<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？]]></title>    <link>https://juejin.cn/post/7571334572769984555</link>    <guid>https://juejin.cn/post/7571334572769984555</guid>    <pubDate>2025-11-12T03:11:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572769984555" data-draft-id="7571378103281713158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？"/> <meta itemprop="keywords" content="LLM,程序员,Agent"/> <meta itemprop="datePublished" content="2025-11-12T03:11:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:11:43.000Z" title="Wed Nov 12 2025 03:11:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在人工智能快速发展的今天，越来越多企业开始部署自己的大语言模型。然而面对动辄数十亿参数的大模型，如何高效稳定地运行它们成为技术团队面临的共同挑战。今天我们就来深入解析两款主流的大模型推理引擎——vLLM和Ollama，帮助您做出正确的技术选型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c7e4fdb95f541b3b68e56440402cb03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=O%2FB5O%2F%2BQrM%2FdsAWFS4EI3rZ5x9Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">什么是vLLM？它为何如此高效？</h2>
<p>vLLM（Vectorized Large Language Model）是由加州大学伯克利分校团队开发的高性能大语言模型推理引擎，专门用于提升大模型推理的效率和速度</p>
<p><strong>vLLM的核心突破在于其创新的PagedAttention技术</strong>，这项技术巧妙地借鉴了操作系统的虚拟内存分页机制 传统推理框架在处理大模型时，需要为每个请求分配一块<strong>连续的显存空间</strong>来存储注意力机制的键值对（KV Cache）。这就像停车场要求每辆车必须停靠在连续的车位中，即使只剩零散车位也无法使用，导致显存利用率通常只有60%左右</p>
<p>而vLLM的PagedAttention技术将KV Cache划分为固定大小的"块"，这些块可以<strong>非连续地存储在显存中</strong>，并通过页表管理它们的映射关系。这种方法就像让车辆可以分散停放在停车场的任何空位，极大提升了显存利用率，可达到<strong>95%以上</strong> 除了PagedAttention外，vLLM还有两大核心技术：</p>
<p><strong>连续批处理（Continuous Batching）</strong> ：传统批处理需要等待一批请求全部完成后才能处理下一批，而vLLM允许新请求随时加入处理队列，确保GPU持续工作，显著提高吞吐量</p>
<p><strong>前缀共享（Prefix Sharing）</strong> ：当多个请求有相同提示前缀时，vLLM可以共享这部分计算的KV Cache，避免重复计算</p>
<p>这些技术使得vLLM在相同硬件上能同时服务<strong>5-10倍</strong>的请求量，成为企业级高并发场景的理想选择</p>
<h2 data-id="heading-1">2.vLLM与Ollama</h2>
<p>虽然vLLM和Ollama都是大模型推理框架，但它们在设计理念和适用场景上有着显著差异。</p>
<h3 data-id="heading-2">2.1定位与核心优势</h3>
<p><strong>Ollama</strong>是一个轻量级的本地推理平台，主打<strong>简单易用和快速部署</strong>。它基于Go语言实现，将模型权重、依赖库和运行环境整合为统一容器，用户只需一条命令即可启动模型服务。Ollama特别适合个人开发者、教育演示和本地测试场景</p>
<p><strong>vLLM</strong>则专注于<strong>高性能推理和服务端扩展</strong>，面向需要处理高并发请求的生产环境。它通过先进的内存管理和调度算法，最大化GPU利用率，适合企业级的大规模部署</p>
<h3 data-id="heading-3">2.2性能表现对比</h3>
<p>从性能数据来看，两个框架有明显差异。以DeepSeek-R1-Distill-Qwen-32B模型为例:</p>
<p><strong>显存占用</strong>：Ollama（4-bit量化）为19-24GB，而vLLM（FP16）为64-96GB</p>
<p><strong>推理速度</strong>：Ollama为5-15 tokens/秒，vLLM可达30-60 tokens/秒</p>
<p><strong>硬件需求</strong>：Ollama可在高端消费级GPU（≥24GB）上运行，vLLM需要多卡专业级GPU</p>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>Ollama</strong></th><th><strong>vLLM</strong></th></tr></thead><tbody><tr><td><strong>核心优势</strong></td><td>易用性、快速启动</td><td>高性能、高并发</td></tr><tr><td><strong>显存管理</strong></td><td>动态分块加载</td><td>PagedAttention分页管理</td></tr><tr><td><strong>批处理</strong></td><td>基础批处理</td><td>连续动态批处理</td></tr><tr><td><strong>硬件需求</strong></td><td>消费级GPU即可</td><td>需要专业级GPU</td></tr><tr><td><strong>部署复杂度</strong></td><td>简单，一条命令</td><td>相对复杂，需要调优</td></tr></tbody></table>
<blockquote>
<p>简单来说，选择标准很清晰：<strong>个人开发测试用Ollama，企业生产部署用vLLM</strong>。</p>
</blockquote>
<h2 data-id="heading-4">3.vLLM的软硬件要求与部署实践</h2>
<h3 data-id="heading-5">3.1硬件要求</h3>
<p>vLLM对硬件有较高要求，<strong>推荐使用专业级GPU</strong>，<strong>显存需求</strong>：至少能容纳模型参数和KV Cache，例如70B模型需要140-210GB显存，<strong>支持张量并行</strong>：通过多GPU并行计算加速推理</p>
<blockquote>
<p>本次实验采用一张魔改的 2080显卡，22G现存</p>
</blockquote>
<h3 data-id="heading-6">3.2软件环境</h3>
<p><strong>操作系统</strong>：Linux（Ubuntu 20.04+或Rocky Linux 9+），<strong>驱动要求</strong>：NVIDIA驱动版本535+</p>
<blockquote>
<p>本次实验环境采用 Rocky Linux 10 版本</p>
</blockquote>
<h3 data-id="heading-7">3.3操作系统基础安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更换镜像源为阿里云镜像源  </span>
sed -e <span class="hljs-string">'s|^mirrorlist=|[#mirrorlist]()=|g'</span> \  
    -e <span class="hljs-string">'s|^[#baseurl]()=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> \  
    -i.bak \  
    /etc/yum.repos.d/[Rr]ocky*.repo  
  
<span class="hljs-comment"># 安装EPEL 仓库  </span>
dnf install -y epel-release  
  
 <span class="hljs-comment"># 和yum是一样的  </span>
dnf clean all  
dnf makecache  
  
  
<span class="hljs-comment"># 更新系统软件(非必要)  </span>
yum -y update  
  
<span class="hljs-comment"># 禁用 SELinux  </span>
setenforce 0  
sed -i <span class="hljs-string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config  
<span class="hljs-comment"># 获取 SELinux 状态  </span>
getenforce   
  
<span class="hljs-comment"># 关闭防火墙(生产环境慎重)  </span>
systemctl stop firewalld  
systemctl <span class="hljs-built_in">disable</span> firewalld  
  
<span class="hljs-comment"># 设置时区  </span>
timedatectl set-timezone Asia/Shanghai  
  
<span class="hljs-comment"># 配置时间同步服务  </span>
systemctl status chronyd  
  
<span class="hljs-comment"># 查看时间是否同步 V 大写  </span>
chronyc sources -V  
MS Name/IP address         Stratum Poll Reach LastRx Last sample                 
===============================================================================  
^+ ntp8.flashdance.cx            2   7   377   104  +2245us[+2245us] +/-  104ms  
^* 211.68.71.26                  3   7   377   105  -8679us[-9888us] +/-  124ms  
^- mail.moe.cat                  2   8    61    94    -14ms[  -14ms] +/-  101ms  
^+ ntp1.flashdance.cx            2   7   377    40   +215us[ +215us] +/-  102ms  
  
<span class="hljs-comment"># 安装常用插件  </span>
yum install -y vim wget telnet net-tools lrzsz unzip gcc numactl  bind-utils tar tar perl pciutils
</code></pre>
<blockquote>
<p>显卡检查时会用到 lspci命令，该命令在 pciutils包中</p>
</blockquote>
<h3 data-id="heading-8">3.4 显卡相关</h3>
<h4 data-id="heading-9">3.4.1 确认显卡型号</h4>
<pre><code class="hljs language-makefile" lang="makefile">lspci | grep -i nvidia  
<span class="hljs-section">01:00.0 VGA compatible controller: NVIDIA Corporation TU102 [GeForce RTX 2080 Ti Rev. A] (rev a1)  </span>
<span class="hljs-section">01:00.1 Audio device: NVIDIA Corporation TU102 High Definition Audio Controller (rev a1)  </span>
<span class="hljs-section">01:00.2 USB controller: NVIDIA Corporation TU102 USB 3.1 Host Controller (rev a1)  </span>
<span class="hljs-section">01:00.3 Serial bus controller: NVIDIA Corporation TU102 USB Type-C UCSI Controller (rev a1)  </span>
  
<span class="hljs-comment"># 确认你运行的内核版本，然后安装对应的开发包：  </span>
<span class="hljs-comment"># 查看当前运行的内核版本  </span>
uname -r  
<span class="hljs-comment"># 安装对应版本的内核开发包  </span>
sudo dnf install kernel-devel-<span class="hljs-variable">$(uname -r)</span> kernel-headers-<span class="hljs-variable">$(uname -r)</span>
</code></pre>
<blockquote>
<p>确认内核版本以及安装对应版本内核开发包很重要，要不然驱动无法安装</p>
</blockquote>
<h4 data-id="heading-10">3.4.2 检查是否存在开源驱动 nouveau</h4>
<pre><code class="hljs language-perl" lang="perl">lsmod | <span class="hljs-keyword">grep</span> nouveau
</code></pre>
<blockquote>
<p>有输出说明存在。 开源驱动会与NVIDA 驱动冲突。我的是有输出的</p>
</blockquote>
<p>如果存在，则需要关闭 nouveau 驱动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"blacklist nouveau"</span> | sudo <span class="hljs-built_in">tee</span> /etc/modprobe.d/blacklist-nouveau.conf  
<span class="hljs-built_in">echo</span> <span class="hljs-string">"options nouveau modeset=0"</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/modprobe.d/blacklist-nouveau.conf  
sudo dracut --force  
<span class="hljs-comment"># 重启  </span>
sudo reboot  
  
<span class="hljs-comment"># 重启后确认,如果没有输出则表示已经关闭了  </span>
lsmod | grep nouveau
</code></pre>
<h4 data-id="heading-11">3.4.3 下载驱动</h4>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nvidia.com%2Fen-us%2Fdrivers%2F" target="_blank" title="https://www.nvidia.com/en-us/drivers/" ref="nofollow noopener noreferrer">www.nvidia.com/en-us/drive…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47772dde6ae34e60a56ec2c7ef29f37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=kTqPs0U7oO2aqhX%2BU2O7EyCdPok%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/423018693a6743f8a9065eea31e6b83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=QpJarPRKo5N2d4oXGZh6jEMgv7k%3D" alt="" loading="lazy"/></p>
<p>选择一个版本下载</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef4827896d048e5a46fe714613b995a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=22hmoPwYNqf47p9y0kYyu5H8eyg%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>将下载的文件存放到 <code>/usr/local/src</code>目录备用</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce300dc352e34d4c8ea8f50114dcd8b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=8bevRhRyVTmhxKeMM%2BgSmIr8CJo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.4.4 执行安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src  
<span class="hljs-comment"># 添加可执行权限  </span>
 <span class="hljs-built_in">chmod</span> +x NVIDIA-Linux-x86_64-580.105.08.run  
<span class="hljs-comment"># 执行安装  </span>
 sudo ./NVIDIA-Linux-x86_64-580.105.08.run
</code></pre>
<p>安装的时候，会让你选择许可证，我们直接选择 <code>**NVIDIA Proprietary**</code><strong>即可</strong></p>























<table><thead><tr><th>选项</th><th>许可证</th><th>特点</th><th>推荐选择</th></tr></thead><tbody><tr><td><strong>NVIDIA Proprietary</strong></td><td>专有许可证</td><td>• 传统的NVIDIA专有驱动 • 经过长期测试，稳定性高 • 与各种NVIDIA功能完全兼容</td><td><strong>大多数用户</strong></td></tr><tr><td><strong>MIT/GPL</strong></td><td>开源许可证</td><td>• 较新的开源内核模块 • 更好的内核兼容性 • 遵循开源协议</td><td>特定场景用户</td></tr></tbody></table>
<p>如果操作系统安装的是字符界面，则会出现一个警告:</p>
<blockquote>
<p>WARNING: nvidia-installer was forced to guess the X library path '/usr/lib64' and X module path '/usr/lib64/xorg/modules';</p>
</blockquote>
<p>这个警告信息表明NVIDIA安装程序无法自动检测到X Window系统的开发文件位置,解决这个警告你需要安装X.Org的开发包和pkg-config工具，</p>
<p>这个警告<strong>不会影响CUDA计算功能</strong>，只会影响图形显示，如果你只在字符界面使用Rocky Linux进行计算任务，可以暂时忽略这个警告</p>
<h4 data-id="heading-13">3.4.5 验证驱动是否安装成功</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#  若输出显示显卡信息、驱动版本，则安装成功nvidia-smi</span>

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09c250b097f842c381eb44cf16ca4fae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=YWyDUUNyFDbHjuPw24VJZ9gJcLQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">3.5.安装CUDA</h3>
<p><strong>CUDA</strong> 是 <strong>Compute Unified Device Architecture</strong> 的缩写，是NVIDIA推出的<strong>并行计算平台和编程模型</strong>。</p>
<p><strong>本质：</strong> 让GPU不仅能处理图形，还能进行通用计算的平台</p>
<p><strong>作用：</strong> 允许开发者使用C/C++等语言直接在GPU上编写程序</p>
<p><strong>应用领域：</strong> AI/深度学习、科学计算、数据分析、图形渲染等</p>
<blockquote>
<p>前提条件，需要先安装 NVIDIA 驱动</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">nvidia-smi  <span class="hljs-comment"># 有输出，则确认驱动正常工作</span>
</code></pre>
<h4 data-id="heading-15">3.5.1 下载<strong>CUDA Toolkit并安装</strong></h4>
<p>RTX 2080 Ti 的最优 CUDA 版本为 <strong>11.7 或 11.8</strong>，我们选择 11.8 版本下载，下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fcuda-toolkit-archive" target="_blank" title="https://developer.nvidia.com/cuda-toolkit-archive" ref="nofollow noopener noreferrer">developer.nvidia.com/cuda-toolki…</a> ，找到对应的版本，选择合适的环境下载。下载后，文件存放到 <code>/usr/local/src</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81734e00293a42468339fdb1a5810e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=CD3w1H0F7shF1p9IG5kAt64avIo%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src  
  
wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run  
  
sudo sh cuda_11.8.0_520.61.05_linux.run
</code></pre>
<blockquote>
<p>安装的时候，会出现错误：unsupported compiler version: 14.2.1. Use --override to override this check. 此时使用下面命令跳过检查。 原因是当前系统版本的gcc版本过高 ，cuda_11.8.0 不识别这个gcc版本。生产环境可以降低 gcc版本，比如gcc 10 版本。因为现在是测试，直接跳过检查</p>
<p>sudo sh cuda_11.8.0_520.61.05_linux.run --override</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8481b25cbe1a44ccbd22a84b321aa7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=zPRzOxVh3GUWsRfs6qHlm7qpgUQ%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>因为驱动已经安装了，所以这里需要将 "Driver" 选项去掉</p>
<p>安装完毕后，Toolkit 被安装在了 <code>/usr/local/cuda-11.8</code>, 同时有个链接文件 <code>/usr/local/cuda</code>指向了这个目录</p>
</blockquote>
<h4 data-id="heading-16">3.5.2 配置环境变量</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑bash配置文件  </span>
vim ~/.bashrc  
  
<span class="hljs-comment"># 添加以下内容（版本号根据实际安装调整）  </span>
<span class="hljs-built_in">export</span> PATH=/usr/local/cuda/bin<span class="hljs-variable">${PATH:+:<span class="hljs-variable">${PATH}</span>}</span>  
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda/lib64<span class="hljs-variable">${LD_LIBRARY_PATH:+:<span class="hljs-variable">${LD_LIBRARY_PATH}</span>}</span>  
<span class="hljs-built_in">export</span> CUDA_HOME=/usr/local/cuda  
  
<span class="hljs-comment"># 使配置生效  </span>
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
<h4 data-id="heading-17">3.5.3 验证安装</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查CUDA编译器  </span>
<span class="hljs-string">nvcc</span> <span class="hljs-string">--version</span>  
<span class="hljs-attr">nvcc:</span> <span class="hljs-string">NVIDIA</span> <span class="hljs-string">(R)</span> <span class="hljs-string">Cuda</span> <span class="hljs-string">compiler</span> <span class="hljs-string">driver</span>  
<span class="hljs-string">Copyright</span> <span class="hljs-string">(c)</span> <span class="hljs-number">2005</span><span class="hljs-number">-2022</span> <span class="hljs-string">NVIDIA</span> <span class="hljs-string">Corporation</span>  
<span class="hljs-string">Built</span> <span class="hljs-string">on</span> <span class="hljs-string">Wed_Sep_21_10:33:58_PDT_2022</span>  
<span class="hljs-string">Cuda</span> <span class="hljs-string">compilation</span> <span class="hljs-string">tools,</span> <span class="hljs-string">release</span> <span class="hljs-number">11.8</span><span class="hljs-string">,</span> <span class="hljs-string">V11.8.89</span>  
<span class="hljs-string">Build</span> <span class="hljs-string">cuda_11.8.r11.8/compiler.31833905_0</span>  
  
<span class="hljs-comment"># 检查CUDA工具包版本  </span>
<span class="hljs-string">nvidia-smi</span>  <span class="hljs-comment"># 查看右上角的CUDA Version</span>

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc0278708474cf8a6d4ceaadf2a126f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=OaIugtasg%2FVKFEhcLujDLjlVmf8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>nvidia-smi 显示的CUDA版本是驱动程序支持的最高 CUDA版本，不是实际安装的CUDA版本，使用 <code>nvcc --version</code>显示的才是实际安装的版本。</p>
</blockquote>
<p>3.6 安装Conda</p>
<p>Conda 是一个开源的包管理和环境管理系统，最初由 Anaconda 公司开发，主要用于 Python 及其他语言（如 R、Ruby、Lua、Perl、Haskell、C/C++）的包管理和环境管理。它可以安装、更新、卸载软件包，并创建隔离的虚拟环境，使得不同项目之间的依赖不会相互干扰。Conda与pip的区别：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55b061a69b6436987d2561b8a68f631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=%2F9vYkXsiZTNJRvOHrtXyXvGLX8I%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src   
<span class="hljs-comment"># 下载安装脚本  </span>
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh  
  
 <span class="hljs-comment"># 执行安装  </span>
 sh Miniconda3-latest-Linux-x86_64.sh  
  
<span class="hljs-comment"># 手动激活 base环境  </span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(/root/miniconda3/bin/conda shell.bash hook)</span>"</span>  
  
<span class="hljs-comment"># 接收许可  </span>
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main  
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r  
  
<span class="hljs-comment"># 查看源  </span>
conda config --show-sources  
==&gt; /root/miniconda3/.condarc &lt;==  
channels:  
  - defaults  
  
conda config --<span class="hljs-built_in">set</span> show_channel_urls <span class="hljs-built_in">yes</span>  
  
conda config --show channels  
  
 <span class="hljs-comment"># 关闭自动激活base环境  </span>
conda config --<span class="hljs-built_in">set</span> auto_activate_base <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-18">3.7 安装vLLM GPU版本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建vllm虚拟环境  </span>
conda create -n vllm_env python=3.11 -y  
<span class="hljs-comment"># 激活vllm虚拟环境  </span>
conda activate vllm_env  
  
<span class="hljs-comment"># 查看已创建的所有Conda环境  </span>
conda <span class="hljs-built_in">env</span> list  
  
<span class="hljs-comment"># 安装vllm 包  </span>
pip install vllm  
  
<span class="hljs-comment"># 检查vLLM命令行工具是否可用  </span>
vllm --<span class="hljs-built_in">help</span>  
  
<span class="hljs-comment"># 在Python交互环境中尝试导入vLLM的核心模块  </span>
python -c <span class="hljs-string">"from vllm import LLM; print('vLLM导入成功！')"</span>
</code></pre>
<h3 data-id="heading-19">3.8 模型下载</h3>
<p>这里先试用国内的 魔搭ModelScope社区 提供的SDK 来下载模型</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装ModelScope SDK  </span>
pip install modelscope  
  
<span class="hljs-comment"># 创建模型存放目录  </span>
<span class="hljs-built_in">mkdir</span> -p /home/models/modelscope/Qwen/Qwen3-0.6B  
<span class="hljs-comment"># 下载模型  </span>
modelscope download --model Qwen/Qwen3-0.6B --local_dir /home/models/modelscope/Qwen/Qwen3-0.6B
</code></pre>
<h3 data-id="heading-20">3.9 加载本地模型</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 加载。完全启动过后，会打开 8000 端口对外提供服务  </span>
vllm serve /home/models/modelscope/Qwen/Qwen3-0.6B
</code></pre>
<p>GET <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.6.133%3A8000%2Fv1%2Fmodels" target="_blank" title="http://192.168.6.133:8000/v1/models" ref="nofollow noopener noreferrer">http://192.168.6.133:8000/v1/models</a> 此时会显示模型信息</p>
<p>单独开启一个窗口，执行命令：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8000/v1/completions -H <span class="hljs-string">"Content-Type: application/json"</span> -d <span class="hljs-string">'{"prompt": "请介绍一下你自己"}'</span>
</code></pre>
<p>有相应则加载成功</p>
<blockquote>
<p>注意：控制台上按 <code>Ctrl +C</code>服务将会停止，回到命令行</p>
</blockquote>
<h3 data-id="heading-21">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust :裸函数 naked functions]]></title>    <link>https://juejin.cn/post/7571379549370351667</link>    <guid>https://juejin.cn/post/7571379549370351667</guid>    <pubDate>2025-11-12T03:25:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379549370351667" data-draft-id="7571395183943663625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust :裸函数 naked functions"/> <meta itemprop="keywords" content="Rust,嵌入式"/> <meta itemprop="datePublished" content="2025-11-12T03:25:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust :裸函数 naked functions
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:25:36.000Z" title="Wed Nov 12 2025 03:25:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F07%2F03%2Fstabilizing-naked-functions%2F" target="_blank" title="https://blog.rust-lang.org/2025/07/03/stabilizing-naked-functions/" ref="nofollow noopener noreferrer">原文</a></p>
<p>一、什么是“裸函数”（naked functions）</p>
<ul>
<li>裸函数用 #[unsafe(naked)] 标注，函数体只能是一个 naked_asm! 调用。</li>
<li>“裸”的含义是：编译器不会为它自动生成常规函数的“前奏/尾声”（prologue/epilogue）代码，也不会帮你处理参数传递或返回值；函数体完全由你写的汇编指令决定。</li>
<li>这和普通的 asm! 不同：普通函数里即便用了 asm!，编译器仍会生成函数的栈帧、保存寄存器等；而 naked 函数则完全不加这些“包装”。</li>
</ul>
<p>二、为什么需要它（和 global_asm! 相比有什么优势）<br/>
过去如果你要写“完全由汇编控制的函数”，常见的做法是用 global_asm! 直接把一段全局汇编塞进目标文件。这样做有几个痛点：</p>
<ol>
<li>
<p>符号/平台指令的样板代码繁琐且平台相关</p>
<ul>
<li>你得自己写 .section/.globl/.type/.size/.p2align 等指令来“声明一个函数”，而且不同目标平台（ELF、Mach-O、COFF）写法不同，机械又容易错。</li>
<li>裸函数会自动生成这些平台相关的指令，你只写核心汇编逻辑即可。</li>
</ul>
</li>
<li>
<p>符号名与名称修饰（name mangling）问题</p>
<ul>
<li>
<p>用 global_asm! 时你往往把函数名硬编码成裸符号，不参与 Rust 的名称修饰。这会引起：</p>
<ul>
<li>跨平台兼容性差（比如 macOS x86_64 符号前缀有 _，Linux 没有）。</li>
<li>需要让符号全局可见，易发生符号冲突。</li>
</ul>
</li>
<li>
<p>用裸函数时，函数名按 Rust 规则处理、参与名称修饰，减少这些问题。</p>
</li>
</ul>
</li>
<li>
<p>泛型支持受限</p>
<ul>
<li>global_asm! 定义的函数无法像正常 Rust 函数一样使用（尤其是 const generics 等）。裸函数因为是“正常函数签名 + 特殊宏体”，可以更自然地结合一些泛型场景（受限于汇编可接受的操作数种类）。</li>
</ul>
</li>
<li>
<p>统一的文档与安全注释位置</p>
<ul>
<li>裸函数只有一个定义点，你可以在它的注释里集中写明安全性约束（非常重要）。global_asm! 往往需要额外的 extern 声明和分散文档，更容易过时或不一致。</li>
</ul>
</li>
</ol>
<p>三、它解决的核心问题与使用场景<br/>
裸函数的典型使用场景都是“非常低层”的地方，你需要绝对控制指令序列与 ABI 交互，不希望编译器插手（如保存/恢复寄存器、栈帧布局等）。</p>
<p>常见场景：</p>
<ul>
<li>
<p>启动代码、引导程序、上下文切换</p>
<ul>
<li>比如在操作系统内核、引导加载器、裸机（embedded）环境，函数需要用特定寄存器传参/返回，不希望任何多余指令。</li>
</ul>
</li>
<li>
<p>异常/中断入口、陷入处理（trampoline）</p>
<ul>
<li>必须手动保存/恢复寄存器、切换栈等，常规函数前后序会干扰。</li>
</ul>
</li>
<li>
<p>编译器内建（compiler-builtins）、特定 ABI 粘合层</p>
<ul>
<li>一些平台或架构有非标准 ABI 的库函数（例如 ARM EABI 的 _*aeabi** 例程），需要“用你自己定义的调用约定”来衔接其他 C 例程或汇编。</li>
</ul>
</li>
<li>
<p>极致性能和确定性</p>
<ul>
<li>某些关键路径上希望精确到每条指令的控制。</li>
</ul>
</li>
</ul>
<p>四、为什么是“unsafe”</p>
<ul>
<li>
<p>裸函数跳过了编译器的 ABI 与栈帧安全网，意味着：</p>
<ul>
<li>你必须确保你写的汇编与声明的 ABI、函数签名完全一致（参数在哪些寄存器、谁来保存哪些寄存器、如何返回值等）。</li>
<li>稍有不当就可能破坏栈、寄存器约定，导致未定义行为或崩溃。</li>
</ul>
</li>
<li>
<p>因此 #[unsafe(naked)] 明确标示“这是不安全接口”，需要配套完整的 SAFETY 注释说明不变量与约定。</p>
</li>
</ul>
<p>五、naked_asm! 是什么</p>
<ul>
<li>
<p>它是专门给裸函数用的汇编宏，介于 asm! 与 global_asm! 之间：</p>
<ul>
<li>写在函数体里（像 asm!），但只接受部分操作数类型（像 global_asm!）。</li>
<li>编译器将裸函数“下沉”为全局汇编，从而保证函数体“只包含你写的指令”，避免 LLVM 等后端偷偷插入额外指令，并且适配非 LLVM 后端。</li>
</ul>
</li>
</ul>
<p>六、和未来相关的两个扩展（实验中）</p>
<ul>
<li>
<p>extern "custom"（feature: abi_custom）</p>
<ul>
<li>现实中很多裸函数并不真遵循 C 或 sysv64 之类标准 ABI，而是“自定义调用约定”。通过 extern "custom" 能把这种事实表达清楚。</li>
<li>重要限制：这类函数不能被普通 Rust 调用表达式直接调用（编译器不知道怎么生成正确调用序列），只能通过内联汇编去“跳”过去。</li>
</ul>
</li>
<li>
<p>cfg_asm（feature: cfg_asm）</p>
<ul>
<li>允许对汇编块内的“某几行”加 #[cfg(...)] 条件编译。便于按目标/特性开关精细裁剪汇编，而不是复制整段汇编。</li>
</ul>
</li>
</ul>
<p>七、一个简化的示例对比</p>
<ul>
<li>
<p>裸函数写法（更简洁、可移植）：</p>
<ul>
<li>#[unsafe(naked)]<br/>
pub extern "sysv64" fn wrapping_add(a: u64, b: u64) -&gt; u64 {<br/>
core::arch::naked_asm!(<br/>
"lea rax, [rdi + rsi]",<br/>
"ret",<br/>
);<br/>
}</li>
</ul>
</li>
<li>
<p>如果用 global_asm!，你得写一堆 .section/.globl/.type/.size 等平台相关指令，还要处理符号名修饰和可见性问题。</p>
</li>
</ul>
<p>八、我该不该用？</p>
<ul>
<li>
<p>如果你在写普通应用（Web 服务、CLI、桌面程序），几乎不需要。</p>
</li>
<li>
<p>如果你在写：</p>
<ul>
<li>OS 内核/引导、嵌入式启动代码/中断向量、</li>
<li>需要完全掌控寄存器与栈的上下文切换、</li>
<li>与非标准 ABI 的底层粘合层、</li>
<li>或想在极少数路径上精确控制指令序<br/>
那么裸函数会显著提升可读性、可维护性与可移植性，同时减少 global_asm! 的样板与坑点。</li>
</ul>
</li>
</ul>
<p>九、使用时的注意事项</p>
<ul>
<li>必写清晰的 SAFETY 注释：说明所遵循的 ABI、寄存器约定、被破坏/保存的寄存器、栈使用方式、返回值规则等。</li>
<li>确保签名、ABI、实现一致。例如 extern "sysv64" 时，x86_64 的参数寄存器是 rdi、rsi、rdx、rcx、r8、r9，返回值在 rax（必要时 rdx）。</li>
<li>谨慎处理被调用者保存（callee-saved）与调用者保存（caller-saved）寄存器。</li>
<li>在嵌入式/无操作系统环境，留意栈指针初始化、中断屏蔽、内存栅栏等。</li>
</ul>
<p>一句话总结：</p>
<ul>
<li>裸函数把“完全由汇编控制函数体”的需求变得更安全、更清晰、更可移植，替代过去繁琐且容易出错的 global_asm! 方案，主要服务于内核、嵌入式、编译器内建等极低层场景。如果你不写这类底层代码，基本用不到；但在需要它的地方，这是一个非常重要的可维护性和健壮性提升。Pomelo_刘金.</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？]]></title>    <link>https://juejin.cn/post/7571372478803820559</link>    <guid>https://juejin.cn/post/7571372478803820559</guid>    <pubDate>2025-11-12T02:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803820559" data-draft-id="7571280402964922403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-12T02:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:06:17.000Z" title="Wed Nov 12 2025 02:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：代丽 货拉拉/技术中心/质量保障部/履约组</p>
</blockquote>
<p>当一个数据平台的工具量突破3000+、日均调用超50万次，是该庆祝规模化的胜利，还是警惕效率的陷阱？</p>
<p>货拉拉数据工厂就曾站在这样的十字路口——依托高效的"协议编程"架构，我们实现了工具的爆发式增长，却也迎来了用户最真实的抱怨："工具太多选不出""串流程要记半天""新手上手太费劲"。</p>
<p>于是，一场从"平台化"到"AI智能化"的跃迁就此启动。今天，我们就聊聊这场转型背后的痛点、方案与收获。</p>
<h2 data-id="heading-0">一、3k+工具的甜蜜烦恼：高效架构下的使用困局</h2>
<p>在聊转型前，必须先说说支撑我们走到今天的核心底气——"协议编程"架构，简单来说就是：</p>
<blockquote>
<p>工具开发者只需写Java工具类（遵循统一规范），平台通过自研解析引擎自动提取功能描述、输入输出参数等元信息，前端再自动生成可视化界面。</p>
</blockquote>
<p>这个模式的威力有多强？开发者不用管前端交互、权限控制这些"杂事"，专注业务逻辑就行，<strong>工具开发成本直接降低60%以上</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4dbf418904fce8705fb9f3cca9d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=CwN1EYRKuEZUhzLPIf5V%2FU6YhOw%3D" alt="" loading="lazy"/></p>
<p>靠着这套打法，数据工厂迅速成为内部造数的核心基础设施：工具总量突破3k+，日均调用超50万次。但规模上去了，新问题也找上门了，集中在两个核心痛点：</p>
<h3 data-id="heading-1">1. 工具太多，选得发愁</h3>
<p>为了鼓励提效，我们采用"全局核心工具+业务线自定义工具"的运营策略，这就导致很多功能相似的工具并存。比如"账号信息查询"这个简单场景，平台上就有3个主流版本：</p>
<ul>
<li>账号中台：通用版（支持全账户类型）</li>
<li>司机业务线：专属版（仅支持司机账户）</li>
<li>用户业务线：专属版（仅支持用户账户）</li>
</ul>
<p>实际使用中，70%的用户会优先选本业务线工具，导致通用工具复用率不足30%；更糟的是，新用户得花<strong>3分钟对比测试</strong>才能找到合适的工具，提升了使用门槛。</p>
<h3 data-id="heading-2">2. 步骤太繁，操作耗时</h3>
<p>我们的工具大多是"原子化"的，一个工具只干一件事。但真实业务场景往往需要多工具串联，比如"下单并给指定司机流转至完单"这个高频操作，用户得手动走三步：</p>
<ol>
<li>用"获取司机信息"工具查车型</li>
<li>用"下单"工具完成创建</li>
<li>用"订单流转"工具更新状态</li>
</ol>
<p>整个流程平均要5分钟，中间还要手动记结果、切工具，不仅麻烦，还容易出错。</p>
<h2 data-id="heading-3">二、升级目标：让造数像"说话"一样简单</h2>
<p>针对这些痛点，我们明确了AI升级的核心方向：<strong>打造一个能理解自然语言、自主调度工具的智能体（Agent）</strong> ，彻底改变用户与数据工厂的交互方式。</p>
<p>具体来说，就是要实现三个核心能力，让用户从"工具操作者"变成"需求提出者"：</p>
<ul>
<li><strong>精准懂需求</strong>：不用记工具名，用日常话描述需求就行（比如"查一下司机张三的账号信息并履约完单"）</li>
<li><strong>智能配工具</strong>：系统自动选最优工具，多步骤场景自动串联，不用手动组合</li>
<li><strong>自动跑流程</strong>：参数传递、工具调用、结果整合全自动化，直接给最终结果</li>
</ul>
<p>我们的愿景很直接： <strong>"所想即所得，所造皆能成"</strong> 。初期目标更是明确：造数效率提升50%以上，新用户上手时间缩短到1分钟内。</p>
<h2 data-id="heading-4">三、技术方案：AI+数据工厂的三重协同落地</h2>
<h3 data-id="heading-5">3.1 技术决策：从理论最优到落地可行</h3>
<p>智能体的核心技术选型，我们围绕业务特性做了多轮评估。常见的与LLM结合方案有三种：RAG（检索增强生成）、MCP（执行引擎）和Fine-tuning（模型微调）。</p>
<p>从理论上看，Fine-tuning似乎是最优解——数据工厂覆盖货运、小拉出行、国际化等全业务线，沉淀了大量特有领域知识，微调能让模型深度融合这些知识，减少上下文输入量，提升稳定性。</p>
<p>但早期简易尝试后，我们发现了实际障碍：微调需要大量标注数据，且对算法团队的技术能力要求极高，同时持续迭代的成本也难以承受。综合落地难度与效果反馈，我们最终确定了 <strong>“LLM+RAG+MCP”的协同路径</strong>，兼顾效果、成本与落地效率。</p>
<h3 data-id="heading-6">3.2 技术方案：三大模块构筑智能体能力</h3>
<p>我们将智能体拆解为“大脑（LLM）-知识库（RAG）-手脚（MCP）”三个核心模块，分别负责“理解决策”“知识储备”“执行落地”，形成完整工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f66e63fa8b4a7daaa8ba3779f0d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=zN%2BsUd4%2BP4VMhzj13z0lz3lz0os%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2.1 LLM：智能体的“决策大脑”</h4>
<p>LLM是智能体的核心决策层，使用到LLM的共有6处，出于成本与调优效果做了如下组合与配置（精选3个展示）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d498042d0c40f291357121e167093d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=FrB3C63EgMES2AmvEf6YYtYT4MU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2 RAG：智能体的“知识储备库”</h4>
<p>LLM 具备强大的通用能力，但对我们内部 3000 + 工具的具体信息 “一无所知”。若直接输入全量工具信息，会导致上下文过载。因此，我们通过 RAG 技术构建 “精准检索 - 高效赋能” 的知识库体系，助力智能体精准 “认知” 所需工具。</p>
<p>实践中，我们选用 bge_base_zh_1.5 作为 Embedding 模型，以适配中文语义理解场景；同时，为提升检索的精度与全面性，搭建了双层知识库筛选策略，并将其与固定原子工具列表组合，最终形成 toolList给到LLM使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f53877a952443b8546e0d3c8ae4a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=iqw4Ihwf3tHrg38zrItumGLOBvw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>全量工具详情知识库</strong>：数据直接同步平台工具数据库，细分为“线上”“线下”两个子库——线上库对应生产环境工具，线下库对应测试环境工具，避免智能体误调用测试工具影响线上业务，保障执行安全性。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97aa3aebd49240b4ad3ff99c42da5aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=6e%2BriJkIPo57AXC09Ie8kq%2BZi2M%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>自然语言与工具映射知识库</strong>：人工维护多语义映射关系，解决“用户表述≠工具描述”的匹配难题。比如“下单”“开单”“创建订单”等不同说法，均映射到同一工具，大幅提升模糊需求的匹配准确率。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10109254d5fb4aa3ba78f23fe5e012c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=jZll3THBqBe2PxPi4hfBGz7%2FMPA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3 MCP：智能体的“执行手脚”</h4>
<p>工具组合方案确定后，就需要MCP（执行引擎）负责“落地执行”，核心解决“按序执行、参数传递、失败处理、结果解析”四大问题，让智能体“会用”工具。</p>
<p>此处tool仅有一个，功能是单个工具运行，其执行逻辑依赖于prompt，prompt大纲设计：</p>
<ul>
<li><strong>核心任务定位</strong>：按工具序列依次执行，保障前序结果向后续传递，失败自动重试；提取执行结果并匹配用户诉求，用自然语言呈现。</li>
<li><strong>核心执行规则</strong>： - 顺序执行：严格遵循工具列表顺序，前序工具执行成功是后序执行的前提； - 参数关联：动态参数从历史执行结果中自动提取，固定参数保持预设值不变； - 失败处理：执行失败触发重试机制（默认3次），重试失败则终止流程并记录失败状态与原因。</li>
<li><strong>结果解析规范</strong>：根据执行状态码（如ret值）判断成败；成功则筛选核心信息分点呈现，失败则明确标注状态码、失败环节及可能原因，便于用户排查。</li>
</ul>
<h2 data-id="heading-10">四、阶段性成果：上线三月，效率与口碑双丰收</h2>
<p>今年8月AI智能体正式上线，作为内部工具的智能化升级尝试，经过一段时间的推广与迭代，在核心效率指标与用户口碑方面已取得显著成效，验证了升级方向的可行性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be704eafbb134285b0a6eb90522d2dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=W1ynp356ITusJ312zFBXhobXtWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 核心数据：用户渗透良好，效率提升显著</h3>
<p>上线至今，智能体的用户接纳度逐步提升，核心效率指标达到预期目标：</p>
<ul>
<li><strong>用户渗透</strong>：累计吸引500+内部用户使用，涵盖测试、产品、开发等关键技术岗位；</li>
<li><strong>调用表现</strong>：当前支持工具100+，累计调用次数3k+，受限于部分用户使用习惯尚未完全转变和支持工具数量有限，但高频用户的周均调用频次达10次，使用粘性较高；</li>
<li><strong>效率提升</strong>：核心业务场景的造数效率提升效果明显，以“下单并流转至完单”为例，操作时间从原有的5分钟缩短至1.5分钟左右，效率提升70%；</li>
<li><strong>使用门槛</strong>：新用户上手适应时间从原有的3分钟压缩至1分钟内，自然语言交互方式有效降低了工具使用的学习成本；</li>
</ul>
<h3 data-id="heading-12">4.2 用户反馈：跨岗位认可，痛点解决明确</h3>
<p>尽管当前使用规模仍在拓展，但智能体精准解决了用户的核心痛点，获得了实际使用者的广泛认可，积累了不少正面反馈：</p>
<ul>
<li><strong>研发岗位</strong>：“这个太牛了，不用去数据工厂找工具了，研发联调的时候很受用”——某开发反馈；</li>
<li><strong>产岗位</strong>：“说实话，有AI*数据工厂，产品验收轻松多了”——某产品反馈；</li>
<li><strong>测试岗位</strong>：“太好用了，测试经常要批量造数，和它说，它可以一次完成，原来我还得在页面点多次”——某测试反馈。</li>
</ul>
<h3 data-id="heading-13">4.3 成果价值：验证方向，沉淀经验</h3>
<p>此次阶段性成果的核心价值，不仅在于效率数据的提升，更在于验证了“AI+数据工厂”模式的可行性：一方面，通过智能化手段解决了平台规模化后的核心痛点，为后续推广积累了真实使用案例；另一方面，基于用户反馈沉淀了模型调优、交互设计的经验，为进一步提升调用频次、扩大使用范围奠定了基础。</p>
<h2 data-id="heading-14">五、未来规划：在迭代中持续精进</h2>
<p>AI智能体的初步落地验证了方向的可行性，但在实际应用中，我们也发现了需要持续优化的核心痛点。基于当前反馈，后续将聚焦问题解决与能力升级，稳步推进智能化深化。</p>
<h3 data-id="heading-15">5.1 现存核心痛点</h3>
<p>结合用户使用数据与反馈收集，目前主要存在两类待解决的问题，也是后续优化的方向：</p>
<ul>
<li><strong>表述习惯差异导致的适配问题</strong>：不同岗位、不同使用经验的用户，对同一业务场景的表述存在差异。以“小b下单”场景为例，用户可能表述为“小b下单”“货运下单”“APP创建小b订单”等多种形式。尽管当前通过持续丰富RAG知识库已实现问题可控，但知识库更新存在一定后置性，未能从源头减少歧义。</li>
<li><strong>LLM</strong> <strong>上下文过载与幻觉问题</strong>：数据工厂工具覆盖货拉拉货运、小拉出行、国际化等全业务线，为保障LLM对业务场景的理解精度，需在上下文中外挂大量业务知识与工具信息，导致上下文内容过载。这一问题直接引发LLM幻觉现象频发（如工具选错、生成逻辑有误的执行序列等），单纯通过精简上下文内容已难以有效缓解。</li>
</ul>
<h3 data-id="heading-16">5.2 后续优化路径</h3>
<p>针对上述痛点，我们制定了明确的分阶段优化计划，兼顾短期问题解决与长期能力提升：</p>
<h4 data-id="heading-17">1. 前置化引导，降低表述歧义</h4>
<p>为解决表述差异问题，后续将从“后置知识库补充”转向“前置输入引导”。计划在交互界面增加场景化引导模块：基于历史调用数据梳理高频业务场景（如订单创建、账号查询、状态流转等），为每个场景配置标准化话术模板与关键词提示。用户输入时，系统可根据初步语义识别推荐对应场景模板，用户仅需补充关键参数即可完成需求提交，从源头降低歧义表述概率。</p>
<h4 data-id="heading-18"><strong>2. 职责拆分 + 场景固化，从架构层面降低幻觉概率</strong></h4>
<p>针对上下文过载引发的幻觉问题，采用 “现有平台交互改造 + 智能体职责拆分” 双轮驱动策略，具体如下：</p>
<ul>
<li><strong>现有平台交互改造</strong>：将现有平台执行底层升级为智能体执行模式，前端除了结果展示采用智能体输出效果，其他不变。该方式既能适配用户现有使用习惯，又能规避 LLM 动态组装工具带来的幻觉风险。</li>
<li><strong>智能体职责拆分</strong>：当前智能体核心决策依赖 “工具组装” 单一 LLM，导致其同时承载业务知识存储、工具匹配判断、执行序列生成等多重职责。后续将核心职责拆分为 “业务知识解析”“工具匹配筛选”“执行序列生成” 三个独立模块，通过 “轻量化 LLM + 专用 RAG 知识库” 协同实现（如专用 RAG 承载业务知识、独立 LLM 负责工具匹配）。此举可显著降低单个模型的上下文负载，从架构层面减少幻觉发生概率。</li>
</ul>
<h4 data-id="heading-19">3. 长期技术探索：微调路径持续验证</h4>
<p>尽管初期因数据、成本等因素放弃了Fine-tuning方案，但随着业务数据的积累与技术成本的优化，我们将持续小范围验证微调可行性。计划选取高频业务场景（如订单全链路相关工具），构建专属微调数据集，探索“基础模型+场景微调”的混合模式，进一步提升模型对特定场景的理解精度与决策稳定性。</p>
<h3 data-id="heading-20">5.3 转型感悟：AI落地是场长期修行</h3>
<p>在智能体落地过程中，我们深刻体会到：LLM的强大之处在于其泛化能力，但相较于传统工程代码的强可控性，它更像一个“需要持续调教的伙伴”。AI赋能并非一蹴而就，而是循序渐进的迭代过程——既要接受初期的不完美，通过实际场景反馈持续调优；也要保持对新技术的敏感度，及时将成熟的技术方案融入现有体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用第三方库处理多线程请求接口结果顺序问题？]]></title>    <link>https://juejin.cn/post/7571409339362770971</link>    <guid>https://juejin.cn/post/7571409339362770971</guid>    <pubDate>2025-11-12T03:25:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571409339362770971" data-draft-id="7571360278971547657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用第三方库处理多线程请求接口结果顺序问题？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T03:25:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用第三方库处理多线程请求接口结果顺序问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:25:46.000Z" title="Wed Nov 12 2025 03:25:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用第三方库处理多线程（或更高效的<strong>协程/异步</strong>）请求接口的结果顺序问题，核心思路是 <strong>“利用库的内置机制，让结果顺序与请求提交顺序一致”</strong> ——无需手动处理排序、锁或队列，库已封装好线程安全和有序逻辑。以下是 <strong>3个最常用的第三方库（grequests、httpx、trio）</strong> 的实战教程，覆盖不同场景，步骤清晰且可直接复用：</p>
<h3 data-id="heading-0">核心前提</h3>
<p>所有方案的“有序”本质：<strong>请求提交顺序 → 任务列表顺序 → 结果列表顺序</strong> 一一对应，库内部通过协程调度、异步事件循环或线程池管理，确保结果不会乱序。<br/>
优先选择 <strong>协程/异步库</strong>（而非纯多线程），因为IO密集型接口请求中，协程效率更高（无线程切换开销、无GIL限制）。</p>
<h3 data-id="heading-1">一、方案1：grequests（最快上手，requests+协程）</h3>
<h4 data-id="heading-2">特点</h4>
<ul>
<li>基于 ​<code>​requests​</code>​（完全兼容其API）和 ​<code>​gevent​</code>​（协程），无需修改原有requests代码；</li>
<li>一行代码实现并发，​<code>​grequests.map()​</code>​ 天然保证结果顺序；</li>
<li>适合快速替换requests实现高并发+有序结果。</li>
</ul>
<h4 data-id="heading-3">步骤&amp;代码</h4>
<h5 data-id="heading-4">1. 安装依赖</h5>
<pre><code class="hljs">pip install grequests
</code></pre>
<h5 data-id="heading-5">2. 完整实现（有序结果）</h5>
<pre><code class="hljs language-ini" lang="ini">import grequests
import time

<span class="hljs-comment"># 配置参数</span>
<span class="hljs-attr">API_URL</span> = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>  <span class="hljs-comment"># 测试接口</span>
<span class="hljs-attr">TOTAL_REQUESTS</span> = <span class="hljs-number">20</span>  <span class="hljs-comment"># 总请求数</span>
<span class="hljs-attr">TIMEOUT</span> = <span class="hljs-number">5</span>  <span class="hljs-comment"># 超时时间</span>
<span class="hljs-attr">CONCURRENT_NUM</span> = <span class="hljs-number">10</span>  <span class="hljs-comment"># 并发数（类似线程池大小）</span>

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">start_time</span> = time.time()

    <span class="hljs-comment"># 1. 构造请求列表（按顺序提交，索引0~19）</span>
    <span class="hljs-comment"># 每个请求对应一个索引，确保结果能追溯到原始请求顺序</span>
    <span class="hljs-attr">requests_list</span> = [
        grequests.get(
            API_URL.format(i % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>),  <span class="hljs-comment"># 循环请求1~10的测试接口</span>
            timeout=TIMEOUT,
            headers={<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"grequests-test"</span>}
        )
        for i in range(TOTAL_REQUESTS)
    ]

    <span class="hljs-comment"># 2. 并发执行，map() 保证结果顺序与请求顺序一致</span>
    <span class="hljs-comment"># size=CONCURRENT_NUM：控制最大并发数，避免压垮接口</span>
    <span class="hljs-attr">responses</span> = grequests.map(requests_list, size=CONCURRENT_NUM)

    <span class="hljs-comment"># 3. 按顺序处理结果（responses顺序 = 请求提交顺序）</span>
    print("grequests 有序结果输出：")
    print("-" * 60)
    for idx, response in enumerate(responses):
        if response and <span class="hljs-attr">response.status_code</span> == <span class="hljs-number">200</span>:
            <span class="hljs-comment"># 成功：提取响应数据</span>
            <span class="hljs-attr">title</span> = response.json()[<span class="hljs-string">"title"</span>][:<span class="hljs-number">20</span>]  <span class="hljs-comment"># 截取标题前20字</span>
            print(f"任务<span class="hljs-section">[{idx}]</span>：✅ 成功 - 响应标题：{title}...")
        else:
            <span class="hljs-comment"># 失败：输出错误信息</span>
            <span class="hljs-attr">err_msg</span> = response.reason if response else <span class="hljs-string">"请求超时/连接失败"</span>
            print(f"任务<span class="hljs-section">[{idx}]</span>：❌ 失败 - 原因：{err_msg<span class="hljs-section">[:30]</span>}")

    <span class="hljs-comment"># 统计耗时</span>
    <span class="hljs-attr">total_cost</span> = round(time.time() - start_time, <span class="hljs-number">3</span>)
    print("-" * 60)
    print(f"总耗时：{total_cost}s，总请求数：{TOTAL_REQUESTS}")
</code></pre>
<h5 data-id="heading-6">关键说明</h5>
<ul>
<li>​<code>​grequests.map(requests_list, size=...)​</code>​：核心函数，并发执行请求列表，返回结果列表（顺序与请求列表一致）；</li>
<li>即使某个请求耗时久，结果列表仍会按原始请求顺序排列（如任务3比任务2先完成，但结果列表中任务2的位置仍在任务3前面）；</li>
<li>兼容requests的所有参数（如 ​<code>​data​</code>​、​<code>​json​</code>​、​<code>​headers​</code>​），支持POST请求。</li>
</ul>
<h3 data-id="heading-7">二、方案2：httpx（高性能，同步/异步双模式）</h3>
<h4 data-id="heading-8">特点</h4>
<ul>
<li>新一代HTTP客户端，可替代requests，支持同步+异步两种模式；</li>
<li>异步模式基于 ​<code>​asyncio​</code>​，并发效率高，​<code>​asyncio.gather()​</code>​ 天然保证结果顺序；</li>
<li>支持HTTP/2、连接池复用，稳定性优于requests。</li>
</ul>
<h4 data-id="heading-9">步骤&amp;代码</h4>
<h5 data-id="heading-10">1. 安装依赖</h5>
<pre><code class="hljs">pip install httpx
</code></pre>
<h5 data-id="heading-11">2. 完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> sys

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大并发连接数</span>

<span class="hljs-comment"># 单个异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""返回 (索引, 是否成功, 结果信息)，确保顺序追溯"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()  <span class="hljs-comment"># 4xx/5xx状态码抛出异常</span>
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-comment"># 主异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（复用连接池，提升效率）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(
        limits=httpx.Limits(max_connections=CONCURRENT_NUM)  <span class="hljs-comment"># 限制并发连接数</span>
    ) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造异步任务列表（按顺序提交，索引0~19）</span>
        tasks = [fetch_data(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
        
        <span class="hljs-comment"># 3. 并发执行任务，gather() 保证结果顺序与任务顺序一致</span>
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)

    <span class="hljs-comment"># 4. 按顺序输出结果（results顺序 = 任务提交顺序）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"httpx 异步有序结果输出："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 兼容Windows系统（解决asyncio事件循环问题）</span>
    <span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">"win32"</span>:
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(main())  <span class="hljs-comment"># 启动异步事件循环</span>
</code></pre>
<h5 data-id="heading-12">关键说明</h5>
<ul>
<li>​<code>​asyncio.gather(*tasks)​</code>​：核心函数，并发执行所有异步任务，返回结果列表（顺序与任务列表完全一致）；</li>
<li>异步客户端 ​<code>​httpx.AsyncClient​</code>​ 支持连接池复用，比单个请求创建连接效率高得多；</li>
<li>支持POST请求：将 ​<code>​client.get()​</code>​ 改为 ​<code>​client.post()​</code>​，传入 ​<code>​json={"key": "value"}​</code>​ 即可。</li>
</ul>
<h3 data-id="heading-13">三、方案3：trio（结构化并发，简洁优雅）</h3>
<h4 data-id="heading-14">特点</h4>
<ul>
<li>基于“结构化并发”的异步库，API比asyncio更简洁，错误处理更优雅；</li>
<li>天然支持结果顺序与请求顺序一致，无需额外配置；</li>
<li>适合追求代码简洁性的异步编程场景。</li>
</ul>
<h4 data-id="heading-15">步骤&amp;代码</h4>
<h5 data-id="heading-16">1. 安装依赖</h5>
<pre><code class="hljs language-arduino" lang="arduino">pip install trio httpx-trio  <span class="hljs-meta"># httpx-trio：httpx适配trio的插件</span>
</code></pre>
<h5 data-id="heading-17">2. 完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>

<span class="hljs-comment"># 单个异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-comment"># 主函数（trio的结构化并发）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（结合trio）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(
        limits=httpx.Limits(max_connections=CONCURRENT_NUM)
    ) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造任务列表（按顺序提交）</span>
        <span class="hljs-comment"># trio.gather() 与 asyncio.gather() 用法一致，保证结果顺序</span>
        results = <span class="hljs-keyword">await</span> trio.gather(*[fetch_data(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)])

    <span class="hljs-comment"># 3. 按顺序输出结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"trio 异步有序结果输出："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    trio.run(main())  <span class="hljs-comment"># trio自带事件循环，直接运行主函数</span>
</code></pre>
<h5 data-id="heading-18">关键说明</h5>
<ul>
<li>​<code>​trio.gather(*tasks)​</code>​：核心函数，功能与 ​<code>​asyncio.gather()​</code>​ 一致，保证结果顺序；</li>
<li>代码比asyncio更简洁，无需手动处理事件循环兼容（如Windows系统）；</li>
<li>结构化并发特性：如果某个任务报错，会自动取消其他未完成任务，避免资源泄漏（可通过 ​<code>​trio.CancelScope​</code>​ 灵活控制）。</li>
</ul>
<h3 data-id="heading-19">四、方案4：tenacity（重试+多线程/异步，有序+高可用）</h3>
<h4 data-id="heading-20">特点</h4>
<ul>
<li>并非HTTP库，而是<strong>重试库</strong>，可与任意并发方案（ThreadPoolExecutor、httpx、aiohttp）结合；</li>
<li>支持失败自动重试（指定重试条件、间隔、次数），不破坏结果顺序；</li>
<li>适合接口不稳定场景（如超时、连接错误），确保有序结果的同时提升成功率。</li>
</ul>
<h4 data-id="heading-21">步骤&amp;代码（结合ThreadPoolExecutor）</h4>
<h5 data-id="heading-22">1. 安装依赖</h5>
<pre><code class="hljs">pip install tenacity requests
</code></pre>
<h5 data-id="heading-23">2. 完整实现（多线程+重试+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential, retry_if_exception_type
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 线程池大小</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-comment"># 配置重试策略：仅对超时/连接错误重试，最多重试2次，间隔1s、2s</span>
<span class="hljs-meta">@retry(<span class="hljs-params">
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">2</span></span>),  <span class="hljs-comment"># 最大重试次数</span>
    wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">5</span></span>),  <span class="hljs-comment"># 指数退避间隔</span>
    retry=retry_if_exception_type(<span class="hljs-params">(<span class="hljs-params">requests.exceptions.Timeout, requests.exceptions.ConnectionError</span>)</span>)  <span class="hljs-comment"># 重试条件</span>
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建线程池，提交任务（Future列表顺序与请求顺序一致）</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=THREAD_NUM) <span class="hljs-keyword">as</span> executor:
        future_list = [executor.submit(fetch_data, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]

        <span class="hljs-comment"># 2. 按Future列表顺序获取结果（保证有序）</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ThreadPoolExecutor + tenacity 有序结果输出："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_list:
            idx, is_success, msg = future.result()  <span class="hljs-comment"># 按提交顺序阻塞等待</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)
</code></pre>
<h5 data-id="heading-24">关键说明</h5>
<ul>
<li>​<code>​@retry(...)​</code>​：装饰器配置重试策略，不影响结果顺序（重试仅在当前任务内部执行）；</li>
<li>按 ​<code>​future_list​</code>​ 顺序调用 ​<code>​future.result()​</code>​：核心是“按提交顺序等待结果”，即使线程执行无序，结果获取顺序仍固定；</li>
<li>可与httpx、aiohttp结合：将 ​<code>​requests.get()​</code>​ 替换为异步请求，重试逻辑不变，仍保证有序。</li>
</ul>
<h3 data-id="heading-25">五、选型建议&amp;面试重点</h3>
<h4 data-id="heading-26">1. 选型优先级</h4>






























<table><thead><tr><th>场景</th><th>推荐库</th><th>核心原因</th></tr></thead><tbody><tr><td>快速上手、兼容requests</td><td>grequests</td><td>语法极简，无需学习新API</td></tr><tr><td>高性能、支持HTTP/2</td><td>httpx</td><td>同步/异步双模式，稳定性强</td></tr><tr><td>追求代码简洁、结构化并发</td><td>trio</td><td>API优雅，错误处理友好</td></tr><tr><td>接口不稳定、需要重试</td><td>tenacity</td><td>可与任意并发方案结合，提升成功率</td></tr></tbody></table>
<h4 data-id="heading-27">2. 面试关键要点</h4>
<ul>
<li><strong>有序的核心原理</strong>：第三方库通过“任务列表与结果列表绑定”实现有序，无需手动排序；</li>
<li><strong>协程vs多线程</strong>：IO密集型接口请求优先选协程（grequests/httpx/trio），效率高于多线程（无GIL限制、无线程切换开销）；</li>
<li><strong>线程安全</strong>：所有推荐库均内置线程安全机制（如协程调度、异步锁），无需手动加锁；</li>
<li><strong>扩展能力</strong>：支持POST请求、请求头配置、超时控制、重试机制，满足工业级需求。</li>
</ul>
<h4 data-id="heading-28">3. 避坑指南</h4>
<ul>
<li>控制并发数：避免设置过大的并发数（如超过50），否则可能被服务端限流或封禁IP；</li>
<li>超时必须配置：防止单个请求阻塞导致整体任务卡住；</li>
<li>异常捕获：必须捕获HTTP错误（4xx/5xx）、超时、连接错误，避免单个任务报错影响整体。</li>
</ul>
<p>以上方案均可直接运行，只需替换 ​<code>​API_URL​</code>​ 为实际接口地址，即可快速实现“多线程/并发请求+有序结果”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初识预加载]]></title>    <link>https://juejin.cn/post/7571352754897551386</link>    <guid>https://juejin.cn/post/7571352754897551386</guid>    <pubDate>2025-11-12T03:27:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754897551386" data-draft-id="7571378103281926150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初识预加载"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T03:27:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李志278"/> <meta itemprop="url" content="https://juejin.cn/user/3370420524565547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初识预加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3370420524565547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李志278
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:27:11.000Z" title="Wed Nov 12 2025 03:27:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> 背景： </h2>
<p>在实习项目中，我遇到了一个典型的视频加载性能问题。页面上有三四个十几秒的视频，只有在满足特定条件时才会播放。最初没有做任何预加载，结果播放时偶尔会出现卡顿。于是我在 <code>&lt;video&gt;</code> 标签中添加了 <code>rel="prefetch"</code> 属性，但由于这些视频共用同一个标签、仅动态切换 <code>src</code>，实际效果并不明显。后来我尝试在组件挂载时通过 JavaScript 手动预加载，但在低速网络下首屏渲染依旧很差。经过查阅 MDN 文档并向 ChatGPT 请教，学习总结了一下预加载。（文末附本人的解决方案）</p>
<h2 data-id="heading-1">一、什么是“预加载”（Preloading）</h2>
<p><strong>预加载</strong>指的是在资源<strong>还未被使用前</strong>，<strong>提前加载进浏览器缓存或内存</strong>，以便在真正需要时能<strong>瞬间可用</strong>。<br/>
核心目标：<strong>减少用户感知的等待时间（Perceived Latency）</strong> 。</p>
<p>浏览器的下载队列和渲染主线程都是有限资源，预加载的设计哲学就是：</p>
<p>“先把带宽用在未来要用的内容上，但不要妨碍当前页面渲染。”</p>
<hr/>
<h2 data-id="heading-2"> 二、requestIdleCallback 的本质</h2>
<p><code>requestIdleCallback(callback[, options])</code><br/>
是一个<strong>任务调度 API</strong>，允许开发者在浏览器<strong>空闲帧</strong>期间执行非关键逻辑。</p>
<p>浏览器每 16.6ms（约 60FPS）会重新绘制一次。<br/>
当主线程完成布局、绘制、事件处理后，若本帧仍有空闲时间，就会执行 <code>requestIdleCallback</code> 注册的回调。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function"><span class="hljs-params">deadline</span> =&gt;</span> {
  <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 执行轻量任务</span>
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>关键点：</p>
<ul>
<li> 不保证立即执行（由浏览器调度）</li>
<li> 可通过 <code>deadline.timeRemaining()</code> 判断剩余时间</li>
<li> 低优先级任务（浏览器可能跳过）</li>
<li> 适用于“可延迟的预加载逻辑”</li>
</ul>
<p>换句话说：<br/>
<code>requestIdleCallback</code> 是**“让预加载不干扰主线程的调度器”**，不是预加载本身。</p>
<hr/>
<h2 data-id="heading-3"> 三、预加载的四种核心方式（+ 浏览器底层优先级）</h2>















































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>方法</td><td>优先级</td><td>触发时机</td><td>适用场景</td><td>浏览器行为</td></tr><tr><td><code>&lt;link rel="preload"&gt;</code></td><td><strong>高</strong></td><td>立即加载</td><td>首屏关键资源</td><td>主线程立刻发起请求，占带宽</td></tr><tr><td><code>&lt;link rel="prefetch"&gt;</code></td><td><strong>低</strong></td><td>空闲时加载</td><td>可能会用到的下个页面资源</td><td>放入低优先级下载队列</td></tr><tr><td>JS 手动加载 (<code>new Image()</code>, <code>video.load()</code>)</td><td>中</td><td>可控</td><td>精确控制加载逻辑</td><td>由 JS 主动创建请求</td></tr><tr><td><code>requestIdleCallback()</code></td><td>调度层</td><td>空闲帧执行</td><td>调度非关键任务（如上报、缓存）</td><td>不加载资源，仅负责“何时执行”</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4"> 四、组合优化策略（实战建议）</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义资源</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">prefetchVideo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>)
  link.<span class="hljs-property">rel</span> = <span class="hljs-string">'prefetch'</span>
  link.<span class="hljs-property">as</span> = <span class="hljs-string">'video'</span>
  link.<span class="hljs-property">href</span> = <span class="hljs-string">'/assets/intro.mp4'</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link)
}

<span class="hljs-comment">// 调度执行</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-title function_">requestIdleCallback</span>(prefetchVideo)
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// Safari fallback</span>
  <span class="hljs-built_in">setTimeout</span>(prefetchVideo, <span class="hljs-number">2000</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>组合优势：</strong></p>
<ul>
<li><code>prefetch</code> → 利用空闲带宽；</li>
<li><code>requestIdleCallback</code> → 避免主线程忙碌时添加 <code>&lt;link&gt;</code>；</li>
<li>整体节奏平衡：<strong>CPU 不阻塞，网络不浪费。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-5"> 五、HTTP 层与浏览器调度机制</h2>
<p>浏览器内部有<strong>资源优先级系统</strong>，会根据资源类型分配网络带宽：</p>





























<table><thead><tr><th/><th/></tr></thead><tbody><tr><td>类型</td><td>优先级</td></tr><tr><td>HTML / CSS / JS (首屏)</td><td>Highest</td></tr><tr><td>preload</td><td>High</td></tr><tr><td>prefetch</td><td>Low</td></tr><tr><td>img / video / font (非首屏)</td><td>Medium / Low</td></tr></tbody></table>
<p>在 HTTP/2 / HTTP/3 下，<code>preload</code> 可以直接让服务端提前推送（Server Push 已废弃但仍有影响），<br/>
而 <code>prefetch</code> 只是<strong>提示浏览器</strong>：“这资源可能未来用到”，是否加载由浏览器决定。</p>
<hr/>
<h2 data-id="heading-6"> 六、更多高级预加载技巧</h2>
<ol>
<li><strong>DNS Prefetch / Preconnect</strong><br/>
提前建立 DNS 或 TCP/TLS 连接，加速外部资源。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">&lt;link <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> href=<span class="hljs-string">"//cdn.example.com"</span>&gt;
  &lt;link <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> href=<span class="hljs-string">"https://cdn.example.com"</span>&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ol>
<li><strong>模块预加载（ESM 动态导入）</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">'./nextPage.js'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Webpack 自动生成 <code>&lt;link rel="prefetch"&gt;</code>，用于懒加载页面的提前下载。</p>
<ol>
<li><strong>Service Worker 缓存预加载</strong><br/>
可以结合 Cache API，在空闲时缓存页面资源：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">self.addEventListener('message', <span class="hljs-attr">e</span> =&gt; {
  caches.open('v1').then(<span class="hljs-attr">cache</span> =&gt; cache.addAll([<span class="hljs-string">'/next.html'</span>, <span class="hljs-string">'/next.js'</span>]))
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7"> 七、总结（逻辑关系图）</h2>
<pre><code class="hljs language-lua" lang="lua">预加载 = 提前加载 + 合理调度
└── <span class="hljs-built_in">preload</span>：立即加载，关键资源
└── prefetch：未来资源，低优先级
└── JS手动加载：精准控制加载时机
└── requestIdleCallback：优化执行时机（CPU层）
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>底层机制：</p>
<ul>
<li>浏览器有独立的网络调度系统；</li>
<li>各种 rel 属性影响资源优先级；</li>
<li><code>requestIdleCallback</code> 属于 <strong>任务调度层</strong>，用于协调 CPU 资源；</li>
<li>组合使用时，能最大化性能与体验。</li>
</ul>
<h2 data-id="heading-8">八、解决方案</h2>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">preloadVideos</span> = () =&gt; {
  const <span class="hljs-attr">videoUrls</span> = [
  //视频链接
]<span class="hljs-comment">;</span>

  videoUrls.forEach((url) =&gt; {
    const <span class="hljs-attr">link</span> = document.createElement(<span class="hljs-string">"link"</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">link.rel</span> = <span class="hljs-string">"prefetch"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">link.as</span> = <span class="hljs-string">"video"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">link.href</span> = url<span class="hljs-comment">;</span>
    document.head.appendChild(link)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">scheduleVideoPreload</span> = () =&gt; {
  if (typeof <span class="hljs-attr">window</span> === <span class="hljs-string">"undefined"</span>) return<span class="hljs-comment">;</span>
  const <span class="hljs-attr">idleCallback</span> = (window as any).requestIdleCallback<span class="hljs-comment">;</span>

  if (typeof <span class="hljs-attr">idleCallback</span> === <span class="hljs-string">"function"</span>) {
    idleCallback(() =&gt; {
      preloadVideos()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  } else {
    requestAnimationFrame(() =&gt; {
      preloadVideos()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
// 组件挂载时预加载视频
onMounted(() =&gt; {
  requestAnimationFrame(() =&gt; {
    scheduleVideoPreload()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>有更好的解决方案欢迎评论区交流。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[结项报告完整版：Apache SeaTunnel 支持 Flink 引擎 Schema Evolution 功能]]></title>    <link>https://juejin.cn/post/7571334572769968171</link>    <guid>https://juejin.cn/post/7571334572769968171</guid>    <pubDate>2025-11-12T03:10:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572769968171" data-draft-id="7571355146771595306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="结项报告完整版：Apache SeaTunnel 支持 Flink  引擎 Schema Evolution 功能"/> <meta itemprop="keywords" content="大数据,Flink,开源"/> <meta itemprop="datePublished" content="2025-11-12T03:10:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白鲸开源"/> <meta itemprop="url" content="https://juejin.cn/user/3870725052049454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            结项报告完整版：Apache SeaTunnel 支持 Flink  引擎 Schema Evolution 功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3870725052049454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白鲸开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:10:50.000Z" title="Wed Nov 12 2025 03:10:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>过去两周，我们对开源之夏活动中表现优异的开发者们进行了简单的采访，初步粗略地了解了一下他们的开发过程和心得体会。今天，我们将通过同学们的完整结项报告，深入了解项目的开发技术细节，希望能够帮助大家更好地了解 Apache SeaTunnel 项目的最新进展。</p>
<p>接下来是关于<em><strong>在 Flink  引擎上对 Schema Evolution 功能的支持</strong></em>这一项目的完整报告：</p>
<h2 data-id="heading-0">一. 已完成工作</h2>
<p>根据原定方案（<a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FQTxYwPcytiG4bxku0vQcrvtlnlb%25EF%25BC%2589%25E5%2592%258C%25E6%2597%25B6%25E9%2597%25B4%25E8%25A7%2584" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/QTxYwPcytiG4bxku0vQcrvtlnlb%EF%BC%89%E5%92%8C%E6%97%B6%E9%97%B4%E8%A7%84" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/QTxYwP…</a>  划，已完成在 Flink  引擎上对 Schema Evolution 功能的支持，目前  Sink 端已支持在  Flink 引擎   上进行流式变更的有：  JdbcSinkWriter ， JdbcExactlyOnceSinkWriter ， ConsoleSinkWriter ，已 经测试完毕，目前没有发现在 Schema Evolution 流程中有明显 bug。</p>
<p>✅在 source 和 transform 之间动态插入算子，如果检测到实现了 SupportSchemaEvolution 的类， 并且开启了 schema evolution 的配置，则插入SchemaOperator。</p>
<p>✅实现 SchemaCoordiantor 协调器，接收 sink 端上报的刷写信息，同时接收 SchemaOperator 上 报的 Schema 变更请求。</p>
<p>✅扩展 SchemaChangeEvent子类，支持 FlushEvent 事件流转。</p>
<p>✅扩展 SupportSchemaEvolutionSinkWriter 方法，支持上报刷写成功信息，处理 FlushEvent。</p>
<p>✅实现 SchemaOperator 算子，检测被 source 端发出的变更事件并处理，支持变更事件透传到下 游。</p>
<p>✅重写 SupportSchemaEvolutionSinkWriter 关于 Schema evolution方法，目前支持
JdbcSinkWriter，JdbcExactlyOnceSinkWriter ，ConsoleSinkWriter，测试完毕，符合预期。</p>
<p>✅扩展 FlinkRowCollector 的 collect 方法，支持变更事件的收集。</p>
<p>✅扩展 FlinkSinkWriter 方法，支持检测变更事件并处理。</p>
<p>✅扩展 SchemaEvolution 错误码和异常体系，变更出现异常时支持详细异常信息上报。</p>
<p>✅变更任务出现异常后，自动抛出异常，交给重试机制处理。</p>
<h2 data-id="heading-1">二. 遇到的问题及解决方案</h2>
<h3 data-id="heading-2">1. 事件流转问题</h3>
<p>在 source 端和 transform 中间插入一个 operator时，需要在内部判断流转过来的元素是否是事 件，如果是事件，就阻塞，等待刷写变更之后再次流转；否则就继续向下流转，有两种方案：</p>
<ul>
<li>和 Zeta 引擎保持一致，创建类似 Record 的类 StreamElement  ，但是从 source 到 transform 到 sink 端的所有链路，关于 SeatunnelRow 的都要修改为 StreamElement，入侵性极高，且非常危 险，影响面大。</li>
<li>在 SeatunnelRow 中添加特殊标记，比如在 options 里面添加一个选项，如果遇到事件，存储到额 外信息里面，这样对链路入侵性不高，但是违反单一设计原则，按理来说 SeatunnelRow 不应该关 心事件，只负责数据流转，之后如果架构升级可以重构，目前以实现功能为主，减小风险。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079f9f2b39b24eada7bbfb86230a5c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=hsbWVb95cNzbcF75DJ9d3Z7JWXE%3D" alt="" loading="lazy"/></p>
<p>之后就可以在 SchemaOperator 算子里面检测到这个标记了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6ac829d7356463dbefb3c8482ca725a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=S3sHgHigfn8AdlptQzoccz9%2F4Aw%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c07cc0ac534085af0c8eb37492b4a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=zkJVwIgn5huXvZH%2FrxUPrYci%2Bno%3D" alt="" loading="lazy"/></p>
<p>但是这样同样会带来一个问题，就是我们 new 了一个空行，会导致 sink 端的写入报错，所以需要 在 sink 端检测：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1afc9fc4172c4b05b9c5ed1ffea5b86f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=R0%2FKRHx1RnUs6yIUpyo4%2FtM4lrs%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de18a34c0e304a15b0fa011b9704f076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=Md1HPg%2FpivmAuhrHYpbXB%2BcEfNU%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dfdffb3e1144fcbeda72a0de30619d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=8zzFfzKZaUnxZSX9T%2BnzoKpLmfE%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f7b5d84ad741a3af1ca3afc9333d5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=qm4OVdvYJ4A%2B86b9LTpyNGb2qts%3D" alt="" loading="lazy"/></p>
<p>这样就能解决事件透传的问题。</p>
<h3 data-id="heading-3">2. 多并行度问题</h3>
<p>实际上在 Flink CDC 的实现中，增量快照阶段，按照用户定义并行度开启任务，读取快照数据；进 入增量阶段后，为了保证顺序，只会保留一个任务来读取，所以我们不需要给协调器多么复杂的实现， 让它正常接收 sink 端响应即可，也不用考虑多个分区重复上报以及顺序问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae3b6aa001e04fc795f157501289f1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=rPitoyMbYb6IQFoZQva3eUQoWAg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98caa9a7213242479855b6f8e176c159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=7LZ74KDac%2FRY814rZIndN9z8OmM%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34a1d46d02e415496d6ced799f11b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=eBTepOGONlvCEhaMtHZNqca%2BzSc%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8c2acc314fc483badabc812098b999d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=N6%2B3OEARI0h9Eyu4EWo9MzrrGII%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cc6411a2adc4707b949c637e6ceef36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=5G9g1yDEWgxj2C%2F1Cg%2BitWAclDw%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b3acdace704494baf07f61c1530c685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=dxYGqKy1T8l0Ien5vcjdXkt3tNg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4c8fb3ba7e143fbaf2467e48e09f506~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=giQhCcyTeNo6PNPFHm549Z9Qgqc%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4269a236c344d45bcb6a863a2b7193f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=L8W%2FknAGV4ioVqWIHOOHVkpYsxA%3D" alt="" loading="lazy"/></p>
<p>关于 source 端明明是一个任务，但是 sink 可能是多个任务的问题，看了下 flink cdc 相关源码， CDC source 确实是由一个任务来读取 binlog，但之后数据通过 KeyGroupStreamPartitioner 按主键 hash分发，不同的 key 被发送到不同的 sink 任务，每个 sink 任务处理分配给它的 key 范围的数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3d2beaa38d47a1bfbba5029f3bc677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=OlKycwAxBOfoY1cyI1iJeJZ8sls%3D" alt="" loading="lazy"/></p>
<p>具体实现里面，会先检查 sink 端和 input 的并行度是否相同，如果不同，会采取 primary key shuffle 的手段：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed72fe10d32b49fca469040e7ef99503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=e8VaLFOcdLLpMy1RWAuKbblSJJY%3D" alt="" loading="lazy"/></p>
<p>sink 配置了自定义并行度且不等于输入并行度时， Flink 会进行特殊处理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37997a27d3c0490385b711143309d8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=STsZdwwZCUIQGG1PuDvJuMLIHR4%3D" alt="" loading="lazy"/></p>
<p>如果 sink 并行度与 input 并行度不同，会通过 primary key 进行 shuffle：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a5d1953567e42049006d2cb0e4da9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=ggBrwN27pCgqQ3EtTErWY6iqADk%3D" alt="" loading="lazy"/></p>
<p>Flink  自己应该支持这种 sink 端的多并行度，但是我有几个考虑的点：</p>
<ol>
<li>如果真要实现这种机制， Shuffle 的实现对我来说有难度。</li>
<li>如果多个并行度同时收到变更命令，对于幂等性的数据库来说，变更可能不受影响，但是像
StarRocks 这种 OLAP 数据库没有幂等性，所以有困难，当然这种也有解决办法，就是收到几个分   区的刷写完成响应之后，协调器收到 ack，让协调器来变更，同样也很麻烦，不如让 source 和 sink 使用相同并行度，在一条算子链里面，也不用 shuffle，但是还有一个点是，数据量大的情况下可能 影响性能。</li>
</ol>
<p>所以，我目前检测到 cdc 变更之后强制指定 sink 端并行度就是1，这样也不会有上面的问题，之后 可以进行迭代来支持 sink 端的需求：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5aecfd3e9864d11bdcab75bdfacdc45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=wrGsRjjXRGyhWeTT8FVw%2BrB0LvY%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6750294350054a369c1687ffc3847d6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=eeUyrWg%2B%2FE0JMHKVacwdGdGnLaA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3. 刷写与请求的执行顺序问题</h3>
<p>之前在 SchemaOperator 算子里面处理变更事件的时候，我先发送了刷写事件，之后才请求协调器 进行变更，这样会有一个问题，协调器内部的 SchemaChangeState 还没有进行初始化，所以之后协调  器迟迟获取不到 State，先一步到的 FluEvent 也没有被成功接收， 一直阻塞，之后任务超过了我设定的 超时时间，任务就失败了。
分析日志后发现：</p>
<ul>
<li>12:33:36,597  - FlushEvent 被处理， Sink 立即上报了 flush 成功</li>
<li>12:33:36,597  - 协调器警告： "No schema change state found"</li>
<li>12:33:36,598  - 协调器才创建 schema change state</li>
</ul>
<p>再次查看我写的代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e3daa0ad4b49369ff27a91bbfcad36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=jKK3mhEdnzWlu4sqkstnhUkfWik%3D" alt="" loading="lazy"/></p>
<p>所以问题就比较明显， Sink 的 flush 通知比协调器的 requestSchemaChange 更早到达，导致通知 被丢弃，我们只需要修改执行顺序即可解决此问题：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aa038e4deaa40b583f422ebdf2cf5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=QuqNjtsoGUgY4we5mA12luyW0xg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5523f20407a446728f7092d24346c552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=8xb%2Fx9bMpf2YOSNXkql1BoKfexA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4. FlushData 和 变更问题</h3>
<p>之前我在实现的时候， FlushEvent  内部包裹着 SchemaChangeEvent，在 FlushData 的同时就把表 变更了，这样有一个问题就是职责不清晰，比较混乱，之后就把职责分开，刷写数据就只刷写数据，之   后上报协调器，再次发送变更事件，真正进行变更：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75851029b8e546f497187ac9eb3fea48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=1zEaY5E6a7PzAYxXCQZmexs%2BaDk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">5. 默认实现与接口职责问题</h3>
<p>目前为了向前兼容，SupportSchemaEvolutionSinkWriter 中新增方法均被标记为 default，之后再 进行迭代。迭代完毕之后，即可取消 default 关键字：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5218845c2fa2486198be8e4b90e72dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=3wl2hNCfnAVOlF0sX10IQvSuuJA%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24aedb34b41f4794a49fb9a235683499~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=FKqIIALl2TNUb8RF0whr6azoMpk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">6. 变更失败后标记失败 or 回滚问题</h3>
<p>有一个问题是，假设说因为网络问题或者其他问题，作业失败了，那么应该直接标记作业失败，让 Flink  自己从检查点拉起作业，还是让其直接回滚？</p>
<p>Flink CDC 的实现是直接标记失败，之后从检查点恢复，目前我采用的是标记失败的策略，考虑的点 是，主动回滚开发相当麻烦，可能还需要 flink ck 进行适配，直接让 schema 变更失败时抛出异常，让现 有的重试机制处理就行，而且也观察到 SeaTunnel 这边做了重试相关的机制， Flink自己有全局重试策略，no ，fixed-delay ，failure-rate（已实现，已测试）。</p>
<p>因为要抛出异常，直接抛出 RuntimeException 对开发者定位问题和用户都不是很友好，所以增强 了异常机制，实现了自己的异常类，错误码和异常方法。
异常处理示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a36ac38976840dba3f1ed28fdb6622a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=vkqASvvDosAvSEB5bNQaQ5jyifU%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e7d6901ff94ea8b27c99051c12fa1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=4Q173eoHYsWx0b3QXTlw2Ewcpao%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">三. 测试用例与结果</h2>
<p>关于 MySQLCDC to MySQL 场景测试报告如下：</p>
<p>✅add column 场景测试报告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FXYotwQ7QeiJqsikiTEscBXwcn" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/XYotwQ7QeiJqsikiTEscBXwcn" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/XYotwQ…</a><br/>
✅drop column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FQU73wXqTpirfZmk6NDCc1i" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/QU73wXqTpirfZmk6NDCc1i" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/QU73wX…</a>
1wnDf
✅modify column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FNXVwwTLf8iWUiFk6nGgcv" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/NXVwwTLf8iWUiFk6nGgcv" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/NXVwwT…</a> GJGnmd
✅change column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FUoIvwdUcJiutXSkyvm1ceb" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/UoIvwdUcJiutXSkyvm1ceb" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/UoIvwd…</a>
LcnUh</p>
<h2 data-id="heading-9">四. 后续工作计划</h2>
<ul>
<li>目前并不是所有支持 schema evolution 的 sink 端均实现了，后续支持SupportSchemaEvolutionSinkWriter 相关子类的实现。</li>
<li>测试不同数据源之间的流转情况，修复可能的小 bug。</li>
<li>测试大量数据情况下是否会出现严重阻塞问题。</li>
<li>测试高并发情况下是否有不一致性问题。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust : Trusted Publishing（受信发布）]]></title>    <link>https://juejin.cn/post/7571379549370417203</link>    <guid>https://juejin.cn/post/7571379549370417203</guid>    <pubDate>2025-11-12T03:35:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379549370417203" data-draft-id="7571395183943712777" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust : Trusted Publishing（受信发布）"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-12T03:35:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust : Trusted Publishing（受信发布）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:35:51.000Z" title="Wed Nov 12 2025 03:35:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F07%2F11%2Fcrates-io-development-update-2025-07%2F" target="_blank" title="https://blog.rust-lang.org/2025/07/11/crates-io-development-update-2025-07/" ref="nofollow noopener noreferrer">原文</a></p>
<p>crates.io：开发进展
2025 年 7 月 11 日 · crates.io 团队</p>
<p>最近 crates.io 做了几件对开发者很实用的更新，核心看这几项：</p>
<ol>
<li>Trusted Publishing（受信发布）：不再在 CI 里存放发布密钥</li>
</ol>
<ul>
<li>
<p>解决的问题：以前用 GitHub Actions 发布到 crates.io，要在仓库里配置长期有效的 API Token（有泄漏风险、也不好轮换）。</p>
</li>
<li>
<p>现在怎么做：在 crates.io 上把你的 GitHub 仓库设为“受信任”。发布时，GitHub Actions 通过 OIDC 临时换取一个短期 token，用完就失效，不用你自己管理长效密钥。</p>
</li>
<li>
<p>现状与前置：目前支持 GitHub Actions；未来可能支持其他 CI（如 GitLab CI）。首次发布仍需要手动，之后可切换为受信发布。</p>
</li>
<li>
<p>上手步骤（简化）：</p>
<ul>
<li>
<p>第一次用 cargo publish 手动发版。</p>
</li>
<li>
<p>在 crates.io 的你的 crate 页面里绑定受信仓库。</p>
</li>
<li>
<p>GitHub Actions 配置：</p>
<ul>
<li>给 workflow 开 id-token: write 权限。</li>
<li>使用 rust-lang/crates-io-auth-action@v1 获取临时 token。</li>
<li>用获取的 token 执行 cargo publish。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcrates.io%2Fdocs%2Ftrusted-publishing" target="_blank" title="https://crates.io/docs/trusted-publishing" ref="nofollow noopener noreferrer">crates.io/docs/truste…</a></p>
</li>
</ul>
<ol start="2">
<li>更“能打”的 OpenGraph 分享图</li>
</ol>
<ul>
<li>
<p>以前：所有 crate 分享出去都是同一张图，信息量低。</p>
</li>
<li>
<p>现在：每个 crate 都有自动生成的专属图片（发布新版本时会重新生成），包含：</p>
<ul>
<li>crate 名称、关键词、描述</li>
<li>默认展示的版本、总发布次数</li>
<li>许可证、crate 体积</li>
</ul>
</li>
<li>
<p>场景：你把 crates.io 链接贴到微信群、Twitter、论坛，预览图会更“信息密集”。</p>
</li>
<li>
<p>技术点：功能独立为 crates_io_og_image（开源），使用 Typst 做排版、oxipng 做压缩；还在给 docs.rs 做主题复用。</p>
</li>
</ul>
<ol start="3">
<li>一键触发 docs.rs 重建</li>
</ol>
<ul>
<li>解决的问题：文档构建失败，或想让旧版本文档享受 docs.rs 新功能，不想专门发一个无意义的小版本。</li>
<li>现在：在 crates.io 的“版本列表”里可以直接点按钮触发该版本的 docs.rs 重建。</li>
</ul>
<ol start="4">
<li>README 支持 GitHub 风格“警示块”</li>
</ol>
<ul>
<li>
<p>现在在 README 里写如下内容，会在 crates.io 上被正确渲染并带样式：</p>
<ul>
<li>
<blockquote>
<p>[!NOTE]</p>
</blockquote>
</li>
<li>
<blockquote>
<p>[!WARNING]</p>
</blockquote>
</li>
<li>
<blockquote>
<p>[!CAUTION]</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7257253692f641b98b064c165cfd6fe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523562&amp;x-signature=ZGH3u35anT8P1BN93ju6Xq5kRsA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>场景：在 README 里加“重要提示/注意/警告”更显眼，省去自定义 HTML/CSS 的麻烦。</li>
</ul>
<ol start="5">
<li>一些“看不见但有感知”的底层优化</li>
</ol>
<ul>
<li>
<p>邮件系统改为模板化（minijinja）：</p>
<ul>
<li>以前用字符串拼接，难维护且风格不统一。</li>
<li>现在改为模板引擎，支持模板继承，后续也更容易支持 HTML 邮件。</li>
</ul>
</li>
<li>
<p>语义化版本（SemVer）排序下推到数据库：</p>
<ul>
<li>以前 API 服务器把所有版本拉出来再排序，版本一多就慢。</li>
<li>现在利用 PostgreSQL 的 JSONB 和 btree 规则在数据库侧排序，API 服务器压力更小，响应更快。</li>
</ul>
</li>
</ul>
<p>该关心哪一项？</p>
<ul>
<li>有持续发布需求、且用 GitHub Actions：优先关注“受信发布”（安全性与易用性大幅提升）。</li>
<li>想让分享更像“产品卡片”：OpenGraph 新图提升链接传播视觉效果。</li>
<li>文档偶尔构建失败或想拿到 docs.rs 新特性：直接在 crates.io 触发重建即可。</li>
<li>README 常写“注意/警告”：用 GitHub 风格警示块更清晰。</li>
<li>维护超多版本的热门 crate：数据库侧 SemVer 排序会让接口更快、更稳。</li>
</ul>
<p>给一个最小可用的受信发布 workflow 模板</p>
<ul>
<li>
<p>前提：在 crates.io 绑定你的 GitHub 仓库；本仓库首发已手动完成一次。</p>
</li>
<li>
<p>workflow 核心要点：</p>
<ul>
<li>触发条件：推送以 v 开头的 tag（比如 v1.2.3）</li>
<li>权限：id-token: write（OIDC 必需）</li>
<li>用 crates-io-auth-action 取临时 token，传给 cargo publish</li>
</ul>
</li>
</ul>
<p>示例（可直接用，按需改 tag 规则）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Publish</span> <span class="hljs-string">to</span> <span class="hljs-string">crates.io</span>  
<span class="hljs-attr">on:</span>  
<span class="hljs-attr">push:</span>  
<span class="hljs-attr">tags:</span> [<span class="hljs-string">'v*'</span>] <span class="hljs-comment"># 推送以 v 开头的 tag 时触发  </span>
<span class="hljs-attr">jobs:</span>  
<span class="hljs-attr">publish:</span>  
<span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>  
<span class="hljs-attr">environment:</span> <span class="hljs-string">release</span> <span class="hljs-comment"># 可选：环境保护  </span>
<span class="hljs-attr">permissions:</span>  
<span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span> <span class="hljs-comment"># OIDC 交换所需  </span>
<span class="hljs-attr">steps:</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">rust-lang/crates-io-auth-action@v1</span>  
<span class="hljs-attr">id:</span> <span class="hljs-string">auth</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">cargo</span> <span class="hljs-string">publish</span>  
<span class="hljs-attr">env:</span>  
<span class="hljs-attr">CARGO_REGISTRY_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.auth.outputs.token</span> <span class="hljs-string">}}</span>
</code></pre>
<p>在哪里反馈？</p>
<ul>
<li>有建议或问题，可以到 Zulip 或 GitHub 交流。团队很欢迎反馈。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议]]></title>    <link>https://juejin.cn/post/7571348736154435620</link>    <guid>https://juejin.cn/post/7571348736154435620</guid>    <pubDate>2025-11-12T03:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736154435620" data-draft-id="7571334572770066475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T03:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:36:18.000Z" title="Wed Nov 12 2025 03:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在排查 iOS 网络问题时，选对抓包工具能省下大量时间。不同工具各有侧重：有的适合交互式调试（能看到明文、断点修改），有的用于底层证据采集（pcap 分析），还有些工具在代理受限或加密链路复杂时提供替代采集与过滤导出能力。下面按<strong>功能责任</strong>把主流方案拆清，给出选型与实战建议，便于团队在工单里快速决策与交付。</p>
<h2 data-id="heading-0">工具矩阵（按功能划分）</h2>
<ul>
<li><strong>代理式交互调试（HTTP/HTTPS 解密）</strong>
<ul>
<li>Charles / Fiddler / Proxyman / mitmproxy：界面友好或脚本化强，能断点修改、Mock 回包、查看请求/响应体。适合开发联调、前端与后端联动调试。限制是需要在终端信任代理 CA，对于启用了证书 pinning 的应用无效。</li>
</ul>
</li>
<li><strong>底层抓包与协议分析</strong>
<ul>
<li>tcpdump / tshark / Wireshark：在网关或服务器抓取完整 pcap（<code>-s 0</code>），用于定位 TCP 三次握手、重传、TLS 握手细节与 UDP（QUIC）流量。是判断请求是否到达后端的权威方法。</li>
</ul>
</li>
<li><strong>安全与渗透测试</strong>
<ul>
<li>Burp Suite：侧重请求篡改、自动化扫描与插件生态，适合安全团队做深度测试。</li>
</ul>
</li>
<li><strong>脚本化与自动化工具</strong>
<ul>
<li>mitmproxy（脚本插件）、pyshark、scapy：适合把抓包、解析与统计流程脚本化，便于在 CI 或回归测试中自动复现与告警。</li>
</ul>
</li>
<li><strong>替代性采集与按应用/域名过滤导出</strong>
<ul>
<li>当代理不可用、系统信任限制或 QUIC/HTTP3 等边界协议导致抓包难度增大时，需要能按应用或域名精准筛选并导出 pcap 的方案。抓包大师（Sniffmaster）在工程实践中被作为此类场景下的补充工具：它支持无须改动应用即可抓取 iOS 的 TCP/HTTPS 流量、按 App/域名过滤、导出 Wireshark 兼容的 pcap 与单包二进制，并提供拦截器与 JavaScript 脚本用于请求/响应的动态修改。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">选型建议（场景驱动）</h2>
<ol>
<li><strong>本地开发联调（快速复现、断点修改）</strong>：优先 Charles / Proxyman；用代理查看明文请求，临时修改 header 或 body 来验证后端容错。</li>
<li><strong>自动化测试 / 批量统计</strong>：用 mitmproxy + 脚本或 pyshark 自动化提取 TLS Alert、重传统计并纳入回归。</li>
<li><strong>生产问题定位（是否到达后端）</strong>：在网关或源站抓 tcpdump，然后用 Wireshark 做深度分析；这是判断网络/运维问题的首选证据。</li>
<li><strong>代理受限 / 应用信任限制 / QUIC 场景</strong>：当代理抓不到包或无法解密时，使用能按 App/域名导出的方案（如抓包大师 Sniffmaster）把目标流量导出为 pcap，再与服务器端 pcap 做逐帧比对，快速判断流量在何处被阻断或替换。</li>
</ol>
<h2 data-id="heading-2">常见问题与应对模板</h2>
<ul>
<li><strong>现象：浏览器能抓、App 抓不到</strong> → 排查证书 pinning、自定义 TLS 或 App 内部网络实现；短期让开发提供调试构建，或用按 App/域名导出 pcap 做比对定位。</li>
<li><strong>现象：只有某些网络/运营商失败</strong> → 收集受影响的 ASN/地域，抓取该网络下的边缘 pcap，与客户端导出的 pcap 对比证书 Issuer 以判断是否存在透明代理。</li>
<li><strong>现象：HTTP/3（QUIC）流量不可见</strong> → 临时在客户端或服务端强制退回 TCP+HTTP/2 进行抓包验证，或在服务端抓 UDP/443 的流量。</li>
</ul>
<h2 data-id="heading-3">工程化交付清单（每次抓包分析应包含）</h2>
<ol>
<li>复现时间窗（精确到秒）与 request-id / trace-id；2. 抓包位置说明（代理/网关/后端/导出文件）与 pcap 文件（加密存储）；3. Wireshark 关键帧截图（ClientHello / tls.alert / 关键 HTTP header）；4. 分析结论（客户端 / 网络中间件 / 服务端）与可执行修复建议（如补 fullchain、调整 pin 策略、放通 QUIC）。</li>
</ol>
<hr/>
<h2 data-id="heading-4">把抓包能力工程化</h2>
<p>抓包不是单一工具的竞争，而是<strong>工具组合+流程化能力</strong>的竞争。代理工具负责交互式调试，tcpdump/Wireshark 提供权威证据，脚本化工具实现自动化指标和回放，而在代理受限或信任链复杂的边界场景，应引入按应用/域名过滤并导出 pcap 的补充方案（抓包大师 Sniffmaster）以完成端到端的比对分析。</p>
<p>将这些工具与标准化交付模板结合起来，能把“无法复现”的问题变成可验证、可修复的工程任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Apifox 中使用「模块」合理地组织接口]]></title>    <link>https://juejin.cn/post/7571352754897600538</link>    <guid>https://juejin.cn/post/7571352754897600538</guid>    <pubDate>2025-11-12T03:39:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754897600538" data-draft-id="7571395183943254025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Apifox 中使用「模块」合理地组织接口"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-11-12T03:39:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Apifox 中使用「模块」合理地组织接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:39:45.000Z" title="Wed Nov 12 2025 03:39:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Apifox 项目中，接口按照「模块 → 目录 → 接口」的层级结构进行管理。</p>
<p>模块对应独立的 OpenAPI 文件，通常按服务或业务进行划分；目录用于在模块内进行功能分类；接口则是具体的 API 定义。理解这种层级化的设计是合理组织接口的基础，下面是一个简单的层级示例图：</p>
<pre><code class="hljs language-Bash" lang="Bash">Apifox 项目
│
├── 模块: 用户服务 (按服务或业务划分)
│   │
│   ├── 目录: 用户认证 (功能分类)
│   │   │
│   │   ├── 接口: POST /login (登录)
│   │   └── 接口: POST /register (注册)
│   │
│   └── 目录: 用户信息
│       │
│       └── 接口: GET /users/{<span class="hljs-built_in">id</span>} (获取用户信息)
│
└── 模块: 订单服务
    │
    ├── 目录: 订单管理
    │   │
    │   ├── 接口: POST /orders (创建订单)
    │   └── 接口: GET /orders/{<span class="hljs-built_in">id</span>} (查询订单详情)
    │
    └── 目录: 支付
        │
        └── 接口: POST /payment/submit (提交支付)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a68a6d8e10ea4cc2b2b037c5c84e74b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=gakOGb4C05oAWmugjqJ5DTCcQ5U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">理解 Apifox 的「模块」</h2>
<p>了解了项目的层级结构之后，我们首先应思考的问题是：<strong>是不是每个项目都要用到模块？又该在哪种情况下拆出新的模块？</strong></p>
<p>当你创建一个新项目时，Apifox 会自动为你创建一个“默认模块”。如果你的项目只包含一个后端服务或接口集合，默认模块通常就足够使用。但如果你需要管理多个不同的 API 服务，就可以为每个服务创建独立的模块。</p>
<p>比如某个项目，后端可能包含用户服务、商品服务、订单服务、物流服务等，每个服务负责不同的业务模块，且往往部署在不同的服务地址上。在 Apifox 中，就推荐为这些服务分别创建模块，相对独立地管理各自的接口。</p>
<p>在项目里点击目录树上方的 <code>+</code> 按钮，即可在下拉菜单中看到「模块」的入口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b34bba263b64e568e7a22eb6e59d944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=CRVFLr4D4aDQnRk08jw3B8JraHc%3D" alt="" loading="lazy"/></p>
<p>创建模块后，它会在左侧项目树中与其他模块并列显示，拥有独立的接口和目录空间，可根据需要添加接口和目录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cc42b68eeb43ba8310daeb8bcae8af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=RVSJvARbknBx8zfZFX8rldy6b8s%3D" alt="" loading="lazy"/></p>
<p>不同模块之间相对独立，拥有各自的接口、数据模型、组件库和模块变量等，其中“数据模型”可以在模块间互相引用。不同的模块也共享项目级别的配置，如环境变量、数据库连接和公共脚本等。</p>
<p>每个模块对应一份完整的 OpenAPI 规范文件，在导出 OpenAPI Spec 数据时，就可以看到是按“模块”分别导出的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69f2a0b4cd8348f59b834a30ea3a62b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=D2t5mcpyTGlukNtVdyKS%2F38SqmU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">理解模块内的「目录」</h2>
<p>确定模块划分后，下一步就是规划模块内部的结构：接口如何分类、如何设计目录层级，才能让接口更易管理？</p>
<p>每个模块下都有一个默认的根目录，所有接口和子目录都归属于该根目录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c01ffb82427433d9f3051b378a21003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=N3vL7WOvHHBgbTYjpOJEFH8xQmM%3D" alt="" loading="lazy"/></p>
<p>创建新目录时，可以在根目录上新建，也可以在任意现有目录下创建子目录。</p>
<p>目录层级的设计应结合该模块的复杂程度来考虑。如果模块仅包含十几个接口，一层目录通常就足够，直接按功能分类即可；但如果模块较为复杂，一般就需要设计更清晰的多级目录结构。</p>
<p>以“用户服务”模块为例，可以按功能创建用户认证、用户信息、权限管理等一级目录，然后在用户认证目录下直接添加登录、注册、密码重置等接口。</p>
<p>当发现某个目录下的接口数量过多、逻辑上应独立管理时，可以将该目录转换为模块。点击目录右侧的<code>...</code>，在菜单中选择「转换为新模块」即可。这个功能有助于在业务扩展或接口增多时，对项目结构进行更合理的重构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9553e36ddafa4cb28af5e74745769c17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=5TxUukkBDK8wXvucvs%2Fx%2B77BA0A%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">环境管理与模块的关系</h2>
<p>除了接口的结构化组织，不同模块通常对应不同的服务地址和部署环境，这就需要通过环境管理来统一配置，让接口在不同环境下能顺利调用。</p>
<p>在环境设置中，每个模块的“前置 URL”可单独配置。例如在测试环境中，用户服务模块的前置 URL 可以设置为 <code>http://user-service:8001</code>，订单服务模块则为 <code>http://order-service:8002</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8dc37bbe34142439d4a1edceda5910d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=RvNt6ptQKBbEeKZRttg91Cocu48%3D" alt="" loading="lazy"/></p>
<p>按模块来组织接口的项目，在切换环境时，各模块的服务地址都会随之更新。例如，从开发环境切换到测试环境时，用户服务模块的地址会从 <code>http://localhost:8001</code> 切换到 <code>http://user-service:8001</code>，订单服务模块的地址则会从 <code>http://localhost:8002</code> 切换到 <code>http://order-service:8002</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ccc81ae4d2e4d1a9ac3547ff623afd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=w5T7LFixpCZYhRDLdJPgUv5AXOU%3D" alt="" loading="lazy"/></p>
<p>环境变量可在所有模块中共享，适合存放不同环境的配置项；而模块变量则适用于每个模块独有的配置，如各自的 API Key 或 Token，可在对应模块的接口中引用。</p>
<h2 data-id="heading-3">数据模型的管理与复用</h2>
<p>除了接口和环境的管理，合理规划数据模型同样重要。通过复用数据模型，可以避免重复定义接口参数和响应结构，让接口在模块之间的组织更清晰。</p>
<p>每个模块都有独立的数据模型管理功能，你可以在模块内创建和维护与业务相关的数据结构。这些数据模型不仅能在当前模块中使用，还可以被其他模块引用，从而实现跨模块的数据复用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cdb7d82192848caa8fc1444134527ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=sRRyhSN8EzDV%2BN8VVrD5laT50bc%3D" alt="" loading="lazy"/></p>
<p>例如，用户相关的数据模型可以定义在「用户服务」模块中，订单相关的模型则定义在「订单服务」模块中。当订单模块需要引用用户信息时，只需直接选择「用户服务」模块中的用户数据模型即可，无需重复创建。</p>
<h2 data-id="heading-4">拓展：从 Postman 导入的接口怎么组织？</h2>
<p>如果团队之前使用 Postman 管理接口，也可以将已有接口直接迁移到 Apifox。</p>
<p>在导入时，每个 Postman Collection 会对应一个模块，文件夹结构会映射为目录。接口和数据模型的组织关系在 Apifox 中能够完整保留，这样既可以沿用原有的接口层级和分类，同时也可以继续在 Apifox 中按照模块、目录和数据模型管理接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d100acaf90544f5bccccab15b24d908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=kZJQeu7JZyaMr5Phj342XvzcWOc%3D" alt="" loading="lazy"/></p>
<p>通过合理的模块划分、清晰的目录组织、规范的数据模型设计，项目的接口结构会更加清晰，也更便于协作和维护。理解 Apifox 的设计理念，并按照这种层级化的方式组织项目，才能让后续的接口管理更高效、更有条理。</p>
<p>欢迎各位用户对 Apifox 继续提出使用反馈和优化意见，我们会持续优化更新，致力于为用户提供更优秀的产品功能和更极致的使用体验！</p>
<p><strong>有任何问题欢迎在</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/" ref="nofollow noopener noreferrer"> <strong>Apifox 用户群</strong></a><em><em>与我们交流沟通</em>！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain智能体核心组件概述]]></title>    <link>https://juejin.cn/post/7571391088947953702</link>    <guid>https://juejin.cn/post/7571391088947953702</guid>    <pubDate>2025-11-12T03:50:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571391088947953702" data-draft-id="7569946369991344191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain智能体核心组件概述"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-12T03:50:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain智能体核心组件概述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:50:17.000Z" title="Wed Nov 12 2025 03:50:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>智能体（Agent）</strong> 是将 <strong>大语言模型（LLM）</strong> 与工具相结合，创建能够 <strong>对任务进行推理、决定使用哪些工具并迭代地寻求解决方案</strong> 的系统。</p>
<p align="left"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9445e64649724f4fbeec6013cbc49218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUxMSU5BSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524270&amp;x-signature=DEKXp1%2B6ln9aq89nHFSNh%2FbGC8I%3D" alt="LangChainAgent.png" loading="lazy"/></p>
<p>LLM智能体循环运行各种工具以实现目标。智能体持续运行，直到满足停止条件为止——即模型发出最终输出或达到迭代次数限制。</p>
<hr/>
<h3 data-id="heading-0">1. 模型（Model）</h3>
<p>模型是智能体的 <strong>推理引擎</strong>。它可以通过多种方式进行指定，支持静态和动态选择模型。</p>
<ul>
<li>
<p><strong>静态模型</strong></p>
<p>静态模型在创建智能体时配置一次，并在整个执行过程中保持不变。这是最常见、最直接的方法。</p>
</li>
<li>
<p><strong>动态模型</strong></p>
<p>动态模型的选择是在运行时环境基于当前状态以及上下文信息。这使得复杂的路由逻辑和成本优化成为可能。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 工具（Tools）</h3>
<p>工具赋予智能体执行操作的能力。</p>
<ul>
<li>基于单个提示词的连续调用工具</li>
<li>在适当时并行调用工具</li>
<li>根据先前结果动态选择工具</li>
<li>工具的重试逻辑和错误处理</li>
<li>跨工具调用保持状态持久性</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 系统提示词</h3>
<p>系统提示词是智能体的核心操控杆，通过给智能体提供系统提示词来控制智能体处理任务的方式。可以动态设置系统提示词。</p>
<hr/>
<h3 data-id="heading-3">4. 结构化输出</h3>
<p>在某些情况下，您可能希望智能体以特定格式返回输出。LangChain 通过<code>response_format</code>参数提供了结构化输出的策略。</p>
<hr/>
<h3 data-id="heading-4">5. 记忆</h3>
<p>智能体通过 <strong>消息状态</strong> 自动维护对话历史。存储在状态中的信息可以视为智能体的短期记忆。</p>
<hr/>
<h3 data-id="heading-5">6. 中间件</h3>
<p>中间件给智能体提供了强大的扩展性，可用于在执行的不同阶段自定义智能体的行为。</p>
<ul>
<li>在调用模型之前处理状态（例如，消息修剪、上下文注入）</li>
<li>修改或验证模型的响应（例如，防护措施、内容过滤）</li>
<li>使用自定义逻辑处理工具执行错误</li>
<li>基于状态或上下文实现动态模型选择</li>
<li>添加自定义日志记录、监控或分析功能</li>
</ul>
<p>中间件可以无缝集成到智能体的执行图中，使开发者能够在关键点拦截和修改数据流，而无需更改智能体核心逻辑。</p>
<hr/>
<h3 data-id="heading-6">7. 调用</h3>
<p>可以通过向智能体的状态传递一个更新来调用它。所有智能体的状态中都包含一个消息序列；要调用智能体，只需传递一条新消息。可以进行流式调用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[某东电商平台的MySQL面试知识点分析]]></title>    <link>https://juejin.cn/post/7571409339362918427</link>    <guid>https://juejin.cn/post/7571409339362918427</guid>    <pubDate>2025-11-12T03:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571409339362918427" data-draft-id="7571360278971678729" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="某东电商平台的MySQL面试知识点分析"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-12T03:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            某东电商平台的MySQL面试知识点分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:54:26.000Z" title="Wed Nov 12 2025 03:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在如今互联网电商的业务环境中，数据库作为基础设施扮演着至关重要的角色。特别是对于某东这样的互联网大厂，MySQL作为主要的数据库管理系统，常常是面试过程中的一个重要考察内容。以下文章将基于MySQL的常见面试问题进行详细阐述，为准备MySQL相关职位的面试者提供帮助。</p>
<hr/>
<h4 data-id="heading-0">1. <strong>数据库了解吗，聊一下？</strong></h4>
<p>数据库是用于存储、管理和操作数据的软件系统。常见的数据库系统有关系型数据库（如MySQL、PostgreSQL）和非关系型数据库（如MongoDB、Redis）。关系型数据库遵循结构化查询语言（SQL），数据存储在表格中，并且通过外键等关系连接。MySQL是开源的、支持高并发、事务性强、成本低的关系型数据库，广泛应用于电商平台、社交网络等高流量的场景。</p>
<h4 data-id="heading-1">2. <strong>知道MVCC吗，聊一下</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a54f8d5759e48ecb3a254bd2e3072d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524466&amp;x-signature=SJ5RyIYGa0vAwlU3pZxAgwERacM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p>MVCC（多版本并发控制）是一种数据库管理并发事务的技术。在MySQL中，MVCC通常与InnoDB存储引擎相关，用于支持高并发的事务管理。其主要原理是：在数据库中为每个数据记录维护多个版本，每个事务看到的是数据的不同版本，确保不同事务不会互相干扰。通过时间戳或事务ID来标识不同版本的记录，达到避免锁的竞争，提高并发度的目的。MVCC的关键优势是读操作不需要加锁，极大提高了并发性能。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fb342c25db4406a81c78344fe5ee845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524466&amp;x-signature=pE8c8T%2BGpVkQZA%2FCRscigK0mB2g%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-2">3. <strong>数据库引擎相关</strong></h4>
<p>在MySQL中，常见的存储引擎有InnoDB、MyISAM、Memory、CSV等。其中最常用的是：</p>
<ul>
<li><strong>InnoDB</strong>：支持ACID事务、行级锁、外键约束，适用于高并发、需要事务管理的场景。</li>
<li><strong>MyISAM</strong>：不支持事务和外键，适用于读取较多的场景，查询性能较好，但不能保证数据一致性。</li>
<li><strong>Memory</strong>：数据存储在内存中，访问速度非常快，适合做缓存数据的存储，但数据会在服务器重启后丢失。</li>
<li><strong>CSV</strong>：每个表存储为CSV文件，适用于轻量级的数据交换。</li>
</ul>
<h4 data-id="heading-3">4. <strong>索引类型</strong></h4>
<p>在MySQL中，常见的索引类型有：</p>
<ul>
<li><strong>BTREE索引</strong>：InnoDB和MyISAM存储引擎默认的索引类型。适用于范围查询（&gt;、&lt;、BETWEEN等）。</li>
<li><strong>HASH索引</strong>：只支持等值查询（=），在Memory存储引擎中使用较多，查询效率高，但不支持范围查询。</li>
<li><strong>FULLTEXT索引</strong>：用于文本数据的全文索引，支持快速的全文搜索。</li>
<li><strong>空间索引</strong>：用于空间数据类型（如GIS数据），支持地理信息系统应用。</li>
</ul>
<h4 data-id="heading-4">5. <strong>乐观锁和悲观锁</strong></h4>
<ul>
<li><strong>乐观锁</strong>：假设不会发生冲突，每次读取数据时不会加锁，而是在更新时进行检查，通常通过版本号或时间戳进行控制。如果检测到版本号不一致，则抛出异常，进行重试。</li>
<li><strong>悲观锁</strong>：假设会发生冲突，在读取数据时就加锁，直到事务完成后才释放锁。悲观锁通常使用行级锁（SELECT FOR UPDATE）或表级锁。</li>
</ul>
<h4 data-id="heading-5">6. <strong>数据库优化</strong></h4>
<p>数据库优化是提高数据库性能的关键手段。主要的优化方法有：</p>
<ul>
<li><strong>查询优化</strong>：使用索引、优化SQL语句、避免全表扫描、合理使用JOIN等。</li>
<li><strong>表结构优化</strong>：规范化数据库表，减少冗余数据，合理设计索引。</li>
<li><strong>缓存优化</strong>：使用缓存技术（如Redis）减少数据库访问压力。</li>
<li><strong>数据库分库分表</strong>：将数据分散到多个数据库或表中，避免单一数据库过载。</li>
</ul>
<h4 data-id="heading-6">7. <strong>索引的最左匹配原则</strong></h4>
<p>在多列索引中，查询时必须遵循最左匹配原则。即查询条件中必须从索引的最左边开始，依次匹配索引的列，才能有效利用复合索引。例如，对于一个索引（A, B, C），查询条件应该至少包含A列，才会利用到该索引。如果查询条件只包含B列或C列，索引将无法被使用。</p>
<h4 data-id="heading-7">8. <strong>事务的隔离级别，MySQL默认是重复读</strong></h4>
<p>MySQL支持四种事务隔离级别：</p>
<ol>
<li><strong>读未提交（Read Uncommitted）</strong>：事务可以读取其他事务未提交的数据，容易产生脏读。</li>
<li><strong>读已提交（Read Committed）</strong>：事务只能读取其他事务已提交的数据，避免脏读，但可能会产生不可重复读。</li>
<li><strong>重复读（Repeatable Read）</strong>：保证事务内读取的数据在整个事务过程中一致，防止不可重复读。MySQL的默认隔离级别。</li>
<li><strong>串行化（Serializable）</strong>：事务以串行方式执行，防止幻读，但性能开销较大。</li>
</ol>
<h4 data-id="heading-8">9. <strong>数据库连接池种类</strong></h4>
<p>常见的数据库连接池有：</p>
<ul>
<li><strong>HikariCP</strong>：轻量级、性能高，广泛用于Spring Boot等框架。</li>
<li><strong>C3P0</strong>：较老的连接池，功能较全，但性能不如HikariCP。</li>
<li><strong>Druid</strong>：阿里巴巴开源的数据库连接池，性能和监控功能优秀，适用于大规模分布式应用。</li>
</ul>
<h4 data-id="heading-9">10. <strong>MySQL的事务</strong></h4>
<p>MySQL的事务遵循ACID特性：</p>
<ul>
<li><strong>原子性</strong>：事务中的所有操作要么全成功，要么全失败。</li>
<li><strong>一致性</strong>：事务执行前后，数据库的状态是有效的。</li>
<li><strong>隔离性</strong>：多个事务并发执行时，彼此隔离，不互相影响。</li>
<li><strong>持久性</strong>：事务一旦提交，数据的变更会永久保存。</li>
</ul>
<h4 data-id="heading-10">11. <strong>MySQL最大连接数有了解过吗</strong></h4>
<p>MySQL的最大连接数默认是151，可以通过修改<code>max_connections</code>参数来调整该值。该参数决定了在任意时刻，MySQL服务器能够接受的最大并发连接数。</p>
<h4 data-id="heading-11">12. <strong>MySQL CPU过高怎么排查</strong></h4>
<p>如果MySQL的CPU使用率过高，可以通过以下方式排查：</p>
<ul>
<li>查看MySQL的<strong>error log</strong>，检查是否有异常。</li>
<li>使用<code>SHOW PROCESSLIST</code>命令查看当前的SQL执行情况，定位是否有长时间运行的查询。</li>
<li>使用<code>EXPLAIN</code>命令分析慢查询，查看是否存在查询优化的空间。</li>
</ul>
<h4 data-id="heading-12">13. <strong>binlog存的什么</strong></h4>
<p>MySQL的<strong>binlog</strong>（二进制日志）记录了所有对数据库进行修改操作的SQL语句或事件，如INSERT、UPDATE、DELETE等。binlog是MySQL进行数据恢复、主从复制的核心机制。</p>
<h4 data-id="heading-13">14. <strong>谈谈EXPLAIN结果中比较关键的指标，以及指标的含义</strong></h4>
<p><code>EXPLAIN</code>命令用于分析SQL语句的执行计划，关键指标包括：</p>
<ul>
<li><strong>id</strong>：查询的标识符，表示查询的顺序。</li>
<li><strong>select_type</strong>：查询的类型，表示是简单查询、联合查询、子查询等。</li>
<li><strong>table</strong>：表示查询操作涉及的表。</li>
<li><strong>type</strong>：连接类型，代表了查询表之间的连接方式。常见的值有<code>ALL</code>（全表扫描）、<code>index</code>（索引扫描）、<code>range</code>（范围扫描）等。</li>
<li><strong>rows</strong>：表示扫描的行数，越小越好。</li>
<li><strong>Extra</strong>：补充信息，表示查询的附加信息，如是否使用了文件排序等。</li>
</ul>
<h4 data-id="heading-14">15. <strong>聚簇索引和非聚簇索引</strong></h4>
<ul>
<li><strong>聚簇索引</strong>：数据存储在索引结构中，数据行和索引叶子节点是一起存储的。InnoDB使用聚簇索引，每个表默认有一个聚簇索引。</li>
<li><strong>非聚簇索引</strong>：数据存储在独立的索引结构中，索引中存储的是指向数据的指针。MyISAM和InnoDB的非主键索引是非聚簇索引。</li>
</ul>
<h4 data-id="heading-15">16. <strong>B树和B+树</strong></h4>
<ul>
<li><strong>B树</strong>：每个节点可以有多个子节点，适用于顺序查找和范围查找，但叶子节点不一定在同一层次。</li>
<li><strong>B+树</strong>：B+树是B树的一种变种，所有数据都存储在叶子节点中，非叶子节点只存储键值，用于提高查询效率。MySQL的InnoDB使用B+树作为索引。</li>
</ul>
<hr/>
<p>通过对以上面试问题的详细解答，面试者可以更好地准备MySQL相关职位的面试，同时为自己提供深入理解Mysql打下坚实的基础</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust : 新版本 1.89.0]]></title>    <link>https://juejin.cn/post/7571391088947986470</link>    <guid>https://juejin.cn/post/7571391088947986470</guid>    <pubDate>2025-11-12T03:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571391088947986470" data-draft-id="7571416207971090482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust : 新版本 1.89.0 "/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-12T03:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust : 新版本 1.89.0 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:57:06.000Z" title="Wed Nov 12 2025 03:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/" ref="nofollow noopener noreferrer">原文</a></p>
<p>2025年8月7日 · Rust 发布团队</p>
<p>Rust 团队很高兴地宣布推出 Rust 新版本 1.89.0。Rust 是一种编程语言，它使每个人都能构建可靠高效的软件。</p>
<p>如果您之前通过 apt 安装了 Rust 的旧版本<code>rustup</code>，则可以使用以下命令获取 1.89.0 版本：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>rustup update stable
</code></pre>
<p>如果您还没有，您可以从我们网站上的相应页面<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rust-lang.org%2Finstall.html" target="_blank" title="https://www.rust-lang.org/install.html" ref="nofollow noopener noreferrer">获取<code>rustup</code></a>，并查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Freleases.html%23version-1890-2025-08-07" target="_blank" title="https://doc.rust-lang.org/stable/releases.html#version-1890-2025-08-07" ref="nofollow noopener noreferrer">1.89.0 的详细发行说明</a>。</p>
<p>如果您想帮助我们测试未来的版本，可以考虑在本地更新到 beta 版（<code>rustup default beta</code>）或 nightly 版（<code>rustup default nightly</code>）。请<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/rust-lang/rust/issues/new/choose" ref="nofollow noopener noreferrer">报告</a>您遇到的任何错误！</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23what-s-in-1-89-0-stable" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#what-s-in-1-89-0-stable" ref="nofollow noopener noreferrer"/>1.89.0 稳定版包含哪些内容？</h2>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23explicitly-inferred-arguments-to-const-generics" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#explicitly-inferred-arguments-to-const-generics" ref="nofollow noopener noreferrer"/>显式推断常量泛型的参数</h3>
<p>Rust 现在支持<code>_</code>将 <code>const</code> 作为泛型参数的参数，并从上下文推断其值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">all_false</span>&lt;<span class="hljs-keyword">const</span> LEN: <span class="hljs-type">usize</span>&gt;() <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">bool</span>; LEN] {
  [<span class="hljs-literal">false</span>; _]
}
</code></pre>
<p><code>_</code>与允许将其作为类型使用的规则类似，<code>_</code>当在签名中时，不允许将其作为常量泛型的参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// This is not allowed</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">all_false</span>&lt;<span class="hljs-keyword">const</span> LEN: <span class="hljs-type">usize</span>&gt;() <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">bool</span>; _] {
  [<span class="hljs-literal">false</span>; LEN]
}

<span class="hljs-comment">// Neither is this</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> ALL_FALSE: [<span class="hljs-type">bool</span>; _] = all_false::&lt;<span class="hljs-number">10</span>&gt;();
</code></pre>
<ul>
<li>
<p>这是给 const 泛型加的“表达式位置的下划线推断”糖衣语法。</p>
</li>
<li>
<p>之前必须重复写常量（如 LEN），现在在实现体的一些地方可以写“_”，由编译器从类型/上下文推断，减少样板与错误。</p>
</li>
<li>
<p>但在签名等声明处仍必须显式写出常量，保证 API 的清晰性与可读性。</p>
</li>
</ul>
<h3 data-id="heading-2">生命周期语法不匹配 lint、</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2F1.89%2Fbook%2Fch10-03-lifetime-syntax.html%23lifetime-elision" target="_blank" title="https://doc.rust-lang.org/1.89/book/ch10-03-lifetime-syntax.html#lifetime-elision" ref="nofollow noopener noreferrer">函数签名中的生命周期省略</a>是 Rust 语言的一个符合人体工程学的特性，但它也可能成为新手和专家都可能遇到的绊脚石。当类型中生命周期被推断出来，而语法上又不明显表明存在生命周期时，这种情况尤其如此：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// The returned type `std::slice::Iter` has a lifetime, </span>
<span class="hljs-comment">// but there's no visual indication of that.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Lifetime elision infers the lifetime of the return </span>
<span class="hljs-comment">// type to be the same as that of `scores`.</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-type">u8</span>&gt; {
   scores.<span class="hljs-title function_ invoke__">iter</span>()
}
</code></pre>
<p>现在，类似这样的代码默认会产生警告：</p>
<pre><code class="hljs language-rust" lang="rust">warning: hiding a lifetime that<span class="hljs-symbol">'s</span> elided elsewhere is confusing
 -<span class="hljs-punctuation">-&gt;</span> src/lib.rs:<span class="hljs-number">1</span>:<span class="hljs-number">18</span>
  |
<span class="hljs-number">1</span> | <span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-type">u8</span>&gt; {
  |                  ^^^^^     -------------------- the same lifetime is hidden here
  |                  |
  |                  the lifetime is elided here
  |
  = help: the same lifetime is referred to <span class="hljs-keyword">in</span> inconsistent ways, making the signature confusing
  = note: `<span class="hljs-meta">#[warn(mismatched_lifetime_syntaxes)]</span>` on by default
help: <span class="hljs-keyword">use</span> `<span class="hljs-symbol">'_</span>` <span class="hljs-keyword">for</span> <span class="hljs-title class_">type</span> paths
  |
<span class="hljs-number">1</span> | <span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-symbol">'_</span>, <span class="hljs-type">u8</span>&gt; {
  |                                             +++
</code></pre>
<p>我们<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F46254" target="_blank" title="https://github.com/rust-lang/rust/pull/46254" ref="nofollow noopener noreferrer">早</a>在 2018 年就尝试改进这种情况，当时我们参与了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F54910" target="_blank" title="https://github.com/rust-lang/rust/issues/54910" ref="nofollow noopener noreferrer"><code>rust_2018_idioms</code></a>lint 小组的工作，但关于lint<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F131725" target="_blank" title="https://github.com/rust-lang/rust/issues/131725" ref="nofollow noopener noreferrer">强烈反馈</a><code>elided_lifetimes_in_paths</code>表明，这种方法过于简单粗暴，因为它警告的寿命对于理解功能来说并不重要：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fmt;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Greeting</span>;

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">fmt</span>::Display <span class="hljs-keyword">for</span> <span class="hljs-title class_">Greeting</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> fmt::Formatter) <span class="hljs-punctuation">-&gt;</span> fmt::<span class="hljs-type">Result</span> {
        <span class="hljs-comment">//                -----^^^^^^^^^ expected lifetime parameter</span>
        <span class="hljs-comment">// Knowing that `Formatter` has a lifetime does not help the programmer</span>
        <span class="hljs-string">"howdy"</span>.<span class="hljs-title function_ invoke__">fmt</span>(f)
    }
}
</code></pre>
<p>我们随后意识到，我们想要消除的困惑发生在以下两种情况同时发生时：</p>
<ol>
<li>生命周期省略推理规则将输入生命周期与输出生命周期<em>关联起来。</em></li>
<li>从语法角度来看，生命是否存在这一点并不显而易见。</li>
</ol>
<p>Rust 语法中有两种表示生命周期的语法：<code>[i]``&amp;</code>和<code>[i]</code> <code>'</code>，其中<code>[i]``'</code>又细分为推断生命周期<code>'_</code>和命名生命周期<code>'a</code>。当类型使用命名生命周期时，生命周期省略将不会为该类型推断生命周期。基于这些标准，我们可以构建三个组：</p>

























<table><thead><tr><th>不言而喻，它有其生命周期。</th><th>允许省略生命周期以推断生命周期</th><th>示例</th></tr></thead><tbody><tr><td>不</td><td>是的</td><td><code>ContainsLifetime</code></td></tr><tr><td>是的</td><td>是的</td><td><code>&amp;T</code>，，<code>&amp;'_ T</code>​<code>ContainsLifetime&lt;'_&gt;</code></td></tr><tr><td>是的</td><td>不</td><td><code>&amp;'a T</code>，<code>ContainsLifetime&lt;'a&gt;</code></td></tr></tbody></table>
<p>代码检查工具<code>mismatched_lifetime_syntaxes</code>会检查函数的输入和输出是否属于同一组。对于上面最初的示例，<code>a``&amp;[u8]</code>属于第二组，而 <code>b``std::slice::Iter&lt;u8&gt;</code>属于第一组。我们称第一组中的生命周期是<em>隐藏的</em>。</p>
<p>因为输入和输出的生命周期属于不同的组，所以 lint 会对此函数发出警告，从而减少对某个值具有有意义的生命周期（但视觉上并不明显）时的困惑。</p>
<p>lint<code>mismatched_lifetime_syntaxes</code>取代了<code>elided_named_lifetimes</code>lint，后者专门针对命名的生命周期做了类似的事情。</p>
<p>未来对该代码检查工具<code>elided_lifetimes_in_paths</code>（lint）的改进计划是将其拆分为更专注的子代码检查工具，并最终针对其中一部分发出警告。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23more-x86-target-features" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#more-x86-target-features" ref="nofollow noopener noreferrer"/>更多 x86 目标功能</h3>
<p>该<code>target_feature</code>属性现在支持x86 上的<code>sha512``, </code>sm3<code>、`sm4</code>,``kl<code>和目标特性。此外，x86 上还支持</code>widekl<code>一些内部函数和目标特性：</code>avx512`</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[target_feature(enable = <span class="hljs-string">"avx512bw"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">cool_simd_code</span>(<span class="hljs-comment">/* .. */</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-comment">/* ... */</span> {
    <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23cross-compiled-doctests" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#cross-compiled-doctests" ref="nofollow noopener noreferrer"/>交叉编译的文档测试</h3>
<p>现在运行时会测试 doctest <code>cargo test --doc --target other_target</code>，这可能会导致一些故障，因为原本会失败的 doctest 现在也会被测试。</p>
<p>可以通过在 doctest 中添加<code>ignore-&lt;target&gt;</code>( <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustdoc%2Fwrite-documentation%2Fdocumentation-tests.html%23ignoring-targets" target="_blank" title="https://doc.rust-lang.org/stable/rustdoc/write-documentation/documentation-tests.html#ignoring-targets" ref="nofollow noopener noreferrer">docs</a> ) 注解来禁用失败的测试：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> ```ignore-x86_64</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> panic!("something")</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> ```</span>
<span class="hljs-function">pub fn <span class="hljs-title">my_function</span>()</span> { }
</code></pre>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23i128-and-u128-in-extern-c-functions" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#i128-and-u128-in-extern-c-functions" ref="nofollow noopener noreferrer"/><code>i128</code>以及<code>u128</code>函数<code>extern "C"</code>​</h3>
<p><code>i128</code>这样<code>u128</code>就不会再触发<code>improper_ctypes_definitions</code>代码检查，这意味着可以在函数中使用这些类型<code>extern "C"</code>而不会收到警告。但这也有一些需要注意的地方：</p>
<ul>
<li>Rust 类型在 ABI 和布局上与<code>__int128</code>C 中的（无符号）类型兼容（当该类型可用时）。</li>
<li>在某些平台上，<code>__int128</code>此功能不可用，<code>i128</code>并且<code>u128</code>不一定与任何 C 类型一致。</li>
<li><code>i128</code>不一定与任何平台上的程序兼容，因为<em>程序</em>和程序可能不具有相同的 ABI（例如在 x86-64 上的情况）。<code>_BitInt(128)``_BitInt(128)``__int128</code></li>
</ul>
<p>这是对去年布局更改的最后一部分后续说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2024%2F03%2F30%2Fi128-layout-update" target="_blank" title="https://blog.rust-lang.org/2024/03/30/i128-layout-update" ref="nofollow noopener noreferrer">https</a> ://blog.rust-lang.org/2024/03/30/i128-layout-update 。</p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23demoting-x86-64-apple-darwin-to-tier-2-with-host-tools" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#demoting-x86-64-apple-darwin-to-tier-2-with-host-tools" ref="nofollow noopener noreferrer"/>使用主机工具降级<code>x86_64-apple-darwin</code>到二级</h3>
<p>GitHub 即将<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fchangelog%2F2025-07-11-upcoming-changes-to-macos-hosted-runners-macos-latest-migration-and-xcode-support-policy-updates%2F%23macos-13-is-closing-down" target="_blank" title="https://github.blog/changelog/2025-07-11-upcoming-changes-to-macos-hosted-runners-macos-latest-migration-and-xcode-support-policy-updates/#macos-13-is-closing-down" ref="nofollow noopener noreferrer">停止</a>为公共代码库提供免费的 macOS x86_64 运行器。苹果公司也已宣布<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMac_transition_to_Apple_silicon%23Timeline" target="_blank" title="https://en.wikipedia.org/wiki/Mac_transition_to_Apple_silicon#Timeline" ref="nofollow noopener noreferrer">计划</a>停止对 x86_64 架构的支持。</p>
<p>根据这些变更，Rust 项目正在将<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer">目标平台</a>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-1-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-1-with-host-tools" ref="nofollow noopener noreferrer">包含宿主工具的 Tier 1</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer">降级<code>x86_64-apple-darwin</code></a>为<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-2-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-2-with-host-tools" ref="nofollow noopener noreferrer">包含宿主工具的 Tier 2。</a>这意味着包含诸如和 等工具的目标平台将保证能够构建，但不能保证能够通过我们的自动化测试套件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-1-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-1-with-host-tools" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-2-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-2-with-host-tools" ref="nofollow noopener noreferrer"/><code>rustc``cargo</code></p>
<p>我们预计，将主机工具降级到 Tier 2 的 RFC 将在 Rust 1.89 和 1.90 版本之间被接受，这意味着 Rust 1.89 将是最后<code>x86_64-apple-darwin</code>一个 Tier 1 目标的 Rust 版本。</p>
<p>对于用户而言，此变更不会立即产生影响。<code>rustup</code>在目标平台仍处于 Tier 2 级别期间，Rust 项目仍将分发标准库和编译器的构建版本，供用户通过其他安装方式使用。随着时间的推移，该目标平台的测试覆盖率降低可能会导致一些问题或兼容性下降，届时将不会另行通知。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23standards-compliant-c-abi-on-the-wasm32-unknown-unknown-target" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#standards-compliant-c-abi-on-the-wasm32-unknown-unknown-target" ref="nofollow noopener noreferrer"/>符合标准的 C ABI<code>wasm32-unknown-unknown</code>目标</h3>
<p><code>extern "C"</code>目标平台上的函数<code>wasm32-unknown-unknown</code>现在具有符合标准的 ABI。有关更多信息，请参阅此博客文章： https: <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F04%2F04%2Fc-abi-changes-for-wasm32-unknown-unknown" target="_blank" title="https://blog.rust-lang.org/2025/04/04/c-abi-changes-for-wasm32-unknown-unknown" ref="nofollow noopener noreferrer">//blog.rust-lang.org/2025/04/04/c-abi-changes-for-wasm32-unknown-unknown</a>。</p>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23platform-support" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#platform-support" ref="nofollow noopener noreferrer"/>平台支持</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer"><code>x86_64-apple-darwin</code>正在被降级为二级主机工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F142053" target="_blank" title="https://github.com/rust-lang/rust/pull/142053" ref="nofollow noopener noreferrer">新增三级<code>loongarch32-unknown-none</code>目标<code>loongarch32-unknown-none-softfloat</code></a></li>
</ul>
<p>有关 Rust 分级平台支持的更多信息，请参阅 Rust 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Frustc%2Fplatform-support.html" target="_blank" title="https://doc.rust-lang.org/rustc/platform-support.html" ref="nofollow noopener noreferrer">平台支持页面。</a></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23stabilized-apis" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#stabilized-apis" ref="nofollow noopener noreferrer"/>稳定的API</h3>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fnum%2Fstruct.NonZero.html" target="_blank" title="https://doc.rust-lang.org/stable/std/num/struct.NonZero.html" ref="nofollow noopener noreferrer"><code>NonZero&lt;char&gt;</code></a></p>
</li>
<li>
<p>这里未列举许多 x86 的内部函数。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F111137" target="_blank" title="https://github.com/rust-lang/rust/issues/111137" ref="nofollow noopener noreferrer">AVX512固有频率</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F126624" target="_blank" title="https://github.com/rust-lang/rust/issues/126624" ref="nofollow noopener noreferrer"><code>SHA512</code>以及<code>SM3</code>内在<code>SM4</code>属性</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.lock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.lock" ref="nofollow noopener noreferrer"><code>File::lock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.lock_shared" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.lock_shared" ref="nofollow noopener noreferrer"><code>File::lock_shared</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.try_lock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.try_lock" ref="nofollow noopener noreferrer"><code>File::try_lock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.try_lock_shared" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.try_lock_shared" ref="nofollow noopener noreferrer"><code>File::try_lock_shared</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.unlock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.unlock" ref="nofollow noopener noreferrer"><code>File::unlock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.from_ref" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.from_ref" ref="nofollow noopener noreferrer"><code>NonNull::from_ref</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.from_mut" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.from_mut" ref="nofollow noopener noreferrer"><code>NonNull::from_mut</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.without_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.without_provenance" ref="nofollow noopener noreferrer"><code>NonNull::without_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.with_exposed_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.with_exposed_provenance" ref="nofollow noopener noreferrer"><code>NonNull::with_exposed_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.expose_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.expose_provenance" ref="nofollow noopener noreferrer"><code>NonNull::expose_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fffi%2Fstruct.OsString.html%23method.leak" target="_blank" title="https://doc.rust-lang.org/stable/std/ffi/struct.OsString.html#method.leak" ref="nofollow noopener noreferrer"><code>OsString::leak</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fpath%2Fstruct.PathBuf.html%23method.leak" target="_blank" title="https://doc.rust-lang.org/stable/std/path/struct.PathBuf.html#method.leak" ref="nofollow noopener noreferrer"><code>PathBuf::leak</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fresult%2Fenum.Result.html%23method.flatten" target="_blank" title="https://doc.rust-lang.org/stable/std/result/enum.Result.html#method.flatten" ref="nofollow noopener noreferrer"><code>Result::flatten</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fos%2Flinux%2Fnet%2Ftrait.TcpStreamExt.html%23tymethod.quickack" target="_blank" title="https://doc.rust-lang.org/stable/std/os/linux/net/trait.TcpStreamExt.html#tymethod.quickack" ref="nofollow noopener noreferrer"><code>std::os::linux::net::TcpStreamExt::quickack</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fos%2Flinux%2Fnet%2Ftrait.TcpStreamExt.html%23tymethod.set_quickack" target="_blank" title="https://doc.rust-lang.org/stable/std/os/linux/net/trait.TcpStreamExt.html#tymethod.set_quickack" ref="nofollow noopener noreferrer"><code>std::os::linux::net::TcpStreamExt::set_quickack</code></a></p>
</li>
</ul>
<p>这些先前稳定的 API 现在在 const 上下文中也保持稳定：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.array.html%23method.as_mut_slice" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.array.html#method.as_mut_slice" ref="nofollow noopener noreferrer"><code>&lt;[T; N]&gt;::as_mut_slice</code></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.slice.html%23impl-%255Bu8%255D%2Fmethod.eq_ignore_ascii_case" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.slice.html#impl-%5Bu8%5D/method.eq_ignore_ascii_case" ref="nofollow noopener noreferrer"><code>&lt;[u8]&gt;::eq_ignore_ascii_case</code></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.str.html%23impl-str%2Fmethod.eq_ignore_ascii_case" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.str.html#impl-str/method.eq_ignore_ascii_case" ref="nofollow noopener noreferrer"><code>str::eq_ignore_ascii_case</code></a></li>
</ul>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23other-changes" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#other-changes" ref="nofollow noopener noreferrer"/>其他变化</h3>
<p>来看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Freleases%2Ftag%2F1.89.0" target="_blank" title="https://github.com/rust-lang/rust/releases/tag/1.89.0" ref="nofollow noopener noreferrer">Rust</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fnightly%2Fcargo%2FCHANGELOG.html%23cargo-189-2025-08-07" target="_blank" title="https://doc.rust-lang.org/nightly/cargo/CHANGELOG.html#cargo-189-2025-08-07" ref="nofollow noopener noreferrer">Cargo</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust-clippy%2Fblob%2Fmaster%2FCHANGELOG.md%23rust-189" target="_blank" title="https://github.com/rust-lang/rust-clippy/blob/master/CHANGELOG.md#rust-189" ref="nofollow noopener noreferrer">Clippy</a>中发生了哪些变化。</p>
<h2 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23contributors-to-1-89-0" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#contributors-to-1-89-0" ref="nofollow noopener noreferrer"/>1.89.0 版本的贡献者</h2>
<p>Rust 1.89.0 的开发离不开许多人的共同努力。没有你们，我们不可能完成这项工作。<a href="https://link.juejin.cn?target=https%3A%2F%2Fthanks.rust-lang.org%2Frust%2F1.89.0%2F" target="_blank" title="https://thanks.rust-lang.org/rust/1.89.0/" ref="nofollow noopener noreferrer">谢谢！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重温 Java 21 之禁用代理的动态加载]]></title>    <link>https://juejin.cn/post/7571299394346205226</link>    <guid>https://juejin.cn/post/7571299394346205226</guid>    <pubDate>2025-11-12T00:44:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394346205226" data-draft-id="7571334572768854059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重温 Java 21 之禁用代理的动态加载"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T00:44:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重温 Java 21 之禁用代理的动态加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:44:17.000Z" title="Wed Nov 12 2025 00:44:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java Agent 通常被直译为 Java 代理，它是一个 jar 包，这个 jar 包很特别，不能独立运行，而是要依附到我们的目标 JVM 进程中。它利用 JVM 提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjava.instrument%2Fjava%2Flang%2Finstrument%2FInstrumentation.html" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/java.instrument/java/lang/instrument/Instrumentation.html" ref="nofollow noopener noreferrer">Instrumentation API</a> 来修改已加载到 JVM 中的字节码，从而实现很多高级功能，比如：</p>
<ul>
<li>Eclipse、IntelliJ 等 IDE 的调试功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jrebel.com%2Fproducts%2Fjrebel" target="_blank" title="https://www.jrebel.com/products/jrebel" ref="nofollow noopener noreferrer">JRebel</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-loaded" target="_blank" title="https://github.com/spring-projects/spring-loaded" ref="nofollow noopener noreferrer">spring-loaded</a> 等工具的热加载功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2F" target="_blank" title="https://arthas.aliyun.com/" ref="nofollow noopener noreferrer">Arthas</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbtraceio%2Fbtrace" target="_blank" title="https://github.com/btraceio/btrace" ref="nofollow noopener noreferrer">Btrace</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foldmanpushcart%2Fgreys-anatomy" target="_blank" title="https://github.com/oldmanpushcart/greys-anatomy" ref="nofollow noopener noreferrer">Greys</a> 等工具的线上诊断功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualvm.github.io%2F" target="_blank" title="https://visualvm.github.io/" ref="nofollow noopener noreferrer">Visual VM</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenjdk.org%2Ftools%2Fsvc%2Fjconsole%2F" target="_blank" title="https://openjdk.org/tools/svc/jconsole/" ref="nofollow noopener noreferrer">JConsole</a> 等工具的性能分析功能；</li>
<li>此外，<a href="https://link.juejin.cn?target=https%3A%2F%2Fskywalking.apache.org%2F" target="_blank" title="https://skywalking.apache.org/" ref="nofollow noopener noreferrer">SkyWalking</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpinpoint-apm%2Fpinpoint" target="_blank" title="https://github.com/pinpoint-apm/pinpoint" ref="nofollow noopener noreferrer">Pinpoint</a> 等 APM 系统也是基于 Java Agent 实现的；</li>
</ul>
<h2 data-id="heading-0">Java Agent 简单示例</h2>
<p>为了对 Java Agent 的概念有一个更直观的认识，我们从一个简单的示例入手，从零开始实现一个 Java Agent。先创建如下目录结构：</p>
<pre><code class="hljs language-css" lang="css">├── pom<span class="hljs-selector-class">.xml</span>
└── <span class="hljs-attribute">src</span>
  └── <span class="hljs-selector-tag">main</span>
    ├── java
    │   └── com
    │     └── example
    │       └── AgentDemo<span class="hljs-selector-class">.java</span>
    └── resources
      └── META-INF
        └── MANIFEST<span class="hljs-selector-class">.MF</span>
</code></pre>
<p>包含三个主要文件：</p>
<ul>
<li><code>pom.xml</code> - Maven 项目的配置文件</li>
<li><code>AgentDemo.java</code> - Java Agent 的入口类</li>
<li><code>MANIFEST.MF</code> - 元数据文件，用于描述打包的 JAR 文件中的各种属性和信息</li>
</ul>
<p>Java Agent 的入口类定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentDemo</span> {

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> {
    System.out.println(<span class="hljs-string">"premain"</span>);
  }
}
</code></pre>
<p>我们知道，常规 Java 程序的入口方法是 <code>main</code> 函数，而 Java Agent 的入口方法是 <code>premain</code> 函数。其中，<code>String agentArgs</code> 是传递给 Agent 的参数，比如当我们运行 <code>java -javaagent:agent-demo.jar=some-args app.jar</code> 命名时，参数 <code>agentArgs</code> 的值就是字符串 <code>some-args</code>；另一个参数 <code>Instrumentation inst</code> 是 JVM 提供的修改字节码的接口，我们可以通过这个接口定位到希望修改的类并做出修改。</p>
<p><strong>Instrumentation API</strong> 是 Java Agent 的核心，它可以在加载 class 文件之前做拦截，对字节码做修改（<code>addTransformer</code>），也可以在运行时对已经加载的类的字节码做变更（<code>retransformClasses</code> 或 <code>redefineClasses</code>）；Instrumentation 的英文释义是插桩或植入，所以这个操作又被称为 <strong>字节码插桩</strong>，由于这个操作非常的底层，一般会配合一些字节码修改的库，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasm.ow2.io%2F" target="_blank" title="https://asm.ow2.io/" ref="nofollow noopener noreferrer">ASM</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javassist.org%2F" target="_blank" title="https://www.javassist.org/" ref="nofollow noopener noreferrer">Javassist</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytebuddy.net%2F" target="_blank" title="https://bytebuddy.net/" ref="nofollow noopener noreferrer">Byte Buddy</a> 等。关于 Instrumentation API 是一个较为艰深复杂的话题，本文为简单起见，没有深入展开，感兴趣的同学可以自行查找相关资料。</p>
<p>有了 Java Agent 的入口类之后，我们还需要告诉 JVM 这个入口类的位置，可以在 <code>MANIFEST.MF</code> 元数据文件中通过 <code>Premain-Class</code> 参数来描述：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Premain-Class: com.example.AgentDemo</span>
</code></pre>
<p>打包的时候，要注意将 <code>MANIFEST.MF</code> 文件一起打到 jar 包里，这可以通过打包插件 <code>maven-assembly-plugin</code> 来实现：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="hljs-tag">&lt;/<span class="hljs-name">manifestFile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>single<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>最后，执行 <code>mvn clean package</code> 打包命令，生成 <code>target/agent-demo-1.0-SNAPSHOT-jar-with-dependencies.jar</code> 文件，我们就得到了一个最简单的 Java Agent 了。</p>
<h2 data-id="heading-1">Java Agent 的两种加载方式</h2>
<p>Java Agent 最常见的使用方式是在运行 <code>java</code> 命令时通过 <code>-javaagent</code> 参数指定要加载的 Agent 文件：</p>
<pre><code class="hljs language-csharp" lang="csharp">$ java -javaagent:agent-demo<span class="hljs-number">-1.0</span>-SNAPSHOT-jar-<span class="hljs-keyword">with</span>-dependencies.jar Hello.java
</code></pre>
<p>这种方式被称为 <strong>静态加载（static loading）</strong>。在这种情况下，Java Agent 和应用程序一起启动，并在运行主程序的 <code>main</code> 方法之前先调用 Java Agent 的 <code>premain</code> 方法，下面是程序的运行结果：</p>
<pre><code class="hljs">premain
Hello
</code></pre>
<p>既然有静态加载，自然就有动态加载。<strong>动态加载（dynamic loading）</strong> 指的是将 Java Agent 动态地加载到已运行的 JVM 进程中，当我们不希望中断生产环境中已经运行的应用程序时，这个特性非常有用。</p>
<p>我们先正常启动一个 Java 应用程序：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>java <span class="hljs-title class_">Hello</span>.java
<span class="hljs-title class_">Hello</span>
</code></pre>
<p>通过 <code>jps</code> 得到该程序的 PID，然后使用 Java 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjdk.attach%2Fcom%2Fsun%2Ftools%2Fattach%2FVirtualMachine.html" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.attach/com/sun/tools/attach/VirtualMachine.html" ref="nofollow noopener noreferrer">Attach API</a> <strong>附加（attach）</strong> 到该程序上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">pidOfOtherJVM</span> <span class="hljs-operator">=</span> <span class="hljs-string">"3378"</span>;
<span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(pidOfOtherJVM);
</code></pre>
<p>附加成功后得到 <code>VirtualMachine</code> 实例，<code>VirtualMachine</code> 提供了一个 <code>loadAgent()</code> 方法用于动态加载 Java Agent：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">File</span> <span class="hljs-variable">agentJar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/com.docker.devenvironments.code/agent-demo-1.0-SNAPSHOT-jar-with-dependencies.jar"</span>);
vm.loadAgent(agentJar.getAbsolutePath());

<span class="hljs-comment">// do other works</span>

vm.detach();
</code></pre>
<p>查看应用程序的日志，可以发现如下报错：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Failed <span class="hljs-keyword">to</span> find Agent-<span class="hljs-keyword">Class</span> manifest attribute <span class="hljs-keyword">from</span> /com.docker.devenvironments.code/agent-demo.jar
</code></pre>
<p>这是因为目前我们这个 Java Agent 还不支持动态加载，动态加载的入口并不是 <code>premain</code> 函数，而是 <code>agentmain</code> 函数，我们在 <code>AgentDemo</code> 类中新增代码如下：</p>
<pre><code class="hljs language-java" lang="java">...
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> {
    System.out.println(<span class="hljs-string">"agentmain"</span>);
  }
...
</code></pre>
<p>并在 <code>MANIFEST.MF</code> 文件中新增 <code>Agent-Class</code> 参数：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Agent-Class: com.example.AgentDemo</span>
</code></pre>
<p>重新打包，并再次动态加载，可以在应用程序中看到日志如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">WARNING:</span> A Java agent has been loaded dynamically (/com.docker.devenvironments.code/agent-demo-<span class="hljs-number">1.0</span>-SNAPSHOT-jar-<span class="hljs-keyword">with</span>-dependencies.jar)
<span class="hljs-symbol">WARNING:</span> <span class="hljs-keyword">If</span> a serviceability tool <span class="hljs-built_in">is</span> <span class="hljs-keyword">in</span> use, please run <span class="hljs-keyword">with</span> -XX:+EnableDynamicAgentLoading <span class="hljs-keyword">to</span> hide this warning
<span class="hljs-symbol">WARNING:</span> <span class="hljs-keyword">If</span> a serviceability tool <span class="hljs-built_in">is</span> <span class="hljs-built_in">not</span> <span class="hljs-keyword">in</span> use, please run <span class="hljs-keyword">with</span> -Djdk.instrument.traceUsage <span class="hljs-keyword">for</span> more information
<span class="hljs-symbol">WARNING:</span> Dynamic loading <span class="hljs-keyword">of</span> agents will be disallowed <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">in</span> a future release
agentmain
</code></pre>
<p>可以看到 <code>agentmain</code> 函数被成功执行，动态加载生效了。</p>
<h2 data-id="heading-2">禁用 Java Agent 的动态加载</h2>
<p>在上面的应用程序日志中，我们可以看到几行 WARNING 提示，这其实就是 Java 21 引入的新内容了，当 JVM 检测到有 Java Agent 被动态加载，就会打印这几行警告信息，告知用户动态加载机制将在未来的版本中默认禁用。如果不想看到这样的日志，可以在启动应用程序时加上 <code>-XX:+EnableDynamicAgentLoading</code> 选项：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>java -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+EnableDynamicAgentLoading</span> <span class="hljs-title class_">Hello</span>.java
</code></pre>
<p>那么 Java 21 为什么要禁用 Java Agent 的动态加载呢？这就要提到 Java 所追求的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenjdk.org%2Fjeps%2F8305968" target="_blank" title="https://openjdk.org/jeps/8305968" ref="nofollow noopener noreferrer">Integrity by Default</a> 原则了。Integrity 一般被翻译为 <strong>完整性</strong>，片面的理解就是要保证我们程序中的任何内容，包括数据或代码都是完整的、没有被篡改的。而 Instrumentation API 通过修改已加载到 JVM 中的字节码来改变现有应用程序，在不更改源代码的情况下改变应用程序的行为。当我们静态加载 Java Agent 时，这并不是什么大问题，因为这是用户明确且有意的使用；然而，动态加载则是间接的，它超出了用户的控制范围，可能对用户的应用程序造成严重破坏，很显然并不符合完整性原则。</p>
<p>因此，作为应用程序的所有者，必须有意识地、明确地决定允许和加载哪些 Java Agent：要么使用静态加载，要么通过 <code>-XX:+EnableDynamicAgentLoading</code> 选项允许动态加载。</p>
<h2 data-id="heading-3">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实]]></title>    <link>https://juejin.cn/post/7571348736153157668</link>    <guid>https://juejin.cn/post/7571348736153157668</guid>    <pubDate>2025-11-12T00:44:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736153157668" data-draft-id="7571334572768870443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-11-12T00:44:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:44:21.000Z" title="Wed Nov 12 2025 00:44:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：告别技术门槛，拥抱创意自由</h2>
<p>你是否曾有过这样的经历：脑海中闪现一个绝妙的 App 想法，却因为不懂后端、数据库而只能望洋兴叹？或者看到一张精美的设计稿，想要快速实现却被复杂的前端代码拦住去路？</p>
<p>作为一名长期关注 AI 开发工具的体验者，我最近深度试用了 WeaveFox 这款 AI 全栈开发平台。经过一段时间的实际使用，我可以毫不夸张地说：<strong>WeaveFox 正在重新定义"从想法到产品"的距离</strong>。</p>
<h2 data-id="heading-1">🎯 核心亮点：三大突破性能力</h2>
<h3 data-id="heading-2">1. 图片转代码：行业最准的 1:1 还原</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e7e2b7b66224aae86a18c98acbe8c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=RdYUihv%2FnTkMPQcP6%2BdtOxPqqbY%3D" alt="image.png" loading="lazy"/></p>
<p>在众多 AI 代码生成工具中，WeaveFox 的图片转代码能力可以说是独树一帜。我专门做了一个对比测试：</p>
<p><strong>测试场景</strong>：上传一张包含复杂布局的设计稿</p>
<p><strong>WeaveFox 表现</strong>：</p>
<ul>
<li>✅ <strong>布局精准度</strong>：几乎 100% 还原设计稿布局</li>
<li>✅ <strong>样式细节</strong>：圆角半径、阴影效果、颜色值都高度一致</li>
<li>✅ <strong>响应式适配</strong>：自动生成适配不同屏幕的代码</li>
<li>✅ <strong>代码质量</strong>：生成的 HTML/CSS 结构清晰，易于维护</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c086af4c4499485a9527bea80a0e3884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=LDgxT4X1sSpTT5MXKXk64eSnHBs%3D" alt="image.png" loading="lazy"/></p>
<p>相比其他同类工具，WeaveFox 在细节还原度上明显领先。特别是对于复杂的 UI 组件，其他工具往往只能生成大致框架，而 WeaveFox 能够精确到像素级别的还原。</p>
<h3 data-id="heading-3">2. 全栈开发：打破"仅能做前端"的局限</h3>
<p>这是 WeaveFox 最让我惊喜的地方。传统的 AI 代码工具大多只能生成前端页面，而 WeaveFox 实现了真正的<strong>全栈一体化开发</strong>。</p>
<p><strong>实战案例：制作一个"健身打卡记录"应用</strong></p>
<p>我用一句话描述需求：<em>"做一个个人健身记录应用，用户可以添加每日运动记录，包括运动类型、时长、消耗卡路里，支持数据统计和进度可视化。"</em></p>
<p><strong>WeaveFox 的完整交付</strong>：</p>
<h4 data-id="heading-4">🗄️ 数据库层</h4>
<ul>
<li>自动创建用户表和运动记录表</li>
<li>包含运动类型、时长、卡路里、日期等字段</li>
<li>建立合理的表关联关系，无需手写 SQL</li>
</ul>
<h4 data-id="heading-5">⚙️ 后端服务</h4>
<ul>
<li>自动生成完整的 API 接口</li>
<li>实现运动记录的增删改查功能</li>
<li>包含数据统计计算（周/月运动总时长、卡路里消耗等）</li>
<li>自动处理数据验证和异常情况</li>
</ul>
<h4 data-id="heading-6">🎨 前端界面</h4>
<ul>
<li>简洁的运动记录添加表单</li>
<li>直观的数据统计图表展示</li>
<li>个人运动历史记录列表</li>
<li>响应式设计适配移动端</li>
</ul>
<h4 data-id="heading-7">🚀 一键部署</h4>
<ul>
<li>自动打包构建</li>
<li>免运维托管</li>
<li>立即获得可分享的访问链接</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0afec5164f6e4c4683a48b31e297c09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=nFLsOxhOz0Yms7kvzLTsjqUAKLM%3D" alt="0350b87f32c2772852bd600e60eb0525.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abb20225309443888febc0e6e811b00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=x%2FlhaktEC6Jh44kNTRFxvp94hrQ%3D" alt="b1e738a28d5f7ce1a5f8f1231bc2cffb.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4a6dd4f1db49cdb6e118859f1ffb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=kRrkZEbIOFIZKFl3leW7lcbaSeg%3D" alt="" loading="lazy"/></p>
<p>整个过程不到 10 分钟，从想法到可用的产品，这种效率是传统开发方式无法想象的。</p>
<h3 data-id="heading-8">3. 持续迭代：指哪打哪的精准优化</h3>
<p>更令人印象深刻的是，WeaveFox 支持通过自然语言进行持续优化：</p>
<ul>
<li>🔄 <strong>局部修改</strong>："完善运动目标设置功能，用户可以设定每月每周运动时长目标" → 自动增加目标管理模块</li>
<li>🎨 <strong>样式调整</strong>："图表颜色改为健康绿色主题，增加运动激励感" → 立即更新视觉风格</li>
<li>⚡ <strong>功能增强</strong>："支持运动类型自定义，用户可以添加新的运动项目" → 自动完成扩展逻辑</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f14a8421c1d48caadfa4d0ef934599c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=DnYqAIxHNEGsfXk%2FbR2L3Wdmaak%3D" alt="a06c0b2bcd5a4c11fecf9d46aac20786.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cc5701351340b39459296f11e26075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=4yZvUTfVQZ%2BOLLsLZ0ouylz6Onw%3D" alt="image.png" loading="lazy"/></p>
<p>这种"对话式开发"的体验，让产品迭代变得前所未有的简单。</p>
<h2 data-id="heading-9">🏆 实际应用价值：解决真实痛点</h2>
<h3 data-id="heading-10">对个人开发者</h3>
<ul>
<li><strong>降低技术门槛</strong>：无需掌握复杂的后端技术栈</li>
<li><strong>提升开发效率</strong>：从几周缩短到几分钟</li>
<li><strong>专注创意本身</strong>：把时间花在产品设计而非技术实现</li>
</ul>
<h3 data-id="heading-11">对小团队/初创公司</h3>
<ul>
<li><strong>快速验证想法</strong>：低成本制作 MVP 产品</li>
<li><strong>节省人力成本</strong>：一个人完成全栈开发工作</li>
<li><strong>加速产品迭代</strong>：快速响应用户反馈</li>
</ul>
<h3 data-id="heading-12">对设计师</h3>
<ul>
<li><strong>设计稿直接变产品</strong>：无需等待开发排期</li>
<li><strong>交互效果实时预览</strong>：设计想法立即可视化</li>
<li><strong>与开发无缝协作</strong>：减少沟通成本</li>
</ul>
<h2 data-id="heading-13">💡 使用建议与最佳实践</h2>
<p>基于我的使用经验，分享几个实用建议：</p>
<h3 data-id="heading-14">1. 需求描述要具体</h3>
<ul>
<li>❌ 模糊："做一个健身应用"</li>
<li>✅ 具体："做一个个人健身记录应用，支持添加运动记录、卡路里统计、进度图表展示和目标设定"</li>
</ul>
<h3 data-id="heading-15">2. 善用迭代优化</h3>
<ul>
<li>先生成基础版本</li>
<li>通过对话逐步完善功能</li>
<li>重点关注用户体验细节</li>
</ul>
<h3 data-id="heading-16">3. 充分利用全栈能力</h3>
<ul>
<li>不要局限于前端页面</li>
<li>考虑数据存储和业务逻辑</li>
<li>规划完整的用户流程</li>
</ul>
<h2 data-id="heading-17">🚀 总结：AI 时代的开发新范式</h2>
<p>经过深度体验，我认为 WeaveFox 代表了 AI 辅助开发的一个重要里程碑。它不仅仅是一个代码生成工具，更是一个<strong>创意实现平台</strong>。</p>
<p><strong>核心优势</strong>：</p>
<ul>
<li>🎯 <strong>精准度领先</strong>：图片转代码行业最准</li>
<li>🔧 <strong>能力完整</strong>：真正的全栈一体化开发</li>
<li>⚡ <strong>效率极高</strong>：从想法到产品几分钟搞定</li>
<li>🎨 <strong>体验友好</strong>：自然语言交互，零技术门槛</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>快速原型验证</li>
<li>个人项目开发</li>
<li>小团队产品迭代</li>
<li>创意想法实现</li>
</ul>
<p>在 AI 技术快速发展的今天，WeaveFox 让我们看到了"人人都是全栈开发者"的可能性。它降低了技术门槛，释放了创意潜能，让更多有想法的人能够将创意转化为现实产品。</p>
<p>如果你也有一个一直想要实现的 App 想法，不妨试试 WeaveFox。也许下一个改变世界的产品，就诞生在你的一句话描述中。</p>
<hr/>
<p><strong>体验地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.weavefox.cn%2F" target="_blank" title="https://www.weavefox.cn/" ref="nofollow noopener noreferrer">www.weavefox.cn/</a></p>
<p><em>用 AI 编织创意，让代码服务于人。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NodeJS创建流式接口&AI大模型接口流式调用记录]]></title>    <link>https://juejin.cn/post/7571378103282204678</link>    <guid>https://juejin.cn/post/7571378103282204678</guid>    <pubDate>2025-11-12T04:03:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103282204678" data-draft-id="7571348736154140708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NodeJS创建流式接口&amp;AI大模型接口流式调用记录"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-12T04:03:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端君"/> <meta itemprop="url" content="https://juejin.cn/user/395479919102856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NodeJS创建流式接口&amp;AI大模型接口流式调用记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479919102856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T04:03:29.000Z" title="Wed Nov 12 2025 04:03:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>什么是流式文本传输？</strong></p>
<p>流式文本传输是一种在数据生成后立即传输，而不是等待所有数据生成完毕再一次性传输的技术。这种传输方式可以显著提升用户体验，特别是在处理大量数据或需要实时响应的场景中。</p>
<p>流式传输的主要优势：</p>
<ul>
<li><strong>实时响应</strong>：用户可以立即看到部分结果，而不必等待整个过程完成</li>
<li><strong>减少内存占用</strong>：数据可以边生成边传输，避免在内存中缓存大量数据</li>
<li><strong>更好的用户体验</strong>：特别是在AI生成内容、长文本处理等场景下</li>
</ul>
<h3 data-id="heading-0">NodeJS + Koa 流式接口示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Readable</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();

<span class="hljs-comment">// 流式响应中间件</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx) =&gt; {
  <span class="hljs-comment">// 设置响应头</span>
  ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
  ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Transfer-Encoding'</span>, <span class="hljs-string">'chunked'</span>);
  
  <span class="hljs-comment">// 创建一个可读流</span>
  <span class="hljs-keyword">const</span> readableStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Readable</span>({
    <span class="hljs-title function_">read</span>(<span class="hljs-params">size</span>) {
      <span class="hljs-comment">// 这个方法会在流需要更多数据时被调用</span>
    }
  });
  
  <span class="hljs-comment">// 模拟异步生成数据的过程</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-string">'这是,第一部分,数据,\n这是,第二部分,数据\n这是,第三部分,数据,\n这是,第四部分,数据,\n这是最后一部分数据\n'</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> data) {
      <span class="hljs-comment">// 模拟处理延迟</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
      <span class="hljs-comment">// 将数据推入流中</span>
      readableStream.<span class="hljs-title function_">push</span>(chunk);
    }
    
    <span class="hljs-comment">// 结束流</span>
    readableStream.<span class="hljs-title function_">push</span>(<span class="hljs-literal">null</span>);
  }
  
  <span class="hljs-comment">// 启动数据生成</span>
  <span class="hljs-title function_">generateData</span>();
  
  <span class="hljs-comment">// 将流管道到响应对象</span>
  ctx.<span class="hljs-property">body</span> = readableStream;
});

<span class="hljs-comment">// 启动服务器</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器运行在 http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<h3 data-id="heading-1">NodeJS 发送流式请求</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">/**
 * Node.js版本的流式查询函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} options.params - 请求参数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onStart] - 开始回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onChange] - 数据变化回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onFinish] - 完成回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onError] - 错误回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.chunkTransform] - 数据块转换函数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">streamRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  <span class="hljs-keyword">const</span> parsedUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
  <span class="hljs-keyword">const</span> isHttps = parsedUrl.<span class="hljs-property">protocol</span> === <span class="hljs-string">'https:'</span>;
  <span class="hljs-keyword">const</span> requestModule = isHttps ? https : http;

  <span class="hljs-keyword">if</span> (searchParams) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      parsedUrl.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
  }

  <span class="hljs-keyword">const</span> requestOptions = {
    <span class="hljs-attr">hostname</span>: parsedUrl.<span class="hljs-property">hostname</span>,
    <span class="hljs-attr">port</span>: parsedUrl.<span class="hljs-property">port</span> || (isHttps ? <span class="hljs-number">443</span> : <span class="hljs-number">80</span>),
    <span class="hljs-attr">path</span>: parsedUrl.<span class="hljs-property">pathname</span> + parsedUrl.<span class="hljs-property">search</span>,
    method,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    },
  };

  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> aborted = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">const</span> req = requestModule.<span class="hljs-title function_">request</span>(requestOptions, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> !== <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">let</span> errorData = <span class="hljs-string">''</span>;
      res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
        errorData += chunk.<span class="hljs-title function_">toString</span>();
      });
      res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${res.statusMessage}</span>\n<span class="hljs-subst">${errorData}</span>`</span>);
        onError?.(error);
      });
      <span class="hljs-keyword">return</span>;
    }

    res.<span class="hljs-title function_">setEncoding</span>(<span class="hljs-string">'utf8'</span>);

    <span class="hljs-comment">// 监听第一个数据块</span>
    res.<span class="hljs-title function_">once</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">() =&gt;</span> {
      onStart?.();
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (aborted) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> chunkStr = chunk?.<span class="hljs-title function_">toString</span>();
      <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(chunkStr) : chunkStr;
      fullText += transformedChunk;
      onChange?.(transformedChunk, fullText);
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!aborted) {
        onFinish?.(fullText);
      }
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onError !== <span class="hljs-string">'function'</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
          <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!aborted) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Response error:'</span>, error);
        onError?.(error);
      }
    });
  });

  req.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!aborted) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Request error:'</span>, error);
      onError?.(error);
    }
  });

  <span class="hljs-comment">// 发送请求体（如果是POST请求）</span>
  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
    req.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body));
  }

  req.<span class="hljs-title function_">end</span>();

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      aborted = <span class="hljs-literal">true</span>;
      req.<span class="hljs-title function_">destroy</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
    },
  };
};
</code></pre>
<h3 data-id="heading-2">浏览器中发送流式请求</h3>
<ul>
<li>基于 <code>fetch</code> 实现</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 浏览器版本的流式查询函数
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">browserStreamRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  
  <span class="hljs-keyword">let</span> controller = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> isStarted = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> isFinished = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildFetchUrl</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!searchParams) <span class="hljs-keyword">return</span> url;
    
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
    <span class="hljs-keyword">return</span> urlObj.<span class="hljs-title function_">toString</span>();
  };
  
  <span class="hljs-keyword">const</span> fetchOptions = {
    method,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    },
    <span class="hljs-comment">// 允许跨域凭证</span>
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
  };
  
  <span class="hljs-comment">// 设置信号用于中断请求</span>
  controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  fetchOptions.<span class="hljs-property">signal</span> = controller.<span class="hljs-property">signal</span>;
  
  <span class="hljs-comment">// 添加请求体（如果是POST请求）</span>
  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
    fetchOptions.<span class="hljs-property">body</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body);
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">processStream</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-title function_">buildFetchUrl</span>(), fetchOptions);
      
      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
        <span class="hljs-keyword">let</span> errorData = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">try</span> {
          errorData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">text</span>();
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// 忽略解析错误</span>
        }
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${response.status}</span> <span class="hljs-subst">${response.statusText}</span>\n<span class="hljs-subst">${errorData}</span>`</span>);
        onError?.(error);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 检查响应是否支持流式处理</span>
      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">body</span>) {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Response body is not streamable'</span>);
        onError?.(error);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 创建TextDecoder用于解码二进制流</span>
      <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
      <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
      
      <span class="hljs-comment">// 流式处理数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">readStream</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
          
          <span class="hljs-keyword">if</span> (done) {
            <span class="hljs-keyword">if</span> (!isFinished) {
              isFinished = <span class="hljs-literal">true</span>;
              onFinish?.(fullText);
            }
            <span class="hljs-keyword">return</span>;
          }
          
          <span class="hljs-comment">// 首次收到数据时触发onStart</span>
          <span class="hljs-keyword">if</span> (!isStarted) {
            isStarted = <span class="hljs-literal">true</span>;
            onStart?.();
          }
          
          <span class="hljs-comment">// 解码并处理数据块</span>
          <span class="hljs-keyword">const</span> chunkStr = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(chunkStr) : chunkStr;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
          
          <span class="hljs-comment">// 继续读取流</span>
          <span class="hljs-title function_">readStream</span>();
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">if</span> (!isFinished &amp;&amp; !controller?.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Stream processing error:'</span>, error);
            onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
          }
        }
      };
      
      <span class="hljs-title function_">readStream</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (!isFinished &amp;&amp; !controller?.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch request error:'</span>, error);
        onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
      }
    }
  };
  
  <span class="hljs-comment">// 立即开始处理流</span>
  <span class="hljs-title function_">processStream</span>();
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (controller) {
        controller.<span class="hljs-title function_">abort</span>();
        isFinished = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
      }
    },
  };
};

</code></pre>
<ul>
<li>低版本浏览器（如 IE11）不支持 <code>fetch</code> 流式传输，需要使用 XHR 实现</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 浏览器兼容性检查
 * <span class="hljs-doctag">@returns</span> 是否支持流式请求
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">isStreamSupported</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> !!(<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReadableStream</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">TextDecoder</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">AbortController</span>);
};

<span class="hljs-comment">/**
 * 降级版本的请求函数（当浏览器不支持流式处理时使用）
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fallbackRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  
  <span class="hljs-keyword">let</span> xhr = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildUrl</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!searchParams) <span class="hljs-keyword">return</span> url;
    
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
    <span class="hljs-keyword">return</span> urlObj.<span class="hljs-title function_">toString</span>();
  };
  
  <span class="hljs-keyword">try</span> {
    xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(method, <span class="hljs-title function_">buildUrl</span>(), <span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 设置响应类型为文本</span>
    xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">'text'</span>;
    
    <span class="hljs-comment">// 设置请求头</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>({
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    }).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      xhr?.<span class="hljs-title function_">setRequestHeader</span>(key, value);
    });
    
    <span class="hljs-comment">// 监听进度事件（非标准流式处理）</span>
    xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span> || xhr?.<span class="hljs-property">responseText</span>) {
        <span class="hljs-keyword">const</span> currentText = xhr?.<span class="hljs-property">responseText</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">const</span> newChunk = currentText.<span class="hljs-title function_">substring</span>(fullText.<span class="hljs-property">length</span>);
        
        <span class="hljs-keyword">if</span> (newChunk &amp;&amp; fullText.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-comment">// 首次收到数据</span>
          onStart?.();
        }
        
        <span class="hljs-keyword">if</span> (newChunk) {
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(newChunk) : newChunk;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
        }
      }
    };
    
    xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr?.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 确保处理完所有数据</span>
        <span class="hljs-keyword">const</span> currentText = xhr.<span class="hljs-property">responseText</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (currentText !== fullText) {
          <span class="hljs-keyword">const</span> newChunk = currentText.<span class="hljs-title function_">substring</span>(fullText.<span class="hljs-property">length</span>);
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(newChunk) : newChunk;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
        }
        onFinish?.(fullText);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${xhr?.status}</span> <span class="hljs-subst">${xhr?.statusText}</span>\n<span class="hljs-subst">${xhr?.responseText || <span class="hljs-string">''</span>}</span>`</span>);
        onError?.(error);
      }
    };
    
    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network error occurred'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'XHR error:'</span>, error);
      onError?.(error);
    };
    
    <span class="hljs-comment">// 发送请求</span>
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
      xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body));
    } <span class="hljs-keyword">else</span> {
      xhr.<span class="hljs-title function_">send</span>();
    }
    
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fallback request initialization error:'</span>, error);
    onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr) {
        xhr.<span class="hljs-title function_">abort</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
      }
    },
  };
};

<span class="hljs-comment">/**
 * 智能流式请求函数 - 根据浏览器支持情况自动选择实现方式
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">smartStreamRequest</span> = (<span class="hljs-params">options</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isStreamSupported</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Using native fetch stream implementation'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">browserStreamRequest</span>(options);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Using fallback XHR implementation'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackRequest</span>(options);
  }
};
</code></pre>
<h3 data-id="heading-3">浏览器端流式请求使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本使用示例</span>
<span class="hljs-keyword">const</span> streamInstance = <span class="hljs-title function_">smartStreamRequest</span>({
  <span class="hljs-attr">params</span>: {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/stream'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: {
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">'Tell me a story'</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-attr">onStart</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Stream started'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">'Streaming...'</span>);
  },
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">chunk, fullText</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Received chunk: <span class="hljs-subst">${chunk}</span>`</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>)?.<span class="hljs-title function_">textContent</span>(fullText);
  },
  <span class="hljs-attr">onFinish</span>: <span class="hljs-function">(<span class="hljs-params">fullText</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Stream finished, total text: <span class="hljs-subst">${fullText.length}</span> characters`</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">'Completed'</span>);
  },
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Stream error:'</span>, error);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">`Error: <span class="hljs-subst">${error.message}</span>`</span>);
  },
  <span class="hljs-comment">// 可选的数据转换函数</span>
  <span class="hljs-attr">chunkTransform</span>: <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
    <span class="hljs-comment">// 例如处理特定格式的流式数据</span>
    <span class="hljs-keyword">return</span> chunk.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^data: /</span>, <span class="hljs-string">''</span>);
  }
});

<span class="hljs-comment">// 中断请求的示例</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  streamInstance.<span class="hljs-title function_">abort</span>();
}, <span class="hljs-number">5000</span>);
</code></pre>
<h4 data-id="heading-4">常见问题处理</h4>
<ol>
<li><strong>CORS 问题</strong>：确保服务器端正确配置了 CORS 响应头，特别是当需要流式传输时</li>
<li><strong>超时处理</strong>：可以通过 <code>setTimeout</code> 和 <code>abort()</code> 方法实现请求超时控制</li>
<li><strong>内存管理</strong>：对于长时间运行的流，注意监控内存使用情况，避免内存泄漏</li>
<li><strong>错误恢复</strong>：可以实现重试逻辑，在 <code>onError</code> 回调中重新发起请求</li>
</ol>
<h2 data-id="heading-5">案例: 流式调用免费的AI大模型接口（来自硅基流动）</h2>
<blockquote>
<p>备注：硅基流动（SiliconFlow）是一家提供免费AI大模型服务的公司，其API接口支持流式传输。其中token可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fme%2Faccount%2Fak" target="_blank" title="https://cloud.siliconflow.cn/me/account/ak" ref="nofollow noopener noreferrer">硅基流动API密钥管理</a> 处创建。API介绍见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.siliconflow.cn%2Fcn%2Fapi-reference%2Fchat-completions%2Fchat-completions" target="_blank" title="https://docs.siliconflow.cn/cn/api-reference/chat-completions/chat-completions" ref="nofollow noopener noreferrer">API手册</a></p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callSiliconFlowAPI</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.siliconflow.cn/v1/chat/completions'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer &lt;token&gt;'</span>, <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: {
      <span class="hljs-attr">model</span>: <span class="hljs-string">'Qwen/Qwen2.5-7B-Instruct'</span>,
      <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你好'</span> }],
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    },
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">streamRequest</span>({
      <span class="hljs-attr">params</span>: options,
      <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">chunk, fullText</span>) =&gt;</span> {
        process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
      },
      <span class="hljs-attr">chunkTransform</span>: extractContentFromSiliconFlowChunk,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
  }
}
<span class="hljs-comment">/**
 * 从 SiliconFlow 模型的响应 chunk 中提取实际内容
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">chunk</span> - 包含 SiliconFlow 响应的 chunk 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} - 提取后的实际内容
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractContentFromSiliconFlowChunk</span> (chunk) {
  <span class="hljs-keyword">return</span> chunk?.<span class="hljs-title function_">trim</span>()
    .<span class="hljs-title function_">split</span>(<span class="hljs-string">'data: '</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item &amp;&amp; !item.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'[DONE]'</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(item.<span class="hljs-title function_">trim</span>());
      <span class="hljs-keyword">const</span> delta = json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span> || json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;
      <span class="hljs-keyword">const</span> res = delta?.<span class="hljs-property">content</span> ?? delta?.<span class="hljs-property">reasoning_content</span> ?? <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> res;
    })
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VonaJS: I18n如何支持Swagger多语言]]></title>    <link>https://juejin.cn/post/7571378103281336326</link>    <guid>https://juejin.cn/post/7571378103281336326</guid>    <pubDate>2025-11-12T02:03:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103281336326" data-draft-id="7571306072424071210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VonaJS: I18n如何支持Swagger多语言"/> <meta itemprop="keywords" content="TypeScript,Node.js,NestJS"/> <meta itemprop="datePublished" content="2025-11-12T02:03:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="濮水大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1119781972622208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VonaJS: I18n如何支持Swagger多语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1119781972622208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    濮水大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:03:25.000Z" title="Wed Nov 12 2025 02:03:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>VonaJS提供的I18n支持模块化体系。每个业务模块都可以单独提供自己的 I18n 语言资源。我们先了解I18n的一般用法，然后再看看如何支持Swagger多语言</p>
<h2 data-id="heading-0">初始化代码骨架</h2>
<p>我们先在模块<code>demo-student</code>中初始化I18n的代码骨架</p>
<h3 data-id="heading-1">1. Cli命令</h3>
<pre><code class="hljs language-bash" lang="bash">$ vona :init:locale demo-student
</code></pre>
<h3 data-id="heading-2">2. 菜单命令</h3>
<pre><code class="hljs language-bash" lang="bash">右键菜单 - [模块路径]: `Vona Init/Locale`
</code></pre>
<h2 data-id="heading-3">定义语言资源</h2>
<p>以模块<code>demo-student</code>为例，定义模块的语言资源：</p>
<ul>
<li>英文</li>
</ul>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ StudentName: 'Student Name',</span>
};
</code></pre>
<ul>
<li>中文</li>
</ul>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ StudentName: '学生名称',</span>
};
</code></pre>
<h2 data-id="heading-4">使用语言资源</h2>
<p>可以通过 Scope 实例提供的<code>locale</code>对象获取模块的语言资源，支持类型化提示</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-meta">@Web</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>)
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// use current locale</span>
    <span class="hljs-keyword">const</span> message1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">StudentName</span>();
    <span class="hljs-comment">// use locale en-us</span>
    <span class="hljs-keyword">const</span> message2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'en-us'</span>);
    <span class="hljs-comment">// use locale zh-cn</span>
    <span class="hljs-keyword">const</span> message3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'zh-cn'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message1, message2, message3);
  }
}  
</code></pre>
<h2 data-id="heading-5">跨模块使用语言资源</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-meta">@Web</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>)
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// use current locale</span>
    <span class="hljs-keyword">const</span> message1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">StudentName</span>();
    <span class="hljs-comment">// use locale en-us</span>
    <span class="hljs-keyword">const</span> message2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'en-us'</span>);
    <span class="hljs-comment">// use locale zh-cn</span>
    <span class="hljs-keyword">const</span> message3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'zh-cn'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message1, message2, message3);
  }
}  
</code></pre>
<h2 data-id="heading-6">覆盖语言资源</h2>
<p>可以使用<code>项目级别</code>的语言资源覆盖<code>模块级别</code>的语言资源</p>
<ul>
<li>英文</li>
</ul>
<p><code>src/backend/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
  modules: {
<span class="hljs-addition">+   'demo-student': {</span>
<span class="hljs-addition">+     StudentName: 'Student Name!',</span>
<span class="hljs-addition">+   },</span>
  },
};
</code></pre>
<ul>
<li>中文</li>
</ul>
<p><code>src/backend/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
  modules: {
<span class="hljs-addition">+   'demo-student': {</span>
<span class="hljs-addition">+     StudentName: '学生名称!',</span>
<span class="hljs-addition">+   },</span>
  },
};
</code></pre>
<h2 data-id="heading-7">当前locale</h2>
<h3 data-id="heading-8">1. 获取当前locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> locale = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span>;
</code></pre>
<h3 data-id="heading-9">2. 设置当前locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
</code></pre>
<h3 data-id="heading-10">3. 获取缺省locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> localeDefault = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">i18n</span>.<span class="hljs-property">config</span>.<span class="hljs-property">defaultLocale</span>;
</code></pre>
<h2 data-id="heading-11">获取当前locale的规则</h2>
<p>当用户访问后端 API 时，后端会自动根据规则获取当前 locale</p>
<h3 data-id="heading-12">1. 模块配置</h3>
<p>I18n 是由模块 a-i18n 提供的核心能力，可以在 App config 中修改模块的配置：</p>
<p><code>src/backend/config/config/config.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// modules</span>
config.<span class="hljs-property">modules</span> = {
  <span class="hljs-string">'a-i18n'</span>: {
    <span class="hljs-attr">defaultLocale</span>: <span class="hljs-string">'en-us'</span>,
    <span class="hljs-attr">queryField</span>: <span class="hljs-string">'x-vona-locale'</span>,
    <span class="hljs-attr">headerField</span>: <span class="hljs-string">'x-vona-locale'</span>,
    <span class="hljs-attr">cookieField</span>: <span class="hljs-string">'locale'</span>,
  },
};
</code></pre>

























<table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>defaultLocale</td><td>Default locale</td></tr><tr><td>queryField</td><td>从request query中获取当前locale，query key默认为<code>x-vona-locale</code></td></tr><tr><td>headerField</td><td>从request header中获取当前locale，header key默认为<code>x-vona-locale</code></td></tr><tr><td>cookieField</td><td>从request cookie中获取当前locale，cookie key默认为<code>locale</code></td></tr></tbody></table>
<h3 data-id="heading-13">2. 规则次序</h3>
<p>系统按以下次序，依次判断当前 locale</p>
<p><code>queryField</code> &gt; <code>headerField</code> &gt; <code>cookieField</code> &gt; <code>Header: Accept-Language</code> &gt; <code>defaultLocale</code></p>
<h2 data-id="heading-14">添加新语言</h2>
<p>VonaJS 默认提供了两个语言:<code>en-us</code>和<code>zh-cn</code>。下面演示如何添加新语言<code>zh-tw</code></p>
<h3 data-id="heading-15">1. 添加类型定义</h3>
<p>采用接口合并机制添加新语言的类型定义</p>
<p>在 VSCode 编辑器中，输入代码片段<code>recordlocale</code>，自动生成代码骨架:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'vona'</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ILocaleRecord</span> {
    : <span class="hljs-built_in">never</span>;
  }
}
</code></pre>
<p>调整代码，然后添加<code>zh-tw</code></p>
<pre><code class="hljs language-diff" lang="diff">declare module 'vona' {
  export interface ILocaleRecord {
<span class="hljs-addition">+   'zh-tw': never;</span>
  }
}
</code></pre>
<h3 data-id="heading-16">2. 添加语言资源</h3>
<p>新建语言文件<code>zh-tw.ts</code>，然后添加语言资源</p>
<p><code>src/module/demo-student/src/config/locale/zh-tw.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title class_">StudentName</span>: <span class="hljs-string">'學生名稱'</span>,
};
</code></pre>
<h2 data-id="heading-17">复数</h2>
<h3 data-id="heading-18">1. 定义语言资源</h3>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestApples_: '%d apples',</span>
<span class="hljs-addition">+ TestApples_0: 'no apples',</span>
<span class="hljs-addition">+ TestApples_1: 'one apple',</span>
};
</code></pre>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestApples_: '%d个苹果',</span>
<span class="hljs-addition">+ TestApples_0: '没有苹果',</span>
};
</code></pre>
<h3 data-id="heading-19">2. 使用语言资源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
<span class="hljs-keyword">const</span> apple0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> apple1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> apple2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apple0}</span>, <span class="hljs-subst">${apple1}</span>, <span class="hljs-subst">${apple2}</span>`</span>);
</code></pre>
<p>控制台输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">no apples, one apple, 2 apples
</code></pre>
<ul>
<li><code>TestApples_</code>: 缺省语言资源。语言资源添加后缀<code>_</code>，可以提示开发者该语言资源需要传入参数</li>
<li><code>TestApples_{n}</code>: 可以针对任何具体的<code>n</code>提供独立的语言资源。系统在进行语言翻译时，如果找不到具体<code>n</code>的语言资源，就使用缺省语言资源<code>TestApples_</code></li>
</ul>
<h2 data-id="heading-20">复数: 多参数</h2>
<p>如果语言资源支持多参数，那么可以明确指定哪个参数支持复数</p>
<h3 data-id="heading-21">1. 定义语言资源</h3>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestNameApples_: '%s has %d apples',</span>
<span class="hljs-addition">+ TestNameApples_0_1: '%s has no apples',</span>
<span class="hljs-addition">+ TestNameApples_1_1: '%s has one apple',</span>
};
</code></pre>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestNameApples_: '%s有%d个苹果',</span>
<span class="hljs-addition">+ TestNameApples_0_1: '%s没有苹果',</span>
};
</code></pre>
<h3 data-id="heading-22">2. 使用语言资源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
<span class="hljs-keyword">const</span> apple0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> apple1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> apple2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apple0}</span>, <span class="hljs-subst">${apple1}</span>, <span class="hljs-subst">${apple2}</span>`</span>);
</code></pre>
<p>控制台输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">Tom has no apples, Tom has one apple, Tom has 2 apples
</code></pre>
<ul>
<li><code>TestNameApples_</code>: 缺省语言资源。语言资源添加后缀<code>_</code>，可以提示开发者该语言资源需要传入参数</li>
<li><code>TestNameApples_{n}_{ordinal}</code>: <code>ordinal</code>代表参数序数</li>
</ul>
<h2 data-id="heading-23">Swagger/Openapi</h2>
<p>VonaJS 提供了一组工具函数，为 Swagger/Openapi 实现 I18n 国际化</p>
<p>比如，为<code>EntityStudent</code>的字段<code>name</code>提供国际化的<code>title</code>信息</p>
<h3 data-id="heading-24">1. $localeScope</h3>
<p>在设置字段 title 信息时，要使用<code>语言资源FullKey</code>。在实际生成 Swagger/Openapi 元数据时，系统会自动将<code>语言资源FullKey</code>翻译为指定的语言</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import { $localeScope } from 'vona';</span>

class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.title($localeScope('demo-student', 'Name')))</span>
  name: string;
}
</code></pre>
<ul>
<li><code>v.title</code>: 设置 title 信息</li>
<li><code>$localeScope</code>: 传入<code>模块名称</code>和<code>语言资源Key</code>，从而生成<code>语言资源FullKey</code>: <code>demo-student::Name</code></li>
</ul>
<h3 data-id="heading-25">2. $locale</h3>
<p>VonaJS 还提供了一个简化的工具函数<code>$locale</code></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import { $locale } from '../.metadata/index.ts';</span>

class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.title($locale('Name')))</span>
  name: string;
}
</code></pre>
<ul>
<li><code>$locale</code>: 传入<code>语言资源Key</code>，从而生成<code>语言资源FullKey</code>: <code>demo-student::Name</code>
<ul>
<li>每个模块都提供了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mtext>函数，因此，使用本模块的</mtext></mrow><annotation encoding="application/x-tex">locale 函数，因此，使用本模块的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">函数，因此，使用本模块的</span></span></span></span></span>locale 函数就可以取得模块名称</li>
</ul>
</li>
</ul>
<h2 data-id="heading-26">资源</h2>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvonajs%2Fvona" target="_blank" title="https://github.com/vonajs/vona" ref="nofollow noopener noreferrer">github.com/vonajs/vona</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org" target="_blank" title="https://vona.js.org" ref="nofollow noopener noreferrer">vona.js.org</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Claude Agent SDK 开发一个 Agent 原来这么简单]]></title>    <link>https://juejin.cn/post/7571372478803787791</link>    <guid>https://juejin.cn/post/7571372478803787791</guid>    <pubDate>2025-11-12T02:03:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803787791" data-draft-id="7571372478803771407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Claude Agent SDK 开发一个 Agent 原来这么简单"/> <meta itemprop="keywords" content="前端,JavaScript,Agent"/> <meta itemprop="datePublished" content="2025-11-12T02:03:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="liruifengv李瑞丰"/> <meta itemprop="url" content="https://juejin.cn/user/237150239994471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Claude Agent SDK 开发一个 Agent 原来这么简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/237150239994471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    liruifengv李瑞丰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:03:17.000Z" title="Wed Nov 12 2025 02:03:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>最近在学习 AI Agent 开发，本文将使用 Claude Agent SDK 的 TypeScript 版本, 构建一个 AI Agent Demo。</p>
<p>全部代码在我的 GitHub 仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliruifengv%2Fclaude-agent-demo" target="_blank" title="https://github.com/liruifengv/claude-agent-demo" ref="nofollow noopener noreferrer">liruifengv/claude-agent-demo</a>。</p>
<h2 data-id="heading-0">Claude Agent SDK 介绍</h2>
<p>Claude Agent SDK 的前身是 Claude Code SDK，是 Claude Code 的底层框架，现在改为通用的 Agent SDK，其中具备了 Claude Code 所拥有的一些基础能力，包括上下文管理，内置丰富的工具，权限控制等，如果你也想构建一个 Agent，使用这个 SDK 能快速搭建起来。更多详情请看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fagent-sdk%2Foverview" target="_blank" title="https://docs.claude.com/en/docs/agent-sdk/overview" ref="nofollow noopener noreferrer">Claude Agent SDK 的文档</a></p>
<h2 data-id="heading-1">环境配置</h2>
<p>首先我们需要初始化一个 Node.js 的空项目。</p>
<p>其次是环境变量，需要配置 Claude 的模型的 BASE_URL 和 API_KEY</p>
<p>两种方式：</p>
<ul>
<li>可以在系统的环境变量里配置：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ANTHROPIC_BASE_URL=ANTHROPIC_BASE_URL
ANTHROPIC_API_KEY=ANTHROPIC_API_KEY
</code></pre>
<ul>
<li>或者在项目的 <code>.env</code> 文件中配置：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ANTHROPIC_BASE_URL=ANTHROPIC_BASE_URL
ANTHROPIC_API_KEY=ANTHROPIC_API_KEY
</code></pre>
<p>然后安装 <code>@anthropic-ai/claude-agent-sdk</code> 这个 npm 包：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @anthropic-ai/claude-agent-sdk
</code></pre>
<h2 data-id="heading-2">基础用法</h2>
<p>首先是 <code>query</code> 函数，他是跟 Agent 交互的主要函数，用于向 Agent 发送请求。</p>
<p>我们来看下用法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { query, <span class="hljs-title class_">Query</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">basicExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// query 函数接受一个 prompt 参数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({<span class="hljs-attr">prompt</span>: <span class="hljs-string">"你好"</span>})

    <span class="hljs-comment">// 这里使用 for await of 循环 result</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result){
      <span class="hljs-comment">// message.type 有几种：'assistant', 'user', 'system', 'result' 等</span>
      <span class="hljs-comment">// 根据不同的消息类型做业务逻辑</span>
      <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>){
        <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
          <span class="hljs-comment">// message.message.content 是一个数组，我们循环所有的 msg</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
            <span class="hljs-comment">// 打印 text 类型的输出</span>
            <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg.<span class="hljs-property">text</span>)
            }
          }
      }
    }
  }
</code></pre>
<p>在 <code>index.ts</code> 中调用 <code>basicExample</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { basicExample } <span class="hljs-keyword">from</span> <span class="hljs-string">"./core/basic-example"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Starting Claude Agent Demo...'</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">basicExample</span>();
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>执行 <code>tsx src/index.ts</code></p>
<p>可以在终端看到</p>
<pre><code class="hljs language-bash" lang="bash">&gt; claude-agent-demo@1.0.0 dev
&gt; tsx src/index.ts

Starting Claude Agent Demo...
你好！很高兴见到你！我是 Claude，一个 AI 助手。我可以帮助你：

- 编写和调试代码
- 搜索和分析代码库
- 执行命令和运行脚本
- 管理文件和项目
- 回答技术问题

有什么我可以帮助你的吗？
</code></pre>
<h2 data-id="heading-3">Session 会话管理</h2>
<p>Claude Agent SDK 自带了会话管理功能，当新建一个 query 时，它会返回一个 session ID，你可以使用这个 ID 来保存和恢复会话。例如，你可以将 session ID 存储在数据库中，以便在用户下次登录时恢复会话。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {query, <span class="hljs-title class_">Query</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sessionExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">"你好"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-comment">// options 的 resume 参数传入记录的 sessionId，就可以继续对话了</span>
          <span class="hljs-attr">resume</span>: sessionId
      }
  })

  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-comment">// message.type === 'assistant' &amp;&amp; message.subtype === 'init' 的时候</span>
      <span class="hljs-comment">// 会返回一个 session_id，需要把这个 session_id 存下来</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          sessionId = message.<span class="hljs-property">session_id</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Current Session ID: <span class="hljs-subst">${sessionId}</span>`</span>)
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-4">实现连续对话</h2>
<p>接下来我们会在终端使用 node 做一下简单的交互，使得用户可输入内容，然后使用 session ID 实现连续对话。</p>
<p>创建一个 <code>tui-chat.ts</code>:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tuiChat</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
        <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
        <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
        <span class="hljs-attr">prompt</span>: <span class="hljs-string">'User: '</span>
    })

    rl.<span class="hljs-title function_">prompt</span>()

    rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'line'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>) =&gt; {
        <span class="hljs-keyword">const</span> userInput = input.<span class="hljs-title function_">trim</span>()
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`User: <span class="hljs-subst">${userInput}</span>`</span>)
        rl.<span class="hljs-title function_">prompt</span>()
    })


    rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"exit the chat"</span>)
        process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
    });

}
</code></pre>
<p>以上代码就能实现用户在终端连续输入内容。
接着写 AI 对话的代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 这个函数接收两个参数，一个 prompt 用户输入，一个当前会话 id</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatExample</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span>, sessionId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) {

  <span class="hljs-comment">// 函数内部定义会话 id</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">_sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
    <span class="hljs-attr">prompt</span>: prompt,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-comment">// options 的 resume 参数传入记录的 sessionId，就可以继续对话了</span>
      <span class="hljs-attr">resume</span>: sessionId
    }
  })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          <span class="hljs-comment">// 系统初始化时记录会话ID</span>
          _sessionId = message.<span class="hljs-property">session_id</span>
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-comment">// 把当前会话 id 返回给调用者</span>
  <span class="hljs-keyword">return</span> _sessionId
}
</code></pre>
<p>然后调用这个 <code>chatExample</code> 就行：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tuiChat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 记录 sessionId</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
    <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
    <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">'User: '</span>
  })

  rl.<span class="hljs-title function_">prompt</span>()

  rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'line'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>) =&gt; {
    <span class="hljs-keyword">const</span> userInput = input.<span class="hljs-title function_">trim</span>()
    <span class="hljs-comment">// 赋值返回的 sessionId</span>
    sessionId = <span class="hljs-keyword">await</span> <span class="hljs-title function_">chatExample</span>(userInput, sessionId)

    rl.<span class="hljs-title function_">prompt</span>()
  })


  rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"exit the chat"</span>)
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
  });
}
</code></pre>
<p>好的，现在我们来执行一下看看效果：</p>
<pre><code class="hljs language-bash" lang="bash">Starting Claude Agent Demo...
User: hello
Assistant: Hello! 👋 How can I <span class="hljs-built_in">help</span> you today? I<span class="hljs-string">'m Claude, and I can assist you with a variety of tasks like:

- Writing, editing, or reviewing code
- Searching through codebases and files
- Running commands and tests
- Creating pull requests and managing git operations
- Answering questions about your project
- And much more!

What would you like to work on?
User: 你是谁
Assistant: 你好！我是 Claude，由 Anthropic 开发的 AI 助手。

在这个环境中，我是 Claude Code - 一个专门用于编程和开发任务的版本。我可以帮助你：

- 编写、编辑和审查代码
- 搜索和分析代码库
- 运行命令和测试
- 管理 Git 操作和创建 Pull Request
- 回答关于项目的问题
- 还有更多其他功能！

有什么我可以帮助你的吗？
User: 我跟你说的上一句话是什么
Assistant: 你上一句话是"你是谁"。
</span></code></pre>
<p>完美，我们可以在终端和 Agent 连续对话了，它能记住我们上一句话，说明当前会话是有效的。</p>
<h2 data-id="heading-5">工具调用</h2>
<p>接下来我们会自定义一个用于数学计算的工具，和一个 MCP Server。</p>
<p>先安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmathjs.org%2F" target="_blank" title="https://mathjs.org/" ref="nofollow noopener noreferrer"><code>mathjs</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" target="_blank" title="https://zod.dev/" ref="nofollow noopener noreferrer"><code>zod</code></a></p>
<pre><code class="hljs language-bash" lang="bash">npm install mathjs
npm install zod@3.25.76
</code></pre>
<p>Claude Agent SDK 内部使用的 zod 还是 3.25 版本，而最新版已经是 4.1.12，会有兼容问题，所以我们安装了指定版本。</p>
<p><code>mathjs</code> 是一个数学计算的库，他有一个 <code>evaluate</code> 方法，可以执行字符串表达式，例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">'mathjs'</span>;

math.evaluate(<span class="hljs-string">'1.2 * (2 + 4.5)'</span>)
</code></pre>
<p>创建一个 <code>tools/calc-tool.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>
<span class="hljs-keyword">import</span> { calculator } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/calculator"</span>;

<span class="hljs-comment">// 使用 tool 函数创建一个工具</span>
<span class="hljs-comment">// 前两个参数是工具名称和描述</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> calcTool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-string">"calculator"</span>,
  <span class="hljs-string">"Perform a calculation using an expression string. The strings used here are executed using mathjs evaluate function. eg  "</span> + <span class="hljs-string">"1.2 * (2 + 4.5)"</span>,
  <span class="hljs-comment">// 第三个参数是 inputSchema，使用 zod 来定义</span>
  {
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"The expression to be evaluated"</span>)
  },
  <span class="hljs-keyword">async</span> (args) =&gt;{
    <span class="hljs-comment">// 回调函数里执行工具的具体业务逻辑</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculator</span>(args.<span class="hljs-property">expression</span>)

    <span class="hljs-comment">// 返回这个结构即可</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-attr">text</span>: result
        }
      ]
    }
  }
)
</code></pre>
<p>创建一个 <code>utils/calculator.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">'mathjs'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression:<span class="hljs-built_in">string</span></span>) : <span class="hljs-built_in">string</span>{
  <span class="hljs-keyword">const</span> result = math.evaluate(expression)
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>()
}
</code></pre>
<p>工具定义完毕，Claude Agent SDK 要求我们必须定义一个 MCP Server 来使用工具。</p>
<p>我们创建一个 <code>mcps/mcp-example-server.ts</code> 文件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createSdkMcpServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;
<span class="hljs-keyword">import</span> { calcTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"../tools/calc-tool"</span>;

<span class="hljs-comment">// createSdkMcpServer 是定义 MCP Server 的函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> utilitiesServer = <span class="hljs-title function_">createSdkMcpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"utilities"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-attr">tools</span>: [calcTool],
})

</code></pre>
<p>好的，MCP Server 创建完毕。</p>
<p>接我们回到 <code>chatExample</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { utilitiesServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"../mcps/mcp-example-server"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatExample</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span>, sessionId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">_sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
    <span class="hljs-attr">prompt</span>: prompt,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">resume</span>: sessionId,
      <span class="hljs-comment">// systemPrompt 可以自定义系统提示词</span>
      <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">"You are a helpful assistant that can use tools to get information. You can use the following tools: calculator"</span>,
      <span class="hljs-comment">// mcpServers 是一个对象参数，传入自定义的 MCP utilitiesServer</span>
      <span class="hljs-attr">mcpServers</span>: {
        <span class="hljs-attr">utilities</span>: utilitiesServer
      },
      <span class="hljs-comment">// 必须在 allowedTools 里指定的工具才能使用</span>
      <span class="hljs-comment">// 工具的命名格式是固定的：mcp__{server_name}__{tool_name}</span>
      <span class="hljs-comment">// 这里就是 mcp__utilities__calculator</span>
      <span class="hljs-attr">allowedTools</span>: [
        <span class="hljs-string">"mcp__utilities__calculator"</span>,
      ]
    }
  })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          _sessionId = message.<span class="hljs-property">session_id</span>
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
          <span class="hljs-comment">// 打印 tool_use 类型的的消息</span>
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_use"</span>) {
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`Using tool:  <span class="hljs-subst">${msg.name}</span> `</span>)
            <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">input</span>) {
                <span class="hljs-comment">// tool 得到的表达式</span>
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">` - Input: <span class="hljs-subst">${msg.input.expression}</span> `</span>)
            }

            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n'</span>)
          }
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'user'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-comment">// 打印 tool_result 类型的消息</span>
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_result"</span>) {
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"Tool Results: "</span>)
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> result <span class="hljs-keyword">of</span> msg.<span class="hljs-property">content</span>) {
              <span class="hljs-keyword">if</span> (result.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(result.<span class="hljs-property">text</span>)
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">" - "</span>)
              }
            }
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n'</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-keyword">return</span> _sessionId
}
</code></pre>
<p>我们运行看看效果：</p>
<pre><code class="hljs language-bash" lang="bash">Starting Claude Agent Demo...
User: 你好
Assistant: 你好！很高兴见到你。我是 Claude，一个 AI 助手。我可以帮你进行计算、回答问题、解决问题等。有什么我可以帮助你的吗？
User: 2454+23546，再平方，再除以 32，等于多少？
Assistant: 我来帮你计算这个问题。
Using tool:  mcp__utilities__calculator  - Input: (2454 + 23546)^2 / 32
Tool Results: 21125000 -
Assistant: 计算结果是：**21,125,000**

让我展示一下计算步骤：
1. 首先：2454 + 23546 = 26000
2. 然后平方：26000² = 676,000,000
3. 最后除以 32：676,000,000 ÷ 32 = 21,125,000
</code></pre>
<p>我们提问了一个数学问题，它把他解析为工具需要的表达式，然后使用了工具，得到了正确结果，完美！</p>
<h2 data-id="heading-6">结尾</h2>
<p>使用 Claude Agent SDK，我们用很少的代码就写了一个简单的 Agent，这个 SDK 应该是学习 Agent 开发起手比较简单的工具了，当然还有很多优秀的 Agent 框架，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fdocs%2Fai-sdk" target="_blank" title="https://vercel.com/docs/ai-sdk" ref="nofollow noopener noreferrer">Vercel AI SDK</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a>, 等等，后续也会学习使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gogs迁移到Gitea不完全指南]]></title>    <link>https://juejin.cn/post/7571272874847354932</link>    <guid>https://juejin.cn/post/7571272874847354932</guid>    <pubDate>2025-11-11T16:36:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847354932" data-draft-id="7571285984089554996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gogs迁移到Gitea不完全指南"/> <meta itemprop="keywords" content="Git,后端"/> <meta itemprop="datePublished" content="2025-11-11T16:36:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tianming2019"/> <meta itemprop="url" content="https://juejin.cn/user/1750078243746087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gogs迁移到Gitea不完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078243746087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tianming2019
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T16:36:01.000Z" title="Tue Nov 11 2025 16:36:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Gogs迁移到Gitea不完全指南</h2>
<p>大家如果有用过<code>Gogs</code>就会发现它已经很久没有啥版本更新了，相比较而言，<code>Gitea</code>的更新频率相对较高一些，社区文档也更完善。但有一点比较头疼的是老旧仓库迁移一是比较琐碎；二则commit activities 等等都消失了，今天就给大家分享一个野路子, 基本思路如下：</p>
<ul>
<li>从gogs 导出数据并解压、提取导出数据中的<code>repositories.zip</code></li>
<li>上传<code>repositories.zip</code>文件到<code>Gitea</code>容器并解压</li>
<li>通过<code>Gitea</code>的管理页面识别并重新关联仓库</li>
</ul>
<p>本文以两者环境均为docker容器为例,主要涉及容器版本：</p>
<ul>
<li>gogs/gogs:latest
<ul>
<li>version: 0.14.0+</li>
<li>sha256: b9b164e0dc299185af6079adde3eed693da55b920887aee92eda19d36030d416</li>
</ul>
</li>
<li>docker.gitea.com/gitea:1.25.1
<ul>
<li>version: 1.25.1</li>
<li>sha256: dbb4b148024bc4462c39332acbdeace8f12cee5646a4e46db75c1d16aa4eaf4b</li>
</ul>
</li>
</ul>
<h3 data-id="heading-1">Gogs数据导出</h3>
<p>进入gogs容器后，默认情况下数据文件在 <code>/data</code>目录下，实际的文件结构如下</p>
<pre><code class="hljs language-plaintext" lang="plaintext">data
├── git
│   └── gogs-repositories
│       ├── gogs
│       │   ├── download.git
│       │   ├── electron-vite-vue.git
│       │   ├── gogs.git
│       └── nobody
├── gogs
│   ├── conf
│   │   └── app.ini
│   ├── custom
│   │   └── conf
│   │       └── app.ini
│   ├── data
│   │   ├── avatars
│   │   │   └── 3
│   │   └── sessions
│   └── log
│       ├── gogs.log
│       ├── gorm.log
│       ├── hooks
│       │   ├── post-receive.log
│       │   ├── pre-receive.log
│       │   ├── update.log
│       │   └── xorm.log
│       └── xorm.log
└── ssh
    ├── ssh_host_dsa_key
    ├── ssh_host_dsa_key.pub
    ├── ssh_host_ecdsa_key
    ├── ssh_host_ecdsa_key.pub
    ├── ssh_host_ed25519_key
    ├── ssh_host_ed25519_key.pub
    ├── ssh_host_rsa_key
    └── ssh_host_rsa_key.pub

43 directories, 18 files
</code></pre>
<p>通过 gogs的 backup 命令进行备份的话默认目录结构如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">gogs-backup
├── custom
│   ├── conf
│   │   └── app.ini
│   ├── custom
│   │   └── conf
│   │       └── app.ini
│   └── log
│       ├── gogs.log
│       ├── gogs.log.2022-11-06
│       ├── gorm.log
│       ├── gorm.log.2022-11-06
│       ├── hooks
│       │   ├── post-receive.log
│       │   ├── pre-receive.log
│       │   ├── update.log
│       │   └── xorm.log
│       ├── xorm.log
│       ├── xorm.log.2022-11-06
├── data
│   └── avatars
│       └── 3
├── db
│   ├── TeamRepo.json
│   ├── TeamUser.json
├── metadata.ini
└── repositories.zip
10 directories, 49 files
</code></pre>
<blockquote>
<p>如果指定了 command options ,则会删减部分内容，大致如下：</p>
<ul>
<li>exclude-mirror-repos 不备份外部仓库</li>
<li>exclude-repos 完全不备份 仓库</li>
<li>database-only 只备份db数据</li>
</ul>
</blockquote>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /backup/file
su git
cd /backup
c94803f5f8bf:/backup$ /app/gogs/gogs backup -v --tempdir ./tmp --target ./file 
<span class="hljs-meta prompt_"># </span><span class="bash">exclude-mirror-repos</span>
<span class="hljs-meta prompt_"># </span><span class="bash">c94803f5f8bf:/backup$ /app/gogs/gogs backup -v --tempdir ./tmp --target ./file --exclude-mirror-repos</span>
</code></pre>
<p>导出文件的命名格式为: <code>gogs-backup-20251111070003.zip</code> ,我们解压文件后可以看到两种备份方式的主要区别是有无ssh密钥配置，建议备份数据后通过此方式再次进行备份，避免数据丢失</p>
<pre><code class="hljs language-shell" lang="shell">cd /backup/file
tar -cf tar_data_20251111.tar /data
</code></pre>
<p>完成备份之后退出容器，并通过 <code>docker cp</code> 复制文件到宿主机即可</p>
<h3 data-id="heading-2">Gitea数据导入</h3>
<p>创建容器后首次进入页面需要配置<code>Gitea</code>,<strong>注册Gitea账号时建议使用gogs的管理员账号,导入数据后可任意添加</strong></p>
<p>通过<code>docker cp</code> 复制<code>gogs-backup-20251111070003.zip</code> 文件中的 <code>repositories.zip</code>
登录gitea容器并切换到<code>/app/gitea</code> 或者 <code>/tmp</code>目录下</p>
<ul>
<li>解压缩<code>repositories.zip</code>文件
<ul>
<li><code>unzip repositories.zip</code></li>
</ul>
</li>
<li>修改文件权限
<ul>
<li><code>chown -R git:git gogs-repositories</code></li>
</ul>
</li>
<li>挪动文件到<code>/data/git/repositories</code>目录
<ul>
<li><strong>一定要确认目录下是否为空，避免覆盖数据</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">通过Gitea管理页面添加仓库</h3>
<ul>
<li>
<p>通过ip或者配置的域名登录管理员账号，按图示进入gitea 仓库管理面板-未收录仓库</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c7f58fb3d0544579348d6f7bae78596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=UwqkwlwTmoS1g2WO6JkCYBaqhak%3D" alt="enter dashboard" loading="lazy"/></p>
</li>
<li>
<p>搜索指定账号(即为<code>repositories.zip</code>下的一级文件夹名称)，逐个添加仓库</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52826e5a22804c6199ed1bcb6ab03a66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=9mKOCXiYMxM%2FGtDBb9TTcw4z32k%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>随意进入其中一个仓库验证</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8429388300a407f9fdae80427860f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=HjQOYRoVRkojJXt9X8ULH0I5fQ8%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>随意下载仓库验证
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f6cf7e8dcd744b9b54dea102e3b1632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=LvV%2BudChtGkA2OdXRHTOZKAOQRw%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE AI 真强，连外国人都在用这些AI技巧]]></title>    <link>https://juejin.cn/post/7571342319893741603</link>    <guid>https://juejin.cn/post/7571342319893741603</guid>    <pubDate>2025-11-12T01:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319893741603" data-draft-id="7568425510792609792" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE AI 真强，连外国人都在用这些AI技巧"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T01:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE AI 真强，连外国人都在用这些AI技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:50:31.000Z" title="Wed Nov 12 2025 01:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你还在手动敲 <code>for</code> 循环、查 Stack Overflow、部署网站时手抖点错按钮……那你真的该试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.datacamp.com%2Ftutorial%2Ftrae-ai" target="_blank" title="https://www.datacamp.com/tutorial/trae-ai" ref="nofollow noopener noreferrer"><strong>Trae AI</strong></a> 了。截至 <strong>2025 年 10 月</strong>，它已经登顶 <strong>SWE-bench</strong>（一个用 500 个真实 GitHub Issue 测评 AI 编程能力的权威榜单）第一，而且是唯一一个作为完整 IDE 参赛并夺冠的工具！</p>
<p>下面我们就用<strong>轻松好玩 + 实战截图</strong>的方式，带你快速上手 Trae AI 的那些超实用技巧。</p>
<hr/>
<h2 data-id="heading-0">🧠 Trae AI 是啥？——你的 AI 工程师助理</h2>
<p>Trae 自称 “<strong>The Real AI Engineer</strong>”（真正的 AI 工程师），听起来有点狂？但它确实干了工程师该干的活：</p>
<ul>
<li>听你用自然语言描述需求（比如：“给我写个 4x4 井字棋”）</li>
<li>自动规划代码结构、生成文件、写文档</li>
<li>能联网查资料、调接口、用工具（靠 MCP）</li>
<li>甚至能一键部署网站到 Vercel！</li>
<li>还支持<strong>语音输入</strong>——边喝奶茶边说“加个登录页”，它就干了！</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bab136c723e74fc2a6e27343414f53b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=US4jfRY7vgMuSfhxdeXk0kgRM2g%3D" alt="Trae AI 界面" loading="lazy"/><br/>
<em>👉 界面清爽，左边聊天 + 中间代码 + 下方终端，VS Code 用户秒上手</em></p>
<hr/>
<h2 data-id="heading-1">💰 价格香到离谱：首月只要 3 美元！</h2>
<p>Trae AI 月费 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>（约</mtext><mn>72</mn><mtext>元人民币）</mtext><mo>∗</mo><mo>∗</mo><mtext>，</mtext><mo>∗</mo><mo>∗</mo><mtext>首月只要</mtext></mrow><annotation encoding="application/x-tex">10（约 72 元人民币）**，**首月只要 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">10</span><span class="mord cjk_fallback">（约</span><span class="mord">72</span><span class="mord cjk_fallback">元人民币）</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">，</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">首月只要</span></span></span></span></span>3</strong>！对比 Cursor（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mtext>）、</mtext><mi>W</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>f</mi><mtext>（</mtext></mrow><annotation encoding="application/x-tex">20）、Windsurf（</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">20</span><span class="mord cjk_fallback">）、</span><span class="mord mathnormal">Win</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord cjk_fallback">（</span></span></span></span></span>15+），简直白菜价！</p>
<p>你还会获得：</p>
<ul>
<li><strong>600 次“快请求”</strong>（用 Claude 4 Sonnet、Gemini 2.5 Pro 等顶级模型）</li>
<li><strong>无限次“慢请求”</strong>（适合不着急的任务）</li>
</ul>
<blockquote>
<p>⚠️ 小提醒：它的“请求计数”是按“次数”而非“token 数”，复杂任务和简单修改算一样的次数——这模式可能撑不久，<strong>趁便宜快上车</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🛠️ 实战技巧 1：用 Builder 写个彩色井字棋游戏</h2>
<p>我们来试试它的核心功能：<strong>Builder 模式</strong>。</p>
<p>在空白项目里输入：</p>
<pre><code class="hljs language-text" lang="text">我想用 Python 做一个 4x4 的井字棋终端游戏，支持两人轮流下棋，
能判断行、列、对角线获胜，还要支持平局。
界面要有颜色，但别太花，简洁清新就好。
</code></pre>
<p><strong>结果？99% 完美！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d570cd4dda7343778386f2df5461170a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=KJEAzc9cnEN0njQhbUnIebl6zAc%3D" alt="Trae 生成的彩色井字棋" loading="lazy"/></p>
<p>它不仅写了代码，还：</p>
<ul>
<li>自动生成 <code>README.md</code></li>
<li>自动运行 <code>python tictactoe.py</code> 测试</li>
<li>用了 <code>colorama</code> 库实现彩色输出</li>
<li>逻辑完全正确，连边界情况都处理了！</li>
</ul>
<hr/>
<h2 data-id="heading-3">🔍 实战技巧 2：内置浏览器 + 联网搜索，不用切窗口！</h2>
<p>以前写代码时，总得在 IDE 和 Chrome 之间来回跳。Trae 直接在聊天框里<strong>内置网页搜索</strong>！</p>
<p>试试输入：</p>
<pre><code class="hljs language-text" lang="text">搜一下别人是怎么做井字棋游戏的？有没有加 AI 对战或 undo 功能？
</code></pre>
<p>它会自动联网，整理出结构化结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0796981af6704dd0abd129e416a6b3e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=EAlwObpOxoKw57z2uXmlwNtRDk4%3D" alt="Trae 内置搜索结果" loading="lazy"/></p>
<p>你可以直接让它：“根据这个加个‘悔棋’功能”，它马上改代码！</p>
<hr/>
<h2 data-id="heading-4">📋 实战技巧 3：用 <code>#</code> 和 <code>@</code> 精准控制上下文</h2>
<ul>
<li><code>#filename.py</code> → 把这个文件内容喂给 AI</li>
<li><code>#rulename</code> → 引用你写的规则文件（比如 <code>#design_philosophy</code>）</li>
<li><code>@DocAgent</code> → 切换到“文档专用 AI 助手”</li>
</ul>
<p>你甚至可以创建自己的规则文件，比如 <code>.trae/rules/architecture.md</code>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目必须用 Flask，前端用 HTMX，不许用 React。</span>
所有 API 返回 JSON，状态码要规范。
</code></pre>
<p>下次你写后端时，只要说 <code>#architecture</code>，AI 就自动遵守！</p>
<hr/>
<h2 data-id="heading-5">🧩 实战技巧 4：用 MCP 连数据库、API、Git……</h2>
<p><strong>MCP（Model Context Protocol）</strong> 是 Trae 的“外挂插件系统”。比如：</p>
<ul>
<li>连 PostgreSQL 查表结构</li>
<li>调公司内部 API 自动生成 SDK</li>
<li>读取 Jira 工单自动写代码</li>
</ul>
<p>它还有个 <strong>MCP 市场</strong>，一键安装常用工具：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e710c1ded024714b601351468d1d99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=LsThH5ZGjH5HCFTqKHVFTSbgCmY%3D" alt="MCP 市场" loading="lazy"/></p>
<p>装完后，切换到 <strong>“Builder with MCP”</strong> 模式，AI 就能“操作真实世界”了！</p>
<hr/>
<h2 data-id="heading-6">🤖 隐藏大招：自定义 AI 代理（Custom Agents）</h2>
<p>不想每次都解释“要写类型注解 + Google 风格 docstring”？<br/>
那就造一个专属 AI：</p>
<ul>
<li>叫它 <strong>@CodeReviewer</strong>：专找 bug、安全漏洞、性能问题</li>
<li>叫它 <strong>@FrontendGuru</strong>：只写 Tailwind + Vue，拒绝 jQuery</li>
</ul>
<p>创建后，在聊天框顶部下拉选择，或直接 <code>@FrontendGuru 做个登录页</code>，它就按你的规矩干活！</p>
<hr/>
<h2 data-id="heading-7">🚀 终极黑科技：SOLO 模式</h2>
<p>SOLO 模式才是 Trae 的“王炸”：你只说“我要做个待办清单网站”，它会：</p>
<ol>
<li>自动规划技术栈（Flask + SQLite + HTMX）</li>
<li>生成所有文件 + 测试用例</li>
<li>写好 README 和部署文档</li>
<li><strong>一键部署到 Vercel</strong></li>
<li>浏览器里直接预览！</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e98fb130d0149e2bc19722721940404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=9ILqk8cVwqgzg6ru60mi%2BJaksjk%3D" alt="SOLO 模式" loading="lazy"/></p>
<blockquote>
<p>❗ 目前 SOLO 仅限邀请用户，连付费用户都未必能用。但<strong>首月 $3 的机会成本太低</strong>，值得一试！</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">🆚 Trae vs Cursor：谁更香？</h2>













































<table><thead><tr><th>功能</th><th>Trae AI</th><th>Cursor</th></tr></thead><tbody><tr><td>价格</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>（首月</mtext></mrow><annotation encoding="application/x-tex">10（首月 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">10</span><span class="mord cjk_fallback">（首月</span></span></span></span></span>3）</td><td>$20</td></tr><tr><td>自定义代理</td><td>✅</td><td>❌</td></tr><tr><td>一键部署</td><td>✅（Vercel）</td><td>❌</td></tr><tr><td>内置浏览器</td><td>✅</td><td>❌</td></tr><tr><td>背景运行</td><td>❌</td><td>✅</td></tr><tr><td>移动端/Slack</td><td>❌</td><td>✅</td></tr><tr><td>界面颜值</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr></tbody></table>
<p><strong>结论</strong>：如果你想要<strong>新潮、便宜、功能强</strong>的 AI IDE，Trae 是当前性价比之王！</p>
<hr/>
<p><strong>彩蛋</strong>：Trae 还支持从 VS Code / Cursor <strong>一键导入设置</strong>，迁移成本几乎为零！</p>
<p>快去试试吧，说不定你的下一个项目，就是 AI 和你一起“结对编程”完成的 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ubuntu24.02安装python库以及部署python项目]]></title>    <link>https://juejin.cn/post/7571334572768935979</link>    <guid>https://juejin.cn/post/7571334572768935979</guid>    <pubDate>2025-11-12T00:57:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572768935979" data-draft-id="7571306072422924330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ubuntu24.02安装python库以及部署python项目"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-12T00:57:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ubuntu24.02安装python库以及部署python项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:57:05.000Z" title="Wed Nov 12 2025 00:57:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 问题引入</h2>
<p>在服务器的系统镜像换到最新的Ubuntu24.02后，原先的python安装机制发生了改变，之前的pip安装的方式变得不可用。</p>
<h2 data-id="heading-1">二. 问题及解决记录</h2>
<h3 data-id="heading-2">1.  python指令不可用</h3>
<p>执行python指令报错:</p>
<pre><code class="hljs language-bash" lang="bash">python --version
    Command <span class="hljs-string">'python'</span> not found, did you mean:
    <span class="hljs-built_in">command</span> <span class="hljs-string">'python3'</span> from deb python3
    <span class="hljs-built_in">command</span> <span class="hljs-string">'python'</span> from deb python-is-python3
</code></pre>
<p>原因:Ubuntu24.02自带python3
解决方法: <code>python3 --version</code></p>
<h3 data-id="heading-3">2. 未安装pip</h3>
<p>执行pip指令报错未安装:</p>
<pre><code class="hljs language-bash" lang="bash">pip list packages
Command <span class="hljs-string">'pip'</span> not found, but can be installed with:
sudo apt install python3-pip
</code></pre>
<p>原因:未安装pip
解决方法:</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install python-pip
</code></pre>
<h3 data-id="heading-4">3. 部署python项目</h3>
<p><strong>在较新的 Ubuntu 版本中，系统 Python 环境被标记为"外部管理环境"，不再支持直接使用pip安装卸载python库，这是为了保护系统完整性。</strong></p>
<h4 data-id="heading-5">方法1，使用apt install 安装相应的python库(不推荐)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否有 FastAPI 的包</span>
apt search fastapi
sudo apt install python3-venv
sudo apt install python3-pip
</code></pre>
<h4 data-id="heading-6">方法2. 使用虚拟环境安装相应的python库(推荐)</h4>
<p><strong>推荐使用方案2.（虚拟环境）</strong> ，这是 Python 开发的最佳实践，可以避免包冲突和系统环境污染。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装虚拟环境工具</span>
sudo apt install python3.12-venv

<span class="hljs-comment"># 创建虚拟环境</span>
python3 -m venv myenv

<span class="hljs-comment"># 激活虚拟环境</span>
<span class="hljs-built_in">source</span> myenv/bin/activate

<span class="hljs-comment"># 在虚拟环境中安装 FastAPI</span>
pip install fastapi uvicorn

<span class="hljs-comment"># 使用完成后退出虚拟环境</span>
<span class="hljs-comment"># deactivate</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python第三方库可以处理多线程请求接口结果顺序问题？]]></title>    <link>https://juejin.cn/post/7571338749198172210</link>    <guid>https://juejin.cn/post/7571338749198172210</guid>    <pubDate>2025-11-12T00:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198172210" data-draft-id="7571332468898103323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python第三方库可以处理多线程请求接口结果顺序问题？"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T00:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python第三方库可以处理多线程请求接口结果顺序问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:13:13.000Z" title="Wed Nov 12 2025 00:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>除了之前提到的标准库方案和 ​<code>​aiohttp​</code>​（异步库），还有多个 <strong>第三方库</strong> 可优雅处理多线程/并发请求的结果顺序问题，核心优势是 <strong>封装完善、无需手动处理线程安全/排序逻辑</strong>，同时兼顾并发效率。以下是 4 个高频实用库，附具体实现和场景适配：</p>
<h4 data-id="heading-0">一、​<code>​grequests​</code>​（requests + gevent，协程并发+有序结果）</h4>
<h5 data-id="heading-1">核心特点</h5>
<ul>
<li>基于 ​<code>​requests​</code>​（兼容其所有 API）和 ​<code>​gevent​</code>​（协程库），本质是“协程并发”（非多线程，但效率高于多线程，无 GIL 限制）；</li>
<li>天然支持 <strong>结果顺序与请求提交顺序一致</strong>（通过 ​<code>​grequests.map()​</code>​ 实现）；</li>
<li>语法极简，几乎无需修改原有 ​<code>​requests​</code>​ 代码，即可实现高并发。</li>
</ul>
<h5 data-id="heading-2">安装</h5>
<pre><code class="hljs">pip install grequests
</code></pre>
<h5 data-id="heading-3">完整实现（有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> grequests
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""单个请求函数：返回（索引，是否成功，结果信息）"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 用 grequests.get 替代 requests.get，支持协程并发</span>
        response = grequests.get(url, timeout=TIMEOUT)
        response.send()  <span class="hljs-comment"># 发送请求（非阻塞）</span>
        response = response.response  <span class="hljs-comment"># 获取响应对象</span>
        response.raise_for_status()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 1. 构造请求列表（按顺序提交）</span>
    requests_list = [grequests.get(API_URL.<span class="hljs-built_in">format</span>(i % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>), timeout=TIMEOUT) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
    
    <span class="hljs-comment"># 2. 并发执行，map 方法保证结果顺序与请求顺序一致</span>
    responses = grequests.<span class="hljs-built_in">map</span>(requests_list, size=<span class="hljs-number">10</span>)  <span class="hljs-comment"># size=并发数（类似线程池大小）</span>

    <span class="hljs-comment"># 3. 按顺序处理结果（responses 顺序 = 请求提交顺序）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"grequests 协程并发 - 按请求顺序输出："</span>)
    <span class="hljs-keyword">for</span> idx, response <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(responses):
        <span class="hljs-keyword">if</span> response <span class="hljs-keyword">and</span> response.status_code == <span class="hljs-number">200</span>:
            msg = <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：✅ <span class="hljs-subst">{msg}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            err_msg = response.reason <span class="hljs-keyword">if</span> response <span class="hljs-keyword">else</span> <span class="hljs-string">"请求超时/失败"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：❌ 失败：<span class="hljs-subst">{err_msg[:<span class="hljs-number">30</span>]}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)
</code></pre>
<h5 data-id="heading-4">关键优势&amp;场景</h5>
<ul>
<li>优势：语法简洁（兼容 ​<code>​requests​</code>​）、并发效率高（协程无线程切换开销）、天然有序；</li>
<li>场景：需要高并发接口请求，且希望结果与提交顺序一致，无需复杂配置。</li>
</ul>
<h4 data-id="heading-5">二、​<code>​httpx​</code>​（新一代 HTTP 客户端，支持同步/异步+有序结果）</h4>
<h5 data-id="heading-6">核心特点</h5>
<ul>
<li>支持 <strong>同步、异步</strong> 两种模式，API 设计优雅，可替代 ​<code>​requests​</code>​；</li>
<li>异步模式基于 ​<code>​asyncio​</code>​，并发效率高，且 ​<code>​asyncio.gather()​</code>​ 天然保证结果顺序；</li>
<li>支持 HTTP/2、连接池复用，稳定性优于 ​<code>​requests​</code>​。</li>
</ul>
<h5 data-id="heading-7">安装</h5>
<pre><code class="hljs">pip install httpx
</code></pre>
<h5 data-id="heading-8">完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 并发数</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""异步请求函数"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（支持连接池复用）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(limits=httpx.Limits(max_connections=CONCURRENT_NUM)) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造异步任务列表（按顺序提交）</span>
        tasks = [request_api(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
        <span class="hljs-comment"># 3. 并发执行，gather 保证结果顺序与任务顺序一致</span>
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)

    <span class="hljs-comment"># 4. 按顺序输出结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"httpx 异步并发 - 按请求顺序输出："</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 兼容 Windows 系统</span>
    <span class="hljs-keyword">import</span> sys
    <span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">"win32"</span>:
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(main())
</code></pre>
<h5 data-id="heading-9">关键优势&amp;场景</h5>
<ul>
<li>优势：支持同步/异步切换、HTTP/2 特性、连接池优化、天然有序；</li>
<li>场景：需要替代 ​<code>​requests​</code>​ 且追求更高性能，同时要求结果有序的并发请求。</li>
</ul>
<h4 data-id="heading-10">三、​<code>​tenacity​</code>​（重试+结合多线程/异步，保证有序结果）</h4>
<h5 data-id="heading-11">核心特点</h5>
<ul>
<li>并非专门的 HTTP 库，而是 <strong>重试库</strong>，可与 ​<code>​requests​</code>​、​<code>​aiohttp​</code>​、​<code>​ThreadPoolExecutor​</code>​ 结合；</li>
<li>支持失败自动重试（指定重试条件、间隔、次数），同时不破坏结果顺序；</li>
<li>适合接口不稳定场景，确保有序结果的同时提升成功率。</li>
</ul>
<h5 data-id="heading-12">安装</h5>
<pre><code class="hljs">pip install tenacity
</code></pre>
<h5 data-id="heading-13">完整实现（结合 ThreadPoolExecutor + 重试+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential, retry_if_exception_type
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-comment"># 配置重试策略：失败最多重试 2 次，每次间隔 1s、2s（指数退避）</span>
<span class="hljs-meta">@retry(<span class="hljs-params">
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">2</span></span>),  <span class="hljs-comment"># 最多重试 2 次</span>
    wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">5</span></span>),  <span class="hljs-comment"># 重试间隔：1s、2s、4s...</span>
    retry=retry_if_exception_type(<span class="hljs-params">(<span class="hljs-params">requests.exceptions.Timeout, requests.exceptions.ConnectionError</span>)</span>)  <span class="hljs-comment"># 仅对超时/连接错误重试</span>
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""单个请求函数（带重试）"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 结合 ThreadPoolExecutor 有序收集结果</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=THREAD_NUM) <span class="hljs-keyword">as</span> executor:
        future_list = [executor.submit(request_api, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ThreadPoolExecutor + tenacity 重试 - 按请求顺序输出："</span>)
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_list:  <span class="hljs-comment"># 按提交顺序获取结果（有序）</span>
            idx, is_success, msg = future.result()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)
</code></pre>
<h5 data-id="heading-14">关键优势&amp;场景</h5>
<ul>
<li>优势：专注重试逻辑，不影响结果顺序，可与任意并发方案结合；</li>
<li>场景：接口不稳定（超时、连接错误频繁），需要保证有序结果且提升成功率。</li>
</ul>
<h4 data-id="heading-15">四、​<code>​trio​</code>​（异步并发库，更简洁的有序结果处理）</h4>
<h5 data-id="heading-16">核心特点</h5>
<ul>
<li>基于 ​<code>​asyncio​</code>​ 的替代方案，专注“结构化并发”，API 更简洁、错误处理更优雅；</li>
<li>天然支持结果顺序与任务提交顺序一致，无需额外排序；</li>
<li>适合追求简洁异步代码，同时要求有序结果的场景。</li>
</ul>
<h5 data-id="heading-17">安装</h5>
<pre><code class="hljs language-arduino" lang="arduino">pip install trio httpx-trio  <span class="hljs-meta"># httpx-trio 是 httpx 的 trio 适配库</span>
</code></pre>
<h5 data-id="heading-18">完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大并发数</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""异步请求函数"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（结合 trio）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(limits=httpx.Limits(max_connections=CONCURRENT_NUM)) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造任务列表（按顺序），用 trio.gather 并发执行并保证顺序</span>
        results = <span class="hljs-keyword">await</span> trio.gather(*[request_api(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)])

    <span class="hljs-comment"># 3. 按顺序输出结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"trio + httpx 异步并发 - 按请求顺序输出："</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    trio.run(main())  <span class="hljs-comment"># trio 自带事件循环，无需手动启动</span>
</code></pre>
<h5 data-id="heading-19">关键优势&amp;场景</h5>
<ul>
<li>优势：结构化并发、API 简洁、错误处理优雅、天然有序；</li>
<li>场景：喜欢异步编程，且追求代码简洁性，需要有序结果的并发请求。</li>
</ul>
<h3 data-id="heading-20">第三方库对比&amp;选型建议</h3>



































<table><thead><tr><th>库名</th><th>核心机制</th><th>关键优势</th><th>适用场景</th></tr></thead><tbody><tr><td>grequests</td><td>协程（gevent）</td><td>兼容 requests、语法极简、并发效率高</td><td>快速替换 requests 实现高并发+有序结果</td></tr><tr><td>httpx</td><td>异步（asyncio）</td><td>支持同步/异步、HTTP/2、连接池优化</td><td>替代 requests 且追求高性能+有序结果</td></tr><tr><td>tenacity</td><td>重试机制</td><td>专注失败重试、可与任意并发方案结合</td><td>接口不稳定，需要重试+有序结果</td></tr><tr><td>trio</td><td>结构化并发</td><td>代码简洁、错误处理优雅</td><td>异步编程爱好者，追求简洁性+有序结果</td></tr></tbody></table>
<h3 data-id="heading-21">面试&amp;实战关键要点</h3>
<ol>
<li><strong>并发模型优先选异步</strong>：​<code>​grequests​</code>​、​<code>​httpx​</code>​、​<code>​trio​</code>​ 均基于协程/异步，效率高于多线程（无 GIL 限制、无线程切换开销），是接口请求的最优解；</li>
<li><strong>有序的核心是“任务与结果绑定”</strong> ：所有库的有序性本质是“提交顺序=任务列表顺序=结果列表顺序”，无需手动排序；</li>
<li><strong>结合场景选择库</strong>：</li>
</ol>
<ul>
<li>简单场景：用 ​<code>​grequests​</code>​（最快上手）；</li>
<li>高性能场景：用 ​<code>​httpx​</code>​（支持 HTTP/2）；</li>
<li>接口不稳定：用 ​<code>​tenacity​</code>​+任意并发库（重试保障）；</li>
<li>异步简洁性：用 ​<code>​trio​</code>​；</li>
</ul>
<ol start="4">
<li><strong>避免过度依赖库</strong>：核心需求是“有序+并发”，优先选标准库（​<code>​ThreadPoolExecutor​</code>​、​<code>​asyncio​</code>​），复杂场景再引入第三方库。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[012.今天我们来实现一个“自己的 GPT”]]></title>    <link>https://juejin.cn/post/7571316028322250787</link>    <guid>https://juejin.cn/post/7571316028322250787</guid>    <pubDate>2025-11-12T01:52:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571316028322250787" data-draft-id="7571355989132902415" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="012.今天我们来实现一个“自己的 GPT”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T01:52:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="山海守门人"/> <meta itemprop="url" content="https://juejin.cn/user/3868524948238876"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            012.今天我们来实现一个“自己的 GPT”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868524948238876/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    山海守门人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:52:47.000Z" title="Wed Nov 12 2025 01:52:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>该教程旨在带大家从 0 起步，掌握用 Python 开发大模型应用的技能。若当前内容让你感到晦涩，可回溯本合集的前期文章，降低学习难度。</p>
</blockquote>
<h2 data-id="heading-0">1. 先看演示效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f89a84c894749c6af112396fd105086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5rW35a6I6Zeo5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517167&amp;x-signature=MEJqq8ewfDeNXTZq14CXOvUcqNU%3D" alt="图片" loading="lazy"/></p>
<p>实现功能：可自定义秘钥；有多轮记忆；可清除历史对话。</p>
<h2 data-id="heading-1">2. 具体实现</h2>
<h3 data-id="heading-2">2.1. 先写工具类 <code>get_chat_response</code></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># utils.py</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> ConversationChain
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chat_response</span>(<span class="hljs-params">prompt, memory, api_key</span>):
    model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>, api_key=api_key, temperature=<span class="hljs-number">0</span>)
    chain = ConversationChain(llm=model, memory=memory)
    response = chain.invoke({<span class="hljs-string">"input"</span>: prompt})
    <span class="hljs-keyword">return</span> response[<span class="hljs-string">"response"</span>]
</code></pre>
<h3 data-id="heading-3">2.2. 本地测试代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># test.py</span>
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> get_chat_response
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory

memory = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>(get_chat_response(<span class="hljs-string">"牛顿提出哪些知名定律？"</span>, memory, os.getenv(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>)))
<span class="hljs-built_in">print</span>(get_chat_response(<span class="hljs-string">"我上一个问题是什么？"</span>, memory, os.getenv(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>)))
</code></pre>
<h3 data-id="heading-4">2.3. 创建 Streamlit 页面框架</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app.py</span>
<span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> get_chat_response

st.title(<span class="hljs-string">"克隆GPT"</span>)
</code></pre>
<h3 data-id="heading-5">2.4. 让用户输入密钥</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> st.sidebar:
    deepseek_api_key = st.text_input(<span class="hljs-string">"请输入DeepSeek API密钥："</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">"password"</span>)
    st.markdown(<span class="hljs-string">"[获取DeepSeek API密钥](https://platform.deepseek.com/api_keys)"</span>)
</code></pre>
<h3 data-id="heading-6">2.5. 把 memory &amp; message 放入 session</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> <span class="hljs-string">"memory"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state[<span class="hljs-string">"memory"</span>] = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">"message"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state[<span class="hljs-string">"message"</span>] = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，我是你的AI助手，有什么可以帮你的吗？"</span>}]
</code></pre>
<h3 data-id="heading-7">2.6. 显示历史消息（AI 初始欢迎已在内）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> st.session_state[<span class="hljs-string">"message"</span>]:
    st.chat_message(message[<span class="hljs-string">"role"</span>]).write(message[<span class="hljs-string">"content"</span>])
</code></pre>
<h3 data-id="heading-8">2.7. 获取用户输入</h3>
<pre><code class="hljs language-python" lang="python">prompt = st.chat_input()
<span class="hljs-keyword">if</span> prompt:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deepseek_api_key:
        st.info(<span class="hljs-string">"请输入你的API key"</span>)
        st.stop()
    <span class="hljs-comment"># 8. 立即展示用户消息</span>
    st.session_state[<span class="hljs-string">"message"</span>].append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: prompt})
    st.chat_message(<span class="hljs-string">"human"</span>).write(prompt)
</code></pre>
<h3 data-id="heading-9">2.8. 调用 AI 并回显</h3>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">"AI正在思考中，请稍等..."</span>):
        response = get_chat_response(prompt, st.session_state[<span class="hljs-string">"memory"</span>], deepseek_api_key)
    <span class="hljs-comment"># 9. 把 AI 回答加入会话</span>
    msg = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: response}
    st.session_state[<span class="hljs-string">"message"</span>].append(msg)
    st.chat_message(<span class="hljs-string">"ai"</span>).write(response)
</code></pre>
<h3 data-id="heading-10">2.9. 添加清除会话按钮</h3>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">if</span> st.button(<span class="hljs-string">"清除历史对话"</span>):
        st.session_state[<span class="hljs-string">"memory"</span>] = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)
        st.session_state[<span class="hljs-string">"message"</span>] = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，我是你的AI助手，有什么可以帮你的吗？"</span>}]
        st.success(<span class="hljs-string">"历史对话已清除"</span>)
</code></pre>
<h2 data-id="heading-11">3. 完整代码</h2>
<h3 data-id="heading-12">3.1. 文件结构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6b74c3159a044e9abb385515808adb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGx5rW35a6I6Zeo5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517167&amp;x-signature=t%2FU5UT8kZX9aGi1ItLgdd2YtOrk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">3.2. 代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> langchain.chains.conversation.base <span class="hljs-keyword">import</span> ConversationChain
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chat_response</span>(<span class="hljs-params">prompt, memory, api_key</span>):
    model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>, api_key=api_key, temperature=<span class="hljs-number">0</span>)
    chain = ConversationChain(llm=model, memory=memory)

    response = chain.invoke({<span class="hljs-string">"input"</span>: prompt})
    <span class="hljs-built_in">print</span>(response)
    <span class="hljs-keyword">return</span> response[<span class="hljs-string">"response"</span>]

<span class="hljs-comment"># memory = ConversationBufferMemory(return_messages=True)</span>
<span class="hljs-comment"># print(get_chat_response("牛顿提出哪些知名定律？", memory, os.getenv("DEEPSEEK_API_KEY")))</span>
<span class="hljs-comment"># print(get_chat_response("我上一个问题是什么？", memory, os.getenv("DEEPSEEK_API_KEY")))</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory

<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> get_chat_response

st.title(<span class="hljs-string">"克隆GPT"</span>)

<span class="hljs-keyword">with</span> st.sidebar:
    deepseek_api_key = st.text_input(<span class="hljs-string">"请输入DeepSeek API密钥："</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">"password"</span>)
    st.markdown(<span class="hljs-string">"[获取DeepSeek API密钥](https://platform.deepseek.com/api_keys)"</span>)

    <span class="hljs-comment"># 添加清除对话按钮</span>
    <span class="hljs-keyword">if</span> st.button(<span class="hljs-string">"清除历史对话"</span>):
        <span class="hljs-comment"># 重置记忆对象</span>
        st.session_state[<span class="hljs-string">"memory"</span>] = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)
        <span class="hljs-comment"># 重置消息列表（保留初始欢迎消息）</span>
        st.session_state[<span class="hljs-string">"message"</span>] = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，我是你的AI助手，有什么可以帮你的吗？"</span>}]
        <span class="hljs-comment"># 显示清除成功提示</span>
        st.success(<span class="hljs-string">"历史对话已清除"</span>)

<span class="hljs-comment"># 初始化会话状态（如果不存在）</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">"memory"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state[<span class="hljs-string">"memory"</span>] = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">"message"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state[<span class="hljs-string">"message"</span>] = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，我是你的AI助手，有什么可以帮你的吗？"</span>}]

<span class="hljs-comment"># 显示历史消息</span>
<span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> st.session_state[<span class="hljs-string">"message"</span>]:
    st.chat_message(message[<span class="hljs-string">"role"</span>]).write(message[<span class="hljs-string">"content"</span>])

<span class="hljs-comment"># 处理用户输入</span>
prompt = st.chat_input()
<span class="hljs-keyword">if</span> prompt:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deepseek_api_key:
        st.info(<span class="hljs-string">"请输入你的API key"</span>)
        st.stop()

    <span class="hljs-comment"># 添加用户消息到会话状态并显示</span>
    st.session_state[<span class="hljs-string">"message"</span>].append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: prompt})
    st.chat_message(<span class="hljs-string">"human"</span>).write(prompt)

    <span class="hljs-comment"># 获取AI响应</span>
    <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">"AI正在思考中，请稍等..."</span>):
        response = get_chat_response(prompt, st.session_state[<span class="hljs-string">"memory"</span>], deepseek_api_key)

    <span class="hljs-comment"># 添加AI响应到会话状态并显示</span>
    msg = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: response}
    st.session_state[<span class="hljs-string">"message"</span>].append(msg)
    st.chat_message(<span class="hljs-string">"ai"</span>).write(response)
</code></pre>
<h2 data-id="heading-14">4. 运行命令</h2>
<pre><code class="hljs language-shell" lang="shell">streamlit run main.py
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Figma 协同编辑是如何做用户状态同步的？]]></title>    <link>https://juejin.cn/post/7571378103281369094</link>    <guid>https://juejin.cn/post/7571378103281369094</guid>    <pubDate>2025-11-12T02:08:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103281369094" data-draft-id="7571295102851629082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Figma 协同编辑是如何做用户状态同步的？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T02:08:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端西瓜哥"/> <meta itemprop="url" content="https://juejin.cn/user/2066737589133015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Figma 协同编辑是如何做用户状态同步的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2066737589133015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端西瓜哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:08:44.000Z" title="Wed Nov 12 2025 02:08:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是前端西瓜哥。</p>
<p>在协同编辑中，同步用户状态是必不可少的功能。通过感知到其他用户的状态，我们可以有意识地避免操作同一个对象，导致冲突和相互覆盖。</p>
<p>下面我们看看 Figma 是怎么进行用户状态的同步的。</p>
<h2 data-id="heading-0">需要同步的状态</h2>
<p>Figma 同步的状态分为几种。</p>
<h3 data-id="heading-1">用户基本信息</h3>
<p>首先是 <strong>用户基本信息</strong>。</p>
<p>用于顶部显示进入当前 “房间” 的用户有哪些，以及光标上显示对应的名字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d54316fd31d54fa89627d7072bc06a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6KW_55Oc5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518124&amp;x-signature=vEikE68F8Ch9o0fFm8Ou4o5lcHk%3D" alt="图片" loading="lazy"/></p>
<p>1、 <strong>name：用户名</strong>；</p>
<p>2、<strong>imageURL：用户头像 url</strong>；</p>
<p>3、<strong>userID：用户 id</strong>；</p>
<p>4、<strong>sessionID：会话 id</strong>。</p>
<p>每个客户端都有有一个唯一的 sessionID。因为一个用户可能会同时打开多个客户端，所以不能用 userID 做区分。</p>
<p>sessionID 是服务端提供的，确保唯一性，并在创建图形时，作为 guid 的一部分，确保图形 id 的唯一性，以确保类 CRDT 的协同编辑机制能正常工作。</p>
<p>5、<strong>deviceName：设备名</strong>，通常是 "editor"。</p>
<p>6、<strong>canWrite：是否有编辑权限</strong>。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">{
  sessionID: <span class="hljs-number">23</span>,
<span class="hljs-symbol">stableSessionID:</span> <span class="hljs-comment">'eccba7720656d0a2f5adeb7b7ca1700915d62b7d',</span>
<span class="hljs-symbol">connected:</span> <span class="hljs-literal">true</span>,
<span class="hljs-symbol">name:</span> <span class="hljs-comment">'xigua',</span>
<span class="hljs-symbol">imageURL:</span> <span class="hljs-comment">'&lt;url&gt;',</span>
<span class="hljs-symbol">deviceName:</span> <span class="hljs-comment">'editor',</span>
<span class="hljs-symbol">userID:</span> <span class="hljs-comment">'1166195885685703702',</span>
<span class="hljs-symbol">canWrite:</span> <span class="hljs-literal">true</span>,
<span class="hljs-symbol">connectedAtTimeS:</span> <span class="hljs-number">205</span>,
// ...
};

</code></pre>
<h3 data-id="heading-2">光标信息</h3>
<p>光标信息可以告知其他协同者，当前客户端的操作意图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01bea56ae1042e4a62e0a2394a55135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6KW_55Oc5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518124&amp;x-signature=lSlVLW%2FLC6Jy%2Bd64FnIEf1AFA6U%3D" alt="图片" loading="lazy"/></p>
<p>1、<strong>cursor: 光标样式</strong>；</p>
<p>通常是 "DEFAULT"（默认光标）。常见的还有 "PEN"、"CROSSHAIR"、"PENCIL"、"HAND"。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d83cfcf600a4c72aaf2a71b1a3cf58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6KW_55Oc5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518124&amp;x-signature=tZiZiyoIKRQlk5ExCFd3GalQMsI%3D" alt="图片" loading="lazy"/></p>
<p>2、<strong>canvasSpaceLocation：光标位置</strong>。用 x、y 表示；</p>
<p>3、<strong>canvasSpaceSelectionBox：选区</strong>。用 x、y、width、height 表示；</p>
<p>4、<strong>color：光标颜色</strong>。使用归一的 rgba 格式；</p>
<p>5、<strong>canvasGuid：光标所在的画布 id</strong>。</p>
<pre><code class="hljs language-css" lang="css">{
  mouse: {
    <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'DEFAULT'</span>,
    canvasSpaceLocation: {
      x: -<span class="hljs-number">72</span>,
      y: -<span class="hljs-number">101</span>,
    },
    canvasSpaceSelectionBox: {
      x: null,
      y: null,
      w: null,
      h: null,
    },
    canvasGuid: {
      sessionID: <span class="hljs-number">0</span>,
      localID: <span class="hljs-number">1</span>,
    },
    cursorHiddenReason: <span class="hljs-number">0</span>,
  },
<span class="hljs-attribute">color</span>: {
    r: <span class="hljs-number">1</span>,
    g: <span class="hljs-number">0.1411764770746231</span>,
    b: <span class="hljs-number">0.7411764860153198</span>,
    a: <span class="hljs-number">1</span>,
  },
}

</code></pre>
<h3 data-id="heading-3">视口信息</h3>
<p>1、<strong>canvasSpaceBounds：视口矩形</strong>；</p>
<p>在 follow 另一个用户时会用到，就是跟随另一个用户的 viewport，将其 fit 到自己的 viewport 上。</p>
<pre><code class="hljs language-css" lang="css">{
  viewport: {
    canvasSpaceBounds: {
      x: -<span class="hljs-number">345.7548522949219</span>,
      y: -<span class="hljs-number">208.17074584960938</span>,
      w: <span class="hljs-number">317.0416564941406</span>,
      h: <span class="hljs-number">512.650390625</span>,
    },
    pixelPreview: false,
    pixelDensity: <span class="hljs-number">1</span>,
    canvasGuid: {
      sessionID: <span class="hljs-number">0</span>,
      localID: <span class="hljs-number">1</span>,
    },
  },
}

</code></pre>
<h3 data-id="heading-4">被选中图形信息</h3>
<p>会保存在 selection 数组中，里面是被选中图形的 id。</p>
<p>这个是全量提交的，所以如果选的图形比较多，数据量还是挺大的。</p>
<pre><code class="hljs language-css" lang="css">{
  selection: [
    { sessionID: <span class="hljs-number">26</span>, localID: <span class="hljs-number">2</span> },
    { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">2</span> },
    { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">3</span> },
    { sessionID: <span class="hljs-number">68</span>, localID: <span class="hljs-number">2</span> },
    { sessionID: <span class="hljs-number">34</span>, localID: <span class="hljs-number">2</span> },
    { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">4</span> },
  ],
}

</code></pre>
<p>因为协同的原因，图形数据是动态的，没法提交一个范围来替代集合。</p>
<h3 data-id="heading-5">跟随信息</h3>
<p>observing 是当前客户端正在跟随哪个客户端，里面保存的是 sessionID。</p>
<p>比如下面表示当前用户正在跟随sessionID 为 83 的客户端。</p>
<pre><code class="hljs language-css" lang="css">{
  observing: [<span class="hljs-number">83</span>],
}

</code></pre>
<h2 data-id="heading-6">通信的各种场景</h2>
<h3 data-id="heading-7">初始化</h3>
<p>客户端初始化，会进行 websocket 连接，然后服务端会返回当前房间的所有用户信息，包括自己的。</p>
<p>自身信息会比较少，因为才初始化，没有光标位置等信息。其中比较重要的是服务端分配的 sessionID，后面的 CRDT 协同都需要它。</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
  userChanges: [
    {
      sessionID: <span class="hljs-number">56</span>,
      stableSessionID: <span class="hljs-string">'74469ea15d268d1713737bd8994b122b500ebfa0'</span>,
      connected: true,
      name: <span class="hljs-string">'watermelon'</span>,
      color: {
        r: <span class="hljs-number">0.4000000059604645</span>,
        g: <span class="hljs-number">0.46666666865348816</span>,
        b: <span class="hljs-number">0.6000000238418579</span>,
        a: <span class="hljs-number">1</span>,
      },
      imageURL: <span class="hljs-string">'&lt;url&gt;'</span>,
      viewport: {
        canvasSpaceBounds: {
          x: -<span class="hljs-number">808</span>,
          y: -<span class="hljs-number">619</span>,
          w: <span class="hljs-number">945</span>,
          h: <span class="hljs-number">860</span>,
        },
        pixelPreview: false,
        pixelDensity: <span class="hljs-number">1</span>,
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
      },
      mouse: {
        <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'DEFAULT'</span>,
        canvasSpaceLocation: {
          x: -<span class="hljs-number">806</span>,
          y: -<span class="hljs-number">285</span>,
        },
        canvasSpaceSelectionBox: {
          x: null,
          y: null,
          w: null,
          h: null,
        },
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
        cursorHiddenReason: <span class="hljs-number">0</span>,
      },
      selection: [],
      observing: [],
      deviceName: <span class="hljs-string">'editor'</span>,
      userID: <span class="hljs-string">'1157564275155718012'</span>,
      canWrite: true,
      connectedAtTimeS: <span class="hljs-number">588</span>,
    },
    {
      sessionID: <span class="hljs-number">58</span>,
      stableSessionID: <span class="hljs-string">'5a11edba43222d4fa6e14da9451ca8fff537a8e3'</span>,
      connected: true,
      name: <span class="hljs-string">'xigua'</span>,
      color: {
        r: <span class="hljs-number">0.0784313753247261</span>,
        g: <span class="hljs-number">0.6823529601097107</span>,
        b: <span class="hljs-number">0.3607843220233917</span>,
        a: <span class="hljs-number">1</span>,
      },
      imageURL: <span class="hljs-string">'&lt;url&gt;'</span>,
      deviceName: <span class="hljs-string">'editor'</span>,
      userID: <span class="hljs-string">'1166195885685703702'</span>,
      canWrite: true,
      connectedAtTimeS: <span class="hljs-number">618</span>,
    },
  ],
}

</code></pre>
<h3 data-id="heading-8">光标和选区信息同步</h3>
<p><strong>需要注意的是，只有当前 “房间” 有 2 个人及以上，用户的状态才会提交给客户端。</strong></p>
<p>用户在画布上移动光标和进行框选时，会将光标位置和选区的信息发送给服务端，服务端会广播给其他客户端。</p>
<p>mousemove 的频率还是挺高的，所以发送的信息会做 <strong>节流</strong>，否则服务端压力会过大。其他所有操作都会做节流。</p>
<p><strong>这里发送的 sessionID 永远是 0，因为服务端不会信任客户端的 sessionID，服务端会根据 websocket 连接，拿到绝对正确的 sessionID</strong>。</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
userChanges: [
    {
      sessionID: <span class="hljs-number">0</span>,
      mouse: {
        <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'DEFAULT'</span>,
        canvasSpaceLocation: {
          x: -<span class="hljs-number">87</span>,
          y: -<span class="hljs-number">633</span>,
        },
        canvasSpaceSelectionBox: {
          x: -<span class="hljs-number">308</span>,
          y: -<span class="hljs-number">792</span>,
          w: <span class="hljs-number">221</span>,
          h: <span class="hljs-number">159</span>,
        },
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
        cursorHiddenReason: <span class="hljs-number">0</span>,
      },
    },
  ],
sentTimestamp: <span class="hljs-string">'1762581990493'</span>,
};

</code></pre>
<h3 data-id="heading-9">选中图形</h3>
<p>选中图形的话，会发送选中图形数据。</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
userChanges: [
    {
      sessionID: <span class="hljs-number">0</span>,
      viewport: {
        canvasSpaceBounds: {
          x: -<span class="hljs-number">372</span>,
          y: -<span class="hljs-number">889</span>,
          w: <span class="hljs-number">356</span>,
          h: <span class="hljs-number">1092</span>,
        },
        pixelPreview: false,
        pixelDensity: <span class="hljs-number">1</span>,
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
      },
      selection: [
        { sessionID: <span class="hljs-number">26</span>, localID: <span class="hljs-number">2</span> },
        { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">2</span> },
        { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">3</span> },
        { sessionID: <span class="hljs-number">68</span>, localID: <span class="hljs-number">2</span> },
        { sessionID: <span class="hljs-number">34</span>, localID: <span class="hljs-number">2</span> },
        { sessionID: <span class="hljs-number">67</span>, localID: <span class="hljs-number">4</span> },
      ],
    },
  ],
sentTimestamp: <span class="hljs-string">'1762582166098'</span>,
}

</code></pre>
<h3 data-id="heading-10">跟随</h3>
<p>点击用户头像即可跟随对应用户。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69124ba4358645a59c0f3b4a0a4122e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6KW_55Oc5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518124&amp;x-signature=YbMhOcQSngNkq6JB8la9hmq61U0%3D" alt="图片" loading="lazy"/></p>
<p>会发送消息：</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
userChanges: [
    {
      sessionID: <span class="hljs-number">0</span>,
      viewport: {
        canvasSpaceBounds: {
          x: -<span class="hljs-number">1016.8021240234375</span>,
          y: -<span class="hljs-number">1148.079345703125</span>,
          w: <span class="hljs-number">1004.8677978515625</span>,
          h: <span class="hljs-number">1484.62646484375</span>,
        },
        pixelPreview: false,
        pixelDensity: <span class="hljs-number">1</span>,
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
      },
      observing: [<span class="hljs-number">71</span>],
    },
  ],
sentTimestamp: <span class="hljs-string">'1762585440201'</span>,
}

</code></pre>
<h3 data-id="heading-11">视口发生改变</h3>
<p>viewport 发生变化是要同步的。</p>
<p>除了视口信息，还额外传了鼠标信息。</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
userChanges: [
    {
      sessionID: <span class="hljs-number">0</span>,
      viewport: {
        canvasSpaceBounds: {
          x: -<span class="hljs-number">1032</span>,
          y: -<span class="hljs-number">803</span>,
          w: <span class="hljs-number">842</span>,
          h: <span class="hljs-number">1244</span>,
        },
        pixelPreview: false,
        pixelDensity: <span class="hljs-number">1</span>,
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
      },
      mouse: {
        <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'DEFAULT'</span>,
        canvasSpaceLocation: {
          x: -<span class="hljs-number">187</span>,
          y: -<span class="hljs-number">570</span>,
        },
        canvasSpaceSelectionBox: {
          x: null,
          y: null,
          w: null,
          h: null,
        },
        canvasGuid: {
          sessionID: <span class="hljs-number">0</span>,
          localID: <span class="hljs-number">1</span>,
        },
        cursorHiddenReason: <span class="hljs-number">0</span>,
      },
    },
  ],
sentTimestamp: <span class="hljs-string">'1762586450176'</span>,
}

</code></pre>
<h3 data-id="heading-12">进入房间</h3>
<p>服务端检测到 WebSocket 连接，其他客户端会接收到这个新用户的信息。</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
userChanges: [
    {
      sessionID: <span class="hljs-number">95</span>,
      stableSessionID: <span class="hljs-string">'19a3dcd3fc347d0fa1289243f69c3a7340a55922'</span>,
      connected: true,
      name: <span class="hljs-string">'watermelon'</span>,
      color: {
        r: <span class="hljs-number">0.0784313753247261</span>,
        g: <span class="hljs-number">0.6823529601097107</span>,
        b: <span class="hljs-number">0.3607843220233917</span>,
        a: <span class="hljs-number">1</span>,
      },
      imageURL: <span class="hljs-string">'&lt;url&gt;'</span>,
      deviceName: <span class="hljs-string">'editor'</span>,
      userID: <span class="hljs-string">'1157564275155718012'</span>,
      canWrite: true,
      connectedAtTimeS: <span class="hljs-number">8084</span>,
    },
  ],
}

</code></pre>
<h3 data-id="heading-13">退出房间</h3>
<p>当有用户离开房间，WebSocket 断开，服务端广播。</p>
<p>其他客户度会收到这个消息。</p>
<pre><code class="hljs language-arduino" lang="arduino">{
  type: <span class="hljs-string">'USER_CHANGES'</span>,
  userChanges: [
    {
      sessionID: <span class="hljs-number">91</span>,
      connected: <span class="hljs-literal">false</span>,
    },
  ],
}

</code></pre>
<h2 data-id="heading-14">结尾</h2>
<p>我是前端西瓜哥，关注我，学习更多协同编辑知识。</p>
<hr/>
<p>相关阅读，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI0NTc2NTEyNA%3D%3D%26mid%3D2247488240%26idx%3D1%26sn%3D1c8bcf327a0c3d3566c45dfb5043cfa4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI0NTc2NTEyNA==&amp;mid=2247488240&amp;idx=1&amp;sn=1c8bcf327a0c3d3566c45dfb5043cfa4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">使用 yjs 给图形编辑器加上多人协同编辑功能</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI0NTc2NTEyNA%3D%3D%26mid%3D2247488221%26idx%3D1%26sn%3D6560730593fd9443c24e264f1017dfc3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI0NTc2NTEyNA==&amp;mid=2247488221&amp;idx=1&amp;sn=6560730593fd9443c24e264f1017dfc3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">多人协同场景下，图形编辑器如何实现多人光标功能？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI0NTc2NTEyNA%3D%3D%26mid%3D2247487894%26idx%3D1%26sn%3Da56438fcdad16696e06de0a831b85ac6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI0NTc2NTEyNA==&amp;mid=2247487894&amp;idx=1&amp;sn=a56438fcdad16696e06de0a831b85ac6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">CRDT 协同编辑：如何确定操作时序？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[爬虫是怎么工作的？从原理到用途]]></title>    <link>https://juejin.cn/post/7571355989133377551</link>    <guid>https://juejin.cn/post/7571355989133377551</guid>    <pubDate>2025-11-12T02:16:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133377551" data-draft-id="7571372478803918863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="爬虫是怎么工作的？从原理到用途"/> <meta itemprop="keywords" content="爬虫,Python,数据挖掘"/> <meta itemprop="datePublished" content="2025-11-12T02:16:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云动雨颤"/> <meta itemprop="url" content="https://juejin.cn/user/772323170591859"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            爬虫是怎么工作的？从原理到用途
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/772323170591859/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云动雨颤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:16:13.000Z" title="Wed Nov 12 2025 02:16:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在信息爆炸的互联网时代，想从海量网页中收集数据，靠人工一个个复制粘贴显然不现实。而爬虫程序，就像一位不知疲倦的“网页探险家”，能自动穿梭在网页之间，把需要的信息筛选、收集起来。今天就给大家分享一些爬虫的工作原理、实际用处，还有最重要的“爬取规矩”。</p>
<h2 data-id="heading-1">一、爬虫是怎么“逛”网页的？</h2>
<p>要理解爬虫，先想象一个场景：你拿到一张藏宝图，图上标着“路径和宝藏”，每一个藏宝点的周围都有几条小路通向其他的藏宝点，而互联网就像这张藏宝图，每个网页就是“藏宝点”，网页里的链接是“小路”，爬虫就是按图索骥的“寻宝人”。</p>
<p>它的工作流程特别像我们逛网站的逻辑，但速度快无数倍：</p>
<ol>
<li><strong>确定起点</strong>：从一个或多个“起始网页”出发（比如某网站的首页），就像寻宝人从第一个藏宝点开始；</li>
<li><strong>抓取内容</strong>：翻开藏宝点的盒子，读取当前网页的全部信息；</li>
<li><strong>寻找“小路”</strong>：分析网页里的链接（比如“下一页”“相关文章”的链接），找到通向其他网页的“小路”；</li>
<li><strong>循环探索</strong>：顺着找到的链接，跳到下一个网页，重复“抓取内容→找链接”的步骤，直到爬完目标范围，就像寻宝人走遍所有相连的藏宝点。</li>
</ol>
<p>举个例子：如果用爬虫爬取某新闻网站，它会先从首页抓取头条新闻，再通过“国内新闻”“国际新闻”的链接，分别爬取这些栏目下的每一篇文章，最后把所有新闻内容收集起来——整个过程无需人工干预，几小时就能完成人几天的工作量。</p>
<h2 data-id="heading-2">二、爬虫收集的数据，能用来做什么？</h2>
<p>爬虫抓取的网页内容，不是简单堆在一起，而是能根据需求加工成有用的信息，就像“寻宝人把收集的宝藏分类整理，变成有价值的藏品”。</p>
<h3 data-id="heading-3">1. 搜索引擎的“幕后功臣”</h3>
<p>我们每天用的百度、谷歌，背后全靠爬虫支撑。比如百度的爬虫会定期“扫荡”互联网上的网页，把内容抓回来后：</p>
<ul>
<li>先过滤掉无效、违规的内容（比如垃圾广告页）；</li>
<li>再对网页内容做“分词处理”（比如把“人工智能发展趋势”拆成“人工智能”“发展趋势”）；</li>
<li>最后建立“倒排索引”（记录每个关键词出现在哪些网页里）。
这样我们搜索关键词时，百度才能在0.1秒内找出相关网页——没有爬虫，搜索引擎就成了“无米之炊”。</li>
</ul>
<h3 data-id="heading-4">2. 个人/企业的数据收集工具</h3>
<p>如果对某个领域的信息感兴趣，爬虫能帮你高效收集。比如：</p>
<ul>
<li>学生做科研：爬取学术网站的论文标题、摘要，整理成研究文献库；</li>
<li>电商卖家：爬取竞争对手的商品价格、销量数据，分析定价策略；</li>
<li>自媒体人：爬取热门平台的爆款文章标题，总结创作趋势。</li>
</ul>
<h3 data-id="heading-5">3. 网站内容的“迁移助手”</h3>
<p>有时候网站需要更新迭代，或者从旧平台迁移到新平台，爬虫能帮着“搬家”。比如某博客平台要关闭，用户可以用爬虫把自己发布的所有文章、评论爬下来，再导入到新的博客平台，避免内容丢失——这比手动复制每一篇文章高效太多。</p>
<h2 data-id="heading-6">三、重要提醒：爬虫也要“守规矩”，robots协议不能忽视</h2>
<p>爬虫爬取网页时，有必须遵守的规则——<strong>robots协议</strong>，这是互联网世界的“爬取礼仪”。</p>
<h3 data-id="heading-7">1. robots协议是什么？</h3>
<p>robots协议是网站主人放在服务器根目录的一个特殊文件（通常地址是“网站域名/robots.txt”），里面会明确告诉爬虫：“哪些页面可以爬，哪些页面不能爬”。比如某购物网站的robots协议可能会写：“允许爬取商品列表页，但禁止爬取用户的个人订单页”。</p>
<h3 data-id="heading-8">2. 为什么要遵守？</h3>
<ul>
<li><strong>尊重网站权益</strong>：有些页面包含隐私信息（如用户登录后的个人中心）或敏感数据（如企业内部文档），网站不希望被爬虫抓取，遵守协议是对他人权益的尊重；</li>
<li><strong>避免法律风险</strong>：如果无视robots协议，强行爬取禁止访问的页面，可能会被认定为“非法获取数据”，面临法律纠纷；</li>
<li><strong>减少服务器压力</strong>：过度爬取会占用网站大量带宽和算力，导致网站卡顿甚至崩溃，遵守协议能避免这种“恶意消耗”。</li>
</ul>
<p>比如某知名爬虫工具曾因大量爬取某社交平台的用户数据，且无视robots协议的禁止规则，最终被起诉，不仅赔偿了巨额罚款，还暂停了相关功能——“无规矩不成方圆”，爬虫的高效必须建立在合规的基础上。</p>
<h2 data-id="heading-9">四、爬虫不是“万能的”，这些限制要知道</h2>
<p>虽然爬虫很强大，但也不是什么都能爬，有3个常见限制：</p>
<ul>
<li><strong>反爬机制拦截</strong>：很多网站会设置“反爬措施”，比如限制同一IP的访问频率（频繁爬取会被暂时封禁IP）、要求输入验证码、动态加载内容（用JavaScript渲染页面，普通爬虫抓不到），这时候需要更专业的爬虫技术才能应对；</li>
<li><strong>数据版权问题</strong>：即使爬取了公开网页的内容，也不能随意使用。比如爬取别人的原创文章后，直接复制发布到自己的平台，可能侵犯著作权；</li>
<li><strong>技术门槛差异</strong>：
<ul>
<li>简单的爬虫（比如爬取静态网页）用Python的“requests”“BeautifulSoup”库就能实现，新手跟着教程也能做；</li>
<li>复杂的爬虫（比如爬取需要登录的平台、动态网页），需要掌握更多技术（如Selenium、API接口调用）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10">五、总结</h2>
<p>爬虫本身没有“好坏”之分，它就像一把“铲子”：用它合规地挖掘公开信息，能帮我们提高效率、解决问题；但如果用它破坏规则、获取敏感数据，就会变成“麻烦制造者”。</p>
<p>理解爬虫的工作原理，不仅能帮我们更好地利用这个工具，也能明白“为什么搜索引擎能快速找到信息”“为什么有些网站会限制爬取”——透过爬虫，我们也能更懂互联网的运行逻辑。如果以后想尝试用爬虫，记得先从“小范围、合规的爬取”开始，做一个有“道德”的“网页探险家”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[藏不住了！TinyVue 悄悄上线 Space 组件，不止按钮表格，弹性间距全搞定]]></title>    <link>https://juejin.cn/post/7571342319893889059</link>    <guid>https://juejin.cn/post/7571342319893889059</guid>    <pubDate>2025-11-12T02:16:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319893889059" data-draft-id="7571280402964398115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="藏不住了！TinyVue 悄悄上线 Space 组件，不止按钮表格，弹性间距全搞定"/> <meta itemprop="keywords" content="前端,Vue.js,GitHub"/> <meta itemprop="datePublished" content="2025-11-12T02:16:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            藏不住了！TinyVue 悄悄上线 Space 组件，不止按钮表格，弹性间距全搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:16:10.000Z" title="Wed Nov 12 2025 02:16:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由TinySpace组件贡献者夏雯斐同学原创。</p>
<h2 data-id="heading-0">前言</h2>
<p>近期，TinyVue正式发布 v3.27.0版本，这次版本更新也增加了很多新特性，space组件就是其中比较重要的一个特性。<br/>
<strong>Space组件</strong> 是 <strong>OpenTiny Vue</strong>组件库中的一个布局容器组件，用于在子元素之间提供灵活的间距控制。
它支持水平与垂直方向排列、自动换行、对齐与分布控制、以及顺序调整等功能，能帮助开发者轻松实现响应式、整齐的组件布局。</p>
<h3 data-id="heading-1">适用场景</h3>
<ul>
<li>表单项或按钮组的布局</li>
<li>列表项的水平/垂直间距</li>
<li>工具栏元素的分布控制</li>
<li>在响应式布局中控制间距与换行</li>
</ul>
<h2 data-id="heading-2">环境准备与安装</h2>
<h3 data-id="heading-3">1. 环境要求</h3>
<p>确保已安装 <strong>Node.js 10.13+</strong> 及包管理器 npm/pnpm/yarn。</p>
<pre><code class="hljs language-bash" lang="bash">node -v
</code></pre>
<h3 data-id="heading-4">2. 安装 OpenTiny Vue</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm install @opentiny/vue

<span class="hljs-comment"># 或 pnpm</span>
pnpm add @opentiny/vue
</code></pre>
<h3 data-id="heading-5">3.引入TinySpace</h3>
<pre><code class="hljs language-vue" lang="vue">import { TinySpace } from '@opentiny/vue'
</code></pre>
<h2 data-id="heading-6">快速开始</h2>
<h3 data-id="heading-7">基础使用</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div id="tiny-space-all" style="padding: 16px; max-width: 600px"&gt;
    &lt;h2&gt;TinySpace 全功能演示&lt;/h2&gt;

    &lt;!-- 控制面板 --&gt;
    &lt;div style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px;"&gt;
      &lt;!-- 间距控制 --&gt;
      &lt;div&gt;
        &lt;strong&gt;间距：&lt;/strong&gt;
        &lt;tiny-button @click="size = [10, 10]"&gt;[10, 10]&lt;/tiny-button&gt;
        &lt;tiny-button @click="size = [10, 30]"&gt;[10, 30]&lt;/tiny-button&gt;
        &lt;tiny-button @click="size = [20, 40]"&gt;[20, 40]&lt;/tiny-button&gt;
      &lt;/div&gt;

      &lt;!-- 布局方向 --&gt;
      &lt;div&gt;
        &lt;strong&gt;方向：&lt;/strong&gt;
        &lt;tiny-button-group&gt;
          &lt;tiny-button @click="direction = 'row'"&gt;水平 row&lt;/tiny-button&gt;
          &lt;tiny-button @click="direction = 'column'"&gt;垂直 column&lt;/tiny-button&gt;
        &lt;/tiny-button-group&gt;
      &lt;/div&gt;

      &lt;!-- 主轴对齐 --&gt;
      &lt;div&gt;
        &lt;strong&gt;主轴对齐 (justify)：&lt;/strong&gt;
        &lt;tiny-select v-model="justify" style="width: 160px"&gt;
          &lt;tiny-option label="start" value="start" /&gt;
          &lt;tiny-option label="center" value="center" /&gt;
          &lt;tiny-option label="end" value="end" /&gt;
          &lt;tiny-option label="space-between" value="space-between" /&gt;
          &lt;tiny-option label="space-around" value="space-around" /&gt;
        &lt;/tiny-select&gt;
      &lt;/div&gt;

      &lt;!-- 交叉轴对齐 --&gt;
      &lt;div&gt;
        &lt;strong&gt;交叉轴对齐 (align)：&lt;/strong&gt;
        &lt;tiny-select v-model="align" style="width: 160px"&gt;
          &lt;tiny-option label="start" value="start" /&gt;
          &lt;tiny-option label="center" value="center" /&gt;
          &lt;tiny-option label="end" value="end" /&gt;
          &lt;tiny-option label="baseline" value="baseline" /&gt;
        &lt;/tiny-select&gt;
      &lt;/div&gt;

      &lt;!-- 自动换行 --&gt;
      &lt;div&gt;
        &lt;tiny-switch v-model="wrap" active-text="自动换行" inactive-text="不换行" /&gt;
      &lt;/div&gt;

      &lt;!-- 顺序控制 --&gt;
      &lt;div&gt;
        &lt;strong&gt;顺序控制：&lt;/strong&gt;
        &lt;tiny-button @click="order = ['3', '1', '2']"&gt;3 → 1 → 2&lt;/tiny-button&gt;
        &lt;tiny-button @click="order = ['2', '3', '1']"&gt;2 → 3 → 1&lt;/tiny-button&gt;
        &lt;tiny-button @click="order = []"&gt;原顺序&lt;/tiny-button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Space 布局演示 --&gt;
    &lt;tiny-space
      class="tiny-space-demo"
      :size="size"
      :direction="direction"
      :justify="justify"
      :align="align"
      :wrap="wrap"
      :order="order"
      style="border: 1px dashed #bbb; padding: 10px; min-height: 120px;"
    &gt;
      &lt;tiny-button key="1" type="primary"&gt;按钮 1&lt;/tiny-button&gt;
      &lt;tiny-button key="2" type="success"&gt;按钮 2&lt;/tiny-button&gt;
      &lt;tiny-button key="3" type="warning"&gt;按钮 3&lt;/tiny-button&gt;
      &lt;tiny-button key="4" type="danger"&gt;按钮 4&lt;/tiny-button&gt;
      &lt;tiny-button key="5" type="info"&gt;按钮 5&lt;/tiny-button&gt;
    &lt;/tiny-space&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import { TinyButton, TinyButtonGroup, TinySwitch, TinySelect, TinyOption } from '@opentiny/vue'
import TinySpace from '@opentiny/vue-space'


// 响应式配置项
const size = ref([10, 20])
const direction = ref('row')
const justify = ref('start')
const align = ref('center')
const wrap = ref(true)
const order = ref([])
&lt;/script&gt;

&lt;style scoped&gt;
.tiny-space-demo .tiny-button {
  min-width: 80px;
}
&lt;/style&gt;
</code></pre>
<blockquote>
<p>默认方向为 <code>row</code>（水平排列），默认间距为 <code>8px</code>。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd7b54484b284787b1ca9b9ef8d51b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519933&amp;x-signature=ow1hXW%2Foq%2FyzCAFnrVpJf3V5OJU%3D" alt="TinySpace 效果图" loading="lazy"/></p>
<h3 data-id="heading-8">配置详解</h3>
<h4 data-id="heading-9">1.控制间距 size</h4>
<p><code>size</code> 是最核心的属性，支持多种写法。</p>
<h5 data-id="heading-10">1.1数值写法</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space :size="20"/&gt;
</code></pre>
<p>间距为 <code>20px</code>。</p>
<h5 data-id="heading-11">1.2数组写法（[rowGap, columnGap]）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space :size="[50, 50]"/&gt;
</code></pre>
<p>行间距 <code>50px</code>，列间距 <code>50px</code>，方便实现不等距布局。</p>
<h5 data-id="heading-12">1.3字符串写法</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space size="100px"/&gt;
</code></pre>
<p>间距为 <code>100px</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space size="small"/&gt;
// small | medium | large
</code></pre>
<h4 data-id="heading-13">2.控制排列方向 direction</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space :size="12" direction="row"/&gt;
</code></pre>
<p>- <code>'row'</code>（默认）：水平排列</p>
<p>- <code>'column'</code>：垂直排列</p>
<p>可以通过切换 <code>direction</code> 实现响应式布局（如手机端竖排、PC端横排）。</p>
<h4 data-id="heading-14">3.对齐 align 与分布 justify</h4>
<p>通过 <code>align</code> 和 <code>justify</code> 控制元素对齐与分布方式。</p>
<h5 data-id="heading-15">3.1 justify</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space :size="10" justify="center"/&gt;
</code></pre>
<h5 data-id="heading-16">3.2 aligin</h5>
<pre><code class="hljs language-VUE" lang="VUE">&lt;tiny-space :size="10" align="baseline"/&gt;     
</code></pre>




















<table><thead><tr><th>属性</th><th>说明</th><th>可选值</th></tr></thead><tbody><tr><td><code>align</code></td><td>垂直对齐</td><td><code>start</code> / <code>center</code> / <code>end</code>/<code>baseline</code>/<code>stretch</code></td></tr><tr><td><code>justify</code></td><td>水平分布</td><td><code>start</code> / <code>center</code> / <code>end</code> / <code>space-between</code></td></tr></tbody></table>
<h4 data-id="heading-17">4.自动换行 wrap</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space :wrap="true" :size="[10, 12]"&gt;
  &lt;tiny-button v-for="n in 10" :key="n"&gt;按钮 {{ n }}&lt;/tiny-button&gt;
&lt;/tiny-space&gt;
</code></pre>
<p><strong>效果</strong>：  当宽度不够时，按钮会自动换行，仍然保持间距一致。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b077325374d64489b63671382b917a3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519933&amp;x-signature=BcJrWKhoFFOj7MHmB10tsN284HM%3D" alt="2.JPG" loading="lazy"/></p>
<h4 data-id="heading-18">5.控制顺序 order</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;tiny-space :order="order" style="border: 1px dashed #ccc"&gt;
    &lt;tiny-button key="1"&gt;First Button&lt;/tiny-button&gt;
    &lt;tiny-button key="2"&gt;Second Button&lt;/tiny-button&gt;
    &lt;tiny-button key="3"&gt;Third Button&lt;/tiny-button&gt;
    &lt;tiny-button&gt;Fourth Button&lt;/tiny-button&gt;
  &lt;/tiny-space&gt;
&lt;/template&gt;
&lt;script setup&gt;
import { TinyButton, TinySpace } from '@opentiny/vue'
const order = ['2', '3', '1'] // 自定义顺序：第二个、第三个、然后第一个
&lt;/script&gt;

</code></pre>
<p>设置 <code>order="['2', '3', '1']"</code> 后，渲染顺序会变为 <strong><strong>2 → 3 → 1</strong></strong>。</p>
<blockquote>
<p>适用于在响应式布局中快速调换内容顺序。</p>
</blockquote>
<h4 data-id="heading-19">6.嵌套布局（组合使用）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-space direction="column" :size="16"&gt;
 &lt;tiny-space direction="row" :size="8"&gt;
  &lt;tiny-button&gt;左&lt;/tiny-button&gt;
  &lt;tiny-button&gt;中&lt;/tiny-button&gt;
  &lt;tiny-button&gt;右&lt;/tiny-button&gt;
 &lt;/tiny-space&gt;

 &lt;tiny-space direction="row" :size="8"&gt;
  &lt;tiny-button&gt;上&lt;/tiny-button&gt;
  &lt;tiny-button&gt;下&lt;/tiny-button&gt;
 &lt;/tiny-space&gt;
&lt;/tiny-space&gt;
</code></pre>
<h4 data-id="heading-20">7.测试与稳定性</h4>
<p><code>TinySpace</code> 已通过 Playwright E2E 自动化测试，验证：</p>
<ul>
<li>
<p>间距正确渲染（<code>rowGap</code> / <code>columnGap</code>）</p>
</li>
<li>
<p>动态数据更新响应</p>
</li>
<li>
<p>换行与方向切换稳定</p>
</li>
<li>
<p>兼容 Vue 2 &amp; Vue 3 环境</p>
</li>
</ul>
<h4 data-id="heading-21">8.最佳实践总结</h4>





















<table><thead><tr><th>场景</th><th>推荐配置</th></tr></thead><tbody><tr><td>表单项垂直间距</td><td><code>&lt;tiny-space direction="column" :size="12"&gt;</code></td></tr><tr><td>按钮组</td><td><code>&lt;tiny-space :size="8" align="center"&gt;</code></td></tr><tr><td>可换行标签集合</td><td><code>&lt;tiny-space :size="[8, 16]" wrap&gt;</code></td></tr></tbody></table>
<h4 data-id="heading-22">9.小结</h4>
<p><strong>TinySpace</strong> 是一个轻量级、灵活的布局组件，专为控制子元素间距而设计。
它支持：</p>
<ul>
<li>数值、预设、数组多种间距形式</li>
<li>垂直与水平排列</li>
<li>自动换行与对齐分布</li>
<li>顺序控制</li>
<li>Vue 2 / Vue 3 双版本兼容</li>
</ul>
<p>通过它，开发者可以轻松构建整洁、美观、响应式的 UI 布局。</p>
<h3 data-id="heading-23">属性一览</h3>















































<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>size</code></td><td><code>number</code> /<code>array</code> / <code>string</code></td><td><code>small</code></td><td>设置间距大小，可为字符串、数字或数组，数组形式为 [横向间距, 纵向间距]</td></tr><tr><td><code>direction</code></td><td><code>string</code></td><td><code> row</code></td><td><code>row</code> | <code>column</code></td></tr><tr><td><code>align</code></td><td><code>string</code></td><td><code>stretch</code></td><td>设置交叉轴上的对齐方式，对应 CSS <code>align-items</code> 属性</td></tr><tr><td><code>justify</code></td><td><code>string</code></td><td><code>start</code></td><td>设置主轴上的对齐方式，对应 CSS<code> justify-content</code> 属性</td></tr><tr><td><code>wrap</code></td><td><code>boolean</code></td><td><code>false</code></td><td>是否自动换行</td></tr><tr><td><code>order</code></td><td><code>string[]</code></td><td>-</td><td>控制子项显示顺序</td></tr></tbody></table>
<h2 data-id="heading-24">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p>OpenTiny 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a><br/>
OpenTiny 代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a><br/>
TinyVue 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
TinyEngine 源码： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~
如果你也想要共建，可以进入代码仓库，找到 good first issue 标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CCF程序员大会码力全开：AI加速营，10w奖金等你拿！]]></title>    <link>https://juejin.cn/post/7571355989133475855</link>    <guid>https://juejin.cn/post/7571355989133475855</guid>    <pubDate>2025-11-12T02:23:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133475855" data-draft-id="7564485874726993920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CCF程序员大会码力全开：AI加速营，10w奖金等你拿！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-12T02:23:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CCF程序员大会码力全开：AI加速营，10w奖金等你拿！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:23:39.000Z" title="Wed Nov 12 2025 02:23:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>CCF程序员大会码力全开：AI加速营</strong>，正式启动！活动由中国计算机学会主办，文心大模型、文心快码、msup联合承办，诚邀你一起成为AI的“魔法师”——用代码点亮创意，以技术创造未来。</p>
<p>提交优秀作品，即有机会<strong>瓜分超10w元奖金</strong>💰！更有机会享受企业实训直通、行业峰会亮相、媒体曝光等全⽅位的资源与服务，助你从活动走向更广阔的舞台！</p>
<h2 data-id="heading-0">一、活动理念</h2>
<h3 data-id="heading-1">创意不设限</h3>
<p>面向所有AI爱好者、创业团队、独立开发者和高校师生，借助文心快码与文心大模型技术，将创意灵感落地为可展示、可交互的应用作品。我们期待你打破常规，释放想象，用代码构建不一样的世界！</p>
<h3 data-id="heading-2">AI向善</h3>
<p>技术，因情怀而更有温度。我们鼓励将正向价值观与社会责任感融入作品。期待你的创作不仅在技术上创新，更能以人为本，赋能社会，让AI服务于社会的美好发展。</p>
<p>微信扫码加入活动专属社群，了解更多活动详情：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9cb286cc9e44c8a917180ecea0f348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=sjVZhr51Q2rkQBVBegMMWzVR55Q%3D" alt="infoflow 2025-11-12 10-17-47.png" loading="lazy"/></p>
<ul>
<li>获取“五万元人气奖”详细评选规则与参与机制；</li>
<li>享有技术导师在线答疑，及时解决开发难题；</li>
<li>融入互助、共享、共创的开发者社区，与同行一起成长。</li>
</ul>
<h2 data-id="heading-3">二、活动方向</h2>
<p>选择感兴趣的方向，与AI Coding工具结对，释放你的创造力！</p>
<h3 data-id="heading-4">1 工具提效</h3>
<p>在生活服务、教育、办公等领域，数据规模和场景复杂度持续增长，人们对效率提升与个性化体验的诉求日益强烈。我们鼓励你运用AI编程，聚焦具体场景，打造一款切实提升效能的智能工具，让AI成为工作与生活中的可靠伙伴，实现“技术服务于人”。</p>
<p>示例：早期人类奴役AI实录：用Comate Zulu 10min做一款Chrome插件</p>
<h3 data-id="heading-5">2 社会赋能</h3>
<p>AI不仅是技术革命，更是推动产业升级与技术进步的重要力量。我们期待你围绕真实社会需求，开发具备现实根基与可持续价值的应用作品，覆盖公益、环保、健康、助老、文化传承等领域，也欢迎具有商业潜力的创新方案。用代码传递科技的温度，让AI服务于社会的美好发展。</p>
<p>示例：放弃Cursor选择文心快码，我从算法工程师进阶到了全栈工程师</p>
<h3 data-id="heading-6">3 无限创意</h3>
<p>在这里，想象力无界，创造自由。我们鼓励你打破一切常规，用AI实现那些天马行空的构想——无论是生成互动艺术、构造虚拟世界、开发情感计算应用，还是创造全新的交互体验。你的作品，就是赛道。不设限，不定义，只为见证技术如何因创意而绽放无限可能。</p>
<h3 data-id="heading-7">4 “模”力加码</h3>
<p>模型是AI编程的最强大脑🧠！推荐在项目核心功能或生成流程中调用文心4.5开源系列模型，用于完成理解、生成、推理等智能任务。让您的作品“模”力满满～</p>
<h2 data-id="heading-8">三、奖励设置</h2>
<h3 data-id="heading-9">1 总分TOP3</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a787afba5fd4745a4115bd3cc10bf76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=R94pcqMl5dy14uazRftVLjIVSF0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-10">2 单项奖</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f12652af24fb4b07b2df9662c9eae3ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=315LblTCJx9qCTYCp7Ap7q1WLRU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>冠、亚、季军不可重复获奖</p>
<h3 data-id="heading-11">3 “模”力加成奖</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/905876f17f214383afd5b44bdd12aafb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=6kQ3165cN1DwYiX79%2FORuQtRrdM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>推荐在核心功能或生成流程中调用文心大模型</p>
<h3 data-id="heading-12">4 最具人气奖</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84b6def0a1bc41918755c294a42ed9be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=PbAB9ZXYJTUJBMRCQCwkjwlfX%2Bc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>参与者将作品积极分享在技术社区和社交媒体，可额外瓜分价值5w元实物奖励～</p>
<p>参与者务必加入「活动答疑群」！！社群将公布人气奖瓜分细则并统计发布渠道</p>
<h3 data-id="heading-13">5 实训直通</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b4f33520c24f64b3d95e3fece95361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=E1R4GqMGVkAoNr4Uq4hoIyceGYM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-14">6 项目曝光</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4807e295f42840a6bb5c0e1250693ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519019&amp;x-signature=gP6jtIE%2BSwfNEj3m9shbzZn9P0U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-15">四、活动流程</h2>
<ul>
<li><strong>10.24 活动开启</strong></li>
<li><strong>11.15 报名截止</strong></li>
<li><strong>11.20 项目提交截止</strong></li>
<li><strong>12月初 获奖作品公示&amp;奖励发放</strong></li>
</ul>
<h2 data-id="heading-16">五、参赛要求</h2>
<p>1.须使用<strong>文心快码 (Baidu Comate)</strong> 进行开发；</p>
<p>一键下载Baidu Comate：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcomate.baidu.com%2Fzh%2Fdownload" target="_blank" title="https://comate.baidu.com/zh/download" ref="nofollow noopener noreferrer">comate.baidu.com/zh/download</a></p>
<p>2.项目开发过程中，可使用第三方工具与文心快码结合，探索更丰富的作品形态；</p>
<p>3.最终提交项目是可公开展示的应用，需<strong>提交GitHub链接或可公开访问作品的链接或至官网</strong>（点击活动官网“提交作品”按钮，提交个人及作品信息）；</p>
<p>4.推荐使用文心模型，有机会获得额外奖励；</p>
<p><strong>5.鼓励多渠道分享</strong>（百度星河社区、稀土掘金、CSDN、知乎等技术社区和社交媒体）作品，可<strong>额外瓜分价值5w元</strong>人气奖；</p>
<p>6.每个方向都能以个人或团队名义参与；</p>
<p>7.原创性：作品核心创意、逻辑和实现需为原创，严禁抄袭、剽窃。如引用第三方资源需注明出处；</p>
<p>8.内容合规：作品内容需符合国家法律法规及公序良俗，不得包含侵权、违法、色情、暴力、歧视等不良信息。</p>
<p>了解更多活动详情或报名参与，请访问活动官网👇<a href="https://link.juejin.cn?target=https%3A%2F%2Fcomate.baidu.com%2Fzh%2FactivityComate1024" target="_blank" title="https://comate.baidu.com/zh/activityComate1024" ref="nofollow noopener noreferrer">comate.baidu.com/zh/activity…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日前端知识点（一）：原型与原型链]]></title>    <link>https://juejin.cn/post/7571355989133279247</link>    <guid>https://juejin.cn/post/7571355989133279247</guid>    <pubDate>2025-11-12T02:09:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133279247" data-draft-id="7570866247979909172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日前端知识点（一）：原型与原型链"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T02:09:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Milian"/> <meta itemprop="url" content="https://juejin.cn/user/2041125009126061"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日前端知识点（一）：原型与原型链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041125009126061/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Milian
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:09:41.000Z" title="Wed Nov 12 2025 02:09:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 首先理解使用class实现继承</h2>
<blockquote>
<p>extends关键字可以继承父类的属性和方法，通过super这个方法调用，其实是原型来实现</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {<span class="hljs-comment">//父类</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">drink</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喝水'</span>)
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span>{<span class="hljs-comment">//extends 继承父类</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">super</span>(name)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  <span class="hljs-title function_">intruduce</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>已经<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁了`</span>)
  }
}

<span class="hljs-keyword">const</span> student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student, <span class="hljs-string">'student'</span>);
student.<span class="hljs-title function_">intruduce</span>();

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span>{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">super</span>(name)
    <span class="hljs-comment">// this.name = name;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'李四'</span>, <span class="hljs-number">6</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person, <span class="hljs-string">'person'</span>);
person.<span class="hljs-title function_">drink</span>();
</code></pre>
<h2 data-id="heading-1">2. 原型是什么？</h2>
<p>先上代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
    }
    <span class="hljs-title function_">intruduce</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>已经<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁了`</span>)
    }
}

<span class="hljs-keyword">const</span> student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student, <span class="hljs-string">'student'</span>);
student.<span class="hljs-title function_">intruduce</span>();
</code></pre>
<h4 data-id="heading-2">a. student实例对象</h4>
<h5 data-id="heading-3">ⅰ. 下图可以看出，student对象这个实例对象并没有包含intruduce方法</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c99d6f0938fe478096affba88b33c068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=qDluC4Lu2nrvUhge%2FVyBG1Uw1QM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-4">ⅱ. 我们把它展开后，其实是包含在__proto__中</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb4bb78fcfaf4f04bace9fd35d6c7a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=ST%2FAUCJe2KCpuU%2Bs0vp8k19njsg%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-5">ⅲ. __proto__则为student的隐式原型</h5>
<p>所以当我们去找一个对象的属性和方法的时候，当前的对象上找不到的时候，它就会去它的隐式原型上找，如果隐式原型上有这个方法，它就会去访问这个方法，然后进行调用。</p>
<p>调用方式就是student.<strong>proto</strong></p>
<h4 data-id="heading-6">b. Student类</h4>
<h5 data-id="heading-7">ⅰ. Student上面有一个属性叫prototype,也可以打印出它的方法</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df87a9a93b9b4a6dba6c56e0cacaa800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=fPmysmO%2Fh5rbUkvB476IKhPapNY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">ⅱ. 而student.__proto__也同样有这些方法，我们对比后发现它们是一摸一样的</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e351cd9086a40a09da7e18ed8c3012d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=79twcAf6Ee%2FghJ1KV46RgUXTi08%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">c. 从这张图可以看出它们指向同一个对象，而prototype是Student这个类的显示原型</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0a89b2b36974f5f822c4b800e6fff0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=beVN0wtIf%2BKMODFfZqcIKhEjRUY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">3. 原型链又是什么？</h2>
<p>在上代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<span class="hljs-comment">//父类</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
    <span class="hljs-title function_">drink</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喝水'</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Teacher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span>{
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">super</span>(name);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
    }
    <span class="hljs-title function_">intruduce</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>已经<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁了`</span>)
    }
}

<span class="hljs-keyword">const</span> teacher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(teacher, <span class="hljs-string">'teacher'</span>);
teacher.<span class="hljs-title function_">intruduce</span>();
</code></pre>
<h4 data-id="heading-11">a. 实例对象teacher调用一个方法，首先会在自身开始找，找不到就通过__proto__隐式原型所指向的Teacher类的显示原型的prototype去找，找到后执行这个方法,如果还是找不到，又因为Teacher.prototype是一个对象，那么它也有一个__proto__属性，然后就会去找它所继承的父类Person的显示原型Person.prototype里面的方法，所以teacher通过这样一个链一层一层的找到目标的方法，这就是我们所说的原型链。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2047218d069e4e2595fcfff2dd13989b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=A1oNpgq8AozhY1B2s%2FGZXFBMqE4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50dc032004944489b6427c6106c21c03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=b4xYlu5uHYgrM%2FCfPSYJ0tixQC8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">b. 检测查看属性和方法是否是自身所拥有的</h4>
<pre><code class="hljs language-js" lang="js">teacher.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"teacher"</span>)<span class="hljs-comment">//false</span>
teacher.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"name"</span>)<span class="hljs-comment">//true</span>
</code></pre>
<blockquote>
<p>那么hasOwnProperty这个属性是从哪儿来的呢？</p>
<p>对象的最终会指向那我们发现person这个父类其实是继承了objects这个类，也就是person.Prototype的隐式原型__proto__其实是指向Object.prototype这个原型,然后所有的对象最终都会指向object，最后object对象的原型最终会指向null。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c9bd3ea7d545449e3119a86e214bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=C7ujsIFfQNL%2Fd9c1%2BLjZzzvdUCQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/164bd69209274d738e44029c5cc8ead9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=UiCoePmeJAbvgwmkLKm05zpOSCM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">4. instanceof 检查类型</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21c7cc4fffd43578af7a70004d0cdc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=%2FNiD9aXHTZpRll%2F4dIhy4thSwIQ%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>原理：原型链</p>
</blockquote>
<p>如果是在teacher的原型链的东西，都会返回true,而Array不存在原型链上所以返回false</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9483b9611bef453d8785997e7c9eda5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlsaWFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518260&amp;x-signature=z2PCVA38aa97osezvF0Hvco8GTc%3D" alt="" loading="lazy"/></p>
<h6 data-id="heading-14"><code>到这里应该能理解原型与原型链的概念了</code></h6></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零到一：编写一个简单的 Umi 插件并发布到 npm]]></title>    <link>https://juejin.cn/post/7571378103281434630</link>    <guid>https://juejin.cn/post/7571378103281434630</guid>    <pubDate>2025-11-12T02:21:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103281434630" data-draft-id="7571334572769542187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零到一：编写一个简单的 Umi 插件并发布到 npm"/> <meta itemprop="keywords" content="前端,前端框架,React.js"/> <meta itemprop="datePublished" content="2025-11-12T02:21:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lcy453"/> <meta itemprop="url" content="https://juejin.cn/user/2921833644950300"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零到一：编写一个简单的 Umi 插件并发布到 npm
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2921833644950300/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lcy453
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:21:25.000Z" title="Wed Nov 12 2025 02:21:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> 一、前言</h2>
<p>        最近在学习 Umi 框架时，发现它的插件机制特别灵活。于是我尝试写一个最简单的 Umi 插件，比如在启动项目时输出一句提示语。</p>
<p>        做完这个我们可以了解插件的基本规范，以及如何打包发布到npm，如何让别人npm install 直接安装使用。</p>
<h2 data-id="heading-1">二、创建插件项目</h2>
<p>        创建项目文件夹    <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e75d5df7967842bfbc03ce34d491d1fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=a79YrQ50K8RrFC82BRKPopnWNhY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e747a280b7c74570a939920d7e17e73b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=oupg7n91lLa4fvtC%2F4BDFCrL1lA%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>        这样项目就创建好了，而且携带了package.json文件，现在我们需要添加一个依赖umi，然后安装umi。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c528f5b6abc4e55997d612be2aef52f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=q3FyB1bJlbmwLGGBDoc8yl0VvRE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>执行pnpm install 就自动安装好依赖了。</p>
<h2 data-id="heading-2">三、注册登录npm然后发布本地插件到npm</h2>
<p>        注册到npm官网就可以，这里我直接登录好了。</p>
<p>        <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6038d0aa54e466886312c102307f048~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=u3jKM%2FABCPQVL0cB09kluAyLZKU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>        登录之后就可以直接npm publish 直接上传到npm了。</p>
<p>        也可以用命令注册，npm adduser 然后输入账户密码就可以了，邮箱也需要填写。</p>
<h2 data-id="heading-3">4、发布之后通过npm install 安装插件并且使用</h2>
<p>        首先可以本地写好插件上传发布之前在自己项目用pnpm link 插件名称本地测试一下。</p>
<p>        首先在插件项目目录pnpm link 将插件包link到npm 或者pnpm环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d502642cb01e44e3981de67f537ac461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=nUwxg3iSwa5WgcxCeBRWXANTS7o%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>        然后在项目目录npm link 插件包名运行即可</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c6bf7f7953343ffbc58e7d104890227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=z1IKwOObEZWfUqNihcAYGDtMlR4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>        在自己的项目输入npm install 自己的插件名称。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3885619cc7c74c9d9231a5d13db666dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=OhJ3JQ%2FXKWbHhS45l3hCT1uY%2FG8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b5bc322e284857b4c8be3bc6c596b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=hmMLfpqdz47c8EPqoFaZHi3xXmM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>        这样插件就安装完成了。</p>
<p>        安装完之后我们在自己的umi项目里面，在.umirc.ts配置或者config/config.ts中配置defineConfig中的plugins插件配置项就可以了。</p>
<pre><code class="hljs language-php" lang="php">import { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"umi"</span>;

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">routes</span>: [
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"index"</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/docs"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"docs"</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/login"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"login"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/weather"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"weather"</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/promise"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"Promise"</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/aiChat"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"aiChat"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/websocket"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"websocket"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/test"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"test"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/streamingChat"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"streamingChat"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"/fileUploadDemo"</span>, <span class="hljs-attr">component</span>: <span class="hljs-string">"FileUploadDemo"</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> },
  ],
  <span class="hljs-attr">npmClient</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-attr">mock</span>: {
    <span class="hljs-attr">include</span>: [<span class="hljs-string">"src/mock/**/*.ts"</span>], // 启用mock功能并指定mock文件位置
  },
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"umi-plugin-hello-lcy"</span>],
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>        运行项目控制台会输出</p>
<p>        <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13a208464e2c48a4a19aee59874a2baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGN5NDUz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518885&amp;x-signature=SIh%2BfeHFAWJZhUNQ5jFkWAhrGGc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-4">5、常见问题       </h2>

























<table><thead><tr><th>问题</th><th>原因</th><th>解决办法</th></tr></thead><tbody><tr><td><code>npm error EPRIVATE</code></td><td><code>package.json</code> 中 <code>"private": true</code></td><td>删除该字段</td></tr><tr><td><code>npm error 402 Payment Required</code></td><td>使用了作用域包（<code>@xxx/</code>）且没设置公开</td><td>加上 <code>--access public</code></td></tr><tr><td>插件未生效</td><td>没在 Umi 配置文件中启用</td><td>确认在 <code>plugins</code> 数组中声明</td></tr></tbody></table>
<h2 data-id="heading-5">6、总结</h2>
<p>这一套流程下来，你已经理解了 Umi 插件的基本结构,能在本地测试插件(npm link 插件名称),成功将插件发布到 npm,<br/>
并能被其他项目直接安装使用。</p>
<h4 data-id="heading-6">值得一提的工具</h4>
<ul>
<li>nrm包镜像源管理工具类似于nvm，管理镜像源</li>
<li>如果要在npm公布上传插件包，需要切换到对应npm镜像源然后登录</li>
<li>如果公司内网也需要切换到内网镜像源</li>
<li>相关命令为 nrm ls 查看当前镜像源以及使用的镜像源</li>
<li>nrm use 切换镜像源
​</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML/CSS/JS 页面渲染机制：揭秘浏览器如何将平凡代码点化为视觉魔法]]></title>    <link>https://juejin.cn/post/7571355989133459471</link>    <guid>https://juejin.cn/post/7571355989133459471</guid>    <pubDate>2025-11-12T02:22:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133459471" data-draft-id="7569580617709781046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML/CSS/JS 页面渲染机制：揭秘浏览器如何将平凡代码点化为视觉魔法"/> <meta itemprop="keywords" content="前端,HTML,CSS"/> <meta itemprop="datePublished" content="2025-11-12T02:22:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML/CSS/JS 页面渲染机制：揭秘浏览器如何将平凡代码点化为视觉魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:22:57.000Z" title="Wed Nov 12 2025 02:22:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、浏览器渲染流程概览</h2>
<p>在互联网时代，我们每天都在与网页打交道，但你是否思考过，当我们在浏览器中输入URL后，页面是如何从代码变成我们看到的精美界面的呢？浏览器的渲染过程是一个复杂而精妙的流程，理解它对于前端开发者至关重要。</p>
<h3 data-id="heading-1">浏览器渲染流程</h3>
<ol>
<li><strong>输入</strong>：HTML/CSS/JS 代码</li>
<li><strong>浏览器处理</strong>：解析、构建、渲染</li>
<li><strong>输出</strong>：最终呈现的页面</li>
</ol>
<p>浏览器每秒可以绘制60次（16.6ms/帧），这保证了页面流畅的视觉体验。</p>
<hr/>
<h2 data-id="heading-2">二、渲染过程详解</h2>
<h3 data-id="heading-3">1. 构建DOM树</h3>
<p>浏览器解析HTML字符串，将其转换为DOM（Document Object Model）树。DOM树是一个树状结构，代表了HTML文档的结构。</p>
<ul>
<li><strong>输入</strong>：HTML字符串</li>
<li><strong>处理</strong>：解析HTML，构建DOM树</li>
<li><strong>输出</strong>：DOM树（内存中的结构）</li>
</ul>
<p>示例HTML文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>介绍<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>渲染流程<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>green<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>red<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>运行该文件，在浏览器中右键选择 检查 ，选择控制台，输入以下代码</p>
<pre><code class="hljs language-css" lang="css">document<span class="hljs-selector-class">.getElementsByTagName</span>('<span class="hljs-selector-tag">p</span>')<span class="hljs-selector-attr">[1]</span>
</code></pre>
<p>可以查询到DOM树的对应节点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54aab8848a8d42c096892bd1eb0776c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518977&amp;x-signature=o7Q0racwAz51OwUunQQL89GKJqE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>为什么需要DOM树？</strong></p>
<ul>
<li>浏览器无法直接处理HTML字符串</li>
<li>树状结构便于表示页面的层次关系</li>
<li>每个HTML标签具有特定语义（如header、footer、article），应根据内容含义正确选用</li>
</ul>
<h3 data-id="heading-4">2. 构建CSSOM树</h3>
<p>浏览器解析CSS字符串，构建CSSOM（CSS Object Model）树。</p>
<ul>
<li><strong>输入</strong>：CSS字符串</li>
<li><strong>处理</strong>：解析CSS，构建CSSOM树</li>
<li><strong>输出</strong>：CSSOM树</li>
</ul>
<p><strong>CSSOM树结构</strong>：</p>
<ul>
<li>每个CSS规则是一个节点</li>
<li>每个节点包含选择器和声明块</li>
<li>声明块包含属性和值</li>
</ul>
<h3 data-id="heading-5">3. 合并DOM和CSSOM，生成渲染树</h3>
<p>浏览器将DOM树和CSSOM树合并，生成渲染树（Render Tree）。</p>
<h3 data-id="heading-6">4. 布局（Layout）</h3>
<p>计算每个元素在页面上的位置和大小。</p>
<h3 data-id="heading-7">5. 绘制（Painting）</h3>
<p>将渲染树转换为屏幕上的像素，最终呈现页面。</p>
<hr/>
<h2 data-id="heading-8">三、写好HTML——正确使用语义化标签</h2>
<h3 data-id="heading-9">1. 什么是语义化标签？</h3>
<p>语义化标签是指具有明确含义的HTML标签，如<code>&lt;header&gt;</code>、<code>&lt;footer&gt;</code>、<code>&lt;article&gt;</code>、<code>&lt;section&gt;</code>等，而非仅使用<code>&lt;div&gt;</code>。</p>
<h3 data-id="heading-10">2. 语义化标签的作用</h3>
<ul>
<li><strong>提高代码可读性</strong>：让开发者更容易理解代码结构</li>
<li><strong>方便搜索引擎索引</strong>：提高SEO效果</li>
<li><strong>方便屏幕阅读器解析</strong>：提升无障碍访问体验</li>
</ul>
<h3 data-id="heading-11">3. SEO与语义化</h3>
<p>SEO（Search Engine Optimization，搜索引擎优化）是网站在搜索引擎中获得更好排名的关键。百度等搜索引擎会派出"蜘蛛"爬取网站，针对HTML进行算法分析，评估查询内容与网页的相关性。</p>
<p><strong>如何提高SEO？</strong></p>
<ul>
<li>使用正确的语义化标签</li>
<li>为内容提供清晰的结构</li>
<li>确保内容可被搜索引擎理解</li>
</ul>
<h3 data-id="heading-12">4. 常用语义化标签</h3>
<h4 data-id="heading-13">示例HTML代码</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>HTML5语义化标签--SEO<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  * {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
  }
  <span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f4f4f4</span>;
  }
  <span class="hljs-selector-tag">header</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">text-align</span>: center;
  }
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-comment">/* css 内置函数 */</span>
    <span class="hljs-attribute">min-height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span>-<span class="hljs-number">120px</span>);
  }
  <span class="hljs-selector-tag">main</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;<span class="hljs-comment">/*主内容区域 其它元素占完后，余下的都是主元素的*/</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1.5rem</span>;
  }
  <span class="hljs-selector-tag">aside</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">250px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ecf0f1</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1.5rem</span>;
  }
  <span class="hljs-selector-class">.aside-left</span> {
     <span class="hljs-attribute">order</span>: -<span class="hljs-number">1</span>;  <span class="hljs-comment">/* 左侧边栏先下载 */</span>
  }
  <span class="hljs-selector-class">.aside-right</span> {
    <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 右侧边栏后下载,因为-1比1小 */</span>
  }
  <span class="hljs-selector-tag">footer</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">margin-top</span>: auto;
  }
  <span class="hljs-comment">/* 媒体查询 设备的宽度 375px &lt; 480px */</span>
  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">flex-direction</span>: column;  <span class="hljs-comment">/* 主轴设置为垂直方向 */</span>
    }
    <span class="hljs-selector-class">.aside-left</span>{
      <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 左侧边栏后下载 */</span>
    }
    <span class="hljs-selector-class">.aside-right</span>{
      <span class="hljs-attribute">order</span>: <span class="hljs-number">2</span>;  <span class="hljs-comment">/* 右侧边栏后下载 */</span>
    }
    <span class="hljs-selector-tag">aside</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    }
  }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>HTML5语义化标签--Agiao的技术博客<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主要内容<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这里是页面的核心内容区域
          <span class="hljs-tag">&lt;<span class="hljs-name">code</span>&gt;</span><span class="hljs-symbol">&amp;lt;</span>main<span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">code</span>&gt;</span>
          和<span class="hljs-tag">&lt;<span class="hljs-name">code</span>&gt;</span><span class="hljs-symbol">&amp;lt;</span>section<span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">code</span>&gt;</span>
          标签表现结构清晰
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>HTML5的语义标签有助于SEO和无障碍访问<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
       
      <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aside-left"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>左侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>导航链接、目录和广告位<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>联系<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aside-right"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>右侧侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>相关文章、推荐内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-symbol">&amp;copy;</span>2025 Agiao. All rights reserved.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>页面显示如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a13102698b44e0e862e7fdcc8fee281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518977&amp;x-signature=xMbzPdA760QeVKe5U5Z%2FbAN8yg4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-14">结构语义化标签</h4>
<ul>
<li><code>header</code>：页面头部</li>
<li><code>footer</code>：页面底部</li>
<li><code>article</code>：独立文章内容</li>
<li><code>section</code>：文档中的章节</li>
<li><code>nav</code>：导航区域</li>
<li><code>aside</code>：侧边栏内容</li>
<li><code>main</code>：主要内容区域</li>
<li><code>figure</code>：图片或图表</li>
<li><code>figcaption</code>：图片描述</li>
</ul>
<h4 data-id="heading-15">功能语义化标签</h4>
<ul>
<li><code>button</code>：按钮</li>
<li><code>a</code>：链接</li>
<li><code>ul/ol/li</code>：列表</li>
<li><code>table</code>：表格</li>
<li><code>form</code>：表单</li>
<li><code>input</code>：输入框</li>
<li><code>textarea</code>：文本域</li>
<li><code>select</code>：选择框</li>
<li><code>option</code>：选项框</li>
</ul>
<hr/>
<h2 data-id="heading-16">四、布局优化技巧</h2>
<h3 data-id="heading-17">1. 语义化标签的布局顺序</h3>
<p>在页面结构中，应将<code>main</code>（主要内容）放在<code>aside</code>（侧边栏）之前：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">main</span>&gt;主要内容&lt;/<span class="hljs-selector-tag">main</span>&gt;
&lt;<span class="hljs-selector-tag">aside</span>&gt;侧边栏内容&lt;/<span class="hljs-selector-tag">aside</span>&gt;
</code></pre>
<p><strong>为什么？</strong></p>
<ul>
<li>主要内容先下载，侧边栏后下载</li>
<li>通过CSS Flexbox的 order 属性可以控制下载顺序：</li>
</ul>
<p><strong>order</strong> ：默认值为<code>0</code>，值越小排列越靠前，支持负数：<code>order: -1</code>比<code>order: 0</code>更靠前</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex;
}
<span class="hljs-selector-tag">main</span> {
  <span class="hljs-attribute">order</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 视觉上放在中间 */</span>
}
<span class="hljs-selector-class">.aside-left</span> {
  <span class="hljs-attribute">order</span>: -<span class="hljs-number">1</span>;  <span class="hljs-comment">/* 左侧边栏先下载 */</span>
}
<span class="hljs-selector-class">.aside-right</span> {
  <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 右侧边栏后下载,因为-1比1小 */</span>
}
</code></pre>
<h3 data-id="heading-18">2. CSS选择器优先级与性能优化</h3>
<p>CSS选择器的书写方式直接影响渲染性能，理解优先级机制对优化至关重要：</p>
<p><strong>优先级计算公式</strong>：<strong><code>内联样式(1000) &gt; ID(100) &gt; 类/属性/伪类(10) &gt; 元素(1)</code></strong></p>
<p><strong>关键原则</strong>：</p>
<ul>
<li><strong>从右向左匹配</strong>：浏览器解析选择器时从右向左，<code>.nav a</code>会先找所有<code>a</code>再筛选<code>.nav</code>内的</li>
<li><strong>越简单越快</strong>：<code>button.primary</code> 比 <code>div.main-content section.buttons button.primary</code> 快10倍以上</li>
<li><strong>避免通配符</strong>：<code>*</code>和<code>*::after</code>会强制浏览器检查每个元素</li>
</ul>
<p><strong>性能优化技巧</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/*  低效：过度嵌套 + 复杂结构 */</span>
<span class="hljs-selector-tag">body</span> <span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.main-content</span> <span class="hljs-selector-tag">ul</span><span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-class">.item</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.link</span><span class="hljs-selector-pseudo">:hover</span> { ... }

<span class="hljs-comment">/*  高效：扁平化 + 语义化类名 */</span>
<span class="hljs-selector-class">.sidebar-link</span><span class="hljs-selector-pseudo">:hover</span> { ... }

<span class="hljs-comment">/*  慎用：高优先级且难覆盖 */</span>
<span class="hljs-selector-id">#main</span> <span class="hljs-selector-class">.content</span> <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.important</span> { ... }

<span class="hljs-comment">/*  推荐：使用类名代替ID，保持低特异性 */</span>
<span class="hljs-selector-class">.main-content</span> <span class="hljs-selector-class">.highlight</span> { ... }
</code></pre>
<p><strong>重要提示</strong>：当必须覆盖样式时，优先增加选择器特异性而非使用 <strong><code>!important</code></strong>。特异性冲突是CSS维护中最常见的问题，保持选择器"扁平化"（1-3层）能显著提升渲染性能和代码可维护性。</p>
<h3 data-id="heading-19">3. 语义化标签与SEO</h3>
<p>从上传的文件2.html中可以看出，"HTML5的语义标签有助于SEO和无障碍访问"。使用正确的语义化标签，可以让搜索引擎更好地理解页面内容，从而提高搜索排名。</p>
<h3 data-id="heading-20">4. 移动端布局修改</h3>
<p>如果按照源代码，该布局在移动端显示时，内容紧凑无法突出重点，如图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e79833af87294af49955b954671619f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518977&amp;x-signature=ukcXifL%2FoISeoSFhZnC1iRtyPM8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>可以利用弹性布局的属性，在Style中添加以下代码：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*  针对宽度 ≤768px 的设备（平板及手机） */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">flex-direction</span>: column;  <span class="hljs-comment">/* 主轴设置为垂直方向，将水平布局转为垂直堆叠 */</span>
  }
  <span class="hljs-selector-class">.aside-left</span> {
    <span class="hljs-attribute">order</span>: -<span class="hljs-number">1</span>;  <span class="hljs-comment">/* 视觉排序，非下载顺序！ */</span>
  }
  <span class="hljs-selector-class">.aside-right</span> {
    <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 视觉排序，非下载顺序！ */</span>
  }
}
</code></pre>
<p><strong>关键概念解析</strong></p>
<p><strong>媒体查询条件</strong></p>
<ul>
<li><strong>实际生效条件</strong>：屏幕宽度≤768px（平板/手机）</li>
</ul>
<p><strong>Flexbox布局转换</strong></p>
<ul>
<li><code>flex-direction: column</code> 将主轴从<strong>水平</strong>变为<strong>垂直</strong></li>
<li>在小屏幕上，内容从并排显示变为<strong>自上而下堆叠</strong></li>
<li>解决小屏幕空间不足的问题</li>
</ul>
<p><strong>order属性的真相</strong></p>
<ul>
<li>
<p><strong>仅改变视觉顺序</strong>，不影响：</p>
<ul>
<li>资源下载顺序</li>
<li>DOM结构顺序</li>
<li>屏幕阅读器读取顺序</li>
<li>SEO权重分配</li>
</ul>
</li>
</ul>
<p> 修改后显示页面如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57cbf3681760451996fa49e0dc11e6f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518977&amp;x-signature=lRlDxfJfyCgvHNm1Tcv7YKsl1zI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-21">五、性能优化</h2>
<h3 data-id="heading-22">1. 渲染流程的性能考量</h3>
<p>渲染过程是浏览器的"重头戏"，流程复杂且时间开销较大。优化渲染性能可以从以下几个方面入手：</p>
<ul>
<li>减少DOM节点数量</li>
<li>避免复杂的CSS选择器</li>
<li>减少重排（reflow）和重绘（repaint）</li>
<li>合理使用CSS动画</li>
</ul>
<h3 data-id="heading-23">2. 语义化与性能</h3>
<p>语义化标签不仅对SEO有益，也能提升页面加载性能。通过正确的标签使用，浏览器可以更快地构建DOM树，减少解析时间。</p>
<hr/>
<h2 data-id="heading-24">六、结语</h2>
<p>HTML/CSS/JS的渲染流程是浏览器工作的核心。理解这个流程，特别是DOM树和CSSOM树的构建，对于编写高效、可维护的前端代码至关重要。语义化HTML不仅让代码更清晰、更易于维护，还能提升SEO效果和无障碍访问体验。</p>
<p>记住：<strong>正确使用语义化标签，是构建现代、高性能、可访问网页的第一步</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VonaJS: 直观好用的分布式锁]]></title>    <link>https://juejin.cn/post/7571379089991335990</link>    <guid>https://juejin.cn/post/7571379089991335990</guid>    <pubDate>2025-11-12T02:29:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991335990" data-draft-id="7571378103281516550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VonaJS: 直观好用的分布式锁"/> <meta itemprop="keywords" content="Node.js,TypeScript,NestJS"/> <meta itemprop="datePublished" content="2025-11-12T02:29:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="濮水大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1119781972622208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VonaJS: 直观好用的分布式锁
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1119781972622208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    濮水大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:29:24.000Z" title="Wed Nov 12 2025 02:29:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式锁</h2>
<p>VonaJS 基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsesamecare%2Fredlock%2F" target="_blank" title="https://github.com/sesamecare/redlock/" ref="nofollow noopener noreferrer">Redlock</a>提供了直观、易用的分布式锁</p>
<h3 data-id="heading-1">创建分布式锁</h3>
<p>比如，在模块 demo-student 中创建分布式锁</p>
<h4 data-id="heading-2">1. Cli命令</h4>
<pre><code class="hljs language-bash" lang="bash">$ vona :create:bean meta redlock --module=demo-student
</code></pre>
<h4 data-id="heading-3">2. 菜单命令</h4>
<pre><code class="hljs language-bash" lang="bash">右键菜单 - [模块路径]: `Vona Meta/Redlock`
</code></pre>
<h3 data-id="heading-4">分布式锁定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypeRedlockLockResource</span> = <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypeRedlockLockIsolateResource</span> = <span class="hljs-built_in">never</span>;

<span class="hljs-meta">@Meta</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaRedlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BeanRedlockBase</span>&lt;<span class="hljs-title class_">TypeRedlockLockResource</span>, <span class="hljs-title class_">TypeRedlockLockIsolateResource</span>&gt; {}
</code></pre>
<ul>
<li><code>TypeRedlockLockResource</code>: 定义<code>lock</code>方法使用的锁资源</li>
<li><code>TypeRedlockLockIsolateResource</code>: 定义<code>lockIsolate</code>方法使用的锁资源</li>
</ul>
<h3 data-id="heading-5">定义锁资源</h3>
<p>当我们使用分布式锁时，需要指定对应的锁资源。比如，为<code>lock</code>方法定义锁资源<code>name</code>:</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- export type TypeRedlockLockResource = never;</span>
<span class="hljs-addition">+ export type TypeRedlockLockResource = 'name';</span>
</code></pre>
<h3 data-id="heading-6">使用分布式锁</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">redlock</span>.<span class="hljs-title function_">lock</span>(<span class="hljs-string">'name'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// do something in lock</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'some result'</span>;
    });
  }
}  
</code></pre>
<ul>
<li><code>redlock.lock</code>：传入锁资源<code>name</code></li>
</ul>
<h3 data-id="heading-7"><code>lock/lockIsolate</code></h3>
<p>VonaJS 提供了两个锁方法: <code>lock/lockIsolate</code>。二者的区别是：<code>lockIsolate</code>自动实现了<code>数据源分级</code>，从而避免因数据源竞争而导致的死锁情况</p>
<ul>
<li>参见: <a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org%2Fzh%2Fguide%2Fdistributed%2Fqueue%2Fdb-level.html" target="_blank" title="https://vona.js.org/zh/guide/distributed/queue/db-level.html" ref="nofollow noopener noreferrer">数据源分级</a></li>
</ul>
<h4 data-id="heading-8">定义锁资源: lockIsolate</h4>
<p>为<code>lockIsolate</code>方法定义锁资源:</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- export type TypeRedlockLockIsolateResource = never;</span>
<span class="hljs-addition">+ export type TypeRedlockLockIsolateResource = 'name';</span>
</code></pre>
<h4 data-id="heading-9">使用分布式锁: lockIsolate</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">redlock</span>.<span class="hljs-title function_">lockIsolate</span>(<span class="hljs-string">'name'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// do something in lock</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'some result'</span>;
    });
  }
}  
</code></pre>
<h3 data-id="heading-10">定义锁资源: 字面量模版</h3>
<p>锁资源还可以是<code>字面量模版</code></p>
<p>比如，如果要为不同的用户单独提供锁资源，那么可以使用形如<code>user-${userId}</code>的字符串，作为锁资源名称</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- export type TypeRedlockLockIsolateResource = 'name';</span>
<span class="hljs-addition">+ export type TypeRedlockLockIsolateResource = 'name' | `user-${string}`;</span>
</code></pre>
<p>这样，在使用<code>lockIsolate</code>方法时同样可以提供类型提示</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> userId = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">redlock</span>.<span class="hljs-title function_">lockIsolate</span>(<span class="hljs-string">`user-<span class="hljs-subst">${userId}</span>`</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// do something in lock</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'some result'</span>;
    });
  }
}  
</code></pre>
<h3 data-id="heading-11">查看当前生效的分布式锁清单</h3>
<p>可以直接输出当前生效的分布式锁清单</p>
<pre><code class="hljs language-diff" lang="diff">class ControllerStudent {
  @Web.get('test')
  test() {
<span class="hljs-addition">+   this.bean.onion.meta.inspectMeta('redlock');</span>
  }
}
</code></pre>
<ul>
<li><code>this.bean.onion</code>: 取得全局 Service 实例 <code>onion</code></li>
<li><code>.meta</code>: 取得与 meta 相关的 Service 实例</li>
<li><code>.inspectMeta</code>: 输出当前生效的分布式锁清单</li>
</ul>
<p>当访问<code>test</code> API 时，会自动在控制台输出当前生效的分布式锁清单，效果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaf3a61f69054411a42ff5bb37067108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r-u5rC05aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519364&amp;x-signature=%2BDlsMnJgL6lM319QWxug6lh9rQs%3D" alt="请添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">资源</h3>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvonajs%2Fvona" target="_blank" title="https://github.com/vonajs/vona" ref="nofollow noopener noreferrer">github.com/vonajs/vona</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org%2F" target="_blank" title="https://vona.js.org/" ref="nofollow noopener noreferrer">vona.js.org/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI-WebView 全面指南]]></title>    <link>https://juejin.cn/post/7571379089991385142</link>    <guid>https://juejin.cn/post/7571379089991385142</guid>    <pubDate>2025-11-12T02:38:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991385142" data-draft-id="7571348736153616420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI-WebView 全面指南"/> <meta itemprop="keywords" content="iOS,SwiftUI"/> <meta itemprop="datePublished" content="2025-11-12T02:38:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YungFan"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006567000"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI-WebView 全面指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006567000/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YungFan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:38:29.000Z" title="Wed Nov 12 2025 02:38:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<p>在 iOS 开发中，网页内容展示几乎是每个 App 的刚需场景。无论是展示帮助中心、隐私政策，还是嵌入在线课程、文档预览等，WebView 都扮演着重要角色。SwiftUI 7.0 通过 WebKit 模块，可以轻松实现网页加载、导航控制以及 JavaScript 交互功能。本文将从基础到高级，循序渐进介绍 SwiftUI 中的 WebView 用法。</p>
<h2 data-id="heading-1">网页加载</h2>
<ul>
<li>在使用 WebView 前，需要先导入 WebKit 模块。</li>
<li>借助 URL 或者 WebPage，可以实现网页加载与状态管理功能。</li>
</ul>
<h3 data-id="heading-2">直接加载URL</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> WebKit

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://www.apple.com.cn"</span>)<span class="hljs-operator">!</span>

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">WebView</span>(url: url)
    }
}
</code></pre>
<h3 data-id="heading-3">使用WebPage</h3>
<p>WebPage 是一个功能更强的类型，它不仅能加载网页，还能实时监控网页的标题、加载进度、URL 状态等信息。</p>
<h4 data-id="heading-4">基本用法</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> WebKit

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webPage <span class="hljs-operator">=</span> <span class="hljs-type">WebPage</span>()
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://www.apple.com.cn"</span>)<span class="hljs-operator">!</span>

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">WebView</span>(webPage)
            .ignoresSafeArea()
            .onAppear {
                webPage.load(<span class="hljs-type">URLRequest</span>(url: url))
            }
    }
}
</code></pre>
<h4 data-id="heading-5">内容控制</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> WebKit

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webPage <span class="hljs-operator">=</span> <span class="hljs-type">WebPage</span>()
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://www.apple.com.cn"</span>)<span class="hljs-operator">!</span>

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-comment">// 标题</span>
            <span class="hljs-type">Text</span>(webPage.title)
            <span class="hljs-comment">// 进度</span>
            <span class="hljs-type">ProgressView</span>(<span class="hljs-string">""</span>, value: webPage.estimatedProgress, total: <span class="hljs-number">1.0</span>)
            <span class="hljs-comment">// 内容</span>
            <span class="hljs-type">WebView</span>(webPage)
                .ignoresSafeArea()
                .onAppear {
                    webPage.load(<span class="hljs-type">URLRequest</span>(url: url))
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-6">高级控制</h2>
<h3 data-id="heading-7">导航策略</h3>
<p>如果需要在网页跳转时进行判断（例如拦截某些 URL、仅允许访问特定域名），可以自定义导航策略。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> WebKit

<span class="hljs-comment">// 导航处理方式</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">NavigationDecider</span>: <span class="hljs-title class_">WebPage</span>.<span class="hljs-title class_">NavigationDeciding</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">decidePolicy</span>(<span class="hljs-params">for</span> <span class="hljs-params">response</span>: <span class="hljs-type">WebPage</span>.<span class="hljs-type">NavigationResponse</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">WKNavigationResponsePolicy</span> {
        <span class="hljs-keyword">if</span> response.response.url<span class="hljs-operator">?</span>.absoluteString.starts(with: <span class="hljs-string">"https://www.apple.com"</span>) <span class="hljs-operator">==</span> <span class="hljs-literal">true</span> {
            .allow
        } <span class="hljs-keyword">else</span> {
            .cancel
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webPage: <span class="hljs-type">WebPage</span> <span class="hljs-operator">=</span> {
        <span class="hljs-keyword">var</span> config <span class="hljs-operator">=</span> <span class="hljs-type">WebPage</span>.<span class="hljs-type">Configuration</span>()
        config.applicationNameForUserAgent <span class="hljs-operator">=</span> <span class="hljs-string">"User Agent"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-type">WebPage</span>(configuration: config, navigationDecider: <span class="hljs-type">NavigationDecider</span>())
    }()
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://www.baidu.com"</span>)<span class="hljs-operator">!</span>

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(webPage.title)
            
            <span class="hljs-type">ProgressView</span>(<span class="hljs-string">""</span>, value: webPage.estimatedProgress, total: <span class="hljs-number">1.0</span>)

            <span class="hljs-type">WebView</span>(webPage)
                .ignoresSafeArea()
                .onAppear {
                    webPage.load(<span class="hljs-type">URLRequest</span>(url: url))
                }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">JavaScript 交互</h3>
<p>许多场景需要与网页内部的 JavaScript 进行交互，如调用函数、获取返回值等。SwiftUI 也提供了非常方便的异步调用方式。</p>
<h4 data-id="heading-9">代码</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> WebKit

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webPage <span class="hljs-operator">=</span> <span class="hljs-type">WebPage</span>()
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> title <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://www.apple.com.cn"</span>)<span class="hljs-operator">!</span>

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            title.isEmpty <span class="hljs-operator">?</span> <span class="hljs-type">Text</span>(webPage.title) : <span class="hljs-type">Text</span>(title)

            <span class="hljs-type">ProgressView</span>(<span class="hljs-string">""</span>, value: webPage.estimatedProgress, total: <span class="hljs-number">1.0</span>)

            <span class="hljs-type">WebView</span>(webPage)
                .ignoresSafeArea()
                .onAppear {
                    webPage.load(<span class="hljs-type">URLRequest</span>(url: url))
                }
                .task {
                    <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">3</span>), clock: .suspending)
                    <span class="hljs-keyword">let</span> jsResult <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> webPage.callJavaScript(
                        <span class="hljs-string">"""
                        console.log("Hello SwiftUI")
                        return "JavaScript Returned Value"
                        """</span>
                    )
                    title <span class="hljs-operator">=</span> jsResult <span class="hljs-keyword">as!</span> <span class="hljs-type">String</span>
                }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4e4680b677c425fa8ea5588ddbc52d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWXVuZ0Zhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763519909&amp;x-signature=k%2FJwN1d%2BJuHhdCxJQQhW1cZ90Rc%3D" alt="效果.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[更新！Figma MCP + Cursor：大前端时代的UI到代码自动化]]></title>    <link>https://juejin.cn/post/7571299394346303530</link>    <guid>https://juejin.cn/post/7571299394346303530</guid>    <pubDate>2025-11-12T01:10:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394346303530" data-draft-id="7570984341414969359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="更新！Figma MCP + Cursor：大前端时代的UI到代码自动化"/> <meta itemprop="keywords" content="Android,前端,AI编程"/> <meta itemprop="datePublished" content="2025-11-12T01:10:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="付十一"/> <meta itemprop="url" content="https://juejin.cn/user/1556564197255975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            更新！Figma MCP + Cursor：大前端时代的UI到代码自动化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564197255975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    付十一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:10:41.000Z" title="Wed Nov 12 2025 01:10:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c10ff6dcb42e46f980c358cdf50fcb70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=oT6LuaRehwBiLD6ulm9yQLYwEbE%3D" alt="image.png" loading="lazy"/>
Figma官方在9月份推出<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.figma.com%2Fmcp-catalog%2F" target="_blank" title="https://www.figma.com/mcp-catalog/" ref="nofollow noopener noreferrer">MCP服务</a>，在此之前，还需要使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgrab%2Fcursor-talk-to-figma-mcp" target="_blank" title="https://github.com/grab/cursor-talk-to-figma-mcp" ref="nofollow noopener noreferrer">cursor-talk-to-figma-mcp</a>进行连接，流程比较繁琐，这次Figma的更新无疑提高了连接效率和UI生成准确率。</p>
<p><strong>核心价值：Figma MCP 能解决什么实际问题？</strong></p>
<p>一句话：</p>
<p><strong>通过 MCP 直接读取 Figma 文件的结构化设计数据，结合 Cursor 的代码智能，实现多平台 UI 代码的自动生成，包括 Android XML、iOS SwiftUI、H5、RN 等。</strong></p>
<p><strong>具体解决的痛点：</strong></p>
<ol>
<li><strong>消除设计到代码的信息偏差</strong> - 直接获取精确的设计数据</li>
<li><strong>大幅减少重复劳动</strong> - 自动化生成基础 UI 代码</li>
<li><strong>提升跨平台一致性</strong> - 同一设计源生成多平台代码</li>
<li><strong>加速开发迭代</strong> - 从设计到可用代码仅需几分钟</li>
</ol>
<h2 data-id="heading-0">一、实战指南：Cursor + Figma MCP 连接流程</h2>
<h3 data-id="heading-1">1. 1、连接流程</h3>
<ol>
<li>进入Figma官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.figma.com%2Fmcp-catalog%2F" target="_blank" title="https://www.figma.com/mcp-catalog/" ref="nofollow noopener noreferrer">MCP服务</a> 点击Cursor中“Add MCP to Cursor”，会跳转到Cursor客户端。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c25eb5ad3248b3b65e99099f64eff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=23PvWrDAjxq%2FILdcVk%2FI%2Fa1kZ3Y%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>点击 <strong>Install</strong> </li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8169401b4ea446539a8fa61fa03b64e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=VJATUe%2BYVLgrDjk9Md6l3vMPVQ0%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li>点击 <strong>Connect</strong> 再开始身份验证过程。</li>
<li>点击 <strong>Open</strong>. 
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/264013dcf6d2478f9ccf092966230e2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=gdJ%2BOjjtdv0rJXtGzSeL7kifqwU%3D" alt="Cursor MCP open dialog" loading="lazy"/></li>
<li><strong>Allow access</strong> </li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb2589e704e64044b5f953a4e5ea7301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=WD15BgVqRtKIfWvahLx3JCI%2FWxc%3D" alt="Cursor allow access dialog" width="70%" loading="lazy"/>
<h3 data-id="heading-2">1.2、开始使用MCP服务</h3>
<ol>
<li>打开Figma客户端以及切换到DEV MODE，选择图层 copy link to selection</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6927cea2e87f485081cdb6177080eb9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=KkxL8MatiwG3SS0rBn%2B8JBGDw%2F8%3D" alt="image.png" width="70%" loading="lazy"/>
<ol start="2">
<li>将复制的链接粘贴到Cursor，让Cursor生成相应代码</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4735fcdbd72405790b81038f3cab695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=tfEH2lyXc7ghTGZg3KiD0rl7KbI%3D" alt="image.png" width="70%" loading="lazy"/>
<h3 data-id="heading-3">1.3、效果对比</h3>













<table><thead><tr><th>设计稿图</th><th>AI生成效果图（第1版）</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82b1af3518de4c09985d36f8d63b31e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=6WFqeByXPDoQVd%2BRH9iFaKaKBG0%3D" alt="image.png" width="100%" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38798f32175a4dffa79b75439945a18a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=pr01rx7G9axhJJb%2BEpTl0b9l98Y%3D" alt="image.png" width="90%" loading="lazy"/></td></tr></tbody></table>
<p>由于目前Cursor+Figma还无法自动下载本地资源图片，第一版的UI图像缺失，但整体看80%的组件和设计稿一致，接下来我将人工下载图片并且植入</p>













<table><thead><tr><th>设计稿图</th><th>AI生成效果图（第2版）</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82b1af3518de4c09985d36f8d63b31e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=6WFqeByXPDoQVd%2BRH9iFaKaKBG0%3D" alt="image.png" width="100%" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a064376050854cfe94c51a4803d5441e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuY5Y2B5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514640&amp;x-signature=rhCLZ2IMEkIgjxwsfVUp%2FLa78hY%3D" alt="image.png" width="85%" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-4">1.4、小结</h3>
<p><strong>已实现</strong></p>
<ol>
<li><strong>连接流程标准化</strong> - 官方集成让设置变得简单可靠</li>
<li><strong>设计数据精准获取</strong> - 能够准确读取尺寸、颜色、字体、间距等核心样式属性</li>
<li><strong>多平台代码生成</strong> - 支持生成符合各平台规范的 UI 代码</li>
<li><strong>组件结构还原</strong> - 能够正确理解并重建设计中的组件层次关系</li>
</ol>
<p><strong>现有局限性</strong></p>
<ol>
<li><strong>图片资源处理</strong> - 仍需手动下载并替换图片资源</li>
<li><strong>复杂交互逻辑</strong> - 主要生成静态 UI，复杂交互需要额外开发</li>
</ol>
<h2 data-id="heading-5">二、问题</h2>
<p>从读取 Figma 到生成 Android UI 代码，Cursor 总耗时不到 1 分钟，视觉还原度接近 90%，这无疑大幅提升了开发效率。但在实际企业项目中应用时，仍会发现一些需要优化的关键问题：</p>
<ol>
<li>
<p><strong>企业组件库适配问题</strong><br/>
公司项目通常基于自研 UI 组件库开发，而 AI 默认生成的是系统原生组件，导致生成的代码无法直接集成</p>
</li>
<li>
<p><strong>布局识别精度不足</strong><br/>
设计稿中的列表结构（RecyclerView）常被误判为平铺的静态 View，缺乏对动态内容的智能识别</p>
</li>
</ol>
<p>上述问题的本质在于缺乏对 AI 生成过程的约束与引导。解决方案的核心在于制定精准的<strong>Cursor Rules</strong>，比如Figma图层名包含“item_”“list_”这类前缀。Rules可以植入这种判断逻辑，强制生成RecyclerView和Adapter模板，而不是傻乎乎罗列View。通过规则体系来规范化代码输出，确保生成结果符合企业级项目的技术要求。</p>
<p>通过系统化的规则配置，我们能够将企业的开发规范、组件库标准固化到AI生成过程中，从而实现从"可用"到"好用"的质变。</p>
<p><strong>引用</strong></p>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.figma.com%2Fmcp-catalog%2F" target="_blank" title="https://www.figma.com/mcp-catalog/" ref="nofollow noopener noreferrer">www.figma.com/mcp-catalog…</a></em></p>
<p>招人：
得物组内缺 Android和iOS，急招，内推可联系我</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践]]></title>    <link>https://juejin.cn/post/7571379089991483446</link>    <guid>https://juejin.cn/post/7571379089991483446</guid>    <pubDate>2025-11-12T02:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991483446" data-draft-id="7571334572769771563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践"/> <meta itemprop="keywords" content="前端,HTML,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T02:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:49:48.000Z" title="Wed Nov 12 2025 02:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握HTML常用属性与全局属性的语义与行为，理解布尔/枚举属性的差异、跨源与安全相关属性的正确配置，并形成可落地的兼容性与可访问性最佳实践</p>
<p>📊 <strong>难度等级</strong>：初级-中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#属性</code> <code>#全局属性</code> <code>#布尔属性</code> <code>#data-*</code> <code>#ARIA</code> <code>#兼容性</code><br/>
⏱️ <strong>阅读时间</strong>：约9分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🌟 引言</h2>
<p>HTML 的属性（attribute）决定了元素的语义、行为和表现。看似简单的 <code>disabled</code>、<code>contenteditable</code>、<code>hidden</code> 或 <code>data-*</code>，在不同的上下文与浏览器实现中却有不少差异：布尔属性是否需要写值？枚举属性有哪些合法取值？<code>crossorigin</code> 与 <code>integrity</code> 如何协同保障资源安全？这些问题若处理不当，会带来可访问性、性能甚至安全风险。</p>
<p>在日常的前端开发中，你是否遇到过这样的困扰：</p>
<ul>
<li>布尔属性写成 <code>disabled="false"</code> 仍然生效，导致交互异常；</li>
<li>滥用 <code>contenteditable</code> 造成键盘可访问性退化；</li>
<li>外链脚本未配置 SRI 与 CORS，被安全策略拦截或错误不透明；</li>
<li>图片懒加载与解码策略混用，出现首屏闪烁与布局抖动；</li>
</ul>
<p>今天分享 7 个「属性行为与最佳实践」核心技巧，帮你在开发中少踩坑、写出更稳妥的页面。</p>
<hr/>
<h2 data-id="heading-1">💡 核心技巧详解</h2>
<blockquote>
<p>📝 使用说明：本文选择 7 个最常用、最易混淆的属性主题进行讲解，每节均含场景、常见误区、推荐方案与要点。</p>
</blockquote>
<h3 data-id="heading-2">1. 全局属性速查：语义清晰、行为可控</h3>
<h4 data-id="heading-3">🔍 应用场景</h4>
<p>需要为元素添加标识与语义、调整方向与可编辑性、控制显示与拖拽能力等通用行为。</p>
<p>常见的全局属性包括：<code>id</code>、<code>class</code>、<code>title</code>、<code>lang</code>、<code>dir</code>、<code>hidden</code>、<code>draggable</code>、<code>contenteditable</code>。</p>
<h4 data-id="heading-4">❌ 常见问题</h4>
<ul>
<li>滥用 <code>id</code> 导致页面内唯一性被破坏；</li>
<li><code>dir</code>/<code>lang</code> 未设置，RTL/LTR 文本方向或语言识别错误；</li>
<li>非必要场景启用 <code>contenteditable</code>，可访问性与输入法体验变差；</li>
<li>用 <code>hidden</code> 替代逻辑卸载，产生无意义的可聚焦元素。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：任意启用 contenteditable 与隐身元素可聚焦问题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑卡片"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：仅在明确编辑场景启用 contenteditable；按需设置语言与方向 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"profile"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"ltr"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"用户资料"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__title"</span>&gt;</span>资料<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__desc"</span>&gt;</span>可编辑区域仅限下面的备注。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑备注"</span>&gt;</span>在此添加备注...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 安全启用/关闭可编辑区域
 * <span class="hljs-doctag">@description</span> 根据布尔开关控制元素的 contenteditable 与可聚焦性
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">enable</span> - 是否启用可编辑
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleEditable</span> = (<span class="hljs-params">el, enable</span>) =&gt; {
  <span class="hljs-comment">// 仅在需要时才启用，避免全局滥用</span>
  el.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'contenteditable'</span>, enable ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>);
  el.<span class="hljs-property">tabIndex</span> = enable ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; <span class="hljs-comment">// 控制键盘可访问性</span>
};
</code></pre>
<h4 data-id="heading-6">💡 核心要点</h4>
<ul>
<li><code>id</code> 必须全页面唯一；</li>
<li>为文档或区域设置正确的 <code>lang</code> 与 <code>dir</code>；</li>
<li><code>hidden</code> 会将元素从可访问性树中移除（但仍在 DOM），用于暂时隐藏而非卸载；</li>
<li><code>contenteditable</code> 仅用于编辑场景，注意键盘与焦点管理。</li>
</ul>
<h4 data-id="heading-7">🎯 实际应用</h4>
<p>在富文本组件中，仅对编辑容器启用 <code>contenteditable</code>，同时结合 <code>aria-label</code> 与键盘导航提示改善可访问性。</p>
<hr/>
<h3 data-id="heading-8">2. 布尔属性行为：存在即为真，值会被忽略</h3>
<h4 data-id="heading-9">🔍 应用场景</h4>
<p>控制交互状态，如禁用、自动聚焦、必填、隐藏等：<code>disabled</code>、<code>autofocus</code>、<code>required</code>、<code>hidden</code>、<code>checked</code>。</p>
<h4 data-id="heading-10">❌ 常见问题</h4>
<ul>
<li>写成 <code>disabled="false"</code> 仍然是禁用；</li>
<li>将布尔属性赋为字符串，误以为可关闭行为；</li>
<li>误用 <code>autofocus</code> 影响无障碍体验（页面初始焦点跳跃）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：disabled="false" 仍然禁用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">"false"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：通过属性存在性表达布尔含义；JS 控制用 property 更直观 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitBtn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 切换布尔属性：存在即为真
 * <span class="hljs-doctag">@description</span> 使用 property 控制更直观，避免字符串赋值歧义
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLButtonElement</span>} <span class="hljs-variable">btn</span> - 目标按钮
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">disabled</span> - 是否禁用
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setDisabled</span> = (<span class="hljs-params">btn, disabled</span>) =&gt; {
  btn.<span class="hljs-property">disabled</span> = disabled; <span class="hljs-comment">// 使用 property 代替 setAttribute('disabled', 'false')</span>
};

<span class="hljs-comment">/**
 * 初始化页面焦点
 * <span class="hljs-doctag">@description</span> 谨慎使用 autofocus，优先在脚本中设定初始焦点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">target</span> - 需要获得焦点的元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initFocus</span> = (<span class="hljs-params">target</span>) =&gt; {
  target.<span class="hljs-title function_">focus</span>(); <span class="hljs-comment">// 统一在脚本中管理初始焦点</span>
};
</code></pre>
<h4 data-id="heading-12">💡 核心要点</h4>
<ul>
<li>布尔属性仅凭「存在」即可生效，属性值通常被忽略；</li>
<li>在 JS 中优先使用 property（如 <code>el.disabled = true</code>），更直观也更兼容；</li>
<li>避免在初始加载阶段使用 <code>autofocus</code> 影响读屏与键盘用户。</li>
</ul>
<h4 data-id="heading-13">🎯 实际应用</h4>
<p>表单组件库中统一封装 <code>disabled</code> 控制逻辑，所有按钮与输入框采用 property 控制，避免属性字符串误用。</p>
<hr/>
<h3 data-id="heading-14">3. 枚举属性：合法取值与默认行为</h3>
<h4 data-id="heading-15">🔍 应用场景</h4>
<p>控制策略选择或行为方式：<code>loading</code>（img：<code>auto</code>/<code>lazy</code>/<code>eager</code>）、<code>decoding</code>（img：<code>sync</code>/<code>async</code>/<code>auto</code>）、<code>crossorigin</code>（<code>anonymous</code>/<code>use-credentials</code>）、<code>autocomplete</code>（多枚举值）。</p>
<h4 data-id="heading-16">❌ 常见问题</h4>
<ul>
<li>写入不合法取值被忽略，导致行为回退到默认；</li>
<li>不了解默认值，造成性能或兼容性问题（如图片解码抖动）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：不合法取值将被忽略，退回默认行为 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"fast"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"quick"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-17">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 合法取值：lazy 与 async 可配合减少首屏抖动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"async"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 规范化枚举属性取值
 * <span class="hljs-doctag">@description</span> 保证属性在合法集合内，否则回退到安全默认
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">name</span> - 枚举属性名
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">allowed</span> - 合法取值集合
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">value</span> - 待设置的值
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setEnumAttr</span> = (<span class="hljs-params">el, name, allowed, value</span>) =&gt; {
  <span class="hljs-keyword">const</span> v = allowed.<span class="hljs-title function_">includes</span>(value) ? value : allowed[<span class="hljs-number">0</span>];
  el.<span class="hljs-title function_">setAttribute</span>(name, v);
};
</code></pre>
<h4 data-id="heading-18">💡 核心要点</h4>
<ul>
<li>明确每个枚举属性的合法取值集合与默认值；</li>
<li>图片建议 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少阻塞与抖动；</li>
<li>跨源枚举值仅限 <code>anonymous</code> 与 <code>use-credentials</code>，影响资源请求与错误可见性。</li>
</ul>
<h4 data-id="heading-19">🎯 实际应用</h4>
<p>资源管理组件统一通过枚举校验函数设置 <code>loading</code>/<code>decoding</code>，确保配置合法与表现稳定。</p>
<hr/>
<h3 data-id="heading-20">4. 数据属性 data-* 与 dataset：结构化携带业务数据</h3>
<h4 data-id="heading-21">🔍 应用场景</h4>
<p>在不污染语义的前提下，为元素附加结构化元数据，配合脚本读取与更新。</p>
<h4 data-id="heading-22">❌ 常见问题</h4>
<ul>
<li>将业务状态塞进 <code>class</code>/<code>id</code>，难以维护；</li>
<li>用 <code>innerHTML</code> 拼字符串读取数据，易遭XSS风险。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：用 class/id 存业务状态，耦合样式与脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"order_1234"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-23">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：使用 data-* 描述元数据，脚本通过 dataset 读取/更新 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderBtn"</span> <span class="hljs-attr">data-order-id</span>=<span class="hljs-string">"1234"</span> <span class="hljs-attr">data-state</span>=<span class="hljs-string">"processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 读取并更新 dataset
 * <span class="hljs-doctag">@description</span> 通过 dataset 读取/写入 data-*，保持结构化与安全
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">{orderId:string,state:string</span>}}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useDataset</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> { orderId, state } = el.<span class="hljs-property">dataset</span>;
  <span class="hljs-comment">// 更新状态为已完成</span>
  el.<span class="hljs-property">dataset</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'done'</span>;
  <span class="hljs-keyword">return</span> { orderId, state };
};
</code></pre>
<h4 data-id="heading-24">💡 核心要点</h4>
<ul>
<li><code>data-*</code> 值始终是字符串；复杂数据请用 JSON 并在脚本中解析；</li>
<li>读取使用 <code>el.dataset.xxx</code>（自动将 <code>data-xxx</code> 转驼峰）；</li>
<li>避免将视觉样式与业务状态耦合在 <code>class</code>/<code>id</code>。</li>
</ul>
<h4 data-id="heading-25">🎯 实际应用</h4>
<p>在列表项中用 <code>data-id</code>/<code>data-type</code> 附加元数据，事件委托时通过 <code>dataset</code> 精确识别目标项。</p>
<hr/>
<h3 data-id="heading-26">5. 表单属性最佳实践：可用性与安全</h3>
<h4 data-id="heading-27">🔍 应用场景</h4>
<p>文件选择与拍照、自动完成功能、输入合法性：<code>accept</code>、<code>capture</code>、<code>autocomplete</code>、<code>required</code> 等。</p>
<h4 data-id="heading-28">❌ 常见问题</h4>
<ul>
<li><code>accept</code> 写错 MIME/扩展名，导致系统选择器无法过滤；</li>
<li><code>capture</code> 盲目开启，移动端直接拉起摄像头影响体验；</li>
<li><code>autocomplete</code> 未按枚举值配置，自动填充失败或扰民。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：accept 写错扩展名或缺少 MIME --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpg"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-29">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：精确的 MIME 或扩展名；按需配置 capture 与 autocomplete --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpeg,image/png"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cameraInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span> <span class="hljs-attr">capture</span>=<span class="hljs-string">"environment"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验文件选择类型
 * <span class="hljs-doctag">@description</span> 检查文件扩展名是否符合 accept 策略
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 用户选择的文件
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否通过校验
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateFileType</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">const</span> ok = <span class="hljs-regexp">/(jpe?g|png)$/i</span>.<span class="hljs-title function_">test</span>(file.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-30">💡 核心要点</h4>
<ul>
<li><code>accept</code> 建议使用 MIME 类型（更通用）+ 扩展名兜底；</li>
<li>移动端谨慎使用 <code>capture</code>，为用户保留从相册选择的路径；</li>
<li><code>autocomplete</code> 使用标准枚举取值提升可用性与安全（如 <code>email</code>、<code>username</code>、<code>current-password</code>）。</li>
</ul>
<h4 data-id="heading-31">🎯 实际应用</h4>
<p>上传组件在客户端先做轻量类型校验，失败时不触发网络请求，减少后端压力与无效流量。</p>
<hr/>
<h3 data-id="heading-32">6. 跨源与安全属性：<code>crossorigin</code>、<code>integrity</code>、<code>referrerpolicy</code></h3>
<h4 data-id="heading-33">🔍 应用场景</h4>
<p>外链脚本/样式/图片资源的安全与错误透明化，CDN 资源加载。</p>
<h4 data-id="heading-34">❌ 常见问题</h4>
<ul>
<li>使用 SRI（<code>integrity</code>）却未设置匹配的 CORS（<code>crossorigin</code>），导致校验失败或错误不可见；</li>
<li>未配置 <code>referrerpolicy</code>，敏感页面泄露来源信息。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：SRI 未配合 CORS，可能导致资源校验失败或错误信息被隐藏 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span> <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-35">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ SRI + CORS 协同；可按需设置 referrerpolicy --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
  <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">"no-referrer"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验跨源配置是否完整
 * <span class="hljs-doctag">@description</span> 简单检查元素是否同时具备 integrity 与合适的 crossorigin
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLScriptElement</span>} <span class="hljs-variable">el</span> - 外链脚本元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否满足基本安全配置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkCrossOriginSafety</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> hasSRI = !!el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'integrity'</span>);
  <span class="hljs-keyword">const</span> co = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'crossorigin'</span>);
  <span class="hljs-keyword">const</span> ok = hasSRI &amp;&amp; (co === <span class="hljs-string">'anonymous'</span> || co === <span class="hljs-string">'use-credentials'</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-36">💡 核心要点</h4>
<ul>
<li>SRI 要与 <code>crossorigin</code> 协同；</li>
<li><code>referrerpolicy</code> 根据场景合理配置（如下载页可用 <code>no-referrer</code>）；</li>
<li>了解错误可见性：跨源脚本在无 CORS 时错误堆栈受限。</li>
</ul>
<h4 data-id="heading-37">🎯 实际应用</h4>
<p>CDN 资源统一模板化：所有外链脚本/样式自动附加 <code>integrity</code> 与 <code>crossorigin</code>，并提供策略位可配置 <code>referrerpolicy</code>。</p>
<hr/>
<h3 data-id="heading-38">7. 可访问性与 ARIA：属性与角色的协同</h3>
<h4 data-id="heading-39">🔍 应用场景</h4>
<p>自定义组件（如伪按钮、可折叠区域）需要通过 <code>role</code> 与 <code>aria-*</code> 提升语义与可操作性。</p>
<h4 data-id="heading-40">❌ 常见问题</h4>
<ul>
<li>仅靠 <code>div</code> + 点击事件充当按钮，键盘用户无法操作；</li>
<li>误用 <code>aria-*</code> 与原生属性冲突（如对 <code>&lt;button&gt;</code> 重复声明 <code>role="button"</code>）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：无键盘可访问性与语义缺失 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doLike()"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-41">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 使用 role 与 aria-* 改善语义与交互；同时处理键盘事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"点赞"</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 为伪按钮添加键盘可访问性
 * <span class="hljs-doctag">@description</span> 处理 Enter/Space 键以触发点击行为
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 伪按钮元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">onActive</span> - 激活时的回调
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">enhancePseudoButton</span> = (<span class="hljs-params">el, onActive</span>) =&gt; {
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> k = e.<span class="hljs-property">key</span>;
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'Enter'</span> || k === <span class="hljs-string">' '</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-title function_">onActive</span>();
    }
  });
};
</code></pre>
<h4 data-id="heading-42">💡 核心要点</h4>
<ul>
<li>原生控件优先（<code>&lt;button&gt;</code>、<code>&lt;a&gt;</code> 等）；若必须自定义，再使用 <code>role</code> 与 <code>aria-*</code>；</li>
<li>始终为可交互元素提供键盘等效操作；</li>
<li>避免与原生属性冲突的冗余 <code>role</code> 声明。</li>
</ul>
<h4 data-id="heading-43">🎯 实际应用</h4>
<p>在卡片组件的可折叠区域使用 <code>aria-expanded</code> 与键盘事件，保证读屏与键盘用户体验一致。</p>
<hr/>
<h2 data-id="heading-44">📊 技巧对比总结</h2>





















































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>全局属性速查</td><td>元素语义与行为</td><td>统一管理 <code>lang/dir</code> 与编辑性</td><td>慎用 <code>contenteditable</code> 与 <code>hidden</code></td></tr><tr><td>布尔属性行为</td><td>交互禁用/焦点</td><td>property 控制直观兼容</td><td>避免 <code>autofocus</code> 影响可访问性</td></tr><tr><td>枚举属性</td><td>资源加载与策略</td><td>明确合法取值与默认值</td><td><code>crossorigin</code> 仅两种取值</td></tr><tr><td>data-* 与 dataset</td><td>携带元数据</td><td>结构化与安全</td><td>值为字符串，复杂用 JSON</td></tr><tr><td>表单属性</td><td>文件与自动填充</td><td>可用性与安全</td><td>谨慎 <code>capture</code>，精确 <code>accept</code></td></tr><tr><td>跨源与安全</td><td>外链资源</td><td>SRI + CORS 协同</td><td>错误可见性受跨源影响</td></tr><tr><td>ARIA 可访问性</td><td>自定义组件</td><td>语义与键盘可用性</td><td>避免与原生属性冲突</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-45">🎯 实战应用建议</h2>
<h3 data-id="heading-46">最佳实践</h3>
<ol>
<li>全局启用文档 <code>lang</code> 与合理的 <code>dir</code> 配置，国际化场景更稳。</li>
<li>统一封装布尔属性控制，全部走 property（<code>el.disabled = true</code>）。</li>
<li>图片使用 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少首屏阻塞与抖动。</li>
<li>业务元数据统一使用 <code>data-*</code>，避免与样式耦合。</li>
<li>表单的 <code>accept/capture/autocomplete</code> 按枚举规范配置，兼顾体验与安全。</li>
<li>外链资源模板化 SRI + CORS，必要时加 <code>referrerpolicy</code>，保障安全与隐私。</li>
</ol>
<h3 data-id="heading-47">性能考虑</h3>
<ul>
<li>图片与媒体优先使用懒加载与异步解码；</li>
<li>减少不必要的可编辑区域与聚焦跳转；</li>
<li>外链资源开启校验与跨源配置，降低失败成本并提升错误可见性。</li>
</ul>
<hr/>
<h2 data-id="heading-48">💡 总结</h2>
<p>这 7 个属性主题覆盖了日常开发中最常见且最易混淆的行为。掌握它们能让你的页面：</p>
<ol>
<li>更语义化、可访问；</li>
<li>更可控、少踩坑；</li>
<li>更安全、可观测；</li>
<li>更稳定、高性能。</li>
</ol>
<hr/>
<h2 data-id="heading-49">🔗 相关资源</h2>
<ul>
<li>MDN: HTML attribute reference — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FAttributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Global attributes — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FGlobal_attributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: ARIA roles, states and properties — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAccessibility%2FARIA" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Subresource Integrity (SRI) — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：理解了布尔与枚举属性的差异、data-* 的安全用法与跨源安全配置的关键点，能够在项目中落地更稳妥的属性策略。</p>
</blockquote>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏和分享！有任何问题也欢迎在评论区讨论。</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript DOM操作与事件处理：从小兔鲜儿电商网站看现代前端开发实践]]></title>    <link>https://juejin.cn/post/7571348736152961060</link>    <guid>https://juejin.cn/post/7571348736152961060</guid>    <pubDate>2025-11-11T15:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736152961060" data-draft-id="7571306072423104554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript DOM操作与事件处理：从小兔鲜儿电商网站看现代前端开发实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T15:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript DOM操作与事件处理：从小兔鲜儿电商网站看现代前端开发实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T15:51:56.000Z" title="Tue Nov 11 2025 15:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今的Web开发领域，JavaScript的DOM操作和事件处理能力是构建交互式用户体验的核心技术。本文将通过分析一个完整的电商网站案例——"小兔鲜儿"，深入探讨JavaScript在实际项目中的应用，特别是事件流、事件委托、滚动交互等关键概念。</p>
<h2 data-id="heading-0">事件流：理解事件传播机制</h2>
<p>事件流描述了事件在DOM结构中传播的顺序，分为捕获阶段和冒泡阶段。在小兔鲜儿网站中，我们随处可见事件流的应用。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 事件捕获示例</span>
element.<span class="hljs-built_in">addEventListener</span>(<span class="hljs-string">'click'</span>, handler, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 事件冒泡示例（默认）</span>
element.<span class="hljs-built_in">addEventListener</span>(<span class="hljs-string">'click'</span>, handler, <span class="hljs-literal">false</span>);
</code></pre>
<p>在实际开发中，我们通常使用事件冒泡，因为它更符合直觉。但当需要提前拦截事件时，事件捕获就显得尤为重要。</p>
<p>值得注意的是，<code>mouseenter</code>和<code>mouseleave</code>事件没有冒泡阶段，这是它们与<code>mouseover</code>和<code>mouseout</code>的重要区别。在小兔鲜儿的主导航悬停效果中，正是利用了这些事件的特性来实现平滑的交互效果。</p>
<h2 data-id="heading-1">事件解绑与性能优化</h2>
<p>随着Web应用越来越复杂，合理管理事件监听器变得至关重要。小兔鲜儿网站展示了正确的事件解绑实践：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'按钮被点击'</span>);
}

<span class="hljs-comment">// 绑定事件</span>
element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleClick);

<span class="hljs-comment">// 解绑事件</span>
element.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleClick);
</code></pre>
<p>需要注意的是，匿名函数无法被解绑，这强调了在重要交互中使用命名函数的重要性。在单页应用(SPA)中，忽视事件解绑可能导致内存泄漏，影响应用性能。</p>
<h2 data-id="heading-2">事件委托：高效处理动态内容</h2>
<p>事件委托是小兔鲜儿网站中广泛应用的高级技巧，它利用了事件冒泡的特性：</p>
<p>html</p>
<p>复制下载运行</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第1个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第2个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第3个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>);
  ul.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">if</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">'LI'</span>) {
      e.<span class="hljs-property">target</span>.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>;
    }
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这种模式的优点非常明显：</p>
<ul>
<li>减少内存使用，只需要一个事件监听器</li>
<li>动态添加的元素自动拥有事件处理能力</li>
<li>代码更加简洁易维护</li>
</ul>
<p>在小兔鲜儿的tab栏切换组件中，事件委托发挥了重要作用：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-nav ul'</span>);
ul.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">if</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">'A'</span>) {
    <span class="hljs-comment">// 移除之前活跃的标签</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-nav .active'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
    <span class="hljs-comment">// 设置当前标签为活跃状态</span>
    e.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
    
    <span class="hljs-keyword">const</span> i = +e.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span>; <span class="hljs-comment">// 字符串转为数字</span>
    <span class="hljs-comment">// 切换对应内容</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-content .active'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`.tab-content .item:nth-child(<span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>)`</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
  }
});
</code></pre>
<h2 data-id="heading-3">阻止默认行为：掌控浏览器原生交互</h2>
<p>在某些场景下，我们需要阻止浏览器的默认行为以提供自定义交互。小兔鲜儿网站中的表单处理就体现了这一技术：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> form = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'form'</span>);
form.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-comment">// 自定义提交逻辑</span>
});
</code></pre>
<p>这一技术还广泛应用于阻止链接跳转、右键菜单等场景，为开发者提供了更精细的交互控制能力。</p>
<h2 data-id="heading-4">滚动交互：提升用户体验的关键</h2>
<p>滚动相关的交互在现代网站中无处不在，小兔鲜儿网站通过多种滚动技术创造了流畅的用户体验。</p>
<h3 data-id="heading-5">滚动事件基础</h3>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">scrollTop</span>;
  <span class="hljs-comment">// 根据滚动位置执行相应操作</span>
});
</code></pre>
<p><code>scrollTop</code>属性是可读写的，这允许我们不仅监听滚动，还能以编程方式控制滚动位置：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 滚动到指定位置</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">800</span>;

<span class="hljs-comment">// 平滑滚动到顶部</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
  <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>
});
</code></pre>
<h3 data-id="heading-6">响应式布局与尺寸监控</h3>
<p>小兔鲜儿网站通过监听窗口尺寸变化，确保在不同设备上都能提供良好的用户体验：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调整布局或重新计算元素位置</span>
});
</code></pre>
<h3 data-id="heading-7">元素尺寸与位置获取</h3>
<p>准确获取元素尺寸和位置是实现精细交互的基础：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'div'</span>);

<span class="hljs-comment">// 获取不包含边框的宽高</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-property">clientWidth</span>, div.<span class="hljs-property">clientHeight</span>);

<span class="hljs-comment">// 获取包含边框的宽高</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-property">offsetWidth</span>, div.<span class="hljs-property">offsetHeight</span>);

<span class="hljs-comment">// 获取相对于定位父元素的位置</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-property">offsetTop</span>, div.<span class="hljs-property">offsetLeft</span>);

<span class="hljs-comment">// 获取元素相对于视口的位置和尺寸</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-title function_">getBoundingClientRect</span>());
</code></pre>
<h2 data-id="heading-8">实战案例：小兔鲜儿电梯导航</h2>
<p>小兔鲜儿网站的电梯导航是一个综合应用上述技术的典型案例，它包含了三个主要功能：</p>
<h3 data-id="heading-9">1. 滚动显示/隐藏</h3>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">(function() {
  const <span class="hljs-attr">entry</span> = document.querySelector(<span class="hljs-string">'.xtx_entry'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">elevator</span> = document.querySelector(<span class="hljs-string">'.xtx-elevator'</span>)<span class="hljs-comment">;</span>
  
  window.addEventListener('scroll', function() {
    const <span class="hljs-attr">n</span> = document.documentElement.scrollTop<span class="hljs-comment">;</span>
    <span class="hljs-attr">elevator.style.opacity</span> = n &gt;= entry.<span class="hljs-literal">off</span>setTop ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  // 返回顶部功能
  const <span class="hljs-attr">backTop</span> = document.querySelector(<span class="hljs-string">'#backTop'</span>)<span class="hljs-comment">;</span>
  backTop.addEventListener('click', function() {
    window.scrollTo(0, 0)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">2. 点击导航平滑滚动</h3>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">list</span> = document.querySelector(<span class="hljs-string">'.xtx-elevator-list'</span>)<span class="hljs-comment">;</span>
list.addEventListener('click', function(e) {
  if (<span class="hljs-attr">e.target.tagName</span> === <span class="hljs-string">'A'</span> &amp;&amp; e.target.dataset.name) {
    // 排他思想更新活跃状态
    const <span class="hljs-attr">old</span> = document.querySelector(<span class="hljs-string">'.xtx-elevator-list .active'</span>)<span class="hljs-comment">;</span>
    if (old) old.classList.remove('active')<span class="hljs-comment">;</span>
    e.target.classList.add('active')<span class="hljs-comment">;</span>
    
    // 滚动到对应区域
    const <span class="hljs-attr">top</span> = document.querySelector(`.xtx_goods_<span class="hljs-variable">${e.target.dataset.name}</span>`).<span class="hljs-literal">off</span>setTop<span class="hljs-comment">;</span>
    <span class="hljs-attr">document.documentElement.scrollTop</span> = top<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11">3. 滚动时高亮对应导航项</h3>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'scroll'</span>, function() {
  <span class="hljs-comment">// 移除之前的活跃状态</span>
  <span class="hljs-keyword">const</span> old = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'.xtx-elevator-list .active'</span>);
  <span class="hljs-keyword">if</span> (old) old.classList.remove(<span class="hljs-string">'active'</span>);
  
  <span class="hljs-comment">// 根据滚动位置设置新的活跃状态</span>
  <span class="hljs-keyword">const</span> n = <span class="hljs-built_in">document</span>.documentElement.scrollTop;
  <span class="hljs-keyword">const</span> news = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'.xtx_goods_new'</span>);
  <span class="hljs-keyword">const</span> popular = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'.xtx_goods_popular'</span>);
  <span class="hljs-keyword">const</span> brand = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'.xtx_goods_brand'</span>);
  <span class="hljs-keyword">const</span> topic = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'.xtx_goods_topic'</span>);
  
  <span class="hljs-keyword">if</span> (n &gt;= news.offsetTop &amp;&amp; n &lt; popular.offsetTop) {
    <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'[data-name=new]'</span>).classList.add(<span class="hljs-string">'active'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n &gt;= popular.offsetTop &amp;&amp; n &lt; brand.offsetTop) {
    <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'[data-name=popular]'</span>).classList.add(<span class="hljs-string">'active'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n &gt;= brand.offsetTop &amp;&amp; n &lt; topic.offsetTop) {
    <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'[data-name=brand]'</span>).classList.add(<span class="hljs-string">'active'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n &gt;= topic.offsetTop) {
    <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'[data-name=topic]'</span>).classList.add(<span class="hljs-string">'active'</span>);
  }
});
</code></pre>
<h2 data-id="heading-12">性能优化与最佳实践</h2>
<p>在小兔鲜儿这样的电商网站中，性能优化尤为重要：</p>
<ol>
<li><strong>节流滚动事件</strong>：高频触发的scroll事件应该进行节流处理</li>
<li><strong>避免强制同步布局</strong>：连续读取和修改DOM属性会导致性能问题</li>
<li><strong>使用CSS动画</strong>：尽可能使用CSS而非JavaScript实现动画效果</li>
<li><strong>事件委托</strong>：如前所述，减少事件监听器数量</li>
</ol>
<h2 data-id="heading-13">总结</h2>
<p>通过分析小兔鲜儿电商网站，我们可以看到现代JavaScript DOM操作和事件处理技术的全面应用。从基础的事件流理解到高级的事件委托模式，从简单的点击处理到复杂的滚动交互，这些技术共同构建了流畅、响应式的用户体验。</p>
<p>在实际项目中，我们应该根据具体需求选择合适的技术方案，平衡功能实现与性能优化，始终以用户体验为中心，这才是前端开发的真正艺术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5.2 Spring AI OpenAI 嵌入模型]]></title>    <link>https://juejin.cn/post/7571281406509793331</link>    <guid>https://juejin.cn/post/7571281406509793331</guid>    <pubDate>2025-11-11T09:38:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509793331" data-draft-id="7571281406509776947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5.2 Spring AI OpenAI 嵌入模型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T09:38:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴祖贤"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475492103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5.2 Spring AI OpenAI 嵌入模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475492103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴祖贤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:38:50.000Z" title="Tue Nov 11 2025 09:38:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI OpenAI 嵌入模型</h2>
<h3 data-id="heading-1">前言</h3>
<p>Spring AI 支持 OpenAI 的文本嵌入模型。</p>
<p>OpenAI 的文本嵌入用于衡量文本字符串的相关性。嵌入是一个向量（浮点数列表）。两个向量之间的距离衡量它们的相关性。小距离表示高相关性，大距离表示低相关性。</p>
<h3 data-id="heading-2">前提条件</h3>
<p>您需要创建一个 OpenAI API 来访问 OpenAI 嵌入模型。</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fsignup" target="_blank" title="https://platform.openai.com/signup" ref="nofollow noopener noreferrer">OpenAI 注册页面</a> 创建账户，并在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Faccount%2Fapi-keys" target="_blank" title="https://platform.openai.com/account/api-keys" ref="nofollow noopener noreferrer">API Keys 页面</a> 生成令牌。</p>
<p>Spring AI 项目定义了一个名为 <code>spring.ai.openai.api-key</code> 的配置属性，您应该将其设置为从 openai.com 获取的 <code>API Key</code> 的值。</p>
<p>您可以在 <code>application.properties</code> 文件中设置此配置属性：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=&lt;your-openai-api-key&gt;
</code></pre>
<p>为了在处理 API 密钥等敏感信息时增强安全性，您可以使用 Spring Expression Language (SpEL) 来引用环境变量：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># In application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${OPENAI_API_KEY}</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># In your environment or .env file</span>
<span class="hljs-built_in">export</span> OPENAI_API_KEY=&lt;your-openai-api-key&gt;
</code></pre>
<p>您也可以在应用程序代码中以编程方式设置此配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Retrieve API key from a secure source or environment variable</span>
<span class="hljs-type">String</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> System.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>);
</code></pre>
<h4 data-id="heading-3">添加仓库和 BOM</h4>
<p>Spring AI 构件发布在 Maven Central 和 Spring Snapshot 仓库中。参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23artifact-repositories" target="_blank" title="../../getting-started.html#artifact-repositories" ref="nofollow noopener noreferrer">构件仓库</a>部分，将这些仓库添加到您的构建系统中。</p>
<p>为了帮助依赖管理，Spring AI 提供了 BOM（物料清单）来确保整个项目中使用一致的 Spring AI 版本。参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建系统中。</p>
<h3 data-id="heading-4">自动配置</h3>
<blockquote>
<p><strong>注意</strong>
Spring AI 自动配置、启动器模块的构件名称发生了重大变化。请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fupgrade-notes.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/upgrade-notes.html" ref="nofollow noopener noreferrer">升级说明</a>了解更多信息。</p>
</blockquote>
<p>Spring AI 为 OpenAI 嵌入模型提供了 Spring Boot 自动配置。要启用它，请将以下依赖项添加到您项目的 Maven <code>pom.xml</code> 文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>或添加到您的 Gradle <code>build.gradle</code> 构建文件中。</p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-starter-model-openai'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>
参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。</p>
</blockquote>
<h4 data-id="heading-5">嵌入属性</h4>
<h5 data-id="heading-6">重试属性</h5>
<p>前缀 <code>spring.ai.retry</code> 用作属性前缀，让您可以为 OpenAI 嵌入模型配置重试机制。</p>













































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.retry.max-attempts</td><td>最大重试尝试次数。</td><td>10</td></tr><tr><td>spring.ai.retry.backoff.initial-interval</td><td>指数退避策略的初始睡眠持续时间。</td><td>2 sec.</td></tr><tr><td>spring.ai.retry.backoff.multiplier</td><td>退避间隔倍数。</td><td>5</td></tr><tr><td>spring.ai.retry.backoff.max-interval</td><td>最大退避持续时间。</td><td>3 min.</td></tr><tr><td>spring.ai.retry.on-client-errors</td><td>如果为 false，抛出 NonTransientAiException，不尝试对 <code>4xx</code> 客户端错误代码进行重试</td><td>false</td></tr><tr><td>spring.ai.retry.exclude-on-http-codes</td><td>不应触发重试的 HTTP 状态代码列表（例如，抛出 NonTransientAiException）。</td><td>empty</td></tr><tr><td>spring.ai.retry.on-http-codes</td><td>应该触发重试的 HTTP 状态代码列表（例如，抛出 TransientAiException）。</td><td>empty</td></tr></tbody></table>
<h5 data-id="heading-7">连接属性</h5>
<p>前缀 <code>spring.ai.openai</code> 用作连接到 OpenAI 的属性前缀。</p>






























<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.base-url</td><td>要连接的 URL</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.openai.com" target="_blank" title="https://api.openai.com" ref="nofollow noopener noreferrer">api.openai.com</a></td></tr><tr><td>spring.ai.openai.api-key</td><td>API 密钥</td><td>-</td></tr><tr><td>spring.ai.openai.organization-id</td><td>可选择地，您可以指定用于 API 请求的组织。</td><td>-</td></tr><tr><td>spring.ai.openai.project-id</td><td>可选择地，您可以指定用于 API 请求的项目。</td><td>-</td></tr></tbody></table>
<blockquote>
<p><strong>提示</strong>
对于属于多个组织的用户（或通过其旧版用户 API 密钥访问其项目），可选择地，您可以指定用于 API 请求的组织和项目。这些 API 请求的使用将计为指定组织和项目的使用量。</p>
</blockquote>
<h5 data-id="heading-8">配置属性</h5>
<blockquote>
<p><strong>注意</strong>
嵌入自动配置的启用和禁用现在通过前缀为 <code>spring.ai.model.embedding</code> 的顶级属性配置。</p>
<p>要启用，设置 spring.ai.model.embedding=openai（默认启用）</p>
<p>要禁用，设置 spring.ai.model.embedding=none（或任何不匹配 openai 的值）</p>
<p>进行此更改是为了允许配置多个模型。</p>
</blockquote>
<p>前缀 <code>spring.ai.openai.embedding</code> 是配置 OpenAI 的 <code>EmbeddingModel</code> 实现的属性前缀。</p>






































































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.embedding.enabled (必需且不再有效)</td><td>启用 OpenAI 嵌入模型。</td><td>true</td></tr><tr><td>spring.ai.model.embedding</td><td>启用 OpenAI 嵌入模型。</td><td>openai</td></tr><tr><td>spring.ai.openai.embedding.base-url</td><td>可选择地覆盖 spring.ai.openai.base-url 以提供特定的嵌入 URL</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.embeddings-path</td><td>要附加到 base-url 的路径</td><td><code>/v1/embeddings</code></td></tr><tr><td>spring.ai.openai.embedding.api-key</td><td>可选择地覆盖 spring.ai.openai.api-key 以提供特定的嵌入 API 密钥</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.organization-id</td><td>可选择地，您可以指定用于 API 请求的组织。</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.project-id</td><td>可选择地，您可以指定用于 API 请求的项目。</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.metadata-mode</td><td>文档内容提取模式。</td><td>EMBED</td></tr><tr><td>spring.ai.openai.embedding.options.model</td><td>要使用的模型</td><td>text-embedding-ada-002（其他选项：text-embedding-3-large, text-embedding-3-small）</td></tr><tr><td>spring.ai.openai.embedding.options.encodingFormat</td><td>返回嵌入的格式。可以是 float 或 base64。</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.options.user</td><td>代表您的最终用户的唯一标识符，可以帮助 OpenAI 监控和检测滥用。</td><td>-</td></tr><tr><td>spring.ai.openai.embedding.options.dimensions</td><td>生成的输出嵌入应该具有的维度数。仅在 <code>text-embedding-3</code> 及更高版本模型中支持。</td><td>-</td></tr></tbody></table>
<blockquote>
<p><strong>注意</strong>
您可以为 <code>ChatModel</code> 和 <code>EmbeddingModel</code> 实现覆盖通用的 <code>spring.ai.openai.base-url</code> 和 <code>spring.ai.openai.api-key</code>。如果设置了 <code>spring.ai.openai.embedding.base-url</code> 和 <code>spring.ai.openai.embedding.api-key</code> 属性，它们将优先于通用属性。类似地，如果设置了 <code>spring.ai.openai.chat.base-url</code> 和 <code>spring.ai.openai.chat.api-key</code> 属性，它们将优先于通用属性。如果您想为不同的模型和不同的模型端点使用不同的 OpenAI 账户，这很有用。</p>
</blockquote>
<blockquote>
<p><strong>提示</strong>
所有以 <code>spring.ai.openai.embedding.options</code> 为前缀的属性都可以通过在 <code>EmbeddingRequest</code> 调用中添加请求特定的<a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9" title="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9">运行时选项</a>来在运行时覆盖。</p>
</blockquote>
<h3 data-id="heading-9">运行时选项</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2FOpenAiEmbeddingOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/main/java/org/springframework/ai/openai/OpenAiEmbeddingOptions.java" ref="nofollow noopener noreferrer">OpenAiEmbeddingOptions.java</a> 提供 OpenAI 配置，如要使用的模型等。</p>
<p>默认选项也可以使用 <code>spring.ai.openai.embedding.options</code> 属性进行配置。</p>
<p>在启动时，使用 <code>OpenAiEmbeddingModel</code> 构造函数设置所有嵌入请求使用的默认选项。在运行时，您可以使用 <code>OpenAiEmbeddingOptions</code> 实例作为 <code>EmbeddingRequest</code> 的一部分来覆盖默认选项。</p>
<p>例如，覆盖特定请求的默认模型名称：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> embeddingModel.call(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddingRequest</span>(List.of(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"World is big and salvation is near"</span>),
        OpenAiEmbeddingOptions.builder()
            .model(<span class="hljs-string">"Different-Embedding-Model-Deployment-Name"</span>)
        .build()));
</code></pre>
<h3 data-id="heading-10">示例控制器</h3>
<p>这将创建一个可以注入到类中的 <code>EmbeddingModel</code> 实现。以下是使用 <code>EmbeddingModel</code> 实现的简单 <code>@Controller</code> 类示例。</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=YOUR_API_KEY
spring.ai.openai.embedding.options.model=text-embedding-ada-002
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddingController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingModel embeddingModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmbeddingController</span><span class="hljs-params">(EmbeddingModel embeddingModel)</span> {
        <span class="hljs-built_in">this</span>.embeddingModel = embeddingModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
}
</code></pre>
<h3 data-id="heading-11">手动配置</h3>
<p>如果您不使用 Spring Boot，可以手动配置 OpenAI 嵌入模型。为此，将 <code>spring-ai-openai</code> 依赖项添加到您项目的 Maven <code>pom.xml</code> 文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>或添加到您的 Gradle <code>build.gradle</code> 构建文件中。</p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-openai'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>
参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>
<code>spring-ai-openai</code> 依赖项也提供对 <code>OpenAiChatModel</code> 的访问。有关 <code>OpenAiChatModel</code> 的更多信息，请参考 <a href="https://link.juejin.cn?target=..%2Fchat%2Fopenai-chat.html" target="_blank" title="../chat/openai-chat.html" ref="nofollow noopener noreferrer">OpenAI 聊天客户端</a> 部分。</p>
</blockquote>
<p>接下来，创建一个 <code>OpenAiEmbeddingModel</code> 实例，并使用它计算两个输入文本之间的相似性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">var</span> <span class="hljs-variable">openAiApi</span> <span class="hljs-operator">=</span> OpenAiApi.builder()
                .apiKey(System.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>))
                .build();

<span class="hljs-type">var</span> <span class="hljs-variable">embeddingModel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAiEmbeddingModel</span>(
		<span class="hljs-built_in">this</span>.openAiApi,
        MetadataMode.EMBED,
        OpenAiEmbeddingOptions.builder()
                .model(<span class="hljs-string">"text-embedding-ada-002"</span>)
                .user(<span class="hljs-string">"user-6"</span>)
                .build(),
        RetryUtils.DEFAULT_RETRY_TEMPLATE);

<span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel
        .embedForResponse(List.of(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"World is big and salvation is near"</span>));
</code></pre>
<p><code>OpenAiEmbeddingOptions</code> 提供嵌入请求的配置信息。api 和选项类提供 <code>builder()</code> 以便于选项创建。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 ETL 更懂语义：DataWorks 支持数据集成 AI 辅助处理能力]]></title>    <link>https://juejin.cn/post/7569566666528325672</link>    <guid>https://juejin.cn/post/7569566666528325672</guid>    <pubDate>2025-11-07T06:01:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569566666528325672" data-draft-id="7569480265568845824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 ETL 更懂语义：DataWorks 支持数据集成 AI 辅助处理能力"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-07T06:01:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 ETL 更懂语义：DataWorks 支持数据集成 AI 辅助处理能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-07T06:01:14.000Z" title="Fri Nov 07 2025 06:01:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在生成式 AI 浪潮下，数据不再只是“被搬运的原料”，更应是“可理解、可推理、可挖掘价值”的智能资产。然而，传统 ETL（Extract-Transform-Load）流程仍停留在结构化数据处理层面，面对海量文本、日志、反馈等非结构化数据时，往往依赖人工标注或复杂开发链路，效率低、成本高、响应慢。</p>
<p>为此，阿里云大数据开发治理平台 DataWorks 数据集成全新智能化升级，以“ AI 释放数据价值”为核心，正式推出 AI 辅助处理能力，并将该功能在阿里云全球所有地域全面开放！将大模型语义理解、AI 智能分析能力深度融入离线同步任务的数据集成任务，真正实现“让每一条数据流都能思考”。</p>
<h2 data-id="heading-0">核心能力-开箱即用的智能 ETL 引擎</h2>
<p>DataWorks Serverless 资源组全新升级，支持大模型一键部署与高效调用！现已支持 Qwen3 系列、DeepSeek 系列及 Embedding 模型，提供多种 GPU 规格按需选用，按量付费，灵活成本。通过 AI Function 可便捷调用模型服务，小尺寸模型推理性能提升近 10 倍，并支持使用 DataWorks Serverless CU 资源抵扣，助力 AI 应用快速构建与弹性扩展。</p>
<p>DataWorks 数据集成现已支持在离线同步任务中直接调用大模型服务，用户无需部署模型、无需编写代码、无需额外付费，只需通过自然语言提示（Prompt），即可完成复杂的数据清洗、增强与语义结构化操作。</p>





























<table><thead><tr><th><strong>功能</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>AI 辅助处理</td><td>支持情感分析、文本分类、摘要生成、关键词提取、翻译等常见 NLP 任务</td></tr><tr><td>向量化（Embedding）处理</td><td>自动将文本字段转化为高维向量，用于语义搜索、RAG、推荐系统等 AI 应用</td></tr><tr><td>多平台模型支持</td><td>*   通过阿里云 DataWorks 部署模型服务<br/>    <br/>*   通过阿里云 PAI 模型市场开通模型服务<br/>    <br/>*   通过阿里云百炼平台开通大模型服务</td></tr><tr><td>零代码配置</td><td>全图形化界面操作，业务人员也能轻松定义 AI 处理逻辑</td></tr><tr><td>结果直写目标表</td><td>所有 AI 处理结果可直接映射至目标数据库字段，无缝对接下游应用</td></tr></tbody></table>
<p>整个过程完全托管，且 AI 处理功能本身不额外收费 —— 您只需为同步任务消耗的计算资源付费，与其他普通离线同步任务计费方式完全一致。</p>
<h2 data-id="heading-1">适用场景-多行业多场景赋能企业 AI 落地</h2>
<p>智能数据处理在数据同步 ETL 流程中可广泛应用于多个企业场景，通过情感分析、摘要生成、关键词提取、翻译和向量化等能力提升数据处理效率与洞察深度。这些应用可以显著提升了企业的决策支持能力和运营智能化水平。</p>
<h3 data-id="heading-2">1、电商客服场景：用户反馈分析与情感分类</h3>
<p>示例，客户留言：“快递太慢了，等了半个月还没到！”</p>

























<table><thead><tr><th>数据处理场景</th><th>提示语</th><th>处理结果示例</th></tr></thead><tbody><tr><td>情感分析</td><td>对用户投诉/咨询文本进行情感分类（正面/负面/中性）</td><td>负面</td></tr><tr><td>摘要生成</td><td>将长文本的用户反馈压缩为简短摘要，提取核心问题</td><td>用户投诉物流时效问题</td></tr><tr><td>关键词提取</td><td>识别高频问题关键词（如“物流延迟”“产品质量”）</td><td>物流延迟、快递、时效</td></tr></tbody></table>
<p>👉 自动归类千万级评论，支撑运营决策与服务质量优化。</p>
<h3 data-id="heading-3">2.、智能汽车场景：设备日志分析与预测性维护</h3>
<p>示例，日志内容：“The break pump pressure：abnormal; sensor exceeding : 15%”</p>

























<table><thead><tr><th>数据处理场景</th><th>提示语</th><th>处理结果示例</th></tr></thead><tbody><tr><td>文本总结</td><td>将设备运行日志中的故障描述压缩为关键信息</td><td>刹车泵浦压力超限，需立即检查</td></tr><tr><td>严重性判断</td><td>判断日志中描述的故障严重性（如“紧急”“警告”）</td><td>高危</td></tr><tr><td>翻译</td><td>统一翻译为中文</td><td>刹车泵浦压力异常，传感器显示值高于阈值15%</td></tr></tbody></table>
<p>👉 将非结构化日志转为结构化告警信息，助力预测性维护系统快速响应。</p>
<h3 data-id="heading-4">3、供应链场景：供应商反馈分析与风险预警</h3>
<p>示例，供应商邮件：“We are unable to fulfill the order due to a shortage of raw materials.”</p>

























<table><thead><tr><th>数据处理场景</th><th>提示语</th><th>处理结果示例</th></tr></thead><tbody><tr><td>情感分析</td><td>评估供应商合作态度（积极/消极）</td><td>消极</td></tr><tr><td>摘要生成</td><td>提取供应商反馈的核心问题（如“交付延迟”）</td><td>供应商因原材料短缺无法完成订单</td></tr><tr><td>翻译</td><td>将非中文供应商邮件翻译为中文</td><td>由于原材料短缺，我们无法完成该订单</td></tr></tbody></table>
<p>👉 自动识别交付风险，提前触发备选供应商调度机制。</p>
<h3 data-id="heading-5">4、法律场景：合同条款分析与风险标注</h3>
<p>示例，合同条款：“In the event of force majeure, the delivery deadline may be extended.”</p>

























<table><thead><tr><th>数据处理场景</th><th>提示语</th><th>处理结果示例</th></tr></thead><tbody><tr><td>摘要生成</td><td>提取合同核心条款（如付款条件、违约责任）</td><td>不可抗力条款允许延期交货</td></tr><tr><td>关键词提取</td><td>识别关键法律术语（如“不可抗力”“仲裁条款”）</td><td>不可抗力、交货期限</td></tr><tr><td>翻译</td><td>将外文合同翻译为中文</td><td>若发生不可抗力，交货期限可延长</td></tr></tbody></table>
<p>👉 提升法务审查效率，降低合同履约风险。</p>
<h2 data-id="heading-6">案例说明</h2>
<p>接下来介绍如何使用AI辅助处理功能，将数据来源表中<code>feedback_info</code>列的数据翻译为英文并同步至目标表。</p>
<p>来源表数据准备</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer_feedback (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    device STRING,
    feedback_info STRING,
    pt <span class="hljs-type">INT</span>
)
PARTITIONED <span class="hljs-keyword">BY</span> (pt)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(id)
<span class="hljs-keyword">WITH</span> (table_type<span class="hljs-operator">=</span><span class="hljs-string">'Duplication'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_feedback (id, device, feedback_info, pt)
<span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">8</span>, <span class="hljs-string">'Huawei MateBook D14'</span>, <span class="hljs-string">'价格实惠，适合学生党，性能够用'</span>, <span class="hljs-number">2020</span>),
(<span class="hljs-number">1</span>, <span class="hljs-string">'iphone'</span>, <span class="hljs-string">'这个商品还行，我用了1年'</span>, <span class="hljs-number">2013</span>),
(<span class="hljs-number">10</span>, <span class="hljs-string">'Bose QuietComfort 35 II'</span>, <span class="hljs-string">'降噪耳机中的经典，舒适度满分'</span>, <span class="hljs-number">2021</span>);
</code></pre>
<h3 data-id="heading-7">一、创建离线同步任务</h3>
<p>进入<a href="https://link.juejin.cn?target=https%3A%2F%2Fdataworks.console.aliyun.com%2Fworkspace%2Flist" target="_blank" title="https://dataworks.console.aliyun.com/workspace/list" ref="nofollow noopener noreferrer">DataWorks工作空间列表页</a>，在顶部切换至目标地域，找到已创建的工作空间，单击操作列的快速进入 &gt; Data Studio，进入Data Studio。</p>
<p>在左侧导航栏单击按钮&lt;/&gt;，进入数据开发页面，在项目目录右侧单击按钮+，选择新建节点 &gt; 数据集成 &gt; 离线同步，进入新建节点对话框。</p>
<p>设置节点路径、数据来源去向和节点名称后，单击确认，创建离线同步节点。</p>
<p>本文以Hologres同步至Hologres为例，介绍离线同步任务中的AI辅助处理功能。</p>
<h3 data-id="heading-8">二、配置同步任务</h3>
<p>创建离线同步节点后，会自动进入任务编辑页面，您需要在此页面配置如下信息：</p>
<h4 data-id="heading-9">1、数据源</h4>
<p>分别配置数据同步任务的数据来源和数据去向。</p>
<p>类型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fdataworks%2Fuser-guide%2Foffline-synchronization-task-ai-auxiliary-processing%3Fspm%3Da2c4g.11186623.help-menu-72772.d_2_1_4_0_5_1.8ae72b0fixOwu4%23afff3df480tlb" target="_blank" title="https://help.aliyun.com/zh/dataworks/user-guide/offline-synchronization-task-ai-auxiliary-processing?spm=a2c4g.11186623.help-menu-72772.d_2_1_4_0_5_1.8ae72b0fixOwu4#afff3df480tlb" ref="nofollow noopener noreferrer">创建离线同步任务</a>步骤中已选择的数据来源和去向的数据源类型，不支持修改，如需修改请重新创建离线同步任务。</p>
<p>配置方式：</p>
<p>快速配置：手动配置数据来源与数据去向的连接信息，详细的配置参数解释可在配置界面查看对应参数的文案提示。</p>
<p>使用已有数据源：请在数据源参数后的下拉列表中选择已创建的数据源。</p>
<p>说明</p>
<p>数据源中只展示对应类型的数据源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83c1d555c5b045a9816f61193727fdfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=GxpfZs6W6F2Jq5jVP5YpqL6dfQ4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">2、运行资源</h4>
<p>选择同步任务所使用的资源组。如果使用 Serverless 资源组，您还可以为该任务分配资源占用 CU 数。</p>
<p>选择资源组后，数据集成将自动检测资源组与数据来源、数据去向的连通性，您也可以手动单击连通性检查。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dff26b085294b7d834e03dddf924269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=fBOd%2B0j5IpZnMUOUV7%2BQIf4QgAA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">3、数据来源</h4>
<p>配置数据来源具体待同步的表信息，如Schema、表、分区和数据过滤条件等。您可以单击数据预览，查看待同步的具体数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76057c7da546479186c0f8257b431f66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=0BRLI5L3qHOfleoXjJcdKbgqgGg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">4、数据处理</h4>
<p>在数据处理区域，您可以开启数据处理能力，数据处理能力需要更多的计算资源，会增加任务的资源占用开销。</p>
<p>单击添加节点，当前支持字符串替换和AI辅助处理。本案例以AI辅助处理为例进行介绍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bb24eb64bee46f49aaa0c3c2c53e5b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=SpNEFvzIumQEjr%2F9LMv2abSw360%3D" alt="image.png" loading="lazy"/></p>
<p>配置AI辅助处理相关信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b7a981881e400db0a6c43945479814~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=i%2BweMrvSBBT57GdbuyHT0qawDqk%3D" alt="image.png" loading="lazy"/>
关键参数解释如下：</p>





























<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>模型提供商</td><td>支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fdataworks%2Fuser-guide%2Fllm-service-management%2F" target="_blank" title="https://help.aliyun.com/zh/dataworks/user-guide/llm-service-management/" ref="nofollow noopener noreferrer">阿里云DataWorks模型服务</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Fwhat-is-model-studio" target="_blank" title="https://help.aliyun.com/zh/model-studio/what-is-model-studio" ref="nofollow noopener noreferrer">阿里百炼平台</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fpai%2Fproduct-overview%2Fwhat-is-machine-learning-platform-for-ai%2F" target="_blank" title="https://help.aliyun.com/zh/pai/product-overview/what-is-machine-learning-platform-for-ai/" ref="nofollow noopener noreferrer">阿里云PAI模型市场</a>。</td></tr><tr><td>模型名称</td><td>负责智能数据处理的模型，按需选择。</td></tr><tr><td>API Key</td><td>访问模型的API KEY，请前往模型提供商获取。<br/>阿里云百炼平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Fget-api-key" target="_blank" title="https://help.aliyun.com/zh/model-studio/get-api-key" ref="nofollow noopener noreferrer">获取百炼API Key</a>。<br/>阿里云PAI模型市场：前往部署的EAS任务，<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fpai%2Fuser-guide%2Fcall-a-service-over-a-public-endpoint" target="_blank" title="https://help.aliyun.com/zh/pai/user-guide/call-a-service-over-a-public-endpoint" ref="nofollow noopener noreferrer">进入在线调试</a>，获取Token，将其作为API KEY填写到此处。</td></tr><tr><td>处理工作描述</td><td>请使用自然语言描述对来源字段的处理，字段名以<code>#{column_name}</code>格式书写。例如，本案例中，此处填写<code>请将'#{feedback_info}'翻译成英文</code>。</td></tr><tr><td>写入字段</td><td>此处请输入存储结果字段的名称，如果对应字段不存在，将自动新增一个字段。</td></tr></tbody></table>
<p>说明</p>
<p>本案例的示例配置中，会将来源表的<code>feedback_info</code>字段翻译成英文，并存储到<code>feedback_processed</code>字段中。</p>
<p>您可以单击AI辅助处理区域右上角的数据输出预览，查看输出的最终数据效果。</p>
<p>（可选）您可以配置多个先后按顺序执行的数据处理流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8a2bf3850c44aabb75403228dcff7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=PvZoEdDwCUYGoRNCX1jQ6pK%2BMRU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">5、数据去向</h4>
<p>配置数据同步的目标表信息，例如Schema、表名、分区等。</p>
<p>您可以单击一键生成目标表结构，快速生成目标表。</p>
<p>如果目标端中已存在表用于接收数据，则按需选择即可。</p>
<p>配置写入模式以及写入冲突策略。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a7a992867164bdca8f5a350be256b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=DX9aaHrbB1V8bTtjo8HkoMxGJrA%3D" alt="image.png" loading="lazy"/></p>
<p>配置同步前是否要清空Hologres表中的已有数据。</p>
<p>（可选）配置最大连接数。</p>
<p>最大连接数仅在写入模式为<code>SQL(INSERT INTO)</code>下生效，在开启任务时请确保Hologres实例有充足的空闲连接。一个任务最多使用9个连接。</p>
<h4 data-id="heading-14">6、去向字段映射</h4>
<p>配置完成数据来源、数据处理和数据去向后，会在此处展示来源与去向表间的字段映射关系，默认为同名映射和同行映射，你也可以按需进行调整。</p>
<p>说明</p>
<p>本案例中除了将源表已有字段（<code>id</code>、<code>device</code>、<code>feedback_info</code>、<code>pt</code>）同名映射外，还需要手动将源表中存储翻译后结果的<code>feedback_processed</code>字段，映射至目标表的<code>translate_feedback</code>字段中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b79070d570bd432cbc631bfaa9eb8a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459453&amp;x-signature=C9fVvrn2Os79QHzFwLVywZAugDk%3D" alt="image.png" loading="lazy"/>
<img src="https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/3BMqYybEJ6wRmqwZ/img/033b5cb1-c739-451a-b45c-3443aebde642.png" alt="image" loading="lazy"/></p>
<h3 data-id="heading-15">三、调试任务</h3>
<p>在离线同步任务的编辑窗口右侧，单击调试配置，配置调试本节点使用的资源组和相关脚本参数。</p>
<p>单击节点顶部工具栏的保存，然后单击运行，等待运行结束，查看运行结果是否成功，您可以前往目标端数据库查看表数据是否符合预期。</p>
<h3 data-id="heading-16">四、调度配置</h3>
<p>若离线同步节点需要周期性调度执行，您需要在节点右侧的调度配置中设置调度策略，配置相关的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fdataworks%2Fuser-guide%2Fnode-scheduling%2F" target="_blank" title="https://help.aliyun.com/zh/dataworks/user-guide/node-scheduling/" ref="nofollow noopener noreferrer">节点调度属性</a>。</p>
<h3 data-id="heading-17">五、节点发布</h3>
<p>请单击节点工具栏的发布图标唤起<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fdataworks%2Fuser-guide%2Ftask-release%2F" target="_blank" title="https://help.aliyun.com/zh/dataworks/user-guide/task-release/" ref="nofollow noopener noreferrer">发布流程</a>，通过该流程将任务发布至生产环境。只有在发布至生产环境后，才会进行周期性调度。</p>
<h3 data-id="heading-18">后续操作：任务运维</h3>
<p>节点发布后，您可以在发布流程中单击补数据或去运维。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI 实现MCP简单案例]]></title>    <link>https://juejin.cn/post/7571306072422858794</link>    <guid>https://juejin.cn/post/7571306072422858794</guid>    <pubDate>2025-11-11T13:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422858794" data-draft-id="7571258854901383211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI 实现MCP简单案例"/> <meta itemprop="keywords" content="后端,Java,人工智能"/> <meta itemprop="datePublished" content="2025-11-11T13:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="从从容容游刃有余"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI 实现MCP简单案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    从从容容游刃有余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:55:10.000Z" title="Tue Nov 11 2025 13:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI 实现MCP简单案例</h2>
<h3 data-id="heading-1">引言</h3>
<p>随着大型语言模型（LLM）在企业应用中的普及，如何有效地连接模型与外部工具、数据和服务成为了开发人员面临的重要挑战。2024年11月，Anthropic推出了<strong>模型上下文协议</strong>（Model Context Protocol，简称MCP），这一开放标准为解决AI系统中组件协同问题提供了全新的解决方案。本文将深入探讨MCP的核心概念，并通过一个实际的Spring AI示例项目展示其强大功能。</p>
<h3 data-id="heading-2">MCP协议简介</h3>
<p>MCP（Model Context Protocol）是一种专为人工智能模型设计的通信协议，旨在解决复杂AI系统中多个模型或组件之间的协同工作问题。你可以把MCP想象成AI领域的"USB接口"，它提供了一种统一的方式将AI模型连接到各种工具和数据源。</p>
<h4 data-id="heading-3">MCP的核心优势</h4>
<ol>
<li><strong>标准化通信</strong>：定义了模型与外部工具交互的标准接口</li>
<li><strong>自动发现能力</strong>：客户端可以自动发现并使用服务端提供的工具</li>
<li><strong>跨平台兼容</strong>：任何实现MCP的系统都可以无缝集成</li>
<li><strong>降低集成成本</strong>：开发者无需为每个模型重新实现工具调用逻辑</li>
<li><strong>增强安全性</strong>：提供了安全的数据交换机制</li>
</ol>
<h3 data-id="heading-4">Spring AI中的MCP实现</h3>
<p>Spring AI框架已经内置了对MCP协议的支持，使Java开发者能够轻松构建MCP服务器和客户端应用。在本文中，我们将通过一个实际的示例项目来演示Spring AI如何实现MCP功能。</p>
<h4 data-id="heading-5">项目架构概览</h4>
<p>我们的示例项目<code>mcp-demos</code>包含两个主要模块：</p>
<ol>
<li><strong>mcp-server-demo</strong>：实现了MCP服务器，提供天气查询等工具服务</li>
<li><strong>mcp-client-demo</strong>：实现了MCP客户端，连接到本地Ollama模型并自动发现服务器提供的工具</li>
</ol>
<h3 data-id="heading-6">服务端实现详解</h3>
<h4 data-id="heading-7">创建MCP服务器</h4>
<p>MCP服务器是一个基于Spring Boot的应用程序，通过简单的配置即可启用MCP功能。</p>
<p>首先，让我们看看主应用类的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpServerApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(McpServerApplication.class, args);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ToolCallbackProvider <span class="hljs-title function_">weatherTools</span><span class="hljs-params">(WeatherService weatherService)</span> {
        <span class="hljs-keyword">return</span> MethodToolCallbackProvider.builder().toolObjects(weatherService).build();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">TextInput</span><span class="hljs-params">(String input)</span> {}

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ToolCallback <span class="hljs-title function_">toUpperCase</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> FunctionToolCallback.builder(<span class="hljs-string">"toUpperCase"</span>, (TextInput input) -&gt; input.input().toUpperCase())
                .inputType(TextInput.class)
                .description(<span class="hljs-string">"Put the text to upper case"</span>)
                .build();
    }
}
</code></pre>
<p>在这段代码中，我们看到了两个关键的Bean定义：</p>
<ol>
<li><code>weatherTools</code>：将<code>WeatherService</code>类中标记为工具的方法注册为MCP服务</li>
<li><code>toUpperCase</code>：创建了一个简单的文本转换工具，用于将文本转换为大写</li>
</ol>
<h4 data-id="heading-8">实现工具服务</h4>
<p>下面是<code>WeatherService</code>类的核心实现，展示了如何定义MCP工具方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BASE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://api.weather.gov"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestClient restClient;

    <span class="hljs-comment">// 构造函数初始化RestClient...</span>

    <span class="hljs-meta">@Tool(description = "Get weather forecast for a specific latitude/longitude")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWeatherForecastByLocation</span><span class="hljs-params">(<span class="hljs-type">double</span> latitude, <span class="hljs-type">double</span> longitude)</span> {
        <span class="hljs-comment">// 实现天气查询逻辑...</span>
    }

    <span class="hljs-meta">@Tool(description = "Get weather alerts for a US state. Input is Two-letter US state code (e.g. CA, NY)")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAlerts</span><span class="hljs-params">(String state)</span> {
        <span class="hljs-comment">// 实现天气警报查询逻辑...</span>
    }
}
</code></pre>
<p><strong>关键技术点</strong>：</p>
<ol>
<li>使用<code>@Tool</code>注解标记可被MCP发现的方法</li>
<li><code>description</code>参数提供了工具的描述，帮助模型理解工具的功能和使用方式</li>
<li>方法参数和返回类型会被自动转换为适合模型理解的格式</li>
</ol>
<h4 data-id="heading-9">服务端配置</h4>
<p>服务端的MCP功能通过<code>application.properties</code>文件进行配置：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.mcp.server.name=mcp-server-demo
spring.ai.mcp.server.version=0.0.1
spring.ai.mcp.server.protocol=SSE
spring.ai.mcp.server.capabilities.resource=true
spring.ai.mcp.server.capabilities.tool=true
spring.ai.mcp.server.capabilities.completion=true
spring.ai.mcp.server.capabilities.prompt=true
spring.ai.mcp.server.streamable-http.mcp-endpoint=/mcp
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>spring.ai.mcp.server.name</code>：服务器名称</li>
<li><code>spring.ai.mcp.server.protocol</code>：通信协议，这里使用SSE（Server-Sent Events）</li>
<li><code>spring.ai.mcp.server.capabilities.*</code>：声明服务器支持的功能</li>
<li><code>spring.ai.mcp.server.streamable-http.mcp-endpoint</code>：MCP端点路径</li>
</ul>
<h3 data-id="heading-10">客户端实现详解</h3>
<h4 data-id="heading-11">创建MCP客户端</h4>
<p>MCP客户端连接到本地Ollama模型，并自动发现服务端提供的工具：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaConfig</span> {

    <span class="hljs-meta">@Value("${ai.user.input}")</span>
    <span class="hljs-keyword">private</span> String userInput;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClient.Builder <span class="hljs-title function_">chatClientBuilder</span><span class="hljs-params">(OllamaChatModel ollamaChatModel)</span> {
        <span class="hljs-keyword">return</span> ChatClient.builder(ollamaChatModel);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> CommandLineRunner <span class="hljs-title function_">predefinedQuestions</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder
            , ToolCallbackProvider tools, ConfigurableApplicationContext context)</span> {

        System.out.println(tools.getToolCallbacks());
        <span class="hljs-keyword">return</span> args -&gt; {
            <span class="hljs-type">var</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientBuilder
                    .defaultToolCallbacks(tools)
                    .build();

            System.out.println(<span class="hljs-string">"\n&gt;&gt;&gt; QUESTION: "</span> + userInput);
            System.out.println(<span class="hljs-string">"\n&gt;&gt;&gt; ASSISTANT: "</span> + chatClient.prompt(userInput).call().content());

            context.close();
        };
    }
}
</code></pre>
<p><strong>关键技术点</strong>：</p>
<ol>
<li>通过<code>ToolCallbackProvider</code>自动获取所有可用的工具（包括通过MCP发现的远程工具）</li>
<li>将这些工具配置到<code>ChatClient</code>中，使其可以在与模型交互时自动选择合适的工具</li>
</ol>
<h4 data-id="heading-12">客户端配置</h4>
<p>客户端的配置同样在<code>application.properties</code>文件中：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.model.chat=ollama
spring.ai.ollama.base-url=http://localhost:11434
spring.ai.ollama.chat.options.model=llama3.2:1b
spring.ai.mcp.client.name=mcp-client-demo
spring.ai.mcp.client.toolcallback.enabled=true
spring.ai.mcp.client.sse.connections.mcp-server-demo.url=http://localhost:8080
ai.user.input=What tools are available?
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>spring.ai.model.chat=ollama</code>：使用Ollama作为聊天模型</li>
<li><code>spring.ai.ollama.*</code>：配置Ollama连接信息</li>
<li><code>spring.ai.mcp.client.toolcallback.enabled=true</code>：启用MCP工具回调</li>
<li><code>spring.ai.mcp.client.sse.connections.*</code>：配置MCP服务器连接</li>
</ul>
<h3 data-id="heading-13">实际使用示例</h3>
<h4 data-id="heading-14">示例1：获取天气预报</h4>
<p>当用户发送如下请求时：</p>
<pre><code class="hljs language-rust" lang="rust">What<span class="hljs-symbol">'s</span> the weather forecast <span class="hljs-keyword">for</span> <span class="hljs-title class_">New</span> York City?
</code></pre>
<p>系统的执行流程如下：</p>
<ol>
<li>客户端将请求发送给Ollama模型</li>
<li>模型分析请求，发现需要获取纽约的天气预报</li>
<li>模型识别到可以使用<code>getWeatherForecastByLocation</code>工具</li>
<li>客户端调用该工具（通过MCP协议）</li>
<li>服务端执行天气查询并返回结果</li>
<li>模型处理结果并返回给用户</li>
</ol>
<h4 data-id="heading-15">示例2：使用文本转换工具</h4>
<p>当用户发送如下请求时：</p>
<pre><code class="hljs language-sql" lang="sql">Please <span class="hljs-keyword">convert</span> <span class="hljs-string">'hello world'</span> <span class="hljs-keyword">to</span> uppercase.
</code></pre>
<p>系统会使用<code>toUpperCase</code>工具将文本转换为大写，整个过程对用户完全透明。</p>
<h3 data-id="heading-16">MCP的工作原理</h3>
<p>MCP协议的工作原理可以概括为以下几个步骤：</p>
<ol>
<li><strong>服务注册</strong>：MCP服务器启动时，会注册所有标记为工具的方法</li>
<li><strong>客户端发现</strong>：MCP客户端连接到服务器后，自动发现可用的工具</li>
<li><strong>工具调用</strong>：当模型需要使用工具时，通过MCP协议调用远程工具</li>
<li><strong>结果处理</strong>：工具执行结果通过MCP返回给客户端，然后由模型进行处理</li>
</ol>
<p>这种机制使得模型可以无缝地使用各种外部工具，而不需要了解工具的具体实现细节。</p>
<h3 data-id="heading-17">实现细节与最佳实践</h3>
<h4 data-id="heading-18">工具方法设计</h4>
<p>在设计MCP工具方法时，应遵循以下最佳实践：</p>
<ol>
<li><strong>清晰的描述</strong>：使用详细的<code>description</code>参数，帮助模型理解工具的用途</li>
<li><strong>合理的参数</strong>：使用简单明了的参数类型和名称</li>
<li><strong>结构化返回</strong>：返回格式良好的结构化数据</li>
<li><strong>错误处理</strong>：妥善处理可能发生的异常</li>
</ol>
<h4 data-id="heading-19">性能优化</h4>
<p>对于生产环境的MCP应用，可以考虑以下性能优化策略：</p>
<ol>
<li><strong>工具缓存</strong>：缓存工具发现结果，减少重复发现开销</li>
<li><strong>请求批处理</strong>：批量处理相关的工具调用</li>
<li><strong>异步执行</strong>：使用异步方式执行耗时的工具调用</li>
<li><strong>连接池管理</strong>：合理管理MCP连接池</li>
</ol>
<h3 data-id="heading-20">MCP与其他方案的对比</h3>
<p>相比传统的API集成方式，MCP具有以下优势：</p>



































<table><thead><tr><th>特性</th><th>MCP</th><th>传统API</th></tr></thead><tbody><tr><td>自动发现</td><td>✓</td><td>✗</td></tr><tr><td>标准接口</td><td>✓</td><td>各厂商不同</td></tr><tr><td>模型理解</td><td>描述性元数据</td><td>无</td></tr><tr><td>跨平台兼容</td><td>✓</td><td>需要适配</td></tr><tr><td>集成复杂度</td><td>低</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-21">未来发展与趋势</h3>
<p>随着MCP协议的不断发展，我们可以期待：</p>
<ol>
<li>更多框架和平台对MCP的支持</li>
<li>更丰富的工具生态系统</li>
<li>安全性和隐私保护的增强</li>
<li>更高效的通信协议和机制</li>
</ol>
<h3 data-id="heading-22">结论</h3>
<p>MCP协议为AI模型与外部工具的交互提供了一种标准化、高效的解决方案。通过Spring AI的实现，Java开发者可以轻松构建支持MCP的应用程序，实现模型与工具的无缝集成。本文介绍的示例项目展示了MCP的基本功能和使用方法，希望能为开发者提供有价值的参考。</p>
<p>随着AI技术的不断发展，MCP这样的标准化协议将在AI应用生态系统中发挥越来越重要的作用，推动AI应用的普及和创新。</p>
<h3 data-id="heading-23">参考文献</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fintroduction" target="_blank" title="https://modelcontextprotocol.io/introduction" ref="nofollow noopener noreferrer">MCP官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2F3-concepts%2Fmodel-context-protocol.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/3-concepts/model-context-protocol.html" ref="nofollow noopener noreferrer">Spring AI MCP文档</a></li>
<li>Anthropic, "Model Context Protocol: A New Standard for AI Tool Integration", 2024</li>
</ol>
<hr/>
<h3 data-id="heading-24">代码链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftree_boss%2Fmcp-demos.git" target="_blank" title="https://gitee.com/tree_boss/mcp-demos.git" ref="nofollow noopener noreferrer">gitee.com/tree_boss/m…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于2D人物冒险游戏闪现逻辑的实现方法]]></title>    <link>https://juejin.cn/post/7571306072422989866</link>    <guid>https://juejin.cn/post/7571306072422989866</guid>    <pubDate>2025-11-11T15:16:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422989866" data-draft-id="7571299394345812010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于2D人物冒险游戏闪现逻辑的实现方法"/> <meta itemprop="keywords" content="游戏开发"/> <meta itemprop="datePublished" content="2025-11-11T15:16:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="祭璃妖"/> <meta itemprop="url" content="https://juejin.cn/user/2534812613608265"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于2D人物冒险游戏闪现逻辑的实现方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2534812613608265/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    祭璃妖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T15:16:39.000Z" title="Tue Nov 11 2025 15:16:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>新人第一篇带有纪念性的文章<br/>
游戏demo来源于b站up主M_Studio麦扣老师的教程《勇士传说》，在此基础上进行的拓展内容实现</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7823f42e2b546d8a511552f4b466010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Wt55KD5aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763478999&amp;x-signature=w1zbUtvs6haRoh9suyCdjZWb3IU%3D" alt="闪现.gif" loading="lazy"/></p>
<p align="center">这是成品，除了隐现动画没有素材，其他都达到了我想要实现的效果😋</p>
<p>当然我自己不太会这个逻辑，于是我寻求了gpt的帮助</p>
<p>核心逻辑如下：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">Slash</span>(InputAction.CallbackContext context)
{
    if (fadeCoroutine != null)
    {
        <span class="hljs-built_in">StopCoroutine</span>(fadeCoroutine);<span class="hljs-comment">//防止上次协程没清空</span>
    }
    fadeCoroutine = <span class="hljs-built_in">StartCoroutine</span>(FadeOutAndBack());<span class="hljs-comment">//启动新协程</span>
}
</code></pre>
<p>在这里使用了StartCoroutine启动协程后调用IEnumerator状态机来实现闪现，为什么要使用协程呢？</p>
<p>1.不用手写计时器、不用在 Update() 里管理状态机，逻辑更清晰</p>
<p>2.避免阻塞主线程，协程在每帧之间自动暂停，不会卡住游戏</p>
<p>3.可以嵌套使用其他协程（渐隐 → 冲刺 → 停顿 → 渐显），方便管理各种状态</p>
<p>底下是管理各种协程的状态机</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function"><span class="hljs-keyword">private</span> IEnumerator <span class="hljs-title">FadeOutAndBack</span>()</span>
{
    <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-title">StartCoroutine</span>(<span class="hljs-params">FadeTo(<span class="hljs-number">0f</span>, fadeDuration</span>))</span>;<span class="hljs-comment">//启动渐隐协程</span>
    <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-title">StartCoroutine</span>(<span class="hljs-params">Dash(dashDistance, dashDuration</span>))</span>;<span class="hljs-comment">//启动冲刺协程</span>
    <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">WaitForSeconds</span>(<span class="hljs-params">invisibleTime</span>)</span>;<span class="hljs-comment">//等待一段时间</span>
    <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-title">StartCoroutine</span>(<span class="hljs-params">FadeTo(<span class="hljs-number">1f</span>, fadeDuration</span>))</span>;<span class="hljs-comment">//启动渐显协程</span>
    fadeCoroutine = <span class="hljs-literal">null</span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>当然最重要的是我们要实现在一段时间内渐隐，渐显，涉及到时间的持续用协程是比较方便的。</p>
<p>因为Unity给了我们很方便的工具去调用，比如在IEnumerator状态机里面调用yield return new WaitForSeconds(0.5f);可以让协程暂停0.5秒而不会影响主线程的逻辑，防止阻塞。</p>
<pre><code class="hljs language-ini" lang="ini"> private IEnumerator Dash(float distance, float duration)
{
    float <span class="hljs-attr">faceSign</span> = Mathf.Sign(transform.localScale.x)<span class="hljs-comment">;</span>
    Vector2 <span class="hljs-attr">dir</span> = new Vector2(-faceSign, <span class="hljs-number">0</span>f).normalized<span class="hljs-comment">; // 朝向向量，向右为 (1,0)</span>
    Vector2 <span class="hljs-attr">start</span> = rb.position<span class="hljs-comment">;//起始位置</span>
    Vector2 <span class="hljs-attr">target</span> = start + dir * distance<span class="hljs-comment">;//目标位置</span>
    <span class="hljs-attr">rb.velocity</span> = new Vector2(<span class="hljs-number">0</span>f, rb.velocity.y)<span class="hljs-comment">;//设置冲刺的时候水平速度先归零</span>
    rb.MovePosition(target)<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>可以看到人物调用了MovePosition这个方法来实现快速移动，根据unity官方手册我们可以看到关于他的描述：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e93f6d715c214f95937204b1a98a797e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Wt55KD5aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763478999&amp;x-signature=6wnBwIOVQx4UUiqcy5cjK%2FzHiC8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>MovePositon是在调用后的下一次物理更新（应该就是物理帧）将物体移动至指定位置，并且在移动过程中检测物理碰撞，相比于直接改变transform.position来说更不容易穿墙，但是为什么能穿过野猪呢？</p>
<p>我在代码里面并没有特别写关于忽略闪现过程中敌人触发器的碰撞，所以我找到了野猪身上有关伤害触发的代码</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">OnTriggerStay2D</span><span class="hljs-params">(Collider2D collision)</span>
</span>{
    collision.<span class="hljs-built_in">GetComponent</span>&lt;Character&gt;()?.<span class="hljs-built_in">TakeDamage</span>(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>可以看到我调用的是OnTriggerStay2D方法，再次查询Unity手册可以看到关于OnTriggerStay2D方法的描述：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96d3a6be60234732a830b81176bb1312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Wt55KD5aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763478999&amp;x-signature=%2BifqlfAUzp45N2H%2B0c7wpPMcUZE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>稍微有点看不懂，问过gpt之后可以知道：OnTriggerStay2D是两个collider触发器在一帧内有重叠就会触发这个方法，所以我们可以得出为什么MovePosition可以穿过野猪而不能穿墙的结论了。</p>
<p>由于MovePosition的操作在两次物理帧之间完成，开始的第一帧我没有与野猪重叠，并且在下一帧我将人物移动至目标点，这两帧期间我的人物并没有与野猪产生重叠，所以不会触发OnTriggerStay2D，那么同理OnTriggerEnter2D和OnTriggerExit2D也不会被触发，因为并没有产生实际的触发器重叠。</p>
<p>ok闪现的逻辑讲完了我们来看看人物逐渐消失又逐渐出现的实现逻辑，先来看看源代码：</p>
<pre><code class="hljs language-ini" lang="ini"> private IEnumerator FadeTo(float targetAlpha, float duration)
{
    Color <span class="hljs-attr">c</span> = sprite.color<span class="hljs-comment">;//由于color是值类型，所以不能单独改color.a，这里用c来改</span>
    float <span class="hljs-attr">startAlpha</span> = c.a<span class="hljs-comment">;</span>
    if (Mathf.Approximately(startAlpha, targetAlpha) || duration &lt;= 0f)
    {
        <span class="hljs-attr">c.a</span> = targetAlpha<span class="hljs-comment">;</span>
        <span class="hljs-attr">sprite.color</span> = c<span class="hljs-comment">;</span>
        yield break<span class="hljs-comment">;</span>
    }
    float <span class="hljs-attr">t</span> = <span class="hljs-number">0</span>f<span class="hljs-comment">;</span>
    while (t &lt; duration)
    {
        t += Time.deltaTime<span class="hljs-comment">;</span>
        float <span class="hljs-attr">a</span> = Mathf.Lerp(startAlpha, targetAlpha, t / duration)<span class="hljs-comment">;//核心实现</span>
        <span class="hljs-attr">c.a</span> = a<span class="hljs-comment">;</span>
        <span class="hljs-attr">sprite.color</span> = c<span class="hljs-comment">;</span>
        yield return null<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">c.a</span> = targetAlpha<span class="hljs-comment">;</span>
    <span class="hljs-attr">sprite.color</span> = c<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>其实核心逻辑就是如何实现从0到1的平滑过渡，这一点的话我一开始有想到通过动画器自带的平滑过渡来实现，但是实际写下来发现人物的隐现并不能跟随上一帧人物的形态，隐现的时候只会执行动画中的人物动画，所以我放弃了在动画器里去实现这个功能。</p>
<p>于是我询问了gpt（哎呀这gpt怎么这么好用），他给出的核心方法就是Mathf.Lerp，查询unity手册可以看到：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd17c9558e4b4c70974b7ec61fe12b4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Wt55KD5aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763478999&amp;x-signature=mbCinU2dEahYnittyxmvkMVjd4c%3D" alt="" width="60%" loading="lazy"/>​</p>
<p>这个方法可以根据最后一个参数来平滑地从第一个参数变化到第二个参数，这行代码</p>
<pre><code class="hljs language-ini" lang="ini">float <span class="hljs-attr">a</span> = Mathf.Lerp(startAlpha, targetAlpha, t / duration)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>就是实现隐现的核心，duration是隐现的持续时间，t/duration就可以得到一个0-1的值，而t是根据Time.deltatime变化的，每次更新只会变化非常小的一个单位，所以能够很平滑地从0过渡到1，而float a就是决定人物color.a的参数，而我们的隐现逻辑又是在协程里实现的，整个过程是异步进行的，并且运行平滑，所以就实现了人物隐现的功能。</p>
<p>好了这篇文章到这里就差不多结束了，最后跟大家讲一点题外话吧。</p>
<p>本人是北京科技大学的一名大二学生，现在大二上，大一当了一年做题蛆，把绩点卷到了保研线，当时也不知道读研能干什么，只知道大家都在说读研究生好找工作，都支持读研，所以在入学的时候我的潜目标就是把绩点卷起来然后保研，然后找个好工作。</p>
<p>然而在大二的时候我加入了我们学校勤敏轩“806”实验室里面的游戏部，因为我十分热爱游戏开发，也在大一卷绩点的同时自学了Unity和C#的一些知识，进来之后我看到了许多开发能力很强的大佬们，他们不在乎绩点，每天泡在实验室旷课写代码，就那时候我觉得我大一一年都浪费了，卷的绩点好像也没那么有用了，我的最终目标是开发游戏，最后入职游戏公司跟他们一起做游戏。那么反过来想，如果我是游戏公司的HR，我会招一个有绩点，有学历，但是Unity的一些基本操作都不熟悉，没有开发过完整游戏项目的一个人吗？我想是不会的。</p>
<p>所以思索再三，我下定决心抛弃我大一卷过的所有成绩，放弃保研，全力投入游戏开发，提升自己的能力，跟我们游戏部成员沟通之后，先找到了这款较为完整的教程，带我们熟悉Unity的一些基本操作，之后再开发属于自己的游戏。（其实还有一个主要原因是我咨询了学长，学长说不做引擎的话，读研对游戏开发没什么帮助）</p>
<p>我在跟教程的过程中想尝试自己实现一些炫酷的闪现功能，有感而发写了这篇文章，顺便以此来纪念我从做题蛆到一名游戏开发者的蜕变。</p>
<p>大家关于游戏开发这方面有什么好的见解也欢迎与我进行交流😋（什么都行）</p>
<p>感谢您观看我的文章</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入JavaScript数组：从内存模型到遍历性能，打造高性能代码的基石]]></title>    <link>https://juejin.cn/post/7571338749197991986</link>    <guid>https://juejin.cn/post/7571338749197991986</guid>    <pubDate>2025-11-11T15:58:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197991986" data-draft-id="7571126773809381386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入JavaScript数组：从内存模型到遍历性能，打造高性能代码的基石"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T15:58:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1203911294726"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入JavaScript数组：从内存模型到遍历性能，打造高性能代码的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1203911294726
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T15:58:07.000Z" title="Tue Nov 11 2025 15:58:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入JavaScript数组：从内存模型到遍历性能，打造高性能代码的基石</h2>
<p>当我们谈起JavaScript的数据结构，数组无疑是其中最常用、最基础的一个。无论是简单的数据列表，还是复杂的算法实现，数组都扮演着核心角色。然而，你真的了解你手中的数组吗？它是如何在内存中存在的？为什么各种遍历方法性能迥异？动态扩容的背后又隐藏着什么代价？本文将带你深入JavaScript数组的内部世界，从内存模型讲到遍历性能，助你写出更专业、更高性能的代码。</p>
<h3 data-id="heading-1">一、数组的本质：一段连续的线性内存空间</h3>
<p>在讨论任何高级特性之前，我们必须回归本质：<strong>数组是一种线性数据结构，在内存中占据一段连续的空间</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<span class="hljs-comment">;</span>
</code></pre>
<p>这行简单的代码背后，发生了什么呢？</p>
<ul>
<li><strong>栈内存（Stack）</strong> ：变量 <code>arr</code>本身被存储在栈内存中，它保存的是一个<strong>引用地址</strong>（一个指向堆内存中实际数组对象的指针）。</li>
<li><strong>堆内存（Heap）</strong> ：数组真正的数据 <code>[1, 2, 3, 4, 5, 6]</code>被存储在堆内存中。JavaScript引擎会为它申请一段<strong>连续的存储空间</strong>，依次存放每个元素。</li>
</ul>
<p>这种“连续”的特性，是数组最核心的优势，它使得通过索引（<code>index</code>）访问元素的时间复杂度为 O(1)，即无论数组多大，<code>arr[1000]</code>和 <code>arr[0]</code>的访问速度几乎一样快，因为地址可以直接通过“基地址 + 索引 * 元素大小”计算出来。</p>
<h4 data-id="heading-2">数组的创建与初始化</h4>
<p>我们通常用字面量方式创建数组。但当我们需要初始化一个长度已知、内容固定的数组时，有更优雅的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个长度为6，且每个元素初始值都为0的数组</span>
<span class="hljs-keyword">const</span> arr = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// 输出: [0, 0, 0, 0, 0, 0]</span>

<span class="hljs-comment">// 不推荐的方式：这只会创建一个长度为6的“空槽”数组</span>
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2); <span class="hljs-comment">// 输出: [ &lt;6 empty items&gt; ]</span>
</code></pre>
<p><code>new Array(6)</code>创建了一个有6个空位（empty）的数组，直接访问这些空位会返回 <code>undefined</code>，但 <code>fill</code>方法可以安全地填充这些位置。明确初始化是避免意外行为的最佳实践。</p>
<h3 data-id="heading-3">二、遍历数组的“十八般武艺”与性能抉择</h3>
<p>如何遍历数组？JavaScript提供了多种方法，但它们的性能特点和适用场景大不相同。</p>
<h4 data-id="heading-4">1. 王者：经典<code>for</code>循环（计数循环）</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = (new Array(<span class="hljs-number">6</span>)).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">; // 关键步骤：缓存数组长度</span>

for(let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
    console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>为什么它性能最好？</strong></p>
<ul>
<li><strong>与CPU工作方式契合</strong>：<code>for</code>循环是纯粹的计数循环，逻辑简单，现代JavaScript引擎（如V8）可以对其进行极强的优化（例如循环展开）。</li>
<li><strong>减少属性查找</strong>：通过在循环外缓存 <code>arr.length</code>，避免了每次循环都查询 <code>length</code>属性的开销。虽然引擎也会优化，但显式缓存是更保险的性能习惯。</li>
<li><strong>控制力强</strong>：可以使用 <code>break</code>和 <code>continue</code>随时中断或跳过循环。</li>
</ul>
<h4 data-id="heading-5">2. 新贵：<code>for...of</code>循环</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">for</span>(const a of arr) {
    console<span class="hljs-selector-class">.log</span>(a);
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li><strong>语法简洁，可读性极佳</strong>：直接迭代元素值，无需操作索引。</li>
<li><strong>性能优异</strong>：在现代引擎中，<code>for...of</code>循环的性能非常接近传统的 <code>for</code>循环，是<strong>可读性与性能的完美平衡点</strong>。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>无法直接获取当前元素的索引（但可以通过其他方式间接获得）。</li>
</ul>
<h4 data-id="heading-6">3. 函数式优雅：<code>forEach</code>与<code>map</code></h4>
<p><strong><code>forEach</code>：</strong> ​ 为每个元素执行一次回调函数。</p>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>性能开销</strong>：涉及函数的<strong>入栈和出栈</strong>操作，比纯循环的开销大。</li>
<li><strong>无法中断</strong>：不能使用 <code>break</code>语句中途跳出循环。</li>
</ul>
<p><strong><code>map</code>：</strong> ​ 在遍历的同时，创建一个新的数组。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> newArr = arr.<span class="hljs-built_in">map</span>(item =&gt; item + <span class="hljs-number">1</span>); <span class="hljs-comment">// [2, 3, 4, 5, 6, 7]</span>
</code></pre>
<p><code>map</code>具有和 <code>forEach</code>相同的性能特点。它用于<strong>数据转换</strong>，如果你需要新数组，使用 <code>map</code>；如果只是遍历，请选择 <code>forEach</code>或其他循环。</p>
<h4 data-id="heading-7">4. 误区：<code>for...in</code>循环</h4>
<p><strong><code>for...in</code>是为遍历普通对象的可枚举属性而设计的，并非用于数组！</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 不推荐用于数组！</span>
<span class="hljs-built_in">for</span>(let key in arr) {
    console<span class="hljs-selector-class">.log</span>(key, arr[key]); <span class="hljs-comment">// key 是字符串类型的索引 "0", "1"...</span>
}

<span class="hljs-comment">// 它的真正用途是遍历对象</span>
const obj = { name: <span class="hljs-string">'小明'</span>, age: <span class="hljs-number">18</span> };
<span class="hljs-built_in">for</span>(let k in obj) {
    console<span class="hljs-selector-class">.log</span>(k, obj[k]); <span class="hljs-comment">// name 小明, age 18</span>
}
</code></pre>
<p><strong>为什么不用于数组？</strong></p>
<ul>
<li><strong>遍历原型链</strong>：它会遍历对象原型链上的所有可枚举属性，除非使用 <code>hasOwnProperty</code>判断，否则可能遍历出意外属性。</li>
<li><strong>性能低下</strong>：它的遍历机制比 <code>for</code>或 <code>for...of</code>慢得多。</li>
<li><strong>顺序不确定</strong>：虽然现在规范规定了属性顺序，但依赖 <code>for...in</code>的遍历顺序依然是不安全的。</li>
</ul>
<p><strong>结论：对象用 <code>for...in</code>，数组用 <code>for</code>或 <code>for...of</code>。</strong></p>
<h3 data-id="heading-8">三、动态数组的代价：扩容与“搬家”</h3>
<p>在强类型语言（如C++、Java）中，数组的大小通常是固定的。但JavaScript的数组是<strong>动态的</strong>，你可以随时使用 <code>push</code>、<code>pop</code>、<code>shift</code>等方法改变其长度。 这带来了便利，但也隐藏着性能陷阱。当数组不断增长，初始分配的内存不够用时，会发生什么？</p>
<ol>
<li><strong>申请新家</strong>：JavaScript引擎会申请一块更大的、连续的内存空间（例如，当前容量的2倍）。</li>
<li><strong>搬家</strong>：将原数组中的所有元素，逐个复制到新的内存空间中。</li>
<li><strong>销毁旧家</strong>：释放原先占用的较小内存块。</li>
</ol>
<p>这个“搬家”过程（重新分配内存和复制数据）的开销是 <strong>O(n)</strong> ​ 的，即与数组长度成正比。在频繁向大型数组添加元素的场景下，这种开销不容忽视。 相比之下，<strong>链表</strong>​ 这种离散的数据结构，添加元素不需要搬迁，只需修改指针。因此，在需要频繁在头部或中部进行插入/删除操作时，链表可能更有优势。但对于<strong>绝大多数需要快速随机访问的场景，数组由于其O(1)的访问效率，依然是更优的选择</strong>。引擎的优化已经非常智能，使得动态数组在多数情况下表现卓越。</p>
<h3 data-id="heading-9">四、进阶知识：循环与闭包的相互作用</h3>
<p>考虑以下经典面试题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 输出什么？</span>
    }, <span class="hljs-number">1000</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/758ddd9e7de34302b015aa527ea0e36e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTIwMzkxMTI5NDcyNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763481487&amp;x-signature=GVRmQkBOpOOG46HX5mfmHGuQ090%3D" alt="5f38222591efefd79d9a10ae65e492c6.png" loading="lazy"/></p>
<p>答案是按顺序输出 <code>0</code>到 <code>9</code>。为什么呢？</p>
<ul>
<li><strong><code>let</code>的块级作用域</strong>：<code>let</code>声明的 <code>i</code>在每次循环中都有一个<strong>独立的词法环境</strong>。可以理解为，循环体执行了10次，创建了10个不同的 <code>i</code>。</li>
<li><strong>闭包</strong>：<code>setTimeout</code>的回调函数形成了一个闭包，引用了它<strong>定义时所在作用域</strong>的变量 <code>i</code>。由于有10个不同的 <code>i</code>，每个回调函数都“记住”了对应的那个值。</li>
</ul>
<p><strong>内存变化</strong>： 最初，变量 <code>i</code>存在于栈内存中。但由于被闭包引用，它的生命周期被延长，JavaScript引擎会将其从栈中“提升”到堆内存中存储，以确保在 <code>for</code>循环结束后，回调函数依然能访问到正确的 <code>i</code>值。这就是闭包延长变量生命周期的机制。 如果这里使用 <code>var i</code>，由于 <code>var</code>没有块级作用域，整个循环共享同一个全局或函数作用域的 <code>i</code>。当回调函数执行时，循环早已结束，<code>i</code>的值已经是10，所以会打印10个10。</p>
<h3 data-id="heading-10">总结</h3>



































<table><thead><tr><th>特性/方法</th><th>优点</th><th>缺点</th><th>使用场景</th></tr></thead><tbody><tr><td>**经典 <code>for</code>**​</td><td><strong>性能极致</strong>，控制力强</td><td>代码稍显繁琐</td><td><strong>性能敏感</strong>场景，需要中断循环时</td></tr><tr><td>**<code>for...of</code>**​</td><td>性能优秀，<strong>语法简洁可读</strong>​</td><td>无法直接获取索引</td><td><strong>日常遍历的首选</strong>，兼顾可读性与性能</td></tr><tr><td>**<code>forEach/map</code>**​</td><td>函数式风格，代码优雅</td><td><strong>性能有开销</strong>，无法中断</td><td>无需中断的简单遍历(<code>forEach</code>)或需生成新数组(<code>map</code>)</td></tr><tr><td>**<code>for...in</code>**​</td><td>用于遍历对象属性</td><td><strong>绝对不要用于遍历数组</strong>​</td><td>遍历<strong>对象</strong>的可枚举属性</td></tr></tbody></table>
<p>理解数组的连续内存模型，是理解其高效随机访问的基础；明智地选择遍历方法，是编写高性能JavaScript代码的关键一步；而知晓动态扩容的代价，则能让你在复杂应用中进行更合理的数据结构选型。希望本文能帮助你重新审视这个最熟悉的“陌生人”，并在未来的开发中更好地驾驭它。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么说数组是 JavaScript 开发者必须精通的数据结构？]]></title>    <link>https://juejin.cn/post/7571258854901514283</link>    <guid>https://juejin.cn/post/7571258854901514283</guid>    <pubDate>2025-11-11T14:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854901514283" data-draft-id="7571334572768526379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么说数组是 JavaScript 开发者必须精通的数据结构？"/> <meta itemprop="keywords" content="数据结构,前端,算法"/> <meta itemprop="datePublished" content="2025-11-11T14:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么说数组是 JavaScript 开发者必须精通的数据结构？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:58:11.000Z" title="Tue Nov 11 2025 14:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当被问及 “数据结构有哪些” 时，若只罗列 “数组、链表、栈、队列、树”，难免显得单薄且缺乏逻辑。其实，数据结构可清晰划分为两大核心类别 ——线性结构与非线性结构，各类结构的设计逻辑和应用场景各有侧重，理解其本质能让我们更灵活地运用。​</p>
<p>线性结构是数据按 “一对一” 顺序排列的结构，日常开发中最为常用，核心成员包括数组、链表、栈和队列。其中，数组堪称 “万能基础款”，凭借连续的内存空间实现高效随机访问，操作简单、性能稳定，是各类场景的首选；而链表虽不及数组普及，却以离散的内存分配打破了空间连续性限制，能灵活应对动态增删场景，完美弥补了数组的短板。再看栈与队列，二者虽均基于线性逻辑，但遵循截然不同的操作规则：栈是 “先进后出（FILO）” 的 “存取容器”，常见于函数调用、表达式求值等场景；队列则是 “先进先出（FIFO）” 的 “排队模型”，广泛应用于任务调度、消息队列等需求中。​</p>
<p>非线性结构则是数据呈 “一对多” 或 “多对多” 关联的结构，其中树结构最为核心，尤其以二叉树为考察重点 —— 无论是算法面试还是实际开发中的搜索、排序场景，二叉树及其衍生结构（如二叉搜索树、红黑树）都占据重要地位。​</p>
<p>接下来，我们将聚焦线性结构中的 “核心成员”—— 数组，详细拆解它的底层原理、使用场景与实战技巧。</p>
<h2 data-id="heading-0">新建数组</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> arr = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
<span class="hljs-comment">//浏览器显示  [空 ×6]</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49fd20d126c44d9b3404e2ab47884cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477891&amp;x-signature=AOjmESSCv8JzqFPTYEaLVylh74o%3D" alt="image.png" loading="lazy"/></p>
<p><strong>用 <code>new Array(length)</code> 创建的数组，在没有初始化之前，它的元素是 “空” 的（empty），而不是 <code>undefined</code> 或其他值。</strong></p>
<h2 data-id="heading-1">遍历数组   for(i=0;i&lt;len;i++)</h2>
<p>我们来看这段代码：</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">const</span> arr = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>; 
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;i&lt;len;i++){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr[i]);
}
</code></pre>
<p>在循环条件中直接使用 <code>arr.length</code> 会有微小的性能开销。</p>
<p><strong>原因如下：</strong></p>
<p>在 JavaScript 中，数组是一个特殊的对象。<code>arr.length</code> 不是一个简单的变量，而是一个<strong>访问器属性（Accessor Property）</strong> 。这意味着，每次你访问 <code>arr.length</code> 时，JavaScript 引擎实际上是在调用一个隐藏的函数来获取数组的长度。</p>
<p>在早期的 JavaScript 引擎中，这个函数调用的开销是比较明显的。如果在一个循环中（例如执行 10000 次）每次都去调用它，累积的开销就会变得可观。</p>
<h2 data-id="heading-2">遍历数组 foreach</h2>
<p>我们接着说 <code>forEach</code>，你提到的两点 ——<strong>不能 <code>break</code></strong> 和 <strong>性能相对较差</strong>—— 非常关键，我们来详细展开，并补充一些你可能忽略的细节。</p>
<hr/>
<h2 data-id="heading-3">1. <code>forEach</code> 基本用法</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index, array</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index, array);
});
</code></pre>
<ul>
<li>
<p><strong>回调参数</strong>：</p>
<ul>
<li><code>item</code>：当前遍历的元素（必选）</li>
<li><code>index</code>：当前元素的索引（可选）</li>
<li><code>array</code>：正在遍历的原数组（可选）</li>
</ul>
</li>
<li>
<p><strong>返回值</strong>：<code>undefined</code>（无论回调里写什么 <code>return</code>，都不会改变这一点）</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">（1）无法中途退出</h3>
<p><code>forEach</code> 没有像 <code>for</code> 循环那样的 <code>break</code> 或 <code>continue</code> 机制。</p>
<ul>
<li>
<p><strong>想提前终止？做不到</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (item === <span class="hljs-number">2</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 报错：Illegal break statement</span>
});
</code></pre>
</li>
<li>
<p><strong>想跳过当前元素？用 <code>return</code> 模拟 <code>continue</code></strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (item === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 跳过当前迭代，进入下一次</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item); <span class="hljs-comment">// 输出 1, 3</span>
});
</code></pre>
</li>
</ul>
<h3 data-id="heading-5"><code>map</code></h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// map</span>
<span class="hljs-comment">// 作用：遍历数组，并对数组中的每个元素进行指定操作（加工/转换），</span>
<span class="hljs-comment">//      然后将所有操作结果收集起来，返回一个全新的数组。</span>
<span class="hljs-comment">// 核心：不改变原数组，返回一个长度相同、值经过转换的新数组。</span>
<span class="hljs-comment">// 适用场景：当你需要从一个数组“派生”出另一个结构相似但值不同的数组时。</span>

<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>];
<span class="hljs-keyword">const</span> newArr = arr.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item + <span class="hljs-number">1</span>); <span class="hljs-comment">// 对每个元素加 1</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);    <span class="hljs-comment">// 输出: [1, 2, 3, 4, 5, 6] (原数组未改变)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newArr); <span class="hljs-comment">// 输出: [2, 3, 4, 5, 6, 7] (新数组)</span>

<span class="hljs-comment">// 回调函数参数详解：</span>
<span class="hljs-comment">// item: 当前正在处理的数组元素 (必选)</span>
<span class="hljs-comment">// index: 当前元素在数组中的索引 (可选)</span>
<span class="hljs-comment">// array: 调用 map 方法的原数组本身 (可选)</span>
<span class="hljs-keyword">const</span> doubledWithIndex = arr.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Index <span class="hljs-subst">${index}</span>: <span class="hljs-subst">${item * <span class="hljs-number">2</span>}</span>`</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(doubledWithIndex); <span class="hljs-comment">// 输出: ["Index 0: 2", "Index 1: 4", "Index 2: 6", ...]</span>

<span class="hljs-comment">// 与 forEach 的区别：</span>
<span class="hljs-comment">// 1. forEach 仅用于遍历，没有返回值（返回 undefined）。</span>
<span class="hljs-comment">// 2. map 会返回一个新数组，更适合数据转换。</span>
<span class="hljs-comment">// 简单说：想“生成新数组”用 map，想“单纯遍历做操作”用 forEach。</span>
</code></pre>
<hr/>
<h3 data-id="heading-6"><code>for...of</code></h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// for...of</span>
<span class="hljs-comment">// 作用：ES6 引入的一种新型循环语句，用于遍历可迭代对象（如 Array, Map, Set, String 等）。</span>
<span class="hljs-comment">// 核心：提供了一种更简洁、更具可读性的方式来遍历集合中的值。</span>
<span class="hljs-comment">// 优点：</span>
<span class="hljs-comment">//   - 语法简洁，可读性远超传统 for 循环。</span>
<span class="hljs-comment">//   - 避免了 for...in 循环遍历数组时可能遇到的原型链污染问题。</span>
<span class="hljs-comment">//   - 可以与 break, continue, return 配合使用。</span>

<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>];

<span class="hljs-comment">// 基本用法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item); <span class="hljs-comment">// 依次输出: 1, 2, 3, 4, 5, 6</span>
}

<span class="hljs-comment">// 如果需要索引，可以结合 Array.prototype.entries() 使用</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [index, item] <span class="hljs-keyword">of</span> arr.<span class="hljs-title function_">entries</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Index <span class="hljs-subst">${index}</span>: <span class="hljs-subst">${item}</span>`</span>); <span class="hljs-comment">// 依次输出: "Index 0: 1", "Index 1: 2", ...</span>
}

<span class="hljs-comment">// 与传统 for 循环对比</span>
<span class="hljs-comment">// 传统 for 循环：</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr[i]);
}
<span class="hljs-comment">// for...of 写法更简洁，意图更明确。</span>

<span class="hljs-comment">// 与 for...in 对比 (注意：不推荐用 for...in 遍历数组)</span>
<span class="hljs-comment">// for...in 遍历的是键名（索引），且可能遍历到数组原型上的属性。</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出: "0", "1", "2", ... (字符串形式的索引)</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-7">总结对比</h3>








































<table><thead><tr><th align="left">特性 / 方法</th><th align="left"><code>map()</code></th><th align="left"><code>for...of</code></th></tr></thead><tbody><tr><td align="left"><strong>核心用途</strong></td><td align="left"><strong>数据转换</strong>，生成新数组。</td><td align="left"><strong>遍历迭代</strong>，访问集合中的每个值。</td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left">返回一个<strong>新数组</strong>。</td><td align="left">无返回值 (<code>undefined</code>)。</td></tr><tr><td align="left"><strong>是否改变原数组</strong></td><td align="left">不改变（除非回调函数内手动修改）。</td><td align="left">不改变（除非循环体内手动修改）。</td></tr><tr><td align="left"><strong>适用对象</strong></td><td align="left">仅数组 (<code>Array</code>)。</td><td align="left">所有<strong>可迭代对象</strong> (<code>Array</code>, <code>String</code>, <code>Map</code>, <code>Set</code>, <code>arguments</code> 等)。</td></tr><tr><td align="left"><strong>中断循环</strong></td><td align="left">无法中断（必须遍历完所有元素）。</td><td align="left">可以使用 <code>break</code> 或 <code>continue</code> 中断或跳过。</td></tr><tr><td align="left"><strong>获取索引</strong></td><td align="left">回调函数的第二个参数即为索引。</td><td align="left">需要配合 <code>arr.entries()</code> 才能方便地获取索引。</td></tr></tbody></table>
<p><strong>何时使用？</strong></p>
<ul>
<li><strong>使用 <code>map</code></strong>：当你需要将一个数组的每个元素按照某种规则进行转换，最终得到一个新的数组时。例如，从 API 获取用户列表后，提取每个用户的 <code>id</code> 和 <code>name</code> 组成新数组。</li>
<li><strong>使用 <code>for...of</code></strong>：当你需要遍历一个数组或其他可迭代对象，对每个元素执行一些操作（如打印、累加、根据条件进行复杂处理等），并且可能需要中途停止循环时。它是日常遍历任务中替代传统 <code>for</code> 循环和 <code>forEach</code> 的优秀选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring事务传播机制深度解析：7种传播行为的使用场景和陷阱]]></title>    <link>https://juejin.cn/post/7571295102851350554</link>    <guid>https://juejin.cn/post/7571295102851350554</guid>    <pubDate>2025-11-11T16:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571295102851350554" data-draft-id="7571060853354348554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring事务传播机制深度解析：7种传播行为的使用场景和陷阱"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-11T16:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring事务传播机制深度解析：7种传播行为的使用场景和陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T16:04:20.000Z" title="Tue Nov 11 2025 16:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>在分布式系统和复杂业务场景中，事务的边界管理变得尤为重要。Spring框架提供了7种事务传播行为，但你是否真正理解它们的区别？是否曾在嵌套事务中踩过坑？本文将深入剖析每种传播机制的原理、使用场景和常见陷阱，帮助你在复杂业务中游刃有余地管理事务。</p>
</blockquote>
<h2 data-id="heading-1">什么是事务传播机制？</h2>
<p>事务传播机制（Transaction Propagation）定义了在多个事务方法相互调用时，事务应该如何传播。简单来说，它回答了"当前方法应该加入现有事务，还是开启新事务"的问题。</p>
<h3 data-id="heading-2">核心概念回顾</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Propagation</span> {
    REQUIRED,
    SUPPORTS,
    MANDATORY,
    REQUIRES_NEW,
    NOT_SUPPORTED,
    NEVER,
    NESTED
}
</code></pre>
<h2 data-id="heading-3">传播机制详解</h2>
<h3 data-id="heading-4">1. REQUIRED（默认） - 需要事务</h3>
<p><strong>定义</strong>：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新事务。</p>
<p><strong>使用场景</strong>：大多数业务方法的默认选择，确保操作在事务中执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 如果调用方有事务，则加入该事务</span>
        <span class="hljs-comment">// 如果调用方无事务，则创建新事务</span>
        orderMapper.insert(order);
        inventoryService.deductStock(order.getItems());
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">场景<span class="hljs-number">1</span>：无事务上下文
<span class="hljs-selector-attr">[开始REQUIRED事务]</span> → 执行方法 → <span class="hljs-selector-attr">[提交/回滚事务]</span>

场景<span class="hljs-number">2</span>：有事务上下文  
<span class="hljs-selector-attr">[加入现有事务]</span> → 执行方法 → <span class="hljs-selector-attr">[由外部事务统一提交/回滚]</span>
</code></pre>
<h3 data-id="heading-5">2. SUPPORTS - 支持事务</h3>
<p><strong>定义</strong>：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务方式执行。</p>
<p><strong>使用场景</strong>：查询操作，可以接受在有事务时加入事务，也可以无事务运行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.SUPPORTS)</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">findOrderById</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 如果有事务，在事务中查询（保证读取最新数据）</span>
        <span class="hljs-comment">// 如果无事务，直接查询（可能读取到旧数据）</span>
        <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.SUPPORTS, readOnly = true)</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">findUserOrders</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 只读查询，适合在只读副本上执行</span>
        <span class="hljs-keyword">return</span> orderMapper.selectByUserId(userId);
    }
}
</code></pre>
<p><strong>陷阱警告</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误使用：期望在无事务时自动创建事务</span>
<span class="hljs-meta">@Transactional(propagation = Propagation.SUPPORTS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateOrderStatus</span><span class="hljs-params">(Long orderId, String status)</span> {
    <span class="hljs-comment">// 如果调用方无事务，此更新操作不在事务中！</span>
    orderMapper.updateStatus(orderId, status);
    <span class="hljs-comment">// 可能造成数据不一致</span>
}
</code></pre>
<h3 data-id="heading-6">3. MANDATORY - 强制要求事务</h3>
<p><strong>定义</strong>：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</p>
<p><strong>使用场景</strong>：强制要求必须在事务上下文中执行的方法，防止误调用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuditService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.MANDATORY)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">auditOperation</span><span class="hljs-params">(String operation, String operator)</span> {
        <span class="hljs-comment">// 必须在事务中执行，否则抛出IllegalTransactionStateException</span>
        auditMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AuditLog</span>(operation, operator));
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuditService auditService;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 正确：在事务中调用</span>
        doBusinessLogic();
        auditService.auditOperation(<span class="hljs-string">"业务操作"</span>, <span class="hljs-string">"user1"</span>); <span class="hljs-comment">// 正常执行</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperationWithoutTx</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 错误：无事务上下文</span>
        doBusinessLogic();
        auditService.auditOperation(<span class="hljs-string">"业务操作"</span>, <span class="hljs-string">"user1"</span>); <span class="hljs-comment">// 抛出异常！</span>
    }
}
</code></pre>
<h3 data-id="heading-7">4. REQUIRES_NEW - 新建事务</h3>
<p><strong>定义</strong>：创建一个新事务，如果当前存在事务，则挂起当前事务。</p>
<p><strong>使用场景</strong>：需要独立事务的操作，如审计日志、消息发送等，不希望受外部事务回滚影响。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderNotification</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">try</span> {
            notificationMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Notification</span>(order));
            <span class="hljs-comment">// 即使外部事务回滚，通知记录仍然保存</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 本地事务回滚，不影响外部事务</span>
            log.error(<span class="hljs-string">"发送通知失败"</span>, e);
        }
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotificationService notificationService;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">try</span> {
            orderMapper.insert(order);
            inventoryService.deductStock(order.getItems());
            
            <span class="hljs-comment">// 独立事务发送通知</span>
            notificationService.sendOrderNotification(order);
            
        } <span class="hljs-keyword">catch</span> (InventoryException e) {
            <span class="hljs-comment">// 订单创建回滚，但通知可能已发送（如果通知先提交）</span>
            log.error(<span class="hljs-string">"库存不足，订单创建失败"</span>, e);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p><strong>执行时序</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">外部事务Tx1开始
  → 执行订单创建逻辑
  → 挂起Tx1，开启新事务Tx2
<span class="hljs-code">    → 发送通知（Tx2）
    → 提交Tx2
  → 恢复Tx1
  → 继续执行...
  → 提交/回滚Tx1（不影响已提交的Tx2）
</span></code></pre>
<h3 data-id="heading-8">5. NOT_SUPPORTED - 不支持事务</h3>
<p><strong>定义</strong>：以非事务方式执行，如果当前存在事务，则挂起当前事务。</p>
<p><strong>使用场景</strong>：不适合在事务中执行的操作，如调用外部系统、文件操作等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExternalService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callExternalSystem</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 不在事务中执行，避免长事务</span>
        externalApiClient.sendOrder(order);
        <span class="hljs-comment">// 即使外部事务回滚，外部调用不会回滚</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateReport</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 生成复杂报表，可能耗时较长</span>
        <span class="hljs-comment">// 不希望阻塞主事务</span>
        <span class="hljs-type">Report</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> reportService.generateOrderReport(orderId);
        fileService.saveReport(report);
    }
}
</code></pre>
<h3 data-id="heading-9">6. NEVER - 禁止事务</h3>
<p><strong>定义</strong>：以非事务方式执行，如果当前存在事务，则抛出异常。</p>
<p><strong>使用场景</strong>：明确禁止在事务中执行的方法，如某些性能敏感的批量操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchOperationService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NEVER)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsertOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-comment">// 明确要求不能在事务中执行</span>
        <span class="hljs-comment">// 如果调用方有事务，则抛出异常</span>
        <span class="hljs-keyword">for</span> (Order order : orders) {
            orderMapper.insert(order);
        }
    }
}

<span class="hljs-comment">// 错误用法示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WrongUsageService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBatchInTransaction</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 错误：在事务中调用NEVER方法</span>
        List&lt;Order&gt; orders = generateOrders();
        batchOperationService.batchInsertOrders(orders); <span class="hljs-comment">// 抛出异常！</span>
    }
}
</code></pre>
<h3 data-id="heading-10">7. NESTED - 嵌套事务</h3>
<p><strong>定义</strong>：如果当前存在事务，则在嵌套事务内执行；如果当前没有事务，则创建新事务。</p>
<p><strong>使用场景</strong>：复杂的业务操作，希望部分操作可以独立回滚而不影响整个事务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexOrderService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderWithNestedTransaction</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 在主事务的嵌套事务中执行</span>
        orderMapper.insert(order);
        
        <span class="hljs-keyword">try</span> {
            inventoryService.deductStock(order.getItems());
        } <span class="hljs-keyword">catch</span> (InventoryException e) {
            <span class="hljs-comment">// 库存操作失败，回滚到保存点</span>
            <span class="hljs-comment">// 但订单记录可能保留（取决于具体实现）</span>
            log.error(<span class="hljs-string">"库存操作失败，回滚嵌套事务"</span>, e);
            <span class="hljs-comment">// 嵌套事务回滚，外部事务继续</span>
            <span class="hljs-keyword">throw</span> e;
        }
        
        <span class="hljs-comment">// 其他操作...</span>
    }
}
</code></pre>
<p><strong>重要说明</strong>：</p>
<ul>
<li>NESTED使用保存点（Savepoint）实现</li>
<li>嵌套事务回滚不会导致外部事务回滚</li>
<li>外部事务回滚会导致所有嵌套事务回滚</li>
<li>需要数据库支持保存点（大多数现代数据库都支持）</li>
</ul>
<h2 data-id="heading-11">实战场景分析</h2>
<h3 data-id="heading-12">场景一：订单创建 + 库存扣减 + 发送通知</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderFullProcessService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderFullProcess</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 主事务：订单核心业务</span>
        orderMapper.insert(order);
        inventoryService.deductStock(order.getItems());
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 独立事务：发送通知（即使主事务回滚，通知已发送）</span>
            notificationService.sendOrderNotification(order);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 通知失败不影响主事务</span>
            log.warn(<span class="hljs-string">"发送通知失败，但订单继续处理"</span>, e);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 非事务：调用外部系统（避免长事务）</span>
            externalService.callExternalSystem(order);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"外部调用失败，但订单继续处理"</span>, e);
        }
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.MANDATORY)</span> <span class="hljs-comment">// 必须在事务中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(List&lt;OrderItem&gt; items)</span> {
        <span class="hljs-keyword">for</span> (OrderItem item : items) {
            <span class="hljs-keyword">if</span> (item.getQuantity() &gt; getAvailableStock(item.getProductId())) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryException</span>(<span class="hljs-string">"库存不足: "</span> + item.getProductId());
            }
            inventoryMapper.deductStock(item.getProductId(), item.getQuantity());
        }
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> <span class="hljs-comment">// 独立事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderNotification</span><span class="hljs-params">(Order order)</span> {
        notificationMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Notification</span>(order));
        <span class="hljs-comment">// 即使外部事务回滚，通知记录仍然保存</span>
    }
}
</code></pre>
<h3 data-id="heading-13">场景二：批量处理 + 进度记录</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchProcessService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span> <span class="hljs-comment">// 无事务批量处理</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processLargeBatch</span><span class="hljs-params">(List&lt;Data&gt; batchData)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> batchData.size();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; total; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 每个项目在独立事务中处理</span>
                processSingleItemInTransaction(batchData.get(i));
                successCount++;
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"处理第{}条数据失败"</span>, i, e);
            }
            
            <span class="hljs-comment">// 无事务记录进度</span>
            updateProgress(i + <span class="hljs-number">1</span>, total, successCount);
        }
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> <span class="hljs-comment">// 每个项目独立事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSingleItemInTransaction</span><span class="hljs-params">(Data data)</span> {
        dataMapper.process(data);
        <span class="hljs-comment">// 单条数据处理失败不影响其他数据</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span> <span class="hljs-comment">// 无事务进度更新</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProgress</span><span class="hljs-params">(<span class="hljs-type">int</span> processed, <span class="hljs-type">int</span> total, <span class="hljs-type">int</span> success)</span> {
        progressMapper.update(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Progress</span>(processed, total, success));
        <span class="hljs-comment">// 进度更新立即提交，即使后续处理失败</span>
    }
}
</code></pre>
<h2 data-id="heading-14">常见陷阱与解决方案</h2>
<h3 data-id="heading-15">陷阱一：REQUIRES_NEW的事务悬挂</h3>
<p><strong>问题</strong>：在REQUIRES_NEW中发生异常，导致外部事务无法正常继续。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    step1();
    innerMethod(); <span class="hljs-comment">// REQUIRES_NEW</span>
    step3(); <span class="hljs-comment">// 如果innerMethod异常，这里不会执行</span>
}

<span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
    step2();
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内部方法失败"</span>);
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    step1();
    <span class="hljs-keyword">try</span> {
        innerMethod(); <span class="hljs-comment">// REQUIRES_NEW</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"内部方法执行失败，继续外部事务"</span>, e);
    }
    step3(); <span class="hljs-comment">// 正常执行</span>
}
</code></pre>
<h3 data-id="heading-16">陷阱二：NESTED事务的误解</h3>
<p><strong>问题</strong>：误以为NESTED事务完全独立。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误理解</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentMethod</span><span class="hljs-params">()</span> {
    parentStep();
    nestedMethod(); <span class="hljs-comment">// NESTED</span>
    parentStep(); <span class="hljs-comment">// 认为nestedMethod回滚不影响这里</span>
}

<span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nestedMethod</span><span class="hljs-params">()</span> {
    nestedStep();
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"嵌套事务失败"</span>);
    <span class="hljs-comment">// 实际会回滚到保存点，后续parentStep不会执行！</span>
}
</code></pre>
<p><strong>正确理解</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentMethod</span><span class="hljs-params">()</span> {
    parentStep();
    <span class="hljs-keyword">try</span> {
        nestedMethod(); <span class="hljs-comment">// NESTED</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"嵌套事务失败，继续主事务"</span>, e);
    }
    parentStep(); <span class="hljs-comment">// 这里会执行</span>
}
</code></pre>
<h3 data-id="heading-17">陷阱三：传播机制组合不当</h3>
<p><strong>问题</strong>：传播机制组合导致事务边界混乱。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 混乱的事务边界</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfusedService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        methodB(); <span class="hljs-comment">// SUPPORTS</span>
        methodC(); <span class="hljs-comment">// REQUIRES_NEW</span>
        methodD(); <span class="hljs-comment">// NEVER - 这里会抛异常！</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.SUPPORTS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 可能不在事务中执行</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodC</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 新事务</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NEVER)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodD</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 禁止事务 - 在methodA事务中调用会抛异常！</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：明确事务边界，合理设计服务层。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClearBoundaryService</span> {
    
    <span class="hljs-comment">// 事务边界清晰的服务</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transactionalProcess</span><span class="hljs-params">()</span> {
        transactionalStep1();
        transactionalStep2();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nonTransactionalProcess</span><span class="hljs-params">()</span> {
        nonTransactionalStep1();
        independentTransactionalStep();
        nonTransactionalStep2();
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">independentTransactionalStep</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 独立事务操作</span>
    }
}
</code></pre>
<h2 data-id="heading-18">性能考虑与最佳实践</h2>
<h3 data-id="heading-19">1. 事务粒度的控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐：过大的事务</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processLargeBatch</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        processSingle(data); <span class="hljs-comment">// 每个处理都在大事务中</span>
    }
    <span class="hljs-comment">// 事务过大，锁持有时间过长</span>
}

<span class="hljs-comment">// 推荐：合适的事务粒度</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processLargeBatch</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        processSingleInTransaction(data); <span class="hljs-comment">// 每个独立事务</span>
    }
}

<span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSingleInTransaction</span><span class="hljs-params">(Data data)</span> {
    processSingle(data);
    <span class="hljs-comment">// 短事务，快速释放锁</span>
}
</code></pre>
<h3 data-id="heading-20">2. 只读事务的优化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询服务使用只读事务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.SUPPORTS, readOnly = true)</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">findOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderMapper.selectById(id);
    }
    
    <span class="hljs-meta">@Transactional(readOnly = true)</span> 
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">findComplexOrders</span><span class="hljs-params">(QueryCondition condition)</span> {
        <span class="hljs-comment">// 复杂查询在只读事务中执行</span>
        <span class="hljs-comment">// 可能路由到只读数据库副本</span>
        <span class="hljs-keyword">return</span> orderMapper.selectByComplexCondition(condition);
    }
}
</code></pre>
<h3 data-id="heading-21">3. 异常处理策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RobustService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">robustProcess</span><span class="hljs-params">()</span> {
        criticalOperation();
        
        <span class="hljs-keyword">try</span> {
            optionalOperationWithNewTx();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"可选操作失败，继续主流程"</span>, e);
        }
        
        <span class="hljs-keyword">try</span> {
            externalCallWithoutTx();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"外部调用失败，继续主流程"</span>, e);
        }
        
        anotherCriticalOperation();
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optionalOperationWithNewTx</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 独立事务，失败不影响主流程</span>
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">externalCallWithoutTx</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 无事务外部调用</span>
    }
}
</code></pre>
<h2 data-id="heading-22">调试与监控</h2>
<h3 data-id="heading-23">事务调试技巧</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">debugTransactionMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 查看当前事务状态</span>
    <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> TransactionAspectSupport.currentTransactionStatus();
    log.debug(<span class="hljs-string">"事务信息: {}"</span>, status);
    
    <span class="hljs-comment">// 检查是否是新建事务</span>
    <span class="hljs-keyword">if</span> (status.isNewTransaction()) {
        log.debug(<span class="hljs-string">"这是新创建的事务"</span>);
    } <span class="hljs-keyword">else</span> {
        log.debug(<span class="hljs-string">"这是已存在的事务"</span>);
    }
    
    <span class="hljs-comment">// 检查事务名称</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">transactionName</span> <span class="hljs-operator">=</span> status.getTransactionName();
    log.debug(<span class="hljs-string">"事务名称: {}"</span>, transactionName);
}
</code></pre>
<h3 data-id="heading-24">日志配置</h3>
<pre><code class="hljs language-properties" lang="properties"># application.properties
# 开启事务调试日志
logging.level.org.springframework.transaction.interceptor=TRACE
logging.level.org.springframework.transaction.support=DEBUG
logging.level.org.springframework.orm.jpa=DEBUG
logging.level.org.springframework.jdbc.datasource=DEBUG

# 显示事务边界
logging.level.org.springframework.transaction=DEBUG
</code></pre>
<h3 data-id="heading-25">监控指标</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMetrics</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Counter&gt; propagationCounters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorTransaction</span><span class="hljs-params">(TransactionEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">propagation</span> <span class="hljs-operator">=</span> getPropagationType(event);
        <span class="hljs-type">Counter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> propagationCounters.computeIfAbsent(
            propagation, 
            key -&gt; meterRegistry.counter(<span class="hljs-string">"transaction.propagation"</span>, <span class="hljs-string">"type"</span>, key)
        );
        counter.increment();
    }
}
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>Spring的7种事务传播机制为复杂业务场景提供了灵活的事务管理方案。正确理解和使用这些传播行为，可以帮助我们：</p>
<ol>
<li><strong>REQUIRED</strong> - 大多数业务方法的默认选择</li>
<li><strong>SUPPORTS</strong> - 适合查询操作，灵活适应事务上下文</li>
<li><strong>MANDATORY</strong> - 强制事务环境，防止误用</li>
<li><strong>REQUIRES_NEW</strong> - 独立事务操作，避免相互影响</li>
<li><strong>NOT_SUPPORTED</strong> - 非事务操作，避免长事务</li>
<li><strong>NEVER</strong> - 明确禁止事务，保证无事务执行</li>
<li><strong>NESTED</strong> - 复杂事务场景，部分回滚能力</li>
</ol>
<p>记住，没有"最好"的传播机制，只有"最适合"当前场景的选择。合理组合使用这些机制，可以构建出既健壮又高性能的事务处理系统。</p>
<hr/>
<p><strong>下期预告</strong>：《Spring事务隔离级别全解析：从读未提交到序列化》</p>
<p>如果觉得本文对你有帮助，请点赞、收藏、关注！欢迎在评论区分享你的实战经验和遇到的问题。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 防火墙双雄：iptables 与 firewalld 配置案例详解]]></title>    <link>https://juejin.cn/post/7571352754896355354</link>    <guid>https://juejin.cn/post/7571352754896355354</guid>    <pubDate>2025-11-11T23:33:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754896355354" data-draft-id="7570909641683173416" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 防火墙双雄：iptables 与 firewalld 配置案例详解"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-11T23:33:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCG元"/> <meta itemprop="url" content="https://juejin.cn/user/3097802498120889"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 防火墙双雄：iptables 与 firewalld 配置案例详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097802498120889/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCG元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T23:33:55.000Z" title="Tue Nov 11 2025 23:33:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. Linux 防火墙基础概念</h2>
<h3 data-id="heading-1">1.1 防火墙的重要性</h3>
<p>在当今的网络环境中，防火墙是保护系统安全的第一道防线。它通过控制网络流量进出系统，有效阻止未经授权的访问和恶意攻击。</p>
<h3 data-id="heading-2">1.2 iptables 与 firewalld 的关系</h3>
<p>iptables 是 Linux 内核中网络包过滤系统的用户空间工具，而 firewalld 是基于 iptables 的高级管理工具，提供了更友好的动态管理接口。</p>
<h2 data-id="heading-3">2. iptables 配置详解</h2>
<h3 data-id="heading-4">2.1 iptables 基础架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[网络数据包] --&gt; B{iptables 链选择}
    B --&gt; C[INPUT 链]
    B --&gt; D[FORWARD 链]
    B --&gt; E[OUTPUT 链]
    
    C --&gt; F{INPUT 规则匹配}
    F --&gt; G[规则1: 允许SSH]
    F --&gt; H[规则2: 允许HTTP]
    F --&gt; I[规则3: 默认拒绝]
    G --&gt; J[接受]
    H --&gt; J
    I --&gt; K[拒绝]
    
    D --&gt; L{FORWARD 规则匹配}
    L --&gt; M[规则1: 允许转发]
    L --&gt; N[规则2: 默认拒绝]
    M --&gt; O[接受]
    N --&gt; P[拒绝]
    
    E --&gt; Q{OUTPUT 规则匹配}
    Q --&gt; R[规则1: 允许所有]
    R --&gt; S[接受]
    
    style A fill:#e1f5fe
    style J fill:#c8e6c9
    style K fill:#ffcdd2
    style O fill:#c8e6c9
    style P fill:#ffcdd2
    style S fill:#c8e6c9
    style G fill:#4fc3f7
    style H fill:#4fc3f7
    style I fill:#ff9800
    style M fill:#4fc3f7
    style N fill:#ff9800
    style R fill:#4fc3f7
</code></pre>
<h3 data-id="heading-5">2.2 创建基础 iptables 配置文件</h3>
<p><strong>创建文件：</strong> <code>/root/iptables-basic-setup.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables 基础防火墙配置脚本</span>
<span class="hljs-comment"># 作者：Linux 系统管理员</span>
<span class="hljs-comment"># 描述：配置基本的防火墙规则，保护服务器安全</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置 iptables 防火墙..."</span>

<span class="hljs-comment"># 1. 清除所有现有规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 清除所有现有规则"</span>
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

<span class="hljs-comment"># 2. 设置默认策略</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 设置默认策略"</span>
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

<span class="hljs-comment"># 3. 允许本地回环接口</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 配置本地回环接口规则"</span>
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

<span class="hljs-comment"># 4. 允许已建立的连接和相关的连接</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 允许已建立的连接"</span>
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="hljs-comment"># 5. 允许 SSH 连接 (端口22)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 配置 SSH 访问规则"</span>
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT

<span class="hljs-comment"># 6. 允许 HTTP 和 HTTPS 访问</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 配置 Web 服务访问规则"</span>
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT

<span class="hljs-comment"># 7. 允许 ICMP (ping)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤7: 配置 ICMP 规则"</span>
iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

<span class="hljs-comment"># 8. 记录被拒绝的数据包</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤8: 配置日志记录规则"</span>
iptables -A INPUT -j LOG --log-prefix <span class="hljs-string">"IPTABLES-DROPPED: "</span> --log-level 4

<span class="hljs-comment"># 9. 显示规则列表</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤9: 显示当前规则"</span>
iptables -L -v

<span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables 基础配置完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"请注意：当前 SSH 连接不会被中断，但新连接将受规则限制。"</span>
</code></pre>
<h3 data-id="heading-6">2.3 创建高级 iptables 配置</h3>
<p><strong>创建文件：</strong> <code>/root/iptables-advanced-setup.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables 高级防火墙配置脚本</span>
<span class="hljs-comment"># 包含端口限制、连接限制和攻击防护</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置高级 iptables 防火墙..."</span>

<span class="hljs-comment"># 清除现有规则</span>
iptables -F
iptables -X

<span class="hljs-comment"># 默认策略</span>
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

<span class="hljs-comment"># 1. 基础规则</span>
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="hljs-comment"># 2. 保护 against 常见攻击</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置常见攻击防护..."</span>

<span class="hljs-comment"># 2.1 防止 SYN 洪水攻击</span>
iptables -A INPUT -p tcp --syn -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 1/s --limit-burst 3 -j ACCEPT
iptables -A INPUT -p tcp --syn -j DROP

<span class="hljs-comment"># 2.2 防止 ping 洪水攻击</span>
iptables -A INPUT -p icmp --icmp-type echo-request -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 1/s -j ACCEPT

<span class="hljs-comment"># 2.3 防止端口扫描</span>
iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP

<span class="hljs-comment"># 3. 服务端口配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置服务端口..."</span>

<span class="hljs-comment"># 3.1 SSH 保护 - 限制连接频率</span>
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --<span class="hljs-built_in">set</span> --name SSH
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --rttl --name SSH -j DROP
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

<span class="hljs-comment"># 3.2 Web 服务</span>
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT

<span class="hljs-comment"># 3.3 数据库服务 (MySQL)</span>
iptables -A INPUT -p tcp --dport 3306 -s 192.168.1.0/24 -j ACCEPT

<span class="hljs-comment"># 3.4 自定义应用端口</span>
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
iptables -A INPUT -p tcp --dport 8443 -j ACCEPT

<span class="hljs-comment"># 4. 时间限制规则示例</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置时间限制规则..."</span>

<span class="hljs-comment"># 允许办公时间访问特定服务 (9:00-18:00)</span>
iptables -A INPUT -p tcp --dport 9090 -m time --timestart 09:00 --timestop 18:00 --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT

<span class="hljs-comment"># 5. 地理限制示例 (需要 xt_geoip 模块)</span>
<span class="hljs-comment"># iptables -A INPUT -p tcp --dport 80 -m geoip --src-cc CN,US,JP -j ACCEPT</span>

<span class="hljs-comment"># 6. 记录被拒绝的连接</span>
iptables -A INPUT -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 5/min -j LOG --log-prefix <span class="hljs-string">"iptables denied: "</span> --log-level 7

<span class="hljs-comment"># 保存规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"保存规则..."</span>
service iptables save

<span class="hljs-comment"># 显示最终规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"最终防火墙规则："</span>
iptables -L -v -n

<span class="hljs-built_in">echo</span> <span class="hljs-string">"高级 iptables 配置完成！"</span>
</code></pre>
<h3 data-id="heading-7">2.4 创建 iptables 持久化脚本</h3>
<p><strong>创建文件：</strong> <code>/root/iptables-persistent-setup.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables 规则持久化配置脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置 iptables 规则持久化..."</span>

<span class="hljs-comment"># 检查系统类型</span>
<span class="hljs-keyword">if</span> [ -f /etc/redhat-release ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># CentOS/RHEL 系统</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 CentOS/RHEL 系统"</span>
    
    <span class="hljs-comment"># 安装 iptables-services</span>
    yum install -y iptables-services
    
    <span class="hljs-comment"># 保存当前规则</span>
    iptables-save &gt; /etc/sysconfig/iptables
    
    <span class="hljs-comment"># 启用服务</span>
    systemctl <span class="hljs-built_in">enable</span> iptables
    systemctl start iptables
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"规则已保存到 /etc/sysconfig/iptables"</span>
    
<span class="hljs-keyword">elif</span> [ -f /etc/debian_version ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># Debian/Ubuntu 系统</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Debian/Ubuntu 系统"</span>
    
    <span class="hljs-comment"># 安装 iptables-persistent</span>
    apt-get update
    apt-get install -y iptables-persistent
    
    <span class="hljs-comment"># 保存规则</span>
    iptables-save &gt; /etc/iptables/rules.v4
    ip6tables-save &gt; /etc/iptables/rules.v6
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"规则已保存到 /etc/iptables/rules.v4"</span>
    
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"未知的系统类型，请手动保存规则。"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"可以使用: iptables-save &gt; /path/to/iptables.rules"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建备份</span>
BACKUP_DIR=<span class="hljs-string">"/root/iptables-backup"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$BACKUP_DIR</span>
iptables-save &gt; <span class="hljs-variable">$BACKUP_DIR</span>/iptables-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d-%H%M%S).rules

<span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables 持久化配置完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"备份文件保存在: <span class="hljs-variable">$BACKUP_DIR</span>"</span>
</code></pre>
<h2 data-id="heading-8">3. firewalld 配置详解</h2>
<h3 data-id="heading-9">3.1 firewalld 核心概念</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[firewalld 守护进程] --&gt; B[运行时配置]
    A --&gt; C[永久配置]
    
    B --&gt; D[立即生效]
    B --&gt; E[重启后丢失]
    
    C --&gt; F[重启后生效]
    C --&gt; G[需要重载]
    
    H[防火墙规则] --&gt; I[ Zones 区域 ]
    H --&gt; J[ Services 服务 ]
    H --&gt; K[ Ports 端口 ]
    H --&gt; L[ Rich Rules 富规则 ]
    
    I --&gt; M[public]
    I --&gt; N[internal]
    I --&gt; O[dmz]
    I --&gt; P[trusted]
    
    J --&gt; Q[ssh]
    J --&gt; R[http]
    J --&gt; S[https]
    
    K --&gt; T[端口转发]
    K --&gt; U[直接规则]
    
    L --&gt; V[复杂规则]
    L --&gt; W[源地址限制]
    L --&gt; X[时间限制]
    
    style A fill:#1565c0
    style I fill:#00796b
    style J fill:#d84315
    style K fill:#6a1b9a
    style L fill:#ff8f00
    style M fill:#4caf50
    style N fill:#4caf50
    style O fill:#4caf50
    style P fill:#4caf50
</code></pre>
<h3 data-id="heading-10">3.2 基础 firewalld 配置脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewalld-basic-setup.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># firewalld 基础配置脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置 firewalld 防火墙..."</span>

<span class="hljs-comment"># 1. 启动和启用 firewalld</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 启动 firewalld 服务"</span>
systemctl start firewalld
systemctl <span class="hljs-built_in">enable</span> firewalld

<span class="hljs-comment"># 2. 检查 firewalld 状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 检查服务状态"</span>
firewall-cmd --state
systemctl status firewalld --no-pager -l

<span class="hljs-comment"># 3. 查看默认区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 查看当前区域配置"</span>
firewall-cmd --get-default-zone
firewall-cmd --get-active-zones

<span class="hljs-comment"># 4. 配置默认区域为 public</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 配置默认区域"</span>
firewall-cmd --set-default-zone=public

<span class="hljs-comment"># 5. 添加基本服务</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 添加基本服务到防火墙"</span>

<span class="hljs-comment"># 5.1 SSH 服务</span>
firewall-cmd --permanent --add-service=ssh
<span class="hljs-built_in">echo</span> <span class="hljs-string">"添加 SSH 服务"</span>

<span class="hljs-comment"># 5.2 HTTP 服务</span>
firewall-cmd --permanent --add-service=http
<span class="hljs-built_in">echo</span> <span class="hljs-string">"添加 HTTP 服务"</span>

<span class="hljs-comment"># 5.3 HTTPS 服务</span>
firewall-cmd --permanent --add-service=https
<span class="hljs-built_in">echo</span> <span class="hljs-string">"添加 HTTPS 服务"</span>

<span class="hljs-comment"># 6. 移除不需要的服务 (示例)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 移除不需要的服务"</span>
firewall-cmd --permanent --remove-service=dhcpv6-client 2&gt;/dev/null || <span class="hljs-literal">true</span>

<span class="hljs-comment"># 7. 添加自定义端口</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤7: 添加自定义端口"</span>
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --permanent --add-port=8443/tcp
<span class="hljs-built_in">echo</span> <span class="hljs-string">"添加端口 8080/tcp 和 8443/tcp"</span>

<span class="hljs-comment"># 8. 配置富规则 (Rich Rules)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤8: 配置富规则"</span>

<span class="hljs-comment"># 8.1 限制 SSH 访问来源</span>
firewall-cmd --permanent --add-rich-rule=<span class="hljs-string">'rule family="ipv4" source address="192.168.1.0/24" service name="ssh" accept'</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"限制 SSH 访问来源为 192.168.1.0/24"</span>

<span class="hljs-comment"># 8.2 拒绝其他所有流量</span>
firewall-cmd --permanent --add-rich-rule=<span class="hljs-string">'rule family="ipv4" source address="0.0.0.0/0" service name="ssh" drop'</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"拒绝其他来源的 SSH 访问"</span>

<span class="hljs-comment"># 9. 重载防火墙配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤9: 重载防火墙配置"</span>
firewall-cmd --reload

<span class="hljs-comment"># 10. 验证配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤10: 验证防火墙配置"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"当前区域服务:"</span>
firewall-cmd --list-services
<span class="hljs-built_in">echo</span> <span class="hljs-string">"当前区域端口:"</span>
firewall-cmd --list-ports
<span class="hljs-built_in">echo</span> <span class="hljs-string">"富规则:"</span>
firewall-cmd --list-rich-rules

<span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld 基础配置完成！"</span>
</code></pre>
<h3 data-id="heading-11">3.3 高级 firewalld 配置脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewalld-advanced-setup.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># firewalld 高级配置脚本</span>
<span class="hljs-comment"># 包含多个区域配置、端口转发和高级特性</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始高级 firewalld 配置..."</span>

<span class="hljs-comment"># 确保 firewalld 运行</span>
systemctl start firewalld

<span class="hljs-comment"># 1. 创建自定义区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 创建自定义区域"</span>

<span class="hljs-comment"># 1.1 创建 webzone 区域</span>
firewall-cmd --permanent --new-zone=webzone
firewall-cmd --permanent --new-zone=internal

<span class="hljs-comment"># 1.2 配置 webzone 区域</span>
firewall-cmd --permanent --zone=webzone --add-service=http
firewall-cmd --permanent --zone=webzone --add-service=https
firewall-cmd --permanent --zone=webzone --add-port=8080/tcp
firewall-cmd --permanent --zone=webzone --set-target=ACCEPT

<span class="hljs-comment"># 1.3 配置 internal 区域</span>
firewall-cmd --permanent --zone=internal --add-service=ssh
firewall-cmd --permanent --zone=internal --add-service=mysql
firewall-cmd --permanent --zone=internal --add-service=postgresql
firewall-cmd --permanent --zone=internal --add-source=192.168.1.0/24

<span class="hljs-comment"># 2. 配置端口转发</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 配置端口转发"</span>

<span class="hljs-comment"># 2.1 启用 IP 伪装</span>
firewall-cmd --permanent --zone=public --add-masquerade

<span class="hljs-comment"># 2.2 配置端口转发 (将公网80端口转发到内网服务器)</span>
firewall-cmd --permanent --zone=public --add-forward-port=port=80:proto=tcp:toport=8080:toaddr=192.168.1.100

<span class="hljs-comment"># 3. ICMP 阻塞配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 配置 ICMP 阻塞"</span>
firewall-cmd --permanent --zone=public --add-icmp-block=echo-request
firewall-cmd --permanent --zone=public --add-icmp-block=echo-reply

<span class="hljs-comment"># 4. 直接规则配置 (Direct Rules)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 配置直接规则"</span>

<span class="hljs-comment"># 4.1 添加直接规则到 INPUT 链</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp --dport 9090 -j ACCEPT

<span class="hljs-comment"># 4.2 添加连接限制规则</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp --dport 22 -m state --state NEW -m recent --<span class="hljs-built_in">set</span> --name ssh --rsource
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --name ssh --rsource -j DROP

<span class="hljs-comment"># 5. 恐慌模式配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 配置恐慌模式"</span>
firewall-cmd --set-panic-off
<span class="hljs-built_in">echo</span> <span class="hljs-string">"恐慌模式已关闭"</span>

<span class="hljs-comment"># 6. 锁定配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 配置白名单锁定"</span>
firewall-cmd --permanent --add-lockdown-whitelist-command=/usr/bin/systemctl
firewall-cmd --permanent --add-lockdown-whitelist-command=/usr/bin/firewall-cmd
firewall-cmd --permanent --add-lockdown-whitelist-user=root

<span class="hljs-comment"># 7. 重载配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤7: 重载防火墙配置"</span>
firewall-cmd --reload

<span class="hljs-comment"># 8. 验证高级配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤8: 验证高级配置"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"所有区域:"</span>
firewall-cmd --list-all-zones

<span class="hljs-built_in">echo</span> <span class="hljs-string">"直接规则:"</span>
firewall-cmd --direct --get-all-rules

<span class="hljs-built_in">echo</span> <span class="hljs-string">"锁定白名单:"</span>
firewall-cmd --list-lockdown-whitelist-commands
firewall-cmd --list-lockdown-whitelist-users

<span class="hljs-built_in">echo</span> <span class="hljs-string">"端口转发:"</span>
firewall-cmd --list-forward-ports

<span class="hljs-built_in">echo</span> <span class="hljs-string">"高级 firewalld 配置完成！"</span>
</code></pre>
<h3 data-id="heading-12">3.4 firewalld 服务管理脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewalld-service-management.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># firewalld 服务管理脚本</span>
<span class="hljs-comment"># 用于管理自定义服务定义</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置 firewalld 自定义服务..."</span>

<span class="hljs-comment"># 创建自定义服务目录</span>
CUSTOM_SERVICE_DIR=<span class="hljs-string">"/etc/firewalld/services"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>

<span class="hljs-comment"># 1. 创建自定义应用服务</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 创建自定义服务定义"</span>

<span class="hljs-comment"># 1.1 创建 nodejs-app 服务</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/nodejs-app.xml &lt;&lt; <span class="hljs-string">EOF
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;service&gt;
  &lt;short&gt;Node.js Application&lt;/short&gt;
  &lt;description&gt;This service allows access to Node.js web application on ports 3000 and 3001.&lt;/description&gt;
  &lt;port protocol="tcp" port="3000"/&gt;
  &lt;port protocol="tcp" port="3001"/&gt;
  &lt;module name="nf_conntrack_netbios_ns"/&gt;
&lt;/service&gt;
EOF</span>

<span class="hljs-comment"># 1.2 创建 mongodb 服务</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/mongodb.xml &lt;&lt; <span class="hljs-string">EOF
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;service&gt;
  &lt;short&gt;MongoDB Database&lt;/short&gt;
  &lt;description&gt;This service allows access to MongoDB database on default port 27017.&lt;/description&gt;
  &lt;port protocol="tcp" port="27017"/&gt;
&lt;/service&gt;
EOF</span>

<span class="hljs-comment"># 1.3 创建 redis 服务</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/redis.xml &lt;&lt; <span class="hljs-string">EOF
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;service&gt;
  &lt;short&gt;Redis Cache&lt;/short&gt;
  &lt;description&gt;This service allows access to Redis caching service on port 6379.&lt;/description&gt;
  &lt;port protocol="tcp" port="6379"/&gt;
&lt;/service&gt;
EOF</span>

<span class="hljs-comment"># 2. 设置正确的文件权限</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 设置文件权限"</span>
<span class="hljs-built_in">chown</span> root:root <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/*.xml
<span class="hljs-built_in">chmod</span> 640 <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/*.xml

<span class="hljs-comment"># 3. 重载 firewalld 以识别新服务</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 重载服务定义"</span>
firewall-cmd --reload

<span class="hljs-comment"># 4. 添加自定义服务到防火墙</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 添加自定义服务到防火墙"</span>

<span class="hljs-comment"># 4.1 添加 nodejs-app 服务到 internal 区域</span>
firewall-cmd --permanent --zone=internal --add-service=nodejs-app

<span class="hljs-comment"># 4.2 添加 mongodb 服务到 internal 区域</span>
firewall-cmd --permanent --zone=internal --add-service=mongodb

<span class="hljs-comment"># 4.3 添加 redis 服务到 internal 区域</span>
firewall-cmd --permanent --zone=internal --add-service=redis

<span class="hljs-comment"># 5. 重载配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 重载防火墙配置"</span>
firewall-cmd --reload

<span class="hljs-comment"># 6. 验证自定义服务</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 验证自定义服务配置"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"可用的自定义服务:"</span>
firewall-cmd --get-services | grep -E <span class="hljs-string">"(nodejs-app|mongodb|redis)"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"internal 区域的服务:"</span>
firewall-cmd --zone=internal --list-services

<span class="hljs-built_in">echo</span> <span class="hljs-string">"服务文件内容:"</span>
<span class="hljs-keyword">for</span> service_file <span class="hljs-keyword">in</span> <span class="hljs-variable">$CUSTOM_SERVICE_DIR</span>/*.xml; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== <span class="hljs-variable">$service_file</span> ==="</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-variable">$service_file</span>
    <span class="hljs-built_in">echo</span>
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld 自定义服务配置完成！"</span>
</code></pre>
<h2 data-id="heading-13">4. 实战配置案例</h2>
<h3 data-id="heading-14">4.1 Web 服务器防火墙配置</h3>
<p><strong>创建文件：</strong> <code>/root/web-server-firewall.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># Web 服务器专用防火墙配置</span>
<span class="hljs-comment"># 适用于 Apache/Nginx web 服务器</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置 Web 服务器防火墙..."</span>

<span class="hljs-comment"># 检测使用的防火墙工具</span>
<span class="hljs-keyword">if</span> systemctl is-active --quiet firewalld; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 firewalld 进行配置"</span>
    FIREWALL_TYPE=<span class="hljs-string">"firewalld"</span>
<span class="hljs-keyword">elif</span> systemctl is-active --quiet iptables; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 iptables 进行配置"</span>
    FIREWALL_TYPE=<span class="hljs-string">"iptables"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"未发现活动的防火墙服务，将安装并配置 firewalld"</span>
    yum install -y firewalld || apt-get install -y firewalld
    systemctl start firewalld
    systemctl <span class="hljs-built_in">enable</span> firewalld
    FIREWALL_TYPE=<span class="hljs-string">"firewalld"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FIREWALL_TYPE</span>"</span> = <span class="hljs-string">"firewalld"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># firewalld 配置</span>
    
    <span class="hljs-comment"># 创建 web-server 区域</span>
    firewall-cmd --permanent --new-zone=web-server
    
    <span class="hljs-comment"># 配置 web-server 区域</span>
    firewall-cmd --permanent --zone=web-server --add-service=http
    firewall-cmd --permanent --zone=web-server --add-service=https
    firewall-cmd --permanent --zone=web-server --add-service=ssh
    firewall-cmd --permanent --zone=web-server --add-port=8080/tcp
    firewall-cmd --permanent --zone=web-server --add-port=8443/tcp
    
    <span class="hljs-comment"># 设置默认区域</span>
    firewall-cmd --set-default-zone=web-server
    
    <span class="hljs-comment"># 添加富规则保护</span>
    firewall-cmd --permanent --zone=web-server --add-rich-rule=<span class="hljs-string">'
        rule family="ipv4" source address="192.168.1.0/24" port port="22" protocol="tcp" accept'</span>
    
    firewall-cmd --permanent --zone=web-server --add-rich-rule=<span class="hljs-string">'
        rule family="ipv4" source address="0.0.0.0/0" port port="22" protocol="tcp" drop'</span>
    
    <span class="hljs-comment"># 重载配置</span>
    firewall-cmd --reload
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld Web 服务器配置完成"</span>
    
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># iptables 配置</span>
    
    <span class="hljs-comment"># 清除现有规则</span>
    iptables -F
    iptables -X
    
    <span class="hljs-comment"># 默认策略</span>
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT ACCEPT
    
    <span class="hljs-comment"># 基础规则</span>
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    
    <span class="hljs-comment"># Web 服务端口</span>
    iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
    iptables -A INPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT
    iptables -A INPUT -p tcp --dport 8080 -m state --state NEW -j ACCEPT
    iptables -A INPUT -p tcp --dport 8443 -m state --state NEW -j ACCEPT
    
    <span class="hljs-comment"># SSH 保护</span>
    iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT
    iptables -A INPUT -p tcp --dport 22 -j DROP
    
    <span class="hljs-comment"># 保存规则</span>
    service iptables save
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables Web 服务器配置完成"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 显示最终配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"最终防火墙配置:"</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FIREWALL_TYPE</span>"</span> = <span class="hljs-string">"firewalld"</span> ]; <span class="hljs-keyword">then</span>
    firewall-cmd --list-all
<span class="hljs-keyword">else</span>
    iptables -L -v -n
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Web 服务器防火墙配置完成！"</span>
</code></pre>
<h3 data-id="heading-15">4.2 数据库服务器防火墙配置</h3>
<p><strong>创建文件：</strong> <code>/root/database-server-firewall.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 数据库服务器专用防火墙配置</span>
<span class="hljs-comment"># 适用于 MySQL, PostgreSQL, MongoDB 等数据库</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始配置数据库服务器防火墙..."</span>

<span class="hljs-comment"># 使用 firewalld 进行配置</span>
systemctl start firewalld
systemctl <span class="hljs-built_in">enable</span> firewalld

<span class="hljs-comment"># 创建 database-zone 区域</span>
firewall-cmd --permanent --new-zone=database-zone

<span class="hljs-comment"># 配置数据库区域</span>
firewall-cmd --permanent --zone=database-zone --add-service=ssh
firewall-cmd --permanent --zone=database-zone --add-service=mysql
firewall-cmd --permanent --zone=database-zone --add-service=postgresql

<span class="hljs-comment"># 添加自定义数据库端口</span>
firewall-cmd --permanent --zone=database-zone --add-port=27017/tcp  <span class="hljs-comment"># MongoDB</span>
firewall-cmd --permanent --zone=database-zone --add-port=5432/tcp   <span class="hljs-comment"># PostgreSQL</span>
firewall-cmd --permanent --zone=database-zone --add-port=3306/tcp   <span class="hljs-comment"># MySQL</span>

<span class="hljs-comment"># 设置源地址限制</span>
firewall-cmd --permanent --zone=database-zone --add-source=192.168.1.0/24
firewall-cmd --permanent --zone=database-zone --add-source=10.0.0.0/24

<span class="hljs-comment"># 设置默认区域为 drop</span>
firewall-cmd --permanent --zone=database-zone --set-target=DROP

<span class="hljs-comment"># 设置 database-zone 为默认区域</span>
firewall-cmd --set-default-zone=database-zone

<span class="hljs-comment"># 重载配置</span>
firewall-cmd --reload

<span class="hljs-comment"># 验证配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"数据库区域配置:"</span>
firewall-cmd --zone=database-zone --list-all

<span class="hljs-built_in">echo</span> <span class="hljs-string">"数据库服务器防火墙配置完成！"</span>
</code></pre>
<h2 data-id="heading-16">5. 监控和故障排除</h2>
<h3 data-id="heading-17">5.1 防火墙监控脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewall-monitor.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 防火墙监控和状态检查脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始防火墙状态检查..."</span>

<span class="hljs-comment"># 获取当前时间</span>
CURRENT_TIME=$(<span class="hljs-built_in">date</span> <span class="hljs-string">"+%Y-%m-%d %H:%M:%S"</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检查时间: <span class="hljs-variable">$CURRENT_TIME</span>"</span>

<span class="hljs-comment"># 检查防火墙服务状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 防火墙服务状态 ==="</span>
<span class="hljs-keyword">if</span> systemctl is-active --quiet firewalld; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld: 运行中"</span>
    systemctl status firewalld --no-pager -l | grep -E <span class="hljs-string">"(Active|Main PID|CGroup)"</span>
<span class="hljs-keyword">elif</span> systemctl is-active --quiet iptables; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables: 运行中"</span>
    systemctl status iptables --no-pager -l | grep -E <span class="hljs-string">"(Active|Main PID|CGroup)"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告: 未发现运行的防火墙服务"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span>

<span class="hljs-comment"># 检查当前规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 当前防火墙规则 ==="</span>
<span class="hljs-keyword">if</span> systemctl is-active --quiet firewalld; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld 配置:"</span>
    firewall-cmd --list-all-zones
<span class="hljs-keyword">elif</span> systemctl is-active --quiet iptables; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables 规则:"</span>
    iptables -L -v -n
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span>

<span class="hljs-comment"># 检查连接状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 当前网络连接 ==="</span>
ss -tunlp | <span class="hljs-built_in">head</span> -20

<span class="hljs-built_in">echo</span>

<span class="hljs-comment"># 检查被拒绝的连接</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 最近被拒绝的连接 ==="</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v journalctl &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    journalctl -u firewalld --since <span class="hljs-string">"1 hour ago"</span> | grep -i <span class="hljs-string">"denied\|rejected"</span> | <span class="hljs-built_in">tail</span> -10
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span>

<span class="hljs-comment"># 检查系统日志中的防火墙相关条目</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 系统日志中的防火墙条目 ==="</span>
dmesg | grep -i <span class="hljs-string">"firewall\|iptables"</span> | <span class="hljs-built_in">tail</span> -10

<span class="hljs-built_in">echo</span>

<span class="hljs-comment"># 端口扫描检查</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 监听端口检查 ==="</span>
netstat -tuln | grep LISTEN

<span class="hljs-built_in">echo</span> <span class="hljs-string">"防火墙状态检查完成！"</span>
</code></pre>
<h3 data-id="heading-18">5.2 防火墙故障排除脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewall-troubleshoot.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 防火墙故障排除脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始防火墙故障排除..."</span>

<span class="hljs-comment"># 1. 检查基本连接</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 检查基本网络连接"</span>
ping -c 3 8.8.8.8 &gt; /dev/null 2&gt;&amp;1
<span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ 外部网络连接正常"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ 外部网络连接失败"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 2. 检查服务状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 检查防火墙服务状态"</span>
<span class="hljs-keyword">if</span> systemctl is-active --quiet firewalld; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ firewalld 服务运行正常"</span>
    
    <span class="hljs-comment"># 检查 firewalld 配置</span>
    <span class="hljs-keyword">if</span> firewall-cmd --state &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ firewalld 配置加载正常"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ firewalld 配置加载失败"</span>
    <span class="hljs-keyword">fi</span>
    
<span class="hljs-keyword">elif</span> systemctl is-active --quiet iptables; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ iptables 服务运行正常"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ 没有运行的防火墙服务"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 3. 检查规则冲突</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 检查规则冲突"</span>
<span class="hljs-keyword">if</span> systemctl is-active --quiet firewalld &amp;&amp; systemctl is-active --quiet iptables; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告: firewalld 和 iptables 同时运行，可能存在冲突"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 4. 检查端口状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 检查关键端口状态"</span>
PORTS_TO_CHECK=<span class="hljs-string">"22 80 443 3306"</span>

<span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-variable">$PORTS_TO_CHECK</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> ss -tuln | grep <span class="hljs-string">":<span class="hljs-variable">$port</span> "</span> &gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ 端口 <span class="hljs-variable">$port</span> 正在监听"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ 端口 <span class="hljs-variable">$port</span> 未监听"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 5. 检查 SELinux 状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 检查 SELinux 状态"</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v getenforce &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    selinux_status=$(getenforce)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"SELinux 状态: <span class="hljs-variable">$selinux_status</span>"</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$selinux_status</span>"</span> = <span class="hljs-string">"Enforcing"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"注意: SELinux 处于强制模式，可能影响网络连接"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 6. 诊断特定问题</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 常见问题诊断"</span>

<span class="hljs-comment"># 检查是否有被拒绝的连接</span>
<span class="hljs-keyword">if</span> dmesg | grep -i <span class="hljs-string">"reject"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"发现被拒绝的连接，查看详细信息:"</span>
    dmesg | grep -i <span class="hljs-string">"reject"</span> | <span class="hljs-built_in">tail</span> -5
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 检查日志中的防火墙错误</span>
<span class="hljs-keyword">if</span> journalctl -u firewalld --since <span class="hljs-string">"1 hour ago"</span> | grep -i <span class="hljs-string">"error"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"发现 firewalld 错误日志:"</span>
    journalctl -u firewalld --since <span class="hljs-string">"1 hour ago"</span> | grep -i <span class="hljs-string">"error"</span> | <span class="hljs-built_in">tail</span> -5
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"故障排除完成！"</span>
</code></pre>
<h2 data-id="heading-19">6. 安全最佳实践</h2>
<h3 data-id="heading-20">6.1 防火墙安全加固脚本</h3>
<p><strong>创建文件：</strong> <code>/root/firewall-hardening.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 防火墙安全加固脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始防火墙安全加固..."</span>

<span class="hljs-comment"># 使用 firewalld 进行加固</span>
systemctl start firewalld

<span class="hljs-comment"># 1. 创建安全区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤1: 创建安全区域结构"</span>

<span class="hljs-comment"># 删除默认区域（如果存在）</span>
firewall-cmd --permanent --delete-zone=public 2&gt;/dev/null || <span class="hljs-literal">true</span>
firewall-cmd --permanent --delete-zone=internal 2&gt;/dev/null || <span class="hljs-literal">true</span>

<span class="hljs-comment"># 创建新的安全区域</span>
firewall-cmd --permanent --new-zone=external
firewall-cmd --permanent --new-zone=restricted
firewall-cmd --permanent --new-zone=management

<span class="hljs-comment"># 2. 配置外部区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤2: 配置外部区域"</span>
firewall-cmd --permanent --zone=external --add-service=http
firewall-cmd --permanent --zone=external --add-service=https
firewall-cmd --permanent --zone=external --set-target=DROP

<span class="hljs-comment"># 3. 配置受限制区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤3: 配置受限制区域"</span>
firewall-cmd --permanent --zone=restricted --add-service=ssh
firewall-cmd --permanent --zone=restricted --add-source=192.168.1.0/24
firewall-cmd --permanent --zone=restricted --set-target=ACCEPT

<span class="hljs-comment"># 4. 配置管理区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤4: 配置管理区域"</span>
firewall-cmd --permanent --zone=management --add-service=ssh
firewall-cmd --permanent --zone=management --add-service=cockpit
firewall-cmd --permanent --zone=management --add-source=10.0.0.0/24
firewall-cmd --permanent --zone=management --set-target=ACCEPT

<span class="hljs-comment"># 5. 配置默认区域</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤5: 设置默认区域"</span>
firewall-cmd --set-default-zone=external

<span class="hljs-comment"># 6. 配置高级保护规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤6: 配置高级保护"</span>

<span class="hljs-comment"># 6.1 防止碎片攻击</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -f -j DROP

<span class="hljs-comment"># 6.2 防止无效数据包</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -m state --state INVALID -j DROP

<span class="hljs-comment"># 6.3 限制新连接速率</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp -m state --state NEW -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 60/min --limit-burst 100 -j ACCEPT

<span class="hljs-comment"># 7. 配置日志规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤7: 配置详细日志"</span>

<span class="hljs-comment"># 记录被拒绝的连接</span>
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 12/min -j LOG --log-prefix <span class="hljs-string">"FIREWALL: "</span> --log-level 4

<span class="hljs-comment"># 8. 禁用不必要的 ICMP 类型</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤8: 配置 ICMP 过滤"</span>
firewall-cmd --permanent --zone=external --add-icmp-block-inversion
firewall-cmd --permanent --zone=external --remove-icmp-block=echo-request
firewall-cmd --permanent --zone=external --remove-icmp-block=echo-reply

<span class="hljs-comment"># 9. 重载配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤9: 应用配置"</span>
firewall-cmd --reload

<span class="hljs-comment"># 10. 验证加固配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"步骤10: 验证加固结果"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"所有区域配置:"</span>
firewall-cmd --list-all-zones

<span class="hljs-built_in">echo</span> <span class="hljs-string">"直接规则:"</span>
firewall-cmd --direct --get-all-rules

<span class="hljs-built_in">echo</span> <span class="hljs-string">"防火墙安全加固完成！"</span>
</code></pre>
<h2 data-id="heading-21">7. 总结</h2>
<p>本教程详细介绍了 Linux 系统中两种主要的防火墙工具：iptables 和 firewalld。通过实际的配置案例和详细的步骤说明，即使是零基础的初学者也能够按照教程完成实际的防火墙配置。</p>
<h3 data-id="heading-22">7.1 关键要点</h3>
<ol>
<li><strong>iptables</strong> 是底层的包过滤工具，功能强大但配置复杂</li>
<li><strong>firewalld</strong> 是基于 iptables 的高级管理工具，提供动态管理和更友好的配置接口</li>
<li>两种工具都可以有效保护服务器安全，选择取决于具体需求和个人偏好</li>
<li>持久化配置是确保防火墙规则在重启后仍然有效的关键</li>
</ol>
<h3 data-id="heading-23">7.2 后续建议</h3>
<ul>
<li>定期审查和更新防火墙规则</li>
<li>监控防火墙日志以检测潜在的安全威胁</li>
<li>在生产环境部署前，先在测试环境验证规则</li>
<li>保持防火墙软件更新到最新版本</li>
</ul>
<p>通过本教程的学习，您应该能够熟练配置和管理 Linux 系统的防火墙，为服务器提供坚实的安全防护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Elasticsearch 中为结构化文档配置递归分块]]></title>    <link>https://juejin.cn/post/7571348736153141284</link>    <guid>https://juejin.cn/post/7571348736153141284</guid>    <pubDate>2025-11-12T00:34:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736153141284" data-draft-id="7571355146770333738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Elasticsearch 中为结构化文档配置递归分块"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-12T00:34:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Elasticsearch 中为结构化文档配置递归分块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:34:09.000Z" title="Wed Nov 12 2025 00:34:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fdaniel-rubinstein" title="https://www.elastic.co/search-labs/author/daniel-rubinstein" target="_blank" ref="nofollow noopener noreferrer">Daniel Rubinstein</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/046667f17a2e46dabb794503611495a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512448&amp;x-signature=sFaHH9ywb5yDybxouzh3LR2WGeY%3D" alt="" loading="lazy"/></p>
<p>了解如何在 Elasticsearch 中使用分块大小、分隔符组和自定义分隔符列表来配置递归分块，以实现最佳的结构化文档索引。</p>
<p>刚接触 Elasticsearch 吗？加入我们的 “<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fvirtual-events%2Fgetting-started-elasticsearch" title="https://www.elastic.co/virtual-events/getting-started-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch 入门</a>” 网络研讨会吧。你也可以现在开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration" title="https://cloud.elastic.co/registration" target="_blank" ref="nofollow noopener noreferrer">免费云端试用</a>，或在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">机器</a>上体验 Elastic。</p>
<p>从 8.16 版本开始，用户可以在将长文档导入语义文本字段时配置分块策略。从 9.1 / 8.19 版本起，我们引入了一种新的可配置递归分块策略，它使用正则表达式列表对文档进行分块。分块的目标是将长文档拆分成包含相关内容的部分。我们现有的策略会按词或句子的粒度拆分文本，但使用结构化格式（例如 Markdown）编写的文档通常在由某些分隔字符串（例如标题）定义的部分中包含相关内容。对于这类文档，我们引入了递归分块策略，以利用结构化文档的格式创建更优质的分块！</p>
<h2 data-id="heading-0">什么是递归分块？</h2>
<p>递归分块会遍历一组提供的分区分隔模式，逐步将文档拆分成更小的段，直到它们符合所需的最大分块大小。</p>
<h3 data-id="heading-1">如何配置递归分块？</h3>
<p>以下是用户为递归分块可配置的参数：</p>
<ul>
<li>
<p>（必需）max_chunk_size：每个分块中允许的最大单词数。</p>
</li>
<li>
<p>以下两者之一：</p>
<ul>
<li>
<p>separators：用于将文档拆分成分块的正则表达式字符串列表。</p>
</li>
<li>
<p>separator_group：一个字符串，用于映射到由 Elastic 定义的默认分隔符列表，以便针对特定类型的文档使用。目前支持 markdown 和 plaintext。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">递归分块如何工作？</h3>
<p>当给定输入文档、max_chunk_size（以单词为单位）和分隔符字符串列表时，递归分块的处理过程如下：</p>
<ol>
<li>
<p>如果输入文档已在最大分块大小范围内，则返回一个覆盖整个输入的单个分块。</p>
</li>
<li>
<p>根据分隔符出现的位置将文本拆分为潜在分块。对每个潜在分块执行以下操作：</p>
<ul>
<li>
<p>如果潜在分块在最大分块大小范围内，将其添加到要返回给用户的分块列表中。</p>
</li>
<li>
<p>否则，从第 2 步重新开始，仅使用潜在分块的文本，并使用下一个分隔符进行拆分。</p>
</li>
<li>
<p>如果没有更多分隔符可用，则退回到基于句子的分块。</p>
</li>
</ul>
</li>
</ol>
<h2 data-id="heading-3">配置递归分块的示例</h2>
<p>除了分块大小之外，递归分块的主要配置是选择用于拆分文档的分隔符。如果你不确定从哪里开始，Elasticsearch 提供了一些默认的分隔符组，可用于常见的使用场景。</p>
<h3 data-id="heading-4">使用分隔符组</h3>
<p>要使用分隔符组，只需在配置分块设置时提供你想使用的组名即可。例如：</p>
<pre><code class="hljs language-json" lang="json">`

<span class="hljs-number">1.</span>  <span class="hljs-attr">"chunking_settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-number">2.</span>      <span class="hljs-attr">"strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recursive"</span><span class="hljs-punctuation">,</span>
<span class="hljs-number">3.</span>      <span class="hljs-attr">"max_chunk_size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>
<span class="hljs-number">4.</span>      <span class="hljs-attr">"separator_group"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"plaintext"</span>
<span class="hljs-number">5.</span>  <span class="hljs-punctuation">}</span>

`AI写代码
</code></pre>
<p>这将为你提供一种递归分块策略，使用的分隔符列表为 ["(?&lt;!\n)\n\n(?!\n)", "(?&lt;!\n)\n(?!\n)"]。这对通用纯文本应用非常有效，先按两个换行符拆分，然后按一个换行符拆分。</p>
<p>我们还提供了一个名为 markdown 的分隔符组，它使用的分隔符列表为：</p>
<pre><code class="hljs language-swift" lang="swift">`

<span class="hljs-number">1</span>.  [
<span class="hljs-number">2</span>.  <span class="hljs-string">"<span class="hljs-subst">\n</span># "</span>,
<span class="hljs-number">3</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>## "</span>,
<span class="hljs-number">4</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>### "</span>,
<span class="hljs-number">5</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>#### "</span>,
<span class="hljs-number">6</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>##### "</span>,
<span class="hljs-number">7</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>###### "</span>,
<span class="hljs-number">8</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>^(?!<span class="hljs-subst">\\</span>s*$).*<span class="hljs-subst">\\</span>n-{1,}<span class="hljs-subst">\\</span>n"</span>,
<span class="hljs-number">9</span>.         <span class="hljs-string">"<span class="hljs-subst">\n</span>^(?!<span class="hljs-subst">\\</span>s*$).*<span class="hljs-subst">\\</span>n={1,}<span class="hljs-subst">\\</span>n"</span>
<span class="hljs-number">10</span>.  ]

`<span class="hljs-type">AI写代码</span>![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>这个分隔符列表非常适用于通用的 markdown 使用场景，会根据 6 个标题级别和分段字符进行拆分。</p>
<p>在创建资源（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference" title="https://www.elastic.co/docs/explore-analyze/elastic-inference" target="_blank" ref="nofollow noopener noreferrer">推理</a>端点 / 语义文本字段）时，与分隔符组对应的分隔符列表会存储在你的配置中。如果分隔符组在之后被更新，它不会改变你已创建资源的行为。</p>
<h3 data-id="heading-5">使用自定义分隔符列表</h3>
<p>如果预定义的分隔符组不适合你的使用场景，你可以定义一个符合需求的自定义分隔符列表。请注意，分隔符列表中可以使用正则表达式。以下是一个使用自定义分隔符配置分块设置的示例：</p>
<pre><code class="hljs language-swift" lang="swift">`

<span class="hljs-number">1</span>.  <span class="hljs-string">"chunking_settings"</span>: {
<span class="hljs-number">2</span>.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
<span class="hljs-number">3</span>.      <span class="hljs-string">"max_chunk_size"</span>: <span class="hljs-number">25</span>,
<span class="hljs-number">4</span>.      <span class="hljs-string">"separators"</span>: [<span class="hljs-string">"<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>, <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>, <span class="hljs-string">"&lt;my-custom-separator&gt;"</span>]
<span class="hljs-number">5</span>.  }

`<span class="hljs-type">AI写代码</span>
</code></pre>
<p>上面的分块策略会先按两个换行符拆分，然后按一个换行符拆分，最后按字符串 “” 拆分。</p>
<h2 data-id="heading-6">递归分块示例</h2>
<p>让我们来看一个递归分块的实际示例。在这个例子中，我们使用以下分块设置，通过自定义分隔符列表按 markdown 文档的前两个标题级别进行拆分：</p>
<pre><code class="hljs language-swift" lang="swift">`

<span class="hljs-number">1</span>.  <span class="hljs-string">"chunking_settings"</span>: {
<span class="hljs-number">2</span>.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
<span class="hljs-number">3</span>.      <span class="hljs-string">"max_chunk_size"</span>: <span class="hljs-number">25</span>,
<span class="hljs-number">4</span>.      <span class="hljs-string">"separators"</span>: [<span class="hljs-string">"<span class="hljs-subst">\n</span># "</span>, <span class="hljs-string">"<span class="hljs-subst">\n</span>## "</span>]
<span class="hljs-number">5</span>.  }

`<span class="hljs-type">AI写代码</span>
</code></pre>
<p>让我们来看一个未分块的简单 Markdown 文档：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778a416a940547818868c450f97341fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512448&amp;x-signature=yGix2SAmSFVtGHQ3%2FMXFSeJe8Zw%3D" alt="" loading="lazy"/></p>
<p>现在让我们使用上面定义的分块设置来对文档进行分块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4c1a5b79c064a1bafc72d38de799c99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512448&amp;x-signature=e1pJH%2BnHSc1ktztddMOg1m3SJ3w%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccd29a02d55c448cba78434a1c267607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512448&amp;x-signature=r%2BOzsLYJimFl4pOIQ8i8PNCgnKE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dbcef7021f04d5cab76e1df0627841d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512448&amp;x-signature=e49ikxjbrzHNsJrMp0ZDeCqP36w%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：每个分块末尾的换行符（除了分块 3）未高亮显示，但包含在实际的分块边界内。</p>
</blockquote>
<h2 data-id="heading-7">今天就开始使用递归分块吧！</h2>
<p>有关如何使用此功能的更多信息，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference%2Finference-api%23chunking-strategies" title="https://www.elastic.co/docs/explore-analyze/elastic-inference/inference-api#chunking-strategies" target="_blank" ref="nofollow noopener noreferrer">配置分块设置的文档</a>。</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Frecursive-chunking-structured-documents-elasticsearch" title="https://www.elastic.co/search-labs/blog/recursive-chunking-structured-documents-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当上传不再只是 /upload，我们是怎么设计大文件上传的]]></title>    <link>https://juejin.cn/post/7571355989133099023</link>    <guid>https://juejin.cn/post/7571355989133099023</guid>    <pubDate>2025-11-12T01:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133099023" data-draft-id="7570394530316369920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当上传不再只是 /upload，我们是怎么设计大文件上传的"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-12T01:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛卡卡了"/> <meta itemprop="url" content="https://juejin.cn/user/888839672963544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当上传不再只是 /upload，我们是怎么设计大文件上传的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888839672963544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛卡卡了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:58:46.000Z" title="Wed Nov 12 2025 01:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">业务背景</h3>
<p>在正式讲之前，先看一个我们做的大文件上传demo。<br/>
下面这个视频演示的是上传一个 1GB 的压缩包，整个过程支持分片上传、断点续传、暂停和恢复。</p>
<p>可以看到速度不是特别快，这个是我故意没去优化的。<br/>
前端那边计算文件 MD5、以及最后合并文件的时间我都保留了，<br/>
主要是想让大家能看到整个流程是怎么跑通的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb07ebdb67942bf8bbb528d0913c679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517525&amp;x-signature=xLviIrXTV3tcfpMPnD62Tn%2F8SBc%3D" alt="output1111.gif" loading="lazy"/></p>
<p>平时我们在做一些 SaaS 系统的时候，文件上传这块其实基本上都设计的挺简单的。<br/>
前端做个分片上传，后端把分片合并起来，最后存 OSS 或者服务器某个路径上，再返回一个 URL 就完事了。<br/>
大多数情况下，这样的方案也确实够用。</p>
<p>但是最近我在做一个私有化项目，场景完全不一样。<br/>
项目是给政企客户部署的内部系统，里面有 AI 大模型客服问答的功能。<br/>
客户需要把他们内部的文档、手册、规范、图纸、流程等资料打包上传到服务器，用来做后续的向量化、知识检索或者模型训练。</p>
<p>这类场景如果还沿用之前 SaaS 系统那种上传方式，往往就不太适用了。<br/>
因为这些文件往往有几个共同点：</p>
<ol start="0">
<li>文件数量多，动辄几百上千份（Word、PDF、PPT、Markdown 都有）；</li>
<li>文件体积大，打成 zip 动不动就是几个 G，甚至十几二十个 G；</li>
<li>上传环境复杂，客户一般在内网或局域网，有的甚至完全断网；</li>
<li>有安全要求，文件不能经过云端 OSS，里面可能有保密资料；</li>
<li>需要审计，要能知道是谁上传的、什么时候传的、文件现在存哪；</li>
<li>上传完之后还要进一步处理，比如自动解压、解析文本、拆页、向量化，然后再存入 Milvus 或 pgvector。</li>
</ol>
<p>所以这种情况还用 SaaS 系统那种“简单上传+云存储”方案的话，那可能问题就一堆：</p>
<ul>
<li>上传中断后用户一刷新浏览器就得重传整个包；</li>
<li>集群部署时分片打到不同机器上根本无法合并；</li>
<li>多人同时上传可能会发生文件覆盖或路径冲突；</li>
<li>没有任何上传记录，也追踪不到是谁传的；</li>
<li>对政企来说，审计、合规、保密全都不达标。</li>
</ul>
<p>所以，我们需要重新设计文件上传的功能逻辑。<br/>
目的是让它不仅能支持大文件、断点续传、集群部署，还能同时适配内网环境、权限管控，以及后续的 AI 文档解析和知识向量化等处理流程。</p>
<hr/>
<h3 data-id="heading-1">为什么很多项目只需要一个 upload 接口</h3>
<p>如果我们回头看一下自己平常做过的一些常规 Web 项目，尤其是各种 SaaS 系统或者后台管理系统，<br/>
其实大多数时候后端只会提供一个 <code>/upload</code> 接口， 前端拿到文件后直接调用这个接口，后端保存文件再返回一个 URL 就结束了。</p>
<p>甚至我们在很多项目里，前端都不会把文件传给业务服务，<br/>
而是直接通过前端 SDK（比如阿里云 OSS、腾讯云 COS、七牛云等）上传到云存储，<br/>
上传完后拿到文件地址，再把这个地址回传给后端保存。</p>
<p>这种方式在 SaaS 系统或者轻量级的业务里非常普遍，也非常高效。 主要原因有几个：</p>
<ol>
<li><strong>文件都比较小</strong>，大多数就是几 MB 的图片、PDF 或 Excel；</li>
<li><strong>云存储足够稳定</strong>，上传、下载、访问都有完整的 SDK 支撑；</li>
<li><strong>系统是公网部署</strong>，不需要考虑局域网、内网断网这些问题；</li>
<li><strong>对安全和审计的要求不高</strong>，文件内容也不是涉密数据；</li>
<li><strong>用户体验优先</strong>，所以直接把文件上传到云端是最省事的方案。</li>
</ol>
<p>换句话说，这种“一个 upload 接口”或“前端直传 OSS”模式，其实是面向<strong>通用型 SaaS 场景</strong>的。<br/>
对于绝大多数互联网业务来说，它既够快又够省心。</p>
<p>但一旦项目换成政企、私有化部署或者 AI 训练平台这种环境，<br/>
就完全不是一个量级的问题了。<br/>
这里的关键不在“能不能上传”，<br/>
而在于<strong>文件上传之后的可控性、可追溯性和安全性</strong>。</p>
<hr/>
<h3 data-id="heading-2">前端常见的大文件上传方式</h3>
<p>在重新设计后端接口之前，我们先来看看现在前端常见的大文件上传思路。<br/>
其实近几年前端这块已经比较成熟了，主流方案大体都是围绕几个核心点展开的：<br/>
<strong>秒传检测、分片上传、断点续传、并发控制、进度展示。</strong></p>
<p>一般来说，前端拿到文件后，会先计算一个文件哈希值，比如用 MD5。<br/>
这样做的目的是为了做<strong>秒传检测</strong>：<br/>
如果服务器上已经存在这个文件，就可以直接跳过上传，节省时间和带宽。</p>
<p>接下来是<strong>分片上传</strong>。<br/>
文件太大时，前端会把文件拆成多个固定大小的小块（比如每块 5MB 或 10MB），<br/>
然后一片一片地上传。这样做可以避免一次性传输大文件导致浏览器卡顿或网络中断。</p>
<p>然后就是<strong>断点续传</strong>。<br/>
前端会记录哪些分片已经上传成功，如果上传过程中网络中断或浏览器刷新，<br/>
下次只需要从未完成的分片继续上传，不用重新传整包文件。</p>
<p>在性能方面，前端还会做<strong>并发控制</strong>。<br/>
比如同时上传三到五个分片，上传完一个就立刻补下一个，<br/>
这样整体速度比单线程串行上传要快很多。</p>
<p>最后是<strong>进度展示</strong>。<br/>
通过监听每个分片的上传状态，前端可以计算整体进度，<br/>
给用户展示一个实时的上传百分比或进度条，让体验更可控。</p>
<p>可以看到，前端的大文件上传方案已经形成了一套相对标准的模式。<br/>
所以这次我在重新设计后端的时候，就打算基于这种前端逻辑，<br/>
去构建一套更贴合企业私有化环境的上传接口控制体系。<br/>
目标是让前后端的职责划分更清晰：<br/>
前端负责切片、控制与恢复；后端负责存储、校验与合并。</p>
<hr/>
<h3 data-id="heading-3">后端接口设计思路</h3>
<p>前端的大文件上传流程其实已经相对固定了，我们只要让后端的接口和它配合得上，就能把整个上传链路打通。<br/>
所以我这次重新设计时，把上传接口拆成了几个比较独立的阶段：<br/>
<strong>秒传检查、初始化任务、上传分片、合并文件、暂停任务、取消任务、任务列表。</strong><br/>
每个接口都只负责一件事，这样接口的职责会更清晰，也方便后期扩展。</p>
<h4 data-id="heading-4">一、/upload/check —— 秒传检查</h4>
<p>这个接口是整个流程的第一步，用来判断文件是否已经上传过。<br/>
前端在计算完文件的全局 MD5（或其他 hash）后，会先调这个接口。<br/>
如果后端发现数据库里已经有相同 hash 的文件，就直接返回“已存在”，前端就不用再上传了。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/check
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"fileHash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"md5_abc123def456"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fileName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"training-docs.zip"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fileSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5342245120</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"exists"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果 <code>exists = true</code>，说明服务端已经有这个文件，可以直接走“秒传成功”的逻辑。</p>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/check")</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; checkFile(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; body) {
    <span class="hljs-comment">// 1. 校验 fileHash 参数是否为空</span>
    <span class="hljs-comment">// 2. 查询 file_info 表是否已有该文件</span>
    <span class="hljs-comment">// 3. 如果文件已存在，直接返回秒传成功（exists = true）</span>
    <span class="hljs-comment">// 4. 如果文件不存在，查询 upload_task 表中是否有未完成任务（支持断点续传）</span>
}
</code></pre>
<h4 data-id="heading-5">二、/upload/init —— 初始化上传任务</h4>
<p>如果文件不存在，就要先初始化一个新的上传任务。<br/>
这个接口的作用是创建一条 <code>upload_task</code> 记录，同时返回一个唯一的 <code>uploadId</code>。<br/>
前端会用这个 uploadId 来标识整个上传过程。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/init
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"fileHash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"md5_abc123def456"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fileName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"training-docs.zip"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"totalChunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">320</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"chunkSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"uploadedChunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>uploadedChunks</code> 用来支持断点续传，如果之前有部分分片上传过，就会在这里返回索引数组。</p>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/init")</span>
<span class="hljs-keyword">public</span> Result&lt;UploadInitResponse&gt; <span class="hljs-title function_">initUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UploadInitRequest request)</span> {
    <span class="hljs-comment">// 1. 检查是否已有同 fileHash 的任务，若有则返回旧任务信息（支持断点续传）</span>
    <span class="hljs-comment">// 2. 否则创建新的 upload_task 记录，生成 uploadId</span>
    <span class="hljs-comment">// 3. 初始化分片数量、大小、状态等信息</span>
    <span class="hljs-comment">// 4. 返回 uploadId 与已上传分片索引列表</span>
}

</code></pre>
<h4 data-id="heading-6">三、/upload/chunk —— 上传单个分片</h4>
<p>这是整个上传过程里调用次数最多的接口。<br/>
每个分片都会单独上传一次，并在服务端保存为临时文件，同时写入 <code>upload_chunk</code> 表。<br/>
上传成功后，后端会更新 <code>upload_task</code> 的进度信息。</p>
<p><strong>请求示例（表单上传）：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/chunk
Content-Type<span class="hljs-punctuation">:</span> multipart/form-data

formData<span class="hljs-punctuation">:</span>
  uploadId<span class="hljs-punctuation">:</span> b4f8e3a7<span class="hljs-number">-1</span>a0c<span class="hljs-number">-4</span>a1d<span class="hljs-number">-88</span>af<span class="hljs-number">-61e98</span>d91a49b
  chunkIndex<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
  chunkSize<span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span>
  chunkHash<span class="hljs-punctuation">:</span> md5_001
  file<span class="hljs-punctuation">:</span> (二进制分片数据)
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"chunkIndex"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"chunkSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping(value = "/chunk", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; uploadChunk(<span class="hljs-meta">@ModelAttribute</span> UploadChunkRequest req) {
    <span class="hljs-comment">// 1. 校验任务状态，禁止上传已取消或已完成的任务</span>
    <span class="hljs-comment">// 2. 检查本地目录（或云端存储桶）是否存在，不存在则创建</span>
    <span class="hljs-comment">// 3. 接收当前分片文件并写入临时路径</span>
    <span class="hljs-comment">// 4. 写入 upload_chunk 表，标记状态为 “已上传”</span>
    <span class="hljs-comment">// 5. 更新 upload_task 的 uploaded_chunks 数量</span>
}

</code></pre>
<h4 data-id="heading-7">四、/upload/merge —— 合并分片</h4>
<p>当前端确认所有分片都上传完后，会调用 <code>/upload/merge</code>。<br/>
后端收到这个请求后，去检查所有分片是否完整，然后按照索引顺序依次合并。<br/>
合并成功后，会删除临时分片文件，并更新 <code>upload_task</code> 状态为“完成”。<br/>
如果启用了云存储，这一步也可以直接把合并后的文件上传到 OSS。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/merge
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fileHash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"md5_abc123def456"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文件合并成功"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"storagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/data/uploads/training-docs.zip"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/merge")</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; mergeFile(<span class="hljs-meta">@RequestBody</span> UploadMergeRequest req) {
    <span class="hljs-comment">// 1. 检查 upload_task 状态是否允许合并</span>
    <span class="hljs-comment">// 2. 校验所有分片是否都上传完成</span>
    <span class="hljs-comment">// 3. 如果是本地存储：按 chunk_index 顺序流式合并文件</span>
    <span class="hljs-comment">// 4. 如果是云存储：调用云端分片合并 API（如 OSS、COS）</span>
    <span class="hljs-comment">// 5. 校验文件 hash 完整性，更新任务状态为 COMPLETED</span>
    <span class="hljs-comment">// 6. 将最终文件信息写入 file_info 表</span>
}
</code></pre>
<h4 data-id="heading-8">五、/upload/pause —— 暂停任务</h4>
<p>这个接口用于在上传过程中手动暂停任务。<br/>
前端可能会在网络波动或用户主动点击暂停时调用。<br/>
后端会更新任务状态为“已暂停”，并记录当前已上传的分片数。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/pause
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务已暂停"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/pause")</span>
<span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">pauseUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UploadPauseRequest req)</span> {
    <span class="hljs-comment">// 1. 查找对应的 upload_task</span>
    <span class="hljs-comment">// 2. 更新任务状态为 “已暂停”</span>
    <span class="hljs-comment">// 3. 返回任务状态确认信息</span>
}
</code></pre>
<h4 data-id="heading-9">六、/upload/cancel —— 取消任务</h4>
<p>如果用户想放弃本次上传，可以调用 <code>/cancel</code>。<br/>
后端会把任务状态标记为“已取消”，并清理对应的临时分片文件。<br/>
这样能避免磁盘上堆积无用数据。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">POST /api/upload/cancel
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务已取消"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/cancel")</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; cancelUpload(<span class="hljs-meta">@RequestBody</span> UploadCancelRequest req) {
    <span class="hljs-comment">// 1. 查找对应的 upload_task</span>
    <span class="hljs-comment">// 2. 更新任务状态为 “已取消”</span>
    <span class="hljs-comment">// 3. 删除或标记已上传的分片文件为待清理</span>
    <span class="hljs-comment">// 4. 返回操作结果</span>
}
</code></pre>
<h4 data-id="heading-10">七、/upload/list —— 查询任务列表</h4>
<p>这个接口我们用于管理后台查看当前上传任务的整体情况。<br/>
可以展示每个任务的文件名、大小、进度、状态、上传人等信息，方便追踪和审计。</p>
<p><strong>请求示例：</strong></p>
<pre><code class="hljs language-json" lang="json">GET /api/upload/list
</code></pre>
<p><strong>返回示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"uploadId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b4f8e3a7-1a0c-4a1d-88af-61e98d91a49b"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"fileName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"training-docs.zip"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"COMPLETED"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"uploadedChunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">320</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"totalChunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">320</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"uploader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"createdAt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-10-20 14:30:12"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>伪代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/list")</span>
<span class="hljs-keyword">public</span> Result&lt;List&lt;UploadTaskSummary&gt;&gt; <span class="hljs-title function_">listUploadTasks</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 查询所有上传任务</span>
    <span class="hljs-comment">// 2. 按创建时间或状态排序</span>
    <span class="hljs-comment">// 3. 返回任务摘要信息（任务名、状态、进度、上传人等）</span>
}
</code></pre>
<h4 data-id="heading-11">接口调用顺序小结</h4>
<p>那我们这整个上传过程的调用顺序就是：</p>
<pre><code class="hljs language-bash" lang="bash">1. /upload/check     → 秒传检测
2. /upload/init      → 初始化上传任务
3. /upload/chunk     → 循环上传所有分片
4. /upload/merge     → 所有分片完成后合并
（可选）/upload/pause、/upload/cancel 用于控制任务
（可选）/upload/list 用于任务追踪与审计
</code></pre>
<h4 data-id="heading-12">接口调用顺序示意图</h4>
<p>下面这张时序图展示了前端、后端、数据库在整个上传过程中的交互关系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5f79241f518495f8774a900301e638f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517525&amp;x-signature=Kcr8YME9sua2zjXuRaAfOSQGCSY%3D" alt="Untitled diagram-2025-11-10-031845.png" loading="lazy"/></p>
<p>这样安排有几个好处：</p>
<ol>
<li><strong>逻辑衔接顺</strong>：上面刚讲完每个接口的职责，下面立刻用图总结；</li>
<li><strong>视觉节奏平衡</strong>：读者读到这里已经看了不少文字，用图能缓解阅读疲劳；</li>
<li><strong>承上启下</strong>：这张图既总结接口流程，又能自然引出下一节“数据库表设计”。</li>
</ol>
<p>这套接口设计基本能覆盖大文件上传在企业项目中的常见需求。<br/>
接下来，我们再来看看支撑这套接口背后的数据库表设计。<br/>
数据库的作用是让上传任务的状态可追踪、可恢复，也能在集群部署时保持一致性。</p>
<hr/>
<h3 data-id="heading-13">数据库表设计思路</h3>
<p>前面说的那一套接口，要真正稳定地跑起来，<br/>
后端必须有一套能记录任务状态、分片信息、文件存储路径的数据库结构。<br/>
因为上传这种场景不是“一次请求就结束”的操作，它往往会持续几分钟甚至几个小时，<br/>
所以我们需要让任务状态可以追踪、可以恢复，还要能支撑集群部署。</p>
<p>我这次主要设计了三张核心表：<br/>
<code>upload_task</code>（上传任务表）、<code>upload_chunk</code>（分片表）、<code>file_info</code>（文件信息表）。<br/>
它们分别负责记录任务、分片和最终文件三层的数据关系。</p>
<h4 data-id="heading-14">一、upload_task —— 上传任务表</h4>
<p>这张表是整个上传过程的“总账”，<br/>
每一个文件上传任务，不管分成多少片，都会在这里生成一条记录。<br/>
它主要用来保存任务的全局信息，比如文件名、大小、上传进度、状态、存储方式等。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `upload_task` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `upload_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务唯一ID（UUID）'</span>,
  `file_hash` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件哈希（用于秒传与断点续传）'</span>,
  `file_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件名称'</span>,
  `file_size` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件总大小（字节）'</span>,
  `chunk_size` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'每个分片大小（字节）'</span>,
  `total_chunks` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'分片总数'</span>,
  `uploaded_chunks` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'已上传分片数量'</span>,
  `status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'任务状态：0-待上传 1-上传中 2-合并中 3-完成 4-取消 5-失败 6-已合并 7-已暂停'</span>,
  `storage_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'local'</span> COMMENT <span class="hljs-string">'存储类型：local/oss/cos/minio/s3等'</span>,
  `storage_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件最终存储地址（云端或本地路径）'</span>,
  `local_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'本地临时文件或合并文件路径'</span>,
  `remark` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'备注信息'</span>,
  `uploader` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'上传人'</span>,
  `created_at` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  `updated_at` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `upload_id` (`upload_id`),
  KEY `idx_hash` (`file_hash`),
  KEY `idx_status` (`status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'上传任务表（支持多种云存储）'</span>;
</code></pre>
<p><strong>设计要点：</strong></p>
<ul>
<li><code>upload_id</code> 是前端初始化任务后由后端生成的唯一标识；</li>
<li><code>file_hash</code> 用来支持秒传逻辑；</li>
<li><code>status</code> 控制任务生命周期（等待、上传中、合并中、完成等）；</li>
<li><code>storage_type</code>、<code>storage_url</code> 可以兼容多种存储方案（本地、OSS、COS、MinIO）；</li>
<li><code>uploaded_chunks</code> 字段让任务能随时恢复，适配断点续传。</li>
</ul>
<h4 data-id="heading-15">二、upload_chunk —— 分片表</h4>
<p>这张表对应每个上传任务下的所有分片。<br/>
每一个分片都会单独在这里占一条记录，用来追踪它的上传状态。<br/>
这张表的存在让我们能做断点续传、进度统计、以及合并前的完整性检查。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `upload_chunk` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `upload_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'所属上传任务ID'</span>,
  `chunk_index` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'分片索引（从0开始）'</span>,
  `chunk_size` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'实际分片大小（字节）'</span>,
  `chunk_hash` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'可选：分片hash（用于高级去重）'</span>,
  `status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'状态：0-待上传 1-已上传 2-已合并'</span>,
  `local_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'分片本地路径'</span>,
  `created_at` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  `updated_at` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uniq_task_chunk` (`upload_id`,`chunk_index`),
  KEY `idx_upload_id` (`upload_id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'上传分片表'</span>;
</code></pre>
<p><strong>设计要点：</strong></p>
<ul>
<li><code>upload_id</code> 是任务外键，和 <code>upload_task</code> 一一对应；</li>
<li><code>chunk_index</code> 代表分片顺序，合并文件时会按这个排序；</li>
<li><code>chunk_hash</code> 可选字段，用来在上传前后做完整性校验；</li>
<li><code>status</code> 字段控制上传进度（待上传、已上传、已合并）；</li>
<li>唯一索引 (<code>upload_id</code>, <code>chunk_index</code>) 避免重复插入分片。</li>
</ul>
<p>通过这张表，我们可以轻松实现断点续传：<br/>
当用户重新开始上传时，后端只返回未完成的分片索引，前端跳过已上传的部分。</p>
<h4 data-id="heading-16">三、file_info —— 文件信息表</h4>
<p>这张表记录的是上传完成后的“最终文件信息”，<br/>
相当于系统的文件索引表。只要文件合并成功并通过校验，<br/>
后端就会往这里写入一条记录。</p>
<p>这张表支撑秒传功能，也能被后续的文档解析或向量化任务使用。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `file_info` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `file_hash` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件hash，用于秒传'</span>,
  `file_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件名称'</span>,
  `file_size` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件大小'</span>,
  `storage_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'local'</span> COMMENT <span class="hljs-string">'存储类型：local/oss/cos/minio/s3等'</span>,
  `storage_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'文件最终存储地址（云端或本地路径）'</span>,
  `uploader` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'上传人'</span>,
  `status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'状态：1-正常，2-删除中，3-已归档'</span>,
  `remark` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'备注'</span>,
  `created_at` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `file_hash` (`file_hash`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'已上传文件信息表（支持多云存储）'</span>;
</code></pre>
<p><strong>设计要点：</strong></p>
<ul>
<li><code>file_hash</code> 是全局唯一标识，用于秒传和查重；</li>
<li><code>storage_url</code> 记录最终可访问路径；</li>
<li><code>status</code> 可扩展为删除、归档等后续操作；</li>
<li>这张表和业务系统中的“文档解析”、“知识库构建”可以直接关联。</li>
</ul>
<h4 data-id="heading-17">四、三张表之间的关系</h4>
<p>这三张表之间的关系我们可以简单理解为：</p>
<pre><code class="hljs language-scss" lang="scss">upload_task  (上传任务)
    ├── upload_chunk (分片详情)
    └── file_info    (最终文件)
</code></pre>
<ul>
<li><code>upload_task</code> 管理任务生命周期；</li>
<li><code>upload_chunk</code> 跟踪每个分片的上传进度；</li>
<li><code>file_info</code> 保存最终文件索引，用于秒传与后续 AI 处理。</li>
</ul>
<p>这样设计的好处是：</p>
<ul>
<li>上传状态可追踪；</li>
<li>上传任务可恢复；</li>
<li>文件信息可统一管理；</li>
<li>多节点部署也能保证一致性。</li>
</ul>
<hr/>
<h3 data-id="heading-18">上传状态流转与任务恢复机制</h3>
<p>有了前面的三张核心表，整个上传的过程就能被“状态机化”管理。<br/>
简单来说，我们希望每一个上传任务从创建、上传、合并到完成，都能有一个明确的状态，<br/>
系统也能在任意阶段中断后恢复，不需要用户重新来一遍。</p>
<p>我们把整个上传任务的生命周期划分成几个关键状态：</p>
<pre><code class="hljs language-java" lang="java">WAITING(<span class="hljs-number">0</span>, <span class="hljs-string">"待上传"</span>),
UPLOADING(<span class="hljs-number">1</span>, <span class="hljs-string">"上传中"</span>),
MERGING(<span class="hljs-number">2</span>, <span class="hljs-string">"合并中"</span>),
COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>),
CANCELED(<span class="hljs-number">4</span>, <span class="hljs-string">"已取消"</span>),
FAILED(<span class="hljs-number">5</span>, <span class="hljs-string">"上传失败"</span>),
CHUNK_MERGED(<span class="hljs-number">6</span>, <span class="hljs-string">"已合并"</span>),
PAUSED(<span class="hljs-number">7</span>, <span class="hljs-string">"已暂停"</span>);
</code></pre>
<h4 data-id="heading-19">一、WAITING（待上传）</h4>
<p>当用户在前端发起上传、文件切片还没真正传上来之前，<br/>
系统会先生成一个上传任务记录（也就是 <code>/upload/init</code> 接口那一步）。<br/>
这个时候任务只是“登记”在数据库里，还没开始传数据。</p>
<p>我们可以理解为：</p>
<blockquote>
<p>任务刚创建，还没开始跑。</p>
<p>此时前端拿到 uploadId，就可以开始逐片上传了。</p>
</blockquote>
<p>在数据库层面，<code>upload_task.status = 0</code>，所有的分片表里还没有数据。</p>
<h4 data-id="heading-20">二、UPLOADING（上传中）</h4>
<p>当第一个分片开始上传时，系统会把任务状态更新为 <strong>上传中</strong>。<br/>
这时候每上传一块分片，都会往 <code>upload_chunk</code> 表里写入一条记录，<br/>
并且更新任务的 <code>uploaded_chunks</code> 字段。</p>
<p>我们会周期性地根据分片上传数量去更新进度条，<br/>
比如已上传 35 / 100 块，系统就知道这部分可以恢复。</p>
<p>这个阶段是任务生命周期里最活跃的一段：<br/>
用户可能暂停、断网、刷新页面、甚至浏览器崩溃。<br/>
但是没关系，因为分片信息都落地到数据库了，<br/>
我们能随时通过 <code>upload_chunk</code> 的状态重新恢复上传。</p>
<h4 data-id="heading-21">三、PAUSED（已暂停）</h4>
<p>如果用户主动点击“暂停上传”，<br/>
系统就会把任务状态标记为 <code>PAUSED</code>。</p>
<p>暂停并不会删除分片，只是告诉系统“不要再继续发请求”。<br/>
这样当用户重新点击“继续上传”时，<br/>
前端只需从后端拿到“哪些分片还没上传”，就能断点续传。</p>
<p>这个状态一般只在用户控制的情况下出现，<br/>
比如网络不好、或者中途切换网络时暂停。</p>
<h4 data-id="heading-22">四、CANCELED（已取消）</h4>
<p>取消和暂停不同，取消意味着用户彻底放弃了这个上传任务。<br/>
任务会被标记为 <code>CANCELED</code>，同时系统可以选择：</p>
<ul>
<li>删除已经上传的临时分片文件；</li>
<li>或者保留一段时间等待清理任务。</li>
</ul>
<p>在后台日志中，这个状态主要用于审计：<br/>
记录谁取消了任务、在什么时间、上传了多少进度。</p>
<h4 data-id="heading-23">五、MERGING（合并中）</h4>
<p>当所有分片都上传完成后，<br/>
后端会自动或手动触发文件合并逻辑（调用 <code>/upload/merge</code>）。<br/>
此时任务状态会切换为 <strong>MERGING</strong>，表示系统正在进行最后一步。</p>
<p>在这一步里：</p>
<ul>
<li>如果是本地存储，会逐个读取分片文件并拼接为完整文件；</li>
<li>如果是云存储（比如 OSS、MinIO），则会触发服务端的分片合并 API。</li>
</ul>
<p>合并过程通常比较耗时，尤其是几 GB 的文件，<br/>
所以单独拿出来作为一个明确状态是必要的。</p>
<h4 data-id="heading-24">六、CHUNK_MERGED（已合并）</h4>
<p>有些系统会把合并成功但未做后续处理的状态单独标出来，<br/>
比如文件已经合并，但还没入库、还没解析。<br/>
这个状态可以让我们在合并之后还有机会做文件校验或后处理。</p>
<p>不过在实际项目里，也可以直接跳过这一步，<br/>
合并完后立刻进入下一状态——<code>COMPLETED</code>。</p>
<h4 data-id="heading-25">七、COMPLETED（已完成）</h4>
<p>文件合并完成、验证通过、存储路径落地、写入 <code>file_info</code> 表，<br/>
这时候任务就算彻底完成了。</p>
<p>在这个状态下：</p>
<ul>
<li>用户可以正常访问文件；</li>
<li>系统可以执行后续的解析任务（比如文档拆页、向量化等）；</li>
<li>文件具备秒传条件，下次再上传同样的文件会直接跳过。</li>
</ul>
<p><code>COMPLETED</code> 是整个生命周期的终点状态。<br/>
在数据库中，任务记录会更新最终路径、存储类型、完成时间等字段。</p>
<h4 data-id="heading-26">八、FAILED（上传失败）</h4>
<p>上传过程中如果出现异常，比如网络中断、磁盘写入异常、OSS 上传失败等，<br/>
系统会标记任务为 <code>FAILED</code>。<br/>
这一状态不会自动清理，<br/>
方便管理员事后追踪错误原因或人工恢复。</p>
<p>失败任务在设计上一般允许“重新启动”，<br/>
也就是通过任务 ID 重新触发上传，从未完成的分片继续。</p>
<p>我们可以通过下面这张图可以更直观地看到整个上传任务的生命周期：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26c793e4d0b4e418d2c8dd72653b72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517525&amp;x-signature=2puIDO4Ge2N6k5yY%2BVJ4srWSB1c%3D" alt="Untitled diagram-2025-11-10-033341.png" loading="lazy"/></p>
<h4 data-id="heading-27">九、任务恢复机制</h4>
<p>在这套机制下，任务恢复就变得非常自然。<br/>
前端每次进入上传页面时，只要传入文件的 hash，<br/>
后端就能通过 <code>upload_task</code> 和 <code>upload_chunk</code> 判断：</p>
<ol>
<li>这个文件有没有上传任务；</li>
<li>如果有，哪些分片已经上传；</li>
<li>任务当前状态是什么（暂停、失败还是上传中）。</li>
</ol>
<p>然后前端只需补传那些未上传的分片即可。<br/>
这就是我们常说的 <strong>断点续传（Resumable Upload）</strong> 。</p>
<p>在集群环境中，这套逻辑同样成立，<br/>
因为任务与分片状态都落在数据库，不依赖单台服务器。<br/>
无论请求打到哪一台机器，上传进度都是统一可见的。</p>
<h4 data-id="heading-28">十、中断后如何续传</h4>
<p>在实际使用中，用户上传中断是很常见的。<br/>
比如文件太大上传到一半，浏览器突然关了；<br/>
或者公司网络断了，机器重启了；<br/>
甚至有人直接换了电脑继续操作。</p>
<p>如果系统没有任务恢复机制，那用户每次都得重新传一遍，<br/>
尤其是那种几个 G 的文件，不但浪费时间，还容易出错。<br/>
所以我们在设计这套上传中心时，<br/>
一开始就考虑了“<strong>断点续传</strong>”和“<strong>任务恢复</strong>”的问题。</p>
<p><strong>1. 恢复上传靠的其实是数据库里的状态</strong></p>
<p>断点续传的核心逻辑，其实很简单：<br/>
我们让任务和分片的状态都写进数据库。</p>
<p>每当用户重新进入上传页面、选中同一个文件时，<br/>
前端会先计算出文件的 hash，然后调用 <code>/upload/check</code> 接口。<br/>
后端收到 hash 后，会依次去查三张表：</p>
<ol>
<li>
<p><strong>先查 <code>file_info</code></strong><br/>
如果能查到，说明文件之前已经上传并合并成功，<br/>
这时候直接返回“文件已存在”，前端就能实现“秒传”，不需要重新上传。</p>
</li>
<li>
<p><strong>查不到 <code>file_info</code>，就去查 <code>upload_task</code></strong><br/>
如果找到了对应任务，就说明这个文件上传到一半被中断了。<br/>
这时我们会返回这个任务的 uploadId。</p>
</li>
<li>
<p><strong>再查 `upload_chunk``</strong><br/>
系统会统计出哪些分片已经上传成功，哪些还没传。<br/>
然后返回一个“未完成的分片索引列表”给前端。</p>
</li>
</ol>
<p>前端拿到这些信息后，就能从中断的地方继续往下传，<br/>
不用再重复上传已经完成的部分。</p>
<p><strong>2. 前端续传时的流程</strong></p>
<p>前端拿到旧的 uploadId 和未完成分片列表后，<br/>
只需要跳过那些已经上传成功的分片，<br/>
然后照常调用 <code>/upload/chunk</code> 去上传剩下的部分。</p>
<p>上传过程中，每个分片的状态都会被实时更新到 <code>upload_chunk</code> 表中，<br/>
<code>upload_task</code> 表的 uploaded_chunks 也会跟着同步增加。<br/>
当所有分片都上传完后，任务状态自动进入 MERGING（合并中）阶段。</p>
<p>所以整个续传过程，其实就是**“基于数据库状态的增量上传”**。<br/>
用户不需要额外操作，系统自己就能恢复上次的进度。</p>
<p><strong>3. 任务状态和恢复判断</strong></p>
<p>任务是否允许恢复，系统会根据 <code>upload_task.status</code> 来判断。<br/>
大致逻辑是这样的：</p>













































<table><thead><tr><th>状态</th><th>是否可恢复</th><th>说明</th></tr></thead><tbody><tr><td>WAITING</td><td>可以</td><td>任务刚创建，还没开始传</td></tr><tr><td>UPLOADING</td><td>可以</td><td>正在上传中，可以继续</td></tr><tr><td>PAUSED</td><td>可以</td><td>用户主动暂停，可以恢复</td></tr><tr><td>FAILED</td><td>可以</td><td>上传失败，可以重新尝试</td></tr><tr><td>CANCELED</td><td>不可以</td><td>用户主动取消，不再恢复</td></tr><tr><td>COMPLETED</td><td>不需要</td><td>已经完成，直接秒传</td></tr><tr><td>MERGING</td><td>等待中</td><td>系统正在合并，前端等待即可</td></tr></tbody></table>
<p>这套判断逻辑让任务的行为更清晰。<br/>
比如用户暂停上传再回来时，可以直接恢复；<br/>
如果任务已经取消，那就算用户重启也不会再自动续传。</p>
<p><strong>4. 多机器部署下的恢复问题</strong></p>
<p>有些人会担心：如果我们的系统是集群部署的，<br/>
上传时中断后再续传，万一请求打到另一台机器上，<br/>
还能恢复吗？</p>
<p>其实没问题。<br/>
因为我们所有任务和分片的状态都是写进数据库的，<br/>
不依赖内存或本地文件。</p>
<p>也就是说，哪怕用户上次上传在 A 机器，这次续传到了 B 机器，<br/>
系统仍然能根据数据库的记录知道：<br/>
这个 uploadId 下的哪些分片已经上传完，哪些还没传。</p>
<p>所以集群部署下也能无缝续传，不会出现“不同机器不认任务”的情况。</p>
<p><strong>5. 小结</strong></p>
<p>整个任务恢复机制靠的就是两张表：<code>upload_task</code> 和 <code>upload_chunk</code>。<br/>
<code>upload_task</code> 负责记录任务总体进度，<br/>
<code>upload_chunk</code> 负责记录每个分片的上传状态。</p>
<p>当用户重新上传时，我们查表判断进度，<br/>
前端从未完成的地方继续传，就能实现真正意义上的“断点续传”。</p>
<p>这套机制有几个显著的好处：</p>
<ul>
<li>上传进度可追踪；</li>
<li>中断后可恢复；</li>
<li>支持集群部署；</li>
<li>不依赖浏览器缓存或 Session。</li>
</ul>
<p>所以，只要数据库没丢，任务记录还在，<br/>
上传进度就能恢复，哪怕换机器、重启系统都没问题。</p>
<hr/>
<h4 data-id="heading-29">文件合并与完整性校验</h4>
<p>前面的所有步骤，其实都是在为这一刻做准备。<br/>
当用户的所有分片都上传完成后，接下来最重要的工作就是：<br/>
<strong>把这些分片拼成一个完整的文件，并且确保文件内容没有出错。</strong></p>
<p>这一步看似简单，但其实是整个大文件上传流程里最容易出问题的地方。<br/>
尤其在集群部署下，如果不同分片分布在不同机器上，<br/>
那合并逻辑就不能只靠本地文件路径去拼接，否则根本找不到所有分片。</p>
<p>所以我们先来理一理整个思路。</p>
<h4 data-id="heading-30">一、合并的触发时机</h4>
<p>前端在检测到所有分片都上传完成后，会调用 <code>/upload/merge</code> 接口。<br/>
这个接口的作用就是通知后端：<br/>
“这个任务的所有分片都传完了，现在可以开始合并了。”</p>
<p>后端接收到请求后，会先去查数据库确认几个关键信息：</p>
<ol>
<li>这个任务对应的 uploadId 是否存在；</li>
<li><code>upload_chunk</code> 表里所有分片是否都处于 “已上传” 状态；</li>
<li>当前任务状态是否允许合并（例如不是暂停、取消或失败）。</li>
</ol>
<p>确认无误后，任务状态会从 <code>UPLOADING</code> 变成 <code>MERGING</code>，<br/>
正式进入文件合并阶段。</p>
<h4 data-id="heading-31">二、本地合并逻辑</h4>
<p>如果系统配置的是本地存储（也就是 <code>cloud.enable = false</code>），<br/>
那所有分片文件都保存在服务器的临时目录中。</p>
<p>合并逻辑大致是这样的：</p>
<ol>
<li>后端按分片的 <code>chunk_index</code> 顺序，依次读取每个分片文件。</li>
<li>逐个写入到一个新的目标文件中，比如 <code>merge.zip</code>。</li>
<li>每合并一个分片，就更新数据库中的状态。</li>
<li>合并完成后，把任务状态更新为 <code>COMPLETED</code>，并写入最终路径。</li>
</ol>
<p>整个过程看起来很直观，<br/>
但这里有两个要点需要特别注意：</p>
<ul>
<li><strong>写入顺序要严格按照分片索引</strong>，否则文件内容会错乱；</li>
<li><strong>文件 IO 要用流式写入（Stream）</strong> ，避免内存一次性读取所有分片导致溢出。</li>
</ul>
<p>合并完成后，我们会计算整个文件的 MD5，与原始 fileHash 对比，<br/>
如果不一致，就说明合并过程中数据丢失或出错。<br/>
这种情况任务会被标记为 <code>FAILED</code>，并在日志中留下异常记录。</p>
<h4 data-id="heading-32">三、云端合并逻辑</h4>
<p>如果我们配置了云存储（比如 OSS、COS、MinIO 等），<br/>
那分片文件就不是存在本地磁盘，而是上传到云端的对象存储桶里。</p>
<p>在这种情况下，合并逻辑就不需要我们自己拼文件了，<br/>
因为大部分云存储服务都提供了“分片合并”的 API。</p>
<p>比如以 OSS 为例，上传时我们调用的是 <code>uploadPart</code> 接口，<br/>
合并时只需要调用 <code>completeMultipartUpload</code>，<br/>
它会根据上传时的分片顺序自动合并为一个完整对象。</p>
<p>整个过程的优点是：</p>
<ul>
<li>不占用本地磁盘；</li>
<li>不受单机 IO 限制；</li>
<li>云端自动校验每个分片的完整性。</li>
</ul>
<p>所以在云存储场景下，我们只需要做两件事：</p>
<ol>
<li>通知云服务去执行合并；</li>
<li>成功后记录最终的文件地址（<code>storage_url</code>）到数据库。</li>
</ol>
<p>这样整个流程就闭环了。</p>
<h4 data-id="heading-33">四、集群部署下的合并问题</h4>
<p>单机情况下，合并很简单，因为所有分片都在本地。<br/>
但如果系统是集群部署的，分片请求可能打到了不同机器，<br/>
这时候分片文件就会分散在多个节点上。</p>
<p>我们在设计时考虑了三种解决方案：</p>
<p><strong>方案 1：共享存储（私有化部署下比较推荐）</strong></p>
<p>最常见的做法是把所有机器的上传目录指向同一个共享路径，<br/>
比如通过 NFS、NAS、或对象存储挂载到 <code>/data/uploads</code>。<br/>
这样无论用户上传的分片打到哪台机器，<br/>
最终都会写入同一个物理目录。</p>
<p>当合并请求发起时，任意一台机器都能访问到完整的分片文件。<br/>
这是目前在企业部署中最稳定、最通用的方案。</p>
<p><strong>方案 2：云存储中转</strong></p>
<p>如果机器之间没有共享目录，那我们可以让每个分片先上传到云端，<br/>
合并时再调用云服务的 API 进行分片合并。<br/>
这种方式适合公网可访问的 SaaS 环境。<br/>
但对于政企内网部署，就不一定行得通。</p>
<p><strong>方案 3：统一调度节点</strong></p>
<p>还有一种是我们自己维护一个“合并调度节点”，<br/>
所有分片上传完后，系统会把合并任务分配到一个指定节点执行，<br/>
这个节点会从其他机器拉取分片（比如通过 HTTP 内部传输或 RPC）。<br/>
这种方式更复杂，适合大规模分布式存储场景。</p>
<p>在私有化项目中，我们一般采用第一种方式——<strong>共享目录 + 本地合并</strong>。<br/>
既能保证性能，也能兼顾安全性。</p>
<h4 data-id="heading-34">五、完整性校验</h4>
<p>文件合并完成后，最后一步是完整性校验。<br/>
我们会重新计算合并后文件的 MD5，与前端最初上传的 <code>fileHash</code> 对比。</p>
<p>如果一致，就说明文件合并成功，内容没有丢失；<br/>
如果不一致，就说明某个分片损坏或顺序错误，<br/>
任务会被标记为 <code>FAILED</code>，并自动记录错误日志。</p>
<p>这样可以确保文件数据的安全性，<br/>
避免在后续 AI 解析或向量化阶段出现内容异常。</p>
<h4 data-id="heading-35">六、异步处理与性能优化</h4>
<p>开头的视频里我们也看到了，整个上传和合并过程我们是<strong>同步执行</strong>的。<br/>
从前端开始上传分片，到最后文件合并完成，都在等待同一个流程走完。<br/>
这种方式在演示时很直观，但在真实项目中其实问题不少。</p>
<p>最明显的一个问题就是——时间太长。<br/>
像我们刚才那个 1GB 的文件，即使网络稳定、服务器性能还可以，<br/>
整个流程也要几分钟甚至更久。<br/>
如果我们让前端一直等待响应，接口超时、连接断开、前端刷新这些问题就都会冒出来。</p>
<p>所以，在真正的业务系统里，我们一般会把<strong>合并、校验、迁移 OSS 或解析入库</strong>这些操作改成<strong>异步任务</strong>来做。<br/>
接口只负责接收分片、登记状态，然后立刻返回“任务已创建”或“上传完成，正在处理中”的提示。<br/>
后续的合并、校验、清理临时文件这些工作交给后台的异步线程、任务队列或者调度器去跑。</p>
<p>这样做的好处有几个：</p>
<ul>
<li>前端体验更流畅，不用卡在“等待合并”阶段；</li>
<li>后端可以批量处理任务，减少高峰期的 IO 压力；</li>
<li>如果任务失败或中断，也能通过任务表重试或补偿；</li>
<li>对接外部存储或 AI 解析流程时，也能自然衔接后续任务链。</li>
</ul>
<p>简单来说，上传只是第一步，<br/>
而合并、校验、转存这些操作本质上更像是后台任务。<br/>
我们在系统设计时只要把这些环节分开，让接口尽量“轻”，<br/>
这套上传系统就能在面对更大文件、更复杂场景时依然稳定可靠。</p>
<h4 data-id="heading-36">七、小结</h4>
<p>整个合并与校验阶段，是把前面所有分片上传工作“收尾”的过程。<br/>
我们通过以下机制保证了稳定性：</p>
<ul>
<li>本地存储场景下：顺序读取 + 流式写入 + hash 校验；</li>
<li>云存储场景下：依赖云端分片合并 API；</li>
<li>集群环境下：通过共享存储或统一调度节点解决文件分散问题；</li>
<li>数据库层面：实时记录状态，便于追踪和审计。</li>
</ul>
<p>最终，当文件合并成功、校验通过后，<br/>
系统会将结果写入 <code>file_info</code> 表，<br/>
整条上传链路就算是完整闭环。</p>
<hr/>
<h3 data-id="heading-37">最后</h3>
<p>我们平常做的项目，大多数时候文件上传都挺简单的。<br/>
前端传到 OSS，后端接个地址存起来就行。<br/>
但等真正做私有化项目的时候，也就会发现很多地方都不一样了。<br/>
要求更多，考虑的细节也多得多。</p>
<p>像这次做的大文件上传就是个很典型的例子。<br/>
以前那种简单方案，放在这种环境下就完全不够用了。<br/>
得考虑断点续传、任务恢复、集群部署、权限、审计这些东西，<br/>
一步没想好，后面全是坑。</p>
<p>我们现在这套设计，其实就是在解决这些“现实问题”。<br/>
接口虽然多一点，但每个职责都很清晰，<br/>
任务状态能追踪，上传中断能恢复，<br/>
甚至以后如果我们想单独抽出来做一个文件系统模块也完全没问题。<br/>
不管是拿来给知识库用，还是 AI 向量化、文档解析，这套逻辑都能复用。</p>
<p>其实很多以前觉得“简单”的功能，<br/>
一旦遇到复杂场景，其实都得重新想。<br/>
但好处是，一旦做通了，这套东西就能稳定用很久。</p>
<p>到这里，大文件上传这块我们算是完整走了一遍。<br/>
以后再遇到类似需求，我们就有经验了，<br/>
不用再从头掉坑里爬出来一次哈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 的结构化文档配置 - 递归分块实践]]></title>    <link>https://juejin.cn/post/7571348736153632804</link>    <guid>https://juejin.cn/post/7571348736153632804</guid>    <pubDate>2025-11-12T01:54:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736153632804" data-draft-id="7571306072423956522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 的结构化文档配置 - 递归分块实践"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-12T01:54:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 的结构化文档配置 - 递归分块实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:54:44.000Z" title="Wed Nov 12 2025 01:54:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天我发表的一篇文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F154722870" title="https://elasticstack.blog.csdn.net/article/details/154722870" target="_blank" ref="nofollow noopener noreferrer">在 Elasticsearch 中为结构化文档配置递归分块</a>” 看着很简单。可能很多开发者还是不能得其要领，特别是在最新的版本中，我们的向量在默认的情况下是不在 source 里进行展示的。很难理解其中精髓。我在这篇文章里，使用一个具体的例子来进行展示。</p>
<h2 data-id="heading-0">例子</h2>
<p>我们可以参考官方文档 “<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference%2Finference-api" title="https://www.elastic.co/docs/explore-analyze/elastic-inference/inference-api" target="_blank" ref="nofollow noopener noreferrer">Inference integrations</a>” 来进行展示。首先，我们选择系统自带的 ELSER 模型来进行展示。我们必须安装好 ELSER 模型：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a72721867b84f7ca30276c2141fa66b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=XtTWN07lYKYC8Idmdq7hm5Ihie0%3D" alt="" loading="lazy"/></p>
<p>首先我们定义如下的一个 inference endpoint：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _inference/sparse_embedding/recursive_markdown_chunks
2.  {
3.    <span class="hljs-string">"service"</span>: <span class="hljs-string">"elasticsearch"</span>,
4.    <span class="hljs-string">"service_settings"</span>: {
5.      <span class="hljs-string">"model_id"</span>: <span class="hljs-string">".elser_model_2"</span>,
6.      <span class="hljs-string">"num_allocations"</span>: 1,
7.      <span class="hljs-string">"num_threads"</span>: 1
8.    },
9.    <span class="hljs-string">"chunking_settings"</span>: {
10.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
11.      <span class="hljs-string">"max_chunk_size"</span>: 25,
12.      <span class="hljs-string">"separators"</span>: [
13.        <span class="hljs-string">"\n# "</span>,
14.        <span class="hljs-string">"\n## "</span>
15.      ]
16.    }
17.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>我们可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference%2Finference-api%23recursive" title="https://www.elastic.co/docs/explore-analyze/elastic-inference/inference-api#recursive" target="_blank" ref="nofollow noopener noreferrer">文档</a>来了解 recursive 是如何工作的。递归策略根据可配置的分隔符模式列表（例如换行符或 Markdown 标题）拆分输入文本。分块器按顺序应用这些分隔符，递归地拆分超过 max_chunk_size 单词限制的任何分块。如果没有分隔符生成足够小的分块，该策略将退回到句子级拆分。</p>
<p>在上面，我们使用了 custom separator group：也就是基于第一第二级的 heading 来进行分隔提前。</p>
<p>接下来，我们定义一个索引：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT recursive_markdown_vectors
2.  {
3.    <span class="hljs-string">"mappings"</span>: {
4.      <span class="hljs-string">"properties"</span>: {
5.        <span class="hljs-string">"content"</span>: {
6.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
7.          <span class="hljs-string">"copy_to"</span>: <span class="hljs-string">"inference_field"</span>
8.        },
9.        <span class="hljs-string">"inference_field"</span>: {
10.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"semantic_text"</span>,
11.          <span class="hljs-string">"inference_id"</span>: <span class="hljs-string">"recursive_markdown_chunks"</span>
12.        }
13.      }
14.    }
15.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>然后，我们写入文档：</p>
<pre><code class="hljs language-less" lang="less">`

<span class="hljs-number">1</span>.  <span class="hljs-selector-tag">POST</span> <span class="hljs-selector-tag">recursive_markdown_vectors</span>/<span class="hljs-selector-tag">_doc</span>/<span class="hljs-number">1</span>
<span class="hljs-number">2</span>.  {
<span class="hljs-number">3</span>.    "<span class="hljs-selector-tag">content</span>": "# <span class="hljs-selector-tag">First</span> <span class="hljs-selector-tag">Header</span>
<span class="hljs-number">4</span>.  <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">first</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sentence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>.

<span class="hljs-number">6</span>.  ## <span class="hljs-selector-tag">Second</span> <span class="hljs-selector-tag">header</span>
<span class="hljs-number">7</span>.  <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">second</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sentence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>.

<span class="hljs-number">9</span>.  # <span class="hljs-selector-tag">Third</span> <span class="hljs-selector-tag">Header</span>
<span class="hljs-number">10</span>.  <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">third</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sendtence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>.

<span class="hljs-number">12</span>.  ## <span class="hljs-selector-tag">Fourth</span> <span class="hljs-selector-tag">Header</span>
<span class="hljs-number">13</span>.  <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">Fourth</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sendtence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>.

<span class="hljs-number">16</span>.  ## <span class="hljs-selector-tag">Fifth</span> <span class="hljs-selector-tag">Header</span>
<span class="hljs-number">17</span>.  <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">fifth</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sentence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>. <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">sixth</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sentence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>. <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">seventh</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">sentence</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">ten</span> <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">words</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">it</span>."
<span class="hljs-number">18</span>.  }

`<span class="hljs-selector-tag">AI</span>写代码!<span class="hljs-selector-attr">[]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>这样我们就大功告成了。</p>
<p>我们可以使用如下的查询来进行展示：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  GET recursive_markdown_vectors/_search?filter_path=**.hits
2.  {
3.    <span class="hljs-string">"fields"</span>: [
4.      {
5.        <span class="hljs-string">"field"</span>: <span class="hljs-string">"inference_field"</span>,
6.        <span class="hljs-string">"format"</span>: <span class="hljs-string">"chunks"</span>
7.      }
8.    ]
9.  }

`AI写代码
</code></pre>
<blockquote>
<p><strong>注意</strong>：上面的 fields 只对 9.2+ 及以上版本起作用。</p>
</blockquote>
<p>我们可以看到如下的查询结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40352a0dcdc6471c8583e2f1887adaad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=V98yL5ZjREVzniTUCigPcCqIYHA%3D" alt="" loading="lazy"/></p>
<p>从上面的结果中，我们可以看到有 3 个 chunks。</p>
<p>我们接下来把 max_chunk_size 设置为 10，看看最后的结果：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _inference/sparse_embedding/recursive_markdown_chunks
2.  {
3.    <span class="hljs-string">"service"</span>: <span class="hljs-string">"elasticsearch"</span>,
4.    <span class="hljs-string">"service_settings"</span>: {
5.      <span class="hljs-string">"model_id"</span>: <span class="hljs-string">".elser_model_2"</span>,
6.      <span class="hljs-string">"num_allocations"</span>: 1,
7.      <span class="hljs-string">"num_threads"</span>: 1
8.    },
9.    <span class="hljs-string">"chunking_settings"</span>: {
10.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
11.      <span class="hljs-string">"max_chunk_size"</span>: 10,
12.      <span class="hljs-string">"separators"</span>: [
13.        <span class="hljs-string">"\n# "</span>,
14.        <span class="hljs-string">"\n## "</span>
15.      ]
16.    }
17.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b9498c81c8e4c87bb20185602a0323d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=JCLV70P0fjshDmpVwpO99hNiBfI%3D" alt="" loading="lazy"/></p>
<p>很显然，它和我们之前的分块还是有点不一样。我们可以试试不同的值来看看。</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _inference/sparse_embedding/recursive_markdown_chunks
2.  {
3.    <span class="hljs-string">"service"</span>: <span class="hljs-string">"elasticsearch"</span>,
4.    <span class="hljs-string">"service_settings"</span>: {
5.      <span class="hljs-string">"model_id"</span>: <span class="hljs-string">".elser_model_2"</span>,
6.      <span class="hljs-string">"num_allocations"</span>: 1,
7.      <span class="hljs-string">"num_threads"</span>: 1
8.    },
9.    <span class="hljs-string">"chunking_settings"</span>: {
10.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
11.      <span class="hljs-string">"max_chunk_size"</span>: 35,
12.      <span class="hljs-string">"separators"</span>: [
13.        <span class="hljs-string">"\n# "</span>,
14.        <span class="hljs-string">"\n## "</span>
15.      ]
16.    }
17.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1e6c54c0067494dbd25796c07bc9a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=o5HzfWQQODkzmhFeQru%2FH6Wh%2BUk%3D" alt="" loading="lazy"/></p>
<p>我们也可以尝试使用 "separator_group":  "markdown"：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _inference/sparse_embedding/recursive_markdown_chunks
2.  {
3.    <span class="hljs-string">"service"</span>: <span class="hljs-string">"elasticsearch"</span>,
4.    <span class="hljs-string">"service_settings"</span>: {
5.      <span class="hljs-string">"model_id"</span>: <span class="hljs-string">".elser_model_2"</span>,
6.      <span class="hljs-string">"num_allocations"</span>: 1,
7.      <span class="hljs-string">"num_threads"</span>: 1
8.    },
9.    <span class="hljs-string">"chunking_settings"</span>: {
10.      <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"recursive"</span>,
11.      <span class="hljs-string">"max_chunk_size"</span>: 25,
12.      <span class="hljs-string">"separator_group"</span>: <span class="hljs-string">"markdown"</span>
13.    }
14.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23a98f076324ce6be122caac80d7daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=6bB2H%2BYjRm0Xkxnc6lLVyK8TUsU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41499d9c17c0463badf7d093ec6e9c93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517284&amp;x-signature=oS2QMUh6UxNupVq9PRbM2WGqJag%3D" alt="" loading="lazy"/></p>
<p>可以看出来，它的结果和我们之前第一个结果的没有什么不一样的，这是因为 markdown 所包含的 separators 里也是对 heading 进行分段的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《手撕类Vue2的响应式核心思想：我的学习心路历程》]]></title>    <link>https://juejin.cn/post/7571306072423153706</link>    <guid>https://juejin.cn/post/7571306072423153706</guid>    <pubDate>2025-11-11T16:14:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072423153706" data-draft-id="7571102074039418921" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《手撕类Vue2的响应式核心思想：我的学习心路历程》"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T16:14:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="残冬醉离殇"/> <meta itemprop="url" content="https://juejin.cn/user/1145072454220539"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《手撕类Vue2的响应式核心思想：我的学习心路历程》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145072454220539/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    残冬醉离殇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T16:14:14.000Z" title="Tue Nov 11 2025 16:14:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、前言：什么是响应式？</h3>
<p>响应式的核心思想很简单：<strong>当数据发生变化时，所有依赖于这个数据的函数（例如视图渲染函数、计算函数等）会自动重新执行</strong>，从而保持数据与依赖它的事物同步。在Vue2中，这是通过<code>Object.defineProperty</code>实现的。今天，我们就顺着这个思路，用原生JavaScript手写一个简易的响应式Demo。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e4f4f8481741f0855dae800d0022fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=10u%2FGqtjrC2peLmDDZ37Z5d7FrM%3D" alt="实例效果.gif" loading="lazy"/></p>
<h3 data-id="heading-1">二、基础版本：手动触发更新</h3>
<p>我们先实现一个最基础的版本。点击按钮，让<code>obj.age</code>增加，并同步更新页面。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"age"</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"changeObj()"</span>&gt;</span>年龄++<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 定义数据对象</span>
<span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
};

<span class="hljs-comment">// 2. 获取DOM元素</span>
<span class="hljs-keyword">const</span> ageEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#age'</span>);

<span class="hljs-comment">// 3. 定义更新DOM的函数</span>
<span class="hljs-keyword">const</span> updateDom = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    ageEl.<span class="hljs-property">textContent</span> = obj.<span class="hljs-property">age</span>.<span class="hljs-title function_">toString</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面已更新: '</span>, ageEl.<span class="hljs-property">textContent</span>);
}

<span class="hljs-comment">// 4. 定义改变数据的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>) =&gt; {
    obj.<span class="hljs-property">age</span>++; <span class="hljs-comment">// 修改数据</span>
    <span class="hljs-title function_">updateDom</span>(); <span class="hljs-comment">// 手动更新DOM</span>
}
</code></pre>
<p><strong>效果：</strong> 点击按钮，年龄增加，页面显示同步更新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/065c57e05f0b48aeb6189d319254b07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=2VNxYZBVL3UBOALCp6rwTm9UZpY%3D" alt="image.png" loading="lazy"/></p>
<p>这确实复现了“响应式”的效果，但存在一个明显问题：<strong>我们需要手动调用<code>updateDom</code></strong>。如果依赖<code>obj.age</code>的函数很多，比如有<code>dependFn1</code>, <code>dependFn2</code>, <code>dependFn3</code>，那么<code>changeObj</code>函数会变得非常冗长和难以维护。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> updateDom = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    age.<span class="hljs-property">textContent</span> = obj.<span class="hljs-property">age</span>.<span class="hljs-title function_">toString</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age.<span class="hljs-property">textContent</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn1</span> = (<span class="hljs-params"/>)=&gt;{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn2</span> = (<span class="hljs-params"/>)=&gt;{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn3</span> = (<span class="hljs-params"/>)=&gt;{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>)=&gt;{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
    obj.<span class="hljs-property">age</span>++
    <span class="hljs-title function_">updateDom</span>()<span class="hljs-comment">//更新dom</span>
    <span class="hljs-title function_">dependFn1</span>()
    <span class="hljs-title function_">dependFn2</span>()
    <span class="hljs-title function_">dependFn3</span>()
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddb48f72293b4dd28b20befe9f082314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=eGa1auY9FA8QpVKa%2FMeFajzRIjs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">三、优化一：统一管理依赖函数</h3>
<p>为了解决上述问题，我们可以把所有依赖函数收集到一个数组中，当数据变化时，统一遍历执行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//创建依赖函数数组</span>
<span class="hljs-keyword">let</span> fnArrays = []

<span class="hljs-comment">//创建触发依赖函数的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatchFns</span> = (<span class="hljs-params"/>)=&gt;{
  fnArrays.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>())
}

<span class="hljs-comment">//收集依赖函数的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">gatherFns</span> = (<span class="hljs-params">fn</span>)=&gt;{
  fnArrays.<span class="hljs-title function_">push</span>(fn)
}

<span class="hljs-title function_">gatherFns</span>(dependFn1)
<span class="hljs-title function_">gatherFns</span>(dependFn2)
<span class="hljs-title function_">gatherFns</span>(dependFn3)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>)=&gt;{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
  obj.<span class="hljs-property">age</span>++
  <span class="hljs-title function_">updateDom</span>()<span class="hljs-comment">//更新dom</span>
  <span class="hljs-title function_">dispatchFns</span>()
}
</code></pre>
<p>这样，我们只需要调用一次<code>dispatchFns()</code>，所有依赖函数都会执行。但这种方式依然不够灵活，如果多个数据对象拥有各自的依赖函数，管理起来会非常混乱。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e403574ff8c4d29876ceb35e500f6ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=mrLWWlQ0diKRc0pJLfB18eDwqZI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">四、优化二：引入Depend类</h3>
<p>更好的做法是为每个响应式数据创建一个独立的<strong>依赖管理器</strong>。我们定义一个<code>Depend</code>类来专门负责收集和触发依赖函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//这时候得创建一个Depend(依赖）类</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">Depend</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
      }

      <span class="hljs-comment">//收集依赖函数</span>
      <span class="hljs-title function_">gatherFns</span>(<span class="hljs-params">fn</span>){
          <span class="hljs-keyword">if</span>(fn &amp;&amp; <span class="hljs-keyword">typeof</span> fn === <span class="hljs-string">'function'</span>){
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">add</span>(fn)
          }
      }

      <span class="hljs-comment">//统一调用依赖函数</span>
      <span class="hljs-title function_">dispatchFns</span>(<span class="hljs-params"/>){
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> {
              <span class="hljs-title function_">fn</span>()
          })
      }
  }

  <span class="hljs-keyword">const</span> depend1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Depend</span>()

  depend1.<span class="hljs-title function_">gatherFns</span>(dependFn1)
  depend1.<span class="hljs-title function_">gatherFns</span>(dependFn2)
  depend1.<span class="hljs-title function_">gatherFns</span>(dependFn3)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>)=&gt;{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
      obj.<span class="hljs-property">age</span>++
      <span class="hljs-title function_">updateDom</span>()<span class="hljs-comment">//更新dom</span>
      depend1.<span class="hljs-title function_">dispatchFns</span>()
  }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6136e264d79241f4955d68571fd57e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=ELBvWPKn3BK7kVssjdoFmwxocFI%3D" alt="image.png" loading="lazy"/></p>
<p>现在，每个响应式数据都有自己的<code>Depend</code>实例，依赖管理更加清晰。但我们仍然需要在修改数据后<strong>手动调用<code>dispatchFns()</code></strong>。</p>
<h3 data-id="heading-4">五、核心实现：自动依赖收集和触发</h3>
<p>要实现真正的自动响应式，我们需要在<strong>获取数据时自动收集依赖</strong>，在<strong>修改数据时自动触发更新</strong>。这可以通过<code>Object.defineProperty</code>拦截数据的读取和修改操作来实现。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//创建一个myReactive的函数，接收一个对象，进行对它的属性劫持</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myReactive</span>(<span class="hljs-params">obj</span>){
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Depend</span>() <span class="hljs-comment">//创建一个实例对象</span>
        <span class="hljs-keyword">let</span> value = obj[key] <span class="hljs-comment">//获取对应属性的值，保留等下要用</span>

        <span class="hljs-comment">//加上属性劫持</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj,key,{
            get : <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                <span class="hljs-keyword">return</span> value
            },
            set : <span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>){
                value = newValue
                <span class="hljs-comment">//通知对应的实例执行所有依赖函数</span>
                instance.<span class="hljs-title function_">dispatchFns</span>()
            }
        })
    })
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/410abf3c8f604860a2e5a8c1a3fc7f1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=%2Ffdak%2FgQzSG5CFSSIXs5lR5d37I%3D" alt="image.png" loading="lazy"/></p>
<p>现在是解决了对象属性改变时，可以劫持使用set方法进行调用依赖函数，但是收集函数就成了一个难题，因为实例是在内部创建的，形成了闭包，外界拿不到内部的实例，所以只有一个方法了，就是设置一个全局活跃函数，当调用依赖函数时，会触发获取对象属性，触发get方法，就可以在get方法调用内部的instance可以获取外部的全局活跃函数，将其加入实例中的Set数组中！</p>
<h4 data-id="heading-5">关键思路：设置"全局活跃函数"</h4>
<p>我们需要一个方法来标记当前正在执行的函数，这样在读取数据时，就能知道是哪个函数依赖了这个数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//设置活跃函数</span>
<span class="hljs-keyword">let</span> activeFn = <span class="hljs-literal">null</span>
<span class="hljs-comment">//加入依赖的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addDependFn</span> = (<span class="hljs-params">fn</span>)=&gt;{
    activeFn = fn
    <span class="hljs-title function_">fn</span>()
    activeFn = <span class="hljs-literal">null</span>
}

<span class="hljs-title function_">addDependFn</span>(dependFn1)
<span class="hljs-title function_">addDependFn</span>(dependFn2)
<span class="hljs-title function_">addDependFn</span>(dependFn3)

<span class="hljs-comment">//创建一个myReactive的函数，接收一个对象，进行对它的属性劫持</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myReactive</span>(<span class="hljs-params">obj</span>){
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Depend</span>() <span class="hljs-comment">//创建一个实例对象</span>
        <span class="hljs-keyword">let</span> value = obj[key] <span class="hljs-comment">//获取对应属性的值，保留等下要用</span>

        <span class="hljs-comment">//加上属性劫持</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj,key,{
            get : <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                instance.<span class="hljs-title function_">gatherFns</span>(activeFn)
                <span class="hljs-keyword">return</span> value
            },
            set : <span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>){
                value = newValue
                <span class="hljs-comment">//通知对应的实例执行所有依赖函数</span>
                instance.<span class="hljs-title function_">dispatchFns</span>()
            }
        })
    })
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7294aceb2c744f9921626c62c784667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=0WNPoe8M2peWvDAbRekiIptYn7c%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>其实到这里就已经实现了简单的响应式啦！哈哈哈， 完整demo代码如下</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>手撕类Vue2响应式demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"age"</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"changeObj()"</span>&gt;</span>年龄++<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// obj对象</span>
        <span class="hljs-keyword">const</span> obj = {
            age : <span class="hljs-number">18</span>
        }

        <span class="hljs-comment">//使用原生拿到元素</span>
        <span class="hljs-keyword">const</span> age = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#age'</span>)

        <span class="hljs-keyword">const</span> updateDom = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            age.<span class="hljs-property">textContent</span> = obj.<span class="hljs-property">age</span>.<span class="hljs-title function_">toString</span>()
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age.<span class="hljs-property">textContent</span>);
        }

        <span class="hljs-comment">//模拟依赖函数1</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn1</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//模拟依赖函数2</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn2</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//模拟依赖函数3</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn3</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//这时候得创建一个类</span>
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Depend</span> {
            <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
            }

            <span class="hljs-comment">//收集依赖函数</span>
            <span class="hljs-title function_">gatherFns</span>(<span class="hljs-params">fn</span>){
                <span class="hljs-keyword">if</span>(fn &amp;&amp; <span class="hljs-keyword">typeof</span> fn === <span class="hljs-string">'function'</span>){
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">add</span>(fn)
                }
            }

            <span class="hljs-comment">//统一调用依赖函数</span>
            <span class="hljs-title function_">dispatchFns</span>(<span class="hljs-params"/>){
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> {
                    <span class="hljs-title function_">fn</span>()
                })
            }
        }

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
            obj.<span class="hljs-property">age</span>++
        }

        <span class="hljs-comment">//设置活跃函数</span>
        <span class="hljs-keyword">let</span> activeFn = <span class="hljs-literal">null</span>
        <span class="hljs-comment">//加入依赖的函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">addDependFn</span> = (<span class="hljs-params">fn</span>)=&gt;{
            activeFn = fn
            <span class="hljs-title function_">fn</span>()
            activeFn = <span class="hljs-literal">null</span>
        }

        <span class="hljs-comment">//手动执行一遍函数</span>
        <span class="hljs-title function_">addDependFn</span>(dependFn1)
        <span class="hljs-title function_">addDependFn</span>(dependFn2)
        <span class="hljs-title function_">addDependFn</span>(dependFn3)

        <span class="hljs-comment">//创建一个myReactive的函数，接收一个对象，进行对它的属性劫持</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">myReactive</span>(<span class="hljs-params">obj</span>){
            <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
                <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Depend</span>() <span class="hljs-comment">//创建一个实例对象</span>
                <span class="hljs-keyword">let</span> value = obj[key] <span class="hljs-comment">//获取对应属性的值，保留等下要用</span>

                <span class="hljs-comment">//加上属性劫持</span>
                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj,key,{
                    get : <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                        instance.<span class="hljs-title function_">gatherFns</span>(activeFn)
                        <span class="hljs-keyword">return</span> value
                    },
                    set : <span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>){
                        value = newValue
                        <span class="hljs-comment">//通知对应的实例执行所有依赖函数</span>
                        instance.<span class="hljs-title function_">dispatchFns</span>()
                    }
                })
            })
        }

        <span class="hljs-title function_">myReactive</span>(obj) <span class="hljs-comment">//传入对象，添加劫持</span>
        <span class="hljs-title function_">addDependFn</span>(updateDom) <span class="hljs-comment">//添加活跃函数</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">六、最终优化</h3>
<blockquote>
<p>但是到现在，其实它还有很多可以优化的地方，比如可能一个对象多次传入myReactive函数，会创建多个实例，还有实例是在myReactive函数里面创建的，属于闭包，可能出现内存泄漏，所以我们可以采用WeakMap集合来收集对象，这样子的话，就可以在myReactive函数开始那里判断一下对象是否创建过。然后每一个对象对应着一个（属性-实例）Map表，这样子的话，就可以方便的拿到实例了，就不会有强引用来泄漏内存了。</p>
</blockquote>
<p>这里是优化，就不赘述了，直接上代码</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>手撕类Vue2响应式demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"age"</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"changeObj()"</span>&gt;</span>年龄++<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// obj对象</span>
        <span class="hljs-keyword">const</span> obj = {
            age : <span class="hljs-number">18</span>
        }

        <span class="hljs-comment">//使用原生拿到元素</span>
        <span class="hljs-keyword">const</span> age = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#age'</span>)

        <span class="hljs-keyword">const</span> updateDom = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            age.<span class="hljs-property">textContent</span> = obj.<span class="hljs-property">age</span>.<span class="hljs-title function_">toString</span>()
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age.<span class="hljs-property">textContent</span>);
        }

        <span class="hljs-comment">//模拟依赖函数1</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn1</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//模拟依赖函数2</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn2</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//模拟依赖函数3</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dependFn3</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
        }

        <span class="hljs-comment">//这时候得创建一个类</span>
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Depend</span> {
            <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
            }

            <span class="hljs-comment">//收集依赖函数</span>
            <span class="hljs-title function_">gatherFns</span>(<span class="hljs-params">fn</span>){
                <span class="hljs-keyword">if</span>(fn &amp;&amp; <span class="hljs-keyword">typeof</span> fn === <span class="hljs-string">'function'</span>){
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">add</span>(fn)
                }
            }

            <span class="hljs-comment">//统一调用依赖函数</span>
            <span class="hljs-title function_">dispatchFns</span>(<span class="hljs-params"/>){
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependFns</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> {
                    <span class="hljs-title function_">fn</span>()
                })
            }
        }

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeObj</span> = (<span class="hljs-params"/>)=&gt;{
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>);
            obj.<span class="hljs-property">age</span>++
        }

        <span class="hljs-comment">//设置活跃函数</span>
        <span class="hljs-keyword">let</span> activeFn = <span class="hljs-literal">null</span>
        <span class="hljs-comment">//加入依赖的函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">addDependFn</span> = (<span class="hljs-params">fn</span>)=&gt;{
            activeFn = fn
            <span class="hljs-title function_">fn</span>()
            activeFn = <span class="hljs-literal">null</span>
        }

        <span class="hljs-comment">//手动执行一遍函数</span>
        <span class="hljs-title function_">addDependFn</span>(dependFn1)
        <span class="hljs-title function_">addDependFn</span>(dependFn2)
        <span class="hljs-title function_">addDependFn</span>(dependFn3)

        <span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()<span class="hljs-comment">//创建一个集合，将响应式对象放进去</span>

        <span class="hljs-comment">//查找依赖实例的函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDepend</span> = (<span class="hljs-params">obj,key</span>)=&gt;{
            <span class="hljs-keyword">let</span> target = targetMap.<span class="hljs-title function_">get</span>(obj)

            <span class="hljs-keyword">if</span>(!target){
                <span class="hljs-comment">//创建</span>
                <span class="hljs-keyword">const</span> propertyDependMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>() <span class="hljs-comment">//创建一张属性和对应依赖实例的对照表</span>
                targetMap.<span class="hljs-title function_">set</span>(obj,propertyDependMap) <span class="hljs-comment">//将对象和对应的属性和对应依赖实例的对照表关联，可以通过对象找到对照表</span>
                target = targetMap.<span class="hljs-title function_">get</span>(obj)
            }

            <span class="hljs-keyword">let</span> depend = target.<span class="hljs-title function_">get</span>(key)
            <span class="hljs-keyword">if</span>(!depend){
                <span class="hljs-comment">//创建</span>
                <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Depend</span>()
                target.<span class="hljs-title function_">set</span>(key,instance) <span class="hljs-comment">//将映射关系写好</span>
                depend = instance
            }

            <span class="hljs-keyword">return</span> depend
        }

        <span class="hljs-comment">//创建一个myReactive的函数，接收一个对象，进行对它的属性劫持</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">myReactive</span>(<span class="hljs-params">obj</span>){
            <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
                <span class="hljs-keyword">let</span> value = obj[key] <span class="hljs-comment">//获取对应属性的值，保留等下要用</span>

                <span class="hljs-comment">//加上属性劫持</span>
                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj,key,{
                    get : <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                        <span class="hljs-title function_">getDepend</span>(obj,key).<span class="hljs-title function_">gatherFns</span>(activeFn)
                        <span class="hljs-keyword">return</span> value
                    },
                    set : <span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>){
                        value = newValue
                        <span class="hljs-comment">//通知对应的实例执行所有依赖函数</span>
                        <span class="hljs-title function_">getDepend</span>(obj,key).<span class="hljs-title function_">dispatchFns</span>()
                    }
                })
            })
        }

        <span class="hljs-title function_">myReactive</span>(obj)
        <span class="hljs-title function_">addDependFn</span>(updateDom)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a45a65bfae0547a8b389d312ef7481f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q6L5Yas6YaJ56a75q6H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763482454&amp;x-signature=LctjD%2BFN%2F1IXxBC0y8udQWCqX0Q%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">七、总结</h3>
<p>响应式其实就是3个重要的点</p>
<ol>
<li><strong>依赖收集</strong>：通过<code>Object.defineProperty</code>的getter拦截属性访问，收集当前正在执行的函数作为依赖</li>
<li><strong>依赖触发</strong>：通过setter拦截属性修改，自动通知所有依赖函数更新</li>
<li><strong>依赖管理</strong>：使用<code>Depend</code>类管理每个属性的依赖关系，使用<code>WeakMap</code>和<code>Map</code>建立对象-属性-依赖的映射关系</li>
</ol>
<blockquote>
<p>这个简易实现包含了Vue2响应式系统的核心思想，但是vue封装的更加复杂！这个只是我的个人总结，如果能帮到你的话，就更好啦！如果觉得写的好的话，可以给个一键三连哈哈哈哈哈哈哈哈</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 Props 响应式深度解析：从原理到最佳实践]]></title>    <link>https://juejin.cn/post/7571342319892987939</link>    <guid>https://juejin.cn/post/7571342319892987939</guid>    <pubDate>2025-11-12T00:07:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319892987939" data-draft-id="7571344319702384680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 Props 响应式深度解析：从原理到最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T00:07:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木易士心"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 Props 响应式深度解析：从原理到最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木易士心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:07:38.000Z" title="Wed Nov 12 2025 00:07:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>在 Vue 3 的响应式系统中，<code>props</code> 是实现组件间数据通信的核心机制。它既强大又微妙——看似简单，却蕴含着响应式系统的设计哲学。许多开发者误以为“只要传了值就会自动更新”，但真实场景远比这复杂。本文将带你深入理解 <code>props</code> 的响应式本质、边界行为，并提供可落地的最佳实践方案。</p>
<h2 data-id="heading-1">一、 Props 响应式本质：单向数据流的核心</h2>
<h3 data-id="heading-2">1.响应式原理剖析</h3>
<p>Vue 3 的 <code>props</code> 并非凭空具备响应能力，而是其底层响应式系统（基于 <code>Proxy</code> 和 <code>reactive</code>）的自然延伸。当父组件向子组件传递数据时，Vue 内部会将原始 props 对象包装成一个<strong>只读的响应式代理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 内部简化逻辑示意</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createPropsProxy</span>(<span class="hljs-params">rawProps, instance</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(rawProps); <span class="hljs-comment">// 基于 reactive() 创建响应式代理</span>
}
</code></pre>
<blockquote>
<p><strong>关键洞察</strong>：<br/>
<code>props</code> 的响应式不是“魔法”，而是 Vue 响应式系统的标准行为。但与普通 <code>reactive</code> 对象不同，<strong>props 是只读的</strong>——这是为了强制遵守“单向数据流”原则，防止子组件意外修改父状态，从而避免难以追踪的数据污染。</p>
</blockquote>
<h3 data-id="heading-3">2. 响应式层级分析</h3>
<p>并非所有通过 <code>props</code> 传递的数据都具有相同的响应行为。理解其层级差异，是避免“为什么没更新？”这类问题的关键：</p>






























<table><thead><tr><th>数据层级</th><th>响应式表现</th><th>示例说明</th></tr></thead><tbody><tr><td>Prop 本身（基本类型）</td><td>引用变化时响应</td><td>父组件 <code>:count="refCount"</code>，当 <code>refCount.value</code> 改变，子组件自动更新</td></tr><tr><td>Prop 对象内部属性</td><td>深度响应式</td><td><code>user.name</code> 变化会触发更新，得益于 <code>reactive</code> 的递归代理</td></tr><tr><td>静态字面量</td><td>无响应式</td><td><code>title="静态标题"</code> 是常量，不会变化，自然无需响应</td></tr><tr><td>计算属性作为 prop</td><td>依赖变化时响应</td><td>父组件传入 <code>:value="computedValue"</code>，当 <code>computedValue</code> 依赖项变化，子组件同步更新</td></tr></tbody></table>
<blockquote>
<p><strong>实践提示</strong>：如果你发现子组件未随父组件更新，请首先确认：<strong>父组件传递的是响应式数据（如 <code>ref</code>/<code>reactive</code>），而非字面量或普通变量</strong>。</p>
</blockquote>
<h2 data-id="heading-4">二、 高级声明模式：类型安全与运行时保障</h2>
<p>现代 Vue 开发强调<strong>类型安全</strong>与<strong>运行时可靠性</strong>。合理声明 <code>props</code> 不仅能提升开发体验，还能在构建阶段捕获潜在错误。</p>
<h3 data-id="heading-5">1. 类型安全的 Props 声明（TypeScript）</h3>
<p>在 <code>&lt;script setup&gt;</code> 中结合 TypeScript 接口，可实现端到端的类型推导：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
interface User {
  id: number
  name: string
  email: string
}

interface Props {
  title: string
  count: number
  user: User
  tags?: string[]
  onAction?: (payload: any) =&gt; void
}

// withDefaults 提供默认值，同时保持类型推断
const props = withDefaults(defineProps&lt;Props&gt;(), {
  count: 0,
  tags: () =&gt; ['default'] // 注意：数组/对象需用工厂函数
})

// 此处 props.user.id 具备完整类型提示和检查
console.log(props.user.id)
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>优势</strong>：</p>
<ul>
<li>编辑器智能提示</li>
<li>编译期类型校验</li>
<li>减少运行时错误</li>
</ul>
</blockquote>
<h3 data-id="heading-6">2. 运行时验证与 TypeScript 结合</h3>
<p>即使使用 TypeScript，某些业务逻辑仍需运行时验证（如枚举值、数据格式）：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { PropType } from 'vue'

const props = defineProps({
  user: {
    type: Object as PropType&lt;User&gt;,
    required: true,
    validator: (value: User) =&gt; {
      // 自定义验证规则：ID 必须为正，名称非空
      return value.id &gt; 0 &amp;&amp; value.name.length &gt; 0
    }
  },
  status: {
    type: String as PropType&lt;'pending' | 'success' | 'error'&gt;,
    default: 'pending'
  }
})
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>注意</strong>：<br/>
<code>validator</code> 在生产环境会被 Tree-shaking 移除，因此<strong>不能依赖它做安全校验</strong>，仅用于开发调试。</p>
</blockquote>
<h2 data-id="heading-7">三、 响应式边界与性能优化</h2>
<p>随着应用复杂度提升，<code>props</code> 可能承载大型对象或高频更新数据。此时，盲目依赖默认响应式行为可能导致性能瓶颈。</p>
<h3 data-id="heading-8">1. 深度监听的开销与优化策略</h3>
<p>对大型嵌套对象使用 <code>{ deep: true }</code> 监听，会触发大量不必要的计算：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({
  largeData: Object // 可能包含数千项的配置树
})

//  性能陷阱：任何嵌套字段变化都会触发回调
watch(props.largeData, (newVal) =&gt; {
  // ...
}, { deep: true })

//  优化方案1：精准监听关键路径
watch(() =&gt; props.largeData.criticalField, (newVal) =&gt; {
  // 仅当核心字段变化时处理
})

//  优化方案2：自定义比较逻辑（避免全量 diff）
watch(() =&gt; props.largeData, (newVal, oldVal) =&gt; {
  if (JSON.stringify(newVal.importantPart) !== JSON.stringify(oldVal.importantPart)) {
    handleImportantChange(newVal.importantPart)
  }
}, { deep: true })

//  优化方案3：防抖 + 批量处理
import { debounce } from 'lodash-es'
const debouncedHandler = debounce((data) =&gt; {
  updateExpensiveUI(data)
}, 300)

watch(() =&gt; props.largeData, debouncedHandler, { deep: true })
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-9">2. 不可变数据模式：降低响应式开销</h3>
<p>对于频繁整体替换的数据（如列表刷新），可采用<strong>不可变更新 + 浅层响应式</strong>策略：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({
  items: Array // 大型列表，每次分页都整体替换
})

// 使用 shallowRef 避免 Vue 对每个 item 做深度代理
import { shallowRef, computed } from 'vue'
const itemsRef = shallowRef(props.items)

// 当 props.items 引用变化时，更新 shallowRef
watch(() =&gt; props.items, (newItems) =&gt; {
  itemsRef.value = newItems // 整体替换，无嵌套响应式开销
})

// 模板中通过 computed 安全访问
const processedItems = computed(() =&gt; 
  itemsRef.value.map(item =&gt; ({ ...item, processed: true }))
)
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>适用场景</strong>：</p>
<ul>
<li>表格/列表数据</li>
<li>配置快照</li>
<li>一次性渲染内容</li>
</ul>
</blockquote>
<h2 data-id="heading-10">四、 高级响应式模式：解构、条件处理与组合逻辑</h2>
<h3 data-id="heading-11">1. 响应式 Props 解构：如何不丢失响应性？</h3>
<p>直接解构 <code>props</code> 会导致响应式连接断裂：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//  错误：user 成为普通值，不再响应</span>
<span class="hljs-keyword">const</span> { user } = props
</code></pre>
<p>正确做法有三种：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { toRefs, computed } from 'vue'

const props = defineProps({ user: Object, settings: Object })

//  方案1：toRefs 保持响应式引用
const { user, settings } = toRefs(props)

//  方案2：computed 派生（推荐用于模板展示）
const userName = computed(() =&gt; props.user.name)
const theme = computed(() =&gt; props.settings.theme)

//  方案3：选择性解构 + 默认值（TypeScript 友好）
const { user = defaultUser } = toRefs(props)
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>何时用哪种？</strong></p>
<ul>
<li><code>toRefs</code>：需要在 <code>setup()</code> 中频繁访问多个属性</li>
<li><code>computed</code>：用于模板或派生逻辑，语义更清晰</li>
<li>直接 <code>props.xxx</code>：最简单场景，避免过度抽象</li>
</ul>
</blockquote>
<h3 data-id="heading-12">2. 条件响应式处理：应对 null/undefined</h3>
<p>现实项目中，<code>props</code> 常因异步加载而暂时为 <code>null</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({
  data: [Object, null] // 允许 null
})

// 安全访问：避免 .xxx 报错
const safeData = computed(() =&gt; props.data ?? {})

// 条件监听：仅在有效数据到来时处理
watch(() =&gt; props.data, (newData) =&gt; {
  if (newData) {
    initializeComponent(newData)
  }
})

// 或使用 watchEffect 自动追踪依赖
watchEffect(() =&gt; {
  if (props.data?.id) {
    // 自动依赖 props.data，且仅在 id 存在时执行
    fetchRelatedData(props.data.id)
  }
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-13">五、 复杂数据流模式：跨层级通信与状态融合</h2>
<h3 data-id="heading-14">1.多层级组件通信：透传与中间处理</h3>
<p>在深层嵌套组件中，中间层组件常需“透传并增强” props：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 中间层组件 --&gt;
&lt;script setup&gt;
const props = defineProps({
  config: Object,
  state: Object
})

// 对透传的 config 添加中间层元信息
const processedConfig = computed(() =&gt; ({
  ...props.config,
  processedAt: Date.now(),
  version: 'v2'
}))

// 事件转发 + 校验
const emit = defineEmits(['update:state'])
const handleStateChange = (newState) =&gt; {
  const validated = validateState(newState)
  if (validated.isValid) {
    emit('update:state', validated.data)
  } else {
    console.warn('Invalid state update:', validated.errors)
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;ChildComponent 
    :config="processedConfig"
    :state="state"
    @update:state="handleStateChange"
  /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-15">2. 状态提升与本地状态融合</h3>
<p>有时需要将外部状态（props）与本地状态合并使用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({
  externalState: Object // 来自全局 store 或父组件
})

const localState = ref({ editing: false, draft: '' })

// 当外部状态重置时，清空本地草稿
watch(() =&gt; props.externalState, (newState) =&gt; {
  if (newState.shouldResetLocal) {
    localState.value = { editing: false, draft: '' }
  }
}, { deep: true })

// 合并状态供模板使用
const mergedState = computed(() =&gt; ({
  ...props.externalState,
  ...localState.value,
  isDirty: localState.value.draft !== props.externalState.content
}))
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>设计思想</strong>：<br/>
将“受控”（来自 props）与“非受控”（本地状态）分离，再通过 <code>computed</code> 融合，是复杂表单、编辑器等场景的常见模式。</p>
</blockquote>
<h2 data-id="heading-16">六、 性能与调试技巧</h2>
<h3 data-id="heading-17">1.  响应式调试：看清依赖关系</h3>
<p>开发阶段可通过以下方式观察 props 的响应行为：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({ complexData: Object })

// watchEffect 会打印每次访问的依赖
watchEffect(() =&gt; {
  console.log('[Debug] Accessing props:', {
    data: props.complexData,
    keys: Object.keys(props.complexData || {})
  })
})

// 获取组件实例，查看原始 props
import { getCurrentInstance, onMounted } from 'vue'
const instance = getCurrentInstance()
onMounted(() =&gt; {
  console.log('Raw props:', instance?.props)
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-18">2. 记忆化与缓存：避免重复计算</h3>
<p>对昂贵的派生计算，应使用缓存策略：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps({
  items: Array,
  filter: String
})

// 方案1：computed 自动缓存（推荐）
const filteredItems = computed(() =&gt; 
  props.items.filter(item =&gt; item.name.includes(props.filter))
)

// 方案2：手动缓存 + 精确依赖
const cachedResult = ref([])
watch([() =&gt; props.items, () =&gt; props.filter], 
  ([items, filter]) =&gt; {
    cachedResult.value = expensiveComputation(items, filter)
  }, 
  { immediate: true }
)
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>经验法则</strong>：<br/>
优先使用 <code>computed</code>，除非你需要控制缓存策略（如 LRU、过期时间等）。</p>
</blockquote>
<h2 data-id="heading-19">七、 响应式 Props 模式总结</h2>
<h3 data-id="heading-20">1. 场景方案总结</h3>








































<table><thead><tr><th>场景</th><th>推荐模式</th><th>替代/补充方案</th></tr></thead><tbody><tr><td>基本类型传递</td><td>直接使用 <code>props.xxx</code></td><td><code>toRef(props, 'xxx')</code>（需解构时）</td></tr><tr><td>对象内部属性访问</td><td>默认深度响应式</td><td><code>watch(() =&gt; props.obj.field, ...)</code></td></tr><tr><td>大型数据集（列表/树）</td><td><code>shallowRef</code> + 整体替换</td><td>虚拟滚动 + 分页加载</td></tr><tr><td>高频更新（如拖拽坐标）</td><td>防抖 + 条件更新</td><td>使用 <code>requestAnimationFrame</code> 节流</td></tr><tr><td>类型安全需求</td><td>TypeScript 接口 + <code>withDefaults</code></td><td>运行时 <code>validator</code>（仅开发环境）</td></tr><tr><td>复杂转换逻辑</td><td><code>computed</code> 派生</td><td>自定义组合式函数（composables）</td></tr></tbody></table>
<h3 data-id="heading-21">2.使用建议</h3>
<ol>
<li><strong>声明明确</strong>：始终为 <code>props</code> 提供类型定义（TS）或运行时验证（JS）</li>
<li><strong>坚守单向流</strong>：通过 <code>emit</code> 向上通信，绝不直接修改 <code>props</code></li>
<li><strong>性能敏感</strong>：对大型/高频数据，评估是否需浅层响应式或手动控制</li>
<li><strong>防御性编程</strong>：处理 <code>null</code>/<code>undefined</code>，避免 <code>.xxx</code> 报错</li>
<li><strong>开发友好</strong>：在调试阶段添加 <code>watchEffect</code> 日志，理清依赖</li>
<li><strong>测试覆盖</strong>：编写单元测试，验证 <code>props</code> 变化时的组件行为</li>
</ol>
<h2 data-id="heading-22">八、 进阶学习路径</h2>
<p>要进一步掌握 Vue 3 响应式系统，建议深入以下方向：</p>
<ul>
<li><strong>源码阅读</strong>：研究 <code>reactive.ts</code>、<code>componentProps.ts</code> 实现</li>
<li><strong>自定义渲染器</strong>：了解 <code>props</code> 在非 DOM 环境（如小程序）中的处理</li>
<li><strong>SSR 序列化</strong>：理解服务端如何传递 <code>props</code> 到客户端</li>
<li><strong>DevTools 调试</strong>：使用 Vue DevTools 的 “Components” 面板实时观察 <code>props</code> 变化</li>
</ul>
<p>通过深入理解 <code>props</code> 的响应式机制，你不仅能避免常见陷阱，更能设计出高性能、高可维护性的组件架构。记住：<strong>响应式是工具，不是目的</strong>。合理使用，方能发挥 Vue 3 的最大威力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现一个低代码编辑器：揭秘可视化搭建的核心原理]]></title>    <link>https://juejin.cn/post/7571344319702433832</link>    <guid>https://juejin.cn/post/7571344319702433832</guid>    <pubDate>2025-11-12T00:15:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571344319702433832" data-draft-id="7568746602805166107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现一个低代码编辑器：揭秘可视化搭建的核心原理"/> <meta itemprop="keywords" content="前端,React.js,低代码"/> <meta itemprop="datePublished" content="2025-11-12T00:15:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FogLetter"/> <meta itemprop="url" content="https://juejin.cn/user/933907109778611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现一个低代码编辑器：揭秘可视化搭建的核心原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933907109778611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FogLetter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:15:32.000Z" title="Wed Nov 12 2025 00:15:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：当编程遇上「拖拽」</h2>
<p>还记得第一次接触编程时的兴奋吗？在黑色的终端里输入几行神秘的代码，就能让计算机按照我们的意愿工作。但随着编程经验的增长，我们也会发现：很多重复性的页面开发工作，其实并不需要每次都从头开始写代码。</p>
<p>这就是低代码/零代码平台诞生的背景。作为一名开发者，我最初对这类平台是抱有怀疑态度的——「拖拽就能生成应用？肯定很鸡肋吧！」直到我真正深入使用并实现了一个低代码编辑器，才发现其中的技术内涵远比想象中丰富。</p>
<p>今天，就让我带你一起揭开低代码编辑器的神秘面纱，看看这看似简单的「拖拽」背后，到底藏着怎样的技术奥秘。</p>
<h2 data-id="heading-1">低代码与零代码：概念辨析</h2>
<h3 data-id="heading-2">什么是低代码/零代码？</h3>
<p><strong>低代码</strong>（Low-Code）和<strong>零代码</strong>（No-Code）都是通过可视化界面和配置化方式，减少或替代传统手写代码的应用开发方法。</p>
<ul>
<li><strong>低代码</strong>：主要面向开发者，提供可视化开发工具提升开发效率</li>
<li><strong>零代码</strong>：让非技术人员也能搭建简单应用，如表单、审批流程、数据看板等</li>
</ul>
<h3 data-id="heading-3">实际应用场景</h3>
<p>在一个企业内部管理系统项目中，开发者使用低代码平台快速搭建了：</p>
<ol>
<li><strong>员工请假审批流程</strong></li>
<li><strong>数据报表展示看板</strong></li>
<li><strong>客户信息管理表单</strong></li>
</ol>
<p>原本需要2周开发的功能，在低代码平台上只用了2天就完成了配置和测试，效率提升惊人！</p>
<h2 data-id="heading-4">低代码编辑器核心架构</h2>
<h3 data-id="heading-5">三大核心区域</h3>
<p>任何低代码编辑器都包含三个基本区域：</p>
<ol>
<li><strong>物料区域</strong>：提供可拖拽的组件</li>
<li><strong>编辑区域</strong>：组件组合和布局的区域</li>
<li><strong>属性设置区域</strong>：配置组件属性的面板</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 编辑器布局组件示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Allotment</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'allotment'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LowcodeEditor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-[100vh] flex flex-col"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Allotment</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Allotment.Pane</span> <span class="hljs-attr">preferredSize</span>=<span class="hljs-string">{240}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Material</span> /&gt;</span> {/* 物料区域 */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Allotment.Pane</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Allotment.Pane</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">EditArea</span> /&gt;</span> {/* 编辑区域 */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Allotment.Pane</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Allotment.Pane</span> <span class="hljs-attr">preferredSize</span>=<span class="hljs-string">{300}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Setting</span> /&gt;</span> {/* 属性设置区域 */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Allotment.Pane</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Allotment</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-6">核心技术栈</h3>
<p>在实现低代码编辑器时，我们选择了以下技术栈：</p>
<ul>
<li><strong>React</strong> + <strong>TypeScript</strong>：组件化开发和类型安全</li>
<li><strong>react-dnd</strong>：实现拖拽功能</li>
<li><strong>allotment</strong>：可调整大小的分栏布局</li>
<li><strong>zustand</strong>：轻量级状态管理</li>
<li><strong>tailwindcss</strong>：原子化CSS样式</li>
</ul>
<h2 data-id="heading-7">实现细节深度解析</h2>
<h3 data-id="heading-8">状态管理：编辑器的「大脑」</h3>
<p>低代码编辑器的核心是一个表示组件树结构的状态管理。我们使用 zustand 来管理这个状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 组件数据结构定义</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Component</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;      <span class="hljs-comment">// 组件类型，如 'Button', 'Container'</span>
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">any</span>;        <span class="hljs-comment">// 组件属性</span>
  children?: <span class="hljs-title class_">Component</span>[]; <span class="hljs-comment">// 子组件</span>
  parentId?: <span class="hljs-built_in">number</span>;     <span class="hljs-comment">// 父组件ID</span>
}

<span class="hljs-comment">// 状态管理store</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useComponentsStore = create&lt;<span class="hljs-title class_">State</span> &amp; <span class="hljs-title class_">Action</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> ({
  <span class="hljs-attr">components</span>: [
    {
      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Page'</span>,
      <span class="hljs-attr">props</span>: {},
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'页面'</span>
    },
  ],
  <span class="hljs-comment">// 添加组件</span>
  <span class="hljs-attr">addComponent</span>: <span class="hljs-function">(<span class="hljs-params">component, parentId</span>) =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (parentId) {
      <span class="hljs-comment">// 找到父组件并添加子组件</span>
      <span class="hljs-keyword">const</span> parentComponent = <span class="hljs-title function_">getComponentById</span>(parentId, state.<span class="hljs-property">components</span>);
      <span class="hljs-keyword">if</span> (parentComponent) {
        <span class="hljs-keyword">if</span> (parentComponent.<span class="hljs-property">children</span>) {
          parentComponent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(component);
        } <span class="hljs-keyword">else</span> {
          parentComponent.<span class="hljs-property">children</span> = [component];
        }
      }
      component.<span class="hljs-property">parentId</span> = parentId;
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">components</span>: [...state.<span class="hljs-property">components</span>],
      }
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">components</span>: [...state.<span class="hljs-property">components</span>, component],
    }
  }),
  <span class="hljs-comment">// 其他操作...</span>
}));
</code></pre>
<p>这个数据结构虽然简单，但却是整个编辑器的核心。它本质上是一棵树，通过 <code>parentId</code> 和 <code>children</code> 属性构建出完整的组件层级关系。</p>
<h3 data-id="heading-9">组件配置管理：编辑器的「组件库」</h3>
<p>为了让编辑器知道有哪些组件可用，我们需要一个组件配置管理系统：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentConfig</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">defaultProps</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;; <span class="hljs-comment">// 默认属性</span>
  <span class="hljs-attr">component</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// React组件</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useComponentConfigStore = create&lt;<span class="hljs-title class_">State</span> &amp; <span class="hljs-title class_">Actions</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">componentConfig</span>: {
    <span class="hljs-title class_">Container</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Container"</span>,
      <span class="hljs-attr">defaultProps</span>: {},
      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Container</span>
    },
    <span class="hljs-title class_">Button</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Button"</span>,
      <span class="hljs-attr">defaultProps</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"primary"</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-string">"按钮"</span>,
      },
      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Button</span>
    },
    <span class="hljs-title class_">Page</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"Page"</span>,
      <span class="hljs-attr">defaultProps</span>: {},
      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Page</span>
    },
  },
  <span class="hljs-comment">// 注册新组件</span>
  <span class="hljs-attr">registerComponent</span>: <span class="hljs-function">(<span class="hljs-params">name, componentConfig</span>) =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...state,
      <span class="hljs-attr">componentConfig</span>: {
        ...state.<span class="hljs-property">componentConfig</span>,
        [name]: componentConfig,
      }
    }
  }),
}));
</code></pre>
<h3 data-id="heading-10">拖拽实现：编辑器的「交互灵魂」</h3>
<p>拖拽功能是低代码编辑器最核心的交互方式。我们使用 <code>react-dnd</code> 来实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 物料项 - 可拖拽的组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MaterialItem</span>(<span class="hljs-params">props: MaterialItemProps</span>) {
  <span class="hljs-keyword">const</span> { name } = props;
  <span class="hljs-keyword">const</span> [_, drag] = <span class="hljs-title function_">useDrag</span>({
    <span class="hljs-attr">type</span>: name,
    <span class="hljs-attr">item</span>: {
      <span class="hljs-attr">type</span>: name,
    }
  });
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{drag}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"border-dashed border-[1px] border-[#000] py-[8px] px-[10px] m-[10px] cursor-move inline-block"</span>
    &gt;</span>
      {name}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 放置区域hook</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMaterialDrop</span>(<span class="hljs-params">accept: <span class="hljs-built_in">string</span>[], id: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> { addComponent } = <span class="hljs-title function_">useComponentsStore</span>();
  <span class="hljs-keyword">const</span> { componentConfig } = <span class="hljs-title function_">useComponentConfigStore</span>();
  
  <span class="hljs-keyword">const</span> [{ canDrop }, drop] = <span class="hljs-title function_">useDrop</span>(<span class="hljs-function">() =&gt;</span> ({
    accept,
    <span class="hljs-attr">drop</span>: <span class="hljs-function">(<span class="hljs-params">item: { <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span> }, monitor</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> didDrop = monitor.<span class="hljs-title function_">didDrop</span>();
      <span class="hljs-keyword">if</span> (didDrop) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 防止重复触发</span>
      
      <span class="hljs-keyword">const</span> props = componentConfig[item.<span class="hljs-property">type</span>].<span class="hljs-property">defaultProps</span>;
      <span class="hljs-title function_">addComponent</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>(),
        <span class="hljs-attr">name</span>: item.<span class="hljs-property">type</span>,
        props
      }, id);
    },
    <span class="hljs-attr">collect</span>: <span class="hljs-function">(<span class="hljs-params">monitor</span>) =&gt;</span> ({
      <span class="hljs-attr">canDrop</span>: monitor.<span class="hljs-title function_">canDrop</span>(),
    }),
  }));
  
  <span class="hljs-keyword">return</span> { canDrop, drop };
}
</code></pre>
<h3 data-id="heading-11">组件渲染：从数据到UI</h3>
<p>编辑区域需要将组件树数据渲染为实际的UI：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">EditArea</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { components } = <span class="hljs-title function_">useComponentsStore</span>();
  <span class="hljs-keyword">const</span> { componentConfig } = <span class="hljs-title function_">useComponentConfigStore</span>();

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderComponents</span>(<span class="hljs-params">components: Component[]</span>): <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> {
    <span class="hljs-keyword">return</span> components.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">component: Component</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> config = componentConfig?.[component.<span class="hljs-property">name</span>];
      <span class="hljs-keyword">if</span> (!config?.<span class="hljs-property">component</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      
      <span class="hljs-comment">// 递归渲染子组件</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
        config.<span class="hljs-property">component</span>,
        {
          <span class="hljs-attr">key</span>: component.<span class="hljs-property">id</span>,
          <span class="hljs-attr">id</span>: component.<span class="hljs-property">id</span>,
          ...config.<span class="hljs-property">defaultProps</span>,
          ...component.<span class="hljs-property">props</span>,
        },
        <span class="hljs-title function_">renderComponents</span>(component.<span class="hljs-property">children</span> || [])
      );
    })
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{renderComponents(components)}<span class="hljs-tag">&lt;/&gt;</span></span>;
}
</code></pre>
<h2 data-id="heading-12">实际组件示例</h2>
<h3 data-id="heading-13">基础容器组件</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> type { <span class="hljs-title class_">CommonComponentProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../interface"</span>;
<span class="hljs-keyword">import</span> { useMaterialDrop } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../hooks/useMaterialDrop'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Container</span> = (<span class="hljs-params">{ id, name, children }: CommonComponentProps</span>) =&gt; {
  <span class="hljs-comment">// 容器可以接受 Button 和 Container 类型的拖拽</span>
  <span class="hljs-keyword">const</span> { canDrop, drop } = <span class="hljs-title function_">useMaterialDrop</span>([<span class="hljs-string">'Button'</span>, <span class="hljs-string">'Container'</span>], id);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{drop}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"border-[1px] border-[#000] min-h-[100px] p-[20px]"</span>
    &gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Container</span>;
</code></pre>
<h3 data-id="heading-14">按钮组件</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">AntdButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">ButtonType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd/es/button"</span>;

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">ButtonProps</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>;
  <span class="hljs-attr">text</span>: string;
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Button</span> = (<span class="hljs-params">{ type, text }: ButtonProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AntdButton</span> <span class="hljs-attr">type</span>=<span class="hljs-string">{type}</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">AntdButton</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Button</span>;
</code></pre>
<h2 data-id="heading-15">技术难点与解决方案</h2>
<h3 data-id="heading-16">问题：useDrop 重复触发</h3>
<p>在实现拖拽功能时，我们遇到了一个常见问题：当在嵌套的容器中拖拽组件时，<code>useDrop</code> 会被多次触发，导致同一个组件被重复添加。</p>
<p><strong>解决方案</strong>：通过 <code>monitor.didDrop()</code> 检查是否已经在子元素中处理了 drop 事件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">drop</span>: <span class="hljs-function">(<span class="hljs-params">item: { <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span> }, monitor</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> didDrop = monitor.<span class="hljs-title function_">didDrop</span>();
  <span class="hljs-keyword">if</span> (didDrop) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 如果已经在子元素处理过，则不再处理</span>
  
  <span class="hljs-comment">// 正常的添加组件逻辑...</span>
}
</code></pre>
<h3 data-id="heading-17">问题：组件树操作复杂性</h3>
<p>对组件树进行增删改查操作时，需要考虑嵌套结构带来的复杂性。</p>
<p><strong>解决方案</strong>：实现递归工具函数来处理组件树：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getComponentById</span>(<span class="hljs-params">
  id: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>,
  components: Component[]
</span>): <span class="hljs-title class_">Component</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (!id) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> component <span class="hljs-keyword">of</span> components) {
    <span class="hljs-keyword">if</span> (component.<span class="hljs-property">id</span> === id) <span class="hljs-keyword">return</span> component;
    
    <span class="hljs-keyword">if</span> (component.<span class="hljs-property">children</span> &amp;&amp; component.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> found = <span class="hljs-title function_">getComponentById</span>(id, component.<span class="hljs-property">children</span>);
      <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">return</span> found;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-18">低代码编辑器的价值思考</h2>
<h3 data-id="heading-19">对开发者的价值</h3>
<ol>
<li><strong>提升开发效率</strong>：重复性页面可以快速搭建</li>
<li><strong>降低维护成本</strong>：可视化配置比代码更直观易懂</li>
<li><strong>促进团队协作</strong>：产品、设计也能参与页面搭建</li>
</ol>
<h3 data-id="heading-20">对企业的价值</h3>
<ol>
<li><strong>降低技术门槛</strong>：业务人员也能搭建简单应用</li>
<li><strong>快速响应需求</strong>：业务变化时能快速调整</li>
<li><strong>成本控制</strong>：减少对高级开发人员的依赖</li>
</ol>
<h2 data-id="heading-21">扩展思路：让编辑器更强大</h2>
<p>基础的低代码编辑器实现后，我们可以考虑添加更多高级功能：</p>
<h3 data-id="heading-22">1. 撤销重做功能</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryState</span> {
  <span class="hljs-attr">past</span>: <span class="hljs-title class_">Component</span>[][];
  <span class="hljs-attr">present</span>: <span class="hljs-title class_">Component</span>[];
  <span class="hljs-attr">future</span>: <span class="hljs-title class_">Component</span>[][];
}

<span class="hljs-comment">// 在每次状态变更时记录历史</span>
</code></pre>
<h3 data-id="heading-23">2. 组件数据绑定</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持将组件属性绑定到数据源</span>
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"bind"</span>,
  <span class="hljs-string">"value"</span>: <span class="hljs-string">"{{user.name}}"</span>
}
</code></pre>
<h3 data-id="heading-24">3. 条件渲染和循环渲染</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持根据条件显示/隐藏组件</span>
{
  <span class="hljs-string">"condition"</span>: <span class="hljs-string">"{{user.isAdmin}}"</span>,
  <span class="hljs-string">"component"</span>: <span class="hljs-string">"AdminPanel"</span>
}

<span class="hljs-comment">// 支持循环渲染</span>
{
  <span class="hljs-string">"loop"</span>: <span class="hljs-string">"{{userList}}"</span>,
  <span class="hljs-string">"component"</span>: <span class="hljs-string">"UserItem"</span>
}
</code></pre>
<h3 data-id="heading-25">4. 事件处理系统</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 配置按钮点击事件</span>
{
  <span class="hljs-string">"onClick"</span>: {
    <span class="hljs-string">"action"</span>: <span class="hljs-string">"navigate"</span>,
    <span class="hljs-string">"params"</span>: {
      <span class="hljs-string">"url"</span>: <span class="hljs-string">"/detail"</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>通过这个简单的低代码编辑器实现，我们可以看到：</p>
<ol>
<li><strong>低代码的核心是数据结构</strong>：一个精心设计的组件树结构是基础</li>
<li><strong>拖拽交互是关键体验</strong>：流畅的拖拽体验决定编辑器的易用性</li>
<li><strong>组件化思维是桥梁</strong>：将UI拆分为可配置的组件是实现可视化的前提</li>
<li><strong>扩展性是生命力</strong>：良好的架构设计让后续功能扩展成为可能</li>
</ol>
<p>低代码并不是要取代传统开发，而是为特定场景提供更高效的解决方案。作为开发者，理解低代码背后的原理，不仅能让我们更好地使用这类平台，还能在适当时机自己构建适合业务的可视化工具。</p>
<p>技术的本质不是堆砌复杂度，而是在理解原理的基础上做出恰当的简化。希望这篇笔记能帮助你理解低代码编辑器的核心原理，在可视化开发的道路上走得更远。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 全家桶深度探索：从语法精要到项目实战]]></title>    <link>https://juejin.cn/post/7571303808116801588</link>    <guid>https://juejin.cn/post/7571303808116801588</guid>    <pubDate>2025-11-12T00:24:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571303808116801588" data-draft-id="7568796644348280832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 全家桶深度探索：从语法精要到项目实战"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T00:24:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FogLetter"/> <meta itemprop="url" content="https://juejin.cn/user/933907109778611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 全家桶深度探索：从语法精要到项目实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933907109778611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FogLetter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:24:54.000Z" title="Wed Nov 12 2025 00:24:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在现代前端开发中，Vue.js 以其渐进式框架的特性和友好的学习曲线，赢得了大量开发者的青睐。今天，就让我们一起来深入探索 Vue 全家桶的魅力所在！</p>
</blockquote>
<h2 data-id="heading-0">一、Vue 与 React：理念的碰撞</h2>
<p>在开始 Vue 全家桶的深度探索之前，让我们先来理解 Vue 与 React 这对"欢喜冤家"的核心差异。</p>
<h3 data-id="heading-1">1.1 设计哲学对比</h3>
<p><strong>React</strong> 推崇函数式编程思想，强调不可变性和单向数据流。它的核心理念是：</p>
<ul>
<li>单向数据绑定：<code>数据 -&gt; 视图</code> + <code>事件 -&gt; 数据更新</code></li>
<li>一切都是 JavaScript：JSX 将标记与逻辑耦合</li>
<li>手动优化：需要开发者关注性能优化点</li>
</ul>
<p><strong>Vue</strong> 则更倾向于渐进式和响应式：</p>
<ul>
<li>双向数据绑定：<code>v-model</code> 指令简化表单处理</li>
<li>关注点分离：模板、逻辑、样式相对独立</li>
<li>自动优化：响应式系统自动处理依赖追踪</li>
</ul>
<h3 data-id="heading-2">1.2 代码风格对比</h3>
<p>让我们通过一个简单的计数器组件来感受两者的差异：</p>
<p><strong>React 实现：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
        点击+1
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>Vue 实现：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
    &lt;button @click="count++"&gt;
      点击+1
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue';

const count = ref(0);
&lt;/script&gt;
</code></pre>
<p>可以看到，Vue 的 <code>ref</code> 和模板语法让代码更加简洁直观。特别是 <code>@click="count++"</code> 这种直接修改的方式，体现了 Vue 响应式系统的便利性。</p>
<h2 data-id="heading-3">二、Vue 3 语法精要</h2>
<h3 data-id="heading-4">2.1 SFC：单文件组件的艺术</h3>
<p>Vue 的单文件组件（Single File Component）是我最喜欢的设计之一。它将一个组件的模板、逻辑和样式封装在单个 <code>.vue</code> 文件中：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 视图层 --&gt;
  &lt;div class="greeting"&gt;{{ message }}&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 逻辑层
import { ref } from 'vue';

const message = ref('Hello Vue!');
&lt;/script&gt;

&lt;style scoped&gt;
/* 样式层 */
.greeting {
  color: #42b983;
  font-size: 1.5rem;
}
&lt;/style&gt;
</code></pre>
<p>这种组织方式让组件变得高度可维护，特别是 <code>&lt;style scoped&gt;</code> 中的样式作用域机制，完美解决了 CSS 污染问题。</p>
<h3 data-id="heading-5">2.2 模板语法：声明式渲染的魅力</h3>
<p>Vue 的模板语法既强大又直观：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 文本插值 --&gt;
    &lt;h1&gt;{{ title }}&lt;/h1&gt;
    
    &lt;!-- 属性绑定 --&gt;
    &lt;img :src="avatarUrl" :alt="userName"&gt;
    
    &lt;!-- 条件渲染 --&gt;
    &lt;div v-if="isVisible"&gt;你看得见我！&lt;/div&gt;
    &lt;div v-else&gt;现在看不见了&lt;/div&gt;
    
    &lt;!-- 列表渲染 --&gt;
    &lt;ul&gt;
      &lt;li v-for="item in items" :key="item.id"&gt;
        {{ item.name }}
      &lt;/li&gt;
    &lt;/ul&gt;
    
    &lt;!-- 双向绑定 --&gt;
    &lt;input v-model="searchText" placeholder="搜索..."&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-6">2.3 响应式系统：Vue 的灵魂</h3>
<p>Vue 3 的响应式系统基于 Proxy，提供了 <code>ref</code> 和 <code>reactive</code> 两种 API：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, reactive, computed, watch } from 'vue';

// 基本类型使用 ref
const count = ref(0);
const searchField = ref('');

// 对象类型可以使用 reactive
const user = reactive({
  name: '张三',
  age: 25,
  profile: {
    level: 'VIP'
  }
});

// 计算属性
const userInfo = computed(() =&gt; {
  return `${user.name} - ${user.age}岁`;
});

// 侦听器
watch(count, (newValue, oldValue) =&gt; {
  console.log(`计数从 ${oldValue} 变为 ${newValue}`);
});

// 方法
const increment = () =&gt; {
  count.value++;
};
&lt;/script&gt;
</code></pre>
<p><strong>响应式的重要提示：</strong></p>
<ul>
<li><code>ref</code> 创建的值在 JS 中访问需要使用 <code>.value</code></li>
<li><code>reactive</code> 创建的对象可以直接访问属性</li>
<li>模板中都不需要 <code>.value</code>，Vue 会自动解包</li>
</ul>
<h2 data-id="heading-7">三、Pinia：新一代状态管理</h2>
<p>Pinia 是 Vue 官方推荐的状态管理库，相比 Vuex，它更加简洁和类型安全。</p>
<h3 data-id="heading-8">3.1 Store 的定义与使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// store/homeStore.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">HomeTopBarItem</span>, <span class="hljs-title class_">RecentlyViewedItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/home'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useHomeStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'home'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 状态定义</span>
  <span class="hljs-keyword">const</span> topBarState = ref&lt;<span class="hljs-title class_">HomeTopBarItem</span>[]&gt;([
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"游览&amp;体验"</span>,
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'photo-o'</span>
    },
    <span class="hljs-comment">// ... 更多项</span>
  ]);
  
  <span class="hljs-keyword">const</span> recentlyViewedState = ref&lt;<span class="hljs-title class_">RecentlyViewedItem</span>[]&gt;([
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"曼谷 &amp; 芭达雅景点通票"</span>,
      <span class="hljs-attr">cover</span>: <span class="hljs-string">"https://example.com/image.jpg"</span>,
      <span class="hljs-attr">price</span>: <span class="hljs-number">173</span>,
    },
    <span class="hljs-comment">// ... 更多项</span>
  ]);

  <span class="hljs-comment">// Getter（计算属性）</span>
  <span class="hljs-keyword">const</span> expensiveItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> recentlyViewedState.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">100</span>);
  });

  <span class="hljs-comment">// Action（方法）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addRecentlyViewed</span> = (<span class="hljs-params">item: RecentlyViewedItem</span>) =&gt; {
    recentlyViewedState.<span class="hljs-property">value</span>.<span class="hljs-title function_">unshift</span>(item);
    <span class="hljs-comment">// 保持最近浏览不超过10个</span>
    <span class="hljs-keyword">if</span> (recentlyViewedState.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">10</span>) {
      recentlyViewedState.<span class="hljs-property">value</span>.<span class="hljs-title function_">pop</span>();
    }
  };

  <span class="hljs-keyword">return</span> {
    topBarState,
    recentlyViewedState,
    expensiveItems,
    addRecentlyViewed
  };
});
</code></pre>
<h3 data-id="heading-9">3.2 在组件中使用 Store</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="home"&gt;
    &lt;van-search
      v-model="searchField"
      placeholder="请输入搜索关键词"
      show-action
      shape="round"
    &gt;
      &lt;template #action&gt;
        &lt;div class="text-white"&gt;
          &lt;van-icon name="shopping-cart-o" size="1.25rem" /&gt;
        &lt;/div&gt;
      &lt;/template&gt;
    &lt;/van-search&gt;
    
    &lt;section class="topbar flex justify-around mb-3"&gt;
      &lt;div 
        v-for="item in topBarState"
        :key="item.title"
        class="topbar-item"
      &gt;
        &lt;van-icon :name="item.icon" size="2rem" /&gt;
        &lt;span class="text-xs"&gt;{{ item.title }}&lt;/span&gt;
      &lt;/div&gt;
    &lt;/section&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { toRefs, ref, onMounted } from 'vue';
import { useHomeStore } from '@/store/homeStore';

const searchField = ref&lt;string&gt;('');
const homeStore = useHomeStore();

// 使用 toRefs 保持响应式
const { topBarState, recentlyViewedState } = toRefs(homeStore);

// 直接使用 action
const handleAddItem = () =&gt; {
  homeStore.addRecentlyViewed({
    title: "新景点",
    cover: "https://example.com/new.jpg",
    price: 200,
  });
};

onMounted(() =&gt; {
  // 组件挂载后可以执行初始化操作
  console.log('Home 组件已挂载');
});
&lt;/script&gt;
</code></pre>
<p><strong>为什么使用 <code>toRefs</code>？</strong></p>
<ul>
<li>当从 store 中解构状态时，使用 <code>toRefs</code> 可以保持响应式</li>
<li>否则直接解构会失去响应式连接</li>
</ul>
<h2 data-id="heading-10">四、路由管理：Vue Router 深度应用</h2>
<h3 data-id="heading-11">4.1 路由配置与类型安全</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// router/index.ts</span>
<span class="hljs-keyword">import</span> {
  createRouter,
  createWebHistory,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">RouteRecordRaw</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;

<span class="hljs-comment">// 使用 TypeScript 确保路由配置正确</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">rootRoutes</span>: <span class="hljs-title class_">RouteRecordRaw</span>[] = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/HomePage/HomePage.vue'</span>),
    <span class="hljs-attr">name</span>: <span class="hljs-string">'home'</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'首页'</span>,
      <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">false</span>
    }
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/account'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Account/Account.vue'</span>),
    <span class="hljs-attr">name</span>: <span class="hljs-string">'account'</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'我的账户'</span>,
      <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-comment">// ... 更多路由</span>
];

<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">RouteRecordRaw</span>[] = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/TheRoot.vue'</span>),
    <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attr">children</span>: rootRoutes
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/:pathMatch(.*)*'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'NotFound'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/NotFound.vue'</span>)
  }
];

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),
  routes
});

<span class="hljs-comment">// 路由守卫</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
  <span class="hljs-comment">// 修改页面标题</span>
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
  }
  
  <span class="hljs-comment">// 身份验证检查</span>
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">requiresAuth</span> &amp;&amp; !<span class="hljs-title function_">isLoggedIn</span>()) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'login'</span> };
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<h3 data-id="heading-12">4.2 布局组件与路由视图</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- App.vue --&gt;
&lt;template&gt;
  &lt;div id="app"&gt;
    &lt;router-view /&gt;
    &lt;TabBar v-if="showTabBar" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue';
import { useRoute } from 'vue-router';
import TabBar from '@/views/layout/TabBar.vue';

const route = useRoute();

// 根据当前路由决定是否显示底部导航
const showTabBar = computed(() =&gt; {
  const hiddenRoutes = ['/login', '/register'];
  return !hiddenRoutes.includes(route.path);
});
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TheRoot.vue --&gt;
&lt;template&gt;
  &lt;div class="root-layout"&gt;
    &lt;header v-if="showHeader" class="app-header"&gt;
      &lt;van-nav-bar
        :title="currentTitle"
        left-arrow
        @click-left="router.back()"
      /&gt;
    &lt;/header&gt;
    
    &lt;main class="app-main"&gt;
      &lt;router-view /&gt;
    &lt;/main&gt;
    
    &lt;footer class="app-footer"&gt;
      &lt;TabBar /&gt;
    &lt;/footer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';

const route = useRoute();
const router = useRouter();

const currentTitle = computed(() =&gt; route.meta.title || '默认标题');
const showHeader = computed(() =&gt; !route.meta.hideHeader);
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-13">五、插槽系统：组件的灵活性之源</h2>
<p>Vue 的插槽系统让组件具备了极高的可定制性。</p>
<h3 data-id="heading-14">5.1 基础插槽使用</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseCard.vue --&gt;
&lt;template&gt;
  &lt;div class="card"&gt;
    &lt;div class="card-header"&gt;
      &lt;!-- 具名插槽 --&gt;
      &lt;slot name="header"&gt;
        &lt;!-- 默认内容 --&gt;
        &lt;h3&gt;默认标题&lt;/h3&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
    
    &lt;div class="card-body"&gt;
      &lt;!-- 默认插槽 --&gt;
      &lt;slot&gt;
        &lt;p&gt;默认内容&lt;/p&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
    
    &lt;div class="card-actions"&gt;
      &lt;!-- 作用域插槽 --&gt;
      &lt;slot name="actions" :item="itemData" :isFavorite="isFavorite"&gt;
        &lt;button @click="handleDefaultAction"&gt;默认操作&lt;/button&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-15">5.2 插槽的使用</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;BaseCard&gt;
    &lt;!-- 具名插槽使用 --&gt;
    &lt;template #header&gt;
      &lt;div class="custom-header"&gt;
        &lt;van-icon name="star" /&gt;
        &lt;h3&gt;自定义标题&lt;/h3&gt;
      &lt;/div&gt;
    &lt;/template&gt;
    
    &lt;!-- 默认插槽内容 --&gt;
    &lt;p&gt;这是卡片的主要内容...&lt;/p&gt;
    
    &lt;!-- 作用域插槽使用 --&gt;
    &lt;template #actions="{ item, isFavorite }"&gt;
      &lt;van-button 
        :type="isFavorite ? 'primary' : 'default'"
        @click="toggleFavorite(item)"
      &gt;
        {{ isFavorite ? '已收藏' : '收藏' }}
      &lt;/van-button&gt;
      &lt;van-button @click="viewDetail(item)"&gt;
        查看详情
      &lt;/van-button&gt;
    &lt;/template&gt;
  &lt;/BaseCard&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-16">六、TypeScript：Vue 的完美搭档</h2>
<p>TypeScript 为 Vue 开发带来了类型安全和更好的开发体验。</p>
<h3 data-id="heading-17">6.1 类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/home.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HomeTopBarItem</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">icon</span>: <span class="hljs-built_in">string</span>;
  badge?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 可选属性</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RecentlyViewedItem</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">cover</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  originalPrice?: <span class="hljs-built_in">number</span>;
  rating?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 泛型响应类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 组件 Props 类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RecentlyViewedProps</span> {
  <span class="hljs-attr">items</span>: <span class="hljs-title class_">RecentlyViewedItem</span>[];
  maxDisplay?: <span class="hljs-built_in">number</span>;
  showPrice?: <span class="hljs-built_in">boolean</span>;
}
</code></pre>
<h3 data-id="heading-18">6.2 组合式函数与类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// composables/useApi.ts</span>
<span class="hljs-keyword">import</span> { ref, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useApi&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Ref</span>&lt;T | <span class="hljs-literal">null</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;</span>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> request&lt;T&gt;({
        url,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
        params
      });
      data.<span class="hljs-property">value</span> = response.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? err.<span class="hljs-property">message</span> : <span class="hljs-string">'未知错误'</span>;
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };
  
  <span class="hljs-keyword">return</span> {
    data,
    loading,
    error,
    fetchData
  };
}
</code></pre>
<h2 data-id="heading-19">七、工具链与工程化</h2>
<h3 data-id="heading-20">7.1 Vite 配置优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VantResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vant/auto-import-resolver'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">VantResolver</span>()],
      <span class="hljs-attr">dts</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 生成类型声明文件</span>
    }),
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
    },
  },
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">''</span>),
      },
    },
  },
});
</code></pre>
<h3 data-id="heading-21">7.2 请求封装与拦截器</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/request.ts</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">AxiosRequestConfig</span>, 
  <span class="hljs-title class_">AxiosResponse</span>,
  <span class="hljs-title class_">AxiosError</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { showToast } <span class="hljs-keyword">from</span> <span class="hljs-string">'vant'</span>;

<span class="hljs-keyword">const</span> instance = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_BASE_URL</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>,
  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-comment">// 请求拦截器</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 添加认证 token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-comment">// 响应拦截器</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> response;
  },
  <span class="hljs-function">(<span class="hljs-params">error: AxiosError</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> status = error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span>;
    
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'请先登录'</span>);
        <span class="hljs-comment">// 跳转到登录页</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'没有权限'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'服务器错误'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'网络错误'</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-comment">// 泛型请求函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> request = &lt;T = <span class="hljs-built_in">any</span>&gt;(
  <span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AxiosResponse</span>&lt;T&gt;&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">instance</span>(config);
};

<span class="hljs-comment">// 具体的 API 请求</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> api = {
  <span class="hljs-attr">get</span>: &lt;T = <span class="hljs-built_in">any</span>&gt;<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, params?: <span class="hljs-built_in">any</span></span>) =&gt;</span> 
    request&lt;T&gt;({ <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>, url, params }),
  
  <span class="hljs-attr">post</span>: &lt;T = <span class="hljs-built_in">any</span>&gt;<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span></span>) =&gt;</span>
    request&lt;T&gt;({ <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, url, data }),
    
  <span class="hljs-attr">put</span>: &lt;T = <span class="hljs-built_in">any</span>&gt;<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span></span>) =&gt;</span>
    request&lt;T&gt;({ <span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, url, data }),
    
  <span class="hljs-attr">delete</span>: &lt;T = <span class="hljs-built_in">any</span>&gt;<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span>
    request&lt;T&gt;({ <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span>, url }),
};
</code></pre>
<h2 data-id="heading-22">八、样式与 Tailwind CSS</h2>
<h3 data-id="heading-23">8.1 原子化 CSS 的优势</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="home"&gt;
    &lt;!-- 渐变背景 --&gt;
    &lt;div class="top-bg absolute h-36 -z-10 w-screen 
                bg-gradient-to-b from-orange-500 to-white"&gt;
    &lt;/div&gt;
    
    &lt;!-- 搜索框 --&gt;
    &lt;van-search
      class="mb-2 mx-4 rounded-lg shadow-sm"
      background="transparent"
    /&gt;
    
    &lt;!-- 内容区域 --&gt;
    &lt;main class="flex flex-col space-y-4 px-4"&gt;
      &lt;header class="w-[calc(100vw-2rem)] min-h-24 
                     bg-white rounded-2xl p-4 shadow-md 
                     self-center transition-all 
                     hover:shadow-lg"&gt;
        &lt;!-- 响应式设计 --&gt;
        &lt;section class="topbar flex justify-around 
                        flex-wrap gap-4 mb-4 
                        md:flex-nowrap md:gap-0"&gt;
          &lt;div 
            v-for="item in topBarState"
            :key="item.title"
            class="topbar-item flex flex-col items-center 
                   cursor-pointer transition-transform 
                   hover:scale-105 min-w-[60px]"
          &gt;
            &lt;div class="topbar-item__icon mb-1"&gt;
              &lt;van-icon :name="item.icon" 
                        class="text-2xl text-orange-500" /&gt;
            &lt;/div&gt;
            &lt;div class="topbar-item__text text-xs 
                        text-gray-600 font-medium"&gt;
              {{ item.title }}
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/section&gt;
      &lt;/header&gt;
    &lt;/main&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-24">8.2 自定义样式与 Tailwind 结合</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* style.css */</span>
<span class="hljs-keyword">@tailwind</span> base;
<span class="hljs-keyword">@tailwind</span> components;
<span class="hljs-keyword">@tailwind</span> utilities;

<span class="hljs-comment">/* 自定义组件样式 */</span>
<span class="hljs-keyword">@layer</span> components {
  <span class="hljs-selector-class">.btn-primary</span> {
    <span class="hljs-keyword">@apply</span> bg-orange-<span class="hljs-number">500</span> text-white px-<span class="hljs-number">4</span> py-<span class="hljs-number">2</span> 
           rounded-lg <span class="hljs-attribute">hover</span>:bg-orange-<span class="hljs-number">600</span> 
           transition-colors <span class="hljs-attribute">focus</span>:outline-none 
           <span class="hljs-attribute">focus</span>:ring-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-orange-<span class="hljs-number">300</span> 
           <span class="hljs-attribute">disabled</span>:opacity-<span class="hljs-number">50</span> <span class="hljs-attribute">disabled</span>:cursor-not-allowed;
  }
  
  <span class="hljs-selector-class">.card</span> {
    <span class="hljs-keyword">@apply</span> bg-white rounded-xl shadow-sm 
           border border-gray-<span class="hljs-number">100</span> 
           <span class="hljs-attribute">hover</span>:shadow-md transition-shadow;
  }
}

<span class="hljs-comment">/* 自定义工具类 */</span>
<span class="hljs-keyword">@layer</span> utilities {
  <span class="hljs-selector-class">.text-shadow</span> {
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
  }
  
  <span class="hljs-selector-class">.scrollbar-hide</span> {
    -ms-<span class="hljs-attribute">overflow</span>-style: none;
    <span class="hljs-attribute">scrollbar-width</span>: none;
  }
  
  <span class="hljs-selector-class">.scrollbar-hide</span>::-webkit-scrollbar {
    <span class="hljs-attribute">display</span>: none;
  }
}
</code></pre>
<h2 data-id="heading-25">九、项目架构最佳实践</h2>
<h3 data-id="heading-26">9.1 目录结构设计</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── assets/          <span class="hljs-comment"># 静态资源</span>
│   ├── images/
│   └── styles/
├── components/      <span class="hljs-comment"># 通用组件</span>
│   ├── ui/         <span class="hljs-comment"># 基础UI组件</span>
│   └── business/   <span class="hljs-comment"># 业务组件</span>
├── views/          <span class="hljs-comment"># 页面组件</span>
├── store/          <span class="hljs-comment"># 状态管理</span>
│   ├── modules/    <span class="hljs-comment"># 模块化store</span>
│   └── index.ts
├── router/         <span class="hljs-comment"># 路由配置</span>
├── utils/          <span class="hljs-comment"># 工具函数</span>
│   ├── request.ts
│   └── helpers.ts
├── types/          <span class="hljs-comment"># 类型定义</span>
├── composables/    <span class="hljs-comment"># 组合式函数</span>
├── api/            <span class="hljs-comment"># API接口</span>
└── main.ts
</code></pre>
<h3 data-id="heading-27">9.2 组件设计原则</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 好的组件设计示例 --&gt;
&lt;template&gt;
  &lt;ProductCard
    :product="product"
    :show-price="true"
    :favorite="isFavorite"
    @favorite-toggle="handleFavoriteToggle"
    @click="handleCardClick"
  &gt;
    &lt;template #badge&gt;
      &lt;van-tag v-if="product.isNew" type="primary"&gt;
        新品
      &lt;/van-tag&gt;
    &lt;/template&gt;
    
    &lt;template #actions&gt;
      &lt;van-button 
        size="small" 
        type="primary"
        @click.stop="handleBuy"
      &gt;
        立即购买
      &lt;/van-button&gt;
    &lt;/template&gt;
  &lt;/ProductCard&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
// 明确的 Props 定义
interface Props {
  product: Product;
  showPrice?: boolean;
  favorite?: boolean;
}

const props = withDefaults(defineProps&lt;Props&gt;(), {
  showPrice: true,
  favorite: false
});

// 明确的事件定义
const emit = defineEmits&lt;{
  'favorite-toggle': [id: string, value: boolean];
  click: [product: Product];
}&gt;();

// 组合式函数复用
const { toggleFavorite } = useFavorite();
const { addToCart } = useCart();

const handleFavoriteToggle = async () =&gt; {
  const newValue = !props.favorite;
  await toggleFavorite(props.product.id, newValue);
  emit('favorite-toggle', props.product.id, newValue);
};

const handleCardClick = () =&gt; {
  emit('click', props.product);
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-28">十、性能优化与最佳实践</h2>
<h3 data-id="heading-29">10.1 组件性能优化</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 虚拟滚动优化长列表 --&gt;
  &lt;RecycleScroller
    :items="largeList"
    :item-size="80"
    key-field="id"
    v-slot="{ item }"
    class="h-96"
  &gt;
    &lt;ProductItem :item="item" /&gt;
  &lt;/RecycleScroller&gt;
  
  &lt;!-- 图片懒加载 --&gt;
  &lt;img
    v-for="image in images"
    :key="image.id"
    v-lazy="image.url"
    class="product-image"
    alt="产品图片"
  /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed, watchEffect, shallowRef } from 'vue';

// 使用 shallowRef 避免深度响应式
const largeList = shallowRef([]);

// 计算属性缓存
const filteredList = computed(() =&gt; {
  return largeList.value.filter(item =&gt; 
    item.price &gt; 0 &amp;&amp; item.stock &gt; 0
  );
});

// 监听优化
watchEffect(() =&gt; {
  // 只有当依赖变化时才执行
  if (filteredList.value.length &gt; 0) {
    updateStatistics(filteredList.value);
  }
});

// 函数记忆化
const expensiveCalculation = computed(() =&gt; {
  return heavyCalculation(filteredList.value);
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-30">10.2 打包优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">manualChunks</span>: {
          <span class="hljs-string">'vue-vendor'</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>],
          <span class="hljs-string">'ui-library'</span>: [<span class="hljs-string">'vant'</span>],
          <span class="hljs-string">'utils'</span>: [<span class="hljs-string">'axios'</span>, <span class="hljs-string">'dayjs'</span>, <span class="hljs-string">'lodash-es'</span>]
        }
      }
    },
    <span class="hljs-attr">chunkSizeWarningLimit</span>: <span class="hljs-number">1000</span>
  }
});
</code></pre>
<h2 data-id="heading-31">总结</h2>
<p>Vue 全家桶提供了一个完整、优雅的前端解决方案。从响应式系统到状态管理，从路由控制到构建工具，每一个环节都体现了 Vue 团队对开发者体验的深度思考。</p>
<p><strong>Vue 的核心优势：</strong></p>
<ol>
<li><strong>渐进式</strong>：可以根据项目需求逐步采用</li>
<li><strong>响应式</strong>：自动的依赖追踪和更新</li>
<li><strong>组合式</strong>：优秀的逻辑复用能力</li>
<li><strong>类型友好</strong>：与 TypeScript 完美结合</li>
<li><strong>生态丰富</strong>：完整的工具链和组件库</li>
</ol>
<p>无论是初创项目还是大型企业应用，Vue 全家桶都能提供出色的开发体验和运行性能。希望这篇笔记能帮助你更好地理解和运用 Vue 全家桶，在开发路上越走越远！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>