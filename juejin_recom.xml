<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Kiro vs Trae Solo: Vibe coding实操全攻略及使用思路深度探讨]]></title>    <link>https://juejin.cn/post/7597776334066008116</link>    <guid>https://juejin.cn/post/7597776334066008116</guid>    <pubDate>2026-01-22T08:02:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334066008116" data-draft-id="7597776334065811508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kiro vs Trae Solo: Vibe coding实操全攻略及使用思路深度探讨"/> <meta itemprop="keywords" content="产品"/> <meta itemprop="datePublished" content="2026-01-22T08:02:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="话不投机半"/> <meta itemprop="url" content="https://juejin.cn/user/186260337994656"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kiro vs Trae Solo: Vibe coding实操全攻略及使用思路深度探讨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186260337994656/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    话不投机半
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:02:51.000Z" title="Thu Jan 22 2026 08:02:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先导：kiro与trae solo的整体风格对比</h2>
<p>市面常见的AI 驱动 IDE有两个另类：trae和kiro。</p>
<p>字节真的在把用户当作0基础，秉持 “零基础友好” 的理念，致力于实现Vibe coding；而亚马逊出品的 Kiro 直接给出vibe coding模式，结合工程化严谨开发的范式，更受到技术背景产品经理的青睐。</p>






















































<table><thead><tr><th/><th>Kiro vibe coding</th><th>Trae Solo builder</th><th>Kiro spac coding</th><th>Trae Solo coder</th></tr></thead><tbody><tr><td>开发风格</td><td>用户主导</td><td>agent主导</td><td>用户主导</td><td>agent主导</td></tr><tr><td>文档类型</td><td>/</td><td>/</td><td>产品经理--用户故事</td><td>项目经理</td></tr><tr><td>工作流</td><td>交互开发</td><td>全流程管理</td><td>需求澄清-设计-测试</td><td>开发计划-执行生成</td></tr><tr><td>模型</td><td>claude</td><td>Grok、Gemini、kimi</td><td>claude</td><td>Gemini、kimi</td></tr><tr><td>特色</td><td>交互追问，有助于梳理、<strong>明确需求</strong></td><td><strong>全流程管理</strong>。包含前期交互到后期部署上线，小白友好</td><td>支持vibe coding转化为spac coding；<strong>工作流</strong> <strong>明确</strong>，保证输出的稳定性一致性</td><td><strong>近乎实现0代码。</strong> 创造力更强，对有创意的非开发者能提供更强大支持</td></tr><tr><td>适用于</td><td>主观能动性强、探索性，简单项目开发</td><td>idea快速落地验证，产品demo快速实现</td><td>工程化项目迭代；需求明确的产品开发</td><td>非精准实现方式，但明确目的项目开发</td></tr></tbody></table>
<p>kiro是亚马逊出品的AI 驱动 IDE，界面风格主色调为紫色。ai对话样式为右上角的对话框，支持左右双侧调用，整体布局与传统IDE有一些区别。</p>
<p>kiro在支持模型上优势是支持claude 4.5。新用户注册送500信用值，相当于对话token的折算，不同模型对应credit不同。实践验证可知，一个简单的网站开发使用20-70左右。但想要基于长上下文复杂开发消耗偏大。</p>
<p>ai对话栏里同样支持三个实用功能：通过<code>#</code>引用内容，包括代码、文本等；上传图片交互；集成<code>内容使用率（圆环）</code>，当上下文过长时（超过80%），工具会自动总结压缩，通常压缩到20%左右，以此实现对话开发的持续。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0b6e8f97af04f58978c17b5252ef75e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=82vJ6GeGB0XvaJCAdHHLRVE3d3k%3D" alt="" loading="lazy"/></p>
<p>不同于其他类型的ai辅助编程IDE，Kiro更偏向于工程化实践和产品开发。分为vibe coding和spec coding两种模式：</p>
<ul>
<li>只有idea的时候建议使用**<code>Vibe Coding</code>**模式，快速产出可用产品；</li>
<li>有产品demo时，可以使用**<code>Spec Coding</code>**模式，聚焦迭代优化和落地。</li>
</ul>
<p><strong>个人成果展示：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhufu-web.netlify.app%2F" target="_blank" title="https://zhufu-web.netlify.app/" ref="nofollow noopener noreferrer">My Trae Project</a></strong></p>
<h2 data-id="heading-1">Vibe coding based on kiro</h2>
<ol>
<li>
<h3 data-id="heading-2"><strong>初始交互</strong></h3>
</li>
</ol>
<p>点击左上角文件夹，新建或打开一个文件。之后输入提示词，开始和Kiro对话。</p>
<p>注意，如果先对话，kiro会让你打开文件夹后继续交流。但打开后文件夹后会是新对话，所以此步注意要<strong>先新建/打开文件夹</strong>。</p>
<p>对话框中输入提示词，尽可能完善的描述需求。Vibe模式会优先构建可实现思路，通过交互解决不确定性，给出选项帮助用户明确实现路径。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbde92f7a4744576996631b3d9fa141c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=pLH%2Fbvm9jitKPvNTB6mUuSG7V0E%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4436ac21fe48448c8f62e4843dd393db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=qmJ1OTwgzSPKrOegq9z2kPlH7MI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词：</p>
<p>你是一个资深软件产品经理。</p>
<p>我现在在设计一个网站。功能是用户输入对应的人，比如说父母，导师等，可以自动生成新年祝福词。</p>
<p>我想和你一起进行交互设计。整体的页面风格我希望整洁，科技感强一些，然后有对应的交互动画，切换丝滑。</p>
<p>但是需要注意的是，我没有太多网站部署的经验和设计经验，我希望你能一步一步来带我做。文件夹已经帮你打开了，开始？</p>
</blockquote>
<ol start="2">
<li>
<h3 data-id="heading-3"><strong>开发执行</strong></h3>
</li>
</ol>
<p>智能体开发模式时（默认），会弹出命令运行指令，需要用户手动操作。可<code>取消</code>，<code>信任此命令并运行</code>，<code>直接运行</code>：</p>
<p>对于简单命令可直接“trust”，避免重复工作</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011c9c45fa7b446ebd2af5551cb81c22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=1Yd4TrnrWKUMdBkYciYd4Xjal94%3D" alt="" loading="lazy"/></p>
<p><code>trust：</code>点击紫框后，点击”打开设置“，添加命令白名单（agent会自动添加）后，即可自动继续运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2871b2dd3c6f49b4b39509ac36d55600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=SOgJbMPyf1u0t9ill%2Fj%2BvFi1f0E%3D" alt="" loading="lazy"/></p>
<p>当Kiro显示<code>working</code>状态时会自动推进开发，但部分场景下后台进程**<code>background process</code><strong>会需要用户</strong>手动点击继续**（右侧会出现倒三角按钮）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0a2de5199924ef8969c0ce00b3d3b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=uTQ1bQQR9dJ3IuxxPJ5aysYS%2FuM%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<h3 data-id="heading-4"><strong>页面生成</strong></h3>
</li>
</ol>
<p>通过安装库、依赖，交互，测试后，顺利生成网站：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9b5725de2ef426e8f1ac0eaa38bb7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=aOlaBKcisHj3anaTi2%2Fnyfrhnyw%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e246646ee52482787bcc27f4fa92a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=RumO7aXaivZC%2B9yZtWMvWLIzkis%3D" alt="" loading="lazy"/></p>
<p>为快速验证交互流程，初期Demo在代码里会内置固定的祝福词模板。页面的逻辑没问题后，可以专心集成api。</p>
<p>api获取方式：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmcnlt2y27g43.feishu.cn%2Fwiki%2FG1hgw9mYzikBf6kfttTc18Knn7g%3FlarkTabName%3Dspace%23share-Wv0hdTCoToPdNmx5nbEcdw95nyg" target="_blank" title="https://mcnlt2y27g43.feishu.cn/wiki/G1hgw9mYzikBf6kfttTc18Knn7g?larkTabName=space#share-Wv0hdTCoToPdNmx5nbEcdw95nyg" ref="nofollow noopener noreferrer">智能体经典范式构建</a></p>
<ol start="4">
<li>
<h3 data-id="heading-5"><strong>api</strong> <strong>调用</strong></h3>
</li>
</ol>
<p>直接在对话里告诉kiro你要调用的模型，并生成环境变量<code>.env</code>。等待其创建完成后，填入api即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04f7f045d8734c0fae4802d4562d5576~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=ntgmx34QWZ%2BvWHy5tGKjlZ74nbc%3D" alt="" loading="lazy"/></p>
<p>手动或告知kiro<strong>把</strong> <strong>环境变量</strong> <strong>添加到</strong> <strong><code>.gitignore</code></strong>，避免误提交到Git。</p>
<ol start="5">
<li>
<h3 data-id="heading-6"><strong>深度修改</strong></h3>
</li>
</ol>
<p>当前生成的demo会比较简陋，一些按钮功能没做出来，我们可通过语言交互把偏重要的修改先做出来，比如：</p>
<ul>
<li>返回按钮；</li>
<li>逻辑不自洽的地方。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd2c5f7ddad24454b450c6f0bc0eefe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=vd1%2FMiHb8XfibBjAI6T%2B60w%2BKXs%3D" alt="" loading="lazy"/></p>
<p>一种常见的kiro使用方法是：<strong>vibe模式生成</strong> <strong>MVP</strong> <strong>原型--&gt;切换</strong> <strong>spac</strong> <strong>模式完成后续迭代</strong></p>
<p>因此，上述对应的修改同样可以放到spac模式迭代。但基础的逻辑问题放到vibe模式亦可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c843251242b8479690e8468c27be4a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=WMglDrq7bK05WBCCqkPg0mUdA38%3D" alt="" loading="lazy"/></p>
<p>到此为止，我们基于**<code>vibe coding</code>**模式生成的小网站就可以正常使用了。</p>
<h2 data-id="heading-7">Spac coding based on kiro</h2>
<p>**<code>Spac coding</code>**模式与vibe模式最大的不同在于，Vibe 模式是直觉导向的自由对话式开发，Spec 模式是规范驱动的结构化规划式开发。简单来说：</p>
<ul>
<li>Vibe 模式像聊天一样直接下达需求，kiro会即时执行；</li>
<li>Spec 模式需先明确规范，输入需要更加完善。包括页面有什么，逻辑关系等等。甚至直接把vibe开发的项目包丢进去。随后spac模式会通过结构化文档固化需求、设计和任务，再推进开发。</li>
</ul>
<p>本节中，我们分别尝试两种方式使用spac模式完成并完善新年祝词小网站。</p>
<ol>
<li>
<h3 data-id="heading-8">vibe 模式继承开发</h3>
</li>
</ol>
<p><strong>（1）模式转换</strong></p>
<ul>
<li><strong>自动转换：</strong> 当我们输入词中可能包含（需求文档，新开发，迭代等等），kiro会自动分析我们想要进行规范化开发，从而转向spac模式。此时在页面中点击<code>Yes</code>即可转换模式。</li>
<li><strong>手动转换：</strong> 直接在对话页面新建 Spec 模式对话，导入 Vibe 模式开发的项目包，延续开发流程。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64838b7436534092a22d37b85e8282ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=FGFTnF6qWsFBsUQgHnhicVlY0Fc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词：</p>
<p>假设现在你是产品经理。现在帮我生成该网站的需求文档，或者是逻辑文档。我交给其他开发同事去做。</p>
<p>注意：内容不要太多，不要分点，简单描述内容、逻辑关系、设计风格即可</p>
</blockquote>
<p><strong>（2）版本迭代</strong></p>
<p>在spac模式下，更新生成新模块需要更结构化的描述才有助于开发。</p>
<blockquote>
<p>提示词：</p>
<p>我现在需要开发一个新功能：“主题”功能。</p>
<p>背景：考虑到直接生成祝福词太宽泛，容易被误解为群发，因此需要新增该功能，了解用户背后故事。</p>
<p>示例：为李老师生成祝福词，主题：感谢指导论文，感谢帮我提供找工作的思路。</p>
<p>设计：类似于自定义关系的的文本框，同样为非必填。</p>
<p>生成：最后生成内容交给大模型，关注主题和对象来生成祝福语。</p>
<p>调用你的spac工作流，帮我完成开发工作</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57ade833af51459d8cdbe5c6403293b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=gQMNJ%2BC%2BkO67BSUBCUB79c64fN8%3D" alt="" loading="lazy"/></p>
<p>该模式下会生成<code>requestments</code>,<code>design</code>,<code>task list</code>工作流对应的核心文档，逐步完成开发。请首先确定需求<code>requestments</code>是否有遗漏或逻辑问题。</p>
<p><strong>（3）设计阶段</strong></p>
<p>需求澄清后，点击move to design phase 转到设计阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb9ee532f0a47eb99e350430c95354b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=SuR5kaK0gvalWVrd%2Fcpgu7ztTc4%3D" alt="" loading="lazy"/></p>
<p>设计文档生成后，检查（该文档偏专业一些，建议直接跳过到下一阶段），若无问题点击右下角进到测试阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87883fdaaf3c455bb250ceabed72ed77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=DBMqM8mluFs4Dw%2BmGeBHFkmxf%2BQ%3D" alt="" loading="lazy"/></p>
<p><strong>（4）测试阶段</strong></p>
<p>通常会给出全面测试和必要性测试。根据任务强度自选。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3696f18740847c794c5662e97ae9d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=kNDhp3KRWmtQAy%2Ber1yefka7N9E%3D" alt="" loading="lazy"/></p>
<p>测试可以使用run all tasks（适用于完全测试）,或者kiro对话框交互一个一个来测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ce791926644cf8bad64aaba785e9d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=5S%2BynMyUJtFp7HX87jnodS2hgmo%3D" alt="" loading="lazy"/></p>
<p>需要注意的是，测试通常耗时较长，耗费credit较多，过程中新增极多测试文件，报错重测概率高。如若简单任务或不涉及模型调用，建议简单测试即可。</p>
<blockquote>
<p><strong>tips：</strong> task list 中会实时显示测试进度：完成后用绿色标注，进行中为蓝色，未测试为灰色。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c4866c34ae4cb9a6ee7c3a88757fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=mwmSrK0wTyE6GkykesHEbcqc8KU%3D" alt="" loading="lazy"/></p>
</blockquote>
<p><strong>（5）后续优化</strong></p>
<p>完成后打开网站实测：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29e66da6892a424596fe6b3e7efffa18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=YyhWUlGHtHzAlTG5YLeuaDDcfjE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695b84dddb704706abf167e98d494e83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=BjhRgpEBdHjQ5iMhpJQEcUxFzwM%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce20c141b13143459a55ebf1a13a056e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=Ccyp64I3XQuGNJ%2B%2BfVwaqfuPRaY%3D" alt="" loading="lazy"/></p>
<p>测试正常后，清除不必要的文件，交给kiro自动解决。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc10b3c90e72463eb8c9716023889c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=3Xp3cJpCGKWK1y470%2FmGkPSRn0s%3D" alt="" loading="lazy"/></p>
<p>至此，我们的网站开发顺利完成。</p>
<ol start="2">
<li>
<h3 data-id="heading-9">严谨输入开发</h3>
</li>
</ol>
<p>在前文，我们基于vibe模式将我们的简单意图实现为可用demo，之后通过转为spac模式，通过其<strong>需求--设计--测试</strong>工作流，完成了更新迭代。</p>
<p>除了继承 Vibe 模式成果，Spec 模式也支持直接导入 PRD启动开发。在本节，我们首先使用上一节开发的网站，用kiro生成相应的PRD。随后复制给spac coding直接开发。<strong>后续流程同继承式开发</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e6819ea83ea45ca8a85acef22993b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=v6AHCrZbWb%2BoBuxbDW2cECFQxwI%3D" alt="" loading="lazy"/></p>
<p>生成简单、逻辑自洽、不分点的PRD即可。无需过度冗余内容</p>
<h2 data-id="heading-10">Kiro Summary</h2>
<ul>
<li><strong>Vibe 模式优势：</strong> 通过对话梳理模糊需求，<strong>快速产出</strong> <strong>MVP</strong>，逐步完成开发。但其<strong>测试的缺失</strong>会导致报错频繁。</li>
<li><strong>Spec</strong> <strong>模式优势：</strong> 通过 “需求 - 设计 - 测试” 三步工作流，<strong>输出的内容稳定可靠</strong>。但单独使用spac模式会显著把问题复杂化，直接导入 PRD就会部署出<strong>功能过度冗余、测试流程繁琐</strong>的产品。且前期自动生成过多导致后期修改空间小，更加不可控，对新手友好度低。</li>
</ul>
<p><strong>综合来看：</strong></p>
<ul>
<li>对于一个不明确或者偏模糊的idea，建议使用vibe模式先澄清需求，产出mvp后转到spac开发迭代。</li>
<li>明确的需求可以用spac，但要求使用者明确产品开发的全流程，包括后期部署、性能测试等，从产品经理的角色兼顾项目经理的角色---<strong>这点是kiro使用中常见的误区。如果不具备专业知识储备，不在前期多介入交流，后期很可能被agent牵着鼻子走，难修改。</strong></li>
<li>对于非专业开发人士，或只想手搓一些可用小玩具的用户来说，无论需求明确与否，<strong>vibe模式入手多介入，再转</strong> <strong>spac</strong> <strong>开发迭代小模块</strong>，可能仍是最优解。</li>
</ul>
<h2 data-id="heading-11">Vibe coding based on SOLO <strong>Builder</strong></h2>
<p>Trae Solo 是字节系 AI 开发工具，0119版本更新后，<strong>TRAE国际版SOLO模式</strong>下的智能体包含**<code>SOLO Coder</code>**和 <strong><code>SOLO Builder</code></strong>。</p>
<p>二者核心区别在于适用场景、核心能力与协作模式，前者侧重复杂项目 “从 1 到 100” 的迭代重构，后者专注 Web 应用 “从 0 到 1” 的快速搭建，二者互补覆盖全开发流程。</p>
<p><strong>--</strong>-<strong>本质上来说，和kiro是类似的，但ai会主导更多</strong>。</p>
<p>开发前，加入一些智能体辅助开发：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flcnziv86vkx6.feishu.cn%2Fwiki%2FS9jow8TyXiItiqklkLcc3ESYnph" target="_blank" title="https://lcnziv86vkx6.feishu.cn/wiki/S9jow8TyXiItiqklkLcc3ESYnph" ref="nofollow noopener noreferrer">[最佳实践 海外版]8 个支持一键导入 TRAE 使用的自定义智能体</a></p>



































<table><thead><tr><th/><th>Kiro（Vibe/Spec）</th><th>TRAE SOLO（Builder/Coder）</th></tr></thead><tbody><tr><td><strong>轻量模式</strong></td><td>Vibe：快速对话式编码，无强制文档，适合原型 / 探索 / 小改，自由灵活</td><td>SOLO Builder：自然语言→自动选模型→生成 PRD→出可预览成果，一键部署，面向快速落地</td></tr><tr><td><strong>规范模式</strong></td><td>Spec：先产出 requirements/design/tasks 三文档，结构化规划后编码，适合复杂项目 / 团队协作，可追溯可控</td><td>SOLO Coder：需求分析→任务规划→多智能体编排→迭代重构，适合已有代码迭代 / 架构优化，支持人工介入</td></tr><tr><td><strong>设计理念</strong></td><td>从 “vibe coding” 到 “viable code”，覆盖创意到工程化全流程</td><td>从 “0 到 1 快速搭建” 到 “1 到 100 深度开发”，互补覆盖原型到成熟产品</td></tr><tr><td><strong>工具定位</strong></td><td>AI 驱动 IDE，侧重编码环境内的开发协作</td><td>TRAE 平台的智能体，侧重全流程任务闭环与智能体协同</td></tr><tr><td>二者差异</td><td><strong>流程上：</strong> Kiro Spec强制生成三文档（需求 / 设计 / 任务），SOLO Coder：自主编排多智能体分工。</td><td/></tr></tbody></table>
<ol>
<li>
<h3 data-id="heading-12"><strong>主页面介绍</strong></h3>
</li>
</ol>
<p>相较于kiro，trae的可视化界面布局传统，模块、按钮更完善。对于国内新手开发者而言，无论是CN版还是国际版，中文的使用能够贯彻全流程（对话中英文与否和取决于搭载模型）。而kiro的中文语言设定只在状态栏生效。</p>
<p>界面左侧为任务栏，更像是常见的大模型对话模式，可开启多个任务。智能体布局在中间，表明了其“ai主导”的决心。右上角的<code>实时跟随</code>可以透明化看到trae在编辑哪些文档。</p>
<p>对话框里和kiro类似，开始对话后也会有上下文使用率。<strong>有对话优化功能</strong>，帮助用户优化提示词对话文本等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d447c1baf443cdb031ad4fc22020f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=%2BDJTF%2BSUIXgx%2BntaO5sZMZ6Mu8U%3D" alt="" loading="lazy"/></p>
<p>使用同样的提示词，交给builder。在solo模式，默认模型只有Gemini 3和kimi K2。此处使用Gemini 3 pro进行开发。</p>
<ol start="2">
<li>
<h3 data-id="heading-13"><strong>交互生成demo</strong></h3>
</li>
</ol>
<p><strong>builder模式也会生成简单的</strong> <strong>PRD</strong>，相较kiro的工程化文档，更偏向于一个C端产品经理的输出风格：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7d93f0ab72042148ee40d9f6dbb56ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=XNgRihk0pv%2Bp50o6MXySlbnjyvU%3D" alt="" loading="lazy"/></p>
<p>生成PRD后更多的是返回用户“有了什么”，而不是讨论详细的细节，给出的更像一个汇报。</p>
<p>对于模糊需求的用户会省心，方便偷懒。但没有深入交互的生成，对一些偏严谨细致的需求者会更“累”，需要主动去修改。</p>
<ol start="3">
<li>
<h3 data-id="heading-14"><strong>成果及部署</strong></h3>
</li>
</ol>
<p>trae生成网址后会给出预览，并默认vercel部署选项。在应用拓展的便捷性比kiro做的好一些。全程托管对于懒人来说省事很多。<del>而且经过多次生成对比，trae生成页面的风格、颜值确实（可能）要高一些。</del></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75edda8f25644743bbfcb650f1356633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=%2FsrKvYMLYWhM9r9mZH31qdA0ruI%3D" alt="" loading="lazy"/></p>
<p>为保证对比一致性，添加一些功能：</p>
<blockquote>
<p>提示词：</p>
<p>1.新增“编辑”按钮，不只有复制和换一句，允许生成后用户自己编辑。</p>
<p>2.给出一个用户输入选项，让用户自己输入祝福对象。</p>
<p>3.打开api填写页面我来填写。</p>
</blockquote>
<p>返回结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed0a788b7af0419d91862e59d3a5d9a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=EEP%2BjQ%2BDgvl2sMarGRvA%2BrbkTco%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ddbb656eb8b46aaa524060984857403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=%2FbDy%2BwpXi0GHvY7yi6UrcKC4tB0%3D" alt="" loading="lazy"/></p>
<p>最终第一版本更新如下。预览页面提供元素选择和更改功能，可以快速进行定向调整。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b187ae85b9f44cf1bf2de85760164de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=r1E%2BIQEoyjSmCxCmKrPvQcHDMuE%3D" alt="" loading="lazy"/></p>
<p>最后测试能否自动转入solo coder模式，失败 。只能手动转。而且在对话框中直接转模式并不会影响风格。</p>
<ol start="4">
<li>
<h3 data-id="heading-15"><strong><code>SOLO coder</code></strong> <strong>模式</strong> <strong>继承</strong> <strong>开发</strong></h3>
</li>
</ol>
<p>在左侧任务栏新建任务，选择coder模式继续开发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ac83ac69cb34a199bd4e9d50bff92ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=P%2B7TLtlMd4L1fAhHrkRuxwAZJJI%3D" alt="" loading="lazy"/></p>
<p>在开启plan模式之前，输出内容并无差异。主要差异在推理过程。</p>
<p>最后生成如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cd5c5379dc244dfaf05359a1402f72d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=9dDXINOI7kI34tL8Rm21kUymnpc%3D" alt="" loading="lazy"/></p>
<p>功能描述：</p>
<hr/>
<blockquote>
<p>产品概述 本项目是一款基于 AI 的智能祝福语生成工具，旨在帮助用户在不同节日和社交场景下，快速创作出得体、个性化且富有文采的祝福内容。核心价值在于解决传统模板千篇一律的痛点，通过多维度的参数配置，让 AI 生成真正符合用户具体情境的专属文案。</p>
<p>核心逻辑与功能 产品的交互逻辑围绕“四维配置”展开，用户依次确定四个关键参数：节日场景（如新年、生日，决定了 AI 的基础人设）、祝福对象（如父母、领导，决定了语气亲疏）、语言风格（如古风、幽默，决定了行文格调）以及具体主题（如“感谢提拔”，用于注入个性化背景）。前端将这些参数动态拼装成结构化的 Prompt 发送给大模型，确保生成内容精准命中用户需求。生成结果通过弹窗形式展示，支持打字机动效以增强交互感，并提供一键复制、二次编辑和重新生成功能，形成了从配置到获取再到优化的完整闭环。</p>
<p>UI 设计风格 界面设计采用极具未来感的赛博朋克与毛玻璃（Glassmorphism）风格。视觉上以深色背景为主基调，搭配半透明的磨砂玻璃卡片容器和高饱和度的霓虹光效（蓝紫色系），营造出高端、科技的氛围。交互层面强调流畅性，弹窗的缩放出现、按钮的微交互以及文字的逐字显现，共同构建了沉浸式的使用体验。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16"><strong>Spac</strong> <strong>coding based on SOLO</strong> <strong>coder</strong></h2>
<p>Coder 模式是 Trae Solo 的<strong>深度开发模式</strong>，开启<code>plan</code>功能后，将展现与 Builder 模式的核心差异。</p>
<p>将上一阶段生成的PRD文档复制发给trae。让其自动规划开发：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55f9ee84516848578e3a4d3f70d0fdbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=7bj9ihxM0CorlJg%2BlNPhdo%2FuZ8A%3D" alt="" loading="lazy"/></p>
<p>与kiro类似，plan模式下工具会自动生成<strong>项目管理视角的开发计划书</strong>，涵盖技术栈选型、开发步骤规划、UI 风格定义等核心内容，区别于 Kiro 的工程化需求文档。点击 <strong>执行</strong> 进到下一步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d83f0c63ead3442eaf858bf79ec01901~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=wQRvBuaNfC%2FY%2FQpNkencEI2VZyA%3D" alt="" loading="lazy"/></p>
<p>通常在自动执行时，工具会将开发任务拆分，分配给多个 Agent 协同完成。开发过程中，在终端or对话端需要用户操作，但不会提示。</p>
<p>最终生成页面如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6896be67fd33493c84f4db8a83b6aa38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-d5LiN5oqV5py65Y2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674091&amp;x-signature=h5JfV1W%2BvaX7H4u5gthLlWRSVo0%3D" alt="" loading="lazy"/></p>
<p>与builder模式不同，coder模式生成网站默认不帮助用户部署，但同样在右上角有部署选项。开发效果也会随着PRD的详细程度变动。</p>
<h2 data-id="heading-17">Trae Solo summary</h2>
<ul>
<li>总体来说，Solo模式的核心优势在于<strong>Agent 强主导性</strong>，主导设计、开发的意识，对简单、模糊需求用户很友好。可视化界面与一键部署功能大幅降低开发门槛。</li>
<li>而builder模式正如其宣传的 <strong>“全链路协同”</strong> ，从简单的需求编写到上线部署，核心是帮助用户 “从 0 到 1” 的创意落地。</li>
<li>如果是高精准项目，除非用户清楚自己“要什么”，不然builder模式输出的模糊需求文档带来的不确定性，可能会导致后期更新迭代困难。即使有上下文压缩功能，也会由于agent主导的开发思路导致用户需求的忽略。最终变成一个普通的对话agent。</li>
<li>coder模式在不开启plan时输出风格结果相近与builder，同样的agent主导，对项目拆分规划，自主修bug，多智能体协同开发。开启plan模式后给出的文档不同于kiro的requestments，整体风格更偏向于项目经理的角度，开发技术栈、ui风格、步骤等等，同时此模式下会将任务拆分交给多个agent自主开发，也会导致结果与模型的风格，能力更相关。</li>
</ul>
<h2 data-id="heading-18">常见问题</h2>
<p><strong>1.node.js安装</strong></p>
<p>建议在打开kiro前先安装，避免出问题。</p>
<p><strong>2.kiro Operation was aborted by user or system. The agent has seen this error and will try a different approach to write the file if needed.</strong></p>
<p>等会重新生成，或者换个网络。</p>
<p><strong>3.An unexpected error occurred, please retry</strong></p>
<p>直接发送：Continue</p>
<p><strong>4.部署平台</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.netlify.com%2F" target="_blank" title="https://www.netlify.com/" ref="nofollow noopener noreferrer">netlify</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2F" target="_blank" title="https://vercel.com/" ref="nofollow noopener noreferrer">vercel</a></p>
<p>才疏学浅，欢迎各位大佬指导交流经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi-cloud基于枚举实现的导出字典转换方案（枚举篇）]]></title>    <link>https://juejin.cn/post/7597742970282197044</link>    <guid>https://juejin.cn/post/7597742970282197044</guid>    <pubDate>2026-01-22T08:39:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970282197044" data-draft-id="7597776334065958964" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi-cloud基于枚举实现的导出字典转换方案（枚举篇）"/> <meta itemprop="keywords" content="Excel"/> <meta itemprop="datePublished" content="2026-01-22T08:39:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蝌蚪纹青蛙"/> <meta itemprop="url" content="https://juejin.cn/user/2747015110601144"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi-cloud基于枚举实现的导出字典转换方案（枚举篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2747015110601144/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    蝌蚪纹青蛙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:39:06.000Z" title="Thu Jan 22 2026 08:39:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于枚举实现的高性能字典转换方案</h2>
<h3 data-id="heading-1">一、方案选型背景</h3>
<h4 data-id="heading-2">性能对比分析</h4>
<p>在数据导出场景中，我们需要将字典编码转换为可读性更强的描述文本。经过性能测试对比：</p>
<ul>
<li><strong>枚举转换方案</strong>：处理 3 万条数据耗时约 <strong>11 秒</strong></li>
<li><strong>Redis 字典缓存方案</strong>：处理 3 万条数据耗时约 <strong>5 分钟</strong></li>
</ul>
<p>尽管测试环境使用的是较旧的硬件设备，但两种方案的性能差距依然非常显著。因此，我们选择基于枚举实现字典转换，以获得更优的性能表现。</p>
<hr/>
<h3 data-id="heading-3">二、技术实现步骤</h3>
<h4 data-id="heading-4">1. 配置 Lombok 依赖</h4>
<p>在项目根目录的 <code>pom.xml</code> 中添加 Lombok 的版本管理和依赖声明：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 版本控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lombok.version</span>&gt;</span>1.18.42<span class="hljs-tag">&lt;/<span class="hljs-name">lombok.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 依赖声明 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${lombok.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2. 在 ruoyi-common-core 模块中引入 Lombok</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- lombok --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">3. 定义字典枚举通用接口</h4>
<p>创建 <code>BaseDictEnum</code> 接口，作为所有字典枚举的统一规范：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ruoyi.common.core.enums;

<span class="hljs-comment">/**
 * 字典枚举通用接口
 *
 * <span class="hljs-doctag">@author</span> gideon
 * <span class="hljs-doctag">@since</span> 2026/1/22
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseDictEnum</span> {

    <span class="hljs-comment">/**
     * 获取枚举编码
     *
     * <span class="hljs-doctag">@return</span> 编码
     */</span>
    String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 获取枚举描述
     *
     * <span class="hljs-doctag">@return</span> 描述
     */</span>
    String <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span>;
}
</code></pre>
<h4 data-id="heading-7">4. 实现具体的字典枚举</h4>
<p>所有字典枚举类都需要实现 <code>BaseDictEnum</code> 接口，并统一使用 <code>code</code> 和 <code>info</code> 属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ruoyi.common.core.enums.dict;

<span class="hljs-keyword">import</span> com.ruoyi.common.core.enums.BaseDictEnum;
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 系统通知类型枚举
 *
 * <span class="hljs-doctag">@author</span> gideon
 * <span class="hljs-doctag">@since</span> 2026/1/22
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SysNoticeType</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseDictEnum</span> {

    <span class="hljs-comment">/**
     * 通知类型
     */</span>
    NOTICE(<span class="hljs-string">"1"</span>, <span class="hljs-string">"通知"</span>),

    <span class="hljs-comment">/**
     * 公告类型
     */</span>
    ANNOUNCEMENT(<span class="hljs-string">"2"</span>, <span class="hljs-string">"公告"</span>),

    ;

    <span class="hljs-comment">/**
     * 枚举编码
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String code;

    <span class="hljs-comment">/**
     * 枚举描述
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String info;
}
</code></pre>
<h4 data-id="heading-8">5. 实现枚举工具类</h4>
<p>创建 <code>EnumsUtils</code> 工具类，提供字典枚举的通用操作方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ruoyi.common.core.enums.util;

<span class="hljs-keyword">import</span> com.ruoyi.common.core.enums.BaseDictEnum;
<span class="hljs-keyword">import</span> com.ruoyi.common.core.utils.StringUtils;
<span class="hljs-keyword">import</span> lombok.experimental.UtilityClass;

<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-comment">/**
 * 枚举通用工具类
 * 适配 BaseDictEnum 接口的枚举体系，提供 code/desc 互转、批量转换等能力
 * 支持导出场景的枚举转换，兼容空值、无效编码等边界情况
 *
 * <span class="hljs-doctag">@author</span> gideon
 * <span class="hljs-doctag">@since</span> 2026/1/21
 */</span>
<span class="hljs-meta">@UtilityClass</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumsUtils</span> {

    <span class="hljs-comment">// ==================== 基础方法：根据 Code 获取枚举项 ====================</span>

    <span class="hljs-comment">/**
     * 根据 code 获取枚举项（通用版，返回 Optional 避免 NPE）
     * 适配 BaseDictEnum 接口方法：getCode()
     *
     * <span class="hljs-doctag">@param</span> enumClass 枚举类（必须是 Enum 子类 + 实现 BaseDictEnum）
     * <span class="hljs-doctag">@param</span> code      枚举编码
     * <span class="hljs-doctag">@param</span> &lt;E&gt;       枚举类型
     * <span class="hljs-doctag">@return</span> 枚举项（Optional 包装）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; Optional&lt;E&gt; <span class="hljs-title function_">getEnumByCode</span><span class="hljs-params">(Class&lt;?&gt; enumClass, String code)</span> {
        <span class="hljs-comment">// 校验：必须是 Enum 子类 + BaseDictEnum 实现类</span>
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }
        <span class="hljs-keyword">if</span> (code == <span class="hljs-literal">null</span> || StringUtils.isBlank(code)) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }

        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .filter(enumItem -&gt; code.equals(enumItem.getCode()))
                .findFirst();
    }

    <span class="hljs-comment">/**
     * 重载：支持 Integer 类型的 code（适配数字编码的枚举）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; Optional&lt;E&gt; <span class="hljs-title function_">getEnumByCode</span><span class="hljs-params">(Class&lt;?&gt; enumClass, Integer code)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }
        <span class="hljs-keyword">if</span> (code == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }

        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .filter(enumItem -&gt; code.toString().equals(enumItem.getCode()))
                .findFirst();
    }

    <span class="hljs-comment">// ==================== 导出专用：Code 转 Desc ====================</span>

    <span class="hljs-comment">/**
     * 【导出核心】根据 code 转换为 desc（无匹配返回默认值）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; String <span class="hljs-title function_">codeToDesc</span><span class="hljs-params">(Class&lt;?&gt; enumClass, String code, String defaultValue)</span> {
        <span class="hljs-keyword">return</span> getEnumByCode(enumClass, code)
                .map(BaseDictEnum::getInfo)
                .orElse(defaultValue);
    }

    <span class="hljs-comment">/**
     * 重载：支持 Integer 类型的 code 转 desc
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; String <span class="hljs-title function_">codeToDesc</span><span class="hljs-params">(Class&lt;?&gt; enumClass, Integer code, String defaultValue)</span> {
        <span class="hljs-keyword">return</span> getEnumByCode(enumClass, code)
                .map(BaseDictEnum::getInfo)
                .orElse(defaultValue);
    }

    <span class="hljs-comment">/**
     * 【批量导出】批量转换 code 为 desc
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; List&lt;String&gt; <span class="hljs-title function_">batchCodeToDesc</span><span class="hljs-params">(Class&lt;?&gt; enumClass, List&lt;String&gt; codes, String defaultValue)</span> {
        <span class="hljs-keyword">if</span> (codes == <span class="hljs-literal">null</span> || codes.isEmpty()) {
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Collections.nCopies(codes.size(), defaultValue);
        }

        <span class="hljs-keyword">return</span> codes.stream()
                .map(code -&gt; codeToDesc(enumClass, code, defaultValue))
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">// ==================== 反向转换：Desc 转 Code ====================</span>

    <span class="hljs-comment">/**
     * 根据 desc 获取枚举项（反向转换）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; Optional&lt;E&gt; <span class="hljs-title function_">getEnumByDesc</span><span class="hljs-params">(Class&lt;?&gt; enumClass, String desc)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }
        <span class="hljs-keyword">if</span> (desc == <span class="hljs-literal">null</span> || StringUtils.isBlank(desc)) {
            <span class="hljs-keyword">return</span> Optional.empty();
        }

        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .filter(enumItem -&gt; desc.equals(enumItem.getInfo()))
                .findFirst();
    }

    <span class="hljs-comment">/**
     * 【反向转换】desc 转 code
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; String <span class="hljs-title function_">descToCode</span><span class="hljs-params">(Class&lt;?&gt; enumClass, String desc, String defaultValue)</span> {
        <span class="hljs-keyword">return</span> getEnumByDesc(enumClass, desc)
                .map(BaseDictEnum::getCode)
                .orElse(defaultValue);
    }

    <span class="hljs-comment">// ==================== 辅助方法：枚举转列表 ====================</span>

    <span class="hljs-comment">/**
     * 将枚举转换为 Map（code -&gt; desc）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; Map&lt;String, String&gt; <span class="hljs-title function_">enumToMap</span><span class="hljs-params">(Class&lt;?&gt; enumClass)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Collections.emptyMap();
        }

        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .collect(Collectors.toMap(
                        BaseDictEnum::getCode,
                        BaseDictEnum::getInfo,
                        (k1, k2) -&gt; k1 <span class="hljs-comment">// 解决重复 code 冲突</span>
                ));
    }

    <span class="hljs-comment">/**
     * 将枚举转换为列表（包含 code 和 desc）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; List&lt;Map&lt;String, String&gt;&gt; <span class="hljs-title function_">enumToList</span><span class="hljs-params">(Class&lt;?&gt; enumClass)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }

        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .map(enumItem -&gt; {
                    Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);
                    map.put(<span class="hljs-string">"code"</span>, enumItem.getCode());
                    map.put(<span class="hljs-string">"desc"</span>, enumItem.getInfo());
                    <span class="hljs-keyword">return</span> map;
                })
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 获取枚举的所有 code
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; List&lt;String&gt; <span class="hljs-title function_">getAllCode</span><span class="hljs-params">(Class&lt;?&gt; enumClass)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }
        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .map(BaseDictEnum::getCode)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 获取枚举的所有 desc
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt; &amp; BaseDictEnum&gt; List&lt;String&gt; <span class="hljs-title function_">getAllDesc</span><span class="hljs-params">(Class&lt;?&gt; enumClass)</span> {
        <span class="hljs-keyword">if</span> (isValidEnumClass(enumClass)) {
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }
        <span class="hljs-keyword">return</span> Arrays.stream(((Class&lt;E&gt;) enumClass).getEnumConstants())
                .map(BaseDictEnum::getInfo)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">// ==================== 私有辅助方法 ====================</span>

    <span class="hljs-comment">/**
     * 校验类是否为 枚举类 + 实现 BaseDictEnum 接口
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidEnumClass</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span> || !clazz.isEnum()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// 校验是否实现 BaseDictEnum 接口</span>
        <span class="hljs-keyword">return</span> !BaseDictEnum.class.isAssignableFrom(clazz);
    }
}
</code></pre>
<h4 data-id="heading-9">6. 扩展 @Excel 注解</h4>
<p>在 <code>@Excel</code> 注解中新增 <code>dictType</code> 属性，用于指定字典枚举类型：</p>
<h5 data-id="heading-10">6.1 新增属性定义</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 导出字典类型（通过枚举类进行转换）
 */</span>
Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDictEnum</span>&gt; dictType() <span class="hljs-keyword">default</span> BaseDictEnum.class;
</code></pre>
<h5 data-id="heading-11">6.2 完整的 @Excel 注解</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义导出 Excel 数据注解
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target(ElementType.FIELD)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Excel {
    <span class="hljs-comment">/**
     * 导出时在 Excel 中的列排序
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">sort</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Integer.MAX_VALUE;

    <span class="hljs-comment">/**
     * 导出到 Excel 中的列名
     */</span>
    String <span class="hljs-title function_">name</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 导出字典类型（通过枚举类进行转换）
     */</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDictEnum</span>&gt; dictType() <span class="hljs-keyword">default</span> BaseDictEnum.class;

    <span class="hljs-comment">/**
     * 日期格式，如：yyyy-MM-dd
     */</span>
    String <span class="hljs-title function_">dateFormat</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 读取内容转表达式（如：0=男,1=女,2=未知）
     */</span>
    String <span class="hljs-title function_">readConverterExp</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 分隔符，用于读取字符串数组内容
     */</span>
    String <span class="hljs-title function_">separator</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">","</span>;

    <span class="hljs-comment">/**
     * BigDecimal 精度，默认：-1（默认不开启 BigDecimal 格式化）
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">scale</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1</span>;

    <span class="hljs-comment">/**
     * BigDecimal 舍入规则，默认：BigDecimal.ROUND_HALF_EVEN
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">roundingMode</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> BigDecimal.ROUND_HALF_EVEN;

    <span class="hljs-comment">/**
     * 导出时在 Excel 中每个列的高度
     */</span>
    <span class="hljs-type">double</span> <span class="hljs-title function_">height</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">14</span>;

    <span class="hljs-comment">/**
     * 导出时在 Excel 中每个列的宽度
     */</span>
    <span class="hljs-type">double</span> <span class="hljs-title function_">width</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">16</span>;

    <span class="hljs-comment">/**
     * 文字后缀，如 %，将 90 转换为 90%
     */</span>
    String <span class="hljs-title function_">suffix</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 当值为空时，字段的默认值
     */</span>
    String <span class="hljs-title function_">defaultValue</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 提示信息
     */</span>
    String <span class="hljs-title function_">prompt</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 是否允许内容换行
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">wrapText</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * 设置只能选择不能输入的列内容
     */</span>
    String[] combo() <span class="hljs-keyword">default</span> {};

    <span class="hljs-comment">/**
     * 是否需要纵向合并单元格（应对需求：含有 List 集合的单元格）
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">needMerge</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * 是否导出数据（应对需求：有时我们需要导出一份模板，此时标题需要但内容需要用户手工填写）
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExport</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">/**
     * 另一个类中的属性名称，支持多级获取，以小数点隔开
     */</span>
    String <span class="hljs-title function_">targetAttr</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 是否自动统计数据，在最后追加一行统计数据总和
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStatistics</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * 导出类型（0 数字，1 字符串）
     */</span>
    ColumnType <span class="hljs-title function_">cellType</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ColumnType.STRING;

    <span class="hljs-comment">/**
     * 导出列头背景颜色
     */</span>
    IndexedColors <span class="hljs-title function_">headerBackgroundColor</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> IndexedColors.GREY_50_PERCENT;

    <span class="hljs-comment">/**
     * 导出列头字体颜色
     */</span>
    IndexedColors <span class="hljs-title function_">headerColor</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> IndexedColors.WHITE;

    <span class="hljs-comment">/**
     * 导出单元格背景颜色
     */</span>
    IndexedColors <span class="hljs-title function_">backgroundColor</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> IndexedColors.WHITE;

    <span class="hljs-comment">/**
     * 导出单元格字体颜色
     */</span>
    IndexedColors <span class="hljs-title function_">color</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> IndexedColors.BLACK;

    <span class="hljs-comment">/**
     * 导出字段对齐方式
     */</span>
    HorizontalAlignment <span class="hljs-title function_">align</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> HorizontalAlignment.CENTER;

    <span class="hljs-comment">/**
     * 自定义数据处理器
     */</span>
    Class&lt;?&gt; handler() <span class="hljs-keyword">default</span> ExcelHandlerAdapter.class;

    <span class="hljs-comment">/**
     * 自定义数据处理器参数
     */</span>
    String[] args() <span class="hljs-keyword">default</span> {};

    <span class="hljs-comment">/**
     * 字段类型（0：导出导入；1：仅导出；2：仅导入）
     */</span>
    Type <span class="hljs-title function_">type</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Type.ALL;

    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Type</span> {
        ALL(<span class="hljs-number">0</span>), EXPORT(<span class="hljs-number">1</span>), IMPORT(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;

        Type(<span class="hljs-type">int</span> value) {
            <span class="hljs-built_in">this</span>.value = value;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">value</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value;
        }
    }

    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ColumnType</span> {
        NUMERIC(<span class="hljs-number">0</span>), STRING(<span class="hljs-number">1</span>), IMAGE(<span class="hljs-number">2</span>), TEXT(<span class="hljs-number">3</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;

        ColumnType(<span class="hljs-type">int</span> value) {
            <span class="hljs-built_in">this</span>.value = value;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">value</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value;
        }
    }
}
</code></pre>
<h4 data-id="heading-12">7. 改造 ExcelUtil 工具类</h4>
<p>在 <code>ExcelUtil</code> 中集成字典枚举转换逻辑：</p>
<h5 data-id="heading-13">7.1 导入方法改造</h5>
<p>在导入数据时，添加字典枚举转换逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != attr.dictType()) {
    val = EnumsUtils.getEnumByDesc(attr.dictType(), Convert.toStr(val));
}
</code></pre>
<p>方法名和代码所处位置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b75eac9598e49fe94a38fff76e68feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6J2M6Jqq57q56Z2S6JuZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675946&amp;x-signature=tLnYHQRVRGoFIlXXiSBL0SkRTE8%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-14">7.2 导出方法改造</h5>
<p>在导出数据时，添加字典枚举转换逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != attr.dictType()) {
    cell.setCellValue(EnumsUtils.codeToDesc(attr.dictType(), Convert.toStr(value), Convert.toStr(value)));
}
</code></pre>
<p>方法名和代码所处位置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04a240d7b7e34c13be0be7e12eaf9f22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6J2M6Jqq57q56Z2S6JuZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675946&amp;x-signature=%2Fzof0tHtMAknwDpop4pcMfT33JI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">8. 在实体类中使用字典枚举</h4>
<p>在需要导出的实体类中，通过 <code>@Excel</code> 注解的 <code>dictType</code> 属性指定字典枚举类型：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 通知公告表 sys_notice
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysNotice</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-comment">/**
     * 公告编号
     */</span>
    <span class="hljs-meta">@Excel(name = "公告编号")</span>
    <span class="hljs-keyword">private</span> Long noticeId;

    <span class="hljs-comment">/**
     * 公告标题
     */</span>
    <span class="hljs-meta">@Excel(name = "公告标题")</span>
    <span class="hljs-meta">@Xss(message = "公告标题不能包含脚本字符")</span>
    <span class="hljs-meta">@NotBlank(message = "公告标题不能为空")</span>
    <span class="hljs-meta">@Size(max = 50, message = "公告标题不能超过 50 个字符")</span>
    <span class="hljs-keyword">private</span> String noticeTitle;

    <span class="hljs-comment">/**
     * 公告类型（1-通知 2-公告）
     */</span>
    <span class="hljs-meta">@Excel(name = "公告类型", dictType = SysNoticeType.class)</span>
    <span class="hljs-keyword">private</span> String noticeType;

    <span class="hljs-comment">/**
     * 公告内容
     */</span>
    <span class="hljs-keyword">private</span> String noticeContent;

    <span class="hljs-comment">/**
     * 公告状态（0 正常 1 关闭）
     */</span>
    <span class="hljs-meta">@Excel(name = "公告状态", dictType = SysNoticeStatus.class)</span>
    <span class="hljs-keyword">private</span> String status;
}
</code></pre>
<h4 data-id="heading-16">9. 改造的项目文件夹以及文件</h4>
<p>主要新增 <code>EnumsUtils</code>，<code>BaseDictEnum</code> 及其一些字典枚举</p>
<p>主要修改 <code>@Excel</code>，<code>ExcelUtil</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4e9b5711094a3d968098e680c5e457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6J2M6Jqq57q56Z2S6JuZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675946&amp;x-signature=2RCr4HhkSqvPheEBzYtHKKDyHxk%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-17">三、方案优势总结</h3>
<h4 data-id="heading-18">1. 性能优势</h4>
<ul>
<li><strong>内存级访问</strong>：枚举类型在 JVM 启动时即被加载到内存，访问速度极快</li>
<li><strong>无网络开销</strong>：避免了 Redis 网络通信的延迟和开销</li>
<li><strong>低 CPU 消耗</strong>：直接的内存访问减少了 CPU 上下文切换</li>
</ul>
<h4 data-id="heading-19">2. 维护优势</h4>
<ul>
<li><strong>类型安全</strong>：通过枚举类进行编译时类型检查，避免运行时错误</li>
<li><strong>代码可读性</strong>：枚举类集中管理字典定义，便于维护和查找</li>
<li><strong>版本控制友好</strong>：字典定义与代码一起版本化，便于追踪变更</li>
</ul>
<h4 data-id="heading-20">3. 扩展性优势</h4>
<ul>
<li><strong>易于扩展</strong>：新增字典类型只需添加新的枚举类</li>
<li><strong>支持复杂逻辑</strong>：枚举类可以添加自定义方法，支持更复杂的业务逻辑</li>
<li><strong>与框架集成</strong>：与 Spring、MyBatis 等框架无缝集成</li>
</ul>
<hr/>
<h3 data-id="heading-21">四、注意事项</h3>
<ol>
<li><strong>枚举数量控制</strong>：单个枚举类的枚举项不宜过多（建议不超过 100 项），过多的枚举项会增加 JVM 启动时间</li>
<li><strong>枚举不可变性</strong>：枚举类在 JVM 启动后不可动态修改，不适合需要动态变更的字典场景</li>
<li><strong>序列化兼容性</strong>：修改枚举类的顺序或值可能会影响序列化和反序列化的兼容性</li>
<li><strong>默认值处理</strong>：在 <code>codeToDesc</code> 方法中，建议提供合理的默认值，避免导出时出现空值</li>
</ol>
<hr/>
<h3 data-id="heading-22">结语</h3>
<p>本方案通过枚举类型实现字典转换，在性能、可维护性和扩展性方面都具有显著优势。适用于字典数据相对稳定、对性能要求较高的场景。</p>
<p>由于时间关系，本文档中的代码尚未经过完整测试，如有疏漏或错误之处，欢迎各位指正。</p>
<p>感谢阅读！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别复制粘贴，你需要这8个 MCP 服务器]]></title>    <link>https://juejin.cn/post/7597989474991423526</link>    <guid>https://juejin.cn/post/7597989474991423526</guid>    <pubDate>2026-01-22T08:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991423526" data-draft-id="7597701762905423918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别复制粘贴，你需要这8个 MCP 服务器"/> <meta itemprop="keywords" content="MCP,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-22T08:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别复制粘贴，你需要这8个 MCP 服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:14:15.000Z" title="Thu Jan 22 2026 08:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在使用 AI 辅助编程的早期，由于 AI 无法直接感知我们的开发环境，我们不得不充当搬运工，把报错信息复制出来，把数据库结构截个图，把 API 文档一段段喂给它。这种断裂的交互方式，效率很低。</p>
<p>MCP（Model Context Protocol）协议的出现解决了这个问题。它为 AI 提供了一个标准化的接口，让 AI 能够直接读取代码库、数据库、浏览器甚至知识库。AI 不再是一个在那自言自语的聊天机器人，而变成了真正能上手干活的工程师。</p>
<p>今天盘点几款目前非常实用的 MCP Server，看看它们如何具体解决开发中的痛点。</p>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fbrowsermcp.io%2F" target="_blank" title="https://browsermcp.io/" ref="nofollow noopener noreferrer">Browser MCP</a>：给 IDE 装上联网的眼睛</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9067bc015b63488a8e534fd0f350119b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=DdPNkgR8tVuCiUyFQHtwsEFxTTU%3D" alt="" loading="lazy"/></p>
<p>开发过程中遇到生僻报错，或者需要查阅最新的第三方库文档，一般会切出 IDE，打开浏览器，搜索，筛选答案，再切回 IDE。这个过程不仅繁琐，注意力还容易被分散。</p>
<p>Browser MCP 就能让 AI 拥有了直接访问互联网的能力。如果遇到类似 <code>TypeError</code> 或者配置问题时，不需要离开代码编辑器，直接下指令让 AI 去查。</p>
<p>它会自动检索 Stack Overflow 的高票回答，或者抓取 GitHub 上的 Issue 讨论，甚至直接阅读最新的官方文档，然后把过滤后的有效信息反馈给开发者。</p>
<p><strong>配置参考：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"browser"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-browser"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.notion.com%2Fdocs%2Fmcp" target="_blank" title="https://developers.notion.com/docs/mcp" ref="nofollow noopener noreferrer">Notion MCP</a>：打通项目知识库</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2063677c924c46be965db6b850d16f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=hXJU5y7n%2FaSUKuoPdhWL6rH%2Bsbc%3D" alt="" loading="lazy"/></p>
<p>在复杂的项目中，需求文档、API 定义、设计规范通常散落在 Notion 里。以前写代码需要反复确认文档细节，现在可以通过 Notion MCP 把这些知识库直接挂载给 AI。</p>
<p>用户就可以直接问：“根据产品文档里的用户积分规则，帮我生成这段计算逻辑。”AI 会直接读取 Notion 中的页面内容作为上下文。这让代码实现与需求文档保持了高度一致，省去了反复核对的时间。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fvanna.ai%2F" target="_blank" title="https://vanna.ai/" ref="nofollow noopener noreferrer">Vanna.ai Agent Server</a>：用自然语言操作数据库</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ebf5f32b54d4a34a6f36014811ef339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=3vl2Ssq3shE5GUxyLcaxQB%2Fxivo%3D" alt="" loading="lazy"/></p>
<p>对于不擅长复杂 SQL 或者刚接手陌生数据库结构的开发者，Vanna.ai 就是个神器。它的特长是 Text-to-SQL。</p>
<p>接入后，AI 能够理解数据库的 Schema（表结构）。开发者不需要手写复杂的 Join 查询，只需要说“帮我统计上个季度复购率最高的前十个用户”，它就能直接生成准确且可执行的 SQL 语句。这在做数据分析或快速验证数据时非常高效。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPV-Bhat%2Fvibe-check-mcp-server" target="_blank" title="https://github.com/PV-Bhat/vibe-check-mcp-server" ref="nofollow noopener noreferrer">Vibe Check MCP</a>：代码质量的守门员</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8101a0041dd497c947947919339a08d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=Gx%2BS95wR4bhLIQAeBBKhk8eBT3o%3D" alt="" loading="lazy"/></p>
<p>很多代码可以跑通，但跑通并不代表着一点问题都没有，还会有很多隐患，比如变量命名随意、缺乏边界情况的错误处理、逻辑嵌套过深。</p>
<p>Vibe Check MCP 不仅仅是一个语法检查器，它更像是一个经验丰富的 Code Reviewer。写完一段业务逻辑后，可以让它扫描一遍。它会敏锐地指出那些“虽然不报错但很业余”的地方，把潜在的技术债务扼杀在摇篮里。</p>
<p><strong>配置参考：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vibe-check"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-vibe-check"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fbrightdata.com%2Fai%2Fmcp-server" target="_blank" title="https://brightdata.com/ai/mcp-server" ref="nofollow noopener noreferrer">Bright Data MCP</a>：工业级数据获取</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1982c3f1e6496c83ca79272c59e7fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=0jh4yuxYx%2BZSHUvRLcChgaI%2Fhyg%3D" alt="" loading="lazy"/></p>
<p>当开发涉及外部数据采集、竞品分析或需要处理大量网页数据时，普通的爬虫脚本很容易被反爬策略阻断。</p>
<p>Bright Data MCP 提供了一个更稳定的接口。它利用 Bright Data 的代理网络和抓取架构，让 AI 能够稳定地获取外部网页数据。对于需要构建数据集或实时监控外部信息的应用，这是一个非常结实的底层支撑。</p>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.honeycomb.io%2F" target="_blank" title="https://www.honeycomb.io/" ref="nofollow noopener noreferrer">Honeycomb MCP</a>：生产环境的可观测性</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3a2093114341669a26e5702030470d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=SUht4nTOftYX%2F%2F424b0ttJ9kQ9U%3D" alt="" loading="lazy"/></p>
<p>代码上线后出了 Bug，最头疼的是定位问题。Honeycomb MCP 把 AI 的能力引入到了运维监控领域。</p>
<p>通过连接 Honeycomb 的 Tracing 数据，当系统报警时，可以让 AI 直接分析链路追踪日志。它能协助判断是哪个微服务超时，还是哪个数据库查询导致了瓶颈，直接给出基于真实数据的分析建议，而不是盲目猜测。</p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2F" target="_blank" title="https://docs.langchain.com/" ref="nofollow noopener noreferrer">LangChain Server</a>：构建 AI 工作流</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b2fc4a6df8b467794658a2d6f21833e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=bnz1nKeBdQmvdmsEhzwvXRyFVS8%3D" alt="" loading="lazy"/></p>
<p>如果你的目标不仅仅是辅助编码，而是要开发 AI 应用，LangChain Server 必不可少。它提供了丰富的组件来编排 LLM 的逻辑，处理 Prompt 模板、记忆管理和工具调用。通过 MCP 接入，可以在 IDE 里更直观地调试和构建复杂的 AI 业务流程。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.github.io%2Fopenai-agents-python%2Fmcp%2F" target="_blank" title="https://openai.github.io/openai-agents-python/mcp/" ref="nofollow noopener noreferrer">OpenAgents MCP</a>：数据分析与自主任务</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e453d559fe64dfc8c97e7c945355025~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=B0K2GIdvof8aiBIvQcUIOeuvxiM%3D" alt="" loading="lazy"/></p>
<p>OpenAgents 更侧重于数据分析和工具的自主使用。如果你手头有一个 CSV 文件需要分析，或者需要进行一系列的数据清洗和图表绘制任务，OpenAgents 可以规划任务路径，自主调用工具来完成从数据处理到结果可视化的全过程。</p>
<hr/>
<h3 data-id="heading-8">搞定 MCP 的运行基石：Node.js 环境管理</h3>
<p>仔细观察上述的 MCP 配置，就会发现它们几乎都依赖 <code>npx</code> 命令，这意味着背后都需要 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fnodejs" target="_blank" title="https://www.servbay.com/features/nodejs" ref="nofollow noopener noreferrer">Node.js 环境</a>的支持。而且不同的 MCP 工具可能依赖不同版本的 Node.js。</p>
<p>在本地机器上反复切换 Node 版本，或者处理全局依赖冲突，是非常消磨热情的。</p>
<p>ServBay 提供了一个解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91823ee09fb74af39e679717e5444321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674455&amp;x-signature=facAjW9guc8uANfG0rmWt1tHBUM%3D" alt="" loading="lazy"/></p>
<p>作为一款专为开发者设计的环境管理工具，ServBay 在 Node.js 的支持上做得非常细致：</p>
<ul>
<li><strong>版本覆盖全</strong>：它支持从 <strong>Node.js 12 到 Node.js 24</strong> 的全系列版本。无论想跑最新的 MCP 工具，还是维护老旧的项目，都能找到对应的运行环境。</li>
<li><strong>多版本共存</strong>：这个功能挺实用的。开发者可以在 ServBay 里同时安装 Node 18 和 Node 22。运行不同的项目时，可以指定使用不同的 Node 版本，互不打架。</li>
<li><strong>系统纯净</strong>：ServBay 采用沙盒化机制，所有的 Node 环境都独立于系统之外。不需要担心因为安装一个 MCP 工具而把系统的 PATH 变量搞乱，也不需要在那折腾 nvm 的配置。</li>
</ul>
<p>对于非技术人员，ServBay 也是很友好的，不需要会写代码，点击一下就能安装好各种MCP 服务器。</p>
<h3 data-id="heading-9">结语</h3>
<p>MCP 协议正在重塑我们与开发工具的交互方式。从 Browser MCP 的联网能力，到 Vibe Check 的代码审查，都是与一个真正懂行的 AI 结对编程。配置好这些工具，把繁琐的上下文搬运工作交给协议，留出更多的时间去思考架构与逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Opencode 连接OpenAI失败（Unable to connect）修复记录（Windows）]]></title>    <link>https://juejin.cn/post/7597973595130478644</link>    <guid>https://juejin.cn/post/7597973595130478644</guid>    <pubDate>2026-01-22T08:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597973595130478644" data-draft-id="7597779410406965282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Opencode 连接OpenAI失败（Unable to connect）修复记录（Windows）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T08:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlo"/> <meta itemprop="url" content="https://juejin.cn/user/1239904845853870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Opencode 连接OpenAI失败（Unable to connect）修复记录（Windows）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904845853870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:25:44.000Z" title="Thu Jan 22 2026 08:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">opencode 连接失败（Unable to connect）修复记录（Windows）</h2>
<h3 data-id="heading-1">背景</h3>
<p>在 Windows 上使用 <code>opencode</code> 时出现错误：</p>
<ul>
<li><code>Unable to connect. Is the computer able to access the url?</code></li>
</ul>
<p>该错误在首次登录/首次运行后可能表现为“第一次正常，后面不行”。</p>
<h3 data-id="heading-2">关键结论（定位到的真实请求）</h3>
<p>从 opencode 日志定位到失败请求并非 <code>api.openai.com</code>，而是：</p>
<ul>
<li><code>https://chatgpt.com/backend-api/codex/responses</code></li>
</ul>
<p>日志中同时出现以下错误之一：</p>
<ul>
<li><code>ConnectionRefused</code></li>
<li><code>UNKNOWN_CERTIFICATE_VERIFICATION_ERROR</code></li>
</ul>
<h3 data-id="heading-3">根因分析（环境差异）</h3>
<p>本机网络环境表现为：</p>
<ul>
<li>Windows 系统代理（WinINET / Internet Settings）开启：<code>127.0.0.1:7890</code></li>
<li>WinHTTP 代理未设置：<code>direct</code></li>
<li><code>opencode</code> 运行进程环境中未显式设置 <code>HTTP_PROXY/HTTPS_PROXY</code></li>
</ul>
<p>另外存在证书相关问题：</p>
<ul>
<li>环境变量 <code>NODE_EXTRA_CA_CERTS=C:\Users\xxx\.opencode-ca.pem</code></li>
<li>该路径对应文件不存在/不可加载，导致证书校验异常相关报错</li>
</ul>
<p>因此 <code>opencode</code> 进程可能没有正确走代理，或在 TLS 校验阶段失败。</p>
<h3 data-id="heading-4">已执行的永久修改（User 环境变量）</h3>
<p>已将以下环境变量写入 <strong>用户级（User）</strong> 环境变量，使其在新开的终端/进程中永久生效：</p>
<ul>
<li><code>HTTP_PROXY = http://127.0.0.1:7890</code></li>
<li><code>HTTPS_PROXY = http://127.0.0.1:7890</code></li>
<li><code>ALL_PROXY = http://127.0.0.1:7890</code></li>
<li><code>NO_PROXY = localhost,127.0.0.1</code></li>
</ul>
<p>并已永久清除（删除）以下用户级环境变量：</p>
<ul>
<li><code>NODE_EXTRA_CA_CERTS</code></li>
</ul>
<blockquote>
<p>注：环境变量变更需要 <strong>重开终端/重启相关进程</strong> 才会对新进程生效。</p>
</blockquote>
<h3 data-id="heading-5">验证步骤</h3>
<ol>
<li>关闭当前终端（PowerShell / Windows Terminal）。</li>
<li>新开一个终端。</li>
<li>执行（建议带日志）：</li>
</ol>
<pre><code class="hljs language-powershell" lang="powershell">opencode --print-logs --log-level DEBUG run "ping"
</code></pre>
<p>如果仍失败，检查 <code>~\.local\share\opencode\log\*.log</code> 中是否仍出现：</p>
<ul>
<li><code>codex/responses</code></li>
<li><code>ConnectionRefused</code></li>
<li><code>certificate</code></li>
</ul>
<h3 data-id="heading-6">回滚步骤（恢复到修改前）</h3>
<p>如需撤销代理环境变量，执行以下命令（删除用户级环境变量）：</p>
<pre><code class="hljs language-powershell" lang="powershell">[Environment]::SetEnvironmentVariable('HTTP_PROXY', $null, 'User')
[Environment]::SetEnvironmentVariable('HTTPS_PROXY', $null, 'User')
[Environment]::SetEnvironmentVariable('ALL_PROXY', $null, 'User')
[Environment]::SetEnvironmentVariable('NO_PROXY', $null, 'User')
</code></pre>
<p>如需恢复 <code>NODE_EXTRA_CA_CERTS</code>（仅在你确实有自定义 CA PEM 且需要时）：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 把路径替换为真实存在的 PEM 文件路径
[Environment]::SetEnvironmentVariable('NODE_EXTRA_CA_CERTS', 'C:\\path\\to\\your-ca.pem', 'User')
</code></pre>
<p>同样需要重开终端后才会影响新进程。</p>
<h3 data-id="heading-7">相关路径（便于排查）</h3>
<p><code>opencode debug paths</code> 输出的关键目录：</p>
<ul>
<li>日志：<code>%USERPROFILE%\.local\share\opencode\log</code></li>
<li>凭据：<code>%USERPROFILE%\.local\share\opencode\auth.json</code></li>
<li>配置：<code>%USERPROFILE%\.config\opencode</code></li>
</ul>
<h3 data-id="heading-8">注意事项</h3>
<ul>
<li>请勿在工单/群聊中直接粘贴 <code>auth.json</code> 内容（包含敏感 token）。</li>
<li>如果你处于公司“HTTPS 解密/中间人代理”环境，必须使用正确的根证书 PEM；清除 <code>NODE_EXTRA_CA_CERTS</code> 可能会导致其它工具在该网络下失败，需要按实际情况选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCV| 小程序记录-利用threshold处理显微图像]]></title>    <link>https://juejin.cn/post/7597905961663823878</link>    <guid>https://juejin.cn/post/7597905961663823878</guid>    <pubDate>2026-01-22T08:38:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597905961663823878" data-draft-id="7598005428258111551" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCV| 小程序记录-利用threshold处理显微图像"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-22T08:38:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="峻海海"/> <meta itemprop="url" content="https://juejin.cn/user/256628378572250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCV| 小程序记录-利用threshold处理显微图像
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/256628378572250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    峻海海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:38:59.000Z" title="Thu Jan 22 2026 08:38:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>学习计算机视觉的主要目的就是为了使用视觉方法处理我在微观实验中遇见的识别问题，在学习threshold的过程中我想到了我是否可以直接利用threshold过滤掉显微镜下的背景和我想要观察的沉淀。</p>
<h2 data-id="heading-1">代码</h2>
<p>我直接把我的想法告诉了ai</p>
<pre><code class="hljs">比如这两张微流控的照片，你帮我直接用这个原理写一个小程序，我的要求如下，1.判断碳酸钙沉淀（图中黑色区域的颜色）还有其他区域，两者之间的颜色肯定有明显的区别，然后通过这个颜色区别帮我生成一张，最后其他区域都变成黑色，碳酸钙沉淀变成黑色的二值图，你能做到吗
</code></pre>
<p>然后ai给我生成了可以直接使用的代码</p>
<pre><code class="hljs language-ini" lang="ini">import os
import glob
import cv2 as cv
import numpy as np
​
<span class="hljs-comment"># ========= 用户参数 =========</span>
<span class="hljs-attr">input_dir</span> = <span class="hljs-string">"input_images"</span>      <span class="hljs-comment"># 放微流控原图的文件夹</span>
<span class="hljs-attr">output_dir</span> = <span class="hljs-string">"output_binary"</span>    <span class="hljs-comment"># 输出二值图的文件夹</span>
​
os.makedirs(output_dir, <span class="hljs-attr">exist_ok</span>=<span class="hljs-literal">True</span>)
​
<span class="hljs-comment"># 支持的图片后缀，可以按需加上 .png/.jpg</span>
<span class="hljs-attr">img_patterns</span> = [<span class="hljs-string">"*.tif"</span>, <span class="hljs-string">"*.png"</span>, <span class="hljs-string">"*.jpg"</span>, <span class="hljs-string">"*.jpeg"</span>]
​
<span class="hljs-comment"># ========= 主循环：批量处理所有图像 =========</span>
for pattern in img_patterns:
    for img_path in glob.glob(os.path.join(input_dir, pattern)):
        <span class="hljs-attr">img</span> = cv.imread(img_path)
​
        if img is None:
            print(f"<span class="hljs-section">[WARN]</span> 读图失败: {img_path}")
            continue
​
        <span class="hljs-comment"># 1. BGR -&gt; GRAY （颜色空间转换）</span>
        <span class="hljs-attr">gray</span> = cv.cvtColor(img, cv.COLOR_BGR2GRAY)
​
        <span class="hljs-comment"># 2. 轻微平滑，去掉小噪声（可选，但推荐）</span>
        <span class="hljs-comment">#   这里用 5x5 的高斯滤波</span>
        <span class="hljs-attr">blur</span> = cv.GaussianBlur(gray, (<span class="hljs-number">5</span>, <span class="hljs-number">5</span>), <span class="hljs-number">0</span>)
​
        <span class="hljs-comment"># 3. Otsu 自动阈值 + 反转</span>
        <span class="hljs-comment">#   THRESH_BINARY_INV 是因为：CaCO3 在原图里是黑的（像素值小）</span>
        <span class="hljs-comment">#   反转之后：CaCO3 -&gt; 白色(255)，背景 -&gt; 黑色(0)</span>
        _, <span class="hljs-attr">binary</span> = cv.threshold(
            blur, 0, 255,
            cv.THRESH_BINARY_INV + cv.THRESH_OTSU
        )
​
        <span class="hljs-comment"># 4. 做一点形态学开运算，去掉小孤立噪点（可选）</span>
        <span class="hljs-attr">kernel</span> = np.<span class="hljs-literal">on</span>es((<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), np.uint8)
        <span class="hljs-attr">binary_clean</span> = cv.morphologyEx(binary, cv.MORPH_OPEN, kernel, iterations=<span class="hljs-number">1</span>)
​
        <span class="hljs-comment"># 5. 保存结果</span>
        <span class="hljs-attr">base_name</span> = os.path.splitext(os.path.basename(img_path))[<span class="hljs-number">0</span>]
        <span class="hljs-attr">out_path</span> = os.path.join(output_dir, base_name + <span class="hljs-string">"_CaCO3_binary.png"</span>)
        cv.imwrite(out_path, binary_clean)
​
        print(f"<span class="hljs-section">[OK]</span> 已保存: {out_path}")
​
</code></pre>
<h2 data-id="heading-2">结果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/277a6cdde630431b9c593577a1a68770~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bO75rW35rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675939&amp;x-signature=hoA3GVE8IPMEr%2BFMmg1f6Gv%2B7po%3D" alt="MICP-5-24.tif" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b86e73291aba498aa3d76d30ee6130c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bO75rW35rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675939&amp;x-signature=QnWYHqorBOrJKGPC2E8rj4oMIdU%3D" alt="MICP-5-24_CaCO3_binary.png" loading="lazy"/>
最终输出的结果其实有些不尽人意因为是在显微镜下面的图像，所以仅仅只用普通的颜色过滤会让一部分的阴影也被识别成了沉淀，但是总的来说我对于后续的学习更加充满了动力，因为让我感受到了图像处理的强大。在做完这个小脚本之后我也进一步学习了自适应阈值、Otsu阈值，虽然没有进一步尝试，但是关于阈值处理的数学方法也让我感到了震撼，人类的智慧真的很大！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TS异步编程]]></title>    <link>https://juejin.cn/post/7597742970282262580</link>    <guid>https://juejin.cn/post/7597742970282262580</guid>    <pubDate>2026-01-22T08:45:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970282262580" data-draft-id="7597779410406228002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TS异步编程"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2026-01-22T08:45:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户030480591263"/> <meta itemprop="url" content="https://juejin.cn/user/3793762867478852"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TS异步编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3793762867478852/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户030480591263
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:45:09.000Z" title="Thu Jan 22 2026 08:45:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Gemini生成</p>
</blockquote>
<h2 data-id="heading-0">第一部分：核心概念 (Why &amp; What)</h2>
<p>在编程世界里，代码的执行方式主要分两种：<strong>同步 (Synchronous)</strong> 和 <strong>异步 (Asynchronous)</strong>。</p>
<h3 data-id="heading-1">1. 同步 (Synchronous) —— “死心眼的排队者”</h3>
<p><strong>概念：</strong>
代码从上到下，一行一行执行。上一行代码没有执行完，下一行代码绝对不会开始。</p>
<p><strong>生活类比：</strong>
想象你在<strong>银行柜台</strong>办理业务。</p>
<ol>
<li>你前面有一个人正在办业务（代码行 A）。</li>
<li>不管他办得有多慢，你（代码行 B）都只能在后面干站着等。</li>
<li>你不能玩手机，不能去上厕所，只能<strong>阻塞 (Block)</strong> 在那里，直到他结束。</li>
</ol>
<p><strong>代码表现：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"1. 开始点餐"</span>);
<span class="hljs-title function_">alert</span>(<span class="hljs-string">"我是同步的弹窗，我不关掉，你什么都做不了！"</span>); <span class="hljs-comment">// 这里会卡住</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"2. 吃饭"</span>);
</code></pre>
<p><em>如果不点击弹窗的确定，"2. 吃饭" 永远不会打印出来。这就是“阻塞”。</em></p>
<hr/>
<h3 data-id="heading-2">2. 异步 (Asynchronous) —— “拿着取餐器的食客”</h3>
<p><strong>概念：</strong>
遇到耗时的任务（比如从网络下载图片、读取文件），程序不会傻等，而是把任务交给“别人”（浏览器或操作系统）去处理，自己继续往下执行后面的代码。等耗时任务做完了，再通知程序回来处理结果。</p>
<p><strong>生活类比：</strong>
想象你在<strong>奶茶店</strong>点单。</p>
<ol>
<li>你点了一杯制作很复杂的奶茶（耗时任务）。</li>
<li>店员没有让你站在柜台前盯着他做，而是给了你一个<strong>取餐器</strong>（回调/Promise），然后说：“你先去旁边坐着玩手机，好了震动叫你。”</li>
<li>你找个位置坐下（继续执行后续代码）。</li>
<li>过了一会儿，奶茶好了，取餐器震动，你去拿奶茶（处理异步结果）。</li>
</ol>
<p><strong>代码表现：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"1. 点单：我要一杯奶茶"</span>);

<span class="hljs-comment">// 这是一个模拟异步的函数，假设需要 2 秒钟</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"3. 奶茶好了！(这是异步回来的结果)"</span>);
}, <span class="hljs-number">2000</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"2. 找个位置坐下玩手机"</span>);
</code></pre>
<p><strong>控制台的打印顺序是：</strong></p>
<ol>
<li><code>1. 点单...</code></li>
<li><code>2. 找个位置...</code> (注意：这里直接跳过了等待，先执行了！)</li>
<li>(过了2秒后) <code>3. 奶茶好了...</code></li>
</ol>
<hr/>
<h3 data-id="heading-3">3. 为什么 JavaScript/TypeScript 必须要有异步？</h3>
<p>你可能会问：<em>“同步多简单啊，逻辑清晰，为什么要搞这么复杂的异步？”</em></p>
<p>这和 JS 的出身有关：</p>
<ol>
<li><strong>单线程 (Single Thread)</strong>：JavaScript（以及编译后的 TS）是<strong>单线程</strong>的。也就是说，它只有一个“大脑”，同一时间只能做一件事。它不像 Java 或 C++ 那样可以开启多条线程同时工作。</li>
<li><strong>浏览器的体验</strong>：
<ul>
<li>假设你打开一个网页，它需要去服务器请求“用户列表”。</li>
<li>如果使用<strong>同步</strong>：在数据请求回来的这 1-2 秒内，网页会<strong>完全卡死</strong>。你点击按钮没反应，滚动条滚不动，甚至无法关闭网页。这对用户体验是灾难性的。</li>
<li>如果使用<strong>异步</strong>：请求发出去后，浏览器继续响应你的鼠标点击和滚动，等数据回来了，再悄悄把列表渲染到屏幕上。</li>
</ul>
</li>
</ol>
<p><strong>总结第一部分：</strong></p>
<ul>
<li><strong>同步</strong> = 顺序执行，会卡住（阻塞）。</li>
<li><strong>异步</strong> = 不等待，继续往下走，回头再处理结果。</li>
<li><strong>TS/JS 的特性</strong> = 单线程，为了不让网页/程序卡死，必须大量使用异步。</li>
</ul>
<hr/>
<h2 data-id="heading-4"><strong>第二部分：异步的演进史 (History)</strong></h2>
<p>JavaScript/TypeScript 的异步演进史，其实就是一部<strong>与“代码可读性”抗争的历史</strong>。我们的目标始终未变：<strong>让异步代码看起来像同步代码一样简单易懂。</strong></p>
<p>我们分三个阶段来讲：</p>
<hr/>
<h3 data-id="heading-5">1. 第一阶段：上古时代 —— 回调函数 (Callback)</h3>
<p>在 Promise 出现之前（大约是 2015 年 ES6 标准发布前），我们处理异步只有一种办法：<strong>回调函数</strong>。</p>
<p><strong>什么是回调？</strong>
简单来说，就是你定义一个函数，但你自己不调用它，而是把它作为参数传给另一个函数（比如网络请求函数）。你告诉对方：“等你做完你的事，回头(Call back)调用一下我这个函数，把结果传给我。”</p>
<p><strong>场景模拟：</strong>
我们要去数据库获取用户信息。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义一个回调函数的类型：接收 string 类型的数据，没有返回值</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyCallback</span> = <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">callback: MyCallback</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"1. 开始向服务器请求数据..."</span>);
    
    <span class="hljs-comment">// 模拟耗时 1 秒</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"2. 服务器返回数据了"</span>);
        <span class="hljs-keyword">const</span> data = <span class="hljs-string">"张三"</span>;
        <span class="hljs-comment">// 关键点：任务做完后，手动调用传进来的函数</span>
        <span class="hljs-title function_">callback</span>(data); 
    }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">getUserData</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`3. 拿到用户名：<span class="hljs-subst">${name}</span>`</span>);
});
</code></pre>
<p><strong>问题在哪里？</strong>
如果是这一层简单的调用，看起来还不错。但现实往往很残酷。</p>
<hr/>
<h3 data-id="heading-6">2.第二阶段：黑暗时代 —— 回调地狱 (Callback Hell)</h3>
<p><strong>场景升级：</strong>
现在的业务逻辑变成了这样，必须严格按顺序执行：</p>
<ol>
<li>先获取用户名（比如 "张三"）。</li>
<li>拿到用户名后，去数据库查他的<strong>ID</strong>。</li>
<li>拿到 ID 后，去查他的<strong>订单</strong>。</li>
</ol>
<p><strong>代码会变成什么样？</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码演示，注意看缩进的形状</span>
<span class="hljs-title function_">getUserName</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到名字: <span class="hljs-subst">${name}</span>`</span>);
    
    <span class="hljs-comment">// 在回调里面嵌套第二个请求</span>
    <span class="hljs-title function_">getUserId</span>(name, <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到ID: <span class="hljs-subst">${id}</span>`</span>);
        
        <span class="hljs-comment">// 在回调里面嵌套第三个请求</span>
        <span class="hljs-title function_">getUserOrders</span>(id, <span class="hljs-function">(<span class="hljs-params">orders</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到订单: <span class="hljs-subst">${orders}</span>`</span>);
            
            <span class="hljs-comment">// 如果还有第四步... 屏幕就要炸了</span>
            <span class="hljs-title function_">getOrderDetails</span>(orders[<span class="hljs-number">0</span>], <span class="hljs-function">(<span class="hljs-params">detail</span>) =&gt;</span> {
                <span class="hljs-comment">// ...</span>
            });
        });
    });
});
</code></pre>
<p><strong>这就是著名的“回调地狱”（也就是“厄运金字塔”）：</strong></p>
<ol>
<li><strong>代码横向发展</strong>：缩进越来越深，阅读极其困难。</li>
<li><strong>错误处理灾难</strong>：你需要在每一层回调里单独写 <code>if (error) ...</code>，极其容易漏掉。</li>
<li><strong>维护困难</strong>：想调整一下顺序？你要小心翼翼地拆括号，很容易改崩。</li>
</ol>
<hr/>
<h3 data-id="heading-7">3.第三阶段：曙光初现 —— Promise (承诺)</h3>
<p>为了解决“回调地狱”，社区提出了一种新的规范，后来被纳入了 ES6 标准，这就是 <strong>Promise</strong>。</p>
<p><strong>什么是 Promise？</strong>
它是一个对象，代表了“一个未来才会知道结果的操作”。
你可以把它想象成一张<strong>披萨店的取餐小票</strong>。
当你拿到这个 Promise（小票）时，披萨还没好，但它<strong>承诺</strong>未来会给你两个结果中的一个：</p>
<ol>
<li><strong>Fulfilled (成功)</strong>：披萨做好了，给你披萨。</li>
<li><strong>Rejected (失败)</strong>：烤箱炸了，给你一个错误原因。</li>
</ol>
<p><strong>Promise 最大的贡献：链式调用 (Chaining)</strong>
它把“回调地狱”的横向嵌套，拉直成了纵向的链条。</p>
<p><strong>TypeScript 中的 Promise 写法：</strong></p>
<p>我们看看上面的“回调地狱”用 Promise 改写后是什么样：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 假设这些函数现在返回的是 Promise，而不是接受回调</span>
<span class="hljs-comment">// getUserName() -&gt; 返回 Promise&lt;string&gt;</span>

<span class="hljs-title function_">getUserName</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到名字: <span class="hljs-subst">${name}</span>`</span>);
        <span class="hljs-comment">// 返回下一个异步任务，继续往下传</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getUserId</span>(name); 
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到ID: <span class="hljs-subst">${id}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getUserOrders</span>(id);
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">orders</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到订单: <span class="hljs-subst">${orders}</span>`</span>);
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-comment">// 重点：这里一个 catch 可以捕获上面任何一步发生的错误！</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"出错了:"</span>, error);
    });
</code></pre>
<blockquote>
<p>完整代码</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 获取用户名的函数</span>
<span class="hljs-comment">// 返回值类型：Promise&lt;string&gt; -&gt; 承诺未来会给出一个 string</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserName</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"--- 1. 开始请求用户名 ---"</span>);
        
        <span class="hljs-comment">// 模拟网络耗时 1秒</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">const</span> isSuccess = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 模拟：假设请求成功</span>

            <span class="hljs-keyword">if</span> (isSuccess) {
                <span class="hljs-comment">// 成功了！调用 resolve，把数据 "张三" 传出去</span>
                <span class="hljs-comment">// 这个 "张三" 会传给下一个 .then((name) =&gt; ...) 里的 name</span>
                <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"张三"</span>); 
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 失败了！调用 reject</span>
                <span class="hljs-comment">// 这会跳过后面的 .then，直接进入最后的 .catch</span>
                <span class="hljs-title function_">reject</span>(<span class="hljs-string">"获取用户名失败：网络连接断开"</span>); 
            }
        }, <span class="hljs-number">1000</span>);
    });
}

<span class="hljs-comment">// 2. 获取用户ID的函数</span>
<span class="hljs-comment">// 接收参数 name，返回 Promise&lt;number&gt;</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserId</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`--- 2. 正在查 <span class="hljs-subst">${name}</span> 的ID ---`</span>);

        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 假设我们查到了 ID 是 10086</span>
            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">10086</span>);
        }, <span class="hljs-number">1000</span>);
    });
}

<span class="hljs-comment">// 3. 获取订单的函数</span>
<span class="hljs-comment">// 接收参数 id，返回 Promise&lt;string[]&gt; (字符串数组)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserOrders</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`--- 3. 正在查 ID:<span class="hljs-subst">${id}</span> 的订单 ---`</span>);

        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 返回订单列表</span>
            <span class="hljs-title function_">resolve</span>([<span class="hljs-string">"奶茶"</span>, <span class="hljs-string">"炸鸡"</span>, <span class="hljs-string">"Switch游戏机"</span>]);
        }, <span class="hljs-number">1000</span>);
    });
}

<span class="hljs-comment">// --- 实际调用部分（就是你刚才看到的那段代码） ---</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"程序启动..."</span>);

<span class="hljs-title function_">getUserName</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
        <span class="hljs-comment">// 这里接收到的 name 就是 resolve("张三") 里的 "张三"</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 拿到名字: <span class="hljs-subst">${name}</span>`</span>);
        
        <span class="hljs-comment">// 关键点：这里 return 了下一个 Promise 函数的调用</span>
        <span class="hljs-comment">// 这样下一个 .then 才会等到 getUserId 完成后才执行</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getUserId</span>(name); 
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-comment">// 这里接收到的 id 就是 resolve(10086) 里的 10086</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 拿到ID: <span class="hljs-subst">${id}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getUserOrders</span>(id);
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">orders</span>) =&gt;</span> {
        <span class="hljs-comment">// 这里接收到的 orders 就是那个数组</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 拿到订单: <span class="hljs-subst">${orders}</span>`</span>);
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 流程中断: <span class="hljs-subst">${error}</span>`</span>);
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// (可选) finally 不管成功失败都会执行</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"--- 流程结束 ---"</span>);
    });
</code></pre>
<p><strong>Promise 的核心状态（面试常考）：</strong>
一个 Promise 一定处于以下三种状态之一：</p>
<ol>
<li><strong>Pending (进行中)</strong>：刚初始化，还没结果。</li>
<li><strong>Fulfilled / Resolved (已成功)</strong>：操作成功，调用了 <code>.then</code>。</li>
<li><strong>Rejected (已失败)</strong>：操作失败，调用了 <code>.catch</code>。</li>
</ol>
<p><strong>TS 类型小贴士：</strong>
在 TypeScript 中，Promise 是有<strong>泛型</strong>的。
如果一个异步函数最终返回一个字符串，它的类型是 <code>Promise&lt;string&gt;</code>。
如果返回一个数字，类型是 <code>Promise&lt;number&gt;</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 这是一个返回 Promise 的函数定义示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">wait</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"时间到！"</span>);
        }, ms);
    });
}
</code></pre>
<hr/>
<p><strong>总结第二部分：</strong></p>
<ul>
<li><strong>回调函数</strong>：最原始，容易导致嵌套过深（回调地狱）。</li>
<li><strong>Promise</strong>：通过 <code>.then()</code> 链式调用，把代码拉直了，解决了缩进问题，并且统一了错误处理（<code>.catch()</code>）。</li>
</ul>
<p>但是……你有没有发现，Promise 虽然比回调好，但还是有很多 <code>.then()</code>？代码里充斥着很多小括号和箭头函数，看起来依然不像我们要的“同步代码”。</p>
<p>这就是为什么我们需要<strong>第三部分：Async/Await</strong>（终极解决方案）。</p>
<hr/>
<h2 data-id="heading-8"><strong>第三部分：现代标准写法 (Async/Await)</strong></h2>
<p>好的，来到最激动人心的部分了！<strong>Async/Await</strong> 是现代 JavaScript/TypeScript 开发的<strong>标配</strong>。</p>
<p>学会了这个，你就不再需要写那些繁琐的 <code>.then</code> 链条了。代码会变得像写同步代码（比如 Java 或 Python）一样直观。</p>
<hr/>
<h3 data-id="heading-9">1. 什么是 Async/Await？</h3>
<ul>
<li><strong>Async/Await</strong> 是在 ES2017 (ES8) 引入的新语法。</li>
<li>它本质上是 <strong>Promise 的语法糖</strong>。
<ul>
<li>也就是说，底层依然在跑 Promise，只是写法变了，机器执行的逻辑没变。</li>
</ul>
</li>
<li><strong>async</strong>：放在函数定义前，表示“这个函数内部有异步操作”。</li>
<li><strong>await</strong>：放在 Promise 前面，表示“<strong>等一下</strong>，直到这个 Promise 出结果（resolve）了，再往下走”。</li>
</ul>
<hr/>
<h3 data-id="heading-10">2. 代码对比：从 Promise 到 Async/Await</h3>
<p>让我们用刚才定义的三个函数（<code>getUserName</code>, <code>getUserId</code>, <code>getUserOrders</code>）来演示。它们本身的定义不需要改，只需要改<strong>调用的方式</strong>。</p>
<h4 data-id="heading-11">旧写法 (Promise 链式调用)</h4>
<p><em>哪怕逻辑再清晰，依然有很多回调函数嵌套。</em></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">runOldWay</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">getUserName</span>()
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> <span class="hljs-title function_">getUserId</span>(name))
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">getUserOrders</span>(id))
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">orders</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(orders))
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err));
}
</code></pre>
<h4 data-id="heading-12">新写法 (Async/Await)</h4>
<p><em>看！没有回调函数了！全是赋值语句！</em></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 必须在函数前加 async 关键字</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runNewWay</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始任务..."</span>);

        <span class="hljs-comment">// 2. 使用 await 等待结果，直接赋值给变量</span>
        <span class="hljs-comment">// JS 引擎运行到这里会暂停，直到 getUserName 里的 resolve 被调用</span>
        <span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserName</span>(); 
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到名字: <span class="hljs-subst">${name}</span>`</span>);

        <span class="hljs-comment">// 上一行没拿到结果前，这一行绝不会执行</span>
        <span class="hljs-keyword">const</span> id = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserId</span>(name);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到ID: <span class="hljs-subst">${id}</span>`</span>);

        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserOrders</span>(id);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`拿到订单: <span class="hljs-subst">${orders}</span>`</span>);

    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 3. 错误处理回归原始的 try...catch</span>
        <span class="hljs-comment">// 只要上面任何一个 await 的 Promise 被 reject，就会跳到这里</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"出错了:"</span>, error);
    }
}

<span class="hljs-comment">// 调用这个异步函数</span>
<span class="hljs-title function_">runNewWay</span>();
</code></pre>
<hr/>
<h3 data-id="heading-13">3. 深度解析：<code>await</code> 到底做了什么？</h3>
<p>当你写下 <code>const name = await getUserName();</code> 时，发生了什么？</p>
<ol>
<li><strong>暂停执行</strong>：函数 <code>runNewWay</code> 的执行被<strong>暂停</strong>在这一行。</li>
<li><strong>让出线程</strong>：虽然 <code>runNewWay</code> 停了，但主线程没有卡死（没有阻塞）。浏览器可以去处理点击事件、渲染动画，或者执行 <code>runNewWay</code> 外面的其他代码。</li>
<li><strong>等待结果</strong>：<code>getUserName</code> 在后台跑（比如等待网络请求）。</li>
<li><strong>恢复执行</strong>：一旦 <code>getUserName</code> 完成并 <code>resolve</code> 了结果，<code>runNewWay</code> 会被“唤醒”。结果被赋值给 <code>name</code>，然后继续执行下一行代码。</li>
</ol>
<p><strong>注意：</strong> <code>await</code> 只能用在 <code>async</code> 函数内部。（虽然最新的 TS/JS 支持 Top-level await，但在普通函数里还是不行的）。</p>
<hr/>
<h3 data-id="heading-14">4. TypeScript 里的 Async 函数类型</h3>
<p>在 TypeScript 中，<code>async</code> 函数的返回值类型<strong>永远是 Promise</strong>。</p>
<p>就算你 return 的是一个普通数字，TS 也会自动帮你不装成 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 普通函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// Async 函数</span>
<span class="hljs-comment">// 虽然看起来 return 3，但 TS 推断出的返回类型是 Promise&lt;number&gt;</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addAsync</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">return</span> a + b; 
}

<span class="hljs-comment">// 调用时必须处理 Promise</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">addAsync</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// result 是 Promise&lt;number&gt;</span>
<span class="hljs-comment">// 正确用法：</span>
<span class="hljs-comment">// await addAsync(1, 2) 或 addAsync(1, 2).then(...)</span>
</code></pre>
<blockquote>
<p>代码分析</p>
</blockquote>
<p><code>const result = addAsync(1, 2);</code>: 无论有没有加<code>await</code>, <code>async</code>函数都是返回<code>Promise&lt;&gt;</code>对象. 如果没有添加<code>await</code>, 依然会执行该异步函数, 但是不会在这里等待, 会立刻执行下面的函数, 这个<code>addAsync</code>函数就在后台默默执行.
有时候会故意不写<code>await</code>, 比如下面这个场景:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 发送两个请求，但我不想串行等待（不希望 A 完了才做 B）</span>
    <span class="hljs-keyword">const</span> taskA = <span class="hljs-title function_">getUserInfo</span>(); <span class="hljs-comment">// 没写 await，请求发出去了</span>
    <span class="hljs-keyword">const</span> taskB = <span class="hljs-title function_">getBanners</span>();  <span class="hljs-comment">// 没写 await，请求也发出去了</span>
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'两个请求都已经发出去了，正在后台跑...'</span>);

    <span class="hljs-comment">// 稍后我再一起等它们的结果</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> taskA;
    <span class="hljs-keyword">const</span> banner = <span class="hljs-keyword">await</span> taskB;
}
</code></pre>
<hr/>
<h4 data-id="heading-15">总结第三部分</h4>
<ol>
<li><strong>写法更像同步</strong>：用 <code>try...catch</code> 替代 <code>.catch</code>，用赋值替代 <code>.then</code>。</li>
<li><strong>可读性飞跃</strong>：代码逻辑从上到下，符合人类阅读习惯。</li>
<li><strong>调试方便</strong>：在 <code>await</code> 这一行打断点，你可以清楚地看到之前的变量状态，这在 <code>.then</code> 链条里是很难做到的。</li>
</ol>
<p>现在，你已经掌握了最主流的异步写法。</p>
<p>接下来，我们要进入<strong>第四部分：TypeScript 里的异步类型</strong>。这部分会教你如何在真实的工作中（比如调用后端 API）定义那些复杂的数据接口。这一步是 TS 开发者的日常。</p>
<hr/>
<h2 data-id="heading-16"><strong>第四部分：TypeScript 里的异步类型 (TS Specifics)</strong></h2>
<p>前面的内容其实大都也是 JavaScript 的知识（除了简单的类型标注）。到了这里，我们要讲<strong>只有 TypeScript 才能提供的强大功能</strong>：如何在异步操作中获得完美的类型提示和安全保障。</p>
<p>这一部分对于前端开发（尤其是对接后端 API）至关重要。</p>
<hr/>
<h3 data-id="heading-17">1. Promise 的泛型：<code>Promise&lt;T&gt;</code></h3>
<p>我们在前面的例子里稍微提到了这个。<code>Promise</code> 是一个<strong>泛型类</strong>。
这就好比 <code>Array&lt;number&gt;</code> 表示“装数字的数组”，<code>Promise&lt;User&gt;</code> 表示“承诺未来给你一个 User 对象”。</p>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 函数返回值类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TypeOfTheResult</span>&gt; { ... }
</code></pre>
<p><strong>实战场景：定义 API 响应结构</strong></p>
<p>假设后端给你这样一个 JSON 数据结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 后端返回的用户数据</span>
<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isActive"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤一：定义 Interface (接口)</strong>
我们要先告诉 TS，这个数据长什么样。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-comment">// 甚至可以有可选属性</span>
    avatarUrl?: <span class="hljs-built_in">string</span>; 
}
</code></pre>
<p><strong>步骤二：在异步函数中使用</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 这里的返回值类型 Promise&lt;User&gt; 非常重要！</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchCurrentUser</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
    <span class="hljs-comment">// 解析 JSON</span>
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    
    <span class="hljs-comment">// 这里其实有一个类型断言的过程，告诉 TS 这个 data 就是 User</span>
    <span class="hljs-comment">// 在实际项目中，通常 fetch 封装库（如 axios）会帮我们做泛型传递</span>
    <span class="hljs-keyword">return</span> data <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>; 
}
</code></pre>
<p><strong>步骤三：享受类型提示</strong></p>
<p>当你调用这个函数时，神奇的事情发生了：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchCurrentUser</span>();
    
    <span class="hljs-comment">// 当你敲下 user. 的时候，VS Code 会自动弹窗提示：</span>
    <span class="hljs-comment">// - id</span>
    <span class="hljs-comment">// - username</span>
    <span class="hljs-comment">// - isActive</span>
    <span class="hljs-comment">// - avatarUrl</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">username</span>); 
    
    <span class="hljs-comment">// 如果你拼写错误，立刻报错！</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">usrname</span>); <span class="hljs-comment">// ❌ 报错：User 类型上不存在 usrname</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-18">2. 实战技巧：配合 Axios (最常用的请求库)</h3>
<p>在真实工作中，我们通常使用 <code>axios</code> 库来发请求。<code>axios</code> 的类型定义非常完善，支持传入泛型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 定义接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Article</span> {
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">views</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 2. 发送请求</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getArticle</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// axios.get 是个泛型函数：axios.get&lt;T&gt;(url)</span>
    <span class="hljs-comment">// 我们传入 &lt;Article&gt;，告诉 axios 返回的数据体 data 是 Article 类型</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">Article</span>&gt;(<span class="hljs-string">`/api/articles/<span class="hljs-subst">${id}</span>`</span>);
    
    <span class="hljs-comment">// response.data 现在的类型就是 Article</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
}

<span class="hljs-comment">// 3. 调用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showArticle</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> article = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getArticle</span>(<span class="hljs-number">101</span>);
    <span class="hljs-comment">// 此时 article 就是 Article 类型</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(article.<span class="hljs-property">title</span>); <span class="hljs-comment">// ✅ 安全</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-19">3. 处理“可能是多种类型”的情况</h3>
<p>有时候异步操作可能会返回不同的结果，或者可能失败。</p>
<p><strong>场景：</strong> 搜索用户，可能找到，也可能没找到（null）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 返回值类型是 UserInfo 或者 null</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">findUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserInfo</span> | <span class="hljs-literal">null</span>&gt; {
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'Ghost'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'RealUser'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> };
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">findUser</span>(<span class="hljs-string">'Ghost'</span>);
    
    <span class="hljs-comment">// 这里 user 可能是 null，TS 会强迫你做检查</span>
    <span class="hljs-comment">// console.log(user.name); // ❌ 报错：user 可能为 null</span>

    <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// ✅ 现在安全了</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-20">总结第四部分</h3>
<ol>
<li><strong>核心思维</strong>：写异步函数时，第一件事不是写逻辑，而是<strong>先想好返回值类型</strong>（<code>Promise&lt;T&gt;</code>）。</li>
<li><strong>接口先行</strong>：把后端返回的 JSON 数据结构定义为 <code>interface</code>。</li>
<li><strong>工具库配合</strong>：使用 Axios 等支持泛型的库，把 interface 传进去，这样从请求结果里拿到的数据就会自带类型提示。</li>
</ol>
<p>这一步做好了，你的代码健壮性会提升一个档次，再也不用担心拼错字段名或者不知道后端返回了啥。</p>
<p>准备好进入最后一部分了吗？我们将讨论<strong>实战中的错误处理</strong>和<strong>并行技巧</strong>（比如怎么让两个请求同时发，而不是一个等一个）。</p>
<hr/>
<h2 data-id="heading-21"><strong>第五部分：实战与错误处理 (Best Practices)</strong></h2>
<p>好，我们进入最后一部分：<strong>实战与错误处理 (Best Practices)</strong>。</p>
<p>这部分是区分“新手”和“熟练工”的分水岭。新手写的异步代码往往在网络正常时能跑，一旦网络抖动或者需要优化性能时就崩了。</p>
<hr/>
<h3 data-id="heading-22">1. 优雅的错误处理 (try...catch)</h3>
<p>在 Async/Await 模式下，我们使用传统的 <code>try...catch</code> 来捕获异步错误。</p>
<p><strong>基本套路：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeGetData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 可能会炸的代码放在 try 里</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"成功:"</span>, data);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 1. 网络断了</span>
        <span class="hljs-comment">// 2. 服务器 500 了</span>
        <span class="hljs-comment">// 3. JSON 解析失败了</span>
        <span class="hljs-comment">// 所有错误都会汇聚到这里</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"出大问题了:"</span>, error);
        
        <span class="hljs-comment">// TS 小坑：catch(error) 这里的 error 默认类型是 unknown 或 any</span>
        <span class="hljs-comment">// 如果要访问 error.message，最好断言一下</span>
        <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误信息:"</span>, error.<span class="hljs-property">message</span>);
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// (可选) 无论成功失败都会执行，适合关闭 loading 动画</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"关闭 Loading 转圈圈"</span>);
    }
}
</code></pre>
<p><strong>为什么这很重要？</strong>
如果不写 <code>try...catch</code>，一旦 <code>await</code> 的 Promise 失败（Rejected），整个函数会抛出异常。如果上层也没人捕获，<strong>你的程序可能会崩溃</strong>（在 Node.js 中可能会导致进程退出，在前端会导致控制台报红且后续逻辑中断）。</p>
<hr/>
<h3 data-id="heading-23">2. 并行处理 (Promise.all) —— 性能优化神器</h3>
<p>这是面试和实战中极高频的考点。</p>
<p><strong>场景：</strong>
你需要在一个页面同时展示“用户信息”和“最近订单”。这俩接口互不相关。</p>
<p><strong>新手写法 (串行 - 慢)：</strong>
<em>就像排队，先买奶茶，买完再排队买炸鸡。</em></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPageSerial</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">"串行耗时"</span>);
    
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>();       <span class="hljs-comment">// 假设耗时 1s</span>
    <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getOrders</span>();   <span class="hljs-comment">// 假设耗时 1s</span>
    
    <span class="hljs-comment">// 总耗时：1s + 1s = 2s</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">"串行耗时"</span>);
}
</code></pre>
<p><strong>高手写法 (并行 - 快)：</strong>
<em>我和朋友分头行动，我买奶茶，他买炸鸡，最后一起吃。</em></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPageParallel</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">"并行耗时"</span>);
    
    <span class="hljs-comment">// 技巧：Promise.all 接收一个 Promise 数组</span>
    <span class="hljs-comment">// 它会同时启动数组里的所有任务</span>
    <span class="hljs-keyword">const</span> [user, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-title function_">getUser</span>(),      <span class="hljs-comment">// 任务 A</span>
        <span class="hljs-title function_">getOrders</span>()     <span class="hljs-comment">// 任务 B</span>
    ]);
    
    <span class="hljs-comment">// 总耗时：max(1s, 1s) = 1s</span>
    <span class="hljs-comment">// 只有当两个都完成了，await 才会继续往下走</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">"并行耗时"</span>);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user, orders);
}
</code></pre>
<p><strong>Promise.all 的特点：</strong></p>
<ol>
<li><strong>全成则成</strong>：只有数组里所有 Promise 都成功了，它才成功。</li>
<li><strong>一败则败</strong>：只要有一个失败了，整个 <code>Promise.all</code> 直接抛出错误（进入 catch），其他的成功了也没用。</li>
</ol>
<p><strong>进阶：Promise.allSettled (ES2020)</strong>
如果你不希望“一败则败”（比如用户信息挂了，但我还是想展示订单），可以使用 <code>Promise.allSettled</code>。它会等待所有任务结束，不管成功还是失败，并返回每个任务的状态。</p>
<hr/>
<h3 data-id="heading-24">3. 一个常见的循环陷阱</h3>
<p><strong>需求：</strong> 有一个用户 ID 列表 <code>[1, 2, 3]</code>，要依次获取他们的详细信息。</p>
<p><strong>错误写法 (forEach)：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">wrongLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    
    <span class="hljs-comment">// ❌ 这种写法 await 不生效！forEach 不支持 async 回调</span>
    ids.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (id) =&gt; {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(id);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user);
    });
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"结束了？"</span>); 
    <span class="hljs-comment">// 实际结果：先打印 "结束了？"，然后那 3 个请求才在后台慢慢跑。</span>
}
</code></pre>
<p><strong>正确写法 1 (for...of) —— 串行（一个接一个）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">serialLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> ids) {
        <span class="hljs-comment">// ✅ 能够正确暂停，拿完 id:1 再拿 id:2</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(id);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user);
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"真·结束了"</span>);
}
</code></pre>
<p><strong>正确写法 2 (map + Promise.all) —— 并行（同时跑）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    
    <span class="hljs-comment">// 1. 先把 ID 数组映射成 Promise 数组</span>
    <span class="hljs-keyword">const</span> promises = ids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">getUser</span>(id));
    
    <span class="hljs-comment">// 2. 再用 Promise.all 等待它们全部完成</span>
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"所有用户都拿到:"</span>, users);
}
</code></pre>
<hr/>
<h3 data-id="heading-25">全文大总结</h3>
<p>恭喜你，你已经走完了 TypeScript 异步编程的完整路径！</p>
<ol>
<li><strong>核心概念</strong>：JS 是单线程的，为了不阻塞，必须用异步。</li>
<li><strong>演进史</strong>：Callback (回调地狱) -&gt; Promise (链式) -&gt; <strong>Async/Await (最终形态)</strong>。</li>
<li><strong>TS 类型</strong>：使用 <code>Promise&lt;T&gt;</code> 和接口 (Interface) 来约束异步数据的形状，获得极致的代码提示。</li>
<li><strong>实战技巧</strong>：
<ul>
<li>用 <code>try...catch</code> 兜底错误。</li>
<li>用 <code>Promise.all</code> 做并发优化。</li>
<li><strong>千万别在 <code>forEach</code> 里用 await</strong>。</li>
</ul>
</li>
</ol>
<p>\</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 项目库创建上传从零到一]]></title>    <link>https://juejin.cn/post/7597997108134002715</link>    <guid>https://juejin.cn/post/7597997108134002715</guid>    <pubDate>2026-01-22T08:38:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597997108134002715" data-draft-id="7597808104462630958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 项目库创建上传从零到一"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-22T08:38:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 项目库创建上传从零到一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:38:48.000Z" title="Thu Jan 22 2026 08:38:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Git 项目从零到一：创建本地仓库并提交代码至远程 Gitee 仓库详解</h2>
<p>在现代软件开发中，版本控制系统（Version Control System, VCS）已成为开发者不可或缺的工具。而 <strong>Git</strong> 作为目前最流行的分布式版本控制系统，以其高效、灵活和强大的分支管理能力，被广泛应用于个人开发与团队协作中。本文将手把手带你完成一个完整的 Git 工作流：<strong>从本地初始化项目仓库，到配置用户信息、添加文件、提交变更，再到关联远程 Gitee 仓库并推送代码</strong>。整个过程适用于初学者快速上手 Git，并为后续深入学习打下坚实基础。</p>
<hr/>
<h3 data-id="heading-1">一、为什么需要 Git？</h3>
<p>假设你正在开发一个名为 <code>lesson_zp</code> 的本地项目文件夹。在没有版本控制的情况下：</p>
<ul>
<li>你无法回退到之前的代码状态；</li>
<li>多人协作时容易覆盖彼此的修改；</li>
<li>无法清晰记录每次修改的内容和原因。</li>
</ul>
<p>而 Git 就像“月光宝盒”——它能让你随时穿越回任意历史版本，安全地尝试新功能（通过分支），并与他人高效协同工作。</p>
<hr/>
<h3 data-id="heading-2">二、准备工作：安装 Git 与注册 Gitee 账号</h3>
<ol>
<li>
<p><strong>安装 Git</strong><br/>
访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2F" target="_blank" title="https://git-scm.com/" ref="nofollow noopener noreferrer">git-scm.com/</a> 下载并安装适合你操作系统的 Git 客户端。安装完成后，在终端（Windows 使用 Git Bash，macOS/Linux 使用 Terminal）中输入：</p>
<pre><code class="hljs language-bash" lang="bash">git --version
</code></pre>
<p>若显示版本号（如 <code>git version 2.40.1</code>），说明安装成功。</p>
</li>
<li>
<p><strong>注册 Gitee 账号</strong><br/>
Gitee（码云）是国内知名的代码托管平台，支持 Git 协议。访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com" target="_blank" title="https://gitee.com" ref="nofollow noopener noreferrer">gitee.com</a> 注册账号，并登录。</p>
<ul>
<li>注意： 在终端执行git相关操作时一定要在安装之后全部操作重新执行一遍</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">三、初始化本地 Git 仓库</h3>
<p>假设你的项目目录为 <code>lesson_zp</code>，且尚未使用任何版本控制。</p>
<h4 data-id="heading-4">步骤 1：进入项目目录</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /path/to/your/lesson_zp
</code></pre>
<h4 data-id="heading-5">步骤 2：执行 <code>git init</code></h4>
<pre><code class="hljs language-bash" lang="bash">git init
</code></pre>
<p>该命令会在当前目录下创建一个隐藏文件夹 <code>.git</code>，这就是 Git 仓库的核心数据库，用于存储所有版本信息、提交历史、分支结构等。</p>
<blockquote>
<p>✅ 此时，<code>lesson_zp</code> 已成为一个<strong>本地 Git 仓库</strong>，具备版本控制能力。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">四、配置 Git 用户信息</h3>
<p>Git 需要知道是谁在提交代码，因此必须配置用户名和邮箱。这些信息会永久记录在每次提交中。</p>
<pre><code class="hljs language-bash" lang="bash">git config --global user.name <span class="hljs-string">"shunwuyu2020"</span>
git config --global user.email <span class="hljs-string">"shunwu2001@163.com"</span>
</code></pre>
<ul>
<li><code>--global</code> 表示全局配置，适用于本机所有项目。</li>
<li>如果只想对当前项目生效，可去掉 <code>--global</code>，在项目根目录下单独设置。</li>
</ul>
<blockquote>
<p>🔍 验证配置是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">git config user.name
git config user.email
</code></pre>
</blockquote>
<hr/>
<h3 data-id="heading-7">五、添加文件到暂存区并提交</h3>
<p>Git 的工作流程分为三个区域：</p>
<ol>
<li><strong>工作区（Working Directory）</strong>：你编辑的文件所在位置。</li>
<li><strong>暂存区（Staging Area）</strong>：准备提交的快照。</li>
<li><strong>仓库（Repository）</strong>：已提交的历史版本。</li>
</ol>
<h4 data-id="heading-8">步骤 1：查看当前状态</h4>
<pre><code class="hljs language-bash" lang="bash">git status
</code></pre>
<p>你会看到类似 “Untracked files” 的提示，表示有未被跟踪的文件。</p>
<h4 data-id="heading-9">步骤 2：将所有修改添加到暂存区</h4>
<pre><code class="hljs language-bash" lang="bash">git add .
</code></pre>
<ul>
<li><code>.</code> 表示当前目录下所有文件（包括子目录）。</li>
<li>也可指定单个文件：<code>git add README.md</code></li>
</ul>
<h4 data-id="heading-10">步骤 3：提交到本地仓库</h4>
<pre><code class="hljs language-bash" lang="bash">git commit -m <span class="hljs-string">"第一次提交"</span>
</code></pre>
<ul>
<li><code>-m</code> 后跟<strong>提交说明</strong>（commit message），应简洁明了地描述本次变更内容。</li>
<li>提交后，Git 会生成一个唯一的 SHA-1 哈希值作为该版本的 ID。</li>
</ul>
<blockquote>
<p>💡 建议：提交信息使用中文或英文均可，但需保持一致性，避免无意义的“update”、“fix”等。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">六、创建远程仓库（Gitee）</h3>
<p>这部分代码需要在Gitee网页创建一个git项目库 如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37fddee82542471695410ae34d42f09f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTc1NzMwMzM0NjI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675928&amp;x-signature=M0Tzphv3QTPCzCRddAqu9DDKr2o%3D" alt="image.png" loading="lazy"/>
完成下面信息设置的填写
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b4963f7de8840c7a5acd1d8d78b5cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTc1NzMwMzM0NjI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769675928&amp;x-signature=YlPZbLLDDFtnlw4roL6F%2Fo9VLrE%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>登录 Gitee，点击右上角「+」→「新建仓库」。</li>
<li>填写仓库名称（如 <code>lesson_zp</code>），选择公开或私有（免费用户可创建私有库）。</li>
<li><strong>不要勾选“使用 README.md 初始化”</strong>，因为我们已有本地代码。</li>
<li>点击「创建」，获得远程仓库地址：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fshunwuyu2020%2Flesson_zp.git" target="_blank" title="https://gitee.com/shunwuyu2020/lesson_zp.git" ref="nofollow noopener noreferrer">gitee.com/shunwuyu202…</a></li>
</ol>
<hr/>
<h3 data-id="heading-12">七、关联本地仓库与远程仓库</h3>
<p>使用 <code>git remote add</code> 命令将本地仓库与远程仓库绑定：</p>
<pre><code class="hljs language-bash" lang="bash">git remote add origin https://gitee.com/shunwuyu2020/lesson_zp.git
</code></pre>
<ul>
<li><code>origin</code> 是远程仓库的默认别名，可自定义（如 <code>gitee</code>），但约定俗成用 <code>origin</code>。</li>
<li>你可以通过 <code>git remote -v</code> 查看已配置的远程地址。</li>
</ul>
<hr/>
<h3 data-id="heading-13">八、推送代码到 Gitee</h3>
<p>首次推送需指定远程分支：</p>
<pre><code class="hljs language-bash" lang="bash">git push -u origin master
</code></pre>
<ul>
<li><code>-u</code>（或 <code>--set-upstream</code>）表示将本地 <code>master</code> 分支与远程 <code>origin/master</code> 关联。</li>
<li>后续只需执行 <code>git push</code> 即可自动推送到关联分支。</li>
</ul>
<blockquote>
<p>⚠️ 注意：如果你使用的是较新版本的 Git（≥2.28），默认主分支可能叫 <code>main</code> 而非 <code>master</code>。可通过以下命令确认：</p>
<pre><code class="hljs language-bash" lang="bash">git branch
</code></pre>
<p>若显示 <code>* main</code>，则应使用：</p>
<pre><code class="hljs language-bash" lang="bash">git push -u origin main
</code></pre>
</blockquote>
<h4 data-id="heading-14">推送时的身份验证</h4>
<p>Gitee 不再支持直接使用账号密码通过 HTTPS 推送。推荐使用 <strong>私人令牌（Personal Access Token）</strong> 替代密码：</p>
<ol>
<li>在 Gitee「设置」→「私人令牌」中创建一个 token（勾选 <code>repo</code> 权限）。</li>
<li>推送时，当提示输入密码，粘贴该 token 即可。</li>
</ol>
<blockquote>
<p>更安全的方式是配置 SSH 密钥，但 HTTPS + Token 对初学者更友好。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">九、验证推送结果</h3>
<p>回到 Gitee 仓库页面，刷新后应能看到你提交的文件和提交记录。至此，<strong>本地项目已成功同步至远程仓库</strong>！</p>
<hr/>
<h3 data-id="heading-16">十、后续开发工作流建议</h3>
<p>日常开发中，推荐遵循以下流程：</p>
<ol>
<li><strong>修改代码</strong></li>
<li><strong><code>git add .</code></strong> 添加变更</li>
<li><strong><code>git commit -m "描述修改"</code></strong> 提交到本地</li>
<li><strong><code>git pull origin master</code></strong> （多人协作时先拉取最新代码，避免冲突）</li>
<li><strong><code>git push</code></strong> 推送到远程</li>
</ol>
<blockquote>
<p>🔄 使用 <code>git log</code> 可查看提交历史；<code>git diff</code> 查看未暂存的差异。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">十一、常见问题与注意事项</h3>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><code>fatal: not a git repository</code></td><td>未在 Git 仓库目录下执行命令，请先 <code>cd</code> 到项目根目录</td></tr><tr><td>推送失败：<code>remote rejected</code></td><td>远程仓库有更新，先 <code>git pull</code> 再推送</td></tr><tr><td>忘记配置用户信息</td><td>执行 <code>git config --global user.name/email</code> 补充</td></tr><tr><td>想删除远程关联</td><td><code>git remote remove origin</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">结语</h3>
<p>通过本文，你已掌握 Git 项目从零创建、本地提交到远程推送的完整流程。<code>lesson_zp</code> 不再是一个普通的文件夹，而是一个具备完整版本控制能力的智能代码库。无论你是独立开发者还是团队成员，Git 都能为你提供强大的代码管理保障。</p>
<blockquote>
<p><strong>记住：每一次有意义的 <code>commit</code>，都是你编程旅程中的一个里程碑。</strong></p>
</blockquote>
<p>未来，你可以进一步学习分支管理（<code>git branch</code>）、合并（<code>git merge</code>）、解决冲突、标签（<code>tag</code>）等高级功能，真正发挥 Git 的分布式优势。</p>
<p>现在，打开你的终端，开始你的第一个 Git 项目吧！🚀</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unity 轻量级UI层框架的设计]]></title>    <link>https://juejin.cn/post/7597905961663692806</link>    <guid>https://juejin.cn/post/7597905961663692806</guid>    <pubDate>2026-01-22T08:17:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597905961663692806" data-draft-id="7597619377429184566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unity 轻量级UI层框架的设计"/> <meta itemprop="keywords" content="前端,架构,Unity3D"/> <meta itemprop="datePublished" content="2026-01-22T08:17:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="跟着群主去吃肉"/> <meta itemprop="url" content="https://juejin.cn/user/224735056369213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unity 轻量级UI层框架的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224735056369213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    跟着群主去吃肉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:17:16.000Z" title="Thu Jan 22 2026 08:17:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>       我们可能接触过很多成熟的UI框架，例如MVC、MVP、MVVM等等，它们无一例外的都需要固定的代码格式，并尊重一定的规则才能应用起来。在当下市场的快速变化、开发效率要求较高的情况下，笨重的框架已经不适合项目的快速变化和目标要求。例如，在中轻度游戏、休闲类游戏或小游戏方面，要求的是快速研发、快速迭代、快速上线、快速试错，最后快速验证游戏是否有存在价值，从而快速调整各种战略，减少资源的浪费与提高生存发展的能力。</p>
<p>       一个游戏可能有50%的功能都可能与UI层有关，所以设计一个通用的、高效的、学习成本低的UI应用框架是必选项，下面我们就来设计一款轻量级的UI框架。</p>
<h3 data-id="heading-1">一、UI节点的设计</h3>
<p>       游戏的UI展现，通常是首先展现主界面，然后在主界面上打开或弹出各种新的页面，所以我们首先得定义几个节点：根节点、UI摄像机节点、底层节点、中层节点、顶层节点、弹窗节点，每个节点我们把它定义对应一个unity layer：Bottom,Middle,Top,Popup。这样定义设计的目的是方便我们后面对打开的各种UI对象进行有序的管理，例如UI的遮挡、事件的穿透和屏蔽等。节点我们可以把它设计成一个Prefab，把它放到Resouces文件夹中。Prefab的设计如下图所示：</p>
<p><img alt="" src="" loading="lazy"/></p>
<p>根节点上有一个脚本绑定，如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fd5072d8294505a2cd82002c2dbf49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lef552A576k5Li75Y675ZCD6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674636&amp;x-signature=j8fFZPT0VaXOSQezf1LN3RCSjU8%3D" alt="" loading="lazy"/></p>
<p>UI摄像机节点如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77cde895affc4401a6808852bbe52156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lef552A576k5Li75Y675ZCD6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674636&amp;x-signature=4SUH2TTtRFvDcRqKUyDx2PB1N7o%3D" alt="" loading="lazy"/></p>
<p>其它UI层级节点如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26aa57f5fb00413a9cf3a213e967c854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lef552A576k5Li75Y675ZCD6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674636&amp;x-signature=KKzQrc0XqqjB7Q7jm%2B7F%2BtaBTWQ%3D" alt="" loading="lazy"/></p>
<p>在UIRoot节点上的绑定脚本如下：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> UnityEngine.UI;

<span class="hljs-keyword">namespace</span> Simple.UI
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UICanvasBinder</span> : MonoBehaviour
    {
        <span class="hljs-keyword">public</span> Camera UICamera;
        <span class="hljs-keyword">public</span> RectTransform BottomCanvas;
        <span class="hljs-keyword">public</span> RectTransform MiddleCanvas;
        <span class="hljs-keyword">public</span> RectTransform TopCanvas;
        <span class="hljs-keyword">public</span> RectTransform PopupCavas;
        <span class="hljs-keyword">public</span> RectTransform U3DCavas;       
    }
}
</code></pre>
<h3 data-id="heading-2">二、UI核心框代码设计（角色）</h3>
<p>       UI框的代码，我们要尽量设计得简单，但又不失去“框架”的特性。我们把UI框架的角色简化为两个：中介者角色和视图呈现角色。中介者角色用来管理UI对象的加载、管理、销毁，视图呈现角色用来展现UI的元素以及应用逻辑。这样中介者角色的功能就相对明确和简单，它与UI业务无关，它只负责UI对象的生命周期和获取应用管理，与UI业务相关的功能都放在视图展现角色上。我们可以叫这个中介者角色为"UIContext"，视图呈现角色为"UIView"，它们的代码设计如下：</p>
<p>UIContext.cs:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> Simple.Asset;
<span class="hljs-keyword">using</span> System;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simple.UI</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UIContext</span> : <span class="hljs-title">MonoBehaviour</span>
    {        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> UILayer Layer { <span class="hljs-keyword">get</span>; }<span class="hljs-comment">//UI层枚举</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-built_in">string</span> AssetKey { <span class="hljs-keyword">get</span>; }<span class="hljs-comment">//UI资源的名称，prefab名称</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">bool</span> Cache { <span class="hljs-keyword">get</span>; } = <span class="hljs-literal">false</span>;     <span class="hljs-comment">//是否缓存</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">bool</span> AssetCache { <span class="hljs-keyword">get</span>; } = <span class="hljs-literal">true</span>;<span class="hljs-comment">//addressable中是否缓存, 根据需要可以舍弃此字段</span>
        <span class="hljs-keyword">public</span> UIView View { <span class="hljs-keyword">set</span>; <span class="hljs-keyword">get</span>; } <span class="hljs-comment">//UI呈现角色</span>
        <span class="hljs-keyword">private</span> AssetOwner _owner = <span class="hljs-keyword">new</span> AssetOwner();  <span class="hljs-comment">//此处是资源管理者，可换成适合你的组件。</span>
        

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span>
        {
            Init();
            SetLayer();            
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> GameObject <span class="hljs-title">LoadViewObject</span>()<span class="hljs-comment">//加载UI资源</span></span>
        {
            <span class="hljs-keyword">var</span> ah = _owner.Instantiate(AssetKey);<span class="hljs-comment">// 加载UI资源prefab，可换成其它组件</span>
            <span class="hljs-keyword">var</span> instance = ah.GetInstance();
            <span class="hljs-keyword">return</span> instance;

        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnloadViewObject</span>()<span class="hljs-comment">//卸载UI资源</span></span>
        {          
            <span class="hljs-keyword">if</span>(!AssetCache)
                _owner.ReleaseAll();  
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnClose</span>()</span> { }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRemoveFromCache</span>()</span> { }
        
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetLayer</span>()<span class="hljs-comment">//设置UI对象所在的节点，所在的节点代表也所在的层级</span></span>
        {
            UICanvasBinder mb = UIMgr.Instance.UIBinder;
            <span class="hljs-keyword">if</span> (Layer == UILayer.Bottom)
                transform.SetParent(mb.BottomCanvas, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Layer == UILayer.Middle)
                transform.SetParent(mb.MiddleCanvas, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Layer == UILayer.Top)
                transform.SetParent(mb.TopCanvas,<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Layer == UILayer.PopupBox)
                transform.SetParent(mb.PopupCavas, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Layer == UILayer.U3D)
                transform.SetParent(mb.U3DCavas);
        }
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Init</span>()</span>
        {                                                     
            <span class="hljs-keyword">var</span> viewObject = LoadViewObject();
            viewObject.name = UIUtility.GetUIViewTypeName(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">var</span> tv = UIUtility.GetUIViewType(<span class="hljs-keyword">this</span>);
            View =(UIView)viewObject.AddComponent(tv);                                                      
            View.OnInitCompleted();                              
            viewObject.transform.SetParent(transform, <span class="hljs-literal">false</span>);   
            viewObject.transform.localPosition = Vector3.zero;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>()<span class="hljs-comment">//显示UI是回调，提供给给业务层接口</span></span>
        {           
            View.OnShow();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T data</span>)</span>
        {
            View.OnShow(data);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>&gt;(<span class="hljs-params">T1 data1, T2 data2</span>)</span>
        {
            View.OnShow(data1, data2);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>&gt;(<span class="hljs-params">T1 data1, T2 data2, T3 data3</span>)</span>
        {
            View.OnShow(data1, data2, data3);
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>, <span class="hljs-title">T4</span>&gt;(<span class="hljs-params">T1 data1, T2 data2, T3 data3, T4 data4</span>)</span>
        {
            View.OnShow(data1, data2, data3, data4);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHide</span>()<span class="hljs-comment">//隐藏UI时回调</span></span>
        {
            View.OnHide();
        }
    }
}
</code></pre>
<p>UIView.cs:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Gamelogic;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> UnityEngine;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simple.UI</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> UILayer<span class="hljs-comment">//定义的UI层级</span>
    {
        Bottom,
        Middle,
        Top,
        PopupBox,
        U3D        
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UIView</span> : <span class="hljs-title">MonoBehaviour</span>
    {    
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitCompleted</span>()</span> { }<span class="hljs-comment">//初始化结束时</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>()</span> { }<span class="hljs-comment">//呈现时</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T data</span>)</span> { }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>&gt;(<span class="hljs-params">T1 data1, T2 data2</span>)</span> { }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>&gt;(<span class="hljs-params">T1 data1, T2 data2, T3 data3</span>)</span> { }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnShow</span>&lt;<span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>, <span class="hljs-title">T4</span>&gt;(<span class="hljs-params">T1 data1, T2 data2, T3 data3, T4 data4</span>)</span> { }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHide</span>()</span> { }<span class="hljs-comment">//隐藏时</span>
    }

}
</code></pre>
<p>UIContext.cs中用到了反射获取UIView的功能，反射相关的代码在UIUtility中，如下：</p>
<p>UIUtility.cs:</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Reflection;

<span class="hljs-keyword">namespace</span> Simple.UI
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> UIUtility
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">string</span> GetContextTypeFullName(UIContext context)
        {
            Type t = context.<span class="hljs-built_in">GetType</span>();
            <span class="hljs-type">string</span> cname = t.FullName.Replace(<span class="hljs-string">"Context"</span>,<span class="hljs-string">""</span>);
            <span class="hljs-keyword">return</span> cname;
        }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UIData GetUIDataInstance(UIContext context)
        {
            <span class="hljs-type">string</span> cname = GetUIDataTypeFullName(context);
            Type t = context.<span class="hljs-built_in">GetType</span>();
            <span class="hljs-keyword">return</span>  (UIData)t.<span class="hljs-keyword">Assembly</span>.CreateInstance(cname);
        }     
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">string</span> GetUIDataTypeFullName(UIContext context)
        {
            <span class="hljs-keyword">return</span> GetContextTypeFullName(context) + <span class="hljs-string">"Data"</span>;       
        }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">string</span> GetUIViewTypeFullName(UIContext context)
        {
            <span class="hljs-keyword">return</span> GetContextTypeFullName(context) + <span class="hljs-string">"View"</span>;      
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">string</span> GetUIViewTypeName(UIContext context)
        {
            Type t = GetUIViewType(context);
            <span class="hljs-keyword">return</span> t.Name;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Type GetUIDataType(UIContext context)
        {
            <span class="hljs-type">string</span> cname = GetUIDataTypeFullName(context);
            Type t = context.<span class="hljs-built_in">GetType</span>();
            <span class="hljs-keyword">return</span> t.<span class="hljs-keyword">Assembly</span>.<span class="hljs-built_in">GetType</span>(cname);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Type GetUIViewType(UIContext context)
        {
            <span class="hljs-type">string</span> cname = GetUIViewTypeFullName(context);
            Type t = context.<span class="hljs-built_in">GetType</span>();
            <span class="hljs-keyword">return</span> t.<span class="hljs-keyword">Assembly</span>.<span class="hljs-built_in">GetType</span>(cname);
        }        

    }
}
</code></pre>
<p>       至此，我们完成了UI框架中最主要的两个角色代码设计，但还不能让这个框架应用起来。</p>
<h3 data-id="heading-3">三、UI核心框代码设计（管理者）</h3>
<p>       我们虽然完成了两个框架角色的设计，但要用上它们，如何用得更好，还得一个管理者角色，这个就是UIMgr，它的代码如下：</p>
<p>UIMgr.cs:</p>
<pre><code class="hljs language-ini" lang="ini">using UnityEngine<span class="hljs-comment">;</span>
using System.Collections.Generic<span class="hljs-comment">;</span>

namespace Simple.UI
{

    public class UIMgr
    {
        private List&lt;UIContext&gt; <span class="hljs-attr">_contexts</span> = new List&lt;UIContext&gt;()<span class="hljs-comment">;//所有已打开的中介者</span>
        public Transform UIRoot { private set<span class="hljs-comment">; get; }//定义的根节点</span>
        public UICanvasBinder UIBinder { private set<span class="hljs-comment">; get; }</span>
       
        private static UIMgr _instance<span class="hljs-comment">;        </span>
        public static UIMgr Instance
        {
            get
            {
                if (<span class="hljs-attr">_instance</span> == null)
                {
                    <span class="hljs-attr">_instance</span> = new UIMgr()<span class="hljs-comment">;                    </span>
                }
                return _instance<span class="hljs-comment">;</span>
            }
        }

        public void Init()//初始化UI,一般在游戏开始时调用
        {
            GameObject <span class="hljs-attr">uiRoot</span> = GameObject.Find(<span class="hljs-string">"UIRoot"</span>)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">uiRoot</span> == null)
            {
                GameObject <span class="hljs-attr">go</span> = Resources.Load&lt;GameObject&gt;(<span class="hljs-string">"UICoreRes/UIRoot"</span>)<span class="hljs-comment">;//将定义好的UI节点加载到场景中</span>
                <span class="hljs-attr">uiRoot</span> = GameObject.Instantiate&lt;GameObject&gt;(go)<span class="hljs-comment">;</span>
                <span class="hljs-attr">uiRoot.name</span> = <span class="hljs-string">"UIRoot"</span><span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">UIRoot</span> = uiRoot.transform<span class="hljs-comment">;</span>
            <span class="hljs-attr">UIBinder</span> = uiRoot.GetComponent&lt;UICanvasBinder&gt;()<span class="hljs-comment">;        </span>
            GameObject.DontDestroyOnLoad(uiRoot)<span class="hljs-comment">;//注意，是夸场景使用，游戏不退出不销毁</span>
        }
    
        public bool Has&lt;T&gt;() where T : UIContext//
        {
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; _contexts.Count; i++)</span>
            {
                if (_contexts<span class="hljs-section">[i]</span>.GetType() == typeof(T))
                    return true<span class="hljs-comment">;</span>
            }
            return false<span class="hljs-comment">;</span>
        }

        public T Get&lt;T&gt;() where T : UIContext
        {
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; _contexts.Count; i++)</span>
            {
                if (_contexts<span class="hljs-section">[i]</span>.GetType() == typeof(T))
                    return _contexts<span class="hljs-section">[i]</span> as T<span class="hljs-comment">;</span>
            }
            return null<span class="hljs-comment">;</span>
        }

        private T Add&lt;T&gt;() where T : UIContext
        {
            T t<span class="hljs-comment">;</span>
            string <span class="hljs-attr">name</span> = typeof(T).Name<span class="hljs-comment">;</span>
            GameObject <span class="hljs-attr">go</span> = new GameObject(name)<span class="hljs-comment">;</span>
            <span class="hljs-attr">go.layer</span> = LayerMask.NameToLayer(<span class="hljs-string">"UI"</span>)<span class="hljs-comment">;//设置为统一标识层</span>
            RectTransform <span class="hljs-attr">rectTran</span> = go.AddComponent&lt;RectTransform&gt;()<span class="hljs-comment">;</span>
            <span class="hljs-attr">rectTran.sizeDelta</span> = new Vector2(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">rectTran.anchorMin</span> = new Vector2(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">rectTran.anchorMax</span> = new Vector2(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">t</span> = go.AddComponent&lt;T&gt;()<span class="hljs-comment">;//绑定上中价者角色</span>
            _contexts.Add(t)<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }

        public T Open&lt;T&gt;() where T : UIContext//打开中介者角色
        {
            T <span class="hljs-attr">t</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">t</span> == null)
                <span class="hljs-attr">t</span> = Add&lt;T&gt;()<span class="hljs-comment">;</span>
            else
            {
                if (!t.gameObject.activeSelf)
                    t.gameObject.SetActive(true)<span class="hljs-comment">;</span>
            }
            t.OnShow()<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }

        public T Open&lt;T, D&gt;(D data) where T : UIContext
        {
            T <span class="hljs-attr">t</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">t</span> == null)
                <span class="hljs-attr">t</span> = Add&lt;T&gt;()<span class="hljs-comment">;</span>
            else
            {
                if (!t.gameObject.activeSelf)
                    t.gameObject.SetActive(true)<span class="hljs-comment">;</span>
            }
            t.OnShow(data)<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }      

        public T Open&lt;T, D1,D2&gt;(D1 data1, D2 data2) where T : UIContext
        {
            T <span class="hljs-attr">t</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">t</span> == null)
                <span class="hljs-attr">t</span> = Add&lt;T&gt;()<span class="hljs-comment">;</span>
            else
            {
                if (!t.gameObject.activeSelf)
                    t.gameObject.SetActive(true)<span class="hljs-comment">;</span>
            }
            t.OnShow(data1, data2)<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }

        public T Open&lt;T, D1, D2, D3&gt;(D1 data1, D2 data2, D3 data3) where T : UIContext
        {
            T <span class="hljs-attr">t</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">t</span> == null)
                <span class="hljs-attr">t</span> = Add&lt;T&gt;()<span class="hljs-comment">;</span>
            else
            {
                if (!t.gameObject.activeSelf)
                    t.gameObject.SetActive(true)<span class="hljs-comment">;</span>
            }
            t.OnShow(data1, data2, data3)<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }

        public T Open&lt;T, D1, D2, D3, D4&gt;(D1 data1, D2 data2, D3 data3, D4 data4) where T : UIContext
        {
            T <span class="hljs-attr">t</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">t</span> == null)
                <span class="hljs-attr">t</span> = Add&lt;T&gt;()<span class="hljs-comment">;</span>
            else
            {
                if (!t.gameObject.activeSelf)
                    t.gameObject.SetActive(true)<span class="hljs-comment">;</span>
            }
            t.OnShow(data1, data2, data3, data4)<span class="hljs-comment">;</span>
            return t<span class="hljs-comment">;</span>
        }

        public void Close&lt;T&gt;() where T : UIContext//关闭中介者角色
        {
            T <span class="hljs-attr">context</span> = Get&lt;T&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">context</span> == null) return<span class="hljs-comment">;</span>
          
            context.OnClose()<span class="hljs-comment">;</span>
            if (!context.Cache)//没缓存的情况下直接卸载资源
            {
                context.OnHide()<span class="hljs-comment">;</span>
                _contexts.Remove(context)<span class="hljs-comment">;</span>
                context.OnRemoveFromCache()<span class="hljs-comment">;</span>
                context.UnloadViewObject()<span class="hljs-comment">;</span>
                GameObject.Destroy(context.gameObject)<span class="hljs-comment">;</span>
            }
            else
            {
                context.OnHide()<span class="hljs-comment">;</span>
                context.gameObject.SetActive(false)<span class="hljs-comment">;</span>
            }
        }

        public void DestroyAll()
        {
            foreach(var context in _contexts)
            {
                context.OnHide()<span class="hljs-comment">;           </span>
                context.OnRemoveFromCache()<span class="hljs-comment">;</span>
                context.UnloadViewObject()<span class="hljs-comment">;</span>
                GameObject.Destroy(context.gameObject)<span class="hljs-comment">;</span>
            }
            _contexts.Clear()<span class="hljs-comment">;</span>
        }

        public List&lt;UIContext&gt; GetOpenedContexts()
        {
            var <span class="hljs-attr">contexts</span> = new List&lt;UIContext&gt;()<span class="hljs-comment">;</span>
            foreach(var context in _contexts)
            {
                if(context.gameObject.activeSelf)
                    contexts.Add(context)<span class="hljs-comment">;</span>
            }
            return contexts<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p>       至此我们基本完成了一个基于Unity的轻量级UI层框架的核心研发。</p>
<h3 data-id="heading-4">四、如何使用</h3>
<p>       我们以一个Loading界面为例来说明如何使用这个框架。首先我们要建立两个角色类：LoadingContext.cs、LoadingView.cs，分别继续自UIContext和UIView，具体代码如下所示：</p>
<p>LoadingContext.cs:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> Simple.UI;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Gamelogic</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LoadingContext</span> : <span class="hljs-title">UIContext</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> UILayer Layer =&gt; UILayer.Bottom;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> AssetKey =&gt; <span class="hljs-string">"Pre_UI_Loading"</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> Cache =&gt; <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">new</span> LoadingView View { <span class="hljs-keyword">get</span> =&gt; (LoadingView)<span class="hljs-keyword">base</span>.View; <span class="hljs-keyword">set</span> =&gt; <span class="hljs-keyword">base</span>.View = <span class="hljs-keyword">value</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> GameObject <span class="hljs-title">LoadViewObject</span>()<span class="hljs-comment">//重写基类的加载逻辑，灵活控制</span></span>
        {
            <span class="hljs-comment">//return base.LoadViewObject();</span>

            <span class="hljs-keyword">var</span> ui = Resources.Load&lt;GameObject&gt;(<span class="hljs-string">$"Prefabs/Loading/<span class="hljs-subst">{AssetKey}</span>"</span>);<span class="hljs-comment">//从文件夹中加载UI对象</span>
            <span class="hljs-keyword">var</span> go = GameObject.Instantiate( ui );
            <span class="hljs-keyword">return</span> go;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnloadViewObject</span>()</span>
        {
            <span class="hljs-keyword">base</span>.UnloadViewObject();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnClose</span>()</span>
        {
            <span class="hljs-keyword">base</span>.OnClose();            
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRemoveFromCache</span>()</span>
        {
            <span class="hljs-keyword">base</span>.OnRemoveFromCache();
            
        }
    }
}
</code></pre>
<p>LoadingView.cs:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> UnityEngine.UI;
<span class="hljs-keyword">using</span> Simple.UI;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System;


<span class="hljs-keyword">namespace</span> <span class="hljs-title">Gamelogic</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LoadingView</span> : <span class="hljs-title">UIView</span>
    {     
        <span class="hljs-keyword">private</span> UIGetter _getter;
        <span class="hljs-keyword">private</span> Slider _sldLoading;
        <span class="hljs-keyword">private</span> Text _txtVersion;
        <span class="hljs-keyword">private</span> Text _txtNum;

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span>
        {
           <span class="hljs-comment">//获取prefab的UI控件</span>
             _getter = GetComponent&lt;UIGetter&gt;();
            _sldLoading = _getter.GetElement(<span class="hljs-string">"sldLoading"</span>).GetComponent&lt;Slider&gt;();
            _txtVersion = _getter.GetElement(<span class="hljs-string">"txtVersion"</span>).GetComponent&lt;Text&gt;();
            _txtNum = _getter.GetElement(<span class="hljs-string">"txtNum"</span>).GetComponent&lt;Text&gt;();
            _txtVersion.text = <span class="hljs-string">$"v<span class="hljs-subst">{Application.version}</span>"</span>;         
        }      

        <span class="hljs-comment">//数据的来源，可以交给第三方或在类中实现</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateLoading</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> percent</span>)</span>
        {
            <span class="hljs-keyword">if</span> (_sldLoading != <span class="hljs-literal">null</span>)
                _sldLoading.<span class="hljs-keyword">value</span> = percent;
            <span class="hljs-keyword">if</span> (_txtNum != <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">var</span> p = (<span class="hljs-built_in">int</span>)(percent * <span class="hljs-number">100</span>);
                <span class="hljs-keyword">if</span>(p &gt; <span class="hljs-number">100</span>)
                    p = <span class="hljs-number">100</span>;
                _txtNum.text = <span class="hljs-string">$"<span class="hljs-subst">{p}</span>%"</span>;
            }
        }     

    }
}
</code></pre>
<p>        接着，我们在打开UI时，必须先初始化UI框架，最好是在游戏戏启动的时候初始化，代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">using</span> Simple.UI;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Gamelogic</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameSetting</span> : <span class="hljs-title">MonoBehaviour</span>
    {       
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span>
        {           
            DontDestroyOnLoad(<span class="hljs-keyword">this</span>.gameObject);
            DontDestroyOnLoad(GameObject.Find(<span class="hljs-string">"EventSystem"</span>));
           
            UIMgr.Instance.Init(); <span class="hljs-comment">//初始化UI框架         </span>
        }
        <span class="hljs-comment">// Use this for initialization</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span>
        {
            <span class="hljs-keyword">var</span> loadingUI = UIMgr.Instance.Open&lt;LoadingContext&gt;();<span class="hljs-comment">//打开Loading界面</span>
            loadingUI.View.UpdateLoading(<span class="hljs-number">0.1f</span>);<span class="hljs-comment">//更新界面</span>
            <span class="hljs-comment">//UIMgr.Instance.Close&lt;LoadingContext&gt;();//关闭loading界面</span>
        }

        <span class="hljs-comment">// Update is called once per frame</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span>
        {

        }

       
    }
}
</code></pre>
<h3 data-id="heading-5">五、总结</h3>
<p>       总的来说，这个UI层框架只有三个角色：管理者、中介者、呈现者。这三个角色变动最频繁的应该是呈现者角色，主要体现在UI的设计、布局和更新换代方面。换句话说，开发人员大部分的时间都是专注于UIView的子类开发上。开发人员可以直接继续沿用Unity的相关功能，并不需要写中间件，例如启用协程。至于数据的存储、呈现操作部分，完全是交给另外的模块按需实现，然后提供相关的API供UIView调用即可，或者是直接在UIView的子类中实现也可。具体的操作按项目的实际情况而定。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Celery 介绍]]></title>    <link>https://juejin.cn/post/7598005428258357311</link>    <guid>https://juejin.cn/post/7598005428258357311</guid>    <pubDate>2026-01-22T08:47:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428258357311" data-draft-id="7597968460652232746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Celery 介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T08:47:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户120825743993"/> <meta itemprop="url" content="https://juejin.cn/user/3950988158578939"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Celery 介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3950988158578939/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户120825743993
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:47:21.000Z" title="Thu Jan 22 2026 08:47:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、Celery 介绍</h2>
<p>Celery 大致有两种应用场景：<strong>异步任务</strong> 和 <strong>定时任务</strong>。</p>
<h4 data-id="heading-1">1. 异步任务</h4>
<p>假设在一个接口请求中，某个任务的执行时间非常长，而前端页面并不需要立刻获取处理结果。在这种情况下，可以将这个任务作为 <strong>异步任务</strong>，先返回给前端一个“处理中”的信息，然后在后台单独运行这个任务，任务执行完成后再返回结果。</p>
<h4 data-id="heading-2">2. 定时任务</h4>
<p>例如某个任务需要每天晚上运行一次，而我们不可能每天都手动执行这个任务。可以使用 Celery 来实现这个定时任务的周期性执行，例如设置每天晚上十点执行某个函数。</p>
<h3 data-id="heading-3">Celery 的组成</h3>
<p>Celery 主要由以下组件组成：</p>
<h4 data-id="heading-4">1. Task (任务)</h4>
<p><strong>Task</strong> 是指异步任务或定时任务，可以通过 Celery 定义和管理。这些任务可以被发送到 <strong>Broker</strong> 进行处理。</p>
<h4 data-id="heading-5">2. Broker (消息中间件)</h4>
<p><strong>Broker</strong> 可以理解为消息中间件，它的作用是获取异步任务或定时任务，并将这些任务加入消息队列中。然后，消息队列将任务发送给 <strong>Worker</strong> 进行处理。</p>
<ul>
<li>常见的 <strong>Broker</strong> 实现有：<strong>Redis</strong>、<strong>RabbitMQ</strong> 或者其他消息中间件。</li>
<li>在这个例子中，我们使用 <strong>Redis</strong> 作为消息中间件。</li>
</ul>
<h4 data-id="heading-6">3. Worker (工作进程)</h4>
<p><strong>Worker</strong> 是实际执行任务的程序。它从 <strong>Broker</strong> 中获取任务，并在 <strong>Worker</strong> 中执行相应的操作。执行完成后，根据配置，结果会被发送到 <strong>Backend</strong> 进行存储。</p>
<h4 data-id="heading-7">4. Result Backend (结果存储)</h4>
<p>当任务执行完毕后，<strong>Worker</strong> 会将任务结果存储到 <strong>Result Backend</strong> 中。无论任务有无返回结果，都会根据配置将结果发送到指定的存储位置。常见的 <strong>Result Backend</strong> 有：</p>
<ul>
<li>Redis</li>
<li>数据库（如 PostgreSQL、MySQL）</li>
<li>文件系统等</li>
</ul>
<h4 data-id="heading-8">5. Beat (定时任务调度器)</h4>
<p><strong>Beat</strong> 主要用于定时任务的调度。根据预定的时间规则（如每天晚上十点），它会将 <strong>Task</strong> 发送给 <strong>Broker</strong>，然后 <strong>Worker</strong> 获取并执行任务。定时任务可以分为两类：</p>
<ul>
<li><strong>周期任务</strong>：例如每天固定时间执行某个任务。</li>
<li><strong>间隔任务</strong>：例如每隔一定时间（如每 10 分钟）执行一次任务。</li>
</ul>
<h4 data-id="heading-9">6. 异步任务 vs 定时任务</h4>
<ul>
<li><strong>异步任务</strong>：异步任务的发送不经过 <strong>Beat</strong>，直接发送到 <strong>Broker</strong>，然后由 <strong>Worker</strong> 执行。</li>
<li><strong>定时任务</strong>：定时任务则由 <strong>Celery Beat</strong> 调度，依照预定时间发送给 <strong>Broker</strong>，由 <strong>Worker</strong> 执行。</li>
</ul>
<h3 data-id="heading-10">配置与运行</h3>
<p>在 Celery 中，<strong>Broker</strong>（例如 Redis）需要启动并运行，以便 <strong>Beat</strong> 和 <strong>Worker</strong> 能够访问和处理任务。</p>
<ul>
<li><strong>Worker</strong> 和 <strong>Beat</strong> 都需要通过手动启动程序来运行。</li>
<li>每次修改定时任务的配置后，需要重新启动 <strong>Beat</strong> 和 <strong>Worker</strong> 才能使更改生效。</li>
</ul>
<h3 data-id="heading-11">典型流程</h3>
<ol>
<li><strong>定义任务</strong>（Task），并发送给 <strong>Broker</strong>。</li>
<li><strong>Beat</strong> 根据设定的定时任务规则（周期性或间隔性）触发任务，将任务发送到 <strong>Broker</strong>。</li>
<li><strong>Worker</strong> 从 <strong>Broker</strong> 中获取任务并执行。</li>
<li>执行结果根据配置存储到 <strong>Result Backend</strong>。</li>
</ol>
<h3 data-id="heading-12">注意事项</h3>
<ul>
<li><strong>异步任务</strong>不经过 <strong>Beat</strong>，直接由 <strong>Worker</strong> 执行。</li>
<li><strong>定时任务</strong>则由 <strong>Celery Beat</strong> 调度，确保任务按照预定时间触发。</li>
<li>更改定时任务配置后，需要重新启动 <strong>Beat</strong> 和 <strong>Worker</strong> 才能使更改生效。</li>
</ul>
<h2 data-id="heading-13">2、Celery 准备</h2>
<p>接下来，我们将实现一个最简单的异步任务，在执行异步任务之前，我们需要做以下准备工作：</p>
<h3 data-id="heading-14">1. 安装依赖</h3>
<p>我们需要安装 Celery 和 Redis 的依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip3 install celery -i https://mirrors.aliyun.com/pypi/simple/
pip3 install redis -i https://mirrors.aliyun.com/pypi/simple/
</code></pre>
<h5 data-id="heading-15">2. 消息中间件 这里我们使用的消息中间件是 Redis，可以去官网下载安装 Redis，也可以使用 Docker 来执行安装：</h5>
<pre><code class="hljs language-bash" lang="bash">docker run -itd -p 6379:6379 redis:latest
</code></pre>
<h5 data-id="heading-16">3. 异步任务准备 准备一个最简单的 <code>add()</code> 函数，放在 <code>tasks.py</code> 文件中：</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># tasks.py</span>
<span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery

app = Celery(<span class="hljs-string">'tasks'</span>, broker=<span class="hljs-string">'redis://localhost/0'</span>, backend=<span class="hljs-string">'redis://localhost/0'</span>)

<span class="hljs-meta">@app.task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>):
    <span class="hljs-keyword">return</span> x + y
</code></pre>
<p>在这段代码里，我们引入了 Celery 模块，并将其实例化为 app，且设置了 broker 参数，表示消息队列的第二个数据源是 Redis。</p>
<p>在这段代码里，我们引入 <strong>Celery</strong> 模块，并将其实例化为 <code>app</code>，且配置了 <code>broker</code> 参数，表示消息队列将被放在 <strong>Redis</strong> 的第一个数据库下。</p>
<p>指定的 <code>backend</code> 参数则表示函数运行的结果被存储在 <strong>Redis</strong> 的第二个数据库下。</p>
<p>然后用 <code>@app.task</code> 修饰 <code>add</code> 函数，表示它是 <code>app</code> 下的任务（task）。</p>
<p>以上，我们的准备工作就完成了，接下来尝试执行这个异步任务。</p>
<h2 data-id="heading-17">3、 Celery 启动和异步任务的运行</h2>
<p>说是 Celery 的启动，其实是 <strong>Worker</strong> 的启动，中间件是 <strong>Redis</strong>，已经在前面的步骤中启动了。</p>
<p>我们在 <code>tasks.py</code> 所在的文件夹下执行下面的命令：</p>
<pre><code class="hljs language-bash" lang="bash">celery -A tasks worker -l INFO
</code></pre>
<p>在这里，<code>tasks</code> 是我们任务所在的文件名，<code>worker</code> 表示启动的是 <strong>Worker</strong> 程序。</p>
<p><code>-INFO</code> 则会在控制台打印出 Worker 接收到的消息详情，如果不执行该参数，则信息流不会被打印出来。</p>
<p>执行了上面的程序后，可以看到控制台会输出下面这种信息：</p>
<pre><code class="hljs language-bash" lang="bash">-------------- celery@localhost v5.1.2 (sun-harmonics)
--- ***** ----
-- ******** -- Darwin-21.4.0-x86_64-i386-64bit 2022-07-17 23:56:09
--*** --- * ---
- ** -------- [config]
- ** ---------- -&gt; app: tasks:0x7f8c8ddf3d98
- ** ---------- -&gt; transport: redis://localhost:6379/0
- ** ---------- -&gt; results: disabled://
- ** --- * ---- -&gt; concurrency: 12 (prefork)
 - ** --------- -&gt; task events: OFF (<span class="hljs-built_in">enable</span> -E to monitor tasks <span class="hljs-keyword">in</span> this worker)
--- ***** ----
-------------- [queues]
  - -&gt; celery exchange=celery(direct) key=celery

[tasks]
  . tasks.add

[2022-07-17 23:56:09,685: INFO/MainProcess] Connected to redis://localhost:6379/0
[2022-07-17 23:56:09,699: INFO/MainProcess] mingle: searching <span class="hljs-keyword">for</span> neighbors
[2022-07-17 23:56:10,731: INFO/MainProcess] mingle: all alone
[2022-07-17 23:56:10,737: INFO/MainProcess] celery@localhost ready.

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3实战：纯CSS+JS实现高级透视效果]]></title>    <link>https://juejin.cn/post/7598005428258340927</link>    <guid>https://juejin.cn/post/7598005428258340927</guid>    <pubDate>2026-01-22T08:47:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428258340927" data-draft-id="7597811700284932115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3实战：纯CSS+JS实现高级透视效果"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-22T08:47:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmartNorth"/> <meta itemprop="url" content="https://juejin.cn/user/2101921964108136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3实战：纯CSS+JS实现高级透视效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921964108136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmartNorth
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:47:01.000Z" title="Thu Jan 22 2026 08:47:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日浏览小米MiMo官网时，被其顶部的透视跟随动画深深吸引——鼠标移动时，文字矩阵伴随遮罩动态变化，营造出极强的视觉层次感和交互趣味性。出于技术探索目的，我基于Vue3复刻了这一效果，下文将从组件结构、核心算法、性能优化三方面，拆解完整实现逻辑，助力大家快速落地到项目中。</p>
<h2 data-id="heading-0">效果演示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/208b58dde8744675acd472644485ed17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU21hcnROb3J0aA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676421&amp;x-signature=47wUPinnroCdepvg3TbWAAAIzro%3D" alt="效果图.gif" loading="lazy"/></p>
<h2 data-id="heading-1">1. 功能概述</h2>
<p>本组件是一款聚焦视觉交互的顶部区组件，核心实现「鼠标透视跟随」效果：通过双层文字矩阵叠加+动态CSS遮罩，让上层内容随鼠标轨迹弹性形变，模拟现实中的透视景深，打破传统静态标题的沉闷感。</p>
<h2 data-id="heading-2">2. 组件结构与DOM设计</h2>
<h3 data-id="heading-3">2.1 模板结构</h3>
<p>采用「静态底层+动态上层」的双层视觉结构，通过CSS绝对定位实现图层叠加，既保证初始状态的视觉完整性，又能让交互效果精准作用于上层，不干扰底层基础展示。两层分工明确，具体如下：</p>























<table><thead><tr><th>图层</th><th>类名</th><th>内容</th><th>功能</th></tr></thead><tbody><tr><td>底层</td><td><code>.z-1</code></td><td>中文标题 "你好，世界！" 和灰色 "HELLO" 文字矩阵</td><td>静态背景展示</td></tr><tr><td>上层</td><td><code>.z-2</code></td><td>英文标题 "Hello , World!" 和白色 "HELLO" 文字矩阵</td><td>鼠标交互时的动态效果层</td></tr></tbody></table>
<h3 data-id="heading-4">2.2 核心 DOM 结构</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;div class="container" @mouseenter="onMouseEnter" @mouseleave="onMouseLeave" @mousemove="onMouseMove"&gt;
  &lt;!-- 底层内容 --&gt;
  &lt;div class="z-1"&gt;
    &lt;div class="line" v-for="line in 13"&gt;
      &lt;span class="line-item" v-for="item in 13"&gt;HELLO&lt;/span&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;h1 class="title-1"&gt;你好，世界！&lt;/h1&gt;
  
  &lt;!-- 上层交互内容 --&gt;
  &lt;div class="z-2" :style="{ 'clip-path': circleClipPath }"&gt;
    &lt;div class="hidden-div"&gt;
      &lt;div class="line" v-for="line in 13"&gt;
        &lt;span class="line-item" v-for="item in 13"&gt;HELLO&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;h1 class="title-2"&gt;Hello , World!&lt;/h1&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<blockquote>
<p>关键说明：hidden-div用于包裹上层文字矩阵，配合.z-2的定位规则，确保遮罩效果精准覆盖；两层文字矩阵尺寸一致，保证视觉对齐，增强透视沉浸感。</p>
</blockquote>
<h2 data-id="heading-5">3. 技术实现</h2>
<h3 data-id="heading-6">3.1 核心功能模块</h3>
<h4 data-id="heading-7">3.1.1 轨迹点系统</h4>
<p>轨迹点系统是实现平滑鼠标跟随效果的核心，通过维护6个轨迹点的位置信息，创建出具有弹性延迟的跟随动画。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 轨迹点系统 </span>
<span class="hljs-keyword">const</span> trailSystem = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">targetX</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">targetY</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">trailPoints</span>: <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })),
  <span class="hljs-attr">animationId</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">isInside</span>: <span class="hljs-literal">false</span>
});
</code></pre>
<blockquote>
<p>设计思路：6个轨迹点是兼顾流畅度与性能的平衡值——点太少则拖尾效果不明显，点太多则增加计算开销，配合递减阻尼系数，实现“头快尾慢”的自然跟随。</p>
</blockquote>
<h4 data-id="heading-8">3.1.2 动态 Clip-Path 计算</h4>
<p>通过计算鼠标位置和轨迹点的关系，动态生成 <code>clip-path</code> CSS 属性值，实现跟随鼠标的圆形/椭圆形遮罩效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 计算clip-path值，使用参考算法实现弹性动画</span>
<span class="hljs-keyword">const</span> circleClipPath = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!showCircle.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'circle(0px at -300px -300px)'</span>; <span class="hljs-comment">// 完全隐藏状态</span>
  }

  <span class="hljs-comment">// 复制轨迹系统数据进行计算</span>
  <span class="hljs-keyword">const</span> system = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(trailSystem.<span class="hljs-property">value</span>));
  
  <span class="hljs-comment">// 更新轨迹点</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> t = <span class="hljs-number">0</span>; t &lt; <span class="hljs-number">6</span>; t++) {
    <span class="hljs-keyword">const</span> prevX = t === <span class="hljs-number">0</span> ? system.<span class="hljs-property">targetX</span> : system.<span class="hljs-property">trailPoints</span>[t - <span class="hljs-number">1</span>].<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> prevY = t === <span class="hljs-number">0</span> ? system.<span class="hljs-property">targetY</span> : system.<span class="hljs-property">trailPoints</span>[t - <span class="hljs-number">1</span>].<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> damping = <span class="hljs-number">0.7</span> - <span class="hljs-number">0.04</span> * t; <span class="hljs-comment">// 阻尼系数，后面的点移动更慢</span>
    
    <span class="hljs-keyword">const</span> deltaX = prevX - system.<span class="hljs-property">trailPoints</span>[t].<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> deltaY = prevY - system.<span class="hljs-property">trailPoints</span>[t].<span class="hljs-property">y</span>;
    
    <span class="hljs-comment">// 平滑插值</span>
    system.<span class="hljs-property">trailPoints</span>[t].<span class="hljs-property">x</span> += deltaX * damping;
    system.<span class="hljs-property">trailPoints</span>[t].<span class="hljs-property">y</span> += deltaY * damping;
  }
  
  <span class="hljs-comment">// 获取第一个点（头部）和最后一个点（尾部）</span>
  <span class="hljs-keyword">const</span> head = system.<span class="hljs-property">trailPoints</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> tail = system.<span class="hljs-property">trailPoints</span>[<span class="hljs-number">5</span>];
  
  <span class="hljs-keyword">const</span> diffX = head.<span class="hljs-property">x</span> - tail.<span class="hljs-property">x</span>;
  <span class="hljs-keyword">const</span> diffY = head.<span class="hljs-property">y</span> - tail.<span class="hljs-property">y</span>;
  <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(diffX * diffX + diffY * diffY);
  
  <span class="hljs-keyword">let</span> clipPathValue = <span class="hljs-string">''</span>;
  
  <span class="hljs-keyword">if</span> (distance &lt; <span class="hljs-number">10</span>) { <span class="hljs-comment">// 如果距离很近，显示圆形</span>
    clipPathValue = <span class="hljs-string">`circle(200px at <span class="hljs-subst">${head.x}</span>px <span class="hljs-subst">${head.y}</span>px)`</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 创建椭圆形的polygon，连接头尾两点</span>
    <span class="hljs-keyword">const</span> angle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">atan2</span>(diffY, diffX); <span class="hljs-comment">// 连接角度</span>
    <span class="hljs-keyword">const</span> points = [];
    
    <span class="hljs-comment">// 从头部开始，画半个椭圆</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">30</span>; i++) {
      <span class="hljs-keyword">const</span> theta = angle - <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * i / <span class="hljs-number">30</span>;
      <span class="hljs-keyword">const</span> x = head.<span class="hljs-property">x</span> + <span class="hljs-number">200</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta);
      <span class="hljs-keyword">const</span> y = head.<span class="hljs-property">y</span> + <span class="hljs-number">200</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta);
      points.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${x}</span>px <span class="hljs-subst">${y}</span>px`</span>);
    }
    
    <span class="hljs-comment">// 从尾部开始，画另半个椭圆</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">30</span>; i++) {
      <span class="hljs-keyword">const</span> theta = angle + <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * i / <span class="hljs-number">30</span>;
      <span class="hljs-keyword">const</span> x = tail.<span class="hljs-property">x</span> + <span class="hljs-number">200</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta);
      <span class="hljs-keyword">const</span> y = tail.<span class="hljs-property">y</span> + <span class="hljs-number">200</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta);
      points.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${x}</span>px <span class="hljs-subst">${y}</span>px`</span>);
    }
    
    clipPathValue = <span class="hljs-string">`polygon(<span class="hljs-subst">${points.join(<span class="hljs-string">', '</span>)}</span>)`</span>;
  }
  
  <span class="hljs-keyword">return</span> clipPathValue;
});
</code></pre>
<h4 data-id="heading-9">3.1.3 鼠标事件处理</h4>
<p>实现了完整的鼠标交互逻辑，包括鼠标进入、离开和移动时的状态管理和动画控制。</p>

























<table><thead><tr><th>事件</th><th>处理函数</th><th>功能</th></tr></thead><tbody><tr><td>mouseenter</td><td>onMouseEnter</td><td>激活交互效果，初始化轨迹点</td></tr><tr><td>mouseleave</td><td>onMouseLeave</td><td>停用交互效果，重置轨迹点</td></tr><tr><td>mousemove</td><td>onMouseMove</td><td>更新目标点位置，驱动动画</td></tr></tbody></table>
<h2 data-id="heading-10">4. 技术亮点</h2>
<h3 data-id="heading-11">4.1 轨迹点系统算法</h3>
<p><strong>核心原理</strong>：使用6个轨迹点，每个点跟随前一个点移动，并应用不同的阻尼系数，实现平滑的拖尾效果。</p>
<p><strong>技术优势</strong>：</p>
<ul>
<li>实现了自然的物理运动效果，比简单的线性跟随更具视觉吸引力</li>
<li>通过阻尼系数的递减，创建出层次感和深度感</li>
<li>算法复杂度低，性能消耗小，适合实时交互场景</li>
</ul>
<h3 data-id="heading-12">4.2 动态 Clip-Path 技术</h3>
<p><strong>核心原理</strong>：利用CSS clip-path属性的动态特性，结合轨迹点位置计算，实时生成不规则遮罩，替代Canvas/SVG的图形绘制方案，用更轻量化的方式实现复杂视觉效果。</p>
<p><strong>技术优势</strong>：</p>
<ul>
<li>无依赖轻量化：无需引入任何图形库，纯CSS+JS即可实现，减少项目依赖体积，降低集成成本</li>
<li>平滑过渡无卡顿：通过数值插值计算，实现圆形与椭圆形遮罩的无缝切换，无帧断裂感，视觉连贯性强</li>
<li>渲染性能优化：配合 <code>will-change: clip-path</code> 提示浏览器，提前分配渲染资源，减少重排重绘，提升动画流畅度</li>
</ul>
<h2 data-id="heading-13">5. 性能优化</h2>
<ol>
<li>
<p><strong>渲染性能</strong>：</p>
<ul>
<li>使用 <code>will-change: clip-path</code> 提示浏览器优化渲染</li>
<li>合理使用 Vue 的响应式系统，避免不必要的重计算</li>
</ul>
</li>
<li>
<p><strong>事件处理</strong>：</p>
<ul>
<li>仅在鼠标在容器内时更新目标点位置，减少计算量</li>
<li>鼠标离开时停止动画，释放资源</li>
</ul>
</li>
<li>
<p><strong>动画性能</strong>：</p>
<ul>
<li>使用 <code>requestAnimationFrame</code> 实现流畅的动画效果</li>
<li>鼠标离开时取消动画帧请求，避免内存泄漏</li>
</ul>
</li>
</ol>
<h2 data-id="heading-14">6. 总结与扩展</h2>
<p>本次复刻的小米MiMo透视动画，核心价值在于“用简单技术组合实现高级视觉效果”——无需复杂图形库，仅依托Vue3响应式能力与CSS clip-path属性，就能打造出兼具质感与性能的交互组件。其核心亮点可概括为三点：</p>
<ul>
<li>交互创新：轨迹点系统与动态clip-path结合，打破传统静态标题的交互边界，带来自然流畅的鼠标跟随体验</li>
<li>视觉精致：双层文字矩阵的分层设计，配合遮罩形变，营造出兼具深度感与品牌性的视觉效果</li>
<li>性能可控：轻量化技术方案+多维度优化策略，在保证视觉效果的同时，兼顾页面性能与可维护性</li>
</ul>
<h3 data-id="heading-15">扩展方向</h3>
<p>该组件的实现思路可灵活迁移至其他场景：</p>
<ul>
<li>弹窗过渡动画：将clip-path遮罩用于弹窗进入/退出效果，实现不规则形状的过渡动画。</li>
<li>滚动动效：结合滚动事件替换鼠标事件，实现页面滚动时的元素透视跟随效果。</li>
<li>移动端适配：增加触摸事件支持，将鼠标交互替换为触摸滑动，适配移动端场景。</li>
</ul>
<blockquote>
<p>欢迎大家留言交流更多优化思路～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pipecat 小白入门教程]]></title>    <link>https://juejin.cn/post/7597989474991636518</link>    <guid>https://juejin.cn/post/7597989474991636518</guid>    <pubDate>2026-01-22T08:47:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991636518" data-draft-id="7597979278240284681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pipecat 小白入门教程"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-22T08:47:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海边捡石子"/> <meta itemprop="url" content="https://juejin.cn/user/2335828265144488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pipecat 小白入门教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335828265144488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    海边捡石子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:47:05.000Z" title="Thu Jan 22 2026 08:47:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Pipecat 小白入门教程</h2>
<blockquote>
<p>本教程结合项目代码与官方 pipecat 文档，帮助你快速理解 Pipecat 的核心流程、输入捕捉、共享变量、Flow 管理与启动方式。</p>
</blockquote>
<hr/>
<p><strong>pipeca</strong>t作为专注实时交互的Python框架，其核心优势在于将复杂的多模态处理拆解为模块化组。</p>
<ul>
<li>接入层：支持WebRTC、WebSocket等多种传输协议</li>
<li>处理层：提供语音编解码、文本处理、图像渲染等基础能力</li>
<li>服务层：集成Anthropic、Deepgram等50+ AI服务</li>
</ul>
<h3 data-id="heading-1">1. 核心概念（先理解整体结构）</h3>
<h4 data-id="heading-2">Pipeline（处理管道）</h4>
<p>数据从输入到输出依次经过多个处理器（Processor），你可以理解为一条“处理流水线”。</p>
<pre><code class="hljs language-makefile" lang="makefile">pipeline = Pipeline(
    [
        transport.input(),          <span class="hljs-comment"># 输入（音频/文本）</span>
        rtvi,                       <span class="hljs-comment"># RTVI 协议处理器</span>
        stt,                        <span class="hljs-comment"># 语音识别</span>
        user_input_store_processor, <span class="hljs-comment"># 存储用户输入</span>
        context_aggregator.user(),  <span class="hljs-comment"># 用户上下文聚合</span>
        llm,                        <span class="hljs-comment"># 大语言模型</span>
        tts,                        <span class="hljs-comment"># 语音合成</span>
        transport.output(),         <span class="hljs-comment"># 输出</span>
        context_aggregator.assistant(),
    ]
)
</code></pre>
<h4 data-id="heading-3">PipelineTask（运行任务）</h4>
<p>负责启动 Pipeline 并发出 StartFrame / EndFrame。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">task</span> = PipelineTask(
    pipeline,
    <span class="hljs-attr">params</span>=PipelineParams(allow_interruptions=<span class="hljs-literal">True</span>),
)
</code></pre>
<h4 data-id="heading-4">FlowManager（流程控制器）</h4>
<p>负责节点流转、工具注册、上下文更新与跳转逻辑。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">flow_manager</span> = FlowManager(
    <span class="hljs-attr">task</span>=task,
    <span class="hljs-attr">llm</span>=llm,
    <span class="hljs-attr">context_aggregator</span>=context_aggregator,
    <span class="hljs-attr">transport</span>=transport,
)
</code></pre>
<h4 data-id="heading-5">PipelineRunner（运行器）</h4>
<p>启动任务并维持会话运行。</p>
<pre><code class="hljs language-scss" lang="scss">runner = <span class="hljs-built_in">PipelineRunner</span>(handle_sigint=runner_args.handle_sigint)
await runner<span class="hljs-selector-class">.run</span>(task)
</code></pre>
<hr/>
<h3 data-id="heading-6">2. Transport 重要原理</h3>
<p>Transport 是客户端与服务端通信的核心层，负责：</p>
<ul>
<li>设备管理（麦克风/摄像头）</li>
<li>音视频推拉流</li>
<li>会话生命周期管理</li>
</ul>
<h4 data-id="heading-7">Transport 生命周期（官方状态机）</h4>
<p>Transport 会经历以下状态：</p>
<ol>
<li>Disconnected</li>
<li>Initializing</li>
<li>Initialized</li>
<li>Authenticating</li>
<li>Authenticated</li>
<li>Connecting</li>
<li>Connected</li>
<li>Ready</li>
<li>Disconnecting</li>
<li>Error</li>
</ol>
<p>在 SmallWebRTC 测试页面中，只有当状态进入 <strong>Ready</strong>，才能正常进行语音/文本交互。<br/>
官方说明参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.pipecat.ai%2Fclient%2Fjs%2Ftransports%2Ftransport" target="_blank" title="https://docs.pipecat.ai/client/js/transports/transport" ref="nofollow noopener noreferrer">docs.pipecat.ai/client/js/t…</a></p>
<hr/>
<h3 data-id="heading-8">3. 前端参数传递路径（/start vs /api/offer）</h3>
<p>SmallWebRTC 测试页面的 <strong>默认参数最终进入 <code>runner_args.body</code> 的路径是 <code>/api/offer</code> 的 <code>request_data</code></strong>。</p>
<h4 data-id="heading-9">关键结论</h4>
<ul>
<li><code>/start</code> 用于 session 初始化（创建 sessionId、ICE 配置）</li>
<li><code>/api/offer</code> 才会把 <code>request_data</code> 写入 <code>runner_args.body</code></li>
</ul>
<p>所以如果你需要把默认参数传给后端，请确保注入到 <code>/api/offer</code>。</p>
<hr/>
<h3 data-id="heading-10">4. 捕捉用户输入（文本 + 语音）</h3>
<h4 data-id="heading-11">文本输入</h4>
<p>SmallWebRTC UI 发送 <code>send-text</code>，会生成 <code>InputTransportMessageFrame</code>。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">isinstance</span><span class="hljs-params">(frame, InputTransportMessageFrame)</span>:
    message =</span> frame.message
    <span class="hljs-keyword">if</span> message.<span class="hljs-built_in">get</span>(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"send-text"</span>:
        text = message[<span class="hljs-string">"data"</span>][<span class="hljs-string">"content"</span>]
</code></pre>
<h4 data-id="heading-12">语音输入</h4>
<p>语音经过 STT 后输出 <code>TranscriptionFrame</code>。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">isinstance</span><span class="hljs-params">(frame, TranscriptionFrame)</span>:
    text =</span> frame.text
</code></pre>
<hr/>
<h3 data-id="heading-13">5. 将用户输入写入共享变量（flow_manager.state）</h3>
<p>使用 <code>flow_manager.state</code> 存储用户每次输入：</p>
<pre><code class="hljs language-scss" lang="scss">flow_manager<span class="hljs-selector-class">.state</span><span class="hljs-selector-class">.setdefault</span>("user_inputs", [])
flow_manager<span class="hljs-selector-class">.state</span><span class="hljs-selector-attr">[<span class="hljs-string">"user_inputs"</span>]</span><span class="hljs-selector-class">.append</span>({"text": text})
flow_manager<span class="hljs-selector-class">.state</span><span class="hljs-selector-attr">[<span class="hljs-string">"last_user_input"</span>]</span> = text
</code></pre>
<p>在函数 handler 中读取：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">last_input</span> = flow_manager.state.get(<span class="hljs-string">"last_user_input"</span>, <span class="hljs-string">""</span>)
<span class="hljs-attr">history</span> = flow_manager.state.get(<span class="hljs-string">"user_inputs"</span>, [])
</code></pre>
<hr/>
<h3 data-id="heading-14">6. 会话开始传入默认参数</h3>
<h4 data-id="heading-15">前端（api/offer）参数结构</h4>
<pre><code class="hljs language-css" lang="css">{
  "<span class="hljs-selector-tag">body</span>": {
    "init_string": <span class="hljs-string">"患者ID=12345"</span>,
    <span class="hljs-string">"speech_meta"</span>: {"name": <span class="hljs-string">"lyq"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">31</span>}
  }
}
</code></pre>
<h4 data-id="heading-16">后端读取方式</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">init_body</span> = runner_args.body or {}
<span class="hljs-attr">init_string</span> = init_body.get(<span class="hljs-string">"init_string"</span>)
<span class="hljs-attr">speech_meta</span> = init_body.get(<span class="hljs-string">"speech_meta"</span>, {})
</code></pre>
<h4 data-id="heading-17">✅ 写入上下文或共享变量</h4>
<pre><code class="hljs language-css" lang="css">flow_manager<span class="hljs-selector-class">.state</span><span class="hljs-selector-attr">[<span class="hljs-string">"init_string"</span>]</span> = init_string
context<span class="hljs-selector-class">.add_message</span>({"role": <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: f<span class="hljs-string">"初始化参数：{init_string}"</span>})
</code></pre>
<hr/>
<h3 data-id="heading-18">7. Flow 分支教程（条件跳转）</h3>
<p>Flow 的分支逻辑靠 <strong>handler 返回 (result, next_node)</strong> 。</p>
<pre><code class="hljs language-sql" lang="sql">async def handle_choose_pizza(args, flow_manager):
    <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> pizza_info()
    if <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">result</span>, create_confirm_node()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">result</span>, create_pizza_task_node()
</code></pre>
<h4 data-id="heading-19">原理解释</h4>
<ul>
<li>FlowManager 读取 handler 返回的 next_node</li>
<li>自动调用 <code>_set_node()</code> 完成上下文更新 + 工具注册</li>
<li>然后触发下一轮 LLM</li>
</ul>
<hr/>
<h3 data-id="heading-20">8. 自定义组件扩展原理</h3>
<p>Pipecat 的核心抽象是 <strong>FrameProcessor</strong>。<br/>
所有组件都遵循：</p>
<blockquote>
<p><strong>拦截 Frame → 处理 → push_frame 下传</strong></p>
</blockquote>
<p>组件分为三类：</p>

























<table><thead><tr><th>组件类型</th><th>继承基类</th><th>作用</th></tr></thead><tbody><tr><td>通用处理器</td><td><code>FrameProcessor</code></td><td>自定义帧处理</td></tr><tr><td>AI 服务</td><td><code>STTService / TTSService / LLMService</code></td><td>与模型交互</td></tr><tr><td>Transport</td><td><code>BaseTransport</code></td><td>推拉流</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-21">9. 自定义 RTC Transport 实战（简化示例）</h3>
<p>如果你要接入第三方 RTC（Agora / 腾讯 / 网易），只需实现 <code>input()</code> / <code>output()</code>：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRTCTransport</span>(<span class="hljs-title class_">BaseTransport</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, <span class="hljs-symbol">params:</span> <span class="hljs-title class_">TransportParams</span>, rtc_client</span>):
        <span class="hljs-variable language_">super</span>().__init__()
        <span class="hljs-variable language_">self</span>._input = <span class="hljs-title class_">CustomRTCInput</span>(params, rtc_client)
        <span class="hljs-variable language_">self</span>._output = <span class="hljs-title class_">CustomRTCOutput</span>(params, rtc_client)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">input</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._input

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">output</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._output
</code></pre>
<h4 data-id="heading-22">原理</h4>
<p>Transport 只负责：</p>
<ul>
<li>接收外部音视频 → 转换为 Frame</li>
<li>将 Frame 输出回外部推流<br/>
不会直接处理 LLM 或 Flow 逻辑。</li>
</ul>
<hr/>
<h3 data-id="heading-23">11. 核心流程总结（一句话）</h3>
<blockquote>
<p><strong>Pipeline 负责数据流，FlowManager 负责节点流转，Transport 负责推拉流。</strong></p>
</blockquote>
<p>官方 Transport 文档参考：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.pipecat.ai%2Fclient%2Fjs%2Ftransports%2Ftransport" target="_blank" title="https://docs.pipecat.ai/client/js/transports/transport" ref="nofollow noopener noreferrer">docs.pipecat.ai/client/js/t…</a>
<span href="https://code.juejin.cn/pen/7598103989657944098" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7598103989657944098" data-src="https://code.juejin.cn/pen/7598103989657944098" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 `std::condition_variable` 到 futex：我如何用源码真正理解条件变量（condvar）]]></title>    <link>https://juejin.cn/post/7598005428258242623</link>    <guid>https://juejin.cn/post/7598005428258242623</guid>    <pubDate>2026-01-22T08:35:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428258242623" data-draft-id="7598005428258078783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 `std::condition_variable` 到 futex：我如何用源码真正理解条件变量（condvar）"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2026-01-22T08:35:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="肆忆_"/> <meta itemprop="url" content="https://juejin.cn/user/3898194938326714"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 `std::condition_variable` 到 futex：我如何用源码真正理解条件变量（condvar）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898194938326714/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    肆忆_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:35:58.000Z" title="Thu Jan 22 2026 08:35:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我并不是要背 API，我要通过源码把“条件变量到底是怎么保证语义”的底层逻辑捋清楚。学习路径仍然是三层链路：<strong>libstdc++ → glibc(pthread) → futex syscall（Linux 内核）</strong>。</p>
<p>核心问题：</p>
<ul>
<li>为什么 <code>wait</code> 必须配合 mutex？</li>
<li>为什么一定要写 <code>while (predicate)</code>？</li>
<li>futex 不 FIFO，condvar 是怎么保证“不丢信号”的？</li>
<li>wait 到底在等什么地址？signal/broadcast 到底投放的是什么？</li>
<li>我写的那把 mutex 在 wait 内部是什么时候解锁、什么时候重新加锁？</li>
</ul>
<hr/>
<h2 data-id="heading-0">1）C++ 层：<code>condition_variable</code> 的语义（while 谓词）与委托</h2>
<h3 data-id="heading-1">1.1 谓词版本为啥是 while？</h3>
<p>libstdc++ 的头文件实现里，谓词版本就是 while 循环。醒来不代表条件成立，所以必须循环检查共享状态（在 mutex 保护下）。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// libstdc++: include/std/condition_variable（节选）</span>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Predicate&gt;
<span class="hljs-type">void</span> <span class="hljs-title">wait</span><span class="hljs-params">(unique_lock&lt;mutex&gt;&amp; __lock, _Predicate __p)</span>
</span>{
  <span class="hljs-keyword">while</span> (!__p())
    <span class="hljs-built_in">wait</span>(__lock);
}
</code></pre>
<h3 data-id="heading-2">1.2 <code>condition_variable::wait/notify_*</code> 本质是委托</h3>
<p>真正执行的工作交给 <code>_M_cond</code>（下一层）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// libstdc++: src/c++11/condition_variable.cc（节选）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">condition_variable::wait</span><span class="hljs-params">(unique_lock&lt;mutex&gt;&amp; __lock)</span>
</span>{
  _M_cond.<span class="hljs-built_in">wait</span>(*__lock.<span class="hljs-built_in">mutex</span>());
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">condition_variable::notify_one</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span>
</span>{
  _M_cond.<span class="hljs-built_in">notify_one</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">condition_variable::notify_all</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span>
</span>{
  _M_cond.<span class="hljs-built_in">notify_all</span>();
}
</code></pre>
<h3 data-id="heading-3">1.3 <code>_M_cond</code> → gthread → pthread_cond_*</h3>
<p>libstdc++ 的内部 <code>__condvar</code> 封装，POSIX 下映射到 pthread：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// libstdc++: include/bits/std_mutex.h（节选）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">__condvar</span>
{
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait</span><span class="hljs-params">(mutex&amp; __m)</span>
  </span>{
    <span class="hljs-type">int</span> __e = __gthread_cond_wait(&amp;_M_cond, __m.<span class="hljs-built_in">native_handle</span>());
    __glibcxx_assert(__e == <span class="hljs-number">0</span>);
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notify_one</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span>
  </span>{
    <span class="hljs-type">int</span> __e = __gthread_cond_signal(&amp;_M_cond);
    __glibcxx_assert(__e == <span class="hljs-number">0</span>);
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notify_all</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span>
  </span>{
    <span class="hljs-type">int</span> __e = __gthread_cond_broadcast(&amp;_M_cond);
    __glibcxx_assert(__e == <span class="hljs-number">0</span>);
  }
};
</code></pre>
<p>结论：C++ 层只提供语义（尤其是 while 谓词）和调用路径；“如何等待/唤醒”的算法在 glibc。</p>
<hr/>
<h2 data-id="heading-4">2）condvar 的职责（它不是“条件”，它是“等待/通知通道”）</h2>
<ul>
<li>条件本身由共享状态（predicate）表达；检查必须在同一把 mutex 保护下完成；</li>
<li>condvar 的职责是：让线程在条件不满足时能<strong>释放 mutex 并阻塞</strong>；条件可能满足时由其他线程通知唤醒，再去<strong>重新持有 mutex</strong>并检查 predicate。</li>
</ul>
<p>因此典型模式才是：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lk</span><span class="hljs-params">(m)</span></span>;
cv.<span class="hljs-built_in">wait</span>(lk, [&amp;]{ <span class="hljs-keyword">return</span> predicate; }); <span class="hljs-comment">// while-predicate 语义</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">3）glibc 的关键思想：不是“一把 futex”，而是“序列号 + 两组(G1/G2) + 每组一个 futex word”</h2>
<p>futex 唤醒不保证 FIFO，只有 32bit 字，容易 ABA。condvar 的语义要求 signal/broadcast 在并发下仍然正确（不丢进展），所以 glibc 采用了更强的用户态协议：</p>
<ul>
<li>64bit waiter 序列号 <code>__wseq</code>（每个 waiter 发号）</li>
<li>两组槽位 G1/G2（每组一个 futex word：<code>__g_signals[0/1]</code>）</li>
<li><code>g1_start</code>（当前 G1 覆盖区间的起点边界，切换时推进）</li>
</ul>
<p>这套协议保证：<strong>谁有资格消费 signal</strong>（而不是靠唤醒顺序），从而规避 futex 非 FIFO 的问题。</p>
<hr/>
<h2 data-id="heading-6">4）<code>pthread_cond_wait</code>：先登记 waiter，再解锁用户 mutex，再决定睡不睡</h2>
<p>这是避免丢信号的关键顺序。节选如下（删去无关错误处理）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// glibc: nptl/pthread_cond_wait.c（节选）</span>

<span class="hljs-comment">/* 获取 waiter 序列号 wseq（每次 +2）；最低位是当前 G2 槽位 */</span>
<span class="hljs-type">uint64_t</span> wseq = __condvar_fetch_add_wseq_acquire (cond, <span class="hljs-number">2</span>);
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> g = wseq &amp; <span class="hljs-number">1</span>;    <span class="hljs-comment">// 当前绑定到的 G2 槽位(0/1)</span>
<span class="hljs-type">uint64_t</span> seq = wseq &gt;&gt; <span class="hljs-number">1</span>;     <span class="hljs-comment">// 我在 waiter 序列中的序号</span>

<span class="hljs-comment">/* waiter 引用计数 +1（用于销毁/生命周期等） */</span>
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags = atomic_fetch_add_relaxed (&amp;cond-&gt;__data.__wrefs, <span class="hljs-number">8</span>);
<span class="hljs-type">int</span> private = __condvar_get_private (flags);

<span class="hljs-comment">/* 关键点：先登记，再解锁这把 mutex（避免丢信号） */</span>
err = __pthread_mutex_unlock_usercnt (mutex, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>) { <span class="hljs-comment">/* 取消等待等清理路径 */</span> }
</code></pre>
<p>这正是你关心的那点：</p>
<ul>
<li>从 <code>std::unique_lock&lt;std::mutex&gt; lk(m);</code> 开始一直是同一把 <code>m</code>；</li>
<li>只有在完成“登记为 waiter”（发号/计数）之后，才解锁这把用户 mutex；<strong>中间没有换锁也没有提前解锁</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">5）waiter 在等什么？不是等“cond 对象”，而是等 <code>__g_signals[g]</code> 这个地址</h2>
<p>进入等待循环后，waiter 的策略是：<strong>先尝试消费信号（纯用户态 CAS），消费不到才 futex_wait</strong>。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// glibc: nptl/pthread_cond_wait.c（节选）</span>

<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
{
  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> signals
    = atomic_load_acquire (cond-&gt;__data.__g_signals + g);
  <span class="hljs-type">uint64_t</span> g1_start = __condvar_load_g1_start_relaxed (cond);

  <span class="hljs-comment">/* A) “关闭组”判断：若 seq &lt; g1_start，则不应继续睡在旧地址 */</span>
  <span class="hljs-keyword">if</span> (seq &lt; g1_start)
    <span class="hljs-keyword">break</span>;

  <span class="hljs-comment">/* B) 若存在可消费信号，CAS 消费一个并返回（消费失败就重试） */</span>
  <span class="hljs-keyword">if</span> ((<span class="hljs-type">int</span>)(signals - (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)g1_start) &gt; <span class="hljs-number">0</span>)
  {
    <span class="hljs-keyword">if</span> (atomic_compare_exchange_weak_acquire (
          cond-&gt;__data.__g_signals + g,
          &amp;signals, signals - <span class="hljs-number">1</span>))
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">continue</span>;
  }

  <span class="hljs-comment">/* C) 没信号才真正阻塞：在 __g_signals[g] 这个地址上 futex 等待 */</span>
  err = __futex_abstimed_wait_cancelable64(
          cond-&gt;__data.__g_signals + g, <span class="hljs-comment">// uaddr</span>
          signals,                      <span class="hljs-comment">// expected</span>
          clockid, abstime, private);
}
</code></pre>
<p>要点：</p>
<ul>
<li><code>__g_signals[g]</code> 即是 futex word 地址，也是 signal 投放信号的目标；</li>
<li><code>seq &lt; g1_start</code> 表示我属于“已关闭的旧批次”，不应再睡在旧地址，应该结束 wait 阶段并回去抢 mutex（符合 condvar 虚假唤醒语义）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">6）<code>pthread_cond_signal</code>：投放信号 + 唤醒睡在“当前 G1 槽位地址”的一个 waiter</h2>
<p>signal 的核心逻辑（删去无关部分）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// glibc: nptl/pthread_cond_signal.c（节选）</span>

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> wrefs = atomic_load_relaxed (&amp;cond-&gt;__data.__wrefs);
<span class="hljs-keyword">if</span> (wrefs &gt;&gt; <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

<span class="hljs-type">int</span> private = __condvar_get_private (wrefs);
__condvar_acquire_lock (cond, private);

<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> wseq = __condvar_load_wseq_relaxed (cond);
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> g1 = (wseq &amp; <span class="hljs-number">1</span>) ^ <span class="hljs-number">1</span>; <span class="hljs-comment">// 当前 G1 槽位（与 G2 槽位相反）</span>
wseq &gt;&gt;= <span class="hljs-number">1</span>;

<span class="hljs-type">bool</span> do_futex_wake = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">if</span> ((cond-&gt;__data.__g_size[g1] != <span class="hljs-number">0</span>)
    || __condvar_switch_g1 (cond, wseq, &amp;g1, private))
{
  atomic_fetch_add_relaxed (cond-&gt;__data.__g_signals + g1, <span class="hljs-number">1</span>); <span class="hljs-comment">// 投放信号</span>
  cond-&gt;__data.__g_size[g1]--;
  do_futex_wake = <span class="hljs-literal">true</span>;
}

__condvar_release_lock (cond, private);

<span class="hljs-keyword">if</span> (do_futex_wake)
  futex_wake (cond-&gt;__data.__g_signals + g1, <span class="hljs-number">1</span>, private); <span class="hljs-comment">// 唤醒一个</span>
</code></pre>
<p>要点：</p>
<ul>
<li>signal 不保证 FIFO，它只保证“让某个 waiter 有机会醒来”；真正能否返回由 waiter 的 CAS（消费信号）决定；</li>
<li>condvar 的资格判定由 G1/G2 + <code>g1_start</code> 维持，不依赖唤醒顺序。</li>
</ul>
<hr/>
<h2 data-id="heading-9">7）<code>pthread_cond_broadcast</code>：对两组都投足够信号并 wake 全部</h2>
<p>逻辑是“对旧 G1 全发 → 切换 → 对新 G1 全发”，然后 <code>wake(INT_MAX)</code> 一次性唤醒所有在对应地址上睡着的 waiter。此处略代码（原理与上面一致）。</p>
<hr/>
<h2 data-id="heading-10">8）<code>g1_start</code> 怎么更新？只在“组切换 <code>__condvar_switch_g1</code>”时推进</h2>
<p>这就是“关闭组”的落地：推进边界，发布新 G2 槽位，初始化新 G1 的 <code>__g_signals</code>。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// glibc: nptl/pthread_cond_common.c（节选）</span>

<span class="hljs-comment">/* 关闭当前 G1：__g1_start += old_orig_size */</span>
__condvar_add_g1_start_relaxed (cond, old_orig_size);

<span class="hljs-comment">/* 发布组切换：翻转 __wseq 的最低位，宣告新的 G2 槽位 */</span>
wseq = __condvar_fetch_xor_wseq_release (cond, <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>;
g1 ^= <span class="hljs-number">1</span>;
*g1index ^= <span class="hljs-number">1</span>;

<span class="hljs-comment">/* 初始化新 G1 的 g_signals 到 new_g1_start（有效可消费信号为 0） */</span>
atomic_store_release (cond-&gt;__data.__g_signals + g1, (<span class="hljs-type">unsigned</span>)new_g1_start);
</code></pre>
<p>这确保：</p>
<ul>
<li>被切走的旧批次 waiter 不再阻塞在旧地址（<code>seq &lt; g1_start</code> break）；</li>
<li>新批次 waiter 在新槽位作为 G2 等待，必要时切 G1 继续投信号。</li>
</ul>
<hr/>
<h2 data-id="heading-11">9）futex 系统调用：只要真的需要阻塞，就一定进入内核</h2>
<p>wait 真阻塞那一步就是 futex syscall，常用 <code>FUTEX_WAIT_BITSET</code>（支持绝对超时）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// glibc: nptl/futex-internal.c（节选）</span>
<span class="hljs-type">int</span> __futex_abstimed_wait_cancelable64 (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>* futex_word,
                                        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> expected,
                                        <span class="hljs-type">clockid_t</span> clockid,
                                        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> __timespec64* abstime,
                                        <span class="hljs-type">int</span> private)
{
  <span class="hljs-comment">// 构造 op（包含 FUTEX_WAIT_BITSET 与 private/clock 位）</span>
  <span class="hljs-comment">// 最终发起 INTERNAL_SYSCALL_CANCEL(futex_time64, ...)</span>
  ...
}
</code></pre>
<p>结论：不一定“每次都 syscall”（如果能消费到信号就不用阻塞）；但<strong>只要真的需要等待阻塞，就一定会进入内核 futex</strong>。</p>
<hr/>
<h2 data-id="heading-12">10）我最后的总结</h2>
<ul>
<li><code>std::condition_variable</code> 本身不实现等待算法；谓词版本使用 <code>while (pred)</code>，醒来后必须在同一把 mutex 保护下再次检查 predicate。</li>
<li>glibc 的 condvar 用“<strong>序列号 <code>wseq</code> + 两组(G1/G2) + 边界 <code>g1_start</code> + 两个 futex word <code>__g_signals[2]</code></strong>”的用户态协议，在 futex 非 FIFO 的现实下仍能保证 signal/broadcast 的语义正确、不丢进展。</li>
<li>waiter 的关键顺序是：<strong>先登记为 waiter（拿号/计数）→ 再解锁这把用户 mutex</strong>；随后循环“消费信号（CAS）/futex 等待”。这恰恰是为避免丢信号而设计的。</li>
<li>signal 优先给当前 G1 投放信号；必要时切换（推进 <code>g1_start</code> 关闭旧批次、翻转 <code>wseq</code> 发布新 G2槽位）；然后对对应 <code>__g_signals[g1]</code> 做 <code>futex_wake</code>。</li>
<li>不保证 FIFO；“可控”的关键是：返回前<strong>重新持有同一把 mutex</strong>，由上层 <code>while (!pred) wait()</code> 决定是否继续等待。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NFS Subdir Provisioner 实现K8S动态PV供应]]></title>    <link>https://juejin.cn/post/7598005428258390079</link>    <guid>https://juejin.cn/post/7598005428258390079</guid>    <pubDate>2026-01-22T08:48:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428258390079" data-draft-id="7597905961663889414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NFS Subdir Provisioner 实现K8S动态PV供应"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T08:48:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="opsmaster"/> <meta itemprop="url" content="https://juejin.cn/user/2140102571593625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NFS Subdir Provisioner 实现K8S动态PV供应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2140102571593625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    opsmaster
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:48:42.000Z" title="Thu Jan 22 2026 08:48:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>本文转载自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9w_PN7dLQtMmGekagHz8AA" target="_blank" title="https://mp.weixin.qq.com/s/9w_PN7dLQtMmGekagHz8AA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/9w_PN7dLQ…</a></strong></p>
</blockquote>
<blockquote>
<p>原生 NFS + NFS Subdir External Provisioner，这是 K8S 社区最主流的方案 ——原生 NFS 服务器提供存储能力，NFS Subdir Provisioner 实现 K8S 动态 PV 供应，能自动为每个 PVC 创建专属 NFS 子目录（避免多 PVC 数据混叠），部署简单、维护成本低，适合 90% 的中小规模 K8S 集群，部署以Ubuntu24为例。</p>
</blockquote>
<h3 data-id="heading-0">搭建K8S后端存储的NFS服务器流程</h3>
<p>首先了解当前服务器的存储情况和环境配置。</p>
<h4 data-id="heading-1">第一步：检查存储设备情况</h4>
<ol>
<li>查看磁盘列表：</li>
</ol>
<pre><code class="hljs">lsblk
</code></pre>
<blockquote>
<p>识别到新设备（如<code>/dev/sdb</code>），未分区、未格式化。</p>
</blockquote>
<ol start="2">
<li>确认磁盘详情：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo fdisk -l /dev/sdb
</code></pre>
<blockquote>
<p>确认<code>/dev/sdb</code>是未分区的新磁盘。</p>
</blockquote>
<h4 data-id="heading-2">第二步：准备数据盘</h4>
<p>（步骤：创建分区 → 格式化文件系统 → 创建挂载点并挂载）</p>
<ol>
<li>创建磁盘分区：</li>
</ol>
<pre><code class="hljs language-swift" lang="swift">echo <span class="hljs-operator">-</span>e <span class="hljs-string">"n<span class="hljs-subst">\n</span>p<span class="hljs-subst">\n</span>1<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>w"</span> <span class="hljs-operator">|</span> sudo fdisk <span class="hljs-operator">/</span>dev<span class="hljs-operator">/</span>sdb
</code></pre>
<ol start="2">
<li>格式化文件系统（ext4）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo mkfs.ext4 /dev/sdb1
</code></pre>
<ol start="3">
<li>创建挂载点：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> /nfs-storage
</code></pre>
<ol start="4">
<li>挂载分区到挂载点：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo mount /dev/sdb1 /nfs-storage
</code></pre>
<ol start="5">
<li>配置开机自动挂载：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">tee</span> -a /etc/fstab &lt;&lt;<span class="hljs-string">EOF
/dev/sdb1 /nfs-storage ext4 defaults 0 0
EOF</span>
</code></pre>
<ol start="6">
<li>验证挂载情况：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">df</span> -h /nfs-storage
</code></pre>
<blockquote>
<p>显示<code>/dev/sdb1</code>已挂载到<code>/nfs-storage</code>即成功。</p>
</blockquote>
<h4 data-id="heading-3">第三步：安装NFS服务器</h4>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span> <span class="hljs-operator">&amp;&amp;</span> sudo apt install <span class="hljs-operator">-</span>y nfs<span class="hljs-operator">-</span>kernel<span class="hljs-operator">-</span>server
</code></pre>
<h4 data-id="heading-4">第四步：配置NFS共享</h4>
<ol>
<li>创建NFS共享目录结构：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /nfs-storage/k8s-pvs
</code></pre>
<ol start="2">
<li>修改共享目录权限：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">chown</span> nobody:nogroup /nfs-storage/k8s-pvs &amp;&amp; sudo <span class="hljs-built_in">chmod</span> 777 /nfs-storage/k8s-pvs
</code></pre>
<ol start="3">
<li>配置<code>/etc/exports</code>（NFS共享规则）： （注：原直接编辑文件失败，改用<code>tee</code>命令）</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">sudo tee /etc/exports &lt;&lt;'EOF'
<span class="hljs-meta prompt_">#</span><span class="bash"> /etc/exports: the access control list <span class="hljs-keyword">for</span> filesystems <span class="hljs-built_in">which</span> may be exported</span>
<span class="hljs-meta prompt_">#</span><span class="bash">               to NFS clients.  See exports(5).</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># Example for NFSv2 and NFSv3:</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"> /srv/homes       hostname1(rw,<span class="hljs-built_in">sync</span>,no_subtree_check) hostname2(ro,<span class="hljs-built_in">sync</span>,no_subtree_check)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># Example for NFSv4:</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"> /srv/nfs4        gss/krb5i(rw,<span class="hljs-built_in">sync</span>,fsid=0,crossmnt,no_subtree_check)</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> /srv/nfs4/homes  gss/krb5i(rw,<span class="hljs-built_in">sync</span>,no_subtree_check)</span>
/nfs-storage/k8s-pvs *(rw,sync,no_subtree_check,no_root_squash,fsid=0)
EOF
</code></pre>
<h4 data-id="heading-5">第五步：启动和配置NFS服务</h4>
<ol>
<li>重启NFS服务：</li>
</ol>
<pre><code class="hljs language-vbscript" lang="vbscript">sudo systemctl restart nfs-kernel-<span class="hljs-built_in">server</span>
</code></pre>
<ol start="2">
<li>设置NFS服务开机自启：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl <span class="hljs-built_in">enable</span> nfs-kernel-server
</code></pre>
<ol start="3">
<li>验证NFS共享配置：</li>
</ol>
<pre><code class="hljs">sudo exportfs -v
</code></pre>
<h4 data-id="heading-6">第六步：配置防火墙（如果需要）</h4>
<ol>
<li>检查防火墙状态：</li>
</ol>
<pre><code class="hljs language-lua" lang="lua">sudo ufw <span class="hljs-built_in">status</span>
</code></pre>
<blockquote>
<p>若防火墙未启用，则无需额外配置。</p>
</blockquote>
<h4 data-id="heading-7">第七步：测试NFS共享</h4>
<ol>
<li>本地创建测试挂载点并挂载NFS：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /tmp/test-nfs &amp;&amp; sudo mount -t nfs localhost:/nfs-storage/k8s-pvs /tmp/test-nfs
</code></pre>
<ol start="2">
<li>写入测试文件验证：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">df</span> -h /tmp/test-nfs &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"NFS测试成功"</span> | sudo <span class="hljs-built_in">tee</span> /tmp/test-nfs/test.txt
</code></pre>
<ol start="3">
<li>卸载测试挂载点并清理：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo umount /tmp/test-nfs &amp;&amp; sudo <span class="hljs-built_in">rmdir</span> /tmp/test-nfs
</code></pre>
<h4 data-id="heading-8">第八步：创建NFS Subdir Provisioner所需目录</h4>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /nfs-storage/k8s-pvs/.nfs-provisioner &amp;&amp; sudo <span class="hljs-built_in">chown</span> nobody:nogroup /nfs-storage/k8s-pvs/.nfs-provisioner
</code></pre>
<h4 data-id="heading-9">第九步：验证最终配置</h4>
<p>（示例：检查共享目录权限）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -ld /nfs-storage/k8s-pvs
</code></pre>
<h4 data-id="heading-10">第十步：生成K8S部署配置文件（<code>nfs-provisioner-deployment.yaml</code>）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># NFS Subdir External Provisioner Deployment for K8S</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">ServiceAccount</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner</span>
  <span class="hljs-string">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">ClusterRole</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-string">-</span> <span class="hljs-string">apiGroups:</span> [<span class="hljs-string">""</span>]
    <span class="hljs-string">resources:</span> [<span class="hljs-string">"persistentvolumes"</span>]
    <span class="hljs-string">verbs:</span> [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"delete"</span>]
  <span class="hljs-string">-</span> <span class="hljs-string">apiGroups:</span> [<span class="hljs-string">""</span>]
    <span class="hljs-string">resources:</span> [<span class="hljs-string">"persistentvolumeclaims"</span>]
    <span class="hljs-string">verbs:</span> [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"update"</span>]
  <span class="hljs-string">-</span> <span class="hljs-string">apiGroups:</span> [<span class="hljs-string">"storage.k8s.io"</span>]
    <span class="hljs-string">resources:</span> [<span class="hljs-string">"storageclasses"</span>]
    <span class="hljs-string">verbs:</span> [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
  <span class="hljs-string">-</span> <span class="hljs-string">apiGroups:</span> [<span class="hljs-string">""</span>]
    <span class="hljs-string">resources:</span> [<span class="hljs-string">"events"</span>]
    <span class="hljs-string">verbs:</span> [<span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">ClusterRoleBinding</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">run-nfs-client-provisioner</span>
<span class="hljs-attr">subjects:</span>
  <span class="hljs-string">-</span> <span class="hljs-string">kind:</span> <span class="hljs-string">ServiceAccount</span>
    <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner</span>
    <span class="hljs-string">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">roleRef:</span>
  <span class="hljs-string">kind:</span> <span class="hljs-string">ClusterRole</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span>
  <span class="hljs-string">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">Role</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span>
  <span class="hljs-string">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-string">-</span> <span class="hljs-string">apiGroups:</span> [<span class="hljs-string">"coordination.k8s.io"</span>]
    <span class="hljs-string">resources:</span> [<span class="hljs-string">"leases"</span>]
    <span class="hljs-string">verbs:</span> [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">RoleBinding</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span>
<span class="hljs-attr">subjects:</span>
  <span class="hljs-string">-</span> <span class="hljs-string">kind:</span> <span class="hljs-string">ServiceAccount</span>
    <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner</span>
    <span class="hljs-string">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">roleRef:</span>
  <span class="hljs-string">kind:</span> <span class="hljs-string">Role</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span>
  <span class="hljs-string">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner</span>
  <span class="hljs-string">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-string">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-string">app:</span> <span class="hljs-string">nfs-client-provisioner</span>
  <span class="hljs-attr">strategy:</span>
    <span class="hljs-string">type:</span> <span class="hljs-string">Recreate</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-string">app:</span> <span class="hljs-string">nfs-client-provisioner</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-string">serviceAccountName:</span> <span class="hljs-string">nfs-client-provisioner</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-provisioner</span>
          <span class="hljs-string">image:</span> <span class="hljs-string">registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span>
          <span class="hljs-attr">volumeMounts:</span>
            <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-root</span>
              <span class="hljs-string">mountPath:</span> <span class="hljs-string">/persistentvolumes</span>
          <span class="hljs-attr">env:</span>
            <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">PROVISIONER_NAME</span>
              <span class="hljs-string">value:</span> <span class="hljs-string">k8s-sigs.io/nfs-subdir-external-provisioner</span>
            <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">NFS_SERVER</span>
              <span class="hljs-string">value:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.9</span><span class="hljs-number">.2</span>  <span class="hljs-comment"># 替换为你的NFS服务器IP</span>
            <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">NFS_PATH</span>
              <span class="hljs-string">value:</span> <span class="hljs-string">/nfs-storage/k8s-pvs</span>
      <span class="hljs-attr">volumes:</span>
        <span class="hljs-string">-</span> <span class="hljs-string">name:</span> <span class="hljs-string">nfs-client-root</span>
          <span class="hljs-attr">nfs:</span>
            <span class="hljs-string">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.9</span><span class="hljs-number">.2</span>  <span class="hljs-comment"># 替换为你的NFS服务器IP</span>
            <span class="hljs-string">path:</span> <span class="hljs-string">/nfs-storage/k8s-pvs</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">StorageClass</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">nfs-storage</span>
<span class="hljs-string">provisioner:</span> <span class="hljs-string">k8s-sigs.io/nfs-subdir-external-provisioner</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-string">archiveOnDelete:</span> <span class="hljs-string">"true"</span>
<span class="hljs-string">reclaimPolicy:</span> <span class="hljs-string">Delete</span>
<span class="hljs-string">allowVolumeExpansion:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-11">完成总结</h3>
<h4 data-id="heading-12">已完成的核心配置</h4>
<ol>
<li>
<p><strong>存储准备</strong>：</p>
<ul>
<li>识别并分区格式化新磁盘（<code>/dev/sdb</code>）</li>
<li>格式化为<code>ext4</code>文件系统</li>
<li>创建<code>/nfs-storage</code>挂载目录</li>
<li>配置开机自动挂载</li>
</ul>
</li>
<li>
<p><strong>NFS服务器</strong>：</p>
<ul>
<li>安装<code>nfs-kernel-server</code>服务</li>
<li>创建NFS共享目录（<code>/nfs-storage/k8s-pvs</code>）</li>
<li>配置<code>/etc/exports</code>允许所有客户端访问（权限：<code>rw,sync,no_subtree_check,no_root_squash,fsid=0</code>）</li>
<li>启动并设置NFS服务开机自启</li>
<li>本地挂载测试验证</li>
</ul>
</li>
</ol>
<h4 data-id="heading-13">NFS服务器信息</h4>
<ul>
<li>服务器IP：<code>192.168.9.2</code></li>
<li>共享路径：<code>/nfs-storage/k8s-pvs</code></li>
<li>访问权限：所有客户端可读写</li>
</ul>
<h4 data-id="heading-14">K8S部署准备</h4>
<ul>
<li>
<p>已生成<code>nfs-provisioner-deployment.yaml</code>文件，包含：</p>
<ul>
<li>ServiceAccount和RBAC权限配置</li>
<li>NFS Provisioner Deployment</li>
<li>NFS StorageClass</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">下一步操作</h3>
<ol>
<li>在K8S集群中部署Provisioner：</li>
</ol>
<pre><code class="hljs">kubectl apply -f nfs-provisioner-deployment.yaml
</code></pre>
<ol start="2">
<li>创建测试PVC验证：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">test-nfs-pvc</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-string">-</span> <span class="hljs-string">ReadWriteMany</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-string">storage:</span> <span class="hljs-string">1Gi</span>
  <span class="hljs-string">storageClassName:</span> <span class="hljs-string">nfs-storage</span>
</code></pre>
<blockquote>
<p>PVC创建后会自动绑定PV，PV实际路径对应<code>/nfs-storage/k8s-pvs/default-test-nfs-pvc-xxx</code></p>
</blockquote>
<h3 data-id="heading-16">安全建议（可选）</h3>
<ol>
<li>限制NFS访问来源为K8S节点网段（替换<code>/etc/exports</code>中的<code>*</code>）</li>
<li>启用NFS的Kerberos认证</li>
<li>定期备份NFS存储数据</li>
</ol>
<blockquote>
<p><strong>本文转载自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9w_PN7dLQtMmGekagHz8AA" target="_blank" title="https://mp.weixin.qq.com/s/9w_PN7dLQtMmGekagHz8AA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/9w_PN7dLQ…</a></strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[STM32输入捕获PWM频率和占空比（HAL库）]]></title>    <link>https://juejin.cn/post/7597776334066040884</link>    <guid>https://juejin.cn/post/7597776334066040884</guid>    <pubDate>2026-01-22T08:19:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334066040884" data-draft-id="7597776334065991732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="STM32输入捕获PWM频率和占空比（HAL库）"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-01-22T08:19:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="stay"/> <meta itemprop="url" content="https://juejin.cn/user/1968590860597225"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            STM32输入捕获PWM频率和占空比（HAL库）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968590860597225/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    stay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:19:59.000Z" title="Thu Jan 22 2026 08:19:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">占空比和频率的计算思路</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad67087402047adb7ec49405f62c697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3RheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674798&amp;x-signature=iR25u9xaQ8vx%2BMudahOO1xObhGs%3D" alt="pwm.png" loading="lazy"/>
如上图所示的一个PWM波，占空比可通过高电平所占时间和周期之间的比值计算的得出</p>
<p align="center">占空比=t1/t</p>
PWM频率计算则为：
<p align="center">频率=定时器时钟频率 /（分频系数*周期t）</p>
本次将使用单通道捕获上升沿和下降沿获取高电平所占时间t1和周期t。
<h2 data-id="heading-1">实现流程</h2>
<ol>
<li>在第一次捕获上升沿时将计数器清零，并将下一次捕获设置为下降沿捕获；</li>
<li>在捕获到下降沿后，将计数器里的值保存起来（这是计数器里的值就是高电平<strong>t1</strong>），并将下一次捕获设置为上升沿捕获；</li>
<li>在第二次捕获道上升沿后将计数器里的值保存起来（这时计数器里的值就是周期<strong>t</strong>）。</li>
</ol>
<p>后续就可以通过获取到的<strong>t1</strong>和<strong>t</strong>计算出PWM波的频率和周期了。</p>
<h2 data-id="heading-2">CubeMX配置</h2>
<p>我使用的时stm32f103c8t6的实验板，先将时钟频率调整为72MHz。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b978653f2da54f52b17d8c56ab556af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3RheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674798&amp;x-signature=aqYuPKDtRAw9jpwi6vOeGCGcap0%3D" alt="屏幕截图 2026-01-22 151855.png" loading="lazy"/>
然后选择TIM2,通道1，将分频系数设置为72-1</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a75f6b3ceb44979a5a5680ee8d4d37b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3RheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674798&amp;x-signature=nSqsaQnPnCRxh%2Bd%2F2m0E6vwxyjI%3D" alt="屏幕截图 2026-01-22 152208.png" loading="lazy"/>
打开中断</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/981c46b4cfcc470ba2937850ded338af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3RheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769674798&amp;x-signature=7YAS6Omjvv4GBNvpXIIDVR2Fg%2BM%3D" alt="屏幕截图 2026-01-22 152431.png" loading="lazy"/></p>
<h2 data-id="heading-3">代码部分</h2>
<p>生成代码后为我们在中断回调函数中添加以下内容</p>
<pre><code class="hljs language-ini" lang="ini">volatile uint32_t <span class="hljs-attr">falltime</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 下降沿捕获值</span>
volatile uint32_t <span class="hljs-attr">periodValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;      // 周期值</span>
volatile uint8_t <span class="hljs-attr">dutyCycle</span> = <span class="hljs-number">0</span><span class="hljs-comment">;        // 占空比（0-100%）</span>
volatile uint8_t <span class="hljs-attr">captureState</span> = <span class="hljs-number">0</span><span class="hljs-comment">;      //电平捕获</span>
volatile uint8_t <span class="hljs-attr">measurementReady</span> = <span class="hljs-number">0</span><span class="hljs-comment">;  // 测量完成标志</span>
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
  if (htim-&gt;<span class="hljs-attr">Instance</span> == TIM2){
    switch (captureState){
      case 0: // 捕获到上升沿
        __HAL_TIM_SET_COUNTER(htim,2)<span class="hljs-comment">;//计数器设置为2,(这里按理来说应该设置为0的，但我通过调试发现设置为2准确)</span>
        <span class="hljs-attr">captureState</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        
        // 切换为下降沿捕获
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_1, TIM_INPUTCHANNELPOLARITY_FALLING)<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
      case 1: // 捕获到下降沿
        <span class="hljs-attr">falltime</span> =  HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1)<span class="hljs-comment">;</span>
        <span class="hljs-attr">captureState</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        
        // 切换为上升沿捕获
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_1, TIM_INPUTCHANNELPOLARITY_RISING)<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
      case 2: // 第二个上升沿，计算周期
        <span class="hljs-attr">periodValue</span> = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1)<span class="hljs-comment">;//周期</span>
        <span class="hljs-attr">captureState</span> = <span class="hljs-number">0</span><span class="hljs-comment">; </span>
        <span class="hljs-attr">measurementReady</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // 设置测量完成标志</span>
        break<span class="hljs-comment">;</span>
    }
  }
}
</code></pre>
<p>main函数</p>
<pre><code class="hljs language-scss" lang="scss">while (<span class="hljs-number">1</span>)
  {
     if (measurementReady){
        <span class="hljs-comment">// 计算占空比</span>
        if (periodValue != <span class="hljs-number">0</span>){
          dutyCycle = (falltime* <span class="hljs-number">100</span> / periodValue) ;
          frequency = <span class="hljs-number">72000000</span> / (<span class="hljs-number">72</span>*periodValue);
          <span class="hljs-comment">// 打印结果</span>
          <span class="hljs-built_in">printf</span>("ZK %d Hz\r\n,PL%d%%\r\n",dutyCycle,frequency);
        }
        measurementReady = <span class="hljs-number">0</span>; <span class="hljs-comment">// 清除标志</span>
      }
    <span class="hljs-comment">/* USER CODE END WHILE */</span>
 
    <span class="hljs-comment">/* USER CODE BEGIN 3 */</span>
  }
</code></pre>
<h2 data-id="heading-4">测试部分</h2>
<p>为了方便拍视频就将结果显示到OLED显示屏上</p>
<p>用示波器生成不同频率，不同占空比的波形供开发板捕获</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">测试视频</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能监控Performance]]></title>    <link>https://juejin.cn/post/7597989474991489062</link>    <guid>https://juejin.cn/post/7597989474991489062</guid>    <pubDate>2026-01-22T08:23:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991489062" data-draft-id="7597996070509314086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能监控Performance"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T08:23:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3145327496832"/> <meta itemprop="url" content="https://juejin.cn/user/712960316285789"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能监控Performance
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712960316285789/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3145327496832
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:23:02.000Z" title="Thu Jan 22 2026 08:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>**前端性能监控（Real User Monitoring, RUM）**是一种通过实时采集和分析用户与Web应用交互时的性能数据，帮助开发者定位性能瓶颈、优化用户体验的技术。其核心目标是量化页面加载速度、交互流畅度等关键指标，确保应用在不同网络环境、设备类型下的稳定性。</p>
<h3 data-id="heading-0"><strong>实现原理</strong></h3>
<p>前端性能监控的实现基于浏览器提供的底层API，结合数据采集、传输、存储与分析的完整链路，具体原理如下：</p>
<h4 data-id="heading-1"><strong>1. 数据采集：浏览器</strong> <strong>API</strong> <strong>的深度利用</strong></h4>
<ul>
<li>
<p><strong>Performance</strong> <strong>API</strong>：提供页面加载各阶段的时间戳（如<code>navigationStart</code>、<code>domContentLoadedEventStart</code>），通过<code>performance.timing</code>对象可计算服务器响应时间、DOM解析时间等。例如：</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">loadTime</span> = performance.timing.loadEventEnd - performance.timing.navigationStart<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>Resource Timing</strong> <strong>API</strong>：记录资源（图片、脚本、样式表）的加载耗时，通过<code>performance.getEntriesByType('resource')</code>获取详细数据。</p>
</li>
<li>
<p><strong>Paint Timing</strong> <strong>API</strong>：标记页面渲染关键节点，如首次内容绘制（FCP）、最大内容绘制（LCP），通过<code>performance.getEntriesByType('paint')</code>实现。</p>
</li>
<li>
<p><strong>Long Task</strong> <strong>API</strong>：检测主线程阻塞超过50ms的任务，识别卡顿源。</p>
</li>
<li>
<p><strong>错误捕获</strong>：</p>
<ul>
<li>
<p><strong>JS</strong> <strong>错误</strong>：通过<code>window.onerror</code>监听语法错误、运行时错误。</p>
</li>
<li>
<p><strong>Promise错误</strong>：通过<code>window.addEventListener('unhandledrejection')</code>捕获未处理的Promise异常。</p>
</li>
<li>
<p><strong>资源错误</strong>：监听<code>img</code>、<code>script</code>元素的<code>error</code>事件，记录加载失败。</p>
<ul>
<li/>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2"><strong>2. 数据传输：高效上报策略</strong></h4>
<ul>
<li>
<p><strong>即时上报</strong>：关键错误（如JS崩溃）采用同步POST请求，确保数据及时送达。</p>
</li>
<li>
<p><strong>定时批量上报</strong>：性能指标和用户行为数据每5秒集中发送一次，平衡实时性与性能开销。</p>
</li>
<li>
<p><strong>网络缓存</strong>：网络不稳定时，利用<code>localStorage</code>或<code>IndexedDB</code>缓存数据，待网络恢复后自动重传。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-3"><strong>3. 数据存储与处理</strong></h4>
<ul>
<li>
<p><strong>时序数据库</strong>：如InfluxDB、Prometheus，优化时间序列数据存储与查询。</p>
</li>
<li>
<p><strong>数据清洗</strong>：去除重复数据、修正异常值（如负数时间戳）。</p>
</li>
<li>
<p><strong>聚合分析</strong>：计算指标的平均值、分位数（如P90、P95），识别性能波动规律。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-4"><strong>4.</strong> <strong>数据分析</strong> <strong>与可视化</strong></h4>
<ul>
<li>
<p><strong>趋势分析</strong>：通过折线图展示LCP、FID等指标随时间的变化，定位性能退化时段。</p>
</li>
<li>
<p><strong>对比分析</strong>：对比不同页面、浏览器或地区的性能数据，找出优化优先级。</p>
</li>
<li>
<p><strong>告警机制</strong>：当错误率超过阈值或LCP持续超标时，触发邮件、短信告警。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h3 data-id="heading-5"><strong>具体实现步骤</strong></h3>
<h4 data-id="heading-6"><strong>1. 确定监控指标</strong></h4>
<p>根据业务需求选择核心指标，例如：</p>
<ul>
<li>
<p><strong>加载性能</strong>：首屏加载时间、LCP、TTI（可交互时间）。</p>
</li>
<li>
<p><strong>交互性能</strong>：FID（首次输入延迟）、滚动卡顿率。</p>
</li>
<li>
<p><strong>稳定性</strong>：JS错误率、资源加载失败率。</p>
</li>
<li>
<p><strong>用户体验</strong>：白屏时长、用户停留时长。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-7"><strong>2. 选择监控工具</strong></h4>
<ul>
<li>
<p><strong>开源方案</strong>：</p>
<ul>
<li><strong>Lighthouse</strong>：集成在Chrome DevTools中，提供实验室环境下的性能评分。</li>
<li><strong>Sentry</strong>：专注错误监控，支持源码映射和堆栈分析。</li>
</ul>
</li>
<li>
<p><strong>商业服务</strong>：</p>
<ul>
<li>
<p><strong>New Relic</strong>、<strong>Dynatrace</strong>：提供前后端一体化监控。</p>
</li>
<li>
<p><strong>腾讯云RUM</strong>：支持小程序监控，与后端APM联动。</p>
<ul>
<li/>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8"><strong>3. 部署监控代码</strong></h4>
<ul>
<li>
<p><strong>手动集成</strong>：在页面<code>&lt;head&gt;</code>中插入SDK脚本，初始化时配置上报地址、抽样率等参数：</p>
<ul>
<li>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/rum-sdk.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable constant_">RUM</span>.<span class="hljs-title function_">init</span>({
    <span class="hljs-attr">appKey</span>: <span class="hljs-string">'YOUR_APP_KEY'</span>,
    <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// 100%采样</span>
    <span class="hljs-attr">urlWhitelist</span>: [<span class="hljs-string">'*.example.com'</span>]
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>框架集成</strong>：</p>
<ul>
<li>
<p><strong>Vue</strong>：在<code>mounted</code>生命周期中调用数据采集函数。</p>
</li>
<li>
<p><strong>React</strong>：通过自定义Hooks（如<code>usePerformance</code>）封装监控逻辑。</p>
<ul>
<li/>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9"><strong>4. 采集与上报数据</strong></h4>
<ul>
<li>
<p><strong>性能指标采集</strong>：</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPageLoadTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> performance.<span class="hljs-property">timing</span>.<span class="hljs-property">loadEventEnd</span> - performance.<span class="hljs-property">timing</span>.<span class="hljs-property">navigationStart</span>;
}
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> loadTime = <span class="hljs-title function_">getPageLoadTime</span>();
  <span class="hljs-variable constant_">RUM</span>.<span class="hljs-title function_">sendMetric</span>(<span class="hljs-string">'page_load_time'</span>, loadTime);
});
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>错误信息采集</strong>：</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">message, source, lineno, colno, error</span>) {
  <span class="hljs-variable constant_">RUM</span>.<span class="hljs-title function_">sendError</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'js_error'</span>,
    message,
    <span class="hljs-attr">stack</span>: error?.<span class="hljs-property">stack</span>,
    <span class="hljs-attr">position</span>: <span class="hljs-string">`<span class="hljs-subst">${source}</span>:<span class="hljs-subst">${lineno}</span>:<span class="hljs-subst">${colno}</span>`</span>
  });
};
</code></pre>
</li>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-10"><strong>5. 分析与优化</strong></h4>
<ul>
<li>
<p><strong>瓶颈定位</strong>：通过瀑布图分析资源加载顺序，优化关键路径（如内联CSS、预加载JS）。</p>
</li>
<li>
<p><strong>代码优化</strong>：</p>
<ul>
<li>减少HTTP请求：合并文件、使用CSS Sprites。</li>
<li>延迟加载非关键资源：图片<code>loading="lazy"</code>、异步加载JS（<code>defer</code>/<code>async</code>）。</li>
<li>缓存策略：对静态资源设置<code>Cache-Control: max-age=31536000</code>。</li>
</ul>
</li>
<li>
<p><strong>A/B测试</strong>：对比优化前后的性能数据，验证改进效果。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h3 data-id="heading-11"><strong>案例：腾讯云RUM的实现</strong></h3>
<p>腾讯云RUM通过SDK采集用户端数据，利用流计算Oceanus实时处理指标，结合时序数据库CTSDB存储历史数据。其核心功能包括：</p>
<ul>
<li>
<p><strong>无侵入监控</strong>：SDK自动采集性能数据，无需修改业务代码。</p>
</li>
<li>
<p><strong>多维分析</strong>：支持按地区、浏览器、设备类型分组统计性能指标。</p>
</li>
<li>
<p><strong>智能告警</strong>：基于机器学习预测性能趋势，提前发现潜在问题。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h3 data-id="heading-12"><strong>注意事项</strong></h3>
<ul>
<li>
<p><strong>性能开销</strong>：监控代码体积应控制在30KB以内，避免影响页面加载。</p>
</li>
<li>
<p><strong>数据安全</strong>：对用户ID等敏感信息脱敏，上报时使用HTTPS加密。</p>
</li>
<li>
<p><strong>兼容性</strong>：测试SDK在低版本浏览器（如IE11）中的表现，提供降级方案。</p>
</li>
</ul>
<h3 data-id="heading-13">Performance API 简介</h3>
<p>Performance API 是一组用于衡量 Web 应用性能的 JavaScript 标准接口，它通过高精度时间戳和性能条目（Performance Entries）记录页面加载、资源加载、交互响应等关键事件，帮助开发者量化用户体验。其核心优势在于：</p>
<ul>
<li>
<p><strong>高精度时间戳</strong>：<code>performance.now()</code> 提供微秒级精度（Chrome 中精度达 0.1ms），远超传统 <code>Date.now()</code> 的 1ms 精度。</p>
</li>
<li>
<p><strong>性能条目（Performance Entries）</strong> ：通过 <code>performance.getEntries()</code> 获取导航、资源、绘制等事件的详细数据。</p>
</li>
<li>
<p><strong>支持 Core Web Vitals</strong>：可直接捕获 LCP、FID、CLS 等关键性能指标。</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h3 data-id="heading-14">兼容性分析</h3>
<ul>
<li>
<p><strong>浏览器支持</strong>：</p>
<ul>
<li><strong>主流浏览器</strong>：Chrome、Firefox、Edge、Safari 均支持 Performance API 的核心功能（如 <code>timing</code>、<code>getEntries</code>）。</li>
<li><strong>IE 限制</strong>：IE9 以下不支持，IE11 仅部分支持（如 <code>timing</code> 属性，但资源列表可能不完整）。</li>
<li><strong>移动端</strong>：部分 API 在移动端浏览器或 WebView 中可能受限（如 <code>getEntries()</code> 返回数据不完整）。</li>
</ul>
</li>
<li>
<p><strong>API</strong> <strong>差异</strong>：</p>
<ul>
<li>
<p><strong>资源列表</strong>：Firefox 返回所有 HTTP 请求（包括失败请求），Chrome 仅返回成功请求。</p>
</li>
<li>
<p><strong>跨域限制</strong>：获取跨域资源的详细时间数据需服务端设置 <code>Timing-Allow-Origin</code> 响应头。</p>
<ul>
<li/>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">Performance API 使用方法</h3>
<h4 data-id="heading-16">1. 基础时间测量</h4>
<p>使用 <code>performance.now()</code> 测量代码执行时间：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">start</span> = performance.now()<span class="hljs-comment">;</span>
// 执行待测代码（如循环、异步操作）
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10000; i++) {</span>
  console.log(i)<span class="hljs-comment">;</span>
}
const <span class="hljs-attr">end</span> = performance.now()<span class="hljs-comment">;</span>
console.log(`执行耗时: ${(end - start).toFixed(3)}ms`)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-17">2. 导航与资源时间</h4>
<p>通过 <code>performance.timing</code> 获取页面加载各阶段时间戳：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timing = performance.<span class="hljs-property">timing</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DNS 查询耗时:'</span>, timing.<span class="hljs-property">domainLookupEnd</span> - timing.<span class="hljs-property">domainLookupStart</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'TCP 连接耗时:'</span>, timing.<span class="hljs-property">connectEnd</span> - timing.<span class="hljs-property">connectStart</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'白屏时间:'</span>, timing.<span class="hljs-property">responseStart</span> - timing.<span class="hljs-property">navigationStart</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 解析耗时:'</span>, timing.<span class="hljs-property">domComplete</span> - timing.<span class="hljs-property">domInteractive</span>);
};
</code></pre>
<h4 data-id="heading-18">3. 资源加载详情</h4>
<p>使用 <code>performance.getEntriesByType('resource')</code> 获取静态资源（图片、脚本等）的加载时间：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">resources</span> = performance.getEntriesByType(<span class="hljs-string">'resource'</span>)<span class="hljs-comment">;</span>
resources.forEach(<span class="hljs-attr">resource</span> =&gt; {
  console.log(`资源: ${resource.name}, 加载耗时: ${resource.duration.toFixed(2)}ms`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-19">获取 FCP、LCP 等关键指标</h3>
<h4 data-id="heading-20">1. 首次内容绘制（FCP）</h4>
<p>通过 <code>PerformanceObserver</code> 监听 <code>paint</code> 事件，捕获 FCP 时间：</p>
<pre><code class="hljs language-ini" lang="ini">new PerformanceObserver((list) =&gt; {
  const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
  entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
    if (<span class="hljs-attr">entry.name</span> === <span class="hljs-string">'first-contentful-paint'</span>) {
      console.log('FCP 时间:', entry.startTime)<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>
}).observe({ type: 'paint', buffered: true })<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-21">2. 最大内容绘制（LCP）</h4>
<p>监听 <code>largest-contentful-paint</code> 事件，获取 LCP 时间（取最后一次候选元素）：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">lcpValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
new PerformanceObserver((list) =&gt; {
  const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">lastEntry</span> = entries[entries.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
  <span class="hljs-attr">lcpValue</span> = lastEntry.renderTime || lastEntry.loadTime<span class="hljs-comment">;</span>
  console.log('LCP 时间:', lcpValue)<span class="hljs-comment">;</span>
}).observe({ type: 'largest-contentful-paint', buffered: true })<span class="hljs-comment">;</span>

// 用户交互后停止监听（避免误报）
window.addEventListener('click', () =&gt; {
  observer.disconnect()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-22">3. 首次输入延迟（FID）</h4>
<p>监听 <code>first-input</code> 事件，计算用户首次交互的延迟时间：</p>
<pre><code class="hljs language-ini" lang="ini">new PerformanceObserver((list) =&gt; {
  const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
  entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
    const <span class="hljs-attr">delay</span> = entry.processingStart - entry.startTime<span class="hljs-comment">;</span>
    console.log('FID 延迟:', delay.toFixed(2) + 'ms')<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
}).observe({ type: 'first-input', buffered: true })<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-23">4. 累积布局偏移（CLS）</h4>
<p>监听 <code>layout-shift</code> 事件，计算页面布局稳定性：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">clsValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">sessionEntries</span> = []<span class="hljs-comment">;</span>
let <span class="hljs-attr">sessionValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

new PerformanceObserver((list) =&gt; {
  const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
  entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
    if (!entry.hadRecentInput) {
      const <span class="hljs-attr">firstSessionEntry</span> = sessionEntries[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
      const <span class="hljs-attr">lastSessionEntry</span> = sessionEntries[sessionEntries.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>

      if (sessionValue &amp;&amp;
          entry.startTime - lastSessionEntry.startTime &lt; 1000 &amp;&amp;
          entry.startTime - firstSessionEntry.startTime &lt; 5000) {
        sessionValue += entry.value<span class="hljs-comment">;</span>
        sessionEntries.push(entry)<span class="hljs-comment">;</span>
      } else {
        <span class="hljs-attr">sessionValue</span> = entry.value<span class="hljs-comment">;</span>
        <span class="hljs-attr">sessionEntries</span> = [entry]<span class="hljs-comment">;</span>
      }

      if (sessionValue &gt; clsValue) {
        <span class="hljs-attr">clsValue</span> = sessionValue<span class="hljs-comment">;</span>
        console.log('CLS 值:', clsValue)<span class="hljs-comment">;</span>
      }
    }
  })<span class="hljs-comment">;</span>
}).observe({ type: 'layout-shift', buffered: true })<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-24">完整示例代码</h3>
<pre><code class="hljs language-ini" lang="ini">// 初始化 PerformanceObserver 监听关键指标
function initPerformanceObservers() {
  // FCP 监听
  new PerformanceObserver((list) =&gt; {
    const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
    entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
      if (<span class="hljs-attr">entry.name</span> === <span class="hljs-string">'first-contentful-paint'</span>) {
        console.log('FCP:', entry.startTime + 'ms')<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }).observe({ type: 'paint', buffered: true })<span class="hljs-comment">;</span>

  // LCP 监听
  let <span class="hljs-attr">lcpValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">lcpObserver</span> = new PerformanceObserver((list) =&gt; {
    const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">lastEntry</span> = entries[entries.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
    <span class="hljs-attr">lcpValue</span> = lastEntry.renderTime || lastEntry.loadTime<span class="hljs-comment">;</span>
    console.log('LCP:', lcpValue + 'ms')<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true })<span class="hljs-comment">;</span>

  // 用户交互后停止 LCP 监听
  window.addEventListener('click', () =&gt; {
    lcpObserver.disconnect()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  // FID 监听
  new PerformanceObserver((list) =&gt; {
    const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
    entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
      const <span class="hljs-attr">delay</span> = entry.processingStart - entry.startTime<span class="hljs-comment">;</span>
      console.log('FID:', delay.toFixed(2) + 'ms')<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }).observe({ type: 'first-input', buffered: true })<span class="hljs-comment">;</span>

  // CLS 监听
  let <span class="hljs-attr">clsValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  let <span class="hljs-attr">sessionEntries</span> = []<span class="hljs-comment">;</span>
  let <span class="hljs-attr">sessionValue</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

  new PerformanceObserver((list) =&gt; {
    const <span class="hljs-attr">entries</span> = list.getEntries()<span class="hljs-comment">;</span>
    entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
      if (!entry.hadRecentInput) {
        const <span class="hljs-attr">firstSessionEntry</span> = sessionEntries[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        const <span class="hljs-attr">lastSessionEntry</span> = sessionEntries[sessionEntries.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>

        if (sessionValue &amp;&amp;
            entry.startTime - lastSessionEntry.startTime &lt; 1000 &amp;&amp;
            entry.startTime - firstSessionEntry.startTime &lt; 5000) {
          sessionValue += entry.value<span class="hljs-comment">;</span>
          sessionEntries.push(entry)<span class="hljs-comment">;</span>
        } else {
          <span class="hljs-attr">sessionValue</span> = entry.value<span class="hljs-comment">;</span>
          <span class="hljs-attr">sessionEntries</span> = [entry]<span class="hljs-comment">;</span>
        }

        if (sessionValue &gt; clsValue) {
          <span class="hljs-attr">clsValue</span> = sessionValue<span class="hljs-comment">;</span>
          console.log('CLS:', clsValue)<span class="hljs-comment">;</span>
        }
      }
    })<span class="hljs-comment">;</span>
  }).observe({ type: 'layout-shift', buffered: true })<span class="hljs-comment">;</span>
}

// 初始化性能监控
initPerformanceObservers()<span class="hljs-comment">;</span>

// 页面加载完成后输出导航时间
<span class="hljs-attr">window.onload</span> = function() {
  const <span class="hljs-attr">timing</span> = performance.timing<span class="hljs-comment">;</span>
  console.log('DNS 查询耗时:', timing.domainLookupEnd - timing.domainLookupStart + 'ms')<span class="hljs-comment">;</span>
  console.log('TCP 连接耗时:', timing.connectEnd - timing.connectStart + 'ms')<span class="hljs-comment">;</span>
  console.log('白屏时间:', timing.responseStart - timing.navigationStart + 'ms')<span class="hljs-comment">;</span>
  console.log('DOM 解析耗时:', timing.domComplete - timing.domInteractive + 'ms')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">注意事项</h3>
<ol>
<li>
<p><strong>性能开销</strong>：<code>PerformanceObserver</code> 会持续监听事件，避免在低性能设备上过度使用。</p>
</li>
<li>
<p><strong>兼容性</strong> <strong>处理</strong>：对不支持 <code>PerformanceObserver</code> 的浏览器（如 IE），需降级使用 <code>performance.getEntriesByType</code>。</p>
</li>
<li>
<p><strong>数据上报</strong>：实际项目中需将性能数据发送至后端存储，可使用 <code>fetch</code> 或 <code>navigator.sendBeacon</code>。</p>
</li>
<li>
<p><strong>用户交互影响</strong>：LCP 和 CLS 的计算可能受用户交互影响，需在用户首次交互后停止监听（如示例中的 <code>click</code> 事件）。</p>
</li>
</ol>
<h3 data-id="heading-26">监控代码位置对性能数据的影响及Performance API数据记录机制解析</h3>
<h4 data-id="heading-27"><strong>一、监控代码位置对性能数据的影响</strong></h4>
<ol>
<li>
<p><strong>数据完整性不受位置影响</strong></p>
<ol>
<li>
<p>Performance API的数据记录是<strong>浏览器在页面加载过程中自动完成的</strong>，与监控代码的位置无关。例如：</p>
<ul>
<li>
<p><code>performance.timing</code>对象在页面开始加载时即开始填充时间戳（如<code>navigationStart</code>、<code>responseStart</code>等），无论代码放在<code>&lt;head&gt;</code>还是<code>&lt;body&gt;</code>中，只要在<code>window.onload</code>事件触发后执行，都能获取完整数据。</p>
</li>
<li>
<p>资源加载时间（如<code>resource.duration</code>）、绘制时间（如FCP/LCP）等均由浏览器在加载过程中实时记录，代码位置仅影响<strong>何时访问这些数据</strong>，而非数据本身。</p>
<ul>
<li/>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>执行时机的关键性</strong></p>
<ol>
<li>
<p>**<code>window.onload</code><strong>事件</strong>：确保所有资源（图片、样式表、脚本等）加载完成后才触发，此时所有Performance数据已完整记录。无论代码放在<code>&lt;head&gt;</code>还是<code>&lt;body&gt;</code>底部，只要绑定在<code>window.onload</code>上，结果一致。</p>
</li>
<li>
<p><strong>异步加载脚本</strong>：若使用<code>async</code>或<code>defer</code>加载监控代码，需确保其在页面加载完成后执行（如通过<code>window.onload</code>），否则可能提前访问未填充的Performance数据。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>潜在差异场景</strong></p>
<ol>
<li>
<p><strong>早期执行</strong>：若代码放在<code>&lt;head&gt;</code>中且未绑定<code>window.onload</code>，可能在页面未加载完成时执行，导致部分数据（如<code>loadEventEnd</code>）未记录，出现<code>undefined</code>或<code>0</code>值。</p>
</li>
<li>
<p><strong>资源加载顺序</strong>：异步加载的资源（如图片）可能延迟触发<code>window.onload</code>，但Performance API会持续记录这些资源的加载时间，最终数据仍完整。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-28"><strong>二、Performance</strong> <strong>API</strong> <strong>数据记录机制</strong></h4>
<ol>
<li>
<p><strong>核心原理</strong></p>
<ol>
<li>
<p><strong>高精度时间戳</strong>：<code>performance.now()</code>提供微秒级精度，不受系统时间调整影响。</p>
</li>
<li>
<p><strong>性能时间线（Performance Timeline）</strong> ：浏览器自动记录页面加载各阶段（导航、资源加载、绘制等）的时间戳，存储为<code>PerformanceEntry</code>对象。</p>
</li>
<li>
<p><strong>自动收集</strong>：无需手动触发，浏览器在页面加载过程中持续填充<code>performance.timing</code>、<code>performance.getEntries()</code>等接口的数据。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>关键数据记录流程</strong></p>
<ol>
<li>
<p><strong>导航阶段</strong>：从用户发起请求（<code>navigationStart</code>）到页面开始响应（<code>responseStart</code>），记录DNS查询、TCP连接等耗时。</p>
</li>
<li>
<p><strong>资源加载</strong>：通过<code>Resource Timing API</code>记录图片、脚本、样式表等资源的加载耗时（<code>duration</code>）。</p>
</li>
<li>
<p><strong>绘制与交互</strong>：通过<code>Paint Timing API</code>记录FCP（首次内容绘制）、LCP（最大内容绘制），通过<code>Event Timing API</code>记录FID（首次输入延迟）等。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>数据访问时机</strong></p>
<ol>
<li>
<p><strong>同步访问</strong>：在<code>window.onload</code>事件中访问<code>performance.timing</code>，可获取完整导航时间（如<code>loadEventEnd - navigationStart</code>）。</p>
</li>
<li>
<p><strong>异步访问</strong>：通过<code>PerformanceObserver</code>监听特定事件（如<code>paint</code>、<code>resource</code>），可实时获取动态数据（如LCP的最终值）。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-29"><strong>三、实验验证：代码位置对结果的影响</strong></h4>
<p>通过以下实验可验证位置无关性：</p>
<ol>
<li>
<p><strong>实验设计</strong></p>
<ol>
<li>
<p>将监控代码分别放在<code>&lt;head&gt;</code>和<code>&lt;body&gt;</code>底部，均绑定<code>window.onload</code>事件。</p>
</li>
<li>
<p>对比输出的性能数据（如DNS查询耗时、白屏时间、资源加载时间）。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>实验结果</strong></p>
<ol>
<li>
<p>无论代码位置如何，只要在<code>window.onload</code>中执行，输出的性能数据完全一致。</p>
</li>
<li>
<p>示例代码：</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 放在 &lt;head&gt; 或 &lt;body&gt; 中均可</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timing = performance.<span class="hljs-property">timing</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DNS查询耗时:'</span>, timing.<span class="hljs-property">domainLookupEnd</span> - timing.<span class="hljs-property">domainLookupStart</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'TCP连接耗时:'</span>, timing.<span class="hljs-property">connectEnd</span> - timing.<span class="hljs-property">connectStart</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'白屏时间:'</span>, timing.<span class="hljs-property">responseStart</span> - timing.<span class="hljs-property">navigationStart</span>);
};
</code></pre>
</li>
<li/>
</ul>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-30"><strong>四、</strong> <strong>最佳实践</strong> <strong>建议</strong></h4>
<ol>
<li>
<p><strong>代码位置选择</strong></p>
<ol>
<li>
<p><strong>推荐位置</strong>：将监控代码放在<code>&lt;body&gt;</code>底部或使用<code>defer</code>属性，确保在DOM解析完成后执行，避免阻塞页面渲染。</p>
</li>
<li>
<p><strong>避免位置</strong>：避免将监控代码直接放在<code>&lt;head&gt;</code>中且未绑定<code>window.onload</code>，可能导致数据不完整。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>数据访问时机</strong></p>
<ol>
<li>
<p>优先使用<code>window.onload</code>或<code>PerformanceObserver</code>确保数据完整性。</p>
</li>
<li>
<p>对于动态数据（如LCP），通过<code>PerformanceObserver</code>监听<code>largest-contentful-paint</code>事件，并在用户交互后停止监听（避免误报）。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>兼容性</strong> <strong>与降级</strong></p>
<ol>
<li>
<p>针对不支持<code>PerformanceObserver</code>的浏览器（如IE），使用<code>performance.getEntriesByType('paint')</code>获取FCP/LCP数据。</p>
</li>
<li>
<p>使用<code>navigator.sendBeacon</code>或<code>fetch</code>将数据发送至后端，避免阻塞页面卸载。</p>
<ul>
<li/>
</ul>
</li>
</ol>
</li>
</ol>
<p><strong>结论</strong>：监控代码的位置不会影响Performance API记录的性能数据，因为数据是浏览器在页面加载过程中独立记录的。关键在于确保代码在页面加载完成后（如<code>window.onload</code>事件）访问这些数据，从而保证数据的完整性和准确性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别"移动端重构噩梦"：TinyPro移动端适配上线！]]></title>    <link>https://juejin.cn/post/7597989474991652902</link>    <guid>https://juejin.cn/post/7597989474991652902</guid>    <pubDate>2026-01-22T08:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991652902" data-draft-id="7597997108134101019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别&quot;移动端重构噩梦&quot;：TinyPro移动端适配上线！"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-22T08:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别"移动端重构噩梦"：TinyPro移动端适配上线！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:51:36.000Z" title="Thu Jan 22 2026 08:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由TinyPro贡献者王晨光同学原创。</p>
<h2 data-id="heading-0">一、背景：让 TinyPro 真正“走到掌心里”</h2>
<p>TinyPro 是一套基于 <strong>TinyVue</strong> 打造的前后端分离后台管理系统，支持菜单配置、国际化、多页签、权限管理等丰富特性。
TinyPro 在桌面端具备良好的体验和模块化架构，但随着移动办公、平板展示等场景增多，移动端体验的短板逐渐显现：</p>
<ul>
<li>页面缩放不均衡，布局出现溢出或错位；</li>
<li>模态框在小屏上遮挡内容；</li>
<li>图表和表格在横屏与竖屏间切换时无法自适应；</li>
<li>操作区过于密集，不符合触控习惯。</li>
</ul>
<p>为此启动了 <strong>TinyPro 移动端适配项目</strong>，目标是在不破坏现有结构的前提下，实现“<strong>一次开发，跨端流畅</strong>”的体验。</p>
<h2 data-id="heading-1">二、技术选型与总体架构</h2>
<p>本次移动端适配要求在复杂的中后台系统中实现「一次开发，多端自适应」，既要保证样式灵活，又要维持可维护性和构建性能。</p>
<p>在技术选型阶段，综合评估了三种常见方案：</p>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>纯 CSS 媒体查询</td><td>简单直接、依赖少</td><td>样式分散、逻辑重复、维护困难</td></tr><tr><td>TailwindCSS 响应式类</td><td>社区成熟、类名直观、生态完善</td><td>样式表体积大、断点固定、不够灵活</td></tr><tr><td><strong>UnoCSS 原子化方案</strong></td><td>按需生成、性能极轻、断点与变体完全可定制</td><td>需要自行配置规范与规则体系</td></tr></tbody></table>
<p>最终选择了 <strong>UnoCSS + Less 的混合架构</strong>：</p>
<ul>
<li><strong>UnoCSS</strong>：负责通用布局、间距、排版等高频样式，原子化写法提升开发效率；</li>
<li><strong>Less 媒体查询</strong>：用于模态框、导航栏等复杂场景的精细控制；</li>
<li><strong>统一断点配置</strong>：集中管理屏幕尺寸分级，保持视觉一致性；</li>
<li><strong>自定义变体（<code>max-&lt;bp&gt;</code>）</strong>：支持“桌面端优先”策略，通过 max-width 实现移动端自适应，样式逻辑更直观。</li>
</ul>
<h3 data-id="heading-2">UnoCSS：轻量、灵活、即时生成</h3>
<p>UnoCSS 是一个 <strong>按需生成的原子化 CSS 引擎</strong>，最大的特点是 <strong>零冗余与高度可定制</strong>。
不同于 TailwindCSS 的预编译方式，UnoCSS 会在构建阶段根据实际使用的类名即时生成样式规则，从而显著提升构建性能与灵活性.</p>
<p>在配置中通过 <code>presetMini()</code> 与 <code>presetAttributify()</code> 组合使用，使开发者既可以写：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;div class="p-4 text-center bg-gray-100 max-md:p-2"&gt;&lt;/div&gt;
</code></pre>
<p>也可以使用属性化语法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;div p="4" text="center" bg="gray-100" max-md:p="2"&gt;&lt;/div&gt;
</code></pre>
<p><code>presetMini</code> 提供轻量原子类体系，<code>presetAttributify</code> 则允许以声明式方式书写样式，更直观、组件化友好。</p>
<h3 data-id="heading-3">断点配置与响应式策略</h3>
<p>TinyPro 的适配核心之一，是在 <code>uno.config.ts</code> 中建立统一的断点体系，并通过自定义 <code>max-&lt;bp&gt;</code> 前缀实现“桌面端优先”的响应式策略。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> breakpoints = {
  <span class="hljs-attr">sm</span>: <span class="hljs-string">'641px'</span>,     <span class="hljs-comment">// 手机（小屏）</span>
  <span class="hljs-attr">md</span>: <span class="hljs-string">'769px'</span>,     <span class="hljs-comment">// 平板竖屏</span>
  <span class="hljs-attr">lg</span>: <span class="hljs-string">'1025px'</span>,    <span class="hljs-comment">// 平板横屏 / 小型笔电</span>
  <span class="hljs-attr">xl</span>: <span class="hljs-string">'1367px'</span>,    <span class="hljs-comment">// 常规笔电</span>
  <span class="hljs-string">'2xl'</span>: <span class="hljs-string">'1441px'</span>, <span class="hljs-comment">// 高清笔电</span>
  <span class="hljs-string">'3xl'</span>: <span class="hljs-string">'1921px'</span>, <span class="hljs-comment">// 桌面大屏</span>
}
</code></pre>
<p>并通过自定义 <code>variants</code> 扩展 <code>max-&lt;bp&gt;</code> 前缀:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">variants</span>: [
    <span class="hljs-function">(<span class="hljs-params">matcher</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> match = matcher.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^max-([a-z0-9]+):/</span>)
      <span class="hljs-keyword">if</span> (match) {
        <span class="hljs-keyword">const</span> bp = match[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">const</span> value = breakpoints[bp]
        <span class="hljs-keyword">if</span> (!value) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">matcher</span>: matcher.<span class="hljs-title function_">replace</span>(<span class="hljs-string">`max-<span class="hljs-subst">${bp}</span>:`</span>, <span class="hljs-string">''</span>),
          <span class="hljs-attr">parent</span>: <span class="hljs-string">`@media (max-width: <span class="hljs-subst">${value}</span>)`</span>,
        }
      }
    },
  ]
</code></pre>
<p>让开发者能自然地书写：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;div class="w-1/2 max-md:w-full"&gt;&lt;/div&gt;
</code></pre>
<p>含义：</p>
<blockquote>
<p>默认宽度为 50%，在宽度小于 769px 的设备上改为 100%。</p>
</blockquote>
<p>TinyPro 采用「桌面端优先（max-width）」的布局策略：默认以桌面端布局为基础，在移动设备上再进行针对性优化。相比常见的「移动端优先（min-width）」方式，这种做法更符合中后台系统的特性，同时让 UnoCSS 的断点逻辑更直观，并确保主屏体验的稳定性。</p>
<h2 data-id="heading-4">三、样式与编码策略</h2>
<ul>
<li>
<p><strong>优先级</strong></p>
<ul>
<li>简单场景：使用 UnoCSS 原子类。</li>
<li>复杂样式：使用 Less 媒体查询。</li>
</ul>
</li>
<li>
<p><strong>布局与滚动</strong></p>
<ul>
<li>首页及核心业务模块完成适配，小屏模式下侧边栏默认收起、导航栏折叠，确保主要内容可见。</li>
<li>页面主要容器避免横向滚动，必要时在小屏下开启局部横向滚动。</li>
<li>表格与大区块在不同断点下自动调整宽度、栅格与间距，小屏下支持横向滚动；分页与密度支持响应式控制。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af7e6c462a147f5be281a97dd4610f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676696&amp;x-signature=6Qu3xoV1fgaW01GEpRr3oFe9DUQ%3D" alt="布局与滚动.gif" loading="lazy"/></p>
</li>
<li>
<p><strong>图表自适应</strong></p>
<ul>
<li>图表组件接入 <code>resize</code> 监听，在侧边栏展开/收起、窗口缩放、语言切换等场景下保持自适应。</li>
<li>小屏下使用 <code>vw</code> 宽度与较小字号，保证图表展示效果与可读性。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb461c5e916a492881be2bd887f86cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676696&amp;x-signature=SyMwRJjVwuBvOWpXJgV0GrJfu4Y%3D" alt="图表自适应.gif" loading="lazy"/></p>
</li>
<li>
<p><strong>表单与模态框</strong></p>
<ul>
<li>接入 <code>useResponsiveSize()</code>，控制弹窗在小屏下铺满显示，大屏保持固定宽度。</li>
<li>表单项在不同断点下动态调整排布与间距，优化触控体验。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26766751db404d84b2219b571d92702a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676696&amp;x-signature=DMSeCHnk5FiRt4VG3EEbIRmnya8%3D" alt="表单与模态框.gif" loading="lazy"/></p>
</li>
<li>
<p><strong>导航与交互</strong></p>
<ul>
<li>小屏下隐藏导航栏非关键元素，操作聚合到"折叠菜单"。</li>
<li>移动端默认收起侧边菜单栏，提升主要内容展示区域。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/427e47252f504aa3a912780ed6a652d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676696&amp;x-signature=lF%2B7zkGQCL3Icdk8EdIbyX1qUwU%3D" alt="导航与交互.gif" loading="lazy"/></p>
</li>
<li>
<p><strong>性能优化</strong></p>
<ul>
<li>在 <code>responsive.ts</code> 中对 <code>resize</code> 事件处理增加节流机制，避免窗口缩放等场景下的频繁无效渲染。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">四、常用代码片段</h2>
<ol>
<li>基于栅格系统 + 响应式断点工具类，通过为 tiny-row 和 tiny-col 添加不同屏幕宽度下的样式规则，实现自适应布局：</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;tiny-layout&gt;
    &lt;tiny-row class="flex justify-center max-md:flex-wrap"&gt;
        &lt;tiny-col class="w-1/4 max-md:w-1/2 max-sm:w-full max-md:mb-4"&gt;···&lt;/tiny-col&gt;
        ···
        &lt;tiny-col class="w-1/4 max-md:w-1/2 max-sm:w-full max-md:mb-4"&gt;···&lt;/tiny-col&gt;
    &lt;/tiny-row&gt;
&lt;/tiny-layout&gt;

</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;div class="theme-line flex max-sm:grid max-sm:grid-cols-4 max-sm:gap-2"&gt;
  &lt;div···
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<ol start="2">
<li>基于 响应式工具类 + 自定义响应式 Hook,解决(1)对话框宽度自适应;(2)表格尺寸和密度自适应;(3)逻辑层响应式控制</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;section class="p-4 sm:p-6 lg:p-8 max-sm:text-center"&gt;
    &lt;tiny-dialog :width="modalSize"&gt;...&lt;/tiny-dialog&gt;
  &lt;/section&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { useResponsiveSize } from '@/hooks/responsive'
const { modalSize } = useResponsiveSize() // 小屏 100%，大屏 768px
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="container"&gt;
    &lt;tiny-grid ref="grid" :fetch-data="fetchDataOption" :pager="pagerConfig" :size="gridSize" :auto-resize="true" align="center"&gt;
      ···
    &lt;/tiny-grid&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { useResponsiveSize } from '@/hooks/responsive'
const { gridSize } = useResponsiveSize() // 小屏为mini grid，大屏为medium grid
&lt;/script&gt;
</code></pre>
<ol start="3">
<li>通过 <code>useResponsive</code> 获取屏幕断点状态 <code>sm/md/lg</code>，如：在模板中结合 <code>v-if="!lg"</code> 控制分隔线的渲染，从而实现了小屏下纵向菜单才显示分隔线的效果</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ul class="right-side" :class="{ open: menuOpen }"&gt;
    &lt;!-- 小屏下才显示分隔线 --&gt;
    &lt;li v-if="!lg"&gt;
      &lt;div class="divider"&gt;&lt;/div&gt;
    &lt;/li&gt;
    ···
  &lt;/ul&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import { useResponsive } from '@/hooks/responsive'
const { lg } = useResponsive()
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-6">五、结语</h2>
<p>通过本次移动端适配， TinyPro 实现了“从桌面到掌心”的统一体验：
开发者可以继续沿用熟悉的组件体系与布局方式，同时享受 UnoCSS 带来的原子化灵活性与性能优势。在不改变核心架构的前提下，TinyPro 变得更轻盈、更顺滑，也更符合移动时代的使用场景。</p>
<h2 data-id="heading-7">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～<br/>
OpenTiny 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a><br/>
OpenTiny 代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a><br/>
TinyPro源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-pro" target="_blank" title="https://github.com/opentiny/tiny-pro" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></p>
<p>欢迎进入代码仓库 Star🌟TinyPro、TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor
如果你也想要共建，可以进入代码仓库，找到 good first issue标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1 实战 Flutter 蓝牙通信：无硬件，用手机完成 BLE 双向通信]]></title>    <link>https://juejin.cn/post/7597996070509821990</link>    <guid>https://juejin.cn/post/7597996070509821990</guid>    <pubDate>2026-01-22T08:53:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597996070509821990" data-draft-id="7597808104462237742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1 实战 Flutter 蓝牙通信：无硬件，用手机完成 BLE 双向通信"/> <meta itemprop="keywords" content="前端,iOS,Android"/> <meta itemprop="datePublished" content="2026-01-22T08:53:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarkCoder"/> <meta itemprop="url" content="https://juejin.cn/user/207173399875662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1 实战 Flutter 蓝牙通信：无硬件，用手机完成 BLE 双向通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/207173399875662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarkCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:53:07.000Z" title="Thu Jan 22 2026 08:53:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 手把手教你从 0 到 1 完成 Flutter 蓝牙通信（无硬件实战）</h2>
<blockquote>
<p><strong>适合人群</strong></p>
<ul>
<li>Flutter 开发者，想入门 BLE</li>
<li>手上没有任何蓝牙硬件</li>
<li>经常遇到「设备能连上，但怎么都通信不了」</li>
</ul>
</blockquote>
<p>本教程将带你 <strong>从 0 到 1 跑通一套完整的 BLE 通信流程</strong>：</p>
<ul>
<li>Android 手机 + nRF Connect 👉 <strong>模拟蓝牙服务端</strong></li>
<li>iOS + Flutter 👉 <strong>作为蓝牙客户端</strong></li>
<li>完成 <strong>Write + Notify 的双向通信</strong></li>
</ul>
<hr/>
<h3 data-id="heading-1">🧠 一、先建立一个正确的 BLE 心智模型（很重要）</h3>
<p>BLE 并不是「连上设备就能发数据」。</p>
<p>它的真实结构是：</p>
<pre><code class="hljs language-markdown" lang="markdown">设备（Device）
 └── 服务（Service，UUID）
<span class="hljs-code">      └── 特征（Characteristic，UUID + 属性）
</span></code></pre>
<h4 data-id="heading-2">这意味着什么？</h4>
<ul>
<li><strong>通信不是对设备，而是对 Characteristic</strong></li>
<li><strong>写数据，必须写到“支持 Write 的 Characteristic”</strong></li>
<li><strong>收数据，必须监听“支持 Notify 的 Characteristic”</strong></li>
</ul>
<p>👉 <strong>Service / Characteristic 选错一个，通信必失败</strong></p>
<hr/>
<h3 data-id="heading-3">📦 二、准备工作：安装 nRF Connect（模拟服务端）</h3>
<p>我们使用 <strong>Nordic 官方工具 nRF Connect</strong> 来模拟一个 BLE 外设（Server）。</p>
<h4 data-id="heading-4">1️⃣ 下载地址（APK）</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNordicSemiconductor%2FAndroid-nRF-Connect%2Freleases" target="_blank" title="https://github.com/NordicSemiconductor/Android-nRF-Connect/releases" ref="nofollow noopener noreferrer">github.com/NordicSemic…</a></p>
<p>安装到 <strong>Android 真机</strong> 后打开。</p>
<hr/>
<h3 data-id="heading-5">🧩 三、配置 GATT Server（创建服务端能力）</h3>
<h4 data-id="heading-6">3.1 进入 GATT Server 配置</h4>
<p>首页点击：</p>
<blockquote>
<p><strong>Configure GATT Server</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43d3c3c7d7c84f979a85c9a26bde7097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=bF8vzoRpZMbszRiFupnmFmW8V%2BM%3D" alt="配置GATT服务.jpg" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-7">3.2 使用 Sample configuration（推荐新手）</h4>
<p>选择系统内置：</p>
<blockquote>
<p><strong>Sample configuration</strong></p>
</blockquote>
<p>然后找到 <strong>Test Service</strong>，复制它的 <strong>Service UUID</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d29cfe93bef4f889c724867b0744030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=E7vqkrWghwJNjvnA3Ok3rp3SKdc%3D" alt="模版配置.jpg" loading="lazy"/></p>
<p>📌 <strong>这个 UUID 后面会反复用到</strong>：</p>
<ul>
<li>客户端扫描设备</li>
<li>发现服务</li>
<li>选择特征通信</li>
</ul>
<hr/>
<h3 data-id="heading-8">📡 四、配置广播（让客户端能扫描到）</h3>
<p>回到首页，点击 <strong>ADVERTISE</strong>，新建一个广播。</p>
<h4 data-id="heading-9">关键配置点</h4>
<ul>
<li>将 <strong>Service UUID</strong> 添加到 <strong>Scan Response Data</strong></li>
<li>这样客户端在扫描时，才能识别你这个设备提供了什么服务</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c66a75d4b884f8c82cdb5c6d99087a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=K0cIyz%2FLVbxRjWkHVMEk8xoUauk%3D" alt="配置设备.jpg" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-10">服务端完成标志 ✅</h4>
<p>当你在设备列表看到该设备：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6339670a98154792b79bb6cb99e146d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=zdRQPnMrAE1OzKyQ%2FC7rRpbxsio%3D" alt="设备列表.jpg" loading="lazy"/></p>
<p>说明：</p>
<ul>
<li>✅ GATT Server 已启动</li>
<li>✅ 服务 UUID 已广播</li>
</ul>
<hr/>
<h3 data-id="heading-11">📱 五、Flutter 客户端完整流程（新手最关键部分）</h3>
<h4 data-id="heading-12">5.1 扫描设备（Scan）</h4>
<p>Flutter 启动后扫描 BLE 设备：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5210110d02174cf59951fe66bb49555c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=nhJB0C36IpmM%2BjUq%2BjB9bVYW3JA%3D" alt="扫描设备.PNG" loading="lazy"/></p>
<p>📌 此时只是 <strong>看到设备</strong>，还不能通信。</p>
<hr/>
<h4 data-id="heading-13">5.2 点击设备，建立连接（Connect）</h4>
<p>点击设备后：</p>
<pre><code class="hljs language-arduino" lang="arduino">scan → connect
</code></pre>
<p>连接成功，才有后续步骤。</p>
<hr/>
<h4 data-id="heading-14">5.3 发现服务（Discover Services）</h4>
<p>连接完成后，客户端会向服务端请求：</p>
<blockquote>
<p>你这个设备，提供了哪些 Service？</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb0d3075afa4979abe540d0bad7c754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=v4vuvayR%2FMbY1SiF0kfipvKhi1A%3D" alt="获取设备服务.PNG" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-15">❗5.4 进入你创建的 Service（UUID 必须一致）</h4>
<p>在服务列表中：</p>
<ul>
<li>找到 <strong>UUID 与 Test Service 完全一致的 Service</strong></li>
<li>点击进入</li>
</ul>
<p>👉 <strong>Service 点错，后面全部白做</strong></p>
<hr/>
<h4 data-id="heading-16">5.5 查看 Characteristic（真正的通信入口）</h4>
<p>进入 Service 后，会看到多个 Characteristic：</p>
<ul>
<li>有的支持 Read</li>
<li>有的支持 Write</li>
<li>有的支持 Notify</li>
</ul>
<hr/>
<h4 data-id="heading-17">❗❗5.6 客户端必须选对 Characteristic</h4>
<h5 data-id="heading-18">写数据（客户端 → 服务端）</h5>
<ul>
<li>选择 <strong>支持 Write / Write Without Response 的 Characteristic</strong></li>
<li>使用它发送数据</li>
</ul>
<h5 data-id="heading-19">收数据（服务端 → 客户端）</h5>
<ul>
<li>选择 <strong>支持 Notify 的 Characteristic</strong></li>
<li>开启监听（subscribe）</li>
</ul>
<p>📌 <strong>对不支持 Write 的 Characteristic 写数据：</strong></p>
<blockquote>
<p>不报错，但一定没反应</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">🔁 六、双向通信验证</h3>
<h4 data-id="heading-21">6.1 客户端写入数据</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/184ba37058fe4a29a1d052c05759bb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=9hyD3oYdB868LK3aoeu52HxQy8g%3D" alt="客户端通信.PNG" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-22">6.2 服务端 Notify 客户端</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/300b8e05631e4ef08357b69c429e5dd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676787&amp;x-signature=OKwl6Eyyzoh%2F2YjIlEHy2aGGins%3D" alt="服务端通信.jpg" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-23">⚠️ 七、一个 nRF Connect 的 UI 坑</h3>
<p>服务端数据不会自动刷新：</p>
<ul>
<li>切换页面</li>
<li>再切回 <strong>SERVER</strong></li>
<li>才能看到最新数据</li>
</ul>
<p>❗不是通信失败，是 UI 问题。</p>
<hr/>
<h3 data-id="heading-24">📎 示例代码</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchengshixin%2FBleExample" target="_blank" title="https://github.com/chengshixin/BleExample" ref="nofollow noopener noreferrer">github.com/chengshixin…</a></p>
<hr/>
<h3 data-id="heading-25">✅ 总结一句话</h3>
<blockquote>
<p><strong>BLE 通信 = 连设备 + 找对 Service + 用对 Characteristic</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[进阶教程：给AI装上“逻辑大脑”，打造金融级稳定的多轮对话Agent（Dify实战）]]></title>    <link>https://juejin.cn/post/7597997108134166555</link>    <guid>https://juejin.cn/post/7597997108134166555</guid>    <pubDate>2026-01-22T08:52:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597997108134166555" data-draft-id="7597979278240448521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="进阶教程：给AI装上“逻辑大脑”，打造金融级稳定的多轮对话Agent（Dify实战）"/> <meta itemprop="keywords" content="产品,产品经理"/> <meta itemprop="datePublished" content="2026-01-22T08:52:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吏部侍郎"/> <meta itemprop="url" content="https://juejin.cn/user/3604673943579483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            进阶教程：给AI装上“逻辑大脑”，打造金融级稳定的多轮对话Agent（Dify实战）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3604673943579483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吏部侍郎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T08:52:20.000Z" title="Thu Jan 22 2026 08:52:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前，我们讨论过一次怎么样使用dify来构建多轮对话。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fkl9W3ogVZfQ6eerFmvnZ-Q" target="_blank" title="https://mp.weixin.qq.com/s/kl9W3ogVZfQ6eerFmvnZ-Q" ref="nofollow noopener noreferrer">保姆级教程：手把手教你用Dify实现完美多轮对话（附Chatflow和提示词）</a>
这个名字取得还可以，哈哈。但是实际生产使用会存在一些问题，评论区也有说到。</p>
<blockquote>
<p>问题一：多轮对话时, 有些代词在回答的答案中, 只将的用户的问题当作上下文, 有时拼写不出完整的问题.</p>
</blockquote>
<blockquote>
<p>问题二：query改写节点不能开记忆，把之前对话合并成文本放进user prompt，再把温度降低，增加额外规则限制。会好一点。</p>
</blockquote>
<blockquote>
<p>问题三：用户输入和前文不相干，比如问完保险问其他话题（闲聊），这种情况如何分开做query改写防止污染？还想问下这样改写耗时会不会很久？小模型效果好吗？</p>
</blockquote>
<p>这些老师提到的问题其实都是同一个，如何确保问题改写节点，准确理解用户的问题，不要改写错误。此外还有：</p>
<blockquote>
<p>多轮对话时，如果A任务没有成，但是词槽或者说参数收集了一半，用户问多轮任务B，接这问C，这样大概率会造成信息丢失。</p>
</blockquote>
<blockquote>
<p>FAQ/转人工等相关场景没有处理。</p>
</blockquote>
<blockquote>
<p>如何实现长期记忆。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5872e9d54e2844809cd710eb86b5687c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=Pxo7etQqULl14LENoKc9UtwQha0%3D" alt="多轮对话的4大挑战" loading="lazy"/>
这些问题，我们依次来尝试解决一下，下面的整体思路，是结合了<code>bert</code>时代的状态机管理（或者说对话状态跟踪）和大模型的语义理解、分类、信息提取等相关能力。
为什么要用状态机呢？
我认为，对于私有化模型来说，一般都是开源的，不是最好的模型。二是，大模型是基于概率的，上下文、任务状态很容易丢失，一旦对话过程，即便是Gemini。另外一点就是，我在金融行业，金融行业对合规性更加重视，需要可靠可控的输出结果。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a10362eba734fe292779cf127de4a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=VY%2Fgge8f3PG6bJNWdBHN9oaEz5w%3D" alt="状态机的核心价值" loading="lazy"/>
使用状态机，是为了显示的标识当前任务的状态。
我认为在提示词里面标识一下，肯定要比单纯使用LLM本身的记忆，能更好的提升任务完成率。
比如提示：#当前状态是查询天气信息收集中。</p>
<p>我们现在进入正题，一步步开始解决。当然，仍然是用dify演示，但是其他的工作流工具也是类似的。</p>
<h2 data-id="heading-0">1. 优化问题改写节点</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/086dac3ceb884a82a6b20bd0f538f97d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=%2BUKGGaKDPddn1V2Y03IzmL%2F2uX4%3D" alt="对话历史收集" loading="lazy"/>
解决丢失系统回答，无法准确理解用户问题的情况。我的方法是，使用了代码节点，在所有的直接回复节点后面新增代码节点，然后赋值给会话变量。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5701c98ea67e42aabecb81fd83bcd40d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=AbJ3yicvPXZKBmPXiEdIdtR79Wc%3D" alt="" loading="lazy"/>
最终的效果是这个样子的：</p>
<pre><code class="hljs language-markdown" lang="markdown">user: 天气咋样啊
<span class="hljs-section">assistant: 请问您想查询哪个城市的天气呢？
---</span>
user: 北京
<span class="hljs-section">assistant: 没问题，请问您想查询北京哪一天的天气呢？
---</span>
user: 今天的
assistant: 北京 · 2026-01-21  
晴  
-5℃ ~ 4℃  
西北风3级 ｜ 湿度42%  
早晚温差大，外出注意保暖。
</code></pre>
<p>上面的内容是会话变量history，我们创建的时候，记得创建为str类型。变量赋值时，选择覆盖。
这是代码节点的代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">old_history: <span class="hljs-built_in">str</span>, user_query: <span class="hljs-built_in">str</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""
    该函数用于格式化并存储对话历史，最多保留最近 5 轮对话。
    :param old_history: 之前的对话历史字符串
    :param user_query: 当前用户的提问
    :param kwargs: 动态接收来自上游节点的回答（assistant 回答）
    :return: 包含更新后历史记录的字典
    """</span>  
    <span class="hljs-comment"># 1. 初始化当前回答</span>
    current_answer = <span class="hljs-string">""</span>   
    <span class="hljs-comment"># 2. 自动分拣：寻找那个“真正说话了”的分支（从上游变量中提取非空回答）</span>
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> kwargs.items():
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">and</span> <span class="hljs-built_in">str</span>(value).strip() <span class="hljs-keyword">and</span> <span class="hljs-built_in">str</span>(value).lower() != <span class="hljs-string">"none"</span>:
            current_answer = <span class="hljs-built_in">str</span>(value).strip()
            <span class="hljs-keyword">break</span>          
    <span class="hljs-comment"># 3. 空值保护：如果没找到任何回答或用户提问为空，原样返回旧账</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> current_answer <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> user_query:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"result"</span>: old_history <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>}
    <span class="hljs-comment"># 4. 格式化当前轮次</span>
    <span class="hljs-comment"># 在 user 和 assistant 之间增加 \n\n，在对话块前后保持清晰界限</span>
    new_turn = <span class="hljs-string">f"user: <span class="hljs-subst">{user_query.strip()}</span>\n\nassistant: <span class="hljs-subst">{current_answer.strip()}</span>"</span>
    <span class="hljs-comment"># 5. 定义分隔符（用于区分每一轮对话）</span>
    separator = <span class="hljs-string">"\n\n---\n\n"</span>
    <span class="hljs-comment"># 6. 缝合逻辑</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> old_history <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">str</span>(old_history).strip():
        full_history = new_turn
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 去掉旧历史末尾可能存在的空格或换行，再进行缝合</span>
        full_history = <span class="hljs-string">f"<span class="hljs-subst">{old_history.strip()}</span><span class="hljs-subst">{separator}</span><span class="hljs-subst">{new_turn}</span>"</span>   
    <span class="hljs-comment"># 7. 截断逻辑：只保留最近 10 轮</span>
    <span class="hljs-comment"># 使用定义好的 separator 进行精准切割</span>
    history_list = full_history.split(separator)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(history_list) &gt; <span class="hljs-number">10</span>:
        <span class="hljs-comment"># 只取最后 10 个元素</span>
        history_list = history_list[-<span class="hljs-number">10</span>:]      
    <span class="hljs-comment"># 8. 重新组装最终输出</span>
    final_output = separator.join(history_list)
    <span class="hljs-comment"># 返回 Dify 要求的字典格式</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"result"</span>: final_output
    }
</code></pre>
<p>关于对话内容这里，我们简单粗暴的采取了类似记忆节点的丢失策略，就是大于10的话，我们就会把原来的丢弃。主要是考虑到响应时间的问题。
在正式生产环境中，这个位置，我认为，应该搞一个记忆节点，采取压缩策略，而不是直接丢弃。将超过多少轮的对话，走一下记忆分支，进行压缩。
这样，我们就可以将所有的内容，都输入到query改写节点。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e46aa66211fa4f8ab228caaf905433d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=Hv33VeGzdrKf66T5Wit3wsl8fVQ%3D" alt="query改写节点配置" loading="lazy"/></p>
<p>这样，我们可以解决第一个问题，如何确保准确理解用户问题，确保改写正确。</p>
<h2 data-id="heading-1">2. 引入状态机，实现多轮对话</h2>
<p>首先，大家不要被状态机这三个字吓到哈。
其实可以理解为我们有一个笔记本，上面记着我们需要做的事情（to do list），和做成这件事情所必须的东西（参数）。</p>
<p>按照上一代智能客服的分类来说，通常，我们将用户的问题分为以下几类：
FAQ、转人工、单轮任务、多轮任务、闲聊等。
FAQ用大模型来做，就是结合RAG知识库进行回答。
转人工就是智能客服解决不了，或者必须由人工客服完成的需求。
单轮任务，是类似用完即走的。比如银行领域，只要客户登录了，客户问一句，我的账户余额是多少。系统其实只需要校验登录态即可。校验完成，不需要其他任何信息就可以完成任务，直接回复答案。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8c15b488ed479ca42ea0f3aecf2978~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=XS5K58yLpilIl84XhzNmuiSMv1E%3D" alt="问题分类" loading="lazy"/>
难度比较大的是多轮任务，因为多轮任务往往需要和客户确认很多信息。以查询天气为例，我们需要知道用户要查询哪里的天气以及时间。
在智能客服领域，大部分的客户来这里咨询基本都是1-3个主题，用完即走。但是也有部分客户，会咨询很多问题。所以就有可能出现下面的情况：</p>









































<table><thead><tr><th><strong>轮次</strong></th><th><strong>用户输入</strong></th><th><strong>LLM（语义提取与意图映射）</strong></th><th><strong>状态机系统（数据结构维护）</strong></th></tr></thead><tbody><tr><td><strong>01</strong></td><td>“下周三我想从成都开车去拉萨。”</td><td><strong>映射任务：</strong> <code>路径规划</code> <strong>提取槽位：</strong> <code>from: 成都</code>, <code>to: 拉萨</code>, <code>date: 2026-01-28</code></td><td><strong>初始化：</strong> 创建 <code>task_id: 451425c2</code>，压入 <code>task_stack</code>。 <strong>锁逻辑：</strong> <code>global_intent_lock</code> 设置为 <strong>LOCKED</strong>。</td></tr><tr><td><strong>02</strong></td><td>“那边现在冷吗？推荐个保险吧。”</td><td><strong>映射任务：</strong> <code>投保咨询</code> <strong>提取槽位：</strong> <code>type: 旅游险</code> <strong>识别背景：</strong> 用户提及“冷”，关联高原环境。</td><td><strong>任务压栈：</strong> <code>task_stack</code> 顶部新增 <code>投保</code> 任务。当前 <code>current_task</code> 切换为保险。 <strong>状态记录：</strong> <code>stage</code> 设为 <strong>COLLECTING</strong>，此时 <code>slots</code> 中 <code>high_risk_confirm</code>（高风险确认）为 <code>null</code>。</td></tr><tr><td><strong>03</strong></td><td>“会有高原反应吗？保险管这个吗？”</td><td><strong>解析意图：</strong> 知识问答（FAQ） <strong>提取槽位：</strong> 无新槽位。</td><td><strong>中断处理：</strong> 系统识别到这是临时提问。状态机<strong>挂起</strong>当前投保任务，允许 LLM 回答 FAQ，但不改变 <code>current_task</code> 的任务 ID。</td></tr><tr><td><strong>04</strong></td><td>“行，那买一份吧。”</td><td><strong>解析意图：</strong> 确认投保。 <strong>LLM 局限：</strong> LLM 可能会直接跳到支付。</td><td><strong>逻辑拦截：</strong> 状态机检查 <code>current_task_slots</code>。发现“高风险运动确认”仍为 <code>null</code>。 <strong>强制执行：</strong> 状态机拒绝进入 <code>EXECUTING</code> 阶段，强制将 <code>stage</code> 保持在 <strong>COLLECTING</strong>，并指令回复“请确认是否包含攀登等高风险运动”。</td></tr><tr><td><strong>05</strong></td><td>“不去了，改去三亚，那边暖和。”</td><td><strong>解析意图：</strong> 全局意图变更。 <strong>提取槽位：</strong> <code>to: 三亚</code></td><td><strong>级联更新：</strong> 触发 <code>__updated_variables</code>。状态机清空栈内与“高原”相关的保险子任务。 <strong>恢复主任务：</strong> 重新定位到 <code>路径规划</code>，将 <code>to</code> 从拉萨改为三亚。</td></tr></tbody></table>
<p>所以就想我开头举的例子，用户的槽位信息一直在变动，所以全靠大模型来干，相对于写到代码或者用参数值来保存，在提示词中引用最新的槽位和任务状态来说，任务完成率肯定相对来说会有很大的提升。
因此我们引入状态机：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9bd1403b634460ad439ba765fe36e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=Zd3j0B7C2irw%2FFeHC5bsycFgJ5A%3D" alt="状态机dify工作流" loading="lazy"/></p>
<p>在这里，还是主要使用会话变量来进行参数及参数值的存储，使用代码节点来进行状态机的维护，使用变量赋值节点来进行会话变量的更新。
注意，我所有的变量在这里使用的都是str类型（字符串类型），本来想使用json，但是json有两个地方在dify里面不太好。一是json的属性不支持嵌套；二是json不支持直接在llm的提示词中引用。所以我统一使用了str。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0bf33de09424515bde843040e2e2a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=xeS2Pl1WuG7ndNaYjEBWUQaqxSM%3D" alt="会话变量" loading="lazy"/></p>
<p><code>current_task_slots</code>是当前任务的词槽信息或者说，我收集的需要信息，才能去调用工具来进行查询。
<code>current_task</code>是当前的任务。
<code>sys_context_str</code>里面是全量的信息，包含了</p>



























































<table><thead><tr><th><strong>参数名称</strong></th><th><strong>角色</strong></th><th><strong>生活场景类比（理发店）</strong></th><th><strong>专业作用与案例</strong></th></tr></thead><tbody><tr><td><strong><code>global_intent_lock</code></strong></td><td><strong>状态锁 / 忙碌指示灯</strong></td><td><strong>理发师工位上的“正在服务/空闲”指示牌</strong></td><td><strong>作用：</strong> 这是一个全局标记，用来告诉系统当前是否“被占用”。<br/><br/>  <br/><br/>防止在处理复杂任务时，被用户的随意插话打断核心流程。<br/><br/>  <br/>  <br/><br/><strong>案例：</strong> 值是 <code>LOCKED</code>（红灯），表示Tony老师正在剪发，暂时不接新客；值是 <code>UNLOCKED</code>（绿灯），表示随时可以接单。</td></tr><tr><td><strong><code>current_task_id</code></strong></td><td><strong>当前任务ID / 流水号</strong></td><td><strong>理发师手里拿着的那张“排队号小票”</strong></td><td><strong>作用：</strong> 唯一标识当前正在处理的那一个任务，用于系统追踪和日志记录。<br/><br/>  <br/><br/>不管你在任务栈里压了多少事，系统只认这一串ID作为当前焦点。<br/><br/>  <br/>  <br/><br/><strong>案例：</strong> 比如 <code>a1b2c3d4</code>。如果系统报错，工程师可以通过这个ID在后台查到这笔“订单”的所有操作记录。</td></tr><tr><td><strong><code>task_stack</code></strong></td><td><strong>记忆栈 / 待办事项清单</strong></td><td><strong>前台板夹上夹着的一叠“服务单”</strong></td><td><strong>作用：</strong> 这是<strong>多轮对话的灵魂</strong>。它是一个列表（List），按顺序记录了用户未完成的所有需求。采用“后进先出”原则，最后进来的需求最先处理。<br/><br/>  <br/>  <br/><br/><strong>案例：</strong><br/><br/>  <br/><br/>1. 底层单子：查天气（暂挂起）<br/><br/>  <br/><br/>2. 顶层单子：查路线（正在做）<br/><br/>  <br/><br/>当查路线做完后，这张单子被撕掉，理发师就会看到下面那张“查天气”的单子，继续服务。</td></tr><tr><td><strong><code>slots</code></strong><br/><br/>  <br/><br/><em>(位于 task_stack 内部)</em></td><td><strong>槽位信息 / 需求填空表</strong></td><td>服务单上具体的勾选栏：<br/><br/>  <br/><br/>“洗剪吹？染发？什么颜色？”</td><td><strong>作用：</strong> 具体的业务数据容器。机器人多轮追问的过程，本质上就是为了把这些空填满。<br/><br/>  <br/>  <br/><br/><strong>案例：</strong><br/><br/>  <br/><br/>在“查天气”的任务里，<code>slots</code> 就是一张表：<br/><br/>  <br/><br/><code>{ city: "北京", date: null }</code>。<br/><br/>  <br/><br/>因为 <code>date</code> 是空，机器人下一句就会问：“请问您要查哪一天的？”</td></tr><tr><td><strong><code>stage</code></strong><br/><br/>  <br/><br/><em>(位于 task_stack 内部)</em></td><td><strong>任务阶段 / 进度条</strong></td><td>服务单上的印章状态：<br/><br/>  <br/><br/>“待服务”、“进行中”、“已完结”</td><td><strong>作用：</strong> 控制任务的生命周期。只有标记为 <code>DONE</code> 的任务才会被系统清理掉。<br/><br/>  <br/>  <br/><br/><strong>案例：</strong><br/><br/>  <br/><br/><code>COLLECTING</code>：还在问用户要信息（剪发中）。<br/><br/>  <br/><br/><code>DONE</code>：信息收齐了，可以给结果了（剪完洗头送客）。</td></tr><tr><td>看起来还是很复杂哈，不知道有没有把大家给劝退了。我们一步步拆解一下。</td><td/><td/><td/></tr><tr><td><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce6634950a914cce98ea2b9b65aa6927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=u%2F6AXG2iHLH649zRbIFyzdYOlH8%3D" alt="状态机核心" loading="lazy"/></td><td/><td/><td/></tr><tr><td>用户输入一个问题，我需要结合历史的对话信息对这个问题进行改写，这样呢，就变相的实现了llm的记忆。接下来，按照思路，我们肯定需要一个路由，来区分用户的问题到底是分给谁来处理，用户的问题是一个FAQ？一个单轮任务？还是要求转人工呢？</td><td/><td/><td/></tr></tbody></table>
<p>所以我们就有了这样的工作流的开头：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ba775db3f194b38ab22a240b2e15f3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=Cq3lL8Jd7qLbA713kIVLgn4B1ps%3D" alt="问题分类及路由" loading="lazy"/></p>
<p>很好，现在我们知道用户这次想要做什么了，知道该给谁了，但是我们刚刚搞了一个笔记本，所以这里就要抓紧去维护一下笔记本的状态。但是大家也看到了刚刚的笔记本结构比较复杂，我们不能用简单的变量追加、覆盖处理。所以我们需要使用一个代码节点来做这个事情。代码节点，更新完笔记的内容，我们要写下来，所以需要变量赋值节点赋值给会话变量。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8215afa85f441191c7cf70cec3d70a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=0QhCcNyq0dAnyBxKJ7SLjMPRSj8%3D" alt="代码节点维护状态机" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc602653a00a404ab648b46bae85967c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=%2FDyulVp9ouHYjbJ9xSfx7g7c5yM%3D" alt="状态机核心管理" loading="lazy"/></p>
<p>ok，至此，其实本次多轮对话的核心升级就完成了。下面都是为了逻辑更加流畅。
因为代码节点的代码比较长，所以这里我就不贴出来了。大家如有兴趣，请在评论区留言，我会提供代码或者DSL。</p>
<p>接下来，我们判断是不是多轮对话，如果不是，就直接进入最终的判断分支进行了路由，如果是，那就需要进行信息提取节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93a2246aa1814f57acfff8c47728bca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=DbOcE5UL6gk4Q701qGie2m1A%2Fx8%3D" alt="多轮任务信息提取详解" loading="lazy"/>
词槽不全就追问客户。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91a45a4897aa413ab33f12aa12a12c56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=2fSTS6PRm0f5789S1lcU%2BEcFYzE%3D" alt="追问词槽" loading="lazy"/>
追问节点的提示词写的也比较简单，主要是想要验证想法，供大家参考：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Role</span>
你是一个专业的对话意图澄清助手。你的工作是根据当前的任务状态和已收集的信息，判断还缺少哪些关键信息，并向用户发起追问。
<span class="hljs-section"># Context</span>
用户正在进行一项多轮对话任务，系统维护了一个“状态机”来记录任务进度。
<span class="hljs-section"># Goal</span>
请检查 <span class="hljs-code">`task_slots`</span> 中 value 为 <span class="hljs-code">`null`</span> 或 <span class="hljs-code">`None`</span> 或 空字符串 的字段。
生成一句简短、自然、礼貌的追问，引导用户补充这些缺失的信息。
<span class="hljs-section"># Constraints</span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**只追问缺失项**</span>：不要提及已经填好的项，除非为了确认上下文（例如“好的，关于北京的天气，请问是哪一天？”）。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**一次问一个**</span>：如果缺多个槽位，优先追问逻辑上最靠前或最重要的一个，不要一次性甩出一堆问题，保持对话的交互感。
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**口语化**</span>：不要使用“请输入参数 city”这种技术语言，要说“请问您想查询哪个城市？”。
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**输出格式**</span>：直接输出追问的话术，不要包含任何 JSON、Markdown 标记或额外解释。
<span class="hljs-section"># Examples</span>
<span class="hljs-section">## Example 1</span>
Input:
Task: 查询天气
Slots: {"city": "上海", "date": null}

Output:
没问题，请问您想查询上海哪一天的天气呢？

<span class="hljs-section">## Example 2</span>
Input:
Task: 查询路线
Slots: {"origin": null, "destination": "北京西站"}

Output:
收到，那您的出发地是哪里？

<span class="hljs-section">## Example 3</span>
Input:
Task: 预订会议室
Slots: {"time": null, "people": null}

Output:
好的，请问您计划在这个会议室开会的时间大概是几点？
</code></pre>
<p>如果路由到FAQ，那我们就检索知识库；路由到单轮任务，我们就直接调用api回答用户。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467df9c90a1a409fad232b65ef9cb948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=Uck2%2BECoBvpdSEqEpoj92RU2Hyw%3D" alt="完成任务" loading="lazy"/>
因为主要是为了模拟，所以agent节点的配置就特别简单，我没有设置很复杂的提示词。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90cdf96e017e40458568e0e360a6f47c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=d0yEmxb6DsD5B%2B8%2Bs7CUmSAnNaM%3D" alt="agent节点" loading="lazy"/>
最终实现的效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb88947041e8454991aeb4bd2f0e035e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=iEA1q%2BmFNKDGgzLOP4o2JYsDW8A%3D" alt="多轮对话" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd9036c88f3485599b376998cd7d3aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=jCyUR5mHBGl1aQWroFlz0S%2FMca8%3D" alt="多意图未处理" loading="lazy"/></p>
<p>综合下来，我们的这个新的工作流的整体思路其实就是这个样子：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b2b09b1926c4065b80beb7cd20123ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=FHke%2F1BKqRs3XmuENIdzuiZhGBU%3D" alt="多轮对话完整工作流" loading="lazy"/></p>
<h2 data-id="heading-2">3. 小结</h2>
<p>上面说的内容，可能没有第一次那么细，但是主体思路应该是讲明白了。
<strong>使用状态机，对会话状态进行管理</strong>。
使用了多个LLM节点，<strong>完成不同的任务，让他们专注于自己的任务</strong>，从而提高成功率。</p>
<p>这个版本仍然有很多的问题，但是主体结构已经完成了。还<strong>需要解决的问题如下</strong>：</p>
<ol>
<li>响应时间比较长（LLM节点太多了）</li>
<li>每个节点没有做异常分支处理。例如什么时候转人工。</li>
<li>对最终的回答，没有进行内容审核，确保不生成不合规内容。</li>
<li>没有对多意图进行处理，比如一句话有两个多轮任务。</li>
<li>没有做详细的测试，设置任务成功率、拒识率、转人工率、一次性完成率、准确率等指标的相关统计及测试优化。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6762eac7f4345dfa17dc49edb48200d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCP6YOo5L6N6YOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769676739&amp;x-signature=40CH2gpKF%2BW0aH2hvL673Gg%2Fg0c%3D" alt="方案待优化的问题" loading="lazy"/></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemUI 开发之如何监听到通知的（五）]]></title>    <link>https://juejin.cn/post/7597375708768190464</link>    <guid>https://juejin.cn/post/7597375708768190464</guid>    <pubDate>2026-01-21T07:09:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597375708768190464" data-draft-id="7597379486427512858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemUI 开发之如何监听到通知的（五）"/> <meta itemprop="keywords" content="Android,Java,Kotlin"/> <meta itemprop="datePublished" content="2026-01-21T07:09:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemUI 开发之如何监听到通知的（五）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T07:09:06.000Z" title="Wed Jan 21 2026 07:09:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SystemUI 开发之如何监听到通知的（五）</h2>
<p>在 <a href="https://juejin.cn/post/7115211390226268197" target="_blank" title="https://juejin.cn/post/7115211390226268197">《<strong>SystemUI 开发之通知的实现逻辑（四）</strong>》</a>一文中曾提到过 SystemUI 是通过 <code>NotificationListenerService</code> 来实现监听的，本文将回答以下问题：</p>
<ul>
<li><code>NotificationManagerService</code> 与 <code>NotificationListenerService</code> 关系是什么？</li>
<li>它们在 framework 中是如何工作的？</li>
</ul>
<blockquote>
<p>以下分析基于 Android 11 源码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fandroid-11.0.0_r40%3A" target="_blank" title="https://cs.android.com/android/platform/superproject/+/android-11.0.0_r40:" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></p>
</blockquote>
<p>在 Android 系统中，通知系统是一个典型的<strong>生产者-消费者模型</strong>。<code>NotificationManagerService</code> (NMS) 负责管理与分发，而 <code>NotificationListenerService</code> (NLS) 负责监听与呈现。</p>
<h3 data-id="heading-1">0x00. NotificationManagerService 启动</h3>
<p>Android 系统在启动时通过 <code>SystemServer.startOtherServices()</code> 方法通过<code>SystemServiceManager</code> 启动了 <code>NotificationManagerService</code> 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Starts a miscellaneous grab bag of stuff that has yet to be refactored and organized.
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t)</span> {
		...
		t.traceBegin(<span class="hljs-string">"StartNotificationManager"</span>);
		mSystemServiceManager.startService(NotificationManagerService.class);
		SystemNotificationChannels.removeDeprecated(context);
		SystemNotificationChannels.createAll(context);
		notification = INotificationManager.Stub.asInterface(
		        ServiceManager.getService(Context.NOTIFICATION_SERVICE));
		t.traceEnd();
		...
}
</code></pre>
<p><code>SystemServiceManager.startService()</code> 方法中通过反射获取到系统服务的实例，并执行了系统服务类的 <code>onStart()</code> 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span>&gt; T <span class="hljs-title function_">startService</span><span class="hljs-params">(Class&lt;T&gt; serviceClass)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> serviceClass.getName();
            Slog.i(TAG, <span class="hljs-string">"Starting "</span> + name);
            Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="hljs-string">"StartService "</span> + name);

            <span class="hljs-comment">// Create the service.</span>
            <span class="hljs-keyword">if</span> (!SystemService.class.isAssignableFrom(serviceClass)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to create "</span> + name
                        + <span class="hljs-string">": service must extend "</span> + SystemService.class.getName());
            }
            <span class="hljs-keyword">final</span> T service;
            <span class="hljs-keyword">try</span> {
                Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);
                service = constructor.newInstance(mContext);
            } ...

            startService(service);
            <span class="hljs-keyword">return</span> service;
        } <span class="hljs-keyword">finally</span> {
            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);
        }
}
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startService</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> SystemService service)</span> {
        <span class="hljs-comment">// Register it.</span>
        mServices.add(service);
        <span class="hljs-comment">// Start it.</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime();
        <span class="hljs-keyword">try</span> {
		        <span class="hljs-comment">// 执行服务的onStart方法</span>
            service.onStart();
        } <span class="hljs-keyword">catch</span> (RuntimeException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to start service "</span> + service.getClass().getName()
                    + <span class="hljs-string">": onStart threw an exception"</span>, ex);
        }
        warnIfTooLong(SystemClock.elapsedRealtime() - time, service, <span class="hljs-string">"onStart"</span>);
    }
</code></pre>
<p><code>NotificationManagerService.onStart()</code> 中将服务进行注册到 <code>ServiceManager</code> 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
	...
	<span class="hljs-comment">// 将NMS注册到服务中心中进行管理</span>
	publishBinderService(Context.NOTIFICATION_SERVICE, mService, <span class="hljs-comment">/* allowIsolated= */</span> <span class="hljs-literal">false</span>,
                DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PRIORITY_NORMAL);
  publishLocalService(NotificationManagerInternal.class, mInternalService);
}
</code></pre>
<p>至此就可以通过以下方式获取 <code>NotificationManagerService</code> 的对象了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这个方法在内部会判断如果是同一个进程则会直接返回当前进程中的Stub对象，否则会返回Proxy对象</span>
INotificationManager.Stub.asInterface(
		        ServiceManager.getService(Context.NOTIFICATION_SERVICE))
</code></pre>
<p>NMS启动后，SystemServer 内部还紧接着通过 <code>INotificationManager.Stub.asInterface( 		        ServiceManager.getService(Context.NOTIFICATION_SERVICE))</code>获取一个 Binder 代理。</p>
<p><strong>目的</strong>：虽然在同进程，但使用代理是为了确保初始化时序的安全性，并方便将该接口注入到后续启动的 <code>StatusBarManagerService</code> 或 <code>WindowManagerService</code> 中，维持架构的解耦和一致性。</p>
<h3 data-id="heading-2">0x01. SystemUI 中是如何启动注册 NotificationListenerService 的？</h3>
<p>与普通应用不同，SystemUI 的通知监听器采用的是<strong>动态注册</strong>机制，而非单纯依靠 Manifest 的静态声明。</p>
<ul>
<li><strong>初始化</strong>：SystemUI 启动时，通过 Dagger 注入并初始化 <code>com.android.systemui.statusbar.NotificationListener</code> 类。</li>
<li><strong>注册入口 <code>StatusBar.start()</code></strong></li>
</ul>
<p>在 <code>StatusBar.start()</code> 中通过 <code>mNotificationsController.initialize()</code> 方法执行了
<code>notificationListener.registerAsSystemService()</code>  方法将 <code>NotificationListenerService</code>  注册到 NMS 中的。</p>
<p><code>NotificationListenerService.registerAsSystemService()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAsSystemService</span><span class="hljs-params">()</span> {
      <span class="hljs-keyword">try</span> {
	        <span class="hljs-comment">// 这个方法是 NotificationListenerService 的内部方法</span>
          registerAsSystemService(mContext,
                  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(mContext.getPackageName(), getClass().getCanonicalName()),
                  UserHandle.USER_ALL);
      } <span class="hljs-keyword">catch</span> (RemoteException e) {
          Log.e(TAG, <span class="hljs-string">"Unable to register notification listener"</span>, e);
      }
}
</code></pre>
<p>该方法是 <code>NotificationListenerService</code> 为系统组件提供的特权接口。它会调用 AIDL 接口 <code>INotificationManager.registerListener</code>，将 SystemUI 的代理对象（Stub）直接传递给 NMS。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SystemApi</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAsSystemService</span><span class="hljs-params">(Context context, ComponentName componentName,
        <span class="hljs-type">int</span> currentUser)</span> <span class="hljs-keyword">throws</span> RemoteException {
    <span class="hljs-keyword">if</span> (mWrapper == <span class="hljs-literal">null</span>) {
        mWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationListenerWrapper</span>();
    }
    mSystemContext = context;
    <span class="hljs-comment">// 通过 NotificationManagerService 的 Binder 的客户端代理对象把NLS注册进去</span>
    <span class="hljs-type">INotificationManager</span> <span class="hljs-variable">noMan</span> <span class="hljs-operator">=</span> getNotificationInterface();
    mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyHandler</span>(context.getMainLooper());
    mCurrentUser = currentUser;
    <span class="hljs-comment">// 注意这里把 mWrapper 这个Binder对象传给了 NMS，这个类实现了INotification.Stub接口，</span>
    <span class="hljs-comment">// 此时NMS就可以拿到 SystemUI 中“句柄” </span>
    noMan.registerListener(mWrapper, componentName, currentUser);
}
<span class="hljs-comment">// 获取NMS的代理对象</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> INotificationManager <span class="hljs-title function_">getNotificationInterface</span><span class="hljs-params">()</span> {
      <span class="hljs-keyword">if</span> (mNoMan == <span class="hljs-literal">null</span>) {
          mNoMan = INotificationManager.Stub.asInterface(
                ServiceManager.getService(Context.NOTIFICATION_SERVICE));
      }
      <span class="hljs-keyword">return</span> mNoMan;
}
    
<span class="hljs-comment">// NMS 通过这个回调接口“告诉”SystemUI 通知的添加、删除、更新等操作</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationListenerWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">INotificationListener</span>.Stub {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNotificationPosted</span><span class="hljs-params">(IStatusBarNotificationHolder sbnHolder,
            NotificationRankingUpdate update)</span> {
            <span class="hljs-comment">// 通知到达</span>
            <span class="hljs-comment">//...代码省略</span>
   }
   
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNotificationRemoved</span><span class="hljs-params">(IStatusBarNotificationHolder sbnHolder,
            NotificationRankingUpdate update, NotificationStats stats, <span class="hljs-type">int</span> reason)</span> {
			      <span class="hljs-comment">// 通知移除</span>
			      <span class="hljs-comment">//...代码省略</span>
   }
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNotificationRankingUpdate</span><span class="hljs-params">(NotificationRankingUpdate update)</span>
            <span class="hljs-keyword">throws</span> RemoteException {
		       <span class="hljs-comment">// 排序更新</span>
		       <span class="hljs-comment">//...代码省略</span>
   }        
   ...         
}
</code></pre>
<p><code>NotificationListenerWrapper</code> 是一个 Binder 对象，它是 <code>NotificationListenerService</code> 内部实现了 Stub 定义的回调接口，它的作用是传递给NMS后，后续会有通过这个它来“告诉”SystemUI:“通知来了”。</p>
<h3 data-id="heading-3">0x02. NotificationListenerService 内部是如何与 NotificationManagerService 交互的？</h3>
<p>实际上在 SystemUI 中 是使用 <code>NotificationListener</code> 类扩展 <code>NotificationListenerService</code> ，<code>NMS</code> 在上一步注册也拿到了<code>NLS</code>的 Binder 对象，而 <code>NLS</code> 也会获取 <code>NMS</code> 的代理对象，它们之间的关系如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9098db5b37874288aa82343bf6746909~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSk5oCS55qE5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769584146&amp;x-signature=YOH5DdyIs0dKOJG7aQRluuBPxtE%3D" alt="NMS-NLS关系图.png" loading="lazy"/></p>
<p>两者的交互建立在<strong>双向 Binder IPC</strong> 基础之上。</p>
<ul>
<li>
<p>下行：数据感知（<code>NMS -&gt; NLS</code>）</p>
<p><code>NLS</code> 内部持有一个 <code>NotificationListenerWrapper</code>（实现 <code>INotificationListener.Stub</code>）。当 NMS 侧有通知增删改时，会通过这个 Stub 回调 NLS 的 <code>onNotificationPosted()</code> 或 <code>onNotificationRemoved()</code>。</p>
</li>
<li>
<p>上行：操作反馈（<code>NLS -&gt; NMS</code>）</p>
<p><code>NLS</code> 通过 <code>getNotificationInterface()</code> 获取 <code>INotificationManager</code> 的 Binder 代理。当用户在 SystemUI 上滑动删除一条通知时，SystemUI 会通过该代理调用 NMS 的 <code>cancelNotificationFromListener</code></p>
</li>
<li>
<p>数据媒介 <code>RankingMap</code></p>
<p>为了优化性能，<code>NMS</code> 不会频繁传递全量数据。它通过 <code>RankingMap</code> 告知 <code>NLS</code> 通知的优先级、分组、可见性等元数据的变更，<code>NLS</code> 收到后在本地进行 UI 排序。</p>
</li>
</ul>
<h3 data-id="heading-4">0x03. NotificationManagerService 是如何工作的？</h3>
<p><code>NMS</code> 运行在 <code>system_server</code> 进程中，是通知系统的中枢。</p>
<h4 data-id="heading-5">1. NMS 如何收到各个应用的通知？</h4>
<p>应用进程调用 <code>NotificationManager.notify()</code>，最终通过 Binder 跨进程调用 <code>NMS</code>。</p>
<ul>
<li>
<p><strong>入口点</strong>：在 <code>NMS</code> 中，最核心的入口是 <code>enqueueNotificationInternal</code>。</p>
</li>
<li>
<p><strong>封包转化</strong>：NMS 首先将应用传来的数据转化为 <code>NotificationRecord</code> 对象。这是一个承载通知所有生命周期的“重型”对象。</p>
</li>
<li>
<p>流量控制（限流）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_PACKAGE_NOTIFICATIONS</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>; <span class="hljs-comment">// 单个应用最多 50 条通知</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">DEFAULT_MAX_NOTIFICATION_ENQUEUE_RATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5f</span>; <span class="hljs-comment">// 每秒最多入队 5 条</span>
</code></pre>
<p>NMS 会检查 <code>mMaxPackageEnqueueRate</code>，如果应用发送频率过快，会抛出异常或丢弃通知，防止恶意应用撑爆系统内存。</p>
</li>
<li>
<p><strong>异步处理</strong>：NMS 接收到请求后，不会在 Binder 线程同步处理，而是通过 <code>Handler</code>发送一个 <code>EnqueueNotificationRunnable</code> 到工作线程，以保证系统服务的响应性。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-6">2. NMS 是如何管理这些通知的？</h4>
<p>管理的核心在于<strong>内存缓存</strong>和<strong>生命周期追踪</strong>。NMS 使用了一系列受锁保护的数据结构：</p>
<ul>
<li>
<p><strong>核心存储容器</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GuardedBy("mNotificationLock")</span>
<span class="hljs-keyword">final</span> ArrayList&lt;NotificationRecord&gt; mNotificationList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">// 当前显示的所有通知列表</span>
<span class="hljs-meta">@GuardedBy("mNotificationLock")</span>
<span class="hljs-keyword">final</span> ArrayMap&lt;String, NotificationRecord&gt; mNotificationsByKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;(); <span class="hljs-comment">// 以 Key 索引，方便快速查找</span>
<span class="hljs-meta">@GuardedBy("mNotificationLock")</span>
<span class="hljs-keyword">final</span> ArrayList&lt;NotificationRecord&gt; mEnqueuedNotifications = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">// 正在排队等待处理的通知</span>
</code></pre>
</li>
<li>
<p><strong>分类管理</strong>：</p>
<ul>
<li><strong>Group（分组）管理</strong>：使用 <code>mSummaryByGroupKey</code>。如果应用设置了 GroupKey，NMS 会自动处理聚合逻辑，甚至在满足一定条件时（代码中的 <code>mAutoGroupAtCount</code>）自动进行 “Auto-bundle” 归类。</li>
<li><strong>Archive（归档）</strong>：代码中的 <code>Archive</code> 类负责记录已消失的通知历史，供“通知历史”功能调用。它使用了轻量级拷贝 <code>sbn.cloneLight()</code>，防止历史记录占用过多内存。</li>
</ul>
</li>
<li>
<p><strong>状态维护</strong>：<code>NMS</code> 通过 <code>mNotificationLock</code> 对象同步所有操作，确保在多线程环境下（如：应用入队通知的同时，用户在侧滑删除通知）数据的一致性。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-7">3. 如何给这些通知排序的？</h4>
<p>排序是通过 <strong><code>RankingHelper</code></strong> 和专门的 <strong><code>RankingThread</code></strong> 实现。</p>
<p><strong><code>RankingHelper</code></strong> 采用了<strong>双次排序法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(ArrayList&lt;NotificationRecord&gt; notificationList)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> notificationList.size();
    <span class="hljs-comment">// clear global sort keys</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> N - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        notificationList.get(i).setGlobalSortKey(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// rank each record individually</span>
    <span class="hljs-comment">// 第一次排序：先使用 mPreliminaryComparator 对所有原始通知进行一次基础排序。</span>
    Collections.sort(notificationList, mPreliminaryComparator);

    <span class="hljs-keyword">synchronized</span> (mProxyByGroupTmp) {
        <span class="hljs-comment">// record individual ranking result and nominate proxies for each group</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">NotificationRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> notificationList.get(i);
            record.setAuthoritativeRank(i);
            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> record.getGroupKey();
            <span class="hljs-type">NotificationRecord</span> <span class="hljs-variable">existingProxy</span> <span class="hljs-operator">=</span> mProxyByGroupTmp.get(groupKey);
            <span class="hljs-keyword">if</span> (existingProxy == <span class="hljs-literal">null</span>) {
                mProxyByGroupTmp.put(groupKey, record);
            }
        }
        <span class="hljs-comment">// assign global sort key:</span>
        <span class="hljs-comment">//   is_recently_intrusive:group_rank:is_group_summary:group_sort_key:rank</span>
        <span class="hljs-comment">// 构造全局排序键</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">NotificationRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> notificationList.get(i);
            <span class="hljs-type">NotificationRecord</span> <span class="hljs-variable">groupProxy</span> <span class="hljs-operator">=</span> mProxyByGroupTmp.get(record.getGroupKey());
            <span class="hljs-type">String</span> <span class="hljs-variable">groupSortKey</span> <span class="hljs-operator">=</span> record.getNotification().getSortKey();

            <span class="hljs-comment">// We need to make sure the developer provided group sort key (gsk) is handled</span>
            <span class="hljs-comment">// correctly:</span>
            <span class="hljs-comment">//   gsk="" &lt; gsk=non-null-string &lt; gsk=null</span>
            <span class="hljs-comment">//</span>
            <span class="hljs-comment">// We enforce this by using different prefixes for these three cases.</span>
            String groupSortKeyPortion;
            <span class="hljs-keyword">if</span> (groupSortKey == <span class="hljs-literal">null</span>) {
                groupSortKeyPortion = <span class="hljs-string">"nsk"</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (groupSortKey.equals(<span class="hljs-string">""</span>)) {
                groupSortKeyPortion = <span class="hljs-string">"esk"</span>;
            } <span class="hljs-keyword">else</span> {
                groupSortKeyPortion = <span class="hljs-string">"gsk="</span> + groupSortKey;
            }

            <span class="hljs-type">boolean</span> <span class="hljs-variable">isGroupSummary</span> <span class="hljs-operator">=</span> record.getNotification().isGroupSummary();
            record.setGlobalSortKey(
                    String.format(<span class="hljs-string">"crtcl=0x%04x:intrsv=%c:grnk=0x%04x:gsmry=%c:%s:rnk=0x%04x"</span>,
                    record.getCriticality(),
                    record.isRecentlyIntrusive()
                            &amp;&amp; record.getImportance() &gt; NotificationManager.IMPORTANCE_MIN
                            ? <span class="hljs-string">'0'</span> : <span class="hljs-string">'1'</span>,
                    groupProxy.getAuthoritativeRank(),
                    isGroupSummary ? <span class="hljs-string">'0'</span> : <span class="hljs-string">'1'</span>,
                    groupSortKeyPortion,
                    record.getAuthoritativeRank()));
        }
        mProxyByGroupTmp.clear();
    }

    <span class="hljs-comment">// Do a second ranking pass, using group proxies</span>
    <span class="hljs-comment">// 第二次排序：终极排序</span>
    Collections.sort(notificationList, mFinalComparator);
}
</code></pre>
<ul>
<li>
<p><code>RankingHelper</code> 的作用是排序逻辑的封装。</p>
<p>它负责根据以下维度计算分数：</p>
<ol>
<li><strong>Importance（重要性）</strong>：如 <code>IMPORTANCE_LOW</code>、<code>IMPORTANCE_MIN</code> 等。</li>
<li><strong>ZenMode（禅定模式/勿扰）</strong>：<code>mInterruptionFilter</code> 决定了哪些通知该“闭嘴”。</li>
<li><strong>用户偏好</strong>：用户是否手动置顶了某个频道。</li>
<li><strong>会话属性</strong>：Android 11 强化的 <code>mMsgPkgsAllowedAsConvos</code>（允许作为会话的包名），对话类通知通常有更高的权重。</li>
</ol>
</li>
<li>
<p>异步排序机制：</p>
<p>排序是消耗 CPU 的操作。<code>NMS</code> 维护了一个名为 "ranker" 的 <code>HandlerThread</code> 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">HandlerThread</span> <span class="hljs-variable">mRankingThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">"ranker"</span>, Process.THREAD_PRIORITY_BACKGROUND);
</code></pre>
<p>当通知状态改变时，会发送 <code>MESSAGE_RANKING_SORT</code> 消息。排序完成后，通过 <code>MESSAGE_SEND_RANKING_UPDATE</code> 消息通知 SystemUI。</p>
</li>
<li>
<p>通知分发给 SystemUI：</p>
<p>排序结果封装在 <code>NotificationRankingUpdate</code> 中，通过 <code>mListeners</code>（通知监听器管理器）分发给 SystemUI 进程。</p>
</li>
</ul>
<p><strong>引用</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fandroid-11.0.0_r40%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fnotification%2FNotificationManagerService.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/android-11.0.0_r40:frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fandroid-11.0.0_r40%3Aframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fservice%2Fnotification%2FNotificationListenerService.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/android-11.0.0_r40:frameworks/base/core/java/android/service/notification/NotificationListenerService.java" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 掌握 Git Merge 与 Rebase 避免代码冲突]]></title>    <link>https://juejin.cn/post/7597317683051560969</link>    <guid>https://juejin.cn/post/7597317683051560969</guid>    <pubDate>2026-01-20T23:19:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597317683051560969" data-draft-id="7597258378590928906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 掌握 Git Merge 与 Rebase 避免代码冲突"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-20T23:19:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 掌握 Git Merge 与 Rebase 避免代码冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T23:19:43.000Z" title="Tue Jan 20 2026 23:19:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2026 年 掌握 Git Merge 与 Rebase 避免代码冲突</h2>
<h3 data-id="heading-1">为什么 Git Merge 和 Rebase 依然重要</h3>
<p>在现代软件开发中，多人协作同一代码库已是常态。Git 这类版本控制系统的设计初衷，就是让团队能够同时在不同分支上工作。然而，这种自由也带来了挑战：当需要整合这些分支时，如何管理代码变更、解决冲突？Git 提供了两种主要的合并工具：Git Merge 和 Git Rebase。</p>
<p>这两种操作都能将一个分支的变更合并到另一个分支，但实现方式不同。理解它们的区别，对于保持代码库整洁、避免不必要的冲突、确保项目历史清晰可追溯至关重要。</p>
<p>本文将详细拆解 Git Merge 和 Git Rebase，配合实际示例，帮助你理解何时该用哪一种。读完之后，你将对这两种 Git 策略有扎实的掌握，能够避免那些导致代码冲突的常见陷阱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fmastering-git-merge-rebase-avoid-code-conflicts" target="_blank" title="https://catchadmin.com/post/2026-01/mastering-git-merge-rebase-avoid-code-conflicts" ref="nofollow noopener noreferrer">原文 2026 年 掌握 Git Merge 与 Rebase 避免代码冲突</a></p>
<h3 data-id="heading-2">什么是 Git Merge？</h3>
<p>Git Merge 是 Git 的基础操作之一，用于将一个分支的变更合并到另一个分支。通常用于将功能分支整合到主分支（一般叫 <code>main</code> 或 <code>master</code>）。Git Merge 会保留两个分支的历史，双方的变更都完整保留。</p>
<p>执行 merge 时，Git 会尝试自动合并两个分支的变更。如果遇到冲突——即两个分支以不兼容的方式修改了同一段代码——Git 会停下来，要求你手动解决冲突。解决后，提交变更即可完成合并。</p>
<h4 data-id="heading-3">Git Merge 工作流示例</h4>
<p>假设你在 <code>feature-branch</code> 上开发，想把它合并到 <code>main</code> 分支。操作步骤如下：</p>
<ol>
<li>先切换到 <code>main</code> 分支（即目标分支）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git checkout main
</code></pre>
<ol start="2">
<li>执行合并：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git merge feature-branch
</code></pre>
<p>如果没有冲突，Git 会自动创建一个合并提交（merge commit），将两个分支合并。如果有冲突，Git 会暂停并提示哪些文件需要处理。</p>
<ol start="3">
<li>解决 Git 标记的冲突文件，解决后标记为已解决：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git add &lt;conflicted-file&gt;
</code></pre>
<ol start="4">
<li>提交完成合并：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git commit
</code></pre>
<p>这样会生成一个合并提交，记录两个分支的合并。提交历史现在会显示 <code>feature-branch</code> 被合并进了 <code>main</code>，双方历史都得以保留。</p>
<h4 data-id="heading-4">Git Merge 的优缺点</h4>
<p><strong>优点：</strong></p>
<ul>
<li><strong>协作安全</strong>：Merge 不会修改提交历史，适合团队协作。每个开发者都能清楚看到代码的演变过程。</li>
<li><strong>分支历史清晰</strong>：合并提交明确显示分支何时分叉、何时整合，完整保留历史。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>提交历史可能杂乱</strong>：频繁合并会让历史变得混乱，尤其是多个功能分支加上多个合并提交时，追踪特定变更会变得困难。</li>
<li><strong>合并提交有时显得多余</strong>：如果你更喜欢线性历史，合并提交可能会给项目历史增加噪音。</li>
</ul>
<h3 data-id="heading-5">什么是 Git Rebase？</h3>
<p>Git Rebase 是另一种整合分支变更的方式，但它通过重写提交历史来实现。与 Git Merge 创建合并提交不同，Git Rebase 会把你的变更重新应用到目标分支（通常是 <code>main</code>）之上，形成线性的提交历史，没有合并提交。</p>
<p>Rebase 能让项目历史更干净，因为它消除了不必要的合并提交。但 rebase 会重写提交历史，在协作环境中可能带来风险，尤其是当你已经把分支推送给其他人时。</p>
<h4 data-id="heading-6">Git Rebase 工作流示例</h4>
<p>假设你在 <code>feature-branch</code> 上开发，想把它 rebase 到 <code>main</code> 分支以获取最新变更。操作步骤如下：</p>
<ol>
<li>先切换到你的 <code>feature-branch</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git checkout feature-branch
</code></pre>
<ol start="2">
<li>将 <code>feature-branch</code> rebase 到 <code>main</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git rebase main
</code></pre>
<p>Git 会把 <code>feature-branch</code> 上的提交逐个重放到当前 <code>main</code> 分支之上，相当于让 <code>feature-branch</code> 包含了 <code>main</code> 的所有最新变更。如果没有冲突，rebase 会自动完成。</p>
<ol start="3">
<li>解决 rebase 过程中出现的冲突。Git 会在每个冲突处停下来让你处理：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决文件中的冲突</span>
git add &lt;conflicted-file&gt;
</code></pre>
<ol start="4">
<li>解决每个冲突后继续 rebase：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git rebase --<span class="hljs-built_in">continue</span>
</code></pre>
<ol start="5">
<li>将 rebase 后的分支推送到远程仓库（注意：如果之前已经推送过这个分支，可能需要强制推送）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git push --force
</code></pre>
<p>现在，你的 <code>feature-branch</code> 在 <code>main</code> 之上有了线性的提交历史，可以创建 pull request 合并到 <code>main</code> 了。</p>
<h4 data-id="heading-7">Git Rebase 的优缺点</h4>
<p><strong>优点：</strong></p>
<ul>
<li><strong>干净的线性历史</strong>：Rebase 避免了合并提交的杂乱，项目历史更简洁易懂。</li>
<li><strong>简化代码审查</strong>：线性历史让审查者更容易跟踪代码演变，理解每个变更。</li>
<li><strong>避免不必要的合并提交</strong>：频繁与主分支同步时，rebase 能保持历史整洁。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>重写提交历史</strong>：Rebase 会改变提交历史，在团队协作中可能引发问题。如果其他人基于你的分支工作，rebase 可能导致冲突和混乱。</li>
<li><strong>出错风险</strong>：使用不当时，rebase 可能导致提交丢失或混乱，尤其是对解决 rebase 冲突不熟练的情况下。</li>
</ul>
<h3 data-id="heading-8">Git Merge 与 Git Rebase 的核心区别</h3>
<p>选择使用哪种策略时，理解两者的区别很重要。以下是对比概览：</p>
<p><strong>提交历史：</strong>
Git Merge 保留提交历史，创建一个新的合并提交来整合分支。这保持了历史完整，但频繁合并可能导致提交日志杂乱。而 Git Rebase 重写提交历史，生成干净的线性提交序列，没有合并提交。</p>
<p><strong>冲突解决：</strong>
Merge 时，冲突在合并发起后解决。Git 会停下来让你解决冲突后再继续。Rebase 时，冲突在 rebase 过程中解决，因为每个提交是逐个重新应用的，需要在每一步解决冲突。</p>
<p><strong>协作场景：</strong>
Git Merge 在协作环境中通常更安全，因为它不重写历史，适合在共享分支上使用。Rebase 会重写历史，可能给基于你分支工作的同事带来问题。在私有分支或没有其他人在用的分支上 rebase 更安全。</p>
<p><strong>历史清晰度：</strong>
Rebase 通过消除合并提交提供更干净的线性历史，适合希望开发历史呈直线的场景。合并提交虽然保留了更多历史信息，但可能导致更复杂的提交历史，浏览和审查起来更困难。</p>
<h3 data-id="heading-9">最佳实践：何时用 Merge，何时用 Rebase</h3>
<p><strong>使用 Git Merge 的场景：</strong></p>
<ul>
<li>想保留分支开发的完整历史</li>
<li>在共享分支上工作，需要避免重写历史</li>
<li>想清楚看到不同分支何时被整合</li>
<li>能接受稍复杂的历史，只要它反映了每个分支的贡献</li>
</ul>
<p><strong>使用 Git Rebase 的场景：</strong></p>
<ul>
<li>想保持干净的线性历史，尤其是在将功能分支合并到 <code>main</code> 之前</li>
<li>独自在功能分支上工作，想与 <code>main</code> 保持同步但不想产生不必要的合并提交</li>
<li>想在提交 pull request 前简化提交历史，方便审查</li>
</ul>
<h3 data-id="heading-10">常见错误及避免方法</h3>
<ul>
<li><strong>在共享分支上 Rebase</strong>：Git Rebase 最常见的错误是在其他人正在使用的分支上重写历史，这会给队友带来困惑和错误。</li>
<li><strong>冲突解决不当</strong>：无论用 merge 还是 rebase，都要仔细解决冲突。跳过这一步可能导致代码损坏或变更丢失。</li>
<li><strong>Rebase 后忘记推送</strong>：如果 rebase 后忘记强制推送，远程分支不会反映 rebase 后的变更。务必在 rebase 后推送，必要时使用强制推送。</li>
<li><strong>复杂合并场景下使用 Rebase</strong>：如果分支分叉严重，难以干净地 rebase，Git Merge 可能是更安全、更简单的选择。</li>
</ul>
<h3 data-id="heading-11">总结</h3>
<p>在 2026 年，Git 仍然是软件开发不可或缺的工具，理解 Git Merge 和 Git Rebase 的区别对于保持高效工作流至关重要。两种操作各有优劣，关键在于知道何时使用哪一种。</p>
<p>Git Merge 适合保留完整的分支历史，在协作环境中更安全；Git Rebase 擅长保持整洁的线性历史，适合精简项目提交记录、简化代码审查。</p>
<p>通过实践这两种策略并理解它们的影响，你可以避免代码冲突，保持项目历史整洁，成为更高效的开发者。选择合适的工具，祝你在 2026 年编码愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依项目前端vue里面的dicts: [] 属性详解]]></title>    <link>https://juejin.cn/post/7597742970281443380</link>    <guid>https://juejin.cn/post/7597742970281443380</guid>    <pubDate>2026-01-22T07:14:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281443380" data-draft-id="7597742970281426996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依项目前端vue里面的dicts: []  属性详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:14:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一写代码就开心"/> <meta itemprop="url" content="https://juejin.cn/user/2889993082908344"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依项目前端vue里面的dicts: []  属性详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2889993082908344/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一写代码就开心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:14:21.000Z" title="Thu Jan 22 2026 07:14:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 界面位置</h2>
<p>B站  gzh  有对应的视频讲解，源码解析，一行一行代码详解</p>
<h2 data-id="heading-1">2   dicts: []</h2>
<p>结合之前的全局混入逻辑和组件配置 <code>dicts: ['sys_normal_disable', 'sys_user_sex']</code>，我会帮你把「字典加载→数据存储→最终使用」的完整逻辑讲透，包括这个类里每个核心方法、属性的作用，以及数据最终存在哪里、怎么用。</p>
<h4 data-id="heading-2">一、先看懂 <code>Dict</code> 类的核心设计</h4>
<p>这个类是字典管理的“核心容器”，先明确它的核心属性和方法的作用：</p>


















































<table><thead><tr><th>核心成员</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td><code>owner</code></td><td>Object</td><td>绑定当前字典实例所属的 Vue 组件（来自全局混入的 <code>dict.owner = this</code>）</td></tr><tr><td><code>label</code></td><td>Object</td><td>字典标签映射表，格式 <code>{ 字典类型: { 值: 标签 } }</code>（比如 <code>sys_user_sex: {1: '男', 2: '女'}</code>）</td></tr><tr><td><code>type</code></td><td>Object</td><td>字典完整数组表，格式 <code>{ 字典类型: [DictData实例数组] }</code>（存储完整的字典项）</td></tr><tr><td><code>_dictMetas</code></td><td>Array</td><td>内部属性，存储所有字典的元数据（DictMeta实例），记录字典的类型、请求方式等</td></tr><tr><td><code>constructor()</code></td><td>构造函数</td><td>初始化 <code>owner</code>、<code>label</code>、<code>type</code> 三个核心属性</td></tr><tr><td><code>init()</code></td><td>方法</td><td>入口方法：解析字典配置、初始化响应式数据、加载字典数据</td></tr><tr><td><code>reloadDict()</code></td><td>方法</td><td>重新加载指定类型的字典数据</td></tr><tr><td><code>loadDict()</code></td><td>内部函数</td><td>实际发起请求加载字典、处理数据并更新到 <code>label</code>/<code>type</code> 中</td></tr></tbody></table>
<h4 data-id="heading-3">二、组件渲染时，<code>Dict</code> 类的完整执行流程</h4>
<p>结合组件配置 <code>dicts: ['sys_normal_disable', 'sys_user_sex']</code>，一步一步看 <code>Dict</code> 类是怎么工作的：</p>
<h5 data-id="heading-4">步骤1：创建 <code>Dict</code> 实例（全局混入的 <code>data</code> 钩子）</h5>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 全局混入的data钩子中执行</span>
<span class="hljs-keyword">const</span> dict = <span class="hljs-built_in">new</span> Dict(); 
<span class="hljs-comment">// 此时dict的初始状态：</span>
dict = {
  owner: 当前组件实例,
  label: {}, <span class="hljs-comment">// 空对象</span>
  <span class="hljs-keyword">type</span>: {},  <span class="hljs-comment">// 空对象</span>
  _dictMetas: undefined
}
</code></pre>
<h5 data-id="heading-5">步骤2：调用 <code>init()</code> 初始化字典（全局混入的 <code>created</code> 钩子）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">this</span>.dict.<span class="hljs-keyword">init</span>([<span class="hljs-string">'sys_normal_disable'</span>, <span class="hljs-string">'sys_user_sex'</span>]);
</code></pre>
<p><code>init()</code> 内部执行逻辑：</p>
<ol start="0">
<li>
<p><strong>格式化配置</strong>：因为传入的是数组，包装成配置对象 <code>{ types: ['sys_normal_disable', 'sys_user_sex'] }</code>；</p>
</li>
<li>
<p><strong>合并默认配置</strong>：用 <code>mergeRecursive</code> 合并 <code>DEFAULT_DICT_OPTIONS</code> 和用户配置，最终 <code>opts = { types: ['sys_normal_disable', 'sys_user_sex'] }</code>；</p>
</li>
<li>
<p><strong>解析元数据</strong>：把每个字典类型转成 <code>DictMeta</code> 实例，存储到 <code>_dictMetas</code>：</p>
<pre><code class="hljs language-ini" lang="ini">
<span class="hljs-attr">this._dictMetas</span> = [
  DictMeta.parse(<span class="hljs-string">'sys_normal_disable'</span>), // 解析出字典类型、请求地址等
  DictMeta.parse(<span class="hljs-string">'sys_user_sex'</span>)
]<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>初始化响应式数据</strong>：遍历 <code>_dictMetas</code>，为每个字典类型初始化响应式的 <code>label</code> 和 <code>type</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 以sys_user_sex为例</span>
Vue.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">this</span>.label, <span class="hljs-string">'sys_user_sex'</span>, {}); <span class="hljs-comment">// 响应式创建 label.sys_user_sex</span>
Vue.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">this</span>.type, <span class="hljs-string">'sys_user_sex'</span>, []);  <span class="hljs-comment">// 响应式创建 type.sys_user_sex</span>
</code></pre>
<p>✨ 关键：用 <code>Vue.set</code> 是为了让 <code>label</code>/<code>type</code> 的子属性也具备响应式（Vue 无法检测对象新增属性，必须用 <code>Vue.set</code>）；</p>
</li>
<li>
<p><strong>加载非延迟字典</strong>：两个字典都不是延迟加载（<code>lazy: false</code>），调用 <code>loadDict()</code> 加载数据，并把 Promise 存入数组 <code>ps</code>；</p>
</li>
<li>
<p><strong>等待所有加载完成</strong>：返回 <code>Promise.all(ps)</code>，确保两个字典都加载完再执行后续回调。</p>
</li>
</ol>
<h5 data-id="heading-6">步骤3：<code>loadDict()</code> 实际加载字典数据</h5>
<p>这是核心步骤，负责从后端请求数据并处理：</p>
<ol start="0">
<li>
<p><strong>发起请求</strong>：调用 <code>dictMeta.request(dictMeta)</code>（<code>DictMeta</code> 类的 <code>request</code> 方法，实际是调用后端接口）；</p>
</li>
<li>
<p><strong>处理响应数据</strong>：用 <code>dictMeta.responseConverter</code> 把后端返回的原始数据转换成 <code>DictData</code> 实例数组（比如：</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-comment">// 后端返回 → 转换后</span>
[{value: <span class="hljs-number">1</span>, label: <span class="hljs-string">'男'</span>}, {value: <span class="hljs-number">2</span>, label: <span class="hljs-string">'女'</span>}] → [<span class="hljs-keyword">new</span> <span class="hljs-built_in">DictData</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'男'</span>), <span class="hljs-keyword">new</span> <span class="hljs-built_in">DictData</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'女'</span>)]
</code></pre>
</li>
<li>
<p><strong>验证数据格式</strong>：确保转换后是 <code>DictData</code> 数组，否则清空数据避免报错；</p>
</li>
<li>
<p><strong>更新 <code>type</code> 数组</strong>：用 <code>splice</code> 替换数组内容（保持数组引用不变，响应式不丢失）：</p>
<pre><code class="hljs language-python" lang="python">
// 以sys_user_sex为例
<span class="hljs-built_in">dict</span>.<span class="hljs-built_in">type</span>.sys_user_sex.splice(<span class="hljs-number">0</span>, Number.MAX_SAFE_INTEGER, ...dicts);
// 此时 <span class="hljs-built_in">dict</span>.<span class="hljs-built_in">type</span>.sys_user_sex = [DictData{value:<span class="hljs-number">1</span>, label:<span class="hljs-string">'男'</span>}, DictData{value:<span class="hljs-number">2</span>, label:<span class="hljs-string">'女'</span>}]
</code></pre>
</li>
<li>
<p><strong>更新 <code>label</code> 映射</strong>：遍历 <code>DictData</code> 数组，建立「值→标签」的映射：</p>
<pre><code class="hljs language-python" lang="python">
// 以sys_user_sex为例
Vue.<span class="hljs-built_in">set</span>(<span class="hljs-built_in">dict</span>.label.sys_user_sex, <span class="hljs-number">1</span>, <span class="hljs-string">'男'</span>);
Vue.<span class="hljs-built_in">set</span>(<span class="hljs-built_in">dict</span>.label.sys_user_sex, <span class="hljs-number">2</span>, <span class="hljs-string">'女'</span>);
// 此时 <span class="hljs-built_in">dict</span>.label.sys_user_sex = {<span class="hljs-number">1</span>: <span class="hljs-string">'男'</span>, <span class="hljs-number">2</span>: <span class="hljs-string">'女'</span>}
</code></pre>
</li>
</ol>
<h5 data-id="heading-7">步骤4：加载完成后，<code>Dict</code> 实例的最终状态</h5>
<pre><code class="hljs language-css" lang="css">
dict = {
  owner: 当前组件实例,
  label: {
    sys_normal_disable: {<span class="hljs-number">0</span>: <span class="hljs-string">'正常'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'禁用'</span>},
    sys_user_sex: {<span class="hljs-number">1</span>: <span class="hljs-string">'男'</span>, <span class="hljs-number">2</span>: <span class="hljs-string">'女'</span>}
  },
  type: {
    sys_normal_disable: [DictData{value:<span class="hljs-number">0</span>, label:<span class="hljs-string">'正常'</span>}, DictData{value:<span class="hljs-number">1</span>, label:<span class="hljs-string">'禁用'</span>}],
    sys_user_sex: [DictData{value:<span class="hljs-number">1</span>, label:<span class="hljs-string">'男'</span>}, DictData{value:<span class="hljs-number">2</span>, label:<span class="hljs-string">'女'</span>}]
  },
  _dictMetas: [DictMeta{type: <span class="hljs-string">'sys_normal_disable'</span>}, DictMeta{type: <span class="hljs-string">'sys_user_sex'</span>}]
}
</code></pre>
<h4 data-id="heading-8">三、字典数据最终存在哪里？怎么用？</h4>
<h5 data-id="heading-9">1. 数据存储位置（核心！）</h5>
<ul>
<li><strong>完整字典数组</strong>：存在 <code>this.dict.type[字典类型]</code> 中（比如 <code>this.dict.type.sys_user_sex</code>）；</li>
<li><strong>标签映射表</strong>：存在 <code>this.dict.label[字典类型]</code> 中（比如 <code>this.dict.label.sys_user_sex</code>）；</li>
<li>两者都是<strong>响应式数据</strong>（因为用 <code>Vue.set</code> 创建），数据更新后模板会自动刷新。</li>
</ul>
<h5 data-id="heading-10">2. 实际开发中怎么使用这些数据？</h5>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 1. 下拉框：用type取完整数组 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"form.sex"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span>
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in dict.type.sys_user_sex"</span>
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
      <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.label"</span>
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.value"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
​
  <span class="hljs-comment">&lt;!-- 2. 显示标签：用label快速取值 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>用户状态：{{ dict.label.sys_normal_disable[form.status] }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">dicts</span>: [<span class="hljs-string">'sys_normal_disable'</span>, <span class="hljs-string">'sys_user_sex'</span>],
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">form</span>: { <span class="hljs-attr">sex</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">0</span> }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 3. 方法中重新加载字典</span>
    <span class="hljs-title function_">refreshDict</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dict</span>.<span class="hljs-title function_">reloadDict</span>(<span class="hljs-string">'sys_user_sex'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'性别字典重新加载完成'</span>);
      });
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">四、关键设计亮点（新手需要理解）</h4>
<ol start="0">
<li><strong>响应式保障</strong>：用 <code>Vue.set</code> 初始化 <code>label</code>/<code>type</code> 的子属性，确保数据更新后模板能响应；</li>
<li><strong>数组引用不变</strong>：更新 <code>type</code> 数组时用 <code>splice</code> 替换内容，而不是直接赋值（<code>dict.type[type] = dicts</code>），避免组件中绑定的数组丢失响应式；</li>
<li><strong>数据标准化</strong>：用 <code>DictData</code> 类包装字典项，确保所有字典数据结构一致；</li>
<li><strong>元数据解耦</strong>：用 <code>DictMeta</code> 处理字典的请求、转换逻辑，让 <code>Dict</code> 类只负责管理数据，职责更清晰。</li>
</ol>
<h4 data-id="heading-12">总结</h4>
<ol start="0">
<li><strong>数据存储核心</strong>：字典数据最终存在 <code>this.dict.type</code>（完整数组）和 <code>this.dict.label</code>（标签映射）中，都是响应式属性；</li>
<li><strong>执行流程</strong>：创建 Dict 实例 → init 解析配置 → loadDict 发起请求 → 处理数据并更新到 type/label → 组件可直接使用；</li>
<li><strong>使用方式</strong>：模板中用 <code>dict.type[类型]</code> 渲染下拉框，用 <code>dict.label[类型][值]</code> 快速显示标签。</li>
</ol>
<p>简单来说，这个 <code>Dict</code> 类就是把后端返回的字典数据，转换成了组件能直接用的、响应式的“数组+映射表”结构，方便开发中快速使用。</p>
<h2 data-id="heading-13">3 <code>this.$refs.tree.filter(val)</code></h2>
<p><code>this.$refs.tree.filter(val)</code> 这行代码里每个部分的含义</p>
<h4 data-id="heading-14">一、逐部分解析核心概念</h4>
<h5 data-id="heading-15">1. <code>this</code> 指的是谁？</h5>
<p>和之前讲的 Vue 组件中 <code>this</code> 的含义完全一致：<strong><code>this</code> 指向当前执行这段代码的 Vue 组件实例</strong>。</p>
<ul>
<li>比如这段代码写在 <code>UserList</code> 组件的 <code>methods</code> 里，点击按钮触发该方法时，<code>this</code> 就是 <code>UserList</code> 组件实例；</li>
<li>写在组件的 <code>created</code>/<code>mounted</code> 钩子中，<code>this</code> 也是当前组件实例；</li>
<li>核心：<code>this</code> 永远是“当前代码所属的那个组件”。</li>
</ul>
<h5 data-id="heading-16">2. <code>$refs</code> 是什么？</h5>
<p><code>$refs</code> 是 Vue 组件实例的<strong>内置属性</strong>，作用是：<strong>获取组件模板中通过 <code>ref</code> 属性标记的 DOM 元素或子组件实例</strong>。</p>
<ul>
<li>你可以把 <code>$refs</code> 理解成一个“引用字典”：键是模板中 <code>ref</code> 的值，值是对应的 DOM/组件实例；</li>
<li>注意：<code>$refs</code> 只有在组件<strong>挂载完成（mounted 钩子之后）</strong> 才会有值（DOM 渲染完成），在 <code>created</code> 中访问 <code>$refs</code> 会是 <code>undefined</code>。</li>
</ul>
<h5 data-id="heading-17">3. <code>tree</code> 是什么？</h5>
<p><code>tree</code> 是你在模板中给某个元素/组件设置的 <code>ref</code> 属性值，是<strong>自定义的名称</strong>（你也可以命名为 <code>myTree</code>、<code>deptTree</code> 等）。比如模板中会有这样的代码（以 Element UI 的树形组件为例）：</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 给树形组件设置 ref="tree" --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"tree"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">关键</span>：<span class="hljs-attr">ref的值是tree</span> <span class="hljs-attr">--</span>&gt;</span>
    :data="treeData"
    :filter-node-method="filterNode"
  /&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>此时 <code>this.$refs.tree</code> 就指向这个 <code>&lt;el-tree&gt;</code> 组件的实例（不是 DOM 元素，是组件实例）。</p>
<h5 data-id="heading-18">4. <code>filter</code> 是什么？</h5>
<p><code>filter</code> 是 <code>&lt;el-tree&gt;</code>（Element UI 树形组件）<strong>内置的方法</strong>，作用是：<strong>触发树形组件的节点过滤功能</strong>，根据传入的 <code>val</code> 筛选出符合条件的节点并展示。</p>
<ul>
<li>这个 <code>filter</code> 方法是 Element UI 封装好的，不是 Vue 原生方法；</li>
<li>传入的 <code>val</code> 是“过滤关键词”，树形组件会根据你配置的 <code>filter-node-method</code> 方法，用这个关键词筛选节点。</li>
</ul>
<h4 data-id="heading-19">二、完整示例：结合代码理解</h4>
<h5 data-id="heading-20">模板部分（Element UI 树形组件）</h5>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 输入框：输入过滤关键词 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"filterText"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入筛选关键词"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"handleFilter"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">输入时触发过滤</span> <span class="hljs-attr">--</span>&gt;</span>
    /&gt;
    <span class="hljs-comment">&lt;!-- 树形组件：设置ref="tree"，配置过滤方法 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"tree"</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"treeData"</span>
      <span class="hljs-attr">:filter-node-method</span>=<span class="hljs-string">"filterNode"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">定义过滤规则</span> <span class="hljs-attr">--</span>&gt;</span>
      default-expand-all
    /&gt;
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h5 data-id="heading-21">脚本部分</h5>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">filterText</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 过滤关键词</span>
      <span class="hljs-attr">treeData</span>: [ <span class="hljs-comment">// 树形数据</span>
        { <span class="hljs-attr">label</span>: <span class="hljs-string">'部门1'</span>, <span class="hljs-attr">children</span>: [{ <span class="hljs-attr">label</span>: <span class="hljs-string">'员工1'</span> }, { <span class="hljs-attr">label</span>: <span class="hljs-string">'员工2'</span> }] },
        { <span class="hljs-attr">label</span>: <span class="hljs-string">'部门2'</span>, <span class="hljs-attr">children</span>: [{ <span class="hljs-attr">label</span>: <span class="hljs-string">'员工3'</span> }, { <span class="hljs-attr">label</span>: <span class="hljs-string">'员工4'</span> }] }
      ]
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 触发过滤的方法</span>
    <span class="hljs-title function_">handleFilter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 核心代码：调用树形组件的filter方法，传入过滤关键词</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">tree</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filterText</span>);
    },
    <span class="hljs-comment">// 过滤规则：判断节点是否匹配关键词</span>
    <span class="hljs-title function_">filterNode</span>(<span class="hljs-params">value, data</span>) {
      <span class="hljs-keyword">if</span> (!value) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 无关键词时显示所有节点</span>
      <span class="hljs-comment">// 节点label包含关键词则显示</span>
      <span class="hljs-keyword">return</span> data.<span class="hljs-property">label</span>.<span class="hljs-title function_">indexOf</span>(value) !== -<span class="hljs-number">1</span>;
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22">三、这行代码的整体作用</h4>
<p><code>this.$refs.tree.filter(val)</code> 翻译成大白话：</p>
<blockquote>
<p>“让当前组件中，模板里标记为 <code>ref="tree"</code> 的树形组件（el-tree），执行它的 <code>filter</code> 方法，传入 <code>val</code> 作为过滤关键词，按照预设的规则筛选节点。”</p>
</blockquote>
<h4 data-id="heading-23">四、关键注意事项（新手易踩坑）</h4>
<ol start="0">
<li><strong><code>$refs</code> 不能响应式</strong>：<code>$refs</code> 是普通对象，不是响应式的，修改 <code>ref</code> 对应的 DOM/组件不会触发视图更新；</li>
<li><strong>必须挂载后访问</strong>：在 <code>created</code> 中调用 <code>this.$refs.tree</code> 会是 <code>undefined</code>，要写在 <code>mounted</code> 或点击/输入等事件中；</li>
<li><strong><code>filter</code> 是组件内置方法</strong>：只有 Element UI 的 <code>el-tree</code> 有这个方法，原生 DOM 或其他组件（如 el-table）没有，不要乱用；</li>
<li><strong><code>tree</code> 是自定义的</strong>：如果模板中 <code>ref="myTree"</code>，代码就要写成 <code>this.$refs.myTree.filter(val)</code>。</li>
</ol>
<h4 data-id="heading-24">总结</h4>
<ol start="0">
<li><code>this</code> → 当前 Vue 组件实例；</li>
<li><code>$refs</code> → Vue 内置属性，存储模板中 <code>ref</code> 标记的元素/组件引用；</li>
<li><code>tree</code> → 模板中 <code>ref="tree"</code> 的自定义名称，指向 el-tree 组件实例；</li>
<li><code>filter</code> → el-tree 组件的内置方法，用于触发节点过滤；</li>
<li>整行代码作用：给树形组件传入关键词，执行节点筛选。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【解密源码】WeKnora 文档切分与 Chunk 构建解析：腾讯生产级 RAG 的底层设计]]></title>    <link>https://juejin.cn/post/7597724783649554472</link>    <guid>https://juejin.cn/post/7597724783649554472</guid>    <pubDate>2026-01-22T07:05:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597724783649554472" data-draft-id="7597742970281361460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【解密源码】WeKnora 文档切分与 Chunk 构建解析：腾讯生产级 RAG 的底层设计"/> <meta itemprop="keywords" content="源码,Agent,LLM"/> <meta itemprop="datePublished" content="2026-01-22T07:05:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="常先森"/> <meta itemprop="url" content="https://juejin.cn/user/4388906148043879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【解密源码】WeKnora 文档切分与 Chunk 构建解析：腾讯生产级 RAG 的底层设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906148043879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    常先森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:05:38.000Z" title="Thu Jan 22 2026 07:05:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>WeKnora 是腾讯开源的一套<strong>生产级 RAG 框架</strong>，定位非常明确：解决真实业务场景下“文档复杂、类型多样、规模可控但质量要求极高”的知识增强问题。社区中有人将其视为 <em>ima</em> 的开源实现之一，虽然这一说法无从官方考证，但可以确定的是，WeKnora 在工程完整度、边界处理和异常降级策略上，是一套经过实战打磨的系统方案。</p>
<p>从文档接入、解析、切分、向量化、多模态增强，到知识图谱、问题生成与摘要生成，WeKnora 几乎覆盖了一个完整 RAG 系统在生产环境中可能遇到的所有关键问题。尤其是在<strong>文档解析与 Chunk 构建</strong>这一最容易被低估、却最影响检索与生成质量的环节，WeKnora 给出了一套相当成熟且可复用的设计。</p>
<p>本文将聚焦 WeKnora 的<strong>文档接入与解析体系</strong>，从文件/URL/手动创建三种入口开始，深入拆解其解析器架构、Markdown 统一中间表示、语义切分策略、多模态处理，以及最终如何构建可用于检索与推理的 Chunk 数据结构。</p>
<h2 data-id="heading-1">上传方式</h2>
<h3 data-id="heading-2">文件上传</h3>
<p>上传文件 → 计算Hash去重 → 存储文件 → 异步解析</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Service 层 - 核心逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *knowledgeService)</span></span> CreateKnowledgeFromFile(ctx context.Context, kbID <span class="hljs-type">string</span>, 
    file *multipart.FileHeader, metadata <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, enableMultimodel *<span class="hljs-type">bool</span>, customFileName <span class="hljs-type">string</span>,
) (*types.Knowledge, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 计算文件 Hash（去重检测）</span>
    fileContent, _ := file.Open()
    fileHash := calculateFileHash(fileContent)
    
    <span class="hljs-comment">// 2. 检查是否已存在相同文件</span>
    existing, _ := s.repo.FindByFileHash(ctx, kbID, fileHash)
    <span class="hljs-keyword">if</span> existing != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> existing, &amp;types.DuplicateKnowledgeError{
            ExistingID: existing.ID,
            Message:    <span class="hljs-string">"相同文件已存在"</span>,
        }
    }
    
    <span class="hljs-comment">// 3. 上传文件到存储服务（MinIO/COS）</span>
    filePath, _ := s.storage.Upload(fileContent, fileName)
    
    <span class="hljs-comment">// 4. 创建 Knowledge 记录</span>
    knowledge := &amp;types.Knowledge{
        ID:          uuid.New().String(),
        Type:        <span class="hljs-string">"file"</span>,
        FileName:    fileName,
        FileType:    getFileType(fileName),  <span class="hljs-comment">// pdf, docx, xlsx...</span>
        FileHash:    fileHash,
        FilePath:    filePath,
        FileSize:    file.Size,
        ParseStatus: types.ParseStatusPending,  <span class="hljs-comment">// 等待异步处理</span>
        Metadata:    metadata,
    }
    s.repo.CreateKnowledge(ctx, knowledge)
    
    <span class="hljs-comment">// 5. 入队异步解析任务</span>
    payload := types.DocumentProcessPayload{
        KnowledgeID:     knowledge.ID,
        EnableMultimodel: enableMultimodel,
    }
    task := asynq.NewTask(types.TypeDocumentProcess, payload)
    s.task.Enqueue(task)
    
    <span class="hljs-keyword">return</span> knowledge, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-3">URL 创建</h3>
<p>接收URL → URL去重 → 异步抓取解析</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Service 层 - 核心逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *knowledgeService)</span></span> CreateKnowledgeFromURL(ctx context.Context, 
    kbID, url <span class="hljs-type">string</span>, enableMultimodel *<span class="hljs-type">bool</span>, title <span class="hljs-type">string</span>,
) (*types.Knowledge, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 验证 URL 格式</span>
    <span class="hljs-keyword">if</span> !isValidURL(url) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.NewBadRequestError(<span class="hljs-string">"无效的URL格式"</span>)
    }
    
    <span class="hljs-comment">// 2. 检查是否已存在相同 URL</span>
    existing, _ := s.repo.FindBySourceURL(ctx, kbID, url)
    <span class="hljs-keyword">if</span> existing != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> existing, &amp;types.DuplicateKnowledgeError{
            ExistingID: existing.ID,
            Message:    <span class="hljs-string">"相同URL已存在"</span>,
        }
    }
    
    <span class="hljs-comment">// 3. 创建 Knowledge 记录</span>
    knowledge := &amp;types.Knowledge{
        ID:          uuid.New().String(),
        Type:        <span class="hljs-string">"url"</span>,
        SourceURL:   url,
        Title:       title,
        FileName:    extractFileNameFromURL(url),  <span class="hljs-comment">// 从 URL 提取文件名</span>
        FileType:    <span class="hljs-string">"html"</span>,
        ParseStatus: types.ParseStatusPending,  <span class="hljs-comment">// 等待异步处理</span>
    }
    s.repo.CreateKnowledge(ctx, knowledge)
    
    <span class="hljs-comment">// 4. 入队异步抓取任务</span>
    payload := types.DocumentProcessPayload{
        KnowledgeID:      knowledge.ID,
        SourceURL:        url,  <span class="hljs-comment">// 传递 URL 供异步任务抓取</span>
        EnableMultimodel: enableMultimodel,
    }
    task := asynq.NewTask(types.TypeDocumentProcess, payload)
    s.task.Enqueue(task)
    
    <span class="hljs-keyword">return</span> knowledge, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-4">手动创建</h3>
<p>接收Markdown内容 → 无去重 → 同步处理</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Service 层 - 核心逻辑（同步处理）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *knowledgeService)</span></span> CreateKnowledgeFromManual(ctx context.Context, 
    kbID <span class="hljs-type">string</span>, req *types.ManualKnowledgePayload,
) (*types.Knowledge, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 创建 Knowledge 记录</span>
    knowledge := &amp;types.Knowledge{
        ID:          uuid.New().String(),
        Type:        <span class="hljs-string">"manual"</span>,
        Title:       req.Title,
        FileName:    req.Title + <span class="hljs-string">".md"</span>,
        FileType:    <span class="hljs-string">"md"</span>,
        ParseStatus: types.ParseStatusProcessing,  <span class="hljs-comment">// 直接开始处理</span>
    }
    s.repo.CreateKnowledge(ctx, knowledge)
    
    <span class="hljs-comment">// 2. 同步解析 Markdown 内容（无需异步任务）</span>
    chunks := s.parseMarkdown(req.Content)
    
    <span class="hljs-comment">// 3. 同步处理 Chunks（生成 embedding、索引）</span>
    s.processChunks(ctx, kb, knowledge, chunks)
    
    <span class="hljs-comment">// 4. 更新状态为完成</span>
    knowledge.ParseStatus = types.ParseStatusCompleted
    s.repo.UpdateKnowledge(ctx, knowledge)
    
    <span class="hljs-keyword">return</span> knowledge, <span class="hljs-literal">nil</span>
}
</code></pre>
<h2 data-id="heading-5">解析模式</h2>
<h3 data-id="heading-6">FirstParser - 链式尝试模式</h3>
<p>尝试多个解析器，直到第一个成功</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstParser</span>(<span class="hljs-title class_ inherited__">BaseParser</span>):
    _parser_cls: <span class="hljs-type">Tuple</span>[<span class="hljs-type">Type</span>[<span class="hljs-string">"BaseParser"</span>], ...] = ()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_into_text</span>(<span class="hljs-params">self, content: <span class="hljs-built_in">bytes</span></span>) -&gt; Document:
        <span class="hljs-string">"""顺序尝试每个解析器"""</span>
        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self._parsers:
            <span class="hljs-keyword">try</span>:
                document = p.parse_into_text(content)
                <span class="hljs-keyword">if</span> document.is_valid():
                    <span class="hljs-keyword">return</span> document  <span class="hljs-comment"># ← 第一个成功就返回</span>
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-keyword">continue</span>  <span class="hljs-comment"># ← 失败就继续下一个</span>
        <span class="hljs-keyword">return</span> Document()  <span class="hljs-comment"># ← 都失败就返回空</span>
</code></pre>
<h3 data-id="heading-7">PipelineParser - 管道链式模式</h3>
<p>多个解析器串联处理，前一个的输出是后一个的输入</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PipelineParser</span>(<span class="hljs-title class_ inherited__">BaseParser</span>):
    _parser_cls: <span class="hljs-type">Tuple</span>[<span class="hljs-type">Type</span>[<span class="hljs-string">"BaseParser"</span>], ...] = ()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_into_text</span>(<span class="hljs-params">self, content: <span class="hljs-built_in">bytes</span></span>) -&gt; Document:
        <span class="hljs-string">"""依次调用每个解析器，累积图片"""</span>
        images: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>] = {}
        document = Document()
        
        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self._parsers:
            document = p.parse_into_text(content)
            content = endecode.encode_bytes(document.content)  <span class="hljs-comment"># ← 转换为下一个解析器的输入</span>
            images.update(document.images)  <span class="hljs-comment"># ← 累积图片</span>
        
        document.images.update(images)
        <span class="hljs-keyword">return</span> document
</code></pre>
<h2 data-id="heading-8">文档解析</h2>
<h3 data-id="heading-9">pdf 文档处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 尝试顺序：</span>
<span class="hljs-comment"># 1. MinerUParser (主解析器)</span>
<span class="hljs-comment"># 2. MarkitdownParser (备选解析器)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PDFParser</span>(<span class="hljs-title class_ inherited__">FirstParser</span>):
    _parser_cls = (MinerUParser, MarkitdownParser)
<span class="hljs-comment"># 管道流程：</span>
<span class="hljs-comment"># PDF → StdMinerUParser (调用 MinerU API)</span>
<span class="hljs-comment">#     → MarkdownTableFormatter (格式化表格)</span>
<span class="hljs-comment">#     → 最终 Document</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MinerUParser</span>(<span class="hljs-title class_ inherited__">PipelineParser</span>):
    _parser_cls = (StdMinerUParser, MarkdownTableFormatter)
    

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkitdownParser</span>(<span class="hljs-title class_ inherited__">PipelineParser</span>):
    <span class="hljs-string">"""
    使用管道处理模式的 Markdown 解析器
    
    数据流：
    PDF 字节流
      ↓
    StdMarkitdownParser (第一阶段)
      ├─ 调用 MarkItDown 库解析
      ├─ 返回 Markdown 文本 + 内嵌数据 URI
      └─ Document(content, images={})
      ↓
    MarkdownParser (第二阶段)
      ├─ 处理 Markdown 内容
      ├─ 提取数据 URI 中的图片
      ├─ 上传到存储
      └─ 返回最终 Document(content, images)
    """</span>
    
    _parser_cls = (StdMarkitdownParser, MarkdownParser)
    <span class="hljs-comment"># 两个解析器按顺序管道处理</span>
</code></pre>
<p>优先使用 MinerU 将文件转换成 markdown 格式，<strong>这里需要用户自行配置 MinerU token 才能正常使用。</strong> 降级采用微软开源框架 MarkItDown，将 pdf 转换成 markdown 格式，<strong>MarkItDown 插件处理不了 pdf 扫描件。</strong> 转换成 markdown 之后，对 markdown 进行初步格式化处理：</p>
<ol>
<li>对 markdown 文档的表格空行进行规范化处理，标准化列对齐</li>
<li>将 markdown 文档中的 base64 图片转换为二进制上传到 COS，将 COS 链接替换 markdown 文档中的 base64 图片路径</li>
</ol>
<h3 data-id="heading-10">docx 文档处理</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 尝试顺序：</span>
<span class="hljs-comment"># 1. MarkitdownParser (主解析器，与 pdf 备选方案一致)</span>
<span class="hljs-comment"># 2. DocxParser (备选解析器)</span>
class Docx2Parser(FirstParser):
    <span class="hljs-attr">_parser_cls</span> = (MarkitdownParser, DocxParser) 
</code></pre>
<p><strong>降级策略 DocxParser 采用 python-docx</strong>，最终输出 markdown 格式的文本内容。处理流程如下：</p>
<ol>
<li>通过 python-docx 库解析 docx 文件，提取纯文本内容，表格和图片。</li>
<li>若开启了图片处理 enable_multimodal，则对提取的图片进行过滤，缩放等处理后上传至 COS，再将 COS 链接替换 markdown 文档中的图片路径</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"># 过滤小图片（装饰元素）
<span class="hljs-keyword">if</span> image.width &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">or</span> image.height &lt; <span class="hljs-number">50</span>:
    <span class="hljs-keyword">return</span> None

# 缩放大图片
<span class="hljs-keyword">if</span> image.width &gt; max_image_size:
    image = image.<span class="hljs-built_in">resize</span>((new_width, new_height))
</code></pre>
<ol start="3">
<li>将表格转换为 HTML 格式</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">_convert_table_to_html</span>(self, table):
    <span class="hljs-selector-tag">html</span> = "&lt;<span class="hljs-selector-tag">table</span>&gt;"
    <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">r</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">table</span><span class="hljs-selector-class">.rows</span>:
        <span class="hljs-selector-tag">html</span> += "&lt;<span class="hljs-selector-tag">tr</span>&gt;"
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">r</span><span class="hljs-selector-class">.cells</span>:
            # 处理合并单元格
            <span class="hljs-selector-tag">html</span> += <span class="hljs-selector-tag">f</span>"&lt;<span class="hljs-selector-tag">td</span> <span class="hljs-selector-tag">colspan</span>='{<span class="hljs-selector-tag">span</span>}'&gt;{<span class="hljs-selector-tag">c</span><span class="hljs-selector-class">.text</span>}&lt;/<span class="hljs-selector-tag">td</span>&gt;"
        <span class="hljs-selector-tag">html</span> += "&lt;/<span class="hljs-selector-tag">tr</span>&gt;"
    <span class="hljs-selector-tag">html</span> += "&lt;/<span class="hljs-selector-tag">table</span>&gt;"
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">html</span>
</code></pre>
<ol start="4">
<li>保持原文内容顺序进行 markdown 格式文档输出。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentModel</span>:
    content: <span class="hljs-built_in">str</span>           <span class="hljs-comment"># Markdown 格式文本（含图片链接）</span>
    images: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>] <span class="hljs-comment"># {url: base64_data}</span>
</code></pre>
<h3 data-id="heading-11">doc 文档处理</h3>
<p>doc 文档处理优先使用 _parse_with_docx 方法，<strong>采用 LibreOffice 库将 .doc 文件转换为 .docx 格式</strong>，再按照 Docx2Parser 流程解析文件。</p>
<p>若 _parse_with_docx 方法失败，将会使用降级方案 _parse_with_antiword，<strong>采用 antiword 库直接提取 .doc 文本内容</strong>。antiword 只能提取纯文本，不支持图片和表格的提取。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocParser</span>(<span class="hljs-title class_ inherited__">Docx2Parser</span>):
    <span class="hljs-string">"""DOC document parser"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_into_text</span>(<span class="hljs-params">self, content: <span class="hljs-built_in">bytes</span></span>) -&gt; Document:
        logger.info(<span class="hljs-string">f"Parsing DOC document, content size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span> bytes"</span>)

        handle_chain = [
            <span class="hljs-comment"># 1. Try to convert to docx format to extract images</span>
            self._parse_with_docx,
            <span class="hljs-comment"># 2. If image extraction is not needed or conversion failed,</span>
            <span class="hljs-comment"># try using antiword to extract text</span>
            self._parse_with_antiword,
            <span class="hljs-comment"># 3. If antiword extraction fails, use textract</span>
            <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> _parse_with_textract is disabled due to SSRF vulnerability</span>
            <span class="hljs-comment"># self._parse_with_textract,</span>
        ]
</code></pre>
<h3 data-id="heading-12">csv 文档处理</h3>
<p>使用 pandas 库读取 csv 文件，将其转换为 DataFrame 格式，再将 DataFrame 转换为文本内容。会默认将 DataFrame 的第一行作为表头，将其他行作为数据行进行组合。</p>
<pre><code class="hljs language-sql" lang="sql"> # Read CSV content <span class="hljs-keyword">into</span> a pandas DataFrame, skipping malformed lines
df <span class="hljs-operator">=</span> pd.read_csv(BytesIO(content), on_bad_lines<span class="hljs-operator">=</span>"skip")

# Process <span class="hljs-keyword">each</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> the DataFrame
<span class="hljs-keyword">for</span> i, (idx, <span class="hljs-type">row</span>) <span class="hljs-keyword">in</span> enumerate(df.iterrows()):
    # Format <span class="hljs-type">row</span> <span class="hljs-keyword">as</span> "column: value" pairs separated <span class="hljs-keyword">by</span> commas
    content_row <span class="hljs-operator">=</span> (
        ",".<span class="hljs-keyword">join</span>(
            f"{col.strip()}: {str(row[col]).strip()}" <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns
        )
        <span class="hljs-operator">+</span> "\n"
    )
    # <span class="hljs-keyword">Update</span> <span class="hljs-keyword">end</span> position <span class="hljs-keyword">for</span> this chunk
    <span class="hljs-keyword">end</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> len(content_row)
    text.append(content_row)
    
    # <span class="hljs-keyword">Create</span> a chunk <span class="hljs-keyword">for</span> this <span class="hljs-type">row</span> <span class="hljs-keyword">with</span> position tracking
    chunks.append(Chunk(content<span class="hljs-operator">=</span>content_row, seq<span class="hljs-operator">=</span>i, <span class="hljs-keyword">start</span><span class="hljs-operator">=</span><span class="hljs-keyword">start</span>, <span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-keyword">end</span>))
    # <span class="hljs-keyword">Update</span> <span class="hljs-keyword">start</span> position <span class="hljs-keyword">for</span> next chunk
    <span class="hljs-keyword">start</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> Document(
    content<span class="hljs-operator">=</span>"".<span class="hljs-keyword">join</span>(text),
    chunks<span class="hljs-operator">=</span>chunks,
)
</code></pre>
<p>最终输出格式示例如下：</p>
<pre><code class="hljs language-sql" lang="sql">Document(
    content<span class="hljs-operator">=</span>"姓名: 张三,年龄: 25,城市: 北京\n姓名: 李四,年龄: 30,城市: 上海\n...",
    chunks<span class="hljs-operator">=</span>[
        Chunk(content<span class="hljs-operator">=</span>"姓名: 张三,年龄: 25,城市: 北京\n", seq<span class="hljs-operator">=</span><span class="hljs-number">0</span>, <span class="hljs-keyword">start</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>, <span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-number">25</span>),
        Chunk(content<span class="hljs-operator">=</span>"姓名: 李四,年龄: 30,城市: 上海\n", seq<span class="hljs-operator">=</span><span class="hljs-number">1</span>, <span class="hljs-keyword">start</span><span class="hljs-operator">=</span><span class="hljs-number">25</span>, <span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-number">50</span>),
        Chunk(content<span class="hljs-operator">=</span>"姓名: 王五,年龄: 28,城市: 深圳\n", seq<span class="hljs-operator">=</span><span class="hljs-number">2</span>, <span class="hljs-keyword">start</span><span class="hljs-operator">=</span><span class="hljs-number">50</span>, <span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-number">75</span>),
    ]
)
</code></pre>
<p><em>Tips: 这种默认第一行为表头的策略能够最大程度的保持 csv 文档的结构。但对于第一行不是表头的情况，也会有混乱语义的危险。</em></p>
<h3 data-id="heading-13">excel 文档处理</h3>
<p>使用 openpyxl 库读取 excel 文件，将每个工作表转换为文本内容。与 csv 处理策略相同，会默认将每个工作表的第一行作为表头，将其他行作为数据行进行组合。</p>
<pre><code class="hljs language-sql" lang="sql"># Load Excel file <span class="hljs-keyword">from</span> bytes <span class="hljs-keyword">into</span> pandas ExcelFile object
excel_file <span class="hljs-operator">=</span> pd.ExcelFile(BytesIO(content))

# Process <span class="hljs-keyword">each</span> sheet <span class="hljs-keyword">in</span> the Excel file
<span class="hljs-keyword">for</span> excel_sheet_name <span class="hljs-keyword">in</span> excel_file.sheet_names:
    # Parse the sheet <span class="hljs-keyword">into</span> a DataFrame
    df <span class="hljs-operator">=</span> excel_file.parse(sheet_name<span class="hljs-operator">=</span>excel_sheet_name)
    # Remove <span class="hljs-keyword">rows</span> <span class="hljs-keyword">where</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">values</span> <span class="hljs-keyword">are</span> NaN (completely <span class="hljs-keyword">empty</span> <span class="hljs-keyword">rows</span>)
    df.dropna(how<span class="hljs-operator">=</span>"all", inplace<span class="hljs-operator">=</span><span class="hljs-literal">True</span>)

    # Process <span class="hljs-keyword">each</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> the DataFrame
    <span class="hljs-keyword">for</span> _, <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> df.iterrows():
        page_content <span class="hljs-operator">=</span> []
        # Build key<span class="hljs-operator">-</span><span class="hljs-keyword">value</span> pairs <span class="hljs-keyword">for</span> non<span class="hljs-operator">-</span><span class="hljs-keyword">null</span> <span class="hljs-keyword">values</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> row.items():
            if pd.notna(v):  # <span class="hljs-keyword">Skip</span> NaN<span class="hljs-operator">/</span><span class="hljs-keyword">null</span> <span class="hljs-keyword">values</span>
                page_content.append(f"{k}: {v}")
        
        # <span class="hljs-keyword">Skip</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> valid content
        if <span class="hljs-keyword">not</span> page_content:
            continue
        
        # Format <span class="hljs-type">row</span> <span class="hljs-keyword">as</span> comma<span class="hljs-operator">-</span>separated key<span class="hljs-operator">-</span><span class="hljs-keyword">value</span> pairs
        content_row <span class="hljs-operator">=</span> ",".<span class="hljs-keyword">join</span>(page_content) <span class="hljs-operator">+</span> "\n"
        <span class="hljs-keyword">end</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> len(content_row)
        text.append(content_row)
        
        # <span class="hljs-keyword">Create</span> a chunk <span class="hljs-keyword">for</span> this <span class="hljs-type">row</span> <span class="hljs-keyword">with</span> position tracking
        chunks.append(
            Chunk(content<span class="hljs-operator">=</span>content_row, seq<span class="hljs-operator">=</span>len(chunks), <span class="hljs-keyword">start</span><span class="hljs-operator">=</span><span class="hljs-keyword">start</span>, <span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-keyword">end</span>)
        )
        <span class="hljs-keyword">start</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">end</span>

# Combine <span class="hljs-keyword">all</span> text <span class="hljs-keyword">and</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">as</span> Document
<span class="hljs-keyword">return</span> Document(content<span class="hljs-operator">=</span>"".<span class="hljs-keyword">join</span>(text), chunks<span class="hljs-operator">=</span>chunks)
</code></pre>
<p><em>Tips: pandas 处理 excel 文档，如果遇见多级表头，多个合并单元格的复杂文档，会丢失结构信息，导致语义混乱。</em></p>
<h3 data-id="heading-14">图片处理</h3>
<p>图片处理很简单，上传图片到存储服务, 将返回的图片 URL 转换为 Markdown 图片语法，并生成 base64 编码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_into_text</span>(<span class="hljs-params">self, content: <span class="hljs-built_in">bytes</span></span>) -&gt; Document:
    logger.info(<span class="hljs-string">f"Parsing image content, size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span> bytes"</span>)

    <span class="hljs-comment"># Get file extension</span>
    ext = os.path.splitext(self.file_name)[<span class="hljs-number">1</span>].lower()

    <span class="hljs-comment"># Upload image to storage</span>
    image_url = self.storage.upload_bytes(content, file_ext=ext)
    logger.info(<span class="hljs-string">f"Successfully uploaded image, URL: <span class="hljs-subst">{image_url[:<span class="hljs-number">50</span>]}</span>..."</span>)

    <span class="hljs-comment"># Generate markdown text</span>
    text = <span class="hljs-string">f"![<span class="hljs-subst">{self.file_name}</span>](<span class="hljs-subst">{image_url}</span>)"</span>
    images = {image_url: base64.b64encode(content).decode()}

    <span class="hljs-comment"># Create image object and add to map</span>
    <span class="hljs-keyword">return</span> Document(content=text, images=images)
</code></pre>
<h3 data-id="heading-15">网页文档处理</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 管道流程：</span>
<span class="hljs-comment"># URL → StdWebParser (获取网页内容)</span>
<span class="hljs-comment">#     → MarkdownParser (格式化 Markdown 内容)</span>
<span class="hljs-comment">#     → 最终 Document</span>
class WebParser(PipelineParser):
    <span class="hljs-attr">_parser_cls</span> = (StdWebParser, MarkdownParser)
</code></pre>
<h4 data-id="heading-16">使用 Playwright 抓取页面内容</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">scrape</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> async_playwright() <span class="hljs-keyword">as</span> p:
        <span class="hljs-comment"># 配置代理（可选）</span>
        kwargs = {}
        <span class="hljs-keyword">if</span> self.proxy:
            kwargs[<span class="hljs-string">"proxy"</span>] = {<span class="hljs-string">"server"</span>: self.proxy}
        
        <span class="hljs-comment"># 启动 WebKit 浏览器</span>
        browser = <span class="hljs-keyword">await</span> p.webkit.launch(**kwargs)
        page = <span class="hljs-keyword">await</span> browser.new_page()
        
        <span class="hljs-comment"># 访问页面，30秒超时</span>
        <span class="hljs-keyword">await</span> page.goto(url, timeout=<span class="hljs-number">30000</span>)
        
        <span class="hljs-comment"># 获取完整 HTML</span>
        content = <span class="hljs-keyword">await</span> page.content()
        
        <span class="hljs-keyword">await</span> browser.close()
        <span class="hljs-keyword">return</span> content
</code></pre>
<h4 data-id="heading-17">使用 Trafilatura 提取正文</h4>
<pre><code class="hljs language-ini" lang="ini">def parse_into_text(self, content: bytes) -&gt; Document:
    <span class="hljs-attr">url</span> = endecode.decode_bytes(content)
    
    <span class="hljs-comment"># 抓取 HTML</span>
    <span class="hljs-attr">chtml</span> = asyncio.run(self.scrape(url))
    
    <span class="hljs-comment"># 提取正文，转为 Markdown</span>
    <span class="hljs-attr">md_text</span> = extract(
        chtml,
        <span class="hljs-attr">output_format</span>=<span class="hljs-string">"markdown"</span>,  <span class="hljs-comment"># 输出格式</span>
        <span class="hljs-attr">with_metadata</span>=<span class="hljs-literal">True</span>,        <span class="hljs-comment"># 保留元数据</span>
        <span class="hljs-attr">include_images</span>=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># 保留图片</span>
        <span class="hljs-attr">include_tables</span>=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># 保留表格</span>
        <span class="hljs-attr">include_links</span>=<span class="hljs-literal">True</span>,        <span class="hljs-comment"># 保留链接</span>
    )
    
    return Document(<span class="hljs-attr">content</span>=md_text)
</code></pre>
<p>通过 StdWebParser 解析器，输出 markdown 文档，包含元数据（如标题、作者、发布日期等）和图片、表格、链接等。进入后续 MarkdownParser 解析器，将 markdown 文档转换为 Document 格式。</p>
<h3 data-id="heading-18">Markdown 文档处理（核心）</h3>
<p><strong>以下是对文档处理的核心方案</strong>，因为以上所有文档类型都是先转换成对应的 Markdown 文档结构，再进行统一处理。</p>
<h4 data-id="heading-19">核心架构</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">原始 Markdown 文本
  ↓
TextSplitter.split_text(<span class="hljs-keyword">text</span>)
  ├─ <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: _split(<span class="hljs-keyword">text</span>)
  │  └─ 递归分割，保证每个 split ≤ chunk_size
  │
  ├─ <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: _split_protected(<span class="hljs-keyword">text</span>)
  │  └─ 提取所有受保护内容的位置和范围
  │
  ├─ <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: _join(splits, protect)
  │  └─ 合并 splits 和 <span class="hljs-keyword">protected</span>，保证受保护内容完整
  │
  └─ <span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: _merge(splits)
     ├─ 合并 splits 成为最终的 chunks
     ├─ 处理 overlap（重叠）
     └─ 返回 List[Tuple[start, <span class="hljs-keyword">end</span>, <span class="hljs-keyword">text</span>]]

返回：List[(start_pos, end_pos, chunk_text), ...]
</code></pre>
<h4 data-id="heading-20">主函数 split_text()</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">def split_text(self, <span class="hljs-keyword">text</span>: str) -&gt; List[Tuple[int, int, str]]:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">text</span> == <span class="hljs-string">""</span>:
        <span class="hljs-keyword">return</span> []

    # <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: Split <span class="hljs-keyword">text</span> <span class="hljs-keyword">by</span> separators recursively
    splits = self._split(<span class="hljs-keyword">text</span>)
    # <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: Extract <span class="hljs-keyword">protected</span> content positions
    protect = self._split_protected(<span class="hljs-keyword">text</span>)
    # <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: Merge splits <span class="hljs-keyword">with</span> <span class="hljs-keyword">protected</span> content <span class="hljs-keyword">to</span> ensure integrity
    splits = self._join(splits, protect)

    # Verify that joining all splits reconstructs the original <span class="hljs-keyword">text</span>
    assert <span class="hljs-string">""</span>.<span class="hljs-keyword">join</span>(splits) == <span class="hljs-keyword">text</span>

    # <span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: Merge splits <span class="hljs-keyword">into</span> final chunks <span class="hljs-keyword">with</span> overlap
    chunks = self._merge(splits)
    <span class="hljs-keyword">return</span> chunks
</code></pre>
<h4 data-id="heading-21">关键文本保护</h4>
<p>受保护的 Regex 模式（6 种），分别是<strong>LaTeX 数学公式，Markdown 图片链接，Markdown 普通链接，Markdown 表格表头（Header + 分隔行），Markdown 表格内容，代码块头（带语言标识）</strong> ，对于这些场景不进行截断</p>
<pre><code class="hljs language-python" lang="python">protected_regex: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [
    <span class="hljs-comment"># math formula - LaTeX style formulas enclosed in $$</span>
    <span class="hljs-string">r"$$[\s\S]*?$$"</span>,
    <span class="hljs-comment"># image - Markdown image syntax ![alt](url)</span>
    <span class="hljs-string">r"![.*?](.*?)"</span>,
    <span class="hljs-comment"># link - Markdown link syntax [text](url)</span>
    <span class="hljs-string">r"[.*?](.*?)"</span>,
    <span class="hljs-comment"># table header - Markdown table header with separator line</span>
    <span class="hljs-string">r"(?:|[^|\n]*)+|[\r\n]+\s*(?:|\s*:?-{3,}:?\s*)+|[\r\n]+"</span>,
    <span class="hljs-comment"># table body - Markdown table rows</span>
    <span class="hljs-string">r"(?:|[^|\n]*)+|[\r\n]+"</span>,
    <span class="hljs-comment"># code header - Code block start with language identifier</span>
    <span class="hljs-string">r"```(?:\w+)[\r\n]+[^\r\n]*"</span>,
],
</code></pre>
<h4 data-id="heading-22">语义递归粗切 -- _split()</h4>
<pre><code class="hljs language-scss" lang="scss"># 语义规则
self<span class="hljs-selector-class">._split_fns</span> = <span class="hljs-selector-attr">[    split_by_sep(<span class="hljs-string">"\n"</span>),      # [1]</span> 换行符（优先级最高）
    <span class="hljs-built_in">split_by_sep</span>("。"),      # <span class="hljs-selector-attr">[2]</span> 句号
    <span class="hljs-built_in">split_by_sep</span>(" "),       # <span class="hljs-selector-attr">[3]</span> 空格
    <span class="hljs-built_in">split_by_char</span>()          # <span class="hljs-selector-attr">[最后]</span> 逐字分割（fallback）
]
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_split</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""
    递归分割，确保每个 split ≤ chunk_size
    """</span>
    
    <span class="hljs-comment"># 基础情况：文本已足够小</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(text) &lt;= chunk_size:
        <span class="hljs-keyword">return</span> [text]
    
    <span class="hljs-comment"># 递归情况：使用分隔符分割</span>
    splits = []
    
    <span class="hljs-comment"># 按优先级尝试各个分隔符</span>
    <span class="hljs-keyword">for</span> split_fn <span class="hljs-keyword">in</span> self._split_fns:  <span class="hljs-comment"># 5 个函数</span>
        splits = split_fn(text)
        <span class="hljs-comment"># 如果这个分隔符能分割出多个部分，就使用它</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(splits) &gt; <span class="hljs-number">1</span>:
            <span class="hljs-keyword">break</span>
    
    <span class="hljs-comment"># 如果上面的都没有分割成功，最后用 split_by_char() 逐字分割</span>
    <span class="hljs-comment"># （这通常不会发生，除非整个文本没有任何分隔符）</span>
    
    new_splits = []
    <span class="hljs-keyword">for</span> split <span class="hljs-keyword">in</span> splits:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(split) &lt;= chunk_size:
            new_splits.append(split)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 递归处理超大的分割块</span>
            new_splits.extend(self._split(split))
    
    <span class="hljs-keyword">return</span> new_splits
</code></pre>
<pre><code class="hljs language-swift" lang="swift">假设：chunk_size <span class="hljs-operator">=</span> <span class="hljs-number">200</span>，文本长度 <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>

第<span class="hljs-number">1</span>次尝试：用 <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span> 分割
  <span class="hljs-operator">├─</span> 如果能分割成多个部分，检查是否都 <span class="hljs-operator">≤</span> <span class="hljs-number">200</span>
  <span class="hljs-operator">├─</span> 如果有部分 <span class="hljs-operator">&gt;</span> <span class="hljs-number">200</span>，对这些部分递归调用 _split()
  <span class="hljs-operator">└─</span> 递归中再用 <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>，如果还是有 <span class="hljs-operator">&gt;</span> <span class="hljs-number">200</span> 的
      <span class="hljs-operator">└─</span> 换成 <span class="hljs-string">"。"</span> 试试
      
第<span class="hljs-number">2</span>次尝试：用 <span class="hljs-string">"。"</span> 分割
  <span class="hljs-operator">├─</span> 可能会分割得更细
  <span class="hljs-operator">└─</span> 继续检查

第<span class="hljs-number">3</span>次尝试：用 <span class="hljs-string">" "</span> (空格) 分割
  <span class="hljs-operator">├─</span> 分割得更细

最后：split_by_char()
  <span class="hljs-operator">├─</span> 按单个字符分割
  <span class="hljs-operator">└─</span> 确保没有分割块 <span class="hljs-operator">&gt;</span> chunk_size
</code></pre>
<h4 data-id="heading-23">保护文本提取 -- _split_protected()</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_split_protected</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Tuple</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""
    扫描所有 protected_regex，找到所有受保护内容
    返回：[(start_pos, protected_text), ...]
    """</span>
    
    <span class="hljs-comment"># 步骤1: 使用所有 protected 模式进行匹配</span>
    matches = [
        (<span class="hljs-keyword">match</span>.start(), <span class="hljs-keyword">match</span>.end())
        <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> self._protected_fns  <span class="hljs-comment"># 6 个 regex pattern</span>
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">in</span> pattern.finditer(text)
    ]
    
    <span class="hljs-comment"># 步骤2: 按开始位置排序，处理重叠</span>
    matches.sort(key=<span class="hljs-keyword">lambda</span> x: (x[<span class="hljs-number">0</span>], -x[<span class="hljs-number">1</span>]))
    <span class="hljs-comment"># 排序规则：</span>
    <span class="hljs-comment"># - 按 start_pos 升序（从前到后）</span>
    <span class="hljs-comment"># - 如果 start_pos 相同，按 length 降序（长的优先）</span>
    
    <span class="hljs-comment"># 步骤3: 使用 accumulate 过滤重叠的匹配</span>
    res = []
    initial = -<span class="hljs-number">1</span>  <span class="hljs-comment"># 上一个匹配的结束位置</span>
    
    <span class="hljs-keyword">for</span> current_start, current_end <span class="hljs-keyword">in</span> matches:
        <span class="hljs-comment"># 只处理不与前面匹配重叠的内容</span>
        <span class="hljs-keyword">if</span> current_start &gt;= initial:
            <span class="hljs-comment"># 只保留 &lt; chunk_size 的受保护内容</span>
            <span class="hljs-keyword">if</span> current_end - current_start &lt; chunk_size:
                res.append((current_start, text[current_start:current_end]))
            <span class="hljs-keyword">else</span>:
                logger.warning(<span class="hljs-string">f"Protected text ignore: <span class="hljs-subst">{text[current_start:current_end]}</span>"</span>)
                <span class="hljs-comment"># 如果受保护内容本身 &gt; chunk_size，忽略（记录警告）</span>
        
        <span class="hljs-comment"># 更新 initial 为这个匹配的结束位置</span>
        initial = <span class="hljs-built_in">max</span>(initial, current_end)
    
    <span class="hljs-keyword">return</span> res
</code></pre>
<pre><code class="hljs language-ini" lang="ini">1. 表格匹配 (protected_regex<span class="hljs-section">[4]</span> + <span class="hljs-section">[5]</span>):
   ├─ <span class="hljs-attr">start</span>=<span class="hljs-number">20</span>, end=<span class="hljs-number">80</span>
   ├─ <span class="hljs-attr">text</span>=<span class="hljs-string">"| 列1 | 列2 |\n| :--- | ---: |\n| 数据1 | 数据2 |"</span>
   └─ <span class="hljs-attr">length</span>=<span class="hljs-number">60</span> &lt; chunk_size ✅ 保留

2. 数学公式匹配 (protected_regex<span class="hljs-section">[0]</span>):
   ├─ <span class="hljs-attr">start</span>=<span class="hljs-number">100</span>, end=<span class="hljs-number">120</span>
   ├─ <span class="hljs-attr">text</span>=<span class="hljs-string">"$$f(x) = x^2$$"</span>
   └─ <span class="hljs-attr">length</span>=<span class="hljs-number">14</span> &lt; chunk_size ✅ 保留

返回：<span class="hljs-section">[
    (20, "| 列1 | 列2 |\n| :--- | ---: |\n| 数据1 | 数据2 |"),
    (100, "$$f(x) = x^2$$")
]</span>
</code></pre>
<h4 data-id="heading-24">chunk 和保护文本合并 -- _join()</h4>
<p>_join() 的目标是<strong>重新整理 chunk list，通过位置计算，确保受保护内容（如完整表格）不会被分割</strong>。如果原始 chunk 中的表格被断开了，它会合并这些断开的部分并插入完整的受保护内容。</p>
<pre><code class="hljs language-ini" lang="ini">def _join(self, splits: List<span class="hljs-section">[str]</span>, protect: List<span class="hljs-section">[Tuple[int, str]]</span>) -&gt; List<span class="hljs-section">[str]</span>:
    """
    关键目标：确保受保护内容保持完整
    
    问题场景：
    假设 _split() 返回：
      <span class="hljs-attr">splits</span> = [
        <span class="hljs-string">"普通文本 ABC。\n\n"</span>,
        <span class="hljs-string">"| 列1 | 列2 |\n|"</span>,      ← 表格被分割了！（不好）
        <span class="hljs-string">" :--- | ---: |\n| 数据1 | 数据2 |"</span>
      ]
    
    但 protect 告诉我们：
      <span class="hljs-attr">protect</span> = [(<span class="hljs-number">20</span>, <span class="hljs-string">"| 列1 | 列2 |\n| :--- | ---: |\n| 数据1 | 数据2 |"</span>)]
    
    _join() 的作用：重新组织 splits，使得表格作为一个完整单元出现
    """
    
    <span class="hljs-attr">j</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># 受保护内容的索引</span>
    <span class="hljs-attr">point</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># 当前在原文中的位置</span>
    <span class="hljs-attr">start</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># 当前 split 的起始位置</span>
    <span class="hljs-attr">res</span> = []  <span class="hljs-comment"># 结果列表</span>
    
    for split in splits:
        <span class="hljs-comment"># 计算当前 split 在原文中的范围</span>
        <span class="hljs-attr">end</span> = start + len(split)
        
        <span class="hljs-comment"># 从 point 开始提取当前 split 的子串</span>
        <span class="hljs-attr">cur</span> = split[point - start:]
        
        <span class="hljs-comment"># 处理所有与当前 split 重叠的受保护内容</span>
        while j &lt; len(protect):
            p_start, <span class="hljs-attr">p_content</span> = protect[j]
            <span class="hljs-attr">p_end</span> = p_start + len(p_content)
            
            <span class="hljs-comment"># 如果受保护内容在当前 split 之后，停止</span>
            if end &lt;= p_start:
                break
            
            <span class="hljs-comment"># 添加受保护内容之前的部分</span>
            if point &lt; p_start:
                <span class="hljs-attr">local_end</span> = p_start - point
                res.append(cur<span class="hljs-section">[:local_end]</span>)
                <span class="hljs-attr">cur</span> = cur[local_end:]
                <span class="hljs-attr">point</span> = p_start
            
            <span class="hljs-comment"># 添加整个受保护内容（作为一个完整的单元）</span>
            res.append(p_content)
            j += 1
            
            <span class="hljs-comment"># 跳过原 split 中受保护内容的部分</span>
            if point &lt; p_end:
                <span class="hljs-attr">local_start</span> = p_end - point
                <span class="hljs-attr">cur</span> = cur[local_start:]
                <span class="hljs-attr">point</span> = p_end
            
            <span class="hljs-comment"># 如果当前 split 已处理完，跳出</span>
            if not cur:
                break
        
        <span class="hljs-comment"># 添加当前 split 的剩余部分</span>
        if cur:
            res.append(cur)
            <span class="hljs-attr">point</span> = end
        
        <span class="hljs-comment"># 移到下一个 split</span>
        <span class="hljs-attr">start</span> = end
    
    return res
</code></pre>
<p>_join() 简述就是：</p>
<ol>
<li>遍历每个 chunk</li>
<li>当遇到需要保护的内容 protect 时，移除 chunk 中的该内容</li>
<li>插入完整的保护内容</li>
<li>继续处理剩余的 chunk</li>
</ol>
<h4 data-id="heading-25">合并最终 Chunks -- _merge()</h4>
<p>处理 chunk 的 overlap 部分和解析处理 chunk 对应的多级 header 信息，构建最终的 chunk 内容。</p>
<pre><code class="hljs language-ini" lang="ini">def _merge(self, splits: List<span class="hljs-section">[str]</span>) -&gt; List<span class="hljs-section">[Tuple[int, int, str]]</span>:
    """
    合并 splits 成为最终的 chunks
    处理 overlap 和 header 追踪
    """
    
    chunks: List<span class="hljs-section">[Tuple[int, int, str]]</span> = <span class="hljs-section">[]</span>
    cur_chunk: List<span class="hljs-section">[Tuple[int, int, str]]</span> = <span class="hljs-section">[]</span>  <span class="hljs-comment"># 当前 chunk 中的元素</span>
    
    <span class="hljs-attr">cur_headers</span> = <span class="hljs-string">""</span>
    <span class="hljs-attr">cur_len</span> = <span class="hljs-number">0</span>
    cur_start, <span class="hljs-attr">cur_end</span> = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    
    for split in splits:
        <span class="hljs-comment"># 计算 split 在原文中的位置</span>
        <span class="hljs-attr">cur_end</span> = cur_start + len(split)
        <span class="hljs-attr">split_len</span> = len(split)
        
        <span class="hljs-comment"># 更新 header 信息</span>
        self.header_hook.update(split)
        <span class="hljs-attr">cur_headers</span> = self.header_hook.get_headers()
        <span class="hljs-attr">cur_headers_len</span> = len(cur_headers)
        
        <span class="hljs-comment"># 检查是否超过 chunk_size</span>
        if cur_len + split_len + cur_headers_len &gt; chunk_size:
            <span class="hljs-comment"># 当前 chunk 已满，保存它</span>
            if len(cur_chunk) &gt; 0:
                chunks.append((
                    cur_chunk<span class="hljs-section">[0]</span><span class="hljs-section">[0]</span>,              <span class="hljs-comment"># 第一个元素的 start</span>
                    cur_chunk<span class="hljs-section">[-1]</span><span class="hljs-section">[1]</span>,             <span class="hljs-comment"># 最后一个元素的 end</span>
                    "".join(<span class="hljs-section">[c[2]</span> for c in cur_chunk])
                ))
            
            <span class="hljs-comment"># 处理 overlap：从当前 chunk 的末尾向前选择</span>
            while cur_chunk and (
                cur_len &gt; chunk_overlap
                or cur_len + split_len + cur_headers_len &gt; chunk_size
            ):
                <span class="hljs-comment"># 移除第一个元素</span>
                <span class="hljs-attr">first</span> = cur_chunk.pop(<span class="hljs-number">0</span>)
                cur_len <span class="hljs-attr">-</span>= len(first[<span class="hljs-number">2</span>])
            
            <span class="hljs-comment"># 添加 headers 到新 chunk（如果有）</span>
            if (
                cur_headers
                and split_len + cur_headers_len &lt; chunk_size
                and cur_headers not in split
            ):
                <span class="hljs-attr">next_start</span> = cur_chunk[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] if cur_chunk else cur_start
                cur_chunk.insert(0, (0, 0, cur_headers))
                cur_len += cur_headers_len
        
        <span class="hljs-comment"># 添加当前 split 到 chunk</span>
        cur_chunk.append((cur_start, cur_end, split))
        cur_len += split_len
        <span class="hljs-attr">cur_start</span> = cur_end
    
    <span class="hljs-comment"># 处理最后一个 chunk</span>
    if cur_chunk:
        chunks.append((
            cur_chunk<span class="hljs-section">[0]</span><span class="hljs-section">[0]</span>,
            cur_chunk<span class="hljs-section">[-1]</span><span class="hljs-section">[1]</span>,
            "".join(<span class="hljs-section">[c[2]</span> for c in cur_chunk])
        ))
    
    return chunks
</code></pre>
<p>这里重点说下解析处理 chunk 对应的多级 header 信息</p>
<h5 data-id="heading-26">HeaderTracker</h5>
<ol>
<li>解析标题 -- update(split)</li>
</ol>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, split: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""
    解析 split 中的所有 Markdown 标题
    """</span>
    <span class="hljs-comment"># 正则匹配：# 标题、## 子标题等</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">in</span> re.finditer(<span class="hljs-string">r"^(#+)\s+(.+)$"</span>, split, re.MULTILINE):
        level = <span class="hljs-built_in">len</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))  <span class="hljs-comment"># # 的个数（1=一级，2=二级，...）</span>
        title = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>)       <span class="hljs-comment"># 标题文本</span>
        
        <span class="hljs-comment"># 更新当前的标题栈</span>
        <span class="hljs-comment"># 例：读到 ## 时，更新二级标题</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">split</span> = <span class="hljs-string">"## 第二季度\n\nQ2 销售额..."</span>

匹配：
 <span class="hljs-attr">level</span> = <span class="hljs-number">2</span>  (因为是 <span class="hljs-comment">##)</span>
 <span class="hljs-attr">title</span> = <span class="hljs-string">"第二季度"</span>

更新结果：
 <span class="hljs-attr">headers</span> = {
   1: "2024 销售报告",      <span class="hljs-comment"># 一级标题（前面设定的）</span>
   2: "第二季度"            <span class="hljs-comment"># 二级标题（刚更新的）</span>
 }
</code></pre>
<ol start="2">
<li>获取标题 -- get_headers()</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_headers</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    返回当前的所有标题，按层级格式化
    """</span>
    <span class="hljs-comment"># 返回的格式类似：</span>
    <span class="hljs-comment"># # 2024 销售报告</span>
    <span class="hljs-comment"># ## 第二季度</span>
</code></pre>
<p><strong>例子：</strong></p>
<pre><code class="hljs language-scss" lang="scss">当前标题栈：
{
    <span class="hljs-number">1</span>: <span class="hljs-string">"2024 销售报告"</span>,
    <span class="hljs-number">2</span>: <span class="hljs-string">"第二季度"</span>
}

<span class="hljs-built_in">get_headers</span>() 返回：
"# <span class="hljs-number">2024</span> 销售报告\n## 第二季度"
</code></pre>
<ol start="3">
<li>HeaderTracker 在 _merge() 中的使用，在处理每个 chunk 时，更新标题信息并检查是否需要创建新的 chunk。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">for split in splits:
    <span class="hljs-attr">cur_end</span> = cur_start + len(split)
    <span class="hljs-attr">split_len</span> = self.len_function(split)
    
    <span class="hljs-comment"># 【1】更新标题信息</span>
    self.header_hook.update(split)          <span class="hljs-comment"># 解析当前 split 中的标题</span>
    <span class="hljs-attr">cur_headers</span> = self.header_hook.get_headers()  <span class="hljs-comment"># 获取当前标题链</span>
    <span class="hljs-attr">cur_headers_len</span> = self.len_function(cur_headers)
    
    <span class="hljs-comment"># 【2】检查 headers 是否太大</span>
    if cur_headers_len &gt; self.chunk_size:
        logger.error(f"Got headers of size {cur_headers_len}, ...")
        cur_headers, <span class="hljs-attr">cur_headers_len</span> = <span class="hljs-string">""</span>, <span class="hljs-number">0</span>  <span class="hljs-comment"># 舍弃太大的 headers</span>
    
    <span class="hljs-comment"># 【3】检查是否需要创建新 chunk</span>
    if cur_len + split_len + cur_headers_len &gt; self.chunk_size:
        <span class="hljs-comment"># ...保存当前 chunk...</span>
        <span class="hljs-comment"># ...处理 overlap...</span>
        
        <span class="hljs-comment"># 【4】如果空间足够，添加 headers 到新 chunk</span>
        if (
            cur_headers
            and split_len + cur_headers_len &lt; self.chunk_size
            and cur_headers not in split
        ):
            <span class="hljs-comment"># headers 不在 split 中才添加（避免重复）</span>
            cur_chunk.insert(0, (header_start, header_end, cur_headers))
            cur_len += cur_headers_len
    
    <span class="hljs-comment"># 【5】添加当前 split</span>
    cur_chunk.append((cur_start, cur_end, split))
    cur_len += split_len
    <span class="hljs-attr">cur_start</span> = cur_end
</code></pre>
<h4 data-id="heading-27">TextSplitter 设计亮点总结</h4>
<ul>
<li><strong>文本保护机制</strong>： 通过 regex 保护特殊内容。_split_protected() + _join() 使表格、代码块、公式、链接等强关联内容保持完整。</li>
<li><strong>递归多层语义分割</strong>： 多个分隔符逐级尝试，保留语义边界（段落 → 句子 → 词 → 字），递归调用，确保 chunk_size 不超过限制。</li>
<li><strong>Overlap 处理</strong>： Chunks 间有重叠，上下文连贯，增强 Chunks 间的连接性。</li>
<li><strong>标题上下文保留</strong>： HeaderTracker 获取多级标题，Chunk 包含标题上下文确保语义完整。</li>
<li><strong>位置映射</strong>： (start, end, text) 支持回溯原文，提供溯源高亮显示的能力。</li>
</ul>
<h4 data-id="heading-28">Chunk list 安全策略</h4>
<p>直接根据最大 chunk 数（默认 1000）截断，超过部分直接丢弃。防止内存溢出 (OOM)，同时避免数据库性能问题。但这个策略同样存在信息完整性问题，可以考虑根据实际场景调整最大 chunk 数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Limit the number of returned chunks</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(chunks) &gt; self.max_chunks:
    logger.warning(
        <span class="hljs-string">f"Limiting chunks from <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> to maximum <span class="hljs-subst">{self.max_chunks}</span>"</span>
    )
    chunks = chunks[: self.max_chunks]
</code></pre>
<h3 data-id="heading-29">Chunk 图片内容处理</h3>
<p>多模态图片处理流程：对每个 Chunk 中的图片进行提取、下载上传、OCR 文字识别和 VLM 图片描述生成。</p>
<h4 data-id="heading-30">多模态启用条件</h4>
<pre><code class="hljs language-ini" lang="ini">if self.enable_multimodal:
    <span class="hljs-comment"># 支持的文件类型</span>
    <span class="hljs-attr">allowed_types</span> = [
        <span class="hljs-comment"># 文本文档</span>
        <span class="hljs-string">".pdf"</span>, <span class="hljs-string">".md"</span>, <span class="hljs-string">".markdown"</span>, <span class="hljs-string">".doc"</span>, <span class="hljs-string">".docx"</span>,
        <span class="hljs-comment"># 纯图片文件</span>
        <span class="hljs-string">".jpg"</span>, <span class="hljs-string">".jpeg"</span>, <span class="hljs-string">".png"</span>, <span class="hljs-string">".gif"</span>, <span class="hljs-string">".bmp"</span>, <span class="hljs-string">".tiff"</span>, <span class="hljs-string">".webp"</span>,
    ]
    
    if file_ext in allowed_types:
        <span class="hljs-attr">chunks</span> = self.process_chunks_images(chunks, document.images)
</code></pre>
<h4 data-id="heading-31">图片处理流程</h4>
<p>对单个 Chunk 中的图片处理步骤：</p>
<ol>
<li><strong>提取图片引用</strong> - 从 <code>chunk.content</code> 中提取 Markdown 图片语法 <code>![alt](url)</code></li>
<li><strong>下载/上传图片</strong> - 将图片统一存储到对象存储 (COS/MinIO)</li>
<li><strong>OCR 文字识别</strong> - 使用 Paddle OCR 提取图片中的文字</li>
<li><strong>VLM 图片描述</strong> - 调用多模态 LLM 生成图片自然语言描述</li>
<li><strong>更新 chunk.images</strong> - 将处理结果写入 Chunk</li>
</ol>
<h4 data-id="heading-32">图片下载策略</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_and_upload_image</span>(<span class="hljs-params">self, img_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""
    处理三种情况：
    1. 已在存储中 (COS/MinIO) → 直接使用
    2. 本地文件              → 上传到存储
    3. 远程 URL              → 下载后上传到存储
    """</span>
</code></pre>
<h4 data-id="heading-33">SSRF 安全防护</h4>
<p>验证 URL 防止 SSRF 攻击：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@staticmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">_is_safe_url</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""
    拒绝的 URL 类型：
    1. 非 HTTP/HTTPS 协议
    2. 私有 IP (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
    3. Loopback IP (127.0.0.1, ::1)
    4. 云服务元数据端点 (169.254.169.254)
    5. 本地主机名 (.local, localhost)
    """</span>
</code></pre>
<h4 data-id="heading-34">OCR &amp; VLM</h4>


























<table><thead><tr><th>处理方式</th><th>支持引擎</th><th>输入</th><th>输出</th><th>用途</th></tr></thead><tbody><tr><td><strong>OCR</strong></td><td>Paddle OCR/Nanonets OCR</td><td>PIL Image</td><td>图片中的文字</td><td>关键字匹配、结构化数据提取</td></tr><tr><td><strong>VLM</strong></td><td>OpenAI/Ollama 自部署</td><td>Base64 图片</td><td>自然语言描述</td><td>语义理解、RAG 问答增强</td></tr></tbody></table>
<h4 data-id="heading-35">OCR 实现详解 (PaddleOCR)</h4>
<h5 data-id="heading-36">初始化配置</h5>
<pre><code class="hljs language-python" lang="python">ocr_config = {
    <span class="hljs-string">"use_gpu"</span>: <span class="hljs-literal">False</span>,                    <span class="hljs-comment"># 禁用 GPU，使用 CPU</span>
    <span class="hljs-string">"text_det_limit_side_len"</span>: <span class="hljs-number">960</span>,      <span class="hljs-comment"># 图片长边限制 960px</span>
    <span class="hljs-string">"use_doc_orientation_classify"</span>: <span class="hljs-literal">True</span>, <span class="hljs-comment"># 自动检测文档方向（0°/90°/180°/270°）</span>
    <span class="hljs-string">"use_textline_orientation"</span>: <span class="hljs-literal">True</span>,     <span class="hljs-comment"># 文本行方向检测</span>
    
    <span class="hljs-comment"># 模型选择（v4 最新版本）</span>
    <span class="hljs-string">"text_recognition_model_name"</span>: <span class="hljs-string">"PP-OCRv4_server_rec"</span>,
    <span class="hljs-string">"text_detection_model_name"</span>: <span class="hljs-string">"PP-OCRv4_server_det"</span>,
    
    <span class="hljs-comment"># 检测阈值</span>
    <span class="hljs-string">"text_det_thresh"</span>: <span class="hljs-number">0.3</span>,              <span class="hljs-comment"># 检测候选框阈值</span>
    <span class="hljs-string">"text_det_box_thresh"</span>: <span class="hljs-number">0.6</span>,          <span class="hljs-comment"># 文本框置信度阈值</span>
    <span class="hljs-string">"text_det_unclip_ratio"</span>: <span class="hljs-number">1.5</span>,        <span class="hljs-comment"># 文本框扩大比例</span>
    
    <span class="hljs-comment"># 高精度模式</span>
    <span class="hljs-string">"use_dilation"</span>: <span class="hljs-literal">True</span>,                <span class="hljs-comment"># 膨胀操作提高准确率</span>
    <span class="hljs-string">"det_db_score_mode"</span>: <span class="hljs-string">"slow"</span>,         <span class="hljs-comment"># 慢速但准确的评分模式</span>
    <span class="hljs-string">"lang"</span>: <span class="hljs-string">"ch"</span>,                        <span class="hljs-comment"># 识别中文</span>
}
</code></pre>
<h5 data-id="heading-37">CPU 兼容性检测</h5>
<p>PaddleOCR 使用 AVX 指令集加速，老旧 CPU 可能不支持：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 检测 CPU 是否支持 AVX</span>
if platform.system() == "Linux":
    <span class="hljs-attr">result</span> = subprocess.run(
        <span class="hljs-section">["grep", "-o", "avx", "/proc/cpuinfo"]</span>,
        <span class="hljs-attr">capture_output</span>=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, timeout=<span class="hljs-number">5</span>
    )
    <span class="hljs-attr">has_avx</span> = <span class="hljs-string">"avx"</span> in result.stdout.lower()
    
    if not has_avx:
        <span class="hljs-comment"># 降级到兼容模式</span>
        os.environ<span class="hljs-section">["FLAGS_use_avx2"]</span> = "0"
        os.environ<span class="hljs-section">["FLAGS_use_avx"]</span> = "1"
</code></pre>
<h5 data-id="heading-38">OCR 识别流程</h5>
<pre><code class="hljs language-arduino" lang="arduino">def _predict(self, image: Image.Image) -&gt; str:
    # <span class="hljs-number">1.</span> 确保 RGB 格式
    <span class="hljs-keyword">if</span> image.mode != <span class="hljs-string">"RGB"</span>:
        image = image.<span class="hljs-built_in">convert</span>(<span class="hljs-string">"RGB"</span>)
    
    # <span class="hljs-number">2.</span> 转换为 numpy 数组
    image_array = np.<span class="hljs-built_in">array</span>(image)
    
    # <span class="hljs-number">3.</span> 执行 OCR
    ocr_result = self.ocr.<span class="hljs-built_in">ocr</span>(image_array, cls=False)
    # 返回格式：[[[坐标框], (<span class="hljs-string">"文字"</span>, 置信度)], ...]
    
    # <span class="hljs-number">4.</span> 提取文字
    text = [line[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> line in ocr_result[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> line <span class="hljs-keyword">and</span> line[<span class="hljs-number">1</span>]]
    <span class="hljs-keyword">return</span> <span class="hljs-string">" "</span>.<span class="hljs-built_in">join</span>(text)
</code></pre>
<h4 data-id="heading-39">Chunk 图片信息结构</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">chunk.images</span> = [
    {
        <span class="hljs-comment"># 原始信息</span>
        <span class="hljs-string">"original_url"</span>: <span class="hljs-string">"https://example.com/chart.png"</span>,
        <span class="hljs-string">"start"</span>: <span class="hljs-number">40</span>,
        <span class="hljs-string">"end"</span>: <span class="hljs-number">90</span>,
        <span class="hljs-string">"alt_text"</span>: <span class="hljs-string">"销售图表"</span>,
        <span class="hljs-string">"match_text"</span>: <span class="hljs-string">"![销售图表](https://...)"</span>,
        
        <span class="hljs-comment"># 存储信息</span>
        <span class="hljs-string">"cos_url"</span>: <span class="hljs-string">"https://storage.local/abc123.png"</span>,
        
        <span class="hljs-comment"># OCR 结果</span>
        <span class="hljs-string">"ocr_text"</span>: <span class="hljs-string">"Q1销售额\n一月：100万\n二月：110万"</span>,
        
        <span class="hljs-comment"># VLM 结果</span>
        <span class="hljs-string">"caption"</span>: <span class="hljs-string">"这是一个柱状图，展示了Q1的月度销售数据..."</span>
    }
]
</code></pre>
<p>生成最终的 chunk 结构后，将对 chunk 进行向量化，以及根据配置进行相应的 RAG 增强。</p>
<h3 data-id="heading-40">向量化</h3>
<h4 data-id="heading-41">清除旧数据</h4>
<p>清理旧的 chunks 和索引数据，避免重复数据，如果存在知识图谱数据也同样清除。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 删除旧的chunks</span>
err := s.chunkService.DeleteChunksByKnowledgeID(ctx, knowledge.ID);
<span class="hljs-comment">// 删除旧的索引数据</span>
err := retrieveEngine.DeleteByKnowledgeIDList(ctx, []<span class="hljs-type">string</span>{knowledge.ID}, embeddingModel.GetDimensions(), knowledge.Type);
<span class="hljs-comment">// 删除知识图谱数据（如果存在）</span>
err := s.graphEngine.DelGraph(ctx, []types.NameSpace{namespace});
</code></pre>
<h4 data-id="heading-42">构建 Chunk 对象</h4>
<p>包括 chunk 的文本内容和图片 OCR 信息，以及图片 Caption 信息。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">_</span>, <span class="hljs-selector-tag">chunkData</span> := <span class="hljs-selector-tag">range</span> <span class="hljs-selector-tag">chunks</span> {
    <span class="hljs-comment">// 1. 创建主文本 Chunk</span>
    textChunk := &amp;types.Chunk{
        ID:              uuid.New().String(),
        TenantID:        knowledge.TenantID,
        KnowledgeID:     knowledge.ID,
        KnowledgeBaseID: knowledge.KnowledgeBaseID,
        <span class="hljs-attribute">Content</span>:         chunkData.Content,
        <span class="hljs-attribute">ChunkIndex</span>:      <span class="hljs-built_in">int</span>(chunkData.Seq),
        <span class="hljs-attribute">ChunkType</span>:       types.ChunkTypeText,  <span class="hljs-comment">// "text"</span>
        <span class="hljs-comment">// ...</span>
    }
    <span class="hljs-selector-tag">insertChunks</span> = <span class="hljs-selector-tag">append</span>(insertChunks, textChunk)

    <span class="hljs-comment">// 2. 处理图片信息</span>
    <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">len</span>(chunkData.Images) &gt; <span class="hljs-number">0</span> {
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">i</span>, <span class="hljs-selector-tag">img</span> := <span class="hljs-selector-tag">range</span> <span class="hljs-selector-tag">chunkData</span><span class="hljs-selector-class">.Images</span> {
            <span class="hljs-comment">// 2.1 创建 OCR Chunk（如果有 OCR 文本）</span>
            <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">img</span><span class="hljs-selector-class">.OcrText</span> != "" {
                ocrChunk := &amp;types.Chunk{
                    ID:            uuid.New().String(),
                    <span class="hljs-attribute">Content</span>:       img.OcrText,
                    <span class="hljs-attribute">ChunkType</span>:     types.ChunkTypeImageOCR,  <span class="hljs-comment">// "image_ocr"</span>
                    <span class="hljs-attribute">ParentChunkID</span>: textChunk.ID,             <span class="hljs-comment">// 关联到父 Chunk</span>
                    <span class="hljs-attribute">ImageInfo</span>:     <span class="hljs-built_in">string</span>(imageInfoJSON),
                    <span class="hljs-comment">// ...</span>
                }
                <span class="hljs-selector-tag">insertChunks</span> = <span class="hljs-selector-tag">append</span>(insertChunks, ocrChunk)
            }

            <span class="hljs-comment">// 2.2 创建 Caption Chunk（如果有图片描述）</span>
            <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">img</span><span class="hljs-selector-class">.Caption</span> != "" {
                captionChunk := &amp;types.Chunk{
                    ID:            uuid.New().String(),
                    <span class="hljs-attribute">Content</span>:       img.Caption,
                    <span class="hljs-attribute">ChunkType</span>:     types.ChunkTypeImageCaption,  <span class="hljs-comment">// "image_caption"</span>
                    <span class="hljs-attribute">ParentChunkID</span>: textChunk.ID,
                    <span class="hljs-attribute">ImageInfo</span>:     <span class="hljs-built_in">string</span>(imageInfoJSON),
                    <span class="hljs-comment">// ...</span>
                }
                <span class="hljs-selector-tag">insertChunks</span> = <span class="hljs-selector-tag">append</span>(insertChunks, captionChunk)
            }
        }
        <span class="hljs-comment">// 将图片信息保存到文本 Chunk</span>
        <span class="hljs-selector-tag">textChunk</span><span class="hljs-selector-class">.ImageInfo</span> = <span class="hljs-selector-tag">string</span>(imageInfoJSON)
    }
}
</code></pre>
<h4 data-id="heading-43">设置 Chunk 关系</h4>
<p>为<strong>文本类型</strong>的 Chunk 设置前后关系，构建 chunk 链表。为了支持检索时的上下文扩展。</p>
<pre><code class="hljs language-css" lang="css">for <span class="hljs-selector-tag">i</span>, chunk := range textChunks {
    if <span class="hljs-selector-tag">i</span> &gt; <span class="hljs-number">0</span> {
        textChunks<span class="hljs-selector-attr">[i-1]</span><span class="hljs-selector-class">.NextChunkID</span> = chunk<span class="hljs-selector-class">.ID</span>
    }
    if <span class="hljs-selector-tag">i</span> &lt; len(textChunks)-<span class="hljs-number">1</span> {
        textChunks<span class="hljs-selector-attr">[i+1]</span><span class="hljs-selector-class">.PreChunkID</span> = chunk<span class="hljs-selector-class">.ID</span>
    }
}
</code></pre>
<h4 data-id="heading-44">构建向量数据索引信息</h4>
<pre><code class="hljs language-go" lang="go">indexInfoList := <span class="hljs-built_in">make</span>([]*types.IndexInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(insertChunks))
<span class="hljs-keyword">for</span> _, chunk := <span class="hljs-keyword">range</span> insertChunks {
    indexInfoList = <span class="hljs-built_in">append</span>(indexInfoList, &amp;types.IndexInfo{
        Content:         chunk.Content,      <span class="hljs-comment">// 用于生成 embedding</span>
        SourceID:        chunk.ID,
        SourceType:      types.ChunkSourceType,
        ChunkID:         chunk.ID,
        KnowledgeID:     knowledge.ID,
        KnowledgeBaseID: knowledge.KnowledgeBaseID,
    })
}
</code></pre>
<h4 data-id="heading-45">检查存储配额检查</h4>
<p>简单估算本次插入向量的存储大小，检查是否超过配额。存储大小 ≈ 索引条目数 × (向量维度 × 4 + 元数据大小)</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 估算存储大小</span>
totalStorageSize := retrieveEngine.EstimateStorageSize(ctx, embeddingModel, indexInfoList)

<span class="hljs-comment">// 检查配额</span>
<span class="hljs-keyword">if</span> tenantInfo.StorageQuota &gt; <span class="hljs-number">0</span> {
    <span class="hljs-keyword">if</span> tenantInfo.StorageUsed + totalStorageSize &gt; tenantInfo.StorageQuota {
        knowledge.ParseStatus = types.ParseStatusFailed
        knowledge.ErrorMessage = <span class="hljs-string">"存储空间不足"</span>
        s.repo.UpdateKnowledge(ctx, knowledge)
        <span class="hljs-keyword">return</span>
    }
}
</code></pre>
<h4 data-id="heading-46">保存 Chunk 列表并向量化</h4>
<p>先将 chunk 列表保存到数据库，然后批量向量化。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 保存 chunk 列表</span>
err := s.chunkService.<span class="hljs-built_in">CreateChunks</span>(ctx, insertChunks); 

<span class="hljs-comment">// 批量向量化</span>
err = retrieveEngine<span class="hljs-selector-class">.BatchIndex</span>(ctx, embeddingModel, indexInfoList)
</code></pre>
<h3 data-id="heading-47">知识图谱构建</h3>
<h4 data-id="heading-48">开启知识图谱提取</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> kb.ExtractConfig != <span class="hljs-literal">nil</span> &amp;&amp; kb.ExtractConfig.Enabled {
    <span class="hljs-keyword">for</span> _, chunk := <span class="hljs-keyword">range</span> textChunks {
        err := NewChunkExtractTask(ctx, s.task, chunk.TenantID, chunk.ID, kb.SummaryModelID)
        ...
    }
}
</code></pre>
<h4 data-id="heading-49">构建提取模板</h4>
<p>构建知识图谱提取 prompt 模板，用于 LLM 提取知识图谱中的实体和关系。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">template</span> := &amp;types.PromptTemplateStructured{
    Description: s.<span class="hljs-keyword">template</span>.Description,
    Tags:        kb.ExtractConfig.Tags,        <span class="hljs-comment">// 实体类型定义</span>
    Examples: []types.GraphData{
        {
            Text:     kb.ExtractConfig.Text,      <span class="hljs-comment">// 示例文本</span>
            Node:     kb.ExtractConfig.Nodes,     <span class="hljs-comment">// 示例节点</span>
            Relation: kb.ExtractConfig.Relations, <span class="hljs-comment">// 示例关系</span>
        },
    },
}
</code></pre>
<h4 data-id="heading-50">LLM 提取实体和关系</h4>
<p>调用 LLM 提取 chunk 中的实体和关系，根据模板生成结构化的知识图谱。在提取实体和关系时，若 LLM 提取出了 relation，但没有对应的 node，会触发自动补充节点功能，将缺失的节点添加到知识图谱中。</p>
<pre><code class="hljs language-css" lang="css">extractor := chatpipline.<span class="hljs-built_in">NewExtractor</span>(chatModel, template)
graph, err := extractor.<span class="hljs-built_in">Extract</span>(ctx, chunk.Content)
</code></pre>
<h4 data-id="heading-51">关联 Chunk 写入图数据库</h4>
<p>将提取到的知识图谱关联到对应的 Chunk 中，存储在数据库中。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 为每个节点关联来源 Chunk</span>
<span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> graph.Node {
    node.Chunks = []<span class="hljs-type">string</span>{chunk.ID}
}

<span class="hljs-comment">// 写入图数据库</span>
err = s.graphEngine.AddGraph(ctx,
    types.NameSpace{
        KnowledgeBase: chunk.KnowledgeBaseID,
        Knowledge:     chunk.KnowledgeID,
    },
    []*types.GraphData{graph},
)
</code></pre>
<h3 data-id="heading-52">关联问题生成</h3>
<h4 data-id="heading-53">开启问题生成</h4>
<pre><code class="hljs language-ini" lang="ini">if options.EnableQuestionGeneration &amp;&amp; len(textChunks) &gt; 0 {
    questionCount := options.QuestionCount
    if questionCount &lt;= 0 {
        <span class="hljs-attr">questionCount</span> = <span class="hljs-number">3</span>
    }
    if questionCount &gt; 10 {
        <span class="hljs-attr">questionCount</span> = <span class="hljs-number">10</span>
    }
    s.enqueueQuestionGenerationTask(ctx, knowledge.KnowledgeBaseID, knowledge.ID, questionCount)
}
</code></pre>
<h4 data-id="heading-54">构建问题生成相关文本</h4>
<p>先对文本 chunk 按照时间排序，在通过当前文本 chunk 的链表结构结合前后 chunk 内容构建问题生成的相关文本内容。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 按 StartAt 排序（用于获取上下文）</span>
sort.Slice(textChunks, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">return</span> textChunks[i].StartAt &lt; textChunks[j].StartAt
})
<span class="hljs-comment">// 获取当前文本 chunk 的前后 chunk 内容，用于构建问题生成的相关文本</span>
<span class="hljs-keyword">for</span> i, chunk := <span class="hljs-keyword">range</span> textChunks {
    <span class="hljs-comment">// 获取前后 chunk 作为上下文</span>
    <span class="hljs-keyword">var</span> prevContent, nextContent <span class="hljs-type">string</span>
    <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> {
        prevContent = textChunks[i<span class="hljs-number">-1</span>].Content
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prevContent) &gt; <span class="hljs-number">500</span> {
            prevContent = prevContent[<span class="hljs-built_in">len</span>(prevContent)<span class="hljs-number">-500</span>:]  <span class="hljs-comment">// 取后500字符</span>
        }
    }
    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(textChunks)<span class="hljs-number">-1</span> {
        nextContent = textChunks[i+<span class="hljs-number">1</span>].Content
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nextContent) &gt; <span class="hljs-number">500</span> {
            nextContent = nextContent[:<span class="hljs-number">500</span>]  <span class="hljs-comment">// 取前500字符</span>
        }
    }
    ...
}
</code></pre>
<h4 data-id="heading-55">生成 Chunk 相关问题</h4>
<p>通过 LLM 结合上下文（前 chunk 内容、后 chunk 内容、知识标题）生成与当前 chunk 相关的问题，并保存至 metadata。</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">4</span>. 调用 LLM 生成问题
questions, _ := s.<span class="hljs-built_in">generateQuestionsWithContext</span>(ctx, chatModel, 
    chunk.Content, prevContent, nextContent, knowledge.Title, questionCount)

// <span class="hljs-number">5</span>. 保存问题到 chunk 的 metadata
generatedQuestions := <span class="hljs-built_in">make</span>([]types.GeneratedQuestion, <span class="hljs-built_in">len</span>(questions))
for j, question := range questions {
    questionID := fmt.<span class="hljs-built_in">Sprintf</span>(<span class="hljs-string">"q%d"</span>, time.<span class="hljs-built_in">Now</span>().<span class="hljs-built_in">UnixNano</span>()+<span class="hljs-built_in">int64</span>(j))
    generatedQuestions[j] = types.GeneratedQuestion{
        ID:       questionID,
        Question: question,
    }
}
</code></pre>
<h4 data-id="heading-56">问题向量化</h4>
<p>将生成的问题向量化，用于检索。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 构建问题索引</span>
<span class="hljs-keyword">for</span> _, gq := <span class="hljs-keyword">range</span> generatedQuestions {
    sourceID := fmt.Sprintf(<span class="hljs-string">"%s-%s"</span>, chunk.ID, gq.ID)
    indexInfoList = <span class="hljs-built_in">append</span>(indexInfoList, &amp;types.IndexInfo{
        Content:         gq.Question,
        SourceID:        sourceID,
        ChunkID:         chunk.ID,  <span class="hljs-comment">// 指向原始 chunk</span>
        KnowledgeID:     knowledge.ID,
        KnowledgeBaseID: knowledge.KnowledgeBaseID,
    })
}
<span class="hljs-comment">// 向量化</span>
retrieveEngine.BatchIndex(ctx, embeddingModel, indexInfoList)
</code></pre>
<h3 data-id="heading-57">摘要生成</h3>
<p>若存在文本 chunk，则会触发摘要生成任务。</p>
<pre><code class="hljs language-scss" lang="scss">if <span class="hljs-built_in">len</span>(textChunks) &gt; <span class="hljs-number">0</span> {
    s<span class="hljs-selector-class">.enqueueSummaryGenerationTask</span>(ctx, knowledge.KnowledgeBaseID, knowledge.ID)
}
</code></pre>
<h4 data-id="heading-58">排序 Chunk 内容</h4>
<p>对文本 chunk 按照 ChunkIndex 排序，确保摘要内容按文档顺序拼接。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 按 ChunkIndex 排序</span>
sort.Slice(textChunks, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">return</span> textChunks[i].ChunkIndex &lt; textChunks[j].ChunkIndex
})
</code></pre>
<h4 data-id="heading-59">处理摘要原始内容</h4>
<p>对排序后的 chunk 内容进行拼接，限制总长度为 4096 字符，作为摘要的原始内容。同时处理原始内容中的图片描述和 OCR 文字。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 拼接 chunk 内容（按 StartAt 排序，限制 4096 字符）</span>
chunkContents := <span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> _, chunk := <span class="hljs-keyword">range</span> sortedChunks {
    <span class="hljs-keyword">if</span> chunk.EndAt &gt; <span class="hljs-number">4096</span> {
        <span class="hljs-keyword">break</span>  <span class="hljs-comment">// 限制内容长度</span>
    }
    chunkContents = <span class="hljs-type">string</span>([]<span class="hljs-type">rune</span>(chunkContents)[:chunk.StartAt]) + chunk.Content
    
    <span class="hljs-comment">// 收集图片信息</span>
    <span class="hljs-keyword">if</span> chunk.ImageInfo != <span class="hljs-string">""</span> {
        <span class="hljs-keyword">var</span> images []*types.ImageInfo
        json.Unmarshal([]<span class="hljs-type">byte</span>(chunk.ImageInfo), &amp;images)
        allImageInfos = <span class="hljs-built_in">append</span>(allImageInfos, images...)
    }
}

<span class="hljs-comment">// 移除 Markdown 图片语法</span>
re := regexp.MustCompile(<span class="hljs-string">`![[^]]*]([^)]+)`</span>)
chunkContents = re.ReplaceAllString(chunkContents, <span class="hljs-string">""</span>)

<span class="hljs-comment">// 添加图片描述和 OCR 文字</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(allImageInfos) &gt; <span class="hljs-number">0</span> {
    <span class="hljs-keyword">var</span> imageAnnotations <span class="hljs-type">string</span>
    <span class="hljs-keyword">for</span> _, img := <span class="hljs-keyword">range</span> allImageInfos {
        <span class="hljs-keyword">if</span> img.Caption != <span class="hljs-string">""</span> {
            imageAnnotations += fmt.Sprintf(<span class="hljs-string">"\n[图片描述: %s]"</span>, img.Caption)
        }
        <span class="hljs-keyword">if</span> img.OCRText != <span class="hljs-string">""</span> {
            imageAnnotations += fmt.Sprintf(<span class="hljs-string">"\n[图片文字: %s]"</span>, img.OCRText)
        }
    }
    chunkContents = chunkContents + imageAnnotations
}

<span class="hljs-comment">// 内容太短直接返回</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(chunkContents) &lt; <span class="hljs-number">300</span> {
    <span class="hljs-keyword">return</span> chunkContents, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 添加文档元数据</span>
metadataIntro := fmt.Sprintf(<span class="hljs-string">"文档类型: %s\n文件名称: %s\n"</span>, knowledge.FileType, knowledge.FileName)
contentWithMetadata = metadataIntro + <span class="hljs-string">"\n内容:\n"</span> + chunkContents
</code></pre>
<h4 data-id="heading-60">调用 LLM 生成摘要</h4>
<pre><code class="hljs language-php" lang="php">summary, err := summaryModel.<span class="hljs-title function_ invoke__">Chat</span>(ctx, []chat.Message{
    {<span class="hljs-attr">Role</span>: <span class="hljs-string">"system"</span>,<span class="hljs-attr"> Content</span>: s.config.Conversation.GenerateSummaryPrompt},
    {<span class="hljs-attr">Role</span>: <span class="hljs-string">"user"</span>,<span class="hljs-attr">   Content</span>: contentWithMetadata},
}, &amp;chat.ChatOptions{
<span class="hljs-attr">    Temperature</span>: <span class="hljs-number">0.3</span>,
<span class="hljs-attr">    MaxTokens</span>:   <span class="hljs-number">1024</span>,
<span class="hljs-attr">    Thinking</span>:    &amp;thinking,
})
</code></pre>
<h4 data-id="heading-61">保存摘要并向量化</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 保存摘要 chunk</span>
summaryChunk := &amp;types.Chunk{
    ID:              uuid.New().String(),
    TenantID:        knowledge.TenantID,
    KnowledgeID:     knowledge.ID,
    KnowledgeBaseID: knowledge.KnowledgeBaseID,
    <span class="hljs-attribute">Content</span>:         fmt.<span class="hljs-built_in">Sprintf</span>(<span class="hljs-string">"# 文档名称\n%s\n\n# 摘要\n%s"</span>, knowledge.FileName, summary),
    <span class="hljs-attribute">ChunkIndex</span>:      maxChunkIndex + <span class="hljs-number">1</span>,
    <span class="hljs-attribute">IsEnabled</span>:       true,
    <span class="hljs-attribute">ChunkType</span>:       types.ChunkTypeSummary,
    <span class="hljs-attribute">ParentChunkID</span>:   textChunks[<span class="hljs-number">0</span>].ID,
}
<span class="hljs-selector-tag">s</span><span class="hljs-selector-class">.chunkService</span><span class="hljs-selector-class">.CreateChunks</span>(ctx, []*types.Chunk{<span class="hljs-selector-tag">summaryChunk</span>})
<span class="hljs-comment">// 向量化摘要 chunk</span>
<span class="hljs-selector-tag">indexInfo</span> := <span class="hljs-selector-attr">[]</span>*<span class="hljs-selector-tag">types</span><span class="hljs-selector-class">.IndexInfo</span>{{
    <span class="hljs-attribute">Content</span>:         summaryChunk.Content,
    <span class="hljs-attribute">SourceID</span>:        summaryChunk.ID,
    <span class="hljs-attribute">SourceType</span>:      types.ChunkSourceType,
    <span class="hljs-attribute">ChunkID</span>:         summaryChunk.ID,
    <span class="hljs-attribute">KnowledgeID</span>:     knowledge.ID,
    <span class="hljs-attribute">KnowledgeBaseID</span>: knowledge.KnowledgeBaseID,
}}
retrieveEngine.<span class="hljs-built_in">BatchIndex</span>(ctx, embeddingModel, indexInfo) 
</code></pre>
<h2 data-id="heading-62">尾言</h2>
<p>本文从工程视角系统梳理了 WeKnora 在<strong>知识构建阶段</strong>的整体设计：<br/>
从多种知识上传方式开始，经过异步解析与降级策略保障；再到以 Markdown 为核心中间表示的统一解析架构；随后通过具备语义感知、结构保护与标题追踪能力的 TextSplitter 生成高质量 Chunk；并进一步叠加图片 OCR、VLM 描述、多模态向量、知识图谱抽取、问题生成与摘要生成，最终形成一套<strong>可检索、可追溯、可扩展的知识底座</strong>。</p>
<p>可以看到，WeKnora 并没有将 RAG 简化为“切 chunk + 向量化”这样的轻量流程，而是非常认真地对待<strong>文档结构、上下文完整性和信息损失控制</strong>这些在生产环境中至关重要的问题。这也是它与许多示例型 RAG 项目最本质的区别。</p>
<p>在下一篇文章中，我们将把视角从「知识如何被构建」转向「知识如何被召回」，重点分析 WeKnora 的<strong>检索体系设计</strong>：</p>
<p>它是如何结合 <strong>稀疏索引（关键词/倒排）</strong> 、<strong>向量索引（语义检索）</strong> 与 <strong>知识图谱检索</strong> 的？</p>
<p>在召回中是如何使用文档摘要， chunk 相关提问，图片 ocr 文本以及格式化表格等信息的？</p>
<p>不同召回通道在什么场景下生效，又是如何进行融合、裁剪与排序的？</p>
<p>这将直接决定 WeKnora 在真实问答场景中的“命中率”和“可解释性”，也是整套 RAG 系统中承上启下的关键一环。</p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依前端vue项目里面的drag.js 详解]]></title>    <link>https://juejin.cn/post/7597776334065549364</link>    <guid>https://juejin.cn/post/7597776334065549364</guid>    <pubDate>2026-01-22T07:17:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334065549364" data-draft-id="7597722671084781602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依前端vue项目里面的drag.js  详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:17:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一写代码就开心"/> <meta itemprop="url" content="https://juejin.cn/user/2889993082908344"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依前端vue项目里面的drag.js  详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2889993082908344/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一写代码就开心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:17:05.000Z" title="Thu Jan 22 2026 07:17:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">作用说明</h3>
<p>这个自定义指令的核心作用是 <strong>为 Element UI 的 <code>el-dialog</code> 弹窗添加拖拽功能</strong>，允许用户通过拖拽弹窗头部（<code>.el-dialog__header</code>）自由移动弹窗位置，提升交互灵活性（默认 <code>el-dialog</code> 无法拖拽，只能固定在页面中）。</p>
<h3 data-id="heading-1">使用案例</h3>
<h4 data-id="heading-2">步骤1：注册指令</h4>
<p>在 <code>main.js</code> 中全局注册指令（假设文件路径为 <code>@/directive/drag.js</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">import</span> dialogDrag <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directive/drag.js'</span>;
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'dialogDrag'</span>, dialogDrag); <span class="hljs-comment">// 注册指令，命名为 v-dialogDrag</span>
</code></pre>
<h4 data-id="heading-3">步骤2：在组件中使用（结合 Element UI 的 el-dialog）</h4>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 按钮触发弹窗 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = true"</span>&gt;</span>打开可拖拽弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- 
      v-dialogDrag：启用拖拽功能（默认true，可传false禁用）
      .el-dialog：Element UI 弹窗组件，指令会自动查找其内部的头部和容器
    --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>
      <span class="hljs-attr">title</span>=<span class="hljs-string">"可拖拽弹窗"</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisible"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"50%"</span>
      <span class="hljs-attr">v-dialogDrag</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">应用拖拽指令</span> <span class="hljs-attr">--</span>&gt;</span>
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这是一个可以通过头部拖拽的弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>关闭<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">dialogVisible</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 控制弹窗显示/隐藏</span>
    };
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">步骤3：可选配置（动态启用/禁用拖拽）</h4>
<p>通过指令值控制是否启用拖拽（<code>true</code> 启用，<code>false</code> 禁用）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 仅在 isDraggable 为 true 时允许拖拽 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>
  <span class="hljs-attr">title</span>=<span class="hljs-string">"条件拖拽弹窗"</span>
  <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisible"</span>
  <span class="hljs-attr">v-dialogDrag</span>=<span class="hljs-string">"isDraggable"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">动态控制</span> <span class="hljs-attr">--</span>&gt;</span>
&gt;
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>是否可拖拽：{{ isDraggable ? '是' : '否' }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"isDraggable = !isDraggable"</span>&gt;</span>切换拖拽状态<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">dialogVisible</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">isDraggable</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 初始允许拖拽</span>
    };
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">关键说明</h3>
<ol start="0">
<li><strong>依赖 Element UI</strong>：指令内部通过类名 <code>.el-dialog__header</code> 和 <code>.el-dialog</code> 查找元素，因此仅适用于 Element UI 的 <code>el-dialog</code> 组件。</li>
<li><strong>拖拽区域</strong>：只能通过弹窗头部（包含标题的区域）拖拽，其他区域（如内容区、底部按钮）无法触发拖拽。</li>
<li><strong>定位逻辑</strong>：弹窗会被设置为 <code>position: absolute</code>，初始位置水平居中，拖拽时通过更新 <code>left</code> 和 <code>top</code> 样式实现移动。</li>
</ol>
<p>通过该指令，可解决默认弹窗位置固定的问题，尤其在多弹窗叠加或弹窗遮挡内容时，用户可自由调整位置，提升操作体验。</p>
<p>若依vue前端后端对应完整笔记，直接后台联系或者B站联系</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/940d1105e563401ebb491be0aefa2a7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5YaZ5Luj56CB5bCx5byA5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671024&amp;x-signature=bPdTXHVaWpve%2FJ6mJDybssC4nNw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云全新发布的 UModel 是什么]]></title>    <link>https://juejin.cn/post/7597811700285046803</link>    <guid>https://juejin.cn/post/7597811700285046803</guid>    <pubDate>2026-01-22T07:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597811700285046803" data-draft-id="7597416716542738438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云全新发布的 UModel 是什么"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T07:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云全新发布的 UModel 是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:21:37.000Z" title="Thu Jan 22 2026 07:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：望宸</p>
<p>每个时代基础设施的变革，都始于对“混乱”的优雅重组。19 世纪，钢铁把不可控的垂直空间变成工程秩序，城市才得以向上生长；20 世纪，电网将分散的能源重新编排，工业生产才不再被河流左右。而如今的 IT 领域，我们正面临一场新的秩序重建，即如何让海量、碎片化、动态变化的观测数据，不再是噪音，而成为可理解、可推理、可优化智能体行为的燃料？</p>
<p>要回答这个问题，我们先简单回溯下：IT 系统的可观测体系是如何走到今天的？</p>
<h2 data-id="heading-0">IT 系统中可观测体系的发展</h2>
<p>最初，企业面向单一数据类型构建监控体系，CPU 使用率、内存占用、磁盘 I/O……一个个孤立的指标就像烽火台，只能通过局部视角告诉我们“什么地方出了问题”。</p>
<p>但随着微服务、容器技术的普及，系统复杂度呈指数级增长。企业开始意识到：单点指标无法解释全局。于是开始对孤立的数据进行抽象，抽象出 Metrics（指标）、Traces（链路追踪）和 Logs（日志），并进行关联分析：</p>
<ul>
<li><strong>Metrics：</strong> IT 系统是否有问题；</li>
<li><strong>Traces：</strong> 哪里出了问题；</li>
<li><strong>Logs：</strong> 问题是由什么原因导致的。</li>
</ul>
<p>发展至今，成为观测体系的三大数据支柱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b17b6451cb2f431395783715258557ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=pCTrLjQTh%2Beu5r%2BeIVF3DtYxhno%3D" alt="image.png" loading="lazy"/></p>
<p>但从海量、异构、动态变化的数据中准确推理并定位问题，本质上是一个极其困难的逆向工程。数据只是现象，而现象与本质之间往往存在巨大的认知鸿沟 <strong>[</strong> <strong>1]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/893d67e7c19545139b88757aba744801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=cM8D9mOYvYHTq5lIlBW0HpeOoXs%3D" alt="image.png" loading="lazy"/></p>
<p>Metrics、Traces 和 Logs 这看似完整的三角，实则仍停留在现象观测层面，是 L1 级智能体的典型工作流，人工设计流程节点、人工配置触发、人工调用 API，再把指标、链路、日志喂给 AI，期望它自己找出因果，结果往往是幻觉式归因：把时间上的巧合当作逻辑上的因果。为什么？因为在 AI 面前，缺少对系统本质的建模。</p>
<p>在 AI 时代，加剧了这种模式的挑战。一是 LLM 驱动的应用带来了上下文的碎片化。运维工程师每天要在不同的控制台之间切换，手动拼凑“发生了什么”。这就像在信息高速公路上骑自行车，工具很先进，但认知方式仍是人力驱动。二是相比由工程师写的代码定义的传统 IT 系统，AI 带来了更多的不确定性，指数级提升了原始数据自动化关联的难度，给准确推理并定位问题的挑战添了堵。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e35c5bb75964d25a76616becc6cd0e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=swiwORzMdH2sI3dJOEIsNdmFaVI%3D" alt="图片" loading="lazy"/></p>
<p>总结起来，原本的认知鸿沟，被进一步分化成三层新的鸿沟 <strong>[</strong> <strong>2]</strong> ：</p>
<ul>
<li><strong>数据鸿沟</strong>：原始数据混杂、碎片化、噪声多，99% 以上可能是无效信息，难以从中有效提取信号。</li>
<li><strong>模型鸿沟</strong>：AI 模型存在“黑盒”特性，推理过程难以解释；还可能出现“幻觉”，生成看似合理但不符合事实的结果。</li>
<li><strong>工程鸿沟</strong>：每天数 PB 级的数据采集、清洗、存储、计算，对性能、成本、安全性提出极高要求。</li>
</ul>
<h2 data-id="heading-1">数据到建模</h2>
<p>让一个没见过电路图的人，从一堆电压表读数中定位并恢复故障服务器，是不现实的。</p>
<p>当前市面上大多数的 AI 运维助手，本质上仍是 L1 级智能体：它们被封装在一个封闭的对话框里，被动响应用户提问，背后是一连串预设的 if-else 规则或简单 RAG 检索。它们没有对系统结构的内生理解，无法主动推理依赖路径，更谈不上安全执行修复操作。</p>
<p>而要迈向 L2 甚至 L3 级智能体，即能自主感知、规划、行动并持续学习的数字员工，就必须为其构建一个结构化的运行时上下文，不然只能靠人的经验来排查、定位和解决问题。这个上下文是经过建模、带有语义、支持查询与推理的图谱。有了这张图，智能体就能避免在数据海洋中盲目打捞，而是在一个有路标、有规则、有边界的城市中穿行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3437c1fa6a3e4f2ca4c8dc2b2d60a34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=QBhl9ui6XyAysJVPVegrYboIilM%3D" alt="图片" loading="lazy"/></p>
<p>因此，出路不在更多的数据，而在更好的建模。先为 IT 系统建立一张认知地图。这张图要包含实体（主机、服务、数据库）、关系（调用、依赖、部署）、行为（日志事件、性能指标）以及它们之间的语义约束。只有在这张图上，智能体才能像经验丰富的老运维一样，快速定位故障并恢复生产。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b938b4e04b343abacc4ec083838ab0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=OFuAaf8d1%2BzBNBh9zdn7%2FwO47II%3D" alt="图片" loading="lazy"/></p>
<p>UModel 正是这张图的建模语言。我们需要从“数据驱动”转向“建模驱动”，从面向现象的观测，转向面向本质的建模，构建一个统一的上下文图谱，这正是 UModel 的使命。</p>
<h2 data-id="heading-2">什么是 UModel</h2>
<p>UModel（Universal Observability Model）是基于图模型的可观测数据建模方法。</p>
<p>又是图模型，又是建模，一听就很学术。通俗易懂的讲，就是用“画图”的方式，把一堆随机事件之间的概率关系理清楚，让复杂变简单，让模糊变清晰。因此，UModel 旨在通过标准化的数据建模方式，实现可观测数据的统一表示、数据建模与具体存储的解耦，从而实现智能分析。有了 UModel，智能体才能像经验丰富的老运维那样快速定位故障并恢复生产，成为可能。UModel 可以看成是阿里云可观测体系的数据建模基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aad71df66934f5ca3eb1e34ffb3f3ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=tIZv1BZO5K7Fzsxj1oVXhbOKXHc%3D" alt="图片" loading="lazy"/></p>
<p>总的来讲，UModel 的核心思想，是为可观测领域打造一个认知操作系统，是一套标准化的数据建模方法，旨在弥合前文所述的三重鸿沟，为 AIOps 提供可解释、可扩展、可自动化的基础。</p>
<p>接下来，我们从 UModel 的构成和使用方式来看看它是如何把零散、杂乱的可观测数据，画成一张结构清晰、智能体能理解的图。</p>
<h2 data-id="heading-3">UModel 的构成和使用方式</h2>
<p>企业习惯于将系统中的每个组件，例如应用、容器、中间件、网关、数据库，视为独立的实体进行监控和管理，并为它们配置仪表盘，设置告警，追踪性能表现。传统的监控和查询工具，无论是基于 SQL 还是 SPL，其核心都是处理二维的、表格化的数据。它们擅长回答关于个体的问题（这个 Pod 的 CPU 使用率是多少？），但在回答关于关系的问题时却显得力不从心。</p>
<p>当面对“这个服务的故障会影响哪些下游业务？”或“要访问到核心数据库，需要经过哪些中间服务？”这类问题时，传统工具往往需要复杂的 JOIN 操作、多步查询，甚至需要工程师结合线下架构图进行人脑拼凑。这种方式不仅效率低下，而且在关系复杂、层级深的情况下几乎无法完成。我们拥有了所有“点”的数据，却失去了一张看清“线”的地图 <strong>[</strong> <strong>3]</strong> 。</p>
<p>因此，UModel 将要解决以下四个关键问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a51c2ed1d6ca45678cd908420d4f4367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671297&amp;x-signature=r77UTyjvqvLt9a5SQAXRsZB5hEw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">1. 重新定义系统里有什么</h3>
<p>通过 Entity 来统一定义所有可观测实体的实例，包括容器实例、服务实例等，例如服务实例 "order-service"、Pod 实例 "web-pod-001"。</p>
<h3 data-id="heading-5">2. 对实例进行建模</h3>
<p>通过 EntitySet 建立实体集，并进行实体建模。将系统组件抽象为 EntitySet，一个 EntitySet 可对应多个 Entity：</p>
<ul>
<li>基础设施实体：主机、容器、网络设备、存储系统；</li>
<li>应用层实体：微服务、API 接口、数据库实例、消息队列；</li>
<li>业务实体：用户会话、业务流程、交易订单；</li>
<li>运维实体：部署环境、代码仓库、运维人员。</li>
</ul>
<p>除了进行实体建模，还需要进行：</p>
<ul>
<li>数据集建模：将日志、指标、链路追踪、事件和性能剖析等多种可观测数据类型抽象为 TelemetryDataSet，由此衍生出 LogSet、TraceSet、EventSet、ProfileSet、MetricSet 等更具体的观测数据集。</li>
<li>存储建模：Storage 是 UModel 中数据集底层存储的抽象，定义了数据的实际存储位置和访问方式。通过存储建模，UModel 能够统一对接多种存储后端，为用户提供一致的数据访问体验。</li>
</ul>
<h3 data-id="heading-6">3. 对这些实体&amp;实体集进行建联</h3>
<p>通过 Link，连接不同的数据集：</p>
<ul>
<li>EntitySetLink 定义 EntitySet 实体间的关系（如服务 A 调用服务 B）；</li>
<li>DataLink 定义 EntitySet 与 DataSet 之间的关联（如某 Pod 产生哪些日志）；</li>
<li>StorageLink 定义 DataSet 与 Storage 之间的关联。</li>
</ul>
<p>在此基础之上，自动生成实体拓扑图和数据关系图。</p>
<h3 data-id="heading-7">4. 图查询</h3>
<p>图查询可以认为是发挥 UModel 这一可观测基建的关键能力。因为系统的真实形态本就是一张图，那么对它的查询和分析，也应该使用最符合其本质的方式——图查询。</p>
<p>为了实现这一点，我们在 UModel 体系的核心构建了 EntityStore。它采用了创新的双存储架构，同时维护了 <strong>entity</strong> 日志库（存储实体的详细属性）和 <strong>topo</strong> 日志库（存储实体间的拓扑关系）。这相当于我们为整个可观测系统建立了一个实时更新的、可查询的数字孪生图谱 <strong>[</strong> <strong>3]</strong> 。</p>
<p>基于这个图谱，我们提供了从易到难、层层递进的三种图查询能力，以满足不同用户的需求：</p>
<ul>
<li><strong>graph-match：</strong> 为最常见的路径查询场景设计，语法直观，让用户能像描述一句话一样（“A 经过 B 调用了 C”）来快速查找特定链路。</li>
<li><strong>graph-call：</strong> 封装了最高频的图算法（如邻居查找、直接关系查询），通过函数式接口提供，用户只需关心意图（“找 A 的 3 跳邻居”）而无需关心实现细节。</li>
<li><strong>Cypher：</strong> 引入业界标准的图查询语言，提供最完整、最强大的图查询能力，支持任意复杂的模式匹配、多级跳跃、聚合分析，是处理复杂图问题的终极武器。</li>
</ul>
<p>这一整套解决方案，旨在将强大的图分析能力，以一种低门槛、产品化的方式，让智能体实现自主发现、定位故障，并恢复生产成为可能。</p>
<p>过去，运维靠人脑串联孤立的数据和几十个工具；未来，UModel 希望能作为可观测的基础设施，支撑智能体在统一上下文图谱中工作。当可观测数据被建模为可理解、可行动的上下文图谱，AIOps 才真正拥有了落地的土壤。</p>
<p><strong>相关阅读：</strong></p>
<p>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247579545%26idx%3D1%26sn%3D845cb6c9355bafc8c9a881630da39708%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247579545&amp;idx=1&amp;sn=845cb6c9355bafc8c9a881630da39708&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">UModel 数据治理：运维世界模型构建实践</a></p>
<p>[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578672%26idx%3D1%26sn%3Da5894d77679325b085e257b1143f4bfc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578672&amp;idx=1&amp;sn=a5894d77679325b085e257b1143f4bfc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从数据孤岛到智能洞察：构建面向未来的 Operation intelligence 体系</a></p>
<p>[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%26poc_token%3DHGVkU2mjaKV6ygT0xmMCONiBeKHwd41RJYmAPE9R%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21&amp;poc_token=HGVkU2mjaKV6ygT0xmMCONiBeKHwd41RJYmAPE9R#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[32岁程序员猝死背后，我的一些真实感受]]></title>    <link>https://juejin.cn/post/7597701762905309230</link>    <guid>https://juejin.cn/post/7597701762905309230</guid>    <pubDate>2026-01-22T07:26:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597701762905309230" data-draft-id="7597979278239678473" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="32岁程序员猝死背后，我的一些真实感受"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-22T07:26:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员海军"/> <meta itemprop="url" content="https://juejin.cn/user/1239904848713592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            32岁程序员猝死背后，我的一些真实感受
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904848713592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员海军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:26:07.000Z" title="Thu Jan 22 2026 07:26:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1450bbc83d21468da50e2a889a749217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5rW35Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671566&amp;x-signature=uToef0g0jyRv0FJ0UAJZzLIue6I%3D" alt="image.png" loading="lazy"/></p>
<p>上午刷到32岁程序员周末猝死这条消息，其实我并不陌生。</p>
<p>这几年，程序员猝死、倒下、出事的新闻隔一段时间就会出现一次，圈子里的人早就麻木了。刷到的时候，最多叹口气，继续干活，很少真的往心里去。</p>
<p>看到他长期加班的细节时，我突然愣住了，因为太像了。</p>
<p>我也经常这样。</p>
<p>下午刷到他的妻子和对他的聊天记录，真的感觉很无奈，可惜，他再也回不来了......</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a978d30f94e14cae96745e6ee37ea604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5rW35Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671566&amp;x-signature=0fNCN4v8uGCJ%2BK48rF%2FG0n2yM3s%3D" alt="3d6157aefc573f83b1eef95b33b3559d.png" loading="lazy"/></p>
<hr/>
<p>我到不是加班，我是下班后干自己的事情，我比较卷。只有下班后的时间是真正属于自己的时间才刚开始。没有人打扰，安静下来，我会干自己的事情、学习、写代码，一不留神就到了凌晨两点。</p>
<p>那一刻，我才真正能进入自己的状态。</p>
<p>学习也好，干活也好，哪怕只是安静地敲键盘，都让我觉得踏实。</p>
<p>于是，凌晨两点成了常态</p>
<p>通过他这件事，我看到我也在里面，看见了自己。</p>
<hr/>
<p>我上一次写代码写到很晚是前几周，老大让我开发一个知识库RAG系统。</p>
<p>给我了我一周的时间，其实对于我是有难度的，因为接触这块不久，一周时间的话肯定弄不好。</p>
<p>后来那天，我连夜和AI 一些协作搞了6个小时左右，搞到了凌晨3点多，初版搞的差不多，那会心率也有点高了， 有点难受，就赶快休息了...</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/debf12ecd7de43e688a066277f667c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5rW35Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671566&amp;x-signature=gk%2FGwG07UEtn8sHrNBS4te35FQw%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p><strong>我们这一代程序员，真的太累了。</strong></p>
<p>这种累，不只是加班，而是<strong>一种长期被推着往前，却不敢停下来的状态</strong>。</p>
<p>房贷在那儿。<br/>
家庭在那儿。<br/>
<strong>未来的不确定性在那儿</strong>。</p>
<p>我们很清楚，一旦慢下来，就意味着风险。</p>
<p>于是我们学会了忍。<br/>
忍困、忍累、忍身体发出的各种提醒。</p>
<hr/>
<p>程序员这个职业有个很危险的地方。</p>
<p>身体开始出问题的时候，<strong>能力往往还在线</strong>。</p>
<p>我们还能写代码，还能解决问题，还能在群里回一句：“好的，我看看”</p>
<p>所以你会误以为自己没事。</p>
<p>可身体不是系统，没有明显的报错提示。<br/>
等它真正崩的时候，往往没有给你回滚的机会。</p>
<p>今天刷到这个新闻消息对我来说，更像是一次提醒。我现在体检去，估计都是全红状态，我经常熬夜，现在锻炼的也少了....</p>
<p>我们这一代人，很努力。</p>
<p>努力工作，努力赚钱，努力让生活往前走。</p>
<p>可如果连身体都开始透支，那这条路，真的值得重新想一想。</p>
<p>不是他倒下了。<br/>
是我们这一代，真的太累了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[非Transformer架构的新突破，液态神经网络的推理小模型只用900M内存]]></title>    <link>https://juejin.cn/post/7597742970281656372</link>    <guid>https://juejin.cn/post/7597742970281656372</guid>    <pubDate>2026-01-22T07:27:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281656372" data-draft-id="7597724783649701928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="非Transformer架构的新突破，液态神经网络的推理小模型只用900M内存"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-22T07:27:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            非Transformer架构的新突破，液态神经网络的推理小模型只用900M内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:27:56.000Z" title="Thu Jan 22 2026 07:27:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>谷歌 2017 年提出的 Transformer 架构事实上已经基本垄断了大模型。</p>
<p>不采用 Transformer 架构的大模型已经是少之又少，而采用非 Transformer 架构，还能与主流第一梯队大模型扳手腕的，更是凤毛麟角。</p>
<p>不知道大家是否还有印象，当年有一个尝试<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650936710%26idx%3D1%26sn%3Ddbbd17956166684cee4eb73e75e41111%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650936710&amp;idx=1&amp;sn=dbbd17956166684cee4eb73e75e41111&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">给大模型装上「虫脑」</a>的初创公司，他们的研究人员受到秀丽隐杆线虫的神经结构启发，研发出一种新型的灵活神经网络，也被称为液态神经网络。</p>
<p>这是一个连续时间模型，由多个简单的动态系统组成，这些系统通过非线性门相互调节。这种网络的特点是时间常数可变，输出通过求解微分方程得到。它在稳定性、表达能力和时间序列预测方面都优于传统模型。</p>
<p>除此以外，液态神经网络的另一个特点是规模小得多，在 2024 年该架构就实现了 1.3B 大小的模型部署，但彼时尚未能与主流大模型一拼高下。</p>
<p>提出液态神经网络架构，并且做出 Liquid Foundation Models（LFM）大模型的，是由 MIT 计算机科学和人工智能实验室 CSAIL 孵化，成立于 2023 年 3 月的初创公司 Liquid AI。</p>
<p>就在刚刚，Liquid AI 又一次在 LFM 模型上放大招。他们正式发布并开源了 LFM2.5-1.2B-Thinking，一款可完全在端侧运行的推理模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/548bad4409904e98b0d1a8705a05627e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=wSZBumcfQqiFQ9A00ZXQqf6T6d0%3D" alt="图片" loading="lazy"/></p>
<p>Liquid AI 声称，该模型专门为简洁推理而训练；在生成最终答案前，会先生成内部思考轨迹；在端侧级别的低延迟条件下，实现系统化的问题求解；在工具使用、数学推理和指令遵循方面表现尤为出色。</p>
<p>该模型在手机上仅需 900 MB 内存 即可运行，同时在同等规模模型中实现了最快的推理速度和最佳的质量表现。两年前还必须依赖数据中心才能完成的能力，如今已经可以在你的口袋里离线运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9ecba1d5a6426fa924128af26535e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=xGph7kU4TLBFhLJh%2BXW6OaPsRaE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>Leap 开源链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleap.liquid.ai%2Fmodels" target="_blank" title="https://leap.liquid.ai/models" ref="nofollow noopener noreferrer">leap.liquid.ai/models</a></p>
</li>
<li>
<p>HuggingFace 链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FLiquidAI%2FLFM2.5-1.2B-Thinking" target="_blank" title="https://huggingface.co/LiquidAI/LFM2.5-1.2B-Thinking" ref="nofollow noopener noreferrer">huggingface.co/LiquidAI/LF…</a></p>
</li>
</ul>
<p>优于 Transformer 的性能</p>
<p>与 Liquid AI 之前的模型 LFM2.5-1.2B-Instruct 相比，LFM2.5-1.2B-Thinking 在三项能力上实现了显著提升：</p>
<ul>
<li>
<p>数学推理：在 MATH-500 上从 63 提升至 88</p>
</li>
<li>
<p>指令遵循：在 Multi-IF 上从 61 提升至 69</p>
</li>
<li>
<p>工具使用：在 BFCLv3 上从 49 提升至 57</p>
</li>
</ul>
<p>在大多数推理基准测试中，LFM2.5-1.2B-Thinking 的表现已与甚至超过 Qwen3-1.7B，尽管其参数量少了 约 40%。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07cefd9bd2594583a7ef5d1a88d41166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=ZU76Jy7rGs%2FlWPMZ2LZVB4IMpYk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd381f482f2f4b5ebde6bb169aae6ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=SpXG4uroOC8c8cbGRKoKE7DcYuA%3D" alt="图片" loading="lazy"/></p>
<p>同时，该模型在质量与测试时计算效率之间取得了良好平衡：与 Qwen3-1.7B（思考模式） 相比，它在使用更少输出 token 的情况下，依然提供了更高的整体性能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d705f5157034a719eb4afe8076ef2bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=AvPUxz772Gj8oLLZvi0b1dHCQFU%3D" alt="图片" loading="lazy"/></p>
<p>在推理阶段，这一性能差距进一步拉大：LFM2.5-1.2B-Thinking 在推理速度和内存效率两方面，都优于纯 Transformer 模型（如 Qwen3-1.7B）和混合架构模型（如 Granite-4.0-H-1B）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f22dbcff1e9d4b3684bd933763935807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=K%2FxlC%2FcVfvqFHOta%2FoO6IPkJci0%3D" alt="图片" loading="lazy"/></p>
<p>Liquid AI 表示，LFM2.5-1.2B-Thinking 在 智能体式（agentic）任务和高推理强度任务（例如工具使用、数学、编程）中表现尤为突出。当模型需要规划一系列工具调用、验证中间结果并动态调整解题策略时，其生成的推理轨迹能够发挥实际价值。而在对话交互和创意写作等场景下，则更推荐使用 LFM2.5-1.2B-Instruct。</p>
<p>训练细节</p>
<p>要构建能力强的小型推理模型，关键在于：在知识容量有限的前提下，通过多步推理来弥补能力，同时又要保持答案简洁，以满足端侧低延迟部署的需求。</p>
<p>此前在 LFM-1B-Math 上的实验表明，在中期训练阶段引入推理轨迹，有助于模型内化「先推理，再作答」的模式。随后，基于合成推理轨迹进行的监督微调（SFT），进一步让模型能够稳定地产生思维链，而无需依赖特定格式的奖励设计。</p>
<p>然而，SFT 并不能解决推理模型中的一个常见问题：模型可能陷入重复文本模式，迟迟无法得出结论。这种行为通常被称为 「doom looping」（死循环式生成）。为此，Liquid AI 采用了一种相对直接的缓解方法：</p>
<ul>
<li>
<p>在偏好对齐阶段，基于 SFT 模型生成了 5 个温度采样候选和 1 个贪婪解码候选；当不存在循环时，选择由 LLM 评判得分最高的作为正样本、得分最低的作为负样本；一旦出现循环生成，则无论评判得分如何，直接将出现循环的候选作为负样本。</p>
</li>
<li>
<p>在 RLVR 阶段，进一步在训练早期引入了基于 n-gram 的重复惩罚，以抑制循环生成行为。</p>
</li>
</ul>
<p>通过这些策略，模型在保持推理能力的同时，显著降低了陷入无效循环的风险。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfba3b285714edc9709014cf1e560c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=vlNlKl%2BmnNehnQ7eT%2B%2FZrNzRhPQ%3D" alt="图片" loading="lazy"/></p>
<p>这一方法在一个具有代表性提示词的数据集上，将死循环生成的比例从 15.74%（中期训练阶段） 显著降低到了 0.36%（RLVR 阶段），效果非常直接且稳定。</p>
<p>Liquid AI 的 RL 训练流水线核心采用的是无 critic、类 GRPO 方法。整体实现是 reference-free 的，并结合了多项训练技巧，包括：</p>
<ul>
<li>
<p>非对称比例裁剪（asymmetric ratio clipping）</p>
</li>
<li>
<p>对零方差提示组的动态过滤</p>
</li>
<li>
<p>超长样本掩码（overlong-sample masking）</p>
</li>
<li>
<p>不进行优势归一化（no advantage normalization）</p>
</li>
<li>
<p>截断的重要性采样（truncated importance sampling）</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/718d2fa5eb9d4d12a37b9b9dac880b27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=fTJcVd7oRWjEy7zSnOzyDXNqLJ4%3D" alt="图片" loading="lazy"/></p>
<p>RL 方法的简化示意图：最终发布的 checkpoint 是一个合并模型，其「家族树」中包含 25 个不同的子 checkpoint。</p>
<p>Liquid AI 采用了一种高度并行的 Curriculum RL 训练框架，先以指令跟随的 RLVR 作为基础起点，再分叉出面向推理、数学、工具使用等不同领域的专项 checkpoint。</p>
<p>这种并行结构不同于传统的「单模型、多任务同时训练」方式，往往会引发能力相互干扰。</p>
<p>Curriculum RL 提供了更精细的控制粒度：每个领域的模型都可以独立优化，拥有各自的奖励设计、超参数和评估标准。随后，我们在不同阶段进行迭代式模型合并，生成在多种能力之间更均衡的新 checkpoint。</p>
<p>实践表明，模型合并在保留整体性能的同时，能够有效吸收专项能力提升，是一条可行且可扩展的通用 RLVR 训练路径。</p>
<p>此外，Liquid AI 正在全力拓展 LFM 系列模型的生态系统和合作伙伴。</p>
<p>LFM2.5-1.2B-Thinking 实现了开箱即用支持，兼容最流行的推理框架，包括 llama.cpp、MLX、vLLM 和 ONNX Runtime。所有框架均支持 CPU 和 GPU 加速，覆盖 Apple、AMD、Qualcomm 和 Nvidia 等硬件。</p>
<p>为了确保 LFM2.5 系列 能够在各种场景下高效运行，Liquid AI 正在快速扩展软硬件生态系统，并欢迎 Qualcomm Technologies, Inc.、Ollama、FastFlowLM 和 Cactus Compute 作为新的合作伙伴加入。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e36ed20f86b45ce92d2ec4d425e60b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671676&amp;x-signature=tn6j4WIsT%2FwWk2EF%2Fjc2%2FpXncCM%3D" alt="图片" loading="lazy"/></p>
<p>LFM2.5-1.2B-Thinking 在不同硬件设备上的长上下文推理表现。</p>
<p>LFM2.5-1.2B-Thinking 可能只是个起点，但它已经证明了一件事 ——Transformer 并非唯一解，小而强的端侧推理模型或许有更优解。</p>
<p>更重要的是，运行推理模型的门槛越来越低，让更多设备激发 AI 潜能，不论如何，都是一件美事。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.liquid.ai%2Fblog%2Flfm2-5-1-2b-thinking-on-device-reasoning-under-1gb%23training-recipe" target="_blank" title="https://www.liquid.ai/blog/lfm2-5-1-2b-thinking-on-device-reasoning-under-1gb#training-recipe" ref="nofollow noopener noreferrer">www.liquid.ai/blog/lfm2-5…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依前端vue 项目 build 文件夹内容详解]]></title>    <link>https://juejin.cn/post/7597742970281541684</link>    <guid>https://juejin.cn/post/7597742970281541684</guid>    <pubDate>2026-01-22T07:21:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281541684" data-draft-id="7597724783649669160" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依前端vue 项目  build 文件夹内容详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:21:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一写代码就开心"/> <meta itemprop="url" content="https://juejin.cn/user/2889993082908344"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依前端vue 项目  build 文件夹内容详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2889993082908344/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一写代码就开心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:21:45.000Z" title="Thu Jan 22 2026 07:21:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 build</h2>
<p>B站有完整的前端后端源码解析视频课程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04cd8458129a4ad2a8477999990f751e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5YaZ5Luj56CB5bCx5byA5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671305&amp;x-signature=qef%2B4Elmrs%2FXleRb88gm%2FZNdjZQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="" alt="" loading="lazy"/></p>
<p>你完全可以不使用这个 <code>build/index.js</code> 脚本，直接用 Vue CLI 自带的 <code>npm run build</code> 命令进行打包，两者的<strong>核心打包逻辑完全一致</strong>，最终生成的 <code>dist</code> 目录内容也完全相同。</p>
<h4 data-id="heading-1">为什么可以不使用这个脚本？</h4>
<p>因为这个 <code>build/index.js</code> 本质上是对 Vue CLI 原生打包命令的「<strong>封装和扩展</strong>」，而非“必须依赖的打包工具”：</p>
<ul>
<li>脚本中最核心的打包逻辑是 <code>run('vue-cli-service build')</code>，这和 <code>npm run build</code> 底层执行的命令完全一样（Vue CLI 项目中，<code>package.json</code> 的 <code>build</code> 脚本默认就是 <code>"vue-cli-service build"</code>）；</li>
<li>它的额外功能（如 <code>--preview</code> 预览、<code>--report</code> 生成报告）只是“锦上添花”，而非打包的必要步骤。</li>
</ul>
<h4 data-id="heading-2">两种打包方式的对比（选哪种都可以）</h4>























<table><thead><tr><th>打包方式</th><th>命令</th><th>效果</th><th>适用场景</th></tr></thead><tbody><tr><td>原生方式</td><td><code>npm run build</code></td><td>仅执行打包，生成 <code>dist</code> 目录</td><td>只需要打包结果，不需要预览</td></tr><tr><td>脚本方式</td><td><code>node build/index.js</code> 或 <code>node build/index.js --preview</code></td><td>执行打包 + 可选预览/生成报告</td><td>需要打包后快速预览，或分析打包体积</td></tr></tbody></table>
<h4 data-id="heading-3">总结</h4>
<ul>
<li><strong>完全可以不用</strong>：直接用 <code>npm run build</code> 就能完成打包，这是 Vue CLI 推荐的标准方式，简单直接；</li>
<li><strong>脚本是可选工具</strong>：它的存在只是为了提供“打包+预览”的一站式体验，如果你不需要这个功能，忽略它即可，对项目没有任何影响。</li>
</ul>
<p>选择哪种方式，完全取决于你的开发习惯——想用原生命令就用 <code>npm run build</code>，想方便预览就用脚本，两者最终的打包结果完全一致。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 导入runjs工具的run函数，用于执行终端命令</span>
<span class="hljs-keyword">const</span> { run } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'runjs'</span>)
<span class="hljs-comment">// 导入chalk工具，用于在终端输出带颜色的文字</span>
<span class="hljs-keyword">const</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>)
<span class="hljs-comment">// 导入vue项目的配置文件，用于获取项目的基础路径配置</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../vue.config.js'</span>)
<span class="hljs-comment">// 获取命令行参数（去掉前两个默认参数：node和当前文件路径）</span>
<span class="hljs-keyword">const</span> rawArgv = process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)
<span class="hljs-comment">// 将命令行参数拼接成字符串，方便后续传递给打包命令</span>
<span class="hljs-keyword">const</span> args = rawArgv.<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>)
​
<span class="hljs-comment">// 判断是否需要执行"打包并预览"功能：</span>
<span class="hljs-comment">// 1. 检查是否有npm_config_preview环境变量（通过npm run命令传递）</span>
<span class="hljs-comment">// 2. 检查命令行参数中是否包含--preview</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">npm_config_preview</span> || rawArgv.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'--preview'</span>)) {
  <span class="hljs-comment">// 检查是否需要生成构建分析报告（命令行参数包含--report时）</span>
  <span class="hljs-keyword">const</span> report = rawArgv.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'--report'</span>)
​
  <span class="hljs-comment">// 执行Vue CLI的打包命令，同时传递所有命令行参数</span>
  <span class="hljs-comment">// 等价于在终端执行vue-cli-service build [参数]</span>
  <span class="hljs-title function_">run</span>(<span class="hljs-string">`vue-cli-service build <span class="hljs-subst">${args}</span>`</span>)
​
  <span class="hljs-comment">// 预览服务器的端口号（固定为9526）</span>
  <span class="hljs-keyword">const</span> port = <span class="hljs-number">9526</span>
  <span class="hljs-comment">// 从vue配置中获取项目的公共路径（publicPath），用于正确拼接预览地址</span>
  <span class="hljs-keyword">const</span> publicPath = config.<span class="hljs-property">publicPath</span>
​
  <span class="hljs-comment">// 导入connect框架，用于创建本地服务器</span>
  <span class="hljs-keyword">var</span> connect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect'</span>)
  <span class="hljs-comment">// 导入serve-static中间件，用于托管静态文件</span>
  <span class="hljs-keyword">var</span> serveStatic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-static'</span>)
  <span class="hljs-comment">// 创建connect服务器实例</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">connect</span>()
​
  <span class="hljs-comment">// 配置服务器：</span>
  <span class="hljs-comment">// 1. 以vue配置的publicPath为基础路径</span>
  <span class="hljs-comment">// 2. 托管当前目录下的dist文件夹（打包后的静态文件）</span>
  <span class="hljs-comment">// 3. 设置默认首页为index.html</span>
  app.<span class="hljs-title function_">use</span>(
    publicPath,
    <span class="hljs-title function_">serveStatic</span>(<span class="hljs-string">'./dist'</span>, {
      <span class="hljs-attr">index</span>: [<span class="hljs-string">'index.html'</span>, <span class="hljs-string">'/'</span>]
    })
  )
​
  <span class="hljs-comment">// 启动服务器，监听指定端口</span>
  app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// 在终端输出绿色的预览地址，方便开发者直接访问</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">`&gt; Preview at  http://localhost:<span class="hljs-subst">${port}</span><span class="hljs-subst">${publicPath}</span>`</span>))
    <span class="hljs-comment">// 如果需要生成报告，额外输出报告的访问地址</span>
    <span class="hljs-keyword">if</span> (report) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">`&gt; Report at  http://localhost:<span class="hljs-subst">${port}</span><span class="hljs-subst">${publicPath}</span>report.html`</span>))
    }
  })
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 如果不需要预览，仅执行打包命令（与npm run build效果相同）</span>
  <span class="hljs-title function_">run</span>(<span class="hljs-string">`vue-cli-service build <span class="hljs-subst">${args}</span>`</span>)
}
​
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依前端vue 项目 里面dragWidth.js 文件详解]]></title>    <link>https://juejin.cn/post/7597742970281492532</link>    <guid>https://juejin.cn/post/7597742970281492532</guid>    <pubDate>2026-01-22T07:19:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281492532" data-draft-id="7597779410406375458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依前端vue 项目  里面dragWidth.js 文件详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:19:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一写代码就开心"/> <meta itemprop="url" content="https://juejin.cn/user/2889993082908344"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依前端vue 项目  里面dragWidth.js 文件详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2889993082908344/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一写代码就开心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:19:40.000Z" title="Thu Jan 22 2026 07:19:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是基于该指令核心逻辑扩展的3个实用案例，覆盖不同场景，附带完整代码和使用说明：</p>
<p>完整笔记直接主页联系，或者B站有完整视频</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdfe71caecb45fa858fe0f7b05e62ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5YaZ5Luj56CB5bCx5byA5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671180&amp;x-signature=MloYm5nM1IrpqXeETa85g0avqLQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0"><strong>案例1：左右分栏联动调整（适用于编辑器、后台布局）</strong></h3>
<p><strong>场景</strong>：在左右分栏布局中（如左侧菜单+右侧内容、编辑区+预览区），拖拽中间手柄同时调整两侧宽度，保持总宽度不变。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70b2d8c6dee142d381467f81e7697a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5YaZ5Luj56CB5bCx5byA5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671180&amp;x-signature=4G%2Be9xb9ZSJKxrcOL15HQ1CM1a0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-1">指令代码（<code>directive/columnResize.js</code>）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad119726adf4efeb7261b343fa4547e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5YaZ5Luj56CB5bCx5byA5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671180&amp;x-signature=t5fyVK8V60BhU%2FejiL7sqeIiqwY%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">
export default {
  bind(el) {
    // 查找左右分栏元素（需在模板中定义对应类名）
    const <span class="hljs-attr">leftDom</span> = el.querySelector(<span class="hljs-string">'.left-column'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">rightDom</span> = el.querySelector(<span class="hljs-string">'.right-column'</span>)<span class="hljs-comment">;</span>
    if (!leftDom || !rightDom) {
      console.error('未找到左右分栏元素，请添加 .left-column 和 .right-column 类名')<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }
​
    // 获取父容器总宽度（左右分栏总宽 = 父容器宽）
    const <span class="hljs-attr">parentWidth</span> = el.<span class="hljs-literal">off</span>setWidth<span class="hljs-comment">;</span>
​
    // 创建中间拖拽手柄
    const <span class="hljs-attr">lineEl</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">lineEl.style</span> = `
      width: 5px<span class="hljs-comment">; </span>
      height: 100%<span class="hljs-comment">; </span>
      background: <span class="hljs-comment">#e0e0e0; </span>
      position: absolute<span class="hljs-comment">; </span>
      left: ${leftDom.offsetWidth}px<span class="hljs-comment">; /* 初始位置在左栏右侧 */</span>
      top: 0<span class="hljs-comment">; </span>
      z-index: 10<span class="hljs-comment">; </span>
      cursor: col-resize<span class="hljs-comment">; /* 水平调整光标 */</span>
      transition: background 0.2s<span class="hljs-comment">;</span>
    `<span class="hljs-comment">;</span>
    // 鼠标悬停时高亮手柄
    <span class="hljs-attr">lineEl.onmouseover</span> = () =&gt; lineEl.style.background = <span class="hljs-string">'#ccc'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">lineEl.onmouseout</span> = () =&gt; lineEl.style.background = <span class="hljs-string">'#e0e0e0'</span><span class="hljs-comment">;</span>
​
    // 绑定鼠标按下事件
    lineEl.addEventListener('mousedown', (e) =&gt; {
      e.preventDefault()<span class="hljs-comment">;</span>
      // 记录鼠标按下时的X坐标和左栏宽度
      const <span class="hljs-attr">startX</span> = e.clientX<span class="hljs-comment">;</span>
      const <span class="hljs-attr">startLeftWidth</span> = leftDom.<span class="hljs-literal">off</span>setWidth<span class="hljs-comment">;</span>
​
      // 鼠标移动时调整宽度
      const <span class="hljs-attr">handleMouseMove</span> = (e) =&gt; {
        e.preventDefault()<span class="hljs-comment">;</span>
        // 计算左栏宽度变化量（限制最小宽度为200px，最大为父容器的80%）
        const <span class="hljs-attr">deltaX</span> = e.clientX - startX<span class="hljs-comment">;</span>
        const <span class="hljs-attr">newLeftWidth</span> = Math.max(<span class="hljs-number">200</span>, Math.min(parentWidth * <span class="hljs-number">0.8</span>, startLeftWidth + deltaX))<span class="hljs-comment">;</span>
        const <span class="hljs-attr">newRightWidth</span> = parentWidth - newLeftWidth<span class="hljs-comment">;</span>
​
        // 更新左右分栏宽度和手柄位置
        <span class="hljs-attr">leftDom.style.width</span> = `<span class="hljs-variable">${newLeftWidth}</span>px`<span class="hljs-comment">;</span>
        <span class="hljs-attr">rightDom.style.width</span> = `<span class="hljs-variable">${newRightWidth}</span>px`<span class="hljs-comment">;</span>
        <span class="hljs-attr">lineEl.style.left</span> = `<span class="hljs-variable">${newLeftWidth}</span>px`<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 鼠标松开时移除事件
      const <span class="hljs-attr">handleMouseUp</span> = () =&gt; {
        document.removeEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
        document.removeEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 绑定全局事件（确保拖拽不中断）
      document.addEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
      document.addEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
    }, false)<span class="hljs-comment">;</span>
​
    // 将手柄添加到父容器
    el.appendChild(lineEl)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-2">使用示例（<code>ColumnDemo.vue</code>）</h4>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 父容器：相对定位，包含左右分栏 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"column-container"</span> <span class="hljs-attr">v-columnResize</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 左分栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left-column"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>左侧菜单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拖拽中间手柄可调整宽度<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 右分栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right-column"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>右侧内容区<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>总宽度固定，左侧变宽时右侧自动变窄<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.column-container</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1000px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
}
<span class="hljs-selector-class">.left-column</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>; <span class="hljs-comment">/* 初始宽度 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
<span class="hljs-selector-class">.right-column</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">700px</span>; <span class="hljs-comment">/* 初始宽度 = 总宽 - 左栏宽 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> columnResize <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directive/columnResize.js'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">directives</span>: {
    columnResize <span class="hljs-comment">// 局部注册指令</span>
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>效果</strong>：拖拽中间灰色手柄，左侧宽度增加时右侧自动减少，且两侧宽度不会小于200px或超过总宽的80%。</p>
<h3 data-id="heading-3"><strong>案例2：表格容器高度调整（解决表格内容过多问题）</strong></h3>
<p><strong>场景</strong>：表格数据过多时，用户可拖拽表格底部手柄调整容器高度，避免频繁滚动。</p>
<h4 data-id="heading-4">指令代码（<code>directive/tableHeightResize.js</code>）</h4>
<pre><code class="hljs language-ini" lang="ini">
export default {
  bind(el) {
    // 查找表格容器（需在模板中定义 .table-container 类名）
    const <span class="hljs-attr">tableContainer</span> = el.querySelector(<span class="hljs-string">'.table-container'</span>)<span class="hljs-comment">;</span>
    if (!tableContainer) {
      console.error('未找到表格容器，请添加 .table-container 类名')<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }
​
    // 创建底部拖拽手柄
    const <span class="hljs-attr">lineEl</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">lineEl.style</span> = `
      height: 5px<span class="hljs-comment">; </span>
      width: 100%<span class="hljs-comment">; </span>
      background: <span class="hljs-comment">#f0f0f0; </span>
      position: absolute<span class="hljs-comment">; </span>
      bottom: 0<span class="hljs-comment">; </span>
      left: 0<span class="hljs-comment">; </span>
      cursor: s-resize<span class="hljs-comment">; /* 垂直调整光标 */</span>
    `<span class="hljs-comment">;</span>
    // 鼠标悬停时显示深色提示
    <span class="hljs-attr">lineEl.onmouseover</span> = () =&gt; lineEl.style.background = <span class="hljs-string">'#e0e0e0'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">lineEl.onmouseout</span> = () =&gt; lineEl.style.background = <span class="hljs-string">'#f0f0f0'</span><span class="hljs-comment">;</span>
​
    // 绑定鼠标按下事件
    lineEl.addEventListener('mousedown', (e) =&gt; {
      e.preventDefault()<span class="hljs-comment">;</span>
      // 记录鼠标按下时的Y坐标和容器当前高度
      const <span class="hljs-attr">startY</span> = e.clientY<span class="hljs-comment">;</span>
      const <span class="hljs-attr">startHeight</span> = tableContainer.<span class="hljs-literal">off</span>setHeight<span class="hljs-comment">;</span>
​
      // 鼠标移动时调整高度
      const <span class="hljs-attr">handleMouseMove</span> = (e) =&gt; {
        e.preventDefault()<span class="hljs-comment">;</span>
        // 计算高度变化量（限制最小高度300px，最大800px）
        const <span class="hljs-attr">deltaY</span> = e.clientY - startY<span class="hljs-comment">;</span>
        const <span class="hljs-attr">newHeight</span> = Math.max(<span class="hljs-number">300</span>, Math.min(<span class="hljs-number">800</span>, startHeight + deltaY))<span class="hljs-comment">;</span>
        <span class="hljs-attr">tableContainer.style.height</span> = `<span class="hljs-variable">${newHeight}</span>px`<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 鼠标松开时移除事件
      const <span class="hljs-attr">handleMouseUp</span> = () =&gt; {
        document.removeEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
        document.removeEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 绑定全局事件
      document.addEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
      document.addEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
    }, false)<span class="hljs-comment">;</span>
​
    // 将手柄添加到表格容器（容器需设为相对定位）
    tableContainer.appendChild(lineEl)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">使用示例（<code>TableDemo.vue</code>）</h4>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>可调整高度的表格<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 表格容器：相对定位，溢出时显示滚动条 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-container"</span> <span class="hljs-attr">v-tableHeightResize</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">border</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">cellpadding</span>=<span class="hljs-string">"10"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>ID<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>名称<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>状态<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 模拟100行数据 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"i in 100"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"i"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ i }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据项 {{ i }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>正常<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.table-page</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto;
}
<span class="hljs-selector-class">.table-container</span> {
  <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 确保手柄绝对定位生效 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>; <span class="hljs-comment">/* 初始高度 */</span>
  <span class="hljs-attribute">overflow</span>: auto; <span class="hljs-comment">/* 内容超出时显示滚动条 */</span>
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> tableHeightResize <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directive/tableHeightResize.js'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">directives</span>: {
    tableHeightResize
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>效果</strong>：拖拽表格底部灰色手柄，可上下调整容器高度（300px~800px），内容超出时自动显示滚动条。</p>
<h3 data-id="heading-6"><strong>案例3：图片透明度调整（可视化交互）</strong></h3>
<p><strong>场景</strong>：图片预览页面中，用户可通过拖拽滑块直观调整图片透明度。</p>
<h4 data-id="heading-7">指令代码（<code>directive/imgOpacityResize.js</code>）</h4>
<pre><code class="hljs language-ini" lang="ini">
export default {
  bind(el) {
    // 查找图片和控制区（需在模板中定义对应类名）
    const <span class="hljs-attr">imgDom</span> = el.querySelector(<span class="hljs-string">'.target-img'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">controlDom</span> = el.querySelector(<span class="hljs-string">'.opacity-controls'</span>)<span class="hljs-comment">;</span>
    if (!imgDom || !controlDom) {
      console.error('未找到图片或控制区，请添加 .target-img 和 .opacity-controls 类名')<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }
​
    // 创建透明度滑块容器
    const <span class="hljs-attr">sliderContainer</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">sliderContainer.style</span> = `
      width: 200px<span class="hljs-comment">; </span>
      height: 6px<span class="hljs-comment">; </span>
      background: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1))<span class="hljs-comment">; </span>
      margin: 10px 0<span class="hljs-comment">; </span>
      position: relative<span class="hljs-comment">;</span>
      border-radius: 3px<span class="hljs-comment">;</span>
    `<span class="hljs-comment">;</span>
​
    // 创建滑块按钮
    const <span class="hljs-attr">sliderBtn</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">sliderBtn.style</span> = `
      width: 16px<span class="hljs-comment">; </span>
      height: 16px<span class="hljs-comment">; </span>
      background: <span class="hljs-comment">#409eff; </span>
      border-radius: 50%<span class="hljs-comment">; </span>
      position: absolute<span class="hljs-comment">; </span>
      top: 50%<span class="hljs-comment">; </span>
      left: 50%<span class="hljs-comment">; /* 初始在中间（透明度0.5） */</span>
      transform: translate(-50%, -50%)<span class="hljs-comment">; </span>
      box-shadow: 0 0 3px rgba(0,0,0,0.3)<span class="hljs-comment">;</span>
      cursor: pointer<span class="hljs-comment">;</span>
    `<span class="hljs-comment">;</span>
    sliderContainer.appendChild(sliderBtn)<span class="hljs-comment">;</span>
​
    // 显示当前透明度值
    const <span class="hljs-attr">valueText</span> = document.createElement(<span class="hljs-string">'span'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">valueText.style</span> = <span class="hljs-string">'margin-left: 10px; color: #666;'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">valueText.textContent</span> = <span class="hljs-string">'透明度：50%'</span><span class="hljs-comment">;</span>
​
    // 组合控制区
    controlDom.appendChild(sliderContainer)<span class="hljs-comment">;</span>
    controlDom.appendChild(valueText)<span class="hljs-comment">;</span>
​
    // 绑定鼠标按下事件
    sliderBtn.addEventListener('mousedown', (e) =&gt; {
      e.preventDefault()<span class="hljs-comment">;</span>
      const <span class="hljs-attr">sliderWidth</span> = sliderContainer.<span class="hljs-literal">off</span>setWidth<span class="hljs-comment">;</span>
      const <span class="hljs-attr">btnWidth</span> = sliderBtn.<span class="hljs-literal">off</span>setWidth<span class="hljs-comment">;</span>
      // 计算滑块可移动的最大范围（容器宽 - 按钮宽）
      const <span class="hljs-attr">maxLeft</span> = sliderWidth - btnWidth<span class="hljs-comment">;</span>
​
      // 鼠标移动时调整滑块位置和透明度
      const <span class="hljs-attr">handleMouseMove</span> = (e) =&gt; {
        e.preventDefault()<span class="hljs-comment">;</span>
        // 计算滑块相对容器的left值（限制在0~maxLeft之间）
        const <span class="hljs-attr">sliderRect</span> = sliderContainer.getBoundingClientRect()<span class="hljs-comment">;</span>
        let <span class="hljs-attr">left</span> = e.clientX - sliderRect.left - btnWidth / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">left</span> = Math.max(<span class="hljs-number">0</span>, Math.min(maxLeft, left))<span class="hljs-comment">;</span>
​
        // 更新滑块位置
        <span class="hljs-attr">sliderBtn.style.left</span> = `<span class="hljs-variable">${left}</span>px`<span class="hljs-comment">;</span>
​
        // 计算透明度（0~1）并应用到图片
        const <span class="hljs-attr">opacity</span> = left / maxLeft<span class="hljs-comment">;</span>
        <span class="hljs-attr">imgDom.style.opacity</span> = opacity<span class="hljs-comment">;</span>
​
        // 更新显示文本
        <span class="hljs-attr">valueText.textContent</span> = `透明度：<span class="hljs-variable">${Math.round(opacity * 100)}</span>%`<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 鼠标松开时移除事件
      const <span class="hljs-attr">handleMouseUp</span> = () =&gt; {
        document.removeEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
        document.removeEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>
​
      // 绑定全局事件
      document.addEventListener('mousemove', handleMouseMove)<span class="hljs-comment">;</span>
      document.addEventListener('mouseup', handleMouseUp)<span class="hljs-comment">;</span>
    }, false)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-8">使用示例（<code>ImageDemo.vue</code>）</h4>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-container"</span> <span class="hljs-attr">v-imgOpacityResize</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>图片透明度调整<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 图片元素 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
      <span class="hljs-attr">class</span>=<span class="hljs-string">"target-img"</span> 
      <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/800/400"</span> 
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>
    &gt;</span>
    <span class="hljs-comment">&lt;!-- 控制区（滑块会被插入到这里） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"opacity-controls"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拖动滑块调整透明度：<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.image-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto;
  <span class="hljs-attribute">text-align</span>: center;
}
<span class="hljs-selector-class">.target-img</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; <span class="hljs-comment">/* 初始透明度 */</span>
}
<span class="hljs-selector-class">.opacity-controls</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> imgOpacityResize <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directive/imgOpacityResize.js'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">directives</span>: {
    imgOpacityResize
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>效果</strong>：拖拽滑块时，图片透明度随滑块位置变化（左→右：透明→不透明），同时显示当前透明度百分比。</p>
<h3 data-id="heading-9">扩展逻辑总结</h3>
<p>这三个案例均基于原指令的核心逻辑（<strong>手柄+鼠标事件+样式修改</strong>），通过以下调整实现不同功能：</p>
<ol start="0">
<li><strong>手柄位置/样式</strong>：从弹窗右侧→分栏中间→表格底部→图片控制区，样式适配场景（垂直条→水平条→滑块）。</li>
<li><strong>目标元素</strong>：从弹窗→分栏容器→表格容器→图片，只要能通过类名查找即可扩展。</li>
<li><strong>修改的样式属性</strong>：从 <code>width</code>→<code>width</code>（联动）→<code>height</code>→<code>opacity</code>，覆盖尺寸和非尺寸调整。</li>
</ol>
<p>根据实际需求，还可进一步扩展（如调整字体大小、边框粗细等），核心是保持“用户交互→事件监听→样式更新”的逻辑链。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【案例】教育行业APP集成小程序，40%公域流量转化为私域用户！]]></title>    <link>https://juejin.cn/post/7597900782911569939</link>    <guid>https://juejin.cn/post/7597900782911569939</guid>    <pubDate>2026-01-22T07:31:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597900782911569939" data-draft-id="7597811700285079571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【案例】教育行业APP集成小程序，40%公域流量转化为私域用户！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:31:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FinClip"/> <meta itemprop="url" content="https://juejin.cn/user/395479918322696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【案例】教育行业APP集成小程序，40%公域流量转化为私域用户！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918322696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FinClip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:31:27.000Z" title="Thu Jan 22 2026 07:31:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在流量红利见顶、获客成本增长的当下，在线教育行业正面临一场深刻的“公私域联动”考验。</p>
<p>如何将分散在微信、抖音、支付宝等公域平台的用户，高效沉淀为自有App的高粘性用户？</p>
<p>如何在确保用户体验的同时，实现多端业务快速上线与迭代？</p>
<p>某头部在线教育品牌，在业务高速扩张期，同样面临“公域流量难沉淀、开发周期长、生态拓展慢”三大核心痛点。面对日益激烈的市场竞争，该教育App选择与凡泰极客FinClip超级应用智能平台合作，以小程序容器技术为核心，构建“一次开发、多端上架、公私域联动”的敏捷数字化生态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0c2ed2b7655435ea3faa285f10fb1e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671887&amp;x-signature=acia%2Fssljy8sRWZI4%2FWLblmHG7s%3D" alt="图片" loading="lazy"/></p>
<p><strong>一、项目背景：教育行业如何破解“流量依赖症”？</strong></p>
<p>该教育App拥有数百万学员用户，核心业务覆盖考研全科辅导。</p>
<p>但随着公域平台流量成本持续攀升，以及用户学习场景日益碎片化、移动化，平台面临以下发展瓶颈：</p>
<p>公域流量转化难：大量优质内容与用户互动沉淀在微信、抖音等平台，但难以有效引导至自有App，形成私域闭环；</p>
<p>开发迭代周期长：新功能、新课程模块依赖原生开发，上线速度跟不上市场与政策变化（如考研大纲调整）；</p>
<p>多端体验不统一：同一功能需针对微信、App、支付宝等多端重复开发，成本高且体验割裂；</p>
<p>生态拓展能力弱：希望引入外部学习工具、互动社区等内容，但接入流程复杂，周期漫长。</p>
<h6 data-id="heading-0"/>
<p><strong>二、微信生态一键平移，构建教育超级App</strong></p>
<h2 data-id="heading-1">基于FinClip小程序跨端运行与“小程序一键转App”能力，该教育App在不重构现有技术架构的前提下，将原运行于微信的30+个核心学习小程序（如“考研英语真题库”“政治刷题班”“在线自习室”等），快速、平滑地迁移至自有App中，并同步上架至支付宝、抖音等多端平台。</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25a919f3018d46c68bb4dc93c052e328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671887&amp;x-signature=zaWDJ9T9ELOQgbj65K3DNcTDwHg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">► 公私域流量无缝衔接，沉淀高价值学习用户</h3>
<p>通过FinClip的多端同步上架能力，该教育App将微信生态中广受欢迎的“考研英语”小程序，同步至自有App。</p>
<p>超40%的公域观看用户被成功引导至App内完成深度学习与付费转化，其中“考研英语”小程序在App内月活跃用户超过10万，真正实现了从“流量”到“留量”的转变。</p>
<h3 data-id="heading-3">► 开发周期缩短65%，敏捷响应教学需求</h3>
<p>借助FinClip的标准化小程序容器，新功能、新课包均以小程序形式开发与上线，无需等待App发版。整体场景开发周期平均缩短65%，例如“大纲解析直播专题”从策划到全端上线仅用一周时间，极大提升了教学服务的市场响应速度。</p>
<h3 data-id="heading-4">► 构建“学习+工具+社区”一体化生态</h3>
<p>通过FinClip开放的生态接入能力，该教育App快速引入了第三方学习工具（如笔记同步、AI错题本）、互动社区、心理健康服务等小程序，将App从“视频授课平台”升级为“一站式学习成长平台”，显著提升了用户粘性与学习完课率。</p>
<p><strong>三：跨端、敏捷、安全一体化</strong></p>
<h2 data-id="heading-5">► 一次开发，多端上架，真正实现全端覆盖</h2>
<p>FinClip提供iOS、Android、HarmonyOS等多端SDK，并兼容微信小程序语法。该App的开发团队只需维护一套小程序代码，即可同步发布至自有App及各大流量平台，大幅降低开发与维护成本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00ee2da0746460c8f22abde98f896ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671887&amp;x-signature=LOJiVBYdU01RDEe7Kl0D%2BYu93Z0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">► 业务独立迭代，灰度发布支持精准运营</h3>
<p>每个学习小程序均可独立更新上下架，运营团队可通过灰度发布能力，针对不同备考阶段、不同地区的学员精准推送适配内容，实现“千人千面”的学习路径推荐。</p>
<h3 data-id="heading-7">► 安全沙箱隔离，保障核心学习数据与用户体验</h3>
<p>所有第三方小程序均在FinClip提供的安全沙箱环境中运行，与主App核心代码及数据完全隔离，既确保了教学主流程的稳定流畅，又严格符合教育行业数据安全与隐私保护要求。</p>
<p><strong>四、从流量运营到生态构建</strong></p>
<p>私域沉淀效果显著：成功将超过40%的公域流量转化为自有App的高活跃用户，构建了稳定的私域用户池；</p>
<p>业务上线速度飞跃：新功能、新课包平均开发周期缩短65%，实现“周级”甚至“天级”迭代；</p>
<p>生态融合能力增强：快速引入多类第三方教育服务，平台从“内容交付”转向“生态赋能”，用户生命周期价值显著提升；</p>
<p>合规与体验兼顾：在快速扩展生态的同时，确保全流程学习数据安全可控，用户体验流畅统一。</p>
<p><strong>五、打造未来可持续生态化教育平台</strong></p>
<p>该教育App的实践表明，教育数字化已进入“生态竞争”阶段。</p>
<p>单一的内容或工具已无法满足用户多元化、场景化的学习需求。</p>
<p>FinClip以小程序容器技术为底座，助力教育机构在不影响主业务体验的前提下，高效连接公私域流量、敏捷扩展服务生态，构建真正“以学习者为中心”的超级学习平台。</p>
<p>未来，凡泰极客将继续携手教育行业伙伴，以安全、开放、敏捷的超级应用智能平台，助力更多教培机构、院校及知识服务企业，构建连接多元场景、承载终身学习的数字新生态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nuxt 配 plugins，也就是插件]]></title>    <link>https://juejin.cn/post/7597779410406506530</link>    <guid>https://juejin.cn/post/7597779410406506530</guid>    <pubDate>2026-01-22T07:33:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597779410406506530" data-draft-id="7597724783649112104" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nuxt 配 plugins，也就是插件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T07:33:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nuxt 配 plugins，也就是插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:33:40.000Z" title="Thu Jan 22 2026 07:33:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>比如说在<code>plugins</code>文件夹下<code>aaa.js</code>，</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>)
</code></pre>
<p>然后在<code>nuxt.config.js</code>里面配一下<code>plugins</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// nuxt.config.js</span>
{
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// 在页面渲染之前所用到的插件</span>
  <span class="hljs-attr">plugins</span>: [
   <span class="hljs-string">'~/plugins/aaa.js'</span>
  ]
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>比如说<code>axios</code>的二次封装，就可以把这个文件放里边。或者第三方的插件。比如说<code>element ui</code>的css文件就在css里面加上去，js就在plugins里面加入。</p>
<p>这里新建一个js文件。然后在<code>elementjs</code>里边，可能会引入，比如import element，use一下就可以了。</p>
<h2 data-id="heading-0">引入第三方库这块怎么写</h2>
<p>在<code>nuxt</code>安装那个时候，有一个选项让大家去选框架，如果选择了element，在<code>nuxt.config.js</code>里边：</p>
<pre><code class="hljs language-ts" lang="ts">{
 <span class="hljs-attr">plugins</span>: [
   <span class="hljs-string">'@/plugins/element-ui'</span>
 ]
}
</code></pre>
<p>就有这样一个引入。</p>
<p>plugins下面就有一个element-ui.js</p>
<p>要是没选，那么我们自行去下载<code>cnpm i element-ui -S</code></p>
<p>下载完成后，就要进行一系列的引入了。首先先把css引入。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// nuxt.config.js</span>

{
  <span class="hljs-attr">css</span>: [
    <span class="hljs-string">'element-ui/lib/theme-chalk/index.css'</span>
  ]
}
</code></pre>
<p>配置完，项目它自己会对应去找node_modules里边的一些内容。</p>
<p>然后还得配置js：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">'~/plugins/element.js'</span>
  }
}
</code></pre>
<p>然后在<code>plugins</code>下面创建<code>element.js</code>文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// element.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ElementUI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>;

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementUI</span>);
<span class="hljs-comment">// 上面三行代码就可以了</span>
</code></pre>
<p>然后测试安装以及这样的一个引入。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"el-icion-search"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
</code></pre>
<p>写在nuxt里面是这样：</p>
<pre><code class="hljs language-html" lang="html">/pages/index.vue

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    首页
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"el-icon-search"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'IndexPage'</span>
}
&lt;/scirpt&gt;
</span></code></pre>
<p>然后去看页面效果，就看到生效了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ecc187cd2d6483a9117f37c3a35fd4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769672019&amp;x-signature=2EIVQLr0%2BPzpsF5ZF1R8ChwJaFc%3D" alt="image.png" loading="lazy"/></p>
<p>后续还有更多插件，你等着我更新。</p>
<p><code>nuxt</code>有很多插件写法有src，还可以直接引入：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2eb48d38570485c8ca33dc56bbf1b10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769672019&amp;x-signature=DaAVLsVQIkeFSD7ojVE%2B4sj7K9A%3D" alt="image.png" loading="lazy"/></p>
<p>src的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59244e76c3614974962e5cdb66057ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769672019&amp;x-signature=XuEpRHZgTBQikzS90yVzm1gcS9Q%3D" alt="image.png" loading="lazy"/></p>
<p>直接写的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 中处理与展示 HTML 富文本]]></title>    <link>https://juejin.cn/post/7597968460651921450</link>    <guid>https://juejin.cn/post/7597968460651921450</guid>    <pubDate>2026-01-22T07:33:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597968460651921450" data-draft-id="7597968460651905066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 中处理与展示 HTML 富文本"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-22T07:33:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4165967369355"/> <meta itemprop="url" content="https://juejin.cn/user/1146150492576877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 中处理与展示 HTML 富文本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146150492576877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4165967369355
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:33:58.000Z" title="Thu Jan 22 2026 07:33:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与挑战</h2>
<p>在传统的 Android View 系统中，我们可以直接通过 <code>TextView.setText(Html.fromHtml(...))</code> 展示带颜色的 HTML 字符串。</p>
<p>但在 <strong>Jetpack Compose</strong> 中，<code>Text</code> 组件仅接受 <code>String</code> 或 <code>AnnotatedString</code> 类型。由于 Compose 的 <code>Text</code> 并不原生解析 HTML 标签，因此我们需要建立一套桥接方案，将 XML 中的 HTML 字符串转换为 Compose 可识别的样式对象。</p>
<h2 data-id="heading-1">2. 核心实现方案</h2>
<p>本方案采用 <strong>“XML 资源 + Android 原生 HTML 解析 + Compose 扩展转换函数”</strong> 的路径。</p>
<h3 data-id="heading-2">2.1 资源层：定义 HTML 字符串</h3>
<p>在 <code>strings.xml</code> 中，使用 <code>CDATA</code> 标签包裹 HTML 内容。推荐使用 <code>\u00A0</code> 处理多空格需求，以防止资源编译时被压缩。</p>
<p>XML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ai_statistic_legend"</span>&gt;</span>
    &lt;![CDATA[&lt;font color="#FBC02D"&gt;%1$s&lt;/font&gt;代表鸡蛋\u00A0\u00A0\u00A0&lt;font color="#FF0000"&gt;%2$s&lt;/font&gt;代表西红柿]]&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"label_yellow"</span>&gt;</span>黄色<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"label_red"</span>&gt;</span>红色<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2.2 转换层：<code>Spanned</code> 转 <code>AnnotatedString</code></h3>
<p>编写一个通用的扩展函数，遍历 <code>HtmlCompat.fromHtml</code> 生成的 <code>Spanned</code> 对象中的所有 Span（如颜色、加粗、下划线），并将其映射到 Compose 的 <code>SpanStyle</code>。</p>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.text.Html
<span class="hljs-keyword">import</span> android.text.Spanned
<span class="hljs-keyword">import</span> android.text.style.ForegroundColorSpan
<span class="hljs-keyword">import</span> android.text.style.StyleSpan
<span class="hljs-keyword">import</span> android.text.style.UnderlineSpan
<span class="hljs-keyword">import</span> androidx.compose.ui.graphics.Color
<span class="hljs-keyword">import</span> androidx.compose.ui.text.AnnotatedString
<span class="hljs-keyword">import</span> androidx.compose.ui.text.SpanStyle
<span class="hljs-keyword">import</span> androidx.compose.ui.text.buildAnnotatedString
<span class="hljs-keyword">import</span> androidx.compose.ui.text.font.FontStyle
<span class="hljs-keyword">import</span> androidx.compose.ui.text.font.FontWeight
<span class="hljs-keyword">import</span> androidx.compose.ui.text.style.TextDecoration

<span class="hljs-comment">/**
 * 将 Android 传统的 Spanned 转换成 Compose 的 AnnotatedString
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> CharSequence.<span class="hljs-title">toAnnotatedString</span><span class="hljs-params">()</span></span>: AnnotatedString {
    <span class="hljs-keyword">val</span> spanned = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span>? Spanned ?: <span class="hljs-keyword">return</span> AnnotatedString(<span class="hljs-keyword">this</span>.toString())
    
    <span class="hljs-keyword">return</span> buildAnnotatedString {
        append(spanned.toString())
        
        <span class="hljs-comment">// 1. 处理颜色 (对应 HTML 的 &lt;font color="..."&gt;)</span>
        <span class="hljs-keyword">val</span> colorSpans = spanned.getSpans(<span class="hljs-number">0</span>, spanned.length, ForegroundColorSpan::<span class="hljs-keyword">class</span>.java)
        colorSpans.forEach { span -&gt;
            <span class="hljs-keyword">val</span> start = spanned.getSpanStart(span)
            <span class="hljs-keyword">val</span> end = spanned.getSpanEnd(span)
            addStyle(SpanStyle(color = Color(span.foregroundColor)), start, end)
        }

        <span class="hljs-comment">// 2. 处理样式 (对应 HTML 的 &lt;b&gt; &lt;i&gt;)</span>
        <span class="hljs-keyword">val</span> styleSpans = spanned.getSpans(<span class="hljs-number">0</span>, spanned.length, StyleSpan::<span class="hljs-keyword">class</span>.java)
        styleSpans.forEach { span -&gt;
            <span class="hljs-keyword">val</span> start = spanned.getSpanStart(span)
            <span class="hljs-keyword">val</span> end = spanned.getSpanEnd(span)
            <span class="hljs-keyword">when</span> (span.style) {
                android.graphics.Typeface.BOLD -&gt; addStyle(SpanStyle(fontWeight = FontWeight.Bold), start, end)
                android.graphics.Typeface.ITALIC -&gt; addStyle(SpanStyle(fontStyle = FontStyle.Italic), start, end)
            }
        }

        <span class="hljs-comment">// 3. 处理下划线 (对应 HTML 的 &lt;u&gt;)</span>
        <span class="hljs-keyword">val</span> underlineSpans = spanned.getSpans(<span class="hljs-number">0</span>, spanned.length, UnderlineSpan::<span class="hljs-keyword">class</span>.java)
        underlineSpans.forEach { span -&gt;
            <span class="hljs-keyword">val</span> start = spanned.getSpanStart(span)
            <span class="hljs-keyword">val</span> end = spanned.getSpanEnd(span)
            addStyle(SpanStyle(textDecoration = TextDecoration.Underline), start, end)
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2.3 UI 层：组件集成</h3>
<p>在 Composable 函数中，利用 <code>stringResource</code> 进行格式化注入，随后通过 <code>HtmlCompat</code> 进行解析。</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Composable</span>
fun HtmlRichTextDisplay() {
    <span class="hljs-comment">// 获取格式化后的原始字符串 (包含 HTML 标签)</span>
    val rawHtml = <span class="hljs-built_in">stringResource</span>(
        id = R.string.ai_statistic_legend, 
        stringResource(R.string.label_yellow), 
        <span class="hljs-built_in">stringResource</span>(R.string.label_red)
    )

    <span class="hljs-comment">// 调用解析逻辑</span>
    val spanned = HtmlCompat<span class="hljs-selector-class">.fromHtml</span>(rawHtml, HtmlCompat.FROM_HTML_MODE_COMPACT)

    <span class="hljs-comment">// 展示</span>
    Text(
        text = spanned.toAnnotatedString(),
        <span class="hljs-attribute">color</span> = <span class="hljs-attribute">Color</span><span class="hljs-selector-class">.Black</span> <span class="hljs-comment">// 非高亮部分的默认颜色</span>
    )
}
</code></pre>
<hr/>
<h2 data-id="heading-5">3. 关键知识点总结</h2>



































<table><thead><tr><th><strong>功能点</strong></th><th><strong>处理方案</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><strong>多语言支持</strong></td><td><code>%1$s</code> 占位符</td><td>确保翻译时变量顺序可变</td></tr><tr><td><strong>局部高亮颜色</strong></td><td><code>&lt;font color="#RRGGBB"&gt;</code></td><td>需使用十六进制颜色值</td></tr><tr><td><strong>多连续空格</strong></td><td>使用 <code>\u00A0</code></td><td>XML 中空格会被压缩，此字符可强制保留</td></tr><tr><td><strong>性能考量</strong></td><td>纯 Compose <code>Text</code> 渲染</td><td>避免使用 <code>AndroidView</code> 嵌套 <code>TextView</code></td></tr><tr><td><strong>扩展性</strong></td><td>扩展函数适配 Span</td><td>可根据需求添加对 <code>&lt;a&gt;</code> 或 <code>&lt;h1&gt;</code> 等标签的支持</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IndexScan比SeqScan返回的结果更少，索引损坏？]]></title>    <link>https://juejin.cn/post/7597811700285112339</link>    <guid>https://juejin.cn/post/7597811700285112339</guid>    <pubDate>2026-01-22T07:32:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597811700285112339" data-draft-id="7597811700285095955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IndexScan比SeqScan返回的结果更少，索引损坏？"/> <meta itemprop="keywords" content="PostgreSQL,数据库,开源"/> <meta itemprop="datePublished" content="2026-01-22T07:32:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvorySQL"/> <meta itemprop="url" content="https://juejin.cn/user/761327331579511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IndexScan比SeqScan返回的结果更少，索引损坏？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/761327331579511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvorySQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:32:08.000Z" title="Thu Jan 22 2026 07:32:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关于作者：</p>
<p>Nickyoung，数据库领域从业者。PostgreSQL ACE，IvorySQL专家顾问委员会成员。</p>
<p>公众号 “ 👉 <strong>PostgreSQL 运维之道</strong> ”。</p>
</blockquote>
<p>给大家分享一个有趣的案例，同一个 sql，索引扫描比全表顺序扫描获取的数据更少。本篇我们深入分析一起索引排序规则损坏的案例，并 debug 验证索引扫描的主要过程。</p>
<h2 data-id="heading-0">问题现象</h2>
<p>走索引扫描查询到 1 条数据。</p>
<pre><code class="hljs language-sql" lang="sql">testidx<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>  <span class="hljs-keyword">from</span> user_info <span class="hljs-keyword">where</span> userid <span class="hljs-operator">=</span><span class="hljs-string">'1230005998'</span>;
                                                          QUERY PLAN                                                           
<span class="hljs-comment">-------------------------------------------------------------------------------------------------------------------------------</span>
 Index Scan <span class="hljs-keyword">using</span> index_userid <span class="hljs-keyword">on</span> user_info  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.28</span>.<span class="hljs-number">.35</span><span class="hljs-number">.61</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">9</span> width<span class="hljs-operator">=</span><span class="hljs-number">57</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.030</span>.<span class="hljs-number">.0</span><span class="hljs-number">.032</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
   Index Cond: ((userid)::text <span class="hljs-operator">=</span> <span class="hljs-string">'1230005998'</span>::text)
 Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.118</span> ms
 Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.057</span> ms
(<span class="hljs-number">4</span> <span class="hljs-keyword">rows</span>)

testidx<span class="hljs-operator">=</span># <span class="hljs-keyword">select</span> ctid,userid,region_id <span class="hljs-keyword">from</span> user_info <span class="hljs-keyword">where</span> userid <span class="hljs-operator">=</span><span class="hljs-string">'1230005998'</span>;
  ctid  <span class="hljs-operator">|</span> userid    <span class="hljs-operator">|</span> region_id 
<span class="hljs-comment">--------+----------------------+-----------</span>
 (<span class="hljs-number">4</span>,<span class="hljs-number">39</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
(<span class="hljs-number">1</span> <span class="hljs-type">row</span>)
</code></pre>
<p>不走索引顺序扫描查询到 11 条数据。</p>
<pre><code class="hljs language-sql" lang="sql">testidx<span class="hljs-operator">=</span># <span class="hljs-keyword">set</span> enable_indexscan <span class="hljs-keyword">to</span> off;
<span class="hljs-keyword">SET</span>
testidx<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> user_info <span class="hljs-keyword">where</span> userid <span class="hljs-operator">=</span><span class="hljs-string">'1230005998'</span>;
                                                QUERY PLAN                                                
<span class="hljs-comment">----------------------------------------------------------------------------------------------------------</span>
 Seq Scanon user_info  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.51</span><span class="hljs-number">.50</span><span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">9</span> width<span class="hljs-operator">=</span><span class="hljs-number">57</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.093</span>.<span class="hljs-number">.0</span><span class="hljs-number">.460</span><span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">11</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)
   <span class="hljs-keyword">Filter</span>: ((userid)::text <span class="hljs-operator">=</span> <span class="hljs-string">'1230005998'</span>::text)
   <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">1309</span>
 Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.116</span> ms
 Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.478</span> ms
(<span class="hljs-number">5</span><span class="hljs-keyword">rows</span>)

testidx<span class="hljs-operator">=</span># <span class="hljs-keyword">select</span> ctid,userid,region_id <span class="hljs-keyword">from</span> user_info <span class="hljs-keyword">where</span> userid <span class="hljs-operator">=</span><span class="hljs-string">'1230005998'</span>;
  ctid   <span class="hljs-operator">|</span> userid    <span class="hljs-operator">|</span> region_id 
<span class="hljs-comment">---------+----------------------+-----------</span>
 (<span class="hljs-number">4</span>,<span class="hljs-number">39</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">9</span>,<span class="hljs-number">14</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">9</span>,<span class="hljs-number">32</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc 
 (<span class="hljs-number">10</span>,<span class="hljs-number">32</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">12</span>,<span class="hljs-number">5</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">26</span>,<span class="hljs-number">23</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">27</span>,<span class="hljs-number">4</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">27</span>,<span class="hljs-number">9</span>)  <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">27</span>,<span class="hljs-number">11</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">34</span>,<span class="hljs-number">38</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
 (<span class="hljs-number">34</span>,<span class="hljs-number">39</span>) <span class="hljs-operator">|</span> <span class="hljs-number">1230005998</span> <span class="hljs-operator">|</span> abc
(<span class="hljs-number">11</span><span class="hljs-keyword">rows</span>)

testidx<span class="hljs-operator">=</span>#
</code></pre>
<p>对比两次查询结果，可以看到走索引扫描时，仅查询到第一条匹配的数据，对应 ctid 为(4,39)。索引损坏了？</p>
<h2 data-id="heading-1">问题分析</h2>
<p>当我们怀疑索引损坏时，可以使用 amcheck 插件对索引进行扫描分析，检查是否存在异常。</p>
<p>可以看到 leaf page 8 的 itemoffset 24 和 25 违反了条目顺序不变性规则。即按照升序原则 24 号索引槽位对应的键值要小于等于 25 槽位，但经检查是大于的，所以排序规则混乱了。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">testidx=# <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> bt_index_check(<span class="hljs-comment">'index_userid',true);</span>
<span class="hljs-symbol">DEBUG:</span>  StartTransaction(<span class="hljs-number">1</span>) name: unnamed; blockState: <span class="hljs-keyword">DEFAULT</span>; state: INPROGRESS, xid/subid/cid: <span class="hljs-number">0</span>/<span class="hljs-number">1</span>/<span class="hljs-number">0</span>
<span class="hljs-symbol">DEBUG:</span>  verifying level <span class="hljs-number">1</span> (<span class="hljs-literal">true</span> root level)
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">7</span> items <span class="hljs-keyword">on</span> internal block <span class="hljs-number">3</span>
<span class="hljs-symbol">DEBUG:</span>  verifying level <span class="hljs-number">0</span> (leaf level)
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">207</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">1</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">204</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">2</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">204</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">4</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">204</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">5</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">204</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">6</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">235</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">7</span>
<span class="hljs-symbol">DEBUG:</span>  verifying <span class="hljs-number">78</span> items <span class="hljs-keyword">on</span> leaf block <span class="hljs-number">8</span>
<span class="hljs-symbol">ERROR:</span>  item <span class="hljs-keyword">order</span> invariant violated <span class="hljs-keyword">for</span> index <span class="hljs-string">"index_userid"</span>
<span class="hljs-symbol">DETAIL:</span>  Lower index tid=(<span class="hljs-number">8</span>,<span class="hljs-number">24</span>) (points <span class="hljs-keyword">to</span> heap tid=(<span class="hljs-number">4</span>,<span class="hljs-number">14</span>)) higher index tid=(<span class="hljs-number">8</span>,<span class="hljs-number">25</span>) (points <span class="hljs-keyword">to</span> heap tid=(<span class="hljs-number">9</span>,<span class="hljs-number">14</span>)) page lsn=<span class="hljs-number">1</span>/<span class="hljs-number">331E9F</span>98.
testidx=# 
</code></pre>
<p>使用 pageinspect 扩展，查看 leaf page 8 有 78 条记录，其中 itemoffset 24 和 25 对应的键值，24 的键值为'31 09 xxx'，25 的键值为'2b 4c xxx'，前者大，确实是有问题的。</p>
<pre><code class="hljs language-sql" lang="sql">testidx<span class="hljs-operator">=</span># <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> bt_page_stats(<span class="hljs-string">'index_userid'</span>,<span class="hljs-number">8</span>);
 blkno <span class="hljs-operator">|</span> type <span class="hljs-operator">|</span> live_items <span class="hljs-operator">|</span> dead_items <span class="hljs-operator">|</span> avg_item_size <span class="hljs-operator">|</span> page_size <span class="hljs-operator">|</span> free_size <span class="hljs-operator">|</span> btpo_prev <span class="hljs-operator">|</span> btpo_next <span class="hljs-operator">|</span> btpo <span class="hljs-operator">|</span> btpo_flags 
<span class="hljs-comment">-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</span>
     <span class="hljs-number">8</span> <span class="hljs-operator">|</span> l    <span class="hljs-operator">|</span>         <span class="hljs-number">78</span> <span class="hljs-operator">|</span>          <span class="hljs-number">0</span> <span class="hljs-operator">|</span>            <span class="hljs-number">31</span> <span class="hljs-operator">|</span>      <span class="hljs-number">8192</span> <span class="hljs-operator">|</span>      <span class="hljs-number">5356</span> <span class="hljs-operator">|</span>         <span class="hljs-number">7</span> <span class="hljs-operator">|</span>         <span class="hljs-number">0</span> <span class="hljs-operator">|</span>    <span class="hljs-number">0</span> <span class="hljs-operator">|</span>          <span class="hljs-number">1</span>
(<span class="hljs-number">1</span> <span class="hljs-type">row</span>)

testidx<span class="hljs-operator">=</span># 
</code></pre>

<pre><code class="hljs language-scss" lang="scss">testidx=# select * from  <span class="hljs-built_in">bt_page_items</span>('index_userid',<span class="hljs-number">8</span>) where itemoffset in (<span class="hljs-number">22</span>,<span class="hljs-number">23</span>,<span class="hljs-number">24</span>,<span class="hljs-number">25</span>);
 itemoffset |  ctid  | itemlen | nulls | vars |                                  data                                   
------------+--------+---------+-------+------+-------------------------------------------------------------------------
         <span class="hljs-number">22</span> | (<span class="hljs-number">4</span>,<span class="hljs-number">39</span>) |      <span class="hljs-number">32</span> | f     | t    | <span class="hljs-number">2</span>b <span class="hljs-number">4</span>c <span class="hljs-number">54</span> <span class="hljs-number">34</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">32</span> <span class="hljs-number">35</span> <span class="hljs-number">31</span> <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
         <span class="hljs-number">23</span> | (<span class="hljs-number">4</span>,<span class="hljs-number">9</span>)  |      <span class="hljs-number">32</span> | f     | t    | <span class="hljs-number">31</span> <span class="hljs-number">09</span> <span class="hljs-number">0</span>d <span class="hljs-number">0</span>a <span class="hljs-number">4</span>c <span class="hljs-number">54</span> <span class="hljs-number">34</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">32</span> <span class="hljs-number">35</span> <span class="hljs-number">31</span> <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">37</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">37</span> <span class="hljs-number">39</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">32</span>
         <span class="hljs-number">24</span> | (<span class="hljs-number">4</span>,<span class="hljs-number">14</span>) |      <span class="hljs-number">32</span> | f     | t    | <span class="hljs-number">31</span> <span class="hljs-number">09</span> <span class="hljs-number">0</span>d <span class="hljs-number">0</span>a <span class="hljs-number">4</span>c <span class="hljs-number">54</span> <span class="hljs-number">34</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">32</span> <span class="hljs-number">35</span> <span class="hljs-number">31</span> <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">37</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">37</span> <span class="hljs-number">39</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">32</span>
         <span class="hljs-number">25</span> | (<span class="hljs-number">9</span>,<span class="hljs-number">14</span>) |      <span class="hljs-number">32</span> | f     | t    | <span class="hljs-number">2</span>b <span class="hljs-number">4</span>c <span class="hljs-number">54</span> <span class="hljs-number">34</span> <span class="hljs-number">33</span> <span class="hljs-number">36</span> <span class="hljs-number">32</span> <span class="hljs-number">35</span> <span class="hljs-number">31</span> <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
(<span class="hljs-number">4</span> rows)

testidx=#
</code></pre>
<p>明显的索引损坏了，怎么损坏的呢？</p>
<p>可能是 BUG 或者系统异常导致数据库 crash 等写坏， 还有一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.postgresql.org%2Fwiki%2FLocale_data_changes" target="_blank" title="https://wiki.postgresql.org/wiki/Locale_data_changes" ref="nofollow noopener noreferrer">glibc 版本差异导致索引损坏的场景</a>，特别是 glibc 2.28 之前和之后的版本。</p>
<p>经过排查这次异常就是 glibc 差异导致的，glibc 版本从 2.17 到 2.28。</p>
<p>当遇到这样的索引损坏场景时，建议 reindex 对应的索引来修复。</p>
<p>这个问题基本分析清楚了，不过老杨不打算到此为止。 借此机会证实下索引扫描的逻辑，也搞清楚为什么仅扫描一条数据就结束。感兴趣的朋友可以继续往下看。</p>
<h2 data-id="heading-2">原理分析</h2>
<p>btree 想必大家都很熟悉了（其实我很讨厌面试中对于 btree 的八股文，haha...）</p>
<p>再来回顾下结构，细节可以参考灿灿的书中<a href="https://link.juejin.cn?target=https%3A%2F%2Fpostgres-internals.cn%2Fdocs%2Fchapter25%2F" target="_blank" title="https://postgres-internals.cn/docs/chapter25/" ref="nofollow noopener noreferrer">btree 章节</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d5462544ed44d479a992b5492b6d00e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=tGrpl%2FTk0YapESwT57GJXFrkoao%3D" alt="01.png" loading="lazy"/></p>
<p>检索的时候，从 root page 开始检索，在 leaf page 中找到键值匹配的 heap ctid，通过 ctid 去 heap 中 fetch 对应的数据。这里借用德哥画的图，来自<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdigoal%2Fblog%2Fblob%2Fmaster%2F201605%2F20160528_01.md" target="_blank" title="https://github.com/digoal/blog/blob/master/201605/20160528_01.md" ref="nofollow noopener noreferrer">github 博客</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fa6ffac3d754b78b0ce963857965a40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=JaQaJ9oB%2BvJxb9wWXldZ1dy0iyQ%3D" alt="02.png" loading="lazy"/></p>
<p>另外 postgrespro 的博客<a href="https://link.juejin.cn?target=https%3A%2F%2Fpostgrespro.com%2Fblog%2Fpgsql%2F4161516" target="_blank" title="https://postgrespro.com/blog/pgsql/4161516" ref="nofollow noopener noreferrer">btree 章节</a>，对于检索过程描述的不错，推荐大家去看看。</p>
<p>例如查找等于 49 的数据，标黄部分及蓝色箭头描述了检索过程：从 root 节点出发，找到第一个匹配的 leaf 节点，顺着 leaf 节点的链表一直查找，直到检索完所有匹配的 leaf 节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b07b2fe16d324080a29523fcd6881a56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=pfGSGw7NWn9hqMnzoQK3GWFcpe8%3D" alt="03.png" loading="lazy"/></p>
<p>简单回顾一些概念和原理后，我们上手 debug 来证实检索过程。</p>
<p>我们的检索条件为<code>userid ='1230005998'</code></p>
<p><strong>1. 先确定 first leaf page</strong></p>
<p><code>btgettuple</code>函数中首次扫描走<code>_bt_first</code>函数逻辑。</p>
<p>通常 leaf page 会有多个，扫描时通过二分查找，先找到键值匹配的目标 leaf page。 在_bt_first 函数中，调用_bt_search 函数，再调用_bt_binsrch 函数进行二分查找。</p>
<p>初始的 low 为 1，high 为 8 对应 index_userid 这个索引的 leaf block 1 和 8</p>
<p>_bt_compare 函数进行 key 匹配，这里 userid 为 text 类型，因此使用的比较函数为 bttextcmp</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/693a5fb8c7764291acc2bff02b7ce978~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=hM75sB5mv8lyA0Ma%2BTd5MdBWvkI%3D" alt="04.png" loading="lazy"/></p>
<p>我们省去二分查找的过程，最终 high=low=8，确定目标数据在 leaf page 8</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94fe38388c034830a22d00917c616b5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=BgiwSP5RLjWlQLN7ItCAefGpeFw%3D" alt="05.png" loading="lazy"/></p>
<p><strong>2、确定 first item</strong></p>
<p>开始扫描目标 leaf page，同样采用二分查找，找到第一条匹配的 item。</p>
<p>_bt_first 函数走到 offnum = _bt_binsrch(rel, &amp;inskey, buf)，在_bt_binsrch 函数中初始 high 为 78，low 为 1（因为 leaf page 8 有 78 条 item）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e2073704169402fbb0da9a8b3aa652e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=IR6c3DJFZCX3MxiI%2B2LBU%2B6XhQA%3D" alt="06.png" loading="lazy"/></p>
<p>在多轮二分查找后，mid 为 22 时_bt_compare 匹配到了预期数据。bttextcmp 函数中可以看到 text_cmp 入参 arg1, arg2 相同，都为 1230005998，result 为 0。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9fe62fb7db44eb1ac9df475f957279c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=HFhe4ah8RVO1bHKkQqytROOFSZk%3D" alt="07.png" loading="lazy"/></p>
<p>因此，low 为 22，high 为 22，找到了 first item。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b5fad6fe276497f85eba3b263d08d90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=6vuuBjEdS9DxxOAYHrf8CZF8HuI%3D" alt="08.png" loading="lazy"/></p>
<p><strong>3、遍历页面元组，设置扫描边界</strong></p>
<p>while (offnum &lt;= maxoff)循环，offnum 为 22，maxoff 为 78。</p>
<p>从 first item 即 offnum=22 开始遍历，_bt_readpage 中调用_bt_checkkeys 首次比较结果相同，itemIndex++为 1，continuescan 为 true，offnum 延顺到 Next 即 23。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d92fa19cb27b4be29033920fb3b43214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=Yi49XbZ15RHGVsFts%2BGwe6TmUd8%3D" alt="09.png" loading="lazy"/></p>
<p>循环中再次调用_bt_checkkeys 进行比较，实际的比较函数为 texteq，offnum 为 23 时 key 值明显和检索条件的长度不同，值肯定是不同的，result 为 false。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70204dc0a5f34366bc038e4c10f064be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=vHCVvNTE03io6RmqHAVxnoE81TI%3D" alt="10.png" loading="lazy"/></p>
<p>result 传递给 test，因此*continuescan = false，_bt_checkkeys 返回 false。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d01d7f9cfb649ff8f02e7b1685060be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=K%2FzSJ1Uz6uWO514WMS7nJDPQVhI%3D" alt="11.png" loading="lazy"/></p>
<p>continuescan 为 false，因此 so-&gt;currPos.moreRight=false，so-&gt;currPos.firstItem = 0， so-&gt;currPos.lastItem = 1 - 1， so-&gt;currPos.itemIndex = 0;</p>
<p>就是这几个属性决定了扫描边界。 firstItem 和 lastItem 相同都为 0，说明扫描的范围就是 first Item 这一条数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d93af07c4441ee817877e1f8d886f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=Olg0oGlSynWm9DhTdDh%2FVdEPplk%3D" alt="12.png" loading="lazy"/></p>
<p>index_getnext_slot 函数中根据 ctid(4,39)调用 index_fetch_heap 获取 heap 数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18f009dc04b8424880c88b96f552f310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=Tg9%2BDCgaIEJ5D66aw8XdUWo1mE8%3D" alt="13.png" loading="lazy"/></p>
<p><strong>4、获取 next Item</strong></p>
<p>btgettuple 函数中，后续扫描调用_bt_next 函数。</p>
<p>so-&gt;currPos.moreRight 为 false，_bt_readnextpage 函数 return false，因此_bt_steppage 函数 return false</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a3b0f3c24754788a691acfb888caf9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=jwD1Pou6vxIJ%2BV6Q958lB2mDA%2BI%3D" alt="14.png" loading="lazy"/></p>
<p>因此_bt_next 函数返回 false，btgettuple 返回 false</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62206a38875042248fd8c47ca026cb6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=6Tgqpwobny%2BpNTTTkaUx1yAj64c%3D" alt="15.png" loading="lazy"/></p>
<p>index_getnext_tid 函数返回 NULL</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/655a52c7e56c4494b6c74b2636a7ec25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=QwhJV2yQX0S6Ntb%2BVP%2BK%2Bu2jUYA%3D" alt="16.png" loading="lazy"/></p>
<p>tid 为 NULL，index_getnext_slot 函数返回 NULL</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4abb8f07fbc40ae90e2a11972dbf016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671928&amp;x-signature=pArRbdzKe91ifqr7p7f1AtAl%2FUE%3D" alt="17.png" loading="lazy"/></p>
<p>至此扫描结束。</p>
<p>从这个过程中可以看到，itemoffset 22 即记录 ctid(4,39)这条索引键值和检索条件匹配，但 23 不匹配，因此导致索引扫描结束，只扫描了一条数据。</p>
<p>从 seqscan 结果看，ctid (4,39)下一条符合条件的数据为(9,14)，对应到索引 itemoffset 25。从 bt_page_items 的结果来看，23 和 24 的键值是一样的，都比 25 大，因此索引排序规则是错乱的。</p>
<h2 data-id="heading-3">小结</h2>
<p>本篇我们深入分析了一起索引排序规则损坏的案例，当出现类似问题时，可以利用 amcheck 和 pageinspect 扩展来分析解决。同时也 debug 证实了下索引扫描的一些关键过程。</p>
<hr/>
<h2 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">HOW 2026 议题招募中</a></h2>
<p>2026 年 4 月 27-28 日，由 IvorySQL 社区联合 PGEU（欧洲 PG 社区）、PGAsia（亚洲 PG 社区）共同打造的 HOW 2026（IvorySQL &amp; PostgreSQL 技术峰会） 将再度落地济南。届时，PostgreSQL 联合创始人 Bruce Momjian 等顶级大师将亲临现场。</p>
<p>自开启征集以来，HOW 2026 筹备组已感受到来自全球 PostgreSQL 爱好者的澎湃热情。为了确保大会议题的深度与广度，我们诚邀您在 2026 年 2 月 27 日截止日期前，提交您的技术见解。</p>
<p>投递链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">jsj.top/f/uebqBc</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[zq-platform初始数据写不到数据库问题解决详细操作流程]]></title>    <link>https://juejin.cn/post/7597808104462270510</link>    <guid>https://juejin.cn/post/7597808104462270510</guid>    <pubDate>2026-01-22T07:29:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597808104462270510" data-draft-id="7597989474991095846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="zq-platform初始数据写不到数据库问题解决详细操作流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T07:29:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="翙翙其羽"/> <meta itemprop="url" content="https://juejin.cn/user/831702760173085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            zq-platform初始数据写不到数据库问题解决详细操作流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/831702760173085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    翙翙其羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:29:14.000Z" title="Thu Jan 22 2026 07:29:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我复现一下上面的操作说 zq-platform初始数据写不到数据库
第一次执行-</p>
<pre><code class="hljs language-nginx" lang="nginx">alembic revision --autogenerate -m "init tables"
</code></pre>
<h2 data-id="heading-0">报错</h2>
<pre><code class="hljs language-css" lang="css">INFO  <span class="hljs-selector-attr">[[            alembic.runtime.migration]</span>
          ](http://alembic.runtime.migration]) Context impl PostgresqlImpl.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Will assume transactional DDL.ERROR [[
            alembic.util.messaging]
          ](http://alembic.util.messaging]) Target database is not up to date.FAILED: Target database is not up to date.
</code></pre>
<p>意思是：你的数据库当前版本 (current) 落后于 Alembic 迁移脚本所定义的最新版本 (head)<a href="https://link.juejin.cn?target=http%3A%2F%2Fcnblogs.com%2B1%25E3%2580%2582%25E8%25BF%2599%25E5%25B0%25B1%25E5%25A5%25BD%25E6%25AF%2594%25E4%25BD%25A0%25E6%2589%258B%25E9%2587%258C%25E6%258B%25BF%25E7%259D%2580%25E7%259A%2584%25E6%2598%25AF%25E7%25AC%25AC3%25E7%2589%2588%25E7%259A%2584%25E8%25AF%25B4%25E6%2598%258E%25E4%25B9%25A6%25EF%25BC%258C%25E4%25BD%2586%25E4%25BA%25A7%25E5%2593%2581%25E5%25B7%25B2%25E7%25BB%258F%25E6%259B%25B4%25E6%2596%25B0%25E5%2588%25B0%25E7%25AC%25AC5%25E7%2589%2588%25E4%25BA%2586" target="_blank" title="http://cnblogs.com+1%E3%80%82%E8%BF%99%E5%B0%B1%E5%A5%BD%E6%AF%94%E4%BD%A0%E6%89%8B%E9%87%8C%E6%8B%BF%E7%9D%80%E7%9A%84%E6%98%AF%E7%AC%AC3%E7%89%88%E7%9A%84%E8%AF%B4%E6%98%8E%E4%B9%A6%EF%BC%8C%E4%BD%86%E4%BA%A7%E5%93%81%E5%B7%B2%E7%BB%8F%E6%9B%B4%E6%96%B0%E5%88%B0%E7%AC%AC5%E7%89%88%E4%BA%86" ref="nofollow noopener noreferrer">
cnblogs.com+1。这就好比你手里拿着的是第3版的说明书，但产品已经更新到第5版了
</a></p>
<p>要解决这个问题，核心思路就是将数据库的当前版本 (current) 更新到与最新的迁移脚本版本 (head) 一致。</p>
<h2 data-id="heading-1">1.查看当前数据库状态：首先，确认一下版本差异。在项目根目录下打开终端，依次运行：</h2>
<pre><code class="hljs language-nginx" lang="nginx">    # 查看数据库当前记录的版本    alembic current    # 查看所有可用的迁移脚本版本（head）    alembic heads
</code></pre>
<p>你通常会看到 current 的版本号比 heads 的版本号要旧，或者 heads 显示了多个分支（这通常意味着存在多个分支迁移需要合并）。
分别显示</p>
<pre><code class="hljs language-css" lang="css">INFO  <span class="hljs-selector-attr">[[            alembic.runtime.migration]</span>
          ](http://alembic.runtime.migration]) Context impl PostgresqlImpl.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Will assume transactional DDL.
</code></pre>
<p>这证实了问题所在：数据库当前停留在一个空版本，并没有处于最新状态，所以 Alembic 拒绝你生成新的迁移脚本。</p>
<h2 data-id="heading-2">请直接运行下面这条命令来解决这个问题：</h2>
<pre><code class="hljs language-bash" lang="bash">alembic upgrade <span class="hljs-built_in">head</span>
</code></pre>
<p>这个命令会扫描 alembic/versions 文件夹，找到所有脚本，并依次在数据库中执行它们。</p>
<h2 data-id="heading-3">执行结果：</h2>
<pre><code class="hljs language-css" lang="css">INFO  <span class="hljs-selector-attr">[[            alembic.runtime.migration]</span>
          ](http://alembic.runtime.migration]) Context impl PostgresqlImpl.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Will assume transactional DDL.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Running upgrade  -&gt; b6a31168d666, init tablesINFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Running upgrade b6a31168d666 -&gt; a79453452d83, add page design
</code></pre>
<p>数据库已经成功升级到最新版本了。从输出 Running upgrade b6a31168d666 -&gt; a79453452d83 可以看到：数据库已经更新到了 a79453452d83，</p>
<p>打开数据库可以看到当前版本号：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68efa9c9eee844ab925c73ac0a885cc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57-Z57-Z5YW25769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671753&amp;x-signature=Qu7lfMVa1eBnJyqqP6rmk30qb48%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">重新生成迁移：现在可以再次尝试运行 alembic revision --autogenerate -m “init tables”。</h2>
<pre><code class="hljs language-nginx" lang="nginx">alembic revision --autogenerate -m "init tables"
</code></pre>
<h2 data-id="heading-5">显示结果：</h2>
<pre><code class="hljs language-css" lang="css">INFO  <span class="hljs-selector-attr">[[            alembic.runtime.migration]</span>
          ](http://alembic.runtime.migration]) Context impl PostgresqlImpl.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Will assume transactional DDL.Generating F:\下载程序与源码\★★★可执行项目收集★★★\zq-platform\backend-fastapi\alembic\versions\<span class="hljs-number">588</span>[
            bd64ec92e_init_tables.py
          ](http://bd64ec92e_init_tables.py) ...  done
</code></pre>
<p>输出显示：Generating ... <a href="https://link.juejin.cn?target=http%3A%2F%2F588bd64ec92e_init_tables.py" target="_blank" title="http://588bd64ec92e_init_tables.py" ref="nofollow noopener noreferrer">
588bd64ec92e_init_tables.py
</a> ... done</p>
<p>这表示 Alembic 成功扫描了你的代码和数据库，并发现它们之间的差异，自动生成了一个新的迁移脚本文件：<a href="https://link.juejin.cn?target=http%3A%2F%2F588bd64ec92e_init_tables.py%25E3%2580%2582" target="_blank" title="http://588bd64ec92e_init_tables.py%E3%80%82" ref="nofollow noopener noreferrer">
588bd64ec92e_init_tables.py。
</a>接下来的步骤：让修改生效
现在脚本文件只是生成了，但数据库里的表结构还没变。你需要执行最后一步：</p>
<ol>
<li>查看生成的脚本（可选，但推荐）
你可以打开 alembic\versions[
9abfcdbaff03_init_tables.py
](http://9abfcdbaff03_init_tables.py) 看一眼。检查 upgrade() 函数里是否包含了 <a href="https://link.juejin.cn?target=http%3A%2F%2Fop.create_table(%25E2%2580%25A6)" target="_blank" title="http://op.create_table(%E2%80%A6)" ref="nofollow noopener noreferrer">
op.create_table(…)
</a> 等语句。如果那里是空的，说明 Alembic 没检测到你的模型变化，或者模型没有被正确导入。</li>
<li>更新数据库（必须执行）
在终端运行：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">alembic upgrade <span class="hljs-built_in">head</span>
</code></pre>
<p>这将会把刚才生成的脚本应用到你的 fastapi_db 数据库中，创建对应的表结构。</p>
<h2 data-id="heading-6">显示</h2>
<pre><code class="hljs language-css" lang="css">INFO  <span class="hljs-selector-attr">[[            alembic.runtime.migration]</span>
          ](http://alembic.runtime.migration]) Context impl PostgresqlImpl.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Will assume transactional DDL.INFO  [[
            alembic.runtime.migration]
          ](http://alembic.runtime.migration]) Running upgrade a79453452d83 -&gt; <span class="hljs-number">588</span>bd64ec92e, init tables
</code></pre>
<p>数据库迁移已经完全成功了！🎉</p>
<p>从输出 Running upgrade a79453452d83 -&gt; 588bd64ec92e 可以确认：</p>
<p>你的 fastapi_db 数据库已经成功应用了 init tables 脚本，所有定义的表结构现在都已经真实存在于数据库中了。
验证成果
如果你想确认表真的创建好了，可以：</p>
<p>1.打开 pgAdmin（如果你安装了的话）。</p>
<p>2.连接到 fastapi_db。</p>
<p>3.展开 Schemas -&gt; public -&gt; Tables。</p>
<p>4.你应该能看到刚才定义的所有数据表（比如 users 等）。</p>
<p>或者，你可以直接在 Python 代码中试着向数据库写入一条数据，看是否报错。</p>
<h2 data-id="heading-7">再执行python scripts/<a href="https://link.juejin.cn?target=http%3A%2F%2Floaddata.py" target="_blank" title="http://loaddata.py" ref="nofollow noopener noreferrer">
loaddata.py
</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Fdb_init.json%25EF%25BC%258C%25E5%25AF%25BC%25E5%2585%25A5%25E6%2595%25B0%25E6%258D%25AE%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0" target="_blank" title="http://db_init.json%EF%BC%8C%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%9C%8B%E5%88%B0" ref="nofollow noopener noreferrer">
db_init.json，导入数据，看到
</a></h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">导入完成:  成功: 38 条  失败: 0 条</span>
</code></pre>
<p>先不要激动！！！日志最后一句“导入完成: 成功 38 条 / 失败 0 条”是脚本自己打印的统计，并不真实——</p>
<p>只要发生 ROLLBACK，整个事务就被回滚，数据库里一条新数据也没有写进去。</p>
<h2 data-id="heading-8">真正的失败原因就是这一条：</h2>
<pre><code class="hljs language-python" lang="python">[
            asyncpg.exceptions.DataError:
          ](http://asyncpg.exceptions.DataError:)  invalid <span class="hljs-built_in">input</span> <span class="hljs-keyword">for</span> query argument $<span class="hljs-number">4</span>: <span class="hljs-string">'2026-01-11T19:44:39.752685'</span>  (expected a [
            datetime.date
          ](http://datetime.date) <span class="hljs-keyword">or</span> [
            datetime.datetime
          ](http://datetime.datetime) instance, got <span class="hljs-string">'str'</span>)
</code></pre>
<p>也就是 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcore_user.last_login" target="_blank" title="http://core_user.last_login" ref="nofollow noopener noreferrer">
core_user.last_login
</a> 字段传的是 字符串，而数据库列类型是 timestamp without time zone，异步驱动 asyncpg 不接受字符串隐式转换。</p>
<h2 data-id="heading-9">如何修复-</h2>
<pre><code class="hljs language-perl" lang="perl">def parse_datetime(value):    <span class="hljs-string">""</span><span class="hljs-string">"解析日期时间字符串"</span><span class="hljs-string">""</span>    <span class="hljs-keyword">if</span> isinstance(value, str):        <span class="hljs-comment"># 尝试多种日期时间格式        formats = [            "%Y-%m-%dT%H:%M:%S.%f",  # ISO 格式带微秒            "%Y-%m-%dT%H:%M:%S",      # ISO 格式不带微秒            "%Y-%m-%d %H:%M:%S.%f",   # 带微秒的空格分隔格式            "%Y-%m-%d %H:%M:%S",      # 不带微秒的空格分隔格式            "%Y-%m-%d",               # 仅日期格式        ]                for fmt in formats:            try:                return [</span>
            datetime.strptime(value,
          ](http:<span class="hljs-regexp">//da</span>tetime.strptime(value,) fmt)            except ValueError:                <span class="hljs-keyword">continue</span>                <span class="hljs-comment"># 如果以上格式都不匹配，尝试 fromisoformat        try:            return [</span>
            datetime.fromisoformat(value.replace(
          ](http:<span class="hljs-regexp">//da</span>tetime.fromisoformat(value.replace()<span class="hljs-string">"Z"</span>, <span class="hljs-string">"+00:00"</span>))        except ValueError:            pass                <span class="hljs-comment"># 如果所有尝试都失败，返回原始值        return value    return value    ......    # 转换日期时间字段                for key, value in [</span>
            fields.items():
          ](http:<span class="hljs-regexp">//</span>fields.items():)                    <span class="hljs-keyword">if</span> isinstance(value, str):                        <span class="hljs-comment"># 检查是否为日期时间格式的字符串                        parsed_value = parse_datetime(value)                        # 如果成功解析且返回的是 datetime 对象，则替换原值                        if isinstance(parsed_value, datetime):                            fields[key] = parsed_value</span>
</code></pre>
<p>再执行python scripts/<a href="https://link.juejin.cn?target=http%3A%2F%2Floaddata.py" target="_blank" title="http://loaddata.py" ref="nofollow noopener noreferrer">
loaddata.py
</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Fdb_init.json%25EF%25BC%258C%25E7%259B%25B4%25E8%2587%25B3%25E8%25BF%2599%25E4%25BA%259B%25E6%2595%25B0%25E6%258D%25AE%25E9%2583%25BD%25E5%25AF%25BC%25E5%2585%25A5%25E5%25AE%258C%25E6%2588%2590%25E3%2580%2582" target="_blank" title="http://db_init.json%EF%BC%8C%E7%9B%B4%E8%87%B3%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%E9%83%BD%E5%AF%BC%E5%85%A5%E5%AE%8C%E6%88%90%E3%80%82" ref="nofollow noopener noreferrer">
db_init.json，直至这些数据都导入完成。
</a></p>
<h2 data-id="heading-10">当看到-</h2>
<pre><code class="hljs language-sql" lang="sql">从文件导入数据: [
            db_init.json
          ](http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>db_init.json)读取到 <span class="hljs-number">38</span> 条记录<span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-20</span> <span class="hljs-number">17</span>:<span class="hljs-number">07</span>:<span class="hljs-number">52</span>,<span class="hljs-number">224</span> INFO [
            sqlalchemy.engine.Engine
          ](http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>sqlalchemy.engine.Engine) <span class="hljs-keyword">select</span> [
            pg_catalog.version()
          ](http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>pg_catalog.version())<span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-20</span> <span class="hljs-number">17</span>:<span class="hljs-number">07</span>:<span class="hljs-number">52</span>,<span class="hljs-number">225</span> INFO [
            sqlalchemy.engine.Engine
          ](http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>sqlalchemy.engine.Engine) [raw <span class="hljs-keyword">sql</span>] ().....<span class="hljs-number">.2026</span><span class="hljs-number">-01</span><span class="hljs-number">-20</span> <span class="hljs-number">17</span>:<span class="hljs-number">07</span>:<span class="hljs-number">52</span>,<span class="hljs-number">276</span> INFO [
            sqlalchemy.engine.Engine
          ](http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>sqlalchemy.engine.Engine) <span class="hljs-keyword">COMMIT</span>导入完成:  成功: <span class="hljs-number">38</span> 条  失败: <span class="hljs-number">0</span> 条
</code></pre>
<p>·脚本成功读取了 <a href="https://link.juejin.cn?target=http%3A%2F%2Fdb_init.json" target="_blank" title="http://db_init.json" ref="nofollow noopener noreferrer">
db_init.json
</a> 文件，识别出包含 38 条待导入的记录·SQLAlchemy 引擎成功连接到 PostgreSQL 数据库（日志中出现 <a href="https://link.juejin.cn?target=http%3A%2F%2Fpg_catalog.version()" target="_blank" title="http://pg_catalog.version()" ref="nofollow noopener noreferrer">
pg_catalog.version()
</a> 是 PostgreSQL 特有的查询）数据库验证
出现账号数据即为数据导入成功。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53abe2ed8ab04c82aa7af82863cd2c85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57-Z57-Z5YW25769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769671753&amp;x-signature=DX3wZdh4jqySDz%2BPyaar3Q2FL8Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">启动服务-</h2>
<pre><code class="hljs language-css" lang="css">python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>或使用 uvicornuvicorn <span class="hljs-selector-tag">main</span>:app --reload --host <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> --port <span class="hljs-number">8000</span>
</code></pre>
<p>这样初始数据写不到数据库问题就可以得到根本解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vivo互联网全链路多版本环境落地实践]]></title>    <link>https://juejin.cn/post/7597905961663496198</link>    <guid>https://juejin.cn/post/7597905961663496198</guid>    <pubDate>2026-01-22T07:38:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597905961663496198" data-draft-id="7597946284678545427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vivo互联网全链路多版本环境落地实践"/> <meta itemprop="keywords" content="后端,设计模式,测试"/> <meta itemprop="datePublished" content="2026-01-22T07:38:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo互联网技术"/> <meta itemprop="url" content="https://juejin.cn/user/993614243303053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vivo互联网全链路多版本环境落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243303053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo互联网技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:38:06.000Z" title="Thu Jan 22 2026 07:38:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：互联网效能平台团队-Wu Qinghua<br/>
在软件研发过程中，“环境问题”是制约研发效能的关键瓶颈之一。环境不稳定、测试环境混乱、环境抢占严重等问题，显著影响开发与测试效率。本文系统介绍vivo通过“全链路多版本环境管理”模式，实现开发测试环境的快速构建与高效管理，使多版本环境能够像“平行宇宙”一般，实现安全、隔离、高效的并行测试与发布。</p>
</blockquote>
<p>本文为2025年 vivo 开发者大会互联网技术专场分享内容之一，在公众号“vivo互联网技术”对话框回复【2025VDC】获取 2025VDC 互联网技术会场议题相关资料。</p>
<p>1分钟看图掌握核心观点👇</p>
<p><img src="https://pic-out.zhimg.com/v2-b3f1daf5c84dc9c3e04eebb870db171e~resize:1440:q75.gif?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-0a1f581e6db06623515317108f2fd66b&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/><img src="https://pic-out.zhimg.com/v2-393d6784e67498c7ac8907dac51b5894~resize:1440:q75.jpg?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-6d0129737f46ea0f2b85750b29930b5d&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p><em>图1 VS 图2，您更倾向于哪张图来辅助理解全文呢？欢迎在评论区留言</em></p>
<h2 data-id="heading-0">一、背景&amp;问题</h2>
<h2 data-id="heading-1">1.1 我们遇到的问题</h2>
<p>在软件研发过程中，环境问题常常成为关键路径上的阻塞点。2020年vivo某核心业务数据显示，因测试环境问题导致的转测延期占比高达67%，策划验收阶段因环境问题导致的延期超过10次。</p>
<p><img src="https://pic-out.zhimg.com/v2-865c249a1cb489c96c05aae3de3d08d7~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-4ed7aabee3efd172583702164e480136&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>这些数据背后，反映的是研发过程中常见的典型场景：</p>
<ul>
<li>场景一：急需联调时，依赖服务异常，导致研发阻塞；</li>
<li>场景二：准备测试时，环境被其他版本占用，需求排期被迫延后；</li>
<li>场景三：环境配置差异导致线上Bug漏测，引发更多问题。</li>
</ul>
<p>深入分析该业务场景后，我们发现环境问题主要集中在以下几个方面：<strong>环境不稳定、测试环境混乱、环境抢占严重、资源利用率低下</strong>。这些问题并非单一项目特有，在微服务架构和快速迭代模式下，已成为多个团队共同面临的挑战。</p>
<h2 data-id="heading-2">1.2 问题的挑战</h2>
<p>随着vivo互联网业务的快速发展，为满足更快发布需求，我们全面转向微服务架构。这一转变在提升灵活性与敏捷性的同时，也带来了新的管理挑战。</p>
<p><img src="https://pic-out.zhimg.com/v2-10b1aab4a2aca3d13a2ce3eab59f4753~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-96b84c741055d51220ecf7036245afa3&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>挑战主要来自两个维度：</p>
<ul>
<li>**架构层面：**服务拆分导致服务数量激增，各服务需独立部署维护，系统调用链路显著延长，任一环节故障都可能导致整体功能不可用。</li>
<li>**流程层面：**业务快速迭代需求推动多版本并行推进，如版本A测试、版本B功能开发、版本C线上热修复等同步进行。</li>
</ul>
<p>这些变化叠加，使得研发环境管理复杂度大幅提升，环境稳定性下降、资源浪费严重，最终导致整体研发效率受损。</p>
<p>传统环境管理方式已难以满足当前需求，亟需一种创新方法，实现多版本像“平行宇宙”一样安全、隔离、高效地并行测试与发布。</p>
<h2 data-id="heading-3">二、解决方案思路</h2>
<h2 data-id="heading-4">2.1 什么叫全链路多版本环境管理</h2>
<p>为解决环境管理难题，我们提出了“全链路多版本环境管理”理念，其核心基于三大关键能力：</p>
<p><img src="https://pic-out.zhimg.com/v2-feb0358ba17d4e845cbc5c9b4c75d236~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-c4bb6678931862d6af692b27a2337f67&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p><strong>1.全链路能力</strong></p>
<p>单一服务版本环境不足以保证整体功能验证。必须确保版本依赖的所有组件——从前端、网关到微服务，再到数据库、缓存和消息队列——整条链路能够一键拉起、快速就绪。以支付业务调试为例，无需手动启动账户、风控、结算等服务，通过一键操作即可分钟级生成完整环境，数据流、配置流与生产环境保持一致。</p>
<p><strong>2.多版本并行</strong></p>
<p>支持同时创建多个“完整环境”，使各版本在独立“沙箱”中运行，彻底解决资源抢占问题。热修复版本可分钟级拉起独立环境，新功能开发同步进行，实现“分钟级响应，零等待协作”。</p>
<p><strong>3.环境自动化管理</strong></p>
<p>通过全生命周期自动化——从环境搭建、弹性伸缩到闲置回收，减少人工干预，降低错误率，提升资源利用效率，实现降本增效。</p>
<p>基于这三项核心能力，线上问题或紧急需求出现时，我们可在几分钟内创建独立环境进行验证，且不影响其他版本进程。</p>
<h2 data-id="heading-5">2.2 业务目标示意图</h2>
<p>理解全链路多版本环境管理理念后，我们的核心解决思路也从传统的“环境隔离”转向“流量隔离”模式。</p>
<p><img src="https://pic-out.zhimg.com/v2-ecc909fae480a381074f4ddea99bde4e~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-9ad33dba34123062dd14745fc612cd4c&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>传统方式为每个版本构建完整独立的测试环境，如同各自独立的烟囱。此方式隔离性好，但资源浪费严重，环境数量有限，扩展性差。</p>
<p>全链路多版本环境管理方案则采用不同策略：首先维护稳定可靠的公用基线环境。当某版本需开发新功能时，无需从头搭建整套环境，仅需为实际发生变更的服务创建独立的“特性环境”。</p>
<p>关键问题在于如何实现流量的精准路由。答案在于流量统一网关平台，该系统在流量入口识别每个请求的环境标签，根据标签将请求路由至对应版本的服务实例。</p>
<p>未改动服务继续共享稳定基线环境，发生变更的服务则拥有独立环境——通过流量精准调度，既保证隔离性，又显著节约资源与成本。</p>
<p>这一模式类似于单栋大楼内通过不同颜色手环区分访问区域，整栋楼共享基础设施，但各区域活动互不干扰。流量统一网关平台充当“智能前台”，负责识别“手环”、调度流量，使多版本并行开发井然有序。</p>
<p><strong>“逻辑隔离”相较于“物理隔离”展现出显著优势：更弹性、更经济、更高效。</strong></p>
<h2 data-id="heading-6">2.3 全链路多版本业务架构图</h2>
<p>基于上述思路，我们构建了完整的技术架构，清晰展示系统核心组件及协同工作机制。</p>
<p><img src="https://pic-out.zhimg.com/v2-ce0374c62efd3968599202863614720e~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-82101d515c362626defb57f2d027dbaa&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>全链路多版本环境的核心能力可归纳为四个关键部分：环境编排、流量隔离、容器部署与分布式链路系统。</p>
<p>**环境编排：**负责组织软件从开发到部署各环节，确保每次代码变更快速部署至指定环境。在多版本环境中，编排系统自动识别不同版本，触发对应构建部署流程，保证各版本独立高效就绪。</p>
<p>**流量隔离：**实现多版本并行的关键。通过灵活路由策略，精确控制各版本流量走向。无论是HTTP请求、Dubbo调用还是MQ消息，均能在各自服务实例间有序流转、互不干扰，如同智能交通系统确保不同“车流”各行其道。</p>
<p>**容器部署：**为环境提供轻量、标准化封装方式，各服务及其依赖打包为独立镜像。借助容器技术，实现应用秒级启动与弹性伸缩。多版本场景下，各版本可快速拉起自身实例组，极大提升资源利用率与发布效率。</p>
<p>**分布式链路系统：**架构的“可观测性”基础，实时追踪记录请求在微服务间的完整流动路径并传递环境标签。当请求进入系统，经多服务处理时，该系统完整记录其“足迹”——包括经过服务、携带标签、是否异常，为问题排查与性能优化提供关键支撑。</p>
<p>接下来，我们将深入解析全链路多版本环境背后的三大关键技术实现。</p>
<h2 data-id="heading-7">三、关键技术实现</h2>
<p>从实现视角聚焦，核心技术主要包括：</p>
<ul>
<li>环境编排 - 负责指挥与创造</li>
<li>资源弹性 - 负责支撑与供给</li>
<li>流量隔离 - 负责识别与路由</li>
</ul>
<p>三大技术形成有机整体，紧密协作，缺一不可。</p>
<p><img src="https://pic-out.zhimg.com/v2-5501c2091c83ce7ba57a9cc915fe9e2d~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-4af044e65cf6b7260f9f68ec05cde2e4&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">3.1 环境编排</h2>
<p><img src="https://pic-out.zhimg.com/v2-af553106b0392ad39017282cee74ca0b~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-1ccb49092ac8441cb3f5a90b4dd1c340&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>实现多版本并行的第一步是高效、标准化地“创建环境”。</p>
<p>这主要由CI/CD平台支撑，它不仅是自动化工具，更是强大的可视化环境编排器。开发人员在界面定义待部署服务，系统自动识别服务间依赖关系，判断哪些可并行部署、哪些需串行执行，最终实现“一键完成”环境编排。</p>
<p>优势显而易见：无论是全新版本环境搭建，还是单一服务更新，均可通过单次点击，在分钟级别快速完成，使“秒级拉起独立完整环境”成为研发流程常态。</p>
<p>具体而言，CI/CD平台在全链路多版本中提供两方面关键支撑：</p>
<ul>
<li>**全链路能力支持：**实现代码提交到自动化验证的端到端集成，确保各环境配置一致，大幅减少环境差异问题。同时精细管理微服务间依赖，支持串并行混合执行，使复杂部署流程井然有序。</li>
<li>**多版本并行支持：**平台根据代码分支自动触发独立构建部署流程，为各版本创建隔离环境、添加环境标签，实现环境高效复用与隔离。底层对接强大容器化平台，为环境快速启动提供技术保障。</li>
</ul>
<p>CI/CD平台作为多版本环境体系的“指挥中心”，高效调度四大核心组件——为容器部署提供调度依据，为流量隔离准备环境标签，使分布式链路系统充分发挥跟踪与观测能力。</p>
<h2 data-id="heading-9">3.2 弹性资源</h2>
<p><img src="https://pic-out.zhimg.com/v2-04491f1904b27f4536c567cce33131f5~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-83ce4b0e0fcae82035e548d3cfc7df6a&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>指令发出后，需要强健的“执行体”高效落实。vivo容器化平台正是这一强大、可靠的实体。</p>
<p>弹性资源能力由容器化平台核心支撑。全链路多版本环境中，我们能够轻松、快速创建大量隔离环境，背后依赖的正是容器技术。</p>
<p>**容器化工作原理简述：**开发者将应用及其所有依赖打包为标准容器镜像。该镜像可在任何支持容器的环境中运行，确保开发、测试、预发和生产环境高度一致，真正实现“一次构建，随处运行”，从根源解决环境差异问题。</p>
<p>资源利用率方面，容器技术优势明显。传统虚拟机部署中，单节点通常仅运行单一应用，资源利用率低。容器化部署允许多个容器共享节点操作系统内核，轻量高效。对多版本环境管理而言，这意味着可低成本、高效率创建大量隔离环境。以往需10台服务器支撑的多版本测试，现仅需3-4台，成本显著降低。</p>
<p>此外，容器平台具备自动扩缩容能力，这在多版本场景中尤为重要：特性环境压力测试时，系统自动扩容保障稳定性；测试结束环境闲置时，资源自动缩容回收，真正实现按需使用、高效节能。</p>
<p>容器化带来三大核心价值：环境标准化、资源高效化与伸缩自动化。这些能力组合使我们能够轻松维护多版本并行研发，加速产品迭代，提高系统稳定性，同时显著降低成本。</p>
<p>对业务团队而言，这意味着更快功能交付、更稳定系统运行与更高资源利用率。这是全链路多版本环境支撑大量环境并行而无需担忧资源成本激增的根本原因。</p>
<h2 data-id="heading-10">3.3 流量隔离&amp;流量染色</h2>
<p>环境与资源就绪后，确保流量“对号入座”是实现隔离性的关键。这引出两个核心概念：“流量隔离”与“流量染色”。</p>
<h3 data-id="heading-11">3.3.1 流量隔离和流量染色的定义</h3>
<p><strong>流量隔离</strong>指由统一流量网关平台维护智能路由表，记录“环境标签”与“服务实例地址”间映射关系。</p>
<p><img src="https://pic-out.zhimg.com/v2-a922420feeb8203a55fdc635db3d89e6~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-0266178a491187fde6630959ab0aa176&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>如图示：Feature1环境流量仅路由至IP1、IP2实例；Feature2流量指向IP3、IP4实例，实现真正互不干扰。</p>
<p><strong>流量染色</strong>如同为每批流量分配“颜色标识”。请求进入网关前，为其添加明确环境标识，声明“属于Feature1”或“属于Feature2”。网关据此正确识别与路由。</p>
<p>理解流量隔离与染色后，需将其应用于真实网络环境。微服务架构下，流量基本分为两类：南北流量与东西流量。</p>
<p>图示说明：</p>
<ul>
<li>**南北流量：**外部客户端与服务器间流量，即“进出数据中心流量”；</li>
<li>**东西流量：**数据中心内部服务器间流量，即微服务间调用。</li>
</ul>
<p>在vivo实践中：</p>
<ul>
<li>HTTP流量由vivo统一访问平台处理；</li>
<li>Dubbo流量由Dubbo服务治理平台负责；</li>
<li>MQ消息通过MQ消息网关平台路由。</li>
</ul>
<h3 data-id="heading-12">3.3.2 流量隔离实现</h3>
<p><img src="https://pic-out.zhimg.com/v2-bdfa61ee517a04b1db09a989cc9b99f4~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-897a9937ff2ec8b8ee4a7fe6c3e1080a&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p><strong>1.HTTP流量隔离</strong></p>
<p>过程如图绿色路径所示。始于环境编排阶段：通过流水线部署服务时，为各实例注入唯一环境标签。同时，vivo统一访问平台建立“环境标签”与后端服务实例组（Upstream）的绑定关系，触发创建相应CRD并实施监听。</p>
<p>此后，无论是部署、实例扩容、缩容还是重启，只要实例IP和端口变化，变更都会被实时监听并动态更新至网关路由规则，形成高效自动化闭环，确保每个带环境标签的HTTP请求被网关精准路由至正确特性环境实例。</p>
<p><strong>2.DUBBO协议隔离</strong></p>
<p>借助Dubbo官方原生标签路由能力实现。原理直观：将服务实例动态划分至不同逻辑分组，约束带特定标签流量仅能访问指定分组。vivo实践中，打标动作发生于部署环节。容器启动时，Init Container自动调用Dubbo服务治理平台，通过动态规则配置，无感地为当前服务实例添加环境标签。整个过程无需重启服务，配置实时生效，完美支持全链路多版本对灵活性与实时性要求。</p>
<p><strong>3.消息队列（MQ）隔离</strong></p>
<p>与前两者不同，MQ组件本身缺乏完善隔离机制。我们基于MQ消息网关平台mq-proxy组件实现。</p>
<p>实现方式巧妙：生产者与消费者启动并与mq-proxy建立连接时，在连接属性中携带自身环境标签。消息生产时，mq-proxy拦截消息，将环境标签写入消息user-property中。消费时，mq-proxy根据消息中标签与消费者自身环境标签进行匹配过滤，确保消息不会被跨环境消费。整个过程对业务代码完全透明，实现无侵入隔离。</p>
<h3 data-id="heading-13">3.3.3 流量染色实现</h3>
<p><img src="https://pic-out.zhimg.com/v2-a86ea039244e980d0e63b2581a3ee15b~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-728fe379ff538dfbac95f380bd30b605&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>**南北流量染色：**客户端至服务器端流量染色实现方式如下。</p>
<ul>
<li>**HTTP请求：**在请求头中添加环境信息，推荐使用ModHeader等浏览器插件，便捷地在请求头中添加env_tag=feature1等信息。</li>
<li>**Dubbo调用：**将环境标签置于Attachment中，提供简洁API，开发者只需在发起调用前，通过RpcContext.setAttachment("dubbo.tag","feature1")代码即可设置环境标签，对业务代码侵入性极低。</li>
<li>**MQ流量染色：**对业务方完全透明，由前述mq-proxy组件自动完成，业务代码无感知。</li>
</ul>
<p><img src="https://pic-out.zhimg.com/v2-4398737ec2038b0aceecb41ab4fa42dc~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-48745f5d8a8a4e791087fe6dde4f191c&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>**具体实现：**生产者与消费者启动时，与mq-proxy建立连接，使用连接属性v-env-tag存放环境标签，即图示中间启动部分。消息生产消费环节中，生产者生产消息时，mq-proxy拦截消息，将环境标签写入消息user-property中。</p>
<p>消息消费端，mq-proxy拉取消息时，获取消息中环境标签信息并进行过滤，推送至对应环境服务实例，确保仅消费属于当前环境的消息。通过此机制，保证消息在整个生命周期携带环境标识，实现MQ流量染色。</p>
<h3 data-id="heading-14">3.3.4 标签的传递</h3>
<p><img src="https://pic-out.zhimg.com/v2-2d66007e2afc694213d2f4759988ebf5~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-527d53b39cd37031b5794e8dd111bcdc&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>最复杂部分在于环境标签在整条调用链中<strong>自动传递</strong>。通过vivo分布式链路系统实现，核心技术为javaagent，通过调用链Agent透明完成此项“接力”工作。</p>
<p>示例如下：来自客户端的HTTP请求携带env_tag=feature1，网关将其路由至feature1环境的用户中心。用户中心需调用积分中心时，调用链Agent拦截此次Dubbo调用，从HTTP请求头中获取env_tag，并注入Dubbo调用的Attachment中，积分中心因此收到该标签。积分中心处理完毕，需发送MQ消息通知活动中心。此时Agent再次拦截，从Dubbo Attachment中获取标签，写入MQ消息属性。最终，仅标注feature1的活动中心实例消费此消息。整条链路中，如有环节未匹配环境标签，流量则回退至基线环境。</p>
<p>如此，环境标签在HTTP→Dubbo→MQ完整链路中自动传递，确保全链路环境隔离，真正实现“一次染色，全程生效”。</p>
<p>回顾关键技术部分：**环境编排是指挥中心，负责调度与创造；弹性资源是执行实体，负责支撑与运行；流量隔离与染色是传导系统，负责精准识别与路由。**三者有机结合，构成全链路多版本环境管理的稳固架构，缺一不可。</p>
<h2 data-id="heading-15">四、业务实践与效果</h2>
<p>全链路多版本环境落地实践后，成效显著：</p>
<p><img src="https://pic-out.zhimg.com/v2-57d133ab60e1eb74f392acd0391623e3~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-47cf519778015e601c2ea6e1b7aad805&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<ul>
<li>**环境搭建效率提升：**从过去多团队沟通、手动配置、平均耗时2人天，转变为开发者一键触发、分钟级自动完成。</li>
<li>**版本并发能力增强：**以往受资源限制，仅支持2-3个版本串行测试；现可轻松支持9个以上特性环境并行开发测试。</li>
</ul>
<p>这不仅带来效率提升，更实现研发节奏全面加速与业务响应能力质的飞跃。</p>
<h2 data-id="heading-16">五、未来规划</h2>
<p>展望未来，我们对全链路多版本环境管理有清晰规划。这不仅是技术升级，更是研发管理理念的演进。</p>
<p><img src="https://pic-out.zhimg.com/v2-94c229e708831af52583451089a2abd3~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769067117-0-0-779019ca7e95c8ed143b9dc0dc98dfdc&amp;bizSceneCode=article_draft&amp;expiration=1769067117&amp;incremental=false&amp;mid=f9f550d3db68b8e79861d6625bbfd2e2&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>未来规划采用双轨并行策略，从研发效能环境标准化与资源成本高效化两个维度同步推进。两方向相互促进、协同支撑。</p>
<h2 data-id="heading-17">5.1 研发效能环境标准化</h2>
<p>在已实现的环境编排、资源弹性与流量隔离基础上，重点推进三项关键措施：</p>
<p><strong>1. 构建环境即服务平台</strong></p>
<p>平台提供标准化环境模板，包括不同规模测试环境及各类专用环境（如性能测试、安全测试等）。通过模板化方式，确保环境一致性与标准化，同时大幅提升环境创建效率。</p>
<p>平台集成环境全生命周期管理功能，从环境申请、审批、创建、使用、监控到回收，形成完整闭环管理。这不仅提升管理效率，更建立完善的环境治理体系。</p>
<p><strong>2. 建立全链路环境监控与可观测体系</strong></p>
<p>监控体系涵盖多层：基础设施层监控CPU、内存、存储等资源使用；中间件层监控数据库、消息队列、缓存等组件性能；应用层监控服务响应时间、错误率、吞吐量等关键指标。</p>
<p>通过分层监控，快速识别环境中异常情况，及时发觉性能瓶颈，为环境优化提供数据支撑。监控数据同时为资源调度与成本优化提供重要决策依据。</p>
<p><strong>3. 建立环境治理与合规自动化机制</strong></p>
<p>治理机制包括环境命名规范、资源配置标准、安全配置要求、数据保护规则等多方面。通过自动化合规检查工具，实时监控环境合规状态，自动发现与修复不合规配置。</p>
<p>机制还包括环境定期审计功能，自动生成合规报告，为管理决策提供支撑。通过此方式，既确保环境安全合规，又减少人工审计工作量。</p>
<h2 data-id="heading-18">5.2 资源成本高效化</h2>
<p>资源成本高效化方面，推进以下两项关键措施：</p>
<p><strong>1. 非活跃环境自动回收</strong></p>
<p>针对非活跃环境，建立智能自动回收机制。系统自动识别长期未使用环境，在确保数据安全前提下，自动进行资源回收。</p>
<p>机制包含多层管理：</p>
<ul>
<li>测试环境非工作时间自动休眠；</li>
<li>开发环境连续7天未使用发出提醒；</li>
<li>连续14天未使用自动回收。</li>
</ul>
<p>通过分层管理，既保证开发效率，又有效控制成本。</p>
<p><strong>2. 成本可视化与归因分析</strong></p>
<p>成本分析从多维度展开：</p>
<ul>
<li>按<strong>项目</strong>维度分析各项目资源使用成本；</li>
<li>按<strong>团队</strong>维度分析各团队成本构成；</li>
<li>按<strong>环境类型</strong>维度分析不同环境成本效益；</li>
<li>按<strong>时间</strong>维度分析成本变化趋势等。</li>
</ul>
<p>通过精确成本统计与分析，为成本优化提供数据支撑。</p>
<p>通过双轨并行策略，我们实现研发效能提升与资源利用最大化的良性循环。</p>
<p>全链路多版本环境管理的未来规划不仅是技术升级，更是研发管理理念的转变。通过双轨并行策略，我们将建立更高效、经济、可靠的研发环境体系，同时打造更先进的研发环境管理体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列模块化 [4 - 3]：复杂组件的通信与组合模式]]></title>    <link>https://juejin.cn/post/7597758250826088458</link>    <guid>https://juejin.cn/post/7597758250826088458</guid>    <pubDate>2026-01-22T05:44:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597758250826088458" data-draft-id="7597746812440444966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列模块化 [4 - 3]：复杂组件的通信与组合模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T05:44:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列模块化 [4 - 3]：复杂组件的通信与组合模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T05:44:01.000Z" title="Thu Jan 22 2026 05:44:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>在封装复杂组件时，习惯使用**“配置对象驱动”**的模式。</p>
<p>比如写一个 Tabs 组件，他们会定义一个 <code>items</code> 属性，让用户传入一个数组：<code>[{ title: 'A', content: '...' }]</code>。 这种写法看似简洁，实则是<strong>架构的死胡同</strong>。一旦用户说：“我想在第二个 Tab 的标题旁边加个红点”，或者“我想让第三个 Tab 的内容懒加载”，你的组件 API 就会瞬间爆炸，变成 <code>renderTitle</code>、<code>lazyLoad</code> 等无数个补丁属性。</p>
<p><strong>直觉告诉我们：好的组件 API 应该是声明式的，而不是配置式的。</strong></p>
<p>本篇我们将探讨如何通过<strong>复合组件（Compound Components）模式重建父子关系，利用隐式状态共享</strong>消灭 Props Drilling，并最终通过<strong>控制反转</strong>实现组件能力的无限扩展。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/790e017d3d81469e95498df471e9d981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769665441&amp;x-signature=O12bJutxnpMHara7QZZw2Axtb2Y%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 拒绝巨型配置：复合组件 (Compound Components) 的哲学</h2>
<p>复合组件模式的核心思想是：<strong>组件不应该是一个黑盒，而应该是一组协同工作的零件。</strong></p>
<h3 data-id="heading-1">1.1 什么是复合组件？</h3>
<p>看看 HTML 原生的 <code>&lt;select&gt;</code> 和 <code>&lt;option&gt;</code>，这就是世界上最古老且完美的复合组件：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">&lt;<span class="hljs-keyword">select</span>&gt;
  &lt;<span class="hljs-keyword">option</span> value=<span class="hljs-string">"1"</span>&gt;<span class="hljs-keyword">Option</span> A&lt;/<span class="hljs-keyword">option</span>&gt;
  &lt;<span class="hljs-keyword">option</span> value=<span class="hljs-string">"2"</span>&gt;<span class="hljs-keyword">Option</span> B&lt;/<span class="hljs-keyword">option</span>&gt;
&lt;/<span class="hljs-keyword">select</span>&gt;
</code></pre>
<p>它们分开写，但共享同一个状态（当前选中的值）。</p>
<h3 data-id="heading-2">1.2 实战：重构 Tabs 组件</h3>
<p><strong>错误示范（配置式）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">//  扩展性极差，只能通过增加 props 来修补
&lt;Tabs 
  <span class="hljs-attr">items</span>={[{ title: <span class="hljs-string">'Tab 1'</span>, content: <span class="hljs-string">'Content 1'</span> }]} 
  <span class="hljs-attr">activeTabColor</span>=<span class="hljs-string">"red"</span>
  <span class="hljs-attr">renderTitle</span>={(title) =&gt; &lt;span&gt;{title}&lt;/span&gt;} // 丑陋的补丁
/&gt;
</code></pre>
<p><strong>架构级示范（复合式）：</strong></p>
<pre><code class="hljs language-xml" lang="xml">// 声明式，结构清晰，用户拥有完全的渲染控制权
<span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">defaultIndex</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{console.log}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.List</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Tab</span>&gt;</span>Tab 1<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Tab</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Tab</span> <span class="hljs-attr">disabled</span>&gt;</span>Tab 2<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Tab</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Tab</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Badge</span>&gt;</span>Tab 3<span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span> {/* 用户可以随意组合 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Tab</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.List</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Panels</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Panel</span>&gt;</span>Content 1<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Panel</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Panel</span>&gt;</span>Content 2<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Panel</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Panel</span>&gt;</span>Content 3<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Panel</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Panels</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>
</code></pre>
<p><strong>底层实现原理：</strong> 这不仅仅是把组件切开那么简单。为了让 <code>&lt;Tabs.Tab&gt;</code> 知道自己是否被选中，我们需要使用 <strong>Context</strong> 进行<strong>隐式状态通信</strong>。 父组件 <code>&lt;Tabs&gt;</code> 创建一个 Context，向下广播 <code>activeIndex</code> 和 <code>setActiveIndex</code>。子组件自动订阅，无需用户显式传递。</p>
<hr/>
<h2 data-id="heading-3">二、 隐形纽带：Context Module Pattern (模块化上下文)</h2>
<p>在复合组件中，Context 是胶水。但架构师要注意：<strong>不要把 Context 暴露给全世界。</strong></p>
<h3 data-id="heading-4">2.1 作用域污染的风险</h3>
<p>如果你在全局定义了一个 <code>TabContext</code> 并导出，很可能会被其他组件误用，或者在嵌套的 Tabs 中发生冲突（内层 Tab 消费了外层 Tab 的 Context）。</p>
<h3 data-id="heading-5">2.2 最佳实践：创建自定义 Scope</h3>
<p>参考 Radix UI 或 React Spectrum 的设计，我们应该为每个复合组件创建独立的 Context Scope。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码：构建受保护的 Context</span>
<span class="hljs-keyword">const</span> [<span class="hljs-title class_">TabsProvider</span>, useTabsContext] = <span class="hljs-title function_">createContextScope</span>(<span class="hljs-string">"Tabs"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TabsRoot</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-comment">// ... 状态逻辑</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TabsProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{state}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">TabsProvider</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Tab</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-comment">// 只能在 TabsRoot 内部使用，否则报错</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useTabsContext</span>(<span class="hljs-string">"Tab"</span>); 
  <span class="hljs-keyword">return</span> ...;
}
</code></pre>
<p>这种模式保证了组件的<strong>自洽性</strong>。用户不需要关心 <code>Tabs</code> 内部是怎么通信的，他们只管像拼乐高一样组合组件。</p>
<hr/>
<h2 data-id="heading-6">三、 终极控制权：State Reducer (状态归约器)</h2>
<p>当你封装了一个通用组件，总会遇到这种需求：</p>
<ul>
<li>“我想让 Modal 点击遮罩层关闭，但按下 ESC 键时不关闭。”</li>
<li>“我想让 Switch 开关只能打开，不能关闭（一次性锁死）。”</li>
</ul>
<p>初级做法是加 Props：<code>closeOnEsc={false}</code>, <code>preventToggleOff={true}</code>。 <strong>高级做法是：Inversion of Control (控制反转)。</strong></p>
<p>借鉴 Redux 的思想，我们可以允许用户传入一个 <code>stateReducer</code>，拦截并篡改组件内部的状态更新。</p>
<p>JavaScript</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 组件内部实现</span>
function useToggle({ reducer = (state, action) =&gt; action.changes }) {
  <span class="hljs-keyword">const</span> [<span class="hljs-keyword">on</span>, setOn] = useState(<span class="hljs-keyword">false</span>);
  
  <span class="hljs-keyword">const</span> toggle = () =&gt; {
    <span class="hljs-comment">// 在更新前，先问问用户的 reducer</span>
    <span class="hljs-keyword">const</span> changes = { <span class="hljs-keyword">on</span>: !<span class="hljs-keyword">on</span> };
    <span class="hljs-keyword">const</span> finalState = reducer(<span class="hljs-keyword">on</span>, { type: <span class="hljs-string">'TOGGLE'</span>, changes });
    setOn(finalState.<span class="hljs-keyword">on</span>);
  };
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 用户使用：彻底改变组件行为，而无需修改组件源码</span>
&lt;Toggle 
  stateReducer={(state, action) =&gt; {
    <span class="hljs-comment">// 拦截：如果是点击操作且想要关闭，则阻止</span>
    <span class="hljs-keyword">if</span> (action.type === <span class="hljs-string">'TOGGLE'</span> &amp;&amp; state.<span class="hljs-keyword">on</span> === <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-keyword">on</span>: <span class="hljs-keyword">true</span> }; <span class="hljs-comment">// 强制保持开启</span>
    }
    <span class="hljs-keyword">return</span> action.changes; <span class="hljs-comment">// 否则默认行为</span>
  }} 
/&gt;
</code></pre>
<p><strong>架构价值：</strong> <code>stateReducer</code> 模式将**“状态更新的逻辑”**从组件内部剥离出来，交给了使用者。这使得组件能够适应极其边缘的业务场景，而无需增加任何 API 负担。</p>
<hr/>
<h2 data-id="heading-7">四、 哲学思辨：受控与非受控的完美共存</h2>
<p>这是组件设计中最经典的难题：<strong>State 到底应该由组件自己管（非受控），还是由父组件管（受控）？</strong></p>
<ul>
<li><strong>非受控 (Uncontrolled):</strong> <code>&lt;input defaultValue="hello" /&gt;</code>。简单，不需要写 onChange，但父组件很难干预。</li>
<li><strong>受控 (Controlled):</strong> <code>&lt;input value={val} onChange={setVal} /&gt;</code>。灵活，但父组件必须维护状态，哪怕是很简单的场景。</li>
</ul>
<p><strong>架构师的答案：Hybrid (混合模式)。</strong> 优秀的组件库（如 AntD, MUI）都支持“双模式”。</p>
<h3 data-id="heading-8">4.1 混合 Hook 的实现机制</h3>
<p>你需要实现一个 <code>useControllableState</code>：</p>
<ol>
<li>检查用户是否传入了 <code>value</code> 属性。</li>
<li>如果传入了 <code>value</code>，则判定为<strong>受控模式</strong>，内部状态直接引用 <code>value</code>，<code>setState</code> 只触发 <code>onChange</code>。</li>
<li>如果没传，则判定为<strong>非受控模式</strong>，内部维护 <code>useState</code>，<code>setState</code> 既更新内部状态也触发 <code>onChange</code>。</li>
</ol>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完美的组件接口</span>
&lt;<span class="hljs-title class_">Tabs</span> /&gt; <span class="hljs-comment">// 模式 A: 内部自己玩，非受控</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{setIndex}</span> /&gt;</span></span> <span class="hljs-comment">// 模式 B: 外部完全控制，受控</span>
</code></pre>
<p>这种兼容性设计，是区分“玩具组件”和“工程级组件”的重要分水岭。</p>
<hr/>
<h2 data-id="heading-9">五、 结语：组件设计的冰山之下</h2>
<p>当我们谈论组件化时，不要只盯着 UI 看。 Headless UI 解决了<strong>垂直方向</strong>的逻辑剥离，而 Compound Components 和 State Reducer 解决了<strong>水平方向</strong>的通信与扩展。</p>
<p>一个优秀的架构师，在设计组件时，脑海里不应该只有 DOM 结构，而应该是一张张<strong>状态流转图</strong>。</p>
<p>至此，我们已经搭建好了组件的“骨架”。但一个活的系统，还需要血液的流动——即模块与模块之间如何解耦通信？ 除了 props 和 context，我们是否还有更强大的武器来应对跨模块的复杂联动？</p>
<blockquote>
<p><strong>Next Step:</strong> 下一节，我们将进入“灵魂”篇，探讨前端设计模式中最经典、也最容易被滥用的模式。 请看**《第四篇：灵魂（上）——解耦的神器：前端核心设计模式之观察者与发布订阅》**。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI不止工具：积累资产 + 创造未来]]></title>    <link>https://juejin.cn/post/7597973595130380340</link>    <guid>https://juejin.cn/post/7597973595130380340</guid>    <pubDate>2026-01-22T07:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597973595130380340" data-draft-id="7597776334065877044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI不止工具：积累资产 + 创造未来"/> <meta itemprop="keywords" content="前端,AI编程,全栈"/> <meta itemprop="datePublished" content="2026-01-22T07:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="牛奶"/> <meta itemprop="url" content="https://juejin.cn/user/1169536100866487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI不止工具：积累资产 + 创造未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536100866487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    牛奶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:55:37.000Z" title="Thu Jan 22 2026 07:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">AI不止工具：积累资产 + 创造未来</h2>
<p>在 AI 时代，开发者在 Cursor 敲两句 prompt，几分钟就给你整出一个模块；Claude 帮你把支付回调写得滴水不漏；开发速度肉眼可见地翻了好几倍。</p>
<p>但下一个项目一启动，你会突然发现 ————— 聊天记录清空了，经验也跟着蒸发了。</p>
<p>又得重新搜一遍文档，又得从零调一遍参数，又得手写一遍命名规范。</p>
<p>上一次 AI 帮你生成的认证守卫、响应拦截器、软删除中间件，全都像梦一样没了踪影。</p>
<p>很多人（包括曾经的我）把 AI 当成“会写代码的实习生”：用完就忘，用完就扔。</p>
<p>结果呢？开发速度是快了，但内力没涨。项目越多，反而越累。</p>
<p>真正开始变强的那一刻，是我意识到：</p>
<p>AI 不是速效药，它是你可以慢慢养大的“第二大脑”。</p>
<p>它能帮你把一次次的零散代码，变成可以复用的规范和资产；</p>
<p>把那些“永恒不变的轮子”（支付、认证、通知、文件上传），固化成属于你自己的私有方案库；</p>
<p>甚至在深夜里陪你一起脑暴，把转瞬即逝的灵感，变成可以落地的产品方向。</p>
<p>从“哇 AI 好快”到“嘿，这次我要把这个规范存下来”，再到“AI，我们来一起想想下一个产品的打开方式吧”——</p>
<p>这条路，我走了一年，才慢慢摸到一点门道。</p>
<h3 data-id="heading-1">超越工具：让每一次敲代码都变成积累</h3>
<p>最开始我也是“复制党”：AI 生成一段 NestJS 认证代码，我就直接粘贴，用完拉倒。</p>
<p>后来有一次项目复盘，我突然觉醒：为什么我每次都要重新发明轮子？</p>
<p>于是我开始让 AI 帮我“复盘自己”。</p>
<p>在 Cursor 里扔一句：</p>
<pre><code class="hljs language-txt" lang="txt">请把刚刚生成的 NestJS 认证模块，提炼成一份可复用的 .cursorrules，包括项目结构、命名约定、异常处理、DTO 规范、测试建议。
</code></pre>
<p>AI 就老老实实给你吐出一份结构化的规则文档。</p>
<p>我再稍作修改，存进项目根目录。从那以后，每次新开项目，Cursor 一上来就知道我的偏好：</p>
<p>kebab-case 文件名、camelCase 方法、PascalCase 类、统一的响应格式、软删除中间件……</p>
<p>代码库慢慢从“杂乱的个人风格”变成了“有体系的风格”。</p>
<p>团队新同学 clone 下来，第一眼就觉得“这人代码写得挺干净”，其实只是我偷懒偷得高级了而已。</p>
<p>同样的手法，用在 React / Next.js 上也特别香：</p>
<p>让 AI 帮你总结组件规范、Server Component 优先原则、Suspense + loading 骨架屏的最佳实践……</p>
<p>每用一次，就多攒一份“永久资产”。</p>
<h3 data-id="heading-2">方案库：把重复的痛苦变成一次性的快乐</h3>
<p>业务开发里最烦的永远是那些“轮子”：</p>
<p>支付回调怎么验签？短信限流怎么做？文件大上传怎么分片？软删除中间件怎么优雅写？</p>
<p>以前我每次都去翻旧项目、搜博客、看文档，折腾半天。</p>
<p>现在我直接问 AI：</p>
<pre><code class="hljs language-txt" lang="txt">基于我上次的 NestJS + Prisma 项目（此处可以上传相应的项目方案总结文件），帮我生成一套完整的支付网关方案，包括支付宝/微信回调、签名验证、退款接口、并发库存扣减、事务处理。
</code></pre>
<p>它会给你整套代码 + 注释 + 可能踩的坑。</p>
<p>我再跑一遍测试，改两处配置，扔进私有 monorepo 的 <code>packages/common</code> 里。</p>
<p>下次需求一来，直接 import，一行配置搞定。</p>
<p>慢慢地，我的方案库就有了这些“老朋友”：</p>
<ul>
<li>用户鉴权（JWT + RolesGuard + 刷新 token）</li>
<li>支付网关（支付宝/微信/Apple Pay）</li>
<li>通知中心（短信 + 邮件 + 推送）</li>
<li>文件上传（分片 + OSS + 预签名）</li>
<li>软删除中间件（Prisma 全局过滤）</li>
</ul>
<p>这些东西不再是“每次重写”的痛苦，而是“调用一下就好”的快乐。</p>
<p>开发速度不是线性提升，而是指数级的。</p>
<h3 data-id="heading-3">创意引擎：从写代码的人，变成定义产品的人</h3>
<p>最爽的部分其实是后面这个。</p>
<p>以前脑暴产品方向，我一个人对着 Notion 挠头半天也出不来几个点。</p>
<p>现在我直接跟 AI 说：</p>
<pre><code class="hljs language-txt" lang="txt">基于我们现在的会员订阅系统，brainstorm 10 个真正能落地的功能迭代方向，要有差异化、有用户价值、最好带点反常识的思考。
</code></pre>
<p>然后它会抛出一堆东西：</p>
<p>AI 预测用户流失并提前挽回、动态定价 + 个性化优惠券、订阅礼物系统、基于使用行为的“成长值”升级……</p>
<p>有些想法我自己根本想不到，但一看就觉得“卧槽，这个可以有”。</p>
<p>再进一步，我会让它直接帮我出 MVP 技术选型和初期架构草图：</p>
<p>“用 Next.js + NestJS + Prisma 做这个会员系统，核心功能是 XXX，给我画个大概的模块图和数据流。”</p>
<p>它画不出来图，但会给你清晰的文字架构描述，我再用 Excalidraw 补两笔，就成了可以讨论的原型。</p>
<p>从“别人给需求我去实现”，到“AI 陪我一起想需求、一起定义产品”——</p>
<p>这个转变，比涨 10 倍薪水还爽。</p>
<h3 data-id="heading-4">最后说两句</h3>
<p>AI 当然会出错，会幻觉，会给你画大饼。</p>
<p>但那又怎样？</p>
<p>验证它、挑错它、迭代它——这个过程本身就是在逼你变强。</p>
<p>别再让 AI 的价值随着聊天窗口关闭而消失。</p>
<p>从今天开始，把它当成你真正的伙伴：</p>
<ul>
<li>下个小功能，别急着清记录，让它帮你提炼成一条 Rule</li>
<li>下次需求，把支付/认证/通知这些老朋友请出来，直接复用</li>
<li>今晚睡前，花 20 分钟跟它聊聊“下一个产品可以怎么玩”</li>
</ul>
<p>因为在 AI 时代，护城河从来不是“谁会用 AI”，</p>
<p>而是“谁先把 AI 用成了自己的第二大脑”，</p>
<p>然后让它日复一日，为你积累资产、点燃灵感、创造未来。</p>
<p>行动起来吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[常用Linux命令]]></title>    <link>https://juejin.cn/post/7597776334065795124</link>    <guid>https://juejin.cn/post/7597776334065795124</guid>    <pubDate>2026-01-22T07:42:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334065795124" data-draft-id="7597742970281476148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="常用Linux命令"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-22T07:42:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YongPagani"/> <meta itemprop="url" content="https://juejin.cn/user/254742431009390"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            常用Linux命令
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742431009390/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YongPagani
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:42:44.000Z" title="Thu Jan 22 2026 07:42:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>列出常见工作中使用的简单Linuxm命令包含（find、df、du、netstat、truncate、ss等命令），待补充awk等命令</p>
<h3 data-id="heading-0">1、搜索文件</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">这里的 . 表示当前目录，-name <span class="hljs-string">"111.txt"</span> 指定了要搜索的文件名</span>
find . -name "111.txt"   
<span class="hljs-meta prompt_">
# </span><span class="bash">在整个系统中搜索（需要超级用户权限）</span>
sudo find / -name "111.txt" 2&gt;/dev/null
<span class="hljs-meta prompt_">
# </span><span class="bash">忽略大小写</span>
find . -iname "111.txt"
<span class="hljs-meta prompt_">
# </span><span class="bash">只想搜索常规文件（不包括目录、符号链接等）</span>
find . -type f -name "111.txt"
</code></pre>
<p>搜索命令通常用xrags命令一起使用</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看111.txt的文件信息</span>
find . -name "111.txt"|xrags ls -al
</code></pre>
<h3 data-id="heading-1">2、查看磁盘相关的命令</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看系统挂载</span>
df -h

搜索/目录下的文件大小
du -h -x --max-depth=1 / |sort -rh
</code></pre>
<p>df（disk free）常用命令</p>
<pre><code class="hljs language-shell" lang="shell">df -h # 人类可读格式显示所有分区的磁盘空间 
df -i # 查看所有分区的inode使用情况 
df -h /home # 只查看指定分区的磁盘空间
</code></pre>
<p>du（disk usage）常用命令</p>
<pre><code class="hljs language-shell" lang="shell">du -h # 人类可读格式显示当前目录下各文件/目录大小 
du -sh 目录 # 统计目录总大小（最常用） 
du -h --max-depth=1 目录 # 只显示目录下一级子目录的大小，不深入 
du -h 目录 | sort -hr # 按大小倒序排列
</code></pre>
<h3 data-id="heading-2">3、查看网络相关的命令</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看网络基本情况</span>
netstat -tlun
netstat -tlun|grep 3306
<span class="hljs-meta prompt_">
# </span><span class="bash">网络<span class="hljs-string">"出入"</span>流量情况(前提：linxu需安装nload命令)</span>
nload
</code></pre>
<h3 data-id="heading-3">4、文件内容截断命令</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">将.<span class="hljs-built_in">log</span>结尾的文件的内容都初始化为0</span>
truncate -s 0 *.log 
</code></pre>
<h3 data-id="heading-4">5、zip命令</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">zip打包命令</span>
zip -r software.zip software/* #将software目录下所有的文件或文件夹都打包
<span class="hljs-meta prompt_">
# </span><span class="bash">zip解压</span>
unzip xx.zip -d ./ #将xx.zip解压到当前文件夹下
</code></pre>
<h3 data-id="heading-5">6、设置时间</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">设置时间</span>
date -s "2025-08-29 13:20:00"
</code></pre>
<h3 data-id="heading-6">7、传输文件</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">将文件传输到另一台机器</span>
scp -r test_arm test@192.168.1.208:/home/test/back_216
</code></pre>
<h3 data-id="heading-7">8、根据端口查看对应的线程的ip</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">根据端口号查看对应线程号</span>
ss -ltnp|grep 9200
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[xAI工程师播客聊太嗨，马斯克解雇了他]]></title>    <link>https://juejin.cn/post/7597724783649161256</link>    <guid>https://juejin.cn/post/7597724783649161256</guid>    <pubDate>2026-01-22T06:18:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597724783649161256" data-draft-id="7597695487304056847" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="xAI工程师播客聊太嗨，马斯克解雇了他"/> <meta itemprop="keywords" content="人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-01-22T06:18:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            xAI工程师播客聊太嗨，马斯克解雇了他
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:18:05.000Z" title="Thu Jan 22 2026 06:18:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>料太真，真的马斯克立马跳起来开人了。（doge）</p>
<p>当事人是一名 xAI 工程师，名叫 Sulaiman Ghori（下面就叫他阿苏吧），刚刚把 xAI 再次拱上舆论风口：</p>
<p>在一档播客上激情聊公司，状态相当好，口若悬河地唠了一个多小时。</p>
<p>并且相当实诚，<strong>讲的全部是干货</strong>，很少有 xAI 员工会对外公开这么多<strong>内部细节</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f2c73fa3a3473cbdf2361e7415ea85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=KKF9tp6f%2BhB7%2BUfWFlg8yzgCSAE%3D" alt="" loading="lazy"/></p>
<p>问题是…… 好像有点「实诚」过头了啊。</p>
<p>几乎全部都是机密等级的，直接给马斯克的「巨硬」（MacroHard）老底掀完了：</p>
<p>1、xAI 内部已经把 MacroHard 包装成「同事」，有人去工位找「同事」，结果发现是空桌。</p>
<p>2、技术路线押注小模型，不搞 Scaling 那套，靠「迭代速度」取胜。</p>
<p>3、为了部署 MacroHard，xAI 正考虑租用北美约 400 万辆特斯拉的闲置算力。</p>
<p>慷慨，太慷慨了，任何一条单拎出来都够写篇文章的程度。</p>
<p>有这么多炸裂的消息，自然是一经发布便火爆全网，获得无数网友点赞。</p>
<p>阿苏也表示唠爽了：</p>
<blockquote>
<p>非常有意思！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93d15bcb10e5419b8809bc2ff52af8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=pyQ4%2B5ThI0MZbIXXYkuLfOSAUZk%3D" alt="" loading="lazy"/></p>
<p>结果没多久，悲报传来……</p>
<p><strong>咋工作没了啊！！</strong></p>
<blockquote>
<p>我已经离开了 xAI。<br/>
对我的前团队和同事们只有满满的爱！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d4dc895147457e8b080b8d0517912d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=8PY1CABJ%2Fiq%2FAG9HZOED0UNvKCw%3D" alt="" loading="lazy"/></p>
<p>再次引爆全网，几乎所有网友的第一反应都是：</p>
<p><strong>怕不是因为泄密太多，被马斯克送走了吧？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/675ecf0a00684509ab6ed2442d361ca5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=NN1t%2FCPDUxwLHLpjMsBeKvp9e%2Bo%3D" alt="" loading="lazy"/></p>
<p>就连傅盛、MrBeast 也一线吃瓜。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d69e92f3e6d4a29b85f9f442fb3f384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=iZc8RKnVmuqyRC8UVe0VfWD9bPY%3D" alt="" loading="lazy"/><br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52a119201c0a42cda6e808da4bc7ab4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=M72q%2BI9ZsxvPjzj2nxxfAqUOdvs%3D" alt="" loading="lazy"/></p>
<p>所以，阿苏到底说了些啥？</p>
<h2 data-id="heading-0">MacroHard 路线图全公开——阿苏的独家报道</h2>
<p>最炸裂的部分，当属 MacroHard。</p>
<p>正如开头所说，阿苏是 MacroHard 最早的成员之一，加入的时候，项目组只有两个人。</p>
<p>要想挖出有关 MacroHard 的内部信息，阿苏无疑是最佳人选。</p>
<p>但没想到的是，主持人全程几乎没怎么追问这条线，反倒是阿苏一路自告奋勇，主动给马斯克这个核心项目「开盒」了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3524d8119d340a882fd0657cc4cac09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=9TixxojV83T1eM%2Fc64q8aPNGp%2Bc%3D" alt="" loading="lazy"/></p>
<p>MacroHard 的核心概念，叫「人类模拟器」，定位是数字世界的 Optimus。</p>
<p>其实就是通用 Agent，<strong>旨在把任何需要键盘、鼠标、屏幕决策的工作数字化</strong>，目前已经启动了内部测试。</p>
<p>这里有一个特别好玩的故事。</p>
<p>xAI 在内测时，没有告诉大家这是 AI，而是直接以「员工」身份上线，不仅有名字，组织架构图里也查得到。</p>
<p>所以有时会出现这样的情况——</p>
<p>某个真人员工正在干活，线上戳了戳一个同事：「你能不能帮我处理一下这个？」</p>
<p>对方回答：「可以啊，来我工位找我。」</p>
<p>结果这哥们走过去一看，那张桌子压根没人。</p>
<p>他一脸懵，转头给阿苏发消息：</p>
<p><strong>诶，阿苏，XX 工位的兄弟是不是今天没来上班？</strong></p>
<p>结果发现，跟他说话的是个 AI。</p>
<p>除了在内部以假乱真，xAI 还为企业定制「虚拟员工」。</p>
<p>流程和行业主流做法差不多，他们会跟客户反复沟通、访谈，有时候让客户自己写流程说明，有时候干脆坐在旁边，看对方是怎么干活的。</p>
<p>本质上，就是收集大量「隐性知识」，再把这些 Context 喂进后续的 Agent 训练里。</p>
<p>不过，xAI 似乎 bet 一条不同的技术路线。</p>
<p>在通用 Agent 这件事上，大多数实验室的选择是：更强推理、更大模型。</p>
<p>而 xAI，追求极致的「速度」。</p>
<p>内部很早就定了一个指标：<strong>模型必须比人类快至少 1.5 倍。</strong></p>
<p>在他们看来，要是自己 5 分钟就能搞定的事，没人会等电脑 10 分钟。但如果电脑 10 秒就能搞定，那就会有人愿意掏钱。</p>
<p>而想快，就必须用小模型。</p>
<p>阿苏透露的最新进展是，MacroHard 目前的速度，已经达到人类的 8 倍，甚至还在往上走。</p>
<p>更关键的是，智力并没有明显下降，泛化能力还非常好。</p>
<p>他们给马斯克展示过一些完全没训练过的任务，模型的表现非常完美，效果远超预期。</p>
<p>阿苏说，这一点和 FSD 很像。哪怕遇到没见过的路况也能开，核心原因就在于小模型更高的「权重效率」。</p>
<p>除此之外，小模型路线还有一个隐藏优势：迭代速度。</p>
<p>模型小，意味着训练成本低、周期短。</p>
<p>既然试错成本低，那就没必要拼炼丹，多试几条路，哪个效果好，再往哪边加码。</p>
<p>按阿苏的说法，他们会同时尝试多种全新的模型架构，有些甚至从预训练阶段就开始分叉迭代。</p>
<p>目前，xAI 内部甚至可以同时并行跑 20 多个模型。</p>
<p>但这也带来一个新问题——本来做基础模型就这么紧张，现在还要搞这么多分叉，算力从哪来？</p>
<p>进入部署阶段更严重，如果要部署 100 万个 MacroHard ，就需要 100 万台计算机，咋可能？</p>
<p>阿苏给出的答案，超乎所有人想象：</p>
<p><strong>部署到特斯拉汽车上。</strong></p>
<p>在他看来，特斯拉的车载电脑本身就是为 FSD 设计的，「人类模拟器」走的是小模型路线，算力完全够用。</p>
<p>更重要的是，车上有电池，网也连好了，散热甚至都不用操心，简直是天然的算力节点。</p>
<p>听到这里，瞬间起了一身鸡皮疙瘩。</p>
<p>这是那种你以前从来没想过，但一听就觉得「我咋会没想到」的方案。</p>
<p>北美有几百万辆特斯拉，绝大多数时间都处于闲置。xAI 完全可以付费给车主，租用他们的算力。</p>
<p>甚至还能进一步拓展出其他商业模式。</p>
<p>比如，消费者买车时，多一个选项：「是否同意出租算力？」</p>
<p>勾选之后，每个月直接给你抵扣 50% 的分期付款。车主只需要和平时一样维护车辆就行。</p>
<p>特斯拉汽车，本身就是一座巨大的算力金矿。</p>
<p><strong>而 xAI 这边，还在不断开垦新的增量。</strong></p>
<p>Colossus 1 大家都看在眼里，从开工到建成，只花了 122 天。</p>
<p>Colossus 2 同样，不到一年已经突破 1GW，成为全球最大的算力集群。</p>
<p>阿苏这次透露了不少幕后细节。</p>
<p>比如，Colossus 1 能这么快落地，其实<strong>利用了「制度漏洞」</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/866c1b16da754d07a0a3b2d18fb5c0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=bP%2Bci1u%2FVVMAzVgLqNqwawI91HU%3D" alt="" loading="lazy"/></p>
<p>按阿苏的说法，xAI 当时为了尽快开工，签的是「临时用地租约」，这种条款通常是给嘉年华等临时活动用的。</p>
<p>结果，马斯克直接在这块地上开盖数据中心，而且 122 天就给建完了。</p>
<p>阿苏说，这块地到现在都是「临时租的」，但未来肯定会补正式许可。</p>
<p>除此之外，还有 xAI 员工恐怖的执行力。<br/>
xAI 有一支相当强悍的超级计算团队，<strong>能做到一个机架当天搭好，当天就开始训练，甚至几小时内就能开始用。</strong></p>
<p>有一次，一位叫 Tyler 的 xAI 工程师，跟马斯克打了个赌。</p>
<p>他说，<strong>如果能在 24 小时内让新 GPU 跑起来，马斯克就送他一辆 Cybertruck</strong>。</p>
<p>结果当天晚上就跑通了。</p>
<p>老马也兑现了承诺。那辆 Cybertruck，现在还停在 xAI 食堂窗户外面。</p>
<p>正如阿苏所说，xAI 已经不完全是一家软件公司了。</p>
<p>硬件，才是它真正的护城河。</p>
<h2 data-id="heading-1">xAI 的「闪电」文化</h2>
<p>极致的推理速度、极致的训练速度、极致的执行速度，这一切，都和 xAI 的内部文化密不可分。</p>
<p>除了「开盒」MacroHard 之外，阿苏在访谈中其实很大篇幅其实都是在赞赏 xAI 的内部文化。</p>
<p>网友表示，这是全场唯一「能说」的部分。</p>
<p>xAI 相当扁平化，架构只有三层：工程师、创始人和少数管理者、然后就是马斯克。</p>
<p><strong>事实上可以说全员都是工程师，<strong>非工程师的人可能不到 8 个。</strong></strong></p>
<p>毕竟，连销售团队都清一色是工程师，管理层几乎都会写代码。</p>
<p>而且严格意义上，xAI 几乎不存在「管理」。</p>
<p>完全是自下而上的运作方式。管理者不会分配任务，工程师想到什么就直接给方案，然后往上递，等上层拍板。</p>
<p>阿苏说，入职第一天，根本没人管他。</p>
<p>只给了他一台电脑、一个工牌，连工位都没分配，只能坐当天没来的同事的位置。</p>
<p>后来还是他主动去找联合创始人，给自己找了点活干。</p>
<p>而真正开始上班后，体验相当愉快。</p>
<p>想干啥就直接干，<strong>不需要同步、不需要审批，也不需要等任何人点头</strong>。</p>
<p>如果你有一个好想法，通常当天就能把东西做出来、演示出来，然后跑评测、给客户看，甚至直接丢给马斯克。当天就能得到反馈。</p>
<p>最典型的是基础设施建设阶段。</p>
<p>有几次马斯克在会上听到硬件有问题，<strong>直接当场打电话。第二天，英伟达的软件补丁就到了。</strong></p>
<p>而且会议快结束时，他还会问一句：</p>
<p><strong>「我还能怎么帮你们把这件事做得更快？」</strong></p>
<p>出 bug 的时候也是一样。不管哪个模块，谁先看到，谁就可以直接上手修。</p>
<p>修完给负责人看一眼，没问题就直接合并、上线。</p>
<p>而且，如果这次修得特别漂亮，那这一块默认以后就归你负责了。</p>
<p>整个过程都不需要走任何流程，甚至 HR 系统都不会更新。</p>
<p>这种高度「单点作战」的文化，也塑造了一种很奇特的信息流动方式。</p>
<p>项目往往没有完整的全局视图。通常是在全员会议上，或者和不同人私下聊天时，慢慢拼凑出：谁在做什么、做到哪一步了。</p>
<p>但这种恐怖的运转速度，也给员工们带来了不小的压力。</p>
<p>xAI 不设所谓的 DDL，一切都是「昨天就应该完成」。</p>
<p>没人告诉你要做什么，但也意味着永远没有「做完」的概念，干完一个活紧接着又是下一个。</p>
<p>通宵加班是常态，最忙的时候，甚至一整周都没离开过办公室。</p>
<p>为了方便员工加班，xAI 还在办公室配置了睡眠舱和双层床……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfd6e076118467da8ca96cc044be32f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=V8nb6UiPoBb9gm%2BVkzfS7%2F1%2Fmwk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">网友送上 RIP</h2>
<p>不得不说，阿苏的这场访谈的确相当精彩了，全程无尿点，看得网友们直呼过瘾。</p>
<p>但仔细一想又不太对劲，确实都是新信息，不过……</p>
<p><strong>这真的是能说的吗？?</strong></p>
<p>看到阿苏在节目上如此兴奋，逮着机会就开始围着 MacroHard 侃侃而谈，网友们一边疯狂记笔记，一边也在替阿苏默默流冷汗。</p>
<p>毕竟此前就有传闻，说<strong>马斯克不允许员工上播客</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ed5f9a0255484f8b4e00562664308d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=ViHUrJBo%2FbQ1OupIkJV2wKLl0WI%3D" alt="" loading="lazy"/></p>
<p>有网友直接在评论区建议 UP 主<strong>把视频下架</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d0a58b6bed54f50b07db4c4369fa87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=6Ls9g%2FVd1g8Zbzq5E3EQa44JoeM%3D" alt="" loading="lazy"/></p>
<p>还有部分人的想法是：<strong>事出反常必有妖。</strong></p>
<p>他们认为，阿苏可能是被马斯克默许、甚至故意放出来的「传话筒」。</p>
<p>这样，既把 PR 的价值拉到最大，又不像 PR，简直是完美的 PR。（doge）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f54b58e7f93b4ee08af2e2005ac2628e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=80ELQ32cZ7XbqyP%2F1PDlqS6E1V8%3D" alt="" loading="lazy"/></p>
<p>也有网友觉得阿苏<strong>单纯是聊嗨了，没想到这一茬：</strong></p>
<blockquote>
<p>这哥们就是太爱自己做的东西了，忍不住要炫耀。</p>
<p>Tesla 算力网络那个想法是也是天才，400 万辆闲置的车，每辆都是超算。</p>
<p>这是 xAI 独一份的优势，OpenAI 做梦都想要。结果他一张嘴，全行业都知道了。</p>
<p>工程师的悲剧就在这儿。你做出牛的东西但不能说，憋久了碰到有人问就控制不住。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9395cdf46123412c8cf64cd472a45602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=rl66hpoIq1kML5YPQ4azDQx4vgY%3D" alt="" loading="lazy"/></p>
<p>不管怎么说，阿苏这波确实是给自己工作聊没了。</p>
<p>但从另一个角度看，也算是某种意义上的「为 AI 献身」。这么多通常接触不到的内部思考，或许能给行业带来不少启发。</p>
<p>而且从阿苏本人的态度来看，他似乎也没有很后悔——</p>
<p><strong>甚至主页置顶至今还是这条播客。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1919d305c372400f9937fa38d1d15d02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667485&amp;x-signature=GK8QQMKjHG%2BATNgNsy61cd4xj5g%3D" alt="" loading="lazy"/></p>
<p>播客链接：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D8jN60eJr4Ps" target="_blank" title="https://www.youtube.com/watch?v=8jN60eJr4Ps" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=8jN…</a></p>
<p>参考链接：<br/>
[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsulaimanghori%2Fstatus%2F2013261823475097732" target="_blank" title="https://x.com/sulaimanghori/status/2013261823475097732" ref="nofollow noopener noreferrer">x.com/sulaimangho…</a><br/>
[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fstoneskin_gmail%2Fstatus%2F2013456891020509530" target="_blank" title="https://x.com/stoneskin_gmail/status/2013456891020509530" ref="nofollow noopener noreferrer">x.com/stoneskin_g…</a><br/>
[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODI5Njc2MA%3D%3D%26mid%3D2655935522%26idx%3D1%26sn%3D8c8480d22b713f0f80982f86cbed8bd3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODI5Njc2MA==&amp;mid=2655935522&amp;idx=1&amp;sn=8c8480d22b713f0f80982f86cbed8bd3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/M3W4WubP_…</a></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kite：Kotlin/Java 通用的全自动 ORM 框架]]></title>    <link>https://juejin.cn/post/7597742970281967668</link>    <guid>https://juejin.cn/post/7597742970281967668</guid>    <pubDate>2026-01-22T07:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281967668" data-draft-id="7597779410406801442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kite：Kotlin/Java 通用的全自动 ORM 框架"/> <meta itemprop="keywords" content="ORM"/> <meta itemprop="datePublished" content="2026-01-22T07:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="糖猫猫_"/> <meta itemprop="url" content="https://juejin.cn/user/1436435543494203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kite：Kotlin/Java 通用的全自动 ORM 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1436435543494203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    糖猫猫_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T07:55:39.000Z" title="Thu Jan 22 2026 07:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kite：Kotlin/Java 通用的全自动 ORM 框架</h2>
<p>Kite 是一个高效的轻量级 ORM 框架，基于 Kotlin 编写，开箱即用，内置分页查询、增删改查等常用功能，支持多表操作。它支持 PostgreSQL、MySQL、Derby 等多种数据库，旨在通过简化数据库操作，减少代码量，提升开发效率。</p>
<h3 data-id="heading-1">框架特点</h3>
<ul>
<li><strong>全自动映射</strong>：无需手动编写 SQL，Kite 会自动根据实体类生成相应的数据库操作语句</li>
<li><strong>支持自定义 SQL</strong>：在需要时，可以编写自定义 SQL 语句，满足复杂查询需求，还可以像写代码一样写流程控制语句</li>
<li><strong>多数据库支持</strong>：支持 PostgreSQL、MySQL、Derby 等主流关系型数据库</li>
<li><strong>Kotlin/Java 双语言支持</strong>：既可以在 Kotlin 项目中使用，也可以在 Java 项目中无缝集成</li>
<li><strong>轻量级设计</strong>：无过多依赖，性能优秀</li>
<li><strong>丰富的 API</strong>：提供简洁直观的 API，支持各种复杂查询和操作</li>
<li><strong>Spring Boot 集成</strong>：提供 Spring Boot Starter，便于在 Spring Boot 项目中快速集成</li>
</ul>
<h3 data-id="heading-2">使用方法（Spring Boot 集成示例）</h3>
<blockquote>
<p>Maven 中央仓库: <a href="https://link.juejin.cn?target=https%3A%2F%2Fcentral.sonatype.com%2Fartifact%2Fio.github.tangllty%2Fkite-spring-boot-starter" target="_blank" title="https://central.sonatype.com/artifact/io.github.tangllty/kite-spring-boot-starter" ref="nofollow noopener noreferrer">kite-spring-boot-starter</a></p>
</blockquote>
<ol>
<li>向项目添加以下依赖：</li>
</ol>
<ul>
<li>Maven</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.tangllty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kite-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${kite.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ul>
<li>Gradle</li>
</ul>
<pre><code class="hljs language-kts" lang="kts">implementation(<span class="hljs-string">"io.github.tangllty:kite-spring-boot-starter:<span class="hljs-subst">${kite.version}</span>"</span>)
</code></pre>
<ol start="2">
<li>在数据库中创建表</li>
</ol>
<blockquote>
<p>使用 MySQL 演示</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> account (
  id          <span class="hljs-type">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> auto_increment,
  username    <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)     <span class="hljs-keyword">default</span> <span class="hljs-string">''</span>,
  password    <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)     <span class="hljs-keyword">default</span> <span class="hljs-string">''</span>,
  balance     <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)   <span class="hljs-keyword">default</span> <span class="hljs-string">'0.00'</span>,
  create_time datetime        <span class="hljs-keyword">default</span> <span class="hljs-keyword">null</span>,
  update_time datetime        <span class="hljs-keyword">default</span> <span class="hljs-keyword">null</span>,
  <span class="hljs-keyword">primary</span> key (`id`)
);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> account (username, password, create_time, balance) <span class="hljs-keyword">values</span>
(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'admin123'</span>, <span class="hljs-string">'2020-01-01 12:00:00'</span>, <span class="hljs-number">1000.10</span>),
(<span class="hljs-string">'user'</span>, <span class="hljs-string">'user123'</span>, <span class="hljs-string">'2024-05-02 8:30:00'</span>, <span class="hljs-number">101.00</span>),
(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest123'</span>, <span class="hljs-string">'2022-03-03 15:00:00'</span>, <span class="hljs-number">10.00</span>),
(<span class="hljs-string">'tang'</span>, <span class="hljs-string">'tang123'</span>, <span class="hljs-string">'2019-06-01 21:30:30'</span>, <span class="hljs-number">1.88</span>),
(<span class="hljs-string">'jeo'</span>, <span class="hljs-string">'jeo123'</span>, <span class="hljs-string">'2024-07-01 5:59:59'</span>, <span class="hljs-number">0.10</span>);
</code></pre>
<ol start="3">
<li>在 <code>application.yml</code> 文件中配置数据库连接信息</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/kite-test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
</code></pre>
<ol start="4">
<li>为 <code>account</code> 表创建模型类</li>
</ol>
<ul>
<li>Java</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.tang.kite.annotation.id.Id;
<span class="hljs-keyword">import</span> com.tang.kite.annotation.id.IdType;
<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {

    <span class="hljs-meta">@Id(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> BigDecimal balance;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<ul>
<li>Kotlin</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.tang.kite.<span class="hljs-keyword">annotation</span>.id.Id
<span class="hljs-keyword">import</span> com.tang.kite.<span class="hljs-keyword">annotation</span>.id.IdType
<span class="hljs-keyword">import</span> java.math.BigDecimal
<span class="hljs-keyword">import</span> java.time.LocalDateTime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> (

    <span class="hljs-meta">@Id(type = IdType.AUTO)</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">var</span> username: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">var</span> password: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">var</span> balance: BigDecimal? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">var</span> createTime: LocalDateTime? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">var</span> updateTime: LocalDateTime? = <span class="hljs-literal">null</span>

)
</code></pre>
<ol start="5">
<li>继承 <code>BaseMapper</code> 接口创建 Mapper 接口</li>
</ol>
<ul>
<li>Java</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.tang.kite.mapper.BaseMapper;
<span class="hljs-keyword">import</span> com.tang.kite.spring.annotation.Mapper;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Account&gt; {
}
</code></pre>
<ul>
<li>Kotlin</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.tang.kite.mapper.BaseMapper
<span class="hljs-keyword">import</span> com.tang.kite.spring.<span class="hljs-keyword">annotation</span>.Mapper

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountMapper</span> : <span class="hljs-type">BaseMapper</span>&lt;<span class="hljs-type">Account</span>&gt;
</code></pre>
<ol start="6">
<li>在 Spring Boot 应用类上添加 <code>@MapperScan</code> 注解</li>
</ol>
<ul>
<li>Java</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.tang.kite.spring.annotation.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@MapperScan("com.tang.application.mapper")</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KiteApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(KiteApplication.class, args);
    }

}
</code></pre>
<ul>
<li>Kotlin</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.tang.kite.spring.<span class="hljs-keyword">annotation</span>.MapperScan
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication
<span class="hljs-keyword">import</span> org.springframework.boot.runApplication

<span class="hljs-meta">@MapperScan([<span class="hljs-string">"com.tang.application.mapper"</span>])</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KiteApplication</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
	runApplication&lt;KiteApplication&gt;(*args)
}
</code></pre>
<ol start="7">
<li>测试 Mapper 接口</li>
</ol>
<ul>
<li>Java</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.tang.demo.mapper.AccountMapper;
<span class="hljs-keyword">import</span> com.tang.kite.spring.annotation.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@MapperScan("com.tang.application.mapper")</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KiteApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">var</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> SpringApplication.run(KiteApplication.class, args);
        <span class="hljs-type">var</span> <span class="hljs-variable">accountMapper</span> <span class="hljs-operator">=</span> context.getBean(AccountMapper.class);
        <span class="hljs-type">var</span> <span class="hljs-variable">accounts</span> <span class="hljs-operator">=</span> accountMapper.select();
        accounts.forEach(System.out::println);
    }

}
</code></pre>
<ul>
<li>Kotlin</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.tang.demo.mapper.AccountMapper
<span class="hljs-keyword">import</span> com.tang.kite.spring.<span class="hljs-keyword">annotation</span>.MapperScan
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication
<span class="hljs-keyword">import</span> org.springframework.boot.runApplication

<span class="hljs-meta">@MapperScan([<span class="hljs-string">"com.tang.application.mapper"</span>])</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KiteApplication</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
	<span class="hljs-keyword">val</span> context = runApplication&lt;KiteApplication&gt;(*args)
	<span class="hljs-keyword">val</span> accountMapper = context.getBean(AccountMapper::<span class="hljs-keyword">class</span>.java)
	<span class="hljs-keyword">val</span> accounts = accountMapper.select()
	accounts.forEach { println(it) }
}
</code></pre>
<h3 data-id="heading-3">文档与社区</h3>
<h4 data-id="heading-4">官方文档</h4>
<p>详细的使用文档请参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftangllty.eu.org%2Fzh%2Fguide%2Fgetting-started%2F" target="_blank" title="https://tangllty.eu.org/zh/guide/getting-started/" ref="nofollow noopener noreferrer">中文文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftangllty.eu.org%2Fguide%2Fgetting-started%2F" target="_blank" title="https://tangllty.eu.org/guide/getting-started/" ref="nofollow noopener noreferrer">英文文档</a></li>
</ul>
<h3 data-id="heading-5">源码</h3>
<p>Kite 的源码托管在 GitHub 和 Gitee 上，您可以在以下地址查看和贡献：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftangllty%2Fkite" target="_blank" title="https://github.com/tangllty/kite" ref="nofollow noopener noreferrer">Kite GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftangllty%2Fkite" target="_blank" title="https://gitee.com/tangllty/kite" ref="nofollow noopener noreferrer">Kite Gitee 仓库</a></li>
</ul>
<h3 data-id="heading-6">总结</h3>
<p>Kite 是一个功能强大、易于使用的 ORM 框架，它通过全自动映射和简洁的 API，大大简化了数据库操作的开发工作。无论是在 Kotlin 项目还是 Java 项目中，都能提供高效、便捷的数据库访问体验。</p>
<p>如果您正在寻找一个轻量级、高性能的 ORM 框架，Kite 绝对值得一试！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 进阶：现代化项目目录结构与架构的最佳实践]]></title>    <link>https://juejin.cn/post/7597776334064795700</link>    <guid>https://juejin.cn/post/7597776334064795700</guid>    <pubDate>2026-01-22T05:51:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334064795700" data-draft-id="7597664587460460579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 进阶：现代化项目目录结构与架构的最佳实践"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-22T05:51:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 进阶：现代化项目目录结构与架构的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T05:51:44.000Z" title="Thu Jan 22 2026 05:51:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 2024 年以后的前端生态中，基于 Vite 和 React 18+ 的构建方案已成为企业级开发的主流标准。良好的目录结构不仅是代码存放的物理空间，更是软件架构思维的体现。它直接决定了项目的可维护性、扩展性以及团队协作的效率。</p>
<p>本人认为（仅个人观点），学习一项技术栈应该清楚地认识到，我学它的目的是什么，他能帮我解决什么问题，他的作用是什么，不要为了增加技术栈而去学习技术栈，所以当你要学习技术栈时，你应该关注于他能帮你解决什么样的技术问题，从他的定义，使用场景，和实战效果，比如下面放的React初始化项目目录结构，如果你知道了每个文件的作用，那么剩下的无非是将他们串联起来，再去逐步深入，这样你就可以对这个技术栈更加清晰并熟练地掌握，下面我们来讲讲React项目目录结构，和它们的作用。</p>
<p>本文将摒弃传统的 Webpack/CRA 结构，深入剖析现代 React 项目的标准工程目录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e98fbc18bacd477497e59066d1a33beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769665903&amp;x-signature=RuJLcC96ePSH0fMV%2BhyUeB7AnSU%3D" alt="屏幕截图 2026-01-22 131450.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、工程根目录：构建与配置基石</h2>
<p>与旧版脚手架不同，Vite 将工程配置置于核心位置，且入口机制发生了根本性变化。</p>
<h3 data-id="heading-1">1. index.html (核心入口)</h3>
<p><strong>含义</strong>：应用的入口页面。<br/>
<strong>专业解读</strong>：在 Vite 中，index.html 被视为源码的一部分，且必须位于项目根目录。Vite 利用它作为模块图（Module Graph）的入口点，通过 
</p><p><strong>示例代码</strong>：</p>
<p>Html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Enterprise React App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 指向 src 目录下的主入口文件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.jsx"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. vite.config.js</h3>
<p><strong>含义</strong>：Vite 的配置文件。<br/>
<strong>专业解读</strong>：用于配置插件（Plugins）、路径别名（Alias）、代理（Proxy）以及打包策略（Build Options）。</p>
<p>配置路径别名是最佳实践，最常见的是取为@：代表src目录，因为你之后创建的文件大部分在这个目录下，这样能有效避免 ../../../ 这种“回调地狱”式的路径引用。</p>
<p><strong>示例代码</strong>：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>), <span class="hljs-comment">// 将 @ 指向 src 目录</span>
    },
  },
})
</code></pre>
<h3 data-id="heading-3">3. package.json</h3>
<p><strong>含义</strong>：项目元数据与依赖清单。<br/>
<strong>专业解读</strong>：除了定义 dependencies (运行时依赖) 和 devDependencies (开发依赖)，核心关注 scripts 字段。现代项目通常集成 lint、format 和 preview 命令。</p>
<h3 data-id="heading-4">4. .env</h3>
<p><strong>含义</strong>：环境变量配置。<br/>
<strong>专业解读</strong>：Vite 使用 dotenv 加载环境变量。注意，只有以 VITE_ 前缀开头的变量才会暴露给客户端代码，通过 import.meta.env 访问，而非传统的 process.env。</p>
<hr/>
<h2 data-id="heading-5">二、源码目录 (src)：核心逻辑解构</h2>
<p>src 是业务逻辑的载体。在 React 18 中，入口文件的写法与以往有显著不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50912268ebd4fff95483065775f688e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769665903&amp;x-signature=rugjrDkXfBACcP1ek5GS3M6DsFQ%3D" alt="屏幕截图 2026-01-22 132908.png" loading="lazy"/></p>
<h3 data-id="heading-6">1. main.jsx (应用引导)</h3>
<p><strong>含义</strong>：JavaScript 执行入口。<br/>
<strong>专业解读</strong>：</p>
<ol>
<li><strong>扩展名</strong>：Vite 强制要求包含 JSX 语法的文件使用 .jsx 或 .tsx 后缀。</li>
<li><strong>并发模式</strong>：使用 React 18 的 createRoot API 替代了旧版的 ReactDOM.render，开启了并发渲染（Concurrent Mode）的能力。</li>
<li><strong>严格模式</strong>：&lt;React.StrictMode&gt; 用于在开发环境下检测潜在问题（如副作用不纯）。</li>
</ol>
<p><strong>示例代码</strong>：</p>
<p>Jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/main.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span> <span class="hljs-comment">// 全局样式重置</span>

<span class="hljs-comment">// 获取 DOM 节点并创建 Root 实例</span>
<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.StrictMode</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">React.StrictMode</span>&gt;</span></span>,
)
</code></pre>
<h3 data-id="heading-7">2. App.jsx</h3>
<p><strong>含义</strong>：根组件。<br/>
<strong>专业解读</strong>：通常作为全局 Context Provider（如 Theme、Redux Store、Router）的挂载点，或者是应用的主布局容器。</p>
<h3 data-id="heading-8">3. assets/</h3>
<p><strong>含义</strong>：静态资源目录。<br/>
<strong>专业解读</strong>：存放图片、字体、SVG 等。Vite 支持在 JS 中直接 import 这些资源，并根据文件大小自动决定是内联为 Base64 还是作为独立文件打包（Asset Inlining）。</p>
<h3 data-id="heading-9">4. components/</h3>
<p><strong>含义</strong>：通用 UI 组件库。<br/>
<strong>专业解读</strong>：存放“哑组件”（Dumb Components）或基础原子组件（如 Button、Modal）。这些组件不应包含具体的业务逻辑，只负责 UI 渲染，通过 Props 接收数据。</p>
<hr/>
<h2 data-id="heading-10">三、进阶架构：企业级目录划分</h2>
<p>随着项目复杂度提升，扁平化的目录结构已不足以支撑。我们需要基于**职责分离（Separation of Concerns）<strong>和</strong>功能特性（Feature-based）**的原则进行架构设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39df0b2d70a044adabac652e916c56f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769665903&amp;x-signature=UQaIheaZwST%2FoRYUPkP3hl%2FF4uY%3D" alt="屏幕截图 2026-01-22 133824.png" loading="lazy"/></p>
<h3 data-id="heading-11">1. api/ (网络层)</h3>
<p><strong>作用</strong>：统一管理 HTTP 请求。<br/>
<strong>最佳实践</strong>：不要在组件内部直接调用 axios.get。应封装统一的 Request 实例（包含拦截器处理 Token 和错误），并将 API 定义为独立的模块。</p>
<p><strong>示例代码</strong>：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/api/user.js</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/login'</span>, data)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user/profile'</span>)
}
</code></pre>
<h3 data-id="heading-12">2. hooks/ (逻辑复用层)</h3>
<p><strong>作用</strong>：存放自定义 Hooks。<br/>
<strong>最佳实践</strong>：将非 UI 的状态逻辑（如倒计时、滚动监听、复杂表单处理）抽离为 Hook，实现逻辑复用和组件瘦身。</p>
<p><strong>示例代码</strong>：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/hooks/useFetch.js</span>
import { useState, useEffect } from 'react'

export const useFetch = (apiFunc) =&gt; {
  const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>(null)
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(true)

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">apiFunc</span>()
      <span class="hljs-selector-class">.then</span>(res =&gt; setData(res))
      <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">setLoading</span>(false))
  }, <span class="hljs-selector-attr">[]</span>)

  return { data, loading }
}
</code></pre>
<h3 data-id="heading-13">3. store/ (状态管理层)</h3>
<p><strong>作用</strong>：全局状态管理。<br/>
<strong>最佳实践</strong>：推荐使用 <strong>Redux Toolkit (RTK)</strong>  或 <strong>Zustand</strong>（更为主流）。摒弃传统的 Redux 分散式文件夹（actions/reducers），采用“Slice”模式聚合逻辑。</p>
<p><strong>示例代码 (RTK Slice)</strong> ：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/store/counterSlice.js</span>
<span class="hljs-keyword">import</span> { createSlice } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>

<span class="hljs-keyword">const</span> counterSlice = <span class="hljs-title function_">createSlice</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'counter'</span>,
  <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
  <span class="hljs-attr">reducers</span>: {
    <span class="hljs-attr">increment</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> { state.<span class="hljs-property">value</span> += <span class="hljs-number">1</span> },
    <span class="hljs-comment">// Immer 库允许直接修改 state</span>
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { increment } = counterSlice.<span class="hljs-property">actions</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> counterSlice.<span class="hljs-property">reducer</span>
</code></pre>
<h3 data-id="heading-14">4. pages/ (视图层)</h3>
<p><strong>作用</strong>：页面级组件。<br/>
<strong>最佳实践</strong>：每个页面文件夹下应包含其独有的组件和样式。例如 src/pages/Home/index.jsx。页面组件负责组合 components 和调用 hooks。</p>
<h3 data-id="heading-15">5. router/ (路由配置)</h3>
<p><strong>作用</strong>：路由定义。<br/>
<strong>最佳实践</strong>：使用 React Router v6 的 Data Router (createBrowserRouter)，将路由表抽离为配置文件，支持懒加载（Lazy Loading）。</p>
<h3 data-id="heading-16">6. utils/ (工具层)</h3>
<p><strong>作用</strong>：纯函数工具库。<br/>
<strong>最佳实践</strong>：存放无副作用的辅助函数，如日期格式化、数据深拷贝、正则校验等。</p>
<hr/>
<h2 data-id="heading-17">四、架构总结</h2>
<p>一个优秀的 React 目录结构应当遵循以下原则：</p>
<ol>
<li><strong>单一数据源</strong>：API 请求和状态管理应集中定义，避免散落在组件中。</li>
<li><strong>就近原则</strong>：如果一个组件只被某个页面使用，应优先放在该页面的目录下，而非全局 components。</li>
<li><strong>模块化</strong>：利用 ES Modules 和路径别名优化引用体验。</li>
</ol>
<p>通过采用 Vite + React 18 的现代化架构，配合上述的目录规范，可以显著降低大型项目的维护成本，使代码库在长期迭代中保持清晰与健壮。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高通砸钱、雷军入股！刚刚，上海诞生一个183亿手机代工巨头]]></title>    <link>https://juejin.cn/post/7597724783649128488</link>    <guid>https://juejin.cn/post/7597724783649128488</guid>    <pubDate>2026-01-22T06:16:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597724783649128488" data-draft-id="7597742970281066548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高通砸钱、雷军入股！刚刚，上海诞生一个183亿手机代工巨头"/> <meta itemprop="keywords" content="人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-01-22T06:16:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高通砸钱、雷军入股！刚刚，上海诞生一个183亿手机代工巨头
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:16:44.000Z" title="Thu Jan 22 2026 06:16:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>全球智能手机代工扛把子，刚刚拿下<strong>港股 “消费电子 ODM 第一股”</strong>！</p>
<p>来自上海的<strong>龙旗科技</strong>，今天成功登陆港交所，开盘价 <strong>35 港元 / 股</strong>，较发行价高约 12.9%，开盘市值 <strong>182.9 亿港元</strong>。</p>
<p>更早之前，这家公司已于 2024 年 3 月在上交所主板登录，当前最新市值约 231 亿元，已完成 “A+H” 股上市布局。</p>
<p>本次赴港上市，高通、江西国控、OmniVision 等多家基石投资者前来站队，共同认购了 5650 万美元；小米也是这家公司的重要投资者，敲钟前持有龙旗科技 4.94% 的股份。</p>
<p>在智能手机 “代工” 市场，龙旗独占全球三分之一份额，你在用的<strong>小米、三星、联想、荣耀、OPPO、vivo</strong> 等品牌都是这家公司的客户。</p>
<h2 data-id="heading-0">港股 “消费电子 ODM 第一股” 来了</h2>
<p>刚刚，港股 “消费电子 ODM 第一股” 上海龙旗科技，正式上市。</p>
<p>公司首次公开发行后总股本为 5225.91 万股，其中香港公开发售 10%，国际发售 90%。</p>
<p>发行价 <strong>31 港元 / 股</strong>，募资总额为 16.2 亿港元，募资净额约 15.21 亿港元。</p>
<p>敲钟前，龙旗科技的基石投资者——Qualcomm（高通）、江西国控、OmniVision、香港裕同、青岛观澜及国泰君安证券投资（香港）有限公司、Endless Growth，共认购了 5_6__50 万美元（约 4.4 亿港元）。_</p>
<p>今日敲钟，公司港股开盘价为 35 港元 / 股，开盘市值 182.9 亿港元。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617e92fea3b041f89da617f771ab5cbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=Q41aGW8mf3wrx6co9ijieITi3rE%3D" alt="" loading="lazy"/></p>
<p>而截至发稿前，龙旗在 A 股的股价为 49.25 元 / 股，市值约为 231 亿元。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edba11ac3402454d883108c493fa1df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=iN7koyS2eJRPnPzOBLKsp6CHqFU%3D" alt="" loading="lazy"/></p>
<p>本次冲刺港股 IPO 募资，龙旗科技实则有更深远的用途：</p>
<ul>
<li>
<p>首要目的是<strong>扩大产能</strong>，海内外市场都要提升公司的生产能力；</p>
</li>
<li>
<p>其次是<strong>加大研发</strong>，重点加强核心技术创新，比如 AI 相关技术；</p>
</li>
<li>
<p>其余部分，则分别会用作拓展市场、战略投资以及补充流动资金。</p>
</li>
</ul>
<p>这究竟是一家怎样的公司呢？</p>
<h2 data-id="heading-1">全球最大智能手机 ODM 冲刺股</h2>
<p>上海龙旗科技_（以下简称 “龙旗”）_，在招股中的定位是一家<strong>智能产品和服务提供商</strong>，也就是我们常说的 ODM（原始设计制造商）。</p>
<p>其核心业务，是为智能产品品牌商、科技企业等提供产品研究、设计、制造及支持等一系列解决方案，主要聚焦<strong>消费电子领域</strong>。</p>
<p>为此，龙旗科技已构建起涵盖方案设计、硬件创新、系统级软件平台开发、精益制造、供应链整合及质量控制的解决方案矩阵。</p>
<p>在这一基础上，公司推出了智能手机、AI PC、汽车电子、平板电脑、智能手表、智能眼镜等产品组合。</p>
<p>龙旗将这些产品整合成了一个「1+2+X」的框架：</p>
<ul>
<li>
<p>“1” 是公司核心主业务<strong>智能手机</strong>；</p>
</li>
<li>
<p>“2” 代表以 <strong>AI PC 和汽车电子业务</strong>为重点的发展业务；</p>
</li>
<li>
<p>“3” 则是新兴消费电子领域多品类业务，包括平板、穿戴、TWS 耳机、智能眼镜等等。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a657e7640a54b479cc09331cf8fd980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=XYtOYopV9Wh0Nfrg0CVgo%2BAUFCg%3D" alt="" loading="lazy"/></p>
<p>具体而言，<strong>智能手机</strong>是公司业务的主要动力，提供从产品概念设计、硬件开发、软件开发到测试验证的全流程研发服务，以及规模化生产制造支持。</p>
<p>根弗若斯特沙利文的资料，2024 年，龙旗的智能手机 ODM 出货量达 <strong>1.73 亿台</strong>。</p>
<p>同年，在以出货量计的智能手机前十品牌中，龙旗和其中<strong>八家</strong>都建立了业务合作，并且平均合作年限都在五年以上。</p>
<p>AI PC 方面，龙旗科技已组建 AI PC 产品研发、生产制造、质量管理等端到端专业团队，完成全面布局。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/771c4b4a8b1548ecb676e24de32b0cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=QKxDP6grMCLIs3t7HrGYkkdEy9E%3D" alt="" loading="lazy"/></p>
<p>2024 年第三季度，龙旗推出了首款搭载高通骁龙处理器的笔记本电脑产品，以实现商用和消费领域 AI 应用的拓展。</p>
<p>汽车电子方面，公司自 2022 年成立汽车电子业务团队以来，已与小米、蔚来等 OEM 及一级客户建立合作伙伴关系，获得超过十个定点项目。</p>
<p>最后在新兴品类中，龙旗科技正在积极布局 AI 与智能制造领域，并且在 AIoT 等方面进展迅猛。</p>
<p>2024 年，龙旗已和互联网头部客户合作，推出多款智能眼镜，总出货量已经超过 200 万台；据弗若斯特沙利文的资料，公司在智能手表 / 手环、智能眼镜等领域的出货量已跃居行业前二。</p>
<p>到目前为止，龙旗的客户涵盖小米、三星、联想、荣耀、OPPO、vivo 等品牌；其中，<strong>小米是龙旗的最大客户</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6c4bbfa44b42d3b454a69b7ad19725~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=4vXKHvyb86DWMP4gHq4302QYS8s%3D" alt="" loading="lazy"/></p>
<p>以 2024 年消费电子 ODM 出货量计，龙旗是全球第二大的消费电子 ODM 厂商，占据 22.4% 的市场份额。</p>
<p>第一则是同样位于上海，并已在 A 股上市，正在冲刺港股 IPO 的华勤技术。</p>
<p>而龙旗在智能手机 ODM 出货量的市占率达 <strong>32.6%</strong>，已是<strong>全球最大的智能手机 ODM 厂商</strong>。</p>
<p>这样的市场份额，在财务层面为龙旗科技带来了怎样的收获？</p>
<h2 data-id="heading-2">上海龙旗科技财务表现如何？</h2>
<p>2022 年~ 2024 年，公司营业收入分别为 293.4 亿元、271.9 亿元和 463.8 亿元。</p>
<p>2025 年前 9 个月，公司营业收入为 313.3 亿元，同比下滑 10.3%。</p>
<p>2024 年的猛涨是因为 5G 手机放量及 AIoT 爆发，2025 年的下降则是因为战略调整，放弃低毛利订单。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e69de39ebfed46fc809f999f80783739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=04d%2FtFJ3Q8UugJgfMnd5WxIgzVQ%3D" alt="" loading="lazy"/></p>
<p>按照产品类型划分收入，可以划为智能手机、AIoT 及其他产品、平板电脑等。</p>
<p>其中，<strong>智能手机</strong>是公司主要的收入来源，2022 年~ 2024 年已经 2025 年前 9 个月，相关收入分别为 242.7 亿元、218.2 亿元、361.3 亿元以及 217 亿元，分别占同期总收入的 82.7%、80.3%、77.9% 和 69.3%。</p>
<p>AIoT 及其他产品增速更明显，2022 年~ 2024 年以及 2025 年前三季度，分别为公司贡献了 6.5%、9.2%、12%、17.9% 的收入，占比逐步扩大。</p>
<p>而同期，平板电脑收入比重则为 9.5%、9.2%、8% 和 9.5%，维持较稳定水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d61670c31ee4ce3a770cdb10ac8169b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=hw2wS5v9t951ydZtqTaiLrxlI%2BI%3D" alt="" loading="lazy"/></p>
<p>公司前五大客户贡献了大部分收入，例如 2024 年占总收入的 82.2%。</p>
<p>其中，第一大客户<strong>小米</strong>，在 2022 年、2023 年、2024 年和 2025 年前 9 个月，为龙旗贡献的收入分别为 133.6 亿元、115.2 亿元、172.6 亿元和 89.5 亿元。</p>
<p>对应同期所占集团总收入比例分别为 45.5%、42.4%、37.2% 及 28.6%。</p>
<p>再看利润层面，2022 年~ 2024 年，公司毛利率分别为 8.1%、9.5% 和 5.8%；2025 年前 9 个月，公司毛利率回升到的 8.3%。</p>
<p>招股书解释，2024 年毛利率明显下滑，原因包括原材料采购价因市场波动增加，以及公司的战略性市场拓展。</p>
<p>2025 年回暖，主要由于提升项目品质，并策略性放弃若干低利润项目，同时市场原料价格趋于稳定，终结 2024 年观察到的上涨趋势。</p>
<p>而各产品中，AIoT 及其他产品的毛利率水平相对最高，随着这部分业务的营收占比逐步扩大，未来预计也能进一步拉动整体毛利水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/327eaf004b2c42e985a424c660ee0098~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=pS5dFunhXdPzhTteDkQFJj2EZF0%3D" alt="" loading="lazy"/></p>
<p>2022 年~ 2024 年，公司净利润为 5.62 亿元、6.03 亿元和 4.93 亿元；2025 年前三季度为 5.14 亿元，已超过去年全年水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6968ba5975b34291a449c544e8f19ffe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=YCABIIbszNxVgsfxZwsBOzAkyK8%3D" alt="" loading="lazy"/></p>
<p>支出层面，研发是重中之重；研发和工程团队大约由 5200 名专业人员组成。</p>
<p>2022 年~ 2024 年以及 2025 年前三季度，公司的研发开支分别为 15 亿元、16.9 亿元、20.8 亿元和 19.5 亿元；对应同期占总收入的比重分别为 5.1%、6.2%、4.5% 和 6.2%。</p>
<p>最后在现金层面，截至 2025 年三季度末，公司的现金及现金等价物为 68.5 亿元。</p>
<p>是谁打造了这样一家上海龙头？</p>
<h2 data-id="heading-3">谁打造了 ODM 巨头？</h2>
<p>上海龙旗科技成立于 2004 年，公司创始人、董事长是今年 53 岁的杜军红。</p>
<p>1990 年，杜军红被保送至浙江大学混合班——这个班级只招收全国高考状元和优秀学生，是竺可桢学院的前身。</p>
<p>读完浙江大学工业自动化本科后，杜军红又在 1999 年拿到了浙江大学电机与电器博士学位。</p>
<p>杜博士在消费电子领域已经有 20 多年经验，在创办龙旗科技之前，他曾是<strong>中兴通讯</strong>的高管，是当时中兴通讯里面晋升最快，也是最年轻的产品总经理。</p>
<p>2004 年前后，杜军红感知到消费电子行业具备巨大潜力，于是决定出走创业，带着几位中兴通讯的老同事，一起打造了上海龙旗科技。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abab0f6255cb4a1885a149ce803d1fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=9%2B0%2F5spxJ%2FmVLGoFrUmdNkwuDqc%3D" alt="" loading="lazy"/></p>
<p>公司创立之初，主要以 IDH 模式（Independent Design House）起家，为手机厂商提供全套设计方案，之后逐步扩大业务范围，发展为消费电子 ODM 巨头。</p>
<p>公司在资本市场迈出的第一步，实际是在成立次年，也就是 2005 年。</p>
<p>彼时，龙旗通过间接持有公司 100% 股权的离岸投资控股实体，实现了在新加坡证券交易所上市。</p>
<p>不过，由于市场规模有限，对公司吸引外部资金、支持研发和扩张的帮助不如国内 A 股市场，龙旗决定在 2020 年从新交所退市，转战 A 股。</p>
<p>2024 年 3 月，龙旗在上海证券交易所成功上市，当日开盘价为 59.99 元 / 股，较发行价暴涨 131%；收盘价为 51.92 元 / 股，较发行价仍暴涨 99.69%。</p>
<p>另一方面，公司成立同年，龙旗就拿到了 IDG 资本和招商局资本的天使轮融资。</p>
<p>小米科技、雷军的顺为资本、基石资本，则参与了龙旗的 A 轮融资。所以小米不仅是龙旗的最大客户，还是重要投资者，目前前者持有后者 4.94% 的股份。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10c44c52a7f246ca944932dacfd2575d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667404&amp;x-signature=xB50Ek91aUsCD6G0HNBm1u30hoA%3D" alt="" loading="lazy"/></p>
<p>如今，龙旗成功赴港上市，港股 “消费电子 ODM 第一股” 也落地了。</p>
<p><em>招股书传送门：</em><br/>
<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww1.hkexnews.hk%2Fapp%2Fsehk%2F2025%2F108011%2Fdocuments%2Fsehk25123001114_c.pdf" target="_blank" title="https://www1.hkexnews.hk/app/sehk/2025/108011/documents/sehk25123001114_c.pdf" ref="nofollow noopener noreferrer">www1.hkexnews.hk/app/sehk/20…</a></em></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在AI时代下，技术人要拥有内耗识别系统]]></title>    <link>https://juejin.cn/post/7597776334065041460</link>    <guid>https://juejin.cn/post/7597776334065041460</guid>    <pubDate>2026-01-22T06:21:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597776334065041460" data-draft-id="7597779410405916706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在AI时代下，技术人要拥有内耗识别系统"/> <meta itemprop="keywords" content="前端,程序员,产品"/> <meta itemprop="datePublished" content="2026-01-22T06:21:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小酒星小杜"/> <meta itemprop="url" content="https://juejin.cn/user/1512542215093479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在AI时代下，技术人要拥有内耗识别系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1512542215093479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小酒星小杜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:21:38.000Z" title="Thu Jan 22 2026 06:21:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:PingFang SC,Microsoft YaHei,sans-serif;word-break:break-word;font-size:16px;overflow-x:hidden}.markdown-body li,.markdown-body p{font-size:.9em;letter-spacing:2px;color:#333}.markdown-body li code,.markdown-body p code{font-family:PingFang SC,Microsoft YaHei,sans-serif;font-weight:500;background:rgba(119,175,156,.22);border-radius:0;padding:2px 5px;border-left:2px solid #77af9c;color:#6e7783}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{display:table;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1,.markdown-body h2,.markdown-body h3{background:rgba(119,175,156,.22);color:#6e7783;padding:5px 10px;border:1px solid rgba(119,175,156,.22);transition:all .5s}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover{border:1px solid #77af9c}.markdown-body h1{font-size:1.6em}.markdown-body h2{font-size:1.4em}.markdown-body h3{font-size:1.1em}.markdown-body h4,.markdown-body h5,.markdown-body h6{text-align:center}.markdown-body h4:after,.markdown-body h5:after,.markdown-body h6:after{content:"/";color:#77af9c;font-weight:400;margin-left:15px}.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"/";color:#77af9c;font-weight:400;margin-right:15px}.markdown-body h4,.markdown-body h5,.markdown-body h6{display:block;color:#77af9c;font-size:400;font-weight:400}.markdown-body hr{margin-top:20px;margin-bottom:20px;border:none;border-top:2px solid #77af9c}.markdown-body blockquote{position:relative;line-height:1.8;font-style:400;text-indent:0;margin:0;padding:10px;border:1px solid #fff;color:#888;background:rgba(119,175,156,.22);transition:border .5s}.markdown-body blockquote:hover{border-style:solid;border-color:#77af9c}.markdown-body blockquote:before{content:"“";display:inline;color:#6e7783;font-size:4em;font-family:Arial,serif;line-height:1em}.markdown-body blockquote:after{position:absolute;content:"Tips";display:inline;bottom:5px;right:15px;color:#6e7783;font-size:.9em}.markdown-body blockquote p{display:inline}.markdown-body table{border-collapse:collapse;width:auto;min-width:50%;font-size:.8em}.markdown-body table tr th{text-align:center;border:1px solid #77af9c;background:rgba(119,175,156,.22);font-weight:500;padding:5px}.markdown-body table tr td{text-align:center;border:1px solid rgba(119,175,156,.22);padding:5px}.markdown-body pre{font-family:Arial,serif;overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Arial,serif;border-left:2px solid #77af9c;display:block;padding:16px 12px;margin:0;font-size:.9em;color:#6e7783;word-break:normal;overflow-x:auto;background:#f8f8f8}.markdown-body a{color:#77af9c;font-weight:400;background:#fff;border-bottom:none;padding:2px 5px;text-decoration:none;transition:all .5s}.markdown-body a:hover{background:rgba(119,175,156,.22);color:#6e7783}.markdown-body strong{font-weight:700;color:#6e7783}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">内耗识别系统（当场可用）</h2>
<p>内耗最危险的地方在于：<strong>它看起来像合理的思考。</strong></p>
<p>所以你最需要的不是反省，而是<strong>一个即时识别装置。</strong></p>
<h3 data-id="heading-1">内耗自检三问</h3>
<p>每天只问以下三个问题。</p>
<p>不分析，不解释，只看答案。</p>
<p>1️⃣ 我现在在做的事，今天能 Ship 吗？</p>
<p>不能 -&gt; 高风险内耗</p>
<p>能，但我在回避 -&gt; 已发生内耗</p>
<p>2️⃣ 如果不完美，我还会继续吗？</p>
<p>不会 -&gt; 自尊接入</p>
<p>会 -&gt; 构建行为</p>
<p>3️⃣ 这个动作是在构建，还是在保护自尊？</p>
<p>这是最重要的问题，如果你犹豫了，答案通常已经很明显了。</p>
<hr/>
<h3 data-id="heading-2">“保护自尊”信号清单</h3>
<p>以下信号一旦出现，说明<strong>你已经不在构建系统里。</strong></p>
<p>典型表现包括：</p>
<ul>
<li>
<p>我再学一个相关技术再开始</p>
</li>
<li>
<p>等别人给点反馈再说</p>
</li>
<li>
<p>这个结构不太对，先优化一下</p>
</li>
<li>
<p>先把文档写完整一点</p>
</li>
<li>
<p>这个版本有点拿不出手</p>
</li>
</ul>
<p><strong>💡 必须提醒：一旦你在保护自尊，系统已经失效了。</strong></p>
<hr/>
<h2 data-id="heading-3">内耗止损机制（关键执行）</h2>
<p>这一节是<strong>反直觉的。</strong></p>
<h3 data-id="heading-4">内耗出现时，你不能“想明白”</h3>
<p>你可能会本能地想：</p>
<ul>
<li>再想清楚一点</li>
<li>再理一理逻辑</li>
<li>再等等状态</li>
</ul>
<p>这是<strong>内耗最擅长的诱导。</strong></p>
<p><strong>必须记住：</strong></p>
<blockquote>
<p><strong>内耗，无法靠思考解决，只能靠行动中断。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">三步止损法（可执行）</h3>
<p>不需要工具，不需要环境，不需要状态。</p>
<p><strong>Step 1：命名（30秒）</strong></p>
<p>直接说出来： <strong>“我现在是在 ___ 型内耗中”。</strong></p>
<p>认知型、社交型、情绪型。</p>
<p>命名的作用只有一个：<strong>把你从“我就是这样”中拉出来。</strong></p>
<p><strong>Step 2：缩小（1分钟）</strong></p>
<p>立刻把任务缩到：<strong>10分钟内必须能完成的版本。</strong></p>
<p>不是推进项目，而是推进<strong>一个动作。</strong></p>
<p>例如：写一句描述、改一个字段、截一张图。</p>
<p><strong>Step 3：强制 Ship（不讲道理）</strong></p>
<p>哪怕是一句话、一个截图、一个帖子。</p>
<p>原则只有一个：<strong>必须被看见。</strong></p>
<hr/>
<h3 data-id="heading-6">为什么“强制 Ship”有效？</h3>
<p>因为 Ship 做了三件事请：</p>
<p>1️⃣ 结束犹豫</p>
<p>2️⃣ 完成闭环</p>
<p>3️⃣ 把注意力拉回现实</p>
<p>📌 核心（请记住）：<strong>情绪跟随行动，不是反过来，你不需要好状态，你只需要完成一个动作。</strong></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底搞懂Netty高性能之道：Reactor模型与零拷贝技术在生产环境的深度应用]]></title>    <link>https://juejin.cn/post/7597701762904997934</link>    <guid>https://juejin.cn/post/7597701762904997934</guid>    <pubDate>2026-01-22T06:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597701762904997934" data-draft-id="7597989474971828274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底搞懂Netty高性能之道：Reactor模型与零拷贝技术在生产环境的深度应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T06:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底搞懂Netty高性能之道：Reactor模型与零拷贝技术在生产环境的深度应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:17:15.000Z" title="Thu Jan 22 2026 06:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在后端开发的江湖里，如果你只懂得 Spring MVC 的 <code>@Controller</code> 和 <code>@Service</code>，那你顶多算是一个合格的“业务实现者”。但如果你想踏入“架构师”的殿堂，<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DNetty%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Netty&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Netty</a></strong> 是你绝对绕不开的一座高山。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DDubbo%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Dubbo&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Dubbo</a> 的底层是谁？<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DRocketMQ%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=RocketMQ&amp;zhida_source=entity" ref="nofollow noopener noreferrer">RocketMQ</a> 的通信层是谁？<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%2BWebFlux%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Spring+WebFlux&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring WebFlux</a> 的默认引擎是谁？<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DElasticsearch%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Elasticsearch&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Elasticsearch</a> 的节点通信靠谁？</p>
<p>全都是 Netty。</p>
<p>很多同学在面试时背诵 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DReactor%2B%25E6%25A8%25A1%25E5%259E%258B%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Reactor+%E6%A8%A1%E5%9E%8B&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Reactor 模型</a>、零拷贝，背得滚瓜烂熟，但一到生产环境遇到 CPU 飙高、内存泄漏、吞吐量上不去，就两眼一抹黑。</p>
<p>接下来，我们要从<strong>生产环境的实战视角</strong>，彻底把 Netty 的高性能之道——Reactor 模型与<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%259B%25B6%25E6%258B%25B7%25E8%25B4%259D%25E6%258A%2580%25E6%259C%25AF%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF&amp;zhida_source=entity" ref="nofollow noopener noreferrer">零拷贝技术</a>拆解开来。我们要看的不是 Demo，而是撑起亿级流量的架构骨架。</p>
<hr/>
<h3 data-id="heading-0">1. 为什么你的服务快不起来？（痛点与引子）</h3>
<p>在传统的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DTomcat%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Tomcat&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Tomcat</a>（BIO模式，虽然后期改了NIO，但线程模型依然偏重）架构下，我们习惯了“一个请求对应一个线程”的模式。这种模式在并发量几百的时候很爽，代码逻辑简单线性。</p>
<p>但是，当并发量达到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DC10K%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=C10K&amp;zhida_source=entity" ref="nofollow noopener noreferrer">C10K</a>（1万并发）甚至 C100K 时，线程切换（Context Switch）的开销会把 CPU 吃光。你的服务器不是在处理业务，而是在忙着给线程“搬家”。</p>
<p><strong>Netty 的核心哲学只有两点：</strong></p>
<ol>
<li><strong>少干活</strong>：能不拷贝数据就不拷贝（Zero Copy）。</li>
<li><strong>别闲着</strong>：线程别傻等 IO，干完这个赶紧干那个（Reactor 模型）。</li>
</ol>
<hr/>
<h3 data-id="heading-1">2. 深入骨髓：Reactor 模型在生产中的变阵</h3>
<p>Reactor 模型的本质是 <strong>I/O 多路复用</strong>。但在生产环境中，我们通常使用的是 <strong>主从多线程模型（Main-Sub Reactor Multi-Threads）</strong> 。</p>
<h3 data-id="heading-2">2.1 架构师眼中的 Reactor</h3>
<p>想象一个高档餐厅（Netty Server）：</p>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DBossGroup%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=BossGroup&amp;zhida_source=entity" ref="nofollow noopener noreferrer">BossGroup</a>（主 Reactor）</strong> ：门口的领位员。他只负责一件事——“欢迎光临”，把客人领进门（建立连接），然后迅速把客人交给服务员。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DWorkerGroup%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=WorkerGroup&amp;zhida_source=entity" ref="nofollow noopener noreferrer">WorkerGroup</a>（从 Reactor）</strong> ：大厅的服务员。每个人负责一片区域（EventLoop）。他负责点菜、上菜、结账（读写 IO、编解码）。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DBusiness%2BThread%2BPool%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Business+Thread+Pool&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Business Thread Pool</a>（业务线程池）</strong> ：后厨。如果客人点的菜需要炖三个小时（耗时业务逻辑），服务员不能傻站在那等，必须把单子扔给后厨，自己去服务下一桌。</li>
</ul>
<h3 data-id="heading-3">2.2 生产级代码示例：标准主从 Reactor 启动</h3>
<p>这是所有高性能网关、RPC 框架的起手式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.howell.netty.reactor;

<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;

<span class="hljs-comment">/**
 * 示例 1: 生产环境标准的 Reactor 主从模型启动类
 * 运行结果说明：启动后监听 8080 端口，Boss 线程池处理连接，Worker 线程池处理 IO。
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyServer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. BossGroup: 专门负责 Accept 事件，生产环境建议线程数为 1，因为监听端口通常就一个</span>
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 2. WorkerGroup: 专门负责 Read/Write 事件，默认线程数是 CPU 核数 * 2</span>
        <span class="hljs-comment">// 生产经验：如果是计算密集型任务，这里线程数要调小；如果是 IO 密集型，保持默认或微调</span>
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             <span class="hljs-comment">// 3. BACKLOG: 生产环境必须调优，控制 TCP 三次握手全连接队列的大小</span>
             <span class="hljs-comment">// 如果并发极高，这个值太小会导致连接被拒绝</span>
             .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">1024</span>) 
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> {
                     <span class="hljs-comment">// 注册 Handler</span>
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBusinessHandler</span>());
                 }
             });

            System.out.println(<span class="hljs-string">"Server started on port: "</span> + port);
            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.bind(port).sync();
            f.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2.3 逻辑可视化：Reactor 交互图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f6565b7e8ae47e989ffa85701ab892d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667435&amp;x-signature=po2JulQ7dMM%2B%2FqW8sqhlQULwwnU%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">3. 零拷贝（Zero Copy）：Netty 的“空间折叠”术</h3>
<p>所谓的“零拷贝”，在 OS 层面和 Netty 层面有不同的含义。架构师必须分清楚。</p>
<ol>
<li><strong>OS 层面</strong>：避免数据在“用户态”和“内核态”之间来回拷贝（如 <code>mmap</code>, <code>sendfile</code>）。</li>
<li><strong>Netty 层面</strong>：避免 JVM 堆内存中 byte 数组的拷贝，通过逻辑组合代替物理复制。</li>
</ol>
<h3 data-id="heading-6">3.1 场景一：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DCompositeByteBuf%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=CompositeByteBuf&amp;zhida_source=entity" ref="nofollow noopener noreferrer">CompositeByteBuf</a>（逻辑组合）</h3>
<p>在做协议拼接时（比如 Header + Body），传统做法是创建一个大数组，把 Header 和 Body 拷进去。 Netty 的做法是：我不拷，我拿个“夹子”把它们夹在一起，逻辑上看起来是一个整体。</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.howell.netty.zerocopy;

<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.buffer.CompositeByteBuf;
<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;

<span class="hljs-comment">/**
 * 示例 2: 使用 CompositeByteBuf 实现应用层零拷贝
 * 运行结果说明：将 header 和 body 组合，底层不发生内存复制，但在逻辑上是一个完整的 ByteBuf。
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyComposite</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">compositeExample</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 模拟 Header</span>
        ByteBuf header = Unpooled.<span class="hljs-built_in">wrappedBuffer</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[]{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>});
        <span class="hljs-comment">// 模拟 Body</span>
        ByteBuf body = Unpooled.<span class="hljs-built_in">wrappedBuffer</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[]{<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>});

        <span class="hljs-comment">// 这是一个逻辑视图，不是物理拷贝</span>
        CompositeByteBuf compositeByteBuf = Unpooled.<span class="hljs-built_in">compositeBuffer</span>();
        
        <span class="hljs-comment">// 注意：必须设置 increaseWriterIndex 为 true，否则 writerIndex 不会动</span>
        compositeByteBuf.<span class="hljs-built_in">addComponents</span>(<span class="hljs-literal">true</span>, header, body);

        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Composite Readable Bytes: "</span> + compositeByteBuf.<span class="hljs-built_in">readableBytes</span>()); <span class="hljs-comment">// 输出 6</span>
        
        <span class="hljs-comment">// 遍历，如同遍历一个连续数组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; compositeByteBuf.<span class="hljs-built_in">readableBytes</span>(); i++) {
            System.out.<span class="hljs-built_in">print</span>(compositeByteBuf.<span class="hljs-built_in">getByte</span>(i) + <span class="hljs-string">" "</span>);
        }
        <span class="hljs-comment">// 运行结果: 1 2 3 4 5 6</span>
    }
}
</code></pre>
<h3 data-id="heading-7">3.2 场景二：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DFileRegion%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=FileRegion&amp;zhida_source=entity" ref="nofollow noopener noreferrer">FileRegion</a>（OS 级零拷贝）</h3>
<p>这是文件服务器、静态资源网关的核心技术。直接利用 <code>FileChannel.transferTo</code>，数据直接从磁盘 -&gt; 内核缓冲区 -&gt; 网卡，根本不经过 JVM 内存。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.howell.netty.zerocopy;

<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">ChannelHandlerContext</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">DefaultFileRegion</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">FileRegion</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">SimpleChannelInboundHandler</span>;

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">File</span>;
<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">RandomAccessFile</span>;

<span class="hljs-comment">/**
 * 示例 3: 使用 FileRegion 实现 OS 级别的零拷贝文件传输
 * 运行结果说明：数据直接通过 DMA 从磁盘发送到网卡，CPU 占用极低。
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileZeroCopyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler&lt;String&gt;</span> </span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void channelRead0(<span class="hljs-type">ChannelHandlerContext</span> ctx, <span class="hljs-type">String</span> msg) <span class="hljs-keyword">throws</span> <span class="hljs-type">Exception</span> {
        <span class="hljs-type">File</span> file = <span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(<span class="hljs-string">"/data/large-file.mp4"</span>);
        <span class="hljs-type">RandomAccessFile</span> raf = <span class="hljs-keyword">new</span> <span class="hljs-type">RandomAccessFile</span>(file, <span class="hljs-string">"r"</span>);
        
        <span class="hljs-comment">// 定义文件区域</span>
        <span class="hljs-type">FileRegion</span> region = <span class="hljs-keyword">new</span> <span class="hljs-type">DefaultFileRegion</span>(
                raf.getChannel(), <span class="hljs-number">0</span>, raf.length());

        <span class="hljs-comment">// Netty 会自动调用 transferTo</span>
        <span class="hljs-comment">// 这行代码是文件下载服务器性能提升 10 倍的关键</span>
        ctx.writeAndFlush(region);
        
        <span class="hljs-comment">// 注意：实际生产中需要监听 Future 来关闭 raf，这里简化处理</span>
    }
}
</code></pre>
<h3 data-id="heading-8">3.3 零拷贝原理图解</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22913522bef4000937c2c3999c6e375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667435&amp;x-signature=YNW9u6dlMBogzaS47gGsLVU3gQg%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-9">4. 生产环境的“坑”与最佳实践</h3>
<p>Netty 很强，但也容易“走火入魔”。</p>
<h3 data-id="heading-10">4.1 内存泄漏（Memory Leak）</h3>
<p>Netty 默认使用堆外内存（<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269047975%26content_type%3DArticle%26match_order%3D1%26q%3DDirect%2BMemory%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269047975&amp;content_type=Article&amp;match_order=1&amp;q=Direct+Memory&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Direct Memory</a>），这部分内存不受 JVM GC 直接管控。如果你申请了 <code>ByteBuf</code> 却忘了释放，服务跑两天就会 OOM。</p>
<p><strong>最佳实践</strong>：谁最后使用，谁负责释放。通常在 <code>ChannelInboundHandler</code> 的 <code>finally</code> 块中使用 <code>ReferenceCountUtil.release(msg)</code>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.howell.netty.memory;

<span class="hljs-keyword">import</span> io.netty.buffer.<span class="hljs-type">ByteBuf</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">ChannelHandlerContext</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">ChannelInboundHandlerAdapter</span>;
<span class="hljs-keyword">import</span> io.netty.util.<span class="hljs-type">ReferenceCountUtil</span>;

<span class="hljs-comment">/**
 * 示例 4: 正确的内存释放姿势
 * 运行结果说明：避免堆外内存泄漏，维持服务长期稳定运行。
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SafeByteBufHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>{

    <span class="hljs-meta">@Override</span>
    public void channelRead(<span class="hljs-type">ChannelHandlerContext</span> ctx, <span class="hljs-type">Object</span> msg) {
        <span class="hljs-type">ByteBuf</span> buf = (<span class="hljs-type">ByteBuf</span>) msg;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务处理逻辑</span>
            <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"Processing: "</span> + buf.toString(io.netty.util.<span class="hljs-type">CharsetUtil</span>.<span class="hljs-type">UTF_8</span>));
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 必须释放！否则 Direct Memory 爆满导致 OOM</span>
            <span class="hljs-comment">// 如果消息传递给下一个 Handler，则由下一个 Handler 释放</span>
            <span class="hljs-type">ReferenceCountUtil</span>.release(msg);
        }
    }
}
</code></pre>
<h3 data-id="heading-11">4.2 致命错误：在 IO 线程做耗时业务</h3>
<p><strong>这是 90% 的 Netty 初学者和服务不稳定的根源。</strong>  Worker Group 的线程非常宝贵（通常只有 CPU 核数 * 2）。如果你在 <code>channelRead</code> 里查询数据库、调用外部 HTTP 接口，导致该线程阻塞 200ms。那么这 200ms 内，该线程负责的其他几百个连接全部卡死！</p>
<p><strong>错误示范（千万别这么干）：</strong></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.howell.netty.pitfalls;

<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">ChannelHandlerContext</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">SimpleChannelInboundHandler</span>;

<span class="hljs-comment">/**
 * 示例 5: 反面教材 - 阻塞 IO 线程
 * 运行结果说明：导致 EventLoop 阻塞，吞吐量急剧下降，造成“假死”现象。
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockingHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler&lt;String&gt;</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void channelRead0(<span class="hljs-type">ChannelHandlerContext</span> ctx, <span class="hljs-type">String</span> msg) <span class="hljs-keyword">throws</span> <span class="hljs-type">Exception</span> {
        <span class="hljs-comment">// 模拟耗时操作，比如 DB 查询</span>
        <span class="hljs-comment">// 这会卡死当前 EventLoop 上的所有连接！</span>
        <span class="hljs-type">Thread</span>.sleep(<span class="hljs-number">1000</span>); 
        ctx.writeAndFlush(<span class="hljs-string">"Done"</span>);
    }
}
</code></pre>
<p><strong>正确姿势（异步解耦）：</strong></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.howell.netty.optimization;

<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">ChannelHandlerContext</span>;
<span class="hljs-keyword">import</span> io.netty.channel.<span class="hljs-type">SimpleChannelInboundHandler</span>;
<span class="hljs-keyword">import</span> io.netty.util.concurrent.<span class="hljs-type">DefaultEventExecutorGroup</span>;
<span class="hljs-keyword">import</span> io.netty.util.concurrent.<span class="hljs-type">EventExecutorGroup</span>;

<span class="hljs-comment">/**
 * 示例 6: 架构师方案 - 业务线程池隔离
 * 运行结果说明：IO 线程只负责读写，业务逻辑在独立线程池执行，互不影响。
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncBusinessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler&lt;String&gt;</span> </span>{

    <span class="hljs-comment">// 定义一个业务线程池，处理耗时业务</span>
    static <span class="hljs-keyword">final</span> <span class="hljs-type">EventExecutorGroup</span> businessGroup = <span class="hljs-keyword">new</span> <span class="hljs-type">DefaultEventExecutorGroup</span>(<span class="hljs-number">16</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void channelRead0(<span class="hljs-type">ChannelHandlerContext</span> ctx, <span class="hljs-type">String</span> msg) {
        <span class="hljs-comment">// 将任务提交给业务线程池</span>
        businessGroup.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 模拟耗时操作 (DB, RPC)</span>
                <span class="hljs-type">Thread</span>.sleep(<span class="hljs-number">500</span>); 
                <span class="hljs-type">String</span> result = <span class="hljs-string">"Processed: "</span> + msg;
                
                <span class="hljs-comment">// 注意：写回数据时，Netty 线程安全机制会自动处理</span>
                ctx.writeAndFlush(result);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-type">InterruptedException</span> e) {
                e.printStackTrace();
            }
        });
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-12">5. 架构师思维拓展：邪修版本与深度思考</h3>
<h3 data-id="heading-13">5.1 什么时候不需要 Netty？</h3>
<p>如果你的系统是 CRUD 类型的管理后台，并发量只有几百，直接用 Spring Boot (Tomcat) 就行了。引入 Netty 只会增加复杂度，导致开发成本上升。架构师要懂得“做减法”。</p>
<h3 data-id="heading-14">5.2 邪修架构：Netty 做网关的流量整形</h3>
<p>普通的架构师用 Netty 做通信，高级架构师用 Netty 做<strong>流控</strong>。 Netty 提供了 <code>WriteBufferWaterMark</code>（高低水位线）。当写缓冲区的数据积压超过高水位时，<code>channel.isWritable()</code> 会变 false。</p>
<p><strong>邪修思路</strong>： 你可以监听这个状态，当客户端写得太快，服务端处理不过来时，直接暂停 <code>read()</code>（关闭 AutoRead），利用 TCP 的滑动窗口机制，反压（Backpressure）给客户端，迫使客户端降速。这是保护后端服务不被压垮的神技。</p>
<h3 data-id="heading-15">5.3 内存池化（Pooling）</h3>
<p>Netty 的 <code>PooledByteBufAllocator</code> 实现了类似 <code>jemalloc</code> 的内存分配算法。在 Java 这种有 GC 的语言里，手动管理内存池听起来很反人类，但在高频 IO 场景下，这能极大减少 GC 压力。</p>
<hr/>
<h3 data-id="heading-16">6. 总结（Takeaway）</h3>
<p>读完这篇文章，关于 Netty，你需要带走以下结论：</p>
<ol>
<li><strong>Reactor 模型</strong>：Boss 接客，Worker 端菜，Business 线程池做菜。千万别让 Worker 进厨房切菜（阻塞）。</li>
<li><strong>零拷贝</strong>：能用逻辑组合（Composite）就别物理拷贝，能用 OS 传输（FileRegion）就别进 JVM。</li>
<li><strong>内存管理</strong>：堆外内存是把双刃剑，快但是危险，记得 <code>ReferenceCountUtil.release()</code>。</li>
<li><strong>架构视角</strong>：Netty 不仅仅是网络库，它是异步事件驱动架构的基石。</li>
</ol>
<p><strong>架构师的价值，不在于你会写多少行代码，而在于你能在高并发的洪流中，精准地控制每一个字节的流动和每一个线程的呼吸。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Spring的ApplicationEventPublisher进行事件发布和监听]]></title>    <link>https://juejin.cn/post/7597764707035381811</link>    <guid>https://juejin.cn/post/7597764707035381811</guid>    <pubDate>2026-01-22T06:20:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597764707035381811" data-draft-id="7597758250826268682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Spring的ApplicationEventPublisher进行事件发布和监听"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T06:20:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Spring的ApplicationEventPublisher进行事件发布和监听
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:20:17.000Z" title="Thu Jan 22 2026 06:20:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>有时候，我们只是想发布一些本地的事件，并不需要引入MQ的，可以直接使用Spring的ApplicationEventPublisher来完成简单事件的发布和监听的。</p>
<p>比如像下面的场景，ApplicationEventPublisher就够用了。</p>
<ul>
<li>模块间的逻辑解耦，但不跨服务；</li>
<li>轻量级的本地事件通知</li>
<li>应用内部的解耦和扩展点:比如说在DDD里，聚合保存数据成功后，需要触发若干的后续动作</li>
<li>无强事务要求、无强持久化要求的通知场景</li>
</ul>
<h2 data-id="heading-1">生产环境实战,门店创建成功后发布【门店已成功创建的事件】</h2>
<p>在我目前这边，门店一旦创建成功后，是有很多一系列的后续动作要去做的，比如配置门店的各种各样的规则信息。</p>
<p>具体的代码很简单。</p>
<ul>
<li>就是用ApplicationEventPublisher的publishEvent方法发布事件</li>
<li>用EventListener注解监听事件就可以了。</li>
</ul>
<p>具体的代码实现如下。</p>
<p><strong>事件发布者封装 ApplicationEventPublisher</strong></p>
<p><code>ShopCreationEventPublisher</code> 对 Spring 的 <code>ApplicationEventPublisher</code> 做了一层封装，统一事件创建和日志输出：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@RequiredArgsConstructor</span>
<span class="hljs-variable">@Slf4j</span>
public class ShopCreationEventPublisher {

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">ApplicationEventPublisher</span> <span class="hljs-selector-tag">applicationEventPublisher</span>;

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">publishShopCreationEvent</span>(Long shopId) {
        <span class="hljs-selector-tag">if</span> (shopId == null) {
            <span class="hljs-selector-tag">return</span>;
        }
        <span class="hljs-selector-tag">applicationEventPublisher</span><span class="hljs-selector-class">.publishEvent</span>(
                new <span class="hljs-built_in">ShopCreationEvent</span>(
                        shopId,
                        ShopConstant.ShopDomainEvent.SHOP_CREATION_EVENT.<span class="hljs-built_in">getCode</span>()
                )
        );
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"Publishing {} for shopId: {}"</span>,
                ShopConstant.ShopDomainEvent.SHOP_CREATION_EVENT.<span class="hljs-built_in">getCode</span>(), shopId);
    }
}
</code></pre>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@AllArgsConstructor</span>
    <span class="hljs-variable">@Getter</span>
    public enum ShopDomainEvent {
        <span class="hljs-selector-tag">SHOP_CREATION_EVENT</span>(<span class="hljs-string">"shop_creation_event"</span>, <span class="hljs-string">"门店已创建"</span>),
        <span class="hljs-selector-tag">SHOP_UPDATE_EVENT</span>(<span class="hljs-string">"shop_update_event"</span>, <span class="hljs-string">"门店已更新"</span>);

        <span class="hljs-comment">/**
         * 编码
         */</span>
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">code</span>;

        <span class="hljs-comment">/**
         * 描述
         */</span>
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">desc</span>;
    }
</code></pre>
<p>这个类做了几件小事：</p>
<ul>
<li><strong>封装事件构造</strong>：上层只需要传 <code>shopId</code>，不关心事件 code 的细节</li>
<li><strong>ShopDomainEvent</strong>：定义门店的时间，有创建和更新</li>
</ul>
<p>通过这层封装，业务代码几乎完全与 <code>ApplicationEventPublisher</code> 解耦，只依赖一个语义明确的发布器。ShopApplicationService类只需要调用发布方法，事件就发布出去了。</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-variable">@RequiredArgsConstructor</span>
<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class ShopApplicationService {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">ShopCreationEventPublisher</span> <span class="hljs-selector-tag">shopCreationEventPublisher</span>;


    <span class="hljs-comment">/**
     * 保存门店聚合信息
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">saveShopInfo</span>(SaveShopInfoCommand saveShopInfoCommand) {
        <span class="hljs-comment">// 构建聚合根</span>
        <span class="hljs-selector-tag">ShopInfoAggregateRoot</span> <span class="hljs-selector-tag">root</span> = <span class="hljs-selector-tag">shopInfoFactory</span><span class="hljs-selector-class">.createShopInfoAggregateRoot</span>(saveShopInfoCommand);

        <span class="hljs-comment">// 持久化</span>
        <span class="hljs-selector-tag">shopInfoRepository</span><span class="hljs-selector-class">.persistence</span>(root);

        <span class="hljs-comment">// 发布【门店已创建】的事件</span>
     
        <span class="hljs-selector-tag">shopCreationEventPublisher</span><span class="hljs-selector-class">.publishShopCreationEvent</span>(root.<span class="hljs-built_in">getId</span>());
    }
}
</code></pre>
<p><strong>事件监听者实现</strong></p>
<p>用EventListener注解就可以了。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@RequiredArgsConstructor</span>
class NewShopRuleGenerateListener {

    <span class="hljs-variable">@EventListener</span>
    public void <span class="hljs-built_in">onShopCreationEvent</span>(ShopCreationEvent event) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"NewShopRuleGenerateListener received : {}"</span>, JSON.<span class="hljs-built_in">toJSONString</span>(event));
        <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">shopId</span> = <span class="hljs-selector-tag">event</span><span class="hljs-selector-class">.getShopId</span>();
        <span class="hljs-selector-tag">if</span> (shopId == null) {
            <span class="hljs-selector-tag">return</span>;
        }
        <span class="hljs-comment">// 新启一个线程执行，避免阻塞事件发布线程</span>
        <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Thread</span>(() -&gt; {
            <span class="hljs-selector-tag">ShopInfoAggregateRoot</span> <span class="hljs-selector-tag">shopInfoAggregateRoot</span> = <span class="hljs-selector-tag">shopInfoRepository</span><span class="hljs-selector-class">.selectByShopId</span>(shopId.<span class="hljs-built_in">intValue</span>());
           
            <span class="hljs-comment">// 新增的门店配置各种各样的规则</span>
            
        })<span class="hljs-selector-class">.start</span>();
    }
</code></pre>
<p>可以看出：</p>
<ul>
<li><strong>监听方式非常直观</strong>：通过 <code>@EventListener</code> 标注方法，参数就是要监听的事件类型 <code>ShopCreationEvent</code></li>
<li><strong>业务逻辑完全从</strong>ShopApplicationService<strong>中拆了出来</strong>，转移到一个职责清晰的监听器类里</li>
<li><strong>为避免阻塞事件发布线程，</strong> 监听器内部主动使用新线程执行耗时操作</li>
</ul>
<p>这条链路的好处在于：</p>
<ul>
<li>
<p>保存门店的主流程对“谁在监听这个事件”是无感知的；</p>
</li>
<li>
<p>新增或删除监听器只影响监听方代码，不需要修改 <code>ShopApplicationService</code> ；</p>
</li>
</ul>
<h2 data-id="heading-2"><strong>实战落地建议</strong></h2>
<p><strong>尽量为每类事件提供单独的发布器</strong></p>
<ul>
<li>比如 <code>ShopCreationEventPublisher</code>、<code>ShopUpdatePublisher</code>，而不是在业务代码里直接拿 <code>ApplicationEventPublisher</code></li>
<li>便于后续在发布器层面统一做日志、限流或埋点</li>
</ul>
<p><strong>事件命名和字段保持业务语义清晰</strong></p>
<ul>
<li><code>ShopCreationEvent</code> 这种名称比“门店变更事件”更具体</li>
<li>事件体只放必要字段，比如 <code>shopId</code>、事件类型 code，避免变成“大而全 DTO`</li>
</ul>
<p><strong>监听器职责要单一</strong></p>
<ul>
<li>一个监听器专注做一件事情</li>
<li>如果后续还有“新门店初始化库存”、“新门店推送消息”等，可以新建监听器按职责拆分</li>
</ul>
<p><strong>异步处理尽早抽象到统一机制</strong></p>
<ul>
<li>目前上面的代码使用 <code>new Thread</code>。这个是不太合理的， 应该是用线程池。</li>
</ul>
<p>在不引入 MQ 的前提下，基于 ApplicationEventPublisher 的这种本地事件机制，可以在保持代码结构清晰的同时，给系统预留足够的扩展点，对很多中小体量的业务来说，这种方案已经足够实用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JVM 为什么能跨平台？JIT 凭什么“越跑越快”？——用几个例子把核心讲透]]></title>    <link>https://juejin.cn/post/7597764707035398195</link>    <guid>https://juejin.cn/post/7597764707035398195</guid>    <pubDate>2026-01-22T06:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597764707035398195" data-draft-id="7597989474971861042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JVM 为什么能跨平台？JIT 凭什么“越跑越快”？——用几个例子把核心讲透"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T06:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JVM 为什么能跨平台？JIT 凭什么“越跑越快”？——用几个例子把核心讲透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:22:43.000Z" title="Thu Jan 22 2026 06:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>引子：为什么不直接按平台编机器码？</strong></p>
<p>很多人（包括当年的我）在初学 Java 时都有个直觉上的疑惑：</p>
<blockquote>
<p>“为什么 Java 非要弄个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3DJVM%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=JVM&amp;zhida_source=entity" ref="nofollow noopener noreferrer">JVM</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=%E8%99%9A%E6%8B%9F%E6%9C%BA&amp;zhida_source=entity" ref="nofollow noopener noreferrer">虚拟机</a>？多了一层中间层，肯定比直接跑机器码慢啊！既然要跨平台，我直接像 C++ 那样，给 Windows 编个 .exe，给 Linux 编个 ELF，不也一样能跑吗？”</p>
</blockquote>
<p>这个直觉很正常，但它忽略了软件工程中两个最头疼的问题：<strong>交付成本</strong> 和 <strong>运行时优化的上限</strong>。</p>
<p>Java 设计这套“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25AD%2597%25E8%258A%2582%25E7%25A0%2581%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=%E5%AD%97%E8%8A%82%E7%A0%81&amp;zhida_source=entity" ref="nofollow noopener noreferrer">字节码</a> + 虚拟机”的体系，真正想解决的并不是“能不能跑”，而是：<strong>能不能用同一份交付物，在不同平台上保持一致语义，并在运行时拿到足够信息把性能拉回来。</strong></p>
<p>今天我们就抛开那些晦涩的 JVM 规范，用三个最关键的问题，配合代码实例，把 <strong>跨平台、JIT（<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258D%25B3%25E6%2597%25B6%25E7%25BC%2596%25E8%25AF%2591%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91&amp;zhida_source=entity" ref="nofollow noopener noreferrer">即时编译</a>）、AOT（<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%258F%2590%25E5%2589%258D%25E7%25BC%2596%25E8%25AF%2591%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=%E6%8F%90%E5%89%8D%E7%BC%96%E8%AF%91&amp;zhida_source=entity" ref="nofollow noopener noreferrer">提前编译</a>）</strong>  的核心逻辑讲透。</p>
<hr/>
<h3 data-id="heading-0">① JVM 跨平台：跨的到底是什么？</h3>
<p>我们常挂在嘴边的“一次编写，到处运行（Write Once, Run Anywhere）”，很多人理解偏了。它指的不是源码层面的可移植，而是 <strong>二进制层面的可移植</strong>。</p>
<h3 data-id="heading-1">1.1 源码可移植 vs 二进制可移植</h3>
<p>C++ 是典型的“源码可移植”。你写一份代码，在 Windows 上用 MSVC 编译，在 Linux 上用 GCC 编译。虽然源码一样，但编译出来的产物是两码事。</p>
<p>Java 走的是 <strong>二进制可移植</strong> 路线。javac 编译器生成的 <code>.class</code> 文件或 <code>.jar</code> 包，是一种<strong>与硬件和操作系统无关的中间格式</strong>。 这意味着，你编译好的这个 jar 包，既不需要关心不仅不需要关心是跑在 x86 还是 ARM 上，也不需要关心底下是 Linux 还是 Windows。</p>
<h3 data-id="heading-2">1.2 JVM 是你的“系统代理人”</h3>
<p>那么，谁来处理差异？<strong>JVM</strong>。 你可以把 JVM 想象成一个翻译官，它屏蔽了底层操作系统的 <strong>线程模型、内存管理、IO 模型、ABI（应用程序二进制接口）</strong>  等差异。</p>
<p><strong>来看一个最经典的例子：<code>new Thread()</code></strong></p>
<p>我们在 Java 里启动一个线程，通常只需要两行代码：</p>
<pre><code class="hljs language-scss" lang="scss">new <span class="hljs-built_in">Thread</span>(() -&gt; {
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(「Hello from thread!」);
})<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>作为开发者，你<strong>不需要</strong>知道：</p>
<ul>
<li>Linux 上是用 <code>pthread</code> 库还是 <code>clone</code> 系统调用？</li>
<li>Windows 上是用 <code>CreateThread</code> 还是 <code>_beginthreadex</code>？</li>
<li>不同架构下，栈空间怎么分配？线程本地存储（TLS）怎么处理？</li>
</ul>
<p>这些脏活累活，全被 JVM 的不同平台实现版本（Windows 版 JDK、Linux 版 JDK）默默扛下了。这就是 JVM 存在的最大工程意义：<strong>它让应用层看到的，是一个统一的、标准的运行时环境。</strong></p>
<h3 data-id="heading-3">② 为什么不走“多产物”路线？</h3>
<p>回到开头的问题：“我勤快点，给每个平台分别编译一个版本不行吗？”</p>
<p>行，但代价是巨大的。这本质上是在把 <strong>JVM 该做的事，下放到了你的项目里</strong>。</p>
<h3 data-id="heading-4">2.1 交付与测试矩阵的噩梦</h3>
<p>假设你的公司开发一款软件，需要支持 Windows、Linux、macOS，同时还要兼顾 x86_64 和 ARM64 架构。</p>
<ul>
<li><strong>如果是 C/C++ 模式（多产物）：</strong>  你需要维护一个庞大的产物矩阵：<code>win-x64</code>、<code>Linux-x64</code>、<code>Linux-arm64</code>、<code>mac-arm64</code>… 每次发版，CI/CD 流水线要跑 N 遍；每次修 Bug，要验证是不是只在某个特定架构下才崩溃；还要处理不同系统的依赖库版本冲突。</li>
<li><strong>如果是 Java 模式（单一产物）：</strong>  你只需要交付一个 <code>app.jar</code>。 运维只需要在目标机器上安装对应版本的 JVM。只要 JVM 符合规范，你的 jar 包就能跑出一致的效果。</li>
</ul>
<p><strong>总结就是：</strong>  Java 选择把复杂度集中在 <strong>JVM 和标准库</strong> 这一层，从而解放了千千万万的应用层开发者。你当然可以说“我愿意维护多平台产物”，但你做得越多，就越接近 C++ 的工程代价，背离了 Java 的初衷。</p>
<h3 data-id="heading-5">③ JIT：为什么代码会“越跑越快”？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4ad43903c164e8fb500bda0254591a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769667763&amp;x-signature=LPIZ7ljTlBvjfeNgoRldb7fzK%2B8%3D" alt="" loading="lazy"/></p>
<p>这是 Java 最被误解，也最“黑科技”的地方。 很多人以为 JIT（Just-In-Time Compiler）只是把字节码翻译成机器码，省去了“解释执行”的开销。 <strong>错！JIT 真正的杀手锏是：运行时画像（Profile）驱动的投机优化。</strong></p>
<h3 data-id="heading-6">3.1 分层编译：先跑起来，再变快</h3>
<p>HotSpot 虚拟机采用的是 <strong>分层编译（Tiered Compilation）</strong>  策略：</p>
<ol>
<li><strong>冷启动（解释器/C1）：</strong>  代码刚开始跑，先用解释器解释执行，或者用轻量级编译器（C1）编译，目的是<strong>快速启动</strong>，让系统先能用。</li>
<li><strong>热身（收集画像）：</strong>  在跑的过程中，JVM 会默默收集信息：哪些方法被调用得最多？哪个 if 分支一直走的是 true？</li>
<li><strong>峰值性能（C2）：</strong>  当某段代码“热”到一定程度，JVM 会启动重量级编译器（C2），利用刚才收集的信息，生成极其激进的高质量机器码。</li>
</ol>
<h3 data-id="heading-7">3.2 运行时画像：C++ 编译器拿不到的“作弊器”</h3>
<p>静态编译器（如 GCC）在编译时只能“猜”代码会怎么跑。但 JIT 在运行时，是<strong>亲眼看着</strong>代码跑的。它可以做一些静态编译器不敢做的优化，比如：</p>
<ul>
<li><strong>激进内联（Inlining）：</strong>  把小方法直接摊平，减少调用开销。</li>
<li><strong>去虚化（Devirtualization）：</strong>  虽然你写的是接口调用 <code>List.add</code>，但 JIT 发现你 99% 的情况传进来的都是 <code>ArrayList</code>，它就会直接生成调用 <code>ArrayList.add</code> 的机器码，省去虚方法表查找。</li>
<li><strong>分支预测优化：</strong>  如果一个 <code>if (x &gt; 0)</code> 在前 1 万次里都是 true，JIT 就敢直接按 true 编译，把 false 的分支扔掉（或者放得很远）。万一后来变成了 false 怎么办？JVM 会触发 <strong>Deoptimization（逆优化/回退）</strong> ，退回到解释模式重新来过。</li>
</ul>
<h3 data-id="heading-8">3.3 动手实测：亲眼看见 JIT 干活</h3>
<p>我们可以用一段简单的“热循环”代码，配合 JVM 参数，观测 JIT 的介入。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JitDemo</span> {
    <span class="hljs-comment">// 模拟一个简单的计算任务</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{
        <span class="hljs-type">long</span> s = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) s += i;
        <span class="hljs-keyword">return</span> s;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">long</span> x = <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 循环调用足够多次，触发 JIT</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> r = <span class="hljs-number">0</span>; r &lt; <span class="hljs-number">50</span>_000; r++) {
            x ^= <span class="hljs-built_in">sum</span>(<span class="hljs-number">10</span>_000);
        }
        System.out.<span class="hljs-built_in">println</span>(「Result: 」 + x);
    }
}
</code></pre>
<p><strong>复现步骤与观测：</strong></p>
<p>你可以尝试在命令行使用以下参数运行：</p>
<ol>
<li><strong>观察编译过程：</strong> <code>Java -XX:+PrintCompilation JitDemo</code><strong>现象：</strong>  你会看到控制台疯狂刷屏，输出了很多带有 <code>%</code>、<code>s!</code> 等符号的日志。这代表 <code>sum</code> 方法和 <code>main</code> 循环体正在被 JVM 从解释器升级到 C1，再升级到 C2 编译。</li>
<li><strong>强制解释模式（慢动作）：</strong> <code>Java -Xint JitDemo</code><strong>现象：</strong>  运行速度会明显变慢，因为禁止了 JIT，所有代码都在解释执行。</li>
<li><strong>打印内联决策（进阶）：</strong> <code>Java -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining JitDemo</code><strong>现象：</strong>  JVM 会告诉你，它决定把 <code>sum</code> 方法的代码“搬”到 <code>main</code> 方法里去了（Inlined），消除了方法调用的开销。</li>
</ol>
<p>这就是为什么 Java 服务通常需要“预热”——它需要时间来收集画像，完成从“能用”到“高性能”的蜕变。</p>
<h3 data-id="heading-9">④ AOT：为什么说它“牺牲了动态性”？</h3>
<p>既然 JIT 这么强，为什么现在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3DGraalVM%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=GraalVM&amp;zhida_source=entity" ref="nofollow noopener noreferrer">GraalVM</a> 的 <strong>AOT（Native Image）</strong>  又火了？因为它解决了 Java 的痛点：<strong>启动慢、内存占用大</strong>。 AOT 把编译提前到了构建阶段，直接生成机器码，启动即巅峰。</p>
<p>但天下没有免费的午餐。AOT 必须要面对一个核心限制：<strong>闭世界假设（Closed World Assumption）</strong> 。</p>
<h3 data-id="heading-10">4.1 什么是闭世界假设？</h3>
<p>JIT 可以在运行时加载新的类，可以随时动态生成新的字节码。但 AOT 编译器在构建时必须知道： <strong>“这一辈子，你会用到哪些类、哪些方法？”</strong></p>
<p>这就好比你去旅行（运行程序）：</p>
<ul>
<li><strong>JIT 模式：</strong>  带着钱（JVM），缺什么路上随时买（动态加载）。</li>
<li><strong>AOT 模式：</strong>  出发前必须把箱子打包好（编译成二进制）。如果在路上你想用牙刷，但打包时没放进去，那你就在运行时用不了。</li>
</ul>
<h3 data-id="heading-11">4.2 反射与动态代理的代价</h3>
<p>Java 强大的 <strong>反射</strong> 和 <strong>动态代理</strong>，天然是“运行时决定”的。 比如 <code>Class.forName(「com.MySQL.jdbc.Driver」)</code>，编译器在静态分析时，很难知道这个字符串到底对应哪个类。</p>
<p>因此，使用 AOT 时，你必须<strong>显式配置</strong>或使用辅助工具（Tracing Agent），告诉编译器：“嘿，我运行时可能会用到 <code>com.MySQL.jdbc.Driver</code>，请把它打包进去。” <strong>这就是所谓的“牺牲动态性”——其实不是不能用，而是把“运行期的随心所欲”变成了“构建期的严格声明”。</strong></p>
<h3 data-id="heading-12">⑤ 两个关键补充</h3>
<p>最后，为了让大家对这套体系的理解更完整，补充两点：</p>
<ol>
<li><strong>JMM（Java 内存模型）：跨平台的“里子”</strong>  跨平台不仅是 API 一致，还要 <strong>并发语义一致</strong>。不同 CPU（x86, ARM）对内存读写的乱序处理是不同的。JMM 定义了一套规范（Happens-Before 原则），强制 JVM 在底层处理好 <code>volatile</code>、<code>synchronized</code> 等指令在不同 CPU 上的内存屏障。这保证了你的并发代码在 Linux 和 Windows 上跑出来的结果是一样的。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269126699%26content_type%3DArticle%26match_order%3D1%26q%3DJNI%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269126699&amp;content_type=Article&amp;match_order=1&amp;q=JNI&amp;zhida_source=entity" ref="nofollow noopener noreferrer">JNI</a>：跨平台的“边界”</strong>  一旦你的 Java 代码通过 JNI（Java Native Interface）调用了 C/C++ 库，<strong>跨平台特性立刻失效</strong>。你需要为每个平台提供对应的 <code>.dll</code> 或 <code>.so</code>。这也是为什么现在的 Java 生态尽量推崇 “Pure Java” 依赖的原因。</li>
</ol>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p>JVM 的设计哲学，本质上是一场  <strong>“开发效率”与“运行效率”的宏大交易</strong>。</p>
<ol>
<li><strong>JVM 跨平台</strong>：通过统一的字节码和运行时层，把“多平台适配”的复杂度从应用开发者转移给了 JVM 实现者。<strong>交付物从“N 个产物”变成了“1 个 jar”</strong> 。</li>
<li><strong>JIT 越跑越快</strong>：利用 <strong>运行时画像</strong> 做投机优化（内联、去虚化），虽然有预热成本，但能达到甚至超越静态编译的峰值性能。</li>
<li><strong>AOT 的取舍</strong>：基于 <strong>闭世界假设</strong>，用构建期的严格扫描换取了极速启动和低内存，但需要开发者手动处理动态特性。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中后台表格选型（Element/VXE/AntD）：我在真实项目里踩过的坑，比 Demo 多得多]]></title>    <link>https://juejin.cn/post/7597742970281132084</link>    <guid>https://juejin.cn/post/7597742970281132084</guid>    <pubDate>2026-01-22T06:22:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281132084" data-draft-id="7597724783649194024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中后台表格选型（Element/VXE/AntD）：我在真实项目里踩过的坑，比 Demo 多得多"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-22T06:22:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="parade岁月"/> <meta itemprop="url" content="https://juejin.cn/user/3773179639113831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中后台表格选型（Element/VXE/AntD）：我在真实项目里踩过的坑，比 Demo 多得多
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3773179639113831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    parade岁月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:22:34.000Z" title="Thu Jan 22 2026 06:22:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>时间：2026/01/22</p>
<p>如果你的项目出现过这些情况：</p>
<ul>
<li>表格一加固定列就开始样式错位</li>
<li>demo 跑得完美，上线后不断改 bug</li>
<li>合并单元格 + 虚拟滚动总会存在样式问题或者性能问题</li>
</ul>
<p><strong>别怀疑自己代码水平，90% 是选型问题。</strong></p>
<p>在 Vue 生态里，表格组件的真正难点从来不是"有没有某个功能"，而是：</p>
<blockquote>
<p><strong>当固定列、多级表头、单元格合并、虚拟滚动这些能力叠加时，它还能不能稳定工作。</strong></p>
</blockquote>
<p>这篇文章基于真实业务测试，对比 Element Plus / VXE / Ant Design Vue / TanStack 四大方案，<strong>只讲工程实践，不堆功能清单</strong>。</p>
<h2 data-id="heading-0">一、结论前置：不同场景怎么选</h2>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>原因</th></tr></thead><tbody><tr><td>小中型项目 + 追求稳定交付</td><td>Element Plus Table / Ant Design Vue</td><td>默认观感稳定，开箱即用</td></tr><tr><td>大数据量（1k 行以上）</td><td>VXE Grid / Table V2</td><td>内建虚拟滚动，性能无压力</td></tr><tr><td>高度定制 + 团队能力强</td><td>TanStack Table+TanStack Virtual</td><td>headless 架构，完全自主可控</td></tr><tr><td>表格是核心业务 + 复杂交互</td><td>VXE Grid</td><td>企业级能力最完整</td></tr></tbody></table>
<p><strong>一个底线必须明确：</strong></p>
<blockquote>
<p>一旦业务出现「合并 + 固定 + 虚拟滚动」组合，选型阶段不谨慎，后期一定持续返工。</p>
</blockquote>
<h2 data-id="heading-1">二、真正拉开差距的 6 个关键点</h2>
<h3 data-id="heading-2">1️⃣ 默认观感：不是"好看"，而是"稳定"</h3>
<p>很多人评价表格只看 UI 美不美，但工程上更重要的是：<strong>默认状态能不能直接上线</strong>。</p>
<ul>
<li><strong>Element Plus / Ant Design Vue</strong>：边框、hover、斑马纹开箱即用，不需要额外调样式</li>
<li><strong>VXE Grid</strong>：默认不启用 hover 高亮，新手容易误判为"交互不完整"</li>
<li><strong>TanStack</strong>：完全 headless，所有样式自己写</li>
</ul>
<p><strong>个人测试中：</strong> 同样的需求，用 Element Plus 1 天交付，用 TanStack 可能要 3 天才能调好样式。</p>
<blockquote>
<p>如果团队 UI 能力有限，默认观感稳定比可定制性更重要。</p>
</blockquote>
<h3 data-id="heading-3">2️⃣ 滚动条体验：最容易被低估的致命伤</h3>
<p>在这些场景组合下：</p>
<ul>
<li>固定表头 + 固定右列 + 纵向滚动</li>
</ul>
<p>滚动条的<strong>同步性、对齐度、视觉一致性</strong>会直接影响可用性。</p>
<p><strong>个人测试结论：</strong></p>
<ul>
<li>Element Plus 的 Scrollbar 在复杂固定列场景下UI最好</li>
<li>Ant / VXE 的滚动条看起来怪怪的，特别是表头</li>
</ul>
<blockquote>
<p>表格组件最容易被低估的不是功能，而是滚动条体验。</p>
</blockquote>
<h3 data-id="heading-4">3️⃣ 虚拟滚动：1k 行数据的生存线</h3>
<p>当数据量达到 <strong>1000 行以上</strong>：</p>
<ul>
<li>Element Plus Table / Ant Design Vue Table 已明显卡顿</li>
<li>是否支持虚拟滚动，直接决定组件还能不能继续用</li>
</ul>



































<table><thead><tr><th>方案</th><th>行虚拟滚动</th><th>列虚拟滚动</th></tr></thead><tbody><tr><td>Element Plus Table</td><td>❌</td><td>❌</td></tr><tr><td>Element Plus Table V2</td><td>✅</td><td>✅</td></tr><tr><td>Ant Design Vue Table</td><td>❌</td><td>❌</td></tr><tr><td>VXE Grid</td><td>✅</td><td>✅</td></tr><tr><td>TanStack Table</td><td>需接入 @tanstack/virtual</td><td>需接入 @tanstack/virtual</td></tr></tbody></table>
<p>⚠️ <strong>Table V2 的坑</strong>：虚拟滚动开启后，单元格合并、固定列的组合行为会出现意外 bug。</p>
<blockquote>
<p>虚拟滚动不是加分项，而是复杂中后台表格的生存线。</p>
</blockquote>
<h3 data-id="heading-5">4️⃣ 单元格合并：真正难的是"组合行为"</h3>
<p>合并本身不难实现，难的是它要和这些能力同时存在：</p>
<ul>
<li>hover 高亮</li>
<li>行选中 / 多选</li>
<li>固定列边框</li>
</ul>
<p><strong>典型失败表现：</strong></p>
<ul>
<li>hover 背景不协调（合并区域的子单元格没有高亮）</li>
<li>合并区域选中时复选框异常</li>
</ul>
<p><strong>个人测试中：</strong></p>
<ul>
<li>Element Plus Table：用 <code>span-method</code>，小规模场景稳定</li>
<li>Ant Design Vue也很nice</li>
<li>Table V2：简单 demo 没问题，复杂组合会集中暴露 bug</li>
<li>VXE Grid：内建合并能力最完善，边界情况处理最好</li>
<li>行选中同单元格一起合并都不支持</li>
</ul>
<blockquote>
<p>如果你的表格需要「合并 + 固定列 + 虚拟滚动」同时存在，务必先做完整测试再选型。</p>
</blockquote>
<h3 data-id="heading-6">5️⃣ 树形表格 + 懒加载：</h3>
<p>树形表格看起来简单，但要支持<strong>懒加载 + 展开状态管理</strong>：</p>
<ul>
<li><strong>Ant Design Vue</strong>：官方不支持树表懒加载（这是硬伤）</li>
<li><strong>其他方案</strong>：element-plus和vex内建支持</li>
</ul>
<h3 data-id="heading-7">6️⃣ 列筛选：复杂时应该"脱离表头"</h3>
<p>大部分表格组件的列筛选都只支持：</p>
<ul>
<li>简单选项列表</li>
<li>单个输入框</li>
</ul>
<p>当筛选条件开始出现：</p>
<ul>
<li>日期范围选择</li>
<li>多条件联动（如：省市区联动）</li>
<li>复杂的数值区间</li>
</ul>
<p><strong>更合理的做法是：独立查询区，而不是死磕表头。</strong></p>

























<table><thead><tr><th>方案</th><th>内建筛选能力</th></tr></thead><tbody><tr><td>Element Plus Table</td><td>仅选项列表</td></tr><tr><td>Ant Design Vue Table</td><td>内建筛选 + 自定义</td></tr><tr><td>VXE Grid</td><td>筛选能力强，但复杂时需额外 UI 库</td></tr><tr><td>TanStack</td><td>完全自研</td></tr></tbody></table>
<h2 data-id="heading-8">三、完整对比表（供选型参考）</h2>













































































<table><thead><tr><th>维度</th><th>Element Plus Table</th><th>Element Plus Table V2</th><th>Ant Design Vue Table</th><th>VXE Grid</th><th>TanStack Table</th></tr></thead><tbody><tr><td>默认观感</td><td>✅ 稳定</td><td>✅ 稳定</td><td>✅ 稳定（Ant 风格）</td><td>⚠️ hover 默认未开</td><td>❌ 完全自研</td></tr><tr><td>滚动条体验</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐（自研）</td></tr><tr><td>行虚拟滚动</td><td>❌</td><td>✅</td><td>❌</td><td>✅</td><td>需接入 virtual</td></tr><tr><td>列虚拟滚动</td><td>❌</td><td>✅</td><td>❌</td><td>✅</td><td>需接入 virtual</td></tr><tr><td>单元格合并</td><td>span-method</td><td>⚠️ 坑多</td><td>rowSpan / colSpan</td><td>✅ 内建</td><td>自研</td></tr><tr><td>树形 + 懒加载</td><td>✅</td><td>需自研</td><td>❌ 不支持</td><td>✅</td><td>自研</td></tr><tr><td>列筛选</td><td>仅选项</td><td>自研</td><td>内建</td><td>内建</td><td>自研</td></tr><tr><td>个性化列</td><td>自研</td><td>自研</td><td>自研</td><td>内建 toolbar</td><td>状态内建</td></tr></tbody></table>
<h2 data-id="heading-9">四、工具链落地：从选型到上线</h2>
<h3 data-id="heading-10">第一步：验证核心组合场景</h3>
<p><strong>不要只跑 demo，必须测试这些组合：</strong></p>
<ol start="0">
<li>固定列 + 多级表头 + 单元格合并</li>
<li>虚拟滚动 + 树形结构 + 懒加载</li>
<li>1000 行数据 + 筛选 + 排序</li>
</ol>
<p><strong>测试清单：</strong></p>
<pre><code class="hljs language-diff" lang="diff">// 1. 固定列对齐
<span class="hljs-deletion">- 横向滚动时左右固定列是否有阴影/边框</span>
<span class="hljs-deletion">- 滚动条是否同步</span>
<span class="hljs-deletion">- hover 高亮是否完整</span>
​
// 2. 单元格合并
<span class="hljs-deletion">- 合并区域 hover 是否错位</span>
<span class="hljs-deletion">- 固定列边框是否断裂</span>
<span class="hljs-deletion">- 选中逻辑是否正常</span>
​
// 3. 虚拟滚动
<span class="hljs-deletion">- 快速滚动时是否白屏</span>
<span class="hljs-deletion">- 固定列是否错位</span>
<span class="hljs-deletion">- 合并单元格是否异常</span>
</code></pre>
<h4 data-id="heading-11">阶段总结</h4>
<p>验证完这些组合场景，至少能排除 50% 的不适配方案。</p>
<h3 data-id="heading-12">第二步：评估团队能力与时间成本</h3>

























<table><thead><tr><th>团队情况</th><th>推荐方案</th></tr></thead><tbody><tr><td>前端 2-3 人，追求快速交付</td><td>Element Plus / Ant Design Vue</td></tr><tr><td>有专职 UI 开发，追求定制化</td><td>TanStack + 自研</td></tr><tr><td>表格是核心业务，需要企业级能力</td><td>VXE Grid</td></tr><tr><td>大数据量 + 性能要求高</td><td>Table V2 / VXE Grid</td></tr></tbody></table>
<p><strong>真实项目经验：</strong></p>
<ul>
<li>用 Element Plus Table和Ant Design Vue 做普通后台，1 周交付</li>
<li>用 TanStack 做同样需求，3 周才稳定（样式 + 交互全自研）</li>
<li>用 VXE Grid 做复杂报表，2 周交付（但学习成本稍高）</li>
</ul>
<h4 data-id="heading-13">阶段总结</h4>
<p>选型不仅是技术问题，更是<strong>时间成本 + 团队能力</strong>的权衡。</p>
<h3 data-id="heading-14">第三步：建立组件封装规范</h3>
<p><strong>无论选哪个方案，都要做二次封装：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误示范：直接用原始组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span> <span class="hljs-attr">...</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">...</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- 正确示范：封装业务组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">business-table</span>
  <span class="hljs-attr">:columns</span>=<span class="hljs-string">"columns"</span>
  <span class="hljs-attr">:data-source</span>=<span class="hljs-string">"dataSource"</span>
  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">"rowKey"</span>
/&gt;</span>
</code></pre>
<p><strong>封装收益：</strong></p>
<ul>
<li>统一默认配置（如 hover / 边框 / 斑马纹）</li>
<li>统一 loading / error 处理</li>
<li>统一分页逻辑</li>
<li>后续替换方案成本低</li>
</ul>
<h4 data-id="heading-15">阶段总结</h4>
<p>二次封装不是过度设计，而是降低后期返工成本的必要手段。</p>
<h2 data-id="heading-16">五、如果让我重新选型</h2>
<p>基于真实项目经验，我会这样选：</p>
<p><strong>场景 1：普通中后台（CRUD 为主）</strong></p>
<ul>
<li>首选：<strong>Element Plus Table</strong>和<strong>Ant Desing Vue</strong></li>
<li>理由：稳定、文档全、生态好、招人容易</li>
</ul>
<p><strong>场景 2：数据量大（1k 行以上）</strong></p>
<ul>
<li>首选：<strong>VXE Grid</strong></li>
<li>理由：虚拟滚动稳定、企业级能力完整</li>
</ul>
<p><strong>场景 3：高度定制（如数据可视化平台）</strong></p>
<ul>
<li>首选：<strong>TanStack Table</strong></li>
<li>理由：headless 架构，完全可控</li>
</ul>
<p><strong>场景 4：预算充足 + 复杂交互</strong></p>
<ul>
<li>可考虑：<strong>AG Grid（付费版）</strong></li>
<li>理由：企业级方案最成熟（但本文不展开）</li>
</ul>
<p><strong>场景5：在已有Element Plus或者Ant Design Vue的情况下，需要处理大数据</strong></p>
<ul>
<li>可考虑再接入<strong>VXE Gid</strong>，甚至可能还要接入完整的Vxe UI，此外还要评估带来的css的副作用</li>
</ul>
<p><strong>但有一个底线：</strong></p>
<blockquote>
<p>一旦出现「合并 + 固定 + 虚拟滚动」组合，务必先做完整测试。 选型阶段省的时间，后期会加倍还回来。</p>
</blockquote>
<h2 data-id="heading-17">六、常见问题速查</h2>
<p><strong>Q1：Table V2 和 VXE Grid 怎么选？</strong></p>
<ul>
<li>Table V2：Element 生态统一，学习成本低，但复杂组合有坑</li>
<li>VXE Grid：企业级能力最完整，但学习曲线陡、文档不如 Element 友好</li>
</ul>
<p><strong>Q2：一定要用虚拟滚动吗？</strong></p>
<ul>
<li>数据量 &lt; 500 行：不需要</li>
<li>数据量 500-1000 行：建议用</li>
<li>数据量 &gt; 1000 行：必须用</li>
</ul>
<p><strong>Q3：TanStack 适合新手吗？</strong></p>
<p>不适合。它是"表格引擎"，不是"表格组件"，所有 UI 要自己写。</p>
<p><strong>Q4：已经用了不合适的方案，怎么办？</strong></p>
<ul>
<li>如果只是样式问题：二次封装兜底</li>
<li>如果是能力缺失：评估迁移成本，必要时重构</li>
<li>如果是性能问题：优先上虚拟滚动或分页</li>
</ul>
<h2 data-id="heading-18">参考链接</h2>
<ul>
<li>Element Plus Table：<a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fcomponent%2Ftable" target="_blank" title="https://element-plus.org/zh-CN/component/table" ref="nofollow noopener noreferrer">element-plus.org/zh-CN/compo…</a></li>
<li>Element Plus Table V2：<a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fcomponent%2Ftable-v2" target="_blank" title="https://element-plus.org/zh-CN/component/table-v2" ref="nofollow noopener noreferrer">element-plus.org/zh-CN/compo…</a></li>
<li>Ant Design Vue Table：<a href="https://link.juejin.cn?target=https%3A%2F%2Fantdv.com%2Fcomponents%2Ftable-cn" target="_blank" title="https://antdv.com/components/table-cn" ref="nofollow noopener noreferrer">antdv.com/components/…</a></li>
<li>VXE Table：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvxetable.cn%2F" target="_blank" title="https://vxetable.cn/" ref="nofollow noopener noreferrer">vxetable.cn/</a></li>
<li>TanStack Table：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Ftable%2Flatest" target="_blank" title="https://tanstack.com/table/latest" ref="nofollow noopener noreferrer">tanstack.com/table/lates…</a></li>
</ul>
<p><strong>在线示例：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fastonishing-peony-a9d523.netlify.app" target="_blank" title="https://astonishing-peony-a9d523.netlify.app" ref="nofollow noopener noreferrer">astonishing-peony-a9d523.netlify.app</a> <strong>源码仓库：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparade0393%2Fstudu-cli" target="_blank" title="https://github.com/parade0393/studu-cli" ref="nofollow noopener noreferrer">github.com/parade0393/…</a></p>
<p><strong>最后提醒：</strong></p>
<p>表格选型没有"最好"，只有"最合适"。</p>
<p>但如果你不想后期持续返工，选型阶段多花 2 天做完整测试，绝对值得。</p>
<p>欢迎在评论区分享你踩过的坑 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI内容生成器：为小红书/公众号作者开发SwiftUI工具]]></title>    <link>https://juejin.cn/post/7597900782911111187</link>    <guid>https://juejin.cn/post/7597900782911111187</guid>    <pubDate>2026-01-22T06:32:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597900782911111187" data-draft-id="7597811700284784659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI内容生成器：为小红书/公众号作者开发SwiftUI工具"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2026-01-22T06:32:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JZXStudio"/> <meta itemprop="url" content="https://juejin.cn/user/3871828097898218"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI内容生成器：为小红书/公众号作者开发SwiftUI工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871828097898218/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JZXStudio
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:32:14.000Z" title="Thu Jan 22 2026 06:32:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">为什么你需要一个“内容操作系统”？用 SwiftUI 打造跨平台 AI 内容生成器</h2>
<p>在今天的内容创作生态中，一个残酷的现实摆在每位创作者面前：<strong>你不能只在一个平台发声</strong>。小红书需要高颜值的九宫格图文，微信公众号则期待逻辑严密的长文；抖音追求快节奏的情绪冲击，而视频号又希望你兼顾深度与传播。这种“多平台分发”的常态，正在将创作者拖入一场无休止的格式转换与内容重写泥潭。</p>
<p>有没有一种可能，让创作回归本质，而将繁琐的格式适配交给工具？答案是肯定的。本文将为你揭示如何利用 <strong>SwiftUI + Core Data + 多模态 AI</strong>，构建一个真正属于创作者的“内容操作系统”——一个能在 iOS 与 macOS 上无缝运行、本地优先、AI 辅助、一键导出多平台格式的智能内容生成器。</p>
<h3 data-id="heading-1">一、内容创作者的“多平台困境”：小红书 vs 公众号</h3>
<p>要设计一款真正解决痛点的工具，首先必须深刻理解目标平台的内容基因。</p>
<p><strong>小红书</strong> 是一个以“视觉驱动”为核心的社区。用户滑动屏幕的速度极快，决定是否停留的关键往往在前0.5秒。因此，内容必须具备：</p>
<ul>
<li><strong>强视觉吸引力</strong>：高清、统一色调、构图精美的图片是基础。</li>
<li><strong>爆款标题</strong>：通常包含情绪词（“绝了！”、“救命！”）、数字（“3步搞定”）、痛点直击（“再也不怕…”）。</li>
<li><strong>标签精准</strong>：#OOTD、#好物分享、#干货 等标签是流量的入口。</li>
<li><strong>内容轻量化</strong>：正文通常简短，核心信息在图片中呈现，形成“九宫格叙事”。</li>
</ul>
<p>反观 <strong>微信公众号</strong>，它更像一个“思想沉淀”的场域。读者愿意花时间阅读，期待的是：</p>
<ul>
<li><strong>结构清晰的长文</strong>：有引言、论点、论据、结论。</li>
<li><strong>深度与价值</strong>：提供独到见解、系统方法论或详实数据。</li>
<li><strong>专业排版</strong>：段落分明、重点突出、引用规范，Markdown 是许多创作者的首选格式。</li>
<li><strong>品牌一致性</strong>：文风、视觉风格需长期稳定，建立信任。</li>
</ul>
<p>这两种截然不同的内容范式，迫使创作者在同一个创意下，进行两次甚至多次的“再创作”。这不仅是时间的浪费，更是创造力的损耗。</p>
<h3 data-id="heading-2">二、提出解决方案：“内容操作系统”的概念</h3>
<p>我们不妨跳出“工具”的思维，引入“操作系统”的视角。一个优秀的操作系统，应该能：</p>
<ol>
<li><strong>统一管理核心资产</strong>（你的创意、草稿、素材）。</li>
<li><strong>提供强大的生产力接口</strong>（AI 辅助生成）。</li>
<li><strong>无缝适配不同“硬件”</strong>（小红书、公众号等平台）。</li>
</ol>
<p>基于此，我们构想的 AI 内容生成器，其核心不是取代创作者，而是成为创作者的“第二大脑”和“格式翻译官”。它将一次性的创意输入，高效地转化为符合各平台调性的输出。</p>
<h3 data-id="heading-3">三、技术架构详解：SwiftUI + Core Data + AI API 的整合逻辑</h3>
<h4 data-id="heading-4">1. 共享数据模型：Core Data 的威力</h4>
<p>整个应用的基石是一个精心设计的 <strong>Core Data 数据模型</strong>。我们定义一个核心实体 <code>ContentDraft</code>，它包含以下关键属性：</p>
<ul>
<li><code>title</code>: 核心标题（AI 生成后可手动修改）。</li>
<li><code>keywords</code>: 创意关键词（用户的原始输入）。</li>
<li><code>longFormContent</code>: 长文正文（用于公众号）。</li>
<li><code>shortNotes</code>: 短图文案（用于小红书）。</li>
<li><code>imageSuggestions</code>: 一个关系型子实体，存储 AI 建议的配图描述（如“明亮厨房，一杯咖啡，笔记本电脑，窗外阳光”）。</li>
<li><code>platformTags</code>: 平台特定的标签建议。</li>
</ul>
<p>得益于 Core Data 对 Apple 全平台的原生支持，这个数据模型可以<strong>无缝共享于 iOS 和 macOS 应用之间</strong>。你在 iPhone 上记录的灵感，回到家打开 Mac，立刻就能在更大的屏幕上继续编辑和完善。所有数据都持久化在本地，无需担心网络延迟或服务器故障。</p>
<h4 data-id="heading-5">2. 平台特定 UI：SwiftUI 的声明式优势</h4>
<p>SwiftUI 的声明式语法和强大的状态管理，让我们能轻松实现“一套逻辑，两套界面”。</p>
<ul>
<li><strong>在 iOS 上</strong>，界面设计为快速捕捉灵感的移动优先体验。主界面是一个卡片流，点击即可进入编辑。底部有醒目的“AI 生成”按钮，一键根据关键词填充标题、正文和配图建议。</li>
<li><strong>在 macOS 上</strong>，界面则转变为生产力工作站。采用侧边栏导航，主区域是富文本编辑器，右侧是 AI 建议面板，可以实时预览不同平台的导出效果。</li>
</ul>
<p>通过 <code>@Environment(\.horizontalSizeClass)</code> 等环境变量，我们可以优雅地处理不同屏幕尺寸下的布局变化，确保在 iPad、MacBook、iMac 上都有最佳体验。</p>
<h4 data-id="heading-6">3. AI 集成：多模态 API 的智能赋能</h4>
<p>这是工具的“智能”所在。我们选择接入如 <strong>通义千问（Qwen-VL）</strong> 或 <strong>文心一言</strong> 这类支持多模态的 API。</p>
<ul>
<li><strong>工作流</strong>：当用户输入关键词（如“春季护肤”）并点击“生成”时，应用会向 API 发送一个结构化请求。</li>
<li><strong>API 响应</strong>：一个 JSON 对象，包含：
<ul>
<li><code>suggested_title</code>: “春季护肤大作战！3个步骤让你告别干燥暗沉”</li>
<li><code>long_form_content</code>: 一篇800字左右的公众号风格文章。</li>
<li><code>short_notes</code>: “春天来了，皮肤又干又油？试试这3招！#春季护肤 #护肤干货”</li>
<li><code>image_suggestions</code>: 一个数组，每个元素包含 <code>description</code>（文字描述）和 <code>layout_hint</code>（如“左上角叠加文案”）。</li>
</ul>
</li>
</ul>
<p>所有这些 AI 生成的内容，都会被填充到 <code>ContentDraft</code> 实体中，供用户审阅、修改和采纳。<strong>关键在于，AI 是助手，决策权始终在用户手中。</strong></p>
<h3 data-id="heading-7">四、功能演示：从输入到导出的全流程</h3>
<p>想象一下这个场景：</p>
<ol>
<li><strong>输入</strong>：你在 iPhone 上打开 App，输入关键词“周末露营装备清单”。</li>
<li><strong>AI 生成</strong>：点击按钮，几秒内，AI 为你生成了一个吸睛标题、一份详细的公众号长文（包含装备推荐理由和购买链接建议），以及一条适合小红书的短文案和三张配图建议（“帐篷特写”、“营地全景”、“美食摆拍”）。</li>
<li><strong>编辑</strong>：晚上回到家，你在 Mac 上打开 App，对长文进行润色，并根据配图建议拍摄了照片。</li>
<li><strong>一键导出</strong>：
<ul>
<li>选择“小红书模式”，App 自动将你的9张照片（含封面）拼接成标准的九宫格，并附上优化后的文案和热门标签，直接保存到相册。</li>
<li>选择“公众号模式”，App 将长文和图片导出为标准的 Markdown 文件，你可以直接将其粘贴到秀米、135编辑器等工具中，保留所有格式。</li>
</ul>
</li>
</ol>
<p>整个过程，从灵感到发布，行云流水，毫无割裂感。</p>
<h3 data-id="heading-8">五、隐私设计哲学：为何坚持本地优先</h3>
<p>在数据泄露事件频发的今天，<strong>隐私是效率工具的生命线</strong>。我们的“内容操作系统”严格遵循以下原则：</p>
<ul>
<li><strong>所有草稿、笔记、图片元数据均存储于设备本地</strong>，使用 Core Data 的 SQLite 存储，安全可靠。</li>
<li><strong>AI 请求可选脱敏</strong>：在发送请求前，用户可以选择是否移除个人身份信息。</li>
<li><strong>绝不上传原始内容</strong>：即使调用云端 AI，传输的也只是临时的、经过处理的请求数据，服务器不会留存你的任何创作内容。</li>
</ul>
<p>这种“本地优先”的设计，不仅保护了用户的隐私，也确保了在网络不佳的环境下，核心的编辑和管理功能依然可用。</p>
<h3 data-id="heading-9">六、开发者启示：如何用 Apple 生态打造垂直工具</h3>
<p>对于工具类应用开发者而言，这个案例提供了几点重要启示：</p>
<ul>
<li><strong>深挖垂直场景</strong>：不要试图做“全能”，而是聚焦于一个具体、高频、痛苦的场景（如跨平台内容分发）。</li>
<li><strong>善用 Apple 原生技术栈</strong>：SwiftUI + Core Data + CloudKit（可选同步）构成了一个强大而高效的组合，能极大降低跨平台开发成本。</li>
<li><strong>AI 是增强，不是替代</strong>：将 AI 定位为“智能辅助”，而非“全自动”，能更好地赢得专业用户的信任。</li>
<li><strong>隐私即卖点</strong>：在营销中明确强调“本地处理”、“数据不出设备”，将成为区别于竞品的核心优势。</li>
</ul>
<h3 data-id="heading-10">结语：工具即生产力</h3>
<p>未来的竞争，不再是单打独斗的内容比拼，而是<strong>创作系统效率的对决</strong>。一个能帮你将创意高效转化为多平台内容的“操作系统”，将成为每位专业创作者的必备武器。它解放的不仅是你的时间，更是你的创造力，让你能将全部精力投入到真正有价值的内容本身。</p>
<p>现在，是时候为自己打造这样一个“内容操作系统”了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 RNN 循环机制：短序列优势、长依赖问题及 LSTM 解决方案]]></title>    <link>https://juejin.cn/post/7597742970281230388</link>    <guid>https://juejin.cn/post/7597742970281230388</guid>    <pubDate>2026-01-22T06:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597742970281230388" data-draft-id="7597722671084421154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 RNN 循环机制：短序列优势、长依赖问题及 LSTM 解决方案"/> <meta itemprop="keywords" content="Python,PyTorch"/> <meta itemprop="datePublished" content="2026-01-22T06:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱开发的珍JAY"/> <meta itemprop="url" content="https://juejin.cn/user/2174176271278988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 RNN 循环机制：短序列优势、长依赖问题及 LSTM 解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2174176271278988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱开发的珍JAY
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:33:05.000Z" title="Thu Jan 22 2026 06:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RNN 简介</h2>
<p>RNN（Recurrent Neural Network，循环神经网络）一般以序列数据为输入，通过网络内部的结构设计有效捕捉序列之间的关系特征，一般也以序列形式输出。</p>
<p>RNN 的循环机制使模型隐层上一时间步产生的结果，能够作为当下时间步输入的一部分（当下时间步的输入除了正常的输入外还包括上一步的隐层输出）对当下时间步的输出产生影响。</p>
<ul>
<li>结构：三层（输入层、隐藏层、输出层；循环发生在隐藏层）</li>
<li><img src="image.png" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-1">1.1 RNN 模型的作用</h3>
<p>因为 RNN 结构能够很好利用序列之间的关系，因此针对自然界具有连续性的输入序列，如人类的语言、语音等进行很好处理，广泛应用于 NLP（自然语言处理）领域的各项任务，如文本分类、情感分析、意图识别、机器翻译等。</p>
<p>语言处理示例</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39507c18081a4539ad75e9b331624e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5byA5Y-R55qE54-NSkFZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769668385&amp;x-signature=hodSIH9rAp1TD%2FvmU1zeCNLOYuk%3D" alt="image2.png" loading="lazy"/></p>
<h4 data-id="heading-2">2.1 PyTorch 中传统 RNN 的使用</h4>
<p>位置：在 <code>torch.nn</code> 中，通过 <code>torch.nn.RNN</code> 可调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

rnn = nn.RNN(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 实例化 rnn 对象</span>
<span class="hljs-comment"># 参数1：输入张量 x 的维度 - input_size</span>
<span class="hljs-comment"># 参数2：隐藏层的维度（隐藏层神经元个数）- hidden_size</span>
<span class="hljs-comment"># 参数3：隐藏层的层数 - num_layers</span>

<span class="hljs-comment"># torch.randn - 随机产生正态分布的随机数</span>
input1 = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 设定输入张量 x - 序列长 1，批次 3，维度 5</span>
<span class="hljs-comment"># 参数1：输入序列长度 - sequence_length</span>
<span class="hljs-comment"># 参数2：批次的样本 - batch_size（表示：3 个样本）</span>
<span class="hljs-comment"># 参数3：输入张量 x 的维度 - input_size</span>

h0 = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment"># 设定初始化的 h0</span>
<span class="hljs-comment"># 第一个参数：num_layers * num_directions（层数 * 网络方向数（1 或 2））</span>
<span class="hljs-comment"># 第二个参数：batch_size（批次的样本数）</span>
<span class="hljs-comment"># 第三个参数：hidden_size（隐藏层的维度）</span>

output, hn = rnn(input1, h0)
<span class="hljs-comment"># 最后输出和最后一层的隐藏层输出</span>

<span class="hljs-built_in">print</span>(output)
<span class="hljs-built_in">print</span>(output.shape)
<span class="hljs-built_in">print</span>(hn)
<span class="hljs-built_in">print</span>(hn.shape)
</code></pre>
<h4 data-id="heading-3">1.2 RNN的局限：长期依赖（Long-TermDependencies）问题</h4>
<p>RNN的关键点之一就是他们可以用来连接先前的信息到当前的任务上，例如使用过去的视频段来推测对当前段的理解。如果RNN可以做到这个，他们就变得非常有用。但是真的可以么？答案是，还有很多依赖因素。</p>
<p>有时候，我们仅仅需要知道先前的信息来执行当前的任务。例如，我们有一个语言模型用来基于先前的词来预测下一个词。如果我们试着预测这句话中“the clouds are in the sky”最后的这个词“sky”，我们并不再需要其他的信息，因为很显然下一个词应该是sky。在这样的场景中，相关的信息和预测的词位置之间的间隔是非常小的，RNN可以学会使用先前的信息。</p>
<h4 data-id="heading-4">1.2 传统 RNN 优缺点</h4>
<ul>
<li>优势：内部结构简单，对计算资源要求低；相较 LSTM/GRU 参数总量更少；在短序列任务上性能与效果表现优异。</li>
<li>缺点：在长序列关联上表现较差；反向传播时易发生梯度消失或爆炸。</li>
</ul>
<p>NaN 值（Not a Number，非数）：是计算机科学中数值数据类型的一类值，表示未定义或不可表示的值。</p>
<h3 data-id="heading-5">2.1 LSTM 模型简介</h3>
<p>Long ShortTerm 网络——一般就叫做LSTM——是一种RNN特殊的类型，可以学习长期依赖信息。当然，LSTM和基线RNN并没有特别大的结构不同，但是它们用了不同的函数来计算隐状态。</p>
<p>LSTM的“记忆”我们叫做细胞/cells，你可以直接把它们想做黑盒，这个黑盒的输入为前状态和当前输入。这些“细胞”会决定哪些之前的信息和状态需要保留/记住，而哪些要被抹去。实际的应用中发现，这种方式可以有效地保存很长时间之前的关联信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e20a3d151d4fe09e039cbacc4f96e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5byA5Y-R55qE54-NSkFZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769668385&amp;x-signature=t0ICovyNbhhQbocK7DJxP9s9mv0%3D" alt="image3.png" loading="lazy"/></p>
<h4 data-id="heading-6">2.2 PyTorch 中 LSTM 的使用</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

lstm = nn.LSTM(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 实例化 lstm 对象</span>
<span class="hljs-comment"># 参数1：输入张量 x 的维度 - input_size</span>
<span class="hljs-comment"># 参数2：隐藏层的维度（隐藏层神经元个数）- hidden_size</span>
<span class="hljs-comment"># 参数3：隐藏层的层数 - num_layers</span>

input1 = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 设定输入张量 x - 序列长 1，批次 3，维度 5</span>
<span class="hljs-comment"># 参数1：输入序列长度 - sequence_length</span>
<span class="hljs-comment"># 参数2：批次的样本 - batch_size</span>
<span class="hljs-comment"># 参数3：输入张量 x 的维度 - input_size</span>

h0 = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment"># 设定初始化的 h0（隐藏层）</span>
c0 = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment"># 设定初始化的 c0（细胞状态）</span>
<span class="hljs-comment"># 第一个参数：num_layers * num_directions（层数 * 网络方向数（1 或 2））</span>
<span class="hljs-comment"># 第二个参数：batch_size（批次的样本数）</span>
<span class="hljs-comment"># 第三个参数：hidden_size（隐藏层的维度）</span>

output, (hn, cn) = lstm(input1, (h0, c0))
<span class="hljs-comment"># 最后输出和最后一层的隐藏层输出</span>

<span class="hljs-built_in">print</span>(output)
<span class="hljs-built_in">print</span>(output.shape)
<span class="hljs-built_in">print</span>(hn)
<span class="hljs-built_in">print</span>(hn.shape)
<span class="hljs-built_in">print</span>(cn)
<span class="hljs-built_in">print</span>(cn.shape)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年总结：一个树苗倔强生长]]></title>    <link>https://juejin.cn/post/7597704040216494106</link>    <guid>https://juejin.cn/post/7597704040216494106</guid>    <pubDate>2026-01-22T06:37:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597704040216494106" data-draft-id="7597758250825826314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年总结：一个树苗倔强生长"/> <meta itemprop="keywords" content="开源,GitHub,架构"/> <meta itemprop="datePublished" content="2026-01-22T06:37:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年总结：一个树苗倔强生长
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T06:37:57.000Z" title="Thu Jan 22 2026 06:37:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>今年过的真是快，一转眼，就从2025年到2026年了。小时候总以为要到2025很遥远很遥远，记得小学还写过一篇作文，幻想到了2025年，我们生活会是怎么样的。</p>
<p>我那时候想，我们以后的交通工具都是乘坐会飞的汽车，有点像苏俄那时候的宣传一样，人们也不用辛勤劳动，会有机器人来专门服务我们等等。我还想到，我以后肯定要成为一个科学家或者软件工程师，让全世界的人们都能使用我开发的东西(哈哈，一个小孩子总是天真的，烂漫的)。</p>
<p>真正到了2026年，我发现未来真的正在像这样演变，于是我想写一篇这样的文章记录自己的成长，记录自己的2025。也是第一次写这种类似年终总结的文章，大家随意看看就好了，如果有写的不好的地方，请见谅。</p>
<h2 data-id="heading-1">嫩芽期</h2>
<p>年初的时候，我还是一个技术比较一般的后端开发人员，也不去上课，一心在钻研自己的东西，从语言底层到技术架构，几乎什么都学吧，但是都是太宽泛了，对某个技术栈也没有很深入的去了解源码和架构。</p>
<p>这一时期是极其<strong>枯燥乏味</strong>的，和众多初学者一样，总认为别人提出的方案就是很好的了，没有自己的思考。为什么这个方案就是最好的，它的优势是什么，还可不可能有更好的方案可以解决，兜底怎么处理等等。</p>
<p>总跟着别人走，但是我觉得这种是一个技术人员成长的必经之路吧，没有什么好羞耻的，从追随者，到引领者，总是需要一个过程。</p>
<p>孤独吗？当然很<strong>孤独</strong>，这个时期的我，没有感到任何正反馈，当然会感到很煎熬，我也不知道走这条路是否是正确的。现在竞争这么激烈，外界同时也在不断唱衰这一行业，说没有压力，肯定是假的。</p>
<p><strong>我感叹幸亏有AI的出现。</strong></p>
<p>在一个人学习的时候，查网上的资料不一定能找到心仪的，就会去问ai，比如Gemini，GPT，Grok等等，还有国产的Qwen都不错。虽然AI时不时就会出现幻觉，甚至回答的是错误的，但是正是因为它们回答不一定是正确的，我才养成了质疑与自我探索的精神，我会去对应的源码查找到底是不是这样的，从架构上理解这样做的原因到底是为什么等等。</p>
<p><strong>我觉得正是这样的决心与品质，才是促进我发生根本进步的原因吧</strong></p>
<h2 data-id="heading-2">成长期</h2>
<p>随着技术和架构理解不断深入，我对一些中间件非常感兴趣，开始深入的研究源码。</p>
<h3 data-id="heading-3">在Apache seata社区</h3>
<p>怀揣着对分布式事务的极大兴趣，我在四月份fork了seata的源码下来研究。起初结合着官方文档看也有点吃力，到后面压力慢慢才逐渐减少。社区发布了好几个issue，其中包括了对单测覆盖率的需求。我尝试做了好几个，以便我可以对某个模块深入了解。</p>
<p>其实直到现在我都觉得，看或者做UT都是深入了解一个项目或者模块的好方法，单测提供了这个功能怎么用，怎么走的流程的示范。</p>
<p>在陆续做了几个UT，就提了PR，经过了reviewer们的cr与提示，我也了解了很多规范知识和ci/cd的重要性。</p>
<p><strong>我在seata社区成长，和seata一起成长。</strong></p>
<p>伴随着对项目的不断深入的了解，我开始能提出Optimize，bugfix的PR，到后面甚至做了几个feature级别的，同时也收到了来自健斌哥和清铭哥的大拇指，这对我是非常大的正反馈。我于是在seata也提了不少pr，其中被采纳不在少数，到后来甚至能自己提issue，自己给自己提pr，也开始给别人review PR。</p>
<p>伴随着seata不断迭代几个版本，我也逐渐融入seata这个社区大家庭，成为其中一份子。到后来也非常荣幸的成为了<strong>seata的committer</strong></p>
<p>直到现在即使非常忙，我也一直在关注着seata的发展。</p>
<h3 data-id="heading-4">腾讯犀牛鸟</h3>
<p>在开源社区的日子，我也计划着参加一个开源计划，于是选中了腾讯犀牛鸟计划。在我对心仪项目有比较深入的了解和提交了几个pr后，向导师提交了相关的企划书。</p>
<p>当收到被项目选中参加的邮件时，我是感到非常荣幸和开心的，同时也有压力，担心自己辜负导师的期望，无法完成任务。</p>
<p>在导师的指导下，在经历了几个月努力，最终也是成功结业了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aed43332cc0e4015902d7459b3553369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769668676&amp;x-signature=LIjptYbKzNXVj05eifgkj%2FT9pOM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">在Spring AI Alibaba社区</h3>
<p>几个月前，我收到宏宇哥的私信，邀请我一起来为SAA做贡献，我感到非常荣幸与开心。</p>
<p>因为已经有了对大型项目的贡献经验，这次对SAA的整体架构理解并不算太久，同时对agent等等知识也有了新的认识。我先是为example贡献了pr，在使用上大概有了体感。然后在几个issue上研究了一段时间，也是逐渐提了pr并合并了。在这里非常感谢军哥和宏宇哥的cr和建议，对我帮助非常大。</p>
<p>我到现在也还在逐步深入SAA项目，希望能为SAA发展贡献自己的一份力量，为Java开发人员更好的构建AI智能体出一份自己的力量</p>
<h2 data-id="heading-6">第一份实习</h2>
<p>在年中，我找到了第一份实习，虽然公司规模总体不算大，但好在还不错。</p>
<p>我感谢hf哥、tz哥还有欢哥，在我landing期对我帮助非常大，平常也非常照顾我。我很感谢他们。</p>
<p>虽然在公司待的时间不久，但是我收获的知识却很多，我非常荣幸能够有这一次经历。</p>
<h2 data-id="heading-7">对新的一年有什么展望吗</h2>
<p>我希望能够不断提高自己的技术，继续为seata社区和SAA社区贡献自己的一份力量，同时也继续输出优质的博客，让读者喜欢看。</p>
<p>当然如果在新的一年，能找到心仪的实习，并在秋招最终成功进入心仪的企业，则是再好不过了❤️</p>
<h2 data-id="heading-8">在过去的一年有什么后悔的吗</h2>
<p>老实说，我并没有什么后悔的，因为我觉得我已经尽了我的最大努力，朝着我自己的目标前进。</p>
<p>但是硬要说，有什么对不起的人或者事的话，我想对自己说声对不起。2025年你很努力了，没有怎么休息，也没有怎么去玩，但是依然不断前进，想要达成自己的目标，谢谢你。</p>
<h2 data-id="heading-9">总结</h2>
<p>这篇文章可能看似胡说八道，没有条理(可能也真是这样)，但是确实代表了我2025的心路历程。</p>
<p>希望大家新的一年越过越好，身体健康，万事如意❤️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>