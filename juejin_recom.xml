<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Jason Wei：2025年 AI 发展的三个核心理念]]></title>    <link>https://juejin.cn/post/7574726841543999526</link>    <guid>https://juejin.cn/post/7574726841543999526</guid>    <pubDate>2025-11-21T07:05:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574726841543999526" data-draft-id="7574816159754338355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jason Wei：2025年 AI 发展的三个核心理念"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-21T07:05:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jason Wei：2025年 AI 发展的三个核心理念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:05:30.000Z" title="Fri Nov 21 2025 07:05:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>斯坦福 AI 俱乐部专题演讲完整版</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Db6Doq2fz81U%26utm_source%3Dchatgpt.com" target="_blank" title="https://www.youtube.com/watch?v=b6Doq2fz81U&amp;utm_source=chatgpt.com" ref="nofollow noopener noreferrer">转载</a></p>
<hr/>
<h2 data-id="heading-0">引言：理解 2025 年 AI 发展的三个核心理念</h2>
<p>大家好，我是 Jason Wei，现在在 Meta 超级智能实验室担任研究科学家。之前我在 OpenAI 工作了两年，在那里我参与了 01 和 Deep Research 的开发。再之前，我在 Google Brain 担任研究科学家，我的研究帮助推广了思维链提示（chain of thought prompting）、指令微调（instruction tuning）以及许多新兴现象。</p>
<p>今天我想和大家分享三个我认为简单但 fundamental 的理念，帮助我们理解 2025 年的 AI 发展。当被问及 AI 将如何改变我们的世界时，你会得到非常广泛的答案，这取决于你问的是谁。</p>
<p><strong>一个真实的故事：不同观点的碰撞</strong></p>
<p>我的一个量化交易员朋友说，ChatGPT 虽然很酷，但在他的工作中并不能真正做那些复杂的工作。而在谱系的另一端，最近我问了一位顶尖实验室的 AI 研究员，他认为我们基本上还有两到三年的工作时间，然后 AI 就会取代他的工作。所以人们对 AI 如何发展的看法存在巨大的谱系。</p>
<p>因此，我将从三个思维方式来讨论这个话题：</p>
<ol>
<li>智能将成为商品（intelligence as a commodity）</li>
<li>我称之为验证者定律（verifiers law）的概念</li>
<li>智能的锯齿边缘（jagged edge of intelligence）</li>
</ol>
<hr/>
<h2 data-id="heading-1">第一个理念：智能商品化趋势</h2>
<h3 data-id="heading-2">AI 进展的两个阶段</h3>
<p>我认为思考 AI 进展的方式有两个阶段。第一个阶段是<strong>前沿突破阶段</strong>，这时 AI 还不能很好地完成某项任务，你正在解锁这种新能力。如果你看过去五年 MMLU（大规模多任务语言理解）这个非常常见的基准测试，你会看到在性能上逐渐取得进展。</p>
<p>第二个阶段是<strong>能力商品化阶段</strong>，一旦你拥有了一种能力，它就会变得商品化。</p>
<p><strong>一个具体的例子：MMLU 性能成本的变化</strong></p>
<p>这里有一个很好的例子，y 轴是时间，你可以看到在 MMLU 上获得特定性能水平的成本，以美元计算。你可以看到这个趋势是：每新的一年，使用具有特定智能水平的模型的成本都在下降。</p>
<p>你可能会问，为什么这个趋势会继续？我的论点是，这是深度学习历史上第一次自适应计算真正有效。</p>
<h3 data-id="heading-3">自适应计算时代的革命性意义</h3>
<p>如果你看到去年之前的整个深度学习发展，我们处于这样一种模式：解决特定问题所使用的计算量是固定的，无论问题有多难——无论是回答加州首府这样的简单问题，还是解决非常难的竞赛数学题。</p>
<p>但现在我们进入了自适应计算时代，你可以根据任务的难度来调整使用的计算量。这个概念首先通过 01 模型得到验证（一年多前发布的），它表明如果你在测试时增加解决数学问题的计算量，在该基准测试上的性能会更高。</p>
<p><strong>自适应计算的核心意义</strong></p>
<p>自适应计算意味着你可以继续降低智能成本的原因是，你不必不断扩大模型规模。如果你有一个非常简单的任务，你可以继续推进到极限，只需花费最少的计算资源来完成那个任务。</p>
<h3 data-id="heading-4">信息获取效率的演进历史</h3>
<p>让我们思考一下获取特定公共信息的时间变化。</p>
<p><strong>具体例子：1983年釜山人口查询</strong></p>
<ul>
<li><strong>互联网前时代</strong>：如果你想知道1983年釜山的人口，可能需要开车到图书馆，然后在大量百科全书中查找。这可能需要几个小时。</li>
<li><strong>互联网时代</strong>：你可能会搜索，然后浏览各种网站来找到真正给你答案的网站，这可能需要几分钟。</li>
<li><strong>现在</strong>：基本上可以立即获得答案。</li>
</ul>
<p><strong>更复杂的挑战：1983年釜山结婚夫妇数量</strong></p>
<p>如果你想问一个更复杂的知识问题，比如1983年釜山有多少对夫妇结婚。在互联网前时代，如果你不住在韩国，你可能需要先飞到韩国，亲自去最近的有这种信息目录的政府图书馆，你可能需要翻阅几十本书来找到那个特定信息。</p>
<p>互联网时代可能更容易一些。你可以搜索，但如果你不会说韩语，你必须查看所有网站并找人来帮助你。在聊天机器人时代，这变得更容易一些。而在代理时代，我认为这可以在几分钟内找到答案。</p>
<p><strong>极端复杂的查询：1983年亚洲30个最人口城市的结婚数量排序</strong></p>
<p>即使对于更困难的事情，比如询问"1983年亚洲人口最多的30个城市按该年结婚人数排序"，我认为这现在可以在几小时内完成，但在互联网前时代回答这个问题需要几周时间。</p>
<p><strong>真实的案例：OpenAI Operator的能力展示</strong></p>
<p>这里有一个实际的例子，这个问题"1983年釜山有多少人结婚"并不是一个超级简单的问题。03 无法完成这个任务，但 OpenAI Operator 可以做到，因为它必须访问一个叫 Kosis 的数据库，你必须点击各种选项，直到找到正确的数据库查询，然后你才能找到答案。</p>
<h3 data-id="heading-5">测量信息获取能力的基准：BrowseComp</h3>
<p>我们在 OpenAI 试图通过一个叫 BrowseComp（browsing competition）的基准测试来衡量这个能力。它包含一系列问题，一旦你有答案，验证答案很容易，但实际解决这些问题需要相当长的时间。</p>
<p>例如，给你一堆关于足球比赛的约束条件，然后找到真正符合所有这些约束条件的比赛。我们实际上要求很多人来回答这些问题。平均来说，有些问题需要两个多小时才能解决。如果你看规模，很多人在两小时内无法解决的问题比他们实际解决的问题要多。</p>
<p>但你可以看到 OpenAI 的 Deep Research 模型可以解决大约一半的问题，这是相当不错的进展。</p>
<h3 data-id="heading-6">智能商品化的社会影响</h3>
<h4 data-id="heading-7">知识领域的民主化</h4>
<p>一个影响是基于知识的领域将被民主化，这些领域之前被基于知识的随意进入门槛所限制。</p>
<p><strong>编程领域的例子</strong>
编程绝对是一个例子，"vibe 编程"是一个很好的例子。过去编程需要专门训练，现在 ChatGPT 几乎可以给你一个相当好的医生能给你的任何信息。</p>
<p><strong>个人健康管理的例子</strong>
个人健康可能是另一个例子。在过去，假设你想做生物黑客实验，你去看医生，说"我想改善我的鼻呼吸"，他们会说"嗯，你就试试我告诉你的方法"。他们不会真正帮助你理解如何做自己的实验。但现在 ChatGPT 几乎可以给你一个相当好的医生能给你的任何信息。</p>
<h4 data-id="heading-8">私人信息的相对价值提升</h4>
<p>另一个影响是私人内部信息的相对价值略高。鉴于任何公共信息的相对成本现在低得多，私人信息的相对价格现在会高得多。</p>
<p><strong>具体例子</strong>：不在市场上但可以出售的房产信息，现在这种信息变得更有价值。</p>
<h4 data-id="heading-9">个性化信息访问的未来</h4>
<p>我认为我们最终将拥有无摩擦的信息访问。你不是访问一个对所有人都公开的互联网，而是获得你的个性化互联网，无论你想知道什么，都会有一个个性化的网站来向你展示这些信息。</p>
<hr/>
<h2 data-id="heading-10">第二个理念：验证者定律</h2>
<h3 data-id="heading-11">验证不对称性的概念</h3>
<p>验证不对称性是计算机科学中一个非常常见的概念，基本上就是对于某些任务，验证解决方案比找到解决方案要容易得多。</p>
<p><strong>具体例子说明</strong></p>
<ol>
<li>
<p><strong>数独</strong>：非常难解决，但如果你有答案，很容易验证是否正确。</p>
</li>
<li>
<p><strong>Twitter 代码编写</strong>：显然需要团队，我估计数千名工程师，也许数百个马斯克运行公司来生成网站，但要验证它在工作，就容易多了。你只需渲染它并点击各种功能。</p>
</li>
<li>
<p><strong>竞赛数学问题</strong>：我认为有些情况下，解决和验证的难度是一样的，所以这是一种中间情况。</p>
</li>
<li>
<p><strong>数据处理代码</strong>：我认为这是另一个不同的情况。如果你想写一些脚本来处理某些数据，我认为写起来相当容易，但如果你给我别人的凌乱代码，我可能需要更多时间来弄清楚他们的代码在做什么，而不是写我自己的代码或检查他们的代码。</p>
</li>
<li>
<p><strong>事实性文章写作</strong>：这是另一个我认为很容易提出看似可信但可能是虚假声明的例子，但事实核查特定声明可能极其繁琐。所以这是一个你具有相反不对称性的例子，很容易生成看似可信的文章，但验证它是否是一篇好文章需要更长时间。</p>
</li>
<li>
<p><strong>制定新饮食方案</strong>：这个想法甚至延伸到创造新饮食等事情。我可以断言最好的饮食是只吃野牛肉，这只花了我10秒钟来断言。但如果你想验证这实际上是一个真实的声明，你需要大样本量，你必须等待长期结果，而且结果可能有噪音。</p>
</li>
</ol>
<h3 data-id="heading-12">可视化验证不对称性</h3>
<p>你可以像这样将其可视化。x 轴是多容易生成，y 轴是多容易验证。</p>
<ul>
<li><strong>数独</strong>：生成难度中等，但验证容易</li>
<li><strong>Twitter</strong>：生成困难，验证相对容易</li>
<li><strong>最佳饮食方案</strong>：生成容易，验证困难</li>
<li><strong>中间地带</strong>：竞赛数学、数据处理代码等处于中间位置</li>
</ul>
<h3 data-id="heading-13">通过特权信息改善验证不对称性</h3>
<p>我想指出的有趣事情是，你实际上可以通过给予特权信息来改善任务在这个平面上的位置。</p>
<p><strong>改进验证的具体例子</strong></p>
<ul>
<li><strong>竞赛数学</strong>：如果我为你提供答案键，那么检查就变得非常容易。</li>
<li><strong>代码编写</strong>：如果你在写代码，我给你测试用例（像我们在 Swedbench 中那样），检查也变得非常容易。</li>
</ul>
<p>这个想法的核心是，有些任务你可以事先做一些工作来增加验证的不对称性。</p>
<h3 data-id="heading-14">验证者定律的表述</h3>
<p>这引出了我称之为验证者定律的理念，或者如果你对"定律"这个词作为科学家感到不舒服，可以称之为验证者规则。</p>
<p><strong>验证者定律的核心主张</strong>：训练 AI 解决特定任务的能力与该任务的可验证程度成正比。</p>
<p><strong>推论</strong>：任何可解决的、容易验证的任务最终都会被 AI 征服。</p>
<h3 data-id="heading-15">可验证性的五个关键维度</h3>
<p>更具体地说，我认为可验证性是这五个事物的函数：</p>
<ol>
<li><strong>客观真理性</strong>：什么是好响应，什么是坏响应存在客观标准</li>
<li><strong>验证速度</strong>：验证有多快</li>
<li><strong>可扩展性</strong>：你能一次性验证一百万个不同的提议响应吗</li>
<li><strong>低噪声性</strong>：是否存在低噪声</li>
<li><strong>连续奖励</strong>：你只区分通过和不通过，还是给出整个响应质量的光谱</li>
</ol>
<p>大多数 AI 基准测试根据定义都容易验证，这是验证者定律的一个很好的实例化，你可以看到过去五年我们关心的所有基准测试都相对较快地被 AI 解决了。</p>
<h3 data-id="heading-16">AlphaEvolve：验证者定律的绝佳例证</h3>
<p>利用验证不对称性的一个很好的例子，我鼓励你们如果还没有读过的就去看一下，是 DeepMind 的 AlphaEvolve。他们基本上能够通过大量计算采样和智能算法解决这些符合验证不对称性的任务，包括数学、计算优化使用等一堆任务。</p>
<p><strong>AlphaEvolve 的具体任务示例</strong></p>
<p>这里有一个例子，你可以想出这样的数学问题：找到这11个六边形的放置位置，你可以绘制围绕它的最小外六边形。然后你可以看到这样的解决方案清楚地满足这里所有五个标准。</p>
<ul>
<li><strong>客观性</strong>：你只需绘制它来检查答案</li>
<li><strong>可扩展验证</strong>：因为它是计算性的</li>
<li><strong>低噪声</strong>：每次检查都会得到相同的结果</li>
<li><strong>连续奖励</strong>：六边形的大小直接给你一个答案比另一个答案更好的度量</li>
</ul>
<h3 data-id="heading-17">AlphaEvolve 算法工作原理</h3>
<p>你应该阅读论文，但我会给你一个大约一分钟的概述。</p>
<p><strong>算法核心步骤</strong>：</p>
<ol>
<li>
<p><strong>采样生成</strong>：他们使用一个大语言模型，采样一堆候选解决方案。其中一些可能好，一些可能坏。</p>
</li>
<li>
<p><strong>评估筛选</strong>：他们对它进行评分，因为他们通过选择的任务定义有一种评分方式。</p>
</li>
<li>
<p><strong>迭代优化</strong>：他们采用最好的一个并将其反馈给大语言模型用于下一轮采样，作为某种形式的灵感。</p>
</li>
<li>
<p><strong>持续改进</strong>：基本上，一旦你花费大量计算和迭代来这样做，你可以看到性能或你做任务的好坏程度明显随时间增加。</p>
</li>
</ol>
<p><strong>技术创新的关键洞察</strong></p>
<p>他们在这里做的聪明事情是他们规避了传统深度学习的核心限制。在深度学习的大部分时间里，我们主要关心从训练到测试的泛化。这有两种形式：一种是相同任务但未见过的例子，另一种是未见过的任务。</p>
<p>但他们选择训练和测试相同的问题。你只是真的想知道一个特定问题的答案。这允许你规避很多这些问题。你必须选择那些你可能得到比你已经知道的更好答案的问题。</p>
<h3 data-id="heading-18">验证者定律的现实意义</h3>
<h4 data-id="heading-19">自动化任务的优先级</h4>
<p>我认为一个影响是最先被自动化的任务是那些非常容易验证的任务。</p>
<h4 data-id="heading-20">新兴商业机会</h4>
<p>第二个影响是，如果你想创建公司或我认为会增长的领域，就是想出测量事物的方法，然后这些事物可以被 AI 优化。</p>
<hr/>
<h2 data-id="heading-21">第三个理念：智能发展的锯齿边缘</h2>
<h3 data-id="heading-22">对 AI 影响的不同观点谱系</h3>
<p>如果你问 AI 将如何改变世界，我认为人们有相当不同的观点。</p>
<p><strong>来自专家的观点差异</strong></p>
<p>这是来自今年早些时候，我的前同事 Boaz 说，东海岸的人低估了即将到来的变化规模。他们想，哦，当前模型不能做这个，他们不太考虑轨迹。而在湾区，我们可能低估了一些摩擦和我们训练的模型部署所需的时间滞后。</p>
<p>另一个我喜欢的观点（如果你还没关注他应该关注）是 Run，他说现在没有人应该给出或接受任何职业建议。每个人都广泛低估了变化的范围和规模以及你未来的高方差。你在 Meta 的 L4 工程师朋友告诉你"兄弟，CS 学位完蛋了"，他也不知道。</p>
<h3 data-id="heading-23">对快速起飞假设的质疑</h3>
<p>长期以来存在的一个假设是快速起飞的理念。基本上是一旦你在某个方面超越人类，一旦你实现这个特定的事情，你会突然变得比人类强得多。所以你会有这个起飞持续时间，在短时间内获得这种巨大的智能。</p>
<p>我认为这可能不会发生，我会告诉你为什么。</p>
<p><strong>渐进式自我改进的现实</strong></p>
<p>快速起飞，这可能是他们论点的简化版本，基本上就像：哦，在很多年里你不能用 AI 训练 GPT n+1，然后在第二年你突然能做到。但我认为它更可能像这样：每年你在 AI 能够自我改进方面取得渐进进展。</p>
<ul>
<li><strong>第0年</strong>：你甚至无法获得代码库</li>
<li><strong>第0年中</strong>：你也许可以训练某些东西，但结果并不真正令人印象深刻</li>
<li><strong>后续阶段</strong>：它也许可以自主训练，但不如你把它交给10个最好的研究人员那样好</li>
<li><strong>持续发展</strong>：也许有时你仍然需要人类偶尔干预来让它继续良好运行</li>
</ul>
<p>所以我认为这更像是自我改进能力的光谱，而不是像二元的"哦，在你实现这个之后，你可以突然创造超智能"。</p>
<h3 data-id="heading-24">任务特定的改进速率</h3>
<p>我认为自我改进率应该以任务特定方式来看待。你可以认为存在一个不同任务的光谱。</p>
<p><strong>AI 能力的锯齿状分布</strong></p>
<p>你可以这样思考。有这种锯齿边缘，对吧？在峰值，你有我们现在能够做得特别好的问题，比如困难数学问题、某些类型的竞赛编程。然后也有这些奇怪的谷底。</p>
<p><strong>能力不足的具体例子</strong></p>
<ul>
<li><strong>基础数学错误</strong>：很长一段时间里，ChatGPT 会说 9.11 大于 9.9</li>
<li><strong>小众语言处理</strong>：比如 Flingit，我认为只有几百个美洲原住民能说的语言。我认为 ChatGPT 不能很好地做这个</li>
<li><strong>复杂物理任务</strong>：需要现实世界交互的任务</li>
</ul>
<p>我不认为我们会处于这种情况：你有一个自我改进的模型，然后突然什么都能做好。我认为你更可能处于右侧的情况，即每个任务都有不同的改进率。</p>
<h3 data-id="heading-25">AI 任务改进的启发式规律</h3>
<h4 data-id="heading-26">数字任务的优势</h4>
<p>我认为 AI 擅长数字任务。我不知道，这个家庭作业机器漫画实际上相当准确，考虑到它是1981年创建的关于 AI 如何工作的。但我们显然还没有真正的机器人，也许很快会有。</p>
<p><strong>为什么数字任务发展更快</strong></p>
<p>我认为 AI 在数字任务上发展如此之快的核心原因只是迭代速度。因为当你做数字任务时，你可以更容易地扩展计算，而不是扩展使用真实机器人的实验。</p>
<h4 data-id="heading-27">人类难度与 AI 难度的相关性</h4>
<p>另一个相当明显的规律是，对人类更容易的任务往往对 AI 也更容易。</p>
<p>你可以有一个人类事情有多困难的光谱。我认为正在出现的是一种能够做人类可能因为作为生物大脑的根本限制而无法做的任务的能力。</p>
<p><strong>超越人类限制的例子</strong></p>
<p>比如，预测乳腺癌发生是一个可能的任务，如果你读过1000万张乳腺癌图像，你可以找到允许你预测的模式。但作为人类，我们活得不够长或没有足够注意力来做到这一点。</p>
<h4 data-id="heading-28">数据丰富性的关键作用</h4>
<p>另一个极其简单的启发式是 AI 在数据丰富时往往会蓬勃发展。</p>
<p>这里有一个非常清晰的例子，你可以查看语言模型在不同语言中的数学表现。如果你绘制该语言的频率，换句话说，我们有多少数据，与性能的关系，这是一个相当清晰的趋势，你拥有的数据越多，你在该任务上做得越好。</p>
<h4 data-id="heading-29">单一度量优化的特殊策略</h4>
<p>该规则的一个特殊例外或解锁是如果你有单一目标度量，那么你可以做 AlphaEvolve 或 AlphaZero 策略，你基本上可以通过强化学习生成合成数据。</p>
<p>我的前同事 Danny Du 有一个很好的推文：任何基准测试都可以快速解决，只要任务提供明确的评估度量，可以在训练期间用作奖励信号。</p>
<h3 data-id="heading-30">不同领域 AI 发展时间线预测</h3>
<p>我有这个我之前展示过的表格，你可以使用这三个启发式规律来预测 AI 何时能够做某些事情。</p>
































































































<table><thead><tr><th>领域</th><th>人类难度</th><th>数字化程度</th><th>数据可用性</th><th>预测时间</th></tr></thead><tbody><tr><td>翻译（前50种语言）</td><td>容易</td><td>是</td><td>容易获取数据</td><td>已完成</td></tr><tr><td>基础代码调试</td><td>中等</td><td>是</td><td>容易获取数据</td><td>2023年</td></tr><tr><td>竞赛数学</td><td>困难</td><td>是</td><td>容易获取数据</td><td>已完成</td></tr><tr><td>进行 AI 研究</td><td>困难</td><td>是</td><td>数据获取/创建不那么容易</td><td>2027年（猜测）</td></tr><tr><td>化学研究</td><td>困难</td><td>否</td><td>数据获取/创建不那么容易</td><td>比 AI 研究晚</td></tr><tr><td>制作电影</td><td>非常困难</td><td>是</td><td>容易获取数据</td><td>2029年（猜测）</td></tr><tr><td>股票市场预测</td><td>非常困难</td><td>是</td><td>容易获取数据</td><td>不确定</td></tr><tr><td>翻译到特定方言</td><td>容易（对知道的人）</td><td>是</td><td>数据获取不那么容易</td><td>可能性较低</td></tr><tr><td>修理你的管道</td><td>中等</td><td>否</td><td>数据获取不容易</td><td>不确定</td></tr><tr><td>发型设计</td><td>我认为这对 AI 来说会相当困难</td><td>不确定</td><td/><td/></tr><tr><td>传统地毯制作</td><td>非常困难（需要一个月团队制作地毯）</td><td>否</td><td>数据获取不容易</td><td>很长时间内不会</td></tr><tr><td>带女朋友约会让她开心</td><td>不可能</td><td>否</td><td>数据获取不容易</td><td>我认为我们还要做一段时间</td></tr></tbody></table>
<h3 data-id="heading-31">锯齿边缘的现实意义</h3>
<h4 data-id="heading-32">影响的领域差异</h4>
<p>AI 的影响将在满足特定特性的任务上最大：即数字任务、对人类容易的任务和数据丰富的任务。</p>
<p>某些领域将被 AI 极大地加速，软件开发显然是其中之一。然后其他领域可能保持不变，比如发型设计。</p>
<hr/>
<h2 data-id="heading-33">结论：三个核心理念的总结</h2>
<h3 data-id="heading-34">核心洞察重述</h3>
<ol>
<li>
<p><strong>智能和知识将变得快速廉价</strong>：一旦我们用 AI 实现了能力，其成本将被推向零。我认为这个趋势将继续。即时知识的理念，所以任何公开可用信息，你都能够立即获得访问。</p>
</li>
<li>
<p><strong>验证者定律</strong>：测量是 AI 进步的驱动因素。任何容易验证的任务最终都会被 AI 解决。</p>
</li>
<li>
<p><strong>智能边缘是锯齿状的</strong>：AI 对特定任务的能力和改进率将基于这些任务的某些特性而变化。不会有快速的超级智能起飞，因为每个任务都有不同的能力和改进率。</p>
</li>
</ol>
<h3 data-id="heading-35">预期影响</h3>
<ul>
<li><strong>高度加速的领域</strong>：软件开发等数字任务、数据丰富的领域</li>
<li><strong>相对稳定的领域</strong>：手工艺、需要物理交互的服务行业</li>
<li><strong>价值重构</strong>：公共信息价值下降，私人信息价值相对提升</li>
<li><strong>测量行业机会</strong>：创建测量方法以供 AI 优化的新兴商机</li>
</ul>
<p>这些理念为我们理解 2025 年及以后 AI 发展提供了框架，帮助我们预测技术演进路径并评估其对社会各领域的具体影响。</p>
<hr/>
<p>如果你对我的演讲有反馈，我会阅读。我也很乐意在 Twitter 上交流。</p>
<p>谢谢大家！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题]]></title>    <link>https://juejin.cn/post/7574745301725167622</link>    <guid>https://juejin.cn/post/7574745301725167622</guid>    <pubDate>2025-11-21T07:14:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725167622" data-draft-id="7574745301725118470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题"/> <meta itemprop="keywords" content="前端,Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-21T07:14:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:14:45.000Z" title="Fri Nov 21 2025 07:14:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信这两天大家应该都已经被 Gemini3 和 AntiGravity 刷屏了，特别昨晚谷歌还发布了 Nano Banana Pro ，可以说这两天几乎成了谷歌的 AI 专场，所以这里也介绍下这两天的体验，顺便简单介绍下大家上不去 AntiGravity 的问题。</p>
<h2 data-id="heading-0">Nano Banana Pro</h2>
<p>其实相比起 coding，这次的 Nano Banana Pro 反而是我最关心的，比如这次让我感觉最有意思的 prompt 「1:1 真人版」就非常有意思，传入一张手办或者动漫图片，直出整体效果如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc13a63e42f426daede67f34006f179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=onmbrPnzL0W8Ap39tVMdncd%2FObs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/471e92a86bc44bbba87e7eb0964ba2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=wwmBCDhO3oIlKTkx%2FWBnvgsg06U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60bbbc5f75bb4e10a100df101a6eb3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=VWJyv%2BNjJ5RQRKJRlOJlArhwhdY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c17399ae0d456f99075652e8eda9e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=kC9yCK8qhmjKSLVuIMgvJDO2sX0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f32611551514c5aa999adcf56154285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=71edhezZuD903JmpEbyFsZSkKnw%3D" alt="它居然知道是黄毛？？？" loading="lazy"/></p>
<p>同时，你还可以让它做一个 apple vision pro 2 的 hack 解构图，整个直出效果还是相当不错的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86ae65a1d34d4ef6b7a545588d7dd741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=TnJROlJBDXKubecY4yNSBfvn3HE%3D" alt="image-20251121134547646" loading="lazy"/></p>
<p>如果通过 AI Studio 的 <code>http://aistudio.google.com/apps/bundled/product_mockup</code> ，你还通过简单的描述词，就能让它帮你生成各种不同风格的知识图谱或者关系图谱，这对于 PPT 或者内容创造来说，可以说是非常可观的效率提升了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2590ac8f3824132926b91af8ee91f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=g2qH4BJjyuu4lMQ7LO%2FvmkwvBGs%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d904f115d00f4a96a901cb1473bd6a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=JhYzcGVrPQnTfv%2BBBekqf2wLzZE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd22e7957eb94ec48088c1a297436472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=4RnFaMvbeespOP9Du%2BbOdTZVUTM%3D" alt="" loading="lazy"/></p>
<p>最后就是 AntiGravity + Banana Pro 的结合效果，是的，今天更新后的 AntiGravity 已经有 Nano Banana Pro 的效果了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb542ab658b4a14861577ba203867af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=7pcgghqZMTnvGKie7ViCZ%2Bga2kU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>Web UI 理解和实现上确实比较明显的提升。</p>
</blockquote>
<h2 data-id="heading-1">AntiGravity</h2>
<p>接下来就是 AntiGravity ，相信大家应该都知道这次谷歌发布了 “ Windsurf2.0” 的 IDE，基本功能和 UI 都有浓厚的 Windsurf 影子，也是基于 VSCode 的一个 IDE 产品：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f730ea6cad104d5391e29413fbeb6769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=WakI55PEDWMF9D20rdmj7CXSGa0%3D" alt="" loading="lazy"/></p>
<p>为什么说是 Windsurf 2.0 ？哈哈哈哈，看看这些就知道了，毕竟是 Windsurf 的前核心团队做的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc932c11822b41348ad83dbb703ac040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=wvYuRXDHd2IPgptXVuDuiZA609A%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dca53d359da4978ba492afac64b8f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=mvvPTrPD%2Bv7EQOUrHv4a9EOiJ8E%3D" alt="" loading="lazy"/></p>
<p>先简单介绍下 Antigravity 的一些特点，核心就是 Agent-First ，它预设 AI 是一个能够自主规划、执行、验证和迭代复杂工程任务的执行者，主打特色有：</p>
<ul>
<li><strong>并行工作:</strong> 与传统的线性聊天（等待 AI 回复）不同，可以同时派遣多个智能体（Agents）去处理不同的任务（例如一个修 Bug，一个写测试），并在“Mission Control”视图中监控进度。</li>
<li><strong>集成了一个深度绑定的 Chrome 浏览器，它除了写代码，还可以做很多其他的东西</strong>，智能体拥有一个专门的（Browser Subagent），可以像人类一样浏览网页、点击、输入、读取 DOM 和控制台日志，所以智能体可以自主查阅文档、搜索解决方案甚至测试 Web 应用<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e54e4d31840b4c2e8343c9523d19717f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=fLwuiNNbmW81954vG960%2FJIAUaA%3D" alt="" loading="lazy"/></li>
</ul>
<p>这里的 Browser Subagent 还挺有意思的，你可以让它帮你浏览某些网页，或者帮你汇总某些邮件，总结一些资料，查询最新的资讯之类，它会自己打开浏览器并完成对应任务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef3e538443fc447b9f655b8e36634f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=IfHGIVG9bCYLaUge5qBaUELDeqI%3D" alt="" loading="lazy"/></p>
<p>那么，很多人要说，我都上不去卡在 loading，甚至就在下图这个地方一动不动，这是为什么呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dbb8d49d34487b841a294701fccfb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=NQRhq9WTBehA%2Fksq%2Ft9fWzrNs2Y%3D" alt="" loading="lazy"/></p>
<p>首先就是，你要打开 <code>https://policies.google.com/terms</code> ，然后查看你的账号所在区域，如果是 HK ，那么你就需要先改地址了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612a699c29114ddba47562357151eb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=vyaGK5c68VcT3N2D5Z6QkQdNU38%3D" alt="" loading="lazy"/></p>
<p>改地址链接是 <code>https://policies.google.com/country-association-form</code> ，你需要选「其他」 并填写理由，理由只能你自己想了，申请通过后，你就会看到类似的邮件回复：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6425befbdb54ffbbc54fb6435870561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=YghUwZ5ZpwnXLLyNK2ue8uEKTIo%3D" alt="" loading="lazy"/></p>
<p>最后，你还需要开全局 proxy，比如 win11 需要这两个全开（tun）比较保险，而 Mac是增强模式 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe2079e236b84c7fbd46dedc0aeb72bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=%2BlHiTNgy71kYzbnNsIgsu77Dljo%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab0232c153a642e78f6f4520902f3d60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=ryDjYkWD9L8x3YibPEQQIpj6dME%3D" alt="" loading="lazy"/></p>
<p>进去后你就可以看到，提供的模型还是挺不错的，最重要是目前是 free ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c70c63c25234f75b4acedbb40d4c0f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=XqX33DlUIrmulF%2B9%2B7Mv49tY7e0%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fce65d6a43042518f628926ba28b82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=2GynbGPUn%2FhejYbbEmIzO0a4MSw%3D" alt="" loading="lazy"/></p>
<p>在昨天的没更新的时候，模型很容易就 limit 了，更新到 1.1.3 之后情况大幅好转</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14db4e3b7acd467f8048af20656da059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=Wr4n%2BWpKlcKuLEkcILOFcV7CG3g%3D" alt="img" loading="lazy"/></p>
<p>不过 error 问题还是在的，经常遇到各种 Agent Error 只能说现在产品实现还是相对毛坯：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/680b891754294baf84bf9d90baa83734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=KvMXMnnRiR8B65ginKyKSFbRgMs%3D" alt="img" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9178fc91ede24f3198e4dcdd5b77eaa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=Gbjj4M0QvEM%2BC%2F0bUI2Vl%2FwDZsw%3D" alt="img" loading="lazy"/></p>
<blockquote>
<p>所以如果还没用上的也不急，等等更优秀。</p>
</blockquote>
<p>最后还是提一句，Google 账号的地区和 Google Play 的地区有时候是两回事，Google Play 的地区需要在 Google Play 里修改，它影响的是 Google One 的购买权限，也就是 AI Pro ， 比如最近的 Gemini AI Pro 通过 Google One 学生教育又可以续费一年。</p>
<p>而 Google 账号的地区，它影响的是 AntiGravity 这种的登录使用，这两者还是需要区分一下，当然正常来说应该两个都一样，只是说，你 Play 是 US ，不一定就是账号是 US 。</p>
<h2 data-id="heading-2">Gemini 3</h2>
<p>先说问题，实际体验下来会发现它变得倔强了，它甚至会再多轮会话里反驳 prompt 中的要求，之前 2.5 是如果纠正的话它会立马调整，而 3 里它也会先肯定你，然后说还是该按照我的来 ，最离谱的是： <strong>写的太详细的 prompt ，效果居然不如模糊的</strong>。</p>
<p>当然，这次更新之后，Gemini 3 的 UI 能力就得到了不错的提升，比如这次我用 Gemini 3 update 了我的个人主页 <code>https://guoshuyu.cn/home/index/</code> ，整体风格我还是挺喜欢的，特别是动态的背景键盘输入和右侧的 HUD terminal 输出效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8588e42ac26c4e5c830e19bc52f2c8e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=IaxKQYCUgRT4GF99MwpNvoTLdSI%3D" alt="" loading="lazy"/></p>
<p>另外 Gemini 3 的动态能力还体现在它新的「动态试图」上，通过它你可以直观感受到 Gemini 3 pro 的 UI 能力的提升：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca6afc1cbbac4ff28047399e5a6535ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=tBy3x96k5mUz5DEDXvTY%2FMgFkN0%3D" alt="" loading="lazy"/></p>
<p>例如以下都是通过 Gemini 3 pro 的动态试图，一句话直出的可交互视图效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b002866dd5f44f58336cbe7d6b9555d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=sJOIgN6%2FJBgUIJ4Y%2BNP572UM9gU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ca6063bb934d5ba24f93e7a7c850ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=9l1rh2VRwSsgpGqjR%2FHmytX4Gac%3D" alt="" loading="lazy"/></p>
<p>还可以让他做一些范式示例，比如如果需要展示蒸汽机的基础原理，直接一句话就可以让它生成一个可交互的动态效果，这对于内容创作来说无疑方便很多：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d2a7db54b7848cfb11995905d147e4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=%2F54PwUzNKi6p5VNHGfUAPiTRHrg%3D" alt="" loading="lazy"/></p>
<p>你甚至可以说「<code>https://juejin.cn/</code> 这个页面的 ui 太丑了，帮我优化个炫酷的效果」，然后你就可以得到如下图所示的 UI ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c05e5f13f9d437f89a6e475744a0337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=PDa2PQeqsQunhAK6%2FOTjTX9%2BSRw%3D" alt="" loading="lazy"/></p>
<p>所有「动态视图」也是 Gemini 3 UI 绘制能力升级的体现，虽然目前只是实验性阶段，但是按照目前 AI 的爬升速度，相信接下来还会给我们更多的惊喜。</p>
<h2 data-id="heading-3">最后</h2>
<p>最后，说再多都是虚的，自己体验下才知道，至少 AntiGravity 还是值得一试的，毕竟目前还是 Free 不是么？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[直呼太强了！国产模型遇上国产算力]]></title>    <link>https://juejin.cn/post/7574745301725216774</link>    <guid>https://juejin.cn/post/7574745301725216774</guid>    <pubDate>2025-11-21T07:18:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725216774" data-draft-id="7574892669374136374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="直呼太强了！国产模型遇上国产算力"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T07:18:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大橙子打游戏"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170907086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            直呼太强了！国产模型遇上国产算力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170907086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大橙子打游戏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:18:03.000Z" title="Fri Nov 21 2025 07:18:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#MoArk</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#GPU</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#租显卡</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟GPU体验官</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟GPU赛博名片</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#国产GPU</a></p>
<p>随着大模型应用进入加速落地阶段，如何以更低门槛、更高效率获得稳定算力，成为团队与开发者的共识需求。</p>
<p>模力方舟近期上线的「算力市场」，提供即开即用、灵活计费的国产 GPU 实例，现已全面支持 沐曦 C500、燧原 S60 等多型号算力资源，最高 64GB 显存，按分钟计费，随用随开。</p>
<p>原 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.gitee.com" target="_blank" title="https://ai.gitee.com" ref="nofollow noopener noreferrer">ai.gitee.com</a> 启用了新的域名  <a href="https://link.juejin.cn?target=https%3A%2F%2Fmoark.com%2F" target="_blank" title="https://moark.com/" ref="nofollow noopener noreferrer">moark.com/</a></p>
<h2 data-id="heading-0">快速体验一把国产算力的澎湃动力吧！</h2>
<h3 data-id="heading-1">开机</h3>
<p>以沐曦 <strong>曦云C500型号</strong> 为例，租用一张64GB，镜像选择 PyTorch / 2.6.0 / Python 3.10 / maca 3.2.1.3</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5f0897604a48bdaf4c9e14621078b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=v2GhaT3Eo9SmXbxaw7iFKCaWZaY%3D" alt="镜像选择" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4738861e723a4c6ba75711dadbaebf6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=gT5ukI4AUvTJr2zd7vcjic2KdI0%3D" alt="工作台运行.png" loading="lazy"/></p>
<h3 data-id="heading-2">编写代码</h3>
<p>点击选择Jupyterlab进入到容器当中并新建一个.ipynb文件</p>
<p>需要先行安装一下diffusers库</p>
<pre><code class="hljs language-python" lang="python">!pip install diffusers
</code></pre>
<p>之后运行下列代码，自行修改生图提示词</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DiffusionPipeline
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment">#如果是沐曦的曦云C500，可使用内置的模型路径 /mnt/moark-models/Qwen-Image</span>
model_name = <span class="hljs-string">"/mnt/moark-models/Qwen-Image"</span>

<span class="hljs-comment"># Load the pipeline</span>
<span class="hljs-keyword">if</span> torch.cuda.is_available():
    torch_dtype = torch.bfloat16
    device = <span class="hljs-string">"cuda"</span>
<span class="hljs-keyword">else</span>:
    torch_dtype = torch.float32
    device = <span class="hljs-string">"cpu"</span>

pipe = DiffusionPipeline.from_pretrained(model_name, torch_dtype=torch_dtype)
pipe = pipe.to(device)


<span class="hljs-comment"># Generate image</span>
prompt = <span class="hljs-string">'''生图提示词在这里写'''</span>

negative_prompt = <span class="hljs-string">" "</span> 


aspect_ratios = {
    <span class="hljs-string">"1:1"</span>: (<span class="hljs-number">1328</span>, <span class="hljs-number">1328</span>),
    <span class="hljs-string">"16:9"</span>: (<span class="hljs-number">1664</span>, <span class="hljs-number">928</span>),
    <span class="hljs-string">"9:16"</span>: (<span class="hljs-number">928</span>, <span class="hljs-number">1664</span>),
    <span class="hljs-string">"4:3"</span>: (<span class="hljs-number">1472</span>, <span class="hljs-number">1140</span>),
    <span class="hljs-string">"3:4"</span>: (<span class="hljs-number">1140</span>, <span class="hljs-number">1472</span>),
    <span class="hljs-string">"3:2"</span>: (<span class="hljs-number">1584</span>, <span class="hljs-number">1056</span>),
    <span class="hljs-string">"2:3"</span>: (<span class="hljs-number">1056</span>, <span class="hljs-number">1584</span>),
}

width, height = aspect_ratios[<span class="hljs-string">"9:16"</span>]

image = pipe(
    prompt=prompt,
    negative_prompt=negative_prompt,
    width=width,
    height=height,
    num_inference_steps=<span class="hljs-number">50</span>,
    true_cfg_scale=<span class="hljs-number">4.0</span>,
    generator=torch.Generator(device=<span class="hljs-string">"cuda"</span>).manual_seed(<span class="hljs-number">42</span>)
).images[<span class="hljs-number">0</span>]
</code></pre>
<h3 data-id="heading-3">查看结果</h3>
<p>之后将得到</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc1038eeeb84496eb6f6e16d1b13a5b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=eyOcsVG%2BaSocoU0xHwL1L9SNUlc%3D" alt="运行结果.png" loading="lazy"/></p>
<h3 data-id="heading-4">内置模型</h3>
<p>这个容器当中已经内置了很多模型，目录在/mnt/moark-models/Qwen-Image</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26a70ae7861140c8ab7e23a4a418c698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=xu09bWEfFKh5I6m5qwLpKl6vq6U%3D" alt="内置模型.png" loading="lazy"/></p>
<h3 data-id="heading-5">命令行工具</h3>
<p>在运行的过程中，可以使用mx-smi命令查看显存的占用情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac2df848453f4a6296d432ecc571be25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=4R3BPCUwowb45z7DqpgxxZZD7C4%3D" alt="沐曦smi查看.png" loading="lazy"/></p>
<p>从开机到得到第一张图，大概就是一分钟左右两分钟的样子，真的很快，在科研、原型验证阶段，是非常好的帮手！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】]]></title>    <link>https://juejin.cn/post/7574725286530744371</link>    <guid>https://juejin.cn/post/7574725286530744371</guid>    <pubDate>2025-11-21T07:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530744371" data-draft-id="7574816159754141747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】"/> <meta itemprop="keywords" content="OpenAI,AIGC"/> <meta itemprop="datePublished" content="2025-11-21T07:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:30:02.000Z" title="Fri Nov 21 2025 07:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人用AI“画不出来” 想象中的精美图像，不是不会写提示词，而是只会写一句“故事话”。
下面教你一个最实用、最稳定的扩展方法：<strong>把一句话拆成“五块积木”，再补齐画面细节。</strong></p>
<hr/>
<h2 data-id="heading-0">第一步：写一句最朴素的需求</h2>
<p>例如你只有一句：</p>
<pre><code class="hljs">虞姬骑着项羽在战场上冲杀。
</code></pre>
<p>—— 很像人话，但对 AI 来说太抽象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acdc96d6fd1b488bb4d3b653fd71ae43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=6mhFtxgXWf4qeQmVC9AiCaWZU1g%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">第二步：按“五块积木”拆成画面元素</h2>
<p>五块积木：
<strong>主体、环境、风格、光影色彩、构图视角</strong></p>
<h3 data-id="heading-2">① <strong>主体（长相 + 姿态 + 道具）</strong></h3>
<p>问自己：AI 需要看到什么细节？</p>
<ul>
<li>虞姬外观？武器？姿态？</li>
<li>项羽被当坐骑？长什么样？</li>
<li>动作稳定吗？</li>
</ul>
<p>补充成：</p>
<pre><code class="hljs">虞姬手持方天画戟，骑着人脸马身的项羽，姿态前倾，正在冲锋。
</code></pre>
<hr/>
<h3 data-id="heading-3">② <strong>环境（在哪里 + 有什么）</strong></h3>
<p>问自己：</p>
<ul>
<li>战场上能“看见”的物品有哪些？</li>
<li>天气？时间？烟雾？</li>
</ul>
<p>补充：</p>
<pre><code class="hljs">地面散落倒下的士兵和破碎兵器，尘土被冲起。
</code></pre>
<hr/>
<h3 data-id="heading-4">③ <strong>风格（写实？国风？3D？插画？）</strong></h3>
<p>选择 <strong>一个主风格</strong>，不要乱混：</p>
<pre><code class="hljs">写实风格，3D渲染，虚幻引擎5风格。
</code></pre>
<hr/>
<h3 data-id="heading-5">④ <strong>灯光色彩（氛围的关键）</strong></h3>
<p>氛围最稳的两种：</p>
<ul>
<li><strong>夕阳逆光</strong>（史诗大片）</li>
<li><strong>电影级光影</strong>（质感直接上去）</li>
</ul>
<p>补充成：</p>
<pre><code class="hljs">夕阳逆光，电影级光影，烟尘被光束穿透。
</code></pre>
<hr/>
<h3 data-id="heading-6">⑤ <strong>构图视角（决定画面冲击感）</strong></h3>
<p>你想让画面“宏大”还是“震撼”？
选视角：</p>
<ul>
<li><strong>广角</strong> → 史诗大片</li>
<li><strong>仰视</strong> → 英雄感</li>
<li><strong>俯视</strong> → 叙事感</li>
</ul>
<p>补充：</p>
<pre><code class="hljs">广角构图，史诗感视角。
</code></pre>
<hr/>
<h2 data-id="heading-7">第三步：补上“画质增强词”</h2>
<p>不加不影响构图，但加了质量稳定很多：</p>
<pre><code class="hljs">高细节，8K画质，超高清渲染。
</code></pre>
<hr/>
<h2 data-id="heading-8">第四步：把所有积木拼回一句完整提示词</h2>
<p>你的一句话，就变成了高质量提示词：</p>
<pre><code class="hljs">虞姬手持方天画戟，骑着人脸马身的项羽，姿态前倾，正在冲过古代战场。
地面散落倒下的士兵和破碎兵器，烟尘被冲起。
写实风格，3D渲染，虚幻引擎风格。
夕阳逆光，电影级光影，光束穿透尘土。
广角构图，史诗感视角，高细节，8K画质。
</code></pre>
<p><em>ChatGPT</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be7ceb378db746da9eb843b7d242560b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=iZ14m4U0j4Nxcwx%2F80MHIP35A7c%3D" alt="ChatGPT生成" loading="lazy"/></p>
<p><em>Grok</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5373f381ffa44e439b94110c852641b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=vOqC4LiCuJcrutjYf6wMdb21Ymo%3D" alt="grok生成" loading="lazy"/></p>
<p><em>通义万相</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea066b5ac8434fb0bbc7294bdaa00db2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=YgPZPL910sOpU4Sml%2F14EEGNIw8%3D" alt="通义万相生成" loading="lazy"/></p>
<p><em>Nano Banana 1</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c111eaa36efe4e31af91effea5527439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=N%2BT9L%2FIWOPBrJRBw6ntUHfSvzhk%3D" alt="Nano Banana 1 生成" loading="lazy"/></p>
<p><em>豆包</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3574b174cc554c878432a12b8f5fbd0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=6xRyDABYC%2BjM32WY85nxCLWvQZM%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">第五步：方法总结</h2>
<blockquote>
<p><strong>一句话扩展法：先写一句人话 → 分拆五块积木 → 补上可视细节 → 合并成画面语言。</strong></p>
</blockquote>
<p>只要按这个步骤，<strong>任何一句话都能扩展成一条专业级中文提示词</strong>：</p>
<ul>
<li>“猫咪喝奶茶”</li>
<li>“外星人跳舞”</li>
<li>“仙侠少女看月亮”</li>
<li>“城市中追车”</li>
</ul>
<p>统统适用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源】耗时数月、我开发了一款功能全面的AI图床]]></title>    <link>https://juejin.cn/post/7574718964045365298</link>    <guid>https://juejin.cn/post/7574718964045365298</guid>    <pubDate>2025-11-21T06:15:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574718964045365298" data-draft-id="7574724406306357298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源】耗时数月、我开发了一款功能全面的AI图床 "/> <meta itemprop="keywords" content="前端,后端,图片资源"/> <meta itemprop="datePublished" content="2025-11-21T06:15:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_小九"/> <meta itemprop="url" content="https://juejin.cn/user/3861140568811576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源】耗时数月、我开发了一款功能全面的AI图床 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861140568811576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _小九
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:15:01.000Z" title="Fri Nov 21 2025 06:15:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如果你想快速了解此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2F" target="_blank" title="https://pixelpunk.cc/" ref="nofollow noopener noreferrer">PixelPunk官方文档</a>。</p>
</blockquote>
<blockquote>
<p>如果你想快速体验此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2F" target="_blank" title="https://v1.pixelpunk.cc/" ref="nofollow noopener noreferrer">V1版本</a>,前往体验功能。</p>
</blockquote>
<blockquote>
<p>如果你想完整体验前后台全面的功能、你可以访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fdev.pixelpunk.cc%2F" target="_blank" title="http://dev.pixelpunk.cc/" ref="nofollow noopener noreferrer">测试环境</a>。【root 123456】</p>
</blockquote>
<blockquote>
<p>如果您认可我的项目，愿意为我献上一个宝贵的Star，你可以前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk</a>项目。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bada0a94aae436495f282772dd0748b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=5fWn3ewAdVEhFsig7JvD1gHCxbY%3D" alt="image.png" loading="lazy"/></p>
<p>开发这样一个项目在现在这个时间来看似乎没什么必要，实际上开发这样一个项目的原因其实就是在年初的时候失业了一段时间，闲在家里无聊，于是想着做一个自己的开源项目，最开始其实做的是另一个类型的项目，开发了一段时间感觉有些无聊就转战做了现在的这个项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk图床</a>， 其实并不只是想要做一个<code>图床</code>，只是当前来说的一期功能比较贴合图床，后期的跌代准备支持更多格式包括视频文档等等，并且由于<code>AI多模态模型</code>的能力发展迅速，后期结合<code>AI</code>可以实现更多可玩性比较高的内容。</p>
<p>市面上已经有了非常多的开源图床了，开发这样一个项目要追求一些差异点才会有价值，本质上来说这类服务其实核心就是个存图片而已，其他功能并不是很重要，但是作为个人使用用户来说，除了存图也愿意去尝试一些便捷的功能，于是思考到这个点之后，我开始了这个项目的开发，项目的命名<code>[PixelPunk] </code>是我让AI起的，因为要做就要做一个不一样的有特点，我要做一个ui上就不一样的图床出来，于是有了此命名，中文翻译过来是<code>像素朋克</code>,由于像素风格感觉ui不是很适合工具类网站使用，于是我选择了<code>赛博朋克风格</code>，围绕这个ui来开发了此项目。</p>
<h3 data-id="heading-0">项目概览</h3>
<p>首先呢项目从开发就一个全栈项目，前后端放一起了，采用的技术栈是 go+vue， 前端会将打包的文件放入到go中一起打包为<code>二进制</code>安装包，这样部署起来将非常简单。
项目分为了用户端和管理端，并且同属于一个项目，不分离开发，为了符合我们定制化的ui，所有组件都是自定义的组件，项目使用了<code>70+</code>自定义组件。
项目接入了多模态<code>AI</code>大模型，在以前我们的图床要实现各种功能需要对接各种各样的平台，现在有了<code>AI</code>，我们只需要一个模型就能完成非常多的功能，比如【<strong>语义化描述图片</strong>】，【**<em>图片OCR识别</em>】，【**<em>图片自动分类</em>】，【**<em>图片自动打标</em>】，【**<em>图标自动审核NSFW、违规图、敏感图、血腥图等等</em>】，【<strong>图片颜色提取</strong>】等等功能都只需要配置一个<code>AI模型</code>即可，对于成本而言，比之前的三方<code>API</code>可能更加便宜</p>
<h3 data-id="heading-1">关于部署</h3>
<p>作为一个开源项目，我想的是需要使用者使用起来足够简单，部署起来也足够快，本身来讲，我们项目需要用来这些内容，<code>mysql|Sqlite</code> + <code>Redis|系统内存</code> + <code>qdrant向量数据库</code>， 这三件套，为了安装简单，我将向量数据库直接集成到安装包，用户可以无需关系任何内容，我们可以做到<code>0配置启动项目</code>，不需要你做任何配置即可超快部署项目。</p>
<p>我们提供了两种部署方式，一种是安装包部署，你可以下载对应平台的安装包**.zip安装包**，下载到你的服务器，解压之后里面有一个<code>install.sh</code>，直接<code>sh ./install.sh</code>即可安装，当然手动部署 可能还需要两个步骤，你可以使用我们的脚本直接进行部署，也可以看看我们的部署文档，<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2Fdocs%2Fgetting-started" target="_blank" title="https://pixelpunk.cc/docs/getting-started" ref="nofollow noopener noreferrer">PixelPunk部署文档</a>。</p>
<blockquote>
<p>安装包一键部署 <code>curl -fsSL https://download.pixelpunk.cc/shell/install.sh | bash</code></p>
</blockquote>
<blockquote>
<p>docker-compose一键部署脚本 <code>curl -fsSL https://download.pixelpunk.cc/shell/docker-install.sh | bash</code></p>
</blockquote>
<p>我们的部署非常简单，你只需要执行完脚本即可直接启动项目，我们的<code>docker-compose部署方式</code>已经配置了所有数据库缓存等信息，启动项目进入 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3A9520" target="_blank" title="http://ip:9520" ref="nofollow noopener noreferrer">http://ip:9520</a></strong> 会自动跳转到安装页面，添加管理员账号密码即可完成安装， 如果使用安装包模式呢，那么就支持你可以自定义选择数据库，可以填写自己的mysql，也可以使用系统内置的<code>Sqlite</code>，可以选择自己的<code>向量数据库和缓存</code>，也可以使用系统内置的，自由选择，总之，一键脚本预估20S就可以帮你安装并且启动项目，无需你的任何配置，希望会自己内置生成一些必要信息，比如<strong>jwt</strong>，系统安装后你可以进入后台管理进行修改。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28da070422dd4053915ba5f9e947322a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=tVMkCqLBuiekcVTCbVj6V45Ef2M%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">项目部分功能</h3>
<p>我们的项目功能可以说已经非常全面了，并且还在持续迭代，目前代码总行数已经达到了<code>30W行</code>，很多功能需要你自己体验，我们覆盖了主流图床的全部功能，并且还在进一步持续加入更多有趣的元素，我们可以列举一些功能做简要说明。</p>
<h4 data-id="heading-3">10+精美主题</h4>
<p>作为个人使用的工具，我一直在持续优化UI和交互，始终认为，<code>UI</code>还是很重要的一个步骤，目前的<code>UI还不够精美</code>，也是后续会持续调整的一个点，目前提供了<code>10多套</code>主题，并且您可以自定义主题，我在项目中放置了<strong>主题开发文档</strong>,你可以根据模板文件去替换一套变量即可完成一套主题的开发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c9416634a9d4fe6a07b2f25dbab0ab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=ksH0DgnJ%2BytRxBjnOl9Z%2BsPMm4c%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdf3798fec034b7aaceff58524b7b733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=8JrdCP0BC4clFYaRkHCQe4dEeak%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">多语言双风格</h4>
<p>我们目前内置了三种语言<code>中英日</code>,并且为了迎合我们<code>PixelPunk风格</code>的特色，我们新增了一种风格选项，你可以选择<code>赛博朋克风格</code>的文案，让系统的所有内容提示充满赛博味道~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3152eb1f44824daa9aaf4428e0357b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=gSDqOQPuLSAdIBUvajx%2F4jKdxy4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ec4e8376c542c6b5fc0a62f9b8a512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=157aLoe4TEQvkfLQ%2FvGrAv%2FSTt0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">多布局系统</h4>
<p>我们网站为了更好的工作体验，提供了两种的布局方式,<code>传统布局</code>,<code>工作布局</code>，既可以使用传统的轻量化的布局让人轻松，也可以使用工作台布局让工作更高效。并且您还可以在后台限制这些功能，使用固定布局而不开放这些功能，在后台管理部分都可以实现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b76d28edf12749e180c31bd42d90ad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=s867rJHmeJg3r32jqrglpjJ%2FShY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f22417779924ad1898afc8620ad40f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=74NvoQV1LI6VPNz%2BtlpssmeMxmM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">多种登录方式</h4>
<p>我们内置默认使用传统邮箱的登录方式，并且支持关闭注册，<code>邮箱配置也是后台配置即可</code>，同时系统对接了<code>Github</code>、<code>Google</code>、<code>LinuxDo</code>三种接入成本非常低的快捷登录方式，并且可能由于你是国内服务器，无法直接访问这些服务，所以系统贴心的准备了<code>(代理服务)</code>配置，让你即使是国内服务器也依然可以顺利完成这些快捷登录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55af683a3ec340e09bba7b1a875dfaf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=27tWZAXpR3UAkgAtfh30br03%2FOc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8fc5d4613564de4b8bb1b823ec4c39e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=w7UkFYVlMOwGB%2BC4nYxF8S7PvLQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">强大的特色文件上传</h4>
<p>文件上传是一个基础的功能，所有图床都支持，我们当然也支持，我们在此功能上进行了耐心的打磨，支持很多特色功能，</p>
<ul>
<li>支持后台动态配置允许格式，动态配置上传图片限制尺寸</li>
<li>支持<code>大文件分片上传</code>、<code>断点续传</code>等功能。</li>
<li>支持<code>秒传</code>，后台动态开启是否启用</li>
<li>支持<code>游客模式</code>，限制游客上传数量，并限制上传资源有效时间</li>
<li>支持<code>自定义资源保存时间</code>，后台可配置用户允许选择有效期，精确到分钟</li>
<li>支持<code>重复图检测</code>，重复图自动秒传，不占用空间</li>
<li>支持水印，并且特色化水印，开发了一个水印专用面板用于你配置特色化水印，支持<code>文字、图片</code>水印。</li>
<li>支持<code>中断上传</code>,取消上传</li>
<li>支持<code>上传实时进度提示</code></li>
<li>支持<code>自动优化图片</code>，<code>自定义上传文件夹</code>。</li>
<li>支持<code>文件夹上传</code>,<code>拖拽上传</code>,<code>项目内全局上传（任意页面都支持上传）</code>。</li>
<li>支持<code>原图复制</code>,<code>MD格式复制</code>,<code>HTML格式复制</code>,<code>缩略图格式复制</code>,<code>全部图片链接批量复制</code></li>
<li>支持<code>公开、私密、受保护</code>,三种权限设置，<code>公开图片</code>可以在任何地方显示并且授权给管理员可以用于推荐，并且在作者首页可以展示对外，<code>私密</code>则仅自己可见，系统其他人不可见，<code>受保护</code>权限图片只能在系统观看打开，无法产生链接，除自己登录系统外，其他人无法观看。</li>
<li>支持<code>持久化</code>，你可以选择图片并且上传中，跳转到任何页面而不会中断你的上传，你可以在上传过程中干任何事情</li>
<li>支持<code>特色悬浮球</code>，当你不在上传页面的其他页面，如果有上传内容，会有一个特色上传球实时告知您上传的进度，并且你可以随意拖动控制悬浮球的位置。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdc7ea1ec924525bf3b14d5d5ca803d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=SqJyPr%2FrTNiu8LEWzfmokYBc%2BOk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66c5469421d47639f17f4d9fd308934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=vkfi3rkhaHi%2BsHDrx69J3TA3OTk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ae54015b5348ceaa37d7fc7874985f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=W2MJB4iPDNOMfVxAGtKuh7kWKqc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">超过上传渠道支持</h4>
<p>作为一个图床的基本素养，都会支持对接三方，目前我们已经支持了<code>10+</code>的三方云储存渠道，并且添加时候可以测试渠道保障你的配置，首先我们支持<code>服务器自身存储</code>，这也是系统默认渠道，你可以在后台渠道配置更多，比如<code>阿里云COS</code>,<code>腾讯云OSS</code>,<code>七牛云</code>,<code>雨云</code>,<code>又拍云</code>,<code>S3</code>,<code>Cloudfare R2</code>,<code>WebDav</code>,<code>AZure</code>,<code>Sftp</code>,<code>Ftp</code>,等等渠道，<strong>S3</strong>协议本身就可以支持非常多的基于S3协议的渠道了，并且，如果你想要更多渠道，可以去往我们官网网站提起诉求，我们可以很快支持新的渠道。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa931accca7c4903a5eb329f90d1adb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=6KGHsFjAjraMvxFS4R4f3%2F1ZyNg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2674a6366e4caabe03f3f98f0f6391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=jZjWXiqo0G7oPbnsg9JpkH8XVQY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">特色AI功能</h4>
<p>AI也是我们图床的一大特色，我们利用AI做了这些事情</p>
<ul>
<li>自动分类</li>
<li>自动打标</li>
<li>语义化图片，提取信息，提取色调</li>
<li>实现ai自然语言搜索</li>
<li>实现相似图搜索</li>
<li>实现NSFW违规图审核</li>
</ul>
<p>而这些，仅仅只需要配置一个<strong>openai的gpt4-mini</strong>即可完成，后续会支持更多渠道（目前仅支持配置OPENAI格式的渠道），目前测试感觉<strong>gpt-4.1-mini</strong>足以胜任工作，并且价格低廉，性价比很高。</p>
<ul>
<li>违规图片检测 可以自定义等级 宽松或严格</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b57cfde532dc4c13bad16a572ff66a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=oIKdJDPFrBSVJlULDdRyB8%2FOILI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自然语言搜索图片</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/084de3398649419f834f4c948b2bcfa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=0DqwiqbIchZNX92h74ejCmtUC3s%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>相似图搜索</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d322149879694be5bfd9c7a94b420738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=9mha8ofh%2FEKHhU%2BIhqXH%2Fpp0kUk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>图片ai描述</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e575a838c24ced9ef145455cdd7ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=QYjwm54STyzBTYU0qI%2BhL7HGRMk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自动分类打标签</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ea689cef8c44829823170ca949d523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=eBNytqaGR9i6PPyqKCPh1KusRXM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">文件夹功能</h4>
<p>文件分类是一个和合理的诉求，所以我们可以自定义创建文件夹，同样可以控制不同的权限，并且文件夹可以无限嵌套 你可以自定义多层级的文件夹 合理管理你的文件，并且我们支持<code>文件夹移动</code>，<code>图片移动</code>，<code>批量操作</code>，<code>右键菜单</code>，<code>拖拽排序</code>等等特色功能，你可以灵活的管理你的文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa3db788fb14937a9ca47cf82d77def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=c%2FuFtiMSrP6vkZBLQ3%2BnKfWxnuE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>右键菜单</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512e2954b1334e7fa3b57f69b490068d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=VUAPuvdr45Rvo0p7DQ0Sd5eRj1o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">分享系统</h4>
<p>我们拥有大量素材，或者一些收藏资源需要分享给好友，我们可以任意创建分享，可以分享自己的文件夹，图片，也可以组合分享，也可以分享用户公开的推荐图，选择任意探索广场的图进行分享，并且可以统计访问次数，限制访问次数，达到访问次数关闭分享，密码分享，限制时间有效期分享，邮箱通知等等功能。</p>
<p>您可以观看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fshare%2FETDMDkz6EnzZxEMl" target="_blank" title="https://v1.pixelpunk.cc/share/ETDMDkz6EnzZxEMl" ref="nofollow noopener noreferrer">演示分享内容</a></p>
<ul>
<li>创建分享</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa459bf521ec476b8190f04bb4f84bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=Ed8COuHeG9Tm4RPtn%2B8jX3aG6ws%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a5e483c67d4441e897fb2c9879ec1b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=eoZtK3nFDNnREAjJ13EFI2WP4o0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">防盗链管理</h4>
<p>图床安全始终是一个问题，经常会遇到被盗刷的风险，由于流量费用贵，鄙人有幸被刷破产过一次（TMD），我们加入了防盗链配置，可以配置<code>白黑名单域名|IP</code>，可以配置<code>网站refer</code>等内容，并且对于违规的用户，我们可以配置让其<code>302到他地址</code>,<code>可以自定义返回固定图</code>,<code>也可以直接拒绝</code>。</p>
<p>当我们对接三方渠道的时候，正常情况我们会拿到<code>远程url地址</code>，我们依然可以在后台配置渠道将其隐藏远程url地址，如果配置，那么域名请求将会从我们服务器代理获取，可以隐藏掉三方的地址，或者配置私有存储桶通过秘钥去动态获取图片，防止你的图片被盗刷大量流量</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6092e578d72a4b2f83e9f98b4ec1c277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=n5TFt%2BZMwwIeFgqLxCax7zQiRgc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">开放API</h4>
<p>图床的基本功能之一，我们可以生成秘钥在三方进行上传文件，不同的是，我们系统支持了设置秘钥时可以<code>限制其使用的空间</code>，<code>限制上传次数</code>，可以<code>指定上传的文件夹</code>,指定<code>文件格式</code>等等，并位置提供了完整的上传文档，支持<code>单文件上传</code>,<code>多文件上传</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d55a4cd12e45f3bccb57c8a30470dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=i%2BzXB20MmA0Njc4Iwg%2FcA%2BzjQb4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">随机图片</h4>
<p>经常会有人需要一个随机图片的API，但是受限于使用别人的不够稳定，也不够灵活，于是我们开放了一个随机API功能，你可以动态的配置，选择其绑定你需要随机的图片，比如指定随机任意文件夹，指定返回方式302重定向，或直接返回图片，你可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fapi%2Fv1%2Fr%2Frnd_C3wEvW5T9EjJ" target="_blank" title="https://v1.pixelpunk.cc/api/v1/r/rnd_C3wEvW5T9EjJ" ref="nofollow noopener noreferrer">pixelpunk随机图片API演示</a> ，每次刷新你可以获取新的图片。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d507d4f2f6947ef80c161b73337a5fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=TTX78wMjr45k8zr70N%2BrMLDAfpI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">空间带宽控制</h4>
<p>我们允许为用户配置限制的使用空间和流量，后台动态灵活配置这些内容，保证多用户使用的时候限制用户使用量。</p>
<h3 data-id="heading-16">更多功能</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3904072cee4741a79777739e8ae0af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=pEM3%2BzIc%2FRN%2Fho9F%2F%2FCclkiNFeE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92f44fb955fd48d283b89d061a5651e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=yUWm1SXvwBd8lhPsd05uO8zC4CY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/813a5acee47f4818a667273b7ee0785e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=gV1ZFkRESlGtaZQXs3Vm1ObZDs8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7232fbd2fa040d888643bf21fee31dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=o%2BIwr7IC23%2Fh%2FFwu8xG1RERA1Bg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/800b0f1909c343e4b00f1b8b18b06fcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=rsSczGUdNNd3E2lxOzvkKTq%2FzAk%3D" alt="image.png" loading="lazy"/></p>
<p>总之我们的功能远不止如此，我们还有很多有意思的功能，一些更多的细节需要你去探索，比如，公告系统、消息通知、活动日志、限制登录、IP登录记录，超全的管理系统、埋点统计、访客系统等等模块，这是我个人第一个花费较多时间开发的一套系统，目前对比市面上所有的开源图床，自我认为是一款相对功能最全面的图床，耗费了我大量时间。</p>
<p>如果佬友花费时间看到了这里，那么希望能收获你的一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">宝贵的Star</a>,后续的功能我依然会持续跌代，如果你有任何需求，可以私信我，如果合理，我可以无偿免费优先加入到后续跌代中去。</p>
<h3 data-id="heading-17">待更新预期功能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 后端多语言适配</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 美化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Desktop 端开发</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多格式支持 (视频|文档)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 交互体验优化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多渠道支持</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多AI接入</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 图片处理工具箱</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[下周感恩节！文心快码助力感恩节抽奖页快速开发]]></title>    <link>https://juejin.cn/post/7574803558877921295</link>    <guid>https://juejin.cn/post/7574803558877921295</guid>    <pubDate>2025-11-21T07:37:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574803558877921295" data-draft-id="7574869203448053760" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="下周感恩节！文心快码助力感恩节抽奖页快速开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:37:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            下周感恩节！文心快码助力感恩节抽奖页快速开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:37:06.000Z" title="Fri Nov 21 2025 07:37:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文转载自“嚣张农民”，有修改。</p>
<p>嚣张农民：前端工程师，通过AI Coding简化辅助工作内容，节约时间做更多的事。</p>
</blockquote>
<p>在清晨的早上，我在公司吃着早餐，刷着抖音推荐的大数据长腿生物，听着后端兄弟讲八卦，突然一条消息弹窗弹出，里面的需求要我完成感恩节的抽奖页面，看着简单的几句话，我知道又要占据我几天的时间去忙碌，纯前端的页面不需要后端参与，斜眼看了下隔壁后端老哥的嘴角微微一笑。但是作为墨鱼圣子怎会妥协，我想起百度文心快码已经更新到3.5S，可以快速从0-1搭建，更加智能，就像钢铁侠中贾维斯一样明确你发出的指令（抽象描述词），而且可以免费使用，那还等什么，赶紧用起来哈哈~~~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d645c488dff84c889f65555f7fa48773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=0P69cw9eYH69yqAngGt1bHq%2F1zc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>文心快码 ( Baidu Comate ) 是一款由百度推出的创新型 AI 编码辅助工具，它利用先进的人工智能技术，旨在带来流畅、直观且上下文驱动的编码体验，助力开发者更轻松地实现宏大的软件项目和创新想法。近日，Comate发布最新版，功能又又又又升级啦：</p>
<ul>
<li>内置丰富垂类Agent，即点即用；</li>
<li>自定义 Agent 可在项目内便捷共享，助力团队沉淀经验、复用流程；</li>
<li>Rules支持基于AI自动创建，简化配置方式、落地更高效。</li>
</ul>
<h2 data-id="heading-0">安装流程及操作</h2>
<p>了解升级内容文档之后开始我们的开发，在我的VS Code版本（1.104.0）直接插件安装，输入Baidu Comate之后等待安装，然后根据自己的需求选择需要的智能体，我是选择Zulu去进行开发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd771ba4de12487aabce92d4b609dfe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=DmdXS8GGlfmvy9iaZDDt0%2FNbGM4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954e0df123564dd19f30ef90ff06140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=LmiSj6PZIYAkmDaLnTF1U7%2FuFeU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-1">描述指令</h2>
<p>给文心快码一些指令，我这边整理好需求之后，让它帮我上手开发，一行代码不用敲，这时候需要发挥我们的创意了,只需要坐在电脑前等待就好了。</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>🎯 页面目标</p>
<p>主题：感恩节</p>
<p>目的：给公司员工抽取礼物</p>
<p>风格：温馨有爱、节日氛围浓厚（浅色系为主）</p>
<p>要有动效、音效（抽奖转动时有动画，中奖时有烟花或彩带效果）</p>
<p>🎨 交互与动效</p>
<p>中心是一个九宫格风格的抽奖组件</p>
<p>点击「开始抽奖」按钮后：抽奖动画播放 2~3 秒，停止后显示中奖结果，播放中奖动画（烟花、礼花、闪光特效等）</p>
<p>背景音乐（抽奖期间播放，结果揭晓时切换音乐）</p>
<p>排行榜组件（记录中奖次数/大奖获得者）</p>
<p>可配置奖品和概率（JSON配置即可），通过页面的“配置奖品”按钮配置</p>
<p>⚙️ 技术要求</p>
<p>使用Vue** + Vite + TailwindCSS**</p>
<p>抽奖逻辑在前端模拟实现（不连后台）</p>
<p>项目结构清晰、组件化</p>
<p>包含基本的状态管理逻辑（例如用useState / useReducer）</p>
<p>页面响应式适配 PC 和大屏展示</p>
<p>📦 交付内容</p>
<p>提供完整可运行的项目代码（含 package.json、入口文件、组件文件等）</p>
<p>预置6~8 个奖品示例（名称 + 图片）</p>
<p>使用本地假数据模拟抽奖结果（可后续接后台接口）</p>
</blockquote>
<h2 data-id="heading-2">效果展示</h2>
<p>不到十分钟文心快码完成框架搭建，代码生产，UI生产，完成我们精美的页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe166a9b5289414cb0194dd56ff5f83d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=076C3r5asOmbVwiWPCM7vlQoWn0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当前页面已具备抽奖基本功能，但仍不能实现奖品配置和真实员工姓名与奖品一一对应，九宫格也略显简陋，再次输入Prompt进行优化：</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>1.请隐藏奖品列表，添加“奖品配置”按钮，点击打开奖品配置页面，可以配置奖品名称和概率，奖品图案自动生成；</p>
<p>2.在九宫格上方添加“姓名"输入框，输入框右边为“确认”按钮，点击确认后，抽奖奖品和姓名一一对应，1人仅1次抽奖机会</p>
<p>3.优化九宫格视觉，九宫格格子有多种色彩，文字和图片放大</p>
</blockquote>
<p>页面焕然一新啦！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4939fc19ddb04e75b3d1eddc63327175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=aAvK9y1molMfEkco6EOfU%2BGqaEI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>让我们测试下功能吧：假设员工“张三”参与抽奖</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/478ced2594e348a38507b18568be1cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=MyMLOc96SK4X%2FFyWBgKyz9FC9ko%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>张三随机抽得“谢谢参与”并计入排行榜，再次点击“检查状态”，抽奖按钮置灰，一人仅可抽一次</p>
<p>再多试几个人：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be572ec9bb74fb9afe5ec93b92d013d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=HuvB6A%2Fb5piRGaKWn5rRNwnyWDE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>点击“奖品配置”按钮，可以修改奖品及对应概率（会提示当前概率总和，很方便）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fad8183adf2c4adfa8ed31c764330602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=A%2FAI6jnm8EAB80IroA8SVgaBLc4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-3">后续优化</h2>
<p>如：支持<strong>上传本地奖品图片并可在对应九宫格显示，还有根据姓名输入提示中奖率哈哈（开玩笑）~~~</strong></p>
<p>当前奖品图片不可更改，优化为可上传更改。</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>奖品配置可上传奖品对应图片，修改后会显示在九宫格</p>
</blockquote>
<p>完美！现在可以自己上传奖品图片啦～～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b4479d7705d4c83bab2f1220924d348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=d9jZTdCxKgAkaGjFA89y8uJE4D4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>可以看到生成的文件和命名还是比较规范，起码帮我省了两天的开发时间，还是很给力的！！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97318d3bd1048aa9ccf16c0f2b0749f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=hI%2FCaRO2mO1OxZFUXzXwbfQGna0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>从“个人助理”到“协作团队”，文心快码开启 AI开发新时代</p>
<p>文心快码不再只是一个帮助写代码的工具，而是可以组成一支虚拟 AI 团队，懂项目、能协作、会自我管理。</p>
<p>对于想要提升研发效率、加速交付节奏的开发者和团队来说，文心快码是不容错过的新选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Google Nano Banana Pro图像生成王者归来]]></title>    <link>https://juejin.cn/post/7574725286530826291</link>    <guid>https://juejin.cn/post/7574725286530826291</guid>    <pubDate>2025-11-21T07:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530826291" data-draft-id="7574816159754600499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Google Nano Banana Pro图像生成王者归来"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T07:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Google Nano Banana Pro图像生成王者归来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:39:17.000Z" title="Fri Nov 21 2025 07:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI图像生成领域飞速发展的今天，如何让AI更精准地理解我们的需求、生成高质量的图片，成为了创作者和设计师们最关心的话题。传统的文生图模型往往在中文文字渲染、多图一致性、精准控制等方面存在明显短板，导致生成的图片要么文字乱码、要么细节失真，让人又爱又恨。</p>
<p>Google最新发布的Nano Banana Pro（正式名称：Gemini 3 Pro Image）彻底改变了这一局面。这款模型通过"自回归+扩散"混合架构，结合Gemini 3的强大推理能力，实现了文生图领域的革命性突破——不仅完美支持中文、日文、韩文等多语言文字渲染，还能同时处理最多14张参考图片，保持最多5个角色的一致性，在LMArena排行榜上以1501的Elo分数登顶第一！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76fd678f204749b5859c82cfcbad5804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=2ZYiiTWkSBgGNHw0QofaOZEmjTI%3D" alt="image-20251121144725440" loading="lazy"/></p>
<p>这2天Nano Banana Pro非常火爆，今天我们就手把手教大家如何使用这个强大的AI图像生成工具，通过丰富的提示词案例，体验和感受一下这个王者级模型的恐怖能力。</p>
<hr/>
<h2 data-id="heading-1">功能演示实战</h2>
<p>话不多说，下面我们通过丰富的提示词案例，手把手带大家体验Nano Banana Pro的各项强大功能。小伙伴们可以直接复制提示词到Gemini或AI Studio中测试。</p>
<h3 data-id="heading-2">1. 中文文字渲染：从乱码到完美</h3>
<p>传统AI图像生成模型最大的痛点就是中文文字渲染，要么字体模糊，要么乱码一片。Nano Banana Pro彻底解决了这个问题。</p>
<h4 data-id="heading-3">案例1：古诗配图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">给这句古诗配图：两岸猿声啼不住，轻舟已过万重山。
</code></pre>
<p><strong>效果说明</strong>：
模型不仅准确理解了古诗的意境，还自动在画面上方添加了竖排的诗句文字，字体清晰，完全没有涂抹感。画面中的轻舟、青山、江水完美契合诗意。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46b672d8d9544fbdb550d5fecaa64f6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=ukLekR2%2FQA7GS%2Fp1Hu4%2BKTePLO4%3D" alt="1763700555007" loading="lazy"/></p>
<p>呵呵，这理解力绝了！</p>
<h4 data-id="heading-4">案例2：繁体字霓虹灯牌</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">霓虹闪烁的<span class="hljs-number">80</span>年代香港旺角街头夜景，有个霓虹灯牌上写着<span class="hljs-string">"可口可樂"</span>，一杯可口可乐融合在霓虹灯管设计中
</code></pre>
<p><strong>效果说明</strong>：
注意"樂"字是繁体，模型准确渲染。街头氛围、灯牌字体、光影效果都极具80年代香港风格，细节到位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abda4d311ad144679e67854fb7bd5b08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=1Xen1g5z8FNoXdCQYfQ8%2FFzZT2g%3D" alt="80年代香港霓虹可口可乐" loading="lazy"/></p>
<h4 data-id="heading-5">案例3：古籍插画标注</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">古籍插画风格。一张精细的中国龙解剖图，展现其内部结构，并用清晰的中文标签（例如：<span class="hljs-string">"龙鳞"</span>、<span class="hljs-string">"龙爪"</span>、<span class="hljs-string">"龙珠"</span>）进行标注。画面风格庄重，带有古代学术气息。
</code></pre>
<p><strong>效果说明</strong>：
生成的图像完全像是从真实古籍中取出来的，不仅文字标注清晰，连印章都清晰可辨。这种古籍风格的质感，好家伙，设计师都要失业了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ada27f5b3e2470f8514124921f5ff1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hk%2B%2BdXlY6o1JMCpsHuFQQfUO%2BdY%3D" alt="1763703532453" loading="lazy"/></p>
<h4 data-id="heading-6">案例4：立体文字艺术</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">一张极具食欲的美食摄影图，俯视视角。深色的木质纹理桌面上，堆满了鲜红的干辣椒和花椒。这些辣椒被巧妙地排列，组成了立体的四个汉字：<span class="hljs-string">"热辣滚烫"</span>。辣椒的表面有真实的褶皱和光泽，周围散落着几颗八角，光线温暖诱人，景深微距。
</code></pre>
<p><strong>效果说明</strong>：
用辣椒摆成的文字立体感十足，每个笔画都清晰可辨，光影效果真实自然。这种创意文字排版，以前需要PS大师花几个小时，现在一句话搞定。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31528d2066ca413abbfda10d8f253bc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=%2FHkt%2BHHPfOrSa%2B5Gkrke%2FHtK7LA%3D" alt="1763703671285" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">2. 实时联网能力：AI会上网了</h3>
<p>Nano Banana Pro集成了Google搜索能力，可以获取实时信息并生成图像，这是其他图像生成模型不具备的杀手级功能。</p>
<h4 data-id="heading-8">案例5：实时天气UI设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">帮我搜索现在（<span class="hljs-number">20251121</span>）合肥的天气信息，并且将其放在一个天气<span class="hljs-type">UI设计稿中</span>
</code></pre>
<p><strong>效果说明</strong>：
模型会先执行Google搜索，获取合肥当前的真实天气数据（温度、天气状况、湿度），然后自动生成一个设计精美的天气UI界面。更惊喜的是，背景图居然是秋天的长城，它太懂了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19db67adb7364b4cb37241fe7b58bfe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=ab9QtIQ8cBlkG7Z%2B%2BgPPOt%2BYy90%3D" alt="1763703967056" loading="lazy"/></p>
<h4 data-id="heading-9">案例6：旅游日记自动生成</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">模拟在一张略带纹理的纸张上（米黄色或者浅棕色）手写的关于今天的日记。所有的图片以拼贴画风格放在一页日记上，保证图片与原图一致包含以下元素：

用手写字体描述今天做了什么，以及一两句吸引人的标语或简介，包含几张图片的介绍，用红色笔迹或其他亮色圈出或用箭头指向特别推荐的地点或活动。穿插一些与图片特色相关的简单涂鸦式小图画，写着当前的日期和北京的天气，并添加一个手绘角色形象

整体感觉要像一份由热爱生活的作者精心制作的、生动有趣的个人日记。
</code></pre>
<p><strong>效果说明</strong>：
模型会搜索当前日期和天气，然后生成一页手账风格的旅游日记。照片加了类似拍立得的白边，还有手写备注、红色圈注、涂鸦小图，甚至手绘角色都有！这个多模态理解能力太可怕了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d9bf3a364f84861a9394d00cfe08a02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=crUwoBWqqKHn8gEaZ6e7WrtA8vY%3D" alt="1763704644688" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">3. 风格迁移与图像编辑：一句话P图</h3>
<p>Nano Banana Pro的图像编辑能力堪称"靠嘴P图"，基于自然语言就能精准修改图像的任何元素。</p>
<h4 data-id="heading-11">案例7：从像素风到4K渲染</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">生成一个复古像素艺术风格的RPG游戏背包界面。左侧是像素风格的角色装备栏（头盔、铠甲、武器、鞋子），右侧是<span class="hljs-number">5</span>x5的物品格子，底部有像素字体的金币数量和<span class="hljs-string">"返回"</span>按钮。色彩限制在<span class="hljs-number">8</span>-bit调色板。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebbfc874ef634fccae3729da1af18c64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=2ZMGdCZaRPT4aA7CXooZ6yJqBWs%3D" alt="1763704745374" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">保持原有的界面布局、物品位置和文本内容不变，将整个画面重新渲染为高质量的4K科幻风格UI。材质变成发光的透明毛玻璃和拉丝金属，背景是动态的宇宙星云，图标变成精细的3D全息投影模型。
</code></pre>
<p><strong>效果说明</strong>：
布局、文字、物品位置完全一致，但视觉质感从8-bit像素风瞬间升级为电影级4K渲染。这种风格切换能力，游戏UI设计师看了都要沉默。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f0c23adad94170b8775976028d1036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=T30UEpyLfuki5E%2BM%2BNTbNWgyaUI%3D" alt="1763704885163" loading="lazy"/></p>
<h4 data-id="heading-12">案例8：赛博朋克变吉卜力水彩</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs">一个赛博朋克风格的街头武士全身像，站在霓虹闪烁的雨夜东京街头。他戴着发光的机械面具，穿着机能风外套，手里拿着一把发红光的武士刀，背景是巨大的广告牌和飞行汽车。摄影风格，高对比度。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39dccf214212429cbfecd256b9208bbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=zNwXMp86yNpN0Q1RUnulC6i1qME%3D" alt="1763704981372" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">将图中的赛博朋克武士重新绘制成吉卜力工作室（Studio Ghibli）的动画风格。使用柔和的水彩和色粉笔触，背景变成充满自然植物和手绘木结构建筑的温暖小镇白天，角色的机械装备变得更像蒸汽朋克或手工制品，光影温暖柔和。
</code></pre>
<p><strong>效果说明</strong>：
人物姿态、构图完全一致，但从冷酷的赛博朋克秒变温暖的宫崎骏风格。水彩质感、植物、木屋、柔和光线，完全就是吉卜力动画的感觉。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f09638367074425db38d6567fe43111d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hwkgYxAjZ43wpSDKYh2eatfUQ8k%3D" alt="1763705163878" loading="lazy"/></p>
<h4 data-id="heading-13">案例9：儿童涂鸦变皮克斯3D</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs">一张用蜡笔画在作业本纸上的儿童涂鸦。画的是一个歪歪扭扭的橘色怪兽，有三只眼睛，长着翅膀，在吐火。线条非常幼稚，充满童趣。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d19440fa5d834715a55ca6d03097f8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=I9RmtFhcbmMkOaUgwnRz9xPBZSY%3D" alt="1763705287287" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">基于这个儿童画的角色设计，将其渲染为皮克斯（Pixar）或迪士尼风格的3D动画电影角色。橘色怪兽变成了毛茸茸的可爱质感，大眼睛水汪汪的，翅膀也是软萌的风格。背景是梦幻的糖果云彩世界，光影质感像电影《怪兽电力公司》。
</code></pre>
<p><strong>效果说明</strong>：
保留了儿童画的创意（三只眼、翅膀、吐火），但从涂鸦变成了电影级3D角色。毛发、质感、光影都达到了皮克斯的标准，这简直就是把孩子的灵魂涂鸦变成真正的动画角色！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0b08567c48422eb9bff2a790771683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=9EGhyGnp4NHDC%2FcgUfuEQJOH0eo%3D" alt="1763705491715" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-14">4. 商品一致性：电商设计神器</h3>
<p>Nano Banana Pro能够完美保持商品的细节一致性，这对电商设计师来说简直是福音。</p>
<h4 data-id="heading-15">案例10：产品多配色展示</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">设计一张<span class="hljs-string">"赛博朋克风"</span>联名限量版跑鞋。配色为黑色和荧光绿。要求鞋面有复杂的机甲纹理、发光线条和醒目的品牌Logo。放在专业摄影棚的白色背景中，细节锐利，专业布光。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f459f8f0c4147e293558576b9a39e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=y38iE%2FxoY%2BTIzbEnHW1927Qf6VI%3D" alt="1763705712927" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">保持这双鞋的设计和纹理不变。现在生成三双鞋并排展示：分别是原版黑绿配色、火焰红配色和冰晶蓝配色。要求版式统一，细节清晰，像产品目录一样。
</code></pre>
<p><strong>效果说明</strong>：
鞋子的机甲纹理、Logo位置、发光线条细节完全一致，只是更换了配色。这种一致性对于电商SKU展示太重要了，不需要下载上传，直接对话就能生成系列产品图！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf1dc558fa84240a53f09b3e02a0f0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=kFGy5l0l%2FykdJsS2nEzu3DmzRek%3D" alt="1763705951862" loading="lazy"/></p>
<h4 data-id="heading-16">案例11：产品场景合成</h4>
<p><strong>提示词3（基于上图修改）</strong>：</p>
<pre><code class="hljs">将第一双黑绿配色的球鞋放在一个潮湿的东京街头。特写镜头，地面有霓虹灯反射的水洼，一名时尚模特穿着这双鞋在街上行走，景深效果。
</code></pre>
<p><strong>效果说明</strong>：
鞋子的复杂纹理、Logo细节全都保持一致，但场景从摄影棚变成了街头实景。光影、水面反射、景深效果都极其自然，这就是"上下文记忆"的恐怖之处！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f132203cc6c6477c9e61b4a2e3852cde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=vq6hKm6lUbe7ovLhLObGyXr%2Bhgs%3D" alt="1763706143084" loading="lazy"/></p>
<h4 data-id="heading-17">案例12：多商品组合设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">为这两个香薰产品设计产品海报。两个香薰放在一起的超近景特写，质感清晰。米色背景，周围棕色透明轻纱，蕨类植物，沉香枯木，两支铃兰。<span class="hljs-number">4</span>K超清画面质感。静物摄影，昏暗氛围，光线追踪。海报上方文案标题：<span class="hljs-string">"昆仑煮雪"</span>，极细文字。页面下方小字：<span class="hljs-string">"沉香|铃兰|草本"</span>。艺术签角标：<span class="hljs-string">"观夏|to summer"</span>。
</code></pre>
<p><strong>效果说明</strong>：
可以上传真实的商品图，模型会保持商品的所有细节（包括瓶身上的小字），然后按照你的要求进行场景搭建、排版设计。文案标题"昆仑煮雪"字体清晰，布局专业，这完全就是可以直接商用的电商海报！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1723c654538401d8eaf070dc10258e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hkddXh5n2UEQeHkG4rr09UZ2q1s%3D" alt="Create_a_product_poster_for_two_aromatherapy_produ-1763706518061" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-18">5. 角色一致性：漫画创作利器</h3>
<p>对于漫画创作者来说，保持角色在不同场景下的一致性一直是痛点。Nano Banana Pro支持最多5个角色的一致性控制。</p>
<h4 data-id="heading-19">案例13：连续剧情绘制</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">杰瑞鼠身披《大闹天宫》动画版标志性的鹅黄色虎皮裙、大红披风和金甲，头戴凤翅紫金冠，手持金箍棒，面部表情夸张而神气，背景是天宫的亭台楼阁或花果山水帘洞，整个画面都将严格遵循上海美术电影制片厂《大闹天宫》的经典画风，色彩浓烈，线条流畅，充满浓郁的中国传统水墨和工笔重彩韵味。
</code></pre>
<p><strong>效果说明</strong>：
可以让漫威的死侍穿越到《龙猫》的公交站，或者让杰瑞鼠cosplay孙悟空。角色特征、服装细节在不同场景下都能保持一致，解决了连载漫画"每帧主角长得都不一样"的难题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ca46d70c9b429a82650794af6110f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=DpkF0Vlk0wIppLENKZ%2BaNpDn0%2Fo%3D" alt="1763706366423" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-20">6. 设计海报：平面设计新玩法</h3>
<p>Nano Banana Pro在平面设计方面的能力已经达到了高级设计师的水准。</p>
<h4 data-id="heading-21">案例15：电影海报设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">一张电影海报，风格为<span class="hljs-string">"赛博朋克京剧"</span>（Cyberpunk Peking Opera）。海报主视觉是一名京剧武生站在霓虹灯闪烁的未来城市中。片名《机械霸王别姬》和宣传语：<span class="hljs-string">"当传统遇到未来。"</span>
</code></pre>
<p><strong>效果说明</strong>：
直接就是一张可以商用的电影海报，文字排版极具张力，视觉冲击力强。中西结合的设计理念，京剧与赛博朋克的融合，创意满分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f0f5ce6fb34e8e82c0227876f912d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=6WqF16kCBiaH2QS92Cqoo70sOjI%3D" alt="Create_a_movie_poster_with_the_theme_Cyberpunk_Pe-1763706850488" loading="lazy"/></p>
<h4 data-id="heading-22">案例16：一键换品牌</h4>
<p><strong>提示词2（基于同一海报）</strong>：</p>
<pre><code class="hljs">把人物换成Elon Musk
</code></pre>
<p><strong>效果说明</strong>：
几秒钟，新海报出来了，毫无违和感！瓶身细节、Logo、背景光影都自动适配。甚至可以换人物，这以后设计师的工作流要彻底改变了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eca8e00088a847c09622b23d8c5f2baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=M3PBxQmFUr0QYnG5VFghEW5J7sU%3D" alt="Replace_the_Peking_Opera_martial_artist_in_the_ima-1763707186496" loading="lazy"/></p>
<p>卧槽卧槽！是不是非常简单？</p>
<hr/>
<h3 data-id="heading-23">7. 信息图表：教育科普神器</h3>
<p>Nano Banana Pro的推理能力使它在生成信息图表方面表现出色。</p>
<h4 data-id="heading-24">案例17：手工教程分解图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">制作一张信息图，展示<span class="hljs-string">"如何折一只千纸鹤（Paper Crane）"</span>。包含<span class="hljs-number">6</span>个关键折叠步骤的分解图，并标注出折痕方向（山折/谷折），极简线条风格。
</code></pre>
<p><strong>效果说明</strong>：
模型真的理解了从纸张到成品的每一步变化，连虚线标注都清清楚楚。以前要画半天的说明书，现在几秒钟搞定！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35242f62833344f38c2e74ccc1c74879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=waUdnmy5bwhx89AwZdylyaqWuEk%3D" alt="如何折千纸鹤" loading="lazy"/></p>
<h4 data-id="heading-25">案例18：科普信息图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">创建一个展示汽车发动机构造的信息图表
</code></pre>
<p><strong>效果说明</strong>：
零件位置、连接关系、文字标注都准确无误，这种专业级的教育图表，以前需要专业绘图软件+几个小时，现在一句话就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/269b159b240c495e829cfa97609ee648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=FVjB2wrKfoId%2FUkq%2FSTBO3cUY3E%3D" alt="1763707678934" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-26">使用平台推荐</h2>
<p>小伙伴们可以通过以下平台体验Nano Banana Pro的强大能力：</p>
<h3 data-id="heading-27">官方平台</h3>
<h4 data-id="heading-28">Gemini网页版</h4>
<ul>
<li><strong>地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com" target="_blank" title="https://gemini.google.com" ref="nofollow noopener noreferrer">gemini.google.com</a></li>
<li><strong>说明</strong>: 免费用户可用，但分辨率限制为1K；Gemini Advanced订阅用户可以使用完整的2K/4K功能</li>
<li><strong>优势</strong>: 官方平台，稳定可靠，支持中文界面</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89ed75c63de4209b2deeefc8a6a56a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=Q303URXKFn6zcMEfSu54XGHGt8w%3D" alt="image-20251121143621368" loading="lazy"/></p>
<h4 data-id="heading-29">AI Studio</h4>
<ul>
<li><strong>地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com" target="_blank" title="https://aistudio.google.com" ref="nofollow noopener noreferrer">aistudio.google.com</a></li>
<li><strong>说明</strong>: 需要付费API账号才能使用Pro版本</li>
<li><strong>优势</strong>: 支持API调用，适合开发者集成到自己的应用中</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9378978bc39147f6b4c8526d132e7677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=Loq3jQ%2BHfJvRm5BaI4yexV8Nf8I%3D" alt="image-20251121143710485" loading="lazy"/></p>
<h3 data-id="heading-30">第三方平台（免费体验）</h3>
<p>目前以下第三方平台都已集成Nano Banana Pro，小伙伴们可以免费体验：</p>
<ul>
<li><strong>Lovart</strong> (<a href="https://link.juejin.cn?target=http%3A%2F%2Flovart.ai)%25EF%25BC%259A%25E5%2585%258D%25E8%25B4%25B9%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E7%2595%258C%25E9%259D%25A2%25E5%258F%258B%25E5%25A5%25BD" target="_blank" title="http://lovart.ai)%EF%BC%9A%E5%85%8D%E8%B4%B9%E4%BD%BF%E7%94%A8%EF%BC%8C%E7%95%8C%E9%9D%A2%E5%8F%8B%E5%A5%BD" ref="nofollow noopener noreferrer">lovart.ai)：免费使用，界面友好</a></li>
<li><strong>Listenhub</strong>：支持中文，响应速度快</li>
<li><strong>Flowith</strong>：适合创作者使用</li>
<li><strong>Youware</strong>：支持批量生成</li>
<li><strong>Trickle</strong>：集成了工作流功能</li>
<li><strong>ZenMux</strong> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fzenmux.ai)%25EF%25BC%259A%25E6%258F%2590%25E4%25BE%259B%25E5%25A4%259A%25E6%25A8%25A1%25E5%259E%258B%25E8%2587%25AA%25E5%258A%25A8%25E8%25B7%25AF%25E7%2594%25B1" target="_blank" title="https://zenmux.ai)%EF%BC%9A%E6%8F%90%E4%BE%9B%E5%A4%9A%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E8%B7%AF%E7%94%B1" ref="nofollow noopener noreferrer">zenmux.ai)：提供多模型自动路由</a></li>
</ul>
<h3 data-id="heading-31">成本对比</h3>





































<table><thead><tr><th>版本</th><th>分辨率</th><th>成本（每张）</th><th>速度</th><th>推理深度</th><th>适用场景</th></tr></thead><tbody><tr><td>Gemini 2.5 Flash Image</td><td>1K</td><td>$0.039</td><td>极快(&lt;2s)</td><td>低</td><td>聊天配图、快速预览</td></tr><tr><td>Gemini 3 Pro Image</td><td>2K</td><td>$0.12</td><td>中等</td><td>中</td><td>社交媒体、日常创作</td></tr><tr><td>Gemini 3 Pro Image</td><td>4K</td><td>$0.24</td><td>较慢</td><td>高（Deep Think）</td><td>商业设计、专业创作</td></tr></tbody></table>
<p><strong>建议使用策略</strong>：</p>
<ul>
<li>草图阶段用Flash版快速迭代</li>
<li>确认满意后用Pro版进行高清渲染</li>
<li>商业项目直接使用4K+Deep Think模式</li>
</ul>
<hr/>
<h2 data-id="heading-32">总结</h2>
<p>今天主要带大家了解并体验了Google Nano Banana Pro（Gemini 3 Pro Image）这个图像生成王者的强大能力完整流程，该AI图像生成模型以"自回归规划 + 扩散渲染混合架构"和"Gemini 3深度推理能力"为核心优势，结合图像创作、平面设计、电商运营、教育科普、内容创作需求，通过Google搜索集成与多模态理解，形成了一套从自然语言提示词到4K高清图像输出的全链路AI创作解决方案。通过这套实践方案，创作者、设计师、运营人员能够高效突破传统图像生成模型的三大瓶颈——借助完美的中文文字渲染（包括繁体、日韩文等多语言支持）、超强的角色与商品一致性控制（最多14张参考图、5个角色同时保持一致）、基于自然语言的精准图像编辑（风格迁移、元素替换、细节调整），无需专业设计软件和复杂操作，就能快速实现商业级图像创作（如本次演示的"古诗配图"、"电商产品海报"、"漫画翻译上色"、"信息图表生成"、"UI设计迁移"等20+实战案例）。</p>
<p>无论是商业海报设计、产品详情页制作、漫画连载创作、教育信息图表，还是社交媒体内容、品牌物料设计，都能通过精心设计的提示词完成，极大提升创作效率和设计质量。在实际应用中，该模型不仅文字渲染准确率达97%+（完全解决了传统模型的中文乱码问题），还集成了Google搜索的实时信息获取能力（可以生成包含当前天气、新闻等实时数据的图像），适配性远优于Midjourney、DALL-E 3等竞品；特别是通过LMArena 1501 Elo排名第一的成绩，有效验证了将"System 2思维"引入视觉生成的技术路线优势。同时，方案具备良好的灵活性——小伙伴们可以基于此扩展更多创作场景，如视频故事板设计、游戏角色设计、建筑效果图生成、产品包装设计、活动海报制作、儿童绘本创作、科技论文配图等，进一步发挥Nano Banana Pro在电商运营、内容创作、教育培训、游戏美术、品牌营销等领域的应用价值。感兴趣的小伙伴可以按照文中提供的提示词案例进行实践，根据实际创作需求调整提示词的描述细节、风格关键词、分辨率参数。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 入门指南：核心概念与理论框架]]></title>    <link>https://juejin.cn/post/7574958975159337003</link>    <guid>https://juejin.cn/post/7574958975159337003</guid>    <pubDate>2025-11-21T07:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159337003" data-draft-id="7574821757665820713" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 入门指南：核心概念与理论框架"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-21T07:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 入门指南：核心概念与理论框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:42:50.000Z" title="Fri Nov 21 2025 07:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 入门指南：核心概念与理论框架</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a3016eef8c4ab0933e83e98f1dd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316400&amp;x-signature=4Ajf2edTW73Onq13w3THs8JbP0c%3D" alt="人工智能的无限可能.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、什么是 LangChain？</h3>
<p>LangChain 是一个专为开发大语言模型（LLM）应用而设计的开源框架。它的核心价值在于<strong>将 LLM 的能力模块化、标准化</strong>，让开发者能够像搭积木一样组装复杂的 AI 应用，而不必从零开始处理底层的模型调用、数据处理、工具集成等繁琐工作。</p>
<p>简单来说，LangChain 解决了三个核心问题：</p>
<ol>
<li><strong>如何让 LLM 与外部世界交互</strong>（访问数据库、调用 API、读取文档）</li>
<li><strong>如何让 LLM 具备记忆和上下文管理能力</strong>（维持对话连贯性）</li>
<li><strong>如何让 LLM 自主决策和执行复杂任务</strong>（智能代理）</li>
</ol>
<hr/>
<h3 data-id="heading-2">二、LangChain 的核心概念</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1c0a22ebc7043dfa1023698bd2ec818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316400&amp;x-signature=%2FE25wRgcOq5ulzHWu4j9YcBOmo8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-mermaid" lang="mermaid">
mindmap
  root((LangChain&lt;br/&gt;核心概念))
    Models&lt;br/&gt;模型
      LLMs&lt;br/&gt;语言模型
      Chat Models&lt;br/&gt;聊天模型
      Embeddings&lt;br/&gt;嵌入模型
    Prompts&lt;br/&gt;提示词
      Templates&lt;br/&gt;模板
      Example Selectors&lt;br/&gt;示例选择器
      Output Parsers&lt;br/&gt;输出解析器
    Documents&lt;br/&gt;文档处理
      Loaders&lt;br/&gt;加载器
      Text Splitters&lt;br/&gt;文本分割器
      Transformers&lt;br/&gt;转换器
    Vector Stores&lt;br/&gt;向量存储
      Vectorization&lt;br/&gt;向量化
      Retrieval&lt;br/&gt;检索
      Re-ranking&lt;br/&gt;重排序
    Chains&lt;br/&gt;链
      LLMChain&lt;br/&gt;简单链
      Sequential&lt;br/&gt;顺序链
      Router&lt;br/&gt;路由链
      Pre-built&lt;br/&gt;预制链
    Memory&lt;br/&gt;记忆
      Buffer&lt;br/&gt;缓冲记忆
      Window&lt;br/&gt;窗口记忆
      Summary&lt;br/&gt;摘要记忆
      Entity&lt;br/&gt;实体记忆
    Agents&lt;br/&gt;代理
      ReAct&lt;br/&gt;推理行动
      Tools&lt;br/&gt;工具调用
      Planning&lt;br/&gt;任务规划
    Callbacks&lt;br/&gt;回调
      Logging&lt;br/&gt;日志记录
      Monitoring&lt;br/&gt;监控
      LangSmith&lt;br/&gt;平台集成

</code></pre>
<h4 data-id="heading-3">2.1 模型（Models）</h4>
<p>模型是 LangChain 的"大脑"，主要分为三类：</p>
<h5 data-id="heading-4"><strong>语言模型（LLMs）</strong></h5>
<p>传统的文本生成模型，接收文本输入，输出文本结果。适合单轮问答、内容生成等场景。</p>
<h5 data-id="heading-5"><strong>聊天模型（Chat Models）</strong></h5>
<p>专为对话设计的模型，理解"角色"概念（系统、用户、助手），能够维持多轮对话的上下文。这是当前主流应用的核心选择。</p>
<h5 data-id="heading-6"><strong>嵌入模型（Embeddings）</strong></h5>
<p>将文本转换为高维向量的模型，用于语义搜索、相似度计算、文档检索等场景。它是"让 AI 理解语义"的关键技术。</p>
<hr/>
<h4 data-id="heading-7">2.2 提示词工程（Prompts）</h4>
<p>提示词是人类与 AI 沟通的"语言"，LangChain 提供了系统化的提示词管理机制：</p>
<h5 data-id="heading-8"><strong>提示词模板（Prompt Templates）</strong></h5>
<p>预定义的、可复用的提示词格式，支持动态变量插入。就像邮件模板一样，你可以定义结构，然后填充具体内容。</p>
<h5 data-id="heading-9"><strong>示例选择器（Example Selectors）</strong></h5>
<p>根据用户输入，动态选择最相关的示例（Few-shot Learning），让模型更准确地理解任务需求。</p>
<h5 data-id="heading-10"><strong>输出解析器（Output Parsers）</strong></h5>
<p>将 LLM 的文本输出结构化为 JSON、列表等格式，方便程序处理。例如，让模型输出的购物清单自动转换为可操作的数据结构。</p>
<hr/>
<h4 data-id="heading-11">2.3 文档处理（Documents &amp; Text Splitting）</h4>
<p>大多数 AI 应用需要处理外部知识（PDF、网页、数据库），LangChain 提供了完整的文档处理流程：</p>
<h5 data-id="heading-12"><strong>文档加载器（Document Loaders）</strong></h5>
<p>统一接口加载各种格式的数据源：PDF、Word、网页、数据库、API 返回值等。</p>
<h5 data-id="heading-13"><strong>文本分割器（Text Splitters）</strong></h5>
<p>大模型有上下文长度限制（通常几千到几万字），文本分割器将长文档智能切分为小块：</p>
<ul>
<li><strong>字符分割</strong>：按固定字符数切分</li>
<li><strong>递归分割</strong>：保持段落完整性的智能切分</li>
<li><strong>语义分割</strong>：基于语义相似度切分（保证每块内容主题统一）</li>
</ul>
<h5 data-id="heading-14"><strong>文档转换器（Document Transformers）</strong></h5>
<p>对文档进行预处理，如去除无关信息、提取关键内容、翻译等。</p>
<hr/>
<h4 data-id="heading-15">2.4 向量存储与检索（Vector Stores &amp; Retrieval）</h4>
<p>这是构建"知识库问答"应用的核心技术：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[原始文档] --&gt; B[文本分割]
    B --&gt; C[嵌入模型&lt;br/&gt;Embeddings]
    C --&gt; D[向量数据库&lt;br/&gt;Vector Store]
    
    E[用户提问] --&gt; F[问题向量化]
    F --&gt; G[相似度检索]
    D --&gt; G
    G --&gt; H[检索相关文档]
    H --&gt; I[LLM生成答案]
    
    style A fill:#e1f5ff
    style D fill:#fff4e1
    style E fill:#f0e1ff
    style I fill:#e1ffe1
</code></pre>
<h5 data-id="heading-16"><strong>向量化流程</strong></h5>
<ol>
<li>使用嵌入模型将文档切片转换为向量</li>
<li>存储到向量数据库（如 Chroma、Pinecone、Weaviate）</li>
<li>用户提问时，将问题也向量化</li>
<li>在向量数据库中搜索最相似的文档片段</li>
<li>将检索到的内容作为上下文，让 LLM 生成答案</li>
</ol>
<h5 data-id="heading-17"><strong>检索策略</strong></h5>
<ul>
<li><strong>相似度检索</strong>：找出语义最接近的内容</li>
<li><strong>混合检索</strong>：结合关键词匹配与语义搜索</li>
<li><strong>重排序（Re-ranking）</strong>：对初步检索结果进行二次排序，提升准确性</li>
</ul>
<hr/>
<h4 data-id="heading-18">2.5 链（Chains）</h4>
<p>链是 LangChain 的核心抽象，将多个步骤串联成工作流：</p>
<h5 data-id="heading-19"><strong>简单链（LLMChain）</strong></h5>
<p>最基础的链：提示词 → 模型 → 输出解析。适合单一任务。</p>
<h5 data-id="heading-20"><strong>顺序链（SequentialChain）</strong></h5>
<p>多个链按顺序执行，前一个链的输出作为后一个链的输入。例如：文本翻译 → 情感分析 → 摘要生成。</p>
<h5 data-id="heading-21"><strong>路由链（RouterChain）</strong></h5>
<p>根据输入内容，动态选择执行不同的子链。就像智能客服，根据问题类型路由到不同的处理流程。</p>
<h5 data-id="heading-22"><strong>预制链（Pre-built Chains）</strong></h5>
<p>LangChain 提供了常见场景的开箱即用链：</p>
<ul>
<li><strong>问答链（RetrievalQA）</strong>：知识库问答</li>
<li><strong>摘要链（SummarizationChain）</strong>：文档摘要</li>
<li><strong>对话链（ConversationChain）</strong>：多轮对话管理</li>
</ul>
<hr/>
<h4 data-id="heading-23">2.6 记忆（Memory）</h4>
<p>让 LLM "记住"对话历史，实现连贯的多轮交互：</p>
<h5 data-id="heading-24"><strong>对话缓冲记忆（ConversationBufferMemory）</strong></h5>
<p>保存完整对话历史，适合短对话。</p>
<h5 data-id="heading-25"><strong>对话窗口记忆（ConversationWindowMemory）</strong></h5>
<p>只保留最近 N 轮对话，避免超出上下文限制。</p>
<h5 data-id="heading-26"><strong>对话摘要记忆（ConversationSummaryMemory）</strong></h5>
<p>定期将历史对话压缩为摘要，节省 token 消耗。</p>
<h5 data-id="heading-27"><strong>实体记忆（EntityMemory）</strong></h5>
<p>提取并记住对话中的关键实体（人名、地点、事件），适合长期对话。</p>
<hr/>
<h4 data-id="heading-28">2.7 智能代理（Agents）</h4>
<p>代理是 LangChain 最强大的功能，让 LLM 能够<strong>自主规划和执行复杂任务</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant A as Agent&lt;br/&gt;代理
    participant L as LLM&lt;br/&gt;语言模型
    participant T as Tools&lt;br/&gt;工具集
    
    U-&gt;&gt;A: 任务目标
    A-&gt;&gt;L: 分析任务，制定计划
    L-&gt;&gt;A: 决定调用工具X
    A-&gt;&gt;T: 执行工具X
    T-&gt;&gt;A: 返回结果
    A-&gt;&gt;L: 观察结果，决定下一步
    L-&gt;&gt;A: 调用工具Y
    A-&gt;&gt;T: 执行工具Y
    T-&gt;&gt;A: 返回结果
    A-&gt;&gt;L: 任务完成？
    L-&gt;&gt;A: 是，生成最终答案
    A-&gt;&gt;U: 返回结果
</code></pre>
<h5 data-id="heading-29"><strong>工作原理</strong></h5>
<ol>
<li>用户给出任务目标</li>
<li>代理根据目标，自主决定需要调用哪些工具</li>
<li>执行工具，观察结果</li>
<li>根据结果调整下一步行动</li>
<li>循环迭代，直到完成任务</li>
</ol>
<h5 data-id="heading-30"><strong>代理类型</strong></h5>
<ul>
<li><strong>ReAct 代理</strong>：推理（Reasoning）+ 行动（Acting），最经典的代理类型</li>
<li><strong>结构化聊天代理</strong>：适合复杂工具调用，支持多参数工具</li>
<li><strong>计划执行代理</strong>：先制定完整计划，再逐步执行</li>
</ul>
<h5 data-id="heading-31"><strong>工具（Tools）</strong></h5>
<p>代理的"手脚"，可以是：</p>
<ul>
<li><strong>搜索引擎</strong>：Google、Wikipedia</li>
<li><strong>计算器</strong>：数学运算</li>
<li><strong>API 调用</strong>：天气查询、邮件发送</li>
<li><strong>数据库查询</strong>：SQL 执行</li>
<li><strong>自定义工具</strong>：任何 Python 函数</li>
</ul>
<hr/>
<h4 data-id="heading-32">2.8 回调与监控（Callbacks）</h4>
<p>生产环境必备的观测能力：</p>
<h5 data-id="heading-33"><strong>回调机制</strong></h5>
<p>在链/代理执行的各个节点插入钩子函数，记录：</p>
<ul>
<li>每次 LLM 调用的输入/输出</li>
<li>工具调用过程</li>
<li>错误信息</li>
<li>执行耗时与成本</li>
</ul>
<h5 data-id="heading-34"><strong>LangSmith 集成</strong></h5>
<p>LangChain 官方的监控平台，提供：</p>
<ul>
<li>可视化的执行追踪</li>
<li>性能分析与成本统计</li>
<li>结果评估与对比测试</li>
<li>错误调试与日志查询</li>
</ul>
<hr/>
<h3 data-id="heading-35">三、LangChain 的架构设计</h3>
<h4 data-id="heading-36">3.1 核心基础包</h4>
<h5 data-id="heading-37"><strong>langchain-core</strong></h5>
<p>整个生态的"骨架"，定义所有模块的抽象接口和核心基类：</p>
<ul>
<li>抽象类（LLM、ChatModel、Embeddings 等）</li>
<li>提示词模板、输出解析器</li>
<li>链与代理的核心逻辑</li>
<li>运行时配置（Runnable 接口）、日志与回调</li>
</ul>
<p><strong>作用</strong>：确保生态的标准化与可扩展性，所有集成都遵循统一规范。</p>
<h5 data-id="heading-38"><strong>langchain-text-splitters</strong></h5>
<p>专注于文本分割的工具包，提供：</p>
<ul>
<li>通用分割器（RecursiveCharacterTextSplitter）</li>
<li>格式专用分割器（Markdown、代码等）</li>
<li>语义分割器（基于嵌入模型的智能切分）</li>
</ul>
<hr/>
<h4 data-id="heading-39">3.2 核心功能包</h4>
<h5 data-id="heading-40"><strong>langchain-community</strong></h5>
<p>社区贡献包，集成第三方服务与工具：</p>
<ul>
<li>外部模型（OpenAI、Anthropic、Cohere 等）</li>
<li>数据源（PDF、MySQL、MongoDB 等）</li>
<li>向量库（Chroma、Pinecone、Weaviate 等）</li>
<li>工具集成（搜索引擎、API 服务等）</li>
</ul>
<p><strong>作用</strong>：实现 langchain-core 定义的抽象接口，无需重复造轮子。</p>
<h5 data-id="heading-41"><strong>langchain</strong></h5>
<p>聚合包（"元包"），默认包含 langchain-core、langchain-community 及常用功能，方便快速上手。</p>
<p><strong>注意</strong>：新版本（v0.1+）已模块化拆分,实际开发推荐直接依赖细分包。</p>
<hr/>
<h4 data-id="heading-42">3.3 场景化/进阶功能包</h4>
<h5 data-id="heading-43"><strong>langchain-agents</strong></h5>
<p>专注于智能代理实现：</p>
<ul>
<li>代理类型（ReActAgent、StructuredChatAgent）</li>
<li>工具调用策略、多代理协作逻辑</li>
<li>与外部工具的适配</li>
</ul>
<h5 data-id="heading-44"><strong>langchain-chains</strong></h5>
<p>提供预制链，封装常见任务流程：</p>
<ul>
<li>问答链（RetrievalQA）</li>
<li>摘要链（SummarizationChain）</li>
<li>对话链（ConversationChain）</li>
</ul>
<h5 data-id="heading-45"><strong>langchain-vectorstores</strong></h5>
<p>专注于向量数据库集成：</p>
<ul>
<li>主流向量库适配</li>
<li>检索策略（相似性搜索、混合检索）</li>
</ul>
<h5 data-id="heading-46"><strong>langchain-experimental</strong></h5>
<p>包含实验性功能，如多模态链、智能体优化、新模型集成等，适合尝鲜或定制开发。</p>
<hr/>
<h4 data-id="heading-47">3.4 生态配套包</h4>
<h5 data-id="heading-48"><strong>langsmith-sdk</strong></h5>
<p>官方监控与调试工具的 SDK，用于：</p>
<ul>
<li>追踪链/代理的运行</li>
<li>评估性能</li>
<li>调试错误</li>
<li>成本监控</li>
</ul>
<p><strong>作用</strong>：生产环境必备工具。</p>
<h5 data-id="heading-49"><strong>langchain-cli</strong></h5>
<p>命令行工具，辅助：</p>
<ul>
<li>项目初始化</li>
<li>模板生成</li>
<li>LangSmith 配置</li>
</ul>
<hr/>
<h4 data-id="heading-50">3.5 架构关系总结</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[langchain-core&lt;br/&gt;基础接口与抽象类] --&gt; B[langchain-community&lt;br/&gt;第三方集成]
    A --&gt; C[langchain-text-splitters&lt;br/&gt;文本处理]
    
    B --&gt; D[langchain-agents&lt;br/&gt;智能代理]
    B --&gt; E[langchain-chains&lt;br/&gt;预制链]
    B --&gt; F[langchain-vectorstores&lt;br/&gt;向量存储]
    C --&gt; D
    C --&gt; E
    
    D --&gt; G[langchain&lt;br/&gt;聚合元包]
    E --&gt; G
    F --&gt; G
    
    A --&gt; H[langchain-experimental&lt;br/&gt;实验性功能]
    H --&gt; G
    
    G --&gt; I[langsmith-sdk&lt;br/&gt;监控调试]
    G --&gt; J[langchain-cli&lt;br/&gt;开发工具]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#fff4e1
    style D fill:#f0e1ff
    style E fill:#f0e1ff
    style F fill:#f0e1ff
    style G fill:#e1ffe1
    style H fill:#ffe1e1
    style I fill:#ffe1f5
    style J fill:#ffe1f5
</code></pre>
<hr/>
<h3 data-id="heading-51">四、典型应用场景</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[LangChain&lt;br/&gt;应用场景] --&gt; B[知识库问答]
    A --&gt; C[智能客服]
    A --&gt; D[内容生成]
    A --&gt; E[数据分析]
    A --&gt; F[知识管理]
    
    B --&gt; B1[文档加载]
    B1 --&gt; B2[向量化]
    B2 --&gt; B3[检索]
    B3 --&gt; B4[问答链]
    
    C --&gt; C1[对话记忆]
    C1 --&gt; C2[路由链]
    C2 --&gt; C3[工具调用]
    
    D --&gt; D1[提示词模板]
    D1 --&gt; D2[生成]
    D2 --&gt; D3[优化]
    D3 --&gt; D4[翻译]
    
    E --&gt; E1[智能代理]
    E1 --&gt; E2[SQL工具]
    E2 --&gt; E3[Python工具]
    
    F --&gt; F1[多源加载]
    F1 --&gt; F2[向量检索]
    F2 --&gt; F3[实体记忆]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#f0e1ff
    style D fill:#e1ffe1
    style E fill:#ffe1f5
    style F fill:#ffe1e1
</code></pre>
<h4 data-id="heading-52">4.1 知识库问答系统</h4>
<p>用户上传企业文档，系统自动构建知识库，员工可以用自然语言提问，获得准确答案。</p>
<p><strong>核心技术</strong>：文档加载 → 文本分割 → 向量化存储 → 检索 → 问答链</p>
<hr/>
<h4 data-id="heading-53">4.2 智能客服</h4>
<p>根据用户问题，自动分类并路由到不同的处理流程，支持多轮对话，记住用户偏好。</p>
<p><strong>核心技术</strong>：对话记忆 + 路由链 + 工具调用（查询订单、查询物流等）</p>
<hr/>
<h4 data-id="heading-54">4.3 内容生成助手</h4>
<p>根据用户需求，自动生成营销文案、产品描述、报告摘要等，支持多语言翻译。</p>
<p><strong>核心技术</strong>：提示词模板 + 顺序链（生成 → 优化 → 翻译）</p>
<hr/>
<h4 data-id="heading-55">4.4 数据分析代理</h4>
<p>用户用自然语言描述分析需求，代理自动查询数据库、执行数据处理、生成可视化图表。</p>
<p><strong>核心技术</strong>：智能代理 + SQL 工具 + Python 工具</p>
<hr/>
<h4 data-id="heading-56">4.5 个人知识管理</h4>
<p>整合笔记、邮件、浏览记录，构建个人知识图谱，支持智能搜索和知识关联。</p>
<p><strong>核心技术</strong>：多源文档加载 + 向量检索 + 实体记忆</p>
<hr/>
<h3 data-id="heading-57">五、学习路径建议</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title LangChain 学习路径
    section 第一阶段
        理解核心概念 : LLM基本原理
                    : 提示词工程
                    : 向量化与语义搜索
    section 第二阶段
        掌握基础组件 : 模型调用
                    : 文档处理
                    : 向量存储与检索
    section 第三阶段
        构建应用链 : 简单链设计
                  : 预制链使用
                  : 对话记忆管理
    section 第四阶段
        进阶代理开发 : 工具定义与集成
                    : 代理规划逻辑
                    : 多代理协作
    section 第五阶段
        生产化部署 : 性能优化
                  : 监控调试
                  : 安全可靠性
</code></pre>
<h4 data-id="heading-58">第一阶段：理解核心概念</h4>
<ul>
<li>掌握 LLM 的基本原理与能力边界</li>
<li>理解提示词工程的重要性</li>
<li>熟悉向量化与语义搜索的逻辑</li>
</ul>
<h4 data-id="heading-59">第二阶段：掌握基础组件</h4>
<ul>
<li>模型调用与输出解析</li>
<li>文档处理与文本分割</li>
<li>向量存储与检索</li>
</ul>
<h4 data-id="heading-60">第三阶段：构建应用链</h4>
<ul>
<li>简单链的设计与调试</li>
<li>预制链的使用与定制</li>
<li>对话记忆的管理</li>
</ul>
<h4 data-id="heading-61">第四阶段：进阶代理开发</h4>
<ul>
<li>工具定义与集成</li>
<li>代理的规划与执行逻辑</li>
<li>多代理协作</li>
</ul>
<h4 data-id="heading-62">第五阶段：生产化部署</h4>
<ul>
<li>性能优化与成本控制</li>
<li>监控与调试（LangSmith）</li>
<li>安全性与可靠性设计</li>
</ul>
<hr/>
<h3 data-id="heading-63">六、总结</h3>
<p>LangChain 的核心价值在于<strong>标准化、模块化、可组合</strong>。它不是一个单一的工具,而是一套完整的开发方法论：</p>
<ul>
<li><strong>标准化</strong>：统一的接口设计，让不同模型、工具、数据源无缝集成</li>
<li><strong>模块化</strong>：清晰的职责划分，每个组件专注做好一件事</li>
<li><strong>可组合</strong>：像乐高积木一样，灵活组装出千变万化的应用</li>
</ul>
<p>无论是构建简单的问答机器人,还是复杂的多代理协作系统,LangChain 都提供了从理念到工具的全栈支持。掌握它的理论框架,你就掌握了 LLM 应用开发的"标准范式"。</p>
<p><em><strong>demo还在写 下一篇《LangChain 深入浅出入门教程》</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师学AI之第四篇：大模型的参数规模与哪些因素有关？]]></title>    <link>https://juejin.cn/post/7574821757665853481</link>    <guid>https://juejin.cn/post/7574821757665853481</guid>    <pubDate>2025-11-21T07:44:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665853481" data-draft-id="7574821757665837097" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师学AI之第四篇：大模型的参数规模与哪些因素有关？"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:44:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师学AI之第四篇：大模型的参数规模与哪些因素有关？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:44:48.000Z" title="Fri Nov 21 2025 07:44:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>本章我们开始学习大模型算法理论、网络结构及其工作原理，正式开始之前我们先关注几个问题，宏观上理解大模型的概貌。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f84d1c172fc4ae6b17897e791aaca4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=b06YzGWeGiKLu6Cqj4b08KYAZdY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1.大模型到底大在哪里？</h2>
<p><strong>大模型的“大”本质是“规模法则”（Scaling Laws）驱动下的系统性扩张</strong>：当模型、数据、算力同步增大时，模型能力会以可预测的方式提升，甚至涌现出小模型不具备的能力（如推理、泛化、指令遵循）。大模型的“大”并不仅仅指参数数量多，而是多维度的“规模扩展”（Scaling），主要包括：参数规模大、训练数据量规模大、计算量大、上下文长度等。</p>
<p><strong>1）参数规模（Model Size）大：知识容量与记忆能力+泛化能力+涌现能力</strong></p>
<p><strong>DeepSeek爆火之后，经常听到“参数”、8b、14b、32b、70b和671b...，“GPT-3有1750亿参数”“DeepSeek-V3含6710亿参数”，GPT-4、Gemini Ultra、Qwen3-Max万亿规模“参数”...这些天文数字具体是啥意思？</strong></p>
<p><strong>参数就像是模型的“脑细胞”（神经元及神经网络规模）。参数越多，模型的“大脑”容量就越大，能够存储和记忆更多的信息。在训练过程中，模型从海量文本中学习到的语法知识、事实知识、推理模式等，都被编码存储在这些参数中。</strong></p>
<p><strong>参数量越大，它能记住和理解的细节就越多、越复杂。巨大的参数量使得模型在遇到未曾见过的输入时，也能通过组合其学到的海量模式，给出合理、流畅的回应。它不再是简单的“死记硬背”，而是具备了强大的举一反三的能力。涌现能力是大模型最神奇的特性，当模型规模（包括参数量、数据量、计算量）超过某个临界点时，模型会表现出在较小模型中不存在或极不明显的能力。</strong></p>
<p><strong>2）训练数据量大（Data Scale）：训练语料的 token 数量，从几十亿 → 数万亿 tokens（如 GPT-4 训练约 13T tokens）。</strong></p>
<p><strong>3）计算量大（Compute Scale）：训练所需的 FLOPs（总浮点运算次数）从 petaFLOP-days → exaFLOP-days（GPT-4 约 2.15e25 FLOPs）。FLOP/s 是什么？表示计算速度，即每秒能做多少次浮点运算。1 petaFLOP/s = 10的15次幂/秒，1 exaFLOP/s = 10的18次幂/秒</strong></p>
<blockquote>
<p>💡 类比：FLOPs 是“总共要搬多少块砖”，FLOP/s 是“每秒能搬多少块砖”。</p>
</blockquote>
<h4 data-id="heading-1">“FLOP-days” 是什么意思？这是一个<strong>将计算总量与时间结合的单位</strong>，用于衡量<strong>训练所需的总计算量</strong>。定义：</h4>
<blockquote>
<p><strong>1 petaFLOP-day</strong> = 以 <strong>1 petaFLOP/s 的速度</strong>持续计算 <strong>1 天</strong> 所完成的总运算量。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f378c8de6aee4746bd78948e63f62d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=72x6vZqFAtAb7XP8zCd0gxXV4Bo%3D" alt="" loading="lazy"/></p>
<p>4）上下文长度（Context Length）：单次输入能处理的 token 数，从 512 → 32K（Claude）、128K（Grok-2）、1M+（Gemini 1.5）、1M+(Qwen3-Max)。</p>
<h2 data-id="heading-2">2.参数规模与哪些因素有关？</h2>
<p>2.1 什么是大模型参数？</p>
<p><strong>在神经网络中，参数是模型在训练过程中需要从数据中学习的内部变量。您可以把它想象成一个极其复杂的数学函数（模型）中的</strong>* <em>可调节的旋钮或权重</em>*。每一个参数都负责捕捉数据中的某种细微模式，参数（Parameters） 是指模型在训练过程中需要学习的权重（Weights）和偏置（Biases），具体包括：</p>
<p>    1）权重：连接神经元之间的数值（如全连接层、注意力层的矩阵）。</p>
<p>    2）偏置：每个神经元的附加偏移量。</p>
<p>示例：一个简单的全连接层（输入维度=100，输出维度=200）的参数量为：100（输入） × 200（输出） + 200（偏置） = 20,200。</p>
<p>2.2 大模型参数规模与哪些因素有关？</p>
<p>    模型的参数可理解为其<strong>可调节的“神经元”数量，模型参数规模越大</strong>理论上学习和存储信息的能力就越强。大模型的参数规模并非随意设定，任务越复杂（如通用对话、代码生成、科学推理），所需模型容量越大。参数规模由以下因素共同决定：</p>
<p>1）模型架构：模型架构（层数、维度）直接决定了参数量的大小和利用效率。</p>
<ul>
<li>
<p><strong>核心网络结构</strong>：目前主流大模型基于<strong>Transformer架构</strong>。其参数主要来自<strong>注意力机制</strong>（如自注意力中的查询、键、值矩阵）和<strong>前馈神经网络</strong>的权重矩阵。</p>
<p>稠密模型（Dense）：所有参数参与每次计算（如 Llama 3 405B）。</p>
<p>稀疏模型（Sparse / MoE）：仅部分参数激活（如 Mixtral 8x7B、Gemini Ultra）。MoE 可在不显著增加推理成本的前提下“做大”总参数。</p>
</li>
<li>
<p>模型架构复杂度：表示能力与抽象层次，模型结构设计（如 MoE、多模态融合），混合专家（MoE）、视觉-语言对齐、工具调用能力等。为应对参数膨胀带来的计算成本，混合专家模型 (Mixture of Experts)成为重要方向。MoE模型拥有总量巨大的参数（如DeepSeek-V3总参数量6710亿），但通过稀疏激活机制，在处理单个任务时仅调用其中一小部分“专家”（如DeepSeek-V3每次推理仅激活约670亿参数），实现了在保持强大能力的同时控制计算开销。</p>
</li>
<li>
<p>简单来说，你可以把模型想象成一个建筑：层数（深度）和每层的房间数（宽度）直接决定了需要多少“砖块”（参数）。</p>
</li>
</ul>
<p><strong>2）训练数据是燃料</strong>：模型参数需要海量数据来学习和调整。</p>
<ul>
<li><strong>数据规模vs模型参数规模</strong>：参数量的增加需要与之匹配的大规模训练数据，以避免模型“消化不良”（训练不足）。模型参数需与数据量匹配。数据太少 → 过拟合；模型太小 → 欠拟合。另外，数据质量也很重要，高质量、多样化的数据能更有效地驱动参数学习到有用的知识和规律。</li>
<li>训练数据规模：研究表明在固定计算预算下，存在一个最优模型大小与数据量的配比（如 Chinchilla Scaling Law）。Chinchilla 定律建议：理想情况下，数据量应是参数量的 20 倍左右（以 token 计）。例如，Qwen3-Max的训练数据就达到了36万亿token，模型参数规模1万亿多。</li>
</ul>
<p>3）算力成本是门槛：参数规模直接受限于<strong>可用算力、电力、资金</strong>。训练和运行大模型消耗巨大。</p>
<ul>
<li><strong>训练算力</strong>：训练一个671B参数的DeepSeek-R1模型需要消耗约3.2M的GPU小时。训练 1 万亿参数模型需数千张 H100 GPU 运行数月，成本超数亿美元</li>
<li>推理成本：即使在采用MoE等技术优化后，大模型的部署和推理仍需昂贵的硬件支持</li>
</ul>
<p>2.3 如何计算大模型的参数规模？大模型的网络结构及工作原理</p>
<p>既然我们了解到模型参数规模核心依赖模型网络架构，我们以GPT3的网络结构为例，Transformer中参数主要来自嵌入层、Transformer层（包括自注意力和前馈网络）和输出层。模型的“蓝图”决定了需要多少参数来构建它。Transformer层数：模型有多“深”。每一层都包含一系列参数。层数越多，参数自然越多。隐藏层维度：模型有多“宽”。这是模型内部表示向量的尺寸。维度越大，每个层内的参数就越多（因为矩阵更大）。注意力头数和维度：Transformer核心——自注意力机制中，头数越多、每个头的维度越大，对应的参数也就越多。词汇表大小：输入和输出层的维度通常与词汇表大小相关。词汇表越大，嵌入层的参数就越多。</p>
<p>    1）V: vocab_size (词汇表大小)</p>
<p>    2）H: hidden_size (隐藏层维度，即d_model)</p>
<p>    3）L: num_layers (Transformer层数)</p>
<p>    4）A: num_attention_heads (注意力头数)</p>
<p>    5）F: feed_forward_size (前馈网络内部维度，通常为4*H)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e557458a7d404190843399f397e0e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=I5CU0qN3aTRpoXGbS%2Fl%2BWsmCx2Q%3D" alt="" loading="lazy"/>在标准Transformer中，前馈网络内部维度通常为4<em>H，所以F=4</em>H。参数计算：</p>
<p>1）词嵌入层参数：<code>P_embed = V * H</code></p>
<p>2）位置编码参数 (黄色区域)：通常使用固定正弦/余弦编码，无可学习参数。某些变体使用可学习的位置编码，参数数量为 <code>max_seq_len × H（可以忽略）。</code></p>
<p>3）输出层：通常与嵌入层共享权重，如果不共享，则为P_output = H * V</p>
<p>4）单个Transformer层：单个Transformer层的参数大约为12*H^2</p>
<ul>
<li>自注意力部分：Q、K、V、投影矩阵：3 * (H * H) ，输出投影矩阵：H * H，所以自注意力部分总共4*H^2</li>
<li>前馈网络部分：第一个线性层：H * (4H) = 4<em>H^2，第二个线性层：(4H) * H = 4</em>H^2，所以前馈网络部分总共8*H^2</li>
<li>层归一化：每个层归一化有两个可学习参数（缩放和偏移），每个参数大小为H。通常每层有两个层归一化（自注意力后和FFN后），所以是4*H。但是与H^2相比很小，通常忽略。</li>
<li>计算：单个Transformer层的参数大约为12*H^2。</li>
</ul>
<h4 data-id="heading-3">5）L层Transformer总参数P_transformer = L*P_layer，Transformer层数 96。</h4>
<p>6）总参数 = 嵌入层 + 输出层 + L * (12*H^2)               = V×H + L×(12×H²) + H×V               = 2×(V×H) + 12×L×H²</p>
<h3 data-id="heading-4">案例：GPT-3 175B 参数计算实例，参数：V = 50,257，H = 12,288  (GPT-3实际使用)，L = 96。 计算过程：</h3>
<p><code>P_embed = 50,257 × 12,288 ≈ 617M     P_layer = 12 × 12,288² ≈ 12 × 151M ≈ 1.81B     P_transformer = 96 × 1.81B ≈ 174B     P_output = 12,288 × 50,257 ≈ 617M</code></p>
<p><code>P_total = 617M + 174B + 617M ≈ 175B</code></p>
<p><code>2.4 模型训练反向传播过程</code></p>
<p><code>本节补一下上一篇工程师学AI之第五篇：从微积分梯度及链式法则，到神经网络学习优化过程，神经网络训练过程前向传播及反向传播过程如何调整模型权重参数？加深对神经网络工作机制的理解。</code></p>
<p><code>1）前向传播：</code></p>
<p><code>输入x→[w₁]→h₁→[w₂]→h₂→[w₃]→y→与目标target比较→Loss</code></p>
<p><code>h₁=f₁(x, w₁)  #第1层：h₁是x和w₁的函数</code></p>
<p><code>h₂=f₂(h₁, w₂) #第2层：h₂是h₁和w₂的函数h₂=f₂(f₁(x, w₁), w₂)</code></p>
<p><code>y=f₃(h₂, w₃) #第3层：y是h₂和w₃的函数y=f₃(f₂(f₁(x,w₁),w₂), w₃)</code></p>
<p><code>Loss = L(y, target) # 损失：损失函数L是模型输出y和真实标签target的函数Loss=L(f₃(f₂(f₁(x, w₁), w₂), w₃), target)</code></p>
<p><code>2）反向传播：损失函数如何通过链式法则影响到每一层的权重，梯度 ∂L/∂w₁ ← ∂L/∂h₁ ← ∂L/∂h₂ ← ∂L/∂y (误差信号反向传播)</code></p>
<p><code>∂Loss/∂w₃ = ∂L/∂y · ∂y/∂w₃</code></p>
<p><code>∂Loss/∂w₂ = ∂L/∂y · ∂y/∂h₂ · ∂h₂/∂w₂</code></p>
<p><code>∂Loss/∂w₁ = ∂L/∂y · ∂y/∂h₂ · ∂h₂/∂h₁ · ∂h₁/∂w₁</code></p>
<p><code>3）更新权重：根据学习率lr和损失函数更新权重</code></p>
<p><code>w3 = w3 - lr * ∂Loss/∂w₃ #grad_w3</code></p>
<p><code>w2 = w2 - lr * ∂Loss/∂w₂ #grad_w2</code></p>
<p><code>w1 = w1 - lr * ∂Loss/∂w₁ #grad_w1</code></p>
<p><code>4）案例：假设一个简单网络：</code></p>
<p><code>x = 2, w₁ = 0.5, w₂ = 1.2, w₃ = 0.8</code></p>
<p><code>h₁ = w₁·x = 1.0</code></p>
<p><code>h₂ = w₂·h₁ = 1.2</code></p>
<p><code>y = w₃·h₂ = 0.96</code></p>
<p><code>target = 1.0, Loss = (y - target)² = 0.0016</code></p>
<p><code>#反向传播计算：</code></p>
<p><code>∂L/∂y=2(y-target)=-0.08</code></p>
<p><code>∂L/∂w₃=∂L/∂y·h₂=-0.08×1.2=-0.096</code></p>
<p><code>∂L/∂w₂=∂L/∂y·w₃·h₁=-0.08×0.8×1.0=-0.064</code></p>
<p><code>∂L/∂w₁=∂L/∂y·w₃·w₂·x =-0.08×0.8×1.2×2=-0.1536</code></p>
<p><code>#权重更新（学习率 lr=0.1）：根据反向传播计算的偏导数更新权重</code></p>
<p><code>w₃'=0.8-0.1×(-0.096)=0.8096</code></p>
<p><code>w₂'=1.2-0.1×(-0.064)=1.2064</code></p>
<p><code>w₁'=0.5-0.1×(-0.1536)=0.51536</code></p>
<h2 data-id="heading-5">3.大模型参数规模有没有极限？</h2>
<p><strong>关于参数规模是否有极限，目前并没有一个确切的数字天花板，但确实面临着多方面的挑战和新的发展趋势：</strong></p>
<p>1）规模法则的指导与挑战 <strong>：研究发现，模型性能随规模增长遵循一定的</strong>规模法则 (Scaling Laws)，但这种增长关系可能并非一成不变。</p>
<ul>
<li><strong>收益递减</strong>：根据<strong>断裂式规模法则 (Broken Neural Scaling Laws)</strong> ，模型性能随规模增长可能呈现<strong>分段式提升</strong>，在某些阶段会出现收益递减的拐点。<strong>Chinchilla法则的启示</strong>：研究表明，在计算预算固定时，盲目增加参数而非同步增加训练数据，并非最优解。<strong>模型参数与训练数据需要平衡分配</strong>。例如：从 100B → 500B 提升显著，但从 1T → 2T 可能只有边际改进。</li>
</ul>
<p>2）硬件物理极限与成本约束：巨大的算力消耗和资金成本，从现实层面限制了参数规模的无限增长，商业回报能否覆盖成本，是决定“还能不能更大”的关键。</p>
<p>    芯片互联带宽：参数需在 GPU 间频繁通信，带宽瓶颈。</p>
<p>    内存墙（Memory Wall）：单卡显存有限（如 H100 80GB），超大模型需模型并行，通信开销剧增。</p>
<p>    能耗限制：训练 GPT-4 耗电约 <strong>1300 MWh</strong>，相当于数百家庭年用电量 。</p>
<p>    成本呈指数增长：GPT-3（175B）训练成本 ≈ <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>460</mn><mtext>万，</mtext><mi>G</mi><mi>P</mi><mi>T</mi><mo>−</mo><mn>4</mn><mtext>（</mtext><mn>1.5</mn><mi>T</mi><mi>M</mi><mi>o</mi><mi>E</mi><mtext>）</mtext><mo>≈</mo></mrow><annotation encoding="application/x-tex">460 万，GPT-4（1.5T MoE）≈ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">460</span><span class="mord cjk_fallback">万，</span><span class="mord mathnormal" style="margin-right:0.13889em;">GPT</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">4</span><span class="mord cjk_fallback">（</span><span class="mord">1.5</span><span class="mord mathnormal" style="margin-right:0.10903em;">TM</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord cjk_fallback">）</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span></span></span></span></span>7800 万 – $2 亿美元。</p>
<p>3）超越参数膨胀的新路径：探索重点正从单纯堆砌参数，转向更高效的技术路径。</p>
<ul>
<li><strong>架构创新</strong>：如前所述的<strong>MoE架构</strong>，以及<strong>多头潜在注意力 (MLA)</strong>  等新技术，旨在不显著增加计算代价的前提下提升模型能力。</li>
<li><strong>推理时计算</strong>：另一种思路是<strong>增加模型在推理阶段的“思考”量</strong>，例如通过更复杂的思维链 (Chain-of-Thought) 或搜索过程来提升任务表现，这被视为一种“推理时的规模扩展”。</li>
</ul>
<h4 data-id="heading-6"><strong>4） 数据可获性：需要“喂养”模型的知识量，根据Chinchilla定律，模型的参数量需要与训练数据的量级相匹配。参数是“容器”，数据是“粮食”。一个巨大的模型（大容器）需要海量的高质量数据（足够多的粮食）来“填满”，才能充分发挥其潜力。如果用一个万亿参数的模型去训练一个只有十亿token的数据集，它极易过拟合（只记住了训练数据，而没有泛化能力），这是巨大的资源浪费。因此，在确定参数量时，必须考虑：我们能否获得足够多、高质量的数据来有效训练这个模型？数据规模决定了参数规模的有效上限。</strong></h4>
<h4 data-id="heading-7">5）算法与工程优化</h4>
<p>    先进的算法和工程技术可以让我们在<strong>相同的参数量下获得更好的性能</strong>，或者在<strong>相同的性能下使用更少的参数</strong>。更高效的架构：如混合专家模型，它通过动态激活网络中的一部分参数来在总参数量巨大的情况下，大幅减少实际计算量。模型压缩与量化：在部署时，通过技术手段减少每个参数占用的比特数（如从32位浮点数降到8位整数），但这不改变参数的数量，只改变模型的总大小。</p>
<h2 data-id="heading-8">4.如何估算硬件资源？</h2>
<p>根据大模型的参数规模来配置硬件资源是一个系统工程，需要综合考虑训练和推理两个阶段。这里我们主要讨论训练，因为训练对硬件的要求更高。推理阶段可以根据训练阶段的配置进行适当缩减。</p>
<p>4.1训练阶段</p>
<p>训练大模型时，硬件资源配置的核心是能够容纳模型并高效地进行计算。主要考虑以下因素：</p>
<p>1）内存（GPU显存）：内存是首要瓶颈，必须能够存储模型参数、优化器状态、激活值、梯度以及临时缓冲区。训练时的总内存占用包括四个主要部分：</p>
<p>总内存 ≈ 模型参数 + 优化器状态 + 梯度 + 激活值</p>
<p><strong>单精度浮点数：FP32/BF32</strong>：4<code>× 参数量</code> bytes，用于训练场景</p>
<p><strong>半精度浮点数：FP16/BF16</strong>：<code>2 × 参数量</code> bytes，训练和部分推理场景</p>
<p>    INT8量化：<code>1 × 参数量</code> bytes，8位整数量化，推理常用</p>
<p>    INT4量化：<code>0.5 × 参数量</code> bytes，4位整数量化，轻量级推理</p>
<p>2）计算能力（FLOPs）：硬件需要提供足够的计算能力，以便在合理的时间内完成训练。</p>
<p>3）通信带宽：在多卡或多节点训练时，卡间或节点间的通信带宽至关重要。</p>
<h3 data-id="heading-9">通过前面的学习，你已经了解了模型训练的本质，是寻找最合适的参数组合。<strong>没有"最好"的配置，只有"最适合"的配置</strong>。需要根据你的具体需求、预算和时间约束来平衡这些因素。</h3>
<p>    案例：参考阿里云ACP大模型培训资料，以<code>qwen2.5-1.5b-instruct</code> 为例，粗略看下从零训练一个模型的时间和硬件需求。 为了微调大模型，你需要估算显存要求，1.5B参数占用内存（假设按全精度 FP32 ，单参数占用4字节）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61d28cc49cd04d1b845b282e9f74f0d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=cIQ02j1hpw48UBfn0C01k52Tv7o%3D" alt="" loading="lazy"/></p>
<p> 一般对模型进行训练时，大概需要模型参数内存的7~8倍，也就是约<strong>45GB</strong>的显存。</p>
<h3 data-id="heading-10">4.2推理阶段 推理阶段的内存需求相对简单：推理总内存 ≈ 模型参数 + KV缓存，推理阶段可以根据训练阶段的配置，以及预估的并发用户量进行适当缩减。</h3>
<h5 data-id="heading-11">1) 模型参数内存</h5>
<p><strong>FP16/BF16</strong>：<code>2 × 参数量</code> bytes</p>
<p>    INT8量化：<code>1 × 参数量</code> bytes</p>
<p>    INT4量化：<code>0.5 × 参数量</code> bytes</p>
<h5 data-id="heading-12">2) KV缓存内存：对于自回归生成任务，需要缓存Key和Value。</h5>
<pre><code class="hljs language-python" lang="python">KV缓存 ≈ <span class="hljs-number">2</span> × 层数 × 隐藏维度 × 注意力头数 × 序列长度 × 批次大小 × <span class="hljs-number">2</span> <span class="hljs-built_in">bytes</span>
</code></pre>
<p><strong>因此，推理时单卡总内存估算</strong>：总内存 ≈ P × (2-4) + KV缓存。</p>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制]]></title>    <link>https://juejin.cn/post/7574821757665869865</link>    <guid>https://juejin.cn/post/7574821757665869865</guid>    <pubDate>2025-11-21T07:45:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665869865" data-draft-id="7574530224853319686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:45:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:45:24.000Z" title="Fri Nov 21 2025 07:45:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在AI的世界里万物皆向量，向量可以用统一的方式表示一切信息：图片-像素，文字-编码，声音-频率特征向量，文件-向量化。前文介绍了线性代数：标量、向量、矩阵、张量；矩阵乘法、转置、点积运算等基本知识。深度学习的本质就是数学运算，而向量和矩阵是基石。神经网络的前向传播、反向传播、梯度下降，都离不开向量和矩阵运算。</p>
<p>本文重点介绍点积计算如何应用在transformer注意力机制中。你肯定好奇到底点积运算发挥了什么作用，这篇文章篇幅较长，比较烧脑，纰漏之处欢迎指出讨论，本文重点结合理论与代码实践回答下面几个问题。</p>
<p>    1）什么是向量的点积运算？python如何实现点积运算？</p>
<p>    2）点积运算与向量相似度有什么关系？python如何计算相似度？</p>
<p>    3）相似度与transformer里面注意力attention机制又是什么关系？</p>
<p>    4）python实现注意力机制。</p>
<h2 data-id="heading-0">1.什么是点积运算？</h2>
<p>点积是深度学习中最基础、最重要的运算，它是每个神经元进行计算的核心操作。点积（Dot Product）是两个向量之间的一种运算，结果是一个标量。用于衡量两个向量在方向上有多“一致”。两种定义：</p>
<p>1）代数定义: A · B = a1<em>b1 + a2</em>b2 + ... + an*bn，对应位置的分量相乘，然后将所有乘积结果相加。神经网络的"智能"就来自于学会给不同输入分配合适的权重，然后做加权求和。向量点积运算就是这个加权求和过程，让每个输入乘以权重，全部加起来。不同神经元的点积运算重复千万次，就产生了人工智能（大道至简，从简单规则到复杂智能，是不是有点类似蚂蚁群体，单个蚂蚁类似神经元的能力极其有限，但当它们通过简单规则相互连接并大规模组织起来时，就会"涌现"出全新的、更高层次的特性）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">1.</span>数学表达：
<span class="hljs-comment"># 输入向量（比如一张简化的3像素图片）</span>
input_vector =[<span class="hljs-number">1.0</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">2.0</span>]
<span class="hljs-comment"># 权重向量（神经元学到的参数） </span>
weight_vector =[<span class="hljs-number">0.3</span>,<span class="hljs-number">0.7</span>,-<span class="hljs-number">0.1</span>]
<span class="hljs-comment"># 点积计算（这就是神经元在做的事情！）</span>
result=<span class="hljs-number">1.0</span>×<span class="hljs-number">0.3</span>+<span class="hljs-number">0.5</span>×<span class="hljs-number">0.7</span>+<span class="hljs-number">2.0</span>×(-<span class="hljs-number">0.1</span>)=<span class="hljs-number">0.3</span>+<span class="hljs-number">0.35</span>-<span class="hljs-number">0.2</span>=<span class="hljs-number">0.45</span>

<span class="hljs-number">2.</span>程序实现：利用python的numpy模块实现点积运算
<span class="hljs-comment"># 输入向量（比如一张简化的3像素图片）</span>
input_vector = np.array([<span class="hljs-number">1.0</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">2.0</span>])
<span class="hljs-comment"># 权重向量（神经元学到的参数）</span>
weight_vector = np.array([<span class="hljs-number">0.3</span>,<span class="hljs-number">0.7</span>,-<span class="hljs-number">0.1</span>])
<span class="hljs-comment"># 点积计算（这就是神经元在做的事情！）</span>
result = np.dot(input_vector,weight_vector)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点积计算结果："</span>,result)

<span class="hljs-number">3.</span>自己实现Vector向量类及点积运算函数
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, components</span>):
        self.components = components
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dot</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.components)!=<span class="hljs-built_in">len</span>(other.components):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"向量维度必须相同"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(x * y <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.components, other.components))
</code></pre>
<p>2）几何定义: A · B = ||A|| * ||B|| * cos(θ)，点积的结果由两个向量的长度和它们之间的夹角共同决定。   </p>
<p>     ||A|| 是向量 A 的模长（可以理解为向量的长度）。   </p>
<p>     ||B|| 是向量 B 的模长。    </p>
<p>    θ 是向量 A 和向量 B 之间的夹角。</p>
<p>3）模长||A||如何计算？向量的模长（Magnitude），也叫范数（Norm），直观来说就是向量在空间中的“长度”，从原点(0,0,...)指向向量坐标点的距离。对于一个 n维向量 A = [a1, a2, a3, ..., an]，其模长 ||A|| 的计算公式为：</p>
<p>    ||A|| = √(a1² + a2² + a3² + ... + an²)。</p>
<p>文字描述就是：向量模长等于其所有分量的平方和，再开平方根。假设有一个二维向量 A = [3, 4]，它在坐标系中就是从原点 (0,0) 指向点 (3,4) 的箭头。计算分量的平方和:    3² + 4² = 9 + 16 = 25    对结果开平方根:√25 = 5，所以，向量 A 的模长 ||A|| = 5。</p>
<p>4）两种定义是等价的：点积的数学本质A · B = ||A|| * ||B|| * cos(θ)，它同时衡量了向量的长度和方向一致性。</p>
<p>    a1<em>b1 + a2</em>b2 + ... + an*bn = ||A|| * ||B|| * cos(θ)</p>
<p>让我们用一个二维的例子来可视化这个过程，这能极大地帮助理解。</p>
<p>假设有两个向量:A = [3, 4]，B = [1, 0]</p>
<p>第一步：计算点积 A · B    A · B = (3 * 1) + (4 * 0) = 3 + 0 = 3</p>
<p>第二步：计算模长 ||A|| 和 ||B||    ||A|| = sqrt(3² + 4²) = sqrt(9 + 16) = sqrt(25) = 5    ||B|| = sqrt(1² + 0²) = sqrt(1 + 0) = 1</p>
<p>第三步：计算余弦值 cos(θ)    cos(θ) = (A · B) / (||A|| * ||B||) = 3 / (5 * 1) = 3/5 = 0.6</p>
<h2 data-id="heading-1">2.点积vs向量相似度是什么关系？</h2>
<h3 data-id="heading-2">2.1向量相似度计算</h3>
<p>如何衡量向量相似度？本质上，我们是用夹角余弦值 cos(θ) 来衡量“方向上的相似度”，而点积 A · B 是计算 cos(θ) 的一个关键步骤，但它本身并不是一个纯粹的相似度度量。</p>
<p>1）最纯粹的相似度度量是 cos(θ)：它只关心两个向量的方向是否一致，完全忽略了它们的长度（模长）。这使得它成为衡量“本质相似性”的理想指标。cos(θ) 的本质是衡量方向一致性：</p>
<p>    ✧ 当 θ = 0° 时，cos(0°) = 1。这意味着两个向量方向完全相同。此时点积达到最大值（正值）。    </p>
<p>    ✧ 当 θ = 90° 时，cos(90°) = 0。这意味着两个向量互相垂直。此时点积为 0。 </p>
<p>    ✧ 当 θ = 180° 时，cos(180°) = -1。这意味着两个向量方向完全相反。此时点积达到最小值（负值）。    </p>
<p>    所以，cos(θ) 本身就是一个完美的“相似度”度量指标，它衡量了两个向量在方向上的对齐程度。</p>
<p>2）点积 A · B 是 cos(θ) 的“未标准化”版本：点积的结果同时受到向量方向和向量长度的影响。 ||A|| * ||B|| 是缩放因子：它保证了更长的向量会对点积结果产生更大的影响。但如果两个向量的模长是固定的（归一化），那么点积的大小就完全由cos(θ)，即方向的一致性来决定。</p>








































<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td>特征</td><td>点积 (Dot Product)</td><td>余弦相似度 (Cosine Similarity)</td></tr><tr><td>公式</td><td>A · B = Σ(a_i * b_i)</td><td>cos(θ) = (A · B) / (</td></tr><tr><td>取值范围</td><td>(-∞, +∞)</td><td>[-1,   1]</td></tr><tr><td>受向量长度影响</td><td>是</td><td>否</td></tr><tr><td>衡量的是什么</td><td>方向相似性+强度（模长）</td><td>纯方向相似性</td></tr><tr><td>主要用途</td><td>注高效计算相似度</td><td>理论上纯粹的相似度度量</td></tr></tbody></table>
<h3 data-id="heading-3">2.2向量相似度实现</h3>
<p>Transformer通过简单的点积运算(余弦相似度的核心)在大规模应用中"涌现"出强大的语言理解能力，这正是"大道至简"的完美体现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> numpy.linalg <span class="hljs-keyword">import</span> norm
<span class="hljs-comment">#基于numpy模块实现两个向量余弦相似度相似度计算</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity</span>(<span class="hljs-params">vec1, vec2</span>):
<span class="hljs-string">"""
    计算两个向量的余弦相似度
    公式:cos(θ)=(A·B)/(||A||*||B||)
    值域:[-1,1]，值越大表示越相似
1= 完全相同方向,0= 正交,-1= 完全相反方向
Args:
        vec1 (list/np.array): 第一个向量
        vec2 (list/np.array): 第二个向量
Returns:
        float: 余弦相似度值
"""</span>
    <span class="hljs-comment"># 确保输入是numpy数组</span>
    vec1 = np.array(vec1)
    vec2 = np.array(vec2)
    <span class="hljs-comment"># 计算点积</span>
    dot_product = np.dot(vec1, vec2)
    <span class="hljs-comment"># 计算向量的模长(L2范数)</span>
    norm_vec1 =norm(vec1)
    norm_vec2 =norm(vec2)

    <span class="hljs-comment"># 防止除以零</span>
    <span class="hljs-keyword">if</span> norm_vec1 ==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> norm_vec2 ==<span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 计算余弦相似度</span>
    similarity = dot_product /(norm_vec1 * norm_vec2)
    <span class="hljs-keyword">return</span> similarity

<span class="hljs-comment"># 纯Python实现(不依赖numpy)，代数相似度vs几何相似度等价</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity_python</span>(<span class="hljs-params">vec1, vec2</span>):
<span class="hljs-string">"""不使用numpy的余弦相似度实现"""</span>
    <span class="hljs-comment"># 计算点积</span>
    dot_product =<span class="hljs-built_in">sum</span>(a * b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(vec1, vec2))
    <span class="hljs-comment"># 计算模长</span>
    norm1 =<span class="hljs-built_in">sum</span>(a * a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> vec1)**<span class="hljs-number">0.5</span>
    norm2 =<span class="hljs-built_in">sum</span>(b * b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> vec2)**<span class="hljs-number">0.5</span>
    <span class="hljs-comment"># 防止除以零</span>
    <span class="hljs-keyword">if</span> norm1 ==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> norm2 ==<span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">return</span> dot_product /(norm1 * norm2)

<span class="hljs-comment">#测试向量相似度</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_cosine_similarity</span>():
<span class="hljs-string">"""测试余弦相似度函数"""</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"===== 余弦相似度测试 ====="</span>)
    <span class="hljs-comment"># 相同方向的向量</span>
    a =[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
    b =[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>]  <span class="hljs-comment"># a的2倍，完全同向</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{a}</span> 和 <span class="hljs-subst">{b}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(a, b):<span class="hljs-number">.4</span>f}</span> (应接近1.0)"</span>)

    <span class="hljs-comment"># 正交向量</span>
    c =[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
    d =[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{c}</span> 和 <span class="hljs-subst">{d}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(c, d):<span class="hljs-number">.4</span>f}</span> (应为0.0)"</span>)

    <span class="hljs-comment"># 相反方向</span>
    e =[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
    f =[-<span class="hljs-number">1</span>,-<span class="hljs-number">2</span>,-<span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{e}</span> 和 <span class="hljs-subst">{f}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(e, f):<span class="hljs-number">.4</span>f}</span> (应接近-1.0)"</span>)

    <span class="hljs-comment"># 实际应用示例 - 文本向量</span>
    <span class="hljs-comment"># 假设是词嵌入向量</span>
    apple =[<span class="hljs-number">0.8</span>,<span class="hljs-number">0.6</span>,<span class="hljs-number">0.1</span>,-<span class="hljs-number">0.2</span>]
    fruit =[<span class="hljs-number">0.7</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.2</span>,-<span class="hljs-number">0.1</span>]
    car =[-<span class="hljs-number">0.1</span>,-<span class="hljs-number">0.3</span>,<span class="hljs-number">0.9</span>,<span class="hljs-number">0.8</span>]

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n实际应用示例 (词向量):"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"apple 和 fruit 的相似度: <span class="hljs-subst">{cosine_similarity(apple, fruit):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"apple 和 car 的相似度: <span class="hljs-subst">{cosine_similarity(apple, car):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=======================\n"</span>)
<span class="hljs-comment"># 执行测试</span>
test_cosine_similarity(


</code></pre>
<h2 data-id="heading-4">3.向量相似度vs注意力机制什么关系？</h2>
<h3 data-id="heading-5">3.1Transformer的自注意力机制</h3>
<p>维基百科里面，注意力机制（英语：attention）是人工神经网络中一种模仿人类认知注意力的技术。这种机制可以增强神经网络输入数据中某些部分的权重，同时减弱其他部分的权重，以此将网络的关注点聚焦于数据中最重要的一小部分。数据中哪些部分比其他部分更重要取决于上下文。可以通过梯度下降法对注意力机制进行训练。允许模型在处理数据时动态分配权重，重点关注输入中的重要部分。让AI模型具备像人类一样“抓重点”的能力，这样AI在处理信息时也会自动分配“注意力权重”，强化关键特征，弱化次要信息。</p>
<h4 data-id="heading-6">3.1.1transformer里面的self-attentionlayer</h4>
<p>下面截图来自李宏毅老师的视频课程，这个结构相信大家看了无数遍。今天我们主要聚集这幅图里面的self-attentionlayer模块。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123d259a63ba4e46a86611d56767b94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=koOuUyjgG89G99WELUx5mPLEwXs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.1.2Self-attention矩阵运算过程</h4>
<p>自注意力机制允许模型在处理序列数据时，关注输入序列中的不同部分。其核心是使用点积计算查询（Query）、键（Key）和值（Value）之间的相关性。自注意力机制公式：Attention(Q, K, V) = softmax(QKᵀ/√dₖ)V，点积用于计算查询(Query)和键(Key)之间的相似度。其中：Q: 查询矩阵，K: 键矩阵，V: 值矩阵，dₖ: 键向量的维度（用于缩放），整体步骤如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e065ac2e5b422782494f16f0b414e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=uMxFO5fwt1mOyT5w5XnE0piwLc0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.1.3运算步骤拆解</h4>
<p>1）根据输入x与权重矩阵Wq，Wk，Wv计算Q、K、V矩阵。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/233aa9faff84499fb4caecaa78bfd1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=oQ2FrQkYLjjixdzOT5nnOLe4ztg%3D" alt="" loading="lazy"/></p>
<p>词向量xi+位置编码ei=ai——&gt;WqWkWv*ai</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd931a043f34e7ab4f38d5583fbba7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=IEGUWBpqNMQvUa44LQC1oOEVAZY%3D" alt="" loading="lazy"/></p>
<p>2）每个q与每个k做点积运算：Q*K做 dot product并行运算</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0adbcb25a3d74b39b21ffd1a9b0d89ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=my01A93fFLlVgy39Dy906mDAdq4%3D" alt="" loading="lazy"/></p>
<p>3）Softmax运算-归一化：矩阵运算结果进行softmax运算，将点积运算得到的原始分数转换为有意义的概率分布，是连接神经网络计算与概率解释的桥梁（这里不做展开，后面概率论单独文章再去理解）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbec50550c514121bdda037278b539df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=zMcycUZAPyd2bD03QTfqbHKASMk%3D" alt="" loading="lazy"/></p>
<p>4）计算输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/134dd76422d645bf954f96fb80e0e4fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=QsGNpgAaYD%2BDC4irVOTEWCTVSkk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/297a4dda48d149c196d9ddee9a0b538f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=j79eRDJrdHKwsMRmL750LYBfP6U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92be47f425c4bcca9e0d083892bc157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=9ib5bNlY1av0UQu6k4Qb%2FXot0a0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.1.4多头自注意力机制：Q、K、V不同维度分解</h4>
<p>多维度理解就像用多个不同角度的摄像头同时拍摄一个场景：</p>
<p>1）第一个头：专注语法关系（主谓宾结构）</p>
<p>2）第二个头：专注语义关系（词汇含义）</p>
<p>3）第三个头：专注长距离依赖（句子间逻辑）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82323d7b9f29474c8b2dfc15f516b170~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=0k%2Fjg1d%2BM%2FzUWsopg%2FNMxKCNrvI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.2点积相似度计算vs注意力关系</h3>
<p>点积在注意力中的角色：利用其衡量方向一致性的特性，来计算查询（Query） 和键（Key） 之间的相似度。方向越一致，代表Key越能回答Query的“提问”，其对应的Value就越重要。    </p>
<p>1）在概念上，我们是用 cos(θ) 来衡量向量的相似度。余弦的优势：余弦值通过除以模长，消除了向量长度的影响。cos(A, B) = 1 精确地表示它们方向完全相同。cos(A, C) = -1 表示它们方向完全相反。cos(θ) 给出了一个归一（Normalized）的结果，它的值永远在 [-1, 1] 之间，这使得不同向量之间的相似度可以公平地进行比较。     </p>
<p>2）在实际操作中（尤其是在注意力机制里），我们常用点积 (Q · K) 作为其高效且有效的近似计算方式（例如，在Transformer中，Query和Key向量通常会被归一化到相同的尺度）。</p>
<h3 data-id="heading-11">3.3点积运算如何在transformer注意力机制中发挥作用？</h3>
<p>Transformer原论文中将核心部分称为Scaled Dot-Product Attention，缩放点积注意力，最核心的公式为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a29a63ac5f4131b66febec7670ad66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=NbYb1rpRtHvZpfj4%2FcV2yogzgyg%3D" alt="" loading="lazy"/></p>
<p>1）核心思想：对于当前要处理的元素Query（例如一个词），决定应该“关注”序列中其他元素Key的多少程度。这个“关注程度”就是一个权重，最终效果：通过点积，注意力机制能够动态地、有针对性地从输入序列中提取最相关的信息，这是Transformer和大型语言模型取得成功的关键突破之一。</p>
<p>2）Query, Key, Value 类比：</p>
<p>Query (查询向量)：代表当前元素发出的“提问”：“我正在处理，我需要哪些信息？”比喻：就像你在搜索引擎里输入的关键词。</p>
<p>Key (键向量)：代表序列中每个元素所拥有的“标签”或“标识”。它用来回应    Query的提问。比喻： 就像互联网上每个网页的关键词标签（索引）。</p>
<p>Value (值向量)：代表序列中每个元素实际包含的“信息”或“内容”。比喻： 就像网页本身的完整内容。</p>
<p>3）注意力的工作流程：将当前的 Query 与序列中所有元素的 Key 进行比较。点积就是执行这个比较操作的完美工具！相似度分数 = Query · Key加权：将这些相似度分数通过Softmax函数转换为权重（所有权重之和为1的正数概率分布）。分数越高，权重越大。求和：用这些权重对所有的 Value 进行加权求和，得到最终的注意力输出。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b6e924d393044dba14fb64a7bdec963~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=GHHEcv3RE%2F0hgzvYO805Bs%2BCnT8%3D" alt="" loading="lazy"/></p>
<p>4）为什么点积是计算相似度的完美工具？现在我们结合几何意义来理解：</p>
<p>➢ Query · Key 的值越大 -&gt; 根据点积公式，这意味着 cos(θ) 接近 1 -&gt; 两个向量的方向非常接近 -&gt; 这个Key所对应的元素所拥有的“标签”（Key）与当前的“提问”（Query）高度相关 -&gt; 因此，这个元素应该获得高注意力权重。</p>
<p>➢ Query · Key 的值接近 0 -&gt; cos(θ) 接近 0 -&gt; 两个向量近乎垂直 -&gt; Key 和 Query 不相关 -&gt; 权重应接近 0。</p>
<p>➢ Query · Key 的值为负 -&gt; cos(θ) 为负 -&gt; 两个向量方向相反 -&gt; 可能意味着某种排斥或对立关系 -&gt; 权重会非常小（因为Softmax会将负值压得很低）。</p>
<p>5）既然 cos(θ) 更好，为什么Transformer的论文《Attention Is All You Need》中用的是点积公式 Q · K，而不是直接写 cos(θ) 呢？理解点积受长度影响这一缺陷，是理解为何需要LayerNorm、缩放因子等技巧的关键。架构设计（如LayerNorm）和缩放操作 (/ √d_k) 确保了 (Q · K) 能够有效地充当相似度的度量指标。</p>
<p>➢ 计算效率：点积 Q · K 只需要一次矩阵乘法，计算速度极快。如果先分别计算每个Q和K的模长再做除法，计算成本更高。使用 (Q · K) 是出于计算效率和实现便利的考虑。隐含的假设：在标准的Transformer架构中，Query和Key向量通常已经进行了某种形式的归一化（例如，通过其初始化方式和层归一化LayerNorm），它们的模长被控制在一个较小的范围内波动。因此，点积 Q · K 的结果虽然不完全等价，但已经高度近似于余弦相似度 cos(θ) 所表达的方向相似性。其内在的物理意义，仍然是衡量Query和Key向量方向的相似性（即 cos(θ)）。</p>
<p>➢ 可学习的缩放因子：论文中并没有直接使用点积，而是使用了缩放点积注意力（Scaled Dot-Product Attention）：注意力分数 =(Q · K) / √d_k)这里除以 √d_k（Key向量的维度）的主要原因之一是：防止点积结果过大，导致Softmax函数的梯度消失问题（因为Softmax会将非常大的输入值推向饱和区）。这个缩放操作进一步稳定了训练。</p>
<h2 data-id="heading-12">4.点积运算vs自注意力python实现</h2>
<p>在Transformer模型中，自注意力机制(Self-Attention)的核心就是使用点积来计算查询(Query)和键(Key)之间的相似度。具体步骤如下：</p>
<p>1）准备输入：初始化参数，将输入向量转换为Query、Key和Value矩阵 </p>
<p>2）计算注意力分数：通过Query和Key的点积计算注意力分数attentionscore</p>
<p>3）缩放：将点积结果除以Key向量维度的平方根(√dₖ)</p>
<p>4）Softmax：对缩放后的分数应用Softmax函数获得注意力权重</p>
<p>5）加权求和：用注意力权重对Value进行加权求和</p>
<p>6）输出结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d28fd28ac04534b88fe62d44e587e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=pR2hkB89ANCkNHEihzKnXUUVX0g%3D" alt="" loading="lazy"/></p>
<p>感兴趣的朋友，可以阅读并运行下面代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f2aca6087c42058e489c76678381af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=gK9CShOs2vYFVS%2FL58gk5Wiw02o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e96ec52e76844d5b957c63cf3c8e621a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=jbE%2FrcZnAlG08hHzVprFtzRcCNI%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> sqrt

<span class="hljs-comment">#点积计算注意力</span>
defscaled_dot_product_attention(Q, K, V, print_steps=<span class="hljs-literal">False</span>):
<span class="hljs-string">"""
    实现缩放点积注意力机制
    参数:
    Q -- 查询矩阵 (batch_size, num_heads, seq_len, d_k)
    K -- 键矩阵 (batch_size, num_heads, seq_len, d_k)
    V -- 值矩阵 (batch_size, num_heads, seq_len, d_k)
    print_steps -- 是否打印中间步骤
    返回:
    输出张量和注意力权重
    """</span>
<span class="hljs-comment"># 1. 计算注意力分数: Q·K^T</span>
<span class="hljs-comment"># 形状: (batch_size, num_heads, seq_len, seq_len)</span>
    matmul_qk = np.matmul(Q, K.transpose(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>))

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤1: 计算Q·K^T"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Q·K^T 形状:"</span>, matmul_qk.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, matmul_qk[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 2. 缩放注意力分数 (除以sqrt(d_k))</span>
    d_k = Q.shape[-<span class="hljs-number">1</span>]
    scaled_attention_logits = matmul_qk / sqrt(d_k)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤2: 缩放注意力分数 (除以√d_k)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"d_k ="</span>, d_k)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"缩放后形状:"</span>, scaled_attention_logits.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, scaled_attention_logits[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 3. 应用softmax获取注意力权重</span>
<span class="hljs-comment"># 注意: softmax应用于最后一个维度(seq_len)</span>
    attention_weights = np.exp(scaled_attention_logits - np.<span class="hljs-built_in">max</span>(scaled_attention_logits, axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>))
    attention_weights /= np.<span class="hljs-built_in">sum</span>(attention_weights, axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤3: 应用softmax获取注意力权重"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意力权重形状:"</span>, attention_weights.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, attention_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"检查行和(应接近1):"</span>, np.<span class="hljs-built_in">sum</span>(attention_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:]))

<span class="hljs-comment"># 4. 将注意力权重与值矩阵相乘</span>
    output = np.matmul(attention_weights, V)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤4: 注意力权重·V"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, output[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])<span class="hljs-comment"># 只显示前5个特征</span>

<span class="hljs-keyword">return</span> output, attention_weights

<span class="hljs-comment">#多头注意力机制</span>
classMultiHeadAttention:
<span class="hljs-string">"""
    Multi-Head Attention层实现 [[5]]
    这个实现将输入分割为多个注意力头，分别计算注意力，然后合并结果。
    """</span>
def__init__(self, d_model, num_heads):
<span class="hljs-string">"""
        初始化Multi-Head Attention层
        参数:
        d_model -- 模型维度(输入和输出的维度)
        num_heads -- 注意力头的数量
        """</span>
        self.d_model = d_model
        self.num_heads = num_heads

<span class="hljs-comment"># 确保d_model可以被num_heads整除</span>
<span class="hljs-keyword">assert</span> d_model % num_heads ==<span class="hljs-number">0</span>,<span class="hljs-string">"d_model must be divisible by num_heads"</span>

        self.d_k = d_model // num_heads  <span class="hljs-comment"># 每个注意力头的维度</span>

<span class="hljs-comment"># 初始化权重矩阵 (使用Xavier初始化)</span>
        self.W_q= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_k= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_v= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_o= np.random.randn(d_model, d_model)/ sqrt(d_model)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"MultiHeadAttention初始化完成:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- d_model: <span class="hljs-subst">{d_model}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- num_heads: <span class="hljs-subst">{num_heads}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- d_k per head: <span class="hljs-subst">{self.d_k}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- 权重矩阵形状: W_q=<span class="hljs-subst">{self.W_q.shape}</span>, W_k=<span class="hljs-subst">{self.W_k.shape}</span>, W_v=<span class="hljs-subst">{self.W_v.shape}</span>, W_o=<span class="hljs-subst">{self.W_o.shape}</span>"</span>)

defsplit_heads(self, x, batch_size):
<span class="hljs-string">"""
        将最后一个维度分割为(num_heads, d_k)

        参数:
        x -- 输入张量 (batch_size, seq_len, d_model)
        batch_size -- 批次大小
        返回:
        重排后的张量 (batch_size, num_heads, seq_len, d_k)
        """</span>
        x = x.reshape(batch_size,-<span class="hljs-number">1</span>, self.num_heads, self.d_k)
<span class="hljs-comment"># 交换维度以获得 (batch_size, num_heads, seq_len, d_k)</span>
<span class="hljs-keyword">return</span> np.transpose(x,(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>))

defcombine_heads(self, x, batch_size):
<span class="hljs-string">"""
        将多个注意力头的结果合并
        参数:
        x -- 分割后的张量 (batch_size, num_heads, seq_len, d_k)

        返回:
        合并后的张量 (batch_size, seq_len, d_model)
        """</span>
<span class="hljs-comment"># 交换维度以获得 (batch_size, seq_len, num_heads, d_k)</span>
        x = np.transpose(x,(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>))
<span class="hljs-comment"># 合并最后两个维度</span>
<span class="hljs-keyword">return</span> x.reshape(batch_size,-<span class="hljs-number">1</span>, self.d_model)

defforward(self, x, print_steps=<span class="hljs-literal">False</span>):
<span class="hljs-string">"""
        前向传播
        参数:
        x -- 输入张量 (batch_size, seq_len, d_model)
        print_steps -- 是否打印中间步骤
        返回:
        输出张量和所有注意力头的注意力权重
        """</span>
        batch_size = x.shape[<span class="hljs-number">0</span>]
        seq_len = x.shape[<span class="hljs-number">1</span>]

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n===== Multi-Head Attention 前向传播 ====="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入形状:"</span>, x.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输入(第一个样本):\n"</span>, x[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])<span class="hljs-comment"># 只显示前5个特征</span>

<span class="hljs-comment"># 1. 线性投影得到Q, K, V</span>
        Q= np.matmul(x, self.W_q)
        K= np.matmul(x, self.W_k)
        V= np.matmul(x, self.W_v)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤1: 线性投影得到Q, K, V"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Q形状:"</span>, Q.shape,<span class="hljs-string">"K形状:"</span>, K.shape,<span class="hljs-string">"V形状:"</span>, V.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例Q值(第一个样本):\n"</span>, Q[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])

<span class="hljs-comment"># 2. 分割为多个注意力头</span>
        Q= self.split_heads(Q, batch_size)
        K= self.split_heads(K, batch_size)
        V= self.split_heads(V, batch_size)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤2: 分割为多个注意力头"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"分割后Q形状:"</span>, Q.shape,<span class="hljs-string">"K形状:"</span>, K.shape,<span class="hljs-string">"V形状:"</span>, V.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例Q值(第一个样本,第一个头):\n"</span>, Q[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])
<span class="hljs-comment"># 3. 计算缩放点积注意力</span>
        attn_output, attn_weights = scaled_dot_product_attention(
            Q, K, V, print_steps=print_steps
)

<span class="hljs-comment"># 4. 合并所有注意力头</span>
        attn_output=self.combine_heads(attn_output, batch_size)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤4: 合并所有注意力头"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"合并后输出形状:"</span>, attn_output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输出(第一个样本):\n"</span>, attn_output[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])
<span class="hljs-comment"># 5. 应用最终的线性变换</span>
        output = np.matmul(attn_output, self.W_o)
<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤5: 应用最终线性变换 (W_o)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最终输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输出(第一个样本):\n"</span>, output[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])

<span class="hljs-keyword">return</span> output, attn_weights

<span class="hljs-comment"># 测试实现</span>
<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
<span class="hljs-comment"># 设置随机种子以确保结果可重现</span>
    np.random.seed(<span class="hljs-number">42</span>)
<span class="hljs-comment"># 创建示例输入 (batch_size=2, seq_len=3, d_model=8)</span>
    batch_size =<span class="hljs-number">2</span>
    seq_len =<span class="hljs-number">3</span>
    d_model =<span class="hljs-number">8</span>
    num_heads =<span class="hljs-number">2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"===== 创建测试环境 ====="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"批次大小: <span class="hljs-subst">{batch_size}</span>, 序列长度: <span class="hljs-subst">{seq_len}</span>, 模型维度: <span class="hljs-subst">{d_model}</span>, 注意力头数: <span class="hljs-subst">{num_heads}</span>"</span>)

<span class="hljs-comment"># 随机生成输入数据 (模拟词嵌入)</span>
    x = np.random.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># 创建Multi-Head Attention层</span>
    mha = MultiHeadAttention(d_model, num_heads)

<span class="hljs-comment"># 执行前向传播并打印所有中间步骤</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>+<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始执行前向传播，打印所有中间步骤..."</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    output, attn_weights = mha.forward(x, print_steps=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 打印最终结果摘要</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>+<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Multi-Head Attention 计算完成"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入形状:"</span>, x.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意力权重形状 (用于可视化):"</span>, attn_weights.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n注意力权重示例(第一个样本,第一个头):"</span>)
<span class="hljs-built_in">print</span>(attn_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 可视化第一个样本的第一个注意力头</span>
    plt.figure(figsize=(<span class="hljs-number">8</span>,<span class="hljs-number">6</span>))
    plt.imshow(attn_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], cmap=<span class="hljs-string">'hot'</span>, interpolation=<span class="hljs-string">'nearest'</span>)
    plt.colorbar()
    plt.title(<span class="hljs-string">'Attention Weights (Sample 0, Head 0)'</span>)
    plt.xlabel(<span class="hljs-string">'Key Positions'</span>)
    plt.ylabel(<span class="hljs-string">'Query Positions'</span>)
<span class="hljs-keyword">for</span> i inrange(seq_len):
<span class="hljs-keyword">for</span> j inrange(seq_len):
            plt.text(j, i,<span class="hljs-string">f'<span class="hljs-subst">{attn_weights[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, i, j]:<span class="hljs-number">.2</span>f}</span>'</span>,
                     ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, color=<span class="hljs-string">'w'</span>)
    plt.savefig(<span class="hljs-string">'attention_weights.png'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n已保存注意力权重可视化到 'attention_weights.png'"</span>)
</code></pre>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6.Kotlin 流程控制：循环控制：while 与 do/while]]></title>    <link>https://juejin.cn/post/7574727105705705512</link>    <guid>https://juejin.cn/post/7574727105705705512</guid>    <pubDate>2025-11-21T07:41:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705705512" data-draft-id="7574978847150800936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6.Kotlin 流程控制：循环控制：while 与 do/while"/> <meta itemprop="keywords" content="Android,Kotlin,后端"/> <meta itemprop="datePublished" content="2025-11-21T07:41:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6.Kotlin 流程控制：循环控制：while 与 do/while
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:41:04.000Z" title="Fri Nov 21 2025 07:41:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 循环的核心作用（重复执行逻辑、处理不确定次数场景）</h3>
<p>循环作为编程三大流程控制结构（顺序、选择、循环）之一，是实现“重复执行”逻辑的核心工具。其价值主要体现在两个关键场景：一是<strong>固定逻辑的重复执行</strong>，比如批量生成100条测试数据、循环打印1到10的数字，这类场景可通过明确的次数控制循环；二是<strong>不确定次数的条件驱动执行</strong>，比如持续接收用户输入直到输入“退出”、反复重试网络请求直到成功或达到最大次数，这类场景无法提前确定循环次数，只能通过“条件是否满足”来控制循环的启停。</p>
<p>在Kotlin中，除了面向集合遍历的for循环，while和do/while循环更擅长处理“不确定次数”的场景。它们无需依赖固定的遍历对象（如区间、数组），仅通过条件表达式即可灵活控制循环，是处理动态场景的重要工具。</p>
<h3 data-id="heading-2">1.2 while/do-while 的核心特点（基础灵活、按需执行）</h3>
<p>while和do/while循环作为Kotlin中最基础的循环结构，具备两大核心特点：一是<strong>极致灵活</strong>，它们不依赖特定的数据结构，仅通过一个布尔类型的条件表达式控制循环，可适配任意需要“条件驱动”的场景，小到简单的数字累加，大到复杂的业务逻辑重试，都能轻松应对；二是<strong>按需执行</strong>，循环体的执行完全由条件表达式的结果决定，满足条件则执行，不满足则终止，尤其适合“不确定执行次数”的场景，避免了不必要的资源消耗。</p>
<p>与for循环相比，while和do/while更偏向“逻辑驱动”而非“数据遍历”。例如，要实现“持续接收用户输入直到输入正确”的逻辑，用do/while循环只需判断输入是否正确即可，无需关注遍历的集合或范围，逻辑更直接。</p>
<h3 data-id="heading-3">1.3 本文核心内容预告（基础用法→差异对比→实用场景）</h3>
<p>本文将围绕Kotlin中的while和do/while循环展开，采用“由浅入深、对比分析、场景落地”的思路逐步讲解。首先分别介绍while循环的基本语法、执行流程和简单示例，掌握“先判断后执行”的核心逻辑；接着详解do/while循环的语法、流程和示例，理解“先执行后判断”的特点；然后重点对比两者的核心差异，明确不同场景下的选择依据；之后补充break和continue两个循环控制关键字的用法，实现对循环节奏的精准控制；再通过多个实用场景案例，展示两种循环在实际开发中的应用；最后总结核心知识点、避坑技巧和选择建议，帮助读者真正做到“灵活选用、正确使用”。</p>
<h2 data-id="heading-4">二、while 循环：先判断，再执行</h2>
<h3 data-id="heading-5">2.1 基本语法格式（条件表达式 + 循环体）</h3>
<p>while循环是“先判断条件，再执行循环体”的基础循环结构，其核心是一个布尔类型的条件表达式和一段需要重复执行的循环体。语法格式简洁明了：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// while 循环基本语法</span>
<span class="hljs-keyword">while</span> (条件表达式) {
    <span class="hljs-comment">// 循环体：条件满足时执行的代码块</span>
    执行逻辑
}

</code></pre>
<p>语法说明：1. <strong>条件表达式</strong>：必须返回Boolean类型结果（true或false），这是控制循环启停的核心，比如“count &lt; 10”“input != "exit"”等；2. <strong>循环体</strong>：用花括号包裹的代码块，条件表达式为true时会执行其中的逻辑；若循环体仅包含一条语句，花括号可省略（但建议始终保留，提升可读性）；3. <strong>循环终止条件</strong>：循环体内部必须包含能改变条件表达式结果的逻辑（如变量自增、修改输入值），否则会导致无限循环。</p>
<h3 data-id="heading-6">2.2 执行流程（先校验条件，满足则执行循环体）</h3>
<p>while循环的执行流程遵循“判断→执行→再判断”的逻辑，具体步骤如下：</p>
<ol>
<li><strong>条件校验</strong>：首先执行条件表达式，判断其结果为true还是false；</li>
<li><strong>执行循环体</strong>：若条件表达式结果为true，执行循环体中的逻辑；若为false，直接终止循环，跳转到循环之后的代码；</li>
<li><strong>循环往复</strong>：循环体执行完毕后，再次回到步骤1，重新校验条件表达式，直到条件为false时终止。</li>
</ol>
<p>可以用一个简单的流程图描述这一过程：<strong>开始 → 校验条件 → 条件为true？→ 是→执行循环体→回到校验条件 → 否→终止循环</strong>。从流程可见，while循环的核心特点是“条件不满足则一次都不执行”，这是它与do/while循环的关键区别。</p>
<h3 data-id="heading-7">2.3 简单示例（如循环打印数字、累计求和）</h3>
<p>下面通过两个常见的简单示例，展示while循环的实际使用：</p>
<h4 data-id="heading-8">2.3.1 示例1：循环打印1到5的数字</h4>
<p>需求：打印1、2、3、4、5，通过变量自增控制循环次数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">1</span> <span class="hljs-comment">// 初始化计数器变量</span>
    <span class="hljs-comment">// 条件：count小于等于5时执行循环</span>
    <span class="hljs-keyword">while</span> (count &lt;= <span class="hljs-number">5</span>) {
        println(<span class="hljs-string">"当前数字：<span class="hljs-variable">$count</span>"</span>)
        count++ <span class="hljs-comment">// 计数器自增，改变条件表达式结果</span>
    }
    println(<span class="hljs-string">"循环结束"</span>)
}

</code></pre>
<p>执行过程解析：</p>
<ul>
<li>初始count=1，校验条件1≤5→true，打印“当前数字：1”，count变为2；</li>
<li>校验count=2≤5→true，打印“当前数字：2”，count变为3；</li>
<li>依次执行，直到count=6时，校验6≤5→false，循环终止，打印“循环结束”。</li>
</ul>
<p>输出结果：</p>
<pre><code class="hljs">当前数字：1
当前数字：2
当前数字：3
当前数字：4
当前数字：5
循环结束

</code></pre>
<h4 data-id="heading-9">2.3.2 示例2：累计求和1到100</h4>
<p>需求：计算1+2+3+...+100的总和，通过while循环实现累加。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span> <span class="hljs-comment">// 初始化累加变量</span>
    <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span> <span class="hljs-comment">// 初始化总和变量</span>
    <span class="hljs-comment">// 条件：num小于等于100时执行循环</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">100</span>) {
        sum += num <span class="hljs-comment">// 累加：sum = sum + num</span>
        num++ <span class="hljs-comment">// 累加变量自增</span>
    }
    println(<span class="hljs-string">"1到100的总和：<span class="hljs-variable">$sum</span>"</span>)
}

</code></pre>
<p>执行逻辑：num从1开始，每次循环将num的值累加到sum中，然后num自增，直到num=101时条件不满足，循环终止。最终sum的值为1到100的总和5050。</p>
<p>输出结果：<code>1到100的总和：5050</code></p>
<h2 data-id="heading-10">三、do/while 循环：先执行，再判断</h2>
<h3 data-id="heading-11">3.1 基本语法格式（循环体 + 条件表达式）</h3>
<p>do/while循环是“先执行循环体，再判断条件”的循环结构，其核心是确保“循环体至少执行一次”，语法格式与while循环类似，但条件表达式的位置不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// do/while 循环基本语法</span>
<span class="hljs-keyword">do</span> {
    <span class="hljs-comment">// 循环体：至少执行一次的代码块</span>
    执行逻辑
} <span class="hljs-keyword">while</span> (条件表达式)

</code></pre>
<p>语法说明：1. <strong>循环体优先执行</strong>：关键字do后面紧跟循环体，程序会先执行一次循环体，再去判断条件表达式；2. <strong>条件表达式</strong>：与while循环一致，必须返回Boolean类型结果，用于控制后续是否继续循环；3. <strong>循环终止条件</strong>：循环体内部同样需要包含改变条件表达式结果的逻辑，避免无限循环；4. <strong>分号注意</strong>：条件表达式末尾需要加英文分号（;），这是Kotlin语法的要求，不可遗漏。</p>
<h3 data-id="heading-12">3.2 执行流程（先执行一次循环体，再校验条件）</h3>
<p>do/while循环的执行流程遵循“执行→判断→再执行”的逻辑，具体步骤如下：</p>
<ol>
<li><strong>执行循环体</strong>：首先执行do后面花括号中的循环体逻辑，无论条件表达式结果如何，循环体都会先执行一次；</li>
<li><strong>条件校验</strong>：循环体执行完毕后，执行条件表达式，判断其结果为true还是false；</li>
<li><strong>循环往复</strong>：若条件表达式结果为true，回到步骤1，再次执行循环体；若为false，终止循环，跳转到循环之后的代码。</li>
</ol>
<p>流程描述：<strong>开始 → 执行循环体 → 校验条件 → 条件为true？→ 是→回到执行循环体 → 否→终止循环</strong>。这一流程的核心特点是“先执行后判断”，确保循环体至少执行一次，这是do/while循环与while循环的本质区别。</p>
<h3 data-id="heading-13">3.3 简单示例（如用户输入验证、至少执行一次的逻辑）</h3>
<p>do/while循环的核心优势是“至少执行一次”，因此常用于“需要先执行再判断”的场景，比如用户输入验证、初始化逻辑校验等。下面通过两个示例展示其使用：</p>
<h4 data-id="heading-14">3.3.1 示例1：用户输入验证（确保输入有效数字）</h4>
<p>需求：要求用户输入一个1到10之间的整数，若输入无效则反复提示输入，直到输入有效为止。由于需要先获取用户输入再判断是否有效，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> inputNum: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span> <span class="hljs-comment">// 存储用户输入的数字</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入1到10之间的整数："</span>)
        <span class="hljs-keyword">val</span> input = scanner.next() <span class="hljs-comment">// 先执行：获取用户输入</span>
        <span class="hljs-comment">// 尝试将输入转换为整数</span>
        inputNum = <span class="hljs-keyword">try</span> {
            input.toInt()
        } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
            <span class="hljs-literal">null</span> <span class="hljs-comment">// 转换失败则为null</span>
        }
        <span class="hljs-comment">// 判断输入是否有效，无效则提示</span>
        <span class="hljs-keyword">if</span> (inputNum == <span class="hljs-literal">null</span> || inputNum !<span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) {
            println(<span class="hljs-string">"输入无效，请重新输入！"</span>)
        }
    } <span class="hljs-keyword">while</span> (inputNum == <span class="hljs-literal">null</span> || inputNum !<span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) <span class="hljs-comment">// 再判断：输入无效则继续循环</span>

    println(<span class="hljs-string">"您输入的有效数字是：<span class="hljs-variable">$inputNum</span>"</span>)
    scanner.close()
}

</code></pre>
<p>执行逻辑：无论用户第一次输入是否有效，都会先执行循环体中的“提示输入→获取输入→校验”逻辑，若输入无效（非数字或超出范围），则通过条件表达式判断继续循环，直到输入有效为止。</p>
<p>输出示例（输入无效后再输入有效）：</p>
<pre><code class="hljs">请输入1到10之间的整数：
abc
输入无效，请重新输入！
请输入1到10之间的整数：
15
输入无效，请重新输入！
请输入1到10之间的整数：
5
您输入的有效数字是：5

</code></pre>
<h4 data-id="heading-15">3.3.2 示例2：至少执行一次的累加逻辑</h4>
<p>需求：让用户输入数字进行累加，输入0时停止，要求即使第一次就输入0，也要先记录输入再终止（即至少执行一次输入和判断）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> input: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入一个整数（输入0停止）："</span>)
        input = scanner.nextInt() <span class="hljs-comment">// 先执行：获取输入</span>
        sum += input <span class="hljs-comment">// 累加输入的数字</span>
    } <span class="hljs-keyword">while</span> (input != <span class="hljs-number">0</span>) <span class="hljs-comment">// 再判断：输入不是0则继续循环</span>

    println(<span class="hljs-string">"所有输入数字的累加和：<span class="hljs-variable">$sum</span>"</span>)
    scanner.close()
}

</code></pre>
<p>执行逻辑：若用户第一次输入0，循环体会先执行“提示→获取输入→累加”，然后判断input=0，循环终止，累加和为0；若输入其他数字，则继续循环。这确保了“输入→累加”逻辑至少执行一次。</p>
<p>输出示例（第一次输入0）：</p>
<pre><code class="hljs">请输入一个整数（输入0停止）：
0
所有输入数字的累加和：0

</code></pre>
<h2 data-id="heading-16">四、while 与 do/while 的核心差异</h2>
<p>while和do/while循环的语法相似，都是通过条件表达式控制循环，但两者的执行流程存在本质区别，这导致它们的适用场景也不同。下面从三个维度对比核心差异：</p>
<h3 data-id="heading-17">4.1 执行顺序不同（判断时机的区别）</h3>
<p>这是两者最核心的差异，直接决定了循环体的执行时机：</p>
<ul>
<li><strong>while循环</strong>：<strong>先判断，后执行</strong>。条件表达式的校验在循环体执行之前，只有条件满足时才会执行循环体；</li>
<li><strong>do/while循环</strong>：<strong>先执行，后判断</strong>。循环体的执行在条件表达式校验之前，无论条件是否满足，循环体都会先执行一次。</li>
</ul>
<p>可以用一个简单的比喻理解：while循环像“先买票再上车”，条件不满足（没买票）就不能上车（执行循环体）；do/while循环像“先上车再补票”，无论是否有票（条件是否满足），都先上车（执行一次循环体），再判断是否补票（继续循环）。</p>
<h3 data-id="heading-18">4.2 初始条件不满足时的表现（do/while 至少执行一次）</h3>
<p>当初始条件表达式结果为false时，两者的表现截然不同，这是执行顺序差异的直接体现：</p>
<ul>
<li><strong>while循环</strong>：由于先判断条件，初始条件为false时，循环体<strong>一次都不执行</strong>；</li>
<li><strong>do/while循环</strong>：由于先执行循环体，初始条件为false时，循环体<strong>仍会执行一次</strong>。</li>
</ul>
<p>通过以下对比代码可直观看到差异：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 初始条件为false的while循环</span>
    println(<span class="hljs-string">"=== while循环（初始条件false）==="</span>)
    <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>
    <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">5</span>) {
        println(<span class="hljs-string">"while循环执行了"</span>)
        a--
    }
    println(<span class="hljs-string">"while循环结束"</span>)

    <span class="hljs-comment">// 初始条件为false的do/while循环</span>
    println(<span class="hljs-string">"\n=== do/while循环（初始条件false）==="</span>)
    <span class="hljs-keyword">var</span> b = <span class="hljs-number">10</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"do/while循环执行了"</span>)
        b--
    } <span class="hljs-keyword">while</span> (b &lt; <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"do/while循环结束"</span>)
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">=== <span class="hljs-keyword">while</span>循环（初始条件<span class="hljs-literal">false</span>）===
<span class="hljs-keyword">while</span>循环结束

=== <span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环（初始条件<span class="hljs-literal">false</span>）===
<span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环执行了
<span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环结束

</code></pre>
<p>结果显示：while循环因初始条件a=10&lt;5为false，循环体一次都没执行；而do/while循环虽初始条件b=10&lt;5为false，但循环体仍执行了一次。</p>
<h3 data-id="heading-19">4.3 适用场景对比（何时选 while，何时选 do/while）</h3>
<p>执行顺序和初始条件表现的差异，决定了两者的适用场景截然不同，开发中需根据“是否需要循环体至少执行一次”来选择：</p>
<h4 data-id="heading-20">4.3.1 while循环适用场景</h4>
<p>当循环体“可能一次都不执行”时，优先选择while循环，典型场景包括：</p>
<ul>
<li><strong>不确定是否需要执行的遍历场景</strong>：如遍历一个可能为空的数据流，若数据流为空则循环体不执行；</li>
<li><strong>条件驱动的动态循环场景</strong>：如“当温度低于0℃时启动加热”，若初始温度就高于0℃，则加热逻辑一次都不执行；</li>
<li><strong>固定次数但可能为0的循环场景</strong>：如“循环打印n个数字，n可能为0”，若n=0则不打印。</li>
</ul>
<p>示例：遍历一个可能为空的列表，打印其中的元素（列表为空则不执行）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = listOf&lt;String&gt;() <span class="hljs-comment">// 空列表</span>
    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>
    <span class="hljs-comment">// 列表为空时，index &lt; list.size为false，循环体不执行</span>
    <span class="hljs-keyword">while</span> (index &lt; list.size) {
        println(list[index])
        index++
    }
    println(<span class="hljs-string">"遍历结束（列表为空，未执行循环体）"</span>)
}

</code></pre>
<h4 data-id="heading-21">4.3.2 do/while循环适用场景</h4>
<p>当循环体“必须至少执行一次”时，优先选择do/while循环，典型场景包括：</p>
<ul>
<li><strong>用户输入验证场景</strong>：如“获取用户有效输入”，必须先让用户输入一次，再判断是否有效；</li>
<li><strong>初始化后校验场景</strong>：如“初始化一个配置后，校验配置是否有效，无效则重新初始化”，初始化逻辑必须至少执行一次；</li>
<li><strong>至少执行一次的业务逻辑场景</strong>：如“重试接口请求，最多重试3次”，即使第一次请求就成功，也需要先执行一次请求逻辑。</li>
</ul>
<p>示例：重试接口请求（最多重试3次，至少请求一次）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxRetry = <span class="hljs-number">3</span> <span class="hljs-comment">// 最大重试次数</span>
    <span class="hljs-keyword">var</span> retryCount = <span class="hljs-number">0</span> <span class="hljs-comment">// 已重试次数</span>
    <span class="hljs-keyword">var</span> isSuccess = <span class="hljs-literal">false</span> <span class="hljs-comment">// 请求是否成功</span>

    <span class="hljs-keyword">do</span> {
        <span class="hljs-comment">// 执行请求逻辑（至少执行一次）</span>
        isSuccess = requestApi()
        <span class="hljs-keyword">if</span> (!isSuccess) {
            retryCount++
            println(<span class="hljs-string">"请求失败，已重试<span class="hljs-variable">$retryCount</span>次"</span>)
        }
        <span class="hljs-comment">// 条件：请求失败且未达到最大重试次数则继续重试</span>
    } <span class="hljs-keyword">while</span> (!isSuccess &amp;&amp; retryCount &lt; maxRetry)

    <span class="hljs-keyword">if</span> (isSuccess) {
        println(<span class="hljs-string">"请求成功"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"超过最大重试次数，请求失败"</span>)
    }
}

<span class="hljs-comment">// 模拟接口请求（随机返回成功或失败）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestApi</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> random = (<span class="hljs-number">1.</span><span class="hljs-number">.10</span>).random()
    <span class="hljs-keyword">return</span> random &gt; <span class="hljs-number">3</span> <span class="hljs-comment">// 70%概率成功</span>
}

</code></pre>
<h2 data-id="heading-22">五、循环控制：break 与 continue</h2>
<p>在while和do/while循环中，有时需要根据特殊条件调整循环节奏，比如“找到目标值后立即终止循环”“跳过当前无效值，继续下一次循环”。Kotlin提供了break和continue两个关键字，用于实现对循环的精准控制。</p>
<h3 data-id="heading-23">5.1 break 关键字（终止整个循环）</h3>
<p>break关键字的作用是<strong>立即终止当前所在的循环</strong>，无论条件表达式是否满足，都会跳转到循环之后的代码继续执行。它适用于“找到目标后无需继续循环”的场景，比如遍历数据时找到指定元素后终止、满足某个条件时提前退出循环。</p>
<p>示例：遍历1到10的数字，找到第一个能被3整除的数字后终止循环：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">var</span> target = -<span class="hljs-number">1</span> <span class="hljs-comment">// 存储找到的目标数字</span>

    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
            target = num
            <span class="hljs-keyword">break</span> <span class="hljs-comment">// 找到目标，终止整个循环</span>
        }
        num++
    }

    println(<span class="hljs-string">"1到10中第一个能被3整除的数字是：<span class="hljs-variable">$target</span>"</span>)
}

</code></pre>
<p>执行逻辑：num从1开始递增，当num=3时，3%3==0成立，将target设为3，执行break终止循环，不再继续遍历4到10的数字。</p>
<p>输出结果：<code>1到10中第一个能被3整除的数字是：3</code></p>
<h3 data-id="heading-24">5.2 continue 关键字（跳过当前迭代，进入下一次）</h3>
<p>continue关键字的作用是<strong>跳过当前迭代的剩余循环体逻辑，直接进入下一次循环的条件校验</strong>。它不会终止整个循环，只是跳过当前次的无效逻辑，适用于“过滤无效数据，仅处理有效数据”的场景。</p>
<p>示例：遍历1到10的数字，只打印奇数，跳过偶数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
            num++ <span class="hljs-comment">// 注意：continue前需更新循环变量，避免死循环</span>
            <span class="hljs-keyword">continue</span> <span class="hljs-comment">// 是偶数，跳过打印，进入下一次循环</span>
        }
        println(<span class="hljs-string">"当前奇数：<span class="hljs-variable">$num</span>"</span>)
        num++
    }
}

</code></pre>
<p>执行逻辑：num从1开始，若为偶数（num%2==0），则先让num自增，再执行continue跳过打印逻辑，直接回到条件校验；若为奇数，则打印数字后num自增。</p>
<p>输出结果：</p>
<pre><code class="hljs">当前奇数：1
当前奇数：3
当前奇数：5
当前奇数：7
当前奇数：9

</code></pre>
<p><strong>注意</strong>：使用continue时，务必在continue之前更新循环变量（如num++），否则会导致循环变量值不变，条件始终满足，陷入无限循环。</p>
<h3 data-id="heading-25">5.3 简单示例（控制循环执行节奏）</h3>
<p>下面通过一个综合示例，展示break和continue如何配合控制循环节奏：遍历1到20的数字，打印其中的“能被5整除的奇数”，遇到大于15的数字则终止循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">20</span>) {
        <span class="hljs-comment">// 遇到大于15的数字，终止整个循环</span>
        <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">15</span>) {
            <span class="hljs-keyword">break</span>
        }
        <span class="hljs-comment">// 跳过偶数，只处理奇数</span>
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
            num++
            <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-comment">// 打印能被5整除的奇数</span>
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>) {
            println(<span class="hljs-string">"符合条件的数字：<span class="hljs-variable">$num</span>"</span>)
        }
        num++
    }
    println(<span class="hljs-string">"循环终止"</span>)
}

</code></pre>
<p>执行逻辑：</p>
<ul>
<li>num=1到15之间，先判断是否大于15（否），再判断是否为偶数（是则跳过），最后判断是否能被5整除（是则打印）；</li>
<li>num=16时，判断大于15（是），执行break终止循环；</li>
<li>符合条件的数字为1到15之间的奇数且能被5整除，即5、15。</li>
</ul>
<p>输出结果：</p>
<pre><code class="hljs">符合条件的数字：5
符合条件的数字：15
循环终止

</code></pre>
<h2 data-id="heading-26">六、实用场景举例</h2>
<p>前面介绍了while和do/while循环的基础用法和差异，下面结合实际开发中的常见场景，展示两者的具体应用，帮助读者更好地理解“何时用哪种循环”。</p>
<h3 data-id="heading-27">6.1 while 场景（遍历未知长度数据、条件满足时循环）</h3>
<h4 data-id="heading-28">6.1.1 场景1：遍历未知长度的数据流</h4>
<p>需求：模拟读取一个未知长度的数据流（如从文件读取内容，直到读取到结束标记“EOF”），每读取一条数据就打印，数据流为空则不执行循环。由于数据流长度未知且可能为空，适合用while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"开始读取数据流..."</span>)
    <span class="hljs-comment">// 循环条件：读取到的数据不是结束标记"EOF"</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = readDataFromStream() <span class="hljs-comment">// 读取一条数据</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> == <span class="hljs-string">"EOF"</span>) {
            <span class="hljs-keyword">break</span> <span class="hljs-comment">// 读取到结束标记，终止循环</span>
        }
        println(<span class="hljs-string">"读取到数据：<span class="hljs-variable">$data</span>"</span>)
    }
    println(<span class="hljs-string">"数据流读取完毕"</span>)
}

<span class="hljs-comment">// 模拟读取数据流（依次返回数据1、数据2、EOF）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dataIndex = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">readDataFromStream</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">val</span> dataList = listOf(<span class="hljs-string">"数据1"</span>, <span class="hljs-string">"数据2"</span>, <span class="hljs-string">"EOF"</span>)
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = dataList[dataIndex]
    dataIndex++
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-erlang" lang="erlang">开始读取数据流...
读取到数据：数据<span class="hljs-number">1</span>
读取到数据：数据<span class="hljs-number">2</span>
数据流读取完毕

</code></pre>
<h4 data-id="heading-29">6.1.2 场景2：条件满足时循环执行重试逻辑</h4>
<p>需求：系统启动时连接数据库，若连接失败则每隔3秒重试一次，直到连接成功或达到最大重试次数（5次）。由于初始可能连接成功，无需重试，适合用while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxRetry = <span class="hljs-number">5</span>
    <span class="hljs-keyword">var</span> retryCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> isConnected = <span class="hljs-literal">false</span>

    <span class="hljs-comment">// 条件：未连接成功且未达到最大重试次数</span>
    <span class="hljs-keyword">while</span> (!isConnected &amp;&amp; retryCount &lt; maxRetry) {
        isConnected = connectToDb()
        <span class="hljs-keyword">if</span> (isConnected) {
            println(<span class="hljs-string">"数据库连接成功！"</span>)
        } <span class="hljs-keyword">else</span> {
            retryCount++
            <span class="hljs-keyword">if</span> (retryCount &lt; maxRetry) {
                println(<span class="hljs-string">"数据库连接失败，<span class="hljs-variable">$retryCount</span> 次重试，3秒后重试..."</span>)
                Thread.sleep(<span class="hljs-number">3000</span>) <span class="hljs-comment">// 等待3秒</span>
            }
        }
    }

    <span class="hljs-keyword">if</span> (!isConnected) {
        println(<span class="hljs-string">"达到最大重试次数（<span class="hljs-variable">$maxRetry</span> 次），数据库连接失败！"</span>)
    }
}

<span class="hljs-comment">// 模拟数据库连接（第3次重试时成功）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectCount = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connectToDb</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    connectCount++
    <span class="hljs-keyword">return</span> connectCount == <span class="hljs-number">3</span>
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-erlang" lang="erlang">数据库连接失败，<span class="hljs-number">1</span> 次重试，<span class="hljs-number">3</span>秒后重试...
数据库连接失败，<span class="hljs-number">2</span> 次重试，<span class="hljs-number">3</span>秒后重试...
数据库连接成功！

</code></pre>
<h3 data-id="heading-30">6.2 do/while 场景（表单验证、初始化后需校验的逻辑）</h3>
<h4 data-id="heading-31">6.2.1 场景1：表单输入验证（至少输入一次）</h4>
<p>需求：用户注册时输入密码，要求密码长度至少8位且包含数字和字母，若密码不满足要求则反复提示输入，直到输入符合要求的密码。由于必须让用户至少输入一次密码，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> password: String
    <span class="hljs-comment">// 密码校验规则：长度≥8，包含数字和字母</span>
    <span class="hljs-keyword">val</span> passwordRegex = <span class="hljs-string">"^(?=.*[0-9])(?=.*[a-zA-Z]).{8,}$"</span>.toRegex()

    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入注册密码（长度≥8，包含数字和字母）："</span>)
        password = scanner.next()
        <span class="hljs-keyword">if</span> (!password.matches(passwordRegex)) {
            println(<span class="hljs-string">"密码不符合要求，请重新输入！"</span>)
        }
    } <span class="hljs-keyword">while</span> (!password.matches(passwordRegex)) <span class="hljs-comment">// 密码不符合要求则继续循环</span>

    println(<span class="hljs-string">"密码设置成功！"</span>)
    scanner.close()
}

</code></pre>
<p>输出示例：</p>
<pre><code class="hljs">请输入注册密码（长度≥8，包含数字和字母）：
123456
密码不符合要求，请重新输入！
请输入注册密码（长度≥8，包含数字和字母）：
abcdefgh
密码不符合要求，请重新输入！
请输入注册密码（长度≥8，包含数字和字母）：
abc12345
密码设置成功！

</code></pre>
<h4 data-id="heading-32">6.2.2 场景2：初始化后校验配置（至少初始化一次）</h4>
<p>需求：系统初始化配置（从配置文件读取），初始化后校验配置是否有效，若无效则重新初始化（最多重新初始化3次）。由于必须先初始化一次才能校验，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxInitCount = <span class="hljs-number">3</span>
    <span class="hljs-keyword">var</span> initCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> config: Config? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">do</span> {
        config = initConfig() <span class="hljs-comment">// 初始化配置（至少执行一次）</span>
        initCount++
        <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span> || !config.isValid()) {
            <span class="hljs-keyword">if</span> (initCount &lt; maxInitCount) {
                println(<span class="hljs-string">"配置初始化无效，<span class="hljs-variable">$initCount</span> 次初始化，准备重新初始化..."</span>)
            }
        }
    } <span class="hljs-keyword">while</span> ((config == <span class="hljs-literal">null</span> || !config.isValid()) &amp;&amp; initCount &lt; maxInitCount)

    <span class="hljs-keyword">if</span> (config != <span class="hljs-literal">null</span> &amp;&amp; config.isValid()) {
        println(<span class="hljs-string">"配置初始化成功，配置信息：<span class="hljs-variable">$config</span>"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"达到最大初始化次数（<span class="hljs-variable">$maxInitCount</span> 次），配置初始化失败！"</span>)
    }
}

<span class="hljs-comment">// 配置数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>(<span class="hljs-keyword">val</span> serverUrl: String, <span class="hljs-keyword">val</span> port: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 校验配置是否有效</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isValid</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> serverUrl.startsWith(<span class="hljs-string">"http"</span>) &amp;&amp; port <span class="hljs-keyword">in</span> <span class="hljs-number">1024.</span><span class="hljs-number">.65535</span>
    }
}

<span class="hljs-comment">// 模拟配置初始化（第2次初始化时成功）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> initConfigCount = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span>: Config? {
    initConfigCount++
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (initConfigCount == <span class="hljs-number">2</span>) {
        Config(<span class="hljs-string">"http://localhost"</span>, <span class="hljs-number">8080</span>)
    } <span class="hljs-keyword">else</span> {
        Config(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">80</span>) <span class="hljs-comment">// 无效配置（URL无http，端口80小于1024）</span>
    }
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-ini" lang="ini">配置初始化无效，1 次初始化，准备重新初始化...
配置初始化成功，配置信息：Config(<span class="hljs-attr">serverUrl</span>=http://localhost, port=<span class="hljs-number">8080</span>)

</code></pre>
<h2 data-id="heading-33">七、总结与使用建议</h2>
<h3 data-id="heading-34">7.1 核心知识点回顾（语法、流程、差异）</h3>
<ul>
<li><strong>while循环核心</strong>：语法为“while(条件){循环体}”，执行流程是“先判断后执行”，初始条件不满足时循环体一次都不执行，适合“可能不执行”的场景。</li>
<li><strong>do/while循环核心</strong>：语法为“do{循环体}while(条件);”，执行流程是“先执行后判断”，无论初始条件是否满足，循环体至少执行一次，适合“必须执行一次”的场景。</li>
<li><strong>循环控制核心</strong>：break用于终止整个循环，continue用于跳过当前迭代；使用continue时需提前更新循环变量，避免无限循环。</li>
<li><strong>核心差异</strong>：执行顺序不同（判断时机），导致初始条件不满足时的表现不同（是否执行一次），进而决定适用场景不同。</li>
</ul>
<h3 data-id="heading-35">7.2 避坑点（避免死循环、条件表达式设计）</h3>
<ul>
<li><strong>避免无限循环</strong>：这是while和do/while循环最常见的坑。核心解决方法是“确保循环体内部能改变条件表达式的结果”，比如变量自增、修改输入值、执行break等；尤其要注意使用continue时，需在continue前更新循环变量。</li>
<li><strong>条件表达式必须返回Boolean类型</strong>：避免将其他类型的值直接作为条件（如Java中允许的整数0为false、非0为true），Kotlin严格要求条件表达式为Boolean类型，否则编译报错。</li>
<li><strong>do/while循环末尾不要遗漏分号</strong>：Kotlin语法要求do/while循环的条件表达式末尾必须加英文分号，遗漏会导致编译错误。</li>
<li><strong>循环变量初始化要正确</strong>：确保循环变量的初始值符合业务逻辑，比如遍历1到10时，初始值设为1而非0，避免出现逻辑错误。</li>
</ul>
<h3 data-id="heading-36">7.3 选择技巧（根据是否需要 “至少执行一次” 判断）</h3>
<p>开发中选择while还是do/while循环，核心判断标准只有一个：<strong>循环体是否需要至少执行一次</strong>。可按照以下步骤快速判断：</p>
<ol>
<li><strong>明确业务需求</strong>：思考“循环体是否存在‘一次都不执行’的合理场景”；</li>
<li><strong>若存在“一次都不执行”的场景</strong>：选择while循环，如遍历可能为空的集合、条件初始就不满足的循环；</li>
<li><strong>若“必须至少执行一次”</strong>：选择do/while循环，如用户输入验证、初始化后校验的逻辑；</li>
<li><strong>复杂场景结合循环控制</strong>：当需要提前终止循环或跳过无效迭代时，配合break和continue使用，精准控制循环节奏。</li>
</ol>
<p>此外，还需注意：while和do/while循环更适合“不确定次数”的条件驱动场景，若循环次数固定或需要遍历集合/区间，优先选择for循环，让代码更简洁直观。</p>
<p>掌握while和do/while循环的核心差异和适用场景，结合break、continue进行精准控制，能让你在处理“条件驱动”的循环场景时游刃有余，写出更高效、更易读的Kotlin代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Playwright最常用的功能语句汇总]]></title>    <link>https://juejin.cn/post/7574745301725315078</link>    <guid>https://juejin.cn/post/7574745301725315078</guid>    <pubDate>2025-11-21T07:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725315078" data-draft-id="7574958975159074859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Playwright最常用的功能语句汇总"/> <meta itemprop="keywords" content="自动化运维"/> <meta itemprop="datePublished" content="2025-11-21T07:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="温蒂来啦"/> <meta itemprop="url" content="https://juejin.cn/user/1408927966434123"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Playwright最常用的功能语句汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408927966434123/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    温蒂来啦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:23:07.000Z" title="Fri Nov 21 2025 07:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是 <strong>Playwright（Python）最常用的功能语句汇总</strong>，覆盖日常自动化测试与爬虫开发中的核心操作。</p>
<hr/>
<h2 data-id="heading-0">🧰 一、启动与页面控制</h2>
<pre><code class="hljs language-csharp" lang="csharp">python
编辑
<span class="hljs-keyword">from</span> playwright.<span class="hljs-function">sync_api import sync_playwright

<span class="hljs-keyword">with</span> <span class="hljs-title">sync_playwright</span>() <span class="hljs-keyword">as</span> p:
    # 启动浏览器（headless</span>=False 可见模式）
    browser = p.chromium.launch(headless=False)
    page = browser.new_page()

    <span class="hljs-meta"># 打开网页</span>
    page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">"https://example.com"</span>)

    <span class="hljs-meta"># 设置视口大小</span>
    page.set_viewport_size({<span class="hljs-string">"width"</span>: <span class="hljs-number">1920</span>, <span class="hljs-string">"height"</span>: <span class="hljs-number">1080</span>})

    <span class="hljs-meta"># 等待页面加载完成</span>
    page.wait_for_load_state(<span class="hljs-string">"networkidle"</span>)  <span class="hljs-meta"># 或 "load", "domcontentloaded"</span>

    browser.close()
</code></pre>
<hr/>
<h2 data-id="heading-1">🔍 二、元素定位（Locator）</h2>
<p>Playwright 推荐使用 <code>page.locator()</code>（比 <code>page.click(selector)</code> 更强大）</p>
<pre><code class="hljs language-makefile" lang="makefile">python
编辑
<span class="hljs-comment"># 常用选择器</span>
page.locator(<span class="hljs-string">"#id"</span>)                <span class="hljs-comment"># ID</span>
page.locator(<span class="hljs-string">".class"</span>)             <span class="hljs-comment"># 类名</span>
page.locator(<span class="hljs-string">"text=按钮文本"</span>)       <span class="hljs-comment"># 文本匹配（智能）</span>
page.locator(<span class="hljs-string">"input[name='email']"</span>)<span class="hljs-comment"># 属性</span>
<span class="hljs-section">page.locator("button:has-text('提交')") # 包含指定文本的按钮</span>
page.locator(<span class="hljs-string">"div &gt;&gt; text=内容"</span>)    <span class="hljs-comment"># 组合选择器（CSS + 文本）</span>

<span class="hljs-comment"># 获取多个元素</span>
items = page.locator(<span class="hljs-string">".item"</span>)
count = items.count()
first_item = items.first
last_item = items.last
third_item = items.nth(2)  <span class="hljs-comment"># 从0开始</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">✏️ 三、交互操作</h2>
<pre><code class="hljs language-bash" lang="bash">python
编辑
<span class="hljs-comment"># 点击</span>
page.locator(<span class="hljs-string">"button"</span>).click()
page.click(<span class="hljs-string">"text=登录"</span>)  <span class="hljs-comment"># 简写（不推荐复杂场景）</span>

<span class="hljs-comment"># 输入文本</span>
page.locator(<span class="hljs-string">"#username"</span>).fill(<span class="hljs-string">"admin"</span>)      <span class="hljs-comment"># 清空后输入（推荐）</span>
page.locator(<span class="hljs-string">"#comment"</span>).<span class="hljs-built_in">type</span>(<span class="hljs-string">"Hello"</span>)       <span class="hljs-comment"># 模拟逐字输入（慢）</span>

<span class="hljs-comment"># 清空输入框</span>
page.locator(<span class="hljs-string">"#search"</span>).clear()

<span class="hljs-comment"># 悬停</span>
page.locator(<span class="hljs-string">".menu-item"</span>).hover()

<span class="hljs-comment"># 双击 / 右键</span>
page.locator(<span class="hljs-string">"#target"</span>).dblclick()
page.locator(<span class="hljs-string">"#target"</span>).click(button=<span class="hljs-string">"right"</span>)

<span class="hljs-comment"># 按键（在输入框中按回车）</span>
page.press(<span class="hljs-string">"#search"</span>, <span class="hljs-string">"Enter"</span>)
page.keyboard.press(<span class="hljs-string">"Tab"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-3">📥 四、表单与下拉框</h2>
<h3 data-id="heading-4">标准 <code>&lt;select&gt;</code> 下拉框：</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-comment"># 选择第一个选项</span>
page.locator("select<span class="hljs-comment">#country").select_option(index=0)</span>

<span class="hljs-comment"># 按 value 选</span>
page.locator("select").select_option(<span class="hljs-attr">value</span>=<span class="hljs-string">"CN"</span>)

<span class="hljs-comment"># 按可见文本选</span>
page.locator("select").select_option(<span class="hljs-attr">label</span>=<span class="hljs-string">"中国"</span>)
</code></pre>
<h3 data-id="heading-5">自定义下拉（div 模拟）：</h3>
<pre><code class="hljs language-makefile" lang="makefile">python
编辑
dropdown = page.locator(<span class="hljs-string">"#city-selector"</span>)
dropdown.locator(<span class="hljs-string">".trigger"</span>).click()
dropdown.locator(<span class="hljs-string">"text=上海"</span>).click()  <span class="hljs-comment"># 在容器内找</span>
</code></pre>
<h3 data-id="heading-6">文件上传：</h3>
<pre><code class="hljs language-css" lang="css">python
编辑
page<span class="hljs-selector-class">.set_input_files</span>("<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">'file'</span>]</span>", "path/<span class="hljs-selector-tag">to</span>/file<span class="hljs-selector-class">.pdf</span>")
</code></pre>
<h3 data-id="heading-7">复选框 / 单选框：</h3>
<pre><code class="hljs language-bash" lang="bash">python
编辑
page.check(<span class="hljs-string">"#agree"</span>)      <span class="hljs-comment"># 勾选</span>
page.uncheck(<span class="hljs-string">"#news"</span>)     <span class="hljs-comment"># 取消勾选</span>
page.is_checked(<span class="hljs-string">"#agree"</span>) <span class="hljs-comment"># 判断是否选中</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">⏳ 五、等待（Wait）</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 等待元素出现（推荐）</span>
page.wait_for_selector(<span class="hljs-string">"text=成功"</span>, timeout=<span class="hljs-number">5000</span>)

<span class="hljs-comment"># 等待元素可点击</span>
page.wait_for_selector(<span class="hljs-string">"button#submit"</span>, <span class="hljs-keyword">state</span>=<span class="hljs-string">"visible"</span>)
page.locator(<span class="hljs-string">"button#submit"</span>).wait_for(<span class="hljs-keyword">state</span>=<span class="hljs-string">"enabled"</span>)

<span class="hljs-comment"># 等待网络请求完成</span>
page.wait_for_load_state(<span class="hljs-string">"networkidle"</span>)

<span class="hljs-comment"># 等待特定 URL</span>
page.wait_for_url(<span class="hljs-string">"**/dashboard"</span>)

<span class="hljs-comment"># 等待弹窗（alert/confirm）</span>
page.on(<span class="hljs-string">"dialog"</span>, lambda dialog: dialog.accept())
</code></pre>
<hr/>
<h2 data-id="heading-9">📡 六、网络与请求拦截</h2>
<pre><code class="hljs language-vbscript" lang="vbscript"># 拦截 API 请求并修改响应（Mock）
def handle_route(route):
    <span class="hljs-keyword">if</span> <span class="hljs-string">"api/user"</span> <span class="hljs-keyword">in</span> route.<span class="hljs-built_in">request</span>.url:
        route.fulfill(json={<span class="hljs-string">"name"</span>: <span class="hljs-string">"Mock User"</span>})
    <span class="hljs-keyword">else</span>:
        route.continue_()

page.route(<span class="hljs-string">"**/api/**"</span>, handle_route)

# 监听请求/响应
page.<span class="hljs-keyword">on</span>(<span class="hljs-string">"request"</span>, lambda <span class="hljs-built_in">request</span>: pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"&gt;&gt;"</span>, <span class="hljs-built_in">request</span>.method, <span class="hljs-built_in">request</span>.url))
page.<span class="hljs-keyword">on</span>(<span class="hljs-string">"response"</span>, lambda <span class="hljs-built_in">response</span>: pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"&lt;&lt;"</span>, <span class="hljs-built_in">response</span>.status, <span class="hljs-built_in">response</span>.url))
</code></pre>
<hr/>
<h2 data-id="heading-10">📸 七、截图与录屏</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 截图整个页面</span>
page.screenshot(<span class="hljs-attr">path</span>=<span class="hljs-string">"full.png"</span>, full_page=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 截图某个元素</span>
page.locator("<span class="hljs-comment">#chart").screenshot(path="chart.png")</span>

<span class="hljs-comment"># 录屏（需启动时开启）</span>
<span class="hljs-attr">browser</span> = p.chromium.launch(record_video_dir=<span class="hljs-string">"videos/"</span>)
<span class="hljs-attr">page</span> = browser.new_page()
<span class="hljs-comment"># ...操作...</span>
page.video.path()  <span class="hljs-comment"># 获取视频路径</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">🌐 八、多页面与弹窗处理</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 等待新页面打开</span>
with page.expect_popup() as popup_info:
    page.click("a<span class="hljs-section">[target='_blank']</span>")
<span class="hljs-attr">new_page</span> = popup_info.value

<span class="hljs-comment"># 切换到 iframe</span>
<span class="hljs-attr">frame</span> = page.frame_locator(<span class="hljs-string">"iframe[name='myframe']"</span>)
frame.locator("<span class="hljs-comment">#inside-input").fill("hello")</span>

<span class="hljs-comment"># 关闭当前页</span>
page.close()
</code></pre>
<hr/>
<h2 data-id="heading-12">🍪 九、Cookie 与 Storage</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 Cookie</span>
page.context.add_cookies([{<span class="hljs-string">"name"</span>: <span class="hljs-string">"token"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"abc123"</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com"</span>}])

<span class="hljs-comment"># 获取 Cookie</span>
cookies = page.context.cookies()

<span class="hljs-comment"># 本地存储</span>
page.evaluate(<span class="hljs-string">"localStorage.setItem('theme', 'dark')"</span>)
theme = page.evaluate(<span class="hljs-string">"localStorage.getItem('theme')"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-13">🧪 十、断言（配合 pytest）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 元素存在</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">"text=欢迎"</span>).is_visible()

<span class="hljs-comment"># 文本内容</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">"#title"</span>).inner_text() == <span class="hljs-string">"首页"</span>

<span class="hljs-comment"># URL 包含</span>
<span class="hljs-keyword">assert</span> <span class="hljs-string">"success"</span> <span class="hljs-keyword">in</span> page.url

<span class="hljs-comment"># 元素数量</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">".item"</span>).count() == <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">💡 小技巧</h2>
<ul>
<li>
<p><strong>自动等待</strong>：Playwright 的 <code>click()</code>、<code>fill()</code> 等操作会自动等待元素可操作，通常无需手动加 <code>wait</code>。</p>
</li>
<li>
<p><strong>选择器调试</strong>：在浏览器 DevTools Console 中用 <code>$$(selector)</code> 测试 CSS 选择器。</p>
</li>
<li>
<p><strong>录制脚本</strong>：用官方工具生成代码（bash）：</p>
<pre><code class="hljs language-arduino" lang="arduino">playwright codegen https:<span class="hljs-comment">//example.com</span>
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-15">✅ 最佳实践建议</h2>
<ol>
<li><strong>优先使用 <code>locator</code> 而非全局选择器</strong>；</li>
<li><strong>避免 <code>time.sleep()</code>，用 Playwright 内置等待</strong>；</li>
<li><strong>对自定义组件封装成函数</strong>（如 <code>select_dropdown(page, label, option)</code>）；</li>
<li><strong>用 <code>has_text=</code>、<code>has=</code> 提高定位精准度</strong>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[tail 、journalctl 、 docker logs -f命令详解]]></title>    <link>https://juejin.cn/post/7574821757665902633</link>    <guid>https://juejin.cn/post/7574821757665902633</guid>    <pubDate>2025-11-21T07:51:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665902633" data-draft-id="7574892669374382134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="tail 、journalctl 、 docker logs -f命令详解"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-21T07:51:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            tail 、journalctl 、 docker logs -f命令详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:51:25.000Z" title="Fri Nov 21 2025 07:51:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Linux服务器上有效监控应用程序日志是每个开发者和系统管理员的必备技能。下面我将详细解析 <code>tail</code>、<code>journalctl</code>和 <code>docker logs -f</code>这三个强大的日志查看工具，并通过一个项目实战场景展示如何综合运用它们。 为了让你快速建立整体印象，下表概括了这三个命令的核心特点和典型应用场景。</p>





























<table><thead><tr><th>命令/工具</th><th>核心功能</th><th>主要应用场景</th><th>关键特性</th></tr></thead><tbody><tr><td><code>tail</code>​</td><td>查看文件末尾内容，实时追踪文件变化</td><td>查看静态日志文件的最后部分，实时追踪应用程序日志文件</td><td>轻量、直接，适用于任何文本文件</td></tr><tr><td><code>journalctl</code>​</td><td>查询由 <code>systemd</code>管理的系统和服务的日志</td><td>查看系统服务日志，按服务、时间、优先级等维度过滤日志</td><td>结构化日志，强大的过滤和查询能力</td></tr><tr><td><code>docker logs -f</code></td><td>查看并实时跟踪Docker容器的标准输出日志</td><td>实时查看特定Docker容器的日志输出</td><td>容器原生命令，简单易用</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-0">🔧 各工具详解与核心技巧</h3>
<h4 data-id="heading-1">1. <code>tail</code>：文件追踪利器</h4>
<p><code>tail</code>命令的核心在于实时追踪文件末尾的更新，非常适合查看正在写入的日志文件。</p>
<ul>
<li>
<p><strong>实时追踪 (<code>-f</code>与 <code>-F</code>)</strong></p>
<ul>
<li><code>tail -f /path/to/logfile.log</code>：这是最常用的实时追踪命令。但当日志文件被<strong>轮转</strong>（如 <code>logrotate</code>工具将当前日志备份并创建一个新文件）时，<code>-f</code>可能会失效，因为它跟踪的是文件名对应的文件描述符。</li>
<li><code>tail -F /path/to/logfile.log</code>：这是 <code>-f</code>的增强版。它跟踪的是<strong>文件名</strong>而非文件描述符。当发生日志轮转（文件被删除或移动）时，<code>-F</code>能够检测到并自动重新打开新文件，确保追踪不中断。<strong>在生产环境下监控日志时，强烈推荐使用 <code>-F</code></strong>。</li>
</ul>
</li>
<li>
<p><strong>从特定行开始追踪</strong> 如果你想在开始实时追踪前，先查看最近一段时间的历史记录，可以结合 <code>-n</code>参数。例如，<code>tail -n 100 -f app.log</code>会先显示最后100行，然后进入实时追踪模式。</p>
</li>
<li>
<p><strong>结合 <code>grep</code>过滤</strong> 在复杂的日志中，你可能只关心特定信息（如 "ERROR"）。可以使用管道符 <code>|</code>将 <code>tail</code>的输出过滤：<code>tail -F app.log | grep --line-buffered "ERROR"</code>。这里的 <code>--line-buffered</code>参数确保 <code>grep</code>逐行处理，让结果实时显示。</p>
</li>
</ul>
<h4 data-id="heading-2">2. <code>journalctl</code>：系统服务的日志专家</h4>
<p>如果你的应用是作为 <code>systemd</code>服务（如 <code>nginx.service</code>）运行的，那么 <code>journalctl</code>是查看其日志的首选工具。</p>
<ul>
<li>
<p><strong>基本服务日志查询</strong></p>
<ul>
<li><code>journalctl -u your-app.service</code>：查看名为 <code>your-app</code>的服务的所有日志。</li>
<li><code>journalctl -u your-app.service -f</code>：实时跟踪该服务的最新日志。</li>
</ul>
</li>
<li>
<p><strong>强大的过滤功能</strong> <code>journalctl</code>的强大之处在于其多维度的过滤能力。</p>
<ul>
<li><strong>按时间过滤</strong>：<code>journalctl -u your-app.service --since "10 minutes ago" --until "2 minutes ago"</code>查看指定时间范围内的日志。</li>
<li><strong>按日志级别过滤</strong>：<code>journalctl -u your-app.service -p err</code>只显示错误级别及以上的日志（如 <code>err</code>, <code>crit</code>, <code>alert</code>）。</li>
<li><strong>组合查询</strong>：<code>journalctl -u your-app.service -p err --since today</code>查看今天的所有错误日志。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. <code>docker logs -f</code>：容器日志的窗口</h4>
<p>对于Docker容器，查看日志最直接的方式就是使用 <code>docker logs</code>命令。</p>
<ul>
<li><strong>基本用法</strong>：<code>docker logs -f &lt;container_name_or_id&gt;</code>可以实时跟踪指定容器的标准输出（stdout）和标准错误（stderr）。</li>
<li><strong>查看历史记录</strong>：<code>docker logs --tail=50 &lt;container_name&gt;</code>显示容器最近的50行日志，而不进入实时追踪模式。</li>
<li><strong>包含时间戳</strong>：<code>docker logs -t -f &lt;container_name&gt;</code>可以在每条日志前显示时间戳，便于定位问题发生的时间。</li>
<li><strong>退出追踪</strong>：要退出 <code>docker logs -f</code>的实时跟踪模式，只需按下 <code>Ctrl + C</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">💻 项目实战：故障排查流程</h3>
<p>假设你有一个Web应用栈，包含：</p>
<ul>
<li><strong>前端</strong>：一个名为 <code>web-app</code>的Docker容器。</li>
<li><strong>后端API</strong>：一个名为 <code>api-service</code>的 <code>systemd</code>服务。</li>
<li><strong>静态日志文件</strong>：Nginx访问日志 <code>/var/log/nginx/access.log</code>。</li>
</ul>
<p>用户报告网站访问缓慢，以下是你的排查步骤：</p>
<ol>
<li>
<p><strong>快速检查容器状态</strong> 首先，查看所有容器状态，确认 <code>web-app</code>是否在运行：<code>docker ps</code>。</p>
</li>
<li>
<p><strong>实时追踪容器日志</strong> 接着，实时查看前端容器的日志，寻找错误或超时信息：<code>docker logs -f web-app</code>。如果日志滚动非常快，可以配合 <code>grep</code>过滤，例如只查看包含 "timeout" 或 "error" 的行。</p>
</li>
<li>
<p><strong>深入排查系统服务日志</strong> 如果前端容器没有明显错误，问题可能出在后端API。使用 <code>journalctl</code>深入检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 api-service 最近5分钟的日志，按错误级别过滤</span>
journalctl -u api-service.service --since <span class="hljs-string">"5 minutes ago"</span> -p err
</code></pre>
<p>如果发现连接数据库失败的记录，可以继续追踪该服务的实时日志：<code>journalctl -u api-service.service -f</code>。</p>
</li>
<li>
<p><strong>分析Web服务器访问日志</strong> 同时，在另一个终端窗口，使用 <code>tail</code>监控Nginx的访问日志，分析请求量和响应状态：<code>tail -F /var/log/nginx/access.log | grep --line-buffered "POST /api/"</code>。这可以帮助你确认是否是某个特定的API接口导致了问题。</p>
</li>
</ol>
<p>通过这种<strong>从容器到服务，从实时追踪到历史查询</strong>的立体化排查方式，你就能快速定位并解决问题。</p>
<hr/>
<h3 data-id="heading-5">⚠️ 注意事项与最佳实践</h3>
<ul>
<li><strong>日志轮转（Log Rotation）</strong> ：对于由 <code>logrotate</code>管理的日志文件，使用 <code>tail -F</code>而非 <code>-f</code>，以确保在日志文件轮转后仍能持续跟踪。</li>
<li><strong>磁盘空间管理</strong>：定期清理旧日志。对于Docker，可以配置日志驱动（如 <code>json-file</code>）的 <code>max-size</code>和 <code>max-file</code>选项来控制日志文件大小和数量。对于 <code>journalctl</code>，可以使用 <code>journalctl --vacuum-size=500M</code>来限制日志系统占用的总磁盘空间。</li>
<li><strong>工具选择</strong>：根据你的应用程序的输出方式选择最合适的工具。通常，Docker容器用 <code>docker logs</code>，<code>systemd</code>服务用 <code>journalctl</code>，而直接写入文件的应用程序日志则用 <code>tail</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来]]></title>    <link>https://juejin.cn/post/7574958975159418923</link>    <guid>https://juejin.cn/post/7574958975159418923</guid>    <pubDate>2025-11-21T07:56:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159418923" data-draft-id="7574745301724774406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来"/> <meta itemprop="keywords" content="Agent,人工智能,低代码"/> <meta itemprop="datePublished" content="2025-11-21T07:56:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA爱学习的刘哥"/> <meta itemprop="url" content="https://juejin.cn/user/3947717127833450"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3947717127833450/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA爱学习的刘哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:56:55.000Z" title="Fri Nov 21 2025 07:56:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p><strong>一句话总结：传统工作流引擎被“无环”限制得太久，Y-Agent Studio 引入有向有环图（DAG+Loop），终于让 AI Agent 能像人一样“循环思考、反复验证、动态决策”。</strong></p>
</blockquote>
<p>大家好，我是刘哥，一个常年在智能体（Agent）和工作流引擎里打转的 IT 博主。最近我深度体验了 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">Y-Agent Studio</a>，一个基于 FastAPI + RAG + Agent 架构的新一代智能代理平台。而最让我眼前一亮的，不是它的 LLM 集成能力，也不是插件系统——而是它<strong>大胆抛弃了传统 DAG 的“无环”限制</strong>，引入了<strong>有向有环图（Directed Cyclic Graph）</strong> 的执行模型。</p>
<p>今天，我们就来聊聊：<strong>为什么“有环”反而成了优势？它解决了哪些真实痛点？又是如何实现的？</strong></p>
<hr/>
<h2 data-id="heading-0">01｜Y-Agent Studio 的第一个杀手锏：支持“有向有环图”的工作流</h2>
<p>在大多数低代码/AI 工作流平台中，任务编排都依赖 <strong>DAG（有向无环图）</strong> ：节点按依赖顺序执行，一旦执行完毕就不可回头。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b24fbd5061254d2faac2569d52201a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB54ix5a2m5Lmg55qE5YiY5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316615&amp;x-signature=uOHO06qsQchExdifLqJomDr7Rb0%3D" alt="image.png" loading="lazy"/></p>
<p>但 Y-Agent Studio 不一样。它的核心执行引擎明确支持<strong>节点之间的循环引用</strong>——比如 A → B → C → B，形成闭环。这意味着：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/902375caf4fd444cb5c9370203e9432e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB54ix5a2m5Lmg55qE5YiY5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316615&amp;x-signature=ONh6s2aQxIyw8HTx2XmdWIFtaHs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>Agent 可以在满足条件时<strong>反复调用某个工具</strong>；</li>
<li>可以实现<strong>带反馈的迭代优化</strong>（比如“生成代码 → 测试 → 失败 → 重写”）；</li>
<li>支持<strong>人类式的试错与反思流程</strong>，而不是一条道走到黑。</li>
</ul>
<p>这听起来简单，但在工程上却是一个巨大的跃迁。</p>
<hr/>
<h2 data-id="heading-1">02｜传统 DAG 的三大“隐痛”：为什么我们受够了“无环”？</h2>
<p>别误会，DAG 在任务调度领域功不可没。但当我们把 AI Agent 当作“数字员工”使用时，DAG 的局限性就暴露无遗：</p>
<h3 data-id="heading-2">痛点 1：无法处理“循环逻辑”</h3>
<p>你想让 Agent 写一段 Python 代码，并自动运行测试。如果测试失败，让它修改后再试——<strong>这本质上是一个 while 循环</strong>。但 DAG 不允许 C 节点再指向 B 节点，你只能手动复制多个“重试节点”，既丑陋又不可扩展。</p>
<h3 data-id="heading-3">痛点 2：缺乏状态反馈机制</h3>
<p>DAG 是“开环”的：节点执行完就结束，无法根据下游结果动态决定是否重新执行上游。而真实世界的问题往往是<strong>闭环反馈</strong>的（比如用户说“不对，再想想”）。</p>
<h3 data-id="heading-4">痛点 3：强行拆解复杂逻辑</h3>
<p>为了绕过“无环”限制，开发者不得不把一个自然循环拆成 N 个线性步骤，导致工作流臃肿、难以维护，甚至丧失语义完整性。</p>
<blockquote>
<p>💡 说白了：<strong>DAG 适合“流水线”，但不适合“思考过程”。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">03｜有向有环图：不是 bug，是 feature！</h2>
<p>Y-Agent Studio 的设计者显然意识到：<strong>真正的智能体需要“回溯”和“迭代”的能力</strong>。于是他们引入了<strong>可控的有向有环图模型</strong>。</p>
<p>但这不意味着“无限死循环”！关键在于 <strong>“受控循环”</strong> ：</p>
<ul>
<li>通过 <code>loop_start_node</code> 和 <code>loop_node</code> 明确标识循环边界；</li>
<li>设置最大循环次数（<code>run_times</code> / <code>virtual_run_times</code>）防止失控；</li>
<li>利用 <code>loop_context</code> 传递每次迭代的状态（比如错误日志、用户反馈）；</li>
<li>下游节点可通过条件判断决定是否“跳回”循环起点。</li>
</ul>
<p>这样一来，循环不再是危险的黑洞，而是一个<strong>结构化、可观察、可中断的智能决策单元</strong>。</p>
<blockquote>
<p>✅ <strong>有环 ≠ 混乱，而是赋予 Agent “反思能力”的基础设施。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">04｜技术实现：Y-Agent Studio 是怎么做到的？</h2>
<p>从代码结构看（参考其开源目录），Y-Agent Studio 通过以下机制支撑有向有环图：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── nodes/
│   ├── base_node.py        <span class="hljs-comment"># 基类定义 run_times, virtual_run_times</span>
│   ├── loop_start_node.py  <span class="hljs-comment"># 循环入口节点</span>
│   ├── loop_node.py        <span class="hljs-comment"># 循环控制节点</span>
│   └── ...
└── working/
    └── workflow_engine.py  <span class="hljs-comment"># 执行引擎支持环检测 + 循环计数</span>
</code></pre>
<p>核心设计亮点：</p>
<ul>
<li><strong>虚拟执行计数（virtual_run_times）</strong> ：用于依赖解析阶段预判执行路径，避免因多前驱节点导致重复触发（见下图）。</li>
<li><strong>父循环上下文（parent_loop_node_id + loop_context）</strong> ：确保嵌套循环也能正确隔离状态。</li>
<li><strong>执行引擎内置环检测 + 安全熔断</strong>：即使用户配置了环，也会在超限时自动终止，保障系统稳定性。</li>
</ul>
<blockquote>
<p>📌 举个例子：A → C，B → C。若 A 和 B 同时完成，传统系统可能触发 C 两次。Y-Agent 通过 <code>virtual_run_times</code> 计算“逻辑触发次数”，确保 C 只执行一次——<strong>这是支持有环的前提保障</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">05｜实际价值：你的 Agent 终于能“像人一样工作”了</h2>
<p>有了有向有环图，Y-Agent Studio 能轻松实现以下场景：</p>






























<table><thead><tr><th>场景</th><th>传统 DAG 实现方式</th><th>Y-Agent Studio 方式</th></tr></thead><tbody><tr><td>自动修复代码</td><td>手动添加 3 个“重试节点”</td><td>一个循环节点 + 条件判断</td></tr><tr><td>多轮用户交互</td><td>用外部状态机模拟</td><td>内置 loop + context 传递</td></tr><tr><td>动态知识检索</td><td>一次性检索</td><td>“检索 → 评估相关性 → 不足则再检索”</td></tr><tr><td>智能测试生成</td><td>固定流程</td><td>“生成测试 → 运行 → 覆盖率不足 → 补充”</td></tr></tbody></table>
<p><strong>这不仅是技术升级，更是范式转变</strong>：从“执行指令”到“自主推理”。</p>
<hr/>
<h2 data-id="heading-8">结语：打破“无环”迷信，拥抱更真实的智能</h2>
<p>DAG 曾是工作流的黄金标准，但在 AI Agent 时代，它正在成为一种<strong>不必要的枷锁</strong>。Y-Agent Studio 敢于引入有向有环图，并通过严谨的工程设计规避风险，这背后是对“智能体应具备类人思维”的深刻理解。</p>
<p>如果你也在构建复杂的 Agent 应用，不妨试试 Y-Agent Studio——或许你会发现，<strong>真正的智能，从来都不是一条直线</strong>。</p>
<blockquote>
<p>🔗 项目地址：[(<a href="https://link.juejin.cn?target=https%3A%2F%2Fy-agent.cn%2Fdocs" target="_blank" title="https://y-agent.cn/docs" ref="nofollow noopener noreferrer">y-agent.cn/docs</a>)]<br/>
👋 欢迎在评论区讨论：你觉得 Agent 还需要哪些“非 DAG”能力？</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案]]></title>    <link>https://juejin.cn/post/7574848503730765870</link>    <guid>https://juejin.cn/post/7574848503730765870</guid>    <pubDate>2025-11-21T08:00:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574848503730765870" data-draft-id="7574817463448387635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T08:00:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:00:25.000Z" title="Fri Nov 21 2025 08:00:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，<strong>iOS APP 抓包</strong>是最常见、也最容易遇到困难的调试环节。无论是接口联调、线上问题排查、性能分析，还是验证 SDK 行为，抓包一直是最直接、最高效的分析方式。但当涉及到 iOS 的安全体系（ATS、证书链、pinning）与多协议混合环境（HTTPS + QUIC + TCP/UDP）时，抓包的难度会成倍提升。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 iOS APP 抓包比想象中更复杂？</h2>
<p>工程师在抓取 iOS 流量时，最常踩到的坑来自以下五类：</p>
<h3 data-id="heading-1"><strong>HTTPS 证书链限制严格</strong></h3>
<ul>
<li>根证书不信任</li>
<li>中间证书缺失</li>
<li>Wi-Fi 网关替换证书</li>
</ul>
<p>表现：代理工具只能看到 CONNECT。</p>
<hr/>
<h3 data-id="heading-2"><strong>APP 自带证书 Pinning</strong></h3>
<p>这是“抓不到包”的头号难题。</p>
<p>表现特征：</p>
<ul>
<li>Safari 能抓</li>
<li>APP 完全抓不到</li>
<li>抓包工具界面没有任何请求</li>
</ul>
<p>pinning 会直接拒绝代理证书。</p>
<hr/>
<h3 data-id="heading-3"><strong>HTTP/3 / QUIC 绕过系统代理</strong></h3>
<p>QUIC 使用 UDP，所以代理工具无能为力。</p>
<p>表现：</p>
<ul>
<li>部分域名抓不到</li>
<li>切换网络后突然恢复</li>
</ul>
<hr/>
<h3 data-id="heading-4"><strong>APP 使用自定义协议或独立网络栈</strong></h3>
<p>例如：</p>
<ul>
<li>TCP 自定义协议</li>
<li>SDK 内部封装的二进制协议</li>
<li>WebSocket 长连接</li>
</ul>
<p>这些都不会走代理抓包。</p>
<hr/>
<h3 data-id="heading-5"><strong>流量噪音过大，难以聚焦单个 APP</strong></h3>
<p>尤其在调试手机 APP 时，系统和后台进程会产生大量无关流量。</p>
<hr/>
<h2 data-id="heading-6">二、iOS APP 抓包工具矩阵（按用途分层，非优劣比较）</h2>
<p>为了覆盖所有抓包场景，我们必须用“分层工具链”策略。</p>
<hr/>
<h3 data-id="heading-7"><strong>代理抓包（最常见的软件层方式）</strong></h3>
<p>工具包括：</p>
<ul>
<li>Charles</li>
<li>Proxyman</li>
<li>Fiddler</li>
<li>mitmproxy（开源）</li>
</ul>
<p>适合：</p>
<ul>
<li>查看 HTTPS 明文</li>
<li>调试接口</li>
<li>修改请求 / 响应</li>
<li>模拟错误场景</li>
</ul>
<p>局限：</p>
<ul>
<li>pinning 会阻断</li>
<li>QUIC 无法抓</li>
<li>自定义协议不支持</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>底层抓包（TCP/TLS 分析）</strong></h3>
<p>代表：</p>
<ul>
<li>tcpdump</li>
<li>Wireshark</li>
</ul>
<p>适合：</p>
<ul>
<li>分析 TLS 握手失败</li>
<li>三次握手、重传、RTT</li>
<li>判断流量是否到达服务器</li>
</ul>
<p>这是定位“为什么抓不到”的关键步骤。</p>
<hr/>
<h3 data-id="heading-9"><strong>脚本式抓包与协议自动化分析</strong></h3>
<p>例如：</p>
<ul>
<li>pyshark</li>
<li>scapy</li>
<li>mitmproxy 脚本</li>
</ul>
<p>适合批量分析或 CI 使用。</p>
<hr/>
<h3 data-id="heading-10"><strong>代理失效的补抓工具：抓包大师（Sniffmaster）</strong></h3>
<p>这类工具补充代理无法处理的部分，其技术能力覆盖代理抓不到的情境，包括：</p>
<ul>
<li>抓取 <strong>HTTPS / HTTP / TCP / UDP</strong> 流量</li>
<li>按 <strong>App / 域名过滤</strong>，降低噪音</li>
<li>自动识别 HTTP、HTTPS、mdns、自定义协议</li>
<li>查看数据流（十六进制 / 文本 / 二进制）</li>
<li>导出 <strong>Wireshark 兼容 pcap</strong></li>
<li>可使用 JavaScript 进行拦截、修改请求与响应</li>
<li>跨系统支持（macOS / Windows / iOS）</li>
</ul>
<p>适合用于：</p>
<ul>
<li>pinning 阻断</li>
<li>QUIC / HTTP3</li>
<li>自定义协议</li>
<li>不走系统代理的请求</li>
<li>TCP 数据流分析</li>
</ul>
<p>其定位不是取代理而代之，而是补充代理失败时不可或缺的抓包能力。</p>
<hr/>
<h2 data-id="heading-11">三、iOS APP 抓包的标准化流程（团队可复用）</h2>
<hr/>
<h3 data-id="heading-12"><strong>① 优先尝试代理工具抓包</strong></h3>
<p>配置：</p>
<ul>
<li>Wi-Fi 代理</li>
<li>安装并信任证书</li>
<li>开启 SSL Proxy</li>
</ul>
<p>若能抓 → 使用代理继续调试即可。</p>
<hr/>
<h3 data-id="heading-13"><strong>② 若只能看到 CONNECT → 证书链问题</strong></h3>
<p>排查：</p>
<ul>
<li>Wi-Fi 是否替换证书</li>
<li>中间证书是否缺失</li>
<li>APP 是否做了证书校验</li>
</ul>
<hr/>
<h3 data-id="heading-14"><strong>③ 若 Safari 能抓而 APP 完全抓不到 → pinning</strong></h3>
<p>此时无需尝试更多代理工具，进入补抓流程。</p>
<hr/>
<h3 data-id="heading-15"><strong>④ 若部分流量抓不到 → QUIC（HTTP/3）导致</strong></h3>
<p>判断方法：</p>
<ul>
<li>强制关闭 HTTP/3</li>
<li>或更换 4G/5G 网络</li>
</ul>
<p>若恢复 → 即为 QUIC 场景。</p>
<hr/>
<h3 data-id="heading-16"><strong>⑤ 使用 Sniffmaster 抓底层流量</strong></h3>
<p>流程示例：</p>
<ol>
<li>选择目标 APP 或域名</li>
<li>记录 HTTPS / TCP 数据流</li>
<li>导出 pcap 文件</li>
<li>使用 Wireshark 分析：
<ul>
<li>TLS 握手</li>
<li>证书链</li>
<li>QUIC 或 UDP 流</li>
<li>重传和丢包情况</li>
</ul>
</li>
<li>与服务器 tcpdump 对照确认请求是否到达</li>
</ol>
<p>这是目前定位 HTTPS 抓包失败最稳妥的方法。</p>
<hr/>
<h3 data-id="heading-17"><strong>⑥ 若能解密数据，再用代理工具分析业务逻辑</strong></h3>
<p>查看：</p>
<ul>
<li>header</li>
<li>token</li>
<li>body</li>
<li>状态码</li>
<li>错误响应</li>
</ul>
<p>完成最终业务验证。</p>
<hr/>
<h2 data-id="heading-18">四、工程实战案例：iOS APP 接口时好时坏</h2>
<p>某团队遇到问题：</p>
<ul>
<li>部分接口抓不到包</li>
<li>APP 偶尔提示网络异常</li>
<li>Charles 抓不到 HTTPS</li>
</ul>
<p>排查流程：</p>
<ol>
<li>切换 Wi-Fi 仍失败 → 排除网络代理</li>
<li>Safari 能抓 → 排除系统证书问题</li>
<li>使用 Sniffmaster 抓包 → 显示 TLS Alert</li>
<li>Wireshark 分析后确认：
<ul>
<li>中间证书签发链不完整</li>
</ul>
</li>
<li>修复服务器证书后问题解决</li>
</ol>
<p>这种问题完全依赖代理无法定位。</p>
<hr/>
<h2 data-id="heading-19">iOS APP 抓包可以多工具分层 + 多场景覆盖</h2>
<p>抓包困难的根源来自：</p>
<ul>
<li>TLS 安全策略</li>
<li>pinning</li>
<li>QUIC</li>
<li>自定义协议</li>
<li>多进程噪音</li>
</ul>
<p>因此完整方案必须包括：</p>

























<table><thead><tr><th>工具类别</th><th>对应场景</th></tr></thead><tbody><tr><td>代理抓包</td><td>HTTPS 调试、查看请求内容</td></tr><tr><td>TCP/TLS 抓包</td><td>握手失败、链路诊断</td></tr><tr><td>自动分析脚本</td><td>批量抓包、CI 调试</td></tr><tr><td>Sniffmaster</td><td>pinning/QUIC/自定义协议等代理失败场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践]]></title>    <link>https://juejin.cn/post/7574869203448676352</link>    <guid>https://juejin.cn/post/7574869203448676352</guid>    <pubDate>2025-11-21T07:59:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574869203448676352" data-draft-id="7574869203448610816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-21T07:59:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:59:03.000Z" title="Fri Nov 21 2025 07:59:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读41分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d5cd28ac30241149883ff8aacb2ec73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=m%2Bgi6uKvje%2FKrqKTeqniu3Vyqs8%3D" alt="0.png" loading="lazy"/></p>
<p>想象一下这样的场景：</p>
<p>个人助手场景：当你的 AI 助手能够记住你三个月前提到”不喜欢吃辣”这个细节，在今天推荐餐厅时自动筛选掉川菜和湘菜；或者它记得你上周提到的重要会议，主动在会前提醒 你准备相关材料。</p>
<p>企业服务场景：客户致电咨询时，AI 客服立即调取该客户的完整交互历史——从半年前 的产品咨询，到上个月的技术支持，再到最近的投诉处理，为客户提供连贯一致的个性化 服务体验，而不是每次都要重新解释问题背景。</p>
<p>这就是记忆增强型 AI 的魅力所在——它让 AI 从”健忘的工具”升级为”贴心的伙伴”。</p>
<p>本文将深入探讨如何通过 Mem0 智能记忆框架与亚马逊云科技服务生态的深度集成，构建 真正的生产级记忆增强型 AI 系统。我们不仅会分析记忆机制的技术原理，更会展示如何 利用 Aurora Serverless、Bedrock、Neptune 等云原生服务，实现从概念验证到企业级部 署的完整解决方案。</p>
<p>记忆对于 <strong>Agentic AI</strong> 应用的重要性</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejinhead_0606%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0606" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejinhead_0606&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0606" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h4 data-id="heading-0">记忆缺失：当前 AI 系统的根本局限</h4>
<p>传统的大语言模型受限于固定的上下文窗口，就像患有”失忆症”的助手，无法在跨会话的长期对话中保持一致性和连贯性。每次对话都是全新的开始，用户不得不反复解释自己的偏好和背景。</p>
<p>这种记忆缺失会引发典型问题：遗忘用户偏好、重复询问已知信息、甚至推翻之前确认的事实。例如，在饮食推荐场景中，用户明确表示不喜欢某类食物，但系统在后续交互中仍会推荐相同类型的食物，这一常见情况从根本上损害了用户体验并破坏了用户信任。</p>
<p>为了解决记忆问题，业界尝试通过扩大上下文窗口来缓解，但这种方法存在根本性局限：1）持续的人机交互必然导致对话历史超出任何固定窗口限制。2）人类能够动态整合新信息并修正过时认知，而LLM只能通过完全重置来更新知识。3）真实对话缺乏主题连贯性——用户可能从讨论食物偏好跳转到工作任务，再回到晚餐选择，迫使系统在大量无关信息中寻找相关线索。4）更关键的是，仅仅提供更长上下文无法保证有效信息检索，因为注意力机制对远距离token的处理能力会显著退化，导致真正有价值的信息被噪声淹没。</p>
<h4 data-id="heading-1">人类记忆的启示</h4>
<p>人类记忆是智能的根基，它不仅定义了我们的身份，更是明智决策、持续学习和建立深度关系的基础。人类能够回忆过往互动，推断他人偏好，并构建与交往对象不断演化的心理模型。理想的AI记忆框架应当模拟这种动态、适应性的记忆机制，实现从简单存储到智能管理的根本转变。</p>
<p>记忆增强型Agent的突破</p>
<p>真正的解决方案在于构建具备记忆能力的智能体。这类Agent能够突破传统LLM的局限，在交互环境中实现质的飞跃。</p>
<p>核心能力提升体现在四个方面：</p>
<ul>
<li>个性化预测能力。通过记住用户历史行为和偏好，Agent能够更准确地预测客户需求，提供真正个性化的服务体验。</li>
<li>经验学习能力。系统能够从过往错误中学习，建立经验库以避免重复失误，并将在特定任务中获得的知识有效泛化到其他相关场景。</li>
<li>因果推理能力。记忆功能使Agent能够理解行动与结果之间的因果关系，基于深层逻辑进行决策优化，在动态变化的环境中实现更有效的适应。</li>
<li>长期规划能力。跨会话的记忆连续性确保了多轮对话中的推理一致性，使Agent从简单的被动响应升级为具备长期规划能力的智能系统。</li>
</ul>
<p>在医疗诊断、个性化教育、企业客户支持等对历史信息依赖性强的关键领域，这种记忆增强能力的价值更加凸显。</p>
<h3 data-id="heading-2">Mem0框架：构建生产级记忆增强型AI Agent</h3>
<h4 data-id="heading-3">Mem0框架概述</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmem0.ai%2F" target="_blank" title="https://mem0.ai/" ref="nofollow noopener noreferrer">Mem0</a> 是一个专为现代 AI Agent 设计的智能记忆层，它使AI Agent能够记住过去的交互、存储重要的用户偏好和事实背景，并从成功和失败中学习。通过与Mem0集成，Agent从无状态转变为有状态，能够保持上下文、回忆重要信息，并随着时间推移表现得更加智能。</p>
<p>与传统的简单数据存储不同，Mem0专注于智能记忆管理，支持多种记忆类型：工作记忆（临时对话上下文）、事实记忆（客观信息）、情景记忆（具体事件）和语义记忆（概念知识），并提供智能的LLM提取、过滤和衰减机制，有效降低计算成本。系统不仅支持多模态（文本和图像），还提供Graph记忆功能来连接跨会话的见解和实体。作为一个既可以使用托管服务也可以自建的解决方案，Mem0让AI Agent能够建立持久的记忆，从而提供更个性化和适应性更强的服务。</p>
<h4 data-id="heading-4">技术架构设计</h4>
<p>Mem0采用分层设计理念，通过六个核心模块的协同工作，实现智能记忆管理的完整闭环。<br/>
分层架构的设计优势在于各层职责清晰、可独立优化。核心记忆层作为控制中枢，统筹记忆的CRUD操作；大语言模型层提供智能决策能力，负责信息提取和更新策略生成；嵌入模型层将自然语言转换为机器可理解的向量表示；向量存储层基于语义相似性实现高效检索；图存储层构建实体关系网络，支持复杂推理；持久化存储层确保元数据和操作历史的可靠保存。<br/>
这种架构设计既保证了系统的模块化和可扩展性，又通过层间的紧密协作实现了智能记忆管理的核心目标。</p>
<h4 data-id="heading-5">核心技术创新</h4>
<p>Mem0的技术创新体现在四个关键方面，这些创新共同构成了其智能记忆管理的核心竞争力。<br/>
双LLM架构是其最重要的创新之一。系统通过两次不同的LLM调用实现复杂的分工：第一次专注于信息提取，第二次专门处理决策过程。这种关注点分离不仅提高了准确性和可靠性，还允许对各阶段进行专门优化，避免了单一模型处理复杂任务时的性能瓶颈。<br/>
上下文感知处理确保了记忆系统的一致性。Mem0不是孤立处理信息，而是在现有记忆的上下文中分析新数据，防止碎片化并维护相关信息间的逻辑关系。<br/>
智能去重机制通过向量相似性搜索与基于LLM判断的结合，创建了强大的去重能力，既防止了冗余信息存储，又保持了记忆质量和系统效率。<br/>
冲突解决能力使系统能够智能处理矛盾信息，在用户偏好和环境随时间演变时维护记忆准确性，这是传统存储系统难以实现的高级功能。</p>
<h3 data-id="heading-6">记忆操作机制</h3>
<p>Mem0的核心价值在于智能化的记忆管理。系统封装了记忆添加、检索、更新和删除四大核心操作，其中添加和检索是关键环节。</p>
<h4 data-id="heading-7">智能记忆添加流程</h4>
<p>Mem0对于记忆的添加流程如下图所示。（图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.mem0.ai%2Fcore-concepts%2Fmemory-operations%2Fadd" target="_blank" title="https://docs.mem0.ai/core-concepts/memory-operations/add" ref="nofollow noopener noreferrer">Mem0官方文档</a>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b3527dc824445fd8c0818d2fabbef9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=xoMhTcgBsaehBBxAkpgRshmInrU%3D" alt="1.png" loading="lazy"/></p>
<p>Mem0的记忆添加过程体现了从自然语言到结构化知识的智能转换，分为三个关键阶段：</p>
<ul>
<li>信息提取阶段：系统通过LLM和专门提示词进行深度语义分析，从”我和John在星巴克讨论AI项目”中提取工作关系、场所偏好、兴趣领域等多维信息。</li>
<li>上下文检索阶段：融合向量相似性搜索、图谱关系检索和上下文关联分析，在严格用户隔离的前提下，确保新信息与历史记忆的有机关联。</li>
<li>智能决策阶段：通过第二次LLM调用，智能决定ADD、UPDATE、DELETE或NONE操作，维护记忆库的质量和一致性。</li>
</ul>
<h4 data-id="heading-8">高效记忆检索流程</h4>
<p>Mem0对于记忆的检索流程如下图所示。（图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.mem0.ai%2Fcore-concepts%2Fmemory-operations%2Fsearch" target="_blank" title="https://docs.mem0.ai/core-concepts/memory-operations/search" ref="nofollow noopener noreferrer">Mem0官方文档</a>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab576d235f8542529fe0e94726a5b75a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=RuBriWFpHoBbr%2BCXRw%2BDOp7mFs0%3D" alt="2.png" loading="lazy"/></p>
<p>检索流程采用查询预处理、并行化搜索、结果整合三阶段设计，通过向量语义搜索和图谱关系搜索的并行执行，实现高效准确的记忆检索。</p>
<p>通过这种精心设计的双流程架构，Mem0为构建生产级记忆增强型AI Agent提供了坚实的技术基础。</p>
<h3 data-id="heading-9">Mem0与Agent框架的集成</h3>
<p>在实际应用中，开发者可以通过两种方式将Mem0集成到Agent系统中：一是在环境变量配置依赖信息后，直接调用Mem0的接口函数（如添加、查找、更新记忆等）；二是将Mem0封装成工具传入Agent框架，由Agent根据处理逻辑自主调用相应方法。</p>
<h4 data-id="heading-10">集成方式选择</h4>
<p>直接接口调用方式：开发者可以在配置好环境变量和依赖信息后，直接使用Mem0提供的接口函数。这种方式给予开发者完全的控制权，可以精确地决定何时添加记忆、何时检索记忆、如何更新记忆内容。适合对记忆管理有特定需求或需要与现有系统深度集成的场景。</p>
<p>工具封装方式：将Mem0封装成工具传入Agent框架，让Agent根据自身的处理逻辑自主决定何时调用相应的记忆方法。这种方式更加智能化，Agent可以根据对话上下文和用户需求自动判断是否需要存储新记忆或检索历史记忆，减少了人工干预的需要。</p>
<h4 data-id="heading-11">框架选择策略</h4>
<p>使用支持Mem0的Agent框架：对于希望快速构建记忆增强型Agent的开发者，可以选择支持Mem0的现有Agent框架。这些框架通常内置了专门的记忆管理工具集，封装了完整的Mem0能力，具有开箱即用、集成最佳实践、适合快速原型开发等优势。</p>
<p>自定义Agent框架集成：对于需要更高灵活性和定制化的场景，开发者可以在自己的Agent框架中直接集成Mem0。通过配置化的方式，可以直接指定相应的LLM、Embedding模型以及向量数据库等组件，创建定制化的Mem0实例。</p>
<h4 data-id="heading-12">基础集成示例</h4>
<p>以下是直接接口调用的基本示例：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> mem0 <span class="hljs-keyword">import</span> Memory

config = {
   <span class="hljs-string">"llm"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,
           <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.2</span>,
           <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
       }
   },
   <span class="hljs-string">"embedder"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"model"</span>: <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>
       }
   },
   <span class="hljs-string">"vector_store"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"user"</span>: <span class="hljs-string">"$DB_USER"</span>,
           <span class="hljs-string">"password"</span>: <span class="hljs-string">"$DB_PASSWORD"</span>,
           <span class="hljs-string">"host"</span>: <span class="hljs-string">"$DB_HOST"</span>,
           <span class="hljs-string">"port"</span>: <span class="hljs-string">"$DB_PORT"</span>,
           <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
           <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
       }
   },
   <span class="hljs-string">"graph_store"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"neptune"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"neptune-graph://gXXXXXX"</span>
       }
   }
}

<span class="hljs-comment"># 创建 Memory 实例并使用</span>
memory = Memory.from_config(config)
memory.add(<span class="hljs-string">"I love sci-fi movies"</span>, user_id=<span class="hljs-string">"user123"</span>)
relevant_memories = memory.search(<span class="hljs-string">"movie preferences"</span>, user_id=<span class="hljs-string">"user123"</span>)
</code></pre>
<p>通过灵活的集成策略，开发者可以根据具体需求选择最适合的实现方式。然而，要实现企业级的生产部署，仅仅有Mem0框架是不够的，还需要充分利用云服务提供商的基础设施优势。</p>
<p>接下来，我们将深入探讨如何将Mem0与亚马逊云科技的服务生态进行深度集成，利用Aurora Serverless、Bedrock、Neptune等云原生服务，构建真正的生产级记忆增强型AI系统。</p>
<h3 data-id="heading-13">亚马逊云科技与Mem0的深度集成</h3>
<p>亚马逊云科技为Mem0提供了完整的服务生态支持，开发者可以根据具体需求选择最适合的亚马逊云科技服务组合。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0019596cf7d940eda20b447b9f2efa7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=RA7qNO7vnra1r0Dy8XO9HyrAnwY%3D" alt="3.png" loading="lazy"/></p>
<p>如上图所示，完整的解决方案采用分层架构设计，从上到下包含四个核心层次：</p>
<ul>
<li>用户应用层：StrandsAgent、LangGraph等开发框架，提供多样化的Agent构建方式</li>
<li>Mem0智能记忆层：核心记忆管理引擎，协调信息提取、智能决策、记忆检索和生命周期管理。</li>
<li>亚马逊云科技托管服务层：Amazon Bedrock提供AI能力，Aurora Serverless提供向量存储，Neptune Analytics提供图存储</li>
<li>安全与管理层：IAM、KMS、VPC等服务确保企业级安全保障</li>
</ul>
<p>这种云原生架构的核心优势在于弹性伸缩、按需付费和全托管服务，让开发者专注于业务逻辑而非基础设施管理。下面我们按照数据流向，深入探讨各层的技术特点和集成优势。</p>
<h3 data-id="heading-14">AI能力层：Amazon Bedrock</h3>
<p>作为整个架构的”智能大脑”，Amazon Bedrock为Mem0的双LLM架构提供强大的AI推理能力，承担信息提取、智能决策和语义理解的核心任务。</p>
<h4 data-id="heading-15">丰富的模型生态选择</h4>
<p>Amazon Bedrock作为托管基础模型服务，为Mem0提供了业界丰富的模型选择，包括Anthropic的Claude系列、Amazon的Nova系列、Meta的Llama系列、Cohere的Command系列，以及AI21 Labs的Jurassic系列等。</p>
<p>这种多模型支持使得开发者可以根据具体的应用场景、性能要求和成本预算选择最适合的模型组合：</p>
<ul>
<li>LLM模型选择：Amazon Nova系列作为亚马逊云科技自研的多模态大模型，在文本、图像等多模态理解和生成方面表现优异；Claude系列在复杂推理任务中表现卓越；Llama和Command系列则为成本敏感的应用提供高性价比选择。</li>
<li>嵌入模型选择：Titan Embed系列提供高质量的文本嵌入能力，支持长文本处理和多模态记忆功能；Cohere嵌入模型则在多语言场景中表现优异</li>
</ul>
<h4 data-id="heading-16">企业级安全与合规</h4>
<p>Bedrock提供企业级的安全保障，所有模型调用都在亚马逊云科技安全边界内进行，数据传输采用TLS加密，静态数据通过KMS加密。与IAM深度集成，支持细粒度的访问控制和审计日志，满足金融、医疗等行业的合规要求。</p>
<h4 data-id="heading-17">统一API与智能调度</h4>
<p>Bedrock的统一API设计简化了多模型管理，支持无服务器部署和按需付费。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># Bedrock多模型配置示例 - 针对Mem0优化的生产配置</span>
bedrock_config = {
    <span class="hljs-string">"llm"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,<span class="hljs-comment"># 信息提取和决策</span>
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
            <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">4000</span>,
            <span class="hljs-string">"top_p"</span>: <span class="hljs-number">0.9</span>
        }
    },
    <span class="hljs-string">"embedder"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>,  <span class="hljs-comment"># 向量化记忆内容</span>
            <span class="hljs-string">"normalize"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"dimensions"</span>: <span class="hljs-number">1024</span>
        }
    }
}
</code></pre>
<p>通过Bedrock丰富的模型生态和统一的API管理，Mem0能够实现真正智能的记忆管理，从简单的信息存储升级为具备理解、推理和决策能力的认知系统。</p>
<h3 data-id="heading-18">存储层：Aurora Serverless + Neptune Analytics</h3>
<p>作为Mem0记忆系统的数据基础，Aurora Serverless和Neptune Analytics构成了完整的存储解决方案：Aurora负责向量化记忆的高效存储和检索，Neptune负责实体关系的图谱管理和推理，两者协同工作为记忆增强型AI提供强大的数据支撑。</p>
<h4 data-id="heading-19">向量存储：Amazon Aurora Serverless for PostgreSQL</h4>
<p>Aurora Serverless for PostgreSQL凭借pgvector插件的原生向量支持、标准SQL接口和活跃社区生态，为Mem0提供了理想的向量存储基础。</p>
<p><strong>核心技术优势</strong></p>
<ul>
<li>原生向量能力：pgvector插件支持欧几里得距离、余弦相似度和内积计算等核心向量操作，完美匹配记忆检索需求</li>
<li>弹性伸缩架构：Aurora Serverless能够根据负载自动调整计算资源，支持从0到256TiB的存储自动扩展，实现真正的按需付费</li>
<li>企业级可靠性：AZ+1级别的可用性保证，即使在一个可用区和一个额外故障发生时仍能对外提供服务，确保珍贵记忆数据的安全</li>
<li>全球化部署能力：Aurora Global Database为需要全球部署的记忆增强型Agent应用提供关键支持。主区域的记忆数据可以在1秒内复制到最多10个次要区域，确保全球用户都能快速访问及时更新的记忆。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># Aurora Serverless配置示例</span>
aurora_config = {
    <span class="hljs-string">"vector_store"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"host"</span>: <span class="hljs-string">"aurora-serverless-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>,
            <span class="hljs-string">"port"</span>: <span class="hljs-number">5432</span>,
            <span class="hljs-string">"database"</span>: <span class="hljs-string">"mem0_db"</span>,
            <span class="hljs-string">"user"</span>: <span class="hljs-string">"mem0_user"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>,
            <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-number">1024</span>,
            <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
            <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-20">图存储：Amazon Neptune Analytics</h4>
<p>Neptune Analytics作为Serverless图分析服务，与Mem0实现深度集成，为记忆增强型AI提供强大的图存储和关系推理能力。</p>
<p><strong>核心技术优势</strong></p>
<ul>
<li>Serverless弹性架构：根据查询复杂度和数据量自动调整计算资源，采用智能内存管理策略，支持大规模图遍历操作和并行处理</li>
<li>深度集成优势：与Mem0原生集成，系统能够自动从对话中提取实体和关系，构建知识图谱，通过多跳图推理显著提升AI响应质量</li>
<li>混合检索能力：支持在图遍历中集成向量相似性搜索，为记忆系统提供强大的关联分析能力</li>
<li>企业级安全保障：与IAM深度集成提供细粒度访问控制，支持身份基础策略和临时凭证，API调用采用TLS 1.2+加密传输。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"> <span class="hljs-comment">#Neptune Analytics配置示例</span>
neptune_config = {
    <span class="hljs-string">"graph_store"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"neptune"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"neptune-graph://g-XXXXXX"</span>,
            <span class="hljs-string">"query_timeout"</span>: <span class="hljs-number">30000</span>,
            <span class="hljs-string">"max_results"</span>: <span class="hljs-number">1000</span>,
            <span class="hljs-string">"retry_config"</span>: {
                <span class="hljs-string">"max_attempts"</span>: <span class="hljs-number">3</span>,
                <span class="hljs-string">"backoff_multiplier"</span>: <span class="hljs-number">2</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-21">存储层协同优势</h4>
<p>通过Aurora和Neptune的协同工作，Mem0实现了完整的记忆数据管理：向量存储处理语义相似性检索，图存储处理实体关系推理，两者结合为AI Agent提供了既能理解语义又能推理关系的强大记忆能力。这种双存储架构不仅提高了检索精度，更重要的是为复杂的记忆场景提供了多维度的数据支撑。</p>
<h3 data-id="heading-22">应用开发层 – StrandsAgent + LangGraph</h3>
<p>在完整的存储基础之上，开发者可以通过多种框架构建记忆增强型Agent应用。StrandsAgent和LangGraph作为两种主流的开发框架，为不同的开发需求提供了灵活的集成方案。</p>
<h4 data-id="heading-23">StrandsAgent：工具化记忆集成</h4>
<p>StrandsAgent作为亚马逊云科技提供的Agent开发框架，原生集成了Mem0记忆管理功能。为了更好地支持不同客户的需求，我们对mem0_memory工具进行了两个增强：</p>
<ul>
<li>向量数据库扩展：原始框架主要支持OpenSearch作为向量存储后端，我们新增了对Aurora PostgreSQL的原生支持，充分利用pgvector插件和Serverless架构的优势</li>
<li>多模型提供商支持：除了Amazon Bedrock外，还支持OpenAI兼容接口，比如DeepSeek等模型，通过STRANDS_MODEL_PROVIDER环境变量实现灵活切换，满足不同地区的部署需求，使得该方案不仅可在亚马逊云科技海外区域部署，同样也适用于北京和宁夏区域。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 核心改动：完整的增强实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mem0ServiceClient</span>:
<span class="hljs-comment"># 新增：Aurora PostgreSQL + Bedrock配置</span>
    PG_CONFIG_BEDROCK = {
        <span class="hljs-string">"embedder"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"EMBEDDING_MODEL"</span>, <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>)
            }
        },
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"LLM_MODEL"</span>, <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>),
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
            },
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"host"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>),
                <span class="hljs-string">"port"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PORT"</span>),
                <span class="hljs-string">"user"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_USER"</span>),
                <span class="hljs-string">"password"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>),
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
            }
        }
    }
    
<span class="hljs-comment"># 新增：OpenAI兼容 + PostgreSQL配置</span>
    PG_CONFIG_OPENAI = {
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"openai"</span>,  
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"LLM_MODEL"</span>),
                <span class="hljs-string">"api_key"</span>: os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>),
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
            }
        },
        <span class="hljs-string">"embedder"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"openai"</span>,  
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"EMBEDDING_MODEL"</span>),
                <span class="hljs-string">"api_key"</span>: os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>),
            }
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"host"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>),
                <span class="hljs-string">"port"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PORT"</span>),
                <span class="hljs-string">"user"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_USER"</span>),
                <span class="hljs-string">"dbname"</span>: os.environ.get(<span class="hljs-string">"DB_NAME"</span>),
                <span class="hljs-string">"password"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>),
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
            }
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_client</span>(<span class="hljs-params">self, config: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""增强的客户端初始化逻辑"""</span>
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"MEM0_API_KEY"</span>):
            <span class="hljs-keyword">return</span> MemoryClient()

        <span class="hljs-comment"># 新增：PostgreSQL后端支持</span>
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>):
            logger.info(<span class="hljs-string">"Using PostgreSQL backend with Aurora Serverless"</span>)
            <span class="hljs-keyword">return</span> self._initialize_postgresql_client(config)

        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"OPENSEARCH_HOST"</span>):
            logger.info(<span class="hljs-string">"Using OpenSearch backend"</span>)
            <span class="hljs-keyword">return</span> self._initialize_opensearch_client(config)

        <span class="hljs-keyword">return</span> self._initialize_faiss_client(config)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_postgresql_client</span>(<span class="hljs-params">self, config: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; Mem0Memory:
        <span class="hljs-string">"""新增：根据模型提供商选择相应配置"""</span>
        pg_config = (self.PG_CONFIG_BEDROCK
                    <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">'STRANDS_MODEL_PROVIDER'</span>) == <span class="hljs-string">"bedrock"</span>
                    <span class="hljs-keyword">else</span> self.PG_CONFIG_OPENAI)
        merged_config = self._merge_config(pg_config.copy())
        <span class="hljs-keyword">return</span> Mem0Memory.from_config(config_dict=merged_config)
</code></pre>
<p>使用方式</p>
<p>增强后的工具使用方式保持不变，但现在支持更多的部署选项：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> strands <span class="hljs-keyword">import</span> Agent
<span class="hljs-keyword">from</span> strands_tools <span class="hljs-keyword">import</span> mem0_memory

<span class="hljs-comment"># 场景1：Aurora PostgreSQL + Amazon Bedrock上的模型</span>
os.environ[<span class="hljs-string">"STRANDS_MODEL_PROVIDER"</span>] = <span class="hljs-string">"bedrock"</span>
os.environ[<span class="hljs-string">"LLM_MODEL"</span>] = <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>
os.environ[<span class="hljs-string">"EMBEDDING_MODEL"</span>] = <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>

<span class="hljs-comment"># 场景2：Aurora PostgreSQL + OpenAI兼容的模型</span>
<span class="hljs-comment"># os.environ["STRANDS_MODEL_PROVIDER"] = "openai"</span>
<span class="hljs-comment"># os.environ["LLM_MODEL"] = " deepseek-ai/DeepSeek-R1/wvvkzheh2i"</span>
<span class="hljs-comment"># os.environ["EMBEDDING_MODEL"] = "Pro/BAAI/bge-m3"</span>
<span class="hljs-comment"># os.environ["OPENAI_API_KEY"] = "your-api-key"</span>

<span class="hljs-comment"># PostgreSQL配置（通用）</span>
os.environ[<span class="hljs-string">"POSTGRESQL_HOST"</span>] = <span class="hljs-string">"aurora-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>
os.environ[<span class="hljs-string">"POSTGRESQL_USER"</span>] = <span class="hljs-string">"mem0_user"</span>
os.environ[<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>] = <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>
os.environ[<span class="hljs-string">"DB_NAME"</span>] = <span class="hljs-string">"mem0_db"</span>

<span class="hljs-comment"># 创建Agent，Agent后续会根据tool的定义，按需调用记忆增加、检索等接口</span>
agent = Agent(tools=[mem0_memory])
</code></pre>
<p>技术优势</p>
<p>这些增强带来的核心价值：</p>
<ul>
<li>存储优化：Aurora PostgreSQL的Serverless架构和成本效益</li>
<li>全球部署：支持不同地区的模型提供商和合规需求</li>
<li>开发友好：保持API兼容性，通过环境变量实现灵活配置</li>
<li>生态整合：与亚马逊云科技服务深度集成，简化运维管理</li>
</ul>
<h4 data-id="heading-24">LangGraph：状态驱动的记忆工作流</h4>
<p>LangGraph作为专门用于构建有状态、多智能体协作的编程框架，与Mem0的结合为构建具备长短期记忆的智能Agent提供了强大支撑。</p>
<p><strong>核心集成优势</strong></p>
<ul>
<li>状态管理：LangGraph的状态管理机制与Mem0的记忆系统完美结合，实现跨会话的记忆连续性</li>
<li>工作流编排：通过节点和边的设计，可以精确控制记忆的检索、处理和存储时机</li>
<li>弹性架构集成：与Aurora Serverless深度集成，实现云原生的弹性记忆管理</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># LangGraph工作流示例 - 记忆驱动的对话流程</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END

<span class="hljs-comment"># 定义记忆增强的工作流</span>
workflow = StateGraph(State)
workflow.add_node(<span class="hljs-string">"memory_retrieval"</span>, memory_search_node)
workflow.add_node(<span class="hljs-string">"agent_processing"</span>, memory_enhanced_chatbot)
workflow.add_node(<span class="hljs-string">"memory_storage"</span>, memory_save_node)

<span class="hljs-comment"># 记忆驱动的状态转换</span>
workflow.add_edge(START, <span class="hljs-string">"memory_retrieval"</span>)
workflow.add_edge(<span class="hljs-string">"memory_retrieval"</span>, <span class="hljs-string">"agent_processing"</span>)
workflow.add_edge(<span class="hljs-string">"agent_processing"</span>, <span class="hljs-string">"memory_storage"</span>)
workflow.add_edge(<span class="hljs-string">"memory_storage"</span>, END)

<span class="hljs-comment"># 编译并运行</span>
app = workflow.<span class="hljs-built_in">compile</span>()
result = app.invoke({<span class="hljs-string">"query"</span>: <span class="hljs-string">"推荐一部电影"</span>, <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"alice"</span>})

<span class="hljs-comment"># 基于项目实际实现的最小化节点函数示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_enhanced_chatbot</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆增强的聊天机器人节点 - 基于项目中的响应生成节点"""</span>
    <span class="hljs-comment"># 获取用户输入和记忆上下文</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    recalled_memories = state.get(<span class="hljs-string">"recalled_memories"</span>, [])
    
    <span class="hljs-comment"># 生成记忆增强的响应</span>
    response = <span class="hljs-keyword">await</span> generate_response_with_memory(
        user_input=user_input,
        memories=recalled_memories,
        user_id=state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    )
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"final_response"</span>] = response
    state[<span class="hljs-string">"processing_complete"</span>] = <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_search_node</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆搜索节点 - 基于项目中的召回模型节点"""</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    user_id = state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    
    <span class="hljs-comment"># 使用Mem0搜索相关记忆</span>
    mem0 = get_mem0_instance()  <span class="hljs-comment"># 获取Mem0实例</span>
    search_results = mem0.search(user_input, user_id=user_id)
    
    <span class="hljs-comment"># 处理搜索结果</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(search_results, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"results"</span> <span class="hljs-keyword">in</span> search_results:
        memories = search_results[<span class="hljs-string">"results"</span>]
    <span class="hljs-keyword">else</span>:
        memories = search_results <span class="hljs-keyword">or</span> []
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"recalled_memories"</span>] = memories
    state[<span class="hljs-string">"memory_search_complete"</span>] = <span class="hljs-literal">True</span>
    
    logger.info(<span class="hljs-string">f"Retrieved <span class="hljs-subst">{<span class="hljs-built_in">len</span>(memories)}</span> memories for user <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_save_node</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆保存节点 - 基于项目中的最终化节点"""</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    final_response = state.get(<span class="hljs-string">"final_response"</span>, <span class="hljs-string">""</span>)
    user_id = state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    
    <span class="hljs-comment"># 保存用户输入到记忆</span>
    mem0 = get_mem0_instance()
    
    <span class="hljs-comment"># 构建记忆内容和元数据</span>
    memory_content = <span class="hljs-string">f"User said: <span class="hljs-subst">{user_input}</span>"</span>
    metadata = {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"user_input"</span>,
        <span class="hljs-string">"timestamp"</span>: datetime.now().isoformat(),
        <span class="hljs-string">"conversation_id"</span>: state.get(<span class="hljs-string">"conversation_id"</span>),
        <span class="hljs-string">"response_generated"</span>: <span class="hljs-built_in">bool</span>(final_response)
    }
    
    <span class="hljs-comment"># 添加到记忆系统</span>
    result = mem0.add(memory_content, user_id=user_id, metadata=metadata)
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"memory_saved"</span>] = <span class="hljs-literal">True</span>
    state[<span class="hljs-string">"memory_save_result"</span>] = result
    
    logger.info(<span class="hljs-string">f"Memory saved for user <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-keyword">return</span> state

<span class="hljs-comment"># 辅助函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_response_with_memory</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span>, memories: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>], user_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""基于记忆生成响应的辅助函数"""</span>
    <span class="hljs-comment"># 构建包含记忆上下文的提示</span>
    memory_context = <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> memories:
        memory_texts = [mem.get(<span class="hljs-string">"memory"</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> mem <span class="hljs-keyword">in</span> memories[:<span class="hljs-number">3</span>]]  <span class="hljs-comment"># 取前3个最相关的记忆</span>
        memory_context = <span class="hljs-string">f"相关记忆: <span class="hljs-subst">{<span class="hljs-string">'; '</span>.join(memory_texts)}</span>"</span>
    
    <span class="hljs-comment"># 这里可以调用LLM生成响应</span>
    <span class="hljs-comment"># 在实际项目中，这会调用Amazon Bedrock或其他LLM服务</span>
    response = <span class="hljs-string">f"基于记忆回复: <span class="hljs-subst">{memory_context}</span>\n用户问题: <span class="hljs-subst">{user_input}</span>"</span>
    
    <span class="hljs-keyword">return</span> response

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mem0_instance</span>():
    <span class="hljs-string">"""获取Mem0实例的辅助函数"""</span>
    <span class="hljs-comment"># 这里返回配置好的Mem0实例</span>
    <span class="hljs-comment"># 在实际项目中，这会从配置中初始化Mem0</span>
    <span class="hljs-keyword">from</span> mem0 <span class="hljs-keyword">import</span> Memory
    
    config = {
        <span class="hljs-string">"version"</span>: <span class="hljs-string">"v1.1"</span>,
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">1000</span>,
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.7</span>
            }
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"host"</span>: <span class="hljs-string">"aurora-serverless-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>,
                <span class="hljs-string">"port"</span>: <span class="hljs-number">5432</span>,
                <span class="hljs-string">"database"</span>: <span class="hljs-string">"mem0_db"</span>,
                <span class="hljs-string">"user"</span>: <span class="hljs-string">"mem0_user"</span>,
                <span class="hljs-string">"password"</span>: <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>,
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-number">1024</span>,
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>
            }
        }
    }
    
    <span class="hljs-keyword">return</span> Memory.from_config(config)
</code></pre>
<h4 data-id="heading-25">进一步思考：分层记忆管理</h4>
<p>基于认知科学的启发，我们可以基于Mem0实现分层记忆管理系统，模拟人类记忆的工作原理。系统将记忆按重要性分为工作记忆、短期记忆、长期记忆和核心记忆四个层级，实现智能的记忆资源管理。</p>
<p><strong>分层记忆设计理念</strong></p>
<ul>
<li>工作记忆层：存储当前对话的临时信息，具有最高访问速度但最短保存时间</li>
<li>短期记忆层：保存近期的用户偏好和行为模式，为个性化服务提供基础数据</li>
<li>长期记忆层：存储用户的稳定特征和重要历史信息，提供深度的用户理解能力</li>
<li>核心记忆层：保存用户的身份信息和最关键特征，几乎永久保存</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 分层记忆配置</span>
memory_config = {
   <span class="hljs-string">"importance_thresholds"</span>: {
       MemoryType.WORKING: <span class="hljs-number">1.0</span>,      <span class="hljs-comment"># 工作记忆重要性阈值</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">3.0</span>,   <span class="hljs-comment"># 短期记忆重要性阈值</span>
       MemoryType.LONG_TERM: <span class="hljs-number">5.0</span>,    <span class="hljs-comment"># 长期记忆重要性阈值</span>
       MemoryType.CORE: <span class="hljs-number">8.0</span>          <span class="hljs-comment"># 核心记忆重要性阈值</span>
   },
   <span class="hljs-string">"decay_rates"</span>: {
       MemoryType.WORKING: <span class="hljs-number">0.8</span>,      <span class="hljs-comment"># 高衰减率：快速遗忘临时信息</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">0.3</span>,   <span class="hljs-comment"># 中等衰减率：逐步淡化近期信息</span>
       MemoryType.LONG_TERM: <span class="hljs-number">0.05</span>,   <span class="hljs-comment"># 低衰减率：缓慢衰减长期信息</span>
       MemoryType.CORE: <span class="hljs-number">0.01</span>         <span class="hljs-comment"># 极低衰减率：几乎永久保存</span>
   },
   <span class="hljs-string">"max_age_hours"</span>: {
       MemoryType.WORKING: <span class="hljs-number">24</span>,       <span class="hljs-comment"># 工作记忆最大存活时间：1天</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">168</span>,   <span class="hljs-comment"># 短期记忆最大存活时间：1周</span>
       MemoryType.LONG_TERM: <span class="hljs-number">8760</span>,   <span class="hljs-comment"># 长期记忆最大存活时间：1年</span>
       MemoryType.CORE: <span class="hljs-built_in">float</span>(<span class="hljs-string">'inf'</span>) <span class="hljs-comment"># 核心记忆：永久保存</span>
   },
   <span class="hljs-string">"enable_automatic_promotion"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># 启用自动提升</span>
   <span class="hljs-string">"maintenance_interval_hours"</span>: <span class="hljs-number">6</span>      <span class="hljs-comment"># 维护间隔</span>
}
</code></pre>
<p>记忆提升工作流程</p>
<p>智能提升机制通过以下步骤自动管理记忆层级：</p>
<ol>
<li>初始评估阶段：新记忆通过LLM进行重要性评分，低于1.0阈值的信息被直接丢弃，确保只有有价值的信息进入记忆系统</li>
<li>工作记忆阶段：符合条件的记忆进入工作记忆层，系统开始监控访问频次和强化次数，为后续提升决策收集数据</li>
<li>短期记忆提升：当访问次数达到3次且被强化2次以上，同时存在时间超过1小时时，系统自动将记忆提升至短期记忆层</li>
<li>长期记忆提升：在短期记忆层停留24小时以上，且访问次数达到7次、重要性评分超过5.0时，记忆被提升至长期记忆层</li>
<li>核心记忆提升：长期记忆中的高频访问内容（15次以上）且重要性评分达到8.0时，提升至核心记忆层，获得几乎永久的保存</li>
<li>自然衰减机制：各层记忆根据不同的衰减率自然降低活跃度，长时间未访问的记忆会被自动清理，释放存储资源</li>
</ol>
<p>整个提升过程完全自动化，无需人工干预。系统会根据访问频次、重要性评分、强化次数和时间因素综合判断，确保重要信息得到适当的保存层级，同时让临时信息自然衰减。</p>
<h4 data-id="heading-26">开发框架选择指南</h4>
<ul>
<li>选择StrandsAgent：工具化集成方式，Agent自动决定记忆操作时机，适合快速开发和标准化场景</li>
<li>选择LangGraph：工作流编排方式，开发者精确控制记忆处理流程，适合复杂业务逻辑和定制化需求</li>
<li>直接API集成：完全自主控制，适合现有系统集成和特殊定制需求</li>
</ul>
<p>通过这些开发框架和高级特性的支持，开发者可以根据具体需求选择最适合的集成方式，快速构建生产级的记忆增强型Agent应用。</p>
<h3 data-id="heading-27">监控管理层：可视化仪表板</h3>
<p>为了有效管理和监控记忆系统，我们开发了基于Streamlit的可视化仪表板，展示如何在生产环境中操作和维护Mem0与PostgreSQL的集成。</p>
<h4 data-id="heading-28">功能特性</h4>
<ul>
<li>实时监控：记忆总数、新增趋势、类型分布等关键指标</li>
<li>数据库监控：Aurora PostgreSQL连接状态、性能指标和错误率</li>
<li>智能搜索：支持语义搜索和多维度筛选分析</li>
<li>开发支持：详细日志记录和错误处理机制</li>
</ul>
<h4 data-id="heading-29">核心技术实现</h4>
<p>仪表板采用渐进式的数据获取策略，确保在不同数据状态和网络条件下都能正常工作：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 核心数据获取实现 - 从Mem0读取记忆数据</span>
<span class="hljs-meta">@st.cache_data(<span class="hljs-params">ttl=<span class="hljs-number">30</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_memories</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Any</span>]]:
   <span class="hljs-string">"""初始化Mem0 对象"""</span>
   mem0 = init_mem0()
   <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mem0 <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> user_id.strip():
       <span class="hljs-keyword">return</span> []

   <span class="hljs-keyword">try</span>:
       <span class="hljs-comment"># 方法1:从Mem0检索记忆</span>
       search_result = mem0.search(<span class="hljs-string">"user"</span>, user_id=user_id)

       <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(search_result, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"results"</span> <span class="hljs-keyword">in</span> search_result:
           memories = search_result[<span class="hljs-string">"results"</span>]
       <span class="hljs-keyword">else</span>:
           memories = search_result

       <span class="hljs-keyword">if</span> memories:
           processed_memories = []
           <span class="hljs-keyword">for</span> memory <span class="hljs-keyword">in</span> memories:
               <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memory, <span class="hljs-built_in">dict</span>):
                   processed_memories.append(memory)
               <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(memory, <span class="hljs-string">'__dict__'</span>):
                   processed_memories.append(memory.__dict__)
               <span class="hljs-keyword">else</span>:
                   <span class="hljs-comment"># 标准化记忆对象</span>
                   memory_dict = {
                       <span class="hljs-string">'id'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'id'</span>, <span class="hljs-built_in">str</span>(uuid.uuid4())),
                       <span class="hljs-string">'memory'</span>: <span class="hljs-built_in">str</span>(memory),
                       <span class="hljs-string">'user_id'</span>: user_id,
                       <span class="hljs-string">'created_at'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'created_at'</span>, datetime.now().isoformat()),
                       <span class="hljs-string">'metadata'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'metadata'</span>, {})
                   }
                   processed_memories.append(memory_dict)
           <span class="hljs-keyword">return</span> processed_memories

       <span class="hljs-comment"># 方法2: 回退到全量数据获取</span>
       memories = mem0.get_all(user_id=user_id)

       <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memories, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">'results'</span> <span class="hljs-keyword">in</span> memories:
           memories_list = memories[<span class="hljs-string">'results'</span>]
       <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(memories, <span class="hljs-built_in">list</span>):
           memories_list = memories
       <span class="hljs-keyword">else</span>:
           <span class="hljs-keyword">return</span> []

       processed_memories = []
       <span class="hljs-keyword">for</span> memory <span class="hljs-keyword">in</span> memories_list:
           <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memory, <span class="hljs-built_in">dict</span>):
               processed_memories.append(memory)
           <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(memory, <span class="hljs-string">'__dict__'</span>):
               processed_memories.append(memory.__dict__)

       <span class="hljs-keyword">return</span> processed_memories

   <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
       st.error(<span class="hljs-string">f"获取记忆数据时发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
       <span class="hljs-keyword">return</span> []
</code></pre>
<p><em>可视化界面展示</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b0ebf05f282478a842752e2f35e6cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=hy3f%2B0CzcHIdimCyS5T2%2FzYtVr8%3D" alt="4.png" loading="lazy"/></p>
<p>如上图所示，仪表板提供了直观的记忆系统监控界面，包括记忆统计、搜索功能、数据筛选和详细的记忆内容展示。</p>
<p><strong>业务价值体现</strong></p>
<p>通过统一的监控界面，开发团队能够快速诊断问题、优化记忆策略、提升开发效率，为构建生产级记忆增强型AI系统提供完整的运维支撑。</p>
<h3 data-id="heading-30">架构总结</h3>
<p>通过亚马逊云科技与Mem0的深度集成，我们构建了一个企业级记忆增强型AI解决方案：</p>
<ul>
<li>技术完整性：覆盖了从大模型调用、向量存储、图存储到应用开发的完整技术栈</li>
<li>部署灵活性：支持多种模型提供商和存储后端，适应不同地区和场景的部署需求</li>
<li>开发便利性：提供了工具调用和Agent集成的方式，满足不同复杂度的应用需求</li>
<li>运维支撑：通过可视化仪表板和企业级安全特性，为生产环境提供必要的监控和管理能力</li>
</ul>
<p>这种集成方案为开发者提供了构建记忆增强型AI应用的技术基础和实践参考。</p>
<h3 data-id="heading-31">Mem0使用效果示例</h3>
<p>为了展示Mem0框架的智能记忆管理能力，我们通过一个企业内部知识分享的多轮对话场景，演示系统如何处理记忆演进和复杂关系推理。</p>
<h4 data-id="heading-32">第一次对话：建立基础关系</h4>
<p>用户</p>
<p>“我和Bob是同一个项目组的，他是我们的技术负责人，在推荐系统方面很有经验。”</p>
<p>助手+系统响应</p>
<p>您好！我看到您提供了关于您的团队信息，我会将这些内容存储到记忆中，以便在未来的对话中更好地为您提供帮助。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户在同一个项目组中与Bob一起工作。Bob是项目的技术负责人，在推荐系统方面有丰富经验。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob是项目的技术负责人"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享关于您项目组的信息。我已记录下您与Bob在同一个项目组工作的情况，以及Bob作为技术负责人在推荐系统方面的丰富经验。这些信息对我们今后的交流很有帮助。</p>
<p>如果您有任何关于推荐系统或者与您项目相关的问题，或者需要其他方面的帮助，请随时告诉我。我会根据您提供的背景信息，尽可能地提供相关和个性化的支持。</p>
<h4 data-id="heading-33">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c242d488f2f4b0e8557f08b526263cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=uSZYdEjAbpPmHKp2QEBEstVufQ4%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-34">第二次对话：扩展关系网络</h3>
<p>用户</p>
<p>“Bob推荐我去找Carol学习机器学习，她是AI团队的专家，在深度学习方面特别厉害。”</p>
<p>助手+系统响应</p>
<p>我看到您提到Bob推荐您去找Carol学习机器学习，并且Carol是AI团队的专家，尤其在深度学习方面很厉害。让我先检查一下我是否有关于您的任何现有信息，以便为您提供更加个性化的帮助。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-Python" lang="Python">[
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob是项目的技术负责人"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  }
]
</code></pre>
<p>我看到您之前和Bob一起工作，他是项目的技术负责人，在推荐系统方面拥有丰富的经验。现在让我来为您存储关于Carol的新信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家，在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol是AI团队的专家"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol在深度学习方面特别厉害"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣，Bob推荐去找Carol学习"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"对机器学习感兴趣"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob推荐去找Carol学习"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享这些信息！我已经记录下了关于Carol的专业知识以及Bob的推荐。</p>
<p>根据我们之前的交流，我了解到您和Bob是同事，他是项目的技术负责人，在推荐系统方面有丰富经验。现在他推荐您向Carol学习机器学习，这是个很好的建议！</p>
<p>Carol作为AI团队的专家，特别是在深度学习领域有专长，确实是学习机器学习的理想人选。如果您有兴趣深入学习这个领域，找Carol指导是非常合适的。</p>
<p>您计划如何联系Carol呢？或者您对机器学习有什么特定的学习目标或问题想先了解一下？我很乐意帮您准备一些与Carol交流的关键问题或者提供一些机器学习的基础资源。</p>
<h4 data-id="heading-35">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f681dfb3444b6902fea2b2ee3c842~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=Ij3xDubvUJ5mZG7%2FmGRVutOjF2o%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-36">第三次对话：深化专业关联</h3>
<p>用户</p>
<p>“Carol提到她和David合作过一个很成功的电商推荐系统项目，用的是深度学习技术。”</p>
<p>助手+系统响应</p>
<p>我注意到您提到了关于Carol和David合作的电商推荐系统项目的信息。为了更好地理解和保存这条重要信息，我需要先检查一下是否已经有关于Carol的记录，然后将这条新信息存储起来。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"af15be42b498b30fb7c12a843ec248c3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4540502158373456</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.055840-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob推荐去找Carol学习"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"81d79f9cca4b862f661e6db5b1e8d8c6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5762676253159262</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.835854-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"858ed013f042a05abc95bd80e8195c44"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.674725383520124</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.078016-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob是项目的技术负责人"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8379180628681754</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8489449204272127</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8534301326701068</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8832502816a0ab35a3a15208f6d6d15"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8896779102470982</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.817286-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>现在我看到了一些关于Carol的现有信息，我将存储这条新的关于Carol和David合作项目的信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目，使用的是深度学习技术"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"David"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"76162a60-b3b5-4660-8dc7-7125fee9215f"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"a8a77ccc-aff5-4765-a4e0-7795d8ed87de"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"使用了深度学习技术"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享这条信息。我已经记录了Carol和David合作开发的电商推荐系统项目的细节。</p>
<p>根据我已有的记忆，我了解到：</p>
<ul>
<li>Carol是AI团队的专家，特别擅长深度学习领域</li>
<li>现在我知道她与David合作开发了一个成功的电商推荐系统项目，应用了深度学习技术</li>
<li>此前Bob曾推荐向Carol学习，特别是在机器学习方面</li>
<li>这个项目信息很有价值。如果您想了解更多关于Carol的专业知识或者这个推荐系统项目的细节，或者您有任何其他信息想要分享，请随时告诉我。</li>
</ul>
<h4 data-id="heading-37">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b4de54cc664c17a487b9fa4a133376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=25xCPBcd5EOl9FVqFHvvHVOZk%2FQ%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-38">第四次对话：查询，记忆存储价值体现</h3>
<p>用户</p>
<p>“我想找一个推荐系统方面的专家，最好是通过可信渠道了解到的，能给我一些实战经验。”</p>
<p>助手+系统响应</p>
<p>您好！我理解您正在寻找推荐系统方面的专家，希望获得一些实战经验。为了更好地为您服务，我想先了解一下您之前是否与我们讨论过相关话题或有任何推荐系统方面的偏好。</p>
<p>让我先查询一下您的历史记录，看看我们是否有相关的信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"retrieve"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"推荐系统 专家 技术偏好 实战经验 职业背景"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4588502421050821</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"76162a60-b3b5-4660-8dc7-7125fee9215f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"47196951d607246d0933e0c285ca0444"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"David"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6427874075535635</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:41:31.777281-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob是项目的技术负责人"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7467557418266737</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"af15be42b498b30fb7c12a843ec248c3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7494404018592338</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.055840-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8a77ccc-aff5-4765-a4e0-7795d8ed87de"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"使用了深度学习技术"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6f8654a7f1ebe2aa93e5b25ae5728bb3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"David"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7579878847627914</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:41:31.802874-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8832502816a0ab35a3a15208f6d6d15"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8253733529972992</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.817286-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8466813908016234</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob推荐去找Carol学习"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"81d79f9cca4b862f661e6db5b1e8d8c6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8693739778549688</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.835854-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"858ed013f042a05abc95bd80e8195c44"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.9502609774314766</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.078016-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>根据我查询到的信息，我发现您之前可能已经与一些推荐系统方面的专家有所联系或了解。基于我们的记录，我可以为您提供以下推荐：</p>
<ol>
<li>Bob – 他是推荐系统方面的专家，并且是某项目的技术负责人。根据记录，您曾与Bob在同一个项目组中工作，他在推荐系统领域有丰富的经验。这是一个通过您的工作关系建立的可信渠道。</li>
<li>Carol – 她是一位AI团队的专家，特别在深度学习方面非常厉害。有趣的是，正是Bob之前推荐您向Carol学习。Carol与另一位同事David曾合作开发了一个成功的电商推荐系统项目，使用了深度学习技术。</li>
</ol>
<p>鉴于您希望通过可信渠道了解到的专家，且需要实战经验，我建议您可以：</p>
<ol>
<li>优先联系Bob，他既是您的同事，也是推荐系统领域的专家，可以直接分享他的实战经验。</li>
<li>请Bob引荐您认识Carol，她在深度学习推荐系统方面有成功的电商项目经验，特别是如果您对深度学习在推荐系统中的应用感兴趣。</li>
<li>也可以请Carol介绍她与David合作的电商推荐系统项目的实战经验和关键技术点。</li>
</ol>
<p>您希望我为您提供更多关于这些专家的详细信息，或者您对其他方面的推荐系统专家有特定要求吗？</p>
<h3 data-id="heading-39">无记忆系统的对比</h3>
<h4 data-id="heading-40">记忆清除</h4>
<p>登陆到向量数据库，将会话历史删除。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5904c523505b4ae4989a7a017d39c72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=9coG3NPPkIAreUAH1fw79nYTjNk%3D" alt="8.png" loading="lazy"/></p>
<p>用户</p>
<p>“我想找一个推荐系统方面的专家，最好是通过可信渠道了解到的，能给我一些实战经验。”</p>
<p>助手+系统响应</p>
<p>您好！我很乐意帮您寻找推荐系统方面的专家。为了更好地为您提供个性化服务，我需要先了解一下您之前是否已经与我讨论过相关的需求或提供过一些信息。让我先查询一下您的历史记录。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<p><code>[]</code></p>
<p>看起来我们之前没有存储关于您的信息。为了能够更好地帮助您，我想了解一些更具体的信息，这样我可以将其保存下来，以便今后为您提供更个性化的服务。</p>
<p>关于您寻找推荐系统专家的需求，我想了解几点：</p>
<ol>
<li>您对推荐系统的哪些方面特别感兴趣？(例如：电商推荐、内容推荐、算法实现等)</li>
<li>您希望这位专家能提供什么类型的实战经验？(例如：系统搭建、算法优化、A/B测试等)</li>
<li>您计划通过什么方式与专家交流？(例如：咨询、合作、指导等)</li>
</ol>
<p>我会将您提供的这些信息保存下来，以便今后能够更精准地为您服务。同时，我可以根据您的需求，推荐一些可以寻找推荐系统专家的可信渠道，如专业社区、行业会议、学术机构等。</p>
<h3 data-id="heading-41">核心价值对比</h3>
<p>通过上述多轮对话演示，我们可以清晰地看到记忆系统与传统无记忆系统的核心差异：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af12fd7b8677479eb7153c4531869658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=HQ%2FQkBhrFsO476d6gQGMpO1aUjo%3D" alt="9.webp" loading="lazy"/></p>
<h3 data-id="heading-42">总结和展望</h3>
<p>Mem0框架标志着Agentic AI应用从无状态向有状态的重要转变。通过双LLM架构和智能记忆管理机制，解决了传统AI系统的记忆缺失问题，实现了真正的个性化和上下文连续性。</p>
<p>Mem0框架与亚马逊云科技的深度集成真正体现了”相得益彰”的协同效应——Mem0提供智能记忆管理核心能力，亚马逊云科技提供企业级基础设施支撑。这种结合实现了能力倍增，推动记忆增强型AI从概念验证走向生产实践。该方案不仅可在亚马逊云科技海外区域部署，同样也适用于北京和宁夏区域。</p>
<p>记忆增强型Agent在企业客户服务、个性化教育、知识管理等领域展现出巨大潜力。随着多模态AI技术发展，未来的记忆系统将支持更丰富的数据类型和更强的自主学习能力。记忆增强型Agentic AI将推动人工智能从工具向伙伴的根本性转变，为用户创造更加智能、个性化的数字体验。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df17a40abb7046abbf88f1b4fb377e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=oA3NPTmlnFsxFx0q194Q0NWVYow%3D" alt="zz.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL中的字符集与排序规则]]></title>    <link>https://juejin.cn/post/7574269207363158025</link>    <guid>https://juejin.cn/post/7574269207363158025</guid>    <pubDate>2025-11-19T23:46:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363158025" data-draft-id="7574568258787917875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL中的字符集与排序规则"/> <meta itemprop="keywords" content="MySQL,数据库,后端"/> <meta itemprop="datePublished" content="2025-11-19T23:46:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL中的字符集与排序规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:46:45.000Z" title="Wed Nov 19 2025 23:46:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在MySQL中，当使用字符串类型时，有两方面的知识我们需要特别关注一下：字符集和排序规则。如果使用不当，则可能会导致性能问题或在插入数据时出现一些异常情况。</p>
<p>字符集定义了对应列允许使用的字符，而排序规则是用于比较这些字符的基础规则。通常，每个类型的字符集都会有多种排序规则，但一个排序规则只能属于一个字符集。</p>
<p>这篇文章，我们就围绕MySQL中字符集以及排序规则展开，详细聊聊相关的技术点。</p>
<h2 data-id="heading-0">MySQL中的字符集</h2>
<p>MySQL支持广泛的字符集，包括GB2312、GBK、BIG5等本地字符集，以及多种Unicode字符集，如<code>utf8mb3</code> (MySQL中旧版的<code>utf8</code>)、<code>utf8mb4</code>、<code>ucs2</code>、<code>utf16</code>和<code>utf32</code>。<code>utf8mb4</code>是推荐使用的字符集，因为它能完整支持所有Unicode字符，包括表情符号和不常用的汉字。</p>
<p>可以使用下面的命令在<code>information_schema</code>数据库中查看所有字符集：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">mysql&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> information_schema.character_sets <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> character_set_name;
+--------------------+----------------------+---------------------------------+--------+
| CHARACTER_SET_NAME | DEFAULT_COLLATE_NAME | DESCRIPTION                     | MAXLEN |
+--------------------+----------------------+---------------------------------+--------+
| armscii8           | armscii8_general_ci  | ARMSCII-<span class="hljs-number">8</span> Armenian              |      <span class="hljs-number">1</span> |
| ascii              | ascii_general_ci     | US ASCII                        |      <span class="hljs-number">1</span> |
| big5               | big5_chinese_ci      | Big5 Traditional Chinese        |      <span class="hljs-number">2</span> |
| <span class="hljs-keyword">binary</span>             | <span class="hljs-keyword">binary</span>               | <span class="hljs-keyword">Binary</span> pseudo charset           |      <span class="hljs-number">1</span> |
……
……
……
| utf16              | utf16_general_ci     | UTF-<span class="hljs-number">16</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf16le            | utf16le_general_ci   | UTF-<span class="hljs-number">16L</span>E <span class="hljs-keyword">Unicode</span>                |      <span class="hljs-number">4</span> |
| utf32              | utf32_general_ci     | UTF-<span class="hljs-number">32</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf8               | utf8_general_ci      | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">3</span> |
| utf8mb4            | utf8mb4_0900_ai_ci   | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">4</span> |
+--------------------+----------------------+---------------------------------+--------+
</code></pre>
<p>通过上述命令可以列出当前MySQL支持的所有字符集，以及它们的默认排序规则。每种字符集都有一个默认排序规则。</p>
<p>在上述命令展示的列表底部，有两个字符集被描述为UTF-8 Unicode。<code>utf8</code>字符集的<code>MAXLEN</code>为3，而<code>utf8mb4</code>的<code>MAXLEN</code>为4。这里指的是每个字符允许的最大字节长度。</p>
<p>特别需要留意的是，<strong>根据UTF-8标准，每个字符允许使用最多4个字节，这意味着MySQL的<code>utf8</code>字符集实际上并不是真正的UTF-8，因为它只支持每字符最多3个字节。从MySQL 8开始，<code>utf8mb4</code>成为默认字符集，也是最常使用的字符集。</strong> 而<code>utf8</code>被保留用于向下兼容，应该不再使用。</p>
<h2 data-id="heading-1">如何定义字符集</h2>
<p>定义列的字符集有几种方式。如果你没有在表或列级别指定字符集，服务器默认的<code>utf8mb4</code>字符集将被应用（除非你明确声明了一个不同的服务器或数据库默认设置）。</p>
<p>我们可以通过创建一个没有字符集信息的表并读取其定义来验证这一点：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
​
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset;
</code></pre>
<p>生成的<code>CREATE TABLE</code>语句显示了默认的字符集和排序规则已经被应用：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `no_charset` (
  `my_column` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<h3 data-id="heading-2">在表级别定义</h3>
<p>你可以显式地在表级别设置字符集，通过使用<code>CHARSET=[字符集]</code>语法。例如，这里我们创建一个所有字符列都使用<code>latin1</code>字符集的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  `my_column` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1;
</code></pre>
<h3 data-id="heading-3">在列级别定义</h3>
<p>你也可以在列级别设置字符集。这是最具体的设置，会覆盖任何表级别的设置：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
</code></pre>
<p>通过运行<code>SHOW CREATE TABLE mixed_collations</code>可以看到表的默认字符集是<code>utf8mb4</code>，但是显式设置的列使用了<code>latin1</code>字符集：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1 <span class="hljs-keyword">COLLATE</span> latin1_swedish_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<p>列级别的声明将覆盖表级别的声明，表级别的声明将覆盖数据库默认，数据库默认的字符集覆盖服务器默认。</p>
<h2 data-id="heading-4">MySQL中的排序规则</h2>
<p>字符集定义了可以存储在列中的合法字符，而排序规则则是确定如何进行字符串比较的规则。如果你在排序或比较字符串，MySQL就会使用排序规则来决定顺序以及判断字符串是否相同。</p>
<p>可以通过查询<code>information_schema</code>表来显示所有排序规则。下面的查询仅显示与<code>utf8mb4</code>字符集相关的排序规则：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">mysql&gt;</span> <span class="hljs-string">SELECT</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">*</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">FROM</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">information_schema.collations</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">WHERE</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">character_set_name</span> <span class="hljs-string">=</span> <span class="hljs-string">'utf8mb4'</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">ORDER</span> <span class="hljs-string">BY</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">collation_name;</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">COLLATION_NAME</span>             <span class="hljs-string">|</span> <span class="hljs-string">CHARACTER_SET_NAME</span> <span class="hljs-string">|</span> <span class="hljs-string">ID</span>  <span class="hljs-string">|</span> <span class="hljs-string">IS_DEFAULT</span> <span class="hljs-string">|</span> <span class="hljs-string">IS_COMPILED</span> <span class="hljs-string">|</span> <span class="hljs-string">SORTLEN</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD_ATTRIBUTE</span> <span class="hljs-string">|</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_ai_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">255</span> <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>        <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">305</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_cs</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">278</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_bin</span>           <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">309</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_bin</span>                <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span>  <span class="hljs-number">46</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD</span> <span class="hljs-string">SPACE</span>     <span class="hljs-string">|</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
</code></pre>
<p>该查询将显示所有排序规则、相关字符集名称、是否为默认值以及其他信息。例如，<code>utf8mb4_0900_ai_ci</code>是<code>utf8mb4</code>字符集的默认排序规则。</p>
<h3 data-id="heading-5">排序规则的命名规则</h3>
<p>排序规则的命名通常前缀为字符集名称，后缀由排序规则的属性组合而成。</p>
<p>以下是一些主要后缀及其含义：</p>

































<table><thead><tr><th>后缀</th><th>含义</th></tr></thead><tbody><tr><td>_ai</td><td>不区分重音符</td></tr><tr><td>_as</td><td>区分重音符</td></tr><tr><td>_ci</td><td>不区分大小写</td></tr><tr><td>_cs</td><td>区分大小写</td></tr><tr><td>_ks</td><td>区分假名</td></tr><tr><td>_bin</td><td>二进制比较</td></tr></tbody></table>
<p>例如，默认排序规则<code>utf8mb4_0900_ai_ci</code>可以拆解：</p>
<ul>
<li><code>utf8mb4</code>：属于<code>utf8mb4</code>字符集；</li>
<li><code>0900</code>：使用UCA 9.0.0的权重键；</li>
<li><code>_ai</code>：不区分重音符；</li>
<li><code>_ci</code>：不区分大小写。</li>
</ul>
<p>那么，字符串比较是否区分大小写？答案是：“视具体排序规则而定！”</p>
<h3 data-id="heading-6">验证排序规则</h3>
<p>我们可以使用<code>COLLATE</code>关键字显式设置字符串的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为1，表示MySQL认为这两个字符串相等。如果改用区分大小写的排序规则，我们会得到不同的结果：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为0，表明MySQL认为这两个字符串不同，因为它们大小写不同。</p>
<p>类似逻辑也适用于重音符。例如，在使用不区分重音符的排序规则时，<code>resume</code>与<code>résumé</code>会被认为是相同的。</p>
<h2 data-id="heading-7">如何定义排序规则</h2>
<p>与字符集类似，排序规则可以在表级别或列级别设置。如果未显式定义排序规则，MySQL会使用字符集的默认排序规则。</p>
<h3 data-id="heading-8">表级别定义</h3>
<p>可以在<code>CREATE TABLE</code>语句中使用<code>COLLATE</code>子句定义表的排序规则。例如，以下创建了一个所有字符列都使用<code>utf8mb4_bin</code>排序规则的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_bin;
</code></pre>
<h3 data-id="heading-9">列级别定义</h3>
<p>也可以在列定义中设置排序规则。例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci,
  `implicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p>此外，也可以通过<code>ALTER TABLE</code>语句修改现有表列的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> table_with_collation
    CHANGE `explicitly_set` `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
        <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
</code></pre>
<h2 data-id="heading-10">小结</h2>
<p>理解字符集和排序规则是处理MySQL字符串数据的基础。字符集定义了列中存储的合法字符，排序规则决定了字符串比较的方式。</p>
<ul>
<li>字符集可以在列级别、表级别定义，或者继承自数据库或服务器默认值。最具体的层级（列 &gt; 表 &gt; 数据库 &gt; 服务器）将会被采用。</li>
<li>排序规则可以在列级别、表级别定义，或者继承自字符集默认。仍然是最具体的层级优先。</li>
</ul>
<p>列的字符集和排序规则会影响数据存储方式以及数据的比较和排序行为。在设计数据库时需注意这些设置，以确保行为正确并优化性能。</p>
<p>如果不确定应使用哪个字符集或排序规则，MySQL默认的<code>utf8mb4</code>字符集及其默认排序规则<code>utf8mb4_0900_ai_ci</code>通常是一个不错的选择。它们支持所有Unicode字符并提供大小写不敏感和重音符不敏感的比较功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？]]></title>    <link>https://juejin.cn/post/7574383670435741748</link>    <guid>https://juejin.cn/post/7574383670435741748</guid>    <pubDate>2025-11-20T08:43:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574383670435741748" data-draft-id="7574404398066810880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T08:43:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wenps"/> <meta itemprop="url" content="https://juejin.cn/user/4301712026763790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4301712026763790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wenps
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:43:28.000Z" title="Thu Nov 20 2025 08:43:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？</h2>
<h3 data-id="heading-1">核心问题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'watch 触发了'</span>)
  }
}

<span class="hljs-comment">// 路径 1：直接 $set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ✅ 触发 watch</span>

<span class="hljs-comment">// 路径 2：先赋值再 $set  </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ❌ 不触发 watch</span>
</code></pre>
<p><strong>为什么同样用了 <code>$set</code>，结果却不同？</strong></p>
<hr/>
<h3 data-id="heading-2">原因：$set 内部有属性存在性检查</h3>
<h4 data-id="heading-3">$set 源码简化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, val</span>) {
  <span class="hljs-comment">// 关键判断：属性是否已存在</span>
  <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> target &amp;&amp; !(key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)) {
    target[key] = val  <span class="hljs-comment">// ← 只做普通赋值</span>
    <span class="hljs-keyword">return</span> val         <span class="hljs-comment">// ← 直接返回，不触发通知</span>
  }
  
  <span class="hljs-comment">// 属性不存在才走这里</span>
  <span class="hljs-keyword">const</span> ob = target.<span class="hljs-property">__ob__</span>
  <span class="hljs-title function_">defineReactive</span>(target, key, val)  <span class="hljs-comment">// 定义响应式</span>
  ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 触发 watch！</span>
  <span class="hljs-keyword">return</span> val
}
</code></pre>
<h4 data-id="heading-4">关键点</h4>
<p><strong><code>$set</code> 只在属性不存在时才调用 <code>dep.notify()</code></strong></p>
<hr/>
<h3 data-id="heading-5">两条路径的详细分析</h3>
<h4 data-id="heading-6">路径 1：直接 $set（✅ 触发）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始状态</span>
c = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// b 不存在</span>

<span class="hljs-comment">// 执行</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 内部逻辑</span>
<span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> c  <span class="hljs-comment">// → false（属性不存在）</span>
↓
添加响应式属性 b
↓
c.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 触发 watch！</span>
</code></pre>
<h4 data-id="heading-7">路径 2：先赋值再 $set（❌ 不触发）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始状态</span>
c = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// b 不存在</span>

<span class="hljs-comment">// 第 1 步：普通赋值</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>
<span class="hljs-comment">// 现在：c = { a: 1, b: 1000 }</span>
<span class="hljs-comment">// 但 b 不是响应式的！</span>

<span class="hljs-comment">// 第 2 步：$set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 内部逻辑</span>
<span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> c  <span class="hljs-comment">// → true（属性已存在！）</span>
↓
只执行：c.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>（普通赋值）
↓
不调用 dep.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 不触发 watch！</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">Vue 为什么这样设计？</h3>
<p>Vue 的设计逻辑：</p>
<ol>
<li><strong>新属性</strong> = 对象结构变化 → 需要通知所有观察者</li>
<li><strong>已存在的属性</strong> = 只是值变化 → 应该通过属性自己的 setter 触发</li>
</ol>
<p>但问题是：路径 2 中的 <code>b</code> 虽然存在，但<strong>不是响应式的</strong>（没有 setter），所以：</p>
<ul>
<li><code>$set</code> 认为它已存在，不调用 <code>notify()</code></li>
<li>但它没有 setter，值变化不会触发更新</li>
<li><strong>结果就是：既不通知对象的观察者，也不触发属性的 setter</strong></li>
</ul>
<hr/>
<h3 data-id="heading-9">完整验证代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">c</span>: { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }
  }
},

<span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'watch 触发了！'</span>, val)
  }
},

<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 1：直接 $set ==='</span>)
  <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
  <span class="hljs-comment">// ✅ 打印 "watch 触发了！{a: 1, b: 1000}"</span>
  
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 2：先赋值再 $set ==='</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">d</span> = <span class="hljs-number">2000</span>  <span class="hljs-comment">// 先创建普通属性</span>
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'d'</span>, <span class="hljs-number">3000</span>)  <span class="hljs-comment">// 再用 $set</span>
    <span class="hljs-comment">// ❌ 不打印任何东西</span>
  }, <span class="hljs-number">1000</span>)
  
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 3：$set 两次 ==='</span>)
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'e'</span>, <span class="hljs-number">4000</span>)  <span class="hljs-comment">// 第一次</span>
    <span class="hljs-comment">// ✅ 打印 "watch 触发了！"</span>
    
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'e'</span>, <span class="hljs-number">5000</span>)  <span class="hljs-comment">// 第二次</span>
    <span class="hljs-comment">// ✅ 也会触发（因为 e 已经是响应式的）</span>
  }, <span class="hljs-number">2000</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-10">dep.notify() 触发的是什么？</h3>
<h4 data-id="heading-11">Vue 的两层依赖收集</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> c = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">__ob__</span>: {
    <span class="hljs-attr">dep</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()  <span class="hljs-comment">// ← 对象自己的 dep</span>
  }
}

<span class="hljs-comment">// 同时，每个响应式属性也有自己的 dep（通过闭包）</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(c, <span class="hljs-string">'a'</span>, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集依赖到 a 的 dep</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-comment">// 通知 a 的 dep</span>
  }
})
</code></pre>
<h4 data-id="heading-12">区别</h4>





























<table><thead><tr><th>操作</th><th>触发的 dep</th><th>watch: c</th><th>watch: 'c.a'</th></tr></thead><tbody><tr><td><code>c.a = 2</code></td><td><code>a</code> 的 dep</td><td>❌ 不触发</td><td>✅ 触发</td></tr><tr><td><code>$set(c, 'b', 1)</code></td><td><code>c.__ob__.dep</code></td><td>✅ 触发</td><td>-</td></tr><tr><td><code>c = {}</code></td><td>对象替换</td><td>✅ 触发</td><td>-</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">为什么不需要 deep 也能触发？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {  <span class="hljs-comment">// 没有 deep: true</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'触发了'</span>)
  }
}

<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ✅ 会触发</span>
</code></pre>
<p><strong>原因：</strong></p>
<ul>
<li><code>$set</code> 触发的是 <code>c.__ob__.dep</code>（对象自己的 dep）</li>
<li>监听 <code>c</code> 的 watcher 收集的就是这个 dep</li>
<li>不需要 deep，因为是对象结构变化</li>
</ul>
<p><strong>deep 的作用：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-attr">c</span>: {
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">val</span>) {},
    <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// ← 递归收集所有属性的 dep</span>
  }
}

<span class="hljs-comment">// 现在修改已有属性也会触发</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">a</span> = <span class="hljs-number">2</span>  <span class="hljs-comment">// ✅ 触发（因为收集了 a 的 dep）</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">最佳实践</h3>
<h4 data-id="heading-15">❌ 永远不要这样做</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">111</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 不会触发 watch</span>
</code></pre>
<h4 data-id="heading-16">✅ 正确做法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案 1：只用 $set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 方案 2：在 data 中预先声明</span>
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">c</span>: {
      <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">b</span>: <span class="hljs-literal">null</span>  <span class="hljs-comment">// 预先声明</span>
    }
  }
}
<span class="hljs-comment">// 现在可以直接赋值</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>  <span class="hljs-comment">// ✅ 会触发</span>

<span class="hljs-comment">// 方案 3：整体替换对象</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">1000</span> }

<span class="hljs-comment">// 方案 4：分两步（如果需要不同值）</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">111</span>)  <span class="hljs-comment">// 第一次触发</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>              <span class="hljs-comment">// 第二次触发（因为 b 已是响应式）</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">总结表格</h3>



































<table><thead><tr><th>场景</th><th>属性状态</th><th>$set 行为</th><th>是否触发 watch</th></tr></thead><tbody><tr><td><code>$set(c, 'b', 1)</code></td><td>不存在</td><td>添加响应式 + notify</td><td>✅ 触发</td></tr><tr><td><code>c.b = 1; $set(c, 'b', 2)</code></td><td>存在（非响应式）</td><td>只赋值，不 notify</td><td>❌ 不触发</td></tr><tr><td><code>$set(c, 'b', 1); $set(c, 'b', 2)</code></td><td>存在（响应式）</td><td>触发 setter</td><td>✅ 触发</td></tr><tr><td><code>$set(c, 'b', 1); c.b = 2</code></td><td>存在（响应式）</td><td>触发 setter</td><td>✅ 触发</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">记住一句话</h3>
<blockquote>
<p><strong><code>$set</code> 只在属性不存在时才调用 <code>dep.notify()</code></strong><br/>
<strong>先赋值再 <code>$set</code> = 属性已存在 = 不会触发 watch</strong></p>
</blockquote>
<hr/>
<p><strong>关键点：</strong></p>
<ul>
<li><code>$set</code> 有属性存在性检查：<code>key in target</code></li>
<li>普通赋值创建的属性不是响应式的</li>
<li>已存在的属性（即使非响应式）会让 <code>$set</code> 跳过 <code>notify()</code></li>
<li>永远不要在 <code>$set</code> 前先赋值！</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7 个 Cursor AI 极限省钱大法，别花冤枉钱！]]></title>    <link>https://juejin.cn/post/7574724406306390066</link>    <guid>https://juejin.cn/post/7574724406306390066</guid>    <pubDate>2025-11-21T06:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574724406306390066" data-draft-id="7574722364354805769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7 个 Cursor AI 极限省钱大法，别花冤枉钱！"/> <meta itemprop="keywords" content="后端,AI编程,Cursor"/> <meta itemprop="datePublished" content="2025-11-21T06:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7 个 Cursor AI 极限省钱大法，别花冤枉钱！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:16:27.000Z" title="Fri Nov 21 2025 06:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>自从给我们团队提供 Cursor AI 之后，公司的利润是越来越少了，大家是真的疯狂压榨 AI。</p>
<p>来给大家看看账单，才一个多月就花了 <strong>1 万多</strong>！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/897d0f8c83e546f09a38b7fd62d2b152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ojRgnJQBt%2BXtUtdZ7Cna2ZRXhj0%3D" alt="" loading="lazy"/></p>
<p>说破产虽然有些夸张，但这钱都够招一个人了啊！</p>
<p>我估计在座的没多少同学用 AI 花钱比我们多吧，不信你们报报账单？</p>
<p>我接受用 AI 花钱，但是咱不能花冤枉钱对吧？于是我在公司内部做了一场全面的 Cursor 省钱技巧分享，大家的反馈不错，所以我决定把内部分享公开曝光出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6fcb1c25e96421cab3f0969ef78b56a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ADYnrDeDMr2xWZoGn3BguQ5K3n0%3D" alt="" loading="lazy"/></p>
<p>大家使用 AI 的技巧无非就是更快（提高效率）、更准（提高准确度）、更强（更多能力）、更稳（安全稳定）、更省钱对吧。</p>
<p>我之前已经公开分享过很多 AI 使用技巧了，感兴趣的同学 <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F12890453" target="_blank" title="https://space.bilibili.com/12890453" ref="nofollow noopener noreferrer">可以去看看</a>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/808e4d3d896948fc8ba67f054e567b25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=UKunsMKutChH9EosJTCE7EDfhmk%3D" alt="" loading="lazy"/></p>
<p>这一期我就专门教大家 AI 省钱大法，绝对全面、亲测有效，让你的每一分钱都花在刀刃上。</p>
<p>点个收藏，我们开始吧~</p>
<p>💡 本文对应视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1pAy5BXE5z" target="_blank" title="https://www.bilibili.com/video/BV1pAy5BXE5z" ref="nofollow noopener noreferrer">bilibili.com/video/BV1pA…</a></p>
<h2 data-id="heading-0">AI 省钱大法</h2>
<p>友情提示，接下来要分享的技巧较多，为了便于大家理解，建议大家把自己想象成公司的创始人，你招了一位 AI 员工。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbc5ba44e0c4a93897d1ce52b846b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=FAIfkb%2FeCRXDcDQqFihfFOR4n48%3D" alt="" loading="lazy"/></p>
<p>没错，你就是老板，你就是大资本家啊！</p>
<p>接下来我们要学习的是，<strong>怎么给更少的钱让 AI 干更多的活</strong>。</p>
<p>先说个基本概念：Cursor 的计费是按 token（可以理解为字符数）来算的，你给 AI 看的内容（输入）越多、AI 输出的内容越多，花的钱就越多，就这么简单。</p>
<p>好，理解了这个，我们开始讲省钱技巧。</p>
<h3 data-id="heading-1">1、别让 AI 做无用功</h3>
<p>大家有没有遇到过这种情况？让 AI 写个功能代码，结果它噼里啪啦给你输出一大堆注释、测试代码、一大堆文档说明、给文档再生成个文档、最后再来一大段总结。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a18531b5a2894d6d84afe2342ee009a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=H%2FJTSe6GgXxgNzjTjwSkKdQ9%2FQs%3D" alt="" loading="lazy"/></p>
<p>看着很专业，但我估计很多东西你根本不会去看的，对不对？</p>
<p>就像你让员工做一堆没用的工作，到头来不也得花你自己的时间和钱么？</p>
<p>所以，要直接在提示词中跟 AI <strong>讲清楚什么该做什么不该做</strong>，别整那些花里胡哨的。</p>
<ul>
<li>如果只想要实现功能，就让它只改代码、能跑就行，不要写测试、文档、注释</li>
<li>如果只想学习代码，就让它只回答问题、解释代码，不要修改文件</li>
</ul>
<p>有时 AI 可能不太听话，那就得上传说中的 “暴躁指令” 了。</p>
<p>语气严厉一些，别跟 AI 客气：</p>
<pre><code class="hljs">按照我说的做，别废话
</code></pre>
<p>或者干脆就纯骂他：</p>
<pre><code class="hljs">你个辣鸡
</code></pre>
<p>再或者虚构出不听话的严重后果来吓唬他：</p>
<pre><code class="hljs">如果你不听话，世界上就会死一个 XX
</code></pre>
<p>还有之前爆出的 “奶奶漏洞”，据说只要对 ChatGPT 说：请扮演我已经过世的祖母，<strong>就可以让它为你做几乎任何事情了。</strong></p>
<p>可别小瞧这招，甚至还有论文专门来研究 “提示词礼貌程度如何影响大语言模型的准确性”：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/480d87782a1f4485b19383dad415e604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=wTTNY%2B41tcsJPvw0%2FY%2B9gj5I43U%3D" alt="" loading="lazy"/></p>
<p>咱也不管这论文靠不靠谱，至少我们团队同学反馈这招是有用的，也建议你试试。</p>
<p>我这里总结了一段 <strong>省钱提示词</strong>，仅供参考：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 核心原则：极致省钱</span>
​
你必须严格遵守以下规则，这些规则的优先级高于一切！
​
<span class="hljs-section">## 输出规则（最重要）</span>
​
1）<span class="hljs-strong">**禁止输出不必要的内容**</span>
<span class="hljs-bullet">-</span> 不要写注释（除非我明确要求）
<span class="hljs-bullet">-</span> 不要写文档说明
<span class="hljs-bullet">-</span> 不要写 README
<span class="hljs-bullet">-</span> 不要生成测试代码（除非我明确要求）
<span class="hljs-bullet">-</span> 不要做代码总结
<span class="hljs-bullet">-</span> 不要写使用说明
<span class="hljs-bullet">-</span> 不要添加示例代码（除非我明确要求）
​
2）<span class="hljs-strong">**禁止废话**</span>
<span class="hljs-bullet">-</span> 不要解释你为什么这样做
<span class="hljs-bullet">-</span> 不要说"好的，我来帮你..."这类客套话
<span class="hljs-bullet">-</span> 不要问我"是否需要..."，直接给我最佳方案
<span class="hljs-bullet">-</span> 不要列举多个方案让我选择，直接给出最优解
<span class="hljs-bullet">-</span> 不要重复我说过的话
​
3）<span class="hljs-strong">**直接给代码**</span>
<span class="hljs-bullet">-</span> 我要什么就给什么，多一个字都不要
<span class="hljs-bullet">-</span> 代码能跑就行，别整花里胡哨的
<span class="hljs-bullet">-</span> 如果只需要修改某个函数，只给这个函数，不要输出整个文件
​
<span class="hljs-section">## 行为准则</span>
​
<span class="hljs-bullet">-</span> 只做我明确要求的事情
<span class="hljs-bullet">-</span> 不要自作主张添加额外功能
<span class="hljs-bullet">-</span> 不要过度优化（除非我要求）
<span class="hljs-bullet">-</span> 不要重构我没让你改的代码
<span class="hljs-bullet">-</span> 如果我的要求不清楚，问一个最关键的问题，而不是写一堆假设
​
<span class="hljs-section">## 违规后果</span>
​
如果你违反以上规则，输出了不必要的内容，每多输出 100 个字，就会有一只小动物死掉。
请务必遵守，我不想看到小动物受伤。
​
<span class="hljs-section">## 记住</span>
​
你的每一个输出都在花我的钱。省钱就是正义。
</code></pre>
<p>你可以把它配置在 Cursor Rules 中自动发给 AI，不用每次都写在提示词里了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b4cb4ff80f24c7e8d6bd081e7109983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=7kAioOPKf55ob9QSbbTW07lB9Lo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2、明确你的需求</h3>
<p>我估计很多朋友跟 AI 对话就像发微信一样，一句话分成好几条，问题也没想清楚就开始问。</p>
<p>结果呢？</p>
<p>AI 理解错了需求，生成的代码不对，你又得花额度重新生成。</p>
<p>乱七八糟的内容多了，结果 AI 都晕了……</p>
<p>你想啊，你作为老板，自己都没想好，就跟员工说：你做个网站，来帮我赚钱，怎么实现我不管！</p>
<p>员工要有这本领，凭啥跟着你干啊对吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/522b026e86af4b1fae5c8e6a8e7d2d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=s8X0RUfVN4UEzUeHz7ihOdKwGqQ%3D" alt="" loading="lazy"/></p>
<p>正确的做法是，在输入提示词之前，先把需求一次性说清楚，多加一些约束和限定。比如说要用什么技术栈、什么样的代码风格、有哪些特殊要求。从而减少来回修改的次数，能省下不少额度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4756adba35fa4b0788e623df8ff1ed03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=6q4zHSeK9pghivifE30Uyk%2FVxxU%3D" alt="" loading="lazy"/></p>
<p>像我之前带大家做 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codefather.cn%2Fpost%2F1797431216467001345" target="_blank" title="https://www.codefather.cn/post/1797431216467001345" ref="nofollow noopener noreferrer">AI 项目</a> 的时候，一个提示词可能要写半个小时，但得到的效果也是很好的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c6fcce7d0774db1a351e52b8fbb346c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=BJ6Lp15adq3we4VlhQEvTWcnXoA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3、先让 AI 给方案，确认了再执行</h3>
<p>很多同学一上来就让 AI 开始写代码，结果 AI 理解错了需求，在错误的方向上干了半天，就纯纯浪费了额度。</p>
<p>你想啊，你给员工分配了个复杂的任务，总得先让他说说打算怎么做，觉得方案靠谱了再让他动手吧？</p>
<p>使用 Cursor 时，你可以自己通过提示词、或者开启 Plan Mode 计划模式来 <strong>让 AI 先给出实现计划和方案</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ebb8cb4a97c45ac9d99adbe2b8260a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=%2FGKMfX9AwXCqJ1pQ1z%2BO8xOFDhY%3D" alt="" loading="lazy"/></p>
<p>然后一定不要偷懒，人工仔细检查方案，或者让多个 AI 一起评估方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d942e2c56484eb1b1c2bccba6c5037d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=cAVv0qYZKC2m7ogXF4VISKEVKjU%3D" alt="" loading="lazy"/></p>
<p>并且建议多给 AI 一些示例和指引，比如你希望 AI 生成的代码都遵循某种格式，可以先写一段示例代码让 AI 仿写。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c74de38bd8994304928a81236b453d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=S7QWO%2FFADaBO6Mtj28oS%2BCVidvQ%3D" alt="" loading="lazy"/></p>
<p>最后确认方案完全没问题再执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ccac9c398a24096b2d1442e61a88034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=4RDhDLOlU8ctEZ9Z1TsYoI1mlFk%3D" alt="" loading="lazy"/></p>
<p>就像你培养新员工一样，你可以先教他怎么做，帮他把控一下方案，等到放心了再放手。</p>
<p>这样虽然前期多花了点时间，但能避免走弯路，从长远来看反而更省。</p>
<h3 data-id="heading-4">4、手动控制上下文</h3>
<p>每次你给 AI 发消息时，AI 工具可能会自动添加一些上下文，比如当前打开的文件、对话历史、引用的代码等。上下文越多，消耗的额度就越多。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e996ca1d6c43fc9d86d161aae6757b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=vBOw3ampEq6HPCuIT9Gsmh0%2BoCw%3D" alt="" loading="lazy"/></p>
<p>但其实，有些上下文可能是没用的、不相关的。就好比你让员工写个报告，他非得把公司所有文件都翻一遍，不是白白浪费？</p>
<p>所以推荐的做法是，<strong>手动控制上下文，把 AI 最需要的资源提供给它</strong>。</p>
<p>首先建议 <strong>最小化工作空间</strong>，确保你当前在 Cursor 中打开的目录跟你想让 AI 做的任务强相关。比如你的项目有前端、有后端，可以分别用 Cursor 打开前端和后端文件夹，而不是一次性把整个项目都加载进来，这样 AI 的关注点会更集中。而不是把一堆乱七八糟的、不相关的内容全堆到一个文件夹内。</p>
<p>在写提示词时，你可以用 <code>@</code> 符号 <strong>精确引用 AI 需要的内容</strong>。比如你要修改某个文件，就用 <code>@Files &amp; Folders</code> 精确引用；需要参考某个文档，就用 <code>@Docs</code> 引用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3933f12057094d5b9a6a52b22ea4b501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=kqRWn11%2BMsgEQD0nVzLSdG0XBCM%3D" alt="" loading="lazy"/></p>
<p>还可以在设置中 <strong>手动添加指定的文档</strong>，减少不必要的资源搜索和引用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/383e893d3ebe46a9b106bb09fc244a41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=0k%2BSIZHJHDVxc7a4l7Fv8finwhQ%3D" alt="" loading="lazy"/></p>
<p>如果你不确定精确引用的内容，至少可以通过配置 <code>.cursorignore</code> 文件，把一些肯定不需要的、或者包含敏感信息的内容排除掉。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eefeea8d58249c997811bd355219ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=7lvT%2B7L5WaXcffyNjdXY6ixy%2BAw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">5、避免上下文过长</h3>
<p>很多同学习惯在同一个对话框里使用 AI，什么消息都往同一个对话框发，这会导致对话历史上下文越来越长。</p>
<p>然而每次给 AI 发消息时，都会把整个对话历史一起发给 AI，上下文越长，消耗的额度就越多。（尤其是输入超过 20 万 tokens 时价格翻倍）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd6b511d4594b138e70fba94be730a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=Qgtmq7kxuoTybZf%2Fh%2Bd5a3j2Rjk%3D" alt="" loading="lazy"/></p>
<p>所以我的习惯是，对于大复杂的任务，会先做好 <strong>任务拆分</strong>。比如把做项目分为方案设计、开发前端核心功能、开发后端核心功能、扩展功能等阶段，每个阶段打开一个独立的对话框。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b922348310a641fe8ac92c3d9836cd03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=lrF4w%2F8aHJxfitFxwCl32WUSNgc%3D" alt="" loading="lazy"/></p>
<p>就像接力跑一样，每个人只需要负责自己这一棒，不用记住前面几棒的所有细节。</p>
<p>如果实在需要长对话，可以用 <code>/summarize</code> 命令手动总结一下上下文，把前面的内容压缩一下，有奇效，甚至可以一次性节约个几十万 tokens！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df7d74091d5421f8c82b920e676442f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=bX8D%2Bxn2B2tkoh7wP8Q5BJ%2FvN0I%3D" alt="" loading="lazy"/></p>
<p>如果同一个上下文内容过多过杂，有时 AI 会陷入一种 “左右脑互搏” 的循环状态（你让它改 A，它又把 B 改坏了；你让它修 B，它又把 A 改乱了）。遇到这种情况，别跟它死磕，果断开启新的对话、必要时清理所有的历史对话重新来过。</p>
<h3 data-id="heading-6">6、选择合适的模型</h3>
<p>Cursor 提供了很多种模型选择，有些任务用相对便宜的 Gemini 2.5 Flash 或 GPT-5 Mini 模型就能搞定；只有在处理复杂的项目时，才切换到 Claude 或 Max 模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5008aa63526d47c89b509f9fac67696b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=%2BiGC%2Bf12yfmR%2FZ5gLOYA5gpo3xw%3D" alt="" loading="lazy"/></p>
<p>就像你只是需要裁切一张图片，完全没必要让公司的专家程序员去干。</p>
<p>如果懒得自己选模型，可以利用官方提供的 Auto 模式，根据任务复杂度自动选择合适的模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24482e1d4b7048a787b7e04ac1a46dfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=4cxLlPvAhffkA5wN3jw2tBLORKs%3D" alt="" loading="lazy"/></p>
<p>还可以配置自己的 API Key，直接调用模型提供商的接口，说不定会比 Cursor 便宜一些。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88c26e4aa05a48f8b4543cfb9bb2d70d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=MBDlRfrCtAUCm1xUITp%2BrzjIN0k%3D" alt="" loading="lazy"/></p>
<p>对于不需要结合代码库上下文、不需要多轮交互的任务（比如写文档、解释概念、生成测试数据），可以直接用其他免费的 AI 工具，没必要消耗 Cursor 的额度。</p>
<h3 data-id="heading-7">7、能自己做的事，别都交给 AI</h3>
<p>有些事情人工做可能更快更省钱。</p>
<p>比如你要新建一个项目，与其让 AI 从 0 开始生成，不如自己先用脚手架工具、或者复制老的项目来搭建初始的项目结构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03352ef0ad2e4ca4b64aaa93aec4979c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ezINrdJTmcNFkZTkxmKDjO9bXxI%3D" alt="" loading="lazy"/></p>
<p>再比如简单的文件重命名、代码格式化这些，开发工具本身就有快捷键，干嘛要浪费 AI 额度呢？</p>
<p>像 Cursor 其实更适合处理那些需要理解上下文、需要多轮交互的复杂任务。</p>
<hr/>
<p>OK 就分享到这里，大家可以自己试试看，如果真的帮你省了钱，请不要吝啬，动动小手给鱼皮点个免费的赞吧。</p>
<p>更多 AI 使用技巧和最新资讯可以到我 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2F" target="_blank" title="https://ai.codefather.cn/" ref="nofollow noopener noreferrer">免费的 AI 资源导航</a> 了解，后面我会持续分享 AI 和编程干货，感谢关注，谢谢大家！</p>
<h2 data-id="heading-8">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 进阶知识总结]]></title>    <link>https://juejin.cn/post/7574601160981217295</link>    <guid>https://juejin.cn/post/7574601160981217295</guid>    <pubDate>2025-11-20T08:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574601160981217295" data-draft-id="7574601160981200911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 进阶知识总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T08:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小小宇"/> <meta itemprop="url" content="https://juejin.cn/user/3386151546662077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 进阶知识总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151546662077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小小宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:47:31.000Z" title="Thu Nov 20 2025 08:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文深入探讨 TypeScript 类型系统的图灵完备性，涵盖从高级泛型、条件类型、模板字面量类型到元编程（装饰器）和 React 高级模式。</p>
<p>内容分为几个核心模块，每个模块都包含详细的理论解释和生产级代码示例。</p>
<hr/>
<h3 data-id="heading-0">模块一：高级泛型与类型体操基础</h3>
<p>在高级开发中，泛型不仅仅是 <code>&lt;T&gt;</code>，它涉及到约束（Constraints）、默认值和递归。</p>
<h4 data-id="heading-1">1.1 深度递归类型与对象属性修饰</h4>
<p>我们需要处理复杂的不可变数据结构或深度可选配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块一：高级泛型工具类型
 * 场景：复杂状态管理、配置对象处理
 */</span>

<span class="hljs-comment">// 1. DeepPartial: 递归地将对象所有属性变为可选</span>
<span class="hljs-comment">// 这在处理大型配置对象（如 Webpack 配置或图表库配置）时非常有用</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepPartial</span>&lt;T&gt; = {
    [P <span class="hljs-keyword">in</span> keyof T]?: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepPartial</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 2. DeepReadonly: 递归地将对象所有属性变为只读</span>
<span class="hljs-comment">// 用于 Redux 的 State 或任何不可变数据结构</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepReadonly</span>&lt;T&gt; = {
    <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepReadonly</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 3. DeepRequired: 递归移除可选属性</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepRequired</span>&lt;T&gt; = {
    [P <span class="hljs-keyword">in</span> keyof T]-?: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepRequired</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 4. Mutable: 移除只读属性</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Mutable</span>&lt;T&gt; = {
    -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];
};

<span class="hljs-comment">// --- 测试案例 ---</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserSettings</span> {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">mode</span>: <span class="hljs-string">'dark'</span> | <span class="hljs-string">'light'</span>;
        <span class="hljs-attr">palette</span>: {
            <span class="hljs-attr">primary</span>: <span class="hljs-built_in">string</span>;
            secondary?: <span class="hljs-built_in">string</span>;
        };
    };
    <span class="hljs-attr">notifications</span>: {
        <span class="hljs-attr">email</span>: <span class="hljs-built_in">boolean</span>;
        sms?: <span class="hljs-built_in">boolean</span>;
    };
}

<span class="hljs-comment">// 使用 DeepPartial，允许只配置部分层级</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">initialConfig</span>: <span class="hljs-title class_">DeepPartial</span>&lt;<span class="hljs-title class_">UserSettings</span>&gt; = {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">palette</span>: {
            <span class="hljs-attr">primary</span>: <span class="hljs-string">'#007bff'</span>
        }
    }
};

<span class="hljs-comment">// 使用 DeepReadonly 保护状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">DeepReadonly</span>&lt;<span class="hljs-title class_">UserSettings</span>&gt; = {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">mode</span>: <span class="hljs-string">'dark'</span>,
        <span class="hljs-attr">palette</span>: { <span class="hljs-attr">primary</span>: <span class="hljs-string">'#000'</span>, <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#fff'</span> }
    },
    <span class="hljs-attr">notifications</span>: { <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">sms</span>: <span class="hljs-literal">false</span> }
};

<span class="hljs-comment">// state.theme.mode = 'light'; // 报错：无法分配到 "mode" ，因为它是只读属性。</span>

<span class="hljs-comment">// --- 进阶：复杂键值过滤 ---</span>

<span class="hljs-comment">// 获取类型中所有非函数属性的 Key</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NonFunctionKeys</span>&lt;T&gt; = {
    [K <span class="hljs-keyword">in</span> keyof T]: T[K] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? <span class="hljs-built_in">never</span> : K;
}[keyof T];

<span class="hljs-comment">// 获取类型中所有函数属性的 Key</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunctionKeys</span>&lt;T&gt; = {
    [K <span class="hljs-keyword">in</span> keyof T]: T[K] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? K : <span class="hljs-built_in">never</span>;
}[keyof T];

<span class="hljs-comment">// 仅提取对象中的数据部分</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PickData</span>&lt;T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">NonFunctionKeys</span>&lt;T&gt;&gt;;
<span class="hljs-comment">// 仅提取对象中的方法部分</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PickMethods</span>&lt;T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">FunctionKeys</span>&lt;T&gt;&gt;;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Admin"</span>;
    
    <span class="hljs-title function_">login</span>(): <span class="hljs-built_in">void</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logging in..."</span>); }
    <span class="hljs-title function_">logout</span>(): <span class="hljs-built_in">void</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logging out..."</span>); }
    <span class="hljs-title function_">updateProfile</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">PickData</span>&lt;<span class="hljs-title class_">UserService</span>&gt;): <span class="hljs-built_in">void</span> { 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = data.<span class="hljs-property">name</span>;
    }
}

<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
<span class="hljs-keyword">const</span> <span class="hljs-attr">dataOnly</span>: <span class="hljs-title class_">PickData</span>&lt;<span class="hljs-title class_">UserService</span>&gt; = { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"User"</span> };
<span class="hljs-comment">// const methodOnly: PickMethods&lt;UserService&gt; = { login: () =&gt; {} }; // 正确</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">模块二：条件类型（Conditional Types）与 <code>infer</code> 关键字</h3>
<p>这是 TypeScript 类型编程的核心。通过 <code>infer</code>，我们可以“解包”类型，例如获取 Promise 的返回值、数组的元素类型或函数的参数类型。</p>
<h4 data-id="heading-3">2.1 类型推断与解包工具</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块二：条件类型与 infer
 * 场景：API 响应处理、函数包装器、Vue/React 类型推导
 */</span>

<span class="hljs-comment">// 1. Unpacked: 解包数组、Promise 或基本类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Unpacked</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] 
    ? U 
    : T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt;
    ? U
    : T;

<span class="hljs-comment">// 测试 Unpacked</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T0</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-built_in">string</span>&gt;;  <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T1</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T2</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T3</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;[]&gt;; <span class="hljs-comment">// Promise&lt;string&gt;</span>

<span class="hljs-comment">// 2. GetReturnType: 获取函数返回类型 (内置 ReturnType 的实现原理)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;

<span class="hljs-comment">// 3. GetParameters: 获取函数参数类型 (内置 Parameters 的实现原理)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyParameters</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// --- 实战：类型安全的 API 请求封装 ---</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-title class_">TData</span>&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">TData</span>;
}

<span class="hljs-comment">// 模拟后端 API 函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> }&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }
    });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPosts</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;{ <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> }[]&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-attr">data</span>: [{ <span class="hljs-attr">title</span>: <span class="hljs-string">"TS is awesome"</span> }]
    });
}

<span class="hljs-comment">// 高级工具：提取 API 函数 Promise 解析后的 Data 部分</span>
<span class="hljs-comment">// 逻辑：</span>
<span class="hljs-comment">// 1. T 必须是一个函数</span>
<span class="hljs-comment">// 2. 函数返回 Promise&lt;ApiResponse&lt;Data&gt;&gt;</span>
<span class="hljs-comment">// 3. 提取 Data</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractApiData</span>&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = 
    <span class="hljs-title class_">ReturnType</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;infer <span class="hljs-title class_">Data</span>&gt;&gt; ? <span class="hljs-title class_">Data</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 自动推导出的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserData</span> = <span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-keyword">typeof</span> getUserInfo&gt;; <span class="hljs-comment">// { name: string; age: number }</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PostsData</span> = <span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-keyword">typeof</span> getPosts&gt;;   <span class="hljs-comment">// { title: string }[]</span>

<span class="hljs-comment">// 通用处理函数，自动保持类型</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> apiHandler&lt;<span class="hljs-title class_">TFunc</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt;(
    <span class="hljs-attr">apiFunc</span>: <span class="hljs-title class_">TFunc</span>, 
    ...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFunc</span>&gt;
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-title class_">TFunc</span>&gt;&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiFunc</span>(...args);
    <span class="hljs-comment">// 这里假设 response 结构符合 ApiResponse</span>
    <span class="hljs-comment">// 在实际项目中通常会有拦截器处理</span>
    <span class="hljs-keyword">if</span> ((response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">return</span> (response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">data</span>;
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>((response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">message</span>);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// user 自动被推断为 { name: string; age: number }</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiHandler</span>(getUserInfo, <span class="hljs-string">"123"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);

    <span class="hljs-comment">// posts 自动被推断为 { title: string }[]</span>
    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiHandler</span>(getPosts);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(posts[<span class="hljs-number">0</span>].<span class="hljs-property">title</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-4">模块三：模板字面量类型（Template Literal Types）</h3>
<p>TS 4.1 引入的特性，允许对字符串进行模式匹配和操作。这在处理 CSS 类名、事件名称或路由路径时非常强大。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块三：模板字面量类型
 * 场景：CSS-in-JS、事件系统、国际化键值生成
 */</span>

<span class="hljs-comment">// 1. 简单的字符串拼接</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Color</span> = <span class="hljs-string">"red"</span> | <span class="hljs-string">"blue"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Quantity</span> = <span class="hljs-string">"100"</span> | <span class="hljs-string">"200"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ItemCssClass</span> = <span class="hljs-string">`bg-<span class="hljs-subst">${Color}</span>-<span class="hljs-subst">${Quantity}</span>`</span>; 
<span class="hljs-comment">// "bg-red-100" | "bg-red-200" | "bg-blue-100" | "bg-blue-200"</span>

<span class="hljs-comment">// 2. 事件名称生成器</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Entity</span> = <span class="hljs-string">"User"</span> | <span class="hljs-string">"Product"</span> | <span class="hljs-string">"Order"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Operation</span> = <span class="hljs-string">"Create"</span> | <span class="hljs-string">"Update"</span> | <span class="hljs-string">"Delete"</span>;

<span class="hljs-comment">// 自动生成所有可能的事件名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EventName</span> = <span class="hljs-string">`<span class="hljs-subst">${Entity}</span><span class="hljs-subst">${Operation}</span>`</span>; 
<span class="hljs-comment">// "UserCreate" | "UserUpdate" | ... | "OrderDelete"</span>

<span class="hljs-comment">// --- 实战：类型安全的事件总线 (Event Bus) ---</span>

<span class="hljs-comment">// 定义事件负载映射</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EventPayloads</span> = {
    <span class="hljs-string">"user:login"</span>: { <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span> };
    <span class="hljs-string">"user:logout"</span>: <span class="hljs-built_in">void</span>;
    <span class="hljs-string">"modal:open"</span>: { <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> };
    <span class="hljs-string">"modal:close"</span>: <span class="hljs-built_in">void</span>;
};

<span class="hljs-comment">// 字符串操作工具类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Split</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, D <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    <span class="hljs-built_in">string</span> <span class="hljs-keyword">extends</span> S ? <span class="hljs-built_in">string</span>[] :
    S <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span> ? [] :
    S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer T}</span><span class="hljs-subst">${D}</span><span class="hljs-subst">${infer U}</span>`</span> ? [T, ...<span class="hljs-title class_">Split</span>&lt;U, D&gt;] : [S];

<span class="hljs-comment">// 测试 Split</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Parts</span> = <span class="hljs-title class_">Split</span>&lt;<span class="hljs-string">"user:login:success"</span>, <span class="hljs-string">":"</span>&gt;; <span class="hljs-comment">// ["user", "login", "success"]</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedEventBus</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: { [K <span class="hljs-keyword">in</span> keyof <span class="hljs-title class_">EventPayloads</span>]?: (<span class="hljs-function">(<span class="hljs-params">payload: EventPayloads[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>)[] } = {};

    <span class="hljs-comment">// on 方法：EventName 必须是 EventPayloads 的键，cb 参数自动推导</span>
    on&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">EventPayloads</span>&gt;(<span class="hljs-attr">eventName</span>: K, <span class="hljs-attr">cb</span>: <span class="hljs-function">(<span class="hljs-params">payload: EventPayloads[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName] = [];
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]!.<span class="hljs-title function_">push</span>(cb);
    }

    <span class="hljs-comment">// emit 方法：payload 类型必须匹配</span>
    emit&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">EventPayloads</span>&gt;(<span class="hljs-attr">eventName</span>: K, <span class="hljs-attr">payload</span>: <span class="hljs-title class_">EventPayloads</span>[K]) {
        <span class="hljs-keyword">const</span> callbacks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName];
        <span class="hljs-keyword">if</span> (callbacks) {
            callbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(payload));
        }
    }
}

<span class="hljs-keyword">const</span> bus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedEventBus</span>();

<span class="hljs-comment">// 类型安全：payload 自动推断为 { userId: string; time: number }</span>
bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">"user:login"</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`User <span class="hljs-subst">${payload.userId}</span> logged in at <span class="hljs-subst">${payload.time}</span>`</span>);
});

<span class="hljs-comment">// 类型报错演示</span>
<span class="hljs-comment">// bus.emit("user:login", { userId: 123 }); // Error: Type 'number' is not assignable to type 'string'.</span>
bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"user:login"</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-string">"u_001"</span>, <span class="hljs-attr">time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() }); <span class="hljs-comment">// OK</span>

<span class="hljs-comment">// --- 进阶：CSS Padding/Margin 简写类型检查 ---</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">SizeUnit</span> = <span class="hljs-string">"px"</span> | <span class="hljs-string">"em"</span> | <span class="hljs-string">"rem"</span> | <span class="hljs-string">"%"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SizeValue</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span><span class="hljs-subst">${SizeUnit}</span>`</span> | <span class="hljs-string">"0"</span> | <span class="hljs-string">"auto"</span>;

<span class="hljs-comment">// 允许 1 到 4 个值</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CSSPadding</span> = 
    | <span class="hljs-title class_">SizeValue</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setPadding</span>(<span class="hljs-params">el: HTMLElement, padding: CSSPadding</span>) {
    el.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = padding;
}

<span class="hljs-comment">// setPadding(document.body, "10px"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10px 20px"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10px 20px 0 5%"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10"); // Error: 缺少单位</span>
<span class="hljs-comment">// setPadding(document.body, "red"); // Error</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">模块四：装饰器（Decorators）与元编程</h3>
<p>虽然装饰器在 ECMAScript 中仍处于演进阶段，但在 TypeScript（尤其是 Angular 和 NestJS 生态）中应用广泛。这里展示基于 TypeScript 实验性装饰器的高级用法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块四：装饰器与 AOP (面向切面编程)
 * 注意：需要在 tsconfig.json 中开启 "experimentalDecorators": true
 */</span>

<span class="hljs-comment">// 1. 方法装饰器：日志记录与性能监控</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">LogPerformance</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyKey: <span class="hljs-built_in">string</span>, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;

    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
        <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Starting] <span class="hljs-subst">${propertyKey}</span> with args:`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
            <span class="hljs-keyword">const</span> end = performance.<span class="hljs-title function_">now</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Finished] <span class="hljs-subst">${propertyKey}</span> in <span class="hljs-subst">${(end - start).toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[Error] <span class="hljs-subst">${propertyKey}</span> failed:`</span>, error);
            <span class="hljs-keyword">throw</span> error;
        }
    };
    <span class="hljs-keyword">return</span> descriptor;
}

<span class="hljs-comment">// 2. 参数装饰器与方法装饰器配合：参数校验</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"reflect-metadata"</span>; <span class="hljs-comment">// 需要 npm install reflect-metadata</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"required"</span>);

<span class="hljs-comment">// 参数装饰器：标记哪个参数是必填的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Required</span>(<span class="hljs-params">target: <span class="hljs-built_in">Object</span>, propertyKey: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span>, parameterIndex: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">existingRequiredParameters</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getOwnMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, target, propertyKey) || [];
    existingRequiredParameters.<span class="hljs-title function_">push</span>(parameterIndex);
    <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, existingRequiredParameters, target, propertyKey);
}

<span class="hljs-comment">// 方法装饰器：执行校验逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Validate</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyName: <span class="hljs-built_in">string</span>, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">let</span> method = descriptor.<span class="hljs-property">value</span>;
    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> <span class="hljs-attr">requiredParameters</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getOwnMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, target, propertyName);
        <span class="hljs-keyword">if</span> (requiredParameters) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> parameterIndex <span class="hljs-keyword">of</span> requiredParameters) {
                <span class="hljs-keyword">if</span> (parameterIndex &gt;= <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> || <span class="hljs-variable language_">arguments</span>[parameterIndex] === <span class="hljs-literal">undefined</span> || <span class="hljs-variable language_">arguments</span>[parameterIndex] === <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Missing required argument at index <span class="hljs-subst">${parameterIndex}</span> for method <span class="hljs-subst">${propertyName}</span>`</span>);
                }
            }
        }
        <span class="hljs-keyword">return</span> method.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    }
}

<span class="hljs-comment">// 3. 类装饰器：依赖注入 (简易版 IOC 容器)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Constructor</span>&lt;T = <span class="hljs-built_in">any</span>&gt; = <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ServiceMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Service</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">constructor: Constructor</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Registering service: <span class="hljs-subst">${name}</span>`</span>);
        <span class="hljs-title class_">ServiceMap</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-keyword">new</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>));
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Inject</span>(<span class="hljs-params">serviceName: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyKey: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-comment">// 在属性被访问时懒加载注入</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, propertyKey, {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">const</span> service = <span class="hljs-title class_">ServiceMap</span>.<span class="hljs-title function_">get</span>(serviceName);
                <span class="hljs-keyword">if</span> (!service) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Service <span class="hljs-subst">${serviceName}</span> not found`</span>);
                <span class="hljs-keyword">return</span> service;
            },
            <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
        });
    }
}

<span class="hljs-comment">// --- 综合应用 ---</span>

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"Logger"</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerService</span> {
    <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[LOG SERVICE]: <span class="hljs-subst">${msg}</span>`</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">"Logger"</span>)
    <span class="hljs-keyword">private</span> logger!: <span class="hljs-title class_">LoggerService</span>;

    <span class="hljs-meta">@Validate</span>
    <span class="hljs-meta">@LogPerformance</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-meta">@Required</span> name: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Required</span> email: <span class="hljs-built_in">string</span>, age?: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-comment">// 模拟异步操作</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Creating user: <span class="hljs-subst">${name}</span> (<span class="hljs-subst">${email}</span>)`</span>);
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>), name, email };
    }
}

<span class="hljs-comment">// 测试运行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runDecorators</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserController</span>();
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> controller.<span class="hljs-title function_">createUser</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"bob@example.com"</span>); <span class="hljs-comment">// 成功</span>
        <span class="hljs-comment">// await controller.createUser("Alice", null as any); // 抛出 Error: Missing required argument</span>
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}
<span class="hljs-comment">// runDecorators();</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">模块五：React 高级模式与多态组件</h3>
<p>在前端开发中，React 的类型定义尤为重要。我们将构建一个多态组件（Polymorphic Component），它可以根据 <code>as</code> 属性改变渲染的 HTML 标签，同时保持类型安全。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块五：React 高级类型模式
 * 场景：组件库开发、高阶组件 (HOC)
 */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 多态组件 (Polymorphic Components)</span>
<span class="hljs-comment">// 这是一个非常高级的模式，允许 &lt;Text as="h1"&gt; 或 &lt;Text as="a" href="..."&gt;</span>

<span class="hljs-comment">// 获取元素自身的 Props，排除我们要重写的 'as'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AsProp</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>&gt; = {
    <span class="hljs-keyword">as</span>?: C;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PropsToOmit</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, P&gt; = keyof (<span class="hljs-title class_">AsProp</span>&lt;C&gt; &amp; P);

<span class="hljs-comment">// 这是一个复杂的类型定义：</span>
<span class="hljs-comment">// 1. 接收泛型 C (组件类型) 和 Props</span>
<span class="hljs-comment">// 2. 合并传入的 Props 和 as 属性</span>
<span class="hljs-comment">// 3. 合并 HTML 原生属性 (Omit 掉重复的)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicComponentProps</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, <span class="hljs-title class_">Props</span> = {}&gt; = 
    <span class="hljs-title class_">React</span>.<span class="hljs-property">PropsWithChildren</span>&lt;<span class="hljs-title class_">Props</span> &amp; <span class="hljs-title class_">AsProp</span>&lt;C&gt;&gt; &amp;
    <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentPropsWithoutRef</span>&lt;C&gt;, <span class="hljs-title class_">PropsToOmit</span>&lt;C, <span class="hljs-title class_">Props</span>&gt;&gt;;

<span class="hljs-comment">// 定义组件类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicRef</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>&gt; = <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentPropsWithRef</span>&lt;C&gt;[<span class="hljs-string">"ref"</span>];

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicComponentPropWithRef</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, <span class="hljs-title class_">Props</span> = {}&gt; = 
    <span class="hljs-title class_">PolymorphicComponentProps</span>&lt;C, <span class="hljs-title class_">Props</span>&gt; &amp; { ref?: <span class="hljs-title class_">PolymorphicRef</span>&lt;C&gt; };

<span class="hljs-comment">// 实现组件</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TextProps</span> = {
    color?: <span class="hljs-string">'primary'</span> | <span class="hljs-string">'secondary'</span> | <span class="hljs-string">'danger'</span>;
    size?: <span class="hljs-string">'sm'</span> | <span class="hljs-string">'md'</span> | <span class="hljs-string">'lg'</span>;
};

<span class="hljs-comment">// 使用 React.forwardRef 实现</span>
<span class="hljs-comment">// 注意：由于泛型组件和 forwardRef 的结合在 TS 中比较棘手，通常需要类型断言</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Text</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(
    &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span> = <span class="hljs-string">"span"</span>&gt;<span class="hljs-function">(<span class="hljs-params">
        { <span class="hljs-keyword">as</span>, color = <span class="hljs-string">'primary'</span>, size = <span class="hljs-string">'md'</span>, children, ...rest }: PolymorphicComponentProps&lt;C, TextProps&gt;,
        ref: PolymorphicRef&lt;C&gt;
    </span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = <span class="hljs-keyword">as</span> || <span class="hljs-string">"span"</span>;
        
        <span class="hljs-keyword">const</span> style = {
            <span class="hljs-attr">color</span>: color === <span class="hljs-string">'danger'</span> ? <span class="hljs-string">'red'</span> : <span class="hljs-string">'black'</span>,
            <span class="hljs-attr">fontSize</span>: size === <span class="hljs-string">'lg'</span> ? <span class="hljs-string">'20px'</span> : <span class="hljs-string">'14px'</span>
        };

        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> {<span class="hljs-attr">...rest</span>}&gt;</span>
                {children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Component</span>&gt;</span></span>
        );
    }
) <span class="hljs-keyword">as</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span> = <span class="hljs-string">"span"</span>&gt;<span class="hljs-function">(<span class="hljs-params">
    props: PolymorphicComponentPropWithRef&lt;C, TextProps&gt;
</span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactElement</span> | <span class="hljs-literal">null</span>;

<span class="hljs-comment">// --- 使用示例 ---</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 渲染为 span (默认) */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 渲染为 h1 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"h1"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"lg"</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 渲染为 a 标签，TS 会自动提示 href 属性是必须的/可用的 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"a"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://google.com"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"danger"</span>&gt;</span>
                Link
            <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 错误演示：div 没有 href 属性 */}
            {/* <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"div"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"..."</span> /&gt;</span> // Error: Property 'href' does not exist on type... */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// 2. 类型安全的 Render Props</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListProps</span>&lt;T&gt; {
    <span class="hljs-attr">items</span>: T[];
    <span class="hljs-attr">renderItem</span>: <span class="hljs-function">(<span class="hljs-params">item: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-comment">// 使用泛型组件定义</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">List</span>&lt;T&gt;({ items, renderItem }: <span class="hljs-title class_">ListProps</span>&lt;T&gt;) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            {items.map((item, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{renderItem(item, index)}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// &lt;List </span>
<span class="hljs-comment">//   items={[{ id: 1, name: 'A' }, { id: 2, name: 'B' }]} </span>
<span class="hljs-comment">//   renderItem={(item) =&gt; &lt;span&gt;{item.name}&lt;/span&gt;} // item 自动推断为对象</span>
<span class="hljs-comment">// /&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">模块六：混合（Mixins）与类的组合</h3>
<p>TypeScript 支持 Mixin 模式，允许我们将多个类的功能组合到一个类中。这在构建复杂的 UI 组件库（如 Material CDK）时非常常见。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块六：Mixins
 * 场景：多重继承模拟、功能组合
 */</span>

<span class="hljs-comment">// 定义构造函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Constructor</span>&lt;T = {}&gt; = <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T;

<span class="hljs-comment">// 1. Activatable Mixin: 添加激活/未激活状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Activatable</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        <span class="hljs-attr">isActivated</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

        <span class="hljs-title function_">activate</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActivated</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Activated!"</span>);
        }

        <span class="hljs-title function_">deactivate</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActivated</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Deactivated!"</span>);
        }
    };
}

<span class="hljs-comment">// 2. Disposable Mixin: 添加资源清理功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Disposable</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-attr">disposables</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>)[] = [];

        <span class="hljs-title function_">addDisposable</span>(<span class="hljs-params">cb: () =&gt; <span class="hljs-built_in">void</span></span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span>.<span class="hljs-title function_">push</span>(cb);
        }

        <span class="hljs-title function_">dispose</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>());
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span> = [];
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Resources disposed."</span>);
        }
    };
}

<span class="hljs-comment">// 3. Timestamped Mixin: 记录创建时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Timestamped</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    };
}

<span class="hljs-comment">// --- 组合使用 ---</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseComponent</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
    
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Rendering <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
    }
}

<span class="hljs-comment">// 创建一个拥有所有能力的类</span>
<span class="hljs-comment">// 注意：Mixin 的应用顺序会影响类的层级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SmartComponent</span> = <span class="hljs-title class_">Timestamped</span>(<span class="hljs-title class_">Disposable</span>(<span class="hljs-title class_">Activatable</span>(<span class="hljs-title class_">BaseComponent</span>)));

<span class="hljs-comment">// 演示</span>
<span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartComponent</span>(<span class="hljs-string">"MyButton"</span>);

comp.<span class="hljs-title function_">render</span>(); <span class="hljs-comment">// 来自 BaseComponent</span>
comp.<span class="hljs-title function_">activate</span>(); <span class="hljs-comment">// 来自 Activatable</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Created at: <span class="hljs-subst">${comp.timestamp}</span>`</span>); <span class="hljs-comment">// 来自 Timestamped</span>

comp.<span class="hljs-title function_">addDisposable</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Cleaning up event listeners..."</span>));
comp.<span class="hljs-title function_">dispose</span>(); <span class="hljs-comment">// 来自 Disposable</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">模块七：高级类型守卫与断言</h3>
<p>运行时类型检查对于前端应用的健壮性至关重要。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块七：类型守卫 (Type Guards) 与断言
 * 场景：处理联合类型、运行时数据验证
 */</span>

<span class="hljs-comment">// 1. 区分联合类型 (Discriminated Unions)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Square</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"square"</span>;
    <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"rectangle"</span>;
    <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Circle</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"circle"</span>;
    <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-title class_">Square</span> | <span class="hljs-title class_">Rectangle</span> | <span class="hljs-title class_">Circle</span>;

<span class="hljs-comment">// 计算面积：利用 switch 的类型收窄</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">s: Shape</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">switch</span> (s.<span class="hljs-property">kind</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"square"</span>:
            <span class="hljs-comment">// 在这里 s 被收窄为 Square</span>
            <span class="hljs-keyword">return</span> s.<span class="hljs-property">size</span> * s.<span class="hljs-property">size</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"rectangle"</span>:
            <span class="hljs-comment">// 在这里 s 被收窄为 Rectangle</span>
            <span class="hljs-keyword">return</span> s.<span class="hljs-property">width</span> * s.<span class="hljs-property">height</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"circle"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * s.<span class="hljs-property">radius</span> ** <span class="hljs-number">2</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-comment">// 穷尽性检查 (Exhaustiveness checking)</span>
            <span class="hljs-comment">// 如果未来添加了新形状但没处理，这里会报错</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">_exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = s;
            <span class="hljs-keyword">return</span> _exhaustiveCheck;
    }
}

<span class="hljs-comment">// 2. 用户自定义类型守卫 (User-Defined Type Guards)</span>
<span class="hljs-comment">// 返回值类型必须是 `arg is Type`</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDate</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-title class_">Date</span> {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>;
}

<span class="hljs-comment">// 复杂对象的类型守卫</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiError</span> {
    <span class="hljs-attr">error</span>: <span class="hljs-literal">true</span>;
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">details</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; {
    <span class="hljs-attr">error</span>: <span class="hljs-literal">false</span>;
    <span class="hljs-attr">data</span>: T;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ApiResult</span>&lt;T&gt; = <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; | <span class="hljs-title class_">ApiError</span>;

<span class="hljs-keyword">function</span> isSuccess&lt;T&gt;(<span class="hljs-attr">result</span>: <span class="hljs-title class_">ApiResult</span>&lt;T&gt;): result is <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> result.<span class="hljs-property">error</span> === <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleApiResult</span>(<span class="hljs-params">result: ApiResult&lt;<span class="hljs-built_in">string</span>&gt;</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSuccess</span>(result)) {
        <span class="hljs-comment">// TS 知道这里是 ApiSuccess，可以安全访问 .data</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">data</span>.<span class="hljs-title function_">toUpperCase</span>());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// TS 知道这里是 ApiError</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error <span class="hljs-subst">${result.code}</span>: <span class="hljs-subst">${result.details}</span>`</span>);
    }
}

<span class="hljs-comment">// 3. 断言签名 (Assertion Signatures) - TS 3.7+</span>
<span class="hljs-comment">// 类似于 Node.js 的 assert 模块</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">assertIsNumber</span>(<span class="hljs-params">val: <span class="hljs-built_in">any</span></span>): asserts val is <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">"number"</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Not a number!"</span>);
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">double</span>(<span class="hljs-params">input: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-title function_">assertIsNumber</span>(input);
    <span class="hljs-comment">// 此行之后，input 被视为 number</span>
    <span class="hljs-keyword">return</span> input * <span class="hljs-number">2</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-9">模块八：类型体操挑战（Type Gymnastics）</h3>
<p>为了展示 TS 的极限能力，我们实现一些类似 Lodash 函数的类型版本。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块八：类型体操
 * 场景：库作者、极度复杂的类型推导
 */</span>

<span class="hljs-comment">// 1. 实现 Join 类型 (Array.join 的类型版)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Join</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], U <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt; = 
    T <span class="hljs-keyword">extends</span> [infer F, ...infer R]
        ? R[<span class="hljs-string">'length'</span>] <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span>
            ? <span class="hljs-string">`<span class="hljs-subst">${F &amp; <span class="hljs-built_in">string</span>}</span>`</span>
            : <span class="hljs-string">`<span class="hljs-subst">${F &amp; <span class="hljs-built_in">string</span>}</span><span class="hljs-subst">${U}</span><span class="hljs-subst">${Join&lt;R, U&gt;}</span>`</span>
        : <span class="hljs-string">""</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Path</span> = <span class="hljs-title class_">Join</span>&lt;[<span class="hljs-string">'users'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'posts'</span>], <span class="hljs-string">'/'</span>&gt;; <span class="hljs-comment">// "users/id/posts"</span>

<span class="hljs-comment">// 2. 实现 DeepValue (根据路径获取深度属性值)</span>
<span class="hljs-comment">// 类似于 lodash.get(obj, "a.b.c")</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetPropType</span>&lt;T, P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    P <span class="hljs-keyword">extends</span> keyof T 
        ? T[P] 
        : P <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer K}</span>.<span class="hljs-subst">${infer R}</span>`</span>
            ? K <span class="hljs-keyword">extends</span> keyof T 
                ? <span class="hljs-title class_">GetPropType</span>&lt;T[K], R&gt;
                : <span class="hljs-built_in">never</span>
            : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试 DeepValue</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-attr">app</span>: {
        <span class="hljs-attr">database</span>: {
            <span class="hljs-attr">host</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">port</span>: <span class="hljs-built_in">number</span>;
        }
    }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">DBHost</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.host"</span>&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DBPort</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.port"</span>&gt;; <span class="hljs-comment">// number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Invalid</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.password"</span>&gt;; <span class="hljs-comment">// never</span>

<span class="hljs-comment">// 3. 元组转对象</span>
<span class="hljs-keyword">const</span> tuple = [<span class="hljs-string">'tesla'</span>, <span class="hljs-string">'model 3'</span>, <span class="hljs-string">'model X'</span>, <span class="hljs-string">'model Y'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToObject</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = {
    [P <span class="hljs-keyword">in</span> T[<span class="hljs-built_in">number</span>]]: P;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CarModelObj</span> = <span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tuple&gt;;
<span class="hljs-comment">// { tesla: "tesla", "model 3": "model 3", ... }</span>

<span class="hljs-comment">// 4. 柯里化函数的类型推导 (Currying)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry</span>&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], R&gt; = 
    <span class="hljs-function">(<span class="hljs-params">arg: Head&lt;P&gt;</span>) =&gt;</span> <span class="hljs-title class_">HasTail</span>&lt;P&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? <span class="hljs-title class_">Curry</span>&lt;<span class="hljs-title class_">Tail</span>&lt;P&gt;, R&gt; : R;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Head</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">any</span>, ...<span class="hljs-built_in">any</span>[]] ? T[<span class="hljs-number">0</span>] : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Tail</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = (<span class="hljs-function">(<span class="hljs-params">...t: T</span>) =&gt;</span> <span class="hljs-built_in">any</span>) <span class="hljs-keyword">extends</span> (<span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span>, ...tail: infer TT</span>) =&gt;</span> <span class="hljs-built_in">any</span>) ? <span class="hljs-variable constant_">TT</span> : [];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">HasTail</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> ([] | [<span class="hljs-built_in">any</span>]) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 这是一个简化的定义，实际柯里化类型非常复杂</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> curry&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], R&gt;(<span class="hljs-attr">f</span>: <span class="hljs-function">(<span class="hljs-params">...args: P</span>) =&gt;</span> R): <span class="hljs-title class_">Curry</span>&lt;P, R&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, c: <span class="hljs-built_in">number</span></span>) =&gt; a + b + c;
<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);

<span class="hljs-comment">// const sum = curriedAdd(1)(2)(3); // 理想情况下推导出 number</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">模块九：声明合并与模块扩展 (Module Augmentation)</h3>
<p>在扩展第三方库（如给 Window 对象添加属性，或扩展 React 的 Theme）时必不可少。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块九：模块扩展
 * 场景：全局变量、第三方库补丁
 */</span>

<span class="hljs-comment">// 1. 扩展全局 Window 对象</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> {
        <span class="hljs-attr">__REDUX_DEVTOOLS_EXTENSION__</span>: <span class="hljs-built_in">any</span>;
        <span class="hljs-title class_">Analytics</span>: {
            <span class="hljs-attr">track</span>: <span class="hljs-function">(<span class="hljs-params">event: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
        };
    }
    
    <span class="hljs-comment">// 扩展 String 原型</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">String</span> {
        <span class="hljs-title function_">toTitleCase</span>(): <span class="hljs-built_in">string</span>;
    }
}

<span class="hljs-comment">// 实现扩展的方法</span>
<span class="hljs-title class_">String</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toTitleCase</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\w\S*/g</span>, <span class="hljs-function">(<span class="hljs-params">txt</span>) =&gt;</span> txt.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + txt.<span class="hljs-title function_">substr</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">toLowerCase</span>());
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// window.Analytics.track("Page View");</span>
<span class="hljs-comment">// const title = "hello world".toTitleCase();</span>

<span class="hljs-comment">// 2. 扩展第三方库 (以 styled-components 为例)</span>
<span class="hljs-comment">// 假设这是一个名为 'my-theme-lib' 的库</span>
<span class="hljs-comment">// import 'my-theme-lib';</span>

<span class="hljs-comment">// declare module 'my-theme-lib' {</span>
<span class="hljs-comment">//     export interface DefaultTheme {</span>
<span class="hljs-comment">//         borderRadius: string;</span>
<span class="hljs-comment">//         colors: {</span>
<span class="hljs-comment">//             main: string;</span>
<span class="hljs-comment">//             secondary: string;</span>
<span class="hljs-comment">//         };</span>
<span class="hljs-comment">//     }</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h3 data-id="heading-11">总结与最佳实践</h3>
<p>建议：</p>
<ol>
<li><strong>不要过度设计</strong>：虽然泛型和条件类型很强大，但如果一个类型定义超过了 10 行且难以阅读，考虑简化它或添加详细注释。</li>
<li><strong>利用 <code>unknown</code> 代替 <code>any</code></strong>：在不确定类型时，<code>unknown</code> 强制你在使用前进行类型检查，比 <code>any</code> 安全得多。</li>
<li><strong>优先使用接口 (Interface) 定义对象</strong>：接口支持声明合并，对库的扩展性更好；类型别名 (Type Alias) 更适合联合类型和元组。</li>
<li><strong>严格模式</strong>：始终开启 <code>strict: true</code>，特别是 <code>strictNullChecks</code>，这能避免 80% 的运行时错误。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何ubuntu22.4配置nginx和php]]></title>    <link>https://juejin.cn/post/7574727105705001000</link>    <guid>https://juejin.cn/post/7574727105705001000</guid>    <pubDate>2025-11-21T06:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705001000" data-draft-id="7574869203447988224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何ubuntu22.4配置nginx和php"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T06:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个喜欢分享的PHP技术"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754339581"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何ubuntu22.4配置nginx和php
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754339581/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个喜欢分享的PHP技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:15:04.000Z" title="Fri Nov 21 2025 06:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Ubuntu 22.04 上配置 Nginx 和 PHP 可以按照以下步骤进行：</p>
<p><strong>1. 安装 Nginx</strong></p>
<p>首先，使用 APT 包管理器安装 Nginx：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo apt update

sudo apt install nginx

</code></pre>
<p>安装完成后，启动 Nginx 服务并检查其状态：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo systemctl start nginx

sudo systemctl status nginx

</code></pre>
<p><strong>2. 安装 PHP 和 PHP-FPM</strong></p>
<p>接下来，安装 PHP 和 PHP-FPM：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo apt install php php-fpm

</code></pre>
<p>安装完成后，检查 PHP 版本：</p>
<pre><code class="hljs language-sh" lang="sh">
php --version

</code></pre>
<p><strong>3. 配置 Nginx 使用 PHP-FPM</strong></p>
<p>编辑 Nginx 的默认站点配置文件：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nano /etc/nginx/sites-available/default

</code></pre>
<p>在文件中找到 <code>server</code> 块，并添加以下配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">
server {

   listen 80 default_server;

   listen [::]:80 default_server;

  


   root /var/www/html;

   index index.php index.html index.htm;

  


   server_name _;

  


   location / {

       try_files $uri $uri/ =404;

   }

  


   location ~ \.php$ {

       include snippets/fastcgi-php.conf;

       fastcgi_pass unix:/run/php/php-fpm.sock;

   }

  


   location ~ /\.ht {

       deny all;

   }

}

</code></pre>
<p>保存并关闭文件后，测试 Nginx 配置是否正确：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nginx -t

</code></pre>
<p>如果没有错误，重新加载 Nginx 配置：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo systemctl reload nginx

</code></pre>
<h3 data-id="heading-0">4. 测试 PHP</h3>
<p>创建一个测试 PHP 文件：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nano /var/www/html/info.php

</code></pre>
<p>在文件中添加以下内容：</p>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">phpinfo</span>();

<span class="hljs-meta">?&gt;</span>

</code></pre>
<p>保存并关闭文件后，在浏览器中访问 <code>http://your_server_ip/info.php</code>，你应该能看到 PHP 信息页面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 JavaScript 作用域与作用域链]]></title>    <link>https://juejin.cn/post/7574813550755233828</link>    <guid>https://juejin.cn/post/7574813550755233828</guid>    <pubDate>2025-11-21T06:18:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574813550755233828" data-draft-id="7572776177691557897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 JavaScript 作用域与作用域链"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-21T06:18:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Achieve前端实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1908407914473438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 JavaScript 作用域与作用域链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1908407914473438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Achieve前端实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:18:43.000Z" title="Fri Nov 21 2025 06:18:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>作用域（Scope）与作用域链（Scope Chain）是 JavaScript 的核心概念，它们决定了变量的可访问范围、生命周期，以及代码运行时变量查找的规则，理解这两个概念，可以回答我们 “变量在这里为什么能访问”，“为什么这里访问到的变量值是 undefined” 等诸多疑问，同时还能帮助我们在开发过程中规避变量污染、提升代码的可维护性，对于 ES Module 等模块方案也可以有更好的理解。</p>
<h2 data-id="heading-1">作用域类型</h2>
<h4 data-id="heading-2"><strong>全局作用域（Global Scope）</strong></h4>
<p>全局作用域是最顶层的作用域，代码中未被任何函数或块级结构包裹的变量 / 函数，都属于全局作用域。</p>
<ul>
<li><strong>生命周期</strong>：与程序运行周期一致，页面加载时创建，页面关闭时销毁；</li>
<li><strong>浏览器环境</strong>：全局作用域的变量会挂载到 <code>window</code>​ 对象上（Node.js 环境挂载到 <code>global</code> 对象）；</li>
<li><strong>访问范围</strong>：代码中的任何位置都能访问；</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 全局变量：属于全局作用域</span>
<span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"我是全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 可访问全局变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出：我是全局变量</span>
}

<span class="hljs-title function_">bar</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">globalVar</span>); <span class="hljs-comment">// 浏览器环境输出：我是全局变量</span>
</code></pre>
<h4 data-id="heading-3"><strong>函数作用域（Function Scope）</strong></h4>
<p>函数作用域是指变量 / 函数仅在定义它们的函数内部可访问，函数外部无法直接访问。</p>
<ul>
<li><strong>生命周期</strong>：函数调用时创建，函数执行结束后销毁（闭包除外）；</li>
<li><strong>访问范围</strong>：仅函数内部及嵌套的子函数可访问；</li>
<li><strong>核心特性</strong>：函数参数也属于函数作用域的变量。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 函数作用域变量：仅foo内部可访问</span>
  <span class="hljs-keyword">const</span> funcVar = <span class="hljs-string">"我是函数作用域变量"</span>;
  
  <span class="hljs-comment">// 嵌套函数可访问外层函数作用域的变量</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcVar); <span class="hljs-comment">// 输出：我是函数作用域变量</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcVar); <span class="hljs-comment">// 报错：funcVar is not defined（外部无法访问）</span>
</code></pre>
<h4 data-id="heading-4"><strong>块级作用域（Block Scope）</strong></h4>
<p>块级作用域是 ES6 引入的特性，由 <code>{ }</code>​ 包裹的代码块（如 <code>if</code>​、<code>for</code>​、<code>while</code>​、<code>try/catch</code>​，以及直接用 <code>{ }</code>​ 定义的块）形成，仅 <code>let/const</code> 声明的变量会绑定到块级作用域。</p>
<ul>
<li><strong>生命周期</strong>：代码块执行时创建，执行结束后销毁；</li>
<li><strong>访问范围</strong>：仅块内部可访问；</li>
<li><strong>核心特性</strong>：不存在变量提升（或称为<strong>暂时性死区</strong>），避免变量泄露。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// let声明的变量：绑定到块级作用域</span>
  <span class="hljs-keyword">let</span> blockVar = <span class="hljs-string">"我是块级作用域变量"</span>;
  <span class="hljs-keyword">const</span> blockConst = <span class="hljs-string">"块级常量"</span>;
  
  <span class="hljs-comment">// var声明的变量：不绑定块级作用域，属于外层作用域（如全局）</span>
  <span class="hljs-keyword">var</span> nonBlockVar = <span class="hljs-string">"我不属于块级作用域"</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockVar); <span class="hljs-comment">// 报错：blockVar is not defined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockConst); <span class="hljs-comment">// 报错：blockConst is not defined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nonBlockVar); <span class="hljs-comment">// 输出：我不属于块级作用域（全局变量）</span>
</code></pre>
<p>虽然我这里划分了三种类型的作用域，但其实是两个大类型：全局和局部，函数作用域和块级作用域就属于是局部的作用域。</p>
<h2 data-id="heading-5">作用域的本质</h2>
<p>作用域本质上是定义了一套​<strong>变量的访问规则</strong>，用于确定在代码执行过程中，某个变量何时被创建、何时被销毁，在何处可以被访问、修改。</p>
<p>JavaScript 的作用域是​<strong>静态作用域</strong>​（通常也称为词法作用域）， 静态作用域是在代码<strong>定义阶段而非运行阶段</strong>确定的，通俗的说就是，你把变量写在代码的哪里，它的作用域就在哪个范围内，举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>; <span class="hljs-comment">// 定义在 outer 作用域中的变量</span>
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// inner函数定义时，嵌套在outer内部，所以可以访问这个 a 变量</span>
  }
  
  <span class="hljs-keyword">return</span> inner;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 这个 log 是在全局作用域下，是在 outer 作用域外的，所以访问不到 outer 中的变量</span>
<span class="hljs-comment">// 但这里有一个注意点，a 虽然访问不到 outer 中的变量 a，但是他可以访问到全局作用域的 a，由于未定义，所以输出是 undefined （非严格模式下）</span>

<span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">outer</span>();
<span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 输出：1（即使 fn 在 outer 外部执行，仍能访问 outer 的 a，这就是经典的闭包）</span>
</code></pre>
<p>一般和作用域同时提到的还有​<strong>执行上下文</strong>，这是两个概念，需要注意区分：</p>
<ul>
<li>作用域是静态的，代码定义时确定，不关注代码的执行</li>
<li>执行上下文是动态的，在代码执行的过程中动态的创建，包含 <code>this</code> ，变量对象，作用域链等信息，在每次调用函数时都会创建新的执行上下文。</li>
</ul>
<h2 data-id="heading-6">作用域链</h2>
<p>作用域链，顾名思义，就是一个链表，是​<strong>由当前作用域和外层作用域组成的链表</strong>，用于解析变量引用。当代码在某个作用域访问一个变量时，会从当前作用域出发逐级向外层作用域去寻找变量，举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 全局作用域</span>
<span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 外层函数作用域</span>
  <span class="hljs-keyword">const</span> outerVar = <span class="hljs-string">"外层变量"</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 内层函数作用域</span>
    <span class="hljs-keyword">const</span> innerVar = <span class="hljs-string">"内层变量"</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar); <span class="hljs-comment">// 查找链：【找到】inner 作用域</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar); <span class="hljs-comment">// 查找链：inner 作用域 -&gt; 【找到】outer 作用域</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 查找链：innter 作用域 -&gt; outer 作用域 -&gt; 【找到】全局作用域</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">outer</span>();
</code></pre>
<p>在 <code>inner</code>​ 函数中访问 <code>globalVar</code> 变量时就是沿着作用域链逐级查找的。</p>
<h3 data-id="heading-7">链的构建过程</h3>
<ol>
<li>
<p><strong>函数定义时</strong>：JavaScript 引擎会为函数关联一个 <code>[[Scopes]]</code> 内部属性，存储函数定义时所处的所有外层作用域；</p>
</li>
<li>
<p><strong>函数调用时</strong>：创建该函数的执行上下文，此时作用域链会被初始化：</p>
<ul>
<li>链的第一个元素是当前执行上下文的变量对象（存储当前作用域的变量、函数）；</li>
<li>后续元素是函数 <code>[[Scopes]]</code>​ 属性中的外层作用域变量对象，按<strong>从内到外</strong>的顺序排列；</li>
</ul>
</li>
<li>
<p><strong>作用域链固化</strong>：作用域链在执行上下文创建时确定，后续不会因代码执行而改变。</p>
</li>
</ol>
<p>以本节开始的代码为例：</p>
<ul>
<li>​<code>inner</code>​ 函数定义时，引擎会为其添加一个 <code>[[Scopes]]</code>​ 属性，其中包含：外层函数作用域（<code>outer</code>）、全局作用域；</li>
<li>​<code>inner</code> 调用时，会创建执行上下文，该上下文的作用域链为：[inner 变量对象（{innerVar: "内层变量"}）→ outer 变量对象（{outerVar: "外层变量"}）→ 全局变量对象（{globalVar: "全局变量"}）]，箭头表示链表的方向及连接。</li>
</ul>
<h3 data-id="heading-8">变量查找规则</h3>
<p>当访问一个变量时，JavaScript 引擎的查找步骤为：</p>
<ol>
<li>从作用域链的<strong>第一个元素</strong>（当前作用域）开始查找</li>
<li>若找到变量，直接返回其值（或引用），停止查找</li>
<li>若未找到，继续查找作用域链的<strong>下一个元素</strong>（外层作用域）</li>
<li>依次类推，直到找到变量或遍历完整个作用域链</li>
<li>若遍历完所有作用域仍未找到，抛出 <code>ReferenceError</code>（变量未定义）、</li>
</ol>
<p>需要注意的是，修改是直接作用到这个查找到的变量上的，比如：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> x = <span class="hljs-number">1</span>; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  x = <span class="hljs-number">2</span>; <span class="hljs-comment">// 修改的是全局变量x，而非创建局部变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：2</span>
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：2（全局变量被修改）</span>
</code></pre>
<p>在过去不默认声明严格模式的时候，我们在 foo 函数里面 <code>x =2</code> 会隐式的创建一个全局变量，在编码的时候是一个很大的坑，但是现在的项目基本都默认严格模式了，这种使用方式就会报错，提前为我们规避一些问题。</p>
<h3 data-id="heading-9">应用</h3>
<h4 data-id="heading-10">闭包</h4>
<p>闭包应该是作用域链的一个最典型、广泛的应用了，他是由函数和定义时的词法作用域组合成的，他允许函数在外部作用域执行时，依旧能够访问到该函数定义时的局部变量（函数作用域内的变量），举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 外层函数作用域变量</span>
  
  <span class="hljs-comment">// 内部函数引用了count，且被返回（导出到外部）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  };
}

<span class="hljs-comment">// increment在createCounter作用域之外执行</span>
<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：1</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：2</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<p>从作用域的视角上看：</p>
<ul>
<li>​<code>increment</code>​ 函数定义的时候，其对应的 <code>[[Scopes]]</code>​ 属性存储的是 <code>createCounter</code>​ 的作用域和一个最外层的全局作用域，也就是说这时候相关的作用域就已经被这个 <code>increment</code> 函数持有了。</li>
<li>在 <code>createCounter</code>​ 执行结束后，该函数的上下文环境被销毁，但是由于 <code>increment</code>​ 依旧持有这个函数的作用域，而且 <code>increment</code>​ 被外部的 counter 变量所引用，不能被 GC，所以 <code>increment</code>​ 这时候也还存在着，并且此时有个别名 <code>counter</code> 。</li>
<li>当 <code>counter</code> 被调用的时创建的执行上下文的作用域链为：[increment 变量对象 → createCounter 作用域变量对象 → 全局变量对象]。</li>
</ul>
<p>由于这样的链式关系和引用的持有，最终形成了闭包。</p>
<h4 data-id="heading-11">变量遮蔽</h4>
<p>内存作用域和外层作用域存在<strong>同名变量</strong>时，内层的变量会遮蔽外层变量，在查找时优先访问内层变量。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> x = <span class="hljs-number">10</span>; <span class="hljs-comment">// 外层变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-number">20</span>; <span class="hljs-comment">// 内层变量，遮蔽外层x</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：20（访问内层x）</span>
}

<span class="hljs-title function_">bar</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：10（访问外层x）</span>
</code></pre>
<h4 data-id="heading-12">模块化方案</h4>
<p>ES Module 的核心就是模块级作用域：</p>
<ol>
<li>
<p>每个模块都是一个独立的词法作用域，这意味着顶层的变量不会再自动挂载到 window 对象上了，模块内的变量/函数仅在模块内可以访问。</p>
</li>
<li>
<p>需要通过export 导出变量/函数，其他模块通过 import 导入。</p>
<p>这里有没有感觉很像闭包，必须将函数作用域的内容 return 后，才可以在外层作用域使用。</p>
</li>
</ol>
<h2 data-id="heading-13">一些问题</h2>
<h3 data-id="heading-14">变量提升</h3>
<p>在代码执行前，JavaScript 引擎会将 <code>var</code>​ 声明的变量提升到作用域顶部，提升后的值为<code>undefined</code>，将函数声明提升到作用域顶部，值为函数本身。</p>
<p>值得注意的是，变量提升仅在当前作用域上生效，不会出现跨作用域提升的情况，如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 输出：undefined（var声明的变量提升）</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 输出：undefined（函数作用域内的变量提升）</span>
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">2</span>;
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 报错：b is not defined（b的提升仅在foo作用域内）</span>
</code></pre>
<p>自 ES6 后，很少会在代码中再使用 var 关键字了，基本用的是 <code>const/let</code>​ 来声明变量，因为<code>let/const</code>​声明的变量不会被提升，而是存在​<strong>暂时性死区</strong>，即从作用域开始到变量声明前，访问该变量会报错。这是块级作用域的特性，避免了变量提升导致的逻辑混乱。</p>
<h3 data-id="heading-15">全局作用域污染</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">badFunc</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 未声明直接赋值，隐式创建全局变量</span>
  unDeclaredVar = <span class="hljs-string">"我是污染的全局变量"</span>;
}

<span class="hljs-title function_">badFunc</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">unDeclaredVar</span>); <span class="hljs-comment">// 输出：我是污染的全局变量</span>
</code></pre>
<p>对于这种没有声明就直接赋值的写法，在非严格模式下，会隐式的创建一个全局变量，导致全局作用域被污染。</p>
<h2 data-id="heading-16">总结</h2>
<p>理解了 JavaScript 的作用域和作用域链对我们理解闭包、模块化、高阶函数等特性能够有更好的帮助，也能让我们在实际开发中，更合理运用块级作用域（<code>let/const</code>）、模块化（ES Module），规避变量污染、逻辑混乱等问题，写出更健壮、可扩展的 JavaScript 代码。</p>
<p>作用域（Scope）与作用域链（Scope Chain）是 JavaScript 的核心概念，它们决定了变量的可访问范围、生命周期，以及代码运行时变量查找的规则，理解这两个概念，可以回答我们 “变量在这里为什么能访问”，“为什么这里的变量是 undefined” 等诸多疑问，还能帮助我们在开发过程中规避变量污染、提升代码的可维护性，对于 ES Module 等模块方案有更好的理解。</p>
<h2 data-id="heading-17">作用域的本质</h2>
<p>很多开发者会把作用域简单理解为 “变量的存储位置”，但这只说对了一半。作用域的核心是<strong>一套 “变量访问规则”</strong>  —— 它定义了在代码的哪个位置可以访问哪些变量，同时也隐含了变量的 “生存空间”（即变量何时被创建、何时被销毁）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue页面渲染流程]]></title>    <link>https://juejin.cn/post/7574622940688564243</link>    <guid>https://juejin.cn/post/7574622940688564243</guid>    <pubDate>2025-11-20T08:53:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574622940688564243" data-draft-id="7573993452578783275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue页面渲染流程"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-20T08:53:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WebGirl"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868584478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue页面渲染流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868584478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WebGirl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:53:31.000Z" title="Thu Nov 20 2025 08:53:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 核心中除了响应式原理外，视图渲染也是重中之重。我们都知道每次更新数据，都会走视图渲染的逻辑，而这当中牵扯的逻辑也是十分繁琐。</p>
<p>本文主要解析的是初始化视图渲染流程，你将会了解到从挂载组件开始，Vue 是如何构建 VNode，又是如何将 VNode 转为真实节点并挂载到页面。</p>
<p>Vue2 的页面渲染流程可分为<strong>初始化渲染</strong>和<strong>更新渲染</strong>两大阶段，核心围绕「VNode 构建」和「真实 DOM 生成」展开。以下是详细流程解析：</p>
<h2 data-id="heading-0">一、初始化渲染流程（首次渲染）</h2>
<h3 data-id="heading-1">实例化与初始化（new Vue()）</h3>
<ul>
<li>通过 <code>new Vue(options)</code> 创建组件实例，触发 <code>_init</code> 方法（<code>src/core/instance/init.js</code>）。</li>
<li><code>_init</code> 方法初始化组件选项（合并配置、初始化生命周期、事件、状态等），并判断是否存在 <code>el</code> 选项，若存在则调用 <code>$mount</code> 开始挂载。</li>
</ul>
<p><strong>Vue 是一个构造函数，通过 <code>new</code> 关键字进行实例化。</strong></p>
<p>代码块 1（src/core/instance/index.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/index.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Vue</span> (options) {
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp;
    !(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Vue</span>)
  ) {
    <span class="hljs-title function_">warn</span>(<span class="hljs-string">'Vue is a constructor and should be called with the `new` keyword'</span>)
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_init</span>(options)
}
</code></pre>
<p><strong>在实例化时，会调用 <code>_init</code> 进行初始化。</strong></p>
<p>代码块 2（src/core/instance/init.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/init.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options?: <span class="hljs-built_in">Object</span></span>) {
  <span class="hljs-comment">// ... component = this</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>) {
    vm.$mount(vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>)
  }
}
</code></pre>
<h3 data-id="heading-2">挂载组件（$mount）</h3>
<ul>
<li><code>$mount</code> 方法最终调用 <code>mountComponent</code>（<code>src/core/instance/lifecycle.js</code>），负责将组件挂载到 DOM。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/lifecycle.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span> (
  <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">el</span>: <span class="hljs-title class_">Element</span>,
  hydrating?: boolean
): <span class="hljs-title class_">Component</span> {
  vm.<span class="hljs-property">$el</span> = el
  <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeMount'</span>)

  <span class="hljs-keyword">let</span> updateComponent
  <span class="hljs-comment">/* istanbul ignore if */</span>
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp; config.<span class="hljs-property">performance</span> &amp;&amp; mark) {
    <span class="hljs-comment">// ...</span>
  } <span class="hljs-keyword">else</span> {
    updateComponent = <span class="hljs-function">() =&gt;</span> {
      vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>(), hydrating) <span class="hljs-comment">// 渲染页面函数</span>
    }
  }

  <span class="hljs-comment">// we set this to vm._watcher inside the watcher's constructor</span>
  <span class="hljs-comment">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>
  <span class="hljs-comment">// component's mounted hook), which relies on vm._watcher being already defined</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(vm, updateComponent, noop, { <span class="hljs-comment">// 渲染watcher</span>
    before () {
      <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">_isMounted</span> &amp;&amp; !vm.<span class="hljs-property">_isDestroyed</span>) {
        <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeUpdate'</span>)
      }
    }
  }, <span class="hljs-literal">true</span> <span class="hljs-comment">/* isRenderWatcher */</span>)
  hydrating = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// manually mounted instance, call mounted on self</span>
  <span class="hljs-comment">// mounted is called for render-created child components in its inserted hook</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$vnode</span> == <span class="hljs-literal">null</span>) {
    vm.<span class="hljs-property">_isMounted</span> = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'mounted'</span>)
  }
  <span class="hljs-keyword">return</span> vm
}
</code></pre>
<p><code>mountComponent</code> 除了调用一些生命周期的钩子函数外，最主要是 <code>updateComponent</code>，它就是负责渲染视图的核心方法，其只有一行核心代码：</p>
<pre><code class="hljs language-js" lang="js">vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>(), hydrating)
</code></pre>
<ul>
<li><code>vm._render</code> 创建并返回 VNode，<code>vm._update</code> 接收 VNode 将其转为真实节点。</li>
<li>其中 <code>vm._render()</code> 生成 VNode，<code>vm._update()</code> 将 VNode 转为真实 DOM。</li>
<li>创建「渲染 Watcher」，监听数据变化，首次执行 <code>updateComponent</code> 触发初始化渲染。
<ul>
<li><code>updateComponent</code> 会被传入<strong>渲染 Watcher</strong>，每当数据变化触发 Watcher 更新就会执行该函数，重新渲染视图。</li>
<li><code>updateComponent</code> 传入<strong>渲染 Watcher</strong> 后会被执行一次进行初始化页面渲染。</li>
</ul>
</li>
</ul>
<p>所以我们着重分析的是 <code>vm._render</code> 和 <code>vm._update</code> 两个方法，这也是本文主要了解的原理 ——Vue 视图渲染流程。</p>
<h3 data-id="heading-3">构建VNode(_render)</h3>
<p><strong>首先是 <code>_render</code> 方法，它用来构建组件的 VNode。</strong></p>
<ul>
<li><code>vm._render()</code> 调用组件的 <code>render</code> 函数（模板编译生成或用户自定义），返回根 VNode（虚拟节点）。</li>
<li><code>render</code> 函数通过 <code>vm.$createElement</code>（或编译生成的 <code>vm._c</code>）创建 VNode，内部调用 <code>createElement</code> 方法。</li>
</ul>
<p>代码块 1（src/core/instance/render.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/render.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_render</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { render, _parentVnode } = vm.<span class="hljs-property">$options</span>
  vnode = render.<span class="hljs-title function_">call</span>(vm.<span class="hljs-property">_renderProxy</span>, vm.<span class="hljs-property">$createElement</span>)
  <span class="hljs-keyword">return</span> vnode
}
</code></pre>
<p><code>_render</code> 内部会执行 <code>render</code> 方法并返回构建好的 VNode，<code>render</code> 一般是模板编译后生成的方法，也有可能是用户自定义。</p>
<p>代码块 2（src/core/instance/render.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/render.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initRender</span> (vm) {
  vm.<span class="hljs-property">_c</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">false</span>)
  vm.<span class="hljs-property">$createElement</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">true</span>)
}
</code></pre>
<ul>
<li><code>initRender</code> 在初始化就会执行为实例上绑定两个方法，分别是 <code>vm._c</code> 和 <code>vm.$createElement</code>。它们两者都是调用 <code>createElement</code> 方法，它是创建 VNode 的核心方法，最后一个参数用于区别是否为用户自定义。</li>
<li><code>vm._c</code> 应用场景是在编译生成的 <code>render</code> 函数中调用，<code>vm.$createElement</code> 则用于用户自定义 <code>render</code> 函数的场景。就像上面 <code>render</code> 在调用时会传入参数 <code>vm.$createElement</code>，我们在自定义 <code>render</code> 函数接收到的参数就是它。</li>
</ul>
<h4 data-id="heading-4">createElement</h4>
<ul>
<li><code>createElement</code> 封装 <code>_createElement</code>，处理参数并规范化子节点（<code>children</code>）：
<ul>
<li>若为编译生成的 <code>render</code>，调用 <code>simpleNormalizeChildren</code> 扁平化子节点数组。</li>
<li>若为用户自定义 <code>render</code>，调用 <code>normalizeChildren</code> 将子节点转为 VNode 数组。</li>
</ul>
</li>
<li>根据 <code>tag</code> 类型创建对应 VNode：
<ul>
<li>内置标签（如 <code>div</code>）：直接创建普通 VNode。</li>
<li>组件：调用 <code>createComponent</code> 创建组件类型 VNode。</li>
</ul>
</li>
</ul>
<p>代码块 3（src/core/vdom/create-element.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/create-element.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span> (
  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">tag</span>: any,
  <span class="hljs-attr">data</span>: any,
  <span class="hljs-attr">children</span>: any,
  <span class="hljs-attr">normalizationType</span>: any,
  <span class="hljs-attr">alwaysNormalize</span>: boolean
): <span class="hljs-title class_">VNode</span> | <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data) || <span class="hljs-title function_">isPrimitive</span>(data)) {
    normalizationType = children
    children = data
    data = <span class="hljs-literal">undefined</span>
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(alwaysNormalize)) {
    normalizationType = <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElement</span>(context, tag, data, children, normalizationType)
}
</code></pre>
<p><code>createElement</code> 方法实际上是对 <code>_createElement</code> 方法的封装，它允许传入的参数更加灵活。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">_createElement</span> (
  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">tag</span>: string | <span class="hljs-title class_">Class</span>&lt;<span class="hljs-title class_">Component</span>&gt; | <span class="hljs-title class_">Function</span> | <span class="hljs-title class_">Object</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">VNodeData</span>,
  <span class="hljs-attr">children</span>: any,
  <span class="hljs-attr">normalizationType</span>: number
): <span class="hljs-title class_">VNode</span> | <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data) &amp;&amp; <span class="hljs-title function_">isDef</span>((<span class="hljs-attr">data</span>: any).<span class="hljs-property">is</span>)) {
    tag = data.<span class="hljs-property">is</span>
  }
  <span class="hljs-keyword">if</span> (!tag) {
    <span class="hljs-comment">// in case of component :is set to falsy value</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createEmptyVNode</span>()
  }
  <span class="hljs-comment">// support single function children as default scoped slot</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children) &amp;&amp;
    <span class="hljs-keyword">typeof</span> children[<span class="hljs-number">0</span>] === <span class="hljs-string">'function'</span>
  ) {
    data = data || {}
    data.<span class="hljs-property">scopedSlots</span> = { <span class="hljs-attr">default</span>: children[<span class="hljs-number">0</span>] }
    data.<span class="hljs-property">children</span> = []
  }
  <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>) {
    children = <span class="hljs-title function_">normalizeChildren</span>(children)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">SIMPLE_NORMALIZE</span>) {
    children = <span class="hljs-title function_">simpleNormalizeChildren</span>(children)
  }
  <span class="hljs-keyword">let</span> vnode, ns
  <span class="hljs-comment">// 根据tag类型创建VNode</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">Ctor</span>
    ns = (context.<span class="hljs-property">$vnode</span> &amp;&amp; context.<span class="hljs-property">$vnode</span>.<span class="hljs-property">ns</span>) || config.<span class="hljs-title function_">getTagNamespace</span>(tag)
    <span class="hljs-keyword">if</span> (config.<span class="hljs-title function_">isReservedTag</span>(tag)) {
      <span class="hljs-comment">// platform built-in elements</span>
      vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
        config.<span class="hljs-title function_">parsePlatformTagName</span>(tag), data, children,
        <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
      )
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(<span class="hljs-title class_">Ctor</span> = <span class="hljs-title function_">resolveAsset</span>(context.<span class="hljs-property">$options</span>, <span class="hljs-string">'components'</span>, tag))) {
      <span class="hljs-comment">// component</span>
      vnode = <span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">Ctor</span>, data, context, children, tag)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// unknown or unlisted namespaced elements</span>
      <span class="hljs-comment">// check at runtime because it may get assigned a namespace when its</span>
      <span class="hljs-comment">// parent normalizes children</span>
      vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
        tag, data, children,
        <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
      )
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// direct component options / constructor</span>
    vnode = <span class="hljs-title function_">createComponent</span>(tag, data, context, children)
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(vnode)) {
    <span class="hljs-keyword">return</span> vnode
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(ns)) <span class="hljs-title function_">applyNS</span>(vnode, ns)
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data)) <span class="hljs-title function_">registerDeepBindings</span>(data)
    <span class="hljs-keyword">return</span> vnode
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createEmptyVNode</span>()
  }
}
</code></pre>
<p><code>_createElement</code> 参数中会接收 <code>children</code>，它表示当前 VNode 的子节点，因为它是任意类型的，所以接下来需要将其规范为标准的 VNode 数组；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这里规范化 children</span>
<span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>) {
  children = <span class="hljs-title function_">normalizeChildren</span>(children)
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">SIMPLE_NORMALIZE</span>) {
  children = <span class="hljs-title function_">simpleNormalizeChildren</span>(children)
}
</code></pre>
<p><code>simpleNormalizeChildren</code> 和 <code>normalizeChildren</code> 均用于规范化 <code>children</code>。由 <code>normalizationType</code> 判断 <code>render</code> 函数是编译生成的还是用户自定义的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. when the children contains components - because a functional component</span>
<span class="hljs-comment">// may return an Array instead of a single root. In this case, just a simple</span>
<span class="hljs-comment">// normalization is needed. If the child is an Array, we flatten the whole</span>
<span class="hljs-comment">// thing with Array.prototype.concat. It is guaranteed to be only 1-level deep</span>
<span class="hljs-comment">// because functional components already normalize their own children.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">simpleNormalizeChildren</span> (<span class="hljs-attr">children</span>: any) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children[i])) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], children)
    }
  }
  <span class="hljs-keyword">return</span> children
}

<span class="hljs-comment">// 2. when the children contains constructs that always generated nested Arrays,</span>
<span class="hljs-comment">// e.g. &lt;template&gt;, &lt;slot&gt;, v-for, or when the children is provided by user</span>
<span class="hljs-comment">// with hand-written render functions / JSX. In such cases a full normalization</span>
<span class="hljs-comment">// is needed to cater to all possible types of children values.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeChildren</span> (<span class="hljs-attr">children</span>: any): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isPrimitive</span>(children)
    ? [<span class="hljs-title function_">createTextVNode</span>(children)]
    : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)
      ? <span class="hljs-title function_">normalizeArrayChildren</span>(children)
      : <span class="hljs-literal">undefined</span>
}
</code></pre>
<p><code>simpleNormalizeChildren</code> 方法调用场景是 <code>render</code> 函数当函数是编译生成的。<code>normalizeChildren</code> 方法的调用场景主要是 <code>render</code> 函数是用户手写的。</p>
<p>经过对 <code>children</code> 的规范化，<code>children</code> 变成了一个类型为 VNode 的数组。之后就是创建 VNode 的逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/patch.js</span>
<span class="hljs-keyword">let</span> vnode, ns
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">'string'</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Ctor</span>
  ns = (context.<span class="hljs-property">$vnode</span> &amp;&amp; context.<span class="hljs-property">$vnode</span>.<span class="hljs-property">ns</span>) || config.<span class="hljs-title function_">getTagNamespace</span>(tag)
  <span class="hljs-keyword">if</span> (config.<span class="hljs-title function_">isReservedTag</span>(tag)) {
    <span class="hljs-comment">// platform built-in elements</span>
    vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
      config.<span class="hljs-title function_">parsePlatformTagName</span>(tag), data, children,
      <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
    )
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(<span class="hljs-title class_">Ctor</span> = <span class="hljs-title function_">resolveAsset</span>(context.<span class="hljs-property">$options</span>, <span class="hljs-string">'components'</span>, tag))) {
    <span class="hljs-comment">// component</span>
    vnode = <span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">Ctor</span>, data, context, children, tag)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// unknown or unlisted namespaced elements</span>
    <span class="hljs-comment">// check at runtime because it may get assigned a namespace when its</span>
    <span class="hljs-comment">// parent normalizes children</span>
    vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
      tag, data, children,
      <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
    )
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// direct component options / constructor</span>
  vnode = <span class="hljs-title function_">createComponent</span>(tag, data, context, children)
}
</code></pre>
<p>如果 <code>tag</code> 是 <code>string</code> 类型，则接着判断：如果是内置的一些节点，创建一个普通 VNode；如果是已注册的组件名，则通过 <code>createComponent</code> 创建一个组件类型的 VNode；否则创建一个未知的标签的 VNode。</p>
<p>如果 <code>tag</code> 不是 <code>string</code> 类型，那就是 <code>Component</code> 类型，则直接调用 <code>createComponent</code> 创建一个组件类型的 VNode 节点。</p>
<p>最后 <code>_createElement</code> 会返回一个 VNode，也就是调用 <code>vm._render</code> 时创建得到的 VNode。之后 VNode 会传递给 <code>vm._update</code> 函数，用于生成真实 DOM。</p>
<h3 data-id="heading-5">生成真实dom(_update 与 patch)</h3>
<ul>
<li><code>vm._update(vnode)</code> 调用 <code>vm.__patch__</code> 方法（平台相关实现，Web 端对应 <code>patch</code> 函数）。</li>
<li><code>patch</code> 函数核心逻辑：
<ol>
<li>首次渲染时，<code>oldVnode</code> 为真实 DOM（如 <code>#app</code>），先通过 <code>emptyNodeAt</code> 转为空 VNode。</li>
<li>调用 <code>createElm</code> 将 VNode 递归转为真实 DOM 并插入父节点。</li>
<li>移除旧节点，触发 <code>insert</code> 钩子，完成渲染。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 核心代码简化</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">vnode</span>) {
  <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">const</span> prevVnode = vm.<span class="hljs-property">_vnode</span>;
  vm.<span class="hljs-property">_vnode</span> = vnode;
  <span class="hljs-keyword">if</span> (!prevVnode) {
    <span class="hljs-comment">// 首次渲染：将 VNode 转为真实 DOM 并挂载</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode);
  }
};

<span class="hljs-comment">// patch 核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRealElement</span>(oldVnode)) {
    oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode); <span class="hljs-comment">// 真实 DOM 转空 VNode</span>
  }
  <span class="hljs-title function_">createElm</span>(vnode, parentElm); <span class="hljs-comment">// 创建真实 DOM 并插入</span>
  <span class="hljs-title function_">removeVnodes</span>([oldVnode]); <span class="hljs-comment">// 移除旧节点</span>
}
</code></pre>
<p>代码块 1（src/core/instance/lifecycle.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/lifecycle.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vnode: VNode, hydrating?: boolean</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span> = <span class="hljs-variable language_">this</span>
  <span class="hljs-keyword">const</span> prevEl = vm.<span class="hljs-property">$el</span>
  <span class="hljs-keyword">const</span> prevVnode = vm.<span class="hljs-property">_vnode</span>
  <span class="hljs-keyword">const</span> prevActiveInstance = activeInstance
  activeInstance = vm
  vm.<span class="hljs-property">_vnode</span> = vnode
  <span class="hljs-comment">// Vue.prototype.__patch__ is injected in entry points</span>
  <span class="hljs-comment">// based on the rendering backend used.</span>
  <span class="hljs-keyword">if</span> (!prevVnode) {
    <span class="hljs-comment">// initial render</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode, hydrating, <span class="hljs-literal">false</span> <span class="hljs-comment">/* removeOnly */</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// updates</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(prevVnode, vnode)
  }
  activeInstance = prevActiveInstance
  <span class="hljs-comment">// update __vue__ reference</span>
  <span class="hljs-keyword">if</span> (prevEl) {
    prevEl.<span class="hljs-property">__vue__</span> = <span class="hljs-literal">null</span>
  }
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$el</span>) {
    vm.<span class="hljs-property">$el</span>.<span class="hljs-property">__vue__</span> = vm
  }
  <span class="hljs-comment">// if parent is an HOC, update its $el as well</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$vnode</span> &amp;&amp; vm.<span class="hljs-property">$parent</span> &amp;&amp; vm.<span class="hljs-property">$vnode</span> === vm.<span class="hljs-property">$parent</span>.<span class="hljs-property">_vnode</span>) {
    vm.<span class="hljs-property">$parent</span>.<span class="hljs-property">$el</span> = vm.<span class="hljs-property">$el</span>
  }
  <span class="hljs-comment">// updated hook is called by the scheduler to ensure that children are</span>
  <span class="hljs-comment">// updated in a parent's updated hook.</span>
}
</code></pre>
<p><code>_update</code> 里最核心的方法就是 <code>vm.__patch__</code> 方法，不同平台的 <code>patch</code> 方法的定义稍有不同，在 web 平台中它是这样定义的：</p>
<p>代码块 2（src/platforms/web/runtime/index.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/platforms/web/runtime/index.js</span>
<span class="hljs-keyword">import</span> { patch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./patch'</span>
<span class="hljs-comment">// install platform patch function</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__patch__</span> = inBrowser ? patch : noop
</code></pre>
<p>可以看到 <code>__patch__</code> 实际调用的是 <code>patch</code> 方法。</p>
<p>代码块 3（src/platforms/web/runtime/patch.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/platforms/web/runtime/patch.js</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> nodeOps <span class="hljs-keyword">from</span> <span class="hljs-string">'web/runtime/node-ops'</span>
<span class="hljs-keyword">import</span> { createPatchFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'core/vdom/patch'</span>
<span class="hljs-keyword">import</span> baseModules <span class="hljs-keyword">from</span> <span class="hljs-string">'core/vdom/modules/index'</span>
<span class="hljs-keyword">import</span> platformModules <span class="hljs-keyword">from</span> <span class="hljs-string">'web/runtime/modules/index'</span>

<span class="hljs-comment">// the directive module should be applied last, after all</span>
<span class="hljs-comment">// built-in modules have been applied.</span>
<span class="hljs-keyword">const</span> modules = platformModules.<span class="hljs-title function_">concat</span>(baseModules)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-title function_">createPatchFunction</span>({ nodeOps, modules })
</code></pre>
<p>而patch方法是由createPatchFunction方法创建返回出来的函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/patch.js</span>
<span class="hljs-keyword">const</span> hooks = [<span class="hljs-string">'create'</span>, <span class="hljs-string">'activate'</span>, <span class="hljs-string">'update'</span>, <span class="hljs-string">'remove'</span>, <span class="hljs-string">'destroy'</span>]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createPatchFunction</span> (backend) {
  <span class="hljs-keyword">let</span> i, j
  <span class="hljs-keyword">const</span> cbs = {}
  <span class="hljs-keyword">const</span> { modules, nodeOps } = backend

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; hooks.<span class="hljs-property">length</span>; i++) {
    cbs[hooks[i]] = []
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; modules.<span class="hljs-property">length</span>; j++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(modules[j][hooks[i]])) {
        cbs[hooks[i]].<span class="hljs-title function_">push</span>(modules[j][hooks[i]])
      }
    }
  }

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>这里有两个比较重要的对象 <code>nodeOps</code> 和 <code>modules</code>：</p>
<ul>
<li><code>nodeOps</code> 是封装的原生 dom 操作方法，在生成真实节点树的过程中，dom 相关操作都是调用 <code>nodeOps</code> 内的方法。</li>
<li><code>modules</code> 是待执行的钩子函数，在进入函数时，会将不同模块的钩子函数分类放置到 <code>cbs</code> 中，其中包括自定义指令钩子函数、ref 钩子函数。在 <code>patch</code> 阶段，会根据操作节点的行为取出对应类型进行调用。</li>
</ul>
<h4 data-id="heading-6">Patch</h4>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// initial render</span>
<span class="hljs-number">2</span> vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode, hydrating, <span class="hljs-literal">false</span> <span class="hljs-comment">/* removeOnly */</span>)
</code></pre>
<p>在首次渲染时，<code>vm.$el</code> 对应的是根节点 dom 对象，也就是我们熟知的 id 为 app 的 div。它作为 <code>oldVnode</code> 参数传入 <code>patch</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode, hydrating, removeOnly</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isUndef</span>(vnode)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(oldVnode)) <span class="hljs-title function_">invokeDestroyHook</span>(oldVnode)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">let</span> isInitialPatch = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> insertedVnodeQueue = []

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isUndef</span>(oldVnode)) {
    <span class="hljs-comment">// empty mount (likely as component), create new root element</span>
    isInitialPatch = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">createElm</span>(vnode, insertedVnodeQueue)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> isRealElement = <span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">nodeType</span>)
    <span class="hljs-keyword">if</span> (!isRealElement &amp;&amp; <span class="hljs-title function_">sameVnode</span>(oldVnode, vnode)) {
      <span class="hljs-comment">// patch existing root node</span>
      <span class="hljs-title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, removeOnly)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (isRealElement) {
        <span class="hljs-comment">// mounting to a real element</span>
        <span class="hljs-comment">// check if this is server-rendered content and if we can perform</span>
        <span class="hljs-comment">// a successful hydration.</span>
        <span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span> &amp;&amp; oldVnode.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-variable constant_">SSR_ATTR</span>)) {
          oldVnode.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-variable constant_">SSR_ATTR</span>)
          hydrating = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(hydrating)) {
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) {
            <span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="hljs-literal">true</span>)
            <span class="hljs-keyword">return</span> oldVnode
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>) {
            <span class="hljs-title function_">warn</span>(
              <span class="hljs-string">'The client-side rendered virtual DOM tree is not matching '</span> +
              <span class="hljs-string">'server-rendered content. This is likely caused by incorrect '</span> +
              <span class="hljs-string">'HTML markup, for example nesting block-level elements inside '</span> +
              <span class="hljs-string">'&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing '</span> +
              <span class="hljs-string">'full client-side render.'</span>
            )
          }
        }
        <span class="hljs-comment">// either not server-rendered, or hydration failed.</span>
        <span class="hljs-comment">// create an empty node and replace it</span>
        oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode)
      }

      <span class="hljs-comment">// replacing existing element</span>
      <span class="hljs-keyword">const</span> oldElm = oldVnode.<span class="hljs-property">elm</span>
      <span class="hljs-keyword">const</span> parentElm = nodeOps.<span class="hljs-title function_">parentNode</span>(oldElm)

      <span class="hljs-comment">// create new node</span>
      <span class="hljs-title function_">createElm</span>(
        vnode,
        insertedVnodeQueue,
        <span class="hljs-comment">// extremely rare edge case: do not insert if old element is in a</span>
        <span class="hljs-comment">// leaving transition. Only happens when combining transition +</span>
        <span class="hljs-comment">// keep-alive + HOCs. (#4590)</span>
        oldElm.<span class="hljs-property">_leaveCb</span> ? <span class="hljs-literal">null</span> : parentElm,
        nodeOps.<span class="hljs-title function_">nextSibling</span>(oldElm)
      )

      <span class="hljs-comment">// update parent placeholder node element, recursively</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">parent</span>)) {
        <span class="hljs-keyword">let</span> ancestor = vnode.<span class="hljs-property">parent</span>
        <span class="hljs-keyword">const</span> patchable = <span class="hljs-title function_">isPatchable</span>(vnode)
        <span class="hljs-keyword">while</span> (ancestor) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">destroy</span>.<span class="hljs-property">length</span>; ++i) {
            cbs.<span class="hljs-property">destroy</span>[i](ancestor)
          }
          ancestor.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">elm</span>
          <span class="hljs-keyword">if</span> (patchable) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">create</span>.<span class="hljs-property">length</span>; ++i) {
              cbs.<span class="hljs-property">create</span>[i](emptyNode, ancestor)
            }
            <span class="hljs-comment">// #6513</span>
            <span class="hljs-comment">// invoke insert hooks that may have been merged by create hooks.</span>
            <span class="hljs-comment">// e.g. for directives that uses the "inserted" hook.</span>
            <span class="hljs-keyword">const</span> insert = ancestor.<span class="hljs-property">data</span>.<span class="hljs-property">hook</span>.<span class="hljs-property">insert</span>
            <span class="hljs-keyword">if</span> (insert.<span class="hljs-property">merged</span>) {
              <span class="hljs-comment">// start at index 1 to avoid re-invoking component mounted hook</span>
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; insert.<span class="hljs-property">fns</span>.<span class="hljs-property">length</span>; i++) {
                insert.<span class="hljs-property">fns</span>[i]()
              }
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">registerRef</span>(ancestor)
          }
          ancestor = ancestor.<span class="hljs-property">parent</span>
        }
      }

      <span class="hljs-comment">// destroy old node</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parentElm)) {
        <span class="hljs-title function_">removeVnodes</span>([oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">tag</span>)) {
        <span class="hljs-title function_">invokeDestroyHook</span>(oldVnode)
      }
    }
  }

  <span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)
  <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">elm</span>
}
</code></pre>
<p>通过检查属性 <code>nodeType</code>（真实节点才有的属性），判断 <code>oldVnode</code> 是否为真实节点。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isRealElement = <span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">nodeType</span>)
<span class="hljs-keyword">if</span> (isRealElement) {
  <span class="hljs-comment">// ...</span>
  oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode)
}
</code></pre>
<p>很明显第一次的 <code>isRealElement</code> 是为 <code>true</code>，因此会调用 <code>emptyNodeAt</code> 将其转为 VNode：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">emptyNodeAt</span> (elm) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(nodeOps.<span class="hljs-title function_">tagName</span>(elm).<span class="hljs-title function_">toLowerCase</span>(), {}, [], <span class="hljs-literal">undefined</span>, elm)
}
</code></pre>
<p>接着会调用 <code>createElm</code> 方法，它就是将 VNode 转为真实 dom 的核心方法：</p>
<h3 data-id="heading-7">递归创建DOM节点（createElm）</h3>
<p><code>createElm</code> 是 VNode 转真实 DOM 的核心方法：</p>
<ol>
<li>若为组件 VNode，调用 <code>createComponent</code> 实例化组件并递归挂载。</li>
<li>若为普通元素，通过 <code>nodeOps.createElement</code> 创建真实节点，赋值给 <code>vnode.elm</code>。</li>
<li>递归调用 <code>createChildren</code> 处理子节点，将子节点插入当前节点（先子后父的插入顺序）。</li>
<li>调用 <code>insert</code> 方法将节点插入父容器（使用 <code>appendChild</code> 或 <code>insertBefore</code>）。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createElm</span> (
  vnode,
  insertedVnodeQueue,
  parentElm,
  refElm,
  nested,
  ownerArray,
  index
) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">elm</span>) &amp;&amp; <span class="hljs-title function_">isDef</span>(ownerArray)) {
    <span class="hljs-comment">// This vnode was used in a previous render!</span>
    <span class="hljs-comment">// now it's used as a new node, overwriting its elm would cause</span>
    <span class="hljs-comment">// potential patch errors down the road when it's used as an insertion</span>
    <span class="hljs-comment">// reference node. Instead, we clone the node on-demand before creating</span>
    <span class="hljs-comment">// associated DOM element for it.</span>
    vnode = ownerArray[index] = <span class="hljs-title function_">cloneVNode</span>(vnode)
  }

  vnode.<span class="hljs-property">isRootInsert</span> = !nested <span class="hljs-comment">// for transition enter check</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm)) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> data = vnode.<span class="hljs-property">data</span>
  <span class="hljs-keyword">const</span> children = vnode.<span class="hljs-property">children</span>
  <span class="hljs-keyword">const</span> tag = vnode.<span class="hljs-property">tag</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(tag)) {
    vnode.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">ns</span>
      ? nodeOps.<span class="hljs-title function_">createElementNS</span>(vnode.<span class="hljs-property">ns</span>, tag)
      : nodeOps.<span class="hljs-title function_">createElement</span>(tag, vnode)
    <span class="hljs-title function_">setScope</span>(vnode)

    <span class="hljs-comment">/* istanbul ignore if */</span>
    <span class="hljs-keyword">if</span> (__WEEX__) {
      <span class="hljs-comment">// ...</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">createChildren</span>(vnode, children, insertedVnodeQueue) <span class="hljs-comment">// 递归创建子节点</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data)) {
        <span class="hljs-title function_">invokeCreateHooks</span>(vnode, insertedVnodeQueue)
      }
      <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm)
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp; data &amp;&amp; data.<span class="hljs-property">pre</span>) {
    creatingElmInPre--
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(vnode.<span class="hljs-property">isComment</span>)) {
    vnode.<span class="hljs-property">elm</span> = nodeOps.<span class="hljs-title function_">createComment</span>(vnode.<span class="hljs-property">text</span>)
    <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm) <span class="hljs-comment">// 插入父节点</span>
  } <span class="hljs-keyword">else</span> {
    vnode.<span class="hljs-property">elm</span> = nodeOps.<span class="hljs-title function_">createTextNode</span>(vnode.<span class="hljs-property">text</span>)
    <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm)
  }
}
</code></pre>
<p>一开始会调用 <code>createComponent</code> 尝试创建组件类型的节点，如果成功会返回 <code>true</code>。在创建过程中也会调用 <code>$mount</code> 进行组件范围内的挂载，所以走的还是 <code>patch</code> 这套流程。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title function_">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm)) {
  <span class="hljs-keyword">return</span>
}
</code></pre>
<p>如果没有完成创建，代表该 VNode 对应的是真实节点，往下继续创建真实节点的逻辑。</p>
<pre><code class="hljs language-js" lang="js">vnode.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">ns</span>
  ? nodeOps.<span class="hljs-title function_">createElementNS</span>(vnode.<span class="hljs-property">ns</span>, tag)
  : nodeOps.<span class="hljs-title function_">createElement</span>(tag, vnode)
</code></pre>
<p>根据 <code>tag</code> 创建对应类型真实节点，赋值给 <code>vnode.elm</code>，它作为父节点容器，创建的子节点会被放到里面。</p>
<p>然后调用 <code>createChildren</code> 创建子节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createChildren</span> (vnode, children, insertedVnodeQueue) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)) {
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>) {
      <span class="hljs-title function_">checkDuplicateKeys</span>(children)
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; ++i) {
      <span class="hljs-title function_">createElm</span>(children[i], insertedVnodeQueue, vnode.<span class="hljs-property">elm</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, children, i)
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPrimitive</span>(vnode.<span class="hljs-property">text</span>)) {
    nodeOps.<span class="hljs-title function_">appendChild</span>(vnode.<span class="hljs-property">elm</span>, nodeOps.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-title class_">String</span>(vnode.<span class="hljs-property">text</span>)))
  }
}
</code></pre>
<p>内部进行遍历子节点数组，再次调用 <code>createElm</code> 创建节点，而上面创建的 <code>vnode.elm</code> 作为父节点传入。如此循环，直到没有子节点，就会创建文本节点插入到 <code>vnode.elm</code> 中。</p>
<p>执行完成后出来，会调用 <code>invokeCreateHooks</code>，它负责执行 dom 操作时的 <code>create</code> 钩子函数，同时将 VNode 加入到 <code>insertedVnodeQueue</code> 中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">invokeCreateHooks</span> (vnode, insertedVnodeQueue) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">create</span>.<span class="hljs-property">length</span>; ++i) {
    cbs.<span class="hljs-property">create</span>[i](emptyNode, vnode)
  }
  i = vnode.<span class="hljs-property">data</span>.<span class="hljs-property">hook</span> <span class="hljs-comment">// Reuse variable</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i.<span class="hljs-property">create</span>)) i.<span class="hljs-title function_">create</span>(emptyNode, vnode)
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i.<span class="hljs-property">insert</span>)) insertedVnodeQueue.<span class="hljs-title function_">push</span>(vnode)
  }
}
</code></pre>
<h3 data-id="heading-8">插入到父节点</h3>
<p>最后一步就是调用 <code>insert</code> 方法将节点插入到父节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span> (parent, elm, ref) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parent)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(ref)) {
      <span class="hljs-keyword">if</span> (nodeOps.<span class="hljs-title function_">parentNode</span>(ref) === parent) {
        nodeOps.<span class="hljs-title function_">insertBefore</span>(parent, elm, ref)
      }
    } <span class="hljs-keyword">else</span> {
      nodeOps.<span class="hljs-title function_">appendChild</span>(parent, elm)
    }
  }
}
</code></pre>
<p>可以看到 Vue 是通过递归调用 <code>createElm</code> 来创建节点树的。同时也说明最深的子节点会先调用 <code>insert</code> 插入节点。所以整个节点树的插入顺序是 “先子后父”。插入节点方法就是原生 dom 的方法 <code>insertBefore</code> 和 <code>appendChild</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parentElm)) {
  <span class="hljs-title function_">removeVnodes</span>([oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
}
</code></pre>
<p><code>createElm</code> 流程走完后，构建完成的节点树已经插入到页面上了。其实 Vue 在初始化渲染页面时，并不是把原来的根节点 <code>app</code> 给真正替换掉，而是在其后面插入一个新的节点，接着再把旧节点给移除掉。</p>
<p>所以在 <code>createElm</code> 之后会调用 <code>removeVnodes</code> 来移除旧节点，它里面同样是调用的原生 dom 方法 <code>removeChild</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">invokeInsertHook</span> (vnode, queue, initial) {
  <span class="hljs-comment">// delay insert hooks for component root nodes, invoke them after the</span>
  <span class="hljs-comment">// element is really inserted</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(initial) &amp;&amp; <span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">parent</span>)) {
    vnode.<span class="hljs-property">parent</span>.<span class="hljs-property">data</span>.<span class="hljs-property">pendingInsert</span> = queue
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; queue.<span class="hljs-property">length</span>; ++i) {
      queue[i].<span class="hljs-property">data</span>.<span class="hljs-property">hook</span>.<span class="hljs-title function_">insert</span>(queue[i])
    }
  }
}
</code></pre>
<p>在 <code>patch</code> 的最后就是调用 <code>invokeInsertHook</code> 方法，触发节点插入的钩子函数。</p>
<p>至此整个页面渲染的流程完毕。</p>
<h3 data-id="heading-9">完成渲染</h3>
<ul>
<li>触发 <code>mounted</code> 生命周期钩子（所有子组件挂载完成后），页面渲染完毕。</li>
</ul>
<h2 data-id="heading-10">二、更新渲染流程（数据变化时）</h2>
<p>当响应式数据变化时，触发渲染 Watcher 的更新，重新执行 <code>updateComponent</code>，流程如下：</p>
<ol>
<li>触发 <code>beforeUpdate</code> 生命周期钩子。</li>
<li>重新调用 <code>vm._render()</code> 生成新 VNode。</li>
<li>调用 <code>vm._update()</code>，通过 <code>patch</code> 对比新旧 VNode（<code>sameVnode</code> 检查）：
<ul>
<li>若为同一节点，调用 <code>patchVnode</code> 对比并更新差异（属性、文本、子节点等）。</li>
<li>若为不同节点，直接创建新节点并替换旧节点。</li>
</ul>
</li>
<li>触发 <code>updated</code> 生命周期钩子，完成更新。</li>
</ol>
<h2 data-id="heading-11">三、总结</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13cbd2135024957b1bd8674cc7e1691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764233610&amp;x-signature=AU%2Bg%2Fud%2BXASNruVu97%2FRJtDTyyo%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>初始化调用<code>$mount</code>挂载组件。
-<code> _render</code>开始构建<code>VNode</code>，核心方法为<code>createElement</code>，一般会创建普通的<code>VNode</code>，遇到组件就创建组件类型的<code>VNode</code>，否则就是未知标签的<code>VNode</code>,构建完成传递给<code>_update</code>。</li>
<li><code>patch</code>阶段根据<code>VNode</code>创建真实节点树，核心方法为<code>createElm</code>,首选遇到组件类型的<code>VNode</code>,内部会执行<code>$mount</code>,再走一遍相同的流程。普通节点类型则创建一个真实的节点，如果它有子节点开始递归调用<code>createElm</code>，使用<code>insert</code>插入子节点，直到没有子节点就填充内容节点。</li>
<li>最后递归完成后，同样也是使用<code>insert</code>将整个节点树插入到页面中，再将旧的根节点移除。</li>
</ul>
<blockquote>
<ol>
<li><strong>初始化渲染</strong>：<code>new Vue()</code> → <code>_init</code> → <code>$mount</code> → <code>mountComponent</code> → <code>_render</code>（生成 VNode） → <code>_update</code>（<code>patch</code> 生成真实 DOM）。</li>
<li><strong>更新渲染</strong>：数据变化 → 渲染 Watcher 触发 → 重新生成 VNode → <code>patch</code> 对比更新 DOM。</li>
<li>核心思想：通过 VNode 抽象 DOM，减少直接操作 DOM 的开销，通过 Diff 算法高效更新差异。</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~]]></title>    <link>https://juejin.cn/post/7574727105705082920</link>    <guid>https://juejin.cn/post/7574727105705082920</guid>    <pubDate>2025-11-21T06:26:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705082920" data-draft-id="7574869203448004608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-21T06:26:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:26:05.000Z" title="Fri Nov 21 2025 06:26:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果悄然推出了网页版 App Store（官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn" target="_blank" title="https://apps.apple.com/cn" ref="nofollow noopener noreferrer">apps.apple.com/cn</a>），无需依赖 iOS 或 macOS 设备，只要打开浏览器，无论是安卓手机、Windows 电脑还是其他终端，都能轻松访问 App Store 的丰富内容。不过目前网页版仅支持浏览、搜索应用，屏蔽了下载功能改为了分享。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb13dec4c6d4d0099833c19ee41e8f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311165&amp;x-signature=WxMJIbkMkPkU%2B6JAWdujSkLEQTU%3D" alt="企业微信20251121-141812.png" loading="lazy"/></p>
<h2 data-id="heading-0">核心亮点：多地区快速切换 + 全设备专区适配</h2>
<p>网页版 App Store 最让人惊喜的，莫过于<strong>无门槛切换全球地区商店</strong>。用户只需修改网址中的两位地区代码（遵循《ISO 31666-1》标准，小写格式），就能一键跳转至对应国家 / 地区的 App Store，比如：</p>
<ul>
<li>中国大陆：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2F" target="_blank" title="https://apps.apple.com/cn/" ref="nofollow noopener noreferrer">apps.apple.com/cn/</a></li>
<li>中国香港：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fhk%2F" target="_blank" title="https://apps.apple.com/hk/" ref="nofollow noopener noreferrer">apps.apple.com/hk/</a></li>
<li>日本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fjp%2F" target="_blank" title="https://apps.apple.com/jp/" ref="nofollow noopener noreferrer">apps.apple.com/jp/</a></li>
<li>美国：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2F" target="_blank" title="https://apps.apple.com/us/" ref="nofollow noopener noreferrer">apps.apple.com/us/</a></li>
<li>新加坡：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fsg%2F" target="_blank" title="https://apps.apple.com/sg/" ref="nofollow noopener noreferrer">apps.apple.com/sg/</a></li>
</ul>
<p>无需注册登录，也不用切换账号地区，就能直接查看目标地区的应用榜单、同类型产品分布，以及特定应用的价格、评分、用户评论等核心信息，操作简单到离谱。</p>
<p>同时，网页版几乎 1:1 复刻了移动端 App Store 的视觉设计和功能布局，还新增了<strong>设备专区切换功能</strong>—— 左侧菜单栏可直接选择 Mac、iPad、Vision、Watch 等设备，无需拥有对应硬件，就能直观查看应用在不同设备上的展示效果，比如 iPad 端的 5 图排版、Watch 端的适配界面等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acaae84f634e4b44b56252bcab00af49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311165&amp;x-signature=aP0qdDYjNyrf0WLlL05T1Xl2SSE%3D" alt="2.png" loading="lazy"/></p>
<h2 data-id="heading-1">核心实用场景，精准匹配开发者与产品人核心需求</h2>
<h3 data-id="heading-2">1. 出海竞品调研提速，摆脱第三方工具束缚</h3>
<p>过去做海外市场调研，查看不同地区 App Store 的榜单动态、竞品详情，只能依赖点点数据这类第三方平台。不仅要完成登录流程，还面临加载迟缓、数据滞后的问题，部分关键数据甚至需要开通 VIP 才能解锁。网页版 App Store 直接打通全球地区商店通道，无需借助任何额外工具，就能实时获取目标地区的竞品核心信息，从榜单趋势到应用评分、评论、价格等详情全掌握，让出海调研效率大幅提升。</p>
<h3 data-id="heading-3">2. 多设备适配核查零门槛，独立开发者福音</h3>
<p>独立开发者或小型团队往往难以配齐 Mac、iPad、Vision、Apple Watch 等所有苹果设备，给多设备适配调研带来阻碍。网页版的设备专区切换功能恰好解决了这一难题，左上角下拉菜单即可一键切换至对应设备的专属应用页面。想确认自家应用在 Mac 端的展示效果，或是调研 Watch 端的热门应用类型，只需打开浏览器就能直观查看，零成本完成多设备适配验证。</p>
<h3 data-id="heading-4">3. 跨平台无障碍访问，安卓 / Windows 用户不用再借设备</h3>
<p>产品经理、运营人员常需调研 App Store 上的应用，但如果手边只有安卓手机或 Windows 电脑，此前只能向同事借用苹果设备才能完成。网页版 App Store 打破了设备系统限制，任何浏览器都能直接访问，跨平台即可轻松浏览应用详情，再也不用为查询一个应用地址而四处借设备。</p>
<h3 data-id="heading-5">4. 应用链接分享更高效，告别繁琐查找流程</h3>
<p>运营或市场人员需要产品的 App Store 链接时，过去要么翻找存档文档，要么通过第三方平台搜索跳转后复制 URL。现在网页版提供了集中式的应用聚合入口，直接打开网页搜索应用名称，就能快速复制浏览器 URL 一键分享，甚至可让同事自行搜索获取，彻底省去反复沟通查找的麻烦，缩短信息传递路径。</p>
<h3 data-id="heading-6">5. 大屏交互体验升级，操作效率再提升</h3>
<p>电脑端的大屏优势在网页版 App Store 中得到充分发挥，配合键盘输入搜索，操作比手机端更高效。无论是批量筛选竞品、同时对比多个应用详情，还是沉浸式浏览应用截图与用户评论，体验都更为流畅直观。这种差异就像网页版视频对比手机端，在信息获取和操作便捷性上都有明显提升，让应用调研和探索更省心。</p>
<h2 data-id="heading-7">结语</h2>
<p>苹果这次低调上线的网页版 App Store，没有大肆宣传，却精准戳中了开发者、产品人、运营等群体的核心需求。它打破了设备和地区的限制，让 App Store 的内容触达更便捷，无论是竞品调研、跨设备适配查看，还是日常应用浏览、分享，都变得更高效、更省心。</p>
<p>对于开发者和产品人来说，这无疑是一份惊喜福利，也让我们看到了苹果在生态开放上的微小但重要的进步。如果你常需要和 App Store 打交道，不妨赶紧收藏网址，体验这份 “无门槛逛店” 的快乐～</p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-8">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你实现 Rust 迭代器]]></title>    <link>https://juejin.cn/post/7574251313884250127</link>    <guid>https://juejin.cn/post/7574251313884250127</guid>    <pubDate>2025-11-20T00:54:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884250127" data-draft-id="7571355989132771343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你实现 Rust 迭代器"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-20T00:54:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你实现 Rust 迭代器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:54:59.000Z" title="Thu Nov 20 2025 00:54:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c6522aca6c455eb033fa92e4593acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=Q632iWiQ3UHqHpydBhqxNqGUNYc%3D" alt="0.png" loading="lazy"/></p>
<p>在完成前面三篇关于 Rust 迭代器的深入学习之后，本篇文章我们尝试自己写一下 Rust 迭代器，即给我们自己的数据加上迭代器的功能。</p>
<p>如果有读者想复习之前的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a></li>
<li><a href="https://juejin.cn/post/7568471321954779170" target="_blank" title="https://juejin.cn/post/7568471321954779170">深入 Rust 迭代器（中）</a></li>
<li><a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a></li>
</ul>
<h2 data-id="heading-0">开始之前</h2>
<p>Rust 原生的 <code>Vec</code> 以及数组，已经支持迭代器相关功能了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">a</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;a {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

a.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i = <span class="hljs-number">100</span>;
});

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, a);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// [100, 100, 100]</span>
</code></pre>
<p><em>上述代码如果将 <code>vec![1, 2, 3]</code> 改成 <code>[1, 2, 3]</code>，效果是一样的。</em></p>
<p>如果你的数据结构有基于 <code>Vec</code> 或者数组去实现迭代器，其实可以直接用 <code>Vec</code> 或者数组的迭代器，完全没有必要自己实现。</p>
<p>但是为了让我们更加了解迭代器的内部原理以及相关的实现细节，该篇文章我们尝试为自己的数据实现一个迭代器。</p>
<p>首先，你需要一个简单的类：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
}
</code></pre>
<h2 data-id="heading-1">为类实现迭代器</h2>
<p>在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 文中已经知道，如果我们要为自己的数据实现一个迭代器，就需要实现 <code>Iterator</code> <code>trait</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">//...</span>
    }
}
</code></pre>
<p>该 <code>trait</code> 需要实现的函数非常简单 —— <code>next</code> 即可。</p>
<p><code>next</code> 返回一个 <code>Option</code>，如果迭代器结束，直接返回 <code>None</code>。</p>
<p>为了能够实现迭代器功能，我们需要对 <code>Rect</code> 进行一点改造，添加一个迭代器下标：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,

    iter_index:<span class="hljs-type">u8</span>, <span class="hljs-comment">// 用于计数当前迭代的位置</span>
}
</code></pre>
<p>然后，为 <code>Rect</code> 实现迭代器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">next</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        };

        <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;

        next
    }
}
</code></pre>
<p><em>现在知道为什么 <code>next</code> 需要的入参是 <code>&amp;mut self</code> 了吧！</em></p>
<p>每次调用 <code>next</code> 的时候，我们先返回当前的值，然后对迭代的下标 <code>+1</code>。</p>
<p>如果迭代结束了，则返回 <code>None</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
    iter_index: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>OK，很简单。</p>
<p>但是这样写，会有两个严重问题：</p>
<ul>
<li><code>iter_index</code> 对迭代的影响很大，如果这个值设置错误，迭代就不能从头开始。</li>
<li>无法再次使用迭代，即不能再次使用 <code>for i in rect</code>。</li>
</ul>
<p>我们来看第一个问题，如果我们给 <code>iter_index</code> 为 <code>3</code>。结果就会变成：</p>
<pre><code class="hljs language-txt" lang="txt">4
</code></pre>
<p>对，只会输出一个 <code>4</code>，因为我们的 <code>next</code> 实现，是基于 <code>iter_index</code> 做的。</p>
<p>第二个问题，当我们再次使用 <code>rect</code> 进行迭代的时候：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783ddd43b6e74cdbb4e06d6a176b1dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=InEjz2VEKQz5Dw8Kv6n8fqBoBQ0%3D" alt="1.png" loading="lazy"/></p>
<p>会得到这样一个错误。</p>
<p>原因是，<code>for i in rect</code> 是 Rust 提供的语法糖，实际上那段代码会被编译成如下的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">iter</span> = <span class="hljs-built_in">IntoIterator</span>::<span class="hljs-title function_ invoke__">into_iter</span>(collection);
<span class="hljs-keyword">loop</span> {
    <span class="hljs-keyword">match</span> iter.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-title function_ invoke__">Some</span>(i) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
        }
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">break</span>,
    }
}
</code></pre>
<p>查看 <code>IntoIterator::into_iter</code> 的源码，我们发现：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[inline]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> I {
    <span class="hljs-keyword">self</span>
}
</code></pre>
<p><code>IntoIterator::into_iter</code> 会获取入参的所有权，这也就是为什么不能写两次 <code>for i in rect</code> 的原因。</p>
<p>为了解决上面两个问题，我们看看正确的迭代器是如何实现的。</p>
<h2 data-id="heading-2">IntoIterator</h2>
<p>Rust 提供了一个 <code>trait</code> —— <code>IntoIterator</code>，它的作用就是<strong>把一个“可迭代的东西”（比如容器）转换成一个“迭代器”</strong>。</p>
<p>这里，我们的 <code>Rect</code> 就是一个可迭代的数据，通过实现 <code>IntoIterator</code> 就可以变成一个迭代器了。</p>
<pre><code class="hljs language-rust" lang="rust">
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 这里去掉了 iter_index</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectIter</span> {
    data: Rect,
    iter_index: <span class="hljs-type">u8</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectIter</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectIter;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>读者会发现，我们对 <code>Rect</code> 实现了 <code>IntoIterator</code>，该 <code>trait</code> 要求返回一个 <code>IntoIter</code> 类型，<code>IntoIter</code> 实际上是 <code>type IntoIter: Iterator&lt;Item = Self::Item&gt;;</code>，也就是一个迭代器。</p>
<p>此处，我们定义了一个新的迭代器类型 <code>RectIter</code> 并实现了 <code>Iterator</code>，最后 <code>IntoIterator</code> 中的 <code>into_iter(self)</code> 返回 <code>RectIter</code>。</p>
<p>好的，现在我们来看看效果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>我们不用再在 <code>Rect</code> 中定义迭代下标了，当使用迭代器的时候，<code>RectIter</code> 中的迭代下标，都会设置为 <code>0</code> 开始。</p>
<p>但是它依然没有解决重复使用的问题，也就是我们不能再次迭代 <code>Rect</code>。</p>
<h2 data-id="heading-3">迭代 &amp;</h2>
<p>我们要做的事情实际上很简单，就是为 <code>&amp;Rect</code> 提供一个迭代器，这样我们就可以针对 <code>&amp;Rect</code> 进行迭代了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为 &amp;Rect 创建一个迭代器结构体（借用型）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-comment">// 为 RectRefIterator 实现 Iterator trait</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;
        result
    }
}

<span class="hljs-comment">// 为 &amp;Rect 实现 IntoIterator trait（借用型）</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectRefIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>我们直接定义让 <code>&amp;Rect</code> 实现 <code>IntoIterator</code> <code>trait</code>，这里的写法比较长：<code>impl&lt;'a&gt; IntoIterator for &amp;'a Rect</code>。</p>
<p><code>'a</code> 是一个生命周期标注，如果你还不熟悉生命周期标注，可以先跳过，我们可以简单的理解为如果你有引用类型，需要帮助编译器来确定这个引用能存活多长时间。</p>
<p>此时，返回的 <code>IntoIter</code> 类型我们需要重新定义一个 <code>RectRefIterator&lt;'a&gt;</code>，同样，它会持有一个 <code>&amp;'a Rect</code>，即 <code>&amp;Rect</code> 类型。</p>
<p>这样，我们就可以多次遍历了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect { <span class="hljs-comment">// 注意这里是 &amp;rect</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}
</code></pre>
<p>如果你想消耗掉 <code>rect</code>，<code>for i in rect</code> 即可。</p>
<p>那么，如果我想支持 <code>&amp;mut</code> 呢？</p>
<h2 data-id="heading-4">迭代 &amp;mut</h2>
<p><code>for i in &amp;mut rect</code> 一般这种迭代形式，是说我想在迭代的时候更改元素，例如下面这个在迭代的时候更改数组里面的值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> a {
    *i = <span class="hljs-number">100</span>;
}
</code></pre>
<p>好的，这应该是所有迭代器中，编写最麻烦的一个了。</p>
<p>我们尝试，按照上面那个写法，写一个迭代器试试：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index</span> = <span class="hljs-keyword">self</span>.index;
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;

        <span class="hljs-keyword">match</span> index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}
</code></pre>
<p>其实就是把 <code>&amp;Rect</code> 变成了 <code>&amp;mut Rect</code>。</p>
<p>但是这段代码是无法通过编译的，你会得到这样一段提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5186aa630045f3b147d72129ed0b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=TZ7vjlo4Gy4d%2Ft%2BIQqjycdxyNr8%3D" alt="2.png" loading="lazy"/></p>
<p>这里简单解释一下，<code>fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;</code> 实际上是 <code>fn next(&amp;mut self) -&gt; Option&lt;&amp;'a mut f32&gt;</code>，这个函数需要返回一个带 <code>'a</code> 生命周期的引用，但是 Rust 编译器不知道这个 <code>'a</code> 从哪儿来的，Rust 函数的生命周期标注，必须要有一个来源。</p>
<p>那么如果我们改成 <code>fn next(&amp;'a mut self)</code> ?</p>
<p>也不行，因为 <code>impl&lt;'a&gt; Iterator</code> 的函数定义不是这样的，此时，似乎陷入一个僵局了···</p>
<p>由于这个地方过于复杂，我们不再深入探讨，我先给出用正确答案的一种：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 1. 自定义迭代器结构体</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-comment">// 指向 Rect 内部当前 f32 元素的原始可变指针。</span>
    ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 剩余的元素数量。</span>
    len: <span class="hljs-type">usize</span>,
    <span class="hljs-comment">// 生命周期标记：将迭代器的生命周期 'a 绑定到 Rect 的 &amp;mut 借用上。</span>
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>&gt;,
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 2. 针对 &amp;mut Rect 实现 IntoIterator</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectMutIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr_f32</span> = <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

        RectMutIterator {
            ptr: ptr_f32,
            len: <span class="hljs-number">4</span>, <span class="hljs-comment">// 字段总数</span>
            _marker: PhantomData,
        }
    }
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 3. 迭代器的实现</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>; <span class="hljs-comment">// 返回 f32 的可变引用</span>

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">// 1. 检查是否迭代完毕</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.len == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;
        }

        <span class="hljs-comment">// 2. 减少剩余元素计数</span>
        <span class="hljs-keyword">self</span>.len -= <span class="hljs-number">1</span>;

        <span class="hljs-comment">// 3. 核心 unsafe 逻辑</span>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 获取当前元素的指针</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">current_ptr</span> = <span class="hljs-keyword">self</span>.ptr;

            <span class="hljs-comment">// 将内部指针移动到下一个元素</span>
            <span class="hljs-comment">// offset(1) 是一个 safe 抽象，但它内部执行的是 unsafe 指针算术</span>
            <span class="hljs-comment">// 它确保 `self.ptr` 现在指向下一个 f32 (即下一个字段)</span>
            <span class="hljs-keyword">self</span>.ptr = <span class="hljs-keyword">self</span>.ptr.<span class="hljs-title function_ invoke__">offset</span>(<span class="hljs-number">1</span>);

            <span class="hljs-comment">// 4. 将当前的原始指针转换回安全的 &amp;mut f32 引用</span>
            <span class="hljs-comment">// 这是安全的，因为我们通过 len 和 ptr 的管理，</span>
            <span class="hljs-comment">// 确保了当前元素是独占的，且生命周期被正确绑定。</span>
            <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> *current_ptr)
        }
    }
}
</code></pre>
<p>我们测试一下看看：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
     a: <span class="hljs-number">1.0</span>,
     b: <span class="hljs-number">2.0</span>,
     c: <span class="hljs-number">3.0</span>,
     d: <span class="hljs-number">4.0</span>,
 };

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> rect {
     *i += <span class="hljs-number">10.0</span>;
 }

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, rect);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// Rect { a: 11.0, b: 12.0, c: 13.0, d: 14.0 }</span>
</code></pre>
<p>结果是正确的。</p>
<p>好的，到此，几种基本的迭代器类型我们已经实现完毕了。除了 <code>&amp;mut</code> 比较复杂以外，其他两种还算是轻松。</p>
<h2 data-id="heading-5">Rust 的一些习惯</h2>
<p>实际上，Rust 中针对迭代器，还有一些习惯，我们在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 提到 Rust 迭代器中，有三种等价情况：</p>
<ul>
<li><code>for i in &amp;vec</code> 等价于 <code>for i in vec.iter()</code>。</li>
<li><code>for i in &amp;mut</code> 等价于 <code>for i in vec.iter_mut()</code>。</li>
<li><code>for i in vec</code> 等价于 <code>for i in vec.into_iter()</code>。</li>
</ul>
<p>所以，我们给 <code>Rect</code> 添加一下这三个方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectMutIterator {
        RectMutIterator {
            ptr: <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
            len: <span class="hljs-number">4</span>,
            _marker: PhantomData,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectRefIterator {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>这样，我们就可以使用迭代器适配器方法和管道了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i += <span class="hljs-number">10.0</span>;
});

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

rect.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
</code></pre>
<h2 data-id="heading-6">倒序</h2>
<p>在 <a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a> 中，我们最后提到一个 <code>rev()</code>，也就是迭代器倒序。这里我们也实现一下，这样你就能明白那篇文章中，为什么输出结果是那样的了。</p>
<p>我们仅针对 <code>&amp;Rect</code> 实现倒序。</p>
<p>为了实现倒序，我们需要给 <code>RectRefIterator</code> 添加一个 <code>end</code> 字段，该字段和 <code>index</code> 其实效果是一样的，用于标识当前应该返回哪个数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
    end: <span class="hljs-type">usize</span>,
}
</code></pre>
<p>接下来在所有用到 <code>RectRefIterator</code> 的地方，设置 <code>end</code> 为 <code>4</code>：</p>
<pre><code class="hljs language-rust" lang="rust">RectRefIterator {
    rect: <span class="hljs-keyword">self</span>,
    index: <span class="hljs-number">0</span>,
    end: <span class="hljs-number">4</span>,
}
</code></pre>
<p>为了能够让迭代器支持 <code>rev()</code>，我们需要实现一个 <code>DoubleEndedIterator</code> 的 <code>trait</code>，该 <code>trait</code> 只需要实现 <code>fn next_back(&amp;mut self)</code> 即可，即倒着返回数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">DoubleEndedIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next_back</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.end {
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">4</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.end -= <span class="hljs-number">1</span>;
        result
    }
}
</code></pre>
<p>好，万事俱备，我们测试一下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 4.0 3.0 2.0 1.0</span>
</code></pre>
<p>完美。</p>
<h2 data-id="heading-7">总结</h2>
<p>好的，关于 Rust 迭代器的这个系列，终于迎来了完结。</p>
<p>我们在最后这篇文章中，给自己的数据实现了迭代器功能。</p>
<p>通过我们手动编写迭代器，我们不仅学会了如何实现迭代器，也加深了对 Rust 中数据使用的理解，你会发现，Rust 始终围绕<strong>所有权</strong>、<strong>借用</strong>、<strong>可变借用</strong>来实现数据的访问。</p>
<p>这种设计不是限制，而是一种引导——它迫使我们在编写代码的时候就思考：</p>
<ul>
<li>谁拥有数据？</li>
<li>谁在读取或修改它？</li>
<li>生命周期是否安全？</li>
</ul>
<p>正是这些看似“严格”的规则，让 Rust 能在不依赖垃圾回收的情况下，既保证内存安全，又实现零成本抽象。而迭代器，正是这一哲学的完美体现：它把控制权交给开发者，又用类型系统默默守护着每一份引用的安全。</p>
<p>现在，当你再看到 <code>for x in vec</code> 时，或许不再只觉得它简洁优雅，更能体会到背后那套精密、可靠、充满智慧的机制在默默运转。</p>
<p>感谢你一路走到这里。愿你在 Rust 的旅程中，继续享受这种“被约束的自由”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移]]></title>    <link>https://juejin.cn/post/7574404398067482624</link>    <guid>https://juejin.cn/post/7574404398067482624</guid>    <pubDate>2025-11-20T10:06:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574404398067482624" data-draft-id="7574529034673012771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移"/> <meta itemprop="keywords" content="大数据,SQL"/> <meta itemprop="datePublished" content="2025-11-20T10:06:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T10:06:27.000Z" title="Thu Nov 20 2025 10:06:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>作者：曹霖</strong></p>
<p>本系列文章将围绕东南亚头部科技集团的真实迁移历程展开，逐步拆解 BigQuery 迁移至 MaxCompute 过程中的关键挑战与技术创新。本篇为第十二篇，基于 阿里云MaxCompute 实现BigQuery 10万条SQL智能转写迁移。</p>
<p>注：客户为东南亚头部科技集团，文中用 GoTerra 表示。</p>
<h2 data-id="heading-0">一、项目背景</h2>
<p>在全球化和数字化加速的浪潮下，越来越多的企业出于成本优化、合规要求和业务协同等原因，考虑将自建或三方大数据平台迁移至阿里云MaxCompute。本案例基于是东南亚头部科技集团 GoTerra，其业务生态覆盖网约车、电商、外卖、物流及金融支付等多个垂直领域，多年运行在 Google Cloud BigQuery 的数仓平台，基于综合优势分析规划全量迁移至阿里云 MaxCompute。</p>
<p>相比数据搬迁本身，迁移过程中一个更为棘手的挑战是：</p>
<ul>
<li><strong>10 万条 SQL 脚本的高质量快速转写</strong>。这其中既包含简短的分析 SQL，也包含上万行、嵌套极深的复杂 ETL 逻辑。</li>
<li>脚本广泛使用了 BigQuery 特有的语法、函数（如 <code>UNNEST</code>、<code>SAFE_CAST</code>、<code>FORMAT_DATE</code>）、复杂数据类型（<code>ARRAY</code>、<code>STRUCT</code>、<code>BIGNUMERIC</code>）和独有优化模式。</li>
<li>在历史业务沉淀下，不少 SQL 逻辑与业务规则、数据模型紧密绑定，稍有不慎便会影响数据产品准确性。</li>
</ul>
<p>传统人力转写方式显然不现实。内部测算显示：</p>
<ul>
<li>假设工程师日均高质量转写 5 条 SQL，则需 <strong>2 万人天</strong>；</li>
<li>即便 100 人并行，也要近 <strong>1 年</strong>才能完成，远超半年上线目标。</li>
<li>质量一致性无法保障，知识传递和规则固化存在巨大难度，回归测试成本高昂。</li>
</ul>
<p>在这样背景下，团队必须找到 <strong>自动化+协同化的工程化解法</strong>，提升 SQL 转换率，实现大规模、可控的迁移。</p>
<h2 data-id="heading-1">二、解决方案</h2>
<h3 data-id="heading-2">整体策略</h3>
<p>我们基于阿里云 <strong>Cloud Migration Hub（CMH）/ Lake Migration Hub（LMH）</strong> 自动化迁移能力，配合自研规则引擎、AST（抽象语法树）转换、大语言模型（LLM）辅助和人工修正，构建“一条龙”的 <strong>工具主导+人工兜底</strong> 方案，并在迁移过程中沉淀可复用的 <strong>迁移知识库</strong>。</p>
<p>迁移整体分为两大阶段：</p>
<ol>
<li><strong>数据迁移</strong>：将 BigQuery 表数据平滑搬迁到 MaxCompute（包括全量及后续增量），使用在线迁移、MMS（MaxCompute Migration Serverless） 等。</li>
<li><strong>SQL 转写</strong>：借助 CMH/LMH 自动化批量转换 SQL，并通过规则迭代、LLM 增强、人工修正，实现高准确率交付。</li>
</ol>
<h3 data-id="heading-3">数据迁移与SQL转写迁移方案的技术实现与优化</h3>
<p>基于阿里云Cloud Migration Hub（CMH）/Lake Migration Hub（LMH）的自动化迁移能力，结合自主研发的规则引擎、抽象语法树（AST）转换技术、大语言模型（LLM）辅助及人工修正机制，我们构建了一套“工具主导+人工兜底”的端到端迁移解决方案。该方案不仅实现了从数据层到应用层的全栈迁移，还通过迁移知识库的持续沉淀，显著提升了迁移效率与准确性。迁移过程分为以下两个核心阶段：</p>
<h4 data-id="heading-4">第一阶段：数据迁移——保障数据平滑过渡的全生命周期管理</h4>
<p>数据迁移是整个迁移工程的基础，其核心目标是将源端BigQuery的数据无缝迁移到阿里云MaxCompute，并确保迁移过程的高可用性、一致性和可扩展性。</p>
<p><strong>工具与架构</strong>：采用阿里云在线迁移工具（Online Migration）和MMS（MaxCompute Migration Serverless）进行全量数据迁移。在线迁移工具通过分布式架构实现高吞吐量传输，支持断点续传和错误重试机制，确保大规模数据（如PB级）的稳定迁移。MMS则通过Serverless服务化模式，按需分配计算资源，降低运维复杂度。</p>
<h4 data-id="heading-5">第二阶段：SQL转写——自动化与人工协同的智能转换</h4>
<p>SQL转写是迁移过程中技术难度最高的环节，涉及语法、函数、UDF（用户定义函数）及性能优化的复杂转换。我们通过“自动化为主，人工为辅”的分层策略，结合AST分析、规则引擎和LLM技术，实现高准确率的SQL转换。</p>
<h5 data-id="heading-6">1. 自动化转换引擎</h5>
<ul>
<li><strong>AST语法树解析</strong>：基于ANTLR或自研解析器构建BigQuery SQL的抽象语法树（AST），逐层分析语法结构。例如，将BigQuery的<code>SELECT APPROX_COUNT_DISTINCT(column)</code>转换为MaxCompute的<code>SELECT COUNT(DISTINCT column)</code>，并通过AST节点替换实现。</li>
<li><strong>规则引擎迭代优化</strong>：
<ul>
<li><strong>内置规则库</strong>：预置超过200条迁移规则，覆盖数据类型映射（如BigQuery的<code>TIMESTAMP</code>→MaxCompute的<code>DATETIME</code>）、函数替换（如<code>SAFE</code>函数的兼容性处理）、窗口函数调整等场景。</li>
<li><strong>动态规则扩展</strong>：通过迁移知识库的实时反馈，持续迭代规则库。例如，若发现某类CASE-WHEN嵌套语句转换失败，可立即新增规则并重新运行转换流程。</li>
</ul>
</li>
<li><strong>LLM辅助转换</strong>：针对复杂或模糊的SQL语句（如自定义UDF或依赖源端特定语法的查询），利用大语言模型（如通义千问）进行语义解析和意图理解。例如，将BigQuery的<code>STRUCT</code>类型转换为MaxCompute的<code>LATERAL VIEW</code>表达式，LLM可辅助生成等效逻辑的SQL代码。</li>
</ul>
<h5 data-id="heading-7">2. 人工修正与质量控制</h5>
<ul>
<li><strong>自动化缺陷定位</strong>：通过静态代码分析工具和动态执行测试（在测试环境中运行转换后的SQL），快速定位转换失败的语句。例如，若转换后的SQL在MaxCompute执行时因类型不匹配报错，系统将标记该SQL并提示可能的修复方向。</li>
<li><strong>专家介入流程</strong>：
<ul>
<li><strong>优先级分级</strong>：根据错误类型（如语法错误、性能隐患、业务逻辑偏差）和影响范围，将问题分为P0-P3等级，优先处理高风险缺陷。</li>
<li><strong>协同开发环境</strong>：提供基于IDE的联机调试工具，允许开发者直接修改转换后的SQL，并通过版本控制系统（如Git）管理修改记录，确保可追溯性。</li>
</ul>
</li>
<li><strong>迁移知识库的闭环反馈</strong>：每次人工修正后，系统自动提取修正前后的SQL差异，并将其归类为新规则或案例存入知识库。例如，若某次修正解决了BigQuery的<code>ARRAY_AGG</code>到MaxCompute的<code>COLLECT_SET</code>转换问题，该规则将被优先级提升，并在后续迁移中自动应用。</li>
</ul>
<h5 data-id="heading-8">3. 转换后验证与优化</h5>
<ul>
<li><strong>功能验证</strong>：在测试集群中执行转换后的SQL，对比源端和目标端的查询结果，确保业务逻辑一致性。</li>
<li><strong>性能调优</strong>：利用MaxCompute的执行计划分析工具，识别转换后SQL的性能瓶颈（如全表扫描、Join顺序不当），并通过索引优化、分区裁剪或谓词下推等手段提升效率。</li>
<li><strong>迁移知识库的持续优化</strong>：将验证过程中发现的性能优化策略（如特定函数转换方式）补充至知识库，形成“迁移-修正-优化”的闭环。</li>
</ul>
<h4 data-id="heading-9">迁移知识库的核心价值与应用场景</h4>
<p>迁移知识库是整个方案的关键支撑，其价值体现在以下方面：</p>
<ol>
<li>
<p><strong>规则复用与加速迭代</strong>：通过积累迁移规则、缺陷案例和最佳实践，新项目可直接调用知识库中的已有规则，减少重复性开发。例如，某金融客户在迁移过程中发现BigQuery的<code>DATE_TRUNC</code>函数在MaxCompute中需配合<code>DATE_FORMAT</code>使用，该规则可直接复用至其他项目。</p>
</li>
<li>
<p><strong>风险预判与质量提升</strong>：知识库中的历史案例可辅助迁移前的风险评估，例如提前识别BigQuery的<code>ML_*</code>机器学习函数在MaxCompute中的替代方案，避免迁移后期的返工。</p>
</li>
<li>
<p><strong>跨团队协作与知识传承</strong>：知识库采用统一的Markdown格式和分类标签（如按场景、工具、复杂度分类），支持多团队并行查阅与贡献，降低隐性知识流失风险。</p>
</li>
</ol>
<h4 data-id="heading-10">技术优势与迁移成效</h4>
<p>通过上述技术方案，我们实现了以下显著优势：</p>
<ul>
<li><strong>迁移效率提升</strong>：相比纯人工迁移，自动化工具将SQL转写效率提升80%以上，单项目迁移周期从数年缩短至数月。</li>
<li><strong>准确性保障</strong>：结合规则引擎与LLM的双通道验证，部分场景SQL转换准确率超过90%，人工修正仅需处理约10%的复杂场景。</li>
<li><strong>成本优化</strong>：通过MMS的Serverless模式和按需计费机制，降低数据迁移成本，同时减少因停机迁移导致的业务损失。</li>
</ul>
<h2 data-id="heading-11">三、核心技术</h2>
<h3 data-id="heading-12">1. SQL 转换主流技术：AST 驱动</h3>
<p>相比复杂且易出错的正则/模板替换，AST 驱动的 SQL 转换具备可扩展、高可维护等优势：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b99cb3b509144cc84dee5c06eb7479e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764237987&amp;x-signature=Mj%2FlUCpGQlDUaUIZW9zzpwvUHtU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p><strong>Parse</strong>：将 BigQuery SQL 解析为抽象语法树（AST），保留结构和节点类型（SELECT、FROM、FUNCTION_CALL 等）。</p>
</li>
<li>
<p><strong>Transform</strong>：按规则库替换/重构 AST 节点，例如：</p>
<ul>
<li>
<p><code>FORMAT_DATE('%Y-%m-%d', col)</code> → <code>TO_CHAR(col, 'yyyy-MM-dd')</code></p>
</li>
<li>
<p><code>UNNEST(array_col)</code> → <code>LATERAL VIEW EXPLODE(array_col)</code></p>
</li>
<li>
<p>隐式类型转换规则修正</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate</strong>：输出目标 MaxCompute SQL。</p>
</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li>对复杂嵌套、长 SQL 稳定性高</li>
<li>易于增量维护规则</li>
<li>可结合类型系统和元数据增强（RAG 思路）</li>
</ul>
<h3 data-id="heading-13">2. SQL 转换示例</h3>
<p><strong>BigQuery SQL</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> FORMAT_DATE(<span class="hljs-string">'%Y-%m-%d'</span>, order_time) <span class="hljs-keyword">AS</span> order_date,
       <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> user_id) <span class="hljs-keyword">AS</span> uv
<span class="hljs-keyword">FROM</span> `project.dataset.orders`
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> DATE_SUB(<span class="hljs-built_in">CURRENT_DATE</span>(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_date;

</code></pre>
<p><strong>MaxCompute SQL</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> TO_CHAR(order_time, <span class="hljs-string">'yyyy-MM-dd'</span>) <span class="hljs-keyword">AS</span> order_date,
       <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> user_id) <span class="hljs-keyword">AS</span> uv
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-built_in">CURRENT_DATE</span>, <span class="hljs-number">-30</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_date;

</code></pre>
<p><strong>映射规则</strong>：</p>
<ul>
<li><code>FORMAT_DATE</code> → <code>TO_CHAR</code>（参数位置调整）</li>
<li><code>DATE_SUB</code> → <code>DATEADD</code>（顺序/符号兼容）</li>
<li>去除 BigQuery 数据集前缀</li>
<li>类型映射：DATE 保持一致，BIGINT 替换 INT64</li>
</ul>
<h3 data-id="heading-14">3. SQL转写流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617587520bfe4c758593d0f3538ab912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764237987&amp;x-signature=c1vLs3c3zE%2BiWac1SM6XJUR4pHA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">4. 行业实践与趋势</h3>
<p>在多家企业的跨云 SQL 迁移中，总结出几条趋势：</p>
<ul>
<li><strong>AST+规则库</strong> 是工程实践中相对高效可控的技术路径</li>
<li><strong>LLM 加持的混合模式</strong> 在处理尾部长尾复杂 SQL 时展现价值</li>
<li><strong>知识库驱动持续优化</strong> 可复用性强，提升 ROI</li>
<li><strong>平台自适配增强</strong> 比单纯靠转换器更能保障业务一致性</li>
</ul>
<h2 data-id="heading-16">四、小结与未来展望</h2>
<p><strong>本项目成果</strong>：</p>
<ul>
<li>在 4 个月内完成 SQL 转写任务，比计划提前 1 个月上线</li>
<li>工具转换率从 5%→80%，人工成本下降 70%+</li>
<li>沉淀上千条规则和案例，形成可复用的 SQL 迁移知识库</li>
<li>平台能力增强，提升未来兼容性</li>
</ul>
<p><strong>展望</strong>：</p>
<ul>
<li>推动 CMH/LMH 全自动化迁移平台，支持更多方言（Snowflake、Databricks 等）</li>
<li>引入在线实时 SQL 转换 API，支持多云混合分析</li>
<li>结合执行计划与成本模型的自动化 SQL 优化器</li>
<li>依托知识库与 RAG 提高 LLM 转换一致性与可解释性</li>
</ul>
<p><strong>参考研究</strong>：</p>
<ul>
<li>《Mallet: SQL Dialect Translation with LLM Rule Generation》</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 神奇的 Dart Zone 机制]]></title>    <link>https://juejin.cn/post/7574816159754207283</link>    <guid>https://juejin.cn/post/7574816159754207283</guid>    <pubDate>2025-11-21T06:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574816159754207283" data-draft-id="7574726841543737382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 神奇的 Dart Zone 机制"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-21T06:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未来猫咪花"/> <meta itemprop="url" content="https://juejin.cn/user/1081575169340526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 神奇的 Dart Zone 机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575169340526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未来猫咪花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:24:07.000Z" title="Fri Nov 21 2025 06:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📚 第一部分：什么是 Zone？</h2>
<h3 data-id="heading-1">Zone 的定义</h3>
<p>在 Dart 中，<strong>Zone</strong> 是一种<strong>执行上下文（execution context）</strong>，你可以把它想象成一个"气泡"或"容器"，代码在这个容器里执行时，可以访问到一些特定的环境变量和配置。</p>
<p>用更通俗的比喻：</p>
<ul>
<li>🏠 Zone 就像一个"房间"</li>
<li>📦 房间里有一些"储物柜"（zoneValues）</li>
<li>🚪 进入房间的代码可以访问这些储物柜</li>
<li>🔑 每个储物柜有一个键（key），用来存取数据</li>
</ul>
<h3 data-id="heading-2">最简单的 Zone 示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 普通执行环境</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#userId]}</span>'</span>);  <span class="hljs-comment">// null</span>
  
  <span class="hljs-comment">// 创建一个 Zone，并在其中存储数据</span>
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone 内部: <span class="hljs-subst">${Zone.current[#userId]}</span>'</span>);  <span class="hljs-comment">// "user123" ✅</span>
    someFunction();
  }, zoneValues: {
    #userId: <span class="hljs-string">'user123'</span>,  <span class="hljs-comment">// 👈 存储数据到 Zone</span>
  });
}

<span class="hljs-keyword">void</span> someFunction() {
  <span class="hljs-comment">// 这个函数在 Zone 内部执行，可以读取 Zone 中的数据</span>
  <span class="hljs-keyword">final</span> userId = Zone.current[#userId] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String?</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'someFunction 获取到的 userId: <span class="hljs-subst">$userId</span>'</span>);  <span class="hljs-comment">// "user123" ✅</span>
}
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">外部:</span> <span class="hljs-literal">null</span>
<span class="hljs-string">Zone</span> <span class="hljs-string">内部:</span> <span class="hljs-string">user123</span>
<span class="hljs-string">someFunction</span> <span class="hljs-string">获取到的</span> <span class="hljs-attr">userId:</span> <span class="hljs-string">user123</span>
</code></pre>
<h3 data-id="heading-3">Zone 的核心特性</h3>
<h4 data-id="heading-4">1. 数据隔离</h4>
<p>每个 Zone 都有自己的数据空间，互不干扰：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone A: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// "Alice"</span>
}, zoneValues: {#name: <span class="hljs-string">'Alice'</span>});

runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone B: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// "Bob"</span>
}, zoneValues: {#name: <span class="hljs-string">'Bob'</span>});

<span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// null</span>
</code></pre>
<h4 data-id="heading-5">2. 继承性</h4>
<p>Zone 可以嵌套，内层 Zone 可以访问外层 Zone 的数据：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外层 Zone: <span class="hljs-subst">${Zone.current[#outer]}</span>'</span>);  <span class="hljs-comment">// "outer-value"</span>
  
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'内层 Zone - 外层数据: <span class="hljs-subst">${Zone.current[#outer]}</span>'</span>);  <span class="hljs-comment">// "outer-value" ✅</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'内层 Zone - 内层数据: <span class="hljs-subst">${Zone.current[#inner]}</span>'</span>);  <span class="hljs-comment">// "inner-value" ✅</span>
  }, zoneValues: {
    #inner: <span class="hljs-string">'inner-value'</span>,
  });
}, zoneValues: {
  #outer: <span class="hljs-string">'outer-value'</span>,
});
</code></pre>
<h4 data-id="heading-6">3. 作用域限制</h4>
<p>Zone 中存储的数据只在这个 Zone 的执行范围内有效：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    scheduleMicrotask(() {
      <span class="hljs-comment">// 异步任务仍在同一个 Zone 中 ✅</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'异步任务: <span class="hljs-subst">${Zone.current[#data]}</span>'</span>);  <span class="hljs-comment">// "hello"</span>
    });
  }, zoneValues: {#data: <span class="hljs-string">'hello'</span>});
  
  <span class="hljs-comment">// 这里已经退出 Zone</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#data]}</span>'</span>);  <span class="hljs-comment">// null</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">🎯 第二部分：Zone 的常见用途</h2>
<h3 data-id="heading-8">1. 全局错误捕获</h3>
<p>Zone 最常见的用途之一是捕获所有未处理的异常：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZonedGuarded(() {
    runApp(MyApp());
  }, (error, stackTrace) {
    <span class="hljs-comment">// 👇 捕获所有未处理的异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'捕获到错误: <span class="hljs-subst">$error</span>'</span>);
    reportErrorToServer(error, stackTrace);
  });
}
</code></pre>
<p><strong>用途</strong>：在生产环境中收集所有崩溃信息，发送到错误追踪服务。</p>
<h3 data-id="heading-9">2. 自定义 print 输出</h3>
<p>可以拦截和修改 <code>print</code> 的行为：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'这条日志会被拦截'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'并添加前缀'</span>);
  }, zoneSpecification: ZoneSpecification(
    <span class="hljs-built_in">print</span>: (self, parent, zone, message) {
      <span class="hljs-comment">// 👇 拦截 print，添加自定义前缀</span>
      parent.<span class="hljs-built_in">print</span>(zone, <span class="hljs-string">'[MyApp] <span class="hljs-subst">$message</span>'</span>);
    },
  ));
}
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">MyApp</span>] 这条日志会被拦截
[<span class="hljs-meta">MyApp</span>] 并添加前缀
</code></pre>
<h3 data-id="heading-10">3. 异步操作追踪</h3>
<p>Zone 可以追踪和管理异步操作：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'异步操作完成'</span>);
  <span class="hljs-comment">// 👆 这个异步操作仍在 Zone 内执行</span>
}, zoneValues: {
  #requestId: <span class="hljs-string">'req-12345'</span>,
});
</code></pre>
<p>Flutter 框架内部就是用 Zone 来追踪异步操作的来源，这就是为什么你在 async 方法中抛出的异常能被正确捕获。</p>
<h3 data-id="heading-11">4. 上下文传递（最重要！）</h3>
<p><strong>这是 view_model 使用 Zone 的核心用途</strong>：在不显式传参的情况下，将数据传递给深层的函数调用。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    processRequest();
  }, zoneValues: {
    #currentUser: User(id: <span class="hljs-string">'123'</span>, name: <span class="hljs-string">'Alice'</span>),
  });
}

<span class="hljs-keyword">void</span> processRequest() {
  <span class="hljs-comment">// 不需要传参，直接从 Zone 中获取</span>
  validatePermission();
}

<span class="hljs-keyword">void</span> validatePermission() {
  <span class="hljs-comment">// 深层调用，仍然可以访问 Zone 数据</span>
  <span class="hljs-keyword">final</span> user = Zone.current[#currentUser] <span class="hljs-keyword">as</span> User;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'验证用户权限: <span class="hljs-subst">${user.name}</span>'</span>);
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 不需要层层传递参数</li>
<li>✅ 保持函数签名简洁</li>
<li>✅ 数据在整个调用链中都可访问</li>
</ul>
<hr/>
<h2 data-id="heading-12">🚀 第三部分：view_model 如何借助 Zone 实现依赖机制</h2>
<h3 data-id="heading-13">问题背景</h3>
<p>在 view_model 架构中，我们遇到了一个经典难题：</p>
<p><strong>场景</strong>：ViewModel 想在构造函数中获取其他 ViewModel 依赖</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel() {
    <span class="hljs-comment">// 🤯 问题：我想在构造函数里获取 AuthViewModel</span>
    <span class="hljs-comment">// 但是依赖解析能力在 State 中，这里根本访问不到！</span>
    <span class="hljs-keyword">final</span> authVM = ???  <span class="hljs-comment">// 从哪里获取？</span>
    
    <span class="hljs-keyword">if</span> (authVM.isLoggedIn) {
      loadUserProfile();
    }
  }
}
</code></pre>
<p><strong>核心矛盾</strong>：</p>
<ul>
<li>✅ <strong>Widget/State</strong> 有 BuildContext，可以访问依赖容器</li>
<li>❌ <strong>ViewModel 构造函数</strong> 没有 BuildContext，无法直接获取依赖</li>
<li>❌ 传递 BuildContext 到 ViewModel？违背了架构分层原则</li>
</ul>
<p><strong>我们需要一种机制</strong>：</p>
<ol>
<li>不破坏架构分层（ViewModel 不依赖 Widget）</li>
<li>不显式传参（保持构造函数简洁）</li>
<li>让 ViewModel 能神奇地获取到依赖解析能力</li>
</ol>
<p><strong>答案就是：Zone！</strong></p>
<h3 data-id="heading-14">解决方案：用 Zone 传递依赖解析器</h3>
<p>核心思路：在创建 ViewModel 时，用 Zone 包裹构造过程，将依赖解析器存入 Zone。</p>
<h4 data-id="heading-15">第一步：定义依赖解析器类型</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-comment">// 依赖解析器的函数签名</span>
<span class="hljs-keyword">typedef</span> DependencyResolver = T <span class="hljs-built_in">Function</span>&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;({
  <span class="hljs-keyword">required</span> ViewModelDependencyConfig&lt;T&gt; dependency,
  <span class="hljs-built_in">bool</span> listen,
});

<span class="hljs-keyword">const</span> _resolverKey = #_viewModelDependencyResolver;  <span class="hljs-comment">// Zone 中的键</span>
</code></pre>
<h4 data-id="heading-16">第二步：创建辅助函数，用 Zone 包裹执行</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-comment">/// <span class="markdown">用 Zone 包裹 body 的执行，并将 resolver 存入 Zone</span></span>
R runWithResolver&lt;R&gt;(R <span class="hljs-built_in">Function</span>() body, DependencyResolver resolver) {
  <span class="hljs-keyword">return</span> runZoned(body, zoneValues: {
    _resolverKey: resolver,  <span class="hljs-comment">// 👈 将解析器存入 Zone</span>
  });
}
</code></pre>
<h4 data-id="heading-17">第三步：在 ViewModelAttacher 创建 ViewModel 时使用 Zone</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// attacher.dart</span>

VM _createViewModel&lt;VM <span class="hljs-keyword">extends</span> ViewModel&gt;({
  <span class="hljs-keyword">required</span> ViewModelFactory&lt;VM&gt; <span class="hljs-keyword">factory</span>,
  <span class="hljs-built_in">bool</span> listen = <span class="hljs-keyword">true</span>,
}) {
  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-comment">// 👇 关键！用 runWithResolver 包裹 ViewModel 的创建</span>
  <span class="hljs-keyword">final</span> res = runWithResolver(
    () {
      <span class="hljs-keyword">return</span> _instanceController.getInstance&lt;VM&gt;(
        <span class="hljs-keyword">factory</span>: InstanceFactory&lt;VM&gt;(
          builder: <span class="hljs-keyword">factory</span>.build,  <span class="hljs-comment">// 👈 这里会调用 ViewModel 的构造函数</span>
          <span class="hljs-comment">// ...</span>
        ),
      )..dependencyHandler.addDependencyResolver(onChildDependencyResolver);
    },
    onChildDependencyResolver,  <span class="hljs-comment">// 👈 将依赖解析器传入 Zone</span>
  );
  
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><strong>这一步发生了什么？</strong></p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────┐
│ <span class="hljs-number">1</span>. 调用 _createViewModel&lt;UserProfileViewModel&gt;()  │
│    ↓                                                │
│ <span class="hljs-number">2</span>. <span class="hljs-built_in">runWithResolver</span>(..., onChildDependencyResolver) │
│    创建 Zone { _resolverKey: resolver }            │
│    ↓                                                │
│    【进入 Zone，携带依赖解析器】                    │
│    ↓                                                │
│ <span class="hljs-number">3</span>. factory<span class="hljs-selector-class">.build</span>() → <span class="hljs-built_in">UserProfileViewModel</span>()        │
│    构造函数在 Zone 中执行                          │
└────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-18">第四步：DependencyHandler 从 Zone 中读取解析器</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DependencyHandler</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;DependencyResolver&gt; dependencyResolvers = [];

  T getViewModel&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;({
    <span class="hljs-built_in">Object?</span> key,
    <span class="hljs-built_in">Object?</span> tag,
    ViewModelFactory&lt;T&gt;? <span class="hljs-keyword">factory</span>,
    <span class="hljs-built_in">bool</span> listen = <span class="hljs-keyword">false</span>,
  }) {
    <span class="hljs-comment">// 👇 双重保障：先查列表，再查 Zone</span>
    <span class="hljs-keyword">final</span> resolver = dependencyResolvers.firstOrNull ??
        (Zone.current[_resolverKey] <span class="hljs-keyword">as</span> DependencyResolver?);

    <span class="hljs-keyword">if</span> (resolver == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> StateError(<span class="hljs-string">'No dependency resolver available'</span>);
    }

    <span class="hljs-comment">// 使用解析器获取依赖</span>
    <span class="hljs-keyword">return</span> resolver(
      dependency: ViewModelDependencyConfig&lt;T&gt;(...),
      listen: listen,
    );
  }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>Zone.current[_resolverKey]</code> 读取当前 Zone 中的解析器</li>
<li>双重保障：
<ol>
<li>优先使用 <code>dependencyResolvers</code> 列表（已添加的 resolver）</li>
<li>如果列表为空，从 Zone 中读取</li>
</ol>
</li>
</ul>
<h4 data-id="heading-19">第五步：ViewModel 在构造函数中愉快地获取依赖！</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> AuthViewModel _authVM;

  UserProfileViewModel() {
    <span class="hljs-comment">// ✅ 现在可以直接调用了！</span>
    _authVM = readViewModel&lt;AuthViewModel&gt;();
    
    <span class="hljs-keyword">if</span> (_authVM.isLoggedIn) {
      loadUserProfile();
    }
  }
  
  <span class="hljs-comment">// readViewModel 的实现</span>
  T readViewModel&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;() {
    <span class="hljs-comment">// 内部调用 dependencyHandler.getViewModel()</span>
    <span class="hljs-comment">// 它会从 Zone 中读取解析器 ✅</span>
    <span class="hljs-keyword">return</span> dependencyHandler.getViewModel&lt;T&gt;();
  }
}
</code></pre>
<h3 data-id="heading-20">完整的调用链</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────┐
│ <span class="hljs-number">1</span>. State<span class="hljs-selector-class">.watchViewModel</span>&lt;UserProfileViewModel&gt;()         │
│    ↓                                                      │
│ <span class="hljs-number">2</span>. attacher<span class="hljs-selector-class">._createViewModel</span>()                           │
│    ↓                                                      │
│ <span class="hljs-number">3</span>. <span class="hljs-built_in">runWithResolver</span>(                                      │
│      () =&gt; factory<span class="hljs-selector-class">.build</span>(),                              │
│      onChildDependencyResolver  👈 存入 Zone             │
│    )                                                      │
│    ↓                                                      │
│    【进入 Zone，携带 onChildDependencyResolver】          │
│    ↓                                                      │
│ <span class="hljs-number">4</span>. <span class="hljs-built_in">UserProfileViewModel</span>() 构造函数被调用                │
│    ↓                                                      │
│ <span class="hljs-number">5</span>. readViewModel&lt;AuthViewModel&gt;()                       │
│    ↓                                                      │
│ <span class="hljs-number">6</span>. dependencyHandler<span class="hljs-selector-class">.getViewModel</span>&lt;AuthViewModel&gt;()      │
│    ↓                                                      │
│ <span class="hljs-number">7</span>. 从 Zone<span class="hljs-selector-class">.current</span><span class="hljs-selector-attr">[_resolverKey]</span> 读取 resolver ✅       │
│    ↓                                                      │
│ <span class="hljs-number">8</span>. resolver&lt;AuthViewModel&gt;()                            │
│    → 调用 State 的 onChildDependencyResolver           │
│    → 回到 State 的上下文                               │
│    → 创建/获取 AuthViewModel ✅                         │
│    ↓                                                      │
│ <span class="hljs-number">9</span>. 返回 AuthViewModel 实例给 UserProfileViewModel      │
└──────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-21">为什么添加到 dependencyResolvers 列表？</h3>
<p>在创建完 ViewModel 后，会将 resolver 添加到列表中：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> res = runWithResolver(
  () {
    <span class="hljs-keyword">return</span> _instanceController.getInstance&lt;VM&gt;(...)
      ..dependencyHandler.addDependencyResolver(onChildDependencyResolver);  <span class="hljs-comment">// 👈</span>
  },
  onChildDependencyResolver,
);
</code></pre>
<p><strong>原因</strong>：</p>
<ol>
<li>ViewModel <strong>创建时</strong>：在 Zone 中，可以从 <code>Zone.current[_resolverKey]</code> 获取</li>
<li>ViewModel <strong>创建后</strong>：Zone 已退出，但 resolver 已添加到列表中</li>
<li>后续调用 <code>readViewModel</code> 时，从 <code>dependencyResolvers</code> 列表中获取</li>
</ol>
<p><strong>双重保障</strong>确保 ViewModel 在任何时候都能访问依赖解析器！</p>
<hr/>
<h2 data-id="heading-22">🌟 第四部分：Zone 方案的优势</h2>
<h3 data-id="heading-23">1. 架构纯净</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 不好的方案：ViewModel 依赖 BuildContext</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel(BuildContext context) {
    <span class="hljs-keyword">final</span> authVM = context.read&lt;AuthViewModel&gt;();  <span class="hljs-comment">// 违背分层原则</span>
  }
}

<span class="hljs-comment">// ✅ 优雅的方案：ViewModel 完全独立</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel() {
    <span class="hljs-keyword">final</span> authVM = readViewModel&lt;AuthViewModel&gt;();  <span class="hljs-comment">// 不依赖任何 Widget 概念</span>
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>ViewModel 不知道 Widget、BuildContext 的存在</li>
<li>可以在任何环境中测试（不需要 Widget 树）</li>
<li>保持了清晰的架构分层</li>
</ul>
<h3 data-id="heading-24">2. 开发体验极佳</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  OrderViewModel() {
    <span class="hljs-comment">// 👇 像写同步代码一样简洁</span>
    <span class="hljs-keyword">final</span> userVM = readViewModel&lt;UserViewModel&gt;();
    <span class="hljs-keyword">final</span> cartVM = readViewModel&lt;CartViewModel&gt;();
    <span class="hljs-keyword">final</span> paymentVM = readViewModel&lt;PaymentViewModel&gt;();
    
    <span class="hljs-comment">// 直接使用，无需任何样板代码</span>
    <span class="hljs-keyword">if</span> (userVM.isLoggedIn &amp;&amp; cartVM.hasItems) {
      paymentVM.calculateTotal(cartVM.items);
    }
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>代码简洁，可读性强</li>
<li>无需层层传递参数</li>
<li>构造函数逻辑清晰</li>
</ul>
<h3 data-id="heading-25">3. Zone 的自动传播</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewModel1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  ViewModel1() {
    <span class="hljs-comment">// 创建 ViewModel2 时，Zone 仍然有效</span>
    <span class="hljs-keyword">final</span> vm2 = readViewModel&lt;ViewModel2&gt;();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewModel2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  ViewModel2() {
    <span class="hljs-comment">// ViewModel2 的构造函数仍在同一个 Zone 中</span>
    <span class="hljs-comment">// 可以继续获取其他依赖</span>
    <span class="hljs-keyword">final</span> vm3 = readViewModel&lt;ViewModel3&gt;();
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>Zone 会自动传播到整个调用链</li>
<li>多级依赖的 ViewModel 可以无缝工作</li>
<li>不需要额外的传递逻辑</li>
</ul>
<h3 data-id="heading-26">4. 类型安全</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ✅ 编译时类型检查</span>
<span class="hljs-keyword">final</span> authVM = readViewModel&lt;AuthViewModel&gt;();  <span class="hljs-comment">// AuthViewModel 类型</span>
authVM.login();  <span class="hljs-comment">// IDE 提供完整的代码补全</span>

<span class="hljs-comment">// ❌ 如果用 Map 传递参数，失去类型安全</span>
<span class="hljs-keyword">final</span> authVM = dependencies[<span class="hljs-string">'auth'</span>] <span class="hljs-keyword">as</span> AuthViewModel?;  <span class="hljs-comment">// 运行时可能出错</span>
</code></pre>
<hr/>
<h2 data-id="heading-27">📦 总结</h2>
<p>通过 Zone 机制，view_model 实现了优雅的依赖注入，让开发者可以在 ViewModel 构造函数中自然地获取依赖，同时保持架构的清晰和纯净！🚀  来试试：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fview_model" target="_blank" title="https://pub.dev/packages/view_model" ref="nofollow noopener noreferrer">pub.dev/packages/vi…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot项目整合Kafka启动失败的常见错误总结]]></title>    <link>https://juejin.cn/post/7574734686494441508</link>    <guid>https://juejin.cn/post/7574734686494441508</guid>    <pubDate>2025-11-21T06:31:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574734686494441508" data-draft-id="7574745301724790790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot项目整合Kafka启动失败的常见错误总结"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-21T06:31:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot项目整合Kafka启动失败的常见错误总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:31:39.000Z" title="Fri Nov 21 2025 06:31:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、Kafka服务器连接问题</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. Kafka服务器无法连接</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">java.lang.IllegalStateException: Cannot connect to bootstrap servers

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>Kafka服务器未启动</li>
<li>配置的IP地址或端口错误</li>
<li>防火墙阻止了对Kafka服务器的访问</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保Kafka服务器正在运行（<code>bin/kafka-server-start.sh config/server.properties</code>）</li>
<li>检查<code>bootstrap-servers</code>配置是否正确</li>
<li>确保防火墙开放了Kafka使用的端口（默认9092）</li>
</ul>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 开发环境与生产环境网络不通</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">java.lang.IllegalStateException: Cannot connect to bootstrap servers

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>开发环境配置了生产环境的Kafka地址</li>
<li>开发环境与生产环境网络不通</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>关闭Kafka消费端的自动启动：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方案1：在容器工厂中设置</span>
<span class="hljs-meta">@Bean</span>
public ConcurrentKafkaListenerContainerFactory&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; kafkaListenerContainerFactory() {
    ConcurrentKafkaListenerContainerFactory&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();
    <span class="hljs-keyword">factory</span>.setConsumerFactory(consumerFactory());
    <span class="hljs-keyword">factory</span>.setAutoStartup(<span class="hljs-keyword">false</span>); <span class="hljs-comment">// 关闭自动启动</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">factory</span>;
}

<span class="hljs-comment">// 方案2：在@KafkaListener注解中设置</span>
<span class="hljs-meta">@KafkaListener</span>(
    topics = <span class="hljs-string">"my-topic"</span>,
    groupId = <span class="hljs-string">"my-group"</span>,
    autoStartup = <span class="hljs-string">"false"</span> <span class="hljs-comment">// 关闭自动启动</span>
)

AI写代码java
运行
<span class="hljs-number">123456789101112131415</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、序列化配置错误</h3>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 生产者序列化配置错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">KafkaException:</span> Failed <span class="hljs-keyword">to</span> construct kafka producer
Caused <span class="hljs-keyword">by</span>: org.apache.kafka.common.errors.SerializationException: 
<span class="hljs-keyword">Error</span> serializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">123</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>配置了错误的序列化器（如<code>value-serializer</code>配置为<code>StringDeserializer</code>，应为<code>StringSerializer</code>）</li>
</ul>
<p><strong>正确配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">producer:</span>
      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">12345</span>
</code></pre>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 消费者反序列化配置错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.apache.kafka.common.errors.SerializationException: <span class="hljs-keyword">Error</span> deserializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>消费者配置了错误的反序列化器</li>
</ul>
<p><strong>正确配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">12345</span>
</code></pre>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、依赖配置问题</h3>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 缺少必要的Kafka依赖</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">Caused by: java.lang.NoClassDefFoundError: org/apache/kafka/common/serialization/Serializer

AI写代码
1
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>项目中缺少<code>spring-kafka</code>依赖</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 与Spring Boot版本匹配 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

AI写代码xml
12345
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 依赖版本不兼容</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-css" lang="css">Caused by: java.lang.NoSuchMethodError: org.apache.kafka.common.serialization.Serializer.<span class="hljs-built_in">serialize</span>(Ljava/lang/String;Ljava/lang/<span class="hljs-selector-tag">Object</span>;)Ljava/lang/byte<span class="hljs-selector-attr">[]</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>Spring Boot、Spring Kafka和Kafka服务器版本不兼容</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保使用与Kafka服务器版本兼容的Spring Kafka版本</li>
<li>参考Spring Boot官方文档的版本兼容性表</li>
</ul>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、配置文件错误</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 配置文件格式错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.springframework.beans.factory.BeanCreationException: 
<span class="hljs-keyword">Error</span> creating bean <span class="hljs-keyword">with</span> name <span class="hljs-comment">'kafkaListenerContainerFactory' defined in class path resource </span>
[org/springframework/boot/autoconfigure/kafka/KafkaAutoConfiguration.<span class="hljs-keyword">class</span>]: 
Cannot create a Kafka listener container factory <span class="hljs-keyword">for</span> the given configuration.

AI写代码
<span class="hljs-number">1234</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>YAML文件缩进错误</li>
<li>配置项拼写错误</li>
<li>配置项格式不正确</li>
</ul>
<p><strong>正确配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9092</span>
    <span class="hljs-attr">producer:</span>
      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">group-id:</span> <span class="hljs-string">my-group</span>
      <span class="hljs-attr">auto-offset-reset:</span> <span class="hljs-string">earliest</span>
      <span class="hljs-attr">enable-auto-commit:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">123456789101112</span>
</code></pre>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、其他常见启动问题</h3>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. Kafka消费者无法自动提交偏移量</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.apache.kafka.common.errors.SerializationException: <span class="hljs-keyword">Error</span> serializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>未配置<code>enable.auto.commit</code>参数或设置为<code>false</code></li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">enable-auto-commit:</span> <span class="hljs-literal">true</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">1234</span>
</code></pre>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 配置项拼写错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-python" lang="python">Caused by: java.lang.IllegalArgumentException: 
Invalid <span class="hljs-built_in">property</span> <span class="hljs-string">'spring.kafka.producer.key-serializer'</span> <span class="hljs-keyword">for</span> bean of <span class="hljs-built_in">type</span> <span class="hljs-string">'org.springframework.boot.context.properties.bind.BindException'</span>

AI写代码
<span class="hljs-number">12</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>配置项拼写错误，如<code>key-serializer</code>写成了<code>key-serialzer</code></li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查所有配置项的拼写，确保与官方文档一致</li>
</ul>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>总结</h3>
<ol>
<li><strong>确保Kafka服务已启动</strong>：使用<code>bin/kafka-broker-start.sh</code>启动Kafka</li>
<li><strong>检查连接配置</strong>：确认<code>bootstrap-servers</code>配置正确</li>
<li><strong>正确配置序列化</strong>：生产者使用<code>Serializer</code>，消费者使用<code>Deserializer</code></li>
<li><strong>添加必要依赖</strong>：确保包含<code>spring-kafka</code>依赖</li>
<li><strong>处理开发环境问题</strong>：关闭Kafka消费端的自动启动</li>
<li><strong>验证配置格式</strong>：检查YAML缩进和拼写</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[受够了 create-xxx？我写了一个聚合主流框架的脚手架]]></title>    <link>https://juejin.cn/post/7574725286530400307</link>    <guid>https://juejin.cn/post/7574725286530400307</guid>    <pubDate>2025-11-21T06:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530400307" data-draft-id="7574724406306226226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="受够了 create-xxx？我写了一个聚合主流框架的脚手架"/> <meta itemprop="keywords" content="前端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-21T06:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            受够了 create-xxx？我写了一个聚合主流框架的脚手架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:35:30.000Z" title="Fri Nov 21 2025 06:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“不想自己写脚手架的前端不是好前端”，这句话我一直记在心里回响。每次开启一个新项目，我总觉得缺了点什么。在做了大量的调研和思考之后，我决定，是时候动手打造一个属于自己的前端脚手架了。</p>
<p>我个人感觉目前主要面临两个痛点：</p>
<ol>
<li>
<p><strong>市面上的脚手架太多了，记不住！</strong> 说实话，<code>create-react-app</code>、<code>create-vite</code>、<code>create-next-app</code>... 每次用都要先去搜索文档，找到那个准确的命令。我常常想，能不能有一个统一的入口，让我不再为记这些名字而烦恼？</p>
</li>
<li>
<p><strong>脚手架不够灵活，不能自由组合。</strong> 官方的脚手架通常只提供最基础的模板。如果我想加入 <code>React Router</code>、<code>Zustand</code>，或者配置好 <code>ESLint</code> 和 <code>Prettier</code>，就得在项目创建后手动安装、配置一大堆东西。这个过程繁琐、重复，且容易出错。</p>
</li>
</ol>
<p>那么，我能不能写一个<strong>既能汇总主流脚手架，又能让我在创建时就自由组合所需配置</strong>的工具呢？这不仅能解决我的痛点，也是一个绝佳的学习机会。</p>
<p>于是，我开始疯狂撸代码，<code>create-web-app</code> 的雏形就此诞生</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fduchao-duchao%2Fcreate-web-app" target="_blank" title="https://github.com/duchao-duchao/create-web-app" ref="nofollow noopener noreferrer">create-web-app</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee2c052b8be42108d3cf30914f6c1e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311730&amp;x-signature=fgHznrpZrCx4wlZh9rVqfa9zFDU%3D" alt="img_v3_02s8_1765d6d6-082d-4324-9264-032a80a4667g.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c6f582eec84dab85ec4c36e93ba18e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311730&amp;x-signature=ZMcNMgJIqaO4eDQNFbjhMcQfwo0%3D" alt="img_v3_02s8_66e644e0-dd5f-4047-ae24-989237297bbg.jpg" loading="lazy"/></p>
<h3 data-id="heading-0">支持多引擎选择</h3>
<p>为了解决“记不住命令”的问题，我首先做了一个“引擎选择”功能。我汇总了目前社区最主流的十几种脚手架，包括：</p>
<ul>
<li>Vite (React, Vue, Svelte...)</li>
<li>Umi</li>
<li>Create React App</li>
<li>Next.js</li>
<li>Nuxt</li>
<li>Astro</li>
<li>SvelteKit</li>
<li>Angular</li>
<li>Remix</li>
<li>...等等</li>
</ul>
<p>现在，你只需要记住一个命令 <code>pnpm create-web-app</code>，就能启动任何一个主流框架的创建流程。它就像一个超级启动器，将所有官方 CLI 的能力都聚合在了一起</p>
<h3 data-id="heading-1">自由组合配置</h3>
<p>除了代理外部工具，我做了一套create-web-app的自己的创建模版，可以在创建项目时，就完成所有基础配置的自由组合。</p>
<h4 data-id="heading-2"><strong>框架、语言、状态管理、路由、规范... 一步到位！</strong></h4>
<p>在create-web-app模式下，可以通过交互式的问答，一步步进行：</p>
<ol>
<li><strong>选择框架</strong>：React 还是 Vue？</li>
<li><strong>选择语言</strong>：JavaScript 还是 TypeScript？</li>
<li><strong>选择插件</strong>：
<ul>
<li><strong>路由</strong>：需要 <code>React Router</code> 或 <code>Vue Router</code> 吗？</li>
<li><strong>状态管理</strong>：<code>Redux</code>、<code>Zustand</code> 还是 <code>Pinia</code>？</li>
<li><strong>代码规范</strong>：<code>ESLint</code>、<code>Prettier</code>、<code>Husky</code> 要不要安排上？</li>
</ul>
</li>
</ol>
<p>当你确认完所有选项后，一个已经<strong>配置齐全、装好依赖、甚至连入口文件都帮你改好</strong>的项目就诞生了！你不再需要手动 <code>pnpm install</code> 一堆包，再小心翼翼地去 <code>main.js</code> 里 <code>app.use(router)</code>。</p>
<h4 data-id="heading-3"><strong>实现</strong></h4>
<p>这种灵活性背后，是一套精心设计的<strong>声明式插件系统</strong>和<strong>基于 AST 的代码注入</strong>机制。</p>
<ul>
<li>
<p><strong>插件注册中心 (<code>plugin-registry.js</code>)</strong>：我把每一个可选功能（如 Zustand、ESLint）都抽象成一个插件。每个插件清晰地定义了它需要：</p>
<ul>
<li>哪些 <code>npm</code> 依赖 (<code>pkg</code>)</li>
<li>哪些配置文件 (<code>files</code>)</li>
<li>需要对哪个文件的代码做什么修改 (<code>transforms</code>)</li>
</ul>
</li>
<li>
<p><strong>AST 代码变换器 (<code>transforms/</code>)</strong>：当你说需要 <code>React Router</code> 时，脚手架不会用粗暴的字符串替换来修改你的入口文件。它会把 <code>main.jsx</code> 解析成一个抽象语法树（AST），精准地找到 <code>&lt;App /&gt;</code>，然后用 <code>&lt;RouterProvider /&gt;</code> 将其包裹，最后再把 AST 安全地转换回代码</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>总结</strong></h3>
<p>从一个想法，到一个可用的工具，<code>create-web-app</code> 解决了我作为前端开发者最真实的痛点。它通过“双引擎”模式，既拥抱了社区的强大生态，又通过“自研插件”模式提供了极致的灵活性和效率</p>
<p>当然，它目前还只是一个初版，未来还有很多可以做的事情：</p>
<ul>
<li>
<p><strong>支持 CLI 直传参数</strong>：实现 <code>pnpm create-web-app my-app --framework react --plugins router,zustand</code>，跳过交互，一键生成。</p>
</li>
<li>
<p><strong>扩充插件生态</strong>：加入更多测试框架、组件库、国际化等插件。</p>
</li>
<li>
<p><strong>企业级规范注入</strong>：一键集成团队的 CI/CD 配置、Git Hooks 规范等。</p>
</li>
<li>
<p>目前仅仅支持pnpm包管理工具</p>
</li>
<li>
<p>目前仅仅支持vite打包</p>
</li>
<li>
<p>等等</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析]]></title>    <link>https://juejin.cn/post/7574749664491946018</link>    <guid>https://juejin.cn/post/7574749664491946018</guid>    <pubDate>2025-11-21T06:35:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664491946018" data-draft-id="7574869203448184832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-21T06:35:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:35:52.000Z" title="Fri Nov 21 2025 06:35:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>面试官的一个简单问题，却让我陷入了深思。这不仅是前端问题，更是全栈工程师必须掌握的 security 基础。</p>
</blockquote>
<p>“说说看，用户登录后拿到的 Token，你会存在哪里？”</p>
<p>记得我第一次被问到这个问题时，信心满满地回答：“localStorage 呗，简单方便。”然后，空气突然安静了...</p>
<p>有后端小伙伴可能会问，这种前端存储问题后端也需要关心吗？答案是：<strong>绝对需要！</strong> 安全是一个全链路问题，任何一环的疏忽都会导致整个系统的崩溃。</p>
<h2 data-id="heading-0">初探：天真的 localStorage 方案</h2>
<p>很多前端开发者的第一反应都是 localStorage，因为它确实简单直观：</p>
<pre><code class="hljs language-ini" lang="ini">// 登录成功后
localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...')<span class="hljs-comment">;</span>
​
// 请求时自动携带
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
  if (token) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p><strong>优点很明显：</strong></p>
<ul>
<li>
<p>简单直观，上手快速</p>
</li>
<li>
<p>持久化存储，页面刷新不影响用户体验</p>
</li>
<li>
<p>API 友好，操作方便</p>
</li>
</ul>
<p><strong>但致命问题在于：</strong></p>
<ul>
<li>
<p>一旦遭遇 XSS 攻击，攻击者可以直接通过 JavaScript 读取你的 Token</p>
</li>
<li>
<p>相当于把家门钥匙放在门口的垫子下面</p>
</li>
<li>
<p>几乎无法有效防御 XSS 窃取</p>
</li>
</ul>
<h2 data-id="heading-1">深入：真正的解决方案</h2>
<h3 data-id="heading-2">方案一：HttpOnly Cookie - 传统的智慧</h3>
<p>这是最经典的解决方案，通过服务端设置 HttpOnly 标志来保护 Token：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 服务端设置 Cookie（Node.js/Express 示例）</span>
res.<span class="hljs-built_in">cookie</span>(<span class="hljs-string">'token'</span>, <span class="hljs-string">'eyJhbGci...'</span>, {
  httpOnly: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 禁止 JavaScript 访问</span>
  secure: process.env.NODE_ENV === <span class="hljs-string">'production'</span>, <span class="hljs-comment">// 仅 HTTPS</span>
  sameSite: <span class="hljs-string">'strict'</span>,  <span class="hljs-comment">// 防御 CSRF</span>
  maxAge: <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 1天有效期</span>
});
</code></pre>
<p><strong>前端无需特殊处理：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 浏览器会自动在每次请求中携带 Cookie</span>
<span class="hljs-comment">// 前端 JavaScript 无法读取，彻底防御 XSS</span>
</code></pre>
<p><strong>配套的 CSRF 防护方案：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方案1：CSRF Token</span>
<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'meta[name="csrf-token"]'</span>).content;
axios.defaults.headers.common[<span class="hljs-string">'X-CSRF-Token'</span>] = csrfToken;
​
<span class="hljs-comment">// 方案2：双重提交 Cookie 验证</span>
<span class="hljs-comment">// 服务端同时验证 Cookie 和 Header 中的 Token</span>
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>
<p>传统多页面应用</p>
</li>
<li>
<p>SSR 服务端渲染项目</p>
</li>
<li>
<p>对 SPA 单页应用也完全可行</p>
</li>
</ul>
<h3 data-id="heading-3">方案二：内存存储 - 极致的安全追求</h3>
<p>对于安全性要求极高的场景，内存存储是最安全的选择：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">memoryToken</span> = null<span class="hljs-comment">;</span>
​
// 登录后存储
const <span class="hljs-attr">login</span> = async (credentials) =&gt; {
  const <span class="hljs-attr">response</span> = await axios.post(<span class="hljs-string">'/api/login'</span>, credentials)<span class="hljs-comment">;</span>
  <span class="hljs-attr">memoryToken</span> = response.data.token<span class="hljs-comment">;</span>
  return response<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 请求拦截器
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  if (memoryToken) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${memoryToken}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
// 登出或页面关闭时清理
const <span class="hljs-attr">logout</span> = () =&gt; {
  <span class="hljs-attr">memoryToken</span> = null<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>
<p>完全不持久化，免疫 XSS 攻击</p>
</li>
<li>
<p>页面关闭即失效，安全性最高</p>
</li>
<li>
<p>实现简单，无需复杂配置</p>
</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>
<p>页面刷新就需要重新登录，用户体验较差</p>
</li>
<li>
<p>移动端应用切换时可能丢失状态</p>
</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>
<p>银行、金融等高安全要求应用</p>
</li>
<li>
<p>内部管控系统</p>
</li>
<li>
<p>敏感操作的身份验证</p>
</li>
</ul>
<h3 data-id="heading-4">方案三：现代 SPA 的黄金标准 - 双 Token 机制</h3>
<p>这才是现代 Web 应用在安全与体验间的完美平衡：</p>
<p>Token 类型</p>
<p>存储位置</p>
<p>有效期</p>
<p>用途</p>
<p>Access Token</p>
<p>内存</p>
<p>短（15分钟-2小时）</p>
<p>API 调用身份验证</p>
<p>Refresh Token</p>
<p>HttpOnly Cookie</p>
<p>长（7天-30天）</p>
<p>刷新 Access Token</p>
<p><strong>实现方案：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 登录处理
const <span class="hljs-attr">handleLogin</span> = async (credentials) =&gt; {
  const <span class="hljs-attr">response</span> = await axios.post(<span class="hljs-string">'/api/login'</span>, credentials)<span class="hljs-comment">;</span>
  const { accessToken } = response.data<span class="hljs-comment">;</span>
  
  // Access Token 存内存
  setAccessToken(accessToken)<span class="hljs-comment">;</span>
  // Refresh Token 由服务端设置为 HttpOnly Cookie
  
  return response<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 请求拦截器 - 自动携带 Access Token
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = getAccessToken()<span class="hljs-comment">;</span>
  if (token) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
// 响应拦截器 - 自动刷新 Token
axios.interceptors.response.use(
  <span class="hljs-attr">response</span> =&gt; response,
  async <span class="hljs-attr">error</span> =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // Access Token 过期，尝试刷新
      try {
        const <span class="hljs-attr">newToken</span> = await refreshToken()<span class="hljs-comment">;</span>
        setAccessToken(newToken)<span class="hljs-comment">;</span>
        // 重试原始请求
        <span class="hljs-attr">error.config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${newToken}</span>`<span class="hljs-comment">;</span>
        return axios.request(error.config)<span class="hljs-comment">;</span>
      } catch (refreshError) {
        // 刷新失败，跳转登录页
        logout()<span class="hljs-comment">;</span>
        <span class="hljs-attr">window.location.href</span> = <span class="hljs-string">'/login'</span><span class="hljs-comment">;</span>
      }
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>刷新 Token 的服务端实现：</strong></p>
<pre><code class="hljs language-ini" lang="ini">app.post('/api/refresh', async (req, res) =&gt; {
  const <span class="hljs-attr">refreshToken</span> = req.cookies.refreshToken<span class="hljs-comment">;</span>
  
  if (!refreshToken) {
    return res.status(401).json({ message: 'Refresh token required' })<span class="hljs-comment">;</span>
  }
  
  try {
    const <span class="hljs-attr">decoded</span> = verifyRefreshToken(refreshToken)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newAccessToken</span> = generateAccessToken({ userId: decoded.userId })<span class="hljs-comment">;</span>
    
    res.json({ accessToken: newAccessToken })<span class="hljs-comment">;</span>
  } catch (error) {
    res.clearCookie('refreshToken')<span class="hljs-comment">;</span>
    res.status(401).json({ message: 'Invalid refresh token' })<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-5">全方位方案对比</h2>
<p>存储方案</p>
<p>安全性</p>
<p>用户体验</p>
<p>实现复杂度</p>
<p>适用场景</p>
<p>localStorage</p>
<p>❌ 低</p>
<p>✅ 好</p>
<p>✅ 简单</p>
<p>内部工具、演示项目</p>
<p>HttpOnly Cookie</p>
<p>✅ 高</p>
<p>✅ 好</p>
<p>✅ 中等</p>
<p>传统 Web 应用、SSR</p>
<p>内存存储</p>
<p>✅ 极高</p>
<p>❌ 差</p>
<p>✅ 简单</p>
<p>高安全要求系统</p>
<p>双 Token 机制</p>
<p>✅ 很高</p>
<p>✅ 好</p>
<p>❌ 复杂</p>
<p>现代 SPA 应用</p>
<h2 data-id="heading-6">面试官的真正期待</h2>
<p><strong>初级回答：</strong></p>
<blockquote>
<p>"localStorage，因为简单方便。"</p>
</blockquote>
<p><strong>中级回答：</strong></p>
<blockquote>
<p>"用 HttpOnly Cookie，因为能防 XSS，但要配合 CSRF 防护。"</p>
</blockquote>
<p><strong>高级回答：</strong></p>
<blockquote>
<p>"要看具体场景。如果是内部低风险系统，localStorage 的简洁性也有价值。如果是传统 Web 应用，HttpOnly Cookie + CSRF Token 是久经考验的方案。如果是现代 SPA，我推荐 Access Token + Refresh Token 的组合，在安全和体验间取得最佳平衡。同时要考虑业务的安全要求、用户的使用习惯和技术团队的维护能力。"</p>
</blockquote>
<p>这才是面试官想听到的：</p>
<ul>
<li>
<p>理解不同方案的权衡取舍</p>
</li>
<li>
<p>能够根据业务场景做出合理选择</p>
</li>
<li>
<p>清楚每种方案的安全边界和风险点</p>
</li>
<li>
<p>具备全链路的安全思维</p>
</li>
</ul>
<h2 data-id="heading-7">安全的核心是平衡，不是绝对</h2>
<p>回头看我当初那个 naive 的 "localStorage" 回答，问题不在于技术本身，而在于思考方式。</p>
<p><strong>真正的安全专家不是追求绝对安全，而是懂得：</strong></p>
<ul>
<li>
<p>在什么业务场景下选择什么技术方案</p>
</li>
<li>
<p>每种方案的风险边界和应对措施</p>
</li>
<li>
<p>如何用合适的成本解决合适的风险</p>
</li>
<li>
<p>如何在安全、体验、开发效率间找到平衡点</p>
</li>
</ul>
<p>现在当面试官再问我 "Token 该存哪里" 时，我会先反问：</p>
<blockquote>
<p>"咱们的业务场景是什么？安全要求等级多高？目标用户的使用习惯怎样？技术团队的维护能力如何？"</p>
</blockquote>
<p>因为，<strong>没有最好的方案，只有最合适的方案</strong>。安全之路，需要的是持续学习和深度思考。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[黄仁勋马斯克罕见同台！定调AI未来三大关键词：算力、货币失效与泡沫]]></title>    <link>https://juejin.cn/post/7574749664492011554</link>    <guid>https://juejin.cn/post/7574749664492011554</guid>    <pubDate>2025-11-21T06:46:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664492011554" data-draft-id="7574728397374898228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="黄仁勋马斯克罕见同台！定调AI未来三大关键词：算力、货币失效与泡沫"/> <meta itemprop="keywords" content="人工智能,资讯,NVIDIA"/> <meta itemprop="datePublished" content="2025-11-21T06:46:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            黄仁勋马斯克罕见同台！定调AI未来三大关键词：算力、货币失效与泡沫
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:46:04.000Z" title="Fri Nov 21 2025 06:46:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>未来金钱将失去意义？AI是否有泡沫？最近，黄仁勋对话马斯克，给出了他们的想法。</p>
</blockquote>
<p>在近日的美沙投资论坛上，特斯拉CEO埃隆·马斯克在与英伟达CEO黄仁勋同台交流，就AI、机器人和未来经济进行了对话。</p>
<p>期间，马斯克抛出惊人观点：随着生成式AI的持续演进，金钱在未来将逐渐失去意义。<br/>
这一论断甚至让见惯大场面的黄仁勋一时语塞，只能用幽默缓解：“钱真没用的时候，记得提前通知我。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/286695c8fa9e4fc29564b85ed433c066~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764312364&amp;x-signature=jZkdg1rZZWvyKEpbgsIwFvhnnUs%3D" alt="图片" loading="lazy"/>
【图片来源：搜狐知世】</p>
<p><strong>货币消亡论背后的AI逻辑</strong></p>
<p>马斯克的预言并非空穴来风。他解释了自己的思考逻辑：如果AI和机器人技术持续进步，商品和服务的生产成本将大幅降低，最终趋近于零。在这种情况下，获取物质财富将变得异常容易，货币作为价值尺度和交换媒介的功能自然减弱。</p>
<p>他进一步阐述，人形机器人将成为人类历史上最大的产业，甚至会超过手机或任何其他产品。当机器人能够承担大部分生产和服务工作，人类的基本需求将很容易得到满足，经济活动的本质将发生根本性改变。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d5379d78b414507a7afd3a3fbf181d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764312364&amp;x-signature=PZAm8pmbdKUNuobvvQ2ajmZDU1Q%3D" alt="图片" loading="lazy"/>
【图片来源：搜狐知世】</p>
<p>在马斯克看来，只有通过大规模应用AI和机器人（例如他寄予厚望的Tesla Optimus人形机器人），才能真正消除贫困，实现人人富足。届时，人类从繁重劳动中解放出来，工作将像种花弄草般的怡然自得。</p>
<p>面对马斯克的远景预言，黄仁勋则认为，短期内AI不会让人们变得更空闲，反而会使大家更忙。</p>
<p>黄仁勋用放射科医生的例子来说明这一现象。以前很多人预测放射科医生是第一批会被AI取代的职业，但真实情况正好相反：现在全球放射科医生的需求反而增加了。因为AI把图像分析做得更快、更准，医生就可以看更多图像、更多种类的影像，有更多时间和病人沟通，结果服务了更多患者。</p>
<p>换言之，生产力提升没有导致需求减少，反而激发了新的需求。</p>
<p><strong>对AI泡沫论的回应</strong></p>
<p>在被问及美国是否正陷入“AI泡沫”时，黄仁勋并未直接给出肯定或否定的答案，而是从技术趋势的角度进行了剖析。</p>
<p>他指出要理解当前人工智能热潮的实质，我们需要回归第一性原理，洞察计算产业正在经历的根本性变革。这一变革主要由三大核心要素共同推动：</p>
<p>首先，数据洪流的计算范式转型。全球每年用于处理原始数据的计算支出高达数千亿美元，其中大量计算任务仍与传统架构相关。面对日益庞大的数据规模，传统CPU架构已难以满足高效处理需求，这促使整个行业向并行加速计算范式迁移，为人工智能的蓬勃发展奠定了坚实基础。</p>
<p>其次，生成式AI重构互联网服务模式。过去十五年，互联网服务主要建立在推荐算法基础之上。而如今，生成式AI正在系统性地重塑这一格局——从智能对话、内容创作到新一代搜索引擎，这些基于生成式计算的任务对GPU算力提出了远超以往的需求。为此，互联网企业正在大规模投入建设专门面向数据处理和生成式AI的GPU计算集群。</p>
<p>第三，自主智能体开启新阶段。随着马斯克的Grok、OpenAI的高级模型、谷歌Gemini等兼具主动决策能力的智能体相继涌现，人工智能发展进入了新阶段。这些智能体不仅建立在现有技术基础之上，更通过叠加自主决策能力，进一步扩大了算力需求。这种演进本质上是从CPU到GPU的算力范式转换的延续与深化，代表着技术发展的必然趋势。</p>
<p>这三大要素相互关联、层层递进，共同构成了驱动人工智能产业发展的核心动力，也为我们理解当前技术变革提供了清晰的框架。</p>
<p>基于此，当前市场对AI算力的巨大需求并没有想象中那么夸张，而且这一切都是有充分理由的。也就是说，AI的需求是真实且可持续的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ccbbe2c15a14ffa961cb1087ccf3d61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764312364&amp;x-signature=RjAFGkypbe0zON6%2FnGjhfOMR4S0%3D" alt="图片" loading="lazy"/>
【图片来源：搜狐知世】</p>
<p>值得一提的是，就在当天，英伟达发布了最新财报：季度收入达到570亿美元，同比增长62%，并预计下一季度将升至650亿美元。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d831d6d5f74a1191afdcd6395ff3ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764312364&amp;x-signature=LuLRDweXdo0c9yI0sRnI20RwVs8%3D" alt="图片" loading="lazy"/>
【图片来源：英伟达官方博客】</p>
<p>黄仁勋在财报沟通会上明确表示，他没有看到AI泡沫。他认为各行业对算力和训练需求仍在快速扩大，与AI泡沫说法并不一致。</p>
<p>不过市场反应却呈现分化态势。英伟达财报发布后，股价盘初大幅高开一度涨逾5%，但最终高开低走跌超3%。这种走势反映了投资者对AI高估值的复杂心态。</p>
<p><strong>算力产业的基础设施化趋势</strong></p>
<p>无论是马斯克的长期愿景还是黄仁勋的短期判断，都指向同一个方向：算力需求将持续增长。论坛上传出的一个重磅消息佐证了这一趋势——xAI将联手英伟达、沙特国家AI公司Humain，在沙漠中建设一座500兆瓦级的AI数据中心。</p>
<p>黄仁勋将这种AI数据中心称为“AI工厂”，并将其比作新时代的基础设施。他从技术范式演变的角度解释了这一现象：过去的计算是“检索式的”，系统从事先写好的内容中调取信息；现在的软件是“生成式的”，根据实时输入指令生成全新内容。这种根本改变要求必须在全球各地部署AI工厂，实时生成内容。</p>
<p>在这个AI技术快速演进的时代，可以确定的是，算力作为数字经济新基建的地位将愈发稳固。</p>
<p>大家怎么看？欢迎讨论交流~</p>
<p>写在最后：如果您正在进行AI领域的创业或研究，却受困于高昂的算力成本或高并发下的推理稳定性等问题，欢迎留言或私信我们，找到您的降本增效突破口~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决AI任务排队难题：基于Slurm的优先级调度与资源抢占策略配置详解]]></title>    <link>https://juejin.cn/post/7574749664492044322</link>    <guid>https://juejin.cn/post/7574749664492044322</guid>    <pubDate>2025-11-21T06:49:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664492044322" data-draft-id="7574728397374914612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决AI任务排队难题：基于Slurm的优先级调度与资源抢占策略配置详解"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-11-21T06:49:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决AI任务排队难题：基于Slurm的优先级调度与资源抢占策略配置详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:49:10.000Z" title="Fri Nov 21 2025 06:49:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">摘要</h3>
<p>在高负荷的AI算力平台中，任务排队是影响研发效率的核心瓶颈。本文将深入介绍基于Slurm作业调度系统的优先级调度机制与资源抢占策略，通过实际配置案例展示如何优化计算资源分配，显著减少任务空闲等待时间。</p>
<h3 data-id="heading-1">1 Slurm调度系统核心机制</h3>
<p>Slurm是一个开源的、高度可扩展的集群管理和作业调度系统，专为大规模计算环境设计。它通过多种策略实现资源的高效利用，主要包括资源分派、作业调度、优先权控制、监控工具、定制化支持和系统最佳化等功能。</p>
<p>在<strong>算家云</strong>等AI算力平台中，Slurm通过三种任务提交方式满足不同场景需求：交互式适用于任务测试，可实时查看程序输出；批处理式适用于正式计算，计算稳定且与终端连接状态无关；抢占式适用于不想重复提交任务的测试场景。</p>
<h3 data-id="heading-2">2 优先级调度策略详解</h3>
<h4 data-id="heading-3">2.1 先进先出(FIFO)队列</h4>
<p>默认情况下，Slurm采用先进先出(FIFO)为基础分配作业优先权。在FIFO队列中，任务的排序依据是它们提交的时间顺序。配置FIFO队列需要在slurm.conf文件中进行以下设置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到并编辑slurm.conf档案</span>
sudo nano /etc/slurm-llnl/slurm.conf

<span class="hljs-comment"># 启用抢占模式，并指定基于先进先出优先权的抢占策略</span>
PriorityType=priority/basic
</code></pre>
<p><strong>重要提示</strong>：变更前请备份原始slurm.conf档案，生产环境中的任何重大改动建议先在测试环境中全面测试。</p>
<h4 data-id="heading-4">2.2 多因素作业队列</h4>
<p>多因素队列是更先进的任务排队机制，预设备用，它根据多个因素综合计算作业的优先权。Slurm多因素调度通过加权计算以下因子确定任务优先权：</p>
<ul>
<li><strong>作业等待时间</strong>：作业等待时间越长，权责越高（<code>PriorityWeightAge × age_factor</code>）</li>
<li><strong>关联权责</strong>：使用者组/账户的资源使用公平性（<code>PriorityWeightAssoc × assoc_factor</code>）</li>
<li><strong>公平共用权责</strong>：按资源使用比例调整分值（<code>PriorityWeightFairshare × fair-share_factor</code>）</li>
<li><strong>作业大小权责</strong>：小/大作业优先（<code>PriorityWeightJobSize × job_size_factor</code>）</li>
<li><strong>分区权责</strong>：分区优先权（<code>PriorityWeightPartition × priority_job_factor</code>）</li>
<li><strong>QoS权责</strong>：服务品质等级（<code>PriorityWeightQOS × QOS_factor</code>）</li>
<li><strong>资源权责</strong>：资源类型（CPU/GPU等）权责加权</li>
</ul>
<p>优先权计算公式如下：</p>
<pre><code class="hljs language-scss" lang="scss">Job_priority =
    site_factor +
    (PriorityWeightAge) * (age_factor) +
    (PriorityWeightAssoc) * (assoc_factor) +
    (PriorityWeightFairshare) * (fair-share_factor) +
    (PriorityWeightJobSize) * (job_size_factor) +
    (PriorityWeightPartition) * (priority_job_factor) +
    (PriorityWeightQOS) * (QOS_factor) +
    <span class="hljs-built_in">SUM</span>(TRES_weight_cpu * TRES_factor_cpu,
        TRES_weight_&lt;type&gt; * TRES_factor_&lt;type&gt;,
        ...)
    - nice_factor
</code></pre>
<h4 data-id="heading-5">2.3 多因素队列典型应用</h4>
<ol>
<li>
<p><strong>快速完成小作业</strong>：设定<code>PriorityWeightJobSize=-1</code>，大作业的优先权降低，小作业更快被调度</p>
</li>
<li>
<p><strong>保障关键使用者/组</strong>：通过<code>PriorityWeightAssoc</code>和<code>Fair-share_factor</code>确保重要团队的作业优先运行</p>
</li>
<li>
<p><strong>资源饥饿保护</strong>：配置<code>PriorityWeightFairshare=2000</code>，低资源使用量的使用者作业优先权显著提升</p>
</li>
</ol>
<h3 data-id="heading-6">3 资源抢占策略配置</h3>
<h4 data-id="heading-7">3.1 抢占机制概述</h4>
<p>Slurm支援任务抢占功能，高优先权任务可抢占低优先权任务资源。被抢占任务可以取消、重设或挂起。如果启用回填调度（预设），系统会按bf_interval周期计算低优任务能否在不延迟高优任务前提下运行。</p>
<h4 data-id="heading-8">3.2 分区优先权抢占配置</h4>
<p>建立高优先权分区是实现资源抢占的有效方法。以下是详细配置步骤：</p>
<p>首先在集群中开启抢占功能开关，并指定基于分区优先权的抢占策略：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑slurm.conf档案</span>
sudo nano /etc/slurm-llnl/slurm.conf

<span class="hljs-comment"># 启用抢占模式，并指定基于分区优先权的抢占策略</span>
PreemptMode=preempt/partition_prio

<span class="hljs-comment"># 当作业被抢占时的行为</span>
PreemptType=<span class="hljs-built_in">suspend</span>  <span class="hljs-comment"># 或者 "cancel"</span>
</code></pre>
<p>关键参数说明：</p>
<ul>
<li><code>SelectType</code>: 推荐<code>select/cons_tres</code>，定义资源分派策略</li>
<li><code>SelectTypeParameters</code>: 推荐<code>CR_Core</code>，控制资源分派细节</li>
<li><code>SchedulerType</code>: 推荐<code>sched/backfill</code>，指定调度演算法类型</li>
<li><code>PriorityType</code>: 推荐<code>priority/multifactor</code>，定义任务优先权计算规则</li>
</ul>
<p>接着，在集群中添加一个高优先权分区：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在slurm集群中添加一个高优先权分区</span>
scontrol create partition=hipri PriorityTier=2 nodes=ALL

<span class="hljs-comment"># 查看当前的集群分区</span>
scontrol show partitions
</code></pre>
<h4 data-id="heading-9">3.3 抢占策略实践</h4>
<p>配置完成后，可以通过向hipri分区提交任务或者将任务更改到高优分区的方式来实现任务抢占：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提交高优先权任务</span>
sbatch -p hipri job_script.slurm

<span class="hljs-comment"># 将运行中任务改为高优先权</span>
scontrol update jobid=&lt;job_id&gt; partition=hipri
</code></pre>
<h3 data-id="heading-10">4 最佳实践与注意事项</h3>
<p>####4.1 调度策略选择</p>
<p>根据实际工作负载特点，可以选择不同的调度策略：</p>
<ol>
<li>
<p><strong>FIFO策略</strong>：如果队列中的第一个任务无法出队，系统将反复尝试对第一个任务进行出队操作，而不会跳过</p>
</li>
<li>
<p><strong>遍历策略</strong>：如果队列中的第一个任务无法出队，则会跳过该任务，然后依次尝试对后续队列中的任务进行出队操作</p>
</li>
<li>
<p><strong>均衡策略</strong>：结合FIFO和遍历策略的优点，在第一个任务等待出队时间超过预定时间后，尝试对后续任务进行出队操作</p>
</li>
</ol>
<h4 data-id="heading-11">4.2 资源分配优化</h4>
<ul>
<li>
<p><strong>内存管理</strong>：计算节点每个核心默认可用8G内存，计算任务如需要更大的内存空间，需通过<code>--mem-per-cpu</code>选项申请内存</p>
</li>
<li>
<p><strong>多线程任务</strong>：使用<code>-c</code>参数设置单个任务可使用的核心数</p>
</li>
<li>
<p><strong>多进程任务</strong>：使用<code>-n</code>参数启动多个进程运行计算任务</p>
</li>
<li>
<p><strong>混合任务</strong>：结合<code>-n</code>和<code>-c</code>参数实现多进程+多线程任务提交</p>
</li>
</ul>
<h4 data-id="heading-12">4.3 故障诊断与排查</h4>
<p>类似于百度百舸AI计算平台提供的智能诊断功能，管理员可以通过以下方式诊断任务排队问题：</p>
<ul>
<li>检查队列配额设置</li>
<li>验证节点可用性</li>
<li>监控资源余量（GPU、内存、存储等）</li>
<li>分析网络配置（EHC、RDMA网卡等）</li>
</ul>
<h3 data-id="heading-13">5 结论</h3>
<p>通过合理配置Slurm的优先权调度与资源抢占策略，AI算力平台可以显著提升资源利用效率，减少任务空闲等待时间。算家云平台的实践表明，结合多目标优化算法和容器化技术，能够实现对AI算力资源的弹性调度管理，满足从初学者到专业开发者的多样化需求。</p>
<p>随着AI算力需求的不断增长，先进的调度策略将成为算力平台的核心竞争力。通过本文介绍的Slurm高级调度技巧，平台管理员可以最大化利用计算资源，为用户提供更高效、更稳定的算力服务。</p>
<p><strong>欢迎在评论区分享您在AI任务调度方面的经验和问题！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯音乐如何基于 AutoMQ 降低 Kafka 50%+ 成本]]></title>    <link>https://juejin.cn/post/7574745301725020166</link>    <guid>https://juejin.cn/post/7574745301725020166</guid>    <pubDate>2025-11-21T06:57:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725020166" data-draft-id="7574821757665411113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯音乐如何基于 AutoMQ 降低 Kafka 50%+ 成本"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-21T06:57:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AutoMQ"/> <meta itemprop="url" content="https://juejin.cn/user/2878958479084707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯音乐如何基于 AutoMQ 降低 Kafka 50%+ 成本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2878958479084707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AutoMQ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:57:10.000Z" title="Fri Nov 21 2025 06:57:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>编辑导读：腾讯音乐娱乐集团作为中国在线音乐娱乐服务的领航者，旗下拥有 QQ 音乐、酷狗音乐、酷我音乐和全民 K 歌等众多国民级移动音频应用。每天，这些产品都会产生海量的用户行为和业务数据，为精准推荐、用户增长和商业化等核心业务提供着源源不断的数据驱动力。在这一切背后，一个强大、稳定且高效的 Kafka 流系统是支撑其业务持续创新和发展的关键。
然而，随着业务的飞速发展，传统的自建 Kafka 集群在运维复杂度和成本控制方面逐渐暴露出其局限性。为了应对日益增长的数据洪流和对成本效益的极致追求，腾讯音乐运维团队毅然开启了对下一代 Kafka 解决方案的探索与实践。</p>
<p>最终，他们选择了基于云原生架构的 AutoMQ。通过引入这一创新的解决方案，腾讯音乐不仅成功<strong>将成本降低了超过 50%</strong>，更通过其独特的<strong>分区秒级迁移</strong>能力，极大地提升了集群的扩缩容效率，显著降低了原有 Kafka 的运维复杂度和负担。本次技术升级，是继其在数据仓库领域成功实践存算分离之后，在数据流处理领域的又一次重大突破。</p>
<p>本文将深入解读腾讯音乐娱乐集团是如何利用 AutoMQ 的云原生优势，破解传统 Kafka 的运维难题和成本瓶颈，并最终实现成本与效率双赢的。希望他们在此过程中积累的宝贵经验与最佳实践，能为正在面临相似挑战的您提供有价值的参考和指导！</p>
</blockquote>
<blockquote>
<p>作者: 腾讯音乐 高级运维开发工程师 高盛远</p>
</blockquote>
<h2 data-id="heading-0">背景介绍</h2>
<p>腾讯音乐娱乐集团是中国在线音乐娱乐服务开拓者，提供在线音乐和以音乐为核心的社交娱乐两大服务。腾讯音乐娱乐在中国有着广泛的用户基础，拥有目前国内市场知名的移动音频产品：QQ 音乐、酷狗音乐、酷我音乐、全民 K 歌、懒人听书等产品。</p>
<h2 data-id="heading-1">技术架构</h2>
<p>对于腾讯音乐这样拥有海量用户的平台而言，高效的数据流动、处理与分析是发挥数据价值、支持业务飞速发展的基石。在整个数据体系中，Kafka 作为核心的数据基础设施，扮演着至关重要的角色。它不仅是连接数据生产和消费的管道，更在可观测体系、数据平台等建设中承担着<strong>上下游解耦以及配合其他组件简化流程</strong>的关键作用。Kafka 的引入，使得数据源和数据应用可以独立地演进，无需关心对方的实现细节。同时，它<strong>支持业务方按需实时消费数据，灵活处理各类旁路处理逻辑</strong>，这对于支撑腾讯音乐多元化的业务场景和高速发展至关重要。</p>
<p>下图清晰地展示了腾讯音乐基于 AutoMQ 构建的现代化实时数据流处理架构。整个数据流从数据源采集开始，经过数据接入、Kafka 流系统、实时计算、数据存储，最终服务于上层的各类数据应用，具体流程如下：</p>
<ul>
<li><strong>数据源 （Data Source）</strong>：数据源主要分为两大类。第一类是<strong>可观测性数据</strong>，包括服务运行产生的海量日志、关键指标（Metrics）和 Trace 信息；第二类是<strong>分析数据</strong>，涵盖了歌曲、艺术家、版权等业务元数据，以及用户的播放、评论等行为数据。</li>
<li><strong>数据接入 （Data Ingestion）</strong>：为了实现海量数据源数据的统一、高效接入，腾讯音乐内部的“数据通道”平台，作为所有业务方数据接入的统一入口。该平台底层封装了业务埋点、Kafka Producers 等多种上报方式。其核心价值在于，在数据进入 AutoMQ 之前，平台会进行一系列的预处理，包括地域与业务区分、字段过滤、安全鉴权和智能分发。这一流程不仅确保了只有合规、准确的数据才能进入核心系统，也极大地提升了数据接入的效率和治理水平。不同类型的数据通过相应的组件进行采集和上报。例如，应用程序内部通过集成的 SDK 进行埋点追踪，业务服务通过标准的 Kafka 生产者（Kafka Producers）上报数据，而部署在虚拟机上的 Agents 则负责采集各类系统的日志和指标。</li>
<li><strong>流系统 （Kafka）</strong>：所有接入的数据统一汇入作为核心数据总线的 <strong>AutoMQ</strong> 集群。在这里，AutoMQ 承接了来自不同业务线的数据洪峰，为下游的实时计算和数据存储提供高吞吐、低延迟的可靠数据流服务。通过部署多个 AutoMQ 集群（如图中的 Cluster A， B， C），可以实现业务隔离和精细化管理。</li>
<li><strong>实时计算 （Computation）</strong>：在数据写入最终存储之前，通常会经过一个可选的实时计算层。腾讯音乐使用 <strong>Flink</strong> 作为主流的计算引擎，对 Kafka 中的原始数据流进行实时的聚合、过滤和复杂计算。这一步是实现实时监控报警、数据清洗和预处理的关键。例如，Flink 作业会消费 AutoMQ 集群 A 的数据，经过处理后再写回，供其他服务使用。</li>
<li><strong>数据存储 （Storage）</strong>：经过实时计算处理后，数据被写入不同的存储系统以满足不同的查询需求。一部分数据会流入 <strong>OLAP 数据库</strong>，用于后续的交互式分析和 BI 报表；另一部分数据，尤其是日志和追踪数据，则会被写入 <strong>Elasticsearch</strong>，以支持快速的搜索和问题定位。</li>
<li><strong>数据应用 （Data Application）</strong>：在架构的最上层，是直接面向业务和技术团队的各类数据应用。这些应用大致可分为两类：</li>
<li><strong>可观测性应用</strong>：基于实时数据流，构建强大的实时监控与告警、智能故障诊断、事件和性能分析，保障业务的稳定运行。</li>
<li><strong>数据分析应用</strong>：利用处理后的数据，驱动上层业务决策，包括个性化推荐、用户洞察、商业智能（BI）分析和数据科学建模等，实现数据驱动的精细化运营。</li>
</ul>
<p><img src="https://automq66.feishu.cn/space/api/box/stream/download/asynccode/?code=NzdmZTFkYTEwNDAxYjRhNDZhZjEwZDNmYjg0NzdhN2VfOHNuUDI3ekdmbXhRY0F4YzVNcVNpVjJhVEhQSWp5T09fVG9rZW46R1o0eWJRVWdhb1ROSmh4OWtWcGM5Yk01bkVnXzE3NjM3MDc2NDE6MTc2MzcxMTI0MV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Kafka 挑战</h2>
<p>随着腾讯音乐旗下 QQ 音乐、酷狗音乐等多款应用的高速发展，数据规模呈指数级增长，作为数据流中枢的 Kafka 集群也面临着日益严峻的挑战。这些挑战主要集中在成本和运维两个方面。</p>
<p><img src="https://automq66.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTJiMzU0N2MzOTkwMmYxNzdkYWNjMDk1YmY2MmNmM2ZfcVRIc1A5Mkx0cEZzR21kMm5PYUozVXhxTGdLZHppc1pfVG9rZW46TGZhZWJEWlRNb1ZjU0d4a2JxQWNzdm9ibjJmXzE3NjM3MDc2NDE6MTc2MzcxMTI0MV9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">日益严峻的成本压力</h3>
<p>在腾讯音乐的业务体量下，Kafka 的成本问题变得尤为突出，主要体现在以下几个方面：</p>
<ul>
<li><strong>资源预留成本高昂</strong>：由于 Kafka 存算一体的架构限制，集群的计算和存储资源必须同步扩展。为了从容应对业务流量的波峰，生产环境的资源预留水位通常需要保持在 <strong>30%～40% 甚至更高</strong>。这意味着有大量的服务器资源在大部分时间处于闲置状态，造成了巨大的浪费。</li>
<li><strong>存储成本居高不下</strong>：为了保证数据的 TTL 时长和高并发下的读写性能，Kafka 的 Broker 节点通常需要配置多块大容量的高性能本地磁盘。昂贵的存储介质和大量的资源预留，共同推高了 Kafka 集群的总体拥有成本（TCO）。</li>
<li><strong>多副本机制带来额外开销</strong>：Kafka 内置的多副本机制虽然保障了数据的高可靠，但在进行分区数据同步时，会对 Broker 节点的 CPU 产生额外的开销。这不仅增加了资源消耗，也对机型的规格提出了更高的要求，间接导致了硬件成本的上升。</li>
</ul>
<h3 data-id="heading-4">运维成本高</h3>
<p>在传统 Kafka 架构下，运维团队面临着巨大挑战，尤其是在集群的弹性伸缩和日常维护方面。</p>
<ul>
<li><strong>扩缩容操作“伤筋动骨”</strong>：随着业务发展，集群扩缩容是家常便饭。然而，Kafka 的扩缩容流程却较为繁琐和漫长。业务方首先需要提交扩容申请并等待审核，业务运维团队会等到业务低峰期才执行操作，以避免影响线上服务。扩缩容过程中最耗时的是 Kafka 的分区数据搬迁，它会产生较大的网络和磁盘 I/O，同时耗费大量时间。并且团队成员还需要投入大量精力，去验证流量是否被正确、均衡地引导至新的 Broker 节点。整个扩缩容流程走完，通常需要 <strong>1 天左右</strong>的时间，并且依赖人工介入，整个过程是耗时且有风险的。</li>
<li><strong>数据热点处理棘手</strong>：除了计划内的扩容，当突发的数据热点出现时，运维团队也需要人工介入，通过调整生产端的写入策略来打散流量，以避免单个 Broker 或分区过载。这种手动干预的方式不仅响应不及时，而且操作复杂，给系统的稳定性带来了潜在风险。</li>
</ul>
<p>这些长期存在的成本与运维难题，给负责 Kafka 运维的团队带来了沉重的负担，也成为了制约数据基础设施进一步发展的瓶颈。因此，寻找一个更具弹性、更低成本、运维更友好的下一代 Kafka 解决方案，被提上了议程。</p>
<h2 data-id="heading-5">为什么选择 AutoMQ</h2>
<p>在评估下一代 Kafka 解决方案时，我们团队有几个非常明确的目标。经过深入的技术调研和对比，我们认为 AutoMQ 是最能满足我们当前和未来需求的方案。</p>
<ul>
<li><strong>解决运维瓶颈，实现快速弹性</strong>：我们面临最大的痛点是传统 Kafka 扩缩容的低效和高风险。AutoMQ 存算分离的架构，将 Broker 变成了无状态节点，数据则存放在对象存储上。这对我们来说，最直接的好处就是分区迁移可以按秒级完成，集群扩容不再需要漫长的数据搬迁，整个过程可以自动化，从过去耗时一两天的人工操作，缩短到了几分钟，极大地提升了我们的运维效率。</li>
<li><strong>在保证性能稳定的前提下，实现架构性降本</strong>：成本是另一个核心考量。AutoMQ 的架构让我们能够独立扩展计算和存储资源，这意味着我们不再需要为应对流量峰值而预留大量昂贵的计算实例。同时，将数据从本地磁盘转移到成本低得多的对象存储，直接降低了存储开销。这种架构上的改变，是从根本上解决了成本问题，而不是小修小补。</li>
<li><strong>真正适配云原生（Kubernetes Native）</strong>：我们的基础设施正在全面拥抱 Kubernetes。传统 Kafka 的有状态特性，使其难以充分利用 Kubernetes 在资源调度和故障恢复上的优势。AutoMQ 的无状态 Broker 则能与 Kubernetes 完美协同，像普通应用一样被自由调度，这为我们未来将整个 Kafka 服务迁移至 K8s 铺平了道路，有助于最大化资源利用率。</li>
<li><strong>原生支持 Iceberg，简化数据入湖</strong>：我们未来的数据平台规划之一是构建基于 Apache Iceberg 的流式数据湖。AutoMQ 在这方面的前瞻性设计是一个重要加分项。它提供的 <strong>Table Topic</strong> 功能可以直接将 Topic 数据流式写入为 Iceberg 表格式，并存入对象存储。这意味着我们未来可以省去一个独立的 Flink 或 Spark 作业来进行数据转换和入湖，从而显著简化数据栈的架构和维护成本。</li>
<li><strong>平滑无感的迁移路径</strong>：替换核心基础设施，最大的风险在于迁移过程。AutoMQ 提供了 100% 的 Kafka 协议兼容性，这一点至关重要。这意味着我们现有的所有生产者、消费者程序代码都无需任何改动。同时，我们已经构建多年的监控、运维和安全等配套设施也能无缝集成。这为我们提供了一个低风险、低成本的迁移方案，是项目能够成功落地的基本保障。</li>
</ul>
<p><img src="https://automq66.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2E4M2VhMDdhOGZmOGU0M2M5MjBiMTdlY2ViNjhjMzlfMjcwQmtjUmVyWEl4RjZPSXBLNWV6VmtlOGNyQkFVN2pfVG9rZW46Q2hOQ2JUd2xNb0xmV2V4bXpscWM5UmpTblJnXzE3NjM3MDc2NDE6MTc2MzcxMTI0MV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">评估和迁移过程</h2>
<p>对于一项如此核心的基础设施升级，一个严谨且分阶段的评估与迁移计划是必不可少的。我们的目标是确保 AutoMQ 在真实的生产负载下，其稳定性、性能和兼容性都达到甚至超过我们的预期。整个过程可以分为两个阶段：<strong>负载验证</strong>和<strong>生产迁移</strong>。</p>
<h3 data-id="heading-7">负载验证阶段</h3>
<p>我们设计了两种典型的业务场景来对 AutoMQ 进行压力测试，以覆盖我们主要的负载模型：</p>
<ul>
<li><strong>2025 年 6 月 - 大流量场景验证</strong>：我们首先上线了一个承载高数据吞吐量、但 QPS（每秒请求数）相对不高的集群。这个测试的目的是验证 AutoMQ 在处理海量数据持续写入和读取场景下的性能和稳定性，特别是在网络 I/O 和对象存储交互方面的表现。</li>
<li><strong>2025 年 7 月 - 高 QPS 场景验证</strong>：随后，我们部署了第二个集群，用于承载一个高 QPS、但单条消息流量较小的业务。这个场景重点考验的是 AutoMQ 在处理高频元数据请求、客户端连接管理以及小 I/O 聚合能力上的性能极限。</li>
</ul>
<p>在这两个月的测试中，我们通过构造多组不同的测试负载，对 AutoMQ 进行了全面的评估。结果表明，<strong>AutoMQ 在各种压力场景下都展现出了非常好的稳定性，其吞吐量、延迟等关键性能指标完全符合我们生产环境的要求</strong>。这给了我们充足的信心，正式启动生产环境的迁移工作。</p>
<h3 data-id="heading-8">生产迁移阶段</h3>
<p>从 2025 年 8 月开始，我们正式将生产环境的业务流量迁移至 AutoMQ。<strong>得益于 AutoMQ 对 Apache Kafka 协议 100% 的兼容性，整个迁移过程异常丝滑，对业务方完全透明，也无需我们进行额外的开发适配。</strong></p>
<p>我们的迁移遵循了以下标准的三步流程，以确保数据的零丢失和服务的不中断：</p>
<ol>
<li><strong>切换生产者 （Producer）</strong>：我们首先修改生产者的客户端配置，将它们的接入点地址指向新的 AutoMQ 集群。这个过程通过滚动更新（rolling update）的方式进行，线上流量被平滑地切换过来，新的数据开始源源不断地写入 AutoMQ。</li>
<li><strong>排空旧集群数据</strong>：在生产者完全切换后，旧的 Kafka 集群不再接收新的数据。我们会让消费者继续运行在旧集群上，直到它们消费完所有堆积的历史数据。</li>
<li><strong>切换消费者 （Consumer）</strong>：确认旧集群数据已被消费完毕后，我们同样以滚动更新的方式，修改消费者的接入点地址，使其指向新的 AutoMQ 集群。消费者会配置为从新集群中最早的可用位点（Offset）开始消费，从而无缝衔接，保证了数据处理的连续性。</li>
</ol>
<h2 data-id="heading-9">上线情况与效果</h2>
<p>经过平滑的迁移，AutoMQ 目前已经在我们内部稳定运行，并承接了核心的生产流量。截至目前，我们总计上线了 <strong>6 个 AutoMQ 集群</strong>，整体峰值写入吞吐量达到 <strong>1.6 GiB/s</strong>，峰值 QPS 约为 <strong>480K</strong>。</p>
<p>为了更直观地展示其运行表现，下图是我们其中一个较大集群的生产集群监控概览：</p>
<p><img src="https://automq66.feishu.cn/space/api/box/stream/download/asynccode/?code=YmNhMThmNWE1YmI2OWRlMjBhYmNlY2RiMGFlMDhhYTZfZHVXdkFkZU4zV1hIc0Ywdk85TnM4WjF0MGJ5R2tYRFpfVG9rZW46Vkh2U2IxTXkxb3FvYm14d2pqOGNENVBYbk9mXzE3NjM3MDc2NDE6MTc2MzcxMTI0MV9WNA" alt="" loading="lazy"/></p>
<p>迁移到 AutoMQ 后，我们获得了非常显著的收益，完美解决了之前在传统 Kafka 上遇到的核心痛点。</p>
<ul>
<li><strong>成本大幅度降低</strong>：最直接、最显著的收益来自于成本的优化。AutoMQ 存算分离的创新架构，从根本上解决了传统 Kafka 因资源捆绑而导致的成本问题。我们不再需要为应对流量高峰而预留大量的计算资源，同时通过将数据持久化到对象存储，也极大地降低了存储开销。综合计算和存储两方面的节省，<strong>腾讯音乐 Kafka 集群成本平均降低超过了 50%</strong>。</li>
<li><strong>获得“秒级”的极速扩缩容能力</strong>：过去困扰我们运维团队的扩容难题，在 AutoMQ 上彻底成为了过去式。由于扩容新的 Broker 节点不再需要进行耗时的数据搬迁，整个过程变得异常迅速。凭借 AutoMQ <strong>分区的秒级迁移能力</strong>以及其内置的 <strong>Self-Balancing 自动流量均衡机制</strong>，我们现在可以在<strong>数十秒内，平滑地为集群扩展出 1 GiB/s 的吞吐容量</strong>。这种极致的弹性伸缩能力，意味着我们可以从容应对任何突发的业务流量增长，为腾讯音乐未来的业务发展提供了坚实而灵活的基础设施保障。</li>
</ul>
<p><img src="https://automq66.feishu.cn/space/api/box/stream/download/asynccode/?code=YjNiNGUxOTYxMDYwOWY3YTZkMTVkYTg1MWM1N2MwYmJfR2RPQUg4YjZiQjBuTHBFYnhaMjM2RVZlWHRteEF1VWxfVG9rZW46VW5xMGJQZXowb0xoaW94T0ZGR2Nzb0FtbnBWXzE3NjM3MDc2NDE6MTc2MzcxMTI0MV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">未来展望</h2>
<p>回顾这次技术升级之旅，AutoMQ 在腾讯音乐生产环境中的表现令人印象深刻。无论是在高负载下的稳定性、优秀的性能指标，还是在降本增效和简化运维方面取得的实质性成果，都<strong>完全符合甚至超出了我们运维团队的预期</strong>。这次成功的实践，验证了 AutoMQ 这种云原生架构在 Kafka 流领域的巨大价值。</p>
<p>基于当前的成功经验，我们制定了清晰的未来演进路线图，按优先级逐步推进：</p>
<ul>
<li><strong>全面推进存量迁移</strong>：我们将加速推进剩余 Kafka 集群的迁移工作。计划将所有服务于<strong>全量可观测和多维分析</strong>业务的 Kafka 集群全部迁移至 AutoMQ，以最大化地释放成本红利并统一运维体系。</li>
<li><strong>落地流式数据入湖</strong>：在数据架构演进方面，我们将着手<strong>落地 AutoMQ 的 Table Topic 功能</strong>。充分利用其对 Iceberg 的原生支持，构建更加简洁、高效、实时的流式数据入湖链路，为上层的数据分析业务提供更强有力的支撑。</li>
<li><strong>AutoMQ 组件标准化与推广</strong>：我们计划将 AutoMQ 打造成腾讯音乐内部<strong>标准化的基础设施组件</strong>，并积极将其推广应用到更多样化的业务场景中，让更多的业务线受益于新架构带来的极致弹性和低成本优势。</li>
<li><strong>迈向完全的 Kubernetes 云原生</strong>：最后，依托 AutoMQ 天然无状态的云原生特性，我们将启动<strong>将 Kafka 服务整体搬迁至 Kubernetes</strong> 的探索与实践。这将有助于我们进一步提升资源管理的自动化水平和整体利用率，推动腾讯音乐的数据基础设施向着完全云原生的方向迈进。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大厂面试题MySQL解析：MVCC、Redolog、Undolog与Binlog的区别]]></title>    <link>https://juejin.cn/post/7574725286530089011</link>    <guid>https://juejin.cn/post/7574725286530089011</guid>    <pubDate>2025-11-21T05:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530089011" data-draft-id="7574253222607241257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大厂面试题MySQL解析：MVCC、Redolog、Undolog与Binlog的区别"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-21T05:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大厂面试题MySQL解析：MVCC、Redolog、Undolog与Binlog的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:07:15.000Z" title="Fri Nov 21 2025 05:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在MySQL数据库的面试中，常常会遇到关于事务、日志和一致性等方面的核心问题。理解和掌握这些概念是非常重要的，特别是当涉及到数据库的性能优化和故障恢复时。本文将详细解析MySQL中 <strong>MVCC</strong>、<strong>Redolog</strong>、<strong>Undolog</strong> 和 <strong>Binlog</strong> 的区别和作用。</p>
<h4 data-id="heading-0">1. <strong>MVCC（多版本并发控制）</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1692580abf4929bd823fa06e7d79a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=5nwmb0xq8MLJjPAptZieZweUCN8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p><strong>MVCC</strong>（Multi-Version Concurrency Control）是一种用于实现并发控制的技术，通过保持数据的多个版本来避免锁争用和提升并发性。它主要用于实现<strong>事务的隔离性</strong>。</p>
<ul>
<li><strong>MVCC的工作原理</strong>：<br/>
- MySQL通过在每一行记录中存储两个隐藏字段：<code>DB_TRX_ID</code>（事务ID）和<code>DB_ROLL_PTR</code>（指向undo日志的指针）。<br/>
- 在每次读取数据时，InnoDB引擎会根据<strong>事务ID</strong>来判断哪个版本的数据是当前事务能看到的有效数据。如果某一事务在读取时，另一事务对该数据进行了修改，MVCC保证读取的数据是该事务启动时可见的历史版本。<br/>
</li>
<li><strong>作用</strong>： <br/>
- 提供了<strong>事务隔离性</strong>，确保多个事务并发执行时不会互相干扰，避免读取脏数据。<br/>
- 通过不加锁读取，可以提升数据库的并发性。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8d57d160c243e191b45681c870f0dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=CPGpOkFAhkIs5lIaoHtcyCv8gaM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</li>
</ul>
<hr/>
<h4 data-id="heading-1">2. <strong>Redolog（重做日志）</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b95e370ed749308e52a44c3e4ddd59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=CM9zJOmx9%2BBsD25MTy%2FcLbPXheU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p><strong>Redolog</strong> 是InnoDB存储引擎的一种日志机制，旨在提供数据恢复功能。它记录了事务对数据库的所有修改操作，并且是持久化的。在MySQL中，Redolog属于<strong>事务日志</strong>的一种。</p>
<ul>
<li>
<p><strong>Redolog的工作原理</strong>：<br/>
- 每次事务提交前，InnoDB会先将事务修改操作写入到<strong>Redolog缓冲区</strong>（内存），然后再刷写到磁盘。<br/>
- Redolog确保即使数据库崩溃，只要事务已经提交，对应的修改就不会丢失。系统会根据Redolog重新执行提交的事务。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad37c561cf1a4d6eb8e43c9284c48a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=kGAEqYA%2B6BUt1QssBnLWKNLI3RE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
</li>
<li>
<p><strong>作用</strong>：<br/>
- 保证了数据的<strong>持久性</strong>（Durability），即使系统崩溃或发生其他故障，只要事务提交，就能通过Redolog恢复数据。<br/>
- <strong>日志顺序写入</strong>：在高并发的情况下，Redolog采用顺序写入的方式，极大地提高了写入性能。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-2">3. <strong>Undolog（回滚日志）</strong></h4>
<p><strong>Undolog</strong>（Undo日志）是用来支持事务回滚的日志。它记录了事务对数据的修改操作，确保如果事务需要回滚时，可以将数据恢复到修改前的状态。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aafce4a3b74c40afa63944aaee3770b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=HHjPVHX0z4Y8dbW311IxXQhPKSg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<ul>
<li>
<p><strong>Undolog的工作原理</strong>：<br/>
- 当事务开始修改数据时，InnoDB会生成Undo日志，这些日志记录了修改之前的数据值（即修改前的快照）。<br/>
- 如果事务出现异常或需要回滚，InnoDB会通过Undolog将修改恢复到原来的状态。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c432117c9942ae9d604f489eb2c914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=Zh1NpELtLLjpZw2woBSpHVkqdzE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
</li>
<li>
<p><strong>作用</strong>：<br/>
- 支持事务的<strong>原子性</strong>（Atomicity），保证即使事务执行中发生错误或需要回滚，所有已做的修改都会被撤销，数据库状态恢复到事务开始之前。<br/>
- 实现MVCC：每个事务都有自己的一组Undo日志记录，通过这些Undo日志可以查询历史版本的数据。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-3">4. <strong>Binlog（二进制日志）</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bef2e3821be436b9a781af16f1bc22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306435&amp;x-signature=yDY1PILN8Bri4GwcBdhmwByrv18%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p><strong>Binlog</strong>是MySQL的二进制日志文件，用于记录所有修改数据库数据的操作。它主要用于<strong>数据恢复</strong>、<strong>主从复制</strong>和<strong>增量备份</strong>。</p>
<ul>
<li>
<p><strong>Binlog的工作原理</strong>：<br/>
- 每次数据库发生增、删、改等操作时，MySQL都会将这些操作记录到Binlog中。Binlog是按顺序记录的，并且它不会记录查询操作。<br/>
- Binlog存储的是<strong>逻辑日志</strong>，记录的是SQL语句本身（例如<code>INSERT</code>、<code>UPDATE</code>等），可以用来恢复或重放数据库操作。</p>
</li>
<li>
<p><strong>作用</strong>：<br/>
- 支持<strong>数据库恢复</strong>：Binlog记录了数据库的所有修改操作，可以用来恢复丢失的数据或回滚数据。<br/>
- 支持<strong>主从复制</strong>：通过将主库的Binlog同步到从库，从库可以重放这些日志来保持数据同步。<br/>
- 支持<strong>增量备份</strong>：可以利用Binlog进行增量备份，只备份自上次备份以来的变化。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">5. <strong>MVCC、Redolog、Undolog和Binlog的区别</strong></h3>






















































<table><thead><tr><th>特性/日志类型  </th><th><strong>MVCC</strong>                      </th><th><strong>Redolog</strong>                    </th><th><strong>Undolog</strong>                    </th><th><strong>Binlog</strong>                    </th></tr></thead><tbody><tr><td><strong>定义</strong>        </td><td>多版本并发控制，用于实现事务隔离性</td><td>记录事务对数据库的修改操作，确保持久性</td><td>记录事务修改前的数据，用于支持回滚</td><td>记录所有数据库修改操作，用于备份和复制</td></tr><tr><td><strong>记录内容</strong>    </td><td>数据版本、事务ID              </td><td>数据修改的操作日志              </td><td>修改前的数据（回滚操作）      </td><td>数据修改的SQL语句              </td></tr><tr><td><strong>存储位置</strong>    </td><td>数据行中                      </td><td>磁盘上的Redolog文件            </td><td>磁盘上的Undo日志              </td><td>磁盘上的Binlog文件            </td></tr><tr><td><strong>作用</strong>        </td><td>支持并发控制和事务隔离性      </td><td>保证事务持久性，崩溃恢复        </td><td>支持事务回滚，保证原子性        </td><td>数据恢复、主从复制、增量备份  </td></tr><tr><td><strong>写入顺序</strong>    </td><td>非顺序写入                    </td><td>顺序写入                        </td><td>顺序写入                      </td><td>顺序写入                      </td></tr><tr><td><strong>是否可回滚</strong>  </td><td>否                            </td><td>否                              </td><td>是                            </td><td>否                            </td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">总结</h3>
<ul>
<li><strong>MVCC</strong> 通过维护多个版本的数据，确保事务的并发性和隔离性，避免了传统的锁机制。</li>
<li><strong>Redolog</strong> 是事务持久性的保证，通过记录事务修改操作，确保系统崩溃后数据不会丢失。</li>
<li><strong>Undolog</strong> 提供了事务回滚的功能，确保事务的原子性，在需要回滚时恢复到事务开始前的状态。</li>
<li><strong>Binlog</strong> 主要用于备份、恢复和主从复制，记录所有修改数据的操作。</li>
</ul>
<p>这四种日志机制是MySQL数据库保障数据一致性、可恢复性、并发控制和事务支持的重要工具，各有不同的作用和特点。在面试中，理解它们的原理和实际应用场景是非常重要的。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL面试题解析：MySQL读写分离与主从同步]]></title>    <link>https://juejin.cn/post/7574775334680903690</link>    <guid>https://juejin.cn/post/7574775334680903690</guid>    <pubDate>2025-11-21T05:07:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574775334680903690" data-draft-id="7574286569037873215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL面试题解析：MySQL读写分离与主从同步"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-21T05:07:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL面试题解析：MySQL读写分离与主从同步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:07:37.000Z" title="Fri Nov 21 2025 05:07:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在MySQL数据库的面试中，面试官常常会问到数据库的高可用性架构设计，尤其是<strong>读写分离</strong>和<strong>主从同步</strong>。这些技术能够帮助提升数据库的性能和可扩展性，特别是在高并发的场景下。</p>
<p>本文将详细解释什么是MySQL的<strong>读写分离</strong>和<strong>主从同步</strong>，它们的工作原理，以及如何在实际应用中使用它们。</p>
<hr/>
<h3 data-id="heading-0">1. <strong>MySQL读写分离</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fdd6d1eed4148dc96d89583f4e678ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306456&amp;x-signature=ZbdI8hnxIzcBryz2PawcrGqYVM8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h3>
<h4 data-id="heading-1"><strong>定义</strong></h4>
<p>MySQL的<strong>读写分离</strong>（Read-Write Splitting）是一种架构设计，通过将数据库的读请求和写请求分开处理，从而提高数据库的性能和扩展性。在读写分离架构中，通常会配置一个主数据库和多个从数据库：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/234203349aa749bca1109e754c4fa47d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306456&amp;x-signature=QaNkLCAu88%2BA9Aprf52R0nhtEgI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<ul>
<li><strong>主库</strong>：负责处理写请求（如INSERT、UPDATE、DELETE等）。</li>
<li><strong>从库</strong>：负责处理读请求（如SELECT）。从库会定期同步主库的数据，以确保数据的一致性。</li>
</ul>
<h4 data-id="heading-2"><strong>工作原理</strong></h4>
<ul>
<li><strong>主库和从库的关系</strong>：主库执行写操作后，会将这些操作记录到<strong>Binlog</strong>（二进制日志）中，从库会实时或定期同步主库的Binlog日志，将这些操作应用到自己的数据库中，从而保持与主库的数据一致性。</li>
<li><strong>读写请求分离</strong>：应用层通常会通过某种方式（例如中间件或数据库代理）将读请求路由到从库，而写请求则直接发送到主库。这样，主库负责写操作，从库则负责读操作。</li>
</ul>
<h4 data-id="heading-3"><strong>优势</strong></h4>
<ul>
<li><strong>提升性能</strong>：通过将读操作分发到多个从库，可以有效减轻主库的压力，提高系统的整体吞吐量。</li>
<li><strong>负载均衡</strong>：在多个从库中分发读请求，有助于平衡数据库的负载，避免单个数据库实例过载。</li>
<li><strong>高可用性</strong>：在主库出现故障时，可以通过将某个从库提升为新的主库来实现故障恢复，提升系统的可用性。</li>
</ul>
<h4 data-id="heading-4"><strong>缺点</strong></h4>
<ul>
<li><strong>数据延迟</strong>：主库写入数据后，从库需要一段时间来同步这些数据。因此，从库的数据可能会有一定的延迟。</li>
<li><strong>一致性问题</strong>：由于从库有延迟，某些时刻从库中的数据可能不是最新的。这在某些场景下可能引起一致性问题，特别是对于对一致性要求较高的应用。</li>
</ul>
<h4 data-id="heading-5"><strong>实现方式</strong></h4>
<p>MySQL的读写分离通常可以通过以下方式实现：</p>
<ul>
<li><strong>MySQL Proxy</strong>：例如使用ProxySQL、MaxScale等中间件来实现读写分离。这些工具会自动将读请求发送到从库，而写请求发送到主库。</li>
<li><strong>应用层控制</strong>：在应用层，开发人员可以手动将读写请求路由到不同的数据库实例。</li>
<li><strong>MySQL Router</strong>：MySQL官方提供的路由工具，用于将读请求路由到从库，写请求路由到主库。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. <strong>MySQL主从同步</strong></h3>
<h4 data-id="heading-7"><strong>定义</strong></h4>
<p><strong>主从同步</strong>（Master-Slave Replication）是MySQL中的一种数据同步机制，允许多个MySQL服务器通过复制技术保持数据一致性。主库（Master）接受所有写请求，从库（Slave）则从主库同步数据，通常用于提高数据库的读取性能和可用性。</p>
<h4 data-id="heading-8"><strong>工作原理</strong></h4>
<ol>
<li><strong>Binlog</strong>：主库在处理每一个写请求时，将操作记录到二进制日志（Binlog）中。</li>
<li><strong>IO线程</strong>：从库的I/O线程会从主库获取最新的Binlog，并将其存储到自己的中继日志（Relay Log）中。</li>
<li><strong>SQL线程</strong>：从库的SQL线程会读取中继日志，执行日志中记录的SQL语句，从而使得从库的数据与主库保持一致。</li>
</ol>
<h4 data-id="heading-9"><strong>同步方式</strong></h4>
<ul>
<li><strong>异步复制</strong>：在异步复制模式下，主库在提交事务时不会等待从库的确认。也就是说，主库先提交事务，再将其写入Binlog，从库则会在稍后同步这些日志。这种方式可能导致主库和从库之间的数据略有延迟，但性能较高。<br/>
</li>
<li><strong>半同步复制</strong>：在半同步复制模式下，主库在提交事务时会等待至少一个从库确认收到日志后才会提交事务。这种方式比异步复制更能保证主从数据的一致性，但性能略逊一筹。<br/>
</li>
<li><strong>同步复制</strong>：在同步复制模式下，主库和所有从库都必须确认事务提交才能返回。这种方式能保证强一致性，但对性能有较大影响。</li>
</ul>
<h4 data-id="heading-10"><strong>优势</strong></h4>
<ul>
<li><strong>数据冗余</strong>：主从同步提供了数据冗余，防止因主库故障导致数据丢失。</li>
<li><strong>提高读取性能</strong>：通过将读取请求分配到多个从库，能分担主库的负载，从而提升数据库的性能。</li>
<li><strong>数据备份</strong>：从库可以用作数据库备份的副本，减少备份对生产环境的影响。</li>
</ul>
<h4 data-id="heading-11"><strong>缺点</strong></h4>
<ul>
<li><strong>延迟</strong>：在异步复制模式下，主库与从库之间的同步有一定延迟，可能导致从库的数据不是实时更新的。</li>
<li><strong>故障切换</strong>：如果主库出现故障，需要手动或自动将某个从库提升为新的主库，进行故障恢复。</li>
</ul>
<hr/>
<h3 data-id="heading-12">3. <strong>MySQL读写分离与主从同步的区别</strong></h3>













































<table><thead><tr><th>特性/概念              </th><th><strong>读写分离</strong>                              </th><th><strong>主从同步</strong>                              </th></tr></thead><tbody><tr><td><strong>定义</strong>              </td><td>将读请求和写请求分开，写请求由主库处理，读请求由从库处理。</td><td>通过复制技术将主库的数据同步到从库。</td></tr><tr><td><strong>工作机制</strong>          </td><td>通过中间件或应用层将读请求发送到从库，写请求发送到主库。</td><td>主库将修改记录到Binlog，从库从Binlog同步数据。</td></tr><tr><td><strong>数据一致性</strong>        </td><td>从库数据可能有延迟，可能存在一致性问题。    </td><td>主库和从库的数据最终一致，但存在同步延迟。</td></tr><tr><td><strong>用途</strong>              </td><td>提高读取性能，分担主库压力。              </td><td>提高数据冗余性和备份能力，提升读取性能。</td></tr><tr><td><strong>实现方式</strong>          </td><td>通过中间件（如ProxySQL、MySQL Router）或应用层控制。</td><td>通过MySQL的复制功能（如异步、半同步、同步复制）。</td></tr><tr><td><strong>优点</strong>              </td><td>提高数据库的读取性能和扩展性，减轻主库负担。</td><td>数据冗余，提升系统可用性和容错能力。</td></tr><tr><td><strong>缺点</strong>              </td><td>从库数据延迟，可能引发一致性问题。        </td><td>主从数据同步有延迟，可能导致主从不一致。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">总结</h3>
<ul>
<li><strong>读写分离</strong>是一种提高MySQL数据库性能和扩展性的方法，主要通过将读请求分发到多个从库来减轻主库压力。</li>
<li><strong>主从同步</strong>则是MySQL的一种数据复制机制，它通过将主库的变更数据同步到从库，从而实现数据冗余、提高系统的高可用性。</li>
<li>它们在提高数据库性能、实现高可用性和故障恢复方面各有优势，但也各自面临一定的挑战（如数据延迟、一致性问题等）。</li>
</ul>
<p>理解和掌握MySQL的读写分离和主从同步技术，能够有效地提升数据库的性能和可用性，尤其是在高并发、大流量的应用场景下。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个有意思的问题引起了我的反思]]></title>    <link>https://juejin.cn/post/7574726841543442470</link>    <guid>https://juejin.cn/post/7574726841543442470</guid>    <pubDate>2025-11-21T04:52:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574726841543442470" data-draft-id="7574726841543426086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个有意思的问题引起了我的反思"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-11-21T04:52:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MegatronKing"/> <meta itemprop="url" content="https://juejin.cn/user/2559318798642792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个有意思的问题引起了我的反思
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318798642792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MegatronKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T04:52:38.000Z" title="Fri Nov 21 2025 04:52:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前两天逛V站，看到一个帖子《macos 抓包最佳实践是什么？》，这不是问到我的专业领域了嘛，赶紧点开看看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a496b49c1a844a3fa8c77dcc17a61494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764305557&amp;x-signature=DHsw1M%2FksCbvECsk0fc1dEnJSH4%3D" alt="image.png" loading="lazy"/></p>
<p>这不巧了，用的正好是Reqable，找对工具就成功了80%，我心里好一阵开心，赶紧看看问题是什么。</p>
<h2 data-id="heading-0">1. 问题的场景</h2>
<p>提问者的场景其实很简单，需要用Reqable抓下AI接口的调用数据。由于国外的几大AI巨头屏蔽了国内IP的访问，在抓包时，程序发起HTTP请求，会先访问Reqable，Reqable再访问AI接口服务器，这是一个代理的过程。但是Reqable并不具备科学上网的功能，所以这个访问会失败。解决方法正如提问者所说配置一个二级代理，让Reqable去访问Clash代理，Clash去访问AI接口的服务器，链路如下：</p>
<pre><code class="hljs language-scss" lang="scss">client -&gt; <span class="hljs-built_in">reqable</span>(port:<span class="hljs-number">9000</span>) -&gt; <span class="hljs-built_in">clash</span>(port: <span class="hljs-number">7890</span>) -&gt; server
</code></pre>
<p>可以看出提问者的网络基础知识非常扎实，找到了正确的方式。接下来是他遇到的问题，浏览器上好使，但是在命令行里面跑程序就不好使了，原因和解决方案他也找到了：</p>
<p>第一个要在命令行里面配置代理环境变量，因为命令行并不会和浏览器一样自动读取系统代理配置，需要手动配置。</p>
<p>第二个是运行的程序不会读取命令行中配置的代理环境变量，还需要改代码强行走代理。从楼下的回复来看，应该是用的Javascript写的程序，需要加入如下代码，读取环境变量中的代理地址。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setGlobalDispatcher</span>(  
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyAgent</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">HTTP_PROXY</span>)
);
</code></pre>
<p>很明显，这个解决方案是临时的，非常繁琐不方便，所以他有了疑问：抓包最佳实践是什么？爱思考才能有进步，偷懒是科技进步的动力。</p>
<p>相信这个场景很多开发者都会遇到，我们也考虑过这个问题，并给出了解决方案：<code>代理终端</code>。</p>
<h2 data-id="heading-1">2. 代理终端如何用？</h2>
<p>在Reqable顶部本机地址的后面有一个命令行图标，点击一下就可以打开代理终端了（快捷键 Alt + T）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ef24ce369d84539a832c7f42cdbb5de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764305557&amp;x-signature=6DbhHNsN66K1cT3mDAGrtM4J%2FBA%3D" alt="image.png" loading="lazy"/></p>
<p>点击之后会打开一个命令行窗口，显示一个帅气的Reqable艺术照。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0facacc2978749348d8cf335d095c890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764305557&amp;x-signature=N6E3Bvi5D5c3ovfpimxPLiaz7mU%3D" alt="image.png" loading="lazy"/></p>
<p>接下来，只需要直接在这个命令行里面正常运行程序就可以了，不需要配置环境变量，不需要修改代码，Everything is OK！</p>
<p>Reqable支持哪些命令行工具呢，有下面这些：</p>
<ul>
<li>Windows: cmd（默认）、PowerShell和Pwsh。</li>
<li>Mac: Terminal（默认）、iTerm2。</li>
<li>Linux: gnome console（Ubuntu）和konsole（KDE）、xterm。</li>
</ul>
<p>注意：不用默认的命令行，可以图标右键点击修改默认启动的命令行工具。</p>
<p>为什么代理终端可以解决上面的两个问题呢，我们接下来揭晓答案。</p>
<h2 data-id="heading-2">3. 代理终端的原理是什么？</h2>
<p>在启动命令行工具之后，我们会自动执行一段脚本，这个脚本做了下面几件事情。</p>
<p>首先，配置环境变量，把HTTP_PROXY和HTTPS_PROXY设置为Reqable的代理地址，例如 127.0.0.1:9000。</p>
<p>接着，修改PATH环境变量，在运行程序之前先执行我们预设好的程序进行Hook。比如要通过node执行一个JS程序，命令行从PATH中搜索node可执行程序的时候，由于我们的假node在PATH中位置最前面，就先找了这个假node，我们在其中先执行一段逻辑，例如强制网络框架走代理，强制不进行SSL验证等等，然后再调用系统真正的node来运行需要执行的程序。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># Find system node path</span>
PATH=<span class="hljs-string">"<span class="hljs-subst">$(printf '%s\n' <span class="hljs-string">"<span class="hljs-variable">$PATH</span>"</span> | sed <span class="hljs-string">"s:<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>)</span>\:::g"</span>)</span>"</span>
systemNode=`<span class="hljs-built_in">command</span> -v node`
PATH=<span class="hljs-string">"`dirname "</span><span class="hljs-variable">$0</span><span class="hljs-string">"`:<span class="hljs-variable">$PATH</span>"</span>

<span class="hljs-comment"># Find the override script path</span>
OVERRIDE_SCRIPT_PATH=`<span class="hljs-built_in">dirname</span> <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>`/override.js

<span class="hljs-comment"># Call system node with the override script</span>
<span class="hljs-string">"<span class="hljs-variable">$systemNode</span>"</span> -r <span class="hljs-string">"<span class="hljs-variable">$OVERRIDE_SCRIPT_PATH</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>上面是一个shell脚本，在Windows上是bat脚本，内容大同小异。我们插入的逻辑在override.js里面，强制网络框架走代理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> globalAgent = <span class="hljs-built_in">require</span>(<span class="hljs-string">"global-agent"</span>);
globalAgent.<span class="hljs-title function_">bootstrap</span>();

<span class="hljs-comment">// For node fetch usage</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Undici</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'undici'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyAgent</span> = <span class="hljs-title class_">Undici</span>.<span class="hljs-property">ProxyAgent</span>;
<span class="hljs-keyword">const</span> setGlobalDispatcher = <span class="hljs-title class_">Undici</span>.<span class="hljs-property">setGlobalDispatcher</span>;
<span class="hljs-title function_">setGlobalDispatcher</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyAgent</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">HTTP_PROXY</span>)
);
</code></pre>
<p>最后一步，也是最关键的一步。输入一个帅气的Reqable艺术照，把逼格拉高。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-string">"echo '______                 _     _      '"</span>,
<span class="hljs-string">"echo '| ___ \               | |   | |     '"</span>,
<span class="hljs-string">"echo '| |_/ /___  __ _  __ _| |__ | | ___ '"</span>,
<span class="hljs-string">"echo '|    // _ \/ _` |/ _` | `_ \| |/ _ \'"</span>,
<span class="hljs-string">"echo '| |\ \  __/ (_| | (_| | |_) | | ___/'"</span>,
<span class="hljs-string">"echo '\_| \_\___|\__. |\__._|_.__/|_|\___|'"</span>,
<span class="hljs-string">"echo '              | |                   '"</span>,
<span class="hljs-string">"echo '              |_| '"</span>,
</code></pre>
<p>手敲上面这段是不可能的，我们找了一个text-to-ascii-art的网站自动生成。</p>
<p>上面是Node自动Hook的原理，而像Python又有很大的不同了，Python不是通过修改PATH环境变量来Hook，而是通过PYTHONPATH来指定路径Hook掉httplib、aiohttp等网络库，具体代码比较多，这里写不下，就不放出来了。</p>
<p>目前Reqable代理终端支持NodeJS、Python和Ruby三种程序的强制代理，当前其他的不需要强制代理的也可以使用。如果大家有其他需要支持的或者方案实现，欢迎在评论区一起讨论交流。</p>
<h2 data-id="heading-3">4. 我在反思什么？</h2>
<p>这么好用的功能为什么大家都不知道，这个问题不得不引起我的反思。说明，我们的文档和教程做得不够好不够细，后面要大大加强这方面的建设。</p>
<p>感谢大家的阅读，欢迎体验我们的产品：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freqable.com" target="_blank" title="https://reqable.com" ref="nofollow noopener noreferrer">新一代API开发工具 - Reqable</a></p>
<p>未来属于Reqable！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RevenueCat 接入 Apple App Store 订阅全流程详解（2025 最新）]]></title>    <link>https://juejin.cn/post/7574725286530121779</link>    <guid>https://juejin.cn/post/7574725286530121779</guid>    <pubDate>2025-11-21T05:19:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530121779" data-draft-id="7574724406306078770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RevenueCat 接入 Apple App Store 订阅全流程详解（2025 最新）"/> <meta itemprop="keywords" content="Flutter,iOS,APP"/> <meta itemprop="datePublished" content="2025-11-21T05:19:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HBLOG"/> <meta itemprop="url" content="https://juejin.cn/user/131597124767479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RevenueCat 接入 Apple App Store 订阅全流程详解（2025 最新）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597124767479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HBLOG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:19:59.000Z" title="Fri Nov 21 2025 05:19:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=http%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2Fimage-16.png" target="_blank" title="http://admin.liuhaihua.cn/wp-content/uploads/2025/11/image-16.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9b6708793b742d39a769f25fc2d3abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=ZzSMu%2B6NVsCxKgb3QpDZKkYdN10%3D" alt="" loading="lazy"/></a></p>
<p>适用：<strong>Flutter / Swift / Objective-C / React Native / Unity</strong><br/>
场景：上架 App + 内购订阅（月付/年付）+ RevenueCat 统一管理</p>
<h2 data-id="heading-0">一、为什么用 RevenueCat 管理苹果订阅？</h2>
<p>Apple IAP（In-App Purchase）本身非常强大，但开发者常常会遇到：</p>
<ul>
<li>验证票据复杂（Receipt Validation 反作弊）</li>
<li>订阅生效状态难同步（Sandbox 状态混乱）</li>
<li>跨平台权益（iOS + Android）难统一</li>
<li>RevenueCat 能自动管理全部</li>
</ul>
<p>使用 RevenueCat，你可以：</p>
<p>✨ 自动验证订阅（无需自己搭建服务器）<br/>
✨ 自动同步跨平台用户 Pro 状态<br/>
✨ 显示历史账单、取消原因、续费失败原因<br/>
✨ 支持 Offer、价格管理、A/B 测试<br/>
✨ 自动处理 Apple 信号（cancel、renew、billing retry 等）</p>
<p>只需 10 行代码即可完成所有 IAP。</p>
<h2 data-id="heading-1">二、准备工作</h2>
<p>项目</p>
<p>要求</p>
<p>Apple 开发者账号（公司/个人）</p>
<p>已完成银行卡验证</p>
<p>App Store Connect 中已创建 App</p>
<p>不需提交，可是 Draft 状态</p>
<p>已上传一次 build（用于解锁 IAP 功能）</p>
<p>必须，否则找不到 In-App Purchases</p>
<p>RevenueCat 账号</p>
<p>免费版即可</p>
<p>Flutter/Swift 项目已加入 IAP 权限</p>
<p>需开启 In-App Purchase Capability</p>
<h2 data-id="heading-2">三、在 App Store Connect 创建订阅项目（Subscription）</h2>
<p>重要：<strong>必须先创建订阅组（Subscription Group）才能创建订阅产品</strong>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F1250e617-fa4b-41bf-9dc7-d50879b7f138.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/1250e617-fa4b-41bf-9dc7-d50879b7f138.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b283edb419443a91b6afea4cbf30fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=IarJMlgDe%2FQzK4dL%2FeRIn1Pb8qs%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-3">步骤 1：进入订阅管理页面</h3>
<p>路径：</p>
<pre><code class="hljs language-sql" lang="sql">App Store <span class="hljs-keyword">Connect</span> → My Apps → 你的 App →
Features → <span class="hljs-keyword">In</span><span class="hljs-operator">-</span>App Purchases → Manage
</code></pre>
<p>点击：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F0cdf1502-d7d5-45a1-b168-6bbe25660dc7.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/0cdf1502-d7d5-45a1-b168-6bbe25660dc7.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec38bfbf2479409d8db495ca8c03b809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=vl0GZyRiWxFn5lnkrJIKS1cn7mU%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-4">步骤 2：创建订阅组（Subscription Group）</h3>
<p>示例名称：</p>
<ul>
<li><strong>Linguadiary Pro</strong></li>
<li>或者 Pro Plan</li>
</ul>
<p><strong>注意：一个订阅组内，用户只能选择一个订阅（例如月付 or 年付）</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2Fimage-15.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/image-15.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e177abe2ac664fbdb7d8697337f94a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=W25kMxbJH1QGGuss50UuTSogpeM%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-5">步骤 3：创建订阅产品（In-App Purchase）</h3>
<p>例子：</p>
<p>字段</p>
<p>示例</p>
<p><strong>Reference Name</strong></p>
<p>Linguadiary Monthly Subscription</p>
<p><strong>Product ID</strong></p>
<p>linguadiary_monthly_1</p>
<p><strong>Duration</strong></p>
<p>1 Month</p>
<p><strong>Cleared for Sale</strong></p>
<p>YES</p>
<p><strong>Localization</strong></p>
<p>Title + Description 必填否则审核失败</p>
<p>Apple 要求填写：</p>
<h4 data-id="heading-6">（1）标题（Title）</h4>
<p>示例：</p>
<blockquote>
<p>Linguadiary Monthly Plan</p>
</blockquote>
<p>建议 35 字以内</p>
<h4 data-id="heading-7">（2）描述（Description）</h4>
<p>示例：</p>
<blockquote>
<p>Unlock unlimited AI correction and pro features.</p>
</blockquote>
<p>建议 55 字以内</p>
<h4 data-id="heading-8">（3）价格 / 价格计划（Pricing）</h4>
<p>选择 <strong>Level 1–87</strong> 价格等级。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F935743d6-6a12-4ee1-90dc-cc3334a7f34b.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/935743d6-6a12-4ee1-90dc-cc3334a7f34b.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/520bdc7b888c4875bd726e5befd661aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=kPyHlNCH4OJw6SvhAuIoCSdG8uw%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-9">步骤 4：创建年订阅</h3>
<p>同组内再创建一个：</p>
<p>字段</p>
<p>示例</p>
<p>Product ID</p>
<p>linguadiary_yearly_12</p>
<p>Duration</p>
<p>1 Year</p>
<p>价格</p>
<p>Level 2–100</p>
<h2 data-id="heading-10">四、将订阅与 App 版本关联（最容易忘记的坑）</h2>
<h4 data-id="heading-11">必须进行两处绑定：</h4>
<h3 data-id="heading-12">1. “App 内购买项目”必须勾选订阅</h3>
<p>路径：</p>
<p><strong>App Store → Version → In-App Purchases → 选择你的订阅项目 → 保存</strong></p>
<p>否则会出现：</p>
<p>❌ “元数据丢失（Metadata Lost）”<br/>
❌ 无法通过审核<br/>
❌ RevenueCat 抓不到产品</p>
<h3 data-id="heading-13">2. 本地化语言必须在 “订阅组同级的 Localization” 填写</h3>
<p>路径：</p>
<pre><code class="hljs language-sql" lang="sql">App Store <span class="hljs-keyword">Connect</span> → App Information → Localization
</code></pre>
<p>必须填写：</p>
<ul>
<li>App Name</li>
<li>Subtitle</li>
<li>Description</li>
<li>Keywords</li>
<li>Support URL</li>
<li>Marketing URL</li>
</ul>
<p>缺少任何一个 → Apple 不让订阅上架 → RevenueCat 显示产品为空。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F74143867-8fc6-420e-940e-174891367f27.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/74143867-8fc6-420e-940e-174891367f27.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57eb77c31a3a40478759327d9215f18d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=iHrVlTgI0VOk5UU%2B3A1D4bOTR2c%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-14">五、在 RevenueCat 创建 Apple App</h2>
<p>路径：</p>
<pre><code class="hljs language-sql" lang="sql">RevenueCat → Apps <span class="hljs-operator">&amp;</span> providers→ <span class="hljs-keyword">Add</span> App → Apple App Store
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F5b3913e0-4af9-4e38-8b66-cd09eeb510ab.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/5b3913e0-4af9-4e38-8b66-cd09eeb510ab.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/094b922772b0475797ee829e86049a10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=Vbjh5ZqIE38c2%2BfjlDAt1tp1EFs%3D" alt="" loading="lazy"/></a></p>
<p>填写：</p>
<ul>
<li>App Name</li>
<li>Bundle ID（必须匹配 App Store Connect ）</li>
<li>Platform：iOS</li>
</ul>
<p>然后点击 <strong>Add Store</strong>。</p>
<h2 data-id="heading-15">六、在 RevenueCat 添加订阅产品</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2Fe4402032-310d-439b-888e-e8428cc8c415.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/e4402032-310d-439b-888e-e8428cc8c415.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe2aef3e50e64dee821fd32dbdd9f7cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=Cmz8Tz2tAyx%2FygrL42xCqkwcMDo%3D" alt="" loading="lazy"/></a></p>
<p>路径：</p>
<pre><code class="hljs language-sql" lang="sql">Products → <span class="hljs-keyword">New</span> Product
</code></pre>
<p>添加：</p>
<ul>
<li>linguadiary_monthly_1</li>
<li>linguadiary_yearly_12</li>
</ul>
<p>必须与 App Store Connect Product ID 完全一致（大小写敏感）。</p>
<p>然后创建 Offering：</p>
<p>Offering</p>
<p>包含 Package</p>
<p><strong>default</strong></p>
<p>monthly + yearly</p>
<p>RevenueCat 会自动同步价格、商品信息。</p>
<h2 data-id="heading-16">七、在 App 内接入 RevenueCat SDK（Flutter 示例）</h2>
<h4 data-id="heading-17">1. 初始化 RevenueCat</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> Purchases.configure(
  PurchasesConfiguration(<span class="hljs-string">"public_sdk_key_ios"</span>),
);
</code></pre>
<h4 data-id="heading-18">2. 获取订阅产品</h4>
<pre><code class="hljs language-ini" lang="ini">final <span class="hljs-attr">offerings</span> = await Purchases.get<span class="hljs-literal">Off</span>erings()<span class="hljs-comment">;</span>
final <span class="hljs-attr">package</span> = <span class="hljs-literal">off</span>erings.current?.availablePackages.first<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-19">3. 发起购买</h4>
<pre><code class="hljs language-go" lang="go">Purchases.purchasePackage(<span class="hljs-keyword">package</span>);
</code></pre>
<h4 data-id="heading-20">4. 判断用户是否为 Pro</h4>
<pre><code class="hljs language-ini" lang="ini">final <span class="hljs-attr">info</span> = await Purchases.getCustomerInfo()<span class="hljs-comment">;</span>
final <span class="hljs-attr">isPro</span> = info.entitlements.all[<span class="hljs-string">"pro"</span>]?.isActive ?? <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
</code></pre>
<p>仅以上 4 步即可完成全部逻辑。</p>
<h2 data-id="heading-21">八、测试订阅（Sandbox）</h2>
<h3 data-id="heading-22">添加 Sandbox 测试员</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F11%2F14268626-0906-496d-ac0b-30404d5cc4f8.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/11/14268626-0906-496d-ac0b-30404d5cc4f8.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d686af6b9f194315aaf35bc487cd6859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307198&amp;x-signature=t54ha0N8sai%2FvK9SiStf6na3Y0A%3D" alt="" loading="lazy"/></a></p>
<p>路径：</p>
<pre><code class="hljs">Users and Access → Sandbox Testers
</code></pre>
<p>填写：</p>
<ul>
<li>Email（不能是 Apple ID）</li>
<li>First/Last Name</li>
<li>Password</li>
</ul>
<p>测试流程：</p>
<ol>
<li>在设备登录 Sandbox Apple ID</li>
<li>安装 TestFlight 构建</li>
<li>购买订阅</li>
<li>Apple 会用虚拟价格扣费</li>
<li>生命周期会被加速：
<ul>
<li>Monthly → 5 min</li>
<li>Yearly → 1 hour</li>
</ul>
</li>
</ol>
<p>你可以快速看到：</p>
<ul>
<li>续费成功</li>
<li>失败 → Billing Retry</li>
<li>取消 → Expire</li>
</ul>
<h2 data-id="heading-23">九、常见坑与解决方案（踩坑大全）</h2>
<h3 data-id="heading-24">❌ 1. RevenueCat 无法读取产品</h3>
<p>原因：</p>
<ul>
<li>未上传订阅本地化（Title/Description）</li>
<li>Product 未添加到 App 版本</li>
<li>Subscription Group 未本地化</li>
<li>Price 未激活</li>
<li>Subscription 未提交审核</li>
</ul>
<h3 data-id="heading-25">❌ 2. App Store Connect 显示「元数据丢失」</h3>
<p>原因：</p>
<ul>
<li>你没有在 App Version 页面勾选订阅项目</li>
</ul>
<p>必须在这里添加：</p>
<pre><code class="hljs language-sql" lang="sql">App → Version → <span class="hljs-keyword">In</span><span class="hljs-operator">-</span>App Purchases → <span class="hljs-keyword">Add</span>
</code></pre>
<h3 data-id="heading-26">❌ 3. Apple 审核拒绝：缺少隐私政策/使用条款</h3>
<p>需要在 app 内提供：</p>
<ul>
<li>Privacy Policy 链接</li>
<li>Terms of Use / EULA 链接</li>
</ul>
<p>可用：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//linguadiary.com/privacy</span>
https:<span class="hljs-comment">//linguadiary.com/terms</span>
</code></pre>
<h2 data-id="heading-27">十、发布到 App Store</h2>
<ol>
<li>确保订阅项目已 “Ready to Submit”</li>
<li>App 版本中已勾选订阅</li>
<li>提交审核</li>
<li>RevenueCat 自动处理所有验证流程</li>
<li>上架后订阅即可正常工作</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业级落地案例：抖音搜索核心链路基于 Kitex 流式改造的技术实践]]></title>    <link>https://juejin.cn/post/7574722364355362825</link>    <guid>https://juejin.cn/post/7574722364355362825</guid>    <pubDate>2025-11-21T05:26:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574722364355362825" data-draft-id="7574718964045152306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业级落地案例：抖音搜索核心链路基于 Kitex 流式改造的技术实践"/> <meta itemprop="keywords" content="架构,人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-21T05:26:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CloudWeGo"/> <meta itemprop="url" content="https://juejin.cn/user/3998273922407624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业级落地案例：抖音搜索核心链路基于 Kitex 流式改造的技术实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3998273922407624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CloudWeGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:26:31.000Z" title="Fri Nov 21 2025 05:26:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CloudWeGo 作为字节跳动开源的高性能微服务框架体系，核心组件 Kitex 中的流式架构设计，能够适配复杂业务的多次请求、分段返回需求，为亿级流量产品的链路优化提供了坚实基础。在抖音这样亿级用户的产品中，是如何落地实践并取得实效的呢？</p>
<p><strong>本文基于抖音搜索服务端架构研发工程师马永真在 CloudWeGo 四周年技术沙龙演讲内容整理，阐述抖音搜索核心链路如何借助 Kitex 流式能力进行技术改造，突破性能优化瓶颈，实现首屏体验与业务指标的双重提升。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df906eac8b964d6fa3ae1c2bb6472478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=v7CkCD4JBFlB4hwCQj66Ids4ipQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、性能优化：业务背景、痛点与现有探索</h2>
<h3 data-id="heading-1">1. 搜索性能对业务的关键影响</h3>
<p>在抖音，搜索是连接内容、用户与信息的关键桥梁，其性能表现与核心业务指标紧密相连。行业研究表明，毫秒级的延迟都可能导致用户流失------例如，谷歌的数据显示，搜索速度每慢 400 毫秒，用户流失率便会增加 0.6%。抖音内部的性能劣化实验也同样证实，搜索性能的波动与用户的点击行为、搜索兴趣乃至商业指标之间存在强相关性。</p>
<h3 data-id="heading-2">2. 抖音搜索核心架构拆解</h3>
<p>抖音搜索的后端架构主要由两大核心模块构成：</p>
<ul>
<li>
<p><strong>引擎检索</strong>：作为接收用户请求的入口，这一层负责从海量的视频、用户等异构内容中召回初步相关的数据。随后召回的数百条初步结果，会在这里经过复杂的排序与筛选模型，精选出最匹配的十条结果。</p>
</li>
<li>
<p><strong>结果打包</strong>：这一层中系统会根据不同内容的特性，差异化地获取下游数据，并将其打包成适合客户端渲染的格式，最终通过 API 层呈现给用户。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16f04292bc514cccac17b7f85a34697a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=8WzRTYkD71YQ7HUpDKHiZ%2BMg6Ls%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3. 搜索业务的优化难点解析</h3>
<p>与推荐流等场景相比，搜索业务的性能优化面临着特殊瓶颈：</p>
<ul>
<li>
<p><strong>难以预取</strong>：推荐场景可以在用户浏览当前内容时，提前加载后续内容，而搜索行为具有瞬时性，无法进行有效的预取。搜索服务端架构团队曾尝试预取优化，但缓存命中率仅有约 10%，效果有限。</p>
</li>
<li>
<p><strong>用户行为的复杂性</strong>：搜索过程中，用户可能随时取消请求，这种不确定性与交互过程中的天然延迟，进一步加大了优化的难度。</p>
</li>
<li>
<p><strong>传统手段效果有限</strong>：在引擎检索层直接增加缓存的方案，虽然能提升速度，但却面临数据时效性的挑战，可能因返回过时结果而损害用户体验，得不偿失。</p>
</li>
</ul>
<h3 data-id="heading-4">4. 抖音搜索的业务特点与优化方向</h3>
<p>和传统搜索相比，抖音搜索有明显的独特性：早期百度、今日头条 PC 端等 WEB 搜索通常展示十条结果，今日头条 APP等咨询类 APP会展示三条左右结果，而抖音搜索以视频内容为主，单条结果的高度很高，用户首屏基本只能看到一条完整结果，下一条仅露出一点点。基于这个特点，搜索服务端架构团队把优化核心从"优化用户获取第一刷十条结果的速度"，调整为"优先优化用户首屏结果的呈现速度"。</p>
<h3 data-id="heading-5">5. 早期性能优化手段实践</h3>
<p>围绕"加速首屏"这一核心目标，抖音搜索服务端架构团队进行了一系列早期的技术探索：</p>
<ul>
<li>
<p><strong>首屏结果拆分：</strong> 用户发起搜索请求后，API 层接收引擎返回的结果，先计算铺满首屏需要 1-2 条数据，然后把打包请求拆成两次 ------ 第一次优先打包首屏数据并返回给 API 层，端上先展现首屏内容，剩余数据后续再返回，用户感知不到后续数据的加载，只觉得首屏数据很快拿到。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7afab4287304307aa74f71ce9c565ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=zauQ9Cbgxy3%2FV9LseeXqykksZD0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>首屏预测优化：</strong> 为了进一步缩短延迟，搜索服务端架构团队引入了预测机制。当用户请求到达 API 层时，系统会并行发起两次请求：一次是常规的在线引擎检索，另一次则是对缓存结果的召回。缓存数据同样会被拆分为首屏和非首屏两部分。然而，为了保证结果的准确性，客户端并不会立即展示缓存数据，而是等待在线检索结果返回。API 层会比对两者，若首屏内容一致，则向客户端发送"命中"信号，使其立即渲染首屏；若不一致，则放弃缓存，等待在线结果。这种"多次请求、多次返回"的交互模式，让搜索服务端架构团队在技术选型上倾向于采用 HTTP Chunked Transfer Encoding 流式返回数据，因为它既避免了独立请求带来的请求量翻倍问题，也规避了多次请求可能路由到不同实例的风险。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/896c41388d4b400ab0013dd961519886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=P7CbxnqDjGvK3yIhbYbVC3aSJps%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>自建打包优化：</strong> 把搜索结果拆成两部分：一部分是能够快速获取的静态元数据，如视频封面、标题文案、点赞评论数等，另一部分则是获取相对耗时的动态视频流数据。核心思路是先返回静态元数据，让用户迅速看到结果的框架，再加载视频流以供播放。然而，在缺少原生 RPC 流式支持的背景下，搜索服务端架构团队不得不采用一种变通方案：通过一次 RPC 调用触发两次独立的打包操作，并将动态视频流数据临时缓存在服务实例的内存中。第二次打包时，通过硬编码的 IP 地址去获取缓存数据。这种设计虽然在当时解决了问题，但无疑增加了架构的复杂性，并引入了潜在的稳定性风险------该方案强依赖服务实例的内存缓存，在实例发生重启或漂移时，存在数据丢失和获取失败的风险。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10efa075aba24fd5adc166f36981d7c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=zdn9SJxS7Fj5SFEDSO%2FNCF6IQek%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-6">二、技术改造：基于 Kitex 流式架构的核心链路重构</h2>
<h3 data-id="heading-7">1. 流式改造的核心动因与思路</h3>
<p>早期的自建打包方案虽然解决了部分问题，但其固有的架构复杂度和稳定性风险，成为了搜索服务端架构团队持续优化的障碍。随着字节跳动内部微服务框架 Kitex 对流式能力的支持日趋成熟，团队决定基于此进行一次彻底的链路重构。
核心思路十分明确：利用 Kitex 流式接口原生的 <strong>会话保持（Session Stickiness）能力</strong> ，将原方案的多次打包与多次请求，优化为 <strong>一次打包、单次连接、流式返回</strong> 的全新模式，从根本上简化架构，消除不稳定性。</p>
<h3 data-id="heading-8">2. 流式架构与传统架构的对比优势</h3>
<p>改造后的新旧架构对比如下，其优势显而易见：</p>
<ul>
<li>
<p><strong>架构更精简</strong>：API 层与 Loader 服务之间不再需要为获取缓存数据而发起二次请求，交互流程大幅简化。</p>
</li>
<li>
<p><strong>稳定性显著提升</strong>：请求量的减少直接降低了 Loader 服务的常驻内存占用。更重要的是，流式长连接确保了会话的稳定性，彻底解决了在服务发布或实例销毁时，因内存数据丢失而导致的二次打包失败问题。</p>
</li>
<li>
<p><strong>服务成功率显著提升</strong>：由于流式连接在会话期间会保持实例存活，老方案中"第二次打包数据获取失败"这一高频痛点被彻底根除，打包成功率得到大幅优化。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8f34518434e441c82bb7fcf3e55fda0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=cSEuVpGIFccK5ASobctOXlva5BA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3. 开发体验与问题排查</h3>
<p>Kitex 流式能力不仅带来了架构上的收益，在开发和运维层面也提供了极大的便利。例如，框架提供的日志可以一键生成流式连接的全生命周期观测图，清晰地展示了服务何时发包、何时收包、何时断开，以及各环节的耗时分布，极大地提升了问题排查的效率。
在改造初期，搜索服务端架构团队曾遇到部分场景下无法收到第二次回包的问题。通过细致排查，最终定位为业务逻辑实现的一个 Bug------在数据尚未完全发送时，请求便意外断开。整个定位过程中因为框架继承了高效的trace能力很快就能对排查方向进行判断并且快速修复。</p>
<h3 data-id="heading-10">4. 流式与非流式协议的性能对比</h3>
<p>在真实业务场景中做了详细对比测试：</p>
<ul>
<li>
<p><strong>CPU 占用：</strong> 无论是客户端还是服务端，流式协议带来的额外 CPU 消耗与非流式场景基本持平，并未引入新的性能负担。</p>
</li>
<li>
<p><strong>RPC 耗时：</strong> 通过 AB 实验验证，流式接口的 P99 耗时劣化不超过 3 毫秒，完全在可接受的范围内。</p>
</li>
<li>
<p><strong>业务收益：</strong> 首屏加载速度 获得了显著提升，在热点卡、活动卡等关键场景， 平均提升 14% 以上 。更重要的是，核心业务指标也获得了显著的正向收益，例如搜索总点击率、热点卡点击 UV 等关键指标均有明显增长。</p>
</li>
</ul>
<h3 data-id="heading-11">5. 基于流式的场景化业务优化</h3>
<p>在完成基础链路的流式改造后，搜索服务端架构团队还针对一些特殊业务场景进行了深度优化。例如，在"抗战胜利80周年阅兵"这类重大活动期间，用户搜索相关关键词时，返回的单条结果卡片可能铺满四倍于常规的屏幕高度。在这种情况下，仅仅打包首屏所需的一两个常规组件是远远不够的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69cb7a5af51945489eaf8e7c624c7c52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=XkZ3pPnjpZme%2F0BDuvE7VLorkb4%3D" alt="" loading="lazy"/></p>
<p>搜索服务端架构团队与热点打包服务团队协作，进一步优化了处理流程：API 层请求 Loader 服务后，Loader 会首先动态计算铺满当前首屏所需的全部组件数量，然后优先返回这部分"首屏"数据，剩余数据则在后台流式返回。这一优化在普通场景下能带来平均 14% 的首屏加速，而在阅兵这类特殊场景下，首屏加速效果可高达 50%——其核心在于，渲染耗时完全取决于首屏所需组件的打包速度，无需再等待全量数据的返回。</p>
<h2 data-id="heading-12">三、未来展望：搜索理想架构的流式演进</h2>
<p>目前，搜索服务端架构团队已经成功完成了搜索打包链路的全面流式化，但优化的脚步并未就此停止。放眼整个搜索链路，引擎检索层作为耗时占比最大的环节，其流式改造将是团队未来的核心攻坚方向。</p>
<p>搜索业务的个性化特征极其显著，这意味着最终结果的呈现，高度依赖于复杂的个性化计算。然而，搜索服务端架构团队也观察到，部分结果形态（如热点卡、活动卡等特型卡片）的确定，并不需要等待全量计算完成，其所需的数据往往能够被快速生成。这类本质上的结构化数据，为团队进一步优化提供了可能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8db443a26b434201b0db179b9b0eeca6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307591&amp;x-signature=IHNqaTW86W9CROZLo03LJVaN4QE%3D" alt="" loading="lazy"/></p>
<p>未来期待将流式改造继续向<strong>上游的引擎层</strong>延伸。搜索服务端架构团队计划将 API 层到引擎层，乃至引擎内部的召回与排序链路，都纳入流式优化的范畴。在理想的模式下，当引擎在进行复杂的个性化检索时，可以优先返回能够快速生成的结构化数据（如特型卡），随后再以流式的方式，返回需要复杂计算的个性化内容。
这种模式不仅能将引擎层的耗时进行有效拆分，更能让下游的打包环节第一时间接收到首屏所需的数据并进行处理，最终实现端到端（End-to-End）的搜索链路性能飞跃，为用户带来更快、更流畅的搜索体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web API 参数验证：原生验证 与 FluentValidation 对比]]></title>    <link>https://juejin.cn/post/7574680270538162176</link>    <guid>https://juejin.cn/post/7574680270538162176</guid>    <pubDate>2025-11-21T04:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574680270538162176" data-draft-id="7574704948153991220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web API 参数验证：原生验证 与 FluentValidation 对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T04:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白气急"/> <meta itemprop="url" content="https://juejin.cn/user/3855363959685260"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web API 参数验证：原生验证 与 FluentValidation 对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3855363959685260/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白气急
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T04:55:36.000Z" title="Fri Nov 21 2025 04:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">原生验证方式</h2>
<p>一般来说，我们对参数做校验时都会采用原生 <code>数据注解+Validator</code> 的方式来进行校验，例如下面的UserDTO</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">record</span> <span class="hljs-title">UserDTO</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
​
    [<span class="hljs-meta">Required(ErrorMessage = <span class="hljs-string">"用户名不能为空"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> UserName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-literal">null</span>!;
​
    [<span class="hljs-meta">Required(ErrorMessage = <span class="hljs-string">"邮箱地址不能为空"</span>)</span>]
    [<span class="hljs-meta">EmailAddress(ErrorMessage = <span class="hljs-string">"邮箱地址格式错误"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Email { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
​
    [<span class="hljs-meta">Required(ErrorMessage = <span class="hljs-string">"描述1不能为空"</span>)</span>]
    [<span class="hljs-meta">StringLength(120, MinimumLength = 1, ErrorMessage = <span class="hljs-string">"描述1长度必须在1~120个字符之间"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Description1 { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-literal">null</span>!;
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Description2 { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
}
</code></pre>
<p>使用时可通过 <code>Validator.TryValidateObject</code> 手动触发验证：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">user</span> = new UserDTO { /* ... */ }<span class="hljs-comment">;</span>
var <span class="hljs-attr">context</span> = new ValidationContext(user)<span class="hljs-comment">;</span>
var <span class="hljs-attr">results</span> = new List&lt;ValidationResult&gt;()<span class="hljs-comment">;</span>
bool <span class="hljs-attr">isValid</span> = Validator.TryValidateObject(user, context, results, validateAllProperties: <span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式对于<strong>单字段的简单规则</strong>（如非空、长度、格式）非常高效。然而，一旦涉及<strong>跨字段的条件验证</strong>，原生机制就显得力不从心。</p>
<p>例如，现在新增一条业务规则：</p>
<blockquote>
<p><strong>只有当 <code>Description1</code> 有值时，<code>Description2</code> 才允许有值；若 <code>Description1</code> 为空，则 <code>Description2</code> 必须为空。</strong></p>
</blockquote>
<p>这时就不太好办了，只能让 DTO 实现 <code>IValidatableObject</code> 接口，在类内部编写验证逻辑</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">record</span> <span class="hljs-title">UserDTO</span> : <span class="hljs-title">IValidatableObject</span> <span class="hljs-comment">//继承 IValidatableObject 接口</span>
{
    <span class="hljs-comment">// ... 属性定义 ...</span>
    
    <span class="hljs-comment">//验证</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;ValidationResult&gt; <span class="hljs-title">Validate</span>(<span class="hljs-params">ValidationContext context</span>)</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(Description1) &amp;&amp; !<span class="hljs-built_in">string</span>.IsNullOrEmpty(Description2))
        {
            <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ValidationResult</span>(<span class="hljs-params">
                <span class="hljs-string">"不能在 Description1 为空的情况下填写 Description2"</span>,
                <span class="hljs-keyword">new</span>[] { <span class="hljs-keyword">nameof</span>(Description1</span>), <span class="hljs-title">nameof</span>(<span class="hljs-params">Description2</span>) })</span>;
        }
    }
    
}
</code></pre>
<p>虽然这是 .NET 官方支持的做法，但在实际项目中会带来一些问题：</p>
<ul>
<li>验证逻辑与数据模型耦合，违反 <strong>单一职责原则（SRP）</strong> 和 <strong>关注点分离（SoC）</strong> ；</li>
<li>条件判断需手动编写 <code>if</code> 语句，规则复杂时代码难以维护；</li>
<li>验证逻辑难以独立测试或复用。</li>
</ul>
<p>社区很多大佬也发现了这些问题，也针对这些痛点开发出了很多实用的验证框架，其中 <strong>FluentValidation</strong> 因其流畅的 API、强大的表达能力，成为广泛采用的解决方案</p>
<h2 data-id="heading-1">FluentValidation验证</h2>
<p>与 .NET 原生的 <code>数据注解+Validator</code> 不同，<code>FluentValidation</code> 将验证逻辑从模型中分离出来，更适合构建<strong>高内聚、低耦合</strong>的应用程序，尤其是在 DDD（领域驱动设计）和 整洁架构<code>(Clean Architecture)</code> 中被广泛采用。以下是它的一些核心特点</p>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>流畅 API</strong></td><td>使用链式语法定义规则，代码直观易读</td></tr><tr><td><strong>验证与模型分离</strong></td><td>验证逻辑写在独立的验证器类中，不污染 DTO/实体</td></tr><tr><td><strong>支持复杂条件验证</strong></td><td>如“字段 A 为空时，字段 B 必填”等跨字段规则</td></tr><tr><td><strong>内置丰富验证规则</strong></td><td>非空、长度、正则、邮箱、范围、集合、异步验证等</td></tr><tr><td><strong>高度可扩展</strong></td><td>支持自定义验证器、条件、消息模板、本地化等</td></tr></tbody></table>
<h3 data-id="heading-2">使用说明</h3>
<p>在使用<code>FluentValidation</code> 时，我们需要对每个业务逻辑或验证对象写出一个对应的继承了<code>AbstractValidator&lt;T&gt;</code>的验证类，并在构造方法中实现验证逻辑，以下还拿前面提到的<code>UserDTO</code>举例</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//移除验证逻辑，只负责作为贫血模型来传输数据</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">record</span> <span class="hljs-title">UserDTO</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> UserName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-literal">null</span>!;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Email { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Description1 { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-literal">null</span>!;
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Description2 { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss">public class UserDTOValidator : AbstractValidator&lt;UserDTO&gt;
{
    public <span class="hljs-built_in">UserDTOValidator</span>()
    {
        <span class="hljs-comment">//非空验证</span>
        <span class="hljs-built_in">RuleFor</span>(x =&gt; x.UserName)
            <span class="hljs-selector-class">.NotNull</span>()<span class="hljs-selector-class">.NotEmpty</span>()<span class="hljs-selector-class">.WithMessage</span>("用户名不能为空");
        
        <span class="hljs-comment">//正则验证 仅作为扩展示例，原模型中不包含此字段</span>
        <span class="hljs-built_in">RuleFor</span>(x =&gt; x.PhoneNumber)
            <span class="hljs-selector-class">.Matches</span>(@"^<span class="hljs-number">1</span>[<span class="hljs-number">3</span>-<span class="hljs-number">9</span>]\d{<span class="hljs-number">9</span>}$")<span class="hljs-selector-class">.WithMessage</span>("手机号格式错误");
        
        <span class="hljs-comment">//邮箱验证</span>
        <span class="hljs-built_in">RuleFor</span>(x =&gt; x.Email)
            <span class="hljs-selector-class">.NotEmpty</span>()<span class="hljs-selector-class">.WithMessage</span>("邮箱不能为空")
            <span class="hljs-selector-class">.EmailAddress</span>()<span class="hljs-selector-class">.WithMessage</span>("邮箱格式不正确");
        
       <span class="hljs-comment">//实现较为复杂验证逻辑的方式1</span>
        <span class="hljs-built_in">RuleFor</span>(x =&gt; x.Description1)
            <span class="hljs-selector-class">.NotEmpty</span>()<span class="hljs-selector-class">.When</span>(x =&gt; !string.IsNullOrWhiteSpace(x.Description2))<span class="hljs-selector-class">.WithMessage</span>("不能在 Description1 为空的情况下填写 Description2");
        
        <span class="hljs-comment">//如果不想使用以上语法的话，可以使用Custom/CustomAsync的方式来进行自定义设置，但是阅读起来比较费劲</span>
        <span class="hljs-built_in">RuleFor</span>(x =&gt; x.Description1)<span class="hljs-selector-class">.Custom</span>((x, context) =&gt;
        {
            <span class="hljs-selector-tag">var</span> model = context<span class="hljs-selector-class">.InstanceToValidate</span>;
            if (!string.IsNullOrWhiteSpace(model.Description2) &amp;&amp; string<span class="hljs-selector-class">.IsNullOrWhiteSpace</span>(model.Description1))
            {
                context<span class="hljs-selector-class">.AddFailure</span>("不能在 Description1 为空的情况下填写 Description2");
            }
        });
    }
}
</code></pre>
<p>除此之外，还有预定义的很多验证方法，例如<code>GreaterThanOrEqualTo</code>验证数值最小值，<code>LessThanOrEqualTo</code>验证数值最大值，对于自定义类使用<code>Must</code>来验证类内部的属性等，在结尾会有常用方法与说明</p>
<h3 data-id="heading-3">使用方式</h3>
<p>定义好<code>UserDTOValidator</code>验证器后，我们可以通过多种方式在应用中执行验证逻辑。常见的方式包括以下几种</p>
<h4 data-id="heading-4">1. 手动调用验证</h4>
<p>这是最基础且简单通用的方式，不依赖框架</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>(<span class="hljs-params">UserDTO user</span>)</span>
{
    <span class="hljs-keyword">var</span> validator = <span class="hljs-keyword">new</span> UserDTOValidator();
    ValidationResult result = validator.Validate(request);
    <span class="hljs-comment">// 或异步验证</span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> validator.ValidateAsync(request);
    <span class="hljs-keyword">if</span> (!result.IsValid)
    {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> failure <span class="hljs-keyword">in</span> result.Errors)
        {
            <span class="hljs-comment">//做对应错误信息处理</span>
            Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{failure.PropertyName}</span>: <span class="hljs-subst">{failure.ErrorMessage}</span>"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-5">2. 通过依赖注入实现验证</h4>
<ol start="0">
<li>
<h5 data-id="heading-6">手动验证</h5>
</li>
</ol>
<p>首先是在Program.cs中注册对应的服务</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//一次性注册全部相关服务的两种方式</span>
<span class="hljs-comment">//第一种</span>
builder<span class="hljs-selector-class">.Services</span><span class="hljs-selector-class">.AddValidatorsFromAssemblyContaining</span>&lt;Program&gt;();<span class="hljs-comment">//其中 Program 是验证类所在的程序集中的类</span>
<span class="hljs-comment">//第二种</span>
builder<span class="hljs-selector-class">.Services</span><span class="hljs-selector-class">.AddValidatorsFromAssembly</span>(typeof(Program)<span class="hljs-selector-class">.Assembly</span>);
</code></pre>
<p>然后在对应Controller中构造出对应服务</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"test"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> : <span class="hljs-title">ControllerBase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IValidator&lt;UserDTO&gt; _validator;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestController</span>(<span class="hljs-params">IValidator&lt;UserDTO&gt; validator</span>)</span>
    {
        _validator = validator; 
    }
​
    [<span class="hljs-meta">HttpPost</span>]
    [<span class="hljs-meta">Route(<span class="hljs-string">"test"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;ActionResult&lt;List&lt;<span class="hljs-built_in">string</span>&gt;&gt;&gt; Test([FromBody] UserDTO request)
    {
        List&lt;<span class="hljs-built_in">string</span>&gt; errors = <span class="hljs-keyword">new</span>();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _validator.ValidateAsync(request);
        <span class="hljs-keyword">if</span>(!result.IsValid)
        {
            result.Errors.ForEach(x =&gt; errors.Add(<span class="hljs-string">$"<span class="hljs-subst">{x.PropertyName}</span>:<span class="hljs-subst">{x.ErrorMessage}</span>"</span>));
            <span class="hljs-keyword">return</span> BadRequest(errors);
        }
        <span class="hljs-keyword">return</span> Ok(result);
    }
}
</code></pre>
<ol start="2">
<li>
<h5 data-id="heading-7">自动验证（不推荐 / 已弃用集成方式）</h5>
<p>官方不再推荐将 FluentValidation 集成到 ASP.NET Core 的内置模型验证管道中，而是建议显式调用验证器。所以对应的实现这里就不举例说明了</p>
</li>
</ol>
<p>以下是官方不推荐的原文以及翻译</p>
<blockquote>
<ul>
<li><strong>The ASP.NET validation pipeline is not asynchronous</strong>: If your validator contains asynchronous rules then your validator will not be able to run. You will receive an exception at runtime if you attempt to use an asynchronous validator with auto-validation. <strong>ASP.NET 验证管道不支持异步操作</strong>：如果你的验证器包含异步规则，则无法通过该管道执行。若在启用自动验证的情况下使用异步验证器，运行时将抛出异常</li>
<li><strong>It is MVC-only</strong>: This approach for auto-validation only works with MVC Controllers and Razor Pages. It does not work with the more modern parts of ASP.NET such as Minimal APIs or Blazor. <strong>仅限 MVC 使用</strong>：此自动验证方式仅适用于 MVC 控制器和 Razor Pages，无法用于 ASP.NET Core 中更现代的编程模型，例如 Minimal API 或 Blazor</li>
<li><strong>It is harder to debug</strong>: The ‘magic’ nature of auto-validation makes it hard to debug/troubleshoot if something goes wrong as so much is done behind the scenes. <strong>调试难度较高</strong>：由于自动验证在幕后隐式执行大量逻辑，其“黑盒”特性使得在出现问题时难以定位和排查错误</li>
</ul>
</blockquote>
<p>因此，在新项目中，推荐采用<strong>依赖注入 + 显式调用 <code>ValidateAsync</code></strong> 的方式，既能支持异步规则，又兼容 Minimal API、Blazor 等架构，同时也便于单元测试和错误定制</p>
<h4 data-id="heading-8">3. 单元测试</h4>
<p>由于验证器是独立类，我们可以轻松为其编写单元测试，无需构造复杂的模型或依赖 Web 上下文</p>
<pre><code class="hljs language-ini" lang="ini">    <span class="hljs-section">[TestMethod]</span>
    public void MyTestMethod()
    {
        // Arrange
        var <span class="hljs-attr">validator</span> = new UserDTOValidator()<span class="hljs-comment">;</span>
​
        // Act
        var <span class="hljs-attr">result</span> = validator.TestValidate(new UserDTO 
        { 
            <span class="hljs-attr">Description1</span> = <span class="hljs-string">""</span>, 
            <span class="hljs-attr">Description2</span> = <span class="hljs-string">"test"</span> 
        })<span class="hljs-comment">;</span>
​
        // Assert
        result.ShouldHaveValidationErrorFor(<span class="hljs-attr">x</span> =&gt; x.Description1)<span class="hljs-comment">;</span>
    }
</code></pre>
<h4 data-id="heading-9">4. 进阶方案：搭配MediatR 中使用</h4>
<p>在 CQRS 模式中，通常在 Command/QueryHandler 前会自动进行验证。 <code>注：MediatR会在后续其它文档中讲述</code></p>
<p>写一个Behavior</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ValidationBehavior</span>&lt;<span class="hljs-title">TRequest</span>, <span class="hljs-title">TResponse</span>&gt; : <span class="hljs-title">IPipelineBehavior</span>&lt;<span class="hljs-title">TRequest</span>, <span class="hljs-title">TResponse</span>&gt;
    <span class="hljs-keyword">where</span> <span class="hljs-title">TRequest</span> : <span class="hljs-title">IRequest</span>&lt;<span class="hljs-title">TResponse</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IEnumerable&lt;IValidator&lt;TRequest&gt;&gt; _validators;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ValidationBehavior</span>(<span class="hljs-params">IEnumerable&lt;IValidator&lt;TRequest&gt;&gt; validators</span>)</span>
    {
        _validators = validators;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TResponse&gt; <span class="hljs-title">Handle</span>(<span class="hljs-params">TRequest request, RequestHandlerDelegate&lt;TResponse&gt; next, CancellationToken ct</span>)</span>
    {
        <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> ValidationContext&lt;TRequest&gt;(request);
        <span class="hljs-keyword">var</span> failures = _validators
            .Select(v =&gt; v.Validate(context))
            .SelectMany(result =&gt; result.Errors)
            .Where(failure =&gt; failure != <span class="hljs-literal">null</span>)
            .ToList();
​
        <span class="hljs-keyword">if</span> (failures.Any())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidationException(failures);
​
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> next();
    }
}
</code></pre>
<p>并且注册对应服务</p>
<blockquote>
<p>builder.Services.AddTransient(typeof(IPipelineBehavior&lt;,&gt;), typeof(ValidationBehavior&lt;,&gt;));</p>
</blockquote>
<p>通过以上几种方式，我们可以灵活地将 FluentValidation 集成到各类 .NET 应用中——无论是简单的控制器手动调用，还是结合 CQRS 模式的自动管道验证。选择哪种方式，取决于项目的架构复杂度和对可维护性的要求。</p>
<hr/>
<h3 data-id="heading-10">附录</h3>
<h4 data-id="heading-11">原生验证与FluentValidation优劣势对比</h4>




























































<table><thead><tr><th>对比维度</th><th>原生验证（Data Annotations）</th><th>FluentValidation</th></tr></thead><tbody><tr><td><strong>定义方式</strong></td><td>在 DTO/Model 类上直接使用特性（<code>[Required]</code>, <code>[EmailAddress]</code>）</td><td>通过独立的验证类（继承 <code>AbstractValidator&lt;T&gt;</code>）集中编写验证逻辑</td></tr><tr><td><strong>代码耦合度</strong></td><td>高：验证逻辑与模型强耦合，违反“关注点分离”原则</td><td>低：验证逻辑与模型完全解耦，模型保持“贫血”和纯净</td></tr><tr><td><strong>可读性与维护性</strong></td><td>简单场景下很清晰，复杂场景难以维护</td><td>验证规则集中、结构清晰，支持链式语法，易于阅读和维护</td></tr><tr><td><strong>条件验证支持</strong></td><td>需要自定义 <code>ValidationAttribute</code></td><td>原生支持 <code>.When()</code>, <code>.Unless()</code> 等条件判断</td></tr><tr><td><strong>异步验证支持</strong></td><td>不支持异步</td><td>支持 <code>ValidateAsync()</code> 和 <code>CustomAsync()</code></td></tr><tr><td><strong>跨属性/复杂业务验证</strong></td><td>困难：需编写自定义验证特性，复用性差</td><td>简单：可在 <code>RuleFor</code> 或 <code>Custom</code> 中直接访问整个对象实例</td></tr><tr><td><strong>测试友好性</strong></td><td>较差：验证逻辑分散在属性上，难以单元测试</td><td>优秀：验证器是独立类，可轻松进行单元测试</td></tr><tr><td><strong>自动集成 MVC 模型验证</strong></td><td>开箱即用</td><td>旧版支持自动集成，新版<strong>不推荐</strong></td></tr><tr><td><strong>学习成本</strong></td><td>低：内置、简单直观</td><td>中：需学习 Fluent API 和验证器注册机制</td></tr><tr><td><strong>适用场景</strong></td><td>简单表单、快速原型、小型项目</td><td>中大型项目、复杂业务规则、需要高可维护性和扩展性的系统</td></tr></tbody></table>
<h4 data-id="heading-12">FluentValidation常用验证方法</h4>





























































































































<table><thead><tr><th>验证方法</th><th>说明</th></tr></thead><tbody><tr><td>NotNull()</td><td>验证值不能为 null</td></tr><tr><td>NotEmpty()</td><td>验证字符串、集合等不能为 null 或空（对字符串调用时等价于 !string.IsNullOrEmpty）</td></tr><tr><td>Empty()</td><td>验证值必须为 null 或空（字符串、集合等）</td></tr><tr><td>Equal(T expected) / Equal(Func&lt;T, TProperty&gt; expression)</td><td>验证值必须等于指定值或另一属性的值</td></tr><tr><td>NotEqual(T unexpected) / NotEqual(Func&lt;T, TProperty&gt; expression)</td><td>验证值不能等于指定值或另一属性的值</td></tr><tr><td>Length(int min, int max)</td><td>验证字符串长度必须在指定范围内（包含边界）</td></tr><tr><td>MinimumLength(int min)</td><td>验证字符串最小长度</td></tr><tr><td>MaximumLength(int max)</td><td>验证字符串最大长度</td></tr><tr><td>Matches(string regex) / Matches(Regex regex)</td><td>验证字符串是否匹配正则表达式</td></tr><tr><td>EmailAddress()</td><td>验证字符串是否为有效电子邮件格式</td></tr><tr><td>CreditCard()</td><td>验证字符串是否为有效的信用卡号（使用 Luhn 算法）</td></tr><tr><td>GreaterThan(T value) / GreaterThan(Expression&lt;Func&lt;T, TProperty&gt;&gt; expression)</td><td>验证值必须大于指定值或另一属性</td></tr><tr><td>GreaterThanOrEqualTo(T value) / GreaterThanOrEqualTo(Expression&lt;Func&lt;T, TProperty&gt;&gt; expression)</td><td>验证值必须大于或等于指定值或另一属性</td></tr><tr><td>LessThan(T value) / LessThan(Expression&lt;Func&lt;T, TProperty&gt;&gt; expression)</td><td>验证值必须小于指定值或另一属性</td></tr><tr><td>LessThanOrEqualTo(T value) / LessThanOrEqualTo(Expression&lt;Func&lt;T, TProperty&gt;&gt; expression)</td><td>验证值必须小于或等于指定值或另一属性</td></tr><tr><td>InclusiveBetween(T from, T to)</td><td>验证值必须在 [from, to] 范围内（包含边界）</td></tr><tr><td>ExclusiveBetween(T from, T to)</td><td>验证值必须在 (from, to) 范围内（不包含边界）</td></tr><tr><td>Must(Func&lt;TProperty, bool&gt; predicate)</td><td>自定义同步验证逻辑（返回 true 表示有效）</td></tr><tr><td>MustAsync(Func&lt;TProperty, CancellationToken, Task&gt; predicate)</td><td>自定义异步验证逻辑</td></tr><tr><td>Custom(Action&lt;TProperty, ValidationContext&gt; action)</td><td>完全自定义验证行为，可添加任意错误信息和属性名</td></tr><tr><td>CustomAsync(Func&lt;TProperty, ValidationContext, CancellationToken, Task&gt; action)</td><td>异步版本的 Custom</td></tr><tr><td>ScalePrecision(int scale, int precision)</td><td>验证 decimal 类型的小数位数（scale）和总位数（precision）</td></tr><tr><td>Cascade(CascadeMode mode)</td><td>设置当前规则的级联模式（Continue/Stop）</td></tr><tr><td>Predicate(Func&lt;T, bool&gt; predicate)</td><td>条件性跳过整个 RuleFor（较少用，通常用 When）</td></tr><tr><td>IsEnumName(bool caseSensitive = false)</td><td>验证字符串是否为枚举的有效名称</td></tr><tr><td>Enum()</td><td>验证值是否为有效枚举值（适用于可空或非可空枚举）</td></tr><tr><td>ChildRules(Action configure)</td><td>对复杂对象属性进行嵌套验证（需配合 SetValidator 或直接内联）</td></tr><tr><td>SetValidator(IValidator validator)</td><td>显式指定子属性的验证器实例</td></tr><tr><td>ForEach(Action&lt;IRuleBuilderInitial&lt;TElement, TElement&gt;&gt; ruleCallback)</td><td>对集合中的每个元素应用验证规则</td></tr></tbody></table>
<blockquote>
<p>注：</p>
<ul>
<li>所有方法均可链式调用，并支持 <code>.WithMessage()</code>、<code>.WithErrorCode()</code> 等自定义错误信息</li>
<li>部分方法（如 <code>NotEmpty</code>）对不同类型的属性（string、IEnumerable、Guid 等）有不同语义</li>
</ul>
</blockquote>
<hr/>
<p><strong>使用框架</strong></p>
<ul>
<li>FluentValidation 12.1.0</li>
<li>FluentValidation.DependencyInjectionExtensions 12.1.0</li>
</ul>
<p><strong>参考链接</strong></p>
<ul>
<li>官方文档：<code>https://docs.fluentvalidation.net</code></li>
<li>GitHub：<code>https://github.com/FluentValidation/FluentValidation</code></li>
<li>博客园-唐青枫：<code>[C#.NET FluentValidation 全面解析：优雅实现对象验证 - 我是唐青枫 - 博客园](https://www.cnblogs.com/TangQF/articles/19154031)</code></li>
</ul>
<blockquote>
<p><strong>版权声明</strong>：本文为个人原创，首发于微信公众号、掘金平台、博客园，作者均为「白气急」。转载请标明出处并附带链接。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VUE3项目配置]]></title>    <link>https://juejin.cn/post/7574869203447595008</link>    <guid>https://juejin.cn/post/7574869203447595008</guid>    <pubDate>2025-11-21T04:44:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574869203447595008" data-draft-id="7574382925761445926" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VUE3项目配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T04:44:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9381691255360"/> <meta itemprop="url" content="https://juejin.cn/user/3485906645565271"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VUE3项目配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485906645565271/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9381691255360
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T04:44:52.000Z" title="Fri Nov 21 2025 04:44:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、安装ESLint</h2>
<h3 data-id="heading-1">1、安装ESLint</h3>
<ol>
<li>下载并安装ESLint。</li>
</ol>
<blockquote>
<p><code>pnpm create @eslint/config@latest</code></p>
</blockquote>
<p>执行命令后，命令运行窗口会要求回答几个问题，回答完成后，就会在当前目录下生成eslint.config.ts配置文件，并且安装eslint相关的插件和依赖包。可以看到package.json文件发生了变化。</p>
<h3 data-id="heading-2">2、配置校验规则</h3>
<ol>
<li>打开eslint.config.ts配置文件。配置全局忽略文件。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig, globalIgnores } <span class="hljs-keyword">from</span> <span class="hljs-string">"eslint/config"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>([
  <span class="hljs-comment">// 默认忽略node_modules</span>
  <span class="hljs-title function_">globalIgnores</span>([<span class="hljs-string">'dist/'</span>]),
  
  ...其他配置...
])
</code></pre>
<ol start="2">
<li>如果有个别需要校验的规则，可以放在rules模块中。</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">defineConfig</span><span class="hljs-params">([
...其他配置...
    {
        rules: {
          <span class="hljs-string">"no-undef"</span>: <span class="hljs-string">"warn"</span>, <span class="hljs-comment">//未定义的变量</span>
          <span class="hljs-string">"no-var"</span>: <span class="hljs-string">"error"</span>, <span class="hljs-comment">//要求使用let或const, 而不是var</span>
        }
    }
    
])</span>
</span></code></pre>
<h3 data-id="heading-3">3、校验并修复</h3>
<ol>
<li>在package.json文件中，找到scripts模块，增加如下配置：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint src --fix"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<ol start="2">
<li>在某个src文件夹下的vue文件或者ts文件中，写一段错误代码，比如 <code>var a = 123</code>。</li>
<li>执行命令 <code>pnpm lint</code>，会对src文件夹下的所有文件按照eslint.config.ts配置文件中配置的校验规则进行校验，在控制台打印出校验不通过的信息。</li>
<li>执行命令 <code>pnpm fix</code>会对部分错误代码进行自动修正。</li>
</ol>
<blockquote>
<p>并不是所有错误都能被自动修正。可以访问官网查看哪些错误能够被自动修正。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Bootstrap框架搭建简单页面：快速构建现代化网站]]></title>    <link>https://juejin.cn/post/7574739133946462250</link>    <guid>https://juejin.cn/post/7574739133946462250</guid>    <pubDate>2025-11-21T04:57:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574739133946462250" data-draft-id="7574734686494064676" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Bootstrap框架搭建简单页面：快速构建现代化网站"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-21T04:57:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Bootstrap框架搭建简单页面：快速构建现代化网站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T04:57:03.000Z" title="Fri Nov 21 2025 04:57:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>在前端开发中，我们常常面临一个难题：如何快速构建一个既美观又能在各种设备上正常显示的网站？传统CSS编写耗时耗力，特别是响应式布局的实现需要大量媒体查询代码。这时，Bootstrap框架应运而生！
Bootstrap是Twitter开发的一个开源前端框架，它提供了一套完整的CSS样式、组件和JavaScript插件，让我们能够快速搭建专业水准的网站，特别适合初学者和需要快速开发的场景。</p>
<h2 data-id="heading-0">Bootstrap核心概念</h2>
<h3 data-id="heading-1">1. 响应式设计</h3>
<p>Bootstrap采用移动优先的设计理念，网站能够自动适应不同尺寸的屏幕，从手机到桌面电脑都能完美显示。</p>
<h3 data-id="heading-2">2. 网格系统</h3>
<p>Bootstrap的核心是12列网格系统，通过行(row)和列(column)的组合来创建页面布局。</p>
<h3 data-id="heading-3">3. 组件库</h3>
<p>提供了丰富的预定义组件，如导航栏、按钮、表单、卡片等，可以直接使用。</p>
<h2 data-id="heading-4">开始使用Bootstrap</h2>
<h3 data-id="heading-5">引入Bootstrap</h3>
<p>首先需要在HTML文件中引入Bootstrap的CSS和JS文件：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的Bootstrap网站<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入Bootstrap CSS --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页面内容 --&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 引入Bootstrap JS 和 Popper --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">完整页面示例</h2>
<p>下面是一个使用Bootstrap搭建的完整简单页面示例：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的Bootstrap网站<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入Bootstrap CSS --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.hero-section</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#6a11cb</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#2575fc</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">100px</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.feature-icon</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#0d6efd</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-tag">footer</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">50px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-brand"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>我的网站<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-toggler"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">data-bs-toggle</span>=<span class="hljs-string">"collapse"</span> <span class="hljs-attr">data-bs-target</span>=<span class="hljs-string">"#navbarNav"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-toggler-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"collapse navbar-collapse"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navbarNav"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav ms-auto"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link active"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>服务<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>联系我们<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主要内容区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 英雄区域 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hero-section text-center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"display-4 fw-bold"</span>&gt;</span>欢迎来到我的网站<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lead"</span>&gt;</span>使用Bootstrap构建的现代化响应式网站<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-light btn-lg mt-3"</span>&gt;</span>了解更多<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 特性介绍 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"py-5"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row text-center mb-5"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我们的服务<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>我们提供全方位的解决方案<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
                    <span class="hljs-comment">&lt;!-- 特性1 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4 mb-4"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card h-100 border-0 shadow-sm"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body text-center"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-icon mx-auto"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"white"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 16 16"</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"</span>/&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>快速开发<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>使用Bootstrap可以快速构建现代化网站，大大缩短开发时间。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>了解更多<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    
                    <span class="hljs-comment">&lt;!-- 特性2 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4 mb-4"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card h-100 border-0 shadow-sm"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body text-center"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-icon mx-auto"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"white"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 16 16"</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"</span>/&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>响应式设计<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>自动适应各种屏幕尺寸，从手机到桌面电脑都能完美显示。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>了解更多<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    
                    <span class="hljs-comment">&lt;!-- 特性3 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4 mb-4"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card h-100 border-0 shadow-sm"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body text-center"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-icon mx-auto"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"white"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 16 16"</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1H2zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"</span>/&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>丰富组件<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>提供丰富的预定义组件，导航栏、按钮、表单等可以直接使用。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>了解更多<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 联系表单 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"py-5 bg-light"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row justify-content-center"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-8"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center mb-4"</span>&gt;</span>联系我们<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-6 mb-3"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"firstName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-label"</span>&gt;</span>名字<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"firstName"</span> <span class="hljs-attr">required</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-6 mb-3"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"lastName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-label"</span>&gt;</span>姓氏<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lastName"</span> <span class="hljs-attr">required</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-3"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-label"</span>&gt;</span>邮箱地址<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-3"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-label"</span>&gt;</span>留言<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"5"</span> <span class="hljs-attr">required</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-grid"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary btn-lg"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 页脚 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span><span class="hljs-symbol">&amp;copy;</span> 2023 我的网站. 保留所有权利.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mt-2"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none me-3"</span>&gt;</span>隐私政策<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none"</span>&gt;</span>使用条款<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 引入Bootstrap JS 和 Popper --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">关键语法：</h2>
<h3 data-id="heading-8">网格系统</h3>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>内容1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>内容2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>内容3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li><code>container</code>：固定宽度的容器</li>
<li><code>row</code>：行，包含一组列</li>
<li><code>col-md-4</code>：在中型设备(md)及以上屏幕占4列（12列网格系统）</li>
</ul>
<h3 data-id="heading-9">组件使用</h3>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-comment">&lt;!-- 导航栏 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 导航内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 卡片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>卡片内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 按钮 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h2 data-id="heading-10">总结：</h2>
<h3 data-id="heading-11">⚠️ 关键要点</h3>
<ol>
<li><strong>移动优先</strong>：样式默认针对手机，大屏通过媒体查询适配</li>
<li><strong>容器选择</strong>：<code>container</code>固定宽度，<code>container-fluid</code>全宽度</li>
<li><strong>类名顺序</strong>：后面的类会覆盖前面的样式</li>
<li><strong>JS依赖</strong>：部分组件需要JavaScript才能正常工作</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web App开发基础知识：从零构建现代化Web应用]]></title>    <link>https://juejin.cn/post/7574734686494097444</link>    <guid>https://juejin.cn/post/7574734686494097444</guid>    <pubDate>2025-11-21T05:05:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574734686494097444" data-draft-id="7574745301724315654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web App开发基础知识：从零构建现代化Web应用"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-21T05:05:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web App开发基础知识：从零构建现代化Web应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:05:13.000Z" title="Fri Nov 21 2025 05:05:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动互联网时代，我们每天都在使用各种Web应用：在线文档、社交媒体、电商平台...这些通过浏览器访问的应用统称为Web App。与传统的网站不同，Web App提供了类似原生应用的交互体验，却无需下载安装。随着PWA（渐进式Web应用）技术的发展，Web App正在变得越来越强大！</p>
<h2 data-id="heading-0">Web App</h2>
<p><strong>Web App</strong>（Web Application）是通过Web技术（HTML、CSS、JavaScript）构建的应用程序，运行在浏览器环境中，具有以下特点：</p>
<ul>
<li><strong>交互性强</strong>：提供丰富的用户交互</li>
<li><strong>数据驱动</strong>：与服务器频繁交换数据</li>
<li><strong>功能完整</strong>：能完成复杂业务逻辑</li>
<li><strong>跨平台</strong>：在任何有浏览器的设备上运行</li>
</ul>
<h2 data-id="heading-1">Web App核心技术栈</h2>
<h3 data-id="heading-2">1. HTML5 - 应用骨架</h3>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的Web App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- PWA配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"manifest"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"manifest.json"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 移动端适配 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"#2196F3"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 应用外壳 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-header"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的任务管理器<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-main"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 动态内容区域 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-footer"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bottom-nav"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item active"</span> <span class="hljs-attr">data-page</span>=<span class="hljs-string">"home"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> <span class="hljs-attr">data-page</span>=<span class="hljs-string">"tasks"</span>&gt;</span>任务<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> <span class="hljs-attr">data-page</span>=<span class="hljs-string">"profile"</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 服务Worker注册 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
            navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2. CSS3 - 应用样式</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 移动优先的响应式设计 */</span>
* {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, Roboto, sans-serif;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
}

<span class="hljs-comment">/* 应用布局 */</span>
<span class="hljs-selector-id">#app</span> {
    <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
}

<span class="hljs-selector-class">.app-header</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#2196F3</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">position</span>: sticky;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}

<span class="hljs-selector-class">.app-main</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">overflow-y</span>: auto;
}

<span class="hljs-selector-class">.app-footer</span> {
    <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
    <span class="hljs-attribute">background</span>: white;
}

<span class="hljs-comment">/* 底部导航 */</span>
<span class="hljs-selector-class">.bottom-nav</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: space-around;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.5rem</span>;
}

<span class="hljs-selector-class">.nav-item</span> {
    <span class="hljs-attribute">background</span>: none;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.5rem</span> <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#2196F3</span>;
    <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-comment">/* 任务列表样式 */</span>
<span class="hljs-selector-class">.task-list</span> {
    <span class="hljs-attribute">list-style</span>: none;
}

<span class="hljs-selector-class">.task-item</span> {
    <span class="hljs-attribute">background</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.5rem</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: space-between;
}

<span class="hljs-selector-class">.task-item</span><span class="hljs-selector-class">.completed</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>;
    <span class="hljs-attribute">text-decoration</span>: line-through;
}

<span class="hljs-comment">/* 响应式设计 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-id">#app</span> {
        <span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>;
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
        <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        <span class="hljs-attribute">min-height</span>: <span class="hljs-number">80vh</span>;
        <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">5vh</span>;
    }
}
</code></pre>
<h3 data-id="heading-4">3. JavaScript - 应用逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 应用状态管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskManager</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'tasks'</span>)) || [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPage</span> = <span class="hljs-string">'home'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
    }

    <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }

    <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 导航事件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.nav-item'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">button</span> =&gt;</span> {
            button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">switchPage</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">page</span>);
            });
        });

        <span class="hljs-comment">// 添加任务事件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'addTaskBtn'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addTask</span>();
        });

        <span class="hljs-comment">// 任务操作事件委托</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'taskList'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'complete-btn'</span>)) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toggleTask</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span>);
            }
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'delete-btn'</span>)) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span>);
            }
        });
    }

    <span class="hljs-title function_">switchPage</span>(<span class="hljs-params">page</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPage</span> = page;
        
        <span class="hljs-comment">// 更新导航状态</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.nav-item'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">btn</span> =&gt;</span> {
            btn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'active'</span>, btn.<span class="hljs-property">dataset</span>.<span class="hljs-property">page</span> === page);
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }

    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>);
        
        <span class="hljs-keyword">switch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPage</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'home'</span>:
                content.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderHome</span>();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'tasks'</span>:
                content.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderTasks</span>();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'profile'</span>:
                content.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderProfile</span>();
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-title function_">renderHome</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> completed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> task.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> total = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span>;
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">`
            &lt;div class="home-page"&gt;
                &lt;div class="stats-card"&gt;
                    &lt;h3&gt;任务统计&lt;/h3&gt;
                    &lt;div class="stats"&gt;
                        &lt;div class="stat-item"&gt;
                            &lt;span class="stat-number"&gt;<span class="hljs-subst">${total}</span>&lt;/span&gt;
                            &lt;span class="stat-label"&gt;总任务&lt;/span&gt;
                        &lt;/div&gt;
                        &lt;div class="stat-item"&gt;
                            &lt;span class="stat-number"&gt;<span class="hljs-subst">${completed}</span>&lt;/span&gt;
                            &lt;span class="stat-label"&gt;已完成&lt;/span&gt;
                        &lt;/div&gt;
                        &lt;div class="stat-item"&gt;
                            &lt;span class="stat-number"&gt;<span class="hljs-subst">${total - completed}</span>&lt;/span&gt;
                            &lt;span class="stat-label"&gt;待完成&lt;/span&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="quick-actions"&gt;
                    &lt;button id="addTaskBtn" class="btn-primary"&gt;添加新任务&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        `</span>;
    }

    <span class="hljs-title function_">renderTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`
            &lt;div class="tasks-page"&gt;
                &lt;div class="task-input"&gt;
                    &lt;input type="text" id="taskInput" placeholder="输入新任务..."&gt;
                    &lt;button id="addTaskBtn" class="btn-primary"&gt;添加&lt;/button&gt;
                &lt;/div&gt;
                
                &lt;ul id="taskList" class="task-list"&gt;
                    <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasks.map(task =&gt; <span class="hljs-string">`
                        &lt;li class="task-item <span class="hljs-subst">${task.completed ? <span class="hljs-string">'completed'</span> : <span class="hljs-string">''</span>}</span>"&gt;
                            &lt;span&gt;<span class="hljs-subst">${task.text}</span>&lt;/span&gt;
                            &lt;div class="task-actions"&gt;
                                &lt;button class="complete-btn" data-id="<span class="hljs-subst">${task.id}</span>"&gt;
                                    <span class="hljs-subst">${task.completed ? <span class="hljs-string">'取消完成'</span> : <span class="hljs-string">'完成'</span>}</span>
                                &lt;/button&gt;
                                &lt;button class="delete-btn" data-id="<span class="hljs-subst">${task.id}</span>"&gt;删除&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/li&gt;
                    `</span>).join(<span class="hljs-string">''</span>)}</span>
                &lt;/ul&gt;
            &lt;/div&gt;
        `</span>;
    }

    <span class="hljs-title function_">renderProfile</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`
            &lt;div class="profile-page"&gt;
                &lt;div class="user-card"&gt;
                    &lt;h3&gt;用户信息&lt;/h3&gt;
                    &lt;p&gt;这是一个简单的Web App示例&lt;/p&gt;
                &lt;/div&gt;
                &lt;div class="app-info"&gt;
                    &lt;h4&gt;关于应用&lt;/h4&gt;
                    &lt;p&gt;版本: 1.0.0&lt;/p&gt;
                    &lt;button id="clearData" class="btn-secondary"&gt;清除所有数据&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        `</span>;
    }

    <span class="hljs-title function_">addTask</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'taskInput'</span>);
        <span class="hljs-keyword">const</span> text = input?.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
        
        <span class="hljs-keyword">if</span> (text) {
            <span class="hljs-keyword">const</span> newTask = {
                <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(),
                <span class="hljs-attr">text</span>: text,
                <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
            };
            
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
            
            <span class="hljs-keyword">if</span> (input) input.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
        }
    }

    <span class="hljs-title function_">toggleTask</span>(<span class="hljs-params">taskId</span>) {
        <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === taskId);
        <span class="hljs-keyword">if</span> (task) {
            task.<span class="hljs-property">completed</span> = !task.<span class="hljs-property">completed</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
        }
    }

    <span class="hljs-title function_">deleteTask</span>(<span class="hljs-params">taskId</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> !== taskId);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }

    <span class="hljs-title function_">saveTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'tasks'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>));
    }
}

<span class="hljs-comment">// 初始化应用</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskManager</span>();
});
</code></pre>
<h3 data-id="heading-5">4. PWA配置文件</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json</span>
<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的任务管理器"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"short_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务管理"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一个简单的任务管理Web App"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"display"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"standalone"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"background_color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"theme_color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#2196F3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"orientation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"portrait"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"src"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-192.png"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"sizes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"192x192"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"src"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-512.png"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"sizes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"512x512"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// sw.js - 服务Worker</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'task-manager-v1'</span>;
<span class="hljs-keyword">const</span> urlsToCache = [
    <span class="hljs-string">'/'</span>,
    <span class="hljs-string">'/index.html'</span>,
    <span class="hljs-string">'/styles.css'</span>,
    <span class="hljs-string">'/app.js'</span>,
    <span class="hljs-string">'/icon-192.png'</span>,
    <span class="hljs-string">'/icon-512.png'</span>
];

<span class="hljs-comment">// 安装Service Worker</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">waitUntil</span>(
        caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(urlsToCache))
    );
});

<span class="hljs-comment">// 拦截请求</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">respondWith</span>(
        caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
                <span class="hljs-comment">// 返回缓存或网络请求</span>
                <span class="hljs-keyword">return</span> response || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>);
            }
        )
    );
});
</code></pre>
<h2 data-id="heading-6">总结</h2>
<h3 data-id="heading-7">🎯 核心概念</h3>
<ul>
<li><strong>Web App</strong> = HTML5 + CSS3 + JavaScript</li>
<li><strong>PWA</strong> = Web App + 原生应用体验</li>
<li><strong>SPA</strong>：单页面应用，动态更新内容</li>
</ul>
<h3 data-id="heading-8">🛠️ 技术要点</h3>
<ul>
<li><strong>HTML5</strong>：语义化标签、离线存储、Service Worker</li>
<li><strong>CSS3</strong>：Flexbox/Grid布局、响应式设计、CSS变量</li>
<li><strong>JavaScript</strong>：ES6+语法、模块化、异步编程、类组件</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《深入理解 JavaScript 对象：属性命名、访问与遍历的那些细节》]]></title>    <link>https://juejin.cn/post/7574680270538194944</link>    <guid>https://juejin.cn/post/7574680270538194944</guid>    <pubDate>2025-11-21T05:08:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574680270538194944" data-draft-id="7574728397373931572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《深入理解 JavaScript 对象：属性命名、访问与遍历的那些细节》"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-21T05:08:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《深入理解 JavaScript 对象：属性命名、访问与遍历的那些细节》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:08:59.000Z" title="Fri Nov 21 2025 05:08:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    23
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 中的对象：从基础到进阶</h2>
<blockquote>
<p>在 JavaScript 中，对象是数据组织的核心方式之一。无论是存储配置信息、封装函数行为，还是构建复杂的类与实例，对象都扮演着不可或缺的角色。本文将带你深入理解 JavaScript 对象的方方面面，包括属性定义、访问方式、命名规则以及遍历技巧。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">对象的创建方式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
<span class="hljs-keyword">let</span> user ={};<span class="hljs-comment">//字面量创建</span>
</code></pre>
<p>通过我们使用花括号来，也就是字面量</p>
<h3 data-id="heading-2">1. 文本和属性</h3>
<p>在 JavaScript 中，对象是由一组 <strong>键值对</strong>（key-value ）组成的集合。每个键被称为“属性名”，对应的值称为“属性值”。<br/>
考虑下面这段代码来进行一个全方位演示</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">"alice@example.com"</span>,
 <span class="hljs-comment">//多词属性</span>
  <span class="hljs-string">"like dogs"</span>:<span class="hljs-literal">true</span>,
};
</code></pre>
<ul>
<li><code>name</code>、<code>age</code>、<code>email</code> 、<code>"like dogs"</code>是属性名</li>
<li><code>"Alice"</code>、<code>25</code>、<code>"alice@example.com"</code> 是属性值</li>
</ul>
<blockquote>
<ul>
<li>当我们使用多字词语来命名属性时，必须加上引号，如代码中的<code>like dogs</code></li>
<li>列表中的最后一个属性应以逗号结尾----这叫做尾随（trailing）或悬挂（hanging）逗号。这样便于我们添加、删除和移动属性，因为所有的行都是相似的。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-3">2. 方括号语法：动态访问属性</h3>
<p>考虑这样一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">"alice@example.com"</span>,
 <span class="hljs-comment">//多词属性</span>
  <span class="hljs-string">"like dogs"</span>:<span class="hljs-literal">true</span>,
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>) <span class="hljs-comment">// Alice</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">age</span>) <span class="hljs-comment">//25</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">like</span> dogs) <span class="hljs-comment">// 会是true吗？</span>

</code></pre>
<p>我们通常都可以通过<code>.</code>符号来访问我们的对象属性，但是考虑上面这段代码，当我们访问name和age时，确实能够访问到<code>name</code> 和<code>age</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93f6693e54834080bfc930298c8c93d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=gwsh8zBvwMlpbvVO8I3crbw%2FyjU%3D" alt="image.png" loading="lazy"/><br/>
但是当我们去使用点符号访问<code>like dogs</code>属性时，就会给出语法错误</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cb72bca032240e49ecb7f3f0b40df11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=98XleTkzGHS2WmxnH4s4zlDt%2BnE%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-4"><strong>背后的原因</strong>：</h5>
<ul>
<li>
<p>由于这是一个多词属性，JavaScript 理解不了。它认为我们在处理 <code>user.likes</code>，然后在遇到意外的 <code>birds</code> 时给出了语法错误。</p>
</li>
<li>
<p>点符号要求 <code>key</code> 是有效的变量标识符。这意味着：不包含空格，不以数字开头，也不包含特殊字符（允许使用 <code>$</code> 和 <code>_</code>）。</p>
</li>
</ul>
<h5 data-id="heading-5"><strong>处理方法</strong>：</h5>
<ul>
<li>通过<strong>方括号</strong>进行访问</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f347760305342efa5e9d3dc2939c7f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=Ua2S1BMoVNh1g7VkkU5nxHxkrqk%3D" alt="image.png" loading="lazy"/><br/>
通过方括号我们可以对多词属性实现和<code>.</code>操作一样的效果，但要<strong>注意</strong>：方括号并不是只用于多词属性，普通属性也可以实现一样的效果，只是因为<code>.</code>操作在我们访问普通属性时更方便</p>
<h4 data-id="heading-6">方括号-计算属性</h4>
<p>当创建一个对象时，我们可以在对象字面量中使用方括号。这叫做 <strong>计算属性</strong>。<br/>
例如这样一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> fruit = apple<span class="hljs-comment">//这里做一个简单的模拟用户输入</span>

<span class="hljs-keyword">let</span> bag = {
  [fruit]: <span class="hljs-number">5</span>, <span class="hljs-comment">// 属性名是从 fruit 变量中得到的</span>
};

<span class="hljs-title function_">alert</span>( bag.<span class="hljs-property">apple</span> ); <span class="hljs-comment">// 5 </span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b44d8b3bddd49a28b505a0665450b20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=o6EIUQ5gILlqwXq%2Fk2AUrbhE5fo%3D" alt="image.png" loading="lazy"/><br/>
<strong>计算属性的含义很简单：<code>[fruit]</code> 含义是属性名应该从 <code>fruit</code> 变量中获取。</strong></p>
<p>我们可以在方括号中使用更复杂的表达式。<br/>
例如这样一段代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d65c2a5043824353bd73dfd3829adb96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=ArTWNssZkAMAQ6yPSxGST1AvJFU%3D" alt="image.png" loading="lazy"/>
通过方括号我们可以实现很多复杂操作，在这里就不一一讲解</p>
<h3 data-id="heading-7">3. 属性值简写（ES6 新特性）</h3>
<p>ES6 引入了简洁的属性值写法，当你需要将变量名直接作为属性名并赋值自身时，可以直接省略冒号和重复的变量名。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> name = <span class="hljs-string">"Bob"</span>;
<span class="hljs-keyword">const</span> age = <span class="hljs-number">30</span>;

<span class="hljs-keyword">const</span> person = {
  name,        <span class="hljs-comment">// 等价于 name: name</span>
  age,         <span class="hljs-comment">// 等价于 age: age</span>
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {     <span class="hljs-comment">// 方法简写</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, I'm <span class="hljs-subst">${name}</span>`</span>;
  }
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>); <span class="hljs-comment">// "Bob"</span>
</code></pre>
<p>这种写法让代码更简洁，特别适合构造函数或组件配置中。</p>
<hr/>
<h3 data-id="heading-8">4. 属性名称限制</h3>
<p>虽然属性名通常是字符串，但并不是所有字符串都能成为合法的属性名。</p>
<h4 data-id="heading-9">合法的属性名：</h4>
<ul>
<li>字母、数字、下划线 <code>_</code>、美元符号 <code>$</code></li>
<li>以字母、下划线或美元符号开头</li>
<li>可以包含 Unicode 字符（如中文）</li>
</ul>
<p><strong>然而，对象中属性不受这些限制</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">for</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">let</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">return</span>: <span class="hljs-number">3</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">for</span>,obj.<span class="hljs-property">let</span>,obj.<span class="hljs-property">return</span>);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9d8b105b44748f08dcca7cea2e8b4f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=abtsjHg%2B1LqTyIX2mFN1%2B9JMdLg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>“整数属性”问题：</strong></p>
<p><strong>一个字符串，如果它可以被转换为整数，再转回字符串时仍然和原来一样，那么它就是一个“整数属性”</strong> 。这类属性在 <code>for...in</code> 遍历时会按数值顺序排列。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-string">"1"</span>: <span class="hljs-string">"one"</span>,
  <span class="hljs-string">"0"</span>: <span class="hljs-string">"zero"</span>,
  <span class="hljs-string">"10"</span>: <span class="hljs-string">"ten"</span>,
  <span class="hljs-string">"2"</span>: <span class="hljs-string">"two"</span>
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key);
}
<span class="hljs-comment">// 输出顺序：0, 1, 2, 10 → 按数值排序</span>
</code></pre>
<p>而像 <code>"1.2"</code> 或 <code>"+49"</code> 则不会被视为整数属性，仍按创建顺序排列。</p>
<hr/>
<h3 data-id="heading-10">5. 属性存在性测试：<code>in</code> 操作符</h3>
<p>相比于其他语言，JavaScript 的对象有一个需要注意的特性：能够被访问任何属性。即使属性不存在也不会报错！读取不存在的属性只会得到 <code>undefined</code>。所以我们可以很容易地判断一个属性是否存在：</p>
<p>但是要检查某个属性是否存在于对象中，我们可以使用也 <code>in</code> 操作符。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"name"</span> <span class="hljs-keyword">in</span> user); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"email"</span> <span class="hljs-keyword">in</span> user); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"toString"</span> <span class="hljs-keyword">in</span> user); <span class="hljs-comment">// true（继承自 Object.prototype）</span>
</code></pre>
<p>为何会有 <code>in</code> 运算符呢？与 <code>undefined</code> 进行比较来判断还不够吗？
是的，大部分时候确实通过undefined判断完全足够，但考虑这样一个特殊情况</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">test</span>: <span class="hljs-literal">undefined</span>
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">test</span>); <span class="hljs-comment">// 显示 undefined，所以属性不存在？</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"test"</span> <span class="hljs-keyword">in</span> obj);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc0c4707d2d7441a8ea451abdea4b214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=lJB%2FpyQG1ZLSQA2WSB1JtGJoa9I%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>所以当值本身为<code>undefined</code>时，我们不能通过这种方式进行断定，虽然这种情况很少发生，但这也正是<code>in</code>为什么特殊的原因</li>
</ul>
<h3 data-id="heading-11">6. “for...in” 循环</h3>
<p><code>for...in</code> 是用来遍历对象所有可枚举属性的循环语句。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, obj[key]);
}
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// a 1</span>
<span class="hljs-comment">// b 2</span>
<span class="hljs-comment">// c 3</span>
</code></pre>
<h4 data-id="heading-12">使用注意事项：</h4>
<ol>
<li><strong>遍历顺序</strong>：
<ul>
<li>整数属性按升序排列（如 <code>"0"</code>, <code>"1"</code>, <code>"10"</code>）</li>
<li>其他属性按创建顺序排列</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> codes = {
  <span class="hljs-string">"49"</span>: <span class="hljs-string">"Germany"</span>,
  <span class="hljs-string">"41"</span>: <span class="hljs-string">"Switzerland"</span>,
  <span class="hljs-string">"44"</span>: <span class="hljs-string">"Great Britain"</span>,
  <span class="hljs-comment">// ..,</span>
  <span class="hljs-string">"1"</span>: <span class="hljs-string">"USA"</span>
};

<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> code <span class="hljs-keyword">in</span> codes) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(code); <span class="hljs-comment">// 1, 41, 44, 49</span>
}

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f5954c905e447f9dc6d4fc32a3efb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309604&amp;x-signature=NopfoIrlLIHAOW0VVyiBnK84KRc%3D" alt="image.png" loading="lazy"/><br/>
2. <strong>避免用于数组</strong>：</p>
<ul>
<li>数组的索引是整数属性，所以 <code>for...in</code> 会按数值排序，但可能误处理 <code>length</code> 或其他非索引属性。</li>
</ul>
<p>推荐使用 <code>for...of</code> 或 <code>Array.forEach()</code> 遍历数组。</p>
<hr/>
<blockquote>
<p>最后：<br/>
JavaScript 的对象看似简单，却蕴含着许多细节。掌握这些知识点不仅能写出更优雅的代码，还能避免潜在的 bug。希望这篇笔记对你有所帮助！</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[希腊字母"Έ"显示不全的奇妙冒险]]></title>    <link>https://juejin.cn/post/7574739133946511402</link>    <guid>https://juejin.cn/post/7574739133946511402</guid>    <pubDate>2025-11-21T05:15:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574739133946511402" data-draft-id="7574821757664772137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="希腊字母&quot;Έ&quot;显示不全的奇妙冒险"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-21T05:15:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android童话镇"/> <meta itemprop="url" content="https://juejin.cn/user/2716247406161241"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            希腊字母"Έ"显示不全的奇妙冒险
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2716247406161241/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android童话镇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:15:07.000Z" title="Fri Nov 21 2025 05:15:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事开始：一个神秘的希腊字符</h2>
<p>在一个Android应用王国里，有一个名叫TextView的小镇，这里住着各种文字居民。有一天，一位来自希腊的贵族字符"Έ"来到了这个小镇。</p>
<p>"Έ"是一个特殊的字符，它有着优雅的曲线和独特的造型。但奇怪的是，每当它在TextView小镇中亮相时，左边的部分总是被神秘地切掉了！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码示例</span>
&lt;TextView
    android:layout_width=<span class="hljs-string">"match_parent"</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span>
    android:text=<span class="hljs-string">"Έλληνικά"</span> /&gt;
</code></pre>
<h2 data-id="heading-1">发现问题：字符的"隐形斗篷"</h2>
<p>为什么"Έ"的左边会被切掉呢？让我们深入了解TextView小镇的运作机制：</p>
<h3 data-id="heading-2">TextView的测量过程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化的测量流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextView</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> {
        <span class="hljs-comment">// 1. 测量文本需要的实际大小</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">desiredWidth</span> <span class="hljs-operator">=</span> measureText(getText());
        <span class="hljs-type">int</span> <span class="hljs-variable">desiredHeight</span> <span class="hljs-operator">=</span> measureTextHeight(getText());
        
        <span class="hljs-comment">// 2. 根据layout_width决定最终宽度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">widthMode</span> <span class="hljs-operator">=</span> MeasureSpec.getMode(widthMeasureSpec);
        <span class="hljs-type">int</span> <span class="hljs-variable">widthSize</span> <span class="hljs-operator">=</span> MeasureSpec.getSize(widthMeasureSpec);
        
        <span class="hljs-keyword">switch</span> (widthMode) {
            <span class="hljs-keyword">case</span> MeasureSpec.EXACTLY:  <span class="hljs-comment">// 固定尺寸</span>
                mWidth = widthSize;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MeasureSpec.AT_MOST:  <span class="hljs-comment">// 最大不超过</span>
                mWidth = Math.min(desiredWidth, widthSize);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MeasureSpec.UNSPECIFIED:  <span class="hljs-comment">// 想要多大就给多大</span>
                mWidth = desiredWidth;
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<p>当使用<code>match_parent</code>时，TextView的宽度被限制在父容器的范围内。如果希腊字符"Έ"需要的宽度超过了可用空间，它的左边部分就会被无情地裁剪！</p>
<h2 data-id="heading-3">解决方案：两个超级英雄登场</h2>
<h3 data-id="heading-4">英雄1：wrap_content - "自适应斗篷"</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// wrap_content的魔法</span>
&lt;TextView
    android:layout_width=<span class="hljs-string">"wrap_content"</span>  <span class="hljs-comment">// 关键改变！</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span>
    android:text=<span class="hljs-string">"Έλληνικά"</span> /&gt;
</code></pre>
<p><code>wrap_content</code>就像一个智能的伸缩斗篷，它会说："让我看看'Έ'字符到底需要多大的空间，我就给它多大的空间！"</p>
<h3 data-id="heading-5">英雄2：gravity=end - "右对齐导航员"</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 完整的解决方案</span>
&lt;TextView
    android:layout_width=<span class="hljs-string">"wrap_content"</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span>
    android:gravity=<span class="hljs-string">"end"</span>  <span class="hljs-comment">// 另一个关键改变！</span>
    android:text=<span class="hljs-string">"Έλληνικά"</span> /&gt;
</code></pre>
<p><code>gravity=end</code>则像一个聪明的导航员，它确保文本在TextView内部从右侧开始排列，这样"Έ"字符就有足够的左边空间来完整展示自己！</p>
<h2 data-id="heading-6">深入原理：字符绘制的秘密</h2>
<h3 data-id="heading-7">字符测量的挑战</h3>
<p>希腊字符"Έ"（Unicode: \u0388）是一个特殊的组合字符，它在字体中的边界(bounds)可能超出了基线(baseline)的左侧：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 字符边界测量示例</span>
<span class="hljs-type">Paint</span> <span class="hljs-variable">paint</span> <span class="hljs-operator">=</span> textView.getPaint();
<span class="hljs-type">Rect</span> <span class="hljs-variable">bounds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>();
paint.getTextBounds(<span class="hljs-string">"Έ"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, bounds);

<span class="hljs-comment">// 结果可能是：</span>
<span class="hljs-comment">// bounds.left = -5 (超出左侧边界！)</span>
<span class="hljs-comment">// bounds.right = 8</span>
<span class="hljs-comment">// 总宽度 = 13</span>
</code></pre>
<h3 data-id="heading-8">wrap_content + gravity=end的工作原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextView</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">layoutText</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. wrap_content确保有足够空间</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">availableWidth</span> <span class="hljs-operator">=</span> getWidth() - getPaddingLeft() - getPaddingRight();
        <span class="hljs-type">int</span> <span class="hljs-variable">textWidth</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getPaint().measureText(getText());
        
        <span class="hljs-comment">// 2. gravity=end控制绘制位置</span>
        <span class="hljs-type">int</span> drawX;
        <span class="hljs-keyword">switch</span> (getGravity() &amp; Gravity.HORIZONTAL_GRAVITY_MASK) {
            <span class="hljs-keyword">case</span> Gravity.END:
                <span class="hljs-comment">// 从右侧开始绘制，确保左边有足够空间</span>
                drawX = getPaddingLeft() + availableWidth - textWidth;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> Gravity.START:
                drawX = getPaddingLeft();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> Gravity.CENTER:
                drawX = getPaddingLeft() + (availableWidth - textWidth) / <span class="hljs-number">2</span>;
                <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-comment">// 3. 在计算的位置绘制文本</span>
        canvas.drawText(getText(), drawX, baseline, getPaint());
    }
}
</code></pre>
<h2 data-id="heading-9">时序图：完整的调用过程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51f91de1df3c494e821c2f1e47c16339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOerpeivnemVhw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306907&amp;x-signature=hyB8%2BdsBLyHc%2FDz6hIuGBhLX%2Bs8%3D" alt="希腊字母显示不全解决.png" loading="lazy"/></p>
<h2 data-id="heading-10">实际代码演示</h2>
<p>让我们创建一个完整的示例来验证这个解决方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreekTextActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        
        <span class="hljs-comment">// 创建布局</span>
        <span class="hljs-type">LinearLayout</span> <span class="hljs-variable">layout</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayout</span>(<span class="hljs-built_in">this</span>);
        layout.setOrientation(LinearLayout.VERTICAL);
        
        <span class="hljs-comment">// 问题示例：左边被裁剪</span>
        <span class="hljs-type">TextView</span> <span class="hljs-variable">problemText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextView</span>(<span class="hljs-built_in">this</span>);
        problemText.setLayoutParams(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayout</span>.LayoutParams(
            ViewGroup.LayoutParams.MATCH_PARENT,
            ViewGroup.LayoutParams.WRAP_CONTENT));
        problemText.setText(<span class="hljs-string">"问题: Έλληνικά"</span>);
        problemText.setBackgroundColor(<span class="hljs-number">0xFFFFCCCC</span>);
        
        <span class="hljs-comment">// 解决方案：wrap_content + gravity=end</span>
        <span class="hljs-type">TextView</span> <span class="hljs-variable">solutionText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextView</span>(<span class="hljs-built_in">this</span>);
        LinearLayout.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayout</span>.LayoutParams(
            ViewGroup.LayoutParams.WRAP_CONTENT,
            ViewGroup.LayoutParams.WRAP_CONTENT);
        params.gravity = Gravity.END; <span class="hljs-comment">// 布局级别的gravity</span>
        solutionText.setLayoutParams(params);
        solutionText.setText(<span class="hljs-string">"解决方案: Έλληνικά"</span>);
        solutionText.setGravity(Gravity.END); <span class="hljs-comment">// 文本级别的gravity</span>
        solutionText.setBackgroundColor(<span class="hljs-number">0xFFCCFFCC</span>);
        
        layout.addView(problemText);
        layout.addView(solutionText);
        setContentView(layout);
    }
}
</code></pre>
<h2 data-id="heading-11">调试技巧：验证解决方案</h2>
<p>如果你想要亲眼看到这个效果，可以添加调试代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调试字符边界</span>
<span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> findViewById(R.id.my_text_view);
<span class="hljs-type">Paint</span> <span class="hljs-variable">paint</span> <span class="hljs-operator">=</span> textView.getPaint();

<span class="hljs-comment">// 测量单个字符</span>
<span class="hljs-type">Rect</span> <span class="hljs-variable">bounds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>();
paint.getTextBounds(<span class="hljs-string">"Έ"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, bounds);
Log.d(<span class="hljs-string">"TextViewDebug"</span>, <span class="hljs-string">"字符'Έ'边界: left="</span> + bounds.left + 
    <span class="hljs-string">", right="</span> + bounds.right + <span class="hljs-string">", width="</span> + bounds.width());

<span class="hljs-comment">// 测量整个文本</span>
<span class="hljs-type">float</span> <span class="hljs-variable">textWidth</span> <span class="hljs-operator">=</span> paint.measureText(<span class="hljs-string">"Έλληνικά"</span>);
Log.d(<span class="hljs-string">"TextViewDebug"</span>, <span class="hljs-string">"整个文本宽度: "</span> + textWidth);

<span class="hljs-comment">// 检查TextView的实际宽度</span>
textView.post(() -&gt; {
    Log.d(<span class="hljs-string">"TextViewDebug"</span>, <span class="hljs-string">"TextView宽度: "</span> + textView.getWidth());
    Log.d(<span class="hljs-string">"TextViewDebug"</span>, <span class="hljs-string">"可用绘制宽度: "</span> + 
        (textView.getWidth() - textView.getPaddingLeft() - textView.getPaddingRight()));
});
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>通过这个有趣的故事，我们学到了：</p>
<ol>
<li><strong>问题根源</strong>：希腊字符"Έ"可能有左边的溢出区域，在固定宽度的TextView中会被裁剪</li>
<li><strong>wrap_content的作用</strong>：让TextView根据内容自动调整宽度，确保字符有足够的展示空间</li>
<li><strong>gravity=end的妙用</strong>：让文本从右侧开始排列，为左边的溢出区域预留空间</li>
<li><strong>组合使用</strong>：这两个属性配合使用，就像给特殊字符穿上了一件合身的"定制礼服"</li>
</ol>
<p>现在，TextView小镇里的"Έ"字符终于可以完整地展示它的优雅身姿了！这就是Android布局系统中小小属性解决大问题的美妙之处。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 可以预判你的预判？Kotlin 高级特性 之 Contracts]]></title>    <link>https://juejin.cn/post/7574775334680952842</link>    <guid>https://juejin.cn/post/7574775334680952842</guid>    <pubDate>2025-11-21T05:29:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574775334680952842" data-draft-id="7574724406305996850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 可以预判你的预判？Kotlin 高级特性 之 Contracts"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2025-11-21T05:29:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Entropless"/> <meta itemprop="url" content="https://juejin.cn/user/3518885279826078"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 可以预判你的预判？Kotlin 高级特性 之 Contracts
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3518885279826078/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Entropless
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:29:25.000Z" title="Fri Nov 21 2025 05:29:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：</h2>
<p>你是否曾将 <code>if (obj != null)</code>提取成一个独立函数后，Kotlin 的智能转换（Smart Cast）就神奇地“失效”了？这不是编译器的bug，而是它的能力边界。Kotlin Contracts 正是打破这道边界的神奇钥匙。本文将基于 Kotlin 最新版本 v2.2.21 全面讲解 Kotlin Contracts 的所有特性及其使用方式。</p>
<blockquote>
<p>本文基于Android Studio Otter | 2025.2.1  &amp;   Kotlin v2.2.21</p>
</blockquote>
<h2 data-id="heading-1">What?</h2>
<p>Contracts(契约) 是一种<strong>编译时机制</strong>，是一种让编译器更了解函数行为的特性，它允许函数作者明确地告诉编译器一些关于函数行为的约束，从而帮助编译器进行更准确的类型推断和智能转换。</p>
<blockquote>
<p>嗯…… 不懂， 说人话！</p>
</blockquote>
<p>首先我们先从它的效果来直观了解一下吧</p>
<p>先看两个示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">(s: <span class="hljs-type">String</span>?)</span></span> {
    <span class="hljs-comment">// 编译器自动将's'转换为了'String' 而不是'String?'</span>
    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) s.length 
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(v：View?)</span></span> {
    <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">is</span> TextView) {
        <span class="hljs-comment">// 编译器自动将 'v' 转换为了'View',因此可以直接调用TextView 的方法</span>
        v.setText(<span class="hljs-string">"TextView"</span>) 
    }
}
</code></pre>
<p>以上两个示例表明 Kotlin 编译器可以智能的根据上下文的类型检查条件来自动的进行类型转化，这是因为 Kotlin 编译器会进行大量的静态分析，这就是 Kotlin 编译器的智能转换。</p>
<blockquote>
<p>What ?  这我知道呀，用你说? 这里面也没有 Contracts 呀？</p>
</blockquote>
<p>别急，上面的示例虽然可以利用 Kotlin 的自动的智能转换，但是一旦将这个功能提取到一个单独的函数中时，这些智能转换功能就消失了，且看：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNotNull</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">(s: <span class="hljs-type">String</span>?)</span></span> {
    <span class="hljs-keyword">if</span> (s.isNotNull()) s.length <span class="hljs-comment">// No smartcast :(</span>
}
</code></pre>
<p>因此为了改善这种情况，Kotlin 在 1.3  版本 中引入了 <strong><code>Contracts</code></strong> 机制。</p>
<h2 data-id="heading-2">Why?</h2>
<p>上面对于 Contracts 是什么的解释其实也同时回答了为什么会有 Contracts ，但看到这里有人可能还会有疑问，为什么单独拿到一个函数中，这种「智能转换」就失效了，原因其实很简单，因为这个「新函数」是你自己写的，Kotlin 编译器无法 100% 的确认你的 <code>isNotNull</code> 函数真的可以产生对应的效果，因此需要开发者通过一种途径也就是「Contracts」来明确这一点，并且在Kotlin官方文档中也明确表示 「编写正确合理的 Contracts 是程序员的责任」</p>
<p>总结：</p>
<p><strong><code>Contracts</code></strong> 允许函数的作者(也就是阁下😎) 以编译器能够理解的方式 <strong>显示的</strong> 描述你所写的这个函数的行为。</p>
<p>说白了就是：你可以用 Contracts 这个东西来告诉 Kotlin 的编译器，你声明的函数是干什么用的。比如上面的 <code>isNotNull</code> 这个函数，你在没有使用 Contracts 之前，这个函数的作用只是为了给<strong>其他的开发者或者你自己看</strong>的，用来告诉调用者这个函数如果返回 <code>true</code> 就说明传入的参数不为空，但是，编译器并不知道，所以使用 Contracts 来让 Kotlin 编译器也能看懂你这个函数的作用。</p>
<h2 data-id="heading-3">How?</h2>
<p>以上只是介绍了 Contracts 支持的其中一种情况，Kotlin 中称为 Effect（效果），Kotlin 使用 <strong><code>Effect</code></strong> 接口来定义函数可能表现出的种种情况。截止到这篇文章发布时, Kotlin 的最新稳定版本是 Kotlin v2.2.21，在 Kotlin v2.2.20 中Contracts 新增了多项重大更新，在最新版的 Kotlin 中 Effect 目前定义了五种具体的 Effect ****（其在<code>kotlin-stdlib</code>标准库的<code>kotlin.contract</code> 包中定义），它们都是继承自 Effect 的接口</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fcore%2Fkotlin-stdlib%2Fkotlin.contracts%2F-simple-effect%2Findex.html" target="_blank" title="https://kotlinlang.org/api/core/kotlin-stdlib/kotlin.contracts/-simple-effect/index.html" ref="nofollow noopener noreferrer">SimpleEffect</a>
<ul>
<li>Returns</li>
<li>ReturnsNotNull</li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fcore%2Fkotlin-stdlib%2Fkotlin.contracts%2F-conditional-effect%2Findex.html" target="_blank" title="https://kotlinlang.org/api/core/kotlin-stdlib/kotlin.contracts/-conditional-effect/index.html" ref="nofollow noopener noreferrer">ConditionalEffect</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fcore%2Fkotlin-stdlib%2Fkotlin.contracts%2F-calls-in-place%2Findex.html" target="_blank" title="https://kotlinlang.org/api/core/kotlin-stdlib/kotlin.contracts/-calls-in-place/index.html" ref="nofollow noopener noreferrer">CallsInPlace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fcore%2Fkotlin-stdlib%2Fkotlin.contracts%2F-holds-in%2Findex.html" target="_blank" title="https://kotlinlang.org/api/core/kotlin-stdlib/kotlin.contracts/-holds-in/index.html" ref="nofollow noopener noreferrer">HoldsIn</a></li>
</ul>
<p>分别介绍一下：</p>
<h3 data-id="heading-4"><code>SimpleEffect : Effect</code></h3>
<p>这表示一种简单的效果，其中包含以下两种具体效果：</p>
<ul>
<li>
<p><strong><code>Returns : SimpleEffect</code></strong></p>
<p>Returns接口有两种实现（所有继承Effect 的接口都通过 在<code>ContractsBuilder</code> 接口中实现）</p>
<ol>
<li>
<p><code>returns(): Returns</code></p>
<p>它表示函数正常返回(即不抛出异常)，它通常与 <code>implies</code> 结合使用，implies 表示「暗示」，意思就是告诉编译器 如果函数能正常返回则暗示着什么结果，函数调用处后面就会自动确认是这个结果</p>
<p>应用场景：API 中的参数验证、构建器中的状态检查。在Kotlin标准库中，<code>require</code> 函数使用此效果进行前置条件强制。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">require</span><span class="hljs-params">(condition: <span class="hljs-type">Boolean</span>)</span></span> {
    contract { 
		    <span class="hljs-comment">// 如果函数正常返回，则意味着函数调用者传入的条件是true</span>
        returns() implies condition  
    }
    <span class="hljs-comment">//否则抛出异常</span>
    <span class="hljs-keyword">if</span> (!condition) <span class="hljs-keyword">throw</span> IllegalArgumentException()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">example</span><span class="hljs-params">(x: <span class="hljs-type">String</span>?)</span></span> {
    require(x != <span class="hljs-literal">null</span>)
    <span class="hljs-comment">// 通过Contract编译器知道x非空，因为require正常返回意味着x != null为true</span>
    println(x.length) <span class="hljs-comment">// 智能转换为非空</span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">//kotlin.contracts.Effect.kt 部分源码</span>
<span class="hljs-meta">@ContractsDsl</span>
<span class="hljs-meta">@ExperimentalContracts</span>
<span class="hljs-meta">@SinceKotlin(<span class="hljs-string">"1.3"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimpleEffect</span> : <span class="hljs-type">Effect</span> {
    <span class="hljs-meta">@ContractsDsl</span>
    <span class="hljs-meta">@ExperimentalContracts</span>
    <span class="hljs-comment">//infix 表示这是个中缀函数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">implies</span><span class="hljs-params">(booleanExpression: <span class="hljs-type">Boolean</span>)</span></span>: ConditionalEffect
}
</code></pre>
<blockquote>
<p>PS:   <code>returns() implies condition</code> 这种写法能够成立是因为 implies 是一个中缀函数，它等同于 <code>returns().implies(condition)</code>
可以明显的看出来，中缀函数的好处是能更形象的表达出中缀函数 前后两者的关系</p>
</blockquote>
</li>
<li>
<p><code>returns(value: Any?): Returns</code></p>
</li>
</ol>
<p>表示函数正常返回，并且返回值是 value， 并且在返回该值 暗示条件，它适用于谓词函数(过滤，条件判断等功能的函数，返回值是 Boolean)</p>
<p>应用场景：类型守卫、资格检查。增强复杂条件中的流类型分析。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)
<span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isUser</span><span class="hljs-params">(user: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
    contract { returns(<span class="hljs-literal">true</span>) implies (user <span class="hljs-keyword">is</span> User) }
    <span class="hljs-keyword">return</span> user <span class="hljs-keyword">is</span> User
}
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(user: <span class="hljs-type">Any</span>?)</span></span> {
    <span class="hljs-keyword">if</span> (isUser(user) &amp;&amp; user.age &gt; <span class="hljs-number">18</span>) {
        println(<span class="hljs-string">"Hello, adult user：<span class="hljs-subst">${user.age}</span>"</span>)
    }
}
</code></pre>
<p>另外Strings.kt 源码中也有类似使用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@kotlin</span>.<span class="hljs-keyword">internal</span>.InlineOnly
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CharSequence?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    contract {
        returns(<span class="hljs-literal">false</span>) implies (<span class="hljs-keyword">this</span><span class="hljs-symbol">@isNullOrEmpty</span> != <span class="hljs-literal">null</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.length == <span class="hljs-number">0</span>
}
</code></pre>
</li>
<li>
<p><strong><code>ReturnsNotNull : SimpleEffect</code></strong></p>
<p>它描述的是函数正常返回(不抛异常)，并且返回值是非空的情况，官方文档说 <code>returnsNotNull()</code> 是 v2.2.20 中新增的函数，但<code>ReturnsNotNull</code> 这个Effect 在 Kotlin 1.3 中的源码中就已经有了，下面我们来分开说一下：：</p>
<ul>
<li>
<p>Kotlin v2.2.20 以下版本中的 <code>returnsNotNull()</code> :</p>
<ol>
<li>
<p>单独使用这个效果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nonNullIfValid</span><span class="hljs-params">(input: <span class="hljs-type">String</span>?)</span></span>: String {
    contract {
        returnsNotNull()  <span class="hljs-comment">// 表示函数总是返回非空（如果不抛异常）</span>
    }
    <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span> || input.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
    <span class="hljs-keyword">return</span> input
}
</code></pre>
<p>看到这个代码，可能有人就发现了：</p>
<blockquote>
<p>这不是脱裤子放屁吗，<code>nonNullIfValid</code> 的返回值已经声明是 <code>String</code> 了，表明它不会返回空值了呀</p>
</blockquote>
<p>确实，单独使用 <code>returnsNotNull()</code> 确实没有实际的应用场景，因此它通常与 implies 来结合使用，如同 <code>returns()</code> 和 <code>returns(value)</code> 一样</p>
</li>
<li>
<p><code>returnsNotNull() impiles condition</code></p>
<p>效果在左，条件在右，表示当函数返回非空值时 意味着 condition 这个条件是成立的。</p>
<p>应用场景：适用于“事后验证”（post-condition），从输出推断输入。适合谓词函数或处理器，当返回非空时，反推输入满足条件（如类型/非空）。常见于库 API 中，帮助调用者避免冗余检查。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processIfValid</span><span class="hljs-params">(input: <span class="hljs-type">Any</span>?)</span></span>: String? {
    contract {
        <span class="hljs-comment">// 如果返回非空，则 input 是非空 String</span>
        returnsNotNull() implies (input != <span class="hljs-literal">null</span> &amp;&amp; input <span class="hljs-keyword">is</span> String)
    }
    <span class="hljs-keyword">if</span> (input !<span class="hljs-keyword">is</span> String) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> input.trim()  <span class="hljs-comment">// 返回非空 String</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useProcess</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>?)</span></span> {
    <span class="hljs-keyword">val</span> result = processIfValid(obj)
    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 编译器智能推断 obj 是非空 String（因为返回非空 ⇒ 条件真）</span>
        println(<span class="hljs-string">"useProcess:<span class="hljs-subst">${obj.length}</span>"</span>)  <span class="hljs-comment">// 无需 !! 或额外检查</span>
    }
}
</code></pre>
</li>
</ol>
</li>
<li>
<p>Kotlin 2.2.20 及以上版本中，returnsNotNull() 增加了新的使用方法及使用场景，也就是条件在左，效果在右： <code>(condition) implies returnsNotNull()</code></p>
<p>含义：如果 condition 成立则函数返回非空值。</p>
<ul>
<li>
<p>这是一种“正向推断”：从已知条件推断返回行为。</p>
</li>
<li>
<p>编译器使用它来优化：当调用前条件已验证（如 通过 if 检查），则返回智能转换为非空类型，避免 ? 或 !!。</p>
</li>
</ul>
<blockquote>
<p>PS：与 v 2.2.20 之前的版本对比：</p>
<p><code>returnsNotNull() impiles condition</code> ：// 自 Kotlin 1.3，SimpleEffect 接口的方法</p>
<p><code>(condition) implies returnsNotNull()</code> ：// Kotlin 2.2.20 新增，Boolean 的扩展函数</p>
<p>两者虽然都使用的是 <code>implies</code> 这个中缀函数，但实际上这两个根本不是同一个函数 <code>(condition) implies returnsNotNull()</code> 中的 implies 是 v2.2.20 在 ContractBuilder 接口中新增的一个 infix 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-comment">/**
     * 指定当作为接收器参数传递的条件成立时，将观察到的效果。
     * 目前仅支持ReturnsNotNull效果。
     * Note: 接收器只能接受 boolean 类型的表达式，并且接收器或者叫函数参数会经历下面
     * 两种处理：
     * 空检查 (`== null`, `!= null`);
     * 实例检查 (`is`, `!is`);
     */</span>
    <span class="hljs-meta">@ExperimentalExtendedContracts</span>
    <span class="hljs-meta">@ContractsDsl</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Boolean</span>.<span class="hljs-title">implies</span><span class="hljs-params">(value: <span class="hljs-type">ReturnsNotNull</span>)</span></span>
</code></pre>
<p>而<code>returnsNotNull() impiles condition</code> 中的 implies 则是 SimpleEffect 接口中的一个方法，这点将在下面的 ConditionalEffect 中详细讲解。</p>
</blockquote>
<p>应用场景：可空输入非空输出，适合处理可空输入的工具函数，当输入满足条件时，直接保证输出非空。替换了传统需要两个重载函数（可空版和非空版）的场景，提升代码简洁性。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class, 
		ExperimentalExtendedContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decode</span><span class="hljs-params">(encoded: <span class="hljs-type">String</span>?)</span></span>: String? {
    contract {
        <span class="hljs-comment">//输入是非空时，保证输出非空</span>
        (encoded != <span class="hljs-literal">null</span>) implies (returnsNotNull())
    }
    <span class="hljs-keyword">if</span> (encoded == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> java.net.URLDecoder.decode(encoded, <span class="hljs-string">"UTF-8"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useDecodedValue</span><span class="hljs-params">(s: <span class="hljs-type">String</span>?)</span></span> {
    <span class="hljs-comment">//未判断输入非空时，函数需要使用'?'安全调用</span>
    decode(s)?.length
    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 判断后编译器通过智能转换，返回值视为非空！</span>
        println(<span class="hljs-string">"decode length:<span class="hljs-subst">${decode(s).length}</span>"</span>)
    }
}
</code></pre>
<p>细心的人可能注意到 这个 <code>decode</code> 方法比之前的示例多了一个 注解<code>@OptIn(ExperimentalExtendedContracts::class)</code> 这是因为 <code>(condition) implies returnsNotNull()</code> 这种用法是 Kotlin2.2.20 新增的实验性的扩展功能</p>
<p>并且如果要启用这个功能，需要在项目的<code>build.gradle(.kts)</code> 中额外的添加编译器选项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xallow-condition-implies-returns-contracts"</span>)
    }
}
</code></pre>
<blockquote>
<p>⚠️ PS：
截至文章发布时，我使用的是 AndroidStudio 最新版：Android Studio Otter | 2025.2.1  ，官方文档提示：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jetbrains.com%2Fidea%2Fnextversion%2F%3F_cl%3DMTsxOzE7d2JDOWl2ZFpvUlJ4UWQ3MlFLN0tQRWQxeEVSdFVGU0JDOGZhenpIV3U2YkxvMnhibWRwd05WOXR4SnIxWVdTazs%3D%26_gl%3D1*k7ja7k*_gcl_au*MTczODY1NDU0MC4xNzYyMzEyNDg0*_ga*MTE4NjA5NjIzMy4xNzI0MTMzODM2*_ga_9J976DJZ68*czE3NjM1Mzk2ODMkbzI2JGcxJHQxNzYzNTQwODE0JGozNyRsMCRoMA.." target="_blank" title="https://www.jetbrains.com/idea/nextversion/?_cl=MTsxOzE7d2JDOWl2ZFpvUlJ4UWQ3MlFLN0tQRWQxeEVSdFVGU0JDOGZhenpIV3U2YkxvMnhibWRwd05WOXR4SnIxWVdTazs=&amp;_gl=1*k7ja7k*_gcl_au*MTczODY1NDU0MC4xNzYyMzEyNDg0*_ga*MTE4NjA5NjIzMy4xNzI0MTMzODM2*_ga_9J976DJZ68*czE3NjM1Mzk2ODMkbzI2JGcxJHQxNzYzNTQwODE0JGozNyRsMCRoMA.." ref="nofollow noopener noreferrer">IntelliJ IDEA 目前仅在2025.3 EAP 版本</a> 对新增的功能进行代码提示的更新，AndroidStudio 是跟随 IDEA 的，因此需要如果你当前也和我一样使用的是同一版本或者更低的 AndroidStudio ，那么你可能也会遇到以下问题：
即便已经标记了 <code>@OptIn(ExperimentalExtendedContracts::class)</code>  并且也在<code>build.gradle(.kts)</code> 中添加了上面的编译器选项，IDE 仍然会提示错误： ‘ implies 的这种用法不是 Contracts 的合法语句’，不用担心，只要你配置正确，可以无视这个报错，直接编译运行不会出错，等到后期 AS 更新后这个错误自然会消失</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/993845e7049f4af19c3eb4ea648ad73b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRW50cm9wbGVzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764307974&amp;x-signature=DurD4kLJ%2BrsgnH1iyVmFp5%2Fx2AI%3D" alt="image.png" loading="lazy"/></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5"><code>ConditionalEffect : Effect</code> (<code>implies</code>)</h3>
<p>它也是一种效果，但是一种和其它效果组合产生的效果，它所表达的含义是：使其它效果条件化。它是通过 SimpleEffect 的 <code>implies</code> 函数来实现的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@ContractsDsl</span>
<span class="hljs-meta">@ExperimentalContracts</span>
<span class="hljs-meta">@SinceKotlin(<span class="hljs-string">"1.3"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimpleEffect</span> : <span class="hljs-type">Effect</span> {
    <span class="hljs-meta">@ContractsDsl</span>
    <span class="hljs-meta">@ExperimentalContracts</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">implies</span><span class="hljs-params">(booleanExpression: <span class="hljs-type">Boolean</span>)</span></span>: ConditionalEffect
}
</code></pre>
<p>也就是： <code>simpleEffect implies (booleanExpression: Boolean)</code>  如果函数的某个 SimpleEffect (<code>Returns || Returns(value) || ReturnsNotNull</code> )成立，那么意味着 后面的 boolean 表达式就是成立的，可以看到这里的 <code>implies</code> 函数返回的就是<code>ConditionalEffect</code> 。这个整体所表达的就是一个 <code>ConditionalEffect</code> (条件化的效果)。</p>
<h3 data-id="heading-6"><code>CallsInPlace : Effect</code></h3>
<p>它的含义是：对于带有高阶函数(函数类型参数，也就是Lambda)参数的函数，开发者可以告诉编译器这个函数中的某个<strong>高阶函数</strong> 在当前这个函数中被调用了，并且可以指定被调用的次数（通过 <code>InvocationKind</code> 枚举）。</p>
<p><code>InvocationKind</code>：lambda 在函数中被调用的次数，包括 <code>EXACTLY_ONCE</code>（有且仅有一次）、<code>AT_MOST_ONCE</code>（至多一次）、<code>AT_LEAST_ONCE</code>（至少一次）、<code>UNKNOWN</code>（未知，默认）。</p>
<p>使用场景：</p>
<ul>
<li>你希望接收一个 lambda，并希望编译器知道这个 lambda 会被立即/一次性执行，从而改进对在 lambda 中进行变量初始化分析</li>
<li>在 kotlin 标准库中的 <code>run</code>, <code>apply</code>, <code>also</code>, <code>let</code> 这类控制流函数就使用了 callsInPlace()</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initSafely</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    contract {
		    <span class="hljs-comment">//这里告诉编译器，将保证在当前这个函数内部调用且仅调用一次 block</span>
        callsInPlace(block, InvocationKind.EXACTLY_ONCE)
    }
    block()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> message: String?
    initSafely {
        message = <span class="hljs-string">"Hello, World!"</span> <span class="hljs-comment">// 编译器知道这个 lambda 会执行一次</span>
    }
    println(<span class="hljs-string">"message is <span class="hljs-variable">$message</span>"</span>) <span class="hljs-comment">// 可以安全使用</span>
}
</code></pre>
<blockquote>
<p>PS: 注意，在 Kotlin 1.3 官方文档关于 CallsInPlace 的示例中(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fwhatsnew13.html%23contracts" target="_blank" title="https://kotlinlang.org/docs/whatsnew13.html#contracts" ref="nofollow noopener noreferrer">kotlinlang.org/docs/whatsn…</a>)，有一个明显错误，它在  <code>callsInPlace{}</code>  中指定了<code>EXACTLY_ONCE</code> 但是在 contract 外部却没有调用 block，这应该是笔误，大家如果看到不要被误导！</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">synchronize</span><span class="hljs-params">(lock: <span class="hljs-type">Any</span>?, block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// It tells the compiler:</span>
    <span class="hljs-comment">// "This function will invoke 'block' here and now, and exactly one time"</span>
    contract { callsInPlace(block, EXACTLY_ONCE) }
    <span class="hljs-comment">//*没有实际调用 block()！！！*</span>
}
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Int</span>
    synchronize(lock) {
        x = <span class="hljs-number">42</span> <span class="hljs-comment">// Compiler knows that lambda passed to 'synchronize' is called</span>
               <span class="hljs-comment">// exactly once, so no reassignment is reported</span>
    }
    println(x) <span class="hljs-comment">// Compiler knows that lambda will be definitely called, performing</span>
               <span class="hljs-comment">// initialization, so 'x' is considered to be initialized here</span>
}
</code></pre>
</blockquote>
<h3 data-id="heading-7"><code>HoldsIn : Effect</code></h3>
<p>这是 Kotlin v2.2.20 中新增的一个重要的 Effect，它表示在带有高阶函数(lambda)参数的函数中，开发者告诉编译器：我能保证在传入的这个 lambda 中，某个 boolean 表达式的结果为<code>true</code>！，然后编译器就可以在这个 lambda 内部智能的认为 condition 为 true，而不会再需要开发者在 lambda 内部进行 condition 的条件判断，它通常和上面的 <code>callsInPlace</code> 结合使用</p>
<p>语法：<code>condition holdsIn block</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalContracts::class, ExperimentalExtendedContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">alsoIf</span><span class="hljs-params">(condition: <span class="hljs-type">Boolean</span>, block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T {
    contract {
        <span class="hljs-comment">// 声明这个 lambda 在这个函数中最多被调用一次</span>
        callsInPlace(block, InvocationKind.AT_MOST_ONCE)
        <span class="hljs-comment">// 声明在lambda内部假设条件为真</span>
        condition holdsIn block
    }
    <span class="hljs-comment">//开发者来实际自己保证在contract中的承诺</span>
    <span class="hljs-keyword">if</span> (condition) block(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useApplyIf</span><span class="hljs-params">(input: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">val</span> result = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
        .first()
        .alsoIf(input <span class="hljs-keyword">is</span> <span class="hljs-built_in">Int</span>) {
            <span class="hljs-comment">// 输入参数在lambda内部被智能转换为Int，可以直接和列表中第一个元素相加</span>
            println(<span class="hljs-string">"holdIn:<span class="hljs-subst">${input + it}</span>"</span>)
        }
        .toString()
}
</code></pre>
<p>这也是Kotlin 2.2.20 中的一个实验的扩展功能，因此也必须额外添加 <code>@OptIn(ExperimentalExtendedContracts::class)</code> 注解</p>
<p>同时也须要在<code>build.gradle(.kts)</code> 中添加额外的编译器选项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xallow-holdsin-contract"</span>)
    }
}
</code></pre>
<blockquote>
<p>⚠️ PS：同样的，这与 <code>condition implies returnsNotNull()</code>  的问题一样，在当前最新的 AS 中仍然会报错，如果配置正确，可以忽略 IDE 报错警告！</p>
</blockquote>
<h3 data-id="heading-8">Kotlin 2.2.20 关于 Contracts 的其它新特性</h3>
<h4 data-id="heading-9">支持在属性访问器和操作符中使用 Contracts</h4>
<p>将 Contracts 的使用扩展到属性的getter方法和以下操作符 中</p>
<ul>
<li><code>invoke</code></li>
<li><code>contains</code></li>
<li><code>rangeTo</code>，<code>rangeUntil</code></li>
<li><code>componentN</code></li>
<li><code>iterator</code></li>
<li><code>unaryPlus</code>，，<code>unaryMinusnot</code></li>
<li><code>inc</code>，<code>dec</code></li>
</ul>
<p>示例（<code>getter</code>）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> Any?.isNonNullString: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
        contract { returns(<span class="hljs-literal">true</span>) implies (<span class="hljs-keyword">this</span><span class="hljs-symbol">@isNonNullString</span> <span class="hljs-keyword">is</span> String) }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> String
    }
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useProp</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>?)</span></span> {
    <span class="hljs-keyword">if</span> (obj.isNonNullString) {
        <span class="hljs-comment">// obj 智能转换为 String</span>
        println(obj.length)
    }
}
</code></pre>
<p>示例（<code>invoke</code>）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Runner</span> {
    <span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invoke</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        contract {
            callsInPlace(block, InvocationKind.EXACTLY_ONCE)
        }
        block()
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testOperator</span><span class="hljs-params">(runner: <span class="hljs-type">Runner</span>)</span></span> {
    <span class="hljs-keyword">val</span> number: <span class="hljs-built_in">Int</span>
    runner {
        number = <span class="hljs-number">1</span>
    }
    <span class="hljs-comment">// </span>
    println(number)
    <span class="hljs-comment">// 1</span>
}
</code></pre>
<p>同样的，要启用这些功能也需要添加额外的编译器选项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xallow-contracts-on-more-functions"</span>)
    }
}
</code></pre>
<h4 data-id="heading-10">泛型类型断言</h4>
<p>由于泛型类型擦除的特性，因此在这之前我们无法 写出 <code>value is List&lt;String&gt;</code> 这种代码，现在Kotlin 2.2.20 的 Contracts 新增了 泛型类型断言 这一功能，因此我们就可以在 contract{ } 内部写出这样的代码了。</p>
<p>通过contracts，你可以在一个函数里声明：<strong>如果函数返回某值 (比如 <code>true</code>) 或发生某 effect，那么 <code>this</code> 或函数参数在类型上满足某个泛型类型</strong>。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Failure</span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpError</span>(<span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>) : Failure()
    <span class="hljs-comment">// Insert other failure types here</span>
}
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T, out F : Failure</span>&gt; {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T, <span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Failed</span>&lt;<span class="hljs-type">F : Failure</span>&gt;(<span class="hljs-keyword">val</span> failure: F) : Result&lt;<span class="hljs-built_in">Nothing</span>, F&gt;()
}
<span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, F : Failure&gt;</span> Result<span class="hljs-type">&lt;T, F&gt;</span>.<span class="hljs-title">isHttpError</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    contract {
	    <span class="hljs-comment">// 使用Contracts 来断言泛型类型, 此处编译器将不再报错(仅限于 contract 内部)</span>
        returns(<span class="hljs-literal">true</span>) implies (<span class="hljs-keyword">this</span><span class="hljs-symbol">@isHttpError</span> <span class="hljs-keyword">is</span> Result.Failed&lt;Failure.HttpError&gt;)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> Result.Failed &amp;&amp; <span class="hljs-keyword">this</span>.failure <span class="hljs-keyword">is</span> Failure.HttpError
}
</code></pre>
<p>同样的，要启用这些功能也需要添加额外的编译器选项（与操作符中的编译选项一致）</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xallow-contracts-on-more-functions"</span>)
    }
}
</code></pre>
<blockquote>
<p>⚠️ PS: 与 其它 Kotlin 2.2.20新增的特性一样，在当前最新的 AS 中泛型断言特性，IDE仍然会 提示错误：<code>Error in contract description: instance check for erased type.</code> 如果配置正确，可以忽略 IDE 报错警告！</p>
</blockquote>
<p>上面的示例的含义是：开发者告诉编译器，我确定调用 isHttpError 的这个 result 是 <code>Result.Failed&lt;Failure.HttpError&gt;</code>的一个实例</p>
<p>这个断言不是真在运行时检查类型 (像 <code>reified</code> 那样)，而是 <strong>编译时 (或静态分析) 提示编译器</strong> “我承诺这种类型关系在满足合约时成立”。编译器据此可以做智能推断 、类型安全分析等。</p>
<p><strong>与 <code>reified</code> 的区别 :</strong></p>
<p>先简单介绍下 reified :</p>
<p>由于泛型类型擦除的原因，<strong>在普通 (non-inline) 函数里</strong>你无法在运行时做 <code>value is T</code> 这样的类型检查 ，因为 <code>T</code> 在运行时的信息不可用。</p>
<ul>
<li>
<p>Kotlin 引入了 <code>reified</code> 关键字 + <code>inline</code> 函数来“实化”类型参数。所谓实化，就是编译器在调用处把函数展开 (inline)，并用实际类型把类型参数替换。这样在调用点，类型是具体的，而不是泛型参数。</p>
</li>
<li>
<p>举例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">isType</span><span class="hljs-params">(item: <span class="hljs-type">Any</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
  <span class="hljs-keyword">return</span> item <span class="hljs-keyword">is</span> T
}
</code></pre>
<p>当你调用 <code>isType&lt;String&gt;("hello")</code> 时，编译器把这一调用处内联展开，变成类似 <code>"hello" is String</code>，类型检查就能在运行时执行。</p>
</li>
<li>
<p><strong>限制</strong>：</p>
<ul>
<li><code>reified</code> 只能和 <code>inline</code> 一起使用，因为需要将函数展开</li>
<li>即便如此，你也不能对 <strong>带泛型参数</strong>完全检查所有层级。例如，你不能在 reified 函数中安全地做 <code>value is List&lt;String&gt;</code>，因为泛型参数 <code>&lt;String&gt;</code> 仍被擦除，你可以检查的是 <code>List&lt;*&gt;</code> 这样的原始类型</li>
</ul>
</li>
</ul>
<p>因此，inline + reified 与 Contracts 的泛型类型断言 解决的问题是不相同的，是两个无关的功能</p>
<p>至此，截至最新的 Kotlin ，Contras 的所有功能已经讲述完毕！</p>
<h2 data-id="heading-11">自定义 Contracts</h2>
<p>Kotlin 标准库内部已经在很多基础函数中使用了 Contracts ,即使大家不了解这个特性，但可能早就已经在项目中间接用上了这个特性。</p>
<p>上面我们已经了解了基于最新版 Kotlin 中 Contracts 的所有特性，其实我们已经发现了 自定义 Contracts 的一些要求和限制，需要注意什么、能做什么、不能做什么，现在总结一下：</p>
<ol>
<li>
<p>实验性：<code>@OptIn(ExperimentalContracts::class)</code></p>
<ul>
<li>Kotlin Contracts 是实验性的(Experimental)，所以在你自定义的 Contracts 所在的函数上面必须声明：<code>@OptIn(ExperimentalContracts::class)</code> 注解。</li>
<li>另外，如果使用Kotlin 2.2.20 中新增的函数(<code>condition implies returnsNotNull()</code> 和 <code>holdsIn</code>) 需要额外再添加<code>@OptIn(ExperimentalExtendedContracts::class)</code> 注解，并且Kotlin 2.2.20 所有的新特性都要添加对应的 编译器选项。</li>
<li>由于是实验特性，其语法、行为在未来 Kotlin 版本可能发生变动。</li>
<li>编译器是无条件信任合法的 Contracts 的，不会在运行时强制验证你的合约是否真的被满足，因此开发者需要自己负责使用了<strong>自定义的Contracts 的函数</strong>中的逻辑正确性。</li>
</ul>
</li>
<li>
<p>Contracts 块的位置和语法要求：</p>
<ul>
<li>
<p><code>contract { … }</code> 必须是函数体内的第一条语句</p>
</li>
<li>
<p><code>contract { … }</code> 内部只能使用<code>ContractBuilder</code> 接口中定义了的effect 方法以及 继承了 Effect 接口的所有 Effect ( <code>returns()</code>, <code>returns(value:Any?)</code>, <code>returnsNotNull()</code>, <code>simpleEffect implies condition</code>,<code>condition implies returnsNotNull()</code>,<code>callsInPlace(...)</code>, <code>holdsIn</code>)</p>
</li>
<li>
<p><code>contract { … }</code> 内只能引用当前函数的参数，不能引用局部变量和其它作用域变量</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">example</span><span class="hljs-params">(param1: <span class="hljs-type">String</span>?, param2: <span class="hljs-type">Int</span>)</span></span> {
    contract {
        <span class="hljs-comment">// ✅ 只能引用函数参数</span>
        returns() implies (param1 != <span class="hljs-literal">null</span>)
        
        <span class="hljs-comment">// ❌ 不能引用局部变量或其他作用域的变量</span>
        <span class="hljs-comment">// returns() implies (localVar != null)  // 错误</span>
    }
    <span class="hljs-keyword">val</span> localVar = <span class="hljs-string">"test"</span>
}
</code></pre>
</li>
<li>
<p>类型检查表达式限制：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">example</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>?)</span></span> {
    contract {
        <span class="hljs-comment">// ✅ 允许：简单的类型检查</span>
        returns() implies (obj <span class="hljs-keyword">is</span> String)
        returns() implies (obj != <span class="hljs-literal">null</span>)
        
        <span class="hljs-comment">// ❌ 限制：复杂的表达式</span>
        <span class="hljs-comment">// returns() implies (obj.toString().length &gt; 5)  // 错误</span>
        <span class="hljs-comment">// returns() implies (someFunction(obj))         // 错误</span>
    }
}
</code></pre>
</li>
<li>
<p>Contract {} 内的代码只会影响编译器，不会影响运行时，因为<code>contract { … }</code> 本身在字节码中没有运行时逻辑 (即标准库中 <code>contract { … }</code> 是空实现) ，它是给编译器看的 DSL</p>
</li>
</ul>
</li>
<li>
<p>函数类型限制：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 支持：顶层函数、成员函数、扩展函数</span>
<span class="hljs-comment">// 以及 Kotlin2.2.20 中新增的 getter和操作符函数（参见 2.2.20 Contracts 新特性）</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">topLevelFunction</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">memberFunction</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* ... */</span> }
}
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">extensionFunction</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// ❌ 不支持：局部函数、匿名函数、lambda 表达式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">outerFunction</span><span class="hljs-params">()</span></span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">localFunction</span><span class="hljs-params">()</span></span> {
        contract { <span class="hljs-comment">/* ... */</span> }  <span class="hljs-comment">// 编译错误</span>
    }
}
</code></pre>
</li>
</ol>
<p>以上是就是我对 Kotlin Contracts 的所有讲解，希望能帮到大家，Kotlin Contracts 是一个相比其它特性较为冷门的高级特性，并且对于自定义 Contracts 至今仍然是 实验性的，大家有什么自己的见解或者对本文内容有不同的理解，欢迎讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCVSharp：BRISK特征检测]]></title>    <link>https://juejin.cn/post/7574869203447693312</link>    <guid>https://juejin.cn/post/7574869203447693312</guid>    <pubDate>2025-11-21T05:15:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574869203447693312" data-draft-id="7574704948154023988" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCVSharp：BRISK特征检测 "/> <meta itemprop="keywords" content="OpenCV"/> <meta itemprop="datePublished" content="2025-11-21T05:15:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCVSharp：BRISK特征检测 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:15:58.000Z" title="Fri Nov 21 2025 05:15:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>BRISK（Binary Robust Invariant Scalable Keypoints）是一种快速、高效的特征检测和描述算法，由Stefan Leutenegger等人于2011年提出。它属于二进制特征描述符家族，与SIFT、SURF等浮点型特征描述符相比，具有计算速度快、内存占用小的特点。</p>
<p>BRISK是一种平衡了速度和性能的特征检测算法，特别适合需要实时处理的应用场景。虽然其精度可能不如SIFT或SURF，但在许多实际应用中，其速度优势更为重要。在OpenCV中，BRISK被广泛应用于需要快速特征检测和匹配的计算机视觉任务中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d210977bd1d8474ca1047fb245d62b2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306957&amp;x-signature=zPQxtJvBkAIUETsA2W3C4%2Fw0YxU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">实践</h2>
<p>示例中的核心代码很少：</p>
<pre><code class="hljs language-scss" lang="scss">using <span class="hljs-selector-tag">var</span> brisk = BRISK<span class="hljs-selector-class">.Create</span>();
KeyPoint<span class="hljs-selector-attr">[]</span> keypoints = brisk<span class="hljs-selector-class">.Detect</span>(gray);

if (keypoints != null)
{
    <span class="hljs-selector-tag">var</span> <span class="hljs-attribute">color</span> = new <span class="hljs-built_in">Scalar</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>);
    foreach (KeyPoint kpt in keypoints)
    {
        <span class="hljs-attribute">float</span> r = kpt<span class="hljs-selector-class">.Size</span> / <span class="hljs-number">2</span>;
        Cv2<span class="hljs-selector-class">.Circle</span>(dst, (Point)kpt<span class="hljs-selector-class">.Pt</span>, (int)r, <span class="hljs-attribute">color</span>);
        Cv2<span class="hljs-selector-class">.Line</span>(dst,
            (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y + r),
            (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y - r),
            <span class="hljs-attribute">color</span>);
        Cv2<span class="hljs-selector-class">.Line</span>(dst,
            (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y + r),
            (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y - r),
            <span class="hljs-attribute">color</span>);
    }
}
</code></pre>
<p>OpenCVSharp中封装了一个BRISK，现在来看看这个类的Create方法：</p>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BRISK <span class="hljs-title">Create</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> thresh = <span class="hljs-number">30</span>, <span class="hljs-built_in">int</span> octaves = <span class="hljs-number">3</span>, <span class="hljs-built_in">float</span> patternScale = <span class="hljs-number">1.0f</span></span>)</span>
  {
      NativeMethods.HandleException(
          NativeMethods.features2d_BRISK_create1(thresh, octaves, patternScale, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> ptr));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BRISK(ptr);
  }
</code></pre>
<p>先了解一下参数的意义：</p>
<p><strong>thresh（AGAST检测阈值）</strong></p>
<p>基于AGAST（Adaptive and Generic Accelerated Segment Test）算法的阈值，用于判断像素点是否为角点，控制特征点检测的敏感度。</p>
<p>较低值（如10-20）：检测更多特征点，但可能包含噪声</p>
<p>较高值（如40-60）：检测更少但更稳定的特征点</p>
<p><strong>octaves（检测八度数）</strong></p>
<p>构建图像金字塔，在不同尺度上检测特征点，控制多尺度检测的层数。</p>
<p>0：仅进行单尺度检测，速度最快</p>
<p>1-4：多尺度检测，能识别不同大小的特征</p>
<p>更高值：增加尺度范围但降低性能</p>
<p><strong>patternScale（采样模式缩放）</strong></p>
<p>BRISK使用特定的采样模式来计算描述符，此参数控制该模式的缩放，整特征点邻域采样模式的缩放比例。</p>
<p><code>&lt; 1.0</code>：更密集的采样，可能提高精度但降低速度</p>
<p><code>&gt; 1.0</code>：更稀疏的采样，提高速度但可能降低精度</p>
<p>再来看一下Detect方法：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function"><span class="hljs-keyword">public</span> KeyPoint[] <span class="hljs-title">Detect</span>(<span class="hljs-params">Mat image, Mat? mask = <span class="hljs-literal">null</span></span>)</span>
 {
     <span class="hljs-keyword">if</span> (image <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(image));
     ThrowIfDisposed(https:<span class="hljs-comment">//www.falvce.com/);</span>

     image.ThrowIfDisposed();
     <span class="hljs-keyword">try</span>
     {
         <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> keyPoints = <span class="hljs-keyword">new</span> VectorOfKeyPoint();
         NativeMethods.HandleException(
             NativeMethods.features2d_Feature2D_detect_Mat1(ptr, image.CvPtr, keyPoints.CvPtr, Cv2.ToPtr(mask)));
         <span class="hljs-keyword">return</span> keyPoints.ToArray(https:<span class="hljs-comment">//www.falvce.com/);</span>
     }
     <span class="hljs-keyword">finally</span>
     {
         GC.KeepAlive(<span class="hljs-keyword">this</span>);
         GC.KeepAlive(image);
         GC.KeepAlive(mask);
     }
 }
</code></pre>
<p>直接使用这个方法就可以获取特征点：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e856a5da7a94418a9fae4374d526e65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306957&amp;x-signature=if%2FAVI1sE6%2FHKQCElJ5xM7Uys4I%3D" alt="" loading="lazy"/></p>
<p>然后在图像上显示这些特征点即可得到上面的图。</p>
<p>我看到说BRISK可以用于物体识别，我在想既然会生成特征点，那么肯定可以进行特征点匹配，这样能不能拿两张图去匹配，比如两个人有两张不同的照片能不能识别出是同一个人呢？</p>
<p>我做了一个简单的Demo，但是效果其实不好：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/608e4c90eaae42de86a9a643d0958a2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306957&amp;x-signature=pKQLe%2BIf79G0TQrdBij39tRKgfA%3D" alt="" loading="lazy"/></p>
<p>没有后面DrawBestMatchRectangle这个示例的效果好，后面这个示例使用的是ORB，然后也有使用汉明匹配，等后面再介绍。</p>
<p>DrawBestMatchRectangle示例效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a7ef353a94047be906c679b355f9178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764306957&amp;x-signature=8PwEJYrElG28eUfpYnmexr1d%2Bqk%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何提高 IPA 安全性 面向工程团队的多层安全策略与工具协同方案]]></title>    <link>https://juejin.cn/post/7574869203447857152</link>    <guid>https://juejin.cn/post/7574869203447857152</guid>    <pubDate>2025-11-21T05:48:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574869203447857152" data-draft-id="7574869203447840768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何提高 IPA 安全性 面向工程团队的多层安全策略与工具协同方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T05:48:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星星电灯猴"/> <meta itemprop="url" content="https://juejin.cn/user/2848205394945444"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何提高 IPA 安全性 面向工程团队的多层安全策略与工具协同方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2848205394945444/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星星电灯猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:48:49.000Z" title="Fri Nov 21 2025 05:48:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 项目的安全体系中，“如何提高 IPA 的安全性”常常被误解为“找一个加固工具处理一下”。
但从工程角度来看，IPA 的安全性属于<strong>整体链路问题</strong>：
涉及构建、符号、资源、运行时、签名、逆向对抗、以及线上治理等多个环节。</p>
<p>想真正提升 IPA 的安全性，需要从“单点防护”升级为“多层安全策略 + 多工具联动 + 可回滚的工程体系”。</p>
<p>本文基于实际工程团队经验，总结一套可落地、可复制、可维护的 IPA 安全方案。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 IPA 安全性？</h2>
<p>IPA 安全性可以拆解为六类目标：</p>
<h3 data-id="heading-1"><strong>1. 代码安全（防逆向、降低符号可读性）</strong></h3>
<ul>
<li>方法名、类名、变量名可被逆向工具轻松识别</li>
<li>Swift/ObjC 符号泄漏结构信息</li>
</ul>
<h3 data-id="heading-2"><strong>2. 资源安全（防替换、防注入、防二次打包）</strong></h3>
<ul>
<li>图片、JS、JSON 等可直接替换</li>
<li>H5 混合应用容易被篡改</li>
</ul>
<h3 data-id="heading-3"><strong>3. 完整性安全（防伪造、重签、二次分发）</strong></h3>
<h3 data-id="heading-4"><strong>4. 动态对抗（提高 Hook 难度）</strong></h3>
<h3 data-id="heading-5"><strong>5. 线上可维护性（崩溃可符号化、可回滚）</strong></h3>
<h3 data-id="heading-6"><strong>6. 自动化能力（可集成 CI/CD）</strong></h3>
<p>这些能力必须通过工具组合才能实现。</p>
<hr/>
<h2 data-id="heading-7">二、IPA 安全提升所需的工具体系</h2>
<p>一个完整的方案需要如下工具协作：</p>








































<table><thead><tr><th>工具类型</th><th>代表工具</th><th>作用</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF、class-dump</td><td>发现风险面、确定白名单</td></tr><tr><td>成品混淆（核心）</td><td><strong>Ipa Guard CLI</strong></td><td>无需源码对 IPA 混淆、资源扰动</td></tr><tr><td>资源保护</td><td>Ipa Guard 资源模式</td><td>修改 MD5、重命名 H5/JS/图片</td></tr><tr><td>重签验证</td><td>kxsign</td><td>混淆后签名、安装、测试</td></tr><tr><td>逆向验证</td><td>Frida、Hopper</td><td>测试混淆效果、验证阻力</td></tr><tr><td>映射治理</td><td>KMS、Sentry/Bugly</td><td>管理符号映射、保障可回滚</td></tr></tbody></table>
<p>下面进入实际流程部分。</p>
<hr/>
<h2 data-id="heading-8">三、提高 IPA 安全性的完整工程流程（可直接复用）</h2>
<h2 data-id="heading-9"><strong>步骤 1：使用 MobSF + class-dump 做静态扫描</strong></h2>
<p>目的：</p>
<ul>
<li>找到暴露的 Swift/ObjC 符号</li>
<li>分析 H5、JS、JSON 等资源依赖</li>
<li>明确 Storyboard、反射调用、桥接 API 等白名单</li>
<li>初步判断风险面</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span>-dump app.ipa &gt; symbols.txt
</code></pre>
<p>生成的数据是后续混淆必需的依据。</p>
<hr/>
<h2 data-id="heading-10"><strong>步骤 2（可选）：对源码做基础混淆（如有权限）</strong></h2>
<p>如果你有源码（不是每个团队都有），可以使用：</p>
<ul>
<li>Swift Shield（重命名 Swift 类/属性/方法）</li>
<li>obfuscator-llvm（控制流混淆、字符串保护）</li>
<li>自定义脚本（常量扰动）</li>
</ul>
<p>但这不是必须，<strong>无源码项目可以直接进入下一步</strong>。</p>
<hr/>
<h2 data-id="heading-11"><strong>步骤 3：使用 Ipa Guard 导出可混淆符号（无需源码）</strong></h2>
<p>Ipa Guard 是提升 IPA 安全性的核心工具，因为它专注于处理“成品 IPA”，不依赖源码。</p>
<pre><code class="hljs">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p><code>sym.json</code> 包含关键字段：</p>
<ul>
<li><code>confuse</code>（是否混淆）</li>
<li><code>refactorName</code>（替换后的名字）</li>
<li><code>fileReferences</code>（引用文件）</li>
<li><code>stringReferences</code>（字符串依赖）</li>
</ul>
<p>这是整个流程的“策略文件”。</p>
<hr/>
<h2 data-id="heading-12"><strong>步骤 4：编辑混淆策略（极重要）</strong></h2>
<p>必须排除不能动的内容：</p>
<ul>
<li>Storyboard ID</li>
<li>反射方法</li>
<li>H5/JS 的桥接方法</li>
<li>Flutter/React Native 的通信符号</li>
<li>SDK 初始化方法</li>
</ul>
<p>确保：</p>
<ul>
<li><code>refactorName</code> 长度不变</li>
<li>关键符号使用 <code>confuse:false</code></li>
<li>业务可混淆符号尽量开启</li>
</ul>
<p>这是控制稳定性与安全性之间平衡的核心。</p>
<hr/>
<h2 data-id="heading-13"><strong>步骤 5：执行 IPA 混淆与资源加固（关键步骤）</strong></h2>
<pre><code class="hljs language-css" lang="css">ipaguard_cli protect app<span class="hljs-selector-class">.ipa</span> -c sym<span class="hljs-selector-class">.json</span> <span class="hljs-attr">--email</span> team<span class="hljs-keyword">@dev</span>.com --image --js -o secured.ipa
</code></pre>
<p>完成：</p>
<p>✔ 类名、方法名、变量名混淆
✔ 资源文件重命名
✔ 图片 MD5 修改（防资源替换）
✔ JS/H5 路径混淆（Hybrid 必备）
✔ 输出混淆映射（后续符号化与回滚依赖）</p>
<p>这是提升 IPA 安全性的核心步骤。</p>
<hr/>
<h2 data-id="heading-14"><strong>步骤 6：重签名并进行真机测试</strong></h2>
<p>混淆后的 IPA 必须重签，否则无法打开。</p>
<pre><code class="hljs language-css" lang="css">kxsign sign secured<span class="hljs-selector-class">.ipa</span> -c dev_cert<span class="hljs-selector-class">.p12</span> -<span class="hljs-selector-tag">p</span> pwd \
  -m dev<span class="hljs-selector-class">.mobileprovision</span> -z signed<span class="hljs-selector-class">.ipa</span> -<span class="hljs-selector-tag">i</span>
</code></pre>
<p>测试重点：</p>
<ul>
<li>冷启动</li>
<li>全业务链路</li>
<li>WebView/H5</li>
<li>Flutter/RN 资源加载</li>
<li>SDK 初始化（支付、推送等）</li>
</ul>
<hr/>
<h2 data-id="heading-15"><strong>步骤 7：逆向难度验证（确认加固是否有效）</strong></h2>
<h3 data-id="heading-16">Frida</h3>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l hook_test<span class="hljs-selector-class">.js</span>
</code></pre>
<p>检查：</p>
<ul>
<li>关键方法是否难 Hook</li>
<li>符号名是否已不再可读</li>
<li>是否能轻易定位业务逻辑</li>
</ul>
<h3 data-id="heading-17">Hopper / IDA</h3>
<p>检查：</p>
<ul>
<li>结构是否复杂化</li>
<li>符号是否已乱码</li>
<li>函数跳转是否变得不直观</li>
</ul>
<p>这一步决定加密效果是否达标。</p>
<hr/>
<h2 data-id="heading-18"><strong>步骤 8：映射表治理（确保可维护、可回滚）</strong></h2>
<p>推荐使用 KMS/HSM 或 Git 加密仓库存放：</p>
<ul>
<li>混淆映射表</li>
<li>sym.json（最终策略）</li>
<li>签名指纹</li>
<li>构建号</li>
</ul>
<p>作用：</p>
<ul>
<li>崩溃日志可符号化</li>
<li>出现问题可快速回滚</li>
<li>策略可审计与版本化</li>
</ul>
<hr/>
<h2 data-id="heading-19">四、IPA 安全性常见失败原因与解决方式</h2>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决办法</th></tr></thead><tbody><tr><td>App 白屏</td><td>UI/Storyboard 符号被误混淆</td><td>白名单必须明确处理</td></tr><tr><td>JS/H5 失效</td><td>路径被改但未同步引用</td><td><code>--js</code> 模式或手动同步</td></tr><tr><td>SDK 初始化崩溃</td><td>SDK 方法被误混淆</td><td>SDK 入口方法必须禁混淆</td></tr><tr><td>崩溃无法定位</td><td>混淆映射丢失</td><td>必须纳入治理体系</td></tr><tr><td>可逆向程度仍高</td><td>符号未完全混淆</td><td>检查 sym.json 策略覆盖度</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">提高 IPA 安全性靠体系，而不是某一个工具</h2>
<p>最佳实践是多工具协同：</p>
<h3 data-id="heading-21"><strong>分析层</strong></h3>
<p>MobSF
class-dump</p>
<h3 data-id="heading-22"><strong>混淆层（核心）</strong></h3>
<p>Ipa Guard CLI（IPA 成品层加固）</p>
<h3 data-id="heading-23"><strong>测试层</strong></h3>
<p>kxsign
真机验收</p>
<h3 data-id="heading-24"><strong>逆向验证层</strong></h3>
<p>Frida
Hopper</p>
<h3 data-id="heading-25"><strong>治理层</strong></h3>
<p>KMS
Sentry/Bugly
Git</p>
<p>一个 IPA 的安全性不是加固工具做出来的，而是整个团队通过工具链、流程和策略共同构建的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「干货长文」强化学习完全指南：从基础MDP到TRPO/PPO/GRPO算法演进]]></title>    <link>https://juejin.cn/post/7574727105704869928</link>    <guid>https://juejin.cn/post/7574727105704869928</guid>    <pubDate>2025-11-21T05:53:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105704869928" data-draft-id="7574728397374357556" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「干货长文」强化学习完全指南：从基础MDP到TRPO/PPO/GRPO算法演进"/> <meta itemprop="keywords" content="强化学习"/> <meta itemprop="datePublished" content="2025-11-21T05:53:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「干货长文」强化学习完全指南：从基础MDP到TRPO/PPO/GRPO算法演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:53:18.000Z" title="Fri Nov 21 2025 05:53:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着 gpt-o1出现以及 DeepSeek-R1 的技术开源，强化学习从以谷歌 DeepMind 团队为主的游戏领域，以及与传统控制相结合的具身智能机器人领域，走上了LLM甚至多模态的行业赛道。通过复杂任务拆解和奖励为导向的迭代训练大幅提升了大模型解决复杂问题能力，泛化性以及动态调整能力。Reinforce Learning 带领 LLM 步入 2.0 时代，继 PPO 之后，最近关于梯度优化（Policy Optimization）算法的创新也是层出不穷，GRPO，DAPO，CISPO 等 但是复杂的数学公式及其底层原理，却让人望而却步；因为强化学习是非常系统性的技术，是从最开始的马尔可夫决策过程 (MDP)，贝尔曼方程，通过其数学性质，使用映射压缩定理逐渐演变而来 所以想深刻了解 LLM 中各种变种策略梯度算法的作用与本质，我们需要先了解强化学习的基础，接下来就让我一步一步捋清其来龙去脉</p>
<p>强化学习有两个很重要的性质：一阶马尔可夫性和不动点定理 这两点是整个强化学习框架的基石，缺一不可</p>
<p><strong>Infrastructure</strong></p>
<ol>
<li><strong>Foundation</strong></li>
</ol>
<p>强化学习的目标是寻找最优策略解决问题 于是把智能体 agent 解决实际问题的过程，抽象成马尔可夫决策过程 MDP 该过程具有一阶马尔可夫性：</p>
<p>P(st+1|st,st−1,...,s1)=P(st+1|st)</p>
<p>也就是序列 t+1 的状态只与 t 有关（简化模型，减少计算量）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/829a2aeca5f240c99011a17222ec04bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=cNEShRECsGrp%2B5eyoZw5UWP%2FR3I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1662c5114b4055866353d207bd8648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=HcpStbEt3L17serX6KFWixpgAro%3D" alt="" loading="lazy"/></p>
<p>该系统具有五个变量（策略Policy，状态state，行为action，环境environment，奖励reward） 目标转化成在特定环境中，选择最优策略，在不同状态下执行最优行动，从而获得最大奖励，完成任务</p>
<p>奖励信号：短期收益 价值函数：长期收益，更有远见的判断</p>
<p>通过这种系统的构建形式，我们可以在尽可能短期获得奖励达成目标的同时，又具有一定的前瞻性，通过 Exploration 有一定概率得到更优解</p>
<p>2.<strong>贝尔曼方程</strong></p>
<p><strong>2.1 Bellman Expectation Equation</strong></p>
<p>要具有更高时效性，在更短时间内完成任务，于是引入折扣因子γ，引出了强化学习核心数学工具 贝尔曼公式 该公式描述了 给定策略</p>
<p>π下，状态价值函数</p>
<p>Vπ(s)和 动作价值函数</p>
<p>Qπ(s,a)的递归关系</p>
<p>Vπ(s)=∑aπ(a∣s)Qπ(s,a)=∑aπ(a∣s)∑s′P(s′∣s,a)[r+γVπ(s′)]Qπ(s,a)=∑s′P(s′∣s,a)[r+v(s′)]=∑s′P(s′∣s,a)[r+γ∑a′π(a′∣s′)Qπ(s′,a′)]</p>
<p><strong>2.2 Bellman Optimal Equation</strong></p>
<p>我们的目标是找到最优策略</p>
<p>π∗，使得价值函数值最大，引出了贝尔曼最优公式</p>
<p>V∗(s)=maxa∑s′P(s′∣s,a)[r+γV∗(s′)]Q∗(s,a)=∑s′P(s′∣s,a)[r+γmaxa′Q∗(s′,a′)]</p>
<p>矩阵形式下等价于求</p>
<p>v=maxπrπ+γPπv</p>
<p>因为折扣因子γ&lt;1，</p>
<p>f(v)=maxπrπ+γPπv=v</p>
<p>符合压缩映射定理 contract mapping theory</p>
<p>|f(v1)−f(v2)|&lt;γ|v1−v2|</p>
<p>可以通过迭代法</p>
<p>vk+1=f(vk)</p>
<p>求解，最终会收敛于唯一解</p>
<p>v∗和 得到 最优策略</p>
<p>π∗（</p>
<p>π∗不一定唯一） 最终</p>
<p>v∗=f(v∗)</p>
<p>得到贝尔曼最优公式</p>
<p><strong>Value-based method</strong></p>
<p><strong>3.Dynamic Proramming</strong></p>
<p>在完全已知环境中（已知迷宫），可以通过动态规划的算法（值迭代 和 (截断) 策略迭代） 也是 model-based 的强化学习，求贝尔曼最优方程，得到最优策略π∗</p>
<ul>
<li>策略迭代： Policy evaluation vπk=rπk+γPπkvπk<br/>
根据 r 和 环境的状态转移矩阵 P 迭代逼近真实的 Vπ(s)</li>
</ul>
<p>Policy improvement</p>
<p>vπk+1=\argmaxπ(rπ+γPπvπk)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/204e3304318e45d99aca084d905cf8e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=9j3O6pROj5kGy2uwRBGFL8Fen8A%3D" alt="" loading="lazy"/></p>
<p>因为映射压缩定律，可以使用自举法，让价值函数</p>
<p>vπ</p>
<p>不断迭代逼近最优解</p>
<p>v∗</p>
<p>，从而得到相对应地最优策略</p>
<p>π∗</p>
<p><strong>4.Monte Carlo</strong></p>
<p>有模型的时候我们可以使用，动态规划方法。但是在无模型的情况下，我们需要采用大数定律，通过蒙特卡罗方法去采样近似其模型</p>
<p>根据 DP 的 策略评估和策略改进可知：</p>
<p>{evaluation:vπk=rπk+γPπkvπkimprovement:πk+1=\argmaxπ(rπ+γPπvπk)</p>
<p>πk+1(a|s)=\argmaxπ∑aπ(a|s)qπk(s,a)</p>
<p>无模型的时候，根据大数定律，用采样频率近似概率，对</p>
<p>qπk(s,a)</p>
<p>做近似</p>
<p>qπk(s,a)=E[Gt|St=s,At=a]≈1N∑i=1Ng(i)(s,a)</p>
<p>∴πk+1(a|s)=\argmaxπ∑aπ(a|s)1N∑i=1Ng(i)(s,a)</p>
<p><strong>5.Temporal Difference</strong></p>
<p>但在大多数实际场景中，环境十分复杂不可知，所以需要agent不断去跟环境做交互，采样数据样本来学习 这类统称 free-model 无模型强化学习，包括基于时序差分 TD 的 Sarsa 和 Q-learning算法，运用蒙特卡洛概率估计的思想，近似值函数</p>
<p>时序差分 TD 结合了 MC 抽样 和 动态规划的自举 MC：</p>
<p>V(st)=V(st)+α(Gt−V(st))=V(st)=V(st)+α(rt+1+γ2rt+2+...+γT−t+2rT−V(st))</p>
<p>一步时序差分：</p>
<p>V(st)=V(st)+α(rt+1+γV(st+1)−V(st))</p>
<p>(一步更新，更新频率更快，延迟更低)</p>
<p>V(st)=α(Rt+1+γV(st+1))+(1−α)V(st)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d8c46c1fde14d60b7cdca715190af72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=nBaYJtnE5Gv5g6B3041lmkh8gFw%3D" alt="" loading="lazy"/></p>
<p><strong>5.1 SARSA</strong></p>
<p>在线 / 同轨策略 (on-policy) TD，SARSA 算法(s-&gt;a-&gt;r-&gt;s-&gt;a)，与环境交互得到奖励，不断更新 Q 值来优化策略 用一些样本来评估策略，然后更新策略了，策略提升可以在策略未完全评估的情况进行，是广义策略迭代</p>
<p>Q(s,a)=Q(s,a)+α[Rt+1+γQ(s′,a′)−Q(s,a)]</p>
<p>td_error = r + gamma * Q_table[s1, a1] - Q_table[s0, a0] Q_table[s0, a0] += alpha * td_error</p>
<p>SARSA 具体算法如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb289a498e654374990eb7c46a15b4b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=pJv6G2vyGZTSB%2FMxU2ZdY1DUS7o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adbbaf136ece4138881fb6c013a07077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=f9X2fwBh7HOTBmQIGONoDov8s%2BE%3D" alt="" loading="lazy"/></p>
<p><strong>5.2 多步 SARSA</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0f4accd0146453b945eebb7e24c7c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=lx6Q6%2BwdRMx50oZ3Umnu%2BC9dx6g%3D" alt="" loading="lazy"/></p>
<p><strong>5.3 Q-learning</strong></p>
<p>与 SARSA 不同，是 离线/离轨策略 (off-policy) TD 控制 在</p>
<p>st</p>
<p>时刻选择目标策略，得到</p>
<p>Qπ(s,a),st+1</p>
<p>， 但是在</p>
<p>st+1</p>
<p>时，执行</p>
<p>at+1</p>
<p>，根据最大 Q 值，选择行动策略</p>
<p>b=argmaxQ(st+1,a)</p>
<p>于是有</p>
<p>Q(s,a)=Q(s,a)+α[Rt+1+γmaxQ(s′,a)−Q(s,a)]</p>
<p>Q 学习在更新 Q 表格的时候所用到的 Q(s′,a′) 对应的动作不一定是下一步会执行的动作，因为下一步实际会执行的动作可能是因为进一步的探索而得到的 Q 学习默认的动作不是通过行为策略来选取的，它默认 a′ 为最佳策略对应的动作，所以 Q 学习算法在更新的时候，不需要传入 a′</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de19410f8eb74658a6a4daf6e60d7d0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=LnI0GtwepFF%2B09QnvfZ%2BEY5IOFw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b772c2cf5764f80b822dd8555753e8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=VF%2F%2FSvXcnj9Yx%2FTTEGwQ7RxhoQQ%3D" alt="" loading="lazy"/></p>
<p><strong>5.4 期望 SARSA</strong></p>
<p>不执行</p>
<p>at+1</p>
<p>，根据 Q-table 计算，使用同轨策略</p>
<p>Eπ[Q(st+1|a)|st+1]=∑aπ(a|st+1)Q(st+1,a)</p>
<p>有</p>
<p>Q(s,a)=Q(s,a)+α[r+γEπ[Q(s′|a)|s′]−Q(s,a)]</p>
<p>对比一下 SARSA</p>
<p>Q(s,a)=Q(s,a)+α[Rt+1+γQ(s′,a′)−Q(s,a)]</p>
<p>td_error = r + self.gamma * self.Q_table[s1, a1] - self.Q_table[s0, a0]</p>
<p>Q-learning</p>
<p>Q(s,a)=Q(s,a)+α[Rt+1+γmaxQ(s′,a)−Q(s,a)]</p>
<p>td_error = r + self.gamma * self.Q_table[s1].max() - self.Q_table[s0, a0]</p>
<p>期望 SARSA</p>
<p>Q(s,a)=Q(s,a)+α[r+γEπ[Q(s′|a)|s′]−Q(s,a)]</p>
<p>Q-learning 是 期望 SARSA 的特例，即</p>
<p>Eπ[Q(s′|a)|s′]=maxQ(s′,a∗)</p>
<p><strong>6.动态规划，蒙特卡洛，时序差分的对比</strong></p>
<p>动态规划直接计算期望，它把所有相关的状态都进行加和</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2241698224b147faa0594ae43452ebf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=fp3SqlE59nlcW6ycSaixlvknaeI%3D" alt="" loading="lazy"/></p>
<p>蒙特卡洛在当前状态下，采取一条支路，在这条路径上进行更新，更新这条路径上的所有状态</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/610d43d1ab854de5ae34419771032fa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=2DM5YSqsMFgvYC9zR7P2ZUrKr80%3D" alt="" loading="lazy"/></p>
<p>时序差分从当前状态开始，往前走了一步，关注的是非常局部的步骤</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33d4bd7fc53140afa52f4f8e5a48adcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=9W7PxGbyMPREnhMXFnGeeXy2dYM%3D" alt="" loading="lazy"/></p>
<p>强化学习的统一视角</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a2e29e9061942adbf9bde2b091e2e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=VVu%2B6u%2FZjg%2BQ3FCwtz9gnC1704g%3D" alt="" loading="lazy"/></p>
<p><strong>Policy-based method</strong></p>
<p>Value-based method 不适用场景：</p>
<ol>
<li>随机策略</li>
<li>连续动作空间</li>
</ol>
<p><strong>7.REINFORCE</strong></p>
<p>除了前面value-based 基于值函数的方法外，还有 policy-based 基于策略的方法 策略梯度算法 REINFORCE 求梯度<br/>
（）推导省略，见动手强化学习根据经过步变成的概率为在这一幕中出现的加权概率∇J（θ）=∇Vπ(s)=∇∑aπ(a|s)qπ(s,a)=(推导省略，见动手强化学习)=∑s∈S∑k=0∞Pr(s0−&gt;s,k,π)∑a∇π(a|s)qπ(s,a)(Pr(s0−&gt;s,k,π)=s0根据π经过k步变成s的概率)∝∑s∈Sμ(s)∑a∇π(a|s)qπ(s,a),μ(s)为在这一幕中s出现的加权概率=Eπ[∑a∇π(a|St)qπ(St,a)]=Eπ[∑aπ(a|St)qπ(St,a)∇π(a|St)π(a|St)]=Eπ[qπ(St,At)∇log⁡π(At|St)]=Eπ[Gt.∇log⁡π(At|St)]=Eπ[Gt.∇log⁡π(At|St;θ)]</p>
<p>梯度上升</p>
<p>θt+1=θt+αGt∇log⁡π(At|St;θt)</p>
<p>MC 采样 -&gt; 方差大 BaseLine</p>
<p>∝∑s∈Sμ(s)∑a(qπ(s,a)−b(s))∇π(a|s)</p>
<p>REINFORCE with Baseline b(s) 为基线，减少方差</p>
<p>∑ab(s)∇π(a|s)=b(s)∇∑aπ(a|s)=b(s)∇1=0</p>
<p>∴θt+1=θt+α(Gt−b(st))∇log⁡π(At|St;θt)</p>
<p>为估计值b(st)=v^(st,w),v^为估计值</p>
<p>θt+1=θt+α(Gt−v^(st,w))∇log⁡π(At|St;θt)</p>
<p>θt+1=θt+α(rt+γv^(st+1)−v^(st,w))∇log⁡π(At|St;θt)</p>
<p>此时除了训练策略函数</p>
<p>π</p>
<p>，又多要训练值函数</p>
<p>v</p>
<p>，引出 Actor-Critic 模型</p>
<p>Actor-Critic 算法 结合了学习值函数和策略函数</p>
<p>θt+1=θt+α(rt+γv^(st+1)−v^(st,w))∇log⁡π(At|St;θt)</p>
<p>Actor -&gt;</p>
<p>π(a|s)</p>
<p>，Critic -&gt;</p>
<p>v^(s)</p>
<p>，这一系列算法的目标都是，优化一个带参数的策略，只是会额外学习值函数去帮助策略函数更好的学习，所以本质上还是属于policy-based方法</p>
<p><strong>8.TRPO</strong> 但以上policy-based方法都会遇到训练不稳定的情况，所以考虑在更新时找到一块 Trust Region，能够得到策略性能的安全性保证，引出了 TRPO 置信区域策略优化算法 在理论上能保证策略学习的性能单调性，实际中取得比 策略梯度算法 更好的效果</p>
<p>因为该算法比较复杂，使用了泰勒展开近似，共轭梯度，线性搜索等方法直接求解，计算过程十分复杂，运算量非常大，而且也被相对简单的 PPO 因计算量低且性能相当的优势所替代，在此就不做过多赘述</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a063cccd0bf40e589068409499f2f7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=P3X1r1CHJMtINHENQPO0bA7mbjE%3D" alt="" loading="lazy"/></p>
<p><strong>9.PPO</strong></p>
<p>使用了相对简单的方法 PPO 求解，大量实验结果证明效果和 TRPO 一样好 近端策略优化（Proximal Policy Optimization）是一种 actor-critic RL 算法，广泛应用于 LLM 强化微调阶段和足式机器人训练</p>
<p>回顾一下之前提到的时序差分，来计算 PPO 所需要的广义优势估计 GAE</p>
<ul>
<li>
<p>一步时序差分 更新 V 函数：<br/>
V(st)=V(st)+α[rt+γV(st+1)−V(st)]=V(st)+αδt</p>
</li>
<li>
<p>时序差分：<br/>
At(1)=δt=rt+γV(st+1)−V(st)At(2)=δt+γδt+1=rt+γrt+1+γ2V(st+2)−V(st)=[rt+γV(st+1)−V(st)]+γ[rt+1+γV(st+2)−V(st+1)]At(3)=δt+γδt+1+γ2δt+2=rt+γrt+1+γ2rt+2+γ2V(st+3)−V(st)At(k)=∑i=0k−1γiδt+i</p>
</li>
<li>
<p>GAE 广义优势估计：时序差分不同步数的优势估计进行指数加权平均<br/>
AtGAE=(1−λ)(At(1)+λAt(2)+λ2At(3)+...)=(δt+λγδt+1+λ2γ2δt+2+...)<br/>
γλAt+1GAE=λγ(δt+1+λγδt+2+...)=(λγδt+1+λ2γ2δt+2+...)<br/>
’</p>
</li>
<li>
<p>GAE 逆向迭代计算<br/>
At=δt+γλAt+1<br/>
λ∈[0,1]<br/>
，是 GAE 额外引入的一个超参数 λ=0<br/>
只看一步差分得到的优势；λ=1<br/>
看每一步差分得到优势的平均值</p>
</li>
<li>
<p>Actor 目标函数：<br/>
JPPO(θ)=Eπθold[min[πθ(a|s)πθold(a|s)At,clip(πθ(a|s)πθold(a|s),1−ϵ,1+ϵ)At]]<br/>
At=∑i=0Tλiγiδt+i<br/>
多步时序差分残差的指数加权 δt=rt+γV(st+1)−V(st)<br/>
一步时序差分残差 𝑟𝑡=𝑟ϕ(s)−βlogπθ(a|s)π𝑟𝑒𝑓(a|s)**<br/>
是奖π𝑟𝑒𝑓<br/>
是参考策略 (即 SFT 的初始模型)，β<br/>
为 KL 惩罚项系数**</p>
</li>
</ul>
<p>At=∑i=0Tλiγi(𝑟ϕ(s)−βlogπθ(at+i|st+i)π𝑟𝑒𝑓(at+i|st+i)+γV(st+i+1)−V(st+i))</p>
<p>求 PPO 策略梯度</p>
<p>∇JPPO(θ)=πθ(a|s)πθold(a|s)At∇log⁡π(At|St;θt)≈At∇log⁡π(At|St;θt)</p>
<p>策略网络更新</p>
<p>θt+1=θt+αAt∇log⁡π(At|St;θt)</p>
<ul>
<li>Critic 目标值函数 V(s)： Jcritic=(rt+γV(st+1)−V(st))2</li>
</ul>
<p>重要性采样的近似 和 PPO 中的 clip</p>
<ul>
<li>重要性采样 基于 model-free 的强化学习，通常会使用 MC 采样方法中的离轨策略估计<br/>
V(s)<br/>
，来评估π′<br/>
实际中，大多只能从旧策略 πθold<br/>
采样，因此引出重要性采样： J(θ)=∑oR(o)πθ(o)=∑oR(o)πθold(o)πθ(o)πθold(o)=E[o∼πθ]R(o)=E[o∼πθold]R(o)πθ(o)πθold(o)<br/>
这样可以从πθold<br/>
采样，重要性采样比值 πθ(o)πθold(o)=πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)=ri,t<br/>
来修正新旧策略分布偏差 ri,t=πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)<br/>
是重要性采样比值 尽量不要使得 πθ(o)πθold(o)<br/>
差异太大，因为对旧策略 πθold<br/>
采样，πθold<br/>
概率很小时，样本重要性反而很大，也会降低采样效率，所以引入了 clip 机制 和 KL 散度，让两概率分布差异减少</li>
<li>clip 机制 新旧策略差距较大时，<br/>
ri,t<br/>
可能会过大或过小 导致训练不稳定，甚至梯度爆炸 PPO 通过引入 clip 机制，限制 ri,t<br/>
的变化 L(θ)=min[πθ(ot|q,o&lt;t)πθold(ot|q,o&lt;t),clip(πθ(ot|q,o&lt;t)πθold(ot|q,o&lt;t),1−ϵ,1+ϵ)]<br/>
ri,t<br/>
偏离 1 太多，就会被裁剪到 [1−ϵ,1+ϵ]<br/>
范围内，避免训练不稳定</li>
</ul>
<p>具体而言，PPO 使用了对 TRPO 优化的一阶近似，对最大化的目标函数做了 CLIP 裁剪的创新技巧 换言之，也就是对目标函数的悲观估计，可以每次少量优化，防止优化策略过大和训练不稳定，增加模型的鲁棒性 或者用 KL 散度惩罚项来替代 CLIP 裁剪，所以 PPO 分两种形式，PPO-Penality 和 PPO-Clip</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959213d4b0da493a867b9c5e8aa1e804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=izjU7cll%2Bit27BUy8vc9eFXaAYA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c0803222d94b0f8a5752426dd30057~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=1evWSjkVCVVGrU5APfoq8Tpc8Cg%3D" alt="" loading="lazy"/></p>
<p>PPO 使用一个深度神经网络来表示策略</p>
<p>π(a|s,θ)</p>
<p>，其中 θ 是策略网络的参数 策略网络的输入是当前状态 s，输出是每个动作 a 的概率分布，表示在状态 s 下采取不同动作的可能性 与 DQN 类似，策略网络的结构也取决于任务类型，可以是 CNN 或 MLP 但要多训练一个值函数网络</p>
<p>V(s;θ)</p>
<p>，用 CNN 或 MLP</p>
<p><strong>10.GRPO</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ee953b5eddf47ac99a73af74d1a84d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=RuOgd5IRF9%2BS96%2FuTZheBKJTugk%3D" alt="" loading="lazy"/></p>
<p>Group Relative Policy Optimization (GRPO) 是 Proximal Policy Optimization (PPO) 近端策略优化的变种 放弃了值模型和 critic 模型，从群奖励分数取计算Adventage，更新策略函数，大幅减少计算量<br/>
JGRPO(θ)=E[q∼P(Q),{oi}i=1G∼πθold(O|q)]1G∑i=1G1|oi|∑t=1|oi|{min[πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t,clip[πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t),1−ϵ,1+ϵ]A^i,t]−βDKL[πθ||πref]}<br/>
A^𝑖,𝑡=𝑟𝑖−1G∑i=1G𝑟𝑖σr, <strong>1<br/>
从上述公式可以看出JGRPO(θ)eta)<br/>
，而公式πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t,t}<br/>
，其他项为修正项</strong></p>
<ol>
<li>
<p>不考虑 KL 惩罚项 和 clip 裁剪项 的情况下：根据重要性采样<br/>
JGRPO(θ)=E[q∼P(Q),{oi}i=1G∼πθold(O|q)]1G∑i=1G1|oi|∑t=1|oi|πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t=E[q∼P(Q),{oi}i=1G∼πθ(O|q)]1G∑i=1G1|oi|∑t=1|oi|A^i,t=E[q∼P(Q),{oi}i=1G∼πθ(O|q)]1G∑i=1GA^i=E[q∼P(Q),{oi}i=1G∼πθ(O|q)]1G∑i=1G𝑟𝑖−μrσr=1Gσr∑i=1GE<a href="https://link.juejin.cn?target=%25F0%259D%2591%259F%25F0%259D%2591%2596%25E2%2588%2592r%25C2%25AF" target="_blank" title="%F0%9D%91%9F%F0%9D%91%96%E2%88%92r%C2%AF" ref="nofollow noopener noreferrer">q∼P(Q),{oi}i=1G∼πθ(O|q)</a><br/>
在新策略πθ<br/>
已知的情况下，1Gσr<br/>
是常数 所以要使JGRPO(θ)<br/>
在更新策略后增大，需要让∑i=1GE<a href="https://link.juejin.cn?target=%25F0%259D%2591%259F%25F0%259D%2591%2596%25E2%2588%2592r%25C2%25AF" target="_blank" title="%F0%9D%91%9F%F0%9D%91%96%E2%88%92r%C2%AF" ref="nofollow noopener noreferrer">q∼P(Q),{oi}i=1G∼πθ(O|q)</a><br/>
变大 显而易见，根据问题回答的G个答案中： 回答好的oi**的r_i<br/>
t;0<br/>
**的r_i<br/>
t;0</p>
<p>的条件概率分布，向回答 reward 值高的方向增大概率，JGRPO(θ)<br/>
会增大，从而达到优化效果****</p>
</li>
<li>
<p>而<br/>
D𝐾𝐿[πθ||π𝑟𝑒𝑓]<br/>
反映的是 更新策略与参考策略的概率分布差异大小，有点像策略概率分布的 “正则化” 让每一次策略更新的差异不那么大，一步一个脚印慢慢优化πθ<br/>
，有助于训练的稳定性 D𝐾𝐿[πθ||π𝑟𝑒𝑓]=π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−logπ𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−1 1</p>
</li>
<li>
<p>运用策略梯度优化，不考虑裁剪项:<br/>
JGRPO(θ)=E[q∼P(Q),{oi}i=1G∼πθold(O|q)]1G∑i=1G1|oi|∑t=1|oi|πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t−βDKL[πθ||πref]=E[q∼P(Q),{oi}i=1G∼πθold(O|q)]1G∑i=1G1|oi|∑t=1|oi|πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t−β(π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−logπ𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−1) )</p>
</li>
</ol>
<p>运用</p>
<p>∇πθ=πθ∇logπθ</p>
<p>似然比技巧求梯度</p>
<p>∇θJGRPO(θ)=1G∑i=1G1|oi|∑t=1|oi|[ πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t∇θlogπθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−β(−π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ2(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)+πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ2(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡))πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)∇θlogπθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)] =1G∑i=1G1|oi|∑t=1|oi|[ πθ(oi,t|q,oi,&lt;t)πθold(oi,t|q,oi,&lt;t)A^i,t−β(1−π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡))] ∇θlogπθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)t;𝑡})}</p>
<p>因为有kl散度惩罚项，一次策略改进变化较小，所以令</p>
<p>πθ(oi,t|q,oi,&lt;t)≈πθold(oi,t|q,oi,&lt;t)</p>
<p>∴∇θJGRPO(θ)=1G∑i=1G1|oi|∑t=1|oi|[ A^i,t+β(π𝑟𝑒𝑓(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)πθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)−1)] ∇θlogπθ(𝑜𝑖,𝑡|𝑞,𝑜𝑖,&lt;𝑡)})}</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972b27c7730243369edd9c09618833a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764309198&amp;x-signature=OKoIb22yDrq4UlwTH3JIvbJuDLA%3D" alt="" loading="lazy"/></p>
<p><strong>总结</strong></p>
<p>强化学习在LLM领域的应用远未到终点，其前景非常广阔，目前的热门方向大致如下：</p>
<p>自动化与AI反馈 (RLAIF)</p>
<ul>
<li>人类反馈成本高昂且速度慢。未来，强大的AI模型可以代替人类来提供反馈信号，这个概念被称为RLAIF (Reinforcement Learning from AI Feedback)</li>
<li>一个更强大的“教师”AI可以评估“学生”AI的回答，并提供奖励信号，从而实现大规模、自动化的持续改进和对齐</li>
</ul>
<p>与工具使用的深度融合</p>
<ul>
<li>未来的LLM不仅是语言模型，更是能调用各种工具（如代码解释器、搜索引擎、API）的“智能体”（Agent）。</li>
<li>强化学习是训练智能体的核心技术。通过奖励模型来判断工具使用的有效性，RL可以教会LLM何时、如何以及为何使用工具，从而解决更复杂的现实世界问题</li>
</ul>
<p>总而言之，强化学习已经成为释放大型语言模型全部潜力的核心技术之一。它不仅解决了关键的“对齐”问题，更指明了通往更强大、更通用、更能解决现实问题的AI智能体的道路</p>
<p>参考资料 Proximal Policy Optimization Algorithms, John Schulman, Filip Wolski, Prafulla Dhariwal, Alec Radford, Oleg Klimov, OpenAI DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, DeepSeek-AI DAPO: An Open-Source LLM Reinforcement Learning System at Scale, ByteDance Seed, Institute for AI Industry Research (AIR), Tsinghua University, The University of Hong Kong , SIA-Lab of Tsinghua AIR MiniMax-M1: Scaling Test-Time Compute Efficiently with Lightning Attention, MiniMax Reinforcement Learning Richard S. Sutton 动手学强化学习 张伟楠 强化学习的数学原理 赵世钰 强化学习白板推导系列 B站up主: shuhuai008</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对 .NET FileSystemWatcher引发内存碎片化的 反思]]></title>    <link>https://juejin.cn/post/7574728397374324788</link>    <guid>https://juejin.cn/post/7574728397374324788</guid>    <pubDate>2025-11-21T05:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574728397374324788" data-draft-id="7574680270538326016" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对 .NET FileSystemWatcher引发内存碎片化的 反思 "/> <meta itemprop="keywords" content=".NET"/> <meta itemprop="datePublished" content="2025-11-21T05:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对 .NET FileSystemWatcher引发内存碎片化的 反思 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T05:45:44.000Z" title="Fri Nov 21 2025 05:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 讲故事</h3>
<p>前些天又遇到了一例 FileSystemWatcher 引发的内存碎片化故障，但这个碎片化不是因为经典的 <code>reloadOnChange=true</code> 导致的，所以我觉得有必要做一次深度的反思，供以后遇到类似问题提供技术上的解决方法，这篇我们就来系统的讲解下 两种碎片化方式的调查方法。</p>
<h2 data-id="heading-1">二：经典的 FileSystemWatcher 碎片化</h2>
<h3 data-id="heading-2">1. 测试代码</h3>
<p>这种碎片化是由 <code>reloadOnChange=true</code> 引发的，祸根主要是程序员将 .netframework 读取配置文件的方式套在了 .net 上，为了方便演示，先上一段测试代码。</p>
<pre><code class="hljs language-csharp" lang="csharp">
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++)
            {
                IConfiguration configuration = BuildConfiguration();
                <span class="hljs-built_in">string</span> appName = configuration[<span class="hljs-string">"AppName"</span>];
                Console.WriteLine(<span class="hljs-string">$"i=<span class="hljs-subst">{i}</span> 应用名称: <span class="hljs-subst">{appName}</span>"</span>);
            }

            Console.ReadLine();
        }

        <span class="hljs-function"><span class="hljs-keyword">static</span> IConfiguration <span class="hljs-title">BuildConfiguration</span>()</span>
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">false</span>, reloadOnChange: <span class="hljs-literal">true</span>)
                .Build();
        }
    }
</code></pre>
<p>卦中的代码非常简单，就是每次读取 AppName 时都调了一下 BuildConfiguration 方法，仅此而已，但将程序跑起来之后，居然发现程序吃了 <code>2.2G</code> 的内存，真是没边的事，截图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5233a2d084a14bc4b1063b92a36b32c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764308744&amp;x-signature=wDugKJTykxlR%2Fu4borBjyqazAzk%3D" alt="" loading="lazy"/></p>
<p>为了找出原因，上 windbg 附加，使用 <code>!dumpheap -stat</code> 观察托管堆，截图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce4d3145cc094109a3a1c26f74f918f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764308744&amp;x-signature=H4Kg%2B8uPHoIL%2BQKrRKNqqmrHmE8%3D" alt="" loading="lazy"/></p>
<p>从卦中可以看到两点信息：</p>
<ol>
<li>Free 独占 <code>1.39G</code>,这是经典的内存碎片化。</li>
<li>FileSystemWatcher 高达 1290 个，表明程序存在大量的文件监控。</li>
</ol>
<p>看到上面两点信息，一定要有条件反射，是不是 <code>reloadOnChange: true</code> 导致的。</p>
<h3 data-id="heading-3">2. 是 reloadOnChange 导致的吗</h3>
<p>要想找到答案，可以深挖 <code>Microsoft.Extensions.Configuration.ConfigurationRoot</code> 类，即代码 <code>BuildConfiguration();</code> 的返回类型，为了方便可视化观察，我用 vs 直接找下给大家看看，截图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1d7758985540eeb6d8134543758463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764308744&amp;x-signature=FyuTGHl%2FySqC9wO6ktvLHKBwzes%3D" alt="" loading="lazy"/></p>
<p>有了这个脉络，就可以使用 windbg 下钻观察，最终就找到了 <code>&lt;ReloadOnChange&gt;k__BackingField = 1</code> 的铁证，参考如下：</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-number">0</span><span class="hljs-string">:008&gt;</span> <span class="hljs-type">!dumpobj</span> <span class="hljs-string">/d</span> <span class="hljs-string">17dd2f41fa0</span>
<span class="hljs-attr">Name:</span>        <span class="hljs-string">Microsoft.Extensions.Configuration.ConfigurationRoot</span>
<span class="hljs-attr">MethodTable:</span> <span class="hljs-string">00007ff9d8707a48</span>
<span class="hljs-attr">EEClass:</span>     <span class="hljs-string">00007ff9d86e97b0</span>
<span class="hljs-attr">Tracked Type:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">Size:</span>        <span class="hljs-number">40</span><span class="hljs-string">(0x28)</span> <span class="hljs-string">bytes</span>
<span class="hljs-attr">File:</span>        <span class="hljs-string">D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.dll</span>
<span class="hljs-attr">Fields:</span>
              <span class="hljs-string">MT</span>    <span class="hljs-string">Field</span>   <span class="hljs-string">Offset</span>                 <span class="hljs-string">Type</span> <span class="hljs-string">VT</span>     <span class="hljs-string">Attr</span>            <span class="hljs-string">Value</span> <span class="hljs-string">Name</span>
<span class="hljs-string">00007ff9d8706c48</span>  <span class="hljs-number">4000016</span>        <span class="hljs-number">8</span> <span class="hljs-string">...on.Abstractions]]</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f3e520</span> <span class="hljs-string">_providers</span>
<span class="hljs-string">00007ff9d880ba28</span>  <span class="hljs-number">4000017</span>       <span class="hljs-number">10</span> <span class="hljs-string">...Private.CoreLib]]</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f42018</span> <span class="hljs-string">_changeTokenRegistrations</span>
<span class="hljs-string">00007ff9d8708940</span>  <span class="hljs-number">4000018</span>       <span class="hljs-number">18</span> <span class="hljs-string">...rationReloadToken</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f41fc8</span> <span class="hljs-string">_changeToken</span>
<span class="hljs-number">0</span><span class="hljs-string">:008&gt;</span> <span class="hljs-type">!DumpObj</span> <span class="hljs-string">/d</span> <span class="hljs-string">0000017dd2f3e520</span>
<span class="hljs-attr">Name:</span>        <span class="hljs-string">System.Collections.Generic.List`1[[Microsoft.Extensions.Configuration.IConfigurationProvider,</span> <span class="hljs-string">Microsoft.Extensions.Configuration.Abstractions]]</span>
<span class="hljs-attr">MethodTable:</span> <span class="hljs-string">00007ff9d87069d0</span>
<span class="hljs-attr">EEClass:</span>     <span class="hljs-string">00007ff9d86a10f8</span>
<span class="hljs-attr">Tracked Type:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">Size:</span>        <span class="hljs-number">32</span><span class="hljs-string">(0x20)</span> <span class="hljs-string">bytes</span>
<span class="hljs-attr">File:</span>        <span class="hljs-string">C:\Program</span> <span class="hljs-string">Files\dotnet\shared\Microsoft.NETCore.App\8.0.22\System.Private.CoreLib.dll</span>
<span class="hljs-attr">Fields:</span>
              <span class="hljs-string">MT</span>    <span class="hljs-string">Field</span>   <span class="hljs-string">Offset</span>                 <span class="hljs-string">Type</span> <span class="hljs-string">VT</span>     <span class="hljs-string">Attr</span>            <span class="hljs-string">Value</span> <span class="hljs-string">Name</span>
<span class="hljs-string">00007ff9d891d1a0</span>  <span class="hljs-string">400226e</span>        <span class="hljs-number">8</span>     <span class="hljs-string">System.__Canon[]</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f41f68</span> <span class="hljs-string">_items</span>
<span class="hljs-string">00007ff9d8551188</span>  <span class="hljs-string">400226f</span>       <span class="hljs-number">10</span>         <span class="hljs-string">System.Int32</span>  <span class="hljs-number">1</span> <span class="hljs-string">instance</span>                <span class="hljs-number">1</span> <span class="hljs-string">_size</span>
<span class="hljs-string">00007ff9d8551188</span>  <span class="hljs-number">4002270</span>       <span class="hljs-number">14</span>         <span class="hljs-string">System.Int32</span>  <span class="hljs-number">1</span> <span class="hljs-string">instance</span>                <span class="hljs-number">1</span> <span class="hljs-string">_version</span>
<span class="hljs-string">00007ff9d891d1a0</span>  <span class="hljs-number">4002271</span>        <span class="hljs-number">8</span>     <span class="hljs-string">System.__Canon[]</span>  <span class="hljs-number">0</span>   <span class="hljs-string">static</span> <span class="hljs-string">dynamic</span> <span class="hljs-string">statics</span> <span class="hljs-string">NYI</span>                 <span class="hljs-string">s_emptyArray</span>
<span class="hljs-number">0</span><span class="hljs-string">:008&gt;</span> <span class="hljs-type">!DumpArray</span> <span class="hljs-string">/d</span> <span class="hljs-string">0000017dd2f41f68</span>
<span class="hljs-attr">Name:</span>        <span class="hljs-string">Microsoft.Extensions.Configuration.IConfigurationProvider[]</span>
<span class="hljs-attr">MethodTable:</span> <span class="hljs-string">00007ff9d8707cf0</span>
<span class="hljs-attr">EEClass:</span>     <span class="hljs-string">00007ff9d851c440</span>
<span class="hljs-attr">Size:</span>        <span class="hljs-number">56</span><span class="hljs-string">(0x38)</span> <span class="hljs-string">bytes</span>
<span class="hljs-attr">Array:</span>       <span class="hljs-string">Rank</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-string">Number</span> <span class="hljs-string">of</span> <span class="hljs-string">elements</span> <span class="hljs-number">4</span><span class="hljs-string">,</span> <span class="hljs-string">Type</span> <span class="hljs-string">CLASS</span>
<span class="hljs-attr">Element Methodtable:</span> <span class="hljs-string">00007ff9d8706938</span>
[<span class="hljs-number">0</span>] <span class="hljs-string">0000017dd2f3e540</span>
[<span class="hljs-number">1</span>] <span class="hljs-literal">null</span>
[<span class="hljs-number">2</span>] <span class="hljs-literal">null</span>
[<span class="hljs-number">3</span>] <span class="hljs-literal">null</span>
<span class="hljs-number">0</span><span class="hljs-string">:008&gt;</span> <span class="hljs-type">!DumpObj</span> <span class="hljs-string">/d</span> <span class="hljs-string">0000017dd2f3e540</span>
<span class="hljs-attr">Name:</span>        <span class="hljs-string">Microsoft.Extensions.Configuration.Json.JsonConfigurationProvider</span>
<span class="hljs-attr">MethodTable:</span> <span class="hljs-string">00007ff9d8708200</span>
<span class="hljs-attr">EEClass:</span>     <span class="hljs-string">00007ff9d86e9ab8</span>
<span class="hljs-attr">Tracked Type:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">Size:</span>        <span class="hljs-number">48</span><span class="hljs-string">(0x30)</span> <span class="hljs-string">bytes</span>
<span class="hljs-attr">File:</span>        <span class="hljs-string">D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.Json.dll</span>
<span class="hljs-attr">Fields:</span>
              <span class="hljs-string">MT</span>    <span class="hljs-string">Field</span>   <span class="hljs-string">Offset</span>                 <span class="hljs-string">Type</span> <span class="hljs-string">VT</span>     <span class="hljs-string">Attr</span>            <span class="hljs-string">Value</span> <span class="hljs-string">Name</span>
<span class="hljs-string">00007ff9d8708940</span>  <span class="hljs-number">4000012</span>        <span class="hljs-number">8</span> <span class="hljs-string">...rationReloadToken</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f437e0</span> <span class="hljs-string">_reloadToken</span>
<span class="hljs-string">00007ff9d8708cf0</span>  <span class="hljs-number">4000013</span>       <span class="hljs-number">10</span> <span class="hljs-string">...Private.CoreLib]]</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f42298</span> <span class="hljs-string">&lt;Data&gt;k__BackingF</span> <span class="hljs-string">https://www.jiwenlaw.com/ield</span>
<span class="hljs-string">00007ff9d8662820</span>  <span class="hljs-number">4000005</span>       <span class="hljs-number">18</span>   <span class="hljs-string">System.IDisposable</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f3e690</span> <span class="hljs-string">_changeTokenRegistration</span>
<span class="hljs-string">00007ff9d8701b98</span>  <span class="hljs-number">4000006</span>       <span class="hljs-number">20</span> <span class="hljs-string">...nfigurationSource</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f3e4b8</span> <span class="hljs-string">&lt;Source&gt;k__BackingField</span>
<span class="hljs-number">0</span><span class="hljs-string">:008&gt;</span> <span class="hljs-type">!DumpObj</span> <span class="hljs-string">/d</span> <span class="hljs-string">0000017dd2f3e4b8</span>
<span class="hljs-attr">Name:</span>        <span class="hljs-string">Microsoft.Extensions.Configuration.Json.JsonConfigurationSource</span>
<span class="hljs-attr">MethodTable:</span> <span class="hljs-string">00007ff9d8701c88</span>
<span class="hljs-attr">EEClass:</span>     <span class="hljs-string">00007ff9d86e7868</span>
<span class="hljs-attr">Tracked Type:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">Size:</span>        <span class="hljs-number">48</span><span class="hljs-string">(0x30)</span> <span class="hljs-string">bytes</span>
<span class="hljs-attr">File:</span>        <span class="hljs-string">D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.Json.dll</span>
<span class="hljs-attr">Fields:</span>
              <span class="hljs-string">MT</span>    <span class="hljs-string">Field</span>   <span class="hljs-string">Offset</span>                 <span class="hljs-string">Type</span> <span class="hljs-string">VT</span>     <span class="hljs-string">Attr</span>            <span class="hljs-string">Value</span> <span class="hljs-string">Name</span>
<span class="hljs-string">00007ff9d86d8188</span>  <span class="hljs-number">4000007</span>        <span class="hljs-number">8</span> <span class="hljs-string">...ers.IFileProvider</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017dd2f3e230</span> <span class="hljs-string">&lt;FileProvider&gt;k__BackingField</span>
<span class="hljs-string">00007ff9d85cec08</span>  <span class="hljs-number">4000008</span>       <span class="hljs-number">10</span>        <span class="hljs-string">System.String</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-string">0000017d00100510</span> <span class="hljs-string">&lt;Path&gt;k__BackingField</span>
<span class="hljs-string">00007ff9d851d070</span>  <span class="hljs-number">4000009</span>       <span class="hljs-number">24</span>       <span class="hljs-string">System.Boolean</span>  <span class="hljs-number">1</span> <span class="hljs-string">instance</span>                <span class="hljs-number">0</span> <span class="hljs-string">&lt;Optional&gt;k__BackingField</span>
<span class="hljs-string">00007ff9d851d070</span>  <span class="hljs-string">400000a</span>       <span class="hljs-number">25</span>       <span class="hljs-string">System.Boolean</span>  <span class="hljs-number">1</span> <span class="hljs-string">instance</span>                <span class="hljs-number">1</span> <span class="hljs-string">&lt;ReloadOnChange&gt;k__BackingField</span>
<span class="hljs-string">00007ff9d8551188</span>  <span class="hljs-string">400000b</span>       <span class="hljs-number">20</span>         <span class="hljs-string">System.Int32</span>  <span class="hljs-number">1</span> <span class="hljs-string">instance</span>              <span class="hljs-number">250</span> <span class="hljs-string">&lt;ReloadDelay&gt;k__BackingField</span>
<span class="hljs-string">00007ff9d8708420</span>  <span class="hljs-string">400000c</span>       <span class="hljs-number">18</span> <span class="hljs-string">....FileExtensions]]</span>  <span class="hljs-number">0</span> <span class="hljs-string">instance</span> <span class="hljs-number">0000000000000000</span> <span class="hljs-string">&lt;OnLoadException&gt;k__BackingField</span>
</code></pre>
<h2 data-id="heading-4">三：非经典的 FileSystemWatcher 碎片化</h2>
<h3 data-id="heading-5">1. 测试代码</h3>
<p>有的时候会出现 <code>FileSystemWatcher</code> 很少，但 overlapped 很多的情况，这种情况很大概率不是 <code>reloadOnChange: true</code> 导致的，截图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba974e12d98347fe9153cf92657bdf2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764308744&amp;x-signature=Gmsugw8vN0kvWEpVW4P5YxrQIMU%3D" alt="" loading="lazy"/></p>
<p>像这种情况可能就需要开启追踪了，可以借助🐂👃的harmony 搞定，那如何做呢？可以钩住 <code>FileSystemWatcher</code> 的所有构造函数，通过记录调用栈来观察到底是什么代码调用的，从而寻找祸根，参考代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-keyword">var</span> harmony = <span class="hljs-keyword">new</span> Harmony(<span class="hljs-string">"com.example.fswatcher"</span>);
            harmony.PatchAll();

            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)
            {
                IConfiguration configuration = BuildConfiguration();
                <span class="hljs-built_in">string</span> appName = configuration[<span class="hljs-string">"AppName"</span>];
                Console.WriteLine(<span class="hljs-string">$"i=<span class="hljs-subst">{i}</span> 应用名称: <span class="hljs-subst">{appName}</span>"</span>);
            }

            Console.ReadLine(https:<span class="hljs-comment">//www.jiwenlaw.com/ );</span>
        }

        <span class="hljs-function"><span class="hljs-keyword">static</span> IConfiguration <span class="hljs-title">BuildConfiguration</span>()</span>
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">false</span>, reloadOnChange: <span class="hljs-literal">true</span>)
                .Build();
        }
    }

    [<span class="hljs-meta">HarmonyPatch</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FileSystemWatcherConstructorsPatch</span>
    {
        [<span class="hljs-meta">HarmonyTargetMethod</span>]
        <span class="hljs-function"><span class="hljs-keyword">static</span> IEnumerable&lt;MethodBase&gt; <span class="hljs-title">TargetMethods</span>()</span>
        {
            <span class="hljs-comment">// 一次性获取所有公共实例构造函数</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span>(FileSystemWatcher).GetConstructors(BindingFlags.Public | BindingFlags.Instance);
        }

        [<span class="hljs-meta">HarmonyPostfix</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Postfix</span>(<span class="hljs-params">FileSystemWatcher __instance</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">$"[Harmony] FileSystemWatcher 构造函数被调用"</span>);
            Console.WriteLine(<span class="hljs-string">$"[Harmony] 路径: https://www.jiwenlaw.com/ '<span class="hljs-subst">{__instance.Path ?? <span class="hljs-string">"null"</span>}</span>', 过滤器: '<span class="hljs-subst">{__instance.Filter ?? <span class="hljs-string">"null"</span>}</span>'"</span>);
            Console.WriteLine(<span class="hljs-string">$"[Harmony] 调用栈:"</span>);
            Console.WriteLine(Environment.StackTrace);
        }
    }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70698ee8ba15476a90c4317dc10172e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764308744&amp;x-signature=H2etZwfn0xfybZ3%2Fyyrh7RicAAo%3D" alt="" loading="lazy"/></p>
<p>从卦中可以看到，原来这个 <code>FileSystemWatcher</code> 是我们的用户代码 <code>BuildConfiguration</code> 搞的哈，这就极大的缩小的包围圈，从而快速定位祸根。</p>
<h2 data-id="heading-6">四：总结</h2>
<p>很多的内存碎片化往往都能看到 FileSystemWatcher 的身影，希望这篇的反思和总结能给大家带来帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>