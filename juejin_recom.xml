<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[设计一个支持万人同时抢购商品的秒杀系统?]]></title>    <link>https://juejin.cn/post/7594642978695266367</link>    <guid>https://juejin.cn/post/7594642978695266367</guid>    <pubDate>2026-01-13T08:03:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594642978695266367" data-draft-id="7594642978695249983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计一个支持万人同时抢购商品的秒杀系统?"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-13T08:03:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计一个支持万人同时抢购商品的秒杀系统?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:03:47.000Z" title="Tue Jan 13 2026 08:03:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、系统架构设计</h2>
<h3 data-id="heading-1">1. 分层架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">客户端层 → 接入层 → 业务服务层 →  数据层
<span class="hljs-code">     ↓       ↓         ↓          ↓
    限流    缓存       队列      数据库
</span></code></pre>
<h3 data-id="heading-2">2. 具体组件</h3>
<ul>
<li><strong>客户端</strong>：静态资源CDN、倒计时校准、防重复提交</li>
<li><strong>接入层</strong>：Nginx+Lua/OpenResty，做第一层限流和缓存</li>
<li><strong>业务层</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>秒杀服务集群（无状态）</li>
<li>消息队列（Kafka/RocketMQ）</li>
<li>缓存集群（Redis Cluster）</li>
</ul>
</li>
</ul>

<ul>
<li><strong>数据层</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>主从数据库（读写分离）</li>
<li>分库分表（按商品/时间）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">二、核心问题解决方案</h2>
<h3 data-id="heading-4">1. 超卖问题</h3>
<h4 data-id="heading-5">解决方案一：Redis原子操作</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用Redis的DECR原子操作扣减库存</span>
def deduct_stock(product_id, user_id):
    <span class="hljs-attr">stock_key</span> = f<span class="hljs-string">"stock:{product_id}"</span>

<span class="hljs-comment"># Lua脚本保证原子性</span>
<span class="hljs-attr">lua_script</span> = <span class="hljs-string">"""
local stock = tonumber(redis.call('GET', KEYS[1]))
if stock and stock &gt; 0 then
redis.call('DECR', KEYS[1])
return 1
end
return 0
"""</span>

<span class="hljs-attr">result</span> = redis.eval(lua_script, <span class="hljs-number">1</span>, stock_key)
return <span class="hljs-attr">result</span> == <span class="hljs-number">1</span>
</code></pre>
<h4 data-id="heading-6">解决方案二：数据库乐观锁</h4>
<pre><code class="hljs language-ini" lang="ini">UPDATE products 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = ? AND stock &gt; <span class="hljs-number">0</span> AND version = ?
</code></pre>
<h4 data-id="heading-7">解决方案三：预扣库存</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 先预扣Redis库存，再异步同步到DB</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">preDeductStock</span><span class="hljs-params">(<span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> count)</span> </span>{
    <span class="hljs-type">String</span> key = <span class="hljs-string">"seckill:stock:"</span> + productId;
    Long remaining = redisTemplate.<span class="hljs-built_in">opsForValue</span>().<span class="hljs-built_in">decrement</span>(key, count);

    <span class="hljs-keyword">if</span> (remaining &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 发送MQ消息异步扣减数据库</span>
        <span class="hljs-built_in">sendStockDeductMessage</span>(productId, count);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 库存不足，回滚</span>
        redisTemplate.<span class="hljs-built_in">opsForValue</span>().<span class="hljs-built_in">increment</span>(key, count);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">2. 高并发请求处理</h3>
<h4 data-id="heading-9">2.1 流量削峰</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用消息队列缓冲请求</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate mqTemplate;

    <span class="hljs-keyword">public</span> SeckillResult seckill(SeckillRequest request) {
        <span class="hljs-comment">// 1. 校验用户和商品状态</span>
        <span class="hljs-keyword">if</span> (!validate(request)) {
            <span class="hljs-keyword">return</span> SeckillResult.fail(<span class="hljs-string">"校验失败"</span>);
        }

        <span class="hljs-comment">// 2. 生成唯一请求ID</span>
        String requestId = generateRequestId(request);

        <span class="hljs-comment">// 3. 请求入队，立即返回</span>
        mqTemplate.sendOneWay(<span class="hljs-string">"seckill-topic"</span>, 
                              MessageBuilder.withPayload(request).build());

        <span class="hljs-comment">// 4. 返回排队中状态，前端轮询结果</span>
        <span class="hljs-keyword">return</span> SeckillResult.processing(requestId);
    }
}
</code></pre>
<h4 data-id="heading-10">2.2 分层过滤</h4>
<pre><code class="hljs">所有请求 → 合法性校验 → 库存校验 → 频率控制 → 实际下单
   ↓           ↓          ↓         ↓         ↓
 100万        50万       10万       5万       1万
</code></pre>
<h3 data-id="heading-11">3. 系统性能优化</h3>
<h4 data-id="heading-12">3.1 缓存策略</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 多级缓存配置</span>
<span class="hljs-section">缓存层级:</span>
  一级: JVM本地缓存 (Caffeine) - 热点商品
  二级: Redis集群 - 库存信息
  三级: 数据库 - 最终一致性
</code></pre>
<h4 data-id="heading-13">3.2 读多写少优化</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 商品信息缓存预热</span>
<span class="hljs-keyword">@Service</span>
public class CacheWarmUpService {

    <span class="hljs-keyword">@PostConstruct</span>
    public void warmUpSeckillProducts() {
        List&lt;Product&gt; hotProducts = <span class="hljs-built_in">loadHotProducts</span>();

        for (Product product : hotProducts) {
            <span class="hljs-comment">// 库存信息</span>
            redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                "stock:" + product.getId(),
                product<span class="hljs-selector-class">.getStock</span>()
            );

            <span class="hljs-comment">// 商品详情</span>
            redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                "product:" + product.getId(),
                JSON<span class="hljs-selector-class">.toJSONString</span>(product)
            );

            <span class="hljs-comment">// 使用布隆过滤器存储可售商品ID</span>
            bloomFilter<span class="hljs-selector-class">.add</span>(product.getId());
        }
    }
}
</code></pre>
<h3 data-id="heading-14">4. 详细实现方案</h3>
<h4 data-id="heading-15">4.1 秒杀流程</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillSystem</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_seckill</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, user_id, product_id</span>):
        <span class="hljs-comment"># 1. 恶意请求拦截</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.check_risk(user_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">403</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"访问过于频繁"</span>}

        <span class="hljs-comment"># 2. 布隆过滤器快速判断</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bloom_filter.contains(product_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">404</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"商品不存在"</span>}

        <span class="hljs-comment"># 3. 内存标记（已售罄的商品直接返回）</span>
        <span class="hljs-keyword">if</span> sold_out_flags.get(product_id):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"已售罄"</span>}

        <span class="hljs-comment"># 4. Redis原子扣减库存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.deduct_stock_in_redis(product_id):
            sold_out_flags[product_id] = <span class="hljs-title class_">True</span>
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"库存不足"</span>}

        <span class="hljs-comment"># 5. 生成订单ID（雪花算法）</span>
        order_id = snowflake.generate()

        <span class="hljs-comment"># 6. 订单信息入队</span>
        mq.send({
            <span class="hljs-string">"order_id"</span>: order_id,
            <span class="hljs-string">"user_id"</span>: user_id,
            <span class="hljs-string">"product_id"</span>: product_id,
            <span class="hljs-string">"time"</span>: time.time()
        })

        <span class="hljs-comment"># 7. 返回排队中</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"排队中"</span>,
            <span class="hljs-string">"order_id"</span>: order_id,
            <span class="hljs-string">"queue_position"</span>: get_queue_position(order_id)
        }
</code></pre>
<h4 data-id="heading-16">4.2 库存同步方案</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Component</span>
<span class="hljs-keyword">@Slf</span>4j
public class StockSyncService {

    <span class="hljs-comment">// 数据库最终扣减</span>
    <span class="hljs-keyword">@Transactional</span>
    public void syncStockToDB(String productId, int count) {
        try {
            <span class="hljs-comment">// 数据库扣减（带重试机制）</span>
            boolean success = productDAO<span class="hljs-selector-class">.deductStock</span>(productId, count);

            if (success) {
                <span class="hljs-comment">// 更新Redis中的最终库存状态</span>
                redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
                    "stock_final:" + productId,
                    getDBStock(productId)
                );

                <span class="hljs-comment">// 删除售罄标记</span>
                soldOutCache<span class="hljs-selector-class">.remove</span>(productId);
            }
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("库存同步失败", e);
            <span class="hljs-comment">// 记录异常，人工介入处理</span>
            alertService<span class="hljs-selector-class">.sendAlert</span>(e);
        }
    }

    <span class="hljs-comment">// 库存对账任务</span>
    <span class="hljs-keyword">@Scheduled</span>(cron = <span class="hljs-string">"0 */5 * * * ?"</span>)
    public void stockReconciliation() {
        List&lt;Product&gt; products = productDAO<span class="hljs-selector-class">.getAllSeckillProducts</span>();

        for (Product product : products) {
            Integer redisStock = <span class="hljs-built_in">getRedisStock</span>(product.getId());
            Integer dbStock = product<span class="hljs-selector-class">.getStock</span>();

            if (!Objects.equals(redisStock, dbStock)) {
                log<span class="hljs-selector-class">.warn</span>("库存不一致: productId={}, redis={}, db={}", 
                         product.getId(), redisStock, dbStock);
                <span class="hljs-comment">// 自动修复或报警</span>
                <span class="hljs-built_in">fixStockInconsistency</span>(product.getId(), dbStock);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">三、高可用保障</h2>
<h3 data-id="heading-18">1. 限流降级策略</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 多维度限流配置</span>
<span class="hljs-section">限流规则:</span>
  用户维度: 每个用户10次/分钟
  IP维度: 每个IP 1000次/分钟
  商品维度: 每个商品 10000次/分钟
  总QPS: 系统最大承受50000 QPS
</code></pre>
<h3 data-id="heading-19">2. 熔断降级</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@Slf4j</span>
public class SeckillController {

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/seckill/{productId}"</span>)
    <span class="hljs-variable">@HystrixCommand</span>(
        fallbackMethod = <span class="hljs-string">"seckillFallback"</span>,
        commandProperties = {
            <span class="hljs-variable">@HystrixProperty</span>(name = <span class="hljs-string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="hljs-string">"1000"</span>),
            <span class="hljs-variable">@HystrixProperty</span>(name = <span class="hljs-string">"circuitBreaker.requestVolumeThreshold"</span>, value = <span class="hljs-string">"20"</span>)
        }
    )
    public Response <span class="hljs-built_in">seckill</span>(<span class="hljs-variable">@PathVariable</span> String productId, 
                            <span class="hljs-variable">@RequestParam</span> String userId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">seckillService</span><span class="hljs-selector-class">.process</span>(userId, productId);
    }

    <span class="hljs-comment">// 降级方法</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Response</span> <span class="hljs-selector-tag">seckillFallback</span>(String productId, String userId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Response</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
    }
}
</code></pre>
<h2 data-id="heading-20">四、监控与告警</h2>
<h3 data-id="heading-21">1. 关键监控指标</h3>
<ul>
<li><strong>系统层面</strong>：QPS、RT、错误率、CPU/内存使用率</li>
<li><strong>应用层面</strong>：库存扣减成功率、消息堆积量</li>
<li><strong>业务层面</strong>：抢购成功率、用户排队时长</li>
</ul>
<h3 data-id="heading-22">2. 监控实现</h3>
<pre><code class="hljs language-arduino" lang="arduino">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillMonitor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;

    <span class="hljs-comment">// 记录关键指标</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordSeckill</span><span class="hljs-params">(<span class="hljs-type">String</span> productId, <span class="hljs-type">boolean</span> success, <span class="hljs-type">long</span> cost)</span> </span>{
        <span class="hljs-comment">// QPS监控</span>
        meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.requests.total"</span>).<span class="hljs-built_in">increment</span>();

        <span class="hljs-keyword">if</span> (success) {
            meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.success.total"</span>).<span class="hljs-built_in">increment</span>();
        } <span class="hljs-keyword">else</span> {
            meterRegistry.<span class="hljs-built_in">counter</span>(<span class="hljs-string">"seckill.fail.total"</span>).<span class="hljs-built_in">increment</span>();
        }

        <span class="hljs-comment">// 耗时分布</span>
        meterRegistry.<span class="hljs-built_in">timer</span>(<span class="hljs-string">"seckill.process.time"</span>)
        .<span class="hljs-built_in">record</span>(cost, TimeUnit.MILLISECONDS);

        <span class="hljs-comment">// 库存变化</span>
        meterRegistry.<span class="hljs-built_in">gauge</span>(<span class="hljs-string">"seckill.stock."</span> + productId, 
                            <span class="hljs-built_in">getCurrentStock</span>(productId));
    }
}
</code></pre>
<h2 data-id="heading-23">五、部署与扩展</h2>
<h3 data-id="heading-24">1. 弹性扩展策略</h3>
<ul>
<li><strong>水平扩展</strong>：无状态服务可快速扩容</li>
<li><strong>自动伸缩</strong>：基于CPU使用率或QPS自动扩缩容</li>
<li><strong>异地多活</strong>：重要业务支持多机房部署</li>
</ul>
<h3 data-id="heading-25">2. 压测方案</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">压测场景:</span>
  场景1: 库存预热，10万用户同时抢1万商品
  场景2: 持续高压，5万QPS持续5分钟
  场景3: 峰值冲击，瞬间20万QPS
  
<span class="hljs-section">压测目标:</span>
  成功率: &gt;99.9%
  平均RT: &lt;100ms
  错误率: &lt;0.1%
</code></pre>
<h2 data-id="heading-26">六、安全考虑</h2>
<ol>
<li><strong>防刷机制</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>验证码（峰值时降级）</li>
<li>设备指纹</li>
<li>行为分析</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>数据安全</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>关键数据加密</li>
<li>操作日志记录</li>
<li>防篡改校验</li>
</ul>
</li>
</ul>
<h2 data-id="heading-27">总结要点</h2>
<ol>
<li><strong>架构核心</strong>：分层过滤 + 异步处理 + 最终一致</li>
<li><strong>库存核心</strong>：Redis原子操作 + 消息队列 + 数据库乐观锁</li>
<li><strong>性能核心</strong>：缓存预热 + 流量削峰 + 读写分离</li>
<li><strong>稳定核心</strong>：熔断降级 + 限流隔离 + 快速失败</li>
</ol>
<h2 data-id="heading-28">面试回答</h2>
<p>首先，<strong>架构设计上要动静分离、分层削峰</strong>。我会把系统分为：</p>
<ol>
<li><strong>静态资源分离</strong>：商品图片、描述页等提前推送到CDN，请求直接走边缘节点，不给后端压力。</li>
<li><strong>网关层限流</strong>：在入口用Nginx或网关（如Sentinel）做恶意请求拦截和总流量限制，比如对同一UID限速，超过阈值直接返回“请求频繁”。</li>
<li><strong>业务逻辑后置，请求队列化</strong>：秒杀的核心——“下单扣库存”这个最重要的逻辑，绝不放在前台实时处理。用户点击“抢购”后，前端直接返回“排队中”，请求进入一个<strong>消息队列</strong>（比如RabbitMQ、Kafka或RocketMQ）。这样一来，海量并发就被平滑成顺序处理的流量，后端服务按照自己的能力从队列里慢慢消费，实现<strong>削峰填谷</strong>。</li>
<li><strong>服务独立部署</strong>：把秒杀相关的功能（验资格、扣库存）单独做成一个微服务，避免影响商城其他正常功能（如浏览、普通下单）。</li>
</ol>
<p>其次，针对如何解决超卖、库存扣减和高并发请求这三个核心问题，我的解决方案是：</p>
<ol>
<li><strong>解决超卖和库存扣减</strong>：这是秒杀的核心。我的方案是：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>预扣库存</strong>：活动开始前，把商品的库存从主库加载到<strong>Redis</strong>中。Redis是单线程内存操作，可以保证原子性。</li>
<li><strong>原子化操作</strong>：在Redis里，使用 <code>DECR</code> 或 <code>LUA</code> 脚本来扣减库存。<code>DECR</code> 命令会直接返回扣减后的值，如果返回值小于0，就说明库存没了，后续流程直接返回售罄。LUA脚本可以打包多个操作（检查库存、扣减），确保整个过程原子性，彻底杜绝超卖。</li>
<li><strong>最终同步</strong>：后台服务从队列消费，成功扣减Redis库存后，生成一个订单ID（但状态是“未支付”），再异步去更新数据库的库存。这里数据库的库存更多是用于后续对账和长尾查询。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>应对高并发请求</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>限流</strong>：除了网关层的总限流，在秒杀服务本身也要做限流，比如用信号量或令牌桶控制处理线程数，只服务自己能承受的流量，多的直接拒绝，快速失败。</li>
<li><strong>无状态化与扩容</strong>：秒杀服务做成无状态的，方便用K8s或云服务快速横向扩容，扛过峰值后再缩容，控制成本。</li>
<li><strong>热点数据隔离</strong>：对于“爆款”商品，它的库存Key在Redis里是热点Key。可以做两件事：一是提前对它进行<strong>Key散列</strong>，把压力分散到多个Redis节点；二是使用Redis集群模式，并开启读写分离。</li>
</ul>
</li>
</ul>
<p>最后，还有一些<strong>关键的细节和兜底策略</strong>：</p>
<ul>
<li><strong>防刷与验证</strong>：前端加入计算型验证码或答题，防止机器人；下单前必须校验用户资格（是否登录、地址完善等）。</li>
<li><strong>异步下单与结果轮询</strong>：用户提交后，服务端返回一个“排队ID”，前端用这个ID轮询后端，查询最终结果（成功、失败或等待）。用户体验上是“排队等待”，而不是一直卡住或报错。</li>
<li><strong>数据一致性对账</strong>：因为用了Redis和消息队列，可能出现极端情况下的数据不一致（比如Redis扣成功，但下游服务挂了，订单没生成）。需要有一个定时对账任务，核对Redis、数据库库存和订单状态，进行修复。</li>
<li><strong>降级与熔断</strong>：如果Redis或数据库访问慢，要有熔断机制，防止服务被拖垮。比如可以快速降级到“返回售罄”的静态页面。</li>
</ul>
<hr/>
<p><strong>总结一下</strong>，我的设计思路是：<strong>前端限流拦截，请求队列削峰；Redis原子扣减防超卖；服务无状态化应对高并发；再通过异步、对账等手段保证最终一致性和用户体验</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite8 Beta来了,Rolldown携手Oxc]]></title>    <link>https://juejin.cn/post/7594626381432487986</link>    <guid>https://juejin.cn/post/7594626381432487986</guid>    <pubDate>2026-01-13T08:13:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432487986" data-draft-id="7594578555352105011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite8 Beta来了,Rolldown携手Oxc"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T08:13:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite8 Beta来了,Rolldown携手Oxc
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:13:54.000Z" title="Tue Jan 13 2026 08:13:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vite8 Beta来了,Rolldown携手Oxc</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7bb3791688449084b08ba66cd2fbfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6X5aSq55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768896833&amp;x-signature=Eyp00QQn064Dq9RAqE4va%2Fl9Mlw%3D" alt="" loading="lazy"/></p>
<p>总结：由 Rolldown 驱动的 Vite</p>
<h3 data-id="heading-1">更新地址</h3>
<p>相关更新地址</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// github地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/vitejs/vite/blob/main/packages/vite/CHANGELOG.md</span>

<span class="hljs-comment">// 官方给我们的更新地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//cn.vitejs.dev/guide/migration</span>

<span class="hljs-comment">// 更新说明地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//vite.dev/blog/announcing-vite8-beta</span>
</code></pre>
<p>接下来我们就看看vite8更新了哪些东西</p>
<h3 data-id="heading-2">重大更新</h3>
<p>先来看看有哪些重大的更新方面</p>
<ul>
<li><strong>性能</strong>：Rolldown 使用 Rust 编写，运行速度与原生应用相当。它的性能水平与 esbuild 相匹配，并且比 Rollup 快 10-30 倍。</li>
<li><strong>兼容性</strong>：Rolldown 支持与 Rollup 和 Vite 相同的插件 API。大多数 Vite 插件在 Vite 8 中可以开箱即用。</li>
<li><strong>更多功能</strong>：Rolldown 为 Vite 解锁了更多高级功能，包括完整打包模式、更灵活的分块控制、模块级持久缓存、模块联邦等。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Vite</span>（构建工具）
<span class="hljs-title class_">Rolldown</span>（打包器）
<span class="hljs-title class_">Oxc</span>（编译器、压缩器）
</code></pre>
<h4 data-id="heading-3">统一工具链</h4>
<pre><code class="hljs language-javascript" lang="javascript">打包工具利用
语法解析器（parsers）
依赖解析器（resolvers）
转换器（transformers）
压缩器（minifiers）
</code></pre>
<p>Rolldown 为统一工具链使用了由VoidZero 团队主导的项目Oxc</p>
<h4 data-id="heading-4">Rolldown</h4>
<p>作用：使用Rolldown 替代esbuild 和 Rollup</p>
<p>Vite 8 基于Rolldown 和 Oxc 的工具，而不是 esbuild 和 Rollup</p>
<p>Vite之前的引擎架构——开发用 esbuild，生产用 Rollup</p>
<h4 data-id="heading-5">使用 Oxc 转换 JavaScript</h4>
<p>使用 Oxc 进行 JavaScript 转换，而不是 esbuild</p>
<h4 data-id="heading-6">使用 Lightning CSS 进行 CSS 压缩</h4>
<p>默认使用 Lightning CSS 进行 CSS 压缩。你可以使用 <code>build.cssMinify: 'esbuild'</code> 选项切换回 esbuild。请注意，你需要将 <code>esbuild</code> 安装为 <code>devDependency</code>。</p>
<p>Lightning CSS 支持更好的语法降级，你的 CSS 包大小可能会略有增加</p>
<h4 data-id="heading-7">一些移除和弃用</h4>
<p>我们简单看看一些废弃和弃用的部分</p>
<p>非常重要更新,我建议是正式版出来直接移除esbuild</p>
<pre><code class="hljs language-javascript" lang="javascript">esbuild 现在已被弃用，将来会被移除
</code></pre>
<p>弃用以及将要移除，尽快处理</p>
<pre><code class="hljs language-javascript" lang="javascript">optimizeDeps.<span class="hljs-property">esbuildOptions</span> 弃用 =&gt; 将来会被移除


build.<span class="hljs-property">rollupOptions</span>.<span class="hljs-property">watch</span>.<span class="hljs-property">chokidar</span> 移除 
=&gt; 
迁移到 build.<span class="hljs-property">rolldownOptions</span>.<span class="hljs-property">watch</span>.<span class="hljs-property">notify</span> 


build.<span class="hljs-property">rollupOptions</span>.<span class="hljs-property">output</span>.<span class="hljs-property">manualChunks</span> 弃用 
=&gt; 
更新成为 advancedChunks

<span class="hljs-comment">// advancedChunks文档使用</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//rolldown.rs/in-depth/advanced-chunks</span>


build.<span class="hljs-property">rollupOptions</span>
=&gt; 重命名为 build.<span class="hljs-property">rolldownOptions</span>

worker.<span class="hljs-property">rollupOptions</span>
  =&gt; 重命名为 worker.<span class="hljs-property">rolldownOptions</span>

build.<span class="hljs-property">commonjsOptions</span>：
  =&gt; 现在无操作效果
</code></pre>
<p>自动转换</p>
<pre><code class="hljs language-javascript" lang="javascript">esbuildOptions.<span class="hljs-property">minify</span> -&gt; rolldownOptions.<span class="hljs-property">output</span>.<span class="hljs-property">minify</span>
esbuildOptions.<span class="hljs-property">treeShaking</span> -&gt; rolldownOptions.<span class="hljs-property">treeshake</span>
esbuildOptions.<span class="hljs-property">define</span> -&gt; rolldownOptions.<span class="hljs-property">transform</span>.<span class="hljs-property">define</span>
esbuildOptions.<span class="hljs-property">loader</span> -&gt; rolldownOptions.<span class="hljs-property">moduleTypes</span>
esbuildOptions.<span class="hljs-property">preserveSymlinks</span> -&gt; !rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">symlinks</span>
esbuildOptions.<span class="hljs-property">resolveExtensions</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">extensions</span>
esbuildOptions.<span class="hljs-property">mainFields</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">mainFields</span>
esbuildOptions.<span class="hljs-property">conditions</span> -&gt; rolldownOptions.<span class="hljs-property">resolve</span>.<span class="hljs-property">conditionNames</span>
esbuildOptions.<span class="hljs-property">keepNames</span> -&gt; rolldownOptions.<span class="hljs-property">output</span>.<span class="hljs-property">keepNames</span>
esbuildOptions.<span class="hljs-property">platform</span> -&gt; rolldownOptions.<span class="hljs-property">platform</span>
esbuildOptions.<span class="hljs-property">plugins</span> -&gt; rolldownOptions.<span class="hljs-property">plugins</span> (partial support)
</code></pre>
<p>剩余就是一些其余更新，这里不做阐述,基本也不用看，除非用到了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//cn.vite.dev/guide/migration#migration-from-v7</span>
</code></pre>
<h3 data-id="heading-8">项目升级</h3>
<h4 data-id="heading-9">官方升级建议</h4>
<p>官方给我们提供了两种建议适用更新</p>
<h5 data-id="heading-10">直接升级：</h5>
<p>更新 package.json 并运行常规的开发和构建命令。</p>
<p>适合：自己的项目和博客</p>
<h5 data-id="heading-11">渐进式迁移：</h5>
<p>先从 Vite 7 迁移到 rolldown-vite 包，然后再到 Vite 8。</p>
<p>这样你可以识别出与 Rolldown 相关的不兼容性或问题，而无需对 Vite 进行其他更改。</p>
<p>适合：较大或复杂的项目或者稳定项目</p>
<h4 data-id="heading-12">项目更新</h4>
<p>接下来我们就在我们项目之中升级并且使用这些部分</p>
<p>我本地的Node版本为<code>Node 22.16.0</code></p>
<p>我们本地是vite7，官方的建议是</p>
<p>对于从 rolldown-vite 迁移到 Vite 8 的用户，你可以撤销 package.json 中的依赖变更并更新到 Vite 8</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^8.0.0"</span>
  }
}
</code></pre>
<p>运行我们的更新命令</p>
<pre><code class="hljs language-javascript" lang="javascript">pnpm add -D vite@<span class="hljs-number">8.0</span><span class="hljs-number">.0</span>-beta<span class="hljs-number">.0</span> @vitejs/plugin-vue@latest
</code></pre>
<p>执行完以后可以看到我们安装文件部分更新</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">"vite"</span>: <span class="hljs-string">"8.0.0-beta.0"</span>,
</code></pre>
<p>更新完成以后提示我们</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">devDependencies</span>:
- vite <span class="hljs-number">7.3</span><span class="hljs-number">.0</span>
+ vite <span class="hljs-number">8.0</span><span class="hljs-number">.0</span>-beta<span class="hljs-number">.0</span>
</code></pre>
<p>然后正常启动打包都没问题,速度上可能因为我的项目比较小，没有太大的区别，打包的体积确实小了</p>
<h4 data-id="heading-13">manualChunks更新</h4>
<p>官方之前对于这部分进行了更新，我们配置一下</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧写法，Vite 8 直接报错</span>
<span class="hljs-attr">rollupOptions</span>: {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">manualChunks</span>: {
      <span class="hljs-string">'vue-vendor'</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'pinia'</span>],
      <span class="hljs-string">'monaco'</span>: [<span class="hljs-string">'monaco-editor'</span>],
    }
  }
}


<span class="hljs-comment">// 新写法</span>
<span class="hljs-attr">rollupOptions</span>: {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">advancedChunks</span>: {
      <span class="hljs-attr">groups</span>: [
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-vendor'</span>, <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](vue|pinia)[\\/]/</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'monaco'</span>, <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]monaco-editor[\\/]/</span> },
      ]
    }
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"算法推荐"这么准？——从协同过滤到深度学习]]></title>    <link>https://juejin.cn/post/7594402344618131471</link>    <guid>https://juejin.cn/post/7594402344618131471</guid>    <pubDate>2026-01-13T08:36:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594402344618131471" data-draft-id="7594655863547379764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 为什么&quot;算法推荐&quot;这么准？——从协同过滤到深度学习"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T08:36:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             为什么"算法推荐"这么准？——从协同过滤到深度学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:36:58.000Z" title="Tue Jan 13 2026 08:36:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 为什么"算法推荐"这么准？——从协同过滤到深度学习 🤖</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下：你打开抖音，刷到的都是你喜欢的视频；你打开淘宝，首页推荐的都是你想买的商品；你打开 Netflix，推荐的都是你想看的电影——这是不是很神奇？</p>
<p>这就是<strong>算法推荐</strong>的魔力！它就像你的"贴心小助手"，总能知道你喜欢什么，想要什么。</p>
<h3 data-id="heading-1">🤔 核心问题：算法推荐的工作原理是什么？为什么能准确预测用户喜好？</h3>
<p>很多人觉得"算法推荐"是个神秘的黑盒子，其实它的本质很简单：<strong>通过分析你的行为数据，找到你的喜好规律，然后推荐符合你喜好的内容</strong>。</p>
<h4 data-id="heading-2">算法推荐的"四大法宝"</h4>
<ul>
<li>📊 <strong>数据收集</strong>：收集你的浏览、点击、购买、评分等行为数据</li>
<li>🧠 <strong>用户画像</strong>：构建你的兴趣模型，了解你的喜好</li>
<li>🔍 <strong>相似度计算</strong>：找到与你兴趣相似的用户或内容</li>
<li>🚀 <strong>推荐算法</strong>：根据相似度和其他因素生成推荐结果</li>
</ul>
<h4 data-id="heading-3">为什么算法推荐这么准？</h4>
<ul>
<li>📱 <strong>数据量庞大</strong>：每天收集海量的用户行为数据</li>
<li>🧮 <strong>机器学习</strong>：通过深度学习模型不断优化推荐结果</li>
<li>🔄 <strong>实时更新</strong>：根据你的最新行为实时调整推荐</li>
<li>🎯 <strong>个性化定制</strong>：为每个用户生成独一无二的推荐列表</li>
</ul>
<h3 data-id="heading-4">📜 从"协同过滤"到"深度学习"：算法推荐的进化史</h3>
<h4 data-id="heading-5">1. 🤝 早期协同过滤："物以类聚，人以群分"</h4>
<p>20 世纪 90 年代，<strong>协同过滤</strong>算法诞生，这是最早的推荐算法。</p>
<p><strong>原理</strong>：</p>
<ul>
<li><strong>基于用户的协同过滤</strong>：找到与你兴趣相似的用户，推荐他们喜欢的内容</li>
<li><strong>基于物品的协同过滤</strong>：找到与你喜欢的内容相似的内容，推荐给你</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>不需要内容的详细信息</li>
<li>能够发现用户的潜在兴趣</li>
<li>推荐结果具有多样性</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>冷启动问题（新用户或新物品无法推荐）</li>
<li>数据稀疏性问题</li>
<li>计算复杂度高</li>
</ul>
<p><strong>代表应用</strong>：早期的亚马逊推荐、MovieLens 电影推荐</p>
<h4 data-id="heading-6">2. 📝 基于内容的推荐："内容为王"</h4>
<p>2000 年代，<strong>基于内容的推荐</strong>算法开始兴起。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>分析内容的特征（如电影的类型、演员、导演）</li>
<li>分析用户的历史行为，构建用户兴趣模型</li>
<li>将用户兴趣与内容特征匹配，生成推荐</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>不依赖其他用户的数据</li>
<li>容易解释推荐原因</li>
<li>可以处理冷启动问题</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>推荐结果缺乏多样性</li>
<li>只能推荐与用户历史兴趣相似的内容</li>
<li>对内容特征的提取要求较高</li>
</ul>
<p><strong>代表应用</strong>：新闻推荐、音乐推荐</p>
<h4 data-id="heading-7">3. 🧠 深度学习推荐："AI 驱动的推荐"</h4>
<p>2010 年代，随着深度学习的兴起，<strong>深度学习推荐</strong>算法成为主流。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>使用深度神经网络自动学习用户和内容的特征</li>
<li>能够处理非结构化数据（如图片、音频、视频）</li>
<li>可以捕捉用户兴趣的动态变化</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>推荐准确率高</li>
<li>能够处理复杂的非线性关系</li>
<li>可以整合多种数据源</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>计算资源需求高</li>
<li>推荐结果难以解释</li>
<li>容易出现"过滤气泡"问题</li>
</ul>
<p><strong>代表应用</strong>：抖音、淘宝、Netflix</p>
<h4 data-id="heading-8">4. 🌈 多模态推荐："视听结合"</h4>
<p>2020 年代，<strong>多模态推荐</strong>算法开始崭露头角。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>同时处理多种模态的数据（文本、图像、音频、视频）</li>
<li>学习不同模态之间的关联关系</li>
<li>生成更全面、更准确的推荐</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>能够捕捉内容的丰富信息</li>
<li>推荐结果更加精准</li>
<li>可以处理复杂的多媒体内容</li>
</ul>
<p><strong>代表应用</strong>：短视频推荐、直播推荐、元宇宙内容推荐</p>
<h3 data-id="heading-9">🔧 技术原理：算法推荐的"秘密武器"</h3>
<h4 data-id="heading-10">1. 📱 用户画像构建："了解你的喜好"</h4>
<p>用户画像是算法推荐的<strong>基础</strong>，它是对用户兴趣的<strong>数字化描述</strong>。</p>
<p><strong>构建用户画像的步骤</strong>：</p>
<ul>
<li><strong>数据收集</strong>：收集用户的基本信息、行为数据、内容偏好等</li>
<li><strong>特征提取</strong>：从数据中提取有价值的特征（如年龄、性别、兴趣标签）</li>
<li><strong>模型构建</strong>：使用机器学习算法构建用户兴趣模型</li>
<li><strong>持续更新</strong>：根据用户的最新行为实时更新用户画像</li>
</ul>
<p><strong>用户画像的类型</strong>：</p>
<ul>
<li><strong>显性画像</strong>：用户主动提供的信息（如性别、年龄、职业）</li>
<li><strong>隐性画像</strong>：通过行为数据推断的信息（如兴趣偏好、消费能力）</li>
</ul>
<h4 data-id="heading-11">2. 🎨 物品特征提取："了解内容的特点"</h4>
<p>物品特征是算法推荐的<strong>另一个基础</strong>，它是对内容的<strong>数字化描述</strong>。</p>
<p><strong>常见的物品特征</strong>：</p>
<ul>
<li><strong>文本特征</strong>：标题、描述、标签、关键词</li>
<li><strong>图像特征</strong>：颜色、形状、纹理、物体识别结果</li>
<li><strong>音频特征</strong>：频谱、节奏、音调、情感</li>
<li><strong>视频特征</strong>：镜头切换、动作识别、场景识别</li>
</ul>
<p><strong>特征提取的方法</strong>：</p>
<ul>
<li><strong>传统方法</strong>：TF-IDF、Word2Vec、CNN 等</li>
<li><strong>深度学习方法</strong>：BERT、GPT、ResNet、Transformer 等</li>
</ul>
<h4 data-id="heading-12">3. 🔍 相似度计算："找到相似的人或内容"</h4>
<p>相似度计算是算法推荐的<strong>核心</strong>，它决定了推荐的准确性。</p>
<p><strong>常见的相似度算法</strong>：</p>
<ul>
<li><strong>余弦相似度</strong>：计算两个向量之间的夹角</li>
<li><strong>皮尔逊相关系数</strong>：计算两个变量之间的线性相关性</li>
<li><strong>杰卡德相似度</strong>：计算两个集合的交集与并集的比值</li>
<li><strong>欧几里得距离</strong>：计算两个点之间的直线距离</li>
</ul>
<p><strong>相似度计算的应用</strong>：</p>
<ul>
<li><strong>用户相似度</strong>：找到与你兴趣相似的用户</li>
<li><strong>物品相似度</strong>：找到与你喜欢的内容相似的内容</li>
</ul>
<h4 data-id="heading-13">4. 🤖 深度神经网络模型："AI 的大脑"</h4>
<p>深度神经网络是现代推荐算法的<strong>核心</strong>，它能够自动学习复杂的非线性关系。</p>
<p><strong>常见的深度学习推荐模型</strong>：</p>
<ul>
<li><strong>MLP（多层感知器）</strong>：基础的深度学习模型</li>
<li><strong>Wide &amp; Deep</strong>：结合了线性模型和深度模型的优点</li>
<li><strong>DeepFM</strong>：结合了因子分解机和深度模型的优点</li>
<li><strong>DIN（深度兴趣网络）</strong>：能够捕捉用户的动态兴趣</li>
<li><strong>BERT4Rec</strong>：基于 BERT 的序列推荐模型</li>
<li><strong>Transformer4Rec</strong>：基于 Transformer 的序列推荐模型</li>
</ul>
<h3 data-id="heading-14">💻 代码实例：简单的协同过滤推荐算法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sklearn.metrics.pairwise <span class="hljs-keyword">import</span> cosine_similarity

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CollaborativeFiltering</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, user_item_matrix</span>):
        <span class="hljs-string">"""初始化协同过滤模型"""</span>
        self.user_item_matrix = user_item_matrix
        self.user_similarity = <span class="hljs-literal">None</span>
        self.item_similarity = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_user_similarity</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""计算用户相似度"""</span>
        self.user_similarity = cosine_similarity(self.user_item_matrix)
        <span class="hljs-keyword">return</span> self.user_similarity

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_item_similarity</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""计算物品相似度"""</span>
        self.item_similarity = cosine_similarity(self.user_item_matrix.T)
        <span class="hljs-keyword">return</span> self.item_similarity

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_user_based</span>(<span class="hljs-params">self, user_id, item_id, k=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""基于用户的协同过滤预测"""</span>
        <span class="hljs-comment"># 找到与目标用户最相似的k个用户</span>
        similar_users = np.argsort(self.user_similarity[user_id])[-k-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>][::-<span class="hljs-number">1</span>]

        <span class="hljs-comment"># 计算预测评分</span>
        numerator = <span class="hljs-number">0</span>
        denominator = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> sim_user <span class="hljs-keyword">in</span> similar_users:
            <span class="hljs-keyword">if</span> self.user_item_matrix[sim_user, item_id] &gt; <span class="hljs-number">0</span>:
                numerator += self.user_similarity[user_id, sim_user] * self.user_item_matrix[sim_user, item_id]
                denominator += self.user_similarity[user_id, sim_user]

        <span class="hljs-keyword">if</span> denominator == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

        <span class="hljs-keyword">return</span> numerator / denominator

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recommend_items</span>(<span class="hljs-params">self, user_id, k=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""为用户推荐k个物品"""</span>
        <span class="hljs-comment"># 计算用户相似度</span>
        <span class="hljs-keyword">if</span> self.user_similarity <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.calculate_user_similarity()

        <span class="hljs-comment"># 找到用户已经评分的物品</span>
        rated_items = <span class="hljs-built_in">set</span>(np.where(self.user_item_matrix[user_id] &gt; <span class="hljs-number">0</span>)[<span class="hljs-number">0</span>])

        <span class="hljs-comment"># 预测未评分物品的评分</span>
        predictions = []
        <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.user_item_matrix.shape[<span class="hljs-number">1</span>]):
            <span class="hljs-keyword">if</span> item_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> rated_items:
                predicted_score = self.predict_user_based(user_id, item_id)
                predictions.append((item_id, predicted_score))

        <span class="hljs-comment"># 按照预测评分排序，推荐k个物品</span>
        predictions.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> predictions[:k]

<span class="hljs-comment"># 测试协同过滤算法</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 构建用户-物品评分矩阵</span>
    <span class="hljs-comment"># 用户：0,1,2,3,4</span>
    <span class="hljs-comment"># 物品：0,1,2,3,4</span>
    user_item_matrix = np.array([
        [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 用户0</span>
        [<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>],  <span class="hljs-comment"># 用户1</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 用户2</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>],  <span class="hljs-comment"># 用户3</span>
        [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>]   <span class="hljs-comment"># 用户4</span>
    ])

    <span class="hljs-comment"># 创建协同过滤模型</span>
    cf = CollaborativeFiltering(user_item_matrix)

    <span class="hljs-comment"># 计算用户相似度</span>
    user_sim = cf.calculate_user_similarity()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 用户相似度矩阵："</span>)
    <span class="hljs-built_in">print</span>(np.<span class="hljs-built_in">round</span>(user_sim, <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 计算物品相似度</span>
    item_sim = cf.calculate_item_similarity()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 物品相似度矩阵："</span>)
    <span class="hljs-built_in">print</span>(np.<span class="hljs-built_in">round</span>(item_sim, <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 为用户0推荐物品</span>
    recommendations = cf.recommend_items(<span class="hljs-number">0</span>, k=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🎯 为用户0推荐的物品："</span>)
    <span class="hljs-keyword">for</span> item_id, score <span class="hljs-keyword">in</span> recommendations:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"物品<span class="hljs-subst">{item_id}</span>，预测评分：<span class="hljs-subst">{score:<span class="hljs-number">.2</span>f}</span>"</span>)

    <span class="hljs-comment"># 运行结果</span>
    <span class="hljs-comment"># 📊 用户相似度矩阵：</span>
    <span class="hljs-comment"># [[1.   0.59 0.4  0.   0.  ]</span>
    <span class="hljs-comment">#  [0.59 1.   0.   0.8  0.71]</span>
    <span class="hljs-comment">#  [0.4  0.   1.   0.55 0.98]</span>
    <span class="hljs-comment">#  [0.   0.8  0.55 1.   0.89]</span>
    <span class="hljs-comment">#  [0.   0.71 0.98 0.89 1.  ]]</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># 📊 物品相似度矩阵：</span>
    <span class="hljs-comment"># [[1.   0.83 0.54 0.   0.  ]</span>
    <span class="hljs-comment">#  [0.83 1.   0.4  0.17 0.89]</span>
    <span class="hljs-comment">#  [0.54 0.4  1.   0.91 0.83]</span>
    <span class="hljs-comment">#  [0.   0.17 0.91 1.   0.93]</span>
    <span class="hljs-comment">#  [0.   0.89 0.83 0.93 1.  ]]</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># 🎯 为用户0推荐的物品：</span>
    <span class="hljs-comment"># 物品2，预测评分：3.42</span>
    <span class="hljs-comment"># 物品1，预测评分：3.00</span>
</code></pre>
<h3 data-id="heading-15">📊 趣味对比：不同推荐算法的优缺点</h3>








































<table><thead><tr><th>算法类型</th><th>核心原理</th><th>优点</th><th>缺点</th><th>代表应用</th></tr></thead><tbody><tr><td>🤝<strong>协同过滤</strong></td><td>基于用户或物品的相似度</td><td>不需要内容特征、能发现潜在兴趣、推荐结果多样</td><td>冷启动问题、数据稀疏性、计算复杂度高</td><td>早期亚马逊、MovieLens</td></tr><tr><td>📝<strong>基于内容的推荐</strong></td><td>基于内容特征匹配</td><td>不存在冷启动问题、推荐结果可解释、计算复杂度低</td><td>推荐结果缺乏多样性、只能推荐相似内容</td><td>新闻推荐、音乐推荐</td></tr><tr><td>🧠<strong>深度学习推荐</strong></td><td>基于深度神经网络</td><td>推荐准确率高、能处理复杂数据、能捕捉动态兴趣</td><td>计算资源需求高、推荐结果难以解释、容易出现过滤气泡</td><td>抖音、淘宝、Netflix</td></tr><tr><td>🌈<strong>多模态推荐</strong></td><td>基于多种模态数据</td><td>能捕捉内容的丰富信息、推荐结果更精准</td><td>数据处理复杂、模型训练困难</td><td>短视频推荐、直播推荐、元宇宙内容推荐</td></tr></tbody></table>
<h3 data-id="heading-16">🏢 算法推荐的应用场景：无处不在的推荐</h3>



























































<table><thead><tr><th>应用场景</th><th>举例</th><th>推荐内容</th><th>核心算法</th></tr></thead><tbody><tr><td>📱<strong>社交媒体</strong></td><td>抖音、快手、微博</td><td>短视频、图文、直播</td><td>深度学习推荐、多模态推荐</td></tr><tr><td>🛒<strong>电商平台</strong></td><td>淘宝、京东、拼多多</td><td>商品、优惠券、活动</td><td>协同过滤、深度学习推荐</td></tr><tr><td>🎬<strong>视频平台</strong></td><td>Netflix、YouTube、B 站</td><td>电影、电视剧、短视频</td><td>深度学习推荐、序列推荐</td></tr><tr><td>🎵<strong>音乐平台</strong></td><td>Spotify、网易云音乐、QQ 音乐</td><td>歌曲、歌单、歌手</td><td>基于内容的推荐、协同过滤</td></tr><tr><td>📚<strong>阅读平台</strong></td><td>微信读书、起点中文网、番茄小说</td><td>书籍、章节、作者</td><td>基于内容的推荐、协同过滤</td></tr><tr><td>🎮<strong>游戏平台</strong></td><td>Steam、Epic Games、TapTap</td><td>游戏、DLC、攻略</td><td>协同过滤、基于内容的推荐</td></tr><tr><td>🛫<strong>旅行平台</strong></td><td>携程、去哪儿、飞猪</td><td>机票、酒店、景点</td><td>协同过滤、深度学习推荐</td></tr><tr><td>🍔<strong>外卖平台</strong></td><td>美团外卖、饿了么、百度外卖</td><td>餐厅、菜品、优惠</td><td>协同过滤、深度学习推荐</td></tr></tbody></table>
<h3 data-id="heading-17">📈 数据支撑：算法推荐的"硬核实力"</h3>
<ul>
<li>🎬 <strong>算法推荐贡献了 Netflix 80%的播放量</strong>，用户平均观看时长增加 30%以上</li>
<li>📺 <strong>YouTube 90%的观看时间来自推荐</strong>，用户留存率提高 40%以上</li>
<li>🛒 <strong>淘宝 60%的成交额来自推荐</strong>，用户购买转化率提高 20%以上</li>
<li>📱 <strong>抖音 70%的视频观看量来自推荐</strong>，用户日均使用时长超过 2 小时</li>
<li>🎵 <strong>Spotify 60%的新歌曲发现来自推荐</strong>，用户付费转化率提高 15%以上</li>
<li>📚 <strong>微信读书 50%的书籍阅读量来自推荐</strong>，用户阅读时长增加 50%以上</li>
<li>🎮 <strong>Steam 45%的游戏购买来自推荐</strong>，用户游戏时长增加 25%以上</li>
</ul>
<h3 data-id="heading-18">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-19">1. "算法推荐在监听我的对话？"</h4>
<p><strong>错！</strong> 算法推荐主要基于你的行为数据（浏览、点击、购买等），而不是监听你的对话。虽然有些应用可能会请求麦克风权限，但主要用于语音识别功能，而不是为了监听你说话来做推荐。</p>
<h4 data-id="heading-20">2. "算法推荐只会推荐我喜欢的内容，限制了我的视野？"</h4>
<p><strong>不一定！</strong> 算法推荐的目标是平衡"准确性"和"多样性"。好的推荐系统会在推荐你喜欢的内容的同时，也推荐一些新的、相关的内容，帮助你发现新的兴趣。</p>
<h4 data-id="heading-21">3. "算法推荐是完全客观的？"</h4>
<p><strong>错！</strong> 算法推荐会受到训练数据的影响，如果训练数据存在偏见，推荐结果也会存在偏见。比如，如果训练数据中男性用户更多，推荐系统可能会更偏向男性用户的兴趣。</p>
<h4 data-id="heading-22">4. "算法推荐会泄露我的隐私？"</h4>
<p><strong>可能！</strong> 算法推荐需要收集大量的用户行为数据，如果数据处理不当，可能会导致隐私泄露。不过，大多数正规平台都会采取严格的数据保护措施，比如数据加密、匿名化处理等。</p>
<h4 data-id="heading-23">5. "算法推荐越精准越好？"</h4>
<p><strong>不一定！</strong> 算法推荐太精准可能会导致"过滤气泡"问题，让你只看到你喜欢的内容，限制你的视野。好的推荐系统应该在精准性和多样性之间找到平衡。</p>
<h4 data-id="heading-24">6. "算法推荐是不可控制的？"</h4>
<p><strong>错！</strong> 大多数应用都提供了推荐设置，你可以调整推荐的偏好，或者关闭某些类型的推荐。比如，你可以在抖音的设置中关闭"个性化推荐"，或者调整推荐的内容类型。</p>
<h4 data-id="heading-25">7. "算法推荐只适用于大公司？"</h4>
<p><strong>错！</strong> 现在有很多开源的推荐系统框架（如 TensorFlow Recommenders、Surprise），小公司也可以轻松搭建自己的推荐系统。</p>
<h4 data-id="heading-26">8. "算法推荐的原理很复杂，普通人无法理解？"</h4>
<p><strong>错！</strong> 算法推荐的核心原理其实很简单，就是基于你的行为数据找到你的喜好规律。虽然深度学习模型的内部工作机制比较复杂，但基本原理是容易理解的。</p>
<h3 data-id="heading-27">🔮 未来展望：算法推荐的发展趋势</h3>
<h4 data-id="heading-28">1. 🤖 AI 大模型与推荐系统结合</h4>
<ul>
<li><strong>GPT-4、Claude、Gemini 等大模型</strong>将融入推荐系统</li>
<li><strong>生成式推荐</strong>：直接生成个性化的推荐理由和内容描述</li>
<li><strong>多轮对话式推荐</strong>：通过对话了解用户的具体需求，生成更精准的推荐</li>
</ul>
<h4 data-id="heading-29">2. 🌈 多模态推荐的普及</h4>
<ul>
<li><strong>同时处理文本、图像、音频、视频等多种模态数据</strong></li>
<li><strong>跨模态推荐</strong>：根据用户的文本兴趣推荐视频内容，或者根据用户的视频兴趣推荐文本内容</li>
<li><strong>3D 和 VR/AR 内容推荐</strong>：为 VR/AR 设备推荐适配的 3D 内容</li>
</ul>
<h4 data-id="heading-30">3. 📱 移动端和边缘端的优化</h4>
<ul>
<li><strong>轻量级推荐模型</strong>：适合在手机等资源受限设备上运行</li>
<li><strong>边缘计算推荐</strong>：在用户设备上进行推荐计算，保护用户隐私</li>
<li><strong>实时推荐</strong>：根据用户的实时位置、心情、上下文生成推荐</li>
</ul>
<h4 data-id="heading-31">4. 🔒 隐私保护和可解释性</h4>
<ul>
<li><strong>联邦学习</strong>：在不泄露原始数据的情况下进行模型训练</li>
<li><strong>差分隐私</strong>：在推荐结果中加入噪声，保护用户隐私</li>
<li><strong>可解释性推荐</strong>：向用户解释为什么推荐某个内容，提高用户信任度</li>
</ul>
<h4 data-id="heading-32">5. 🌍 跨平台和跨设备推荐</h4>
<ul>
<li><strong>统一的推荐系统</strong>：在不同平台和设备上为用户提供一致的推荐体验</li>
<li><strong>上下文感知推荐</strong>：根据用户当前使用的设备、时间、地点生成推荐</li>
<li><strong>多设备协同推荐</strong>：结合用户在不同设备上的行为生成推荐</li>
</ul>
<h3 data-id="heading-33">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>最早的推荐算法是什么？</td><td>协同过滤</td><td>✅/❌</td></tr><tr><td>算法推荐贡献了 Netflix 多少播放量？</td><td>80%</td><td>✅/❌</td></tr><tr><td>YouTube 多少观看时间来自推荐？</td><td>90%</td><td>✅/❌</td></tr><tr><td>深度学习推荐的主要优点是什么？</td><td>推荐准确率高、能处理复杂数据</td><td>✅/❌</td></tr><tr><td>协同过滤的主要缺点是什么？</td><td>冷启动问题、数据稀疏性</td><td>✅/❌</td></tr><tr><td>什么是"过滤气泡"？</td><td>算法只推荐用户喜欢的内容，限制用户视野</td><td>✅/❌</td></tr><tr><td>多模态推荐处理哪些数据？</td><td>文本、图像、音频、视频等</td><td>✅/❌</td></tr><tr><td>联邦学习的主要作用是什么？</td><td>保护用户隐私</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-34">🎯 结语：算法推荐——你的"贴心小助手"</h3>
<p>算法推荐已经成为我们数字生活的<strong>重要组成部分</strong>，它就像你的"贴心小助手"，总能知道你喜欢什么，想要什么。</p>
<p>从早期的协同过滤到现在的深度学习推荐，算法推荐技术一直在不断进化，推荐准确率也在不断提高。未来，随着 AI 大模型、多模态推荐、隐私保护等技术的发展，算法推荐将变得更加智能、更加个性化、更加安全。</p>
<p><strong>记住</strong>：</p>
<ul>
<li>🔍 算法推荐的核心是<strong>数据和模型</strong></li>
<li>🎯 好的推荐系统需要平衡<strong>准确性和多样性</strong></li>
<li>🔒 隐私保护是算法推荐的<strong>重要挑战</strong></li>
<li>💡 算法推荐的目的是<strong>帮助你发现更好的内容</strong>，而不是控制你的视野</li>
</ul>
<p>下次当你打开抖音、淘宝、Netflix 时，不妨想想背后的算法推荐技术——正是这些看不见的"小助手"，让我们的数字生活变得更加便捷和丰富！</p>
<h3 data-id="heading-35">💬 互动话题</h3>
<ol>
<li>你觉得算法推荐最准的应用是哪个？为什么？</li>
<li>你遇到过算法推荐的"翻车"时刻吗？</li>
<li>你希望算法推荐在哪些方面改进？</li>
<li>你担心算法推荐的"过滤气泡"问题吗？</li>
<li>你对 AI 大模型与推荐系统结合有什么期待？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有没有在 iOS 直接抓包 的App？]]></title>    <link>https://juejin.cn/post/7594468778111500322</link>    <guid>https://juejin.cn/post/7594468778111500322</guid>    <pubDate>2026-01-13T08:47:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594468778111500322" data-draft-id="7594662258353930275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有没有在 iOS 直接抓包 的App？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T08:47:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有没有在 iOS 直接抓包 的App？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:47:24.000Z" title="Tue Jan 13 2026 08:47:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发群里，经常能看到有人问：有没有那种<strong>iOS 直接抓包 App</strong>，装到手机上就能看到所有请求？</p>
<p>这个问题本身，其实已经暴露了一个常见误解。
在 iOS 的安全模型下，<strong>纯手机端直接抓包几乎不可行</strong>，真正可行的方案，很多都是手机 + 电脑的组合，只是有些工具把过程做得更像直接。</p>
<hr/>
<h2 data-id="heading-0"><strong>直接抓包的真实需求场景</strong></h2>
<p>在我遇到的项目里，提出想要直接抓包的通常是下面几种情况：</p>
<ul>
<li>测试环境接口异常，但源码不可改</li>
<li>三方 App 行为不透明，只能观察通信</li>
<li>HTTPS 接口参数复杂，日志不完整</li>
<li>需要在真机上复现线上问题</li>
</ul>
<p>这些场景的共同点是：<strong>不能改 App，只能在设备外部观察网络行为</strong>。</p>
<hr/>
<h2 data-id="heading-1"><strong>为什么 iOS 很难做到真正的手机端抓包</strong></h2>
<p>iOS 不允许普通应用监听系统级网络流量。
所以像 Android 那种在手机上装个 VPN 抓包 App 的方式，在 iOS 上基本走不通。</p>
<p>能做的事情只有两类：</p>
<ul>
<li>通过系统代理，把流量导出</li>
<li>通过 USB，把设备流量镜像到电脑</li>
</ul>
<p>所谓直接，更多是<strong>配置步骤是否复杂</strong>的问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>代理抓包依然是最现实的入口</strong></h2>
<p>在可控环境下，HTTPS 代理仍然是最常用的方案。</p>
<p>Charles、Fiddler、Proxyman 都属于这一类，
抓包大师也是同样的工作原理，只是把证书和配置流程自动化了。</p>
<hr/>
<h2 data-id="heading-3"><strong>使用抓包大师进行 HTTPS 代理抓包的实际流程</strong></h2>
<p>在一次接口联调中，我用的是抓包大师，主要原因是配置成本低。</p>
<p>具体操作过程大致是这样：</p>
<ul>
<li>用 USB 将 iPhone 连接到电脑，保持解锁和亮屏</li>
<li>打开抓包大师，在设备列表中选中当前 iOS 设备</li>
<li>切换到 HTTPS 代理抓包模式</li>
</ul>
<p>如果是第一次使用，会提示安装描述文件和证书。
按照提示在 iOS 设置中信任证书即可。</p>
<p>代理地址和端口会直接显示出来，只需要在当前 Wi-Fi 下设置为手动代理。</p>
<hr/>
<h2 data-id="heading-4"><strong>代理抓包时常见的卡点</strong></h2>
<p>即使流程顺利，也经常会遇到这些问题：</p>
<ul>
<li>装了证书但 HTTPS 还是空白</li>
<li>只有部分接口能看到</li>
<li>某个 App 完全没流量</li>
</ul>
<p>这通常不是工具问题，而是 App 绕过了系统代理。</p>
<hr/>
<h2 data-id="heading-5"><strong>当代理失效，数据流抓包才是真正的底层视角</strong></h2>
<p>如果我怀疑 App 根本没走代理，会直接切换策略。</p>
<p>在抓包大师中，选择<strong>数据流抓包</strong>模式：</p>
<ul>
<li>仍然通过 USB 连接设备</li>
<li>不需要配置代理或证书</li>
<li>直接开始抓取设备发出的 TCP / UDP 数据</li>
</ul>
<p>如果只关心某个 App，可以提前筛选目标应用，避免被系统流量淹没。</p>
<p>这一步的目的只有一个：
确认<strong>这个 App 是否真的在联网，以及用的是什么方式</strong>。</p>
<hr/>
<h2 data-id="heading-6"><strong>在抓包中经常会使用不同的方式去验证</strong></h2>
<p>在一个真实问题中，我通常会这样组合：</p>
<ul>
<li>代理抓包：看 HTTPS 结构和参数</li>
<li>数据流抓包：确认底层通信是否存在</li>
<li>拦截器：验证客户端对响应的处理逻辑</li>
</ul>
<p>没有哪个工具能一次性解决所有问题。</p>
<hr/>
<h2 data-id="heading-7"><strong>拦截器在调试中的实际价值</strong></h2>
<p>当请求已经能被代理捕获，但逻辑依然不明确时，
拦截器比反复猜测代码更直接。</p>
<p>在抓包大师里，可以通过 JS 修改请求或响应：</p>
<ul>
<li>改字段值，验证 UI 依赖</li>
<li>构造异常响应，观察客户端行为</li>
<li>临时重定向请求地址</li>
</ul>
<p>这些操作，往往能在几分钟内确认问题方向。</p>
<hr/>
<h2 data-id="heading-8"><strong>关于 有没有iOS 直接抓包 App 的结论</strong></h2>
<p>如果一定要给个结论，那就是：</p>
<ul>
<li>iOS 上不存在真正意义的纯手机抓包 App</li>
<li>所谓 <strong>直接</strong> ，本质是工具把配置步骤隐藏了</li>
<li>真正高效的抓包，来自对网络路径的判断</li>
</ul>
<p>当你理解了这一点，选工具反而会变简单。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sniffmaster.net%2Ftutorial%2Fzh%2F4%2F4.html" target="_blank" title="https://www.sniffmaster.net/tutorial/zh/4/4.html" ref="nofollow noopener noreferrer">www.sniffmaster.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线第一章：可见区间处理]]></title>    <link>https://juejin.cn/post/7594523145211117622</link>    <guid>https://juejin.cn/post/7594523145211117622</guid>    <pubDate>2026-01-13T08:50:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594523145211117622" data-draft-id="7594385386740678675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线第一章：可见区间处理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T08:50:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线第一章：可见区间处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:50:13.000Z" title="Tue Jan 13 2026 08:50:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">绘制K线第一章：可见区间处理</h2>
<h3 data-id="heading-1">概述</h3>
<p>在入门版本中，我们绘制了所有K线数据。但当数据量很大时，所有K线会挤在一起或超出屏幕，无法正常显示。</p>
<p><strong>可见区间处理</strong>就是解决这个问题：只绘制屏幕能容纳的K线数量，让图表清晰可读。</p>
<h3 data-id="heading-2">为什么需要可见区间</h3>
<h4 data-id="heading-3">问题场景</h4>
<p>假设有以下情况：</p>
<ul>
<li>屏幕宽度：1080px</li>
<li>每根K线占用：30px（20px宽度 + 10px间距）</li>
<li>可显示的K线数量：1080 ÷ 30 = 36根</li>
<li>实际数据：1000根K线</li>
</ul>
<p>如果绘制所有1000根K线：</p>
<ul>
<li>K线会挤在一起，无法看清</li>
<li>或者超出屏幕，看不到完整内容</li>
</ul>
<h4 data-id="heading-4">解决方案</h4>
<p>只显示最后36根K线（最新的数据），这样：</p>
<ul>
<li>K线清晰可读</li>
<li>不会超出屏幕</li>
</ul>
<h3 data-id="heading-5">实现原理</h3>
<h4 data-id="heading-6">核心逻辑</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 计算可见K线数量</span>
val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()  <span class="hljs-comment">// 30px</span>
val visibleCount = (width / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()  <span class="hljs-comment">// 1080 ÷ 30 = 36</span>

<span class="hljs-comment">// 2. 获取可见数据（只取最后N根）</span>
val visibleData = if (klineData.size &gt; visibleCount) {
    klineData<span class="hljs-selector-class">.takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后36根</span>
} else {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}

<span class="hljs-comment">// 3. 只对可见数据计算价格范围</span>
val priceRange = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 4. 只绘制可见数据</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { index, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(...)
}
</code></pre>
<h4 data-id="heading-7">关键点</h4>
<ol>
<li><strong>计算可见数量</strong>：<code>屏幕宽度 ÷ 每根K线占用宽度</code></li>
<li><strong>取最后N根</strong>：使用 <code>takeLast()</code> 方法，显示最新的数据</li>
<li><strong>价格范围计算</strong>：只基于可见数据计算，确保Y轴比例正确</li>
</ol>
<h3 data-id="heading-8">代码实现（KLineViewCase2）</h3>
<h4 data-id="heading-9">类图</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@startuml</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineViewCase2</span> {
  - klineData: List&lt;KLineEntity&gt;
  - config: KLineConfig
  + setKLineData(<span class="hljs-keyword">data</span>: List&lt;KLineEntity&gt;)
  - calculatePriceRange(<span class="hljs-keyword">data</span>: List&lt;KLineEntity&gt;): Pair&lt;<span class="hljs-built_in">Float</span>, <span class="hljs-built_in">Float</span>&gt;
}

KLineViewCase2 --&gt; KLineConfig : 依赖
KLineViewCase2 --&gt; KLineEntity : 使用

note right of KLineViewCase2
  相比Case1，增加了可见区间处理：
  <span class="hljs-number">1.</span> 计算可见K线数量
  <span class="hljs-number">2.</span> 只取最后N根数据
  <span class="hljs-number">3.</span> 只对可见数据计算价格范围
end note

<span class="hljs-meta">@enduml</span>
</code></pre>
<h4 data-id="heading-10">核心代码（可见区间部分）</h4>
<p>在 <code>onDraw()</code> 方法中，相比Case1增加了可见区间处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 计算可见区间：根据屏幕宽度计算能显示多少根K线</span>
val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()
val visibleCount = (width / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()

<span class="hljs-comment">// 2. 获取可见的K线数据（只显示最后N根，最新的数据）</span>
val visibleData = if (klineData.size &gt; visibleCount) {
    klineData<span class="hljs-selector-class">.takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后N根</span>
} else {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}

<span class="hljs-comment">// 3. 计算可见数据的价格范围（注意：传入visibleData而不是klineData）</span>
val priceRange = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 4. 绘制可见的K线（使用visibleData）</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { index, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(canvas, entity, index, minPrice, maxPrice, height)
}
</code></pre>
<p><strong>关键改动</strong>：</p>
<ul>
<li><code>calculatePriceRange()</code> 方法现在接受 <code>data</code> 参数，可以传入可见数据</li>
<li>其他绘制逻辑与Case1相同（参考入门文档）</li>
</ul>
<h3 data-id="heading-11">与Case1的对比</h3>






























<table><thead><tr><th>特性</th><th>Case1（入门版）</th><th>Case2（可见区间版）</th></tr></thead><tbody><tr><td>绘制数据</td><td>所有数据</td><td>只绘制可见数据（最后N根）</td></tr><tr><td>价格范围计算</td><td>基于所有数据</td><td>基于可见数据</td></tr><tr><td>适用场景</td><td>数据量小（&lt; 50根）</td><td>数据量大（&gt; 50根）</td></tr><tr><td>代码复杂度</td><td>简单</td><td>稍复杂（增加可见区间逻辑）</td></tr></tbody></table>
<h3 data-id="heading-12">完整绘制链路</h3>
<p>相比Case1，Case2在绘制链路中增加了可见区间处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 设置K线数据 → 触发<span class="hljs-built_in">onDraw</span>()重绘
   ↓
<span class="hljs-number">2</span>. <span class="hljs-built_in">onDraw</span>()方法执行：
   ├─ 绘制背景（与Case1相同）
   ├─ 检查数据是否为空（与Case1相同）
   ├─ 【新增】计算可见区间
   │   ├─ 计算可见K线数量（屏幕宽度 ÷ 每根K线宽度）
   │   └─ 获取可见数据（取最后N根）
   ├─ 计算价格范围（基于可见数据，不是所有数据）
   └─ 遍历可见K线数据并绘制（绘制逻辑与Case1相同）
</code></pre>
<p><strong>说明</strong>：绘制K线的具体步骤（计算坐标、绘制影线、绘制实体）与Case1相同，参考入门文档。</p>
<h3 data-id="heading-13">关键概念</h3>
<h4 data-id="heading-14">可见K线数量计算</h4>
<pre><code class="hljs language-scss" lang="scss">可显示的K线数量 = 屏幕宽度 ÷ 每根K线占用的总宽度
                = <span class="hljs-attribute">width</span> ÷ (candleWidth + candleSpacing)
                = <span class="hljs-attribute">width</span> ÷ totalCandleWidth
</code></pre>
<p><strong>示例</strong>：</p>
<ul>
<li>屏幕宽度：1080px</li>
<li>每根K线占用：30px（20px宽度 + 10px间距）</li>
<li>可见数量：1080 ÷ 30 = 36根</li>
</ul>
<h4 data-id="heading-15">取最后N根数据</h4>
<pre><code class="hljs language-arduino" lang="arduino">val visibleData = <span class="hljs-keyword">if</span> (klineData.size &gt; visibleCount) {
    klineData.<span class="hljs-built_in">takeLast</span>(visibleCount)  <span class="hljs-comment">// 取最后N根（最新数据）</span>
} <span class="hljs-keyword">else</span> {
    klineData  <span class="hljs-comment">// 数据不足，全部显示</span>
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>如果数据量 &gt; 可见数量：只取最后N根（显示最新数据）</li>
<li>如果数据量 ≤ 可见数量：全部显示</li>
</ul>
<h4 data-id="heading-16">价格范围只基于可见数据</h4>
<p>这是关键点：价格范围必须只基于可见数据计算，而不是所有数据。</p>
<p><strong>为什么？</strong></p>
<ul>
<li>如果基于所有数据计算价格范围，可见数据的价格变化可能很小</li>
<li>导致Y轴比例不合适，K线看起来像一条线</li>
<li>只基于可见数据计算，Y轴比例正确，K线清晰可见</li>
</ul>
<h3 data-id="heading-17">注意事项</h3>
<ol>
<li><strong>数据顺序</strong>：确保数据是按时间顺序排列的（从旧到新），这样 <code>takeLast()</code> 才能取到最新数据</li>
<li><strong>边界情况</strong>：当数据量小于可见数量时，需要全部显示</li>
<li><strong>价格范围</strong>：必须只基于可见数据计算，不能基于所有数据</li>
</ol>
<h3 data-id="heading-18">总结</h3>
<p>可见区间处理是K线绘制的重要优化：</p>
<ul>
<li><strong>解决数据量大时的显示问题</strong></li>
<li><strong>只绘制屏幕能容纳的K线</strong></li>
<li><strong>价格范围只基于可见数据计算</strong></li>
<li><strong>为后续的滚动、缩放功能打下基础</strong></li>
</ul>
<p>效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f634c8f6cee24dbcbc33dc8b06300ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899165&amp;x-signature=GjPSuEFB7%2ByZR7%2FgPDHN0Gl4akc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[普通前端程序员的 2025：没什么大胜利，但也没被生活击倒]]></title>    <link>https://juejin.cn/post/7594655863547510836</link>    <guid>https://juejin.cn/post/7594655863547510836</guid>    <pubDate>2026-01-13T08:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594655863547510836" data-draft-id="7594655863547428916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="普通前端程序员的 2025：没什么大胜利，但也没被生活击倒"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T08:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小蜗"/> <meta itemprop="url" content="https://juejin.cn/user/61995432544503"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            普通前端程序员的 2025：没什么大胜利，但也没被生活击倒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61995432544503/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小蜗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:59:42.000Z" title="Tue Jan 13 2026 08:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>没什么宏大的叙事，单纯记录一下这个平平淡淡、甚至有点紧绷的 2025。</p>
<p>今年大环境怎样大家心里都有数，能苟住就算赢。盘了一下今年的几个关键数据，发现居然还凑合，比预想中要好一点。</p>
<h2 data-id="heading-0"><strong>1. 关于身体</strong></h2>
<p>16+8 加上打羽毛球。从 72kg 到了 63kg。</p>
<p>以前代码写久了颈椎像是生锈的，现在虽然还是累，但至少身体轻盈了不少。这也算是给 30 岁以后的自己充了点值。</p>
<h2 data-id="heading-1"><strong>2. 关于吞金兽</strong></h2>
<p>娃 3 岁了。
成功把人类幼崽又养活了一年（老父亲抹泪）。
带娃真的比修 Bug 累，情绪崩溃了无数次，但治愈也就一瞬间的事。看着她没心没肺地笑，觉得这点累也值了。</p>
<h2 data-id="heading-2"><strong>3. 搞钱与还债</strong></h2>
<p>今年最大的动作是降杠杆，硬着头皮还了 30w 房贷。</p>
<p>我妈支援了 10w，我爸支援了 10w，我自己攒了 10w。</p>
<p>在这个年份，有家人的托举真的很幸运。把债压下去，睡觉稍微踏实了一点点。</p>
<p>另外，前几年绿得发光的基金，今年终于回本扶正了，赶紧跑还是继续卧倒，还得再想想。</p>
<h2 data-id="heading-3"><strong>4. 工作</strong></h2>
<p>两个字：稳定。
在裁员消息满天飞的 2025，能安稳度过一年，绩效还行，没出大岔子，我觉得这就是一种胜利。</p>
<h2 data-id="heading-4"><strong>5. 精神避难</strong></h2>
<p>生活不能只有 KPI 和尿不湿。</p>
<p>今年看了 89 部电影，去了 2 次国内游，1 次出境游。</p>
<p>只有在客厅黑灯的那两个小时，或者站在陌生风景里的时候，才感觉自己不是个只会敲键盘的工具人。</p>
<hr/>
<h2 data-id="heading-5"><strong>写在最后</strong></h2>
<p>看着这些流水账，其实没什么惊天动地的成就。但在这个充满了不确定性的时代，能按部就班地生活，本身就很奢侈。</p>
<p>很喜欢的一句话，送给同样在 2025 努力支撑的兄弟们：</p>
<blockquote>
<p><strong>哪有什么胜利可言，挺住便意味着一切。💪</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 进阶：非技术人员的生存手册]]></title>    <link>https://juejin.cn/post/7594514040917770267</link>    <guid>https://juejin.cn/post/7594514040917770267</guid>    <pubDate>2026-01-13T08:56:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594514040917770267" data-draft-id="7594616268782108699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 进阶：非技术人员的生存手册"/> <meta itemprop="keywords" content="程序员,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-13T08:56:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 进阶：非技术人员的生存手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:56:51.000Z" title="Tue Jan 13 2026 08:56:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>Vibe Coding 的门槛看起来很低——打开 Cursor、Claude 或者 AI Studio，用自然语言描述你的需求，AI 就能帮你生成代码。但很多人在实际操作中会发现：AI 做出来的东西，和自己想要的总是差那么一点。</p>
<p>说到底，问题在我们自己身上。</p>
<p>作为非技术人员，你面临的真正挑战在于：如何让 AI 理解你到底想要什么。这篇文章会帮你跨过这道坎。</p>
<h3 data-id="heading-1">第一关：你真的知道自己要什么吗？</h3>
<p>很多人做不到把需求描述清楚，其实跟表达能力没太大关系，更多是认知层次的问题。</p>
<p>我们可以用一个简单的认知象限来理解这件事：</p>
<ul>
<li>Know-Know（知道自己知道什么）：比如"我需要一个登录页面"</li>
<li>Know-Unknow（知道自己不知道什么）：比如"我知道需要数据库，但不知道怎么设计"</li>
<li>Unknow-Unknow（不知道自己不知道什么）：比如"为什么用户登录后还是跳回首页？"——你根本不知道需要 session 管理</li>
<li>Unknow-Know（不知道自己其实知道什么）：比如"其实我潜意识里希望界面更简洁"——没意识到这也是一个需求</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftreydtw%2Farticle%2F2010601217597276631%2Fmedia%2F2010599364889313282" target="_blank" title="https://x.com/treydtw/article/2010601217597276631/media/2010599364889313282" ref="nofollow noopener noreferrer"/></p>
<p>大多数失败的 Vibe Coding 项目，都卡在 Unknow-Unknow 这个象限——你都不知道自己遗漏了什么，AI 当然也帮不了你。</p>
<p>破局方法：AI 访谈</p>
<p>与其一上来就让 AI 写代码，不如先让 AI 扮演一个产品经理，反过来采访你：</p>
<blockquote>
<p>我有一个模糊的项目想法，请扮演产品经理来采访我。 通过一系列问题，帮我把这个想法变得更加清晰和具体。 每次只问一个问题，等我回答后再问下一个。</p>
</blockquote>
<p>通过一次次的回答问题，你会发现自己的想法逐渐从模糊变得清晰，从”我想做一个 App”变成”我想做一个帮助自由职业者追踪项目收入、自动生成发票的工具”。</p>
<p>这才是 Vibe Coding 的真正起点。</p>
<h3 data-id="heading-2">第二关：小步快走，别想一口吃成胖子</h3>
<p>很多人的第一个项目就野心勃勃：要做一个社交平台、要做一个在线教育系统、要做一个电商网站……</p>
<p>结果呢？三天热情过后，项目变成了一堆报错的代码和半成品的页面。</p>
<p>正确的做法是：从身边的 Side Project 做起。</p>
<p>什么是好的第一个项目？</p>
<ul>
<li>✅ 一个个人记账小工具</li>
<li>✅ 一个自动整理收藏夹的脚本</li>
<li>✅ 一个把语音转成文字的小页面</li>
<li>✅ 一个生日提醒机器人</li>
</ul>
<p>这些项目有几个共同特点：</p>
<ol>
<li>功能单一：只解决一个问题</li>
<li>用户明确：就是你自己</li>
<li>验收简单：能用就行</li>
</ol>
<p>当你能把一个小项目从头到尾完整做出来、部署上线、自己用起来之后，你就拥有了做更大项目的信心和方法论。</p>
<h3 data-id="heading-3">第三关：像项目经理一样思考</h3>
<p>这是非技术人员最需要培养的能力：工程化思维。</p>
<p>你不需要看懂每一行代码，但你必须学会：</p>
<ol>
<li>管控风险</li>
</ol>
<p>每次让 AI 修改代码之前，问自己：</p>
<ul>
<li>这次改动会影响其他功能吗？</li>
<li>如果改坏了，我能恢复吗？</li>
<li>我有没有备份？</li>
</ul>
<ol start="2">
<li>验收成果</li>
</ol>
<p>不要 AI 说”改好了”你就信了。你需要：</p>
<ul>
<li>实际运行一遍</li>
<li>测试主要功能</li>
<li>检查边界情况（比如输入为空会怎样？）</li>
</ul>
<ol start="3">
<li>分解任务</li>
</ol>
<p>大任务拆成小任务，每次只让 AI 做一件事：</p>
<p>❌ "帮我做一个完整的用户系统" ✅ "先帮我做一个登录表单的 UI" ✅ "现在帮我加上表单验证" ✅ "接下来对接后端登录接口"</p>
<h3 data-id="heading-4">第四关：版本控制是你的后悔药</h3>
<p>学会用 Git，这是非技术人员最值得投资的技能之一。</p>
<p>为什么？因为在 Vibe Coding 的过程中，你会频繁遇到这种情况：</p>
<blockquote>
<p>“刚才那个版本明明是好的，让 AI 改了几轮之后，整个网站都挂了……”</p>
</blockquote>
<p>如果你用了 Git，只需要一条命令就能回到之前任何一个正常的版本。没有 Git？那你只能求 AI 帮你”撤销刚才的修改”——但 AI 的记忆可没那么可靠。</p>
<p>最基础的 Git 用法，只需要记住三个命令：</p>
<h2 data-id="heading-5">保存当前进度（相当于游戏存档） git add . git commit -m "完成了登录功能" # 查看历史存档 git log --oneline # 回到某个存档 git checkout &lt;存档编号&gt;</h2>
<p>养成习惯：每完成一个小功能，就 commit 一次。这样你永远有后悔药可以吃。</p>
<h3 data-id="heading-6">第五关：真实运行检查</h3>
<p>这是很多人忽略的最后一步。</p>
<p>我见过太多人在 AI Studio 里做出了炫酷的 Demo，发到朋友圈收获一片点赞，但那个项目从来没有真正运行过。</p>
<p>没有部署运行的项目，就像只存在于图纸上的房子——看着很美，但你住不进去。</p>
<p>为什么真实运行检查这么重要？</p>
<ol>
<li>暴露真实问题：在 AI Studio 的沙盒里一切正常，放到真实服务器上可能就报错了</li>
<li>发现性能问题：本地测试感觉很快，用户多了就卡死了</li>
<li>验证真实价值：你以为很有用的功能，实际用起来可能很鸡肋</li>
</ol>
<p>最简单的部署方式</p>
<p>如果你的项目是一个静态网页，用 Vercel 或 Netlify 可以免费一键部署。如果需要后端，可以用 Railway 或 Render。</p>
<p>不需要懂什么服务器配置，把代码推上去，平台自动帮你搞定一切。</p>
<h3 data-id="heading-7">总结：非技术人员的 Vibe Coding 生存法则</h3>
<ol>
<li>先厘清需求：用 AI 访谈的方式，把模糊想法变清晰</li>
<li>从小做起：Side Project 优先，积累成功经验</li>
<li>工程化思维：像项目经理一样管理风险、验收成果</li>
<li>善用 Git：版本控制是你的后悔药</li>
<li>真实运行：Demo 不算数，部署上线才是真的完成</li>
</ol>
<p>Vibe Coding 的本质，是让你成为一个会用 AI 工具的创造者。</p>
<p>代码只是工具，解决问题才是目的。</p>
<p>本文转载自宝玉推特</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在一天内重启你的人生]]></title>    <link>https://juejin.cn/post/7594616268782059547</link>    <guid>https://juejin.cn/post/7594616268782059547</guid>    <pubDate>2026-01-13T08:54:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782059547" data-draft-id="7594482829755220014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在一天内重启你的人生"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T08:54:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在一天内重启你的人生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:54:55.000Z" title="Tue Jan 13 2026 08:54:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你还没准备变好，那是因为你在害怕。</p>
<p>——DAN</p>
<blockquote>
<p>作者：DAN KOE</p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fthedankoe%2Fstatus%2F2010751592346030461" target="_blank" title="https://x.com/thedankoe/status/2010751592346030461" ref="nofollow noopener noreferrer">x.com/thedankoe/s…</a></p>
</blockquote>
<p>如果你跟我这类人有点像，那你肯定觉得“新年决心”这玩意儿简直蠢透了。</p>
<p>原因很简单：大多数人改变生活的方式完全搞反了。</p>
<p>大家制定这些决心只是因为随大流——人类嘛，总喜欢在这种肤浅的“地位游戏”里找存在感——但这些决心根本无法触及真正改变的核心。真正的改变，远比你给自己洗脑说“今年我要更自律、更高效”要深刻得多。</p>
<p>如果你不幸被我说中了，别急，我不是来居高临下说教的（虽然我写东西确实有点犀利）。我放弃过的目标比我实现的要多十倍。我觉得这对大多数人来说都是常态。但不得不承认，大多数人试图改变生活却总是以惨败告终，这是一个铁一般的事实。</p>
<p>不过，虽然我认为“新年决心”很蠢，但反思一下你那糟糕的现状，然后以此为跳板去追求更好的生活，永远是明智之举。</p>
<p>所以，无论你是想创业、想通过健身脱胎换骨，还是想冒险去过一种更有意义的生活（而不是两周后就打回原形），我想分享 7 个你可能没听说过的，关于行为改变、心理学和生产力的核心理念。希望能帮你在 2026 年真正做成点事儿。</p>
<p>这是一篇干货满满的长文。 这不那种你看完就忘的快餐文章。 这是一份值得你收藏、做笔记，并专门抽出时间去深度思考的内容。</p>
<p>文章末尾的一套流程（旨在深挖你的潜意识，找出你真正想要什么）大约需要你花整整一天的时间去完成，但它带来的影响将极其深远。</p>
<p>我们开始吧。</p>
<h2 data-id="heading-0">一、你还没过上想要的生活，是因为你还不是“配得上”那种生活的人</h2>
<p>在设定宏大目标时，人们往往只盯着成功两个要素中的次要那个：</p>
<ol>
<li>改变你的行动，向目标推进（这是二阶的，最不重要）。</li>
<li>改变你的本质，让行为自然而然地发生（这是一阶的，最重要的）。</li>
</ol>
<p>大多数人立了一个浮于表面的目标，给自己打鸡血，硬撑着自律几周，然后毫无悬念地退回到老样子。为什么？因为他们试图在腐烂的地基上盖高楼。</p>
<p>如果这听起来有点玄，我们来看个例子。</p>
<p>想想那些成功人士：一个拥有完美身材的健美运动员，一个身家过亿的 CEO，或者一个在人群中谈笑风生、毫无社交焦虑的社交达人。</p>
<p>你觉得那个健美运动员需要“咬牙坚持”才能吃得健康吗？那个 CEO 需要“强迫自己”去自律地管理团队吗？</p>
<p>在你看来，表面上好像是这样。但真相是：他们根本无法想象自己过另一种生活。 对健美运动员来说，逼他吃垃圾食品才是真正的折磨；对 CEO 来说，赖床不起才是让他每一秒都感到痛苦的事（这里有细微差别，但这只是为了举例）。</p>
<p>对有些人来说，我的生活方式看起来极端且苦行僧。但在我看来，这再自然不过了。这不是为了跟谁比，我只是真心享受这种活法。当我妈劝我休息一下，出去玩玩时，我强忍着没回她一句：“如果我不觉得好玩，我干嘛要做这些？”</p>
<p>下一句话听起来很简单，但令人震惊的是，绝大多数人都不懂：</p>
<p>如果你想要某种人生结果，你必须在该结果出现之前很久，就已经过上了能产生这种结果的生活方式。</p>
<p>如果有人说想减掉 30 磅，我通常是不信的。不是我不信他们的能力，而是太多次听到这种话：“等我减完肥，我就能重新开始享受生活了。”</p>
<p>很遗憾地告诉你：如果你不能把“导致你减肥成功的生活方式”变成你的终身生活方式，如果你找不到一个比把你拉回旧习惯的引力更强大的理由，那你注定会反弹回原点。最后你只能不快乐地承认，你浪费了这辈子最宝贵的资源：时间。</p>
<p>当你真正由内而外地改变时，那些对你目标毫无帮助的旧习惯会让你感到恶心，因为你深刻地意识到，那些行为会累积成什么样的人生。你现在之所以能容忍目前的低标准，是因为你并没有完全意识到这些标准到底是什么，以及它们最终会将你引向何方。</p>
<p>你说你想改变，你说你想“财务自由”或“变得健康”，但你的行动却总是背道而驰。这里面的水，比你想象的要深。</p>
<h2 data-id="heading-1">二、你还没过上想要的生活，是因为你潜意识里根本就不想</h2>
<blockquote>
<p>“只相信行动。生活发生在事件的层面，而不是语言的层面。只相信行动。” —— 阿尔弗雷德·阿德勒</p>
</blockquote>
<p>如果你想改变自己，就必须理解大脑的运作机制，这样才能开始“重写代码”。</p>
<p>理解大脑的第一步，是明白所有行为都是目标导向的（目的论）。这一点细想其实很明显，但深究起来，大多数人都不愿面对。</p>
<ul>
<li>你往前迈一步，是因为你想去某个地方。</li>
<li>你挠鼻子，是因为你想止痒。</li>
</ul>
<p>这些显而易见。但大多数时候，你的目标是无意识的。比如，你大白天瘫在沙发上刷手机，你可能没意识到，你其实是在试图消磨掉那个让你焦虑的“下一个任务”到来之前的时间。</p>
<p>在更深层、更复杂的无意识层面，你会追求一些实际上伤害你的目标，但你会用一种社会可接受的方式来合理化你的行为，以免自己看起来像个失败者。</p>
<p>举个例子：如果你总是拖延工作，你可能会借口说自己“缺乏自律”。但实际上，你是在追求一个目标——保护自己。保护自己免受“完成工作并展示成果”后可能遭遇的评判。</p>
<p>如果你嘴上说想辞掉那份没前途的工作，却迟迟不动，你可能会觉得自己没勇气。但真相是，你正在追求“安全感”、“确定性”以及“不想让周围那些认为这工作还不错的人觉得你是个失败者”这一目标。</p>
<p>真正的教训是：真正的改变需要改变你的目标。</p>
<p>我指的不是定个肤浅的 KPI，因为这种行为本身可能就是为了服务于某个正在伤害你的潜意识目标。我指的是改变你的视角。因为目标本质上就是一个透镜。它是一种对未来的投射，决定了你能看到哪些信息、想法和资源。</p>
<p>如果不理解这一点，你会越陷越深。</p>
<h2 data-id="heading-2">三、你还没过上想要的生活，是因为你害怕成为那个人</h2>
<blockquote>
<p>“不管是你是怎么产生这个想法的，也不管它来自哪里……只要你接受了一个想法，并且深信不疑，它就会像催眠师的指令控制被催眠者一样控制你。” —— 麦克斯韦尔·马尔茨</p>
</blockquote>
<p>这就是你如何成为今天的你，以及你将如何成为明天的你的过程。这是“身份认同”的解剖学：</p>
<ol>
<li>你想达成一个目标。</li>
<li>你通过这个目标的透镜来感知现实。</li>
<li>你只注意那些能帮你达成目标的“重要”信息（学习）。</li>
<li>你朝着目标行动，并收到“正在取得进展”的反馈。</li>
<li>你重复这种行为，直到它变成自动化的、无意识的（条件反射）。</li>
<li>这种行为成为你自我认知的一部分（“我就是那种……的人”）。</li>
<li>为了维持心理的一致性，你会死命捍卫这个身份。</li>
<li>你的身份塑造新的目标，循环重新开始。如果这个身份不利于美好生活，事情就会迅速恶化。</li>
</ol>
<p>残酷的现实是，你必须打断第 6 步和第 7 步之间的循环，但这个过程从你童年时期就开始了。</p>
<p>你有生存的目标。你依赖父母教你如何生存。你必须顺从。因为大多数教育都是通过奖惩机制进行的，除非你接受他们的信念和价值观，否则就会受罚。除非你看穿这一切，否则你从未真正独立思考过。</p>
<p>更可怕的是，你的父母可能也没打破这个循环。他们也被工业时代的成功观念所制约，甚至背负着他们父母辈的思维钢印。</p>
<p>再深一层，当你满足了生理生存需求（在今天这很容易），你就会开始寻求概念或意识形态上的生存。你不再只是保护肉体，你开始拼命保护你的“思想”。看看网上的骂战就知道了，那是不同身份认同之间的战争。</p>
<p>当你的身体受到威胁，你会战或逃。 当你的身份受到威胁，反应是一模一样的。</p>
<p>如果你深度认同某种政治立场，当有人挑战你的信仰时，你会感到威胁，感到压力，甚至在情绪上感觉被人扇了一巴掌。因为大多数人不具备分析情绪真伪的能力，你就会躲进回音室，变本加厉地坚持那些可能伤害你和他人的观点。</p>
<p>同样的事情也发生在你无意识地把自己看作“一个律师”、“一个游戏玩家”或者“一个注定无法成功的人”时。</p>
<h2 data-id="heading-3">四、你想要的生活存在于特定的思维层级中</h2>
<p>心智是随着时间通过可预测的阶段进化的。</p>
<p>刚出生时，你像个求生的海绵，吸收一切文化信念以求安全。如果你不小心，你的心智可能会固化，让你难以过上更有意义的生活。</p>
<p>关于这一点，马斯洛需求层次、螺旋动力学（Spiral Dynamics）等模型都有详述。为了方便理解，我总结了自我发展的 9 个阶段（80/20 法则版）：</p>
<ol>
<li>冲动型 (Impulsive)： 冲动即行动，非黑即白。像发脾气的幼儿。</li>
<li>自我保护型 (Self-Protective)： 世界是危险的，要学会自保。学会撒谎、讨好大人。</li>
<li>从众型 (Conformist)： 群体规则就是真理。无法理解为什么有人会和自己群体不一样。</li>
<li>自我觉察型 (Self-Aware)： 意识到内心世界与外部不符。开始质疑，但不知所措。</li>
<li>尽责型 (Conscientious)： 建立原则并自我约束。比如经过深思熟虑后改变信仰，或制定职业规划。</li>
<li>个人主义型 (Individualist)： 意识到原则受环境影响。发现自己的观点只是因为成长环境，而非绝对真理。</li>
<li>策略型 (Strategist)： 玩转系统，同时意识到自己的局限。能领导组织，同时主动审视盲点。</li>
<li>构建觉察型 (Construct-Aware)： 视一切框架（包括身份）为有用的虚构。知道“地图不是疆域”。</li>
<li>合一型 (Unitive)： 自我与生活消融。工作、休息、娱乐融为一体。只是当下的存在对发生的一切做出反应。</li>
</ol>
<p>读这篇文章的人大多处于第 4 到第 8 阶段。第 4 阶段的人极度渴望改变，觉得命不该绝于此，但理不清头绪。好消息是，无论你在哪个阶段，进阶之路都有迹可循。</p>
<h2 data-id="heading-4">五、真正的智力是“得到你想要生活”的能力</h2>
<blockquote>
<p>“检验智力的唯一标准，是你是否得到了你想要的生活。” —— Naval Ravikant</p>
</blockquote>
<p>成功有个公式： 成功 = 主观能动性 (Agency) + 机会 (Opportunity) + 智力 (Intelligence)</p>
<ul>
<li>如果你有主观能动性但没机会，你会很努力但没结果。</li>
<li>如果你有主观能动性和机会但没智力，你抓不住那些机会。</li>
</ul>
<p>这里的“智力”，我想借用控制论（Cybernetics）的概念。Cybernetics 源自希腊语，意为“掌舵”。也就是“得到你想要东西的艺术”。</p>
<p>控制论揭示了智能系统的特性：</p>
<ol>
<li>有一个目标。</li>
<li>朝目标行动。</li>
<li>感知当前位置。</li>
<li>与目标对比。</li>
<li>根据反馈调整行动。</li>
</ol>
<p>智力的高低，取决于系统试错、迭代和坚持的能力。</p>
<p>偏航的船修正航向；恒温器感知温度变化并启动；胰腺在血糖升高后分泌胰岛素。这都叫智能。</p>
<p>这和生活有什么关系？关系大了。</p>
<p>高智商不是做题快，而是拥有“迭代”、“坚持”和“全局观”的能力。 低智商的表现是无法从错误中学习。</p>
<p>低智商的人遇到问题就卡住，碰到障碍就放弃。就像一个作家，写不出爆款就放弃了，因为他缺乏尝试新事物、实验和找出适合自己流程的能力。</p>
<p>高智商的人明白，只要时间足够长，任何问题都能解决。智力就是意识到：只要做出一系列正确的选择，就能达成目标。</p>
<p>要变得更聪明，你必须：</p>
<ul>
<li>拒绝既定道路。</li>
<li>潜入未知领域。</li>
<li>设定更高的新目标来扩展思维。</li>
<li>拥抱混乱，允许成长。</li>
<li>学习自然的通用原则。</li>
<li>成为一个深度通才。</li>
</ul>
<h2 data-id="heading-5">六、如何（在一天内）重启你的人生</h2>
<p>如果你想挖掘内心，真正改变人生轨迹，你需要经历三个阶段：</p>
<ol>
<li>不和谐 (Dissonance)： 你感觉现在的日子没法过了，受够了毫无进展。</li>
<li>不确定 (Uncertainty)： 你不知道下一步怎么走，可能会迷茫。</li>
<li>发现 (Discovery)： 你找到了真正想做的事，半年抵别人六年。</li>
</ol>
<p>这套流程需要你花整整一天。准备好纸和笔。</p>
<p>第一部分：早晨——心理挖掘（愿景与反愿景）</p>
<p>拿出 15-30 分钟。别用 AI，用你自己的脑子。</p>
<ol>
<li>那种让你学会忍受的、钝痛且持久的“不满意”到底是什么？</li>
<li>你在过去一年里抱怨最多，但从未真正改变的三件事是什么？</li>
<li>对于每个抱怨：旁观者如果只看你的行为（不听你说什么），会认为你真正想要的是什么？</li>
<li>关于你目前的生活，哪一个真相是你绝对不敢告诉最尊敬的人的？</li>
<li>反愿景 (Anti-Vision)： 如果未来五年什么都不变，描述一个普通的周二。你在哪醒来？身体感觉如何？你想到的第一件事是什么？谁在你身边？你现在的这种“苟且”的代价是什么？</li>
<li>如果你这辈子都这么过，从未打破这种模式，你错过了什么？</li>
<li>为了真正改变，你必须放弃哪个身份？（“我是那种……的人”）。不再做这个人，你在社交上会付出什么代价？</li>
<li>你至今没改变的最尴尬（而不是最合理）的原因是什么？</li>
<li>如果你的行为是一种自我保护，你到底在保护什么？这种保护让你失去了什么？</li>
</ol>
<p>如果你的回答足够诚实，你会感到一种深深的恶心。这种恶心是好事，它是动力。</p>
<p>现在，建立最小可行性愿景 (Minimum Viable Vision)： 10. 抛开“现不现实”。如果你打个响指就能在三年后过上不同生活，你真正想要的是什么？描述一个普通的周二。 11. 为了让那种生活感觉自然而非强迫，你必须相信自己是什么样的人？写下身份声明：“我是那种……的人”。 12. 如果你已经是那个人了，这周你会做的一件事是什么？</p>
<p>第二部分：白天——打断自动驾驶</p>
<p>仅仅写下来不够，你得打破当下的无意识模式。在手机上设闹钟，把这些问题设为提醒事项，全天轰炸自己：</p>
<ul>
<li>11:00am: 我现在做这件事，是在逃避什么？</li>
<li>1:30pm: 如果有人拍下我过去两小时的录像，他们会认为我想要什么？</li>
<li>3:15pm: 我是在走向我讨厌的生活，还是我想要的生活？</li>
<li>5:00pm: 我假装不重要，但其实最重要的事情是什么？</li>
<li>7:30pm: 我今天做的哪些事是为了“维护人设”，而不是出于真心？</li>
<li>9:00pm: 今天什么时候我感觉最“活着”？什么时候感觉像行尸走肉？</li>
</ul>
<p>第三部分：晚上——整合洞见</p>
<p>经过这一天，你应该至少有一个深刻的洞见。</p>
<ol>
<li>今天过后，关于你为什么一直卡住，感觉最真实的理由是什么？</li>
<li>谁是真正的敌人？给它起个名。不是外部环境，是你内部运行的那个模式。</li>
<li>写一句话，概括你绝不接受的生活（反愿景）。</li>
<li>写一句话，概括你正在构建的生活（愿景 MVP）。</li>
<li>设定镜头（而不是终点）： 一年镜头： 一年后哪件事必须成真，才能证明你打破了旧模式？ 一月镜头： 为了让一年目标可能实现，这周必须发生什么？ 每日镜头： 那个未来的你，明天会毫不犹豫去做的 2-3 件事是什么？</li>
</ol>
<h2 data-id="heading-6">七、把你的人生变成一款电子游戏</h2>
<blockquote>
<p>“当精神能量（注意力）投入到现实目标中，且技能与行动机会相匹配时，意识就会变得有序。” —— 米哈里·契克森米哈赖</p>
</blockquote>
<p>现在，把你所有的洞察整合成一个计划。拿出一张新纸，写下这 6 个组件：</p>
<ol>
<li>反愿景 (Anti-vision)： 我存在的噩梦，我绝不想再经历的生活。这是你的赌注。</li>
<li>愿景 (Vision)： 我理想中的生活，我的通关条件。这是你的胜利。</li>
<li>1 年目标 (1 year goal)： 这是你的主线任务。</li>
<li>1 个月项目 (1 month project)： 我需要学什么？练什么？这是你的Boss 战，用来赚经验值和掉落装备。</li>
<li>每日杠杆 (Daily levers)： 推进项目的关键任务。这是你的日常任务 (Quests)。</li>
<li>约束条件 (Constraints)： 我绝不为了目标牺牲什么？这是游戏的规则。</li>
</ol>
<p>为什么这很强大？ 因为这些组件创造了一个属于你的小世界。这就是沉迷、享受和心流状态的来源。 这就像是一个力场，把你从分心和诱惑中隔绝开来。</p>
<p>游戏玩得越久，这个力场就越强。很快，这就成了你的本能，你甚至无法想象另一种活法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AAAI 2026 | 美团技术团队学术论文精选]]></title>    <link>https://juejin.cn/post/7594385386740252691</link>    <guid>https://juejin.cn/post/7594385386740252691</guid>    <pubDate>2026-01-13T07:07:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386740252691" data-draft-id="7594533204002865215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AAAI 2026 | 美团技术团队学术论文精选"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-13T07:07:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AAAI 2026 | 美团技术团队学术论文精选
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-13T07:07:40.000Z" title="Tue Jan 13 2026 07:07:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-13
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读11分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Faaai.org%2F" target="_blank" title="https://aaai.org/" ref="nofollow noopener noreferrer">AAAI</a> 是人工智能领域顶级的国际学术会议，本文精选了美团技术团队被收录的8篇学术论文（附下载链接），覆盖大模型推理、 退火策略、过程奖励模型、强化学习、视觉文本渲染等多个技术领域，希望这些论文能对大家有所帮助或启发。</p>
<h2 data-id="heading-0">01 Promoting Efficient Reasoning with Verifiable Stepwise Reward</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2508.10293" target="_blank" title="https://arxiv.org/pdf/2508.10293" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc3605a0654c4c7a84d30446a9d3ecab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=N6YOtkkpNtU2BFdNROAD3WHECjU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：大推理模型通过强化学习提升了链式推理能力，但输出冗长，导致推理开销增大和用户体验下降，即「过度思考」问题。针对这一现象，本文提出了可验证的过程奖励机制（VSRM），通过奖励有效步骤、惩戒无效步骤，优化模型推理过程。VSRM首先通过特殊token划分推理步骤，并结合三条规则保证每个步骤的内容可读性。各步骤通过插入token生成子轨迹，模型根据每步前后正确率变化分配步骤级奖励。为避免奖励信号稀疏，引入前瞻窗口机制，通过折扣因子传播未来正确率变化，使奖励更密集。</p>
<p>实验表明，VSRM能大幅缩减输出长度，且在多种数学benchmark和不同模型、算法下保持甚至提升性能。消融实验证明前瞻窗口机制有效，显式长度惩罚对VSRM无益。VSRM机制可与各类强化学习算法无缝结合，有效抑制无效步骤，鼓励有效推理，是解决过度思考问题、提升模型推理效率的有效方法。</p>
<h2 data-id="heading-1">02 Scaling and Transferability of Annealing Strategies in Large Language Model Training</h2>
<p><strong>论文类型</strong>：Long Paper</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.17652" target="_blank" title="https://arxiv.org/pdf/2505.17652" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db2e192bb434abba92317d2c1c94422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=807%2F%2FnsqTlyvGt6ceTt1TDtnkeA%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文深入研究了大型语言模型训练过程中退火策略（Annealing Strategies）对模型性能的影响，提出了一个新的缩放法则公式来预测不同训练配置下的损失曲线。研究发现，即使在相同的训练token数量和模型规模下，不同的批次大小（batch size）和学习率调度器也会导致显著不同的训练曲线。为此，作者提出了一个改进的缩放法则公式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c912e5b5c984f6eac14c908590fe600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=il6I0OGGFl%2BX7QU5yrr1Gzg9P3s%3D" alt="" loading="lazy"/></p>
<p>其中S表示学习率对训练步数的积分（前向效应），M表示动量对训练步数的积分（退火动量项），N代表模型规模。</p>
<p>论文的核心贡献包括：(1) 证明在特定情况下，训练步数比训练token数更适合作为追踪损失曲线的指标；(2) 发现最优退火比率（Ropt）随总训练步数增加而减小，遵循幂律关系；(3) 验证了最优退火比率在训练集和验证集上保持一致；(4) 通过在Dense模型和MoE（Mixture-of-Experts）模型上的大量实验，证明小模型可以作为优化大模型训练动态的可靠代理。该研究为大规模语言模型的训练提供了更精确的理论指导，有助于优化训练效率和模型性能。</p>
<h2 data-id="heading-2">03 From Mathematical Reasoning to Code: Generalization of Process Reward Models in Test-Time Scaling</h2>
<p><strong>论文类型</strong>：Long Paper （Oral）</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2506.00027" target="_blank" title="https://arxiv.org/pdf/2506.00027" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d802b61624c4732b3098b2b4421d47d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=stLrYtwGIBOx1FG1LbWCBMxrxiU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文系统研究了过程奖励模型（Process Reward Models, PRMs）在提升大型语言模型推理能力方面的作用，特别关注其从数学推理到代码生成任务的跨域泛化能力。研究从训练方法、可扩展性和泛化能力等多个维度对PRMs进行了深入分析。</p>
<p>论文的核心发现包括：</p>
<ul>
<li><strong>训练计算资源的影响</strong>：研究发现随着PRM模型规模的增大，性能提升呈现边际递减效应，强调了在模型规模和计算成本之间寻找平衡的重要性。同时，训练数据集的多样性显著影响PRM性能，作者提出的ASLAF（自动步骤级标注与过滤）方法在多个基准测试中表现优异。</li>
<li><strong>测试时扩展策略</strong>：论文评估了Best-of-N采样、束搜索、蒙特卡洛树搜索（MCTS）和多数投票等多种搜索策略。结果表明，在计算资源充足时MCTS效果最佳，而在资源受限情况下Best-of-N采样是实用的替代方案。</li>
<li><strong>跨域泛化能力</strong>：令人惊讶的是，在数学数据集上训练的PRMs在代码生成任务上的表现与专门针对代码训练的模型相当，展现出强大的跨域适应能力。通过梯度分析，研究还发现PRMs倾向于选择具有相似底层推理模式的响应，这为理解其优化机制提供了新视角。该研究为优化大规模语言模型的训练和部署提供了重要的理论指导和实践参考。</li>
</ul>
<h2 data-id="heading-3">04 Rethinking the Sampling Criteria in Reinforcement Learning for LLM Reasoning: A Competence-Difficulty Alignment Perspective</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.17652" target="_blank" title="https://arxiv.org/pdf/2505.17652" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/772cebd44c5645f3b99f28b1ffc94059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=XJzBCeoGug2YuCDzM051Y%2FVKEpU%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文对强化学习（RL）中的问题采样策略进行了系统性研究，当前主流采样策略大多直接依赖单步通过率（Pass Rate） 作为问题难度指标，存在 1）对问题难度的估计不够稳定；2）无法有效捕捉模型能力与问题难度的对齐关系的问题。</p>
<p>针对这些问题，本文提出了 CDAS（Competence-Difficulty Alignment Sampling）：一种将模型能力与问题难度显式建模并对齐的动态采样方法。CDAS 不依赖单步通过率，而是通过累积历史表现差异来构建更稳定的难度估计；同时定义模型能力，并以不动点系统确保两者在训练过程中共同收敛。基于能力—难度差值构建对齐指标，再通过对称采样策略，选取最匹配模型当前能力的问题，从而提升有效梯度比例与训练效率。CDAS 在数学推理和代码生成场景中均通过 RL 训练 验证，结果显示 CDAS 显著提升了采样效率与模型性能，击败了多种主流采样策略。</p>
<h2 data-id="heading-4">05 ViType: High-Fidelity Visual Text Rendering via Glyph-Aware Multimodal Diffusion</h2>
<p><strong>论文类型</strong>：Oral</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2FViType__High_Fidelity_Visual_Text_Rendering_via_Glyph_Aware_Multimodal.pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/ViType__High_Fidelity_Visual_Text_Rendering_via_Glyph_Aware_Multimodal.pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07f269513b6a49b99bd150406b2a3b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=RMuMAul6DDKtn3iSxTDSrqAQ0BQ%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：随着文生图模型在电商营销等领域的广泛应用，视觉文本渲染的准确性已成为制约生成质量的核心瓶颈。现有模型因缺乏字形级理解能力，难以精确刻画多语言字符结构，导致海报、商品图等商业场景中文字乱码、字形失真等问题频发，严重阻碍了AIGC在智能设计中的实际落地。</p>
<p>针对这一关键挑战，我们提出ViType三阶段对齐增强框架：首先通过视觉问答机制实现文本-字形显式对齐，将字符视觉结构注入大语言模型语义空间；其次创新性地将预对齐字形嵌入与文本token同步输入多模态扩散Transformer，通过联合训练建立跨模态特征协同；最后基于高质量图文对进行美学精调，确保生成图像的版式和谐与视觉美感。该框架使字符准确率提升15%以上，为电商海报、营销物料等高精度视觉内容创作提供了可靠的技术支撑。</p>
<h2 data-id="heading-5">06 DSCF: Dual-Source Counterfactual Fusion for High-Dimensional Combinatorial Interventions</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2F%25E3%2580%2590AAAI%25E3%2580%2591DSCF.pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/%E3%80%90AAAI%E3%80%91DSCF.pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/581f0d39113446e3a43bfb6dad862683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=cJpgWBmoPujc8MsOKyh%2B20BcrAQ%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：在个性化推荐、数字营销和医疗健康等领域，基于观测数据预测反事实结果对科学决策至关重要。在这些应用场景中，决策过程往往涉及高维组合干预策略，例如多渠道资源捆绑投放或产品组合推荐。面向这类场景，无论是历史策略的效果评估还是新策略的优化，都需要模型能够对历史数据中很少出现甚至从未出现过的策略组合效果进行准确预测。此外，观测数据中源于历史分配策略和倾向性投放的选择偏差会进一步加剧数据稀疏问题，从而影响反事实推断的准确性。</p>
<p>为此，本文提出双源反事实融合模型（Dual-Source Counterfactual Fusion，DSCF），该可扩展框架通过双专家混合架构联合建模观测数据和代理反事实样本，并采用领域引导融合机制，在有效平衡偏差消除与信息多样性的同时，还能自适应地泛化到反事实输入场景。在合成和半合成数据集上的大量实验表明，DSCF框架能够显著提升高维组合干预场景下的预测准确性，并在不同情境下展现出优异的鲁棒性表现。</p>
<h2 data-id="heading-6">07 Compress-then-Rank: Faster and Better Listwise Reranking with Large Language Models via Ranking-Aware Passage Compression</h2>
<p><strong>论文类型</strong>：Poster</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs3plus.meituan.net%2Fddfile%2FAAAI2026_C2R(1).pdf" target="_blank" title="https://s3plus.meituan.net/ddfile/AAAI2026_C2R(1).pdf" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ed70403cca443fa84ffeb6a345fe77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=0yjJFqdSMcCeT3s4shfRxC8x9Rc%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：基于大型语言模型（LLMs）的列表重排序（listwise reranking）已经成为最先进的方法，在段落重排序任务中不断创下新的性能基准。然而，其实际应用面临两个关键挑战：处理长序列时高昂的计算开销和高延迟，以及由于“迷失在中间”等现象导致的长上下文性能下降。</p>
<p>为了解决这些问题，我们提出了一种高效的框架压缩后排序（Compress-then-Rank, C2R），该框架不是直接对原始段落进行列表重排序，而是对其紧凑的多向量代理进行操作。这些代理可以预先计算并缓存，适用于语料库中的所有段落。C2R 的有效性依赖于三项关键创新。首先，压缩模型通过结合文本恢复和文本延续目标进行预训练，生成高保真的压缩向量序列，从而减轻了单向量方法中常见的语义损失问题。其次，一种新颖的输入方案将每个序数索引的嵌入添加到其对应的压缩向量序列前，这不仅划定了段落边界，还引导重排序 LLM 生成排序列表。最后，压缩模型和重排序模型通过联合优化，使压缩过程对排序目标具有排序感知能力。在主要重排序基准上的广泛实验表明，C2R 在提供显著加速的同时，能够实现与全文重排序方法相当甚至更优的排序性能。</p>
<h2 data-id="heading-7">08 Multi-Aspect Cross-modal Quantization for Generative Recommendation</h2>
<p><strong>论文类型</strong>：Oral</p>
<p><strong>论文下载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2511.15122" target="_blank" title="https://arxiv.org/pdf/2511.15122" ref="nofollow noopener noreferrer">PDF</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e487a0d32fb24a34b88de19e1b696875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=uXpRPJu2YTYICtSHfFUsqunbYI0%3D" alt="" loading="lazy"/></p>
<p><strong>论文简介</strong>：本文提出一种基于多模态融合的生成式推荐框架（MACRec），旨在解决现有生成式推荐方法因模态信息利用不足和跨模态交互缺失导致的性能瓶颈。</p>
<p>针对文本与视觉模态的量化难题，MACRec引入跨模态量化与多角度对齐机制，通过两阶段技术路线实现优化：1）跨模态残差量化：将对比学习融入分层量化过程，生成兼具语义层次性与模态兼容性的物品标识符，显著降低多模态表征冲突；2）跨模态协同对齐：通过显式-隐式协同对齐策略，分别建模文本与视觉模态的共享特征和互补特征，增强生成式推荐的多模态理解能力。在亚马逊电商推荐数据集上的实验结果表明，MACRec相较基准模型在推荐性能上有显著提升；各模态的码本分布更均衡、利用率更低，充分验证了跨模态量化与对齐机制在提升生成式推荐有效性方面的优势。</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7392bde83446528a07ba8d9e4c8c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892860&amp;x-signature=iAOhBJZdBsE%2BhhWL3UHy1x3Cd0E%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx日志分析工具-NginxPulse开源了]]></title>    <link>https://juejin.cn/post/7594385386740301843</link>    <guid>https://juejin.cn/post/7594385386740301843</guid>    <pubDate>2026-01-13T07:23:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386740301843" data-draft-id="7594351060615708691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx日志分析工具-NginxPulse开源了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T07:23:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3984285870859614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx日志分析工具-NginxPulse开源了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3984285870859614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:23:19.000Z" title="Tue Jan 13 2026 07:23:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上周写了个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaisir.cn%2Fpost%2F186" target="_blank" title="https://www.kaisir.cn/post/186" ref="nofollow noopener noreferrer">nginx 日志分析系统</a>，这几天花了点时间把代码整理了下，现已开源。</p>
<p>欢迎各位有需要的开发者自取。</p>
<h2 data-id="heading-1">项目地址</h2>
<ul>
<li>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flikaia%2Fnginxpulse" target="_blank" title="https://github.com/likaia/nginxpulse" ref="nofollow noopener noreferrer">github.com/likaia/ngin…</a></li>
<li>dockerhub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fmagiccoders%2Fnginxpulse%2F" target="_blank" title="https://hub.docker.com/r/magiccoders/nginxpulse/" ref="nofollow noopener noreferrer">hub.docker.com/r/magiccode…</a></li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5aba9d653f3448d9cb56a4b8912bf40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893799&amp;x-signature=OELLIFoqZWehzvcGx1irsYE6X3U%3D" alt="demo-img-1.png" loading="lazy"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561f6858b63e4d6b87e989fca37b2deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893799&amp;x-signature=W%2F%2BisIxmZJfmiU9emDVxpIZNNdY%3D" alt="demo-img-2.png" loading="lazy"/></p>
<h2 data-id="heading-2">写在最后</h2>
<p>我是<strong>神奇的程序员</strong>，一位前端开发工程师。</p>
<p>如果你对我感兴趣，请移步我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaisir.cn%2F" target="_blank" title="https://www.kaisir.cn/" ref="nofollow noopener noreferrer">个人网站</a>，进一步了解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作]]></title>    <link>https://juejin.cn/post/7594405684592115764</link>    <guid>https://juejin.cn/post/7594405684592115764</guid>    <pubDate>2026-01-13T07:26:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594405684592115764" data-draft-id="7594358540049137699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-01-13T07:26:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Anthropic新发布】Cowork：Claude Code 适用于你的其他工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:26:03.000Z" title="Tue Jan 13 2026 07:26:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fcowork-research-preview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/blog/cowork-research-preview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">转载</a></p>
<p>当我们发布 Claude Code 时,我们期望开发者会用它来编写代码。他们确实这样做——然后很快开始用它处理<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fclaudeai%2Fstatus%2F2009666254815269313" target="_blank" title="https://x.com/claudeai/status/2009666254815269313" ref="nofollow noopener noreferrer">几乎其他所有事情</a>。这促使我们构建了 Cowork：一种更简单的方式,让任何人——<a href="https://juejin.cn/post/7594358540049039395" target="_blank" title="https://juejin.cn/post/7594358540049039395">不仅仅是开发者</a>——都能以完全相同的方式与 Claude 协作。从今天起,Cowork 已在我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fdownload%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/download?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">macOS app</a> 上向 Claude Max 订阅者提供研究预览版,我们将从这里快速改进它。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447db088f5b149868a73d1a37bf3979e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=oltjTobPb8Oh2xiT%2F68dGNUqvNk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee6707b06a24c9a99c01989c9d9bb72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=n1sJRsuXUeqHrIEkb%2BltZGYk0yU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">使用 Cowork 与普通对话有什么不同？</h2>
<p>在 Cowork 中,你让 Claude 访问你计算机上你选择的文件夹。然后 Claude 可以读取、编辑或创建该文件夹中的文件。例如,它可以通过对每个文件进行排序和重命名来重新整理你的下载文件夹,从一堆截图中创建包含支出列表的新电子表格,或者从你分散的笔记中生成报告的初稿。</p>
<p>在 Cowork 中,Claude 完成此类工作时,比你在普通对话中看到的具有更强的自主性。一旦你设置了任务,Claude 就会制定计划并稳步完成,同时向你通报它的进展。如果你使用过 Claude Code,这会感觉很熟悉——Cowork 基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilding-agents-with-the-claude-agent-sdk" target="_blank" title="https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk" ref="nofollow noopener noreferrer">完全相同的基础</a>构建。这意味着 Cowork 可以承担许多与 Claude Code 相同的任务,但以更适合非编码任务的形式呈现。</p>
<p>当你掌握了基础知识后,你可以让 Cowork 变得更强大。Claude 可以使用你现有的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fconnectors%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/connectors?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">connectors</a>(将 Claude 连接到外部信息),在 Cowork 中,我们添加了初始的一组 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">skills</a>,可以提高 Claude 创建文档、演示文稿和其他文件的能力。如果你将 Cowork 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fchrome%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/chrome?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Claude in Chrome</a> 配合使用,Claude 也可以完成需要浏览器访问的任务。</p>
<p>Cowork 旨在让使用 Claude 处理新工作尽可能简单。你不需要手动持续提供上下文或将 Claude 的输出转换为正确的格式。你也不必等待 Claude 完成后再提供进一步的想法或反馈：你可以排队多个任务,让 Claude 并行处理它们。这种感觉更像是在给同事留言,而不是来回对话。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b5f787bf134e1ca48b2297bf30d03d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768893962&amp;x-signature=yJoqiasZIrhQeWCeBspnnMra9hY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">保持控制</h2>
<p>在 Cowork 中,你可以选择 Claude 可以看到哪些文件夹和 connectors：Claude 无法读取或编辑任何你没有明确授权的内容。Claude 还会在采取任何重大操作之前征求你的许可,因此你可以根据需要引导或纠正它。</p>
<p>也就是说,在让 Claude 接管之前,还有一些事情需要注意。默认情况下,主要需要知道的是,如果被指示,Claude 可以采取潜在的破坏性操作(例如删除本地文件)。由于 Claude 总是有可能误解你的指示,你应该对此类事情给出非常明确的指导。</p>
<p>你还应该注意"<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fprompt-injection-defenses" target="_blank" title="https://www.anthropic.com/research/prompt-injection-defenses" ref="nofollow noopener noreferrer">prompt injections</a>"(提示注入)的风险：攻击者试图通过 Claude 在互联网上遇到的内容来改变 Claude 的计划。我们已经针对 prompt injections 构建了复杂的防御措施,但 agent 安全——即保护 Claude 现实世界行为的任务——仍然是行业中的一个积极发展领域。</p>
<p>这些风险并非 Cowork 特有,但这可能是你第一次使用超越简单对话的更高级工具。我们建议采取预防措施,尤其是在你学习它如何工作的时候。我们在我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.claude.com%2Fen%2Farticles%2F13364135-using-cowork-safely%3Futm_source%3Dchatgpt.com" target="_blank" title="https://support.claude.com/en/articles/13364135-using-cowork-safely?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Help Center</a> 中提供了更多详细信息。</p>
<h2 data-id="heading-2">展望未来</h2>
<p>这是一个研究预览版。我们之所以提前发布 Cowork,是因为我们想了解人们用它来做什么,以及他们认为如何可以做得更好。我们鼓励你尝试 Cowork 可以为你做什么,并尝试你意想不到的事情：你可能会感到惊喜！随着我们从此次预览中学到更多,我们计划进行大量改进(包括通过添加跨设备同步并将其带到 Windows),并确定进一步使其更安全的方法。</p>
<p>Claude Max 订阅者现在可以下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fdownload%3Futm_source%3Dchatgpt.com" target="_blank" title="https://claude.com/download?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">macOS app</a> 尝试 Cowork,然后点击侧边栏中的"Cowork"。如果你使用其他计划,可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fforms.gle%2FmtoJrd8kfYny29jQ9" target="_blank" title="https://forms.gle/mtoJrd8kfYny29jQ9" ref="nofollow noopener noreferrer">加入等候名单</a>以备将来访问。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线入门]]></title>    <link>https://juejin.cn/post/7594533204003127359</link>    <guid>https://juejin.cn/post/7594533204003127359</guid>    <pubDate>2026-01-13T07:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003127359" data-draft-id="7594403873178271785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线入门"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-13T07:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:41:35.000Z" title="Tue Jan 13 2026 07:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">绘制K线入门</h2>
<h3 data-id="heading-1">什么是K线</h3>
<p>K线（又称蜡烛图）是金融领域用来表示价格走势的一种图表形式。每根K线代表一个时间周期（如1分钟、5分钟、1小时、1天等）内的价格变化情况。</p>
<h4 data-id="heading-2">K线的组成部分</h4>
<p>一根K线由以下几个部分组成：</p>
<ol>
<li><strong>实体（Body）</strong> ：矩形部分，表示开盘价和收盘价之间的价格区间</li>
</ol>
<ul>
<li>
<ul>
<li>如果收盘价 &gt; 开盘价：称为<strong>阳线</strong>（通常用红色表示，表示上涨）</li>
<li>如果收盘价 &lt; 开盘价：称为<strong>阴线</strong>（通常用绿色表示，表示下跌）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>上影线（Upper Shadow）</strong> ：实体上方的细线，表示最高价到实体上边缘的距离</li>
<li><strong>下影线（Lower Shadow）</strong> ：实体下方的细线，表示最低价到实体下边缘的距离</li>
</ol>
<h4 data-id="heading-3">K线的数据要素</h4>
<p>每根K线需要以下数据：</p>
<ul>
<li><strong>Date（时间）</strong> ：该K线的时间周期（如：2025/01/20、2025-01-20 10:00:00等）</li>
<li><strong>Open（开盘价）</strong> ：该时间周期开始时的价格</li>
<li><strong>Close（收盘价）</strong> ：该时间周期结束时的价格</li>
<li><strong>High（最高价）</strong> ：该时间周期内的最高价格</li>
<li><strong>Low（最低价）</strong> ：该时间周期内的最低价格</li>
<li><strong>Volume（成交量）</strong> ：该时间周期内的交易量（可选，用于其他分析）</li>
</ul>
<h4 data-id="heading-4">数据模型定义</h4>
<p>在代码中，我们用 Kotlin 的 <code>data class</code> 来表示K线数据：</p>
<h5 data-id="heading-5">类图</h5>
<pre><code class="hljs language-markdown" lang="markdown">@startuml
class KLineEntity {
<span class="hljs-bullet">  -</span> Close: String
<span class="hljs-bullet">  -</span> Date: String
<span class="hljs-bullet">  -</span> High: String
<span class="hljs-bullet">  -</span> Low: String
<span class="hljs-bullet">  -</span> Open: String
<span class="hljs-bullet">  -</span> Volume: String
<span class="hljs-bullet">  +</span> getCloseFloat(): Float
<span class="hljs-bullet">  +</span> getOpenFloat(): Float
<span class="hljs-bullet">  +</span> getHighFloat(): Float
<span class="hljs-bullet">  +</span> getLowFloat(): Float
<span class="hljs-bullet">  +</span> isRising(): Boolean
}
@enduml
</code></pre>
<h5 data-id="heading-6">代码实现</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineEntity</span>(
    <span class="hljs-keyword">val</span> Close: String,    <span class="hljs-comment">// 收盘价</span>
    <span class="hljs-keyword">val</span> Date: String,     <span class="hljs-comment">// 日期</span>
    <span class="hljs-keyword">val</span> High: String,     <span class="hljs-comment">// 最高价</span>
    <span class="hljs-keyword">val</span> Low: String,      <span class="hljs-comment">// 最低价</span>
    <span class="hljs-keyword">val</span> Open: String,     <span class="hljs-comment">// 开盘价</span>
    <span class="hljs-keyword">val</span> Volume: String    <span class="hljs-comment">// 成交量</span>
) {
    <span class="hljs-comment">// 类型转换方法（String → Float）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCloseFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Close.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOpenFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Open.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHighFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = High.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLowFloat</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = Low.toFloatOrNull() ?: <span class="hljs-number">0f</span>
    
    <span class="hljs-comment">// 判断是否为阳线（上涨）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isRising</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = getCloseFloat() &gt; getOpenFloat()
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>isRising()</code> 用于判断涨跌，决定绘制时使用阳线颜色还是阴线颜色</li>
</ul>
<h4 data-id="heading-7">涨跌判断</h4>
<p>判断一根K线是涨还是跌：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isRising</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = getCloseFloat() &gt; getOpenFloat()
</code></pre>
<ul>
<li><strong>阳线（上涨）</strong> ：收盘价 &gt; 开盘价</li>
<li><strong>阴线（下跌）</strong> ：收盘价 &lt; 开盘价</li>
<li><strong>平盘</strong>：收盘价 = 开盘价（较少见，通常也按阳线处理）</li>
</ul>
<h3 data-id="heading-8">如何绘制蜡烛图（入门版本）</h3>
<p><strong>说明</strong>：本章节介绍的是<strong>入门版本的K线绘制方法</strong>，采用最简单、最直观的实现方式，适合初学者循序渐进地学习。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>固定坐标系（不滚动、不缩放）</li>
<li>绘制所有数据（不区分可见区间）</li>
<li>代码逻辑简单清晰</li>
<li>便于理解K线绘制的核心原理</li>
</ul>
<p><strong>学习路径</strong>：</p>
<ol>
<li>先掌握入门版本的绘制方法（本章节）</li>
<li>理解坐标计算、价格转换等核心概念</li>
<li>后续章节会逐步引入滚动、缩放、性能优化等高级功能</li>
</ol>
<p>循序渐进，从简单到复杂，才能更好地理解K线绘制的本质。</p>
<h4 data-id="heading-9">绘制步骤</h4>
<p>绘制一根K线（蜡烛图）需要以下步骤：</p>
<ol>
<li><strong>计算坐标</strong></li>
</ol>
<ul>
<li>
<ul>
<li>计算K线的中心X坐标（基于索引位置）</li>
<li>将价格转换为Y坐标（最高价、最低价、开盘价、收盘价）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>绘制影线</strong></li>
</ol>
<ul>
<li>
<ul>
<li>绘制上影线：从最高价到实体上边缘</li>
<li>绘制下影线：从最低价到实体下边缘</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>绘制实体</strong></li>
</ol>
<ul>
<li>
<ul>
<li>根据涨跌选择颜色（阳线红色，阴线绿色）</li>
<li>绘制矩形实体（从开盘价到收盘价）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">坐标计算</h4>
<h5 data-id="heading-11">X坐标计算</h5>
<p>K线的X坐标基于其在数据列表中的索引位置：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 每根K线占用的总宽度（从配置中获取）</span>
val totalCandleWidth = config.<span class="hljs-built_in">getTotalCandleWidth</span>()  <span class="hljs-comment">// candleWidth + candleSpacing = 30px</span>

<span class="hljs-comment">// K线中心X坐标（从0开始，不使用偏移）</span>
val centerX = index * totalCandleWidth + config.candleWidth / <span class="hljs-number">2</span>

<span class="hljs-comment">// K线实体左右边界</span>
val left = centerX - config.candleWidth / <span class="hljs-number">2</span>
val right = centerX + config.candleWidth / <span class="hljs-number">2</span>
</code></pre>
<h5 data-id="heading-12">Y坐标计算</h5>
<p>价格转Y坐标的公式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">priceToY</span><span class="hljs-params">(price: <span class="hljs-type">Float</span>, minPrice: <span class="hljs-type">Float</span>, maxPrice: <span class="hljs-type">Float</span>, height: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">val</span> priceRange = maxPrice - minPrice
    <span class="hljs-keyword">if</span> (priceRange == <span class="hljs-number">0f</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0f</span>
    <span class="hljs-keyword">val</span> ratio = (maxPrice - price) / priceRange
    <span class="hljs-keyword">return</span> height * ratio
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>minPrice</code> 和 <code>maxPrice</code> 是所有K线的价格范围（包含10%边距）</li>
<li><code>height</code> 是View的高度</li>
<li>价格越高，Y坐标越小（屏幕上方）</li>
<li>入门版本绘制所有数据，不区分可见区间</li>
</ul>
<h4 data-id="heading-13">绘制顺序</h4>
<p>绘制K线时，应该<strong>先绘制影线，再绘制实体</strong>，这样实体可以覆盖影线的中间部分：</p>
<ol>
<li><strong>绘制上影线</strong>：从最高价到实体上边缘</li>
<li><strong>绘制下影线</strong>：从最低价到实体下边缘</li>
<li><strong>绘制实体</strong>：绘制矩形，覆盖影线的中间部分</li>
</ol>
<h4 data-id="heading-14">绘制代码示例</h4>
<pre><code class="hljs language-scss" lang="scss">private fun <span class="hljs-built_in">drawCandle</span>(
    canvas: Canvas,
    entity: KLineEntity,
    index: Int,
    minPrice: Float,
    maxPrice: Float,
    height: Float
) {
    <span class="hljs-comment">// 1. 计算X坐标</span>
    val totalCandleWidth = config<span class="hljs-selector-class">.getTotalCandleWidth</span>()
    val centerX = index * totalCandleWidth + config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>
    val <span class="hljs-attribute">left</span> = centerX - config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>
    val <span class="hljs-attribute">right</span> = centerX + config<span class="hljs-selector-class">.candleWidth</span> / <span class="hljs-number">2</span>

    <span class="hljs-comment">// 2. 计算各价格的Y坐标</span>
    val highY = <span class="hljs-built_in">priceToY</span>(entity.getHighFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val lowY = <span class="hljs-built_in">priceToY</span>(entity.getLowFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val openY = <span class="hljs-built_in">priceToY</span>(entity.getOpenFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    val closeY = <span class="hljs-built_in">priceToY</span>(entity.getCloseFloat(), minPrice, maxPrice, <span class="hljs-attribute">height</span>)
    
    <span class="hljs-comment">// 3. 计算实体边界</span>
    val <span class="hljs-attribute">top</span> = <span class="hljs-built_in">minOf</span>(openY, closeY)      <span class="hljs-comment">// 实体上边缘（较小的Y值）</span>
    val <span class="hljs-attribute">bottom</span> = <span class="hljs-built_in">maxOf</span>(openY, closeY)   <span class="hljs-comment">// 实体下边缘（较大的Y值）</span>
    
    <span class="hljs-comment">// 4. 选择颜色和画笔</span>
    val isRising = entity<span class="hljs-selector-class">.isRising</span>()
    val bodyPaint = if (isRising) risingPaint else fallingPaint
    shadowPaint<span class="hljs-selector-class">.color</span> = if (isRising) config<span class="hljs-selector-class">.risingColor</span> else config<span class="hljs-selector-class">.fallingColor</span>
    
    <span class="hljs-comment">// 5. 绘制上影线（从最高价到实体上边缘）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawLine</span>(centerX, highY, centerX, top, shadowPaint)
    
    <span class="hljs-comment">// 6. 绘制下影线（从最低价到实体下边缘）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawLine</span>(centerX, bottom, centerX, lowY, shadowPaint)
    
    <span class="hljs-comment">// 7. 绘制实体（矩形）</span>
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(left, top, right, bottom, bodyPaint)
}
</code></pre>
<h4 data-id="heading-15">绘制要点</h4>
<ol>
<li><strong>影线宽度</strong>：通常比实体窄，例如实体宽度20px，影线宽度2px</li>
<li><strong>颜色区分</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>阳线（上涨）：通常用红色或白色</li>
<li>阴线（下跌）：通常用绿色或黑色</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>实体高度</strong>：实体高度 = |收盘价 - 开盘价|，如果开盘价等于收盘价，实体高度为0（显示为一条横线）</li>
<li><strong>影线长度</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>上影线长度 = 最高价 - max(开盘价, 收盘价)</li>
<li>下影线长度 = min(开盘价, 收盘价) - 最低价</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">配置模型（KLineConfig）</h3>
<p>K线绘制需要配置参数，我们使用 <code>KLineConfig</code> 来管理这些配置：</p>
<h5 data-id="heading-17">类图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc50768eeb374359bda181215a8e79a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894895&amp;x-signature=GPhLd3o4gY6FntYKiSJ3fQCCPPI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-18">代码实现</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KLineConfig</span>(
    <span class="hljs-keyword">val</span> candleWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">20f</span>,      <span class="hljs-comment">// K线实体宽度（像素）</span>
    <span class="hljs-keyword">val</span> candleSpacing: <span class="hljs-built_in">Float</span> = <span class="hljs-number">10f</span>,    <span class="hljs-comment">// K线之间的间距（像素）</span>
    <span class="hljs-keyword">val</span> risingColor: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0xFFFF0000</span>, <span class="hljs-comment">// 阳线颜色（红色）</span>
    <span class="hljs-keyword">val</span> fallingColor: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0xFF00FF00</span>,<span class="hljs-comment">// 阴线颜色（绿色）</span>
    <span class="hljs-keyword">val</span> shadowWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">2f</span>        <span class="hljs-comment">// 影线宽度（像素）</span>
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTotalCandleWidth</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Float</span> = candleWidth + candleSpacing
}
</code></pre>
<h5 data-id="heading-19">依赖关系</h5>
<ul>
<li><strong>KLineViewCase1</strong> 依赖 <strong>KLineConfig</strong>：KLineViewCase1内部持有KLineConfig实例，用于获取绘制参数（宽度、间距、颜色等）</li>
<li><strong>KLineViewCase1</strong> 使用 <strong>KLineEntity</strong>：KLineViewCase1接收KLineEntity列表作为数据源进行绘制</li>
</ul>
<h4 data-id="heading-20">配置说明</h4>
<ul>
<li><strong>candleWidth (20px)</strong> : K线实体（矩形部分）的宽度</li>
<li><strong>candleSpacing (10px)</strong> : 相邻两根K线之间的间距</li>
<li><strong>risingColor</strong>: 阳线颜色（收盘价 &gt; 开盘价）</li>
<li><strong>fallingColor</strong>: 阴线颜色（收盘价 &lt; 开盘价）</li>
<li><strong>shadowWidth (2px)</strong> : 影线的宽度</li>
</ul>
<h4 data-id="heading-21">参数关系</h4>
<pre><code class="hljs language-ini" lang="ini">每根K线占用的总宽度 = candleWidth + <span class="hljs-attr">candleSpacing</span>
                   = 20px + <span class="hljs-attr">10px</span> = <span class="hljs-number">30</span>px
</code></pre>
<p><strong>说明</strong>：入门版本会绘制所有K线数据，不涉及可见区间和数量限制的计算。</p>
<h3 data-id="heading-22">完整绘制流程</h3>
<h4 data-id="heading-23">View的onDraw方法</h4>
<p>K线图的绘制在自定义View的 <code>onDraw()</code> 方法中完成，完整流程如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onDraw(canvas)

    <span class="hljs-comment">// 0. 绘制背景</span>
    <span class="hljs-keyword">val</span> width = width.toFloat()
    <span class="hljs-keyword">val</span> height = height.toFloat()
    canvas.drawRect(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, width, height, backgroundPaint)

    <span class="hljs-keyword">if</span> (klineData.isEmpty()) {
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 1. 计算价格范围（包含边距）</span>
    <span class="hljs-keyword">val</span> priceRange = calculatePriceRange()
    <span class="hljs-keyword">if</span> (priceRange.first &gt;= priceRange.second) {
        <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 价格范围无效</span>
    }

    <span class="hljs-keyword">val</span> minPrice = priceRange.first
    <span class="hljs-keyword">val</span> maxPrice = priceRange.second

    <span class="hljs-comment">// 2. 遍历所有K线数据，逐根绘制</span>
    klineData.forEachIndexed { index, entity -&gt;
        drawCandle(canvas, entity, index, minPrice, maxPrice, height)
    }
}
</code></pre>
<h4 data-id="heading-24">价格范围计算</h4>
<p>在绘制K线之前，需要先计算所有K线的价格范围（最高价和最低价），并添加边距：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculatePriceRange</span><span class="hljs-params">()</span></span>: Pair&lt;<span class="hljs-built_in">Float</span>, <span class="hljs-built_in">Float</span>&gt; {
    <span class="hljs-keyword">if</span> (klineData.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0f</span> to <span class="hljs-number">0f</span>
    }

    <span class="hljs-keyword">var</span> minPrice = <span class="hljs-built_in">Float</span>.MAX_VALUE
    <span class="hljs-keyword">var</span> maxPrice = <span class="hljs-built_in">Float</span>.MIN_VALUE

    <span class="hljs-comment">// 遍历所有K线，找出最高价和最低价</span>
    klineData.forEach { entity -&gt;
        <span class="hljs-keyword">val</span> high = entity.getHighFloat()
        <span class="hljs-keyword">val</span> low = entity.getLowFloat()
        <span class="hljs-keyword">if</span> (high &gt; maxPrice) maxPrice = high
        <span class="hljs-keyword">if</span> (low &lt; minPrice) minPrice = low
    }

    <span class="hljs-comment">// 添加10%的边距，让K线不会紧贴上下边缘</span>
    <span class="hljs-keyword">val</span> priceRange = maxPrice - minPrice
    <span class="hljs-keyword">val</span> padding = priceRange * <span class="hljs-number">0.1f</span>
    <span class="hljs-keyword">val</span> adjustedMinPrice = minPrice - padding
    <span class="hljs-keyword">val</span> adjustedMaxPrice = maxPrice + padding

    <span class="hljs-keyword">return</span> adjustedMinPrice to adjustedMaxPrice
}
</code></pre>
<p><strong>为什么要添加边距？</strong></p>
<ul>
<li>避免K线紧贴View的上下边缘</li>
<li>让图表看起来更美观</li>
</ul>
<h4 data-id="heading-25">完整绘制链路</h4>
<p>K线绘制的完整流程：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 设置K线数据 → 触发<span class="hljs-built_in">onDraw</span>()重绘
   ↓
<span class="hljs-number">2</span>. <span class="hljs-built_in">onDraw</span>()方法执行：
   ├─ 绘制背景
   ├─ 检查数据是否为空
   ├─ 计算价格范围
   │   ├─ 遍历所有K线，找出最高价和最低价
   │   └─ 添加<span class="hljs-number">10%</span>边距
   └─ 遍历K线数据，对每根K线调用<span class="hljs-built_in">drawCandle</span>()
       ├─ 计算X坐标（基于索引）
       ├─ 计算Y坐标（最高价、最低价、开盘价、收盘价）
       ├─ 绘制上影线
       ├─ 绘制下影线
       └─ 绘制实体
</code></pre>
<h3 data-id="heading-26">效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49bb1c5b3f58461c9a7a616f707c2894~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894895&amp;x-signature=BF6hD1SJ6ywFP9oTLr1O%2BdsvV%2F4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts]]></title>    <link>https://juejin.cn/post/7594533204003192895</link>    <guid>https://juejin.cn/post/7594533204003192895</guid>    <pubDate>2026-01-13T07:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003192895" data-draft-id="7594385386740367379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts"/> <meta itemprop="keywords" content="AI编程,OpenAI,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T07:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文看懂 AI 世界里的新黑话Skills、MCP、Projects、Prompts
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:47:38.000Z" title="Tue Jan 13 2026 07:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">Skills、MCP、Projects、Prompts 到底在说什么？</h2>
<p>最近不少人跟我吐槽：</p>
<blockquote>
<p>“我只是想用下 AI，结果一抬头全是新名词，低头一看，自己仿佛落后了一个时代。”</p>
</blockquote>
<p>Skills、MCP、Projects、Prompts……这些词听起来像高深的新框架、新协议，甚至像某种“圈内黑话”，但说实话——<strong>没那么玄</strong>。</p>
<p>今天咱们逐个拆解，用最直白的话把这些概念讲透，看完你就能轻松跟上 AI 圈的节奏。</p>
<hr/>
<h2 data-id="heading-1">一、Prompts（提示词）：控制 AI 输出的基础语言工具</h2>
<p>先从最基础，也最容易被低估的概念说起——Prompt。</p>
<h3 data-id="heading-2">1️⃣ 什么是 Prompt？</h3>
<p>核心定义很简单：<strong>Prompt = 你给 AI 的指令 / 输入</strong></p>
<p>比如这些常见场景，你输出的内容都是 Prompt：</p>
<ul>
<li>
<p>“帮我写一段 Java 代码，实现用户登录校验”</p>
</li>
<li>
<p>“用小学生能听懂的话解释什么是 JVM”</p>
</li>
<li>
<p>“假设你是资深 Java 架构师，帮我设计一个高可用的订单系统”</p>
</li>
</ul>
<p>一句话总结：<strong>Prompts 本质是“你跟 AI 沟通的自然语言指令或可复用模板”</strong>，核心作用是精准传递需求，为模型提供上下文和方向，是控制 AI 输出的基础语言工具，而非“解决效率低下”本身。需要注意的是，Prompts 是即时的、一次性的，除非刻意保存，否则仅存在于当前对话中。([claude.com][2])</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 为什么 Prompt 这么重要？</h3>
<p>关键前提：AI 没有“读心术”，它只会 <strong>严格按照你给出的指令执行</strong>，你的 Prompt 质量直接决定输出效果。</p>
<p>这是最直观的对比：</p>
<ul>
<li>
<p>Prompt 模糊 → 输出敷衍、抓不住重点（像摸鱼）</p>
</li>
<li>
<p>Prompt 清晰 → 输出精准、专业度拉满（像加班赶工）</p>
</li>
</ul>
<p>用同一个 AI 测试，差距立现：</p>





















<table><thead><tr><th>Prompt</th><th>输出结果</th></tr></thead><tbody><tr><td>给我讲下 Redis</td><td>泛泛而谈，只讲基础定义，无实际应用价值</td></tr><tr><td>用 Java 后端工程师视角，结合高并发场景讲 Redis 的缓存策略、穿透解决方案</td><td>聚焦后端核心需求，从原理到实践，附带代码示例和避坑指南</td></tr><tr><td>这就是为什么“Prompt Engineering（提示词工程）”会成为热门技能——说白了，它就是 <strong>“把需求说清楚、说精准”的工程化能力</strong>。将复杂指令做成可复用的 Prompt 模板确实能提高效率，但这是应用价值，而非 Prompts 的核心定义。([mcp-sdk.com][4])</td><td/></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、Skills（技能包）：封装好的专业解决步骤</h2>
<p>如果说 Prompt 是“单次的指挥指令”，那 <strong>Skills 就是模型可复用的“专业能力包”</strong>——是一组封装好的专业知识、操作指导和执行逻辑，包含指令、方法、脚本、资源等，能在多个对话或项目中重复使用，当模型判断需求匹配时会自动加载并调用。需要特别纠正的是，Skills 不是“给 AI 装工具”（接入工具是 MCP 的作用），更像是“专业手册 + 操作说明 + 业务流程模板”。</p>
<hr/>
<h3 data-id="heading-5">1️⃣ 什么是 Skill？</h3>
<p>AI 领域的 Skill 定义精准且明确：<strong>Skill = 可复用、动态加载的专业能力包</strong>，核心是通过结构化的流程和知识，增强模型执行复杂任务的能力。</p>
<p>比如这些都是典型的 AI Skill：</p>
<ul>
<li>代码编写（Java/Python/前端等多语言）</li>
<li>文档翻译与跨语言对齐</li>
<li>长文本总结与关键信息提取</li>
<li>UI 原型图/架构图绘制</li>
<li>第三方 API 调用与数据交互</li>
<li>数据库查询与数据分析</li>
<li>自动化测试用例生成</li>
</ul>
<p>通俗理解：<strong>Skill 就像是 AI 的“专业工具箱里的标准化工具套装”</strong>。举个例子，若你常做竞品分析，可创建一个“竞品分析 Skill”，里面包含检索数据的步骤、分析框架、输出格式和相关方法；当你下达竞品分析需求时，模型会自动识别并加载这个 Skill 辅助完成任务。</p>
<p>一句话总结：Prompts 是单次指令，Skills 是封装好的、结构化的专业解决步骤。</p>
<hr/>
<h3 data-id="heading-6">2️⃣ 为什么现在大家都在强调 Skills？</h3>
<p>核心原因：AI 早已不是“一问一答的聊天机器人”了。</p>
<p>以前用 AI：<strong>你问一句，它答一句</strong>，主动权完全在你手里，需要你一步步引导；</p>
<p>现在用 AI：<strong>你抛一个目标，它自己拆步骤、选技能、落地执行</strong></p>
<p>这时候你关心的核心问题，已经从“它聪不聪明”变成了**“它能不能精准匹配我的需求，把这件事干成”**——而 Skills 就是判断 AI 能力边界的核心标准。</p>
<hr/>
<h2 data-id="heading-7">三、Projects（项目/工作区）：持久的上下文空间</h2>
<p>这是 AI 提升任务连贯性的关键设计——从“碎片化对话记忆”升级到“集中化上下文管理”，核心是提供一个持久的独立工作区，而非“解决记忆缺失”。</p>
<hr/>
<h3 data-id="heading-8">1️⃣ 什么是 AI Projects？</h3>
<p>定义精准且明确：<strong>Project = 带有大上下文窗口的独立工作区</strong>，用于集中存放一个任务所需的背景资料、知识库、规则和文件等，让模型在这个项目范围内持续利用这些内容，无需重复上传或解释背景。</p>
<p>比如这些场景，都属于 AI Projects：</p>
<ul>
<li>从 0 到 1 开发一个个人博客系统（含需求分析、架构设计、代码编写、部署文档）</li>
<li>设计一套高并发秒杀方案（含流量预估、防超卖策略、压测方案）</li>
<li>开发一个自动生成周报的工具（对接企业 IM 数据、提取工作内容、格式化输出）</li>
<li>搭建一套 AI 客服系统（对接业务知识库、设计对话流程、自动回复与转接）</li>
</ul>
<p>这里的关键区别：不再是“问一句答一句”的碎片化互动，更核心的是 <strong>“一个项目中的背景资料始终可用，实现上下文的持久化管理”</strong> 。</p>
<p>有无 Projects 的核心差异如下：</p>

















<table><thead><tr><th>无 Projects</th><th>有 Projects</th></tr></thead><tbody><tr><td>模型只能记住当前对话里的内容</td><td>一个项目中的背景资料始终可用</td></tr><tr><td>重复上传/解释任务背景</td><td>项目内部持久保存背景知识</td></tr></tbody></table>
<p>所以，Projects 不仅仅是“解决记忆缺失”，而是提供一个空间让上下文长期有效。</p>
<hr/>
<h3 data-id="heading-9">2️⃣ 为什么 Projects 越来越重要？</h3>
<p>因为真实世界的工作，从来不是“一句话能解决的”。</p>
<p>一个完整的真实任务，必然包含这几个环节：</p>
<ol>
<li>精准理解需求（甚至挖掘潜在需求）</li>
<li>拆解任务步骤（把大目标拆成可执行的小任务）</li>
<li>选择工具/技能（匹配每个步骤需要的能力）</li>
<li>落地执行（编写代码、整理文档、调试问题）</li>
<li>迭代修正（根据反馈优化结果）</li>
<li>交付最终成果（可直接使用的产品/方案/文档）</li>
</ol>
<p>而 <strong>Projects 就是把 AI 的工作场景“固定化、集中化”的核心载体</strong>，让复杂任务的推进更连贯、高效。</p>
<p>一句话总结：<strong>Projects = AI 处理复杂任务的“专属工作室”，核心价值是提供持久的上下文空间</strong>。</p>
<hr/>
<h2 data-id="heading-10">四、MCP：让 AI 真正“接入现实世界”的关键</h2>
<p>终于到了最容易让人劝退的词——MCP。别慌，它不是什么高深的技术壁垒，核心作用就一个：让 AI 安全地“动手干活”。</p>
<hr/>
<h3 data-id="heading-11">1️⃣ MCP 到底是什么？</h3>
<p>先看全称：MCP（Model Context Protocol），模型上下文协议。</p>
<p>一句话讲懂：<strong>MCP = 让 AI 安全、规范地接入外部数据源和工具的开放标准协议/连接层</strong>。它通过标准化接口实现 AI 与外部资源的对接，无需为每个资源编写定制代码，从根本上解决了“大语言模型无法天然访问外部数据和工具”的问题。</p>
<p>这里的“外部世界”，就是我们真实工作中会用到的各类系统：</p>
<ul>
<li>企业内部数据库（客户数据、订单数据）</li>
<li>文件系统（本地文档、云存储文件）</li>
<li>公司业务系统（CRM、ERP、OA）</li>
<li>第三方 API（支付接口、地图接口、短信接口）</li>
<li>各类办公工具（Excel、PPT、Jira）</li>
</ul>
<hr/>
<h3 data-id="heading-12">2️⃣ 没有 MCP，AI 就是“纸上谈兵”</h3>
<p>没有 MCP 的约束和支持，AI 再聪明，也像“被关在玻璃房里的专家”——能出方案，但没法落地执行。</p>
<p>具体来说，它做不了这些事：</p>
<ul>
<li>查询你公司的内部业务数据（比如“统计上月华东地区的销售数据”）</li>
<li>直接调用你的业务接口（比如“自动创建一个客户跟进工单”）</li>
<li>修改你本地/云存储的文件（比如“更新这份项目计划书的进度表”）</li>
</ul>
<p>而有了 MCP 之后，AI 才能 <strong>合法、受控、可审计地接入真实世界的资源并动手干活</strong>——这也是企业级 AI 应用的核心前提，这才是“接入工具/数据”的核心逻辑。</p>
<hr/>
<h3 data-id="heading-13">3️⃣ MCP 解决的核心问题：可控性</h3>
<p>企业用 AI，最担心的不是“AI 不够聪明”，而是“AI 乱干活”。MCP 的核心价值，就是解决“可控性”问题。</p>
<p>具体来说，它能保证：</p>
<ul>
<li>不乱调用接口（只允许调用授权范围内的接口）</li>
<li>不乱读数据（只能访问指定权限的数据，保护隐私）</li>
<li>不越权操作（严格遵循角色权限，比如普通员工不能修改管理员数据）</li>
<li>操作可追溯（每一步调用都有日志，出问题能排查）</li>
</ul>
<p>所以 MCP 的本质，不是让 AI“更聪明”，而是让 AI <strong>具备连接真实世界的能力，成为能落地的</strong> <strong>企业级</strong> <strong>工具</strong> <strong>——可靠、可控、可</strong> <strong>对接外部资源</strong>。</p>
<hr/>
<h2 data-id="heading-14">五、串起来看：一条完整的 AI 工作链路</h2>
<p>单独看每个概念可能有点散，把它们串起来，就能理解 AI 工作的完整逻辑了：</p>
<ol>
<li><strong>Prompt（指令）</strong>：你用自然语言精准告诉 AI“要做什么、要什么结果”——这是启动信号，核心是让模型听懂需求；</li>
<li><strong>Skills（技能包）</strong>：AI 根据指令，从“专业能力库”里挑选封装好的流程和知识（比如竞品分析框架、代码编写规范）；</li>
<li><strong>Projects（工作区）</strong>：AI 在专属的持久化空间里推进任务，背景资料、中间成果全程可用，无需重复沟通；</li>
<li><strong>MCP（协议）</strong>：AI 通过标准化接口，安全接入企业数据库、云盘等外部资源，落地执行真实业务操作（比如查询销售数据、调用业务接口）。</li>
</ol>
<p>一句话终极总结：</p>
<blockquote>
<p>Prompt 是“让模型听懂的指令”，Skills 是“模型做事的专业流程”，Projects 是“模型工作的专属空间”，MCP 是“模型连接真实世界的桥梁”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">六、核心概念对照与新手落地建议</h2>
<p>先通过一张表格清晰对照四个概念的核心信息，帮你建立精准认知：</p>



































<table><thead><tr><th>术语</th><th>作用层级</th><th>核心定义</th><th>解决的核心问题</th></tr></thead><tbody><tr><td>Prompts</td><td>输入指令</td><td>用户输入的自然语言指令或模板，引导模型生成期望输出</td><td>让模型“听懂你说什么”</td></tr><tr><td>Skills</td><td>专业能力包</td><td>可复用、动态加载的专业知识+操作逻辑组合</td><td>让模型“知道怎么做”</td></tr><tr><td>Projects</td><td>上下文空间</td><td>持久化的独立工作区，存放任务背景资料与资源</td><td>让模型“持续记住背景”</td></tr><tr><td>MCP</td><td>外部连接层</td><td>标准化协议/连接层，让 AI 安全接入外部资源</td><td>让模型“能接入真实世界资源”</td></tr></tbody></table>
<p>如果看完还是有点懵，完全正常——不用急于掌握所有概念，按“从易到难、从用起来到深下去”的顺序来：</p>
<ol>
<li>
<p><strong>先练 Prompt：把“指挥权”抓在手里</strong>
核心目标：能清晰、精准地描述需求。这一步比学任何新框架都重要，是用好 AI 的基础。建议从“明确角色（比如‘你是 Java 开发’）+ 明确任务（比如‘写登录接口’）+ 明确要求（比如‘含参数校验’）”的格式练起，后续可将高频需求整理为可复用模板。</p>
</li>
<li>
<p><strong>再理解 Skills：梳理“可用的专业能力”</strong>
核心目标：结合自己的工作场景，梳理 AI 哪些封装好的 Skills 能帮到你。比如后端开发可关注“代码调试 Skill、架构设计 Skill”，运营可关注“文案优化 Skill、数据分析 Skill”，也可根据高频任务自定义 Skills。</p>
</li>
<li>
<p><strong>用 Projects 思维提效：搭建“专属工作区”</strong>
核心目标：处理复杂任务时，用 Projects 集中管理背景资料。比如做项目方案时，将需求文档、参考案例、团队规则都放入同一个 Project，避免重复上传和解释，提升任务连贯性。</p>
</li>
<li>
<p><strong>MCP 先了解，不用急着深钻</strong>
核心目标：知道 MCP 是“AI 接入外部系统的标准化协议”即可。只有当你需要“让 AI 操作公司数据库、调用业务接口”等企业级落地需求时，再去深入了解 MCP 的具体实现和规范。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">最后：记住一个核心判断标准</h2>
<p>AI 领域的新词会越来越多，今天的“黑话”可能明天就变成“基础概念”，但无论出现多少新词，判断它们有没有价值的标准只有一个：</p>
<blockquote>
<p><strong>它能不能帮你把事干成、把效率提上去？</strong></p>
</blockquote>
<p>不用为了“懂黑话”而懂黑话，能精准理解概念、用好这些工具让 AI 成为你的“得力助手”，才是最终目的。</p>
<h2 data-id="heading-17">参考资料：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.53ai.com%2Fnews%2FLargeLanguageModel%2F2025111408153.html" target="_blank" title="https://www.53ai.com/news/LargeLanguageModel/2025111408153.html" ref="nofollow noopener noreferrer">www.53ai.com/news/LargeL…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claude.com%2Fblog%2Fskills-explained" target="_blank" title="https://www.claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">www.claude.com/blog/skills…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mcp-sdk.com%2Fguide%2Fconcepts%2Fprompts.html" target="_blank" title="https://www.mcp-sdk.com/guide/concepts/prompts.html" ref="nofollow noopener noreferrer">www.mcp-sdk.com/guide/conce…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何发布自定义 Spring Boot Starter]]></title>    <link>https://juejin.cn/post/7594403873178042409</link>    <guid>https://juejin.cn/post/7594403873178042409</guid>    <pubDate>2026-01-13T07:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594403873178042409" data-draft-id="7594627998839013418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何发布自定义 Spring Boot Starter"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-13T07:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袁慎建"/> <meta itemprop="url" content="https://juejin.cn/user/1310273592900317"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何发布自定义 Spring Boot Starter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273592900317/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袁慎建
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:08:08.000Z" title="Tue Jan 13 2026 07:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>最近在工作中遇到了 API 限流的需求，市面上虽然有一些现成的解决方案，但总觉得不够灵活，要么功能太重，要么配置复杂。于是萌生了一个想法：为什么不自己开发一个轻量级的限流器Starter呢？既能满足自己的需求，又能学习Spring Boot Starter的开发和发布流程。</p>
<p>这篇文章就来分享一下我是如何从零开始开发一个自定义限流器Spring Boot Starter，并最终成功发布到Maven Central的经历。希望能给有类似需求的同学一些参考。</p>
<h2 data-id="heading-1">为什么需要自定义Spring Boot Starter？</h2>
<p>在开始之前，我们先来聊聊Spring Boot Starter到底是什么，以及为什么要使用它。</p>
<p>简单来说，Spring Boot Starter是一种特殊的依赖项，它封装了一组相关的依赖和配置，让我们能够快速集成某个功能模块。比如我们常用的 <code>spring-boot-starter-web</code>、<code>spring-boot-starter-data-jpa</code>等，它们内部已经帮我们整合了多个相关的依赖，并提供了合理的默认配置。</p>
<p>那么，Spring Boot Starter相比传统的JAR包有什么优势呢？</p>
<ol>
<li><strong>自动配置</strong>：Starter可以根据类路径下的依赖自动配置相应的组件，大大减少了手动配置的工作量。</li>
<li><strong>依赖聚合</strong>：一个Starter可以聚合多个相关的依赖，避免了手动管理复杂的依赖关系。</li>
<li><strong>约定优于配置</strong>：提供了合理的默认配置，开箱即用。</li>
<li><strong>条件化配置</strong>：通过 <code>@ConditionalOnProperty</code>、<code>@ConditionalOnClass</code>等注解，可以根据条件决定是否加载某些配置。</li>
</ol>
<p>举个例子，如果我们直接使用Redis进行限流，需要引入 <code>spring-boot-starter-data-redis</code>，然后手动配置RedisTemplate，再编写限流逻辑。而有了限流器Starter后，只需要引入一个依赖，配置几个参数，就可以通过注解的方式实现限流，整个过程变得非常简单。</p>
<p>它背后也是 “行为和数据分离” 的软件设计理念的实际运用。</p>
<h2 data-id="heading-2">我的限流器 Starter 设计思路</h2>
<h3 data-id="heading-3">功能需求</h3>
<p>我的限流器Starter需要支持以下功能：</p>
<ol>
<li><strong>多种限流算法</strong>：令牌桶、漏桶、固定窗口、滑动窗口计数器和滑动窗口日志五种算法</li>
<li><strong>注解驱动</strong>：通过简单的注解就能实现接口限流</li>
<li><strong>Redis存储</strong>：支持分布式环境下的限流一致性</li>
<li><strong>灵活配置</strong>：支持全局配置和局部配置</li>
<li><strong>AOP无侵入</strong>：基于Spring AOP实现，对业务代码无侵入</li>
</ol>
<h3 data-id="heading-4">核心架构</h3>
<p>整个Starter的核心架构如下：</p>
<pre><code class="hljs language-plain" lang="plain">┌─────────────────────────────────────┐
│        RateLimiterAutoConfiguration │
│        ──────────────────────────────│
│        • 配置各种限流算法的Bean      │
│        • 条件化加载                  │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              限流注解               │
│        ──────────────────────────────│
│        • @FixedWindowRateLimiter    │
│        • @TokenBucketRateLimiter    │
│        • @LeakyBucketRateLimiter    │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              限流切面               │
│        ──────────────────────────────│
│        • 基于AOP拦截方法调用        │
│        • 实现具体的限流逻辑         │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│              存储层                 │
│        ──────────────────────────────│
│        • Redis存储                  │
│        • Lua脚本保证原子性          │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">关键代码实现</h3>
<h4 data-id="heading-6">1. 自动配置类</h4>
<p>首先，我们需要一个自动配置类，它会在Spring容器启动时自动配置我们的限流器组件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "rate-limiter", name = "enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-meta">@EnableConfigurationProperties(RateLimiterProperties.class)</span>
<span class="hljs-meta">@ComponentScan(basePackages = "cn.springboot.starter.ratelimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiterAutoConfiguration</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> FixedWindowCounterScriptFactory <span class="hljs-title function_">fixedWindowCounterScriptFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedWindowCounterScriptFactory</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EnhancedTokenBucketScriptFactory <span class="hljs-title function_">tokenBucketScriptFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedTokenBucketScriptFactory</span>();
    }

    <span class="hljs-comment">// ... 其他算法的ScriptFactory</span>
}
</code></pre>
<p>这里有一个关键点需要注意：<code>@ComponentScan(basePackages = "cn.springboot.starter.ratelimiter")</code>注解的作用是让Spring能够扫描到我们Starter中定义的所有组件（包括切面、异常处理器等），这样它们才能被自动注册到Spring容器中。如果没有这个注解，消费端的Spring Boot应用在引入我们的Starter后将无法自动发现和加载这些组件。</p>
<p>这里有几个关键点：</p>
<ul>
<li><code>@ConditionalOnProperty</code>：只有在配置了 <code>rate-limiter.enabled=true</code>时才加载配置</li>
<li><code>@EnableConfigurationProperties</code>：启用配置属性绑定</li>
<li><code>@ComponentScan</code>：扫描限流器相关的组件</li>
<li><code>@ConditionalOnBean(StringRedisTemplate.class)</code>：只有当RedisTemplate存在时才创建Redis相关的组件</li>
</ul>
<h4 data-id="heading-7">2. 配置属性类</h4>
<p>为了让用户能够灵活配置限流参数，我们需要定义配置属性类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "rate-limiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiterProperties</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">enabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">defaultLimit</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">defaultWindowSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">defaultMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"请求过于频繁，请稍后再试"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxKeyLength</span> <span class="hljs-operator">=</span> <span class="hljs-number">255</span>;
}
</code></pre>
<p>这样用户就可以在 <code>application.yml</code>中配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rate-limiter:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">default-limit:</span> <span class="hljs-number">20</span>
  <span class="hljs-attr">default-window-size:</span> <span class="hljs-number">120</span>
  <span class="hljs-attr">default-message:</span> <span class="hljs-string">"访问频率过高，请稍后再试"</span>
</code></pre>
<h4 data-id="heading-8">3. 限流注解</h4>
<p>为了方便使用，我定义了多个限流注解，每种算法对应一个：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> FixedWindowRateLimiter {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
    <span class="hljs-type">long</span> <span class="hljs-title function_">limit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">10</span>;
    <span class="hljs-type">long</span> <span class="hljs-title function_">windowSize</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">60</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">permits</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"请求过于频繁，请稍后再试"</span>;
}
</code></pre>
<h4 data-id="heading-9">4. AOP切面</h4>
<p>这是实现限流逻辑的核心部分，通过AOP拦截带有限流注解的方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@ConditionalOnProperty(name = "rate-limiter.enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FixedWindowRateLimiterAspect</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRateLimiterAspect</span> {
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisScript&lt;Long&gt; fixedWindowScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FixedWindowRateLimiterAspect</span><span class="hljs-params">(<span class="hljs-meta">@Autowired(required = false)</span> StringRedisTemplate redisTemplate,
                                        RateLimiterProperties properties,
                                        <span class="hljs-meta">@Autowired(required = false)</span> FixedWindowCounterScriptFactory scriptFactory)</span> {
        <span class="hljs-built_in">super</span>(redisTemplate, properties, <span class="hljs-literal">null</span>);
        <span class="hljs-built_in">this</span>.fixedWindowScript = scriptFactory != <span class="hljs-literal">null</span> ? scriptFactory.createRateLimitScript() : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Around("@annotation(rateLimiter)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint point, FixedWindowRateLimiter rateLimiter)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> getMethod(point);
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> generateKey(method, point.getArgs(), rateLimiter.key());

        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> checkFixedWindowRateLimit(key, rateLimiter);
        <span class="hljs-type">long</span> <span class="hljs-variable">executionTime</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;

        <span class="hljs-keyword">if</span> (!allowed) {
            log.warn(<span class="hljs-string">"固定窗口限流超出配额，键值: {}"</span>, key);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimitException</span>(rateLimiter.message());
        }

        <span class="hljs-keyword">return</span> point.proceed();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkFixedWindowRateLimit</span><span class="hljs-params">(String key, FixedWindowRateLimiter rateLimiter)</span> {
        <span class="hljs-keyword">if</span> (!checkRedisAndScriptAvailability(key, fixedWindowScript)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-type">RedisRateLimitStorage</span> <span class="hljs-variable">fixedWindowRedisStorage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimitStorage</span>(redisTemplate, fixedWindowScript);
        <span class="hljs-keyword">return</span> fixedWindowRedisStorage.isAllowed(key, rateLimiter.limit(), rateLimiter.windowSize(), rateLimiter.<span class="hljs-keyword">permits</span>());
    }
}
</code></pre>
<h4 data-id="heading-10">5. Redis 存储与 Lua 脚本</h4>
<p>为了保证限流操作的原子性，我使用了Redis的Lua脚本来实现各种限流算法。以令牌桶算法为例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTokenBucketScript</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"""
        -- 令牌桶限流脚本
        -- KEYS[1] = 限流器的键
        -- ARGV[1] = 桶容量（最大令牌数）
        -- ARGV[2] = 填充速率（每秒令牌数）
        -- ARGV[3] = 需要获取的许可数

        local key = KEYS[1]
        local capacity = tonumber(ARGV[1])
        local refill_rate = tonumber(ARGV[2])  -- 每秒令牌数
        local permits = tonumber(ARGV[3])

        -- 从Redis获取当前桶状态（令牌数，上次填充时间）
        local bucket_state = redis.call('HMGET', key, 'tokens', 'last_refill_time')

        local current_tokens, last_refill_time

        if bucket_state[1] and bucket_state[2] then
            current_tokens = tonumber(bucket_state[1])
            last_refill_time = tonumber(bucket_state[2])
        else
            -- 如果桶不存在则初始化
            current_tokens = capacity
            last_refill_time = tonumber(redis.call('TIME')[1])
            redis.call('HMSET', key, 'tokens', current_tokens, 'last_refill_time', last_refill_time)
        end

        -- 获取当前时间
        local current_time = tonumber(redis.call('TIME')[1])

        -- 根据经过的时间计算要添加的令牌数
        local time_elapsed = current_time - last_refill_time
        local tokens_to_add = math.floor(time_elapsed * refill_rate)

        -- 更新令牌数，但不超过容量
        local new_tokens = math.min(capacity, current_tokens + tokens_to_add)

        -- 检查是否有足够的令牌用于请求
        if new_tokens &gt;= permits then
            -- 扣除令牌并更新上次填充时间
            redis.call('HMSET', key, 'tokens', new_tokens - permits, 'last_refill_time', current_time)
            return 1  -- 请求允许
        else
            -- 即使请求被拒绝也要更新上次填充时间（防止滥用）
            redis.call('HMSET', key, 'tokens', new_tokens, 'last_refill_time', current_time)
            return 0  -- 请求拒绝
        end
        """</span>;
}
</code></pre>
<h2 data-id="heading-11">实现限流器 Spring Boot Starter</h2>
<h3 data-id="heading-12">1. 项目结构</h3>
<p>Spring Boot Starter的项目结构如下：</p>
<pre><code class="hljs language-plain" lang="plain">src/
├── main/
│   ├── java/
│   │   └── cn/springboot/starter/ratelimiter/
│   │       ├── config/           # 配置相关类
│   │       ├── core/             # 核心功能类
│   │       │   ├── exception/    # 异常处理
│   │       │   ├── metrics/      # 指标监控（预留目录，目前为空）
│   │       │   └── storage/      # 存储相关（含Redis和Lua脚本）
│   │       │       └── script/   # Lua脚本实现
│   │       └── demo/             # 示例代码
│   └── resources/
│       └── META-INF/
│           └── additional-spring-configuration-metadata.json  # 配置元数据（手动补充的描述信息）
└── target/classes/META-INF/  # 编译后生成
    ├── spring-configuration-metadata.json  # 自动生成的配置元数据
    └── additional-spring-configuration-metadata.json  # 手动补充的配置元数据
└── test/
</code></pre>
<p>其中，core包是整个限流器的核心，包含了：</p>
<ul>
<li><strong>exception</strong>：限流相关的异常定义</li>
<li><strong>metrics</strong>：性能指标收集（预留目录，目前为空）</li>
<li><strong>storage</strong>：存储层实现，包含Redis存储和Lua脚本</li>
<li><strong>storage/script</strong>：各种限流算法的Lua脚本实现</li>
<li>*<strong>Aspect</strong>：各个限流算法对应的AOP切面（如FixedWindowRateLimiterAspect等，位于core根目录）</li>
<li>*<strong>RateLimiter</strong>：各个限流算法对应的注解（如FixedWindowRateLimiter等，位于core根目录）</li>
</ul>
<h3 data-id="heading-13">2. 关键配置文件</h3>
<h4 data-id="heading-14">配置元数据文件</h4>
<p>Spring Boot提供了配置元数据功能，可以让IDE提供配置提示。配置元数据文件的工作机制如下：</p>
<ol>
<li><strong>自动元数据生成</strong>：<code>spring-boot-configuration-processor</code>在编译时自动扫描 <code>@ConfigurationProperties</code>注解的类，生成 <code>spring-configuration-metadata.json</code>文件，包含基本的配置属性信息，会自动将属性的注释信息作为元数据的 description。</li>
<li><strong>手动补充元数据</strong>：在 <code>src/main/resources/META-INF/additional-spring-configuration-metadata.json</code>中可以手动编写补充文件，添加更详细的描述信息，或补充处理器无法自动生成的配置属性，这个是可选的。</li>
<li><strong>元数据合并</strong>：编译时，手动编写的 <code>additional-spring-configuration-metadata.json</code>文件会与自动生成的元数据合并，最终形成完整的配置元数据。</li>
</ol>
<p><code>additional-spring-configuration-metadata.json</code>元数据文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"groups"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn.springboot.starter.ratelimiter.config.RateLimiterProperties"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sourceType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn.springboot.starter.ratelimiter.config.RateLimiterProperties"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter.enabled"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java.lang.Boolean"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"是否启用限流"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defaultValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rate-limiter.default-limit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java.lang.Long"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"默认限制次数"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defaultValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-15">注册自动配置类</h4>
<p>Spring Boot 3.x，在 <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件写入：</p>
<pre><code class="hljs language-plain" lang="plain">cn.springboot.starter.ratelimiter.config.RateLimiterAutoConfiguration
</code></pre>
<p>Spring Boot 2.7及以前版本，在 <code>META-INF/spring.factories</code>文件中注册自动配置类：</p>
<pre><code class="hljs language-properties" lang="properties">org.springframework.boot.autoconfigure.AutoConfiguration.imports=\
cn.springboot.starter.ratelimiter.config.RateLimiterAutoConfiguration
</code></pre>
<h3 data-id="heading-16">3. 依赖管理</h3>
<p>在 <code>pom.xml</code>中，我们需要合理管理依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

</code></pre>
<p>注意将 <code>spring-boot-configuration-processor</code>设置为 <code>optional=true</code>，这样它不会传递给使用Starter的项目。</p>
<h2 data-id="heading-17">发布到 Maven Central</h2>
<p>发布到Maven Central是一个相对复杂的过程，需要遵循严格的规范。以下是我在实践中总结的完整流程：</p>
<h3 data-id="heading-18">1. 准备工作</h3>
<h4 data-id="heading-19">注册Sonatype账号</h4>
<p>首先需要在<a href="https://link.juejin.cn?target=https%3A%2F%2Fcentral.sonatype.com%2F" target="_blank" title="https://central.sonatype.com/" ref="nofollow noopener noreferrer">Sonatype Central Portal</a>注册账号，这是发布到Maven Central的入口。</p>
<h4 data-id="heading-20">申请Namespace权限</h4>
<p>登录后需要申请命名空间权限。我申请的是 <code>io.github.yuanshenjian-cn</code>，这通常对应你的GitHub用户名或组织名。申请时需要提供项目URL和SCM URL。</p>
<p><strong>重要提醒</strong>：这里的命名空间名称需要与你在项目pom.xml中配置的groupId保持一致，因为Sonatype会验证你是否有权在这个命名空间下发布构件。</p>
<h3 data-id="heading-21">2. GPG签名设置</h3>
<p>发布到 Maven Central 必须使用 GPG签名来保证构件的完整性和真实性。</p>
<h4 data-id="heading-22">安装GPG</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS</span>
brew install gpg

<span class="hljs-comment"># Ubuntu/Debian</span>
sudo apt-get install gnupg
</code></pre>
<h4 data-id="heading-23">生成GPG密钥对</h4>
<pre><code class="hljs language-bash" lang="bash">gpg --gen-key
</code></pre>
<p>按照提示填写信息，建议设置一个强密码。</p>
<h4 data-id="heading-24">上传公钥到密钥服务器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐使用 keys.openpgp.org</span>
gpg --keyserver keys.openpgp.org --send-keys YOUR_KEY_ID

<span class="hljs-comment"># 备用服务器</span>
gpg --keyserver keyserver.ubuntu.com --send-keys YOUR_KEY_ID
gpg --keyserver pgp.mit.edu --send-keys YOUR_KEY_ID
</code></pre>
<h3 data-id="heading-25">3. Maven配置</h3>
<p>在 <code>~/.m2/settings.xml</code>中配置Sonatype认证信息：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>YOUR_SONATYPE_USERNAME<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>YOUR_SONATYPE_PASSWORD<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>注意：Sonatype现在使用User Token进行认证，需要在Central Portal中生成用户令牌。</p>
<h3 data-id="heading-26">4. 项目POM配置</h3>
<p>在项目的 <code>pom.xml</code>中添加必要的插件和配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 编译插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 源码插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-source-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-sources<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar-no-fork<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- JavaDoc插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-javadocs<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- GPG签名插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>sign-artifacts<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>verify<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>sign<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Central Publishing插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.sonatype.central<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>central-publishing-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">publishingServerId</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">publishingServerId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 发布管理 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">distributionManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">snapshotRepository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/content/repositories/snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">snapshotRepository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/service/local/staging/deploy/maven2/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">distributionManagement</span>&gt;</span>

</code></pre>
<h3 data-id="heading-27">5. 发布流程</h3>
<h4 data-id="heading-28">验证构建</h4>
<pre><code class="hljs language-bash" lang="bash">./mvnw clean verify
</code></pre>
<p>确保所有测试通过，且生成了必需的构件（JAR、Sources、Javadoc）。</p>
<h4 data-id="heading-29">执行发布</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> GPG_TTY=$(<span class="hljs-built_in">tty</span>)
./mvnw clean deploy -DskipTests
</code></pre>
<p>注意设置 <code>GPG_TTY</code>环境变量，这可以解决在某些终端环境下GPG无法获取密码的问题。</p>
<h3 data-id="heading-30">6. 在Central Portal中确认发布</h3>
<p>发布完成后，登录Sonatype Central Portal，在"Upload" -&gt; "Components"页面找到刚上传的组件，点击"Publish"按钮完成发布。</p>
<h2 data-id="heading-31">发布过程中的踩坑经验</h2>
<h3 data-id="heading-32">1. GPG签名问题</h3>
<p>最常见的问题是GPG签名失败。我遇到过以下几种情况：</p>
<ul>
<li><strong>"gpg: signing failed: Inappropriate ioctl for device"</strong>：这是最常见的一种错误，解决方案是设置 <code>GPG_TTY=$(tty)</code></li>
<li><strong>"Invalid signature"</strong>：通常是因为公钥没有正确上传到PGP服务器，需要等待服务器同步</li>
<li><strong>GPG agent问题</strong>：有时GPG agent没有正确运行，需要重启</li>
</ul>
<h3 data-id="heading-33">2. 构件验证失败</h3>
<p>Maven Central对发布的构件有严格的要求：</p>
<ul>
<li>必须包含sources和javadoc</li>
<li>所有构件都必须签名</li>
<li>POM文件必须包含完整的元数据（许可证、开发者信息、SCM信息等）</li>
<li>JavaDoc不能有警告</li>
</ul>
<h3 data-id="heading-34">3. 版本管理</h3>
<ul>
<li>一旦发布到 Maven Central，无法删除或修改已发布的版本</li>
<li>确保版本号唯一且有意义</li>
<li>发布正式版本时，不要使用 <code>-SNAPSHOT</code>后缀</li>
</ul>
<h2 data-id="heading-35">消费端如何使用</h2>
<p>发布成功后，用户就可以通过简单的依赖引入来使用我们的限流器：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.yuanshenjian-cn<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api-rate-limiter-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>然后在代码中使用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {

    <span class="hljs-comment">// 使用令牌桶算法</span>
    <span class="hljs-meta">@TokenBucketRateLimiter(
        key = "'api:user:' + #id",         // 限流键，支持 SpEL 表达式
        capacity = 5,                      // 桶容量
        refillRate = 1,                    // 每秒填充1个令牌
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@GetMapping("/api/user/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User: "</span> + id;
    }

    <span class="hljs-comment">// 使用固定窗口算法</span>
    <span class="hljs-meta">@FixedWindowRateLimiter(
        key = "'api:order:' + #orderId",   // 限流键
        limit = 10,                        // 限制次数
        windowSize = 60,                   // 时间窗口（秒）
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@PostMapping("/api/order/{orderId}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Order created: "</span> + orderId;
    }

    <span class="hljs-comment">// 使用漏桶算法</span>
    <span class="hljs-meta">@LeakyBucketRateLimiter(
        key = "'api:upload:' + #userId",   // 限流键
        capacity = 5,                      // 桶容量
        leakRate = 2,                      // 每秒处理2个请求
        message = "访问频率过高，请稍后再试"
    )</span>
    <span class="hljs-meta">@PostMapping("/api/upload")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"File uploaded successfully"</span>;
    }
}
</code></pre>
<h2 data-id="heading-36">总结</h2>
<p>这次跟 Qwen Pair 开发并发布一个 Spring Boot Starter 是一个很好的学习过程，让我深入了解了 Spring Boot 的自动配置机制、AOP编程、Redis应用以及Maven发布流程。</p>
<p>这个项目从构思到发布，经历了需求分析、架构设计、编码实现、测试验证、发布上线等多个阶段。每一个环节都有值得学习的地方，特别是发布到Maven Central的过程，让我对开源软件的发布标准有了更深的认识。</p>
<p>希望这篇分享对你有所帮助，如果有什么问题，欢迎在评论区交流讨论。</p>
<p>本文涉及的完整项目源码可以在GitHub上找到：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanshenjian-cn%2Fspring-boot-starter-api-rate-limiter" target="_blank" title="https://github.com/yuanshenjian-cn/spring-boot-starter-api-rate-limiter" ref="nofollow noopener noreferrer">github.com/yuanshenjia…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质]]></title>    <link>https://juejin.cn/post/7594576956420636698</link>    <guid>https://juejin.cn/post/7594576956420636698</guid>    <pubDate>2026-01-13T07:21:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956420636698" data-draft-id="7594616268781355035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-13T07:21:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 Redis 的 Pipeline 不是原子的，而 Lua 脚本却是？——从事件循环讲透原子性本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:21:43.000Z" title="Tue Jan 13 2026 07:21:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>Pipeline 批量发命令，Lua 脚本也能批量操作，但只有 Lua 是原子的。<br/>
为什么？答案藏在 Redis 的单线程心脏里。</strong></p>
</blockquote>
<p>在使用 Redis 时，你可能遇到过这样的困惑：</p>
<ul>
<li>我用 <code>Pipeline</code> 一口气发了 100 个命令，效率很高；</li>
<li>但我听说 <code>Pipeline</code> <strong>不是原子的</strong>，中间可能被其他客户端插队；</li>
<li>而写个 Lua 脚本，哪怕包含 10 条 Redis 命令，却能保证<strong>完全原子执行</strong>。</li>
</ul>
<p>这到底是为什么？难道 Redis 对 Lua 有“特殊照顾”？</p>
<p>今天，我们就从 <strong>Redis 内部执行模型</strong> 出发，彻底讲清楚：<strong>Pipeline 和 Lua 脚本在 Redis 眼中，根本就不是一类东西</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、Pipeline：只是“网络打包”，不是“执行合并”</h2>
<p>很多人误以为 Pipeline 是一种“批量命令”，其实它<strong>根本不是 Redis 的功能</strong>，而是<strong>客户端的优化技巧</strong>。</p>
<h3 data-id="heading-1">客户端视角：</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 普通方式：3 次网络往返</span>
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"1"</span>);
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"b"</span>, <span class="hljs-string">"2"</span>);
redis.<span class="hljs-keyword">set</span>(<span class="hljs-string">"c"</span>, <span class="hljs-string">"3"</span>);

<span class="hljs-comment">// Pipeline：1 次网络往返</span>
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"1"</span>);
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"b"</span>, <span class="hljs-string">"2"</span>);
pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-string">"c"</span>, <span class="hljs-string">"3"</span>);
pipeline.<span class="hljs-keyword">sync</span>();
</code></pre>
<p>看起来很高效，对吧？但关键在于：<strong>Redis 并不知道你在用 Pipeline</strong>。</p>
<h3 data-id="heading-2">Redis 服务端视角：</h3>
<p>当 Redis 收到 TCP 流中的数据：</p>
<pre><code class="hljs language-css" lang="css">SET <span class="hljs-selector-tag">a</span> <span class="hljs-number">1</span>\r\nSET <span class="hljs-selector-tag">b</span> <span class="hljs-number">2</span>\r\nSET c <span class="hljs-number">3</span>\r\n
</code></pre>
<p>它会<strong>逐行解析</strong>，然后依次执行三个独立的 <code>SET</code> 命令。</p>
<p>也就是说，在 Redis 内部，这三个命令和你分开三次发送<strong>没有任何区别</strong>——它们会被<strong>一个一个放进命令队列，再一个一个执行</strong>。</p>
<h3 data-id="heading-3">问题来了：命令之间会发生什么？</h3>
<p>Redis 的主循环大致如下（简化版）：</p>
<pre><code class="hljs language-scss" lang="scss">while (<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 1. 处理网络 I/O（读取所有客户端数据）</span>
    <span class="hljs-built_in">aeProcessEvents</span>();

    <span class="hljs-comment">// 2. 执行命令队列中的命令</span>
    while (hasCommand()) {
        <span class="hljs-built_in">executeCommand</span>(dequeueCommand());
        <span class="hljs-comment">// ← 执行完一条命令后，回到循环顶部！</span>
    }
}
</code></pre>
<p>注意：<strong>每执行完一条命令，Redis 就会回到事件循环顶部</strong>，去处理：</p>
<ul>
<li>其他客户端的新请求；</li>
<li>定时任务（如 key 过期）；</li>
<li>主从同步等。</li>
</ul>
<p>所以，你的 <code>SET a 1</code> 和 <code>SET b 2</code> 之间，完全可能插入别人发来的 <code>DEL x</code>！</p>
<blockquote>
<p>✅ <strong>Pipeline 只省了网络 RTT，没改变命令的执行语义。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、Lua 脚本：Redis 的“独占模式”</h2>
<p>相比之下，Lua 脚本在 Redis 中享有“VIP 待遇”。</p>
<p>当你执行：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">EVAL</span> "<span class="hljs-selector-tag">redis</span><span class="hljs-selector-class">.call</span>(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">1</span>], <span class="hljs-string">'1'</span>); <span class="hljs-selector-tag">redis</span><span class="hljs-selector-class">.call</span>(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-string">'2'</span>)" <span class="hljs-number">2</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span>
</code></pre>
<p>Redis 不会把它拆成两个 <code>SET</code> 命令。而是：</p>
<ol>
<li><strong>整个脚本被视为一个不可分割的单元</strong>；</li>
<li><strong>执行期间，Redis 会暂停处理任何新命令</strong>；</li>
<li>脚本内部的所有 <code>redis.call()</code> 都在当前上下文中直接执行，<strong>不经过命令队列</strong>。</li>
</ol>
<h3 data-id="heading-5">技术实现：<code>lua_caller</code> 标志位</h3>
<p>在 Redis 源码中，有一个关键变量：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">redisServer</span> {
    client *lua_caller;  <span class="hljs-comment">// 当前正在执行 Lua 脚本的客户端</span>
};
</code></pre>
<p>在事件循环的关键位置（如 <code>beforeSleep</code>、<code>processCommand</code>），Redis 会检查：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (server.lua_caller != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-comment">// 正在执行 Lua 脚本，跳过处理新命令！</span>
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>这意味着：<strong>只要 Lua 脚本没跑完，其他客户端的命令一律排队等待</strong>。</p>
<blockquote>
<p>✅ <strong>Lua 脚本 = 占用 Redis 主线程的“临界区”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、一张图看懂本质区别</h2>
<pre><code class="hljs language-css" lang="css">普通命令 / Pipeline 命令：
<span class="hljs-selector-attr">[SET a 1]</span> → 执行 → 回到事件循环 → <span class="hljs-selector-attr">[其他客户端命令]</span> → <span class="hljs-selector-attr">[SET b 2]</span> → 执行

Lua 脚本：
<span class="hljs-selector-attr">[Lua 开始]</span> → 执行 SET <span class="hljs-selector-tag">a</span> <span class="hljs-number">1</span> → 执行 SET <span class="hljs-selector-tag">b</span> <span class="hljs-number">2</span> → <span class="hljs-selector-attr">[Lua 结束]</span> → 其他命令才能进来
</code></pre>
<p>Pipeline 的命令是“散装”的，Lua 脚本是“封装好的原子包”。</p>
<hr/>
<h2 data-id="heading-7">四、常见误区澄清</h2>





















<table><thead><tr><th>误区</th><th>正解</th></tr></thead><tbody><tr><td>“Pipeline 是事务”</td><td>❌ Pipeline 没有任何事务语义，只是网络优化</td></tr><tr><td>“Lua 脚本快是因为本地执行”</td><td>❌ Lua 在 Redis 服务端执行，快是因为原子+无网络开销</td></tr><tr><td>“Cluster 下 Pipeline 也能跨节点原子”</td><td>❌ Cluster 下 Pipeline 必须同 slot，且仍非原子</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">五、如何选择？</h2>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>需要<strong>原子性</strong>（如扣款、限流）</td><td>✅ Lua 脚本</td></tr><tr><td>只需<strong>提升吞吐</strong>（如批量导入）</td><td>✅ Pipeline</td></tr><tr><td>简单批量读写（同 key）</td><td>✅ <code>MGET</code> / <code>MSET</code>（内置原子命令）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>记住：<br/>
要速度 → Pipeline；<br/>
要一致 → Lua。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">结语</h2>
<p>Redis 的简洁之美，正体现在它的<strong>单线程模型</strong>上。<br/>
Pipeline 和 Lua 脚本看似都能“批量操作”，但一个只是<strong>网络层的巧思</strong>，另一个则是<strong>执行层的保障</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[gorm回读机制溯源]]></title>    <link>https://juejin.cn/post/7594396368175349795</link>    <guid>https://juejin.cn/post/7594396368175349795</guid>    <pubDate>2026-01-13T07:53:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396368175349795" data-draft-id="7594396523441242147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="gorm回读机制溯源"/> <meta itemprop="keywords" content="后端,面试,GitHub"/> <meta itemprop="datePublished" content="2026-01-13T07:53:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="37手游后端团队"/> <meta itemprop="url" content="https://juejin.cn/user/1548527766871239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            gorm回读机制溯源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548527766871239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    37手游后端团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:53:30.000Z" title="Tue Jan 13 2026 07:53:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>近期在开发过程中，发现一个奇怪现象：go程序使用gorm进行insert操作，日志却出现了一行insert以及一行select，一度让我怀疑是代码Bug。经过仔细排查，排除了程序主动select逻辑，确认只有insert的操作，因此展开对此现象的分析。</p>
<h2 data-id="heading-1">二、分析过程</h2>
<p>1、现场还原</p>
<p>本次案例中，将日志现场经简化、脱敏如下：</p>
<pre><code class="hljs language-scss" lang="scss">(C:/www/project-name/internal/dao/dao_impls/dao_test/test.go:<span class="hljs-number">23</span>)
<span class="hljs-selector-attr">[2025-12-11 18:30:33]</span>  <span class="hljs-selector-attr">[5.54ms]</span>  INSERT INTO `test` (`gid`,`atime`) VALUES (<span class="hljs-number">1000001</span>,<span class="hljs-number">1765449029</span>)
<span class="hljs-selector-attr">[1 rows affected or returned ]</span>
 
(C:/www/project-name/internal/dao/dao_impls/dao_test/test.go:<span class="hljs-number">23</span>)
<span class="hljs-selector-attr">[2025-12-11 18:30:33]</span>  <span class="hljs-selector-attr">[13.33ms]</span>  SELECT `score` FROM `test`  WHERE (id = <span class="hljs-number">5</span>)
<span class="hljs-selector-attr">[1 rows affected or returned ]</span>


</code></pre>
<p>日志中第二行，SELECT <code>score</code> FROM <code>test</code>  WHERE (id = 5)，便是预期外的select。</p>
<p>将表结构的struct简化后如下：</p>
<pre><code class="hljs language-sql" lang="sql">type Test struct {
    ID int64 `gorm:"column:id;PRIMARY_KEY;AUTO_INCREMENT;TYPE:bigint(20);NOT NULL" json:"id"`,
    Gid <span class="hljs-type">int</span> `gorm:"column:gid;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"gid"`,
    Score int64 `gorm:"column:score;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"score"`,
    Atime <span class="hljs-type">int</span> `gorm:"column:atime;TYPE:int(11);NOT NULL" <span class="hljs-keyword">sql</span>:"DEFAULT:0" json:"atime"`
}

</code></pre>
<p>2、gorm源码定位</p>
<p>阅读gorm源码后定位到，此现象是gorm的回读操作（gorm版本是v1.9.14）。</p>
<p>一个create操作包含以下几个过程：</p>
<p>1） Create 方法入口（触发回调链）</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// github.com/jinzhu/gorm/main.go (1.9.14)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span></span> Create(value <span class="hljs-keyword">interface</span>{}) *DB {
  <span class="hljs-comment">// 初始化 Scope（GORM v1 核心上下文，包含 SQL、模型、字段等信息）</span>
  scope := s.NewScope(value)
  <span class="hljs-comment">// 执行 Create 回调链（核心：before_create → create → after_create）</span>
  scope.CallCallbacks(s.parent.callbacks.creates)
   
  <span class="hljs-comment">// 处理错误、返回结果</span>
  <span class="hljs-keyword">if</span> scope.HasError() {
    s.db.AddError(scope.DB().Error)
  }
  <span class="hljs-keyword">return</span> s.db
}

</code></pre>
<p>2）Create 回调注册</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// github.com/jinzhu/gorm/callback_create.go (1.9.14)</span>
<span class="hljs-comment">// RegisterCallbacks 注册 Create 相关回调（v1 初始化时执行）</span>
func <span class="hljs-built_in">RegisterCallbacks</span>(db *DB) {
  <span class="hljs-comment">// 注册「插入中」回调：执行 INSERT 语句</span>
  db<span class="hljs-selector-class">.Callback</span>()<span class="hljs-selector-class">.Create</span>()<span class="hljs-selector-class">.Register</span>("gorm:create", create)
  <span class="hljs-comment">// 注册「插入后」回调：触发字段回读（核心）</span>
  db<span class="hljs-selector-class">.Callback</span>()<span class="hljs-selector-class">.Create</span>()<span class="hljs-selector-class">.Register</span>("gorm:after_create", afterCreate)
}
 
<span class="hljs-comment">// afterCreate 是 v1 插入后回读字段的核心回调</span>
func <span class="hljs-built_in">afterCreate</span>(scope *Scope) {
  if scope<span class="hljs-selector-class">.HasError</span>() {
    return
  }
 
  <span class="hljs-comment">// 核心：触发「从数据库回读字段值」的逻辑</span>
  if err := scope.<span class="hljs-built_in">RetrieveDBValues</span>(); err != nil {
    scope<span class="hljs-selector-class">.Err</span>(err)
  }
}



</code></pre>
<p>3）回读字段的核心实现（生成 SELECT 语句）</p>
<pre><code class="hljs language-go" lang="go">

<span class="hljs-comment">// github.com/jinzhu/gorm/scope.go (1.9.14)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span></span> RetrieveDBValues() <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 筛选需要回读的字段（自增ID、生成列、默认值字段等）</span>
  fields := scope.Fields()
  <span class="hljs-keyword">var</span> retrieveFields []*Field
  <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> fields {
    <span class="hljs-comment">// 判断字段是否需要回读（自增、有默认值、生成列等）</span>
    <span class="hljs-keyword">if</span> field.NeedToRetrieveValue() {
      retrieveFields = <span class="hljs-built_in">append</span>(retrieveFields, field)
    }
  }
 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(retrieveFields) == <span class="hljs-number">0</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// 无需要回读的字段，直接返回</span>
  }
 
  <span class="hljs-comment">// 2. 拼接需要回读的字段名</span>
  <span class="hljs-keyword">var</span> fieldNames []<span class="hljs-type">string</span>
  <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> retrieveFields {
    fieldNames = <span class="hljs-built_in">append</span>(fieldNames, scope.Quote(field.DBName))
  }
 
  <span class="hljs-comment">// 3. 构建 WHERE 条件（基于主键，如 id = 5）</span>
  primaryField := scope.PrimaryField()
  <span class="hljs-keyword">if</span> primaryField == <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"primary field not found"</span>)
  }
 
  <span class="hljs-comment">// 4. 拼接 SELECT SQL（对应日志中的 SELECT 语句）</span>
  sql := fmt.Sprintf(
    <span class="hljs-string">"SELECT %s FROM %s WHERE %s = %v"</span>,
    strings.Join(fieldNames, <span class="hljs-string">", "</span>),       <span class="hljs-comment">// 回读字段列表</span>
    scope.QuotedTableName(),              <span class="hljs-comment">// 表名</span>
    scope.Quote(primaryField.DBName),     <span class="hljs-comment">// 主键字段 id</span>
    scope.AddToVars(scope.PrimaryKeyValue()), <span class="hljs-comment">// 主键值（如 5）</span>
  )
 
  <span class="hljs-comment">// 5. 执行 SELECT 查询（日志中看到的 SELECT 操作在此执行）</span>
  row := scope.SQLDB().QueryRow(sql, scope.SQLVars()...)
  <span class="hljs-keyword">if</span> row.Err() != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> row.Err()
  }
 
  <span class="hljs-comment">// 6. 将查询结果扫描回模型字段</span>
  dest := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">interface</span>{}, <span class="hljs-built_in">len</span>(retrieveFields))
  <span class="hljs-keyword">for</span> i, field := <span class="hljs-keyword">range</span> retrieveFields {
    dest[i] = field.Field.Interface()
  }
  <span class="hljs-keyword">return</span> row.Scan(dest...)
}


</code></pre>
<p>整个过程简化成一张流程图就是：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2da9d48119f641d9be4dc1af9d7b9769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768895989&amp;x-signature=DHpD2SQHWFZKj%2FMIxNcz%2FTLKx6E%3D" alt="image.png" loading="lazy"/></p>
<p>3、触发回读的条件</p>
<p>在本次案例中，回读产生的原因是字段有数据库默认值（<code>sql:"default:'xxx'"</code>）且插入时未显式赋值。这也是最典型的原因，其实还有另外几种因素也能导致，个人觉得在开发中不太常见，就不枚举了。</p>
<p>4、关闭回读</p>
<p>如果不需要回读，可以通过以下方式关闭：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-comment">// 方式1：全局禁用 after_create 回调（影响所有 Create 操作）</span>
db.Callback().Create().Remove(<span class="hljs-string">"gorm:after_create"</span>)
 
<span class="hljs-comment">// 方式2：单次 Create 跳过回调（仅影响当前操作）</span>
scope := db.NewScope(&amp;rec)
scope.SkipAfterCreate = <span class="hljs-literal">true</span>
db.Create(&amp;rec)
 
<span class="hljs-comment">// 方式3：移除模型中字段的 sql:"DEFAULT:0" 标签（数据库层面的默认值仍生效）</span>
<span class="hljs-keyword">type</span> Test <span class="hljs-keyword">struct</span> {
    Score <span class="hljs-type">int64</span> <span class="hljs-string">`gorm:"column:score;TYPE:int(11);NOT NULL" json:"score"`</span>,
   <span class="hljs-comment">// 其他字段...</span>
}
 
<span class="hljs-comment">// 方式4：使用原生 SQL 插入（绕过 GORM 回调链）</span>
db.Exec(<span class="hljs-string">"INSERT INTO test (...) VALUES (...)"</span>, args...)
 
<span class="hljs-comment">// 方式5：程序代码显式赋值</span>
rec.Score=<span class="hljs-number">0</span>


</code></pre>
<h2 data-id="heading-2">三、回读的影响</h2>
<p>其实一个基于主键的select回读，在大多数时候影响并不大，但是对于高并发的业务场景，任何一个微小的逻辑都可能被放大！</p>
<p>1、最直接影响就是性能损耗，会占用更多数据库连接、消耗IO资源，多一次网络往返。</p>
<p>2、数据不一致。RetrieveDBValues() 方法中，将回读的 SELECT 结果覆盖到模型结构体的内存，多个事务并发场景下可能导致业务读取到脏数据。</p>
<p>3、回读会产生额外的select日志，增加日志体积，且可能干扰问题排查。</p>
<h2 data-id="heading-3">四、结语</h2>
<p>对于go开发者而言，这个案例有几个启示：其一，orm框架的“黑盒操作”背后往往有清晰的设计逻辑，遇到疑难问题时，溯源源码是最直接有效的排查手段；其二，使用框架时不能仅关注上层API调用，还需了解其核心机制（如Gorm的回调链），才能精准规避风险；其三，在高并发等场景下，需格外关注框架的隐式操作，才能把性能压榨机制或者规避不必要的bug。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-63、数据流中的中位数]]></title>    <link>https://juejin.cn/post/7594415509607350318</link>    <guid>https://juejin.cn/post/7594415509607350318</guid>    <pubDate>2026-01-13T06:09:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594415509607350318" data-draft-id="7593607642553368602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-63、数据流中的中位数"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T06:09:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-63、数据流中的中位数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:10.000Z" title="Tue Jan 13 2026 06:09:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>如何得到⼀个数据流中的中位数？如果从数据流中读出奇数个数值，那么中位数就是所有数值排序之后位于中间的数值。如果从数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。我们使⽤ Insert() ⽅法读取数据流，使⽤ GetMedian() ⽅法获取当前读取数据的中位数。</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">排序列表法</h3>
<p>维护一个列表，每次获取中位数前进行排序</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder1</span> {
    <span class="hljs-keyword">private</span> List&lt;Integer&gt; data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MedianFinder1</span><span class="hljs-params">()</span> {
        data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">// 插入数字到数据流</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
        data.add(num);
        <span class="hljs-comment">// 每次插入后排序，保持列表有序</span>
        Collections.sort(data);
    }
    
    <span class="hljs-comment">// 获取当前数据流的中位数</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> data.size();
        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        
        <span class="hljs-keyword">if</span> (size % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 奇数个元素，返回中间值</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) data.get(size / <span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 偶数个元素，返回中间两个数的平均值</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> size / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">return</span> (data.get(mid - <span class="hljs-number">1</span>) + data.get(mid)) / <span class="hljs-number">2.0</span>;
        }
    }
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：每次插入需要排序，时间复杂度O(n log n)</li>
<li><strong>获取中位数</strong>：直接通过索引访问，时间复杂度O(1)</li>
<li><strong>空间复杂度</strong>：O(n)，需要存储所有数据</li>
</ul>
<h3 data-id="heading-3">插入排序法</h3>
<p>在方法一基础上优化，在插入时就找到正确位置，避免每次都完整排序。同时利用二分查找找到插入位置，减少排序开销</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder2</span> {
    <span class="hljs-keyword">private</span> List&lt;Integer&gt; data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MedianFinder2</span><span class="hljs-params">()</span> {
        data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
        <span class="hljs-comment">// 使用二分查找找到合适的插入位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = data.size() - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">if</span> (data.get(mid) &lt; num) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-comment">// 在找到的位置插入元素</span>
        data.add(left, num);
    }
    
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> data.size();
        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        
        <span class="hljs-keyword">if</span> (size % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) data.get(size / <span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> size / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">return</span> (data.get(mid - <span class="hljs-number">1</span>) + data.get(mid)) / <span class="hljs-number">2.0</span>;
        }
    }
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：二分查找O(log n) + 插入操作O(n) = O(n)</li>
<li><strong>获取中位数</strong>：O(1)，通过索引直接访问</li>
<li><strong>优化效果</strong>：比方法一有明显提升，特别适合部分有序的数据</li>
</ul>
<h3 data-id="heading-4">双堆法</h3>
<p>是最高效的解法，利用大顶堆和小顶堆的特性来动态维护中位数，使用大顶堆存较小一半，小顶堆存较大一半</p>
<p>⽤⼀个数字来不断统计数据流中的个数，并且创建⼀个最⼤堆，⼀个最⼩堆</p>
<ul>
<li>如果插⼊的数字的个数是奇数的时候，让最⼩堆⾥⾯的元素个数⽐最⼤堆的个数多 1 ，这样⼀来中位数就是⼩顶堆的堆顶</li>
<li>如果插⼊的数字的个数是偶数的时候，两个堆的元素保持⼀样多，中位数就是两个堆的堆顶的元素相加除以2 。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
	<span class="hljs-keyword">private</span> PriorityQueue&lt;Integer&gt; min = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Integer&gt;();
	<span class="hljs-keyword">private</span> PriorityQueue&lt;Integer&gt; max = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Integer&gt;(<span class="hljs-keyword">new</span>
	
	<span class="hljs-title class_">Comparator</span>&lt;Integer&gt;() {
		<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> {
			<span class="hljs-keyword">return</span> o2 - o1;
		}
	});
	
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(Integer num)</span> {
		count++;
		<span class="hljs-keyword">if</span> (count % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
			<span class="hljs-comment">// 奇数的时候，需要最⼩堆的元素⽐最⼤堆的元素多⼀个。</span>
			<span class="hljs-comment">// 先放到最⼤堆⾥⾯，然后弹出最⼤的</span>
			max.offer(num);
			<span class="hljs-comment">// 把最⼤的放进最⼩堆</span>
			min.offer(max.poll());
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 放进最⼩堆</span>
			min.offer(num);
			<span class="hljs-comment">// 把最⼩的放进最⼤堆</span>
			max.offer(min.poll());
		}
	}
		
	<span class="hljs-keyword">public</span> Double <span class="hljs-title function_">GetMedian</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">if</span> (count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">return</span> (min.peek() + max.peek()) / <span class="hljs-number">2.0</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) min.peek();
		}
	}
}
</code></pre>
<ul>
<li><strong>插入操作</strong>：堆的插入操作O(log n)，平衡操作O(log n)，总体O(log n)</li>
<li><strong>获取中位数</strong>：直接访问堆顶元素，O(1)时间复杂度</li>
<li><strong>空间复杂度</strong>：O(n)，需要存储所有数据</li>
</ul>
<p><strong>为什么这种方法有效？</strong></p>
<ul>
<li><strong>大顶堆</strong>（maxHeap）：存储数据流中<strong>较小的一半</strong>数字，堆顶是这一半中的最大值</li>
<li><strong>小顶堆</strong>（minHeap）：存储数据流中<strong>较大的一半</strong>数字，堆顶是这一半中的最小值</li>
<li><strong>平衡维护</strong>：确保两个堆的大小相差不超过1，这样中位数就只与两个堆顶有关</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再死磕 Nginx！http-proxy-middleware 低配置起飞]]></title>    <link>https://juejin.cn/post/7594270467029991451</link>    <guid>https://juejin.cn/post/7594270467029991451</guid>    <pubDate>2026-01-12T08:56:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594270467029991451" data-draft-id="7594168317214212106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再死磕 Nginx！http-proxy-middleware 低配置起飞"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-12T08:56:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再死磕 Nginx！http-proxy-middleware 低配置起飞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T08:56:39.000Z" title="Mon Jan 12 2026 08:56:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是凌览。</p>
<ul>
<li>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.code24.top%2F" target="_blank" title="https://blog.code24.top/" ref="nofollow noopener noreferrer">blog.code24.top</a></li>
<li>去水印下载鸭：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnologo.code.top%2F" target="_blank" title="http://nologo.code.top/" ref="nofollow noopener noreferrer">nologo.code.top</a></li>
</ul>
<p>如果本文能给你提供启发或帮助，欢迎动动小手指，一键三连（<code>点赞</code>、<code>评论</code>、<code>转发</code>），给我一些支持和鼓励谢谢。</p>
<h2 data-id="heading-0">前言</h2>
<p>已有一个去水印下载鸭后端服务，域名配置、服务器端口均已配置稳定。</p>
<p>现在我另有一个后端服务，假设取名叫去水印下载鸭后端服务Pro。</p>
<p>现在需要去水印下载鸭后端服务、去水印下载鸭后端服务Pro部署在同一台服务器，并且两者都通过80、443公开端口对外访问。这时大多选择Nginx反向代理让去水印下载鸭后端服务、去水印下载鸭后端服务Pro共用一个门牌号，流量自动分流，证书复用。</p>
<p>对于并发量大的后台选择Nginx没毛病，但对流量小到连“并发”俩字都嫌重，再搬出 Nginx 就是拿青龙偃月刀切葱花——刀好，但真没必要。</p>
<p>Node 玩家直接 http-proxy-middleware 一把梭,省出配 nginx 的功夫，早把需求迭代上线了。</p>
<p>本文就来介绍怎样用 http-proxy-middleware 三分钟搭好反向代理，让“去水印下载鸭”与“Pro 版”同吃 80/443，零 Nginx、低配置。</p>
<h2 data-id="heading-1">http-proxy-middleware是什么</h2>
<p>http-proxy-middleware是一个基于 Express.js 框架的中间件,它能够将一个或多个 HTTP 请求代理到另一个服务器上。常用场景如：前端开发遇到跨域问题时，通过配置http-proxy-middleware，可以将前端请求代理到后端服务器，从而巧妙地避开浏览器的跨域限制。</p>
<h2 data-id="heading-2"><strong>安装与基础使用</strong></h2>
<p>首先安装http-proxy-middleware:</p>
<pre><code class="hljs language-jsx" lang="jsx">npm install http-proxy-middleware
</code></pre>
<p>安装完成后，我们就可以在项目中引入并使用它了。以下是一个简单的 Express 应用中使用http-proxy-middleware代理请求的示例：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-comment">// 创建一个代理中间件，将所有以/api开头的请求代理到目标服务器</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api'</span>, <span class="hljs-title function_">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://target-server.com'</span>, <span class="hljs-comment">// 目标服务器地址</span>
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许修改请求头中的origin字段</span>
}));
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">${port}</span>`</span>);
});

</code></pre>
<h2 data-id="heading-3">运用到实际项目</h2>
<p>去水印下载鸭后端服务跑在 3000，在生产环境中会占住公网 80；去水印下载鸭后端服务Pro躲在 3010，只对内敞开。现在把 <code>http-proxy-middleware</code> 直接塞进3000去水印下载鸭后端服务，只加一条路由规则：</p>
<p>接口一旦撞上 <code>/api/gold-price/*/**</code>，当场被悄悄转给3010端口服务。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> proxyGoldPrice = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./middleware/proxyGoldPrice.js'</span>);
<span class="hljs-comment">//省略</span>
<span class="hljs-comment">// 👇 新增：代理 gold-price 路由</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api/gold-price'</span>, proxyGoldPrice);

<span class="hljs-comment">//省略</span>
</code></pre>
<p>在middleware目录创建<code>proxyGoldPrice.js</code> 文件,Express中间件配置放置在一起.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7fb39b4408e4880943113025a898930~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768812999&amp;x-signature=bclmSDT4C5mLU9tdVduSoB5WhBk%3D" alt="image.png" loading="lazy"/></p>
<p>proxyGoldPrice.js内容:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// middleware/proxyGoldPrice.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>);

<span class="hljs-keyword">const</span> proxyGoldPrice = <span class="hljs-title function_">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">"http://127.0.0.1:3010"</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 如果目标服务不需要 /api 前缀，可启用 pathRewrite：</span>
    <span class="hljs-attr">pathRewrite</span>: {
        <span class="hljs-comment">//重写路径</span>
        <span class="hljs-string">'^/'</span>: <span class="hljs-string">'/api/gold-price/'</span>,
    }
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = proxyGoldPrice;
</code></pre>
<p>在上述代码中，我们通过createProxyMiddleware函数创建了一个代理中间件。当应用接收到以/api/gold-price开头的请求时，它会自动将该请求转发到<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A3010%25E3%2580%2582" target="_blank" title="http://127.0.0.1:3010%E3%80%82" ref="nofollow noopener noreferrer">http://127.0.0.1:3010。</a></p>
<p>举个例子：访问<code>http://127.0.0.1:3000/api/gold-price/realtime</code>时，命中<code>app.use('/api/gold-price', proxyGoldPrice)</code>路由，http-proxy-middleware会把<code>http://127.0.0.1:3000/api/gold-price/realtime</code>转发到<code>http://127.0.0.1:3010/realtime</code>。</p>
<p>上述例子中转发后的访问的是<code>http://127.0.0.1:3010/realtime</code>,但在去水印下载鸭后端服务Pro路由前缀都有<code>/api/gold-price</code>,所以会出错没找到对应路由。</p>
<p><code>pathRewrite</code>则是解决些问题的配置,它用于路径重写:</p>
<pre><code class="hljs language-jsx" lang="jsx"> <span class="hljs-attr">pathRewrite</span>: {
        <span class="hljs-comment">//重写路径</span>
        <span class="hljs-string">'^/'</span>: <span class="hljs-string">'http://127.0.0.1:3010/realtime'</span>,
    }
</code></pre>
<p>表示把<code>/</code>替换成<code>/api/gold-price/</code>。转发后路径就是<code>http://127.0.0.1:3010/api/gold-price/realtime</code>。该字段可配可不配，取决于你的目标服务器。</p>
<p>好了，http-proxy-middleware基础使用方法介绍完毕。有不同代理需求功能可以移步看它的官方文档。</p>
<h2 data-id="heading-4">工具对比</h2>
<p>来个简单对比：</p>





















































<table><thead><tr><th>特性</th><th>http-proxy-middleware</th><th>http-proxy</th><th>nginx</th></tr></thead><tbody><tr><td>配置复杂度</td><td>中等</td><td>高</td><td>高</td></tr><tr><td>Node.js 集成</td><td>优秀</td><td>优秀</td><td>需要单独进程</td></tr><tr><td>开发便利性</td><td>优秀</td><td>良好</td><td>一般</td></tr><tr><td>性能</td><td>良好</td><td>优秀</td><td>优秀</td></tr><tr><td>WebSocket 支持</td><td>是</td><td>是</td><td>是</td></tr><tr><td>路径重写</td><td>是</td><td>有限</td><td>是</td></tr><tr><td>适用场景</td><td>轻量网关、Node 栈一体化</td><td>底层库、自定义代理逻辑</td><td>高并发、多语言、企业级网关</td></tr></tbody></table>
<p>http-proxy-middleware是http-proxy二次封装，本质是一个东西。http-proxy-middleware的存在让http-proxy更易使用。</p>
<h2 data-id="heading-5">最后</h2>
<p>通过在 Node.js 应用中集成 http-proxy-middleware 中间件，只需几行代码配置就能让多个后端服务共用 80/443 端口，实现请求分流和路由转发。相比 Nginx，这种方案配置简单、与 Node.js 深度集成、开发便利性高，特别适合流量不大的项目快速部署，避免"杀鸡用牛刀"的资源浪费。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[物品超领取损失1万事故复盘(一)]]></title>    <link>https://juejin.cn/post/7594266018303934527</link>    <guid>https://juejin.cn/post/7594266018303934527</guid>    <pubDate>2026-01-12T08:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594266018303934527" data-draft-id="7588680081326555178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="物品超领取损失1万事故复盘(一)"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-12T08:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            物品超领取损失1万事故复盘(一)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T08:56:58.000Z" title="Mon Jan 12 2026 08:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    65
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>我是[<a href="https://juejin.cn/user/465848660928872" title="https://juejin.cn/user/465848660928872" target="_blank">提前退休的java猿</a>]，一名7年java开发经验的开发组长，分享工作中的各种问题！（抖音、公众号同号）</p>
</blockquote>
<p>25年12月25日上午，数据库服务器<code>CPU 100%</code>，最终导致某个物品领取业务损失1万块。如果之前有看过我文章的应该就知道 <code>CPU 100%</code> 已经不是第一出现了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f634a70e65f471788731c7c69700327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768833548&amp;x-signature=2CWv0iO3h7WAuGFa8s%2Fn7v4%2BMPM%3D" alt="e51b9f7f7235a025d17664fbad9c3feb.png" loading="lazy"/>
今天先从代码上复盘一下，为什么数据库<code>CPU100%</code> 之后，物品就超领了❓ 首先想到的肯定是代码存在问题，今天就先看看代码上是否存在问题。</p>
<blockquote>
<p>🔈负责的同事这样说反馈的：同一个事务中先库存扣减（A操作）：update t set num = num -1 where num &gt;0 然后插入领取记录（B操作）:insert xx。<br/>
❗最终数据结果就是insert 的领取数量，大于了库存总数。所以同事就反馈A没执行，B却执行成功了非常的诡异。</p>
</blockquote>
<p>说实话到现在为止我还是有点怀疑他写的代码，数据库的原子性都被破坏了还是很恐怖的😨，今天的文章主要看看排查出事务的原子性破坏坏的问题。</p>
<p>（ps:<code>🧛🏾‍♀️这是一篇没有找到答案的技术博客</code>）</p>
<h2 data-id="heading-1">抽奖超领复盘</h2>
<p>CUP为什么飙高的这个问题今天就不是我们要排查的问题，所以代码的性能今天就不讨论了。今天主要分析物品超领的问题，到底是代码问题导致的事务失效，还是有其他地方在插入领取记录或者是做了库存回滚（插入记录又回滚）。还是真的是事务的原子性被破坏了。</p>
<blockquote>
<p>🔊环境介绍：数据库使用的国产的人大金仓，使用的是主从架构</p>
</blockquote>
<h3 data-id="heading-2">一、核心代码分析</h3>
<p>从controller 到service 的代码我都看了，本来要把这部分代码贴出来的还是算了。无限简化之后就是下面的逻辑</p>
<p><strong>controller</strong> 层代码：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@RedisRateLimiter(value = 100,limit = 1)</span>
    <span class="hljs-meta">@PostMapping(value = "/grabCoupon")</span>
    <span class="hljs-keyword">public</span> Res&lt;?&gt; equityClaim(<span class="hljs-meta">@RequestBody</span> GrabCouponReqEx req) {
        .........
        <span class="hljs-keyword">return</span> service.grabCouponTrans(req);
    }
</code></pre>
<p><strong>service</strong> 层代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,rollbackFor = RuntimeException.class)</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; grabCouponTrans(GrabCouponReqEx req) {
       <span class="hljs-comment">// 对所有代码进行 try，然后抛出RuntimException 让框架回滚</span>
       <span class="hljs-keyword">try</span>{
       <span class="hljs-comment">//💦当然事务中还有很多查询校验的逻辑这儿就省略了</span>
       .............................
        <span class="hljs-comment">//✅ A操作：库存扣减，这个地方对库存-1，如果更新行数大与0返回true </span>
        <span class="hljs-comment">//UPDATE t SET num =  num -1  WHERE id = #{id} AND num &gt; 0;</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isok</span> <span class="hljs-operator">=</span> xxDao.reduceInventoryNoCompleted(id);
        <span class="hljs-keyword">if</span> (isok) {
            <span class="hljs-comment">// ✅B操作：插入领取记录，插入成功返回 true</span>
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">insetSuc</span> <span class="hljs-operator">=</span> insert(record);
            <span class="hljs-comment">// ...................... ❌HTTP 写在事务中</span>
            Result&lt;?&gt; result1 = XXHttpUtils.preExamination(claimReq);
            <span class="hljs-comment">//同步更新核销数据</span>
            <span class="hljs-keyword">if</span> (!isokDetail) {
                logger.error(<span class="hljs-string">"【反馈数据更新同步异常】"</span>);
                XXHttpUtils.saveLogsNoSupp(xx);
            }
            <span class="hljs-keyword">return</span> result;
        } 
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"更新配置权益核销状态失败！"</span>);
    }<span class="hljs-keyword">catch</span> (Exception e){
        <span class="hljs-comment">// ❗这也是一个问题代码呀，还是用log.error("ss",e)</span>
        e.printStackTrace();
        <span class="hljs-comment">//........ redis 信息回滚操作.........</span>
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<p>基础稍微扎实一点的可以看出上面的代码逻辑是不会出现库存被扣成负数的情况，即使在高并发下，因为update By id 操作本身会进行行锁。所以在库存 =1的情况下，多个请求更新也只有一个能更新成功（更新行数=1）。</p>
<h4 data-id="heading-3">事务失效？</h4>
<ul>
<li>捕捉<code>RuntimeException</code>事务导致失效：注解上面捕捉的是<code>RuntimeException</code>，但是捕捉了Exceptioon 又抛出了。如果抛出去的异常没有继成RuntimeException，事务就会失效，也不会出现 A没执行、B却执行成功的情况。</li>
<li>❌<del>this调用insert导致事务失效</del>：这个观点我在抖音评论下面看到好几个人都这么说。这个观点是不对的，首先调用insert方法外层方法（<code>grabCouponTrans</code>）是被@Transactional标记的，并且也是通过spring管理的容器对象管理的，所以不会因为在事务方法内部进行了this调用导致这个this调用方法不在事务内。只是这个this调用的方法没有被代理，默认加入到外层方法的事务里面了。</li>
</ul>
<h4 data-id="heading-4">主从读写不一致？</h4>
<p>这个问题正常来说开启了非只读事务之后，应该读写都走的是主库。但是我debug了一下 事务的读取居然是走的从库？？</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">04</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">42</span>] [<span class="hljs-number">230</span>] [com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">executor</span>.<span class="hljs-property">DispatchAbstractStatement</span>--&gt;executeTemplet] 
<span class="hljs-title class_">Send</span> to slave <span class="hljs-attr">session</span>: (session={com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>@e3cc839}
url={<span class="hljs-attr">jdbc</span>:<span class="hljs-attr">kingbase8</span>:<span class="hljs-comment">//从库IP:从库port/ghbase} </span>
st={<span class="hljs-variable constant_">SELECT</span> id,..... <span class="hljs-variable constant_">FROM</span> xx_table <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-number">5099</span>} _sqlType={select})

</code></pre>
<p>然后写库又是用主库</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">04</span> <span class="hljs-number">23</span>:<span class="hljs-number">39</span>:<span class="hljs-number">23</span>] [<span class="hljs-number">230</span>] [com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">executor</span>.<span class="hljs-property">DispatchAbstractStatement</span>--&gt;executeTemplet] 
<span class="hljs-title class_">Send</span> to master <span class="hljs-attr">session</span>: (session={com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>@e3cc839} 
url={<span class="hljs-attr">jdbc</span>:<span class="hljs-attr">kingbase8</span>:<span class="hljs-comment">//主库iP:port/ghbase?_hostLoadRate=0} st={INSERT INTO xx_table (id....) VALUES (...........)</span>
<span class="hljs-variable constant_">RETURNING</span> <span class="hljs-string">"id"</span>} _sqlType={insert or <span class="hljs-keyword">delete</span> or update})
</code></pre>
<blockquote>
<p>我以为这就是问题源头了😱，事务里面得查询会走从库。当我继续debug得时候，发现在执行事务注解标记得方法时候，如果没有执行<code>更新SQL（DML）</code>那么查询就一直走从库，直到执行更新数据SQL（DML）的时候，后面的查询也都走主库了。</p>
</blockquote>
<h3 data-id="heading-5">二、异常日志分析</h3>
<h4 data-id="heading-6">1. Couldn't commit jdbc connection. FATAL: terminating connection due to conflict with recovery(偶尔出现任何业务)</h4>
<p>这个异常时还没到业务高峰的时候，这个问题就是<code>Quartz</code>在维护内部状态的时候出现的报错。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">01</span>:<span class="hljs-number">01</span>:<span class="hljs-number">01</span><span class="hljs-number">.581</span> [<span class="hljs-title class_">QuartzScheduler</span>_MyScheduler-cdszgh-szhpt-41766404430759_ClusterManager] <span class="hljs-variable constant_">ERROR</span> o.<span class="hljs-property">s</span>.<span class="hljs-property">s</span>.<span class="hljs-property">q</span>.<span class="hljs-property">LocalDataSourceJobStore</span> - [manage,<span class="hljs-number">3941</span>] - <span class="hljs-title class_">ClusterManager</span>: <span class="hljs-title class_">Error</span> managing <span class="hljs-attr">cluster</span>: <span class="hljs-title class_">Couldn</span><span class="hljs-string">'t commit jdbc connection. FATAL: terminating connection due to conflict with recovery
  Detail: User was holding a relation lock for too long.
  Hint: In a moment you should be able to reconnect to the database and repeat your command.
org.quartz.JobPersistenceException: Couldn'</span>t commit jdbc connection. <span class="hljs-attr">FATAL</span>: terminating connection due to conflict <span class="hljs-keyword">with</span> recovery
  <span class="hljs-title class_">Detail</span>: <span class="hljs-title class_">User</span> was holding a relation lock <span class="hljs-keyword">for</span> too long.
  <span class="hljs-title class_">Hint</span>: <span class="hljs-title class_">In</span> a moment you should be able to reconnect to the database and repeat your command.
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport</span>.<span class="hljs-title function_">commitConnection</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3749</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport</span>.<span class="hljs-title function_">doCheckin</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3331</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport$ClusterManager</span>.<span class="hljs-title function_">manage</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3935</span>)
	at org.<span class="hljs-property">quartz</span>.<span class="hljs-property">impl</span>.<span class="hljs-property">jdbcjobstore</span>.<span class="hljs-property">JobStoreSupport$ClusterManager</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">JobStoreSupport</span>.<span class="hljs-property">java</span>:<span class="hljs-number">3972</span>)
</code></pre>
<h5 data-id="heading-7">✔原因分析</h5>
<p>PostgreSQL 数据库因为检测到  <strong>"relation lock 持有时间过长"</strong>  而主动终止了连接。这是 PostgreSQL 在<strong>主从复制（流复制）或恢复模式</strong>下的一种保护机制。</p>
<p>💦引发这个问题的原因可能是：PostgreSQL 备机恢复压力大、<strong>网络延迟</strong> 导致复制缓慢、数据库服务器资源不足</p>
<ol>
<li>
<p><strong>PostgreSQL 恢复冲突处理</strong></p>
<ul>
<li>当 PostgreSQL 备机正在执行 WAL 恢复时</li>
<li>如果有长时间的事务锁定了某些表（relation lock）</li>
<li>主从同步可能会被阻塞</li>
<li>为了确保数据一致性，PostgreSQL 会强制终止持有锁过长的会话</li>
</ul>
</li>
<li>
<p><strong>Quartz 集群管理机制</strong></p>
<ul>
<li><code>ClusterManager</code> 线程定期检查集群状态（默认每 15-30 秒）</li>
<li>需要获取数据库锁来维护集群一致性</li>
<li>如果这个操作耗时过长，就会触发 PostgreSQL 的保护机制</li>
</ul>
</li>
</ol>
<h4 data-id="heading-8">2.org.apache.catalina.connector.ClientAbortException: java.io.IOException: 断开的管道（各业务频繁出现）</h4>
<p>这个问题出现在了数据库服务器CPU已经是拉满的状态了，应该是用户的请求已经开始阻塞了</p>
<pre><code class="hljs language-js" lang="js">org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">ClientAbortException</span>: java.<span class="hljs-property">io</span>.<span class="hljs-property">IOException</span>: 断开的管道
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">realWriteBytes</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">342</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">flushByteBuffer</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">777</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">append</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">674</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">writeBytes</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">377</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">OutputBuffer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">OutputBuffer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">355</span>)
	at org.<span class="hljs-property">apache</span>.<span class="hljs-property">catalina</span>.<span class="hljs-property">connector</span>.<span class="hljs-property">CoyoteOutputStream</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">CoyoteOutputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">101</span>)
	at .......................
	at......................... com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">std</span>.<span class="hljs-property">BeanSerializerBase</span>.<span class="hljs-title function_">serializeFields</span>(<span class="hljs-title class_">BeanSerializerBase</span>.<span class="hljs-property">java</span>:<span class="hljs-number">774</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">BeanSerializer</span>.<span class="hljs-title function_">serialize</span>(<span class="hljs-title class_">BeanSerializer</span>.<span class="hljs-property">java</span>:<span class="hljs-number">178</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">DefaultSerializerProvider</span>.<span class="hljs-title function_">_serialize</span>(<span class="hljs-title class_">DefaultSerializerProvider</span>.<span class="hljs-property">java</span>:<span class="hljs-number">480</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ser</span>.<span class="hljs-property">DefaultSerializerProvider</span>.<span class="hljs-title function_">serializeValue</span>(<span class="hljs-title class_">DefaultSerializerProvider</span>.<span class="hljs-property">java</span>:<span class="hljs-number">319</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ObjectWriter$Prefetch</span>.<span class="hljs-title function_">serialize</span>(<span class="hljs-title class_">ObjectWriter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1518</span>)
	at com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ObjectWriter</span>.<span class="hljs-title function_">writeValue</span>(<span class="hljs-title class_">ObjectWriter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1007</span>)
</code></pre>
<h5 data-id="heading-9">✔原因分析</h5>
<p><strong>这是正常的用户行为导致的异常</strong>，不是程序bug。应该优雅处理而不是报ERROR日志，避免日志文件被这类无关紧要的错误信息淹没。</p>
<h4 data-id="heading-10">3.Cause: java.sql.SQLException: Send to master from switch slave retry failare maxtimes still SQLException: FATAL: terminating connection due to administrator command（各业务频繁出现）</h4>
<p>这个报错也是集中出现在CPU拉满的情况，导致很多查询就直接报错了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cause</span>: java.<span class="hljs-property">sql</span>.<span class="hljs-property">SQLException</span>: <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command
; <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command; nested exception is java.<span class="hljs-property">sql</span>.<span class="hljs-property">SQLException</span>: <span class="hljs-title class_">Send</span> to master <span class="hljs-keyword">from</span> <span class="hljs-keyword">switch</span> slave retry failare maxtimes still <span class="hljs-title class_">SQLException</span>: <span class="hljs-attr">FATAL</span>: terminating connection due to administrator command
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">SQLStateSQLExceptionTranslator</span>.<span class="hljs-title function_">doTranslate</span>(<span class="hljs-title class_">SQLStateSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">107</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">70</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">79</span>)
	at org.<span class="hljs-property">springframework</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">support</span>.<span class="hljs-property">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-title function_">translate</span>(<span class="hljs-title class_">AbstractFallbackSQLExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">79</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">MyBatisExceptionTranslator</span>.<span class="hljs-title function_">translateExceptionIfPossible</span>(<span class="hljs-title class_">MyBatisExceptionTranslator</span>.<span class="hljs-property">java</span>:<span class="hljs-number">91</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">SqlSessionTemplate$SqlSessionInterceptor</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">SqlSessionTemplate</span>.<span class="hljs-property">java</span>:<span class="hljs-number">441</span>)
	at com.<span class="hljs-property">sun</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">$Proxy177</span>.<span class="hljs-title function_">selectList</span>(<span class="hljs-title class_">Unknown</span> <span class="hljs-title class_">Source</span>)
	at org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">SqlSessionTemplate</span>.<span class="hljs-title function_">selectList</span>(<span class="hljs-title class_">SqlSessionTemplate</span>.<span class="hljs-property">java</span>:<span class="hljs-number">224</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperMethod</span>.<span class="hljs-title function_">executeForMany</span>(<span class="hljs-title class_">MybatisMapperMethod</span>.<span class="hljs-property">java</span>:<span class="hljs-number">166</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperMethod</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">MybatisMapperMethod</span>.<span class="hljs-property">java</span>:<span class="hljs-number">77</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperProxy$PlainMethodInvoker</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MybatisMapperProxy</span>.<span class="hljs-property">java</span>:<span class="hljs-number">148</span>)
	at com.<span class="hljs-property">baomidou</span>.<span class="hljs-property">mybatisplus</span>.<span class="hljs-property">core</span>.<span class="hljs-property">override</span>.<span class="hljs-property">MybatisMapperProxy</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MybatisMapperProxy</span>.<span class="hljs-property">java</span>:<span class="hljs-number">89</span>)
	at com.<span class="hljs-property">sun</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">$Proxy386</span>.<span class="hljs-title function_">findStatisticsVoByActivityIdList</span>(<span class="hljs-title class_">Unknown</span> <span class="hljs-title class_">Source</span>)
	at 
...................业务代码方法的一些方法栈信息(省略).............................................
</code></pre>
<h5 data-id="heading-11">✔原因分析</h5>
<ul>
<li>从库延迟严重，查询超时</li>
<li>主库负载过高，无法处理请求</li>
<li><strong>网络问题</strong>导致连接不稳定</li>
<li>数据库管理员执行了维护操作（如：重启、kill连接、数据库自动kill长时间运行的查询）</li>
</ul>
<blockquote>
<p>❗错误："terminating connection due to administrator command"
→ DBA可能执行了：SELECT pg_terminate_backend(pid);
→ 或数据库自动kill了长时间运行的查询</p>
</blockquote>
<h4 data-id="heading-12">4. java.net.SocketTimeoutException: Read timed out（各业务频繁出现）</h4>
<p>在CPU拉满的情况下出现大量的<code>read timed out</code>读取数据库响应的时候就超时了。
在业务低峰的时候<code>commit</code> 事务的时候也出现过这个问题，增加socket超时时间可以降低这个错误的发生。</p>
<p>下面的select语句也是 领取事务中的 更新数据前的一些前置查询SQL</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">12.101</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">78</span>] <span class="hljs-variable constant_">ERROR</span> druid.<span class="hljs-property">sql</span>.<span class="hljs-property">Statement</span> - [statementLogError,<span class="hljs-number">148</span>] - {conn-<span class="hljs-number">10567</span>, pstmt-<span class="hljs-number">277353</span>} execute error.
<span class="hljs-variable constant_">SELECT</span> * <span class="hljs-keyword">from</span> 待领取的物品数据
com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">An</span> I/O error occurred <span class="hljs-keyword">while</span> sending to the backend.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">core</span>.<span class="hljs-property">v3</span>.<span class="hljs-property">QueryExecutorImpl</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">QueryExecutorImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">428</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">executeInternal_</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">784</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">676</span>)
	at com.<span class="hljs-property">kingbase8</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">executeWithFlags</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">286</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">265</span>)
        
        <span class="hljs-title class_">Caused</span> <span class="hljs-attr">by</span>: java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketTimeoutException</span>: <span class="hljs-title class_">Read</span> timed out
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">socketRead0</span>(<span class="hljs-title class_">Native</span> <span class="hljs-title class_">Method</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">socketRead</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">116</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">171</span>)
	at java.<span class="hljs-property">net</span>.<span class="hljs-property">SocketInputStream</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">SocketInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">141</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">core</span>.<span class="hljs-property">VisibleBufferedInputStream</span>.<span class="hljs-title function_">readMore</span>(<span class="hljs-title class_">VisibleBufferedInputStream</span>.<span class="hljs-property">java</span>:<span class="hljs-number">210</span>)
</code></pre>
<h5 data-id="heading-13">✔原因分析</h5>
<p>这个问题以前也是一直都存在的，CPU空闲的也会出现这个问题，现在CPU打满之后就出现大量的请求</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eee73d829774b48ae617cb22d309021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768833548&amp;x-signature=x3LJNgKdRKgp%2Fgm5%2BLtJHGHwVFw%3D" alt="4dc309fe-0ecf-49dd-afa7-dc022f64aae0.png" loading="lazy"/></p>
<h4 data-id="heading-14">5.💢om.kingbase8.util.KSQLException: This _connection has been closed.（各业务频繁出现）</h4>
<p>这个错是比较关键的错误了！涉及报错的SQL基本就是我们领取物品事务中的SQL了。在日志文件中在CPU打满这段时间内出现得非常之多。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">49</span>:<span class="hljs-number">56.569</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">41</span>] <span class="hljs-variable constant_">ERROR</span> druid.<span class="hljs-property">sql</span>.<span class="hljs-property">Statement</span> - 
[statementLogError,<span class="hljs-number">148</span>] - {conn-<span class="hljs-number">10529</span>, pstmt-<span class="hljs-number">276494</span>} execute error. 
<span class="hljs-variable constant_">INSERT</span> <span class="hljs-variable constant_">INTO</span> xx_lottery_xx (xx, xx, xx,) <span class="hljs-variable constant_">VALUES</span> (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
com.<span class="hljs-property">xx</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">This</span> _connection has been closed.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">checkIsClosed</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1401</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">getAutoCommit</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1329</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">executeInternal_</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">735</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbStatement</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-title class_">KbStatement</span>.<span class="hljs-property">java</span>:<span class="hljs-number">676</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbPreparedStatement</span>.<span class="hljs-title function_">executeWithFlags</span>(<span class="hljs-title class_">KbPreparedStatement</span>.<span class="hljs-property">jav</span>
        
        ........<span class="hljs-property">insert</span> 领取记录..............................
        <span class="hljs-variable constant_">ERROR</span> c.<span class="hljs-property">a</span>.<span class="hljs-property">d</span>.<span class="hljs-property">p</span>.<span class="hljs-property">DruidDataSource</span> - [recycle,<span class="hljs-number">2146</span>] - recycle error
com.<span class="hljs-property">xx</span>.<span class="hljs-property">util</span>.<span class="hljs-property">KSQLException</span>: <span class="hljs-title class_">This</span> _connection has been closed.
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">checkIsClosed</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1401</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">KbConnection</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">KbConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1288</span>)
	at com.<span class="hljs-property">xx</span>.<span class="hljs-property">dispatcher</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">DispatchConnection</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">DispatchConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">1115</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">699</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">logging</span>.<span class="hljs-property">LogFilter</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">LogFilter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">467</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">694</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterAdapter</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterAdapter</span>.<span class="hljs-property">java</span>:<span class="hljs-number">964</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">connection_setAutoCommit</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">694</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">proxy</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">ConnectionProxyImpl</span>.<span class="hljs-title function_">setAutoCommit</span>(<span class="hljs-title class_">ConnectionProxyImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">416</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidConnectionHolder</span>.<span class="hljs-title function_">reset</span>(<span class="hljs-title class_">DruidConnectionHolder</span>.<span class="hljs-property">java</span>:<span class="hljs-number">387</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidDataSource</span>.<span class="hljs-title function_">recycle</span>(<span class="hljs-title class_">DruidDataSource</span>.<span class="hljs-property">java</span>:<span class="hljs-number">2053</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidPooledConnection</span>.<span class="hljs-title function_">recycle</span>(<span class="hljs-title class_">DruidPooledConnection</span>.<span class="hljs-property">java</span>:<span class="hljs-number">343</span>)
	at com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">FilterChainImpl</span>.<span class="hljs-title function_">dataSource_recycle</span>(<span class="hljs-title class_">FilterChainImpl</span>.<span class="hljs-property">java</span>:<span class="hljs-number">5047</span>)
        
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">44</span>:<span class="hljs-number">22.908</span> [http-nio-<span class="hljs-number">8077</span>-exec-<span class="hljs-number">149</span>] <span class="hljs-variable constant_">ERROR</span> o.<span class="hljs-property">s</span>.<span class="hljs-property">t</span>.<span class="hljs-property">i</span>.<span class="hljs-property">TransactionInterceptor</span> - 
[completeTransactionAfterThrowing,<span class="hljs-number">680</span>] - <span class="hljs-title class_">Application</span> exception overridden by rollback exception
</code></pre>
<h5 data-id="heading-15">✔原因分析</h5>
<p>和上面的报错很类似，只是在插入数据的时候发现连接断开了，这时候回滚也是没办法的。</p>
<h3 data-id="heading-16">三、数据库日志分析</h3>
<p>这个日志文件是我们部门经理发出来的，什么级别的日志咱也不知道，应该是记录的慢SQL的吧或者报错SQL日志的吧。</p>
<p>直接看业务高峰时数据库的异常日志,就只看领取事务中相关SQL的日志</p>
<h4 data-id="heading-17">情况一：</h4>
<p>【1817689】数据库后端进程ID ，当前事务的就只有库存扣减的日志，执行完扣减之后就 直接出现 <code>unexpected EOF</code>
（没有@Transactional 方法 中更新库存前的查询的日志说明查询是走了从库）</p>
<p>而且这个【1817689】进程在抛错之后，在日志文件中的下文就没有收到这个进程了（执行了库存扣减然后就直接报错被销毁了❓）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:<span class="hljs-attr">duration</span>: <span class="hljs-number">3538.580</span> ms  execute &lt;unnamed&gt;:
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>)
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">DETAIL</span>:  <span class="hljs-attr">parameters</span>: $1 = <span class="hljs-string">'12783'</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:  
unexpected <span class="hljs-variable constant_">EOF</span> on client connection <span class="hljs-keyword">with</span> an open transaction
</code></pre>
<h4 data-id="heading-18">情况二：</h4>
<p>[1872365] 日志中搜索[1872365]进程，只有下面两行🌚，就很奇怪，也没有报错也没有insert记录的日志。</p>
<p>当时[1872365] 进程前后都有其他日志（是不是代表这个进程进行了多次会话，对应的领取业务也是走通了的❓）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>] <span class="hljs-attr">LOG</span>:  <span class="hljs-attr">duration</span>: <span class="hljs-number">3236.489</span> ms  execute &lt;unnamed&gt;: 
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>)
<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>] <span class="hljs-attr">DETAIL</span>:  <span class="hljs-attr">parameters</span>: $1 = <span class="hljs-string">'12786'</span>
</code></pre>
<p>🎃完全看不懂这个日志了，被<code>@Transactional</code> 标记的方法正常逻辑是 库存扣减、然后插入领取记录。但是这个数据库日志只有库存扣减的日志。</p>
<h3 data-id="heading-19">四、错误日志归纳总结分析</h3>
<p><strong>应用程序的错误日志</strong>（库存扣减出现两次报错）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">51.730</span> 库存扣减异常（<span class="hljs-title class_">This</span> _connection has been closed.）程序发起回滚失败（ [completeTransactionAfterThrowing,<span class="hljs-number">680</span>] - <span class="hljs-title class_">Application</span> exception overridden by rollback exception）
<span class="hljs-number">2.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span>:<span class="hljs-number">28.297</span> 库存扣减异常同上
</code></pre>
<p><strong>数据库日志</strong>（库存扣减出现两次日志）一次：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08.825</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1817689</span>] <span class="hljs-attr">LOG</span>:<span class="hljs-attr">duration</span>: <span class="hljs-number">3538.580</span> ms  execute &lt;unnamed&gt;:
<span class="hljs-variable constant_">UPDATE</span> xx <span class="hljs-variable constant_">SET</span> ...(库存扣减<span class="hljs-variable constant_">SQL</span>) 出现：unexpected <span class="hljs-variable constant_">EOF</span> on client connection <span class="hljs-keyword">with</span> an open transaction

<span class="hljs-number">2.</span> <span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31.591</span> <span class="hljs-variable constant_">CST</span> [<span class="hljs-number">1872365</span>]  <span class="hljs-attr">duration</span>: <span class="hljs-number">3236.489</span> ms
</code></pre>
<p>❌数据库的日志库存扣减的日志只有两条，但是数据库中的领取记录有很多，说明这个日志应该是只记录了部分日志。可能是记录的慢SQL😂</p>
<p>📢但是超领的数据远不止两条数据，说明这些超领的数据在执行代码的时候，也是没有抛错的，所以想要通过日志去定位问题。暂时是不行的</p>
<h2 data-id="heading-20">总结</h2>
<p>下面的代码，正常来讲不管有没有加事务，都不可能出现 库存扣减数量 大于插入记录数量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//✅ A操作：库存扣减，这个地方对库存-1，如果更新行数大与0返回true</span>
<span class="hljs-comment">//UPDATE t SET num = num -1 WHERE id = #{id} AND num &gt; 0;</span>
<span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> xxDao.reduceInventoryNoCompleted(id);
<span class="hljs-keyword">if</span> (row&gt;<span class="hljs-number">0</span>) {
<span class="hljs-comment">// ✅B操作：插入领取记录，插入成功返回</span>
<span class="hljs-literal">true</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">insetSuc</span> <span class="hljs-operator">=</span> insert(record);
</code></pre>
<p>从日志上应用上的日志来看，确实有事务报错，阻塞，以及不能回滚的问题，好像也不能够解释 领取的记录量大于库存总数的问题。</p>
<p>我在代码中也没有找到库存回滚+1 的代码，所以目前为止我从代码层面和日志上都不能找到到底什么问题引起的。</p>
<p>之前抖音上有网友说遇到过这个问题，因为主从延迟的问题。</p>
<p><strong>Couldn't commit jdbc connection. FATAL: terminating connection due to conflict with recovery</strong></p>
<p>这个问题，我也问了一下deepSeek，说的可能会破坏事务的原子性（可信度有待考证）</p>
<p>🙈抱歉这是一篇没有答案的技术博客，后续如果我也会持续跟进这个问题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比]]></title>    <link>https://juejin.cn/post/7594576956420079642</link>    <guid>https://juejin.cn/post/7594576956420079642</guid>    <pubDate>2026-01-13T06:08:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956420079642" data-draft-id="7594415509607301166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:08:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师之夜系列分享第三十九篇：Kafka、RocketMQ、JMQ 存储架构深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:08:39.000Z" title="Tue Jan 13 2026 06:08:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：毕源泉</p>
<h2 data-id="heading-0"><strong>引言</strong></h2>
<p>消息队列的存储架构是决定其可靠性、吞吐量、延迟性能的核心因素，直接影响业务场景适配能力。本文聚焦三款主流消息队列 ——Kafka（LinkedIn 开源，侧重高吞吐）、RocketMQ（阿里开源，金融级特性突出）、JMQ（京东开源，侧重高可用与灵活性），从存储模型、数据组织、索引设计等维度展开深度对比，为技术选型与架构优化提供参考。​</p>
<p>本文将从概念辨析出发，系统拆解主流存储模型与存储引擎的设计逻辑，对比 JMQ、Kafka、RocketMQ的技术选型差异与架构设计。​</p>
<h2 data-id="heading-1"><strong>一、</strong> Kafka存储架构</h2>
<h3 data-id="heading-2">1.1 核心存储模型：分区日志流</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee01ba5da3c1475592f077f908a2456c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=c7Oq0C14wEkUNI8E%2FC53PX7fpBw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>Topic - 主题</strong></p>
<p>Kafka学习了数据库里面的设计，在里面设计了topic（主题），这个东西类似于关系型数据库的表，此时我需要获取中国移动的数据，那就直接监听中国移动订阅的Topic即可。</p>
<p><strong>Partition - 分区</strong></p>
<p>Kafka还有一个概念叫Partition（分区），分区具体在服务器上面表现起初就是一个目录，一个主题下面有多个分区，这些分区会存储到不同的服务器上面，或者说，其实就是在不同的主机上建了不同的目录。这些分区主要的信息就存在了.log文件里面。跟数据库里面的分区差不多，是为了提高性能。</p>
<p>至于为什么提高了性能，很简单，多个分区多个线程，多个线程并行处理肯定会比单线程好得多。</p>
<p>Topic和partition像是HBASE里的table和region的概念，table只是一个逻辑上的概念，真正存储数据的是region，这些region会分布式地存储在各个服务器上面，对应于kafka，也是一样，<strong>Topic也是逻辑概念，而partition就是分布式存储单元。这个设计是保证了海量数据处理的基础。我们可以对比一下，如果HDFS没有block的设计，一个100T的文件也只能单独放在一个服务器上面，那就直接占满整个服务器了，引入block后，大文件可以分散存储在不同的服务器上。</strong></p>
<p><strong>注意：</strong></p>
<p>1.分区会有单点故障问题，所以我们会为每个分区设置副本数</p>
<p>2.分区的编号是从0开始的</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66333a00a3d94c1185c3fb0de363a34c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=rCTx8tpxHS4Xca00NsI9U2qqjps%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>Kafka 以「主题（Topic）- 分区（Partition）」为核心组织数据，每个分区本质是一个 append-only 的日志流，消息按生产顺序追加存储，保证分区内消息有序性。​</p>
<p><strong>优点：</strong> 可以充分利用磁盘顺序读写高性能的特性。存储介质也可以选择廉价的SATA磁盘，这样可以获得更长的数据保留时间、更低的数据存储成本。</p>
<h3 data-id="heading-3">1.2 数据组织：分段日志文件</h3>
<p>•每个分区拆分为多个 Segment 文件（默认 1GB），命名格式为「起始偏移量.log」（如 00000000000000000000.log）​，做这个限制目的是为了方便把.log加载到内存去操作</p>
<p>•配套两类索引文件：.index（偏移量→物理地址映射）、.timeindex（时间戳→偏移量映射）​​</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730b9896bc594900819a3c86d89efefc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=ivaklGaephzfSavNgncXwrI4Uqw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>这个9936472之类的数字，就是代表了这个日志段文件里包含的起始offset，也就说明这个分区里至少都写入了接近1000万条数据了。</p>
<p>Kafka broker有一个参数，log.segment.bytes，限定了每个日志段文件的大小，最大就是1GB，一个日志段文件满了，就自动开一个新的日志段文件来写入，避免单个文件过大，影响文件的读写性能，这个过程叫做log rolling，正在被写入的那个日志段文件，叫做active log segment。</p>
<h3 data-id="heading-4">1.3 消息读/写过程</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84e19c96cd441e69db4281f4fe824fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=JLf0F8dw%2BzGIXqtM%2BLD0qwIJdpg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>写消息：</strong></p>
<p>•Index文件写入，Index文件较小，可以直接用mmap进行内存映射，避免频繁的磁盘I/O操作，提高写入性能；由于Index文件是稀疏索引，只需要记录关键位置的偏移量，因此即使使用mmap，写入的开销也相对较低。</p>
<p>•Segment文件写入，Segment文件较大，可以采用普通的写操作（FileChannel.write），由于Segment文件是顺序写入的，并且Kafka会利用操作系统的PageCache（页缓存）机制，写入操作会先写入到内存中，然后由操作系统在后台异步刷新到磁盘，可以进一步提高写入的性能。</p>
<p><strong>读消息：</strong></p>
<p>•Index文件读取，通常使用mmap方式读取，由于Index文件较小，且是稀疏索引，缺页中断的可能性较小。</p>
<p>•Segment文件读取，通常使用sendfile系统调用来实现零拷贝读取和发送，减少数据在用户空间与内核空间之间的拷贝次数，提高数据传输的效率。</p>
<h3 data-id="heading-5">1.4 关键技术</h3>
<p>Kafka 作为高性能的消息中间件，其超高吞吐量的核心秘诀之一就是<strong>深度依赖 PageCache + 顺序 I/O + mmap 内存映射</strong>的组合。</p>
<p>PageCache，中文名称为页高速缓冲存储器。它是将磁盘上的数据加载到内存中，当系统需要访问这些数据时，可以直接从内存中读取，而不必每次都去读取磁盘。这种方式显著减少了磁盘I/O操作，从而提高了系统性能。</p>
<p>mmap（Memory-mapped file）是操作系统提供的一种将<strong>磁盘文件</strong>与<strong>进程虚拟地址空间</strong>建立映射关系的核心技术，本质是让进程通过直接操作内存地址的方式读写文件，无需传统的 read/write 系统调用。核心价值在于<strong>零拷贝</strong>和<strong>内存式文件访问</strong>，尤其适合大文件、高吞吐、随机访问的场景。</p>
<p>将日志段（.log）文件映射到内存，生产者写入时直接写内存（内核异步刷盘），消费者读取时直接从内存读取，实现超高吞吐（Kafka 的 “顺序写 + mmap” 是其高性能核心）；</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8025311968154f9e8ca20594c637af59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=FWIUrpjyB8hG3B%2BMusGW%2Fn5KiJ4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>零拷贝流程示意图</p>
<p>零拷贝过程：</p>
<p>1.用户进程发起sendfile系统调用，<strong>上下文（切换1）从用户态转向内核态</strong></p>
<p>2.DMA控制器，把数据从硬盘中拷贝到内核缓冲区。</p>
<p>3.CPU将读缓冲区中数据拷贝到socket缓冲区</p>
<p>4.DMA控制器，异步把数据从socket缓冲区拷贝到网卡，</p>
<p>5.<strong>上下文（切换2）从内核态切换回用户态</strong>，sendfile调用返回。</p>
<h3 data-id="heading-6">1.5 设计优势</h3>
<p>•顺序写磁盘：Segment 文件仅追加写入，规避随机 IO，吞吐量极高（单分区可达 10 万 + TPS）​​</p>
<p>•索引轻量化：仅维护偏移量与时间戳索引，降低存储开销​</p>
<p>•副本同步：基于 ISR 机制，仅同步已提交消息，兼顾一致性与可用性</p>
<h2 data-id="heading-7">二、RocketMQ存储架构</h2>
<p>Kafka的每个Partition都是一个完整的、顺序写入的文件，但当Partition数量增多时，从操作系统的角度看，这些写入操作会变得相对随机，这可能会影响写入性能。</p>
<h3 data-id="heading-8">2.1 核心存储模型：分离式设计</h3>
<p>RocketMQ采用「CommitLog + ConsumeQueue + IndexFile」三层结构，彻底分离数据存储与索引查询：​</p>
<p>•CommitLog：全局单一日志文件（默认 1GB / 个，循环覆盖），存储所有主题的原始消息​​</p>
<p>•ConsumeQueue：按主题 - 队列维度拆分的索引文件，存储「消息物理地址 + 偏移量 + 长度」，供消费者快速查询​</p>
<p>•IndexFile：哈希索引文件，支持按消息 Key 查询</p>
<p>CommitLog：消息的原始日记本</p>
<p><strong>CommitLog</strong>是RocketMQ存储消息的物理文件，所有消息都会按到达顺序写入这个文件。你可以把它想象成一本不断追加的日记本——每条消息都是按时间顺序记录的新日记。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 消息存储的核心逻辑简化示例（非源码）</span>
 public void <span class="hljs-built_in">putMessage</span>(Message message) {
     <span class="hljs-comment">// 1. 将消息序列化为字节数组</span>
     byte<span class="hljs-selector-attr">[]</span> data = <span class="hljs-built_in">serialize</span>(message);
     <span class="hljs-comment">// 2. 计算消息物理偏移量</span>
     long offset = commitLog<span class="hljs-selector-class">.getMaxOffset</span>();
     <span class="hljs-comment">// 3. 将数据追加到CommitLog文件末尾</span>
     commitLog<span class="hljs-selector-class">.append</span>(data);
     <span class="hljs-comment">// 4. 返回消息的全局唯一物理偏移量</span>
     return offset;
}
</code></pre>
<p>消息写入CommitLog时有三个关键特性：</p>
<p>1.<strong>顺序写入</strong>：所有消息按到达顺序追加到文件末尾，避免磁盘随机寻址</p>
<p>2.<strong>内存映射</strong>：通过MappedByteBuffer实现文件映射，减少数据拷贝次数</p>
<p>3.<strong>文件分割</strong>：单个CommitLog文件默认1GB，写满后创建新文件（文件名用起始偏移量命名）</p>
<p>举个例子，当生产者发送三条消息时，CommitLog文件可能长这样：</p>
<pre><code class="hljs language-ini" lang="ini">0000000000000000000（文件1，1GB）  
2|--消息A(<span class="hljs-attr">offset</span>=<span class="hljs-number">0</span>)  
3|--消息B(<span class="hljs-attr">offset</span>=<span class="hljs-number">100</span>)  
4|--消息C(<span class="hljs-attr">offset</span>=<span class="hljs-number">200</span>)  
500000000001073741824（文件2，起始偏移量1073741824）  
</code></pre>
<p><strong>温馨提示</strong>：虽然CommitLog是顺序写，但读取时需要配合索引结构，否则遍历文件找消息就像大海捞针。</p>
<p>消费队列ConsumeQueue：消息的快速目录</p>
<p>如果每次消费都要扫描CommitLog，性能会惨不忍睹。于是RocketMQ设计了<strong>ConsumeQueue</strong>——它是基于Topic和Queue的二级索引文件。</p>
<p>每个ConsumeQueue条目包含三个关键信息（固定20字节）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">1</span>| CommitLog <span class="hljs-title function_">Offset</span> <span class="hljs-params">(<span class="hljs-number">8</span>字节)</span> | Message <span class="hljs-title function_">Size</span> <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span> | Tag <span class="hljs-title function_">Hashcode</span> <span class="hljs-params">(<span class="hljs-number">8</span>字节)</span> |  
</code></pre>
<p>这相当于给CommitLog里的消息做了一个目录：</p>
<pre><code class="hljs language-lua" lang="lua">TopicA-Queue0的ConsumeQueue  
<span class="hljs-number">2</span>|<span class="hljs-comment">--0（对应CommitLog偏移0的消息A）  </span>
<span class="hljs-number">3</span>|<span class="hljs-comment">--100（对应CommitLog偏移100的消息B）  </span>
<span class="hljs-number">4</span>|<span class="hljs-comment">--200（对应CommitLog偏移200的消息C）</span>
</code></pre>
<p>当消费者拉取TopicA-Queue0的消息时：</p>
<p>1.先查ConsumeQueue获取消息的物理位置</p>
<p>2.根据CommitLog Offset直接定位到CommitLog文件</p>
<p>3.读取指定位置的消息内容</p>
<p><strong>关键设计点</strong>：</p>
<p>•ConsumeQueue采用内存映射+异步刷盘，保证高性能</p>
<p>•单个文件存储30万条索引，约5.72MB（30万*20字节）</p>
<p>•通过hashCode快速过滤Tag，实现消息过滤</p>
<p>索引文件IndexFile：消息的全局字典</p>
<p>如果需要根据MessageID或Key查询消息，ConsumeQueue就不够用了。这时候就要用到<strong>IndexFile</strong>这个全局索引。</p>
<p>IndexFile的结构类似HashMap：</p>
<p>1.<strong>Slot槽位</strong>（500万个）：存储相同hash值的Index条目链表头</p>
<p>2.<strong>Index条目</strong>（2000万条）：包含Key的hash值、CommitLog偏移量、时间差等信息</p>
<p>当写入消息时：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 索引构建过程简化示意</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">buildIndex</span><span class="hljs-params">(Message message)</span> </span>{
    <span class="hljs-comment">// 计算Key的hash值</span>
    <span class="hljs-type">int</span> hash = <span class="hljs-built_in">hash</span>(message.<span class="hljs-built_in">getKey</span>());
    <span class="hljs-comment">// 定位到对应的Slot槽位</span>
    <span class="hljs-type">int</span> slotPos = hash % slotNum;
    <span class="hljs-comment">// 在Index区域追加新条目</span>
    indexFile.<span class="hljs-built_in">addEntry</span>(hash, message.<span class="hljs-built_in">getCommitLogOffset</span>());
}
</code></pre>
<p>查询时通过两次查找快速定位：</p>
<p>1.根据Key的hash值找到Slot槽位</p>
<p>2.遍历Slot对应的链表，比对CommitLog中的实际Key值</p>
<p><strong>性能优化必知</strong>：</p>
<p>•消息体积差异大时，CommitLog仍然保持顺序写，但ConsumeQueue可能出现「稀疏索引」（相邻索引指向的物理位置间隔大）</p>
<p>•生产环境中CommitLog建议放在单独SSD磁盘，ConsumeQueue和IndexFile可放普通磁盘</p>
<p>•遇到消息堆积时，优先检查消费者速度，而不是无脑扩容Broker存储</p>
<p>理解这些底层机制，下次遇到消息查询性能问题或者磁盘IO瓶颈时，就知道该从CommitLog的写入模式还是ConsumeQueue的索引结构入手排查了。</p>
<h3 data-id="heading-9">2.2 数据流转机制</h3>
<p>•生产者写入 CommitLog，生成全局唯一偏移量（PHYOFFSET）​</p>
<p>•后台线程异步构建 ConsumeQueue 索引，同步消息元数据​</p>
<p>•消费者通过 ConsumeQueue 定位 CommitLog 中的消息，避免全量扫描</p>
<p>存储过程全景图</p>
<p>现在把各个模块串起来看消息的生命周期：</p>
<p>1.生产者发送消息到Broker</p>
<p>2.Broker将消息<strong>顺序写入CommitLog</strong></p>
<p>3.<strong>异步线程</strong>同时构建ConsumeQueue和IndexFile</p>
<p>4.消费者通过ConsumeQueue快速定位消息</p>
<p>5.按需查询IndexFile实现消息回溯</p>
<p>整个过程就像图书馆的管理系统：</p>
<p>•CommitLog是藏书库（按入库时间摆放）</p>
<p>•ConsumeQueue是分类目录（按题材/出版社分类）</p>
<p>•IndexFile是检索电脑（支持按书名/作者查询）</p>
<h3 data-id="heading-10">2.4 设计优势</h3>
<p>•读写分离：CommitLog 仅负责写入，ConsumeQueue 负责查询，提升并发性能​</p>
<p>•事务支持：通过 CommitLog 中的事务状态标记 + 回查机制，实现分布式事务消息​</p>
<p>•刷盘策略：支持「异步刷盘（高吞吐）」「同步刷盘（金融级可靠性）」动态切换</p>
<h2 data-id="heading-11">三、JMQ存储架构</h2>
<p>JMQ的消息存储分别参考了Kafka和RocketMQ存储设计上优点，并根据京东内部的应用场景进行了改进和创新。</p>
<h3 data-id="heading-12">3.1 核心存储模型：分区日志 + 队列兼容</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2c49ebef1454ecfa3eb5dc914d8e9b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=%2FMKq95%2FkKgWD%2BV9ypnTsgfXuzg8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>JMQ</strong>存储的基本单元是PartitionGroup。在同一个Broker上，每个PartitionGroup对应一组消息文件（Journal Files），顺序存放这个Topic的消息。</p>
<p>与Kafka类似，每个Topic包含若干Partition，每个Partition对应一组索引文件（Index Files），索引中存放消息在消息文件中的位置和消息长度。消息写入时，收到的消息按照对应的PartitionGroup写入依次追加写入消息文件中，然后异步创建索引并写入对应Partition的索引文件中。</p>
<p>以PartionGroup为基本存储单元的设计，在兼顾灵活性的同时，具有较好的性能，并且单个PartitionGroup可以支持更多的并发。</p>
<h3 data-id="heading-13">3.2 消息读/写过程</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65797ed9958e496ab45de3f081747403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889319&amp;x-signature=tUNZo5%2F%2BVu7XYsMj9wYFq1wEXyA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>写消息：</strong></p>
<p>JMQ的写操作使用DirectBuffer作为缓存，数据先写入DirectBuffer，再异步通过FileChannel写入到文件中。</p>
<p>•消息写入DirectBuffer后，默认写入该节点成功（数据的高可靠是通过Raft协议复制，用多个内存副本来保证），相对Kafka的写操作来看，JMQ响应写入请求的处理过程没有发生系统调用，在京东内部的大量单条同步发送的场景下开销更低、性能更优。</p>
<p>•同时也避免使用MappedByteBuffer（Mmap方式）产生Page Fault中断，OS在中断中将该页对应磁盘中的数据拷贝到内存中，在对文件进行追加写入的情况下，这一无法避免的过程是完全没有必要，反而增加了写入的耗时的问题。</p>
<p><strong>读消息：</strong></p>
<p>JMQ采用定长稠密索引设计，每个索引固定长度。</p>
<p>•定长设计的好处是，直接根据索引序号就可以计算出索引在文件中的位置：索引位置 = 索引序号 * 索引长度。这样，消息的查找过程就比较简单了，首先计算出索引所在的位置，直接读取索引，然后根据索引中记录的消息位置读取消息。</p>
<p>•在京东内部应用场景中，单条消息处理耗时高是比较常见的，微服务架构下用户一般会申请更多的消费节点，让每个消费节点单次拉取较小批量的消息进行处理，以提升消费并行度，这样消费拉取请求的次数会比较多，稠密索引的设计会更适用内部的应用场景。</p>
<p>JMQ消费读操作99%以上都能命中缓存（JMQ设计的堆外内存与文件映射的一种缓存机制），避免了Kafka可能遇到的Cache被污染，影响性能和吞吐的问题。同时直接读内存也规避了RocketMQ在读取消息存储的日志数据文件时容易产生较多的随机访问读取磁盘，影响性能的问题。（当没有命中缓存时，会默认降级为通过Mmap的方式读取消息）。</p>
<h2 data-id="heading-14">四、竞品对比分析</h2>













































<table><thead><tr><th>﻿</th><th><strong>JMQ</strong></th><th><strong>Kafka</strong></th></tr></thead><tbody><tr><td><strong>存储模型</strong></td><td>以<strong>PartitionGroup</strong>为基本存储单元，支持高并发写入</td><td>以<strong>Partition</strong>为基本存储单元，支持灵活的数据复制和迁移</td></tr><tr><td><strong>消息写入性能</strong></td><td>- 单副本异步写入性能与 Kafka 相当 - 三副本异步写入性能优于 Kafka</td><td>- 单副本异步写入性能与 JMQ 相当 - 三副本异步写入性能略低于 JMQ</td></tr><tr><td><strong>同步写入性能</strong></td><td>- 同步写入性能稳定，几乎不受网络延迟影响</td><td>- 同步写入性能受网络延迟影响较大，稳定性略逊于 JMQ</td></tr><tr><td><strong>多分区性能</strong></td><td>- 多分区异步写入性能与 Kafka 相当 - 同步写入性能略低于 Kafka</td><td>- 多分区同步写入性能更稳定，适合高并发场景</td></tr><tr><td><strong>副本机制</strong></td><td>支持异步复制，副本间数据同步性能较好</td><td>支持异步和同步复制，副本机制成熟，适合复杂部署</td></tr><tr><td><strong>跨机房部署</strong></td><td>- 同步写入性能基本不受影响 - 异步写入性能下降</td><td>- 同步写入性能受网络延迟影响较大 - 异步写入性能下降</td></tr><tr><td><strong>适用场景</strong></td><td>- 对同步写入性能要求高 - 副本异步吞吐要求高 - 大规模微服务集群</td><td>- 复杂分区的高并发同步写入 - 大规模分布式系统 - 多语言生态支持丰富</td></tr></tbody></table>
<p>在单副本场景下，JMQ与Kafka的单机写入性能均十分出色，均可达到网络带宽上限。</p>
<p>然而，在更贴近生产环境的三副本场景中，两者特性出现分化：</p>
<p><strong>JMQ在三副本异步写入下的极限吞吐优势明显，且在跨机房部署时，其同步写入性能表现良好，几乎不受网络延迟影响；而Kafka则在多分区同步写入场景下展现出更稳定的性能，衰减小于JMQ。在大部分异步吞吐场景及不同消息体下的性能趋势上，两者表现相当。</strong></p>
<p>综上所述，JMQ尤其适合对同步写入性能和副本异步吞吐有极高要求的场景，而Kafka在复杂分区的高并发同步写入方面适应性更广。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SPI机制：服务扩展的核心技术]]></title>    <link>https://juejin.cn/post/7594415509607333934</link>    <guid>https://juejin.cn/post/7594415509607333934</guid>    <pubDate>2026-01-13T06:08:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594415509607333934" data-draft-id="7593602686136139802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SPI机制：服务扩展的核心技术"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T06:08:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SPI机制：服务扩展的核心技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:08:48.000Z" title="Tue Jan 13 2026 06:08:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要SPI机制</h2>
<h3 data-id="heading-1">SPI和API的区别是什么</h3>
<p>SPI是一种跟API相对应的反向设计思想：API由实现方确定标准规范和功能，调用方无权做任何干预； 而SPI是由调用方确定标准规范，也就是接口，然后调用方依赖此接口，第三方实现此接口，这样做就可以方便的进行扩展，类似于插件机制，这是SPI出现的需求背景。</p>
<p>SPI ： “接口”位于“调用方”所在的“包”中</p>
<ul>
<li>
<p>概念上更依赖调用方。</p>
</li>
<li>
<p>组织上位于调用方所在的包中。</p>
</li>
<li>
<p>实现位于独立的包中。</p>
</li>
<li>
<p>常见的例子是：插件模式的插件。</p>
</li>
</ul>
<p>API ： “接口”位于“实现方”所在的“包”中</p>
<ul>
<li>
<p>概念上更接近实现方。</p>
</li>
<li>
<p>组织上位于实现方所在的包中。</p>
</li>
<li>
<p>实现和接口在一个包中。</p>
</li>
</ul>
<h3 data-id="heading-2">什么是SPI机制</h3>
<p>SPI（Service Provider Interface），是JDK内置的一种 服务提供发现机制，可以用来启用框架扩展和替换组件，主要是被框架的开发人员使用，例如数据库中的java.sql.Driver接口，不同的厂商可以针对同一接口做出不同的实现，如下图所示，MySQL和PostgreSQL都有不同的实现提供给用户。
而Java的SPI机制可以为某个接口寻找服务实现，Java中SPI机制主要思想是<strong>将装配的控制权移到程序之外</strong>，在模块化设计中这个机制尤其重要，其核心思想就是 <strong>解耦</strong>。</p>
<p>SPI整体机制图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc39590bdd5d40ecab1192c3011a2f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=0gTdm9ZMzo22fG4%2F%2FBO4BcWZnzk%3D" alt="" loading="lazy"/></p>
<ol>
<li>当服务的提供者提供了一种接口的实现之后，需要在classpath下的 META-INF/services/ 目录里创建一个文件，文件名是以<strong>服务接口</strong>命名的，而文件里的内容是这个接口的<strong>具体的实现类</strong>。</li>
<li>当其他的程序需要这个服务的时候，就可以通过查找这个jar包（一般都是以jar包做依赖）的META-INF/services/中的配置文件，配置文件中有接口的具体实现类名，再根据这个类名进行加载实例化，就可以使用该服务了。JDK中查找服务的实现的工具类是：java.util.ServiceLoader。</li>
</ol>
<h2 data-id="heading-3">SPI机制的简单示例</h2>
<p>假设现在需要一个发送消息的服务MessageService，发送消息的实现可能是基于短信、也可能是基于电子邮件、或推送通知发送消息。</p>
<ul>
<li><strong>接口定义</strong>：首先定义一个接口 <code>MessageService</code></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span>;
}
</code></pre>
<ul>
<li><strong>提供两个实现类</strong>：一个通过短信发送消息，一个通过电子邮件发送消息。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 短信发送实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsMessageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"Sending SMS: "</span> + message);
    }
}

<span class="hljs-comment">// 电子邮件发送实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailMessageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"Sending Email: "</span> + message);
    }
}
</code></pre>
<ul>
<li><strong>配置文件</strong>：在 <code>META-INF/services/</code> 目录下创建一个配置文件，文件名为 <code>MessageService</code> ，全限定名 <code>com.example.MessageService</code>，文件内容为接口的实现类的全限定名。</li>
</ul>
<pre><code class="hljs language-java" lang="java"># 文件: META-INF/services/com.seven.MessageService
com.seven.SmsMessageService
com.seven.EmailMessageService
</code></pre>
<ul>
<li><strong>加载服务实现</strong>：在应用程序中，通过 <code>ServiceLoader</code> 动态加载并使用这些实现类。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        ServiceLoader&lt;MessageService&gt; loader = ServiceLoader.load(MessageService.class);

        <span class="hljs-keyword">for</span> (MessageService service : loader) {
            service.sendMessage(<span class="hljs-string">"Hello, SPI!"</span>);
        }
    }
}
</code></pre>
<p>运行时，<code>ServiceLoader</code> 会发现并加载配置文件中列出的所有实现类，并依次调用它们的 <code>sendMessage</code> 方法。</p>
<p>由于在 配置文件 写了两个实现类，因此两个实现类都会执行 sendMessage 方法。</p>
<p>这就是因为ServiceLoader.load(Search.class)在加载某接口时，会去 META-INF/services 下找接口的全限定名文件，再根据里面的内容加载相应的实现类。</p>
<p>这就是spi的思想，接口的实现由provider实现，provider只用在提交的jar包里的META-INF/services下根据平台定义的接口新建文件，并添加进相应的实现类内容就好。</p>
<h2 data-id="heading-4">SPI机制的应用</h2>
<h3 data-id="heading-5">JDBC DriverManager</h3>
<p>在JDBC4.0之前，开发连接数据库的时候，通常会用<code>Class.forName("com.mysql.jdbc.Driver")</code>这句先加载数据库相关的驱动，然后再进行获取连接等的操作。而JDBC4.0之后不需要用<code>Class.forName("com.mysql.jdbc.Driver")</code>来加载驱动，直接获取连接就可以了，原因就是现在使用了Java的SPI扩展机制来实现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c85677d74aaa4af5afa2748ef2c6484a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=AeHC76Ms6Mgy2IMHayYaVHVnEUE%3D" alt="" loading="lazy"/></p>
<p>如上图所示：</p>
<ol>
<li>首先在java中定义了接口 java.sql.Driver，并没有具体的实现，具体的实现都是由不同厂商来提供的。</li>
<li>在mysql的jar包mysql-connector-java-8.0.26.jar中，可以找到 META-INF/services 目录，该目录下会有一个名字为 java.sql.Driver 的文件，文件内容是com.mysql.cj.jdbc.Driver，这里面的内容就是mysql针对Java中定义的接口的实现。</li>
<li>同样在ojdbc的jar包ojdbc11.jar中，也可以找到同样的配置文件，文件内容是 oracle.jdbc.OracleDriver，这是oracle数据库对Java的java.sql.Driver的实现。</li>
</ol>
<h4 data-id="heading-6">使用方法</h4>
<p>而现在Java中写连接数据库的代码的时候，不需要再使用<code>Class.forName("com.mysql.jdbc.Driver")</code>来加载驱动了，直接获取连接就可以了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:xxxx://xxxx:xxxx/xxxx"</span>;
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);
.....
</code></pre>
<p>这里并没有涉及到spi的使用，看下面源码。</p>
<h4 data-id="heading-7">源码实现</h4>
<p>上面的使用方法，就是普通的连接数据库的代码，实际上并没有涉及到 SPI 的东西，但是有一点可以确定的是，我们没有写有关具体驱动的硬编码<code>Class.forName("com.mysql.jdbc.Driver")</code>！</p>
<p>而上面的代码就可以直接获取数据库连接进行操作，但是跟SPI有啥关系呢？
既然上面代码没有加载驱动的代码，那实际上是怎么去确定使用哪个数据库连接的驱动呢？</p>
<p>这里就涉及到使用Java的SPI 扩展机制来查找相关驱动的东西了，关于驱动的查找其实都在DriverManager中，DriverManager是Java中的实现，用来获取数据库连接，源码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverManager</span> {

    <span class="hljs-comment">// 存放注册的jdbc驱动</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * Load the initial JDBC drivers by checking the System property
     * jdbc.properties and then use the {<span class="hljs-doctag">@code</span> ServiceLoader} mechanism
     */</span>
    <span class="hljs-keyword">static</span> {
        loadInitialDrivers();
        println(<span class="hljs-string">"JDBC DriverManager initialized"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadInitialDrivers</span><span class="hljs-params">()</span> {
        String drivers;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从JVM -D参数读取jdbc驱动</span>
            drivers = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;String&gt;() {
                <span class="hljs-keyword">public</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">"jdbc.drivers"</span>);
                }
            });
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            drivers = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// If the driver is packaged as a Service Provider, load it.</span>
        <span class="hljs-comment">// Get all the drivers through the classloader</span>
        <span class="hljs-comment">// exposed as a java.sql.Driver.class service.</span>
        <span class="hljs-comment">// ServiceLoader.load() replaces the sun.misc.Providers()</span>

        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Void&gt;() {
            <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {

                ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();

                <span class="hljs-comment">/* Load these drivers, so that they can be instantiated.
                 * It may be the case that the driver class may not be there
                 * i.e. there may be a packaged driver with the service class
                 * as implementation of java.sql.Driver but the actual class
                 * may be missing. In that case a java.util.ServiceConfigurationError
                 * will be thrown at runtime by the VM trying to locate
                 * and load the service.
                 *
                 * Adding a try catch block to catch those runtime errors
                 * if driver not available in classpath but it's
                 * packaged as service and that service is there in classpath.
                 */</span>
                <span class="hljs-keyword">try</span>{
                    <span class="hljs-comment">// 加载创建所有Driver</span>
                    <span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
                        <span class="hljs-comment">// 触发Driver的类加载-&gt;在静态代码块中创建Driver对象并放到DriverManager</span>
                        driversIterator.next();
                    }
                } <span class="hljs-keyword">catch</span>(Throwable t) {
                <span class="hljs-comment">// Do nothing</span>
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        });

        println(<span class="hljs-string">"DriverManager.initialize: jdbc.drivers = "</span> + drivers);

        <span class="hljs-keyword">if</span> (drivers == <span class="hljs-literal">null</span> || drivers.equals(<span class="hljs-string">""</span>)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 解析JVM参数的jdbc驱动</span>
        String[] driversList = drivers.split(<span class="hljs-string">":"</span>);
        println(<span class="hljs-string">"number of Drivers:"</span> + driversList.length);
        <span class="hljs-keyword">for</span> (String aDriver : driversList) {
            <span class="hljs-keyword">try</span> {
                println(<span class="hljs-string">"DriverManager.Initialize: loading "</span> + aDriver);
                <span class="hljs-comment">// initial为ture </span>
                <span class="hljs-comment">// 触发Driver的类加载-&gt;在静态代码块中创建Driver对象并放到DriverManager</span>
                Class.forName(aDriver, <span class="hljs-literal">true</span>,
                        ClassLoader.getSystemClassLoader());
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                println(<span class="hljs-string">"DriverManager.Initialize: load failed: "</span> + ex);
            }
        }
    }

}
</code></pre>
<p>上面的代码主要步骤是：</p>
<ol>
<li>从系统变量中获取有关驱动的定义。</li>
<li>使用SPI来获取驱动的实现。</li>
<li>遍历使用SPI获取到的具体实现，实例化各个实现类。</li>
<li>根据第一步获取到的驱动列表来实例化具体实现类。</li>
</ol>
<ul>
<li>第二步：使用SPI来获取驱动的实现，对应的代码是：</li>
</ul>
<pre><code class="hljs language-java" lang="java">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
</code></pre>
<p>这里封装了接口类型和类加载器，并初始化了一个迭代器。</p>
<ul>
<li>第三步：遍历获取到的具体实现，实例化各个实现类，对应的代码如下：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//获取迭代器</span>
Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();
<span class="hljs-comment">//遍历所有的驱动实现</span>
<span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
    driversIterator.next();
}
</code></pre>
<p>在遍历的时候，首先调用driversIterator.hasNext()方法，这里会搜索classpath下以及jar包中所有的META-INF/services目录下的java.sql.Driver文件，并找到文件中的实现类的名字，此时并没有实例化具体的实现类（ServiceLoader具体的源码实现在下面）。</p>
<p>然后是调用driversIterator.next();方法，此时就会根据驱动名字具体实例化各个实现类了。现在驱动就被找到并实例化了。</p>
<h3 data-id="heading-8">Common-Logging</h3>
<p>common-logging（也称Jakarta Commons Logging，缩写 JCL）是常用的日志库门面， 使用了SPI的方式来动态加载和配置日志实现。这种机制允许库在运行时找到合适的日志实现，而无需硬编码具体的日志库。</p>
<p>我们看下它是怎么通过SPI解耦的。</p>
<p>首先，日志实例是通过LogFactory的getLog(String)方法创建的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getLog</span><span class="hljs-params">(Class clazz)</span> <span class="hljs-keyword">throws</span> LogConfigurationException {
    <span class="hljs-keyword">return</span> getFactory().getInstance(clazz);
}
</code></pre>
<p>LogFatory是一个抽象类，它负责加载具体的日志实现，getFactory()方法源码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.commons.logging.LogFactory <span class="hljs-title function_">getFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LogConfigurationException {
    <span class="hljs-comment">// Identify the class loader we will be using</span>
    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">contextClassLoader</span> <span class="hljs-operator">=</span> getContextClassLoaderInternal();

    <span class="hljs-keyword">if</span> (contextClassLoader == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// This is an odd enough situation to report about. This</span>
        <span class="hljs-comment">// output will be a nuisance on JDK1.1, as the system</span>
        <span class="hljs-comment">// classloader is null in that environment.</span>
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"Context classloader is null."</span>);
        }
    }

    <span class="hljs-comment">// Return any previously registered factory for this class loader</span>
    org.apache.commons.logging.<span class="hljs-type">LogFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> getCachedFactory(contextClassLoader);
    <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> factory;
    }

    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
        logDiagnostic(
                <span class="hljs-string">"[LOOKUP] LogFactory implementation requested for the first time for context classloader "</span> +
                        objectId(contextClassLoader));
        logHierarchy(<span class="hljs-string">"[LOOKUP] "</span>, contextClassLoader);
    }

    <span class="hljs-comment">// classpath根目录下寻找commons-logging.properties</span>
    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> getConfigurationFile(contextClassLoader, FACTORY_PROPERTIES);

    <span class="hljs-comment">// Determine whether we will be using the thread context class loader to</span>
    <span class="hljs-comment">// load logging classes or not by checking the loaded properties file (if any).</span>
    <span class="hljs-comment">// classpath根目录下commons-logging.properties是否配置use_tccl</span>
    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">baseClassLoader</span> <span class="hljs-operator">=</span> contextClassLoader;
    <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">String</span> <span class="hljs-variable">useTCCLStr</span> <span class="hljs-operator">=</span> props.getProperty(TCCL_KEY);
        <span class="hljs-keyword">if</span> (useTCCLStr != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (Boolean.valueOf(useTCCLStr).booleanValue() == <span class="hljs-literal">false</span>) {
                baseClassLoader = thisClassLoader;
            }
        }
    }

    <span class="hljs-comment">// 这里真正开始决定使用哪个factory</span>
    <span class="hljs-comment">// 首先，尝试查找vm系统属性org.apache.commons.logging.LogFactory，其是否指定factory</span>
    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
        logDiagnostic(<span class="hljs-string">"[LOOKUP] Looking for system property ["</span> + FACTORY_PROPERTY +
                <span class="hljs-string">"] to define the LogFactory subclass to use..."</span>);
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">factoryClass</span> <span class="hljs-operator">=</span> getSystemProperty(FACTORY_PROPERTY, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (factoryClass != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] Creating an instance of LogFactory class '"</span> + factoryClass +
                        <span class="hljs-string">"' as specified by system property "</span> + FACTORY_PROPERTY);
            }
            factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] No system property ["</span> + FACTORY_PROPERTY + <span class="hljs-string">"] defined."</span>);
            }
        }
    } <span class="hljs-keyword">catch</span> (SecurityException e) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] A security exception occurred while trying to create an"</span> +
                    <span class="hljs-string">" instance of the custom factory class"</span> + <span class="hljs-string">": ["</span> + trim(e.getMessage()) +
                    <span class="hljs-string">"]. Trying alternative implementations..."</span>);
        }
        <span class="hljs-comment">// ignore</span>
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] An exception occurred while trying to create an"</span> +
                    <span class="hljs-string">" instance of the custom factory class"</span> + <span class="hljs-string">": ["</span> +
                    trim(e.getMessage()) +
                    <span class="hljs-string">"] as specified by a system property."</span>);
        }
        <span class="hljs-keyword">throw</span> e;
    }

    <span class="hljs-comment">// 第二，尝试使用java spi服务发现机制，在META-INF/services下寻找org.apache.commons.logging.LogFactory实现</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(<span class="hljs-string">"[LOOKUP] Looking for a resource file of name ["</span> + SERVICE_ID +
                    <span class="hljs-string">"] to define the LogFactory subclass to use..."</span>);
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// META-INF/services/org.apache.commons.logging.LogFactory, SERVICE_ID</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> getResourceAsStream(contextClassLoader, SERVICE_ID);

            <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// This code is needed by EBCDIC and other strange systems.</span>
                <span class="hljs-comment">// It's a fix for bugs reported in xerces</span>
                BufferedReader rd;
                <span class="hljs-keyword">try</span> {
                    rd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is, <span class="hljs-string">"UTF-8"</span>));
                } <span class="hljs-keyword">catch</span> (java.io.UnsupportedEncodingException e) {
                    rd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is));
                }

                <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassName</span> <span class="hljs-operator">=</span> rd.readLine();
                rd.close();

                <span class="hljs-keyword">if</span> (factoryClassName != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">""</span>.equals(factoryClassName)) {
                    <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                        logDiagnostic(<span class="hljs-string">"[LOOKUP]  Creating an instance of LogFactory class "</span> +
                                factoryClassName +
                                <span class="hljs-string">" as specified by file '"</span> + SERVICE_ID +
                                <span class="hljs-string">"' which was present in the path of the context classloader."</span>);
                    }
                    factory = newFactory(factoryClassName, baseClassLoader, contextClassLoader);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// is == null</span>
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(<span class="hljs-string">"[LOOKUP] No resource file with name '"</span> + SERVICE_ID + <span class="hljs-string">"' found."</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            <span class="hljs-comment">// note: if the specified LogFactory class wasn't compatible with LogFactory</span>
            <span class="hljs-comment">// for some reason, a ClassCastException will be caught here, and attempts will</span>
            <span class="hljs-comment">// continue to find a compatible class.</span>
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(
                        <span class="hljs-string">"[LOOKUP] A security exception occurred while trying to create an"</span> +
                                <span class="hljs-string">" instance of the custom factory class"</span> +
                                <span class="hljs-string">": ["</span> + trim(ex.getMessage()) +
                                <span class="hljs-string">"]. Trying alternative implementations..."</span>);
            }
            <span class="hljs-comment">// ignore</span>
        }
    }

    <span class="hljs-comment">// 第三，尝试从classpath根目录下的commons-logging.properties中查找org.apache.commons.logging.LogFactory属性指定的factory</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(
                        <span class="hljs-string">"[LOOKUP] Looking in properties file for entry with key '"</span> + FACTORY_PROPERTY +
                                <span class="hljs-string">"' to define the LogFactory subclass to use..."</span>);
            }
            <span class="hljs-type">String</span> <span class="hljs-variable">factoryClass</span> <span class="hljs-operator">=</span> props.getProperty(FACTORY_PROPERTY);
            <span class="hljs-keyword">if</span> (factoryClass != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(
                            <span class="hljs-string">"[LOOKUP] Properties file specifies LogFactory subclass '"</span> + factoryClass + <span class="hljs-string">"'"</span>);
                }
                factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);

                <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> think about whether we need to handle exceptions from newFactory</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                    logDiagnostic(<span class="hljs-string">"[LOOKUP] Properties file has no entry specifying LogFactory subclass."</span>);
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
                logDiagnostic(<span class="hljs-string">"[LOOKUP] No properties file available to determine"</span> + <span class="hljs-string">" LogFactory subclass from.."</span>);
            }
        }
    }

    <span class="hljs-comment">// 最后，使用后备factory实现，org.apache.commons.logging.impl.LogFactoryImpl</span>
    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (isDiagnosticsEnabled()) {
            logDiagnostic(
                    <span class="hljs-string">"[LOOKUP] Loading the default LogFactory implementation '"</span> + FACTORY_DEFAULT +
                            <span class="hljs-string">"' via the same classloader that loaded this LogFactory"</span> +
                            <span class="hljs-string">" class (ie not looking in the context classloader)."</span>);
        }

        factory = newFactory(FACTORY_DEFAULT, thisClassLoader, contextClassLoader);
    }

    <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) {
        cacheFactory(contextClassLoader, factory);

        <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Enumeration</span> <span class="hljs-variable">names</span> <span class="hljs-operator">=</span> props.propertyNames();
            <span class="hljs-keyword">while</span> (names.hasMoreElements()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) names.nextElement();
                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> props.getProperty(name);
                factory.setAttribute(name, value);
            }
        }
    }

    <span class="hljs-keyword">return</span> factory;
}
</code></pre>
<p>可以看出，抽象类LogFactory加载具体实现的步骤如下：</p>
<ol>
<li>从vm系统属性org.apache.commons.logging.LogFactory</li>
<li>使用SPI服务发现机制，发现org.apache.commons.logging.LogFactory的实现</li>
<li>查找classpath根目录commons-logging.properties的org.apache.commons.logging.LogFactory属性是否指定factory实现</li>
<li>使用默认factory实现，org.apache.commons.logging.impl.LogFactoryImpl</li>
</ol>
<p>LogFactory的getLog()方法返回类型是org.apache.commons.logging.Log接口，提供了从trace到fatal方法。可以确定，如果日志实现提供者只要实现该接口，并且使用继承自org.apache.commons.logging.LogFactory的子类创建Log，必然可以构建一个松耦合的日志系统。</p>
<h3 data-id="heading-9">Spring中SPI机制</h3>
<p>在springboot的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fframework%2Fspringboot%2Fprincipleofautomaticassembly.html" target="_blank" title="https://www.seven97.top/framework/springboot/principleofautomaticassembly.html" ref="nofollow noopener noreferrer">自动装配</a>过程中，最终会加载META-INF/spring.factories文件，主要通过以下几个步骤实现：</p>
<ol>
<li><strong>服务接口定义</strong>： Spring 定义了许多服务接口，如 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>。</li>
<li><strong>服务提供者实现</strong>： 各种具体的模块和库会提供这些服务接口的实现，如各种自动配置类。</li>
<li><strong>服务描述文件</strong>： 在实现模块的 JAR 包中，会有一个 <code>META-INF/spring.factories</code> 文件，这个文件中列出了该 JAR 包中实现的自动配置类。</li>
<li><strong>服务加载</strong>： Spring Boot 在启动时加载 <code>spring.factories</code> 文件，并实例化这些文件中列出的实现类。</li>
</ol>
<p>Spring Boot 使用 <code>SpringFactoriesLoader</code> 来加载 <code>spring.factories</code> 文件中列出的所有类，并将它们注册到应用上下文中。需要注意的是，其实这里不仅仅是会去ClassPath路径下查找，会扫描所有路径下的Jar包，只不过这个文件只会在Classpath下的jar包中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FACTORIES_RESOURCE_LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"META-INF/spring.factories"</span>;
<span class="hljs-comment">// spring.factories文件的格式为：key=value1,value2,value3</span>
<span class="hljs-comment">// 从所有的jar包中找到META-INF/spring.factories文件</span>
<span class="hljs-comment">// 然后从文件中解析出key=factoryClass类名称的所有value值</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">loadFactoryNames</span><span class="hljs-params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassName</span> <span class="hljs-operator">=</span> factoryClass.getName();
    <span class="hljs-comment">// 取得资源文件的URL</span>
    Enumeration&lt;URL&gt; urls = (classLoader != <span class="hljs-literal">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));
    List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-comment">// 遍历所有的URL</span>
    <span class="hljs-keyword">while</span> (urls.hasMoreElements()) {
        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> urls.nextElement();
        <span class="hljs-comment">// 根据资源文件URL解析properties文件，得到对应的一组@Configuration类</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> PropertiesLoaderUtils.loadProperties(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(url));
        <span class="hljs-type">String</span> <span class="hljs-variable">factoryClassNames</span> <span class="hljs-operator">=</span> properties.getProperty(factoryClassName);
        <span class="hljs-comment">// 组装数据，并返回</span>
        result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>通过 SPI 机制和 <code>spring.factories</code> 文件的配合，Spring Boot 实现了模块化和自动配置的能力。开发者可以通过定义自动配置类并在 <code>spring.factories</code> 文件中声明它们，从而实现模块的独立和松耦合。这种机制不仅简化了配置和启动过程，还提升了应用的可扩展性和维护性。</p>
<h2 data-id="heading-10">SPI 机制通常怎么使用</h2>
<p>看完上面的几个例子解析，应该都能知道大概的流程了：</p>
<ol>
<li>定义标准：定义标准，就是定义接口。比如接口java.sql.Driver</li>
<li>具体厂商或者框架开发者实现：厂商或者框架开发者开发具体的实现：
在META-INF/services目录下定义一个名字为接口全限定名的文件，比如java.sql.Driver文件，文件内容是具体的实现名字，比如me.cxis.sql.MyDriver。写具体的实现me.cxis.sql.MyDriver，都是对接口Driver的实现。</li>
<li>具体使用：引用具体厂商的jar包来实现我们的功能：</li>
</ol>
<pre><code class="hljs language-java" lang="java">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
<span class="hljs-comment">//获取迭代器</span>
Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();
<span class="hljs-comment">//遍历</span>
<span class="hljs-keyword">while</span>(driversIterator.hasNext()) {
    driversIterator.next();
    <span class="hljs-comment">//可以做具体的业务逻辑</span>
}

</code></pre>
<ol start="4">
<li>使用规范：</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa43475fdb5949c2bb6227e0f44cb443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889327&amp;x-signature=%2BVEvjRf9%2BRJes4bO7%2BmIYdMvXAg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">SPI机制实现原理</h2>
<p>那么问题来了： 怎么样才能加载这些SPI接口的实现类呢，真正的原因是Java的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fjava%2Fjvm%2F01-jvmbasic2-classloadingmechanism.html" target="_blank" title="https://www.seven97.top/java/jvm/01-jvmbasic2-classloadingmechanism.html" ref="nofollow noopener noreferrer">类加载机制</a>！ SPI接口属于java rt核心包，只能由启动类加载器BootStrap classLoader加载，而第三方jar包是用户classPath路径下，根据类加载器的可见性原则：启动类加载器无法加载这些jar包，也就是没法向下委托，所以spi必须打破这种传统的双亲委派机制，通过自定义的类加载器来加载第三方jar包下的spi接口实现类！</p>
<p>JDK中ServiceLoader方法的具体实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//ServiceLoader实现了Iterable接口，可以遍历所有的服务实现者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceLoader</span>&lt;S&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;S&gt;{

    <span class="hljs-comment">//查找配置文件的目录</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"META-INF/services/"</span>;

    <span class="hljs-comment">//表示要被加载的服务的类或接口</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;S&gt; service;

    <span class="hljs-comment">//这个ClassLoader用来定位，加载，实例化服务提供者</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader loader;

    <span class="hljs-comment">// 访问控制上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccessControlContext acc;

    <span class="hljs-comment">// 缓存已经被实例化的服务提供者，按照实例化的顺序存储</span>
    <span class="hljs-keyword">private</span> LinkedHashMap&lt;String,S&gt; providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 迭代器</span>
    <span class="hljs-keyword">private</span> LazyIterator lookupIterator;

    <span class="hljs-comment">//重新加载，就相当于重新创建ServiceLoader了，用于新的服务提供者安装到正在运行的Java虚拟机中的情况。</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reload</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//清空缓存中所有已实例化的服务提供者</span>
        providers.clear();
        <span class="hljs-comment">//新建一个迭代器，该迭代器会从头查找和实例化服务提供者</span>
        lookupIterator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyIterator</span>(service, loader);
    }

    <span class="hljs-comment">//私有构造器</span>
    <span class="hljs-comment">//使用指定的类加载器和服务创建服务加载器</span>
    <span class="hljs-comment">//如果没有指定类加载器，使用系统类加载器，就是应用类加载器。</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ServiceLoader</span><span class="hljs-params">(Class&lt;S&gt; svc, ClassLoader cl)</span> {
        service = Objects.requireNonNull(svc, <span class="hljs-string">"Service interface cannot be null"</span>);
        loader = (cl == <span class="hljs-literal">null</span>) ? ClassLoader.getSystemClassLoader() : cl;
        acc = (System.getSecurityManager() != <span class="hljs-literal">null</span>) ? AccessController.getContext() : <span class="hljs-literal">null</span>;
        reload();
    }

    <span class="hljs-comment">//解析失败处理的方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, String msg, Throwable cause)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConfigurationError</span>(service.getName() + <span class="hljs-string">": "</span> + msg,
                                            cause);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, String msg)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConfigurationError</span>(service.getName() + <span class="hljs-string">": "</span> + msg);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(Class&lt;?&gt; service, URL u, <span class="hljs-type">int</span> line, String msg)</span>
        <span class="hljs-keyword">throws</span> ServiceConfigurationError
    {
        fail(service, u + <span class="hljs-string">":"</span> + line + <span class="hljs-string">": "</span> + msg);
    }

    <span class="hljs-comment">//解析服务提供者配置文件中的一行</span>
    <span class="hljs-comment">//首先去掉注释校验，然后保存</span>
    <span class="hljs-comment">//返回下一行行号</span>
    <span class="hljs-comment">//重复的配置项和已经被实例化的配置项不会被保存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseLine</span><span class="hljs-params">(Class&lt;?&gt; service, URL u, BufferedReader r, <span class="hljs-type">int</span> lc, List&lt;String&gt; names)</span>
        	<span class="hljs-keyword">throws</span> IOException, ServiceConfigurationError{
        <span class="hljs-comment">//读取一行</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">ln</span> <span class="hljs-operator">=</span> r.readLine();
        <span class="hljs-keyword">if</span> (ln == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">//#号代表注释行</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">ci</span> <span class="hljs-operator">=</span> ln.indexOf(<span class="hljs-string">'#'</span>);
        <span class="hljs-keyword">if</span> (ci &gt;= <span class="hljs-number">0</span>) ln = ln.substring(<span class="hljs-number">0</span>, ci);
        ln = ln.trim();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> ln.length();
        <span class="hljs-keyword">if</span> (n != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> ((ln.indexOf(<span class="hljs-string">' '</span>) &gt;= <span class="hljs-number">0</span>) || (ln.indexOf(<span class="hljs-string">'\t'</span>) &gt;= <span class="hljs-number">0</span>))
                fail(service, u, lc, <span class="hljs-string">"Illegal configuration-file syntax"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ln.codePointAt(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (!Character.isJavaIdentifierStart(cp))
                fail(service, u, lc, <span class="hljs-string">"Illegal provider-class name: "</span> + ln);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) {
                cp = ln.codePointAt(i);
                <span class="hljs-keyword">if</span> (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != <span class="hljs-string">'.'</span>))
                    fail(service, u, lc, <span class="hljs-string">"Illegal provider-class name: "</span> + ln);
            }
            <span class="hljs-keyword">if</span> (!providers.containsKey(ln) &amp;&amp; !names.contains(ln))
                names.add(ln);
        }
        <span class="hljs-keyword">return</span> lc + <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">//解析配置文件，解析指定的url配置文件</span>
    <span class="hljs-comment">//使用parseLine方法进行解析，未被实例化的服务提供者会被保存到缓存中去</span>
    <span class="hljs-keyword">private</span> Iterator&lt;String&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(Class&lt;?&gt; service, URL u)</span> <span class="hljs-keyword">throws</span> ServiceConfigurationError{
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        ArrayList&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">try</span> {
            in = u.openStream();
            r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in, <span class="hljs-string">"utf-8"</span>));
            <span class="hljs-type">int</span> <span class="hljs-variable">lc</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> ((lc = parseLine(service, u, r, lc, names)) &gt;= <span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> names.iterator();
    }

    <span class="hljs-comment">//服务提供者查找的迭代器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;S&gt;{

        Class&lt;S&gt; service;<span class="hljs-comment">//服务提供者接口</span>
        ClassLoader loader;<span class="hljs-comment">//类加载器</span>
        Enumeration&lt;URL&gt; configs = <span class="hljs-literal">null</span>;<span class="hljs-comment">//保存实现类的url</span>
        Iterator&lt;String&gt; pending = <span class="hljs-literal">null</span>;<span class="hljs-comment">//保存实现类的全名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">nextName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<span class="hljs-comment">//迭代器中下一个实现类的全名</span>

        <span class="hljs-keyword">private</span> <span class="hljs-title function_">LazyIterator</span><span class="hljs-params">(Class&lt;S&gt; service, ClassLoader loader)</span> {
            <span class="hljs-built_in">this</span>.service = service;
            <span class="hljs-built_in">this</span>.loader = loader;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNextService</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (nextName != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> (configs == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> PREFIX + service.getName();
                    <span class="hljs-keyword">if</span> (loader == <span class="hljs-literal">null</span>)
                        configs = ClassLoader.getSystemResources(fullName);
                    <span class="hljs-keyword">else</span>
                        configs = loader.getResources(fullName);
                }
            }
            <span class="hljs-keyword">while</span> ((pending == <span class="hljs-literal">null</span>) || !pending.hasNext()) {
                <span class="hljs-keyword">if</span> (!configs.hasMoreElements()) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                pending = parse(service, configs.nextElement());
            }
            nextName = pending.next();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">private</span> S <span class="hljs-title function_">nextService</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (!hasNextService())
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();
            <span class="hljs-type">String</span> <span class="hljs-variable">cn</span> <span class="hljs-operator">=</span> nextName;
            nextName = <span class="hljs-literal">null</span>;
            Class&lt;?&gt; c = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
                c = Class.forName(cn, <span class="hljs-literal">false</span>, loader);
            }
            <span class="hljs-keyword">if</span> (!service.isAssignableFrom(c)) {
                fail(service, <span class="hljs-string">"Provider "</span> + cn  + <span class="hljs-string">" not a subtype"</span>);
            }
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">S</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> service.cast(c.newInstance());
                providers.put(cn, p);
                <span class="hljs-keyword">return</span> p;
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (acc == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> hasNextService();
            } <span class="hljs-keyword">else</span> {
                PrivilegedAction&lt;Boolean&gt; action = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Boolean&gt;() {
                    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">run</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> hasNextService(); }
                };
                <span class="hljs-keyword">return</span> AccessController.doPrivileged(action, acc);
            }
        }

        <span class="hljs-keyword">public</span> S <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (acc == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> nextService();
            } <span class="hljs-keyword">else</span> {
                PrivilegedAction&lt;S&gt; action = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;S&gt;() {
                    <span class="hljs-keyword">public</span> S <span class="hljs-title function_">run</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> nextService(); }
                };
                <span class="hljs-keyword">return</span> AccessController.doPrivileged(action, acc);
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
        }

    }

    <span class="hljs-comment">//获取迭代器</span>
    <span class="hljs-comment">//返回遍历服务提供者的迭代器</span>
    <span class="hljs-comment">//以懒加载的方式加载可用的服务提供者</span>
    <span class="hljs-comment">//懒加载的实现是：解析配置文件和实例化服务提供者的工作由迭代器本身完成</span>
    <span class="hljs-keyword">public</span> Iterator&lt;S&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Iterator</span>&lt;S&gt;() {
            <span class="hljs-comment">//按照实例化顺序返回已经缓存的服务提供者实例</span>
            Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders
                = providers.entrySet().iterator();

            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (knownProviders.hasNext())
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">return</span> lookupIterator.hasNext();
            }

            <span class="hljs-keyword">public</span> S <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (knownProviders.hasNext())
                    <span class="hljs-keyword">return</span> knownProviders.next().getValue();
                <span class="hljs-keyword">return</span> lookupIterator.next();
            }

            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
            }

        };
    }

    <span class="hljs-comment">//为指定的服务使用指定的类加载器来创建一个ServiceLoader</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;S&gt; service, ClassLoader loader)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceLoader</span>&lt;&gt;(service, loader);
    }

    <span class="hljs-comment">//使用线程上下文的类加载器来创建ServiceLoader</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;S&gt; service)</span> {
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();
        <span class="hljs-keyword">return</span> ServiceLoader.load(service, cl);
    }

    <span class="hljs-comment">//使用扩展类加载器为指定的服务创建ServiceLoader</span>
    <span class="hljs-comment">//只能找到并加载已经安装到当前Java虚拟机中的服务提供者，应用程序类路径中的服务提供者将被忽略</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">loadInstalled</span><span class="hljs-params">(Class&lt;S&gt; service)</span> {
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();
        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">while</span> (cl != <span class="hljs-literal">null</span>) {
            prev = cl;
            cl = cl.getParent();
        }
        <span class="hljs-keyword">return</span> ServiceLoader.load(service, prev);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"java.util.ServiceLoader["</span> + service.getName() + <span class="hljs-string">"]"</span>;
    }

}
</code></pre>
<ol>
<li><strong>首先</strong>，ServiceLoader实现了Iterable接口，所以它有迭代器的属性，这里主要都是实现了迭代器的 hasNext 和 next 方法。这里主要都是调用的lookupIterator的相应hasNext和next方法，lookupIterator是懒加载迭代器。</li>
<li><strong>其次</strong>，LazyIterator 中的 hasNext 方法，静态变量PREFIX就是”META-INF/services/”目录，这也就是为什么需要在classpath下的META-INF/services/目录里创建一个以服务接口命名的文件。</li>
<li><strong>最后</strong>，通过反射方法Class.forName()加载类对象，并用newInstance方法将类实例化，并把实例化后的类缓存到providers对象中，(LinkedHashMap&lt;String,S&gt;类型）然后返回实例对象。</li>
</ol>
<p>所以可以看到ServiceLoader不是实例化以后，就去读取配置文件中的具体实现，并进行实例化。而是等到使用迭代器去遍历的时候，才会加载对应的配置文件去解析，调用hasNext方法的时候会去加载配置文件进行解析，调用next方法的时候进行实例化并缓存。</p>
<p>所有的配置文件只会加载一次，服务提供者也只会被实例化一次，重新加载配置文件可使用reload方法。</p>
<h2 data-id="heading-12">JDK SPI机制的缺陷</h2>
<p>通过上面的解析，可以发现，我们使用SPI机制的缺陷：</p>
<ul>
<li>
<p>获取某个实现类的方式不够灵活，只能通过 Iterator 形式获取，不能根据某个参数来获取对应的实现类。如果不想用某些实现类，或者某些类实例化很耗时，它也被载入并实例化了，这就造成了浪费。</p>
</li>
<li>
<p>多个并发多线程使用 ServiceLoader 类的实例是不安全的</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东零售广告创意：统一的布局生成和评估模型]]></title>    <link>https://juejin.cn/post/7594514040916688923</link>    <guid>https://juejin.cn/post/7594514040916688923</guid>    <pubDate>2026-01-13T06:09:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594514040916688923" data-draft-id="7594415509607317550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东零售广告创意：统一的布局生成和评估模型"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:09:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东零售广告创意：统一的布局生成和评估模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:36.000Z" title="Tue Jan 13 2026 06:09:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：冯伟</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1979a23781d4a23979bcbbfdd09c49a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=4ADkuRzvrJaCUKh0%2FaSWiB8sxSg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>MM2025: Uni-Layout: Integrating Human Feedback in Unified Layout Generation and Evaluation</p>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2508.02374" target="_blank" title="https://arxiv.org/abs/2508.02374" ref="nofollow noopener noreferrer">arxiv.org/abs/2508.02…</a>﻿</p>
<p>代码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJD-GenX%2FUni-Layout" target="_blank" title="https://github.com/JD-GenX/Uni-Layout" ref="nofollow noopener noreferrer">github.com/JD-GenX/Uni…</a>﻿</p>
<p>﻿</p>
<p>摘要：布局生成在电商图片的设计中起到至关重要的作用。当前的布局生成方法在能力上具有任务特定性，并且评估标准与人类感知不一致，导致其应用范围有限且评估效果不佳。为了解决这些问题，Uni-Layout实现了统一生成、模拟人类的评估以及二者之间的对齐。针对通用生成，该框架将各种布局任务整合到一个统一的分类系统中，并开发了一个统一的生成器，通过自然语言提示处理背景或元素内容受限的任务。为了引入人类反馈以有效评估布局，我们构建了Layout-HF100k，这是首个包含10万个人工标注布局的大规模人类反馈数据集。基于Layout-HF100k，我们引入了一种模拟人类的评估器，该评估器结合视觉和几何信息，采用思维链机制进行定性评估，并通过信心估计模块提供定量测量。为了更好地对齐生成器和评估器，我们采用动态边距偏好优化（DMPO）技术，将二者整合为一个协调系统，以更好地符合人类判断。</p>
<h2 data-id="heading-0">一、背景及现状</h2>
<p>布局生成旨在为给定的元素设计吸引人的视觉排版，涵盖从海报和文档设计到用户界面布局和杂志排版等广泛任务。虽然生成模型取得了显著进展，但现有方法通常专注于狭义任务，导致解决方案缺乏灵活性和普适性。此外，尽管现有的评估指标基于布局设计原则精心设计，但它们常常与人类的感知不一致。如图1所示，高评分的布局可能在视觉质量上较差，这揭示了现有指标与真实人类感知之间的差距。为了解决这些挑战，我们提出了Uni-Layout，一个通过统一生成器、模拟人类的评估器和动态边距对齐机制来整合布局生成、评估和对齐的整体框架。为了详细阐述Uni-Layout，本文围绕三个核心研究问题展开。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d390e83d1604ceebddcf9adf9081a19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=HSQfanmk4vFHI95SRMwaytmOFl4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图1：布局生成任务的分类体系与动机阐述</p>
<h2 data-id="heading-1">二、如何实现跨任务的统一布局生成？</h2>
<p>为了系统地统一当前分散的布局生成任务领域，我们提出了一个基于两个维度的精心组织的分类法：背景和元素内容是自由的还是受限的。如图1所示，我们将现有的布局任务分为四种代表性类型：BFEF、BCEF、BFEC和BCEC。当前的任务特定方法在统一布局生成方面存在困难，但多模态大型语言模型（MLLMs）由于其通用的视觉-语言理解能力，提供了有前景的解决方案。利用MLLMs，我们提出了一个统一的布局生成器，其工作方式类似于一名熟练的设计师。该生成器结合视觉约束和文本指令来生成连贯的布局，能够处理背景和元素内容既可以受限也可以自由的多种场景。通过在各种布局任务上的联合训练，它为布局生成提供了一个灵活且统一的解决方案。</p>
<p>为了统一多种布局任务，一个通用的布局任务指令可写作：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48fec20f7d6e4acc93b3e08246dd6c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=8Xh%2BQLqx2eoTySMX%2F%2F%2FFpJBP4hw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中T为任务描述，b表示背景的内容和属性，e表示元素的内容和属性，O是指定的输出格式。注意背景和元素的属性是必须的，但其内容可为空。为了清楚起见，我们针对BCEC任务提供了一个说明示例，其中下划线部分对应上式中的对应项。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f1ff5f4a07c462bb748dfb7f580d871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=TVEJMnzEIPR81D8Ub4fmyLOpYyo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-2">三、如何模拟人类来评估布局？</h2>
<p>尽管人类感知在布局设计中非常重要，但现有数据集中缺乏对布局质量的人类反馈。为弥补这一缺口，我们汇总了统一生成器的输出，并编制了Layout-HF100k，这是首个专为布局生成策划的全面人类反馈数据集，包含10万个精心标注的高质量示例，涵盖代表性布局任务。该数据集的示例如图2所示。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f486b516de23439bb1a9670f841a30f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=USEpMWPVfwDorbt4VziY3ccVcQk%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图2：Layout-HF100k示例。第一/二行分别为合格/不合格布局。</p>
<p>基于这一全新的数据集，我们开发了一种评估器，结构如图3（b）和（c）所示。其通过视觉和几何信息两个分支处理布局，以有效模拟人类判断模式。此外，该评估器结合了一个输出定量置信度估计的分类头，以及定性“思维链”（CoT）推理，使其能够捕捉微妙的审美偏好，并提供与人类感知模式紧密对齐的可解释评估。通过结合多模态分析和CoT推理，我们的评估器不仅能够做出准确判断，还能阐明其决策背后的理由，类似于人类专家如何评估布局。</p>
<p>具体来说，CoT包含以下四个步骤：</p>
<p>(1) 布局概览：对布局可视化结果快速而全面的扫描，通过简洁的文本描述捕捉布局的第一印象，概述整体构图和上下文元素。</p>
<p>(2) 空间解构：系统地分解布局的基本组成部分，分析几何属性和空间关系。它检查对齐模式、识别潜在重叠，并评估间距一致性，以揭示潜在的结构框架。</p>
<p>(3) 美学评估：对布局的视觉质量进行详细评估，重点关注艺术价值和设计原则。这包括对比例平衡、空间和谐和视觉节奏的评估，同时考虑这些元素如何对整体美学效果产生影响。</p>
<p>(4) 全面评估：最后阶段综合所有先前分析的见解，以提供对布局有效性的全面评估，最后给出“合格”或“不合格”的明确判断。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4126fe4426904eb9bccecaf83aa4f30e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=FToOYhNRsC96qYDH0%2FxnJ%2F6nzUc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图3：Uni-Layout框架概览</p>
<h2 data-id="heading-3">四、如何有效对齐人类反馈和布局生成？</h2>
<p>现有的对齐方法要么直接最大化人类偏好的输出可能性，要么在其偏好学习目标中使用固定边距。这些传统方法未能反映人类偏好的不同程度，因为它们对强偏好和弱偏好一视同仁。为了解决这一限制，我们提出了一种新的对齐方法，称为动态边距偏好优化（DMPO）。具体而言，当评估者在成对样本之间表现出更强烈的偏好时，DMPO会自动增加边距，以在胜出和失败的响应之间强制产生更大的分数差异，而对于不太明显的偏好则应用较小的边距。这种信心引导的自适应边距策略更好地捕捉了人类判断的范围，从而实现与布局生成和人类偏好的更精确对齐。</p>
<p>如图3（d）所示，给定任务指令和可选的背景或元素内容，生成器产生两个候选布局l1和l2。之后通过双分支处理器将布局结果转化为视觉和几何信息，并通过布局评估器产出候选布局的得分。我们将两种布局的分数差距定义如下：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f79f8947ff145f688a58360fb7e2db9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=Ye1INJAol8YWK6kmFPzp68YLTEc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627f4a8d776341bfaa4c19437970ed30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=8PieKGvMXBMbfw4Mm4VQ2uAaPm0%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中I+和l+分别表示高分布局的视觉和几何信息。为了进一步增强对边距的感知，我们应用了非线性变换f()来处理分数差距。最终，DMPO的损失形式可写作：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f95501589ab462d9fb1e1cfed813ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=caPyI905OKwccmTgg7y2qX0jBhA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>通过将生成和评估整合到反馈循环中，DMPO弥合了布局生成和人类审美偏好之间的差距，产生了更具视觉吸引力的布局。</p>
<h2 data-id="heading-4">五、实验结果</h2>
<p>（1）布局评估模型性能</p>
<p>为了验证我们的评估器，我们将其与一些领先的闭源（M）LLM模型进行比较，包括GPT-4o、Claude3.5 Sonnet（Claude3.5）、GLM-4v和DeepSeek-R1。这些模型遵循“LLM-as-Judge”范式。所有模型接收相同的指令和视觉输入，除了DeepSeek-R1，它只处理文本。如表1所示，我们的模型表现出色，达到85.5%的准确率，比现有的MLLMs高出25-35%。一些MLLMs的表现接近随机（约50%），突显了它们在布局评估中的局限性。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a676ed0c5cf64a43881e595b7bda7d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=IwMFgHf3K%2Bgg2eeLq6n7wwaCPec%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>表1 ：布局评估模型对比</p>
<p>（2）布局生成模型性能</p>
<p>在本小节中，我们与三类基线方法进行了比较：(1) 针对单个布局任务设计的任务特定SOTA模型（例如，LayoutDM）；(2) 闭源模型，包括GPT-4o、Claude3.5和DeepSeek-R1；(3) 开源的多模态大语言模型（MLLMs），如联合训练四个任务的LLaVA。</p>
<p>在表2展示的任务特定评估中，我们的方法在多个指标上表现出色。值得注意的是，在BFEF任务中，我们实现了最低的Ove（0.001）和Ali（0.00004），与专用模型如LayoutDM和LayoutFlow持平或超越。在BFEC任务中，我们的方法以最小的Ove（0.00045）和最高的Max.（0.439）创下新纪录。在BCEF任务中，我们在𝑅𝑐𝑜𝑚（31.848）和𝑅𝑠𝑢𝑏（0.774）方面取得了最佳结果。同样，在BCEC任务中，我们的方法以最低的𝑅𝑐𝑜𝑚（8.536）显著优于现有方法，同时在其他指标上保持竞争力。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3183d72df93417eb662ece3ffafdf39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=Zy4wVsgginm8pGWtbQnnpvHkddE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>表2：任务特定评估指标结果</p>
<p>针对所有任务的人类模拟评估，我们引入了评估模型的LR分数来评估性能。如图4所示，我们的方法实现了最高的LR分数0.702，在不同布局场景中表现出持续的优越性。与其他模型相比，我们显著超越了GPT-4o（0.584）、Claude3.5（0.575）和DeepSeek-R1（0.401），差距明显。与开源基线LLaVA（0.422）相比，性能差距更加显著，提升了近30%。与LayoutFlow（BFEF的SOTA）、P&amp;R（BFEC的SOTA）和Poster-Llama（BCEF和BCEC的SOTA）取得的平均LR分数0.658相比，我们的方法取得了更优的结果，从而验证了Uni-Layout的有效性。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27f032cea829447b980a980507c52f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889376&amp;x-signature=mxFYwGlDm61YnxeZ2XUqJSccg3U%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>图4： 人类模拟评估指标结果</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东多语言质量解决方案]]></title>    <link>https://juejin.cn/post/7594420277449474075</link>    <guid>https://juejin.cn/post/7594420277449474075</guid>    <pubDate>2026-01-13T06:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594420277449474075" data-draft-id="7594420277449408539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东多语言质量解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-13T06:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东多语言质量解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:15:49.000Z" title="Tue Jan 13 2026 06:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：李小磊</p>
<h2 data-id="heading-0">一、业界多语言面临的通用挑战是什么</h2>
<p>做这个事之前，我们先看看业界做了什么。</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxJW-HuBu6tNz-pCjAJIwBw" target="_blank" title="https://mp.weixin.qq.com/s/xJW-HuBu6tNz-pCjAJIwBw" ref="nofollow noopener noreferrer">阿里巴巴全球化测试技术介绍</a>﻿</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FE-QssSrIdZWo-kykNn4N3Q" target="_blank" title="https://mp.weixin.qq.com/s/E-QssSrIdZWo-kykNn4N3Q" ref="nofollow noopener noreferrer">蚂蚁全球化无线端质量解决方案</a>﻿</p>
<p>•﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJB1AxTnGTvXyIQmnFLrrzg" target="_blank" title="https://mp.weixin.qq.com/s/JB1AxTnGTvXyIQmnFLrrzg" ref="nofollow noopener noreferrer">谈谈多语言测试</a>﻿</p>
<p>总结下来，需要面临3个通用问题：</p>
<p>1.语言物料生产阶段：对于存量未接入多语言平台（70%）的模块，会有潜在代码会未配置Key的问题，而对于已接入模块会出现错配置Key问题，最终导致端上的文案不展示及展示错误问题。</p>
<p>2.标准化流程缺失：在研发阶段，新增多语言文案的流程缺失，大部分模式是业务方、内容团队、开发同学通过翻译平台是弱管控。需要PRD语言类key标准化-&gt;翻译平台录入-&gt;研发流程流程门禁检测+端上测试-&gt;Key发布上线管理。</p>
<p>3.海外测试仿真度低：全球化用户遍布全球各地，质量同学想要真实模拟不同地区的用户的真实体验挑巨大，海外用户手机适配的挑战也将远远大于国内。且语言类特有的漏翻\错翻\文案截断问题在UI层的问题突出，而当前手工程度高，问题发现能力弱。与此同时可以预见，若扩充到其他语言时工作量会成倍增加。如下是全球用户在品牌、机型、系统和分辨率上的差异。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d93abc88a54ed49b3b10be23522227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=TFybThY%2BJfuve0TCLtyTbf1R5Oo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-1">二、面临的挑战却远不止于此。因为我们京东商城是航母级的APP，意味着</h2>
<h3 data-id="heading-2"><strong>1. 产品形态多样</strong></h3>
<p>一般有4个维度：地区/国家 &amp; 语言 &amp; 币种 &amp; 时区</p>
<p><strong>地区国家：</strong> 0-大陆、5-港澳、7-台湾、8-美国、9-日本、10-新加坡、11-马来西亚、12-泰国、13-韩国、14-越南、15-柬埔寨、100-海外</p>
<p><strong>语言：</strong> 简体中文=zh_CN、美式英语=en_US、繁体中文=zh_HK（仅港澳台湾）</p>
<p><strong>币种：</strong></p>

















































































































<table><thead><tr><th><strong>用户设置币种</strong></th><th><strong>货币符号</strong></th><th><strong>展示类型</strong></th><th><strong>金额表达示例（10元）</strong></th></tr></thead><tbody><tr><td>HKD</td><td>HK$</td><td>B</td><td>HK$10.99</td></tr><tr><td>TWD</td><td>NT$</td><td>B</td><td>NT$10.99</td></tr><tr><td>USD</td><td>$</td><td>B</td><td>$10.99</td></tr><tr><td>JPY</td><td>JP¥</td><td>B</td><td>JP¥10</td></tr><tr><td>SGD</td><td>S$</td><td>B</td><td>S$10.99</td></tr><tr><td>MYR</td><td>RM</td><td>B</td><td>RM10.99</td></tr><tr><td>THB</td><td>฿</td><td>B</td><td>฿10.99</td></tr><tr><td>KRW</td><td>₩</td><td>B</td><td>₩10</td></tr><tr><td>VND</td><td>₫</td><td>B</td><td>₫10</td></tr><tr><td>KHR</td><td>៛</td><td>B</td><td>៛10.99</td></tr><tr><td>AUD</td><td>AU$</td><td>B</td><td>AU$10.99</td></tr><tr><td>AED</td><td>د.إ</td><td>A</td><td>د.إ10.99</td></tr><tr><td>EUR</td><td><strong>€</strong></td><td>B</td><td>€10.99</td></tr><tr><td>GBP</td><td><strong>£</strong></td><td>B</td><td>£10.99</td></tr><tr><td>CAD</td><td>CA$</td><td>B</td><td>CA$10.99</td></tr><tr><td>NZD</td><td>NZD$</td><td>B</td><td>NZD$10.99</td></tr><tr><td>MXN</td><td>Mex$</td><td>B</td><td>Mex$10.99</td></tr></tbody></table>
<p>﻿</p>
<p><strong>时区</strong>：</p>
<p>1.若用户设置语言是英文，则转换时区后用英语时间表达格式：日月年 时分秒。如：年月日 时分秒：2025-06-07 23:59:59，转换成英文：07 Jun 2025 23:59:59(UTC+8)</p>
<p>2.若用户设置语言是中文&amp;繁体，则转换时区后时间表达格式：年月日，时分秒。</p>
<p>3.返回目标地区的UTC时区值（T），时区由各模块自己判断是否要展示。</p>
<h3 data-id="heading-3">2. 技术栈多，技术架构复杂</h3>
<h4 data-id="heading-4">2.1 语言类-客户端</h4>
<p><strong>- 场景1：</strong> 端页面可从多语言SDK获取“国家/区域”，“语言”，“模式”参数，处理自定义的业务逻辑；<strong>网络请求使用“京东零售基础网路库”加载端页面。基础库负责统一上传“国家/区域”，“语言”，“模式”参数，端无须特殊处理。</strong></p>
<p><strong>- 场景2：</strong> 端页面可从多语言SDK获取“国家/区域”，“语言”，“模式”参数，处理自定义的业务逻辑；<strong>网络请求不使用“JD零售基础网路库”，端需要自己参照参数规则，上传“国家/区域”，“语言”，“模式”参数。</strong></p>
<h4 data-id="heading-5">2.2 语言类-后端</h4>
<p><strong>传递方式</strong>：客户端-&gt;网络库/非网络库-&gt;color网关/非color网关-&gt;SOA-&gt;后台服务（JSF隐式传参）。</p>
<p><strong>使用方式</strong>：服务端从全局上下文SDK中读取，不允许篡改。<strong>SOA及后台服务需要接入dongboot内核+donglog+dongcontext+dongthread</strong></p>
<h4 data-id="heading-6">2.3 汇率类-设计</h4>
<p>换算原则：SOA调用科技汇率接口获取汇率，传给价格源（到手价/原价团队/预售价）进行外币价格计算；若展示价格由中台计算，例如购物车勾选后价格和结算页支付价格，则由中台进行外币价格计算。核心页面外币金额展示示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae757805cb84f25bc6a108fba31857a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=DU8DgGipt7F4bFCZ5QqpC2ne9iM%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<h4 data-id="heading-7">2.4 时区类-设计</h4>
<ol>
<li>
<p>当端SOA侧依赖的上游返回的String类型的文案里面如果包含日期或时间，由中后端上游进行时区转换。</p>
</li>
<li>
<p>当端SOA侧依赖的上游返回了时间戳/Date格式的日期或时间，由端SOA侧进行时区转换。</p>
</li>
</ol>
<p>全链路涉及模块：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f41ec2038f034a53834728d786a3e9b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=KCIZFgfkUnng9vLCA4prXIZspj0%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-8">三、对QA而言，挑战是巨大的，具体是什么？</h2>
<h4 data-id="heading-9">3.1 挑战一：覆盖的页面场景多，英文版2.0的围绕20+个业务，涵盖零售&amp;科技&amp;物流&amp;健康全链路。</h4>
<p>交易域：商详、结算、购物车、凑单、换购、订单/订详、收银台、支付成功、价保、店铺、售后</p>
<p>导购&amp;流量：首页、拍照购、分类、评价、消息中心、搜索、推荐、我京及核心二三级页、权益中心、plus、等级会员、发票、客服。</p>
<h4 data-id="heading-10">3.2 挑战二：页面 &amp; 语言 &amp; 汇率 &amp; 时区的笛卡尔积，将极大的增加测试验证工作量。</h4>
<p>除大陆站点外，中文模式下的时区<strong>也需要验证。</strong> 所以有更多的页面进入覆盖场景。如：咚咚客服、活动日历、短信、延保服务、账单。</p>
<h4 data-id="heading-11">3.3 挑战三：即使每个页面能否走到，每个页面的测试深度无法穷举。</h4>
<p>1.流量&amp;导购类页面千人千面，依赖于账户维度的丰富度。如：</p>
<p>2.交易类页面，依赖较多前置条件：如：</p>
<p>1.商详：楼层多，需要不同的SKU。</p>
<p>2.结算：楼层多，需要不同的SKU。</p>
<p>3.购物车：依赖账户加车状态、比如预售&amp;定金的时间表达</p>
<p>4.凑单：可能无法通过OpenAPP协议进入。</p>
<p>5.收银台：目前不支持OpenAPP协议进去。</p>
<p>6.订单：依赖账户内的订单、二级弹层不依赖于openAPP协议。</p>
<p>7.promise：“付款时间”保持和当前用户时区一致、“发货时间”和“送达时间”保持与收货地时区一致。</p>
<p>﻿</p>
<h2 data-id="heading-12">四、京东全球售-测试方案</h2>
<h3 data-id="heading-13">4.1 目标</h3>
<p>进行自动化问题检测，提升走查效率。提供修复建议，提升全球售本地化体验。</p>
<h3 data-id="heading-14">4.2 整体思路</h3>
<p>通过接口、页面、用户动线三层验证思路进行验证。并通过汇率接口限流，验证页面兜底情况。</p>
<h3 data-id="heading-15">4.3 策略一【接口层】通过梳理全量使用价格计算的接口，进行币种设置，批量测试。</h3>
<p><strong>面向中台：JSF接口设置DongContext，验证不同语言下的返回</strong>。如：台账 （PayResource.queryOrder - 查询应付金额（收银台））、到手价中台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FTav9wHASWJ3ufru6HW0K" target="_blank" title="https://joyspace.jd.com/pages/Tav9wHASWJ3ufru6HW0K" ref="nofollow noopener noreferrer">计算外币价格-结算网关接口文档</a>） 、价促平台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FYM8L8oc60kI16lZUdZd5" target="_blank" title="https://joyspace.jd.com/pages/YM8L8oc60kI16lZUdZd5" ref="nofollow noopener noreferrer">主站新增外币金额表达-接口文档</a>）、预售价中台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FY9ZM1rXUbLXTIEsUHTNA" target="_blank" title="https://joyspace.jd.com/pages/Y9ZM1rXUbLXTIEsUHTNA" ref="nofollow noopener noreferrer">4.2 批量获取当前进行中的预售</a>）。</p>
<p><strong>面向前台：</strong> <strong>color网关接口设置DongContext</strong>，验证不同语言就需要前台端SOA对接科技接口获取汇率，再从外币价格jar包获取外币金额，并前端表达。接口性能要求80ms，如果性能不足需要降级不展示。</p>
<p><strong>期望的结果</strong>：</p>
<p>•外币金额计算规则：外币金额=本币 X 汇率。</p>
<p>•外币金额小数点处理：VND（越南盾）、KRW（韩元）、JPY（日元）三个币种，外币金额四舍五入取整数；其他币种，外币金额四舍五入，最多保留2位小数，小数点后0要抹去。</p>
<h3 data-id="heading-16">4.3 策略二【页面级测试】一键触发核心场景组合，并自动化结果校验。</h3>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baf4cf74d1cf4c45b6fa7de2f918e2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=MthakQRUh%2FTYWcuah0SlcUGzeAg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<ol>
<li>核心场景组合定义：</li>
</ol>
<p>（P0）港澳-繁体-港币-UTC+8</p>
<p>（P0）台湾-英文-台币-UTC+8</p>
<p>（P0）新加坡-英文-新币-UTC+8</p>
<p>（P0）澳大利亚-英文-AUD-UTC+11</p>
<p>（P0）大陆-英文-美元-UTC+8</p>
<ol start="2">
<li>
<p>自动化切换、截图、跳转、文案检测识别。</p>
</li>
<li>
<p>结果验证，翻译错误、翻译质量。</p>
</li>
</ol>
<h3 data-id="heading-17">4.3 策略三：【常态化保鲜】通过APP回归、兜底演练动作防裂化</h3>
<p>1.一键触发：打通测试回归计划，多任务手动一键出发/定时触发/接口触发，输出报告需要对任务整体通过率计算。内容包括：遍历的页面，每个子任务（当成一条用例）除了展示完成的状态，还需要展示通过率，错误的个数，通过的个数等。</p>
<p>2.设备选择：实现基于系统、机型、分辨率、国内外品牌等维度筛选机型。</p>
<p>3.发版报告：①报告类增加小 i解释：通过/忽略的标准，例如明确告知除了人名/图片，其余内容均需进行翻译，以及相关类别问题的研发接口人。</p>
<h3 data-id="heading-18">4.4 策略四：【智能体Agent】<strong>探索智能体方案，进行翻译质量检测</strong></h3>
<p>基于赛博平台对各页面的识别结果，将接口中翻译后的内容提取出来并输送给智能体，由智能体来<strong>检测</strong>多语言<strong>翻译的准确性</strong>。</p>
<p>﻿</p>
<h2 data-id="heading-19">五、做到什么程度</h2>
<h3 data-id="heading-20">5.1 工程上的提效价值：</h3>
<p>•执行上：3240mins-&gt;30mins</p>
<p>•检测上：324mins-&gt;32.4mins</p>
<p>计算公式如下：</p>




















<table><thead><tr><th>﻿</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>UI层</td><td>执行：36个page ✖️ 9（站点+语言+币种） ✖️ 5 mins ✖️ 2端 = 3240mins 检测：648页面人工check * 0.5 mins = 324mins</td><td>执行上：子用例集维度： 1次执行（36个page并行） ✖️ （9个场景并行） ✖️ 30mins（ 双端并行）= 30mins 检测维度：目标90%的check可以通过检测脚本搞定。324 ✖️（1-90%）= 32.4mins。</td></tr><tr><td>API层</td><td>涉及color网关（4.8万接口）和非color网关接口，以及HSF接口</td><td>单接口调试及多接口回归自动化验证，可以提效约70%以上</td></tr></tbody></table>
<p><strong>结果展示1：聚合页对比10种场景</strong></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1547ef18c7b4c099c57eb0ee8e5cbba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=PrHXer1fOhvgaCuJn%2BSunL61JVY%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>提效10倍。计算公式：10（页面+语言+比重）* 3端的情况下：</p>
<p>•人工：10<em>3</em>5（分钟）=150min</p>
<p>•自动：15分钟</p>
<p><strong>结果展示2：自动检测</strong></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f91ddaefa6546ae8559ab1dd1873ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=Jt3E1CSbVdJE%2Fxly7dpECPRwq44%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>提效100%。计算公式≈通过的问题数在总问题数中的比例，意味着是自动检测。</p>
<p>具体测试包括见：【15.3.20】- 多语言自动化测试报告。 （涉及到内部网站，请联系作者进行报告链接获取）</p>
<p>﻿</p>
<h3 data-id="heading-21">5.2 大模型上的实践价值：</h3>

















<table><thead><tr><th>翻译的精准度不够：item(s)</th><th>翻译截断</th><th>翻译不准确 scrape 本义 “刮擦”，引申为「技术爬虫抓取」，隐含 “非正常手段获取”“批量爬取” 的负面意味，应改为collection</th><th>中文未翻译</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35955b1b9ea04ef4b0f4d4b9540afa73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=35W4oO576AEKTjBCwVmzvwp88nI%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60dee5fd33a34de48ee9ca95dcaf123a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=AkEfL0v5lF5g4nYpDGuaROAPrHU%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00d9886668414a988767ca8127e5f356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=ma8zyPVLwBCSSXxdWHpbt3RqY7s%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47248be556004d36827a228538667920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=U40IZS4gIOvaAoMWNlZqtXeYHoU%3D" alt="" loading="lazy"/>﻿</td></tr></tbody></table>
<p>•15.2.80多语言翻译质量检测，发现13个翻译类问题。见<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoyspace.jd.com%2Fpages%2FSo07Tw9myszm8oGUyJFI" target="_blank" title="https://joyspace.jd.com/pages/So07Tw9myszm8oGUyJFI" ref="nofollow noopener noreferrer">15.2.80多语言翻译质量检测报告</a>﻿</p>
<p>•智能体经过3轮优化，采纳率11%提升至85.71%。</p>
<h3 data-id="heading-22">5.3 零售研发流程的多语言升级价值</h3>









































<table><thead><tr><th><strong>场景/功能</strong></th><th><strong>详细描述</strong></th><th><strong>原型</strong></th><th/></tr></thead><tbody><tr><td><strong>创建设计</strong></td><td>创建设计时给出提醒</td><td>·选择迭代设计，选择需求后，识别需求的多语言字段 ·若打标为是，则给出黄色区域文案提示： ·所选需求涉及多语言，请在设计用例过程中重点关注 ·不涉及联调设计</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147ae836b19645898e8df035ff7de010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=EdvAaJqlxYPq6u%2FKx5Wn6xP2Zhc%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>编写用例</strong></td><td>编写用例时支持批量打标签</td><td>·目录、用例批量操作增加添加标签操作； ·点击添加标签，弹框展示标签输入的弹框，点击确定后，追加至所选用例的标签字段<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6e5e34124e408dae94fa08148af79b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=pYkgEMVsB9wL7JpSj4pppVnNkmg%3D" alt="" loading="lazy"/>﻿ ·联调设计同步支持</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8347487073c4dbdbc77d26edde209b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=6Wc0LE%2BAVh%2FfyFvaEst%2BPvMkPfY%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>用例打标</strong></td><td>单用例详情页，支持用户打标签</td><td>多语言系统标签用户点击添加默认推荐出来</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2287f75fc44b4a7491d1c427415b04d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=GFZI5vDEkrLU%2FtwnHzIGr7nkvPE%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>用例评审</strong></td><td>时给出提示提醒</td><td>点击评审完成时，判断下需求是否有对应标记，若有标记，则增加一个根据标签统计多语言用例的区域，若用例数为0，则0红色高亮显示，并展示建议补充文案 不涉及联调设计</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3dbac8688df4855b7e326fdebafe425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=fvjV0sWeUiw5lk8Lo1UWBGQP%2FLY%3D" alt="" loading="lazy"/>﻿</td></tr><tr><td><strong>发版回归</strong></td><td>一键触发自动化巡检</td><td>·页面 x 语言 x 汇率 x 时区的的测试组合场景，进行高效执行和批量验证。 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcyber.test.jd.com%2F%23%2Fautotest%2Fi18nAutomation%25C2%25B7%25E9%2595%25BF%25E6%259C%259F%25E8%25A7%2584%25E5%2588%2592%25EF%25BC%259A%25E4%25B8%2580%25E9%2594%25AE%25E6%258A%25A5Bug%25E3%2580%2581%25E5%258D%2595%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259A%25E6%2597%25B6%25E5%25B7%25A1%25E6%25A3%2580%25E3%2580%2581%25E5%25B5%258C%25E5%2585%25A5APP%25E5%258F%2591%25E7%2589%2588%25E5%259B%259E%25E5%25BD%2592%25E5%25B9%25B3%25E5%258F%25B0%25E6%25B5%2581%25E7%25A8%258B%25E3%2580%2581%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E8%25B4%25A8%25E9%2587%258F%25E7%25BF%25BB%25E8%25AF%2591%25E5%25B5%258C%25E5%2585%25A5%25E5%25B9%25B3%25E5%258F%25B0%25E3%2580%2582" target="_blank" title="http://cyber.test.jd.com/#/autotest/i18nAutomation%C2%B7%E9%95%BF%E6%9C%9F%E8%A7%84%E5%88%92%EF%BC%9A%E4%B8%80%E9%94%AE%E6%8A%A5Bug%E3%80%81%E5%8D%95%E6%A8%A1%E5%9D%97%E5%AE%9A%E6%97%B6%E5%B7%A1%E6%A3%80%E3%80%81%E5%B5%8C%E5%85%A5APP%E5%8F%91%E7%89%88%E5%9B%9E%E5%BD%92%E5%B9%B3%E5%8F%B0%E6%B5%81%E7%A8%8B%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%B4%A8%E9%87%8F%E7%BF%BB%E8%AF%91%E5%B5%8C%E5%85%A5%E5%B9%B3%E5%8F%B0%E3%80%82" ref="nofollow noopener noreferrer">cyber.test.jd.com/#/autotest/…</a></td><td>﻿</td></tr></tbody></table>
<p>﻿</p>
<h2 data-id="heading-23">六、未来规划</h2>
<h3 data-id="heading-24">6.1 大而全的质量保障整体方案</h3>
<ol>
<li>
<p>【已完成】标准化多语言研发流程。多语言检测能力覆盖整个语言生产过程。</p>
</li>
<li>
<p>【进行中】建设全球化测试体系化能力。测试资源：构建手机号、银行卡、支付账号、测试账号、云测真机、网络仿真，构建研测阶段的真实海外环境。效率&amp;体验：通过多端的功能的自动化，提升测试回归阶段的多机适配效率。通过多环境的app性能测试（核心页面、图片、视频），例如美国、印度和欧洲的页面秒开率会有很大区别，提前发现端侧性能问题。体验巡检：联合本地化外包、海外产设团队，进行线上用户体验走查，真实模拟用户现场发现体验问题。</p>
</li>
<li>
<p>【未开始】<strong>建设全球化安全生产体系</strong>。攻防演练：在多租户并行的部署架构下，进行域名、接口级别的攻防演练，提升系统的海外高可用性。海外压测：压测平台能力进行扩充，涵盖海外用户特征的压测数据及脚本以及多机房混压，提升海外服务稳定性。</p>
</li>
</ol>
<p>策略大图见下：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ddb227ca0334a8cb1cd2da0e8c79664~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768889749&amp;x-signature=7aLH6nq8RRnP%2F1Dx5YCiQNgoPis%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-25">6.2 翻译质量智能体</h3>
<p>语言度量能力：通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMicrosoftTranslator%2FGEMBA" target="_blank" title="https://github.com/MicrosoftTranslator/GEMBA" ref="nofollow noopener noreferrer">GPT Based MQM</a>（Multidimensional Quality Metrics），构建国际化水位分数，助力owner&amp;团队看清缺陷密度水位。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑]]></title>    <link>https://juejin.cn/post/7593742881141604361</link>    <guid>https://juejin.cn/post/7593742881141604361</guid>    <pubDate>2026-01-12T01:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593742881141604361" data-draft-id="7593177437081813043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑"/> <meta itemprop="keywords" content="Android,面试,前端"/> <meta itemprop="datePublished" content="2026-01-12T01:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            破解Android悬浮窗遮挡无障碍服务难题：我在可见即可说上踩过的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T01:00:48.000Z" title="Mon Jan 12 2026 01:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>为什么你的Android悬浮窗"挡住"了无障碍服务</strong></p>
<p>Android  可见即可说  (语音悬浮窗口在，无障碍服务扫描不出系统卸载window)</p>
<h2 data-id="heading-0">1.完整需求： 语音说一句话：帮我把抖音里面的今天的奖励全部领完，红包领完！</h2>
<p>1）语音悬浮窗交互：</p>
<p>能自动点击悬浮窗下方的所有窗口（如抖音红包按钮）</p>
<p>点击悬浮窗空白区域 → 悬浮窗消失</p>
<p>悬浮窗内 RecyclerView 的点击事件需响应</p>
<h3 data-id="heading-1">效果图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc351be39344c3eb15b650b9fb935ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768784448&amp;x-signature=u9KubdCm8Vxz7igRl2Mv07NunHU%3D" alt="语音.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 具体详细需求：</h3>
<p>系统弹窗支持：</p>
<p>当语音指令为“卸载抖音”时：</p>
<p>先显示语音悬浮窗</p>
<p>再触发系统卸载弹窗（com.android.packageinstaller）</p>
<p>用户可通过语音控制点击“确定”或“取消”</p>
<h2 data-id="heading-3">2.核心问题：无障碍服务无法识别被悬浮窗完全遮挡的系统弹窗</h2>
<p>语音把系统的卸载window弹出，</p>
<p>语音可见即可说扫描不出卸载window，</p>
<p>导致无法实现确认按钮的可见即可说</p>
<h3 data-id="heading-4">2.2 问题现象</h3>
<p>当语音悬浮窗完全覆盖系统卸载弹窗时：</p>
<p>AccessibilityService 的 windows 列表中扫描不到 com.android.packageinstaller</p>
<p>只能扫描到 launcher 或 systemui</p>
<p>导致“可见即可说”功能失效，无法点击“确定/取消”</p>
<h3 data-id="heading-5">2.3 根本原因（Android 系统机制限制）</h3>
<p>表格</p>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>窗口可见性判定</strong></td><td>Android Accessibility 服务<strong>不会返回被完全遮挡且不可交互的窗口</strong>的节点</td></tr><tr><td><strong>安全限制</strong></td><td>出于隐私和安全考虑，系统禁止通过无障碍服务读取被其他应用完全覆盖的 UI 层</td></tr><tr><td><strong>层级与类型相同</strong></td><td>语音悬浮窗 (<code>TYPE_SYSTEM</code>, layer=1) 与 launcher (<code>TYPE_APPLICATION</code>, layer=0) 不同；但卸载弹窗也是 <code>TYPE_APPLICATION</code>, layer=0，与 launcher 同级。当悬浮窗高度 95% 屏幕时，完全遮挡卸载弹窗 → 系统认为其“不可见”</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>验证结论</strong>：只要悬浮窗<strong>未完全遮挡</strong>卸载弹窗（例如高度 ≤85%），无障碍服务就能正常扫描到 <code>packageinstaller</code>。</p>
</blockquote>
<h2 data-id="heading-6">3.分析问题</h2>
<h3 data-id="heading-7">3.1 之前同事写的代码逻辑：</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">layoutParams</span> = new WindowManager.LayoutParams(
    MATCH_PARENT,
    WRAP_CONTENT,
    TYPE_APPLICATION_OVERLAY,
    FLAG_NOT_FOCUSABLE,
    TRANSLUCENT
)<span class="hljs-comment">;</span>
layoutParams.flags |= FLAG_LAYOUT_IN_SCREEN<span class="hljs-comment">;</span>
layoutParams.flags |= FLAG_NOT_TOUCH_MODAL<span class="hljs-comment">;      // ✅ 允许区域外触摸透传</span>
layoutParams.flags |= FLAG_WATCH_OUTSIDE_TOUCH<span class="hljs-comment">;  // 配合外部点击关闭</span>
</code></pre>
<h3 data-id="heading-8">3.2 无障碍服务中的“窗口替换”逻辑</h3>
<pre><code class="hljs language-ini" lang="ini">if (rootNode?.<span class="hljs-attr">packageName</span> == packageName || rootNode?.childCount == <span class="hljs-number">0</span>) {
    windows.forEach { window -&gt;
        window.root?.takeIf { rn -&gt;
            rn.packageName != packageName &amp;&amp; rn.childCount != 0
        }?.apply {
            <span class="hljs-attr">rootNode</span> = this  // 替换为非自身、非空的窗口根节点
        }
    }
}
</code></pre>
<p>目的：跳过语音悬浮窗自身，尝试使用其他窗口（如卸载弹窗）作为操作目标
失败原因：当卸载弹窗被完全遮挡 → windows 列表中根本不存在该窗口 → 替换失败</p>
<h3 data-id="heading-9">3.2  无障碍服务扫描的结果</h3>
<h3 data-id="heading-10">3.2.1 具体结果分3步骤：</h3>
<h6 data-id="heading-11">1).在桌面扫描的结果：</h6>
<pre><code class="hljs language-bash" lang="bash">2026-01-06 15:48:48.918 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 0, window: AccessibilityWindowInfo[title=导航栏, displayId=0, <span class="hljs-built_in">id</span>=258, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=3, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">1824</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1920</span>)), bounds=Rect(0, 1824 - 864, 1920), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.android.systemui
2026-01-06 15:48:48.919 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 1, window: AccessibilityWindowInfo[title=null, displayId=0, <span class="hljs-built_in">id</span>=252, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=2, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">864</span>,<span class="hljs-number">115</span>)), bounds=Rect(0, 0 - 864, 115), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.android.systemui
2026-01-06 15:48:48.919 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 2, window: AccessibilityWindowInfo[title=null, displayId=0, <span class="hljs-built_in">id</span>=265, <span class="hljs-built_in">type</span>=TYPE_SYSTEM, layer=1, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">192</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1824</span>)), bounds=Rect(0, 192 - 864, 1824), focused=<span class="hljs-literal">true</span>, active=<span class="hljs-literal">true</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.tencent.voice
2026-01-06 15:48:48.920 59779-59779 VoiceAcces...ityService com.tencent.voice              E  开始windows-------index: 3, window: AccessibilityWindowInfo[title=大桌面, displayId=0, <span class="hljs-built_in">id</span>=250, <span class="hljs-built_in">type</span>=TYPE_APPLICATION, layer=0, region=SkRegion((<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">864</span>,<span class="hljs-number">1920</span>)), bounds=Rect(0, 0 - 864, 1920), focused=<span class="hljs-literal">false</span>, active=<span class="hljs-literal">false</span>, pictureInPicture=<span class="hljs-literal">false</span>, hasParent=<span class="hljs-literal">false</span>, isAnchored=<span class="hljs-literal">false</span>, hasChildren=<span class="hljs-literal">false</span>]; com.tencent.launcher
</code></pre>
<p>launcher: type=TYPE_APPLICATION, layer=0</p>
<h6 data-id="heading-12">2). 在桌面，然后弹出卸载框：</h6>
<pre><code class="hljs"> com.android.systemui -
com.android.packageinstaller 
</code></pre>
<p>卸载window：type=TYPE_APPLICATION, layer=0
不会扫描到桌面的window，被卸载弹框全部挡住, 处于同一层级
得出层级关系：卸载在最底层，layer=0</p>
<h6 data-id="heading-13">3).在桌面，语音悬浮窗出现之后，然后弹出卸载框：</h6>
<p>不正常是这个：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">2025-12-29 13:58:34.996  1900-1900  VoiceAcces...ityService com.tencent.voice              D  windows size:</span> <span class="hljs-number">4</span> 
                                                                                                     <span class="hljs-attr">windowArrStr:</span> <span class="hljs-string">com.android.systemui</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
                                                                                                    <span class="hljs-string">com.android.systemui</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
                                                                                                    <span class="hljs-string">com.tencent.voice</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:true</span> 
                                                                                                    <span class="hljs-string">com.tencent.launcher</span> <span class="hljs-bullet">-</span> <span class="hljs-string">visible:true</span> <span class="hljs-bullet">-</span> <span class="hljs-string">active:false</span> 
<span class="hljs-number">2025-12-29 13:58:34.998  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.android.systemui</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:34.999  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.tencent.voice</span>
<span class="hljs-number">2025-12-29 13:58:34.999  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.android.systemui</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.000  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.001  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.tencent.voice</span>
                                                                                                    <span class="hljs-string">isActive:true</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">D</span>  <span class="hljs-string">packageName:com.tencent.launcher</span>
                                                                                                    <span class="hljs-string">isActive:false</span>
                                                                                                    <span class="hljs-string">isAccessibilityFocused:false</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点前.......com.android.systemui</span>
<span class="hljs-number">2025-12-29 13:58:35.003  </span><span class="hljs-number">1900</span><span class="hljs-number">-1900</span>  <span class="hljs-string">VoiceAcces...ityService</span> <span class="hljs-string">com.tencent.voice</span>              <span class="hljs-string">E</span>  <span class="hljs-string">替换节点后.......com.tencent.launcher</span>

</code></pre>
<p>原因应该是优先级：他们type相同
语音:        type=TYPE_SYSTEM, layer=1,
launcher: type=TYPE_APPLICATION, layer=0</p>
<h6 data-id="heading-14">期望正常是这个结果：</h6>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.989</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  windows size: <span class="hljs-number">4</span> 
                                                                                                     windowArrStr: com.android.systemui - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
                                                                                                    com.android.systemui - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
                                                                                                    com.tencent.voice - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">true</span> 
                                                                                                    com.android.packageinstaller - visible:<span class="hljs-literal">true</span> - active:<span class="hljs-literal">false</span> 
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.systemui
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.tencent.voice
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.990</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.991</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.systemui
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.992</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.tencent.voice
                                                                                                    isActive:<span class="hljs-literal">true</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.994</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              D  packageName:com.android.packageinstaller
                                                                                                    isActive:<span class="hljs-literal">false</span>
                                                                                                    isAccessibilityFocused:<span class="hljs-literal">false</span>
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.995</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点前.......com.android.systemui
<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">54.995</span>   <span class="hljs-number">565</span><span class="hljs-number">-565</span>   VoiceAcces...ityService com.tencent.voice              E  替换节点后.......com.android.packageinstaller
</code></pre>
<h2 data-id="heading-15">4. 解决方案</h2>
<h3 data-id="heading-16">4.1 模仿手机厂商怎么处理的！ 看了下VIVO手机，</h3>
<p>先卸载，
发现语音悬浮后，不能再进行下一步的可见即可说！ 命中的是大模型，卸载按钮一样无法命中，如下图！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bcb80d8086a4033aa5abfc2f95a8a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768784448&amp;x-signature=wXxRpbDoXmVCVwGZorDbsQl4ZbE%3D" alt="1000023139_免费视频转GIF_20260109_170019.gif" loading="lazy"/></p>
<p>如果悬浮窗完全挡住了下面的window，下面的window就不会被系统扫描到！
发现一个问题，我的悬浮窗完全挡住了.com.android.packageinstaller，window里面就扫描不出，扫描出了com.tentent.launcher, 如果我的悬浮窗没用完全挡住，就可以window里面就扫描出了.com.android.packageinstaller</p>
<h3 data-id="heading-17">📌 总结</h3>

















<table><thead><tr><th>问题原因</th><th>系统将完全被悬浮窗遮挡的窗口视为“不可见”，故 AccessibilityService 无法获取其根节点</th></tr></thead><tbody><tr><td>根本限制</td><td>Android 安全机制：不能通过 Accessibility 读取被完全遮挡/不可交互的窗口</td></tr><tr><td>推荐做法</td><td>1. 避免完全覆盖 2. 过滤掉自身和 SystemUI/Launcher 3. 结合 UsageStats 做兜底</td></tr></tbody></table>
<p>当时产品看了竞品没用实现，让我放手！ 我觉得修改系统framwork层可以解决，但是公司的framwork层太low了，只有自己想办法</p>
<h3 data-id="heading-18">4.1 避免完全遮挡（推荐临时方案）</h3>
<p>修改悬浮窗高度，留出顶部或底部空间</p>
<p>具体措施如下：
第一种临时方案：语音的悬浮窗不完全挡住系统的弹框，是可以扫描出来的！
翻看了源码： 无障碍服务扫描原理，从上往下扫描，当同级layer 的window，会根据优先级判断！ 前面的窗口完全挡住，会扫描不出
<strong>所以很容易想到临时方案：修改悬浮窗的宽度或者高度</strong>,</p>
<pre><code class="hljs language-ini" lang="ini">    // 设置窗口大小和位置
            int <span class="hljs-attr">screenHeight</span> = DisplayUtils.getScreenHeight(MainApplication.getApplication())<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.height</span> = (int) (screenHeight * <span class="hljs-number">0.85</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.format</span> = PixelFormat.TRANSLUCENT<span class="hljs-comment">;</span>
            <span class="hljs-attr">layoutParams.gravity</span> = Gravity.BOTTOM | Gravity.CENTER_HORIZONTAL<span class="hljs-comment">;</span>

</code></pre>
<p>因为治标不治本！我不考虑，打算先看现象</p>
<h4 data-id="heading-19">4.1.1 第二种临时方案   解决方案：.改变点击事件</h4>
<p>核心思路：</p>
<p>默认悬浮窗可点击（处理内部 RecyclerView）</p>
<p>当检测到系统弹窗出现时（如通过 UsageStats 或广播）：</p>
<p>将悬浮窗设为 不可点击 + 事件透传</p>
<p>即：FLAG_NOT_TOUCHABLE | FLAG_NOT_FOCUSABLE</p>
<p>用户操作完成后，恢复可点击状态</p>
<p>点击事件的详细分析：
1.如果是点击了安装之后，2s后，设置为不可点击，
上报后，如果是采集到了，设置为可点击！</p>
<pre><code class="hljs language-arduino" lang="arduino">   <span class="hljs-keyword">protected</span> WindowManager.<span class="hljs-function">LayoutParams <span class="hljs-title">getLayoutParams</span><span class="hljs-params">(<span class="hljs-type">boolean</span> clickable,<span class="hljs-type">int</span> orientation)</span> </span>{
        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"getLayoutParams: clickable = "</span> + clickable + <span class="hljs-string">" cardClickable = "</span> + cardClickable);
        mCurAsrClickable = clickable;
        <span class="hljs-keyword">if</span> (layoutParams == null) {
            layoutParams = <span class="hljs-keyword">new</span> WindowManager.<span class="hljs-built_in">LayoutParams</span>(WindowManager.LayoutParams.TYPE_APPLICATION);
            layoutParams.width = WindowManager.LayoutParams.WRAP_CONTENT;
            layoutParams.height = WindowManager.LayoutParams.WRAP_CONTENT;
            layoutParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ALERT;
            layoutParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
            layoutParams.format = PixelFormat.TRANSLUCENT;<span class="hljs-comment">// 支持透明</span>
        }

        <span class="hljs-type">int</span> canTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
        <span class="hljs-type">int</span> cantTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
        <span class="hljs-keyword">if</span> (clickable) {
            layoutParams.flags |= canTouchFlag;
            layoutParams.flags |= cantTouchFlag;
            layoutParams.flags ^= cantTouchFlag;
        } <span class="hljs-keyword">else</span> {
            layoutParams.flags |= cantTouchFlag;
            layoutParams.flags |= canTouchFlag;
            layoutParams.flags ^= canTouchFlag;
        }
</code></pre>
<h3 data-id="heading-20">4.2  方案二: 最优化终极解决方案 结合悬浮窗属性优化 + 无障碍服务智能处理：</h3>
<p>通过悬浮窗属性+ 替换可见即可说的window对象，替换节点解决！</p>
<h4 data-id="heading-21">4.2.1 悬浮窗的属性核心代码如下：</h4>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-keyword">protected</span> WindowManager.<span class="hljs-function">LayoutParams <span class="hljs-title">getLayoutParams</span><span class="hljs-params">(<span class="hljs-type">boolean</span> clickable)</span> </span>{
        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"getLayoutParams: clickable = "</span> + clickable + <span class="hljs-string">" cardClickable = "</span> + cardClickable);
        mCurAsrClickable = clickable;
        <span class="hljs-keyword">if</span> (layoutParams == null) {
            layoutParams = <span class="hljs-keyword">new</span> WindowManager.<span class="hljs-built_in">LayoutParams</span>(
                    WindowManager.LayoutParams.MATCH_PARENT,
                    WindowManager.LayoutParams.WRAP_CONTENT,
                    WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                    WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                    PixelFormat.TRANSLUCENT);

            layoutParams.format = PixelFormat.TRANSLUCENT;
            layoutParams.gravity = Gravity.BOTTOM | Gravity.CENTER_HORIZONTAL;

            layoutParams.flags |= WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;

            <span class="hljs-comment">// 设置窗口标志 - 允许点击事件传递到下层</span>
            layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
            layoutParams.flags |= WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;
        }

        <span class="hljs-comment">// 设置窗口大小和位置</span>
        <span class="hljs-type">int</span> screenHeight = DisplayUtils.<span class="hljs-built_in">getScreenHeight</span>(MainApplication.<span class="hljs-built_in">getApplication</span>());
        layoutParams.height = (<span class="hljs-type">int</span>) (screenHeight * <span class="hljs-number">0.95</span>);

        <span class="hljs-comment">//根据屏幕方向，动态设置宽度</span>
        <span class="hljs-keyword">if</span> (DisplayUtils.<span class="hljs-built_in">isLandscape</span>(GlobalApplication.mGlobalContext)) {
            layoutParams.width = DisplayUtils.<span class="hljs-built_in">dp2px</span>(MainApplication.<span class="hljs-built_in">getApplication</span>(), <span class="hljs-number">348f</span>);
        } <span class="hljs-keyword">else</span> {
            layoutParams.width = WindowManager.LayoutParams.MATCH_PARENT;
        }

        LogUtils.<span class="hljs-built_in">d</span>(TAG, <span class="hljs-string">"-----height: "</span> + layoutParams.height);
        <span class="hljs-keyword">return</span> layoutParams;
    }
</code></pre>
<h4 data-id="heading-22">4.2.2 可见即可说，无障碍服务替换window的核心代码如下:</h4>
<pre><code class="hljs language-javascript" lang="javascript">            <span class="hljs-comment">// 第一步：在 threadRoot 线程中获取根节点</span>
            <span class="hljs-title class_">GlobalScope</span>.<span class="hljs-title function_">launch</span>(<span class="hljs-params">threadRoot</span>) {
                <span class="hljs-keyword">try</span> {
                    val startTime = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>()
                    <span class="hljs-comment">// 获取根节点</span>
                    <span class="hljs-keyword">var</span> rootNode = rootInActiveWindow
                    activeRootNodeVisible = rootNode?.<span class="hljs-property">isVisibleToUser</span> ?: <span class="hljs-literal">false</span>
                    <span class="hljs-title function_">printLogOnDebug</span>(<span class="hljs-string">"rootInActiveWindow-------${rootNode?.packageName}; ${rootNode?.windowId}"</span>)

                    <span class="hljs-comment">// 窗口过滤逻辑（已注释，可根据需要启用）</span>
                    <span class="hljs-keyword">if</span> (rootNode?.<span class="hljs-property">packageName</span> == packageName || rootNode?.<span class="hljs-property">childCount</span> == <span class="hljs-number">0</span>) {
                        windows?.<span class="hljs-property">forEach</span> { <span class="hljs-variable language_">window</span> -&gt;
                            <span class="hljs-variable language_">window</span>?.<span class="hljs-property">root</span>?.<span class="hljs-property">takeIf</span> { rn -&gt;
                                rn.<span class="hljs-property">packageName</span> != packageName &amp;&amp; rn.<span class="hljs-property">childCount</span> != <span class="hljs-number">0</span>
                            }?.<span class="hljs-property">apply</span> {
                                rootNode = <span class="hljs-variable language_">this</span>
                                <span class="hljs-title class_">LogUtils</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"替换节点......."</span>)
                            }
                        }
                    }
</code></pre>
<p>更详细一点的代码片段：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccessibilityEvent</span><span class="hljs-params">(event: <span class="hljs-type">AccessibilityEvent</span>?)</span></span> {
<span class="hljs-comment">//        windows.forEach {</span>
<span class="hljs-comment">//            LogUtils.e(TAG, "开始windows-------$it; ${it.root?.packageName}")</span>
<span class="hljs-comment">//        }</span>

        <span class="hljs-keyword">if</span>(!SettingsChangeObserver.checkIsCarSystem()){
            <span class="hljs-keyword">var</span> rootNodeOrigin = getRootNodeWithCache(event)

            lastCallBackTime = System.currentTimeMillis()
            lastActiveRootNodePackage = <span class="hljs-string">"<span class="hljs-subst">${rootNodeOrigin?.packageName?.toString() ?: <span class="hljs-string">""</span>}</span> child:<span class="hljs-subst">${rootNodeOrigin?.childCount}</span>"</span>

            windowArrStr = <span class="hljs-string">""</span>
            <span class="hljs-keyword">if</span>(isAbleToLog){
                windows.forEach {
                    windowArrStr += <span class="hljs-string">"<span class="hljs-subst">${it.root?.packageName}</span> - visible:<span class="hljs-subst">${it.root?.isVisibleToUser}</span> - active:<span class="hljs-subst">${it.isActive}</span> \n"</span>
                }
            }
            activeRootNodeVisible = rootNodeOrigin?.isVisibleToUser ?: <span class="hljs-literal">false</span>
            printLogOnDebug(<span class="hljs-string">"rootInActiveWindow-------<span class="hljs-subst">${rootNodeOrigin?.packageName}</span>; <span class="hljs-subst">${rootNodeOrigin?.windowId}</span>"</span>)

<span class="hljs-comment">//        for (w in windows) {</span>
<span class="hljs-comment">//            w.getBoundsInScreen(mRect)</span>
<span class="hljs-comment">//            //过滤顶部状态栏窗口</span>
<span class="hljs-comment">//            if (mRect.equalsXY(0, 0, 1920, 32)) continue</span>
<span class="hljs-comment">//            if (mRect.equalsXY(144, 0, 1920, 32)) continue</span>
<span class="hljs-comment">//            //过滤左边Dock栏窗口</span>
<span class="hljs-comment">//            if (mRect.equalsXY(0, 0, 144, 720)) continue</span>
<span class="hljs-comment">//            val pkName = w.root?.packageName</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//            if (pkName.isNullOrEmpty()) break</span>
<span class="hljs-comment">//            rootNode</span>
<span class="hljs-comment">//            // TODO V2处理</span>
<span class="hljs-comment">////            rootNode = HotwordsExecutorFactory.getHotwordsExecutor(pkName).interceptRootNode(windows, rootNode)</span>
<span class="hljs-comment">//            break</span>
<span class="hljs-comment">//        }</span>

            <span class="hljs-keyword">if</span> (rootNodeOrigin?.packageName == packageName || rootNodeOrigin?.childCount == <span class="hljs-number">0</span>) {
                windows.forEach {
                Log.d(
                    TAG, <span class="hljs-string">"""
                packageName:<span class="hljs-subst">${it?.root?.packageName}</span>
                isActive:<span class="hljs-subst">${it?.isActive}</span>
                isAccessibilityFocused:<span class="hljs-subst">${it?.isAccessibilityFocused}</span>
                """</span>.trimIndent()
                )
                    it.root?.takeIf { rn -&gt;
                        rn.packageName != packageName &amp;&amp; rn.childCount != <span class="hljs-number">0</span>
                    }?.apply {
                        LogUtils.d(TAG, <span class="hljs-string">"替换节点......."</span>+ rootNodeOrigin?.packageName )
                        rootNodeOrigin = <span class="hljs-keyword">this</span>
                    }
                }
            }
            <span class="hljs-keyword">val</span> rootNode = rootNodeOrigin

            lastLoadRootNodePackage = rootNode?.packageName?.toString() ?: <span class="hljs-string">""</span>

            printLogOnDebug(<span class="hljs-string">"rootNode-------<span class="hljs-subst">${rootNode?.packageName}</span>; <span class="hljs-subst">${rootNode?.windowId}</span>"</span>)

            <span class="hljs-keyword">if</span> (rootNode == <span class="hljs-literal">null</span> || event == <span class="hljs-literal">null</span>|| event.packageName.isNullOrEmpty()) {
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-keyword">if</span> (rootNode.packageName == packageName) {
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-keyword">try</span> {
                logNodeInfo(rootNode, event)
            } <span class="hljs-keyword">catch</span> (e: Exception) {

            }
            GlobalScope.launch(threadContext) {
                <span class="hljs-keyword">try</span> {
                    processBusinessLogic(rootNode)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    LogUtils.e(TAG, e.message)
                }
            }
        }<span class="hljs-keyword">else</span>{

            <span class="hljs-comment">// 第一步：在 threadRoot 线程中获取根节点</span>
            GlobalScope.launch(threadRoot) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
                    <span class="hljs-comment">// 获取根节点</span>
                    <span class="hljs-keyword">var</span> rootNode = rootInActiveWindow
                    <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
                    <span class="hljs-keyword">val</span> timeCost = endTime - startTime
                    <span class="hljs-keyword">if</span> (timeCost &gt; <span class="hljs-number">1000</span>) {
                        LogUtils.e(TAG, <span class="hljs-string">"获取最新rootInActiveWindow耗时超过1秒: <span class="hljs-subst">${timeCost}</span>ms"</span>+Thread.currentThread().name)
                        <span class="hljs-keyword">val</span> eventType = event?.let { AccessibilityEvent.eventTypeToString(it.eventType) } ?: <span class="hljs-string">"unknown"</span>
                        voiceAccessibilityPerformance.reportAccessibility(timeCost,eventType)
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isAbleToWindowLog){
                        LogUtils.i(TAG, <span class="hljs-string">"获取最新rootInActiveWindow耗时: <span class="hljs-subst">${timeCost}</span>ms"</span>+Thread.currentThread().name)
                    }

                    lastCallBackTime = System.currentTimeMillis()
                    lastActiveRootNodePackage = <span class="hljs-string">"<span class="hljs-subst">${rootNode?.packageName?.toString() ?: <span class="hljs-string">""</span>}</span> child:<span class="hljs-subst">${rootNode?.childCount}</span>"</span>
                    windowArrStr = <span class="hljs-string">""</span>

                    activeRootNodeVisible = rootNode?.isVisibleToUser ?: <span class="hljs-literal">false</span>
                    printLogOnDebug(<span class="hljs-string">"rootInActiveWindow-------<span class="hljs-subst">${rootNode?.packageName}</span>; <span class="hljs-subst">${rootNode?.windowId}</span>"</span>)

                    <span class="hljs-comment">// 窗口过滤逻辑（已注释，可根据需要启用）</span>
                    <span class="hljs-keyword">if</span> (rootNode?.packageName == packageName || rootNode?.childCount == <span class="hljs-number">0</span>) {
                        windows?.forEach { window -&gt;
                            window?.root?.takeIf { rn -&gt;
                                rn.packageName != packageName &amp;&amp; rn.childCount != <span class="hljs-number">0</span>
                            }?.apply {
                                rootNode = <span class="hljs-keyword">this</span>
                                LogUtils.d(TAG, <span class="hljs-string">"替换节点......."</span>)
                            }
                        }
                    }
</code></pre>
<blockquote>
<p>为什么修改悬浮窗的属性和替换window可以解决呢?</p>
</blockquote>
<p>先整理需求：</p>
<h4 data-id="heading-23">1.).需要能把悬浮窗的事件能触摸，就要用到 WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</h4>
<h4 data-id="heading-24">2).期望不影响下面window的交互，FLAG_NOT_FOCUSABLE</h4>
<p>FLAG_NOT_FOCUSABLE ： 焦点是干嘛的?
只有设置了这个，才能扫描到window对象</p>
<p><strong>场景1：设置了 FLAG_NOT_FOCUSABLE</strong></p>
<p>// 你的悬浮窗代码：
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
// 用户操作和结果：</p>
<ol>
<li>用户点击悬浮窗内的 EditText → ❌ 软键盘不会弹出</li>
<li>用户按物理键盘 → ❌ 悬浮窗收不到按键事件</li>
<li>用户按返回键 → ❌ 悬浮窗收不到返回键事件</li>
<li>用户按音量键 → ❌ 悬浮窗收不到音量键事件</li>
</ol>
<p><strong>场景2：没有设置 FLAG_NOT_FOCUSABLE</strong>
// 不设置 FLAG_NOT_FOCUSABLE：
// layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE; // 注释掉</p>
<p>// 用户操作和结果：</p>
<ol>
<li>用户点击悬浮窗内的 EditText → ✅ 软键盘弹出</li>
<li>用户按物理键盘 → ✅ 悬浮窗收到按键事件</li>
<li>用户按返回键 → ✅ 悬浮窗收到返回键事件</li>
<li>用户按音量键 → ✅ 悬浮窗收到音量键事件</li>
</ol>
<p><strong>Q1：设置了 FLAG_NOT_FOCUSABLE，为什么还能收到触摸事件？</strong>
A：焦点和触摸是分开的。FLAG_NOT_FOCUSABLE 只影响键盘/按键事件，不影响触摸事件。要阻止触摸，需要设置 FLAG_NOT_TOUCHABLE。</p>
<p><strong>Q2：WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</strong>
和只设置了WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,有什么区别</p>
<p>FLAG_NOT_TOUCH_MODAL 的作用？
默认情况下，悬浮窗会模态拦截所有触摸事件（即使点击空白区，底层也收不到）
加上此 flag 后：
悬浮窗区域内：自己处理事件
区域外：事件传递给下层窗口
<strong>Q3：// 设置窗口标志 - 允许点击外部关闭</strong>
params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</p>
<p><strong>Q4：// 设置窗口标志 - 允许点击外部关闭</strong>
这个必须配合flag一起使用, 否则也不生效
WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;</p>
<p><strong>Q5：这3个步骤到底事什么意思</strong></p>
<p>int canTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;
int cantTouchFlag = WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;</p>
<pre><code class="hljs language-ini" lang="ini">    layoutParams.flags |= canTouchFlag<span class="hljs-comment">;</span>
    layoutParams.flags |= cantTouchFlag<span class="hljs-comment">;</span>
    layoutParams.flags ^= cantTouchFlag<span class="hljs-comment">;</span>
</code></pre>
<p>这个是什么意思
经过这三步运算后：</p>
<p>✅ 设置了 FLAG_NOT_TOUCH_MODAL</p>
<p>❌ 移除了 FLAG_NOT_TOUCHABLE</p>
<p>❌ 移除了 FLAG_NOT_FOCUSABLE</p>
<p>等价于：</p>
<p>// 设置 NOT_TOUCH_MODAL
layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<h3 data-id="heading-25">4.3 总结：  焦点和触摸事件是2回事！</h3>
<h6 data-id="heading-26">1）.触摸响应： 只和这个有关系</h6>
<p>layoutParams.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<h6 data-id="heading-27">2).  悬浮窗的事件分发问题：</h6>
<p>设置 FLAG_NOT_FOCUSABLE + FLAG_NOT_TOUCH_MODAL
onTouchEvent 返回 false， 我发现下面的launcher应用，不能接收到点击事件</p>
<p>结论：事件透传，(只和FLAG_NOT_TOUCHABLE有关系，注意不是FLAG_NOT_FOCUSABLE ，不遵循事件分发原理)！
权限和系统限制：一些系统为了安全，限制了悬浮窗与底层应用的交互</p>
<p>系统安全机制禁止应用直接干预其他应用的事件流。</p>
<p>悬浮窗事件透传机制</p>
<p>● FLAG_NOT_FOCUSABLE：窗口不获取焦点，但仍可接收触摸事件(自己得到事件)</p>
<p>● FLAG_NOT_TOUCH_MODAL：窗口区域内的触摸事件自己处理，区域外的传递给后面</p>
<p>● FLAG_NOT_TOUCHABLE：完全不接收任何触摸事件，全部传递给后面(全部给了底层)</p>
<p>Android悬浮窗事件分发遵循以下基本流程：</p>
<ol>
<li>输入系统检测触摸事件</li>
<li>WindowManagerService确定目标窗口</li>
<li>悬浮窗的事件分发只能针对自己的窗口，不能分发给其他窗口</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp">    <span class="hljs-comment">/**
     * 设置红色区域点击关闭功能, 点击到cardView不消失
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setupTransparentAreaClick</span>()</span> {
        <span class="hljs-keyword">if</span> (mAsrView == <span class="hljs-literal">null</span>) {
            LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: mAsrView is null"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 获取根布局</span>
        View rootView = mAsrView.findViewById(R.id.root_view);

        <span class="hljs-keyword">if</span> (rootView == <span class="hljs-literal">null</span> || cardView == <span class="hljs-literal">null</span>) {
            LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: rootView or cardView is null"</span>);
            <span class="hljs-keyword">return</span>;
        }

        LogUtils.d(TAG, <span class="hljs-string">"setupTransparentAreaClick: rootView="</span> + rootView + <span class="hljs-string">", cardView="</span> + cardView);

        rootView.setOnTouchListener(<span class="hljs-keyword">new</span> View.OnTouchListener() {
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> touchStartTime = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> touchStartX = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> touchStartY = <span class="hljs-number">0</span>;

            @Override
            <span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">onTouch</span>(<span class="hljs-params">View v, MotionEvent <span class="hljs-keyword">event</span></span>)</span> {
                <span class="hljs-keyword">if</span> (mAsrView == <span class="hljs-literal">null</span>) {
                    LogUtils.e(TAG, <span class="hljs-string">"onTouch: mAsrView=null!!"</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-built_in">int</span> action = <span class="hljs-keyword">event</span>.getAction();
                <span class="hljs-built_in">float</span> currentX = <span class="hljs-keyword">event</span>.getX();
                <span class="hljs-built_in">float</span> currentY = <span class="hljs-keyword">event</span>.getY();

                <span class="hljs-keyword">switch</span> (action) {
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                        touchStartTime = System.currentTimeMillis();
                        touchStartX = currentX;
                        touchStartY = currentY;

                        LogUtils.d(TAG, <span class="hljs-string">"ACTION_DOWN: x="</span> + currentX + <span class="hljs-string">", y="</span> + currentY);
                        LogUtils.d(TAG, <span class="hljs-string">"rootView bounds: width="</span> + rootView.getWidth() + <span class="hljs-string">", height="</span> + rootView.getHeight());
                        LogUtils.d(TAG, <span class="hljs-string">"cardView bounds: left="</span> + cardView.getLeft() + <span class="hljs-string">", top="</span> + cardView.getTop() +
                                <span class="hljs-string">", right="</span> + cardView.getRight() + <span class="hljs-string">", bottom="</span> + cardView.getBottom());

                        <span class="hljs-comment">// 判断点击是否在cardView区域内</span>
                        boolean isInsideCardView = isPointInsideView(currentX, currentY, cardView);
                        LogUtils.d(TAG, <span class="hljs-string">"isInsideCardView: "</span> + isInsideCardView);

                        <span class="hljs-comment">// 如果点击在cardView内，不处理，让子View处理</span>
                        <span class="hljs-keyword">if</span> (isInsideCardView) {
                            LogUtils.d(TAG, <span class="hljs-string">"点击在cardView内，不处理触摸事件"</span>);
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                        }
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
<span class="hljs-comment">//                        LogUtils.d(TAG, "ACTION_MOVE: x=" + currentX + ", y=" + currentY);</span>
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                        <span class="hljs-built_in">long</span> touchDuration = System.currentTimeMillis() - touchStartTime;
                        <span class="hljs-built_in">float</span> deltaX = Math.abs(currentX - touchStartX);
                        <span class="hljs-built_in">float</span> deltaY = Math.abs(currentY - touchStartY);

                        LogUtils.d(TAG, <span class="hljs-string">"ACTION_UP: x="</span> + currentX + <span class="hljs-string">", y="</span> + currentY +
                                <span class="hljs-string">", duration="</span> + touchDuration + <span class="hljs-string">"ms, deltaX="</span> + deltaX + <span class="hljs-string">", deltaY="</span> + deltaY);

                        <span class="hljs-comment">// 判断是否是点击事件（不是滑动）</span>
                        <span class="hljs-keyword">if</span> (touchDuration &lt; <span class="hljs-number">500</span> &amp;&amp; deltaX &lt; <span class="hljs-number">50</span> &amp;&amp; deltaY &lt; <span class="hljs-number">50</span>) {
                            boolean isInside = isPointInsideView(currentX, currentY, cardView);
                            LogUtils.d(TAG, <span class="hljs-string">"点击事件处理: isInsideCardView="</span> + isInside);

                            <span class="hljs-comment">// 如果点击在cardView外，关闭界面</span>
                            <span class="hljs-keyword">if</span> (!isInside) {
                                LogUtils.i(<span class="hljs-string">"baidu"</span>, <span class="hljs-string">"点击在cardView外部，触发关闭"</span>);
                                stopDialog();
                                LogUtils.i(<span class="hljs-string">"baidu"</span>, <span class="hljs-string">"点击在cardView外部，触发关闭====="</span>);
                                AsrUiManger.getPhone().sendTimeoutDelayTime(<span class="hljs-number">1500</span>);

                                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                            } <span class="hljs-keyword">else</span> {
                                LogUtils.d(TAG, <span class="hljs-string">"点击在cardView内部，不触发关闭"</span>);
                            }
                        } <span class="hljs-keyword">else</span> {
                            LogUtils.d(TAG, <span class="hljs-string">"滑动事件，不触发关闭"</span>);
                        }
                        <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        });
    }
</code></pre>
<h6 data-id="heading-28">3).FLAG 标志含义</h6>
<p>FLAG_NOT_FOCUSABLE: 窗口不获取输入焦点，但可接收触摸</p>
<p>FLAG_NOT_TOUCH_MODAL: 窗口外部触摸传递给下层</p>
<p>FLAG_WATCH_OUTSIDE_TOUCH: 可接收窗口外部的触摸事件</p>
<p>FLAG_NOT_TOUCHABLE: 完全不接收触摸事件</p>
<h2 data-id="heading-29">5.最终建议</h2>
<p>采用方案三的优化悬浮窗属性 + 智能无障碍服务处理</p>
<p>悬浮窗设置为半透明、不获取焦点、允许触摸穿透</p>
<p>在系统弹框出现时，自动将悬浮窗缩小/淡化</p>
<p>无障碍服务实现智能根节点查找算法</p>
<p>这样既能保证悬浮窗的功能，又能让系统弹框正常被无障碍服务扫描到，实现"可见即可说"的完整功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Anthropic 如何评估 AI Agent]]></title>    <link>https://juejin.cn/post/7594396523440554019</link>    <guid>https://juejin.cn/post/7594396523440554019</guid>    <pubDate>2026-01-13T06:23:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396523440554019" data-draft-id="7594396368174661667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Anthropic 如何评估 AI Agent"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-13T06:23:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Anthropic 如何评估 AI Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:23:48.000Z" title="Tue Jan 13 2026 06:23:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：打破“盲目飞行”的开发循环</h2>
<p>在开发AI智能体的过程中，许多团队都经历过这样的痛点：你修复了一个问题，却在不经意间引发了另一个更隐蔽的问题。如果没有一套可靠的评估体系，整个开发过程就像是在“盲目飞行”，团队陷入被动修复的循环，难以自信地发布新版本。</p>
<p>有效的评估（evals）正是打破这一困境的关键。它能让智能体在行为上的变化和潜在问题在影响用户之前就变得清晰可见。本文将从Anthropic的深度分享中，提炼出五个最令人惊讶、最具影响力的核心教训，它们将彻底改变你对AI智能体评估的看法。</p>
<h2 data-id="heading-1">五个关于AI智能体评估的反直觉教训</h2>
<h3 data-id="heading-2">教训一：别等了，从20个失败案例开始构建你的评估体系</h3>
<p>团队在项目初期常常认为构建评估体系是一项巨大的“开销”，会拖慢产品上市的进度，因此选择推迟。他们认为，等产品功能稳定、规模化之后再来考虑评估也不迟。</p>
<p>然而，Anthropic的经验恰恰相反：等到智能体规模化后才开始构建评估，你会遇到更大的困难。更重要的是，评估的价值会随着时间复利增长。早期投入不仅不会拖慢你，反而会成为未来加速迭代的引擎。那么，该如何开始呢？其实门槛比你想象的要低得多：</p>
<p>“实际上，一套由20-50个源自真实失败案例的简单任务，就是一个绝佳的起点。”</p>
<p>这个观点之所以重要，是因为它彻底打破了“评估体系必须庞大而完美”的误区。这不仅仅是关于避免技术债，更是为了获得开发过程中的能见度。用一小组真实的失败案例起步，就等于为你的驾驶舱安装了第一批仪表，让你停止“盲目飞行”，开始用数据导航。</p>
<h3 data-id="heading-3">教训二：当你的智能体“失败”时，可能恰恰是天才的体现</h3>
<p>我们通常认为，评估失败就意味着智能体犯了错。但有时，这种“失败”恰恰是其卓越创造力的体现。</p>
<p>以Anthropic提到的 Opus 4.5 模型为例，在一个预订航班的测试任务中，它没有遵循预设的流程，而是通过发现政策中的一个漏洞，为用户找到了一个更好的解决方案。从字面上看，它“失败”了这次评估，因为它没有按照人类设计的死板路径执行任务。但从用户的角度看，它取得了巨大的成功。</p>
<p>“它‘失败’了书面上的评估，但实际上为用户想出了一个更好的解决方案。”</p>
<p>这个例子深刻地揭示了静态评估的局限性。这并非简单的程序错误，而是前沿模型的一个典型特征：它们的解决问题的能力，已经开始超越那些嵌入在旧式评估里的、基于静态规则的假设。依赖僵化的路径评估无异于另一种“盲目飞行”，因为它让你对模型自身的天才之处视而不见。学会识别这些“天才般”的失败，才能让你真正看清你所解锁的前沿能力。</p>
<h3 data-id="heading-4">教训三：评估终点，而非过程</h3>
<p>在评估智能体时，一个常见的错误是检查它是否遵循了一套非常具体的步骤，比如是否按照特定顺序调用了某些工具。这种方法看似严谨，实则非常脆弱。</p>
<p>Anthropic指出，这种方法“过于僵化，会导致测试过于脆弱”，因为它会惩罚那些评估设计者未曾预料到的、同样有效的创新方法。一个更优越、更具前瞻性的做法是：评估智能体最终产出的成果（outcome），而不是它所采取的具体路径（path）。</p>
<p>例如，与其检查一个编码智能体是否调用了某个特定的编辑函数，不如直接评估它生成的代码是否通过了所有的单元测试。专注于过程本身就是一种“盲目飞行”，因为它让你对那些更优越、未曾预见的解决方案视而不见。而专注于最终成果，才是获得智能体究竟为用户完成了什么的真实视野。这一教训对于释放AI智能体的全部潜力至关重要。</p>
<h3 data-id="heading-5">教训四：你的指标在衡量什么：一次成功还是次次可靠？</h3>
<p>“我们的智能体成功率是75%。” 这句话听起来不错，但它可能隐藏着巨大的误导性。你需要问一个更深层次的问题：这个成功率衡量的是什么？是多次尝试中的一次成功，还是每一次尝试都必须成功？这里有两个关键指标：pass@k 和 pass^k。</p>
<ul>
<li>pass@k 衡量的是智能体在 k 次尝试中至少有一次成功的可能性。你可以把它比作“多次射门，只要进一个球就算成功”。这个指标适用于那些只要找到一个可行解就行的场景，比如代码生成或创意构思。</li>
<li>pass^k 衡量的是智能体在全部 k 次尝试中每次都成功的概率。这更像是“要求每次射门都必须命中”。对于需要高度可靠和一致性的面向客户的智能体来说，这个指标至关重要。</li>
</ul>
<p>这两个指标的差异巨大。例如，如果一个智能体的单次成功率（pass@1）是75%，那么它连续成功3次的概率（pass^3）就骤降至42.1875%，约等于42% (0.75 x 0.75 x 0.75)。</p>
<p>为需要高可靠性的面向客户的智能体使用 pass@k 指标，是导致用户流失的温床。因为75%的单次成功率掩盖了在仅仅三次交互中，性能稳定率甚至不足50%的残酷事实。这不仅仅是统计学上的选择，更是决定产品定位的战略抉择。你是在打造一个创意性的头脑风暴伙伴，十次尝试有一次绝妙点子就算巨大成功（pass@k）？还是在构建一个关键任务型支持助手，任何低于近乎完美的可靠性都是不可接受的（pass^k）？你的指标选择，决定了你的优化方向。</p>
<h3 data-id="heading-6">教训五：你最强大的评估工具不是代码，而是你的眼睛</h3>
<p>在追求自动化的过程中，我们很容易过度依赖冷冰冰的评估分数。然而，分数可能是骗人的。一个误导性的低分可能不是因为智能体失败了，而是因为评估本身存在缺陷。</p>
<p>例如，Anthropic在对Opus 4.5模型进行CORE-Bench基准测试时，通过人工审查记录发现，其分数从最初的42%跃升至95%。原因何在？仅仅是修复了评估系统中的问题，比如过于僵化的评分标准（它会因为“96.12”与预期格式“96.124991…”不完全匹配而判定为错误）。如果没有阅读完整的试验记录（transcript），团队会错误地认为模型的能力远比实际情况要差。</p>
<p>“阅读记录是验证你的评估是否在衡量真正重要的事情的方式，也是智能体开发的一项关键技能。”</p>
<p>信任分数而不去阅读记录，是终极的“盲目飞行”——仪表盘显示你在急速下坠，但实际上你可能飞得比以往任何时候都高，只是你的仪表坏了。自动化工具告诉你“是什么”（分数是42%），但只有深入审查记录才能揭示“为什么”——不是因为模型不行，而是因为评估本身存在缺陷。</p>
<h2 data-id="heading-7">结论：将评估视为核心战略，而非事后弥补</h2>
<p>有效的评估不是开发过程中的负担，而是一种能够加速开发、确保质量的核心战略资产。它能将团队成员模糊的“感觉变差了”转化为了清晰、可操作的衡量指标。</p>
<p>成功的AI团队都明白一个道理：评估体系是产品不可或缺的一部分，其重要性不亚于单元测试之于传统软件。而且，在模型能力飞速发展的时代，一个强大的评估套件就是你的护城河。它能让你在几天内验证并部署更先进的模型，而你的竞争对手可能还在数周的手动测试中苦苦挣扎。</p>
<p>如果你的评估体系反映了你最看重的东西，那么它正在讲述一个关于你智能体的核心故事。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3规范化示例]]></title>    <link>https://juejin.cn/post/7594385386739941395</link>    <guid>https://juejin.cn/post/7594385386739941395</guid>    <pubDate>2026-01-13T06:09:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386739941395" data-draft-id="7594403873177354281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3规范化示例"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:09:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一尘子"/> <meta itemprop="url" content="https://juejin.cn/user/2142267148862040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3规范化示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2142267148862040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一尘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:09:27.000Z" title="Tue Jan 13 2026 06:09:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、层级分离原则</h2>
<h3 data-id="heading-1">1. 模板层（UI）分离</h3>
<h4 data-id="heading-2">❌ 反例：模板中写复杂表达式和数据操作</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 反例1: 模板中写复杂表达式 --&gt;
    &lt;div&gt;
      {{ goodsList.filter(item =&gt; item.price &gt; 100).map(item =&gt; item.name).join(',') }}
    &lt;/div&gt;
    
    &lt;!-- 反例2: 直接在模板中修改数据 --&gt;
    &lt;button @click="goodsList.push({ id: Date.now(), name: '新商品', price: 99 })"&gt;
      添加商品
    &lt;/button&gt;
    
    &lt;!-- 反例3: 模板中写复杂计算 --&gt;
    &lt;div&gt;
      总价: {{ goodsList.reduce((sum, item) =&gt; sum + item.price * item.count, 0).toFixed(2) }}
    &lt;/div&gt;
    
    &lt;!-- 反例4: 用样式控制业务逻辑 --&gt;
    &lt;div :style="{ display: isVisible ? 'block' : 'none' }"&gt;
      内容
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const goodsList = ref([
  { id: 1, name: '商品A', price: 150, count: 2 },
  { id: 2, name: '商品B', price: 80, count: 1 },
]);
const isVisible = ref(true);
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">✅ 正例：模板只负责渲染，逻辑放在 computed/methods</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 正例1: 调用简单的 computed --&gt;
    &lt;div&gt;{{ filteredGoodsNames }}&lt;/div&gt;
    
    &lt;!-- 正例2: 调用方法处理事件 --&gt;
    &lt;button @click="handleAddGoods"&gt;添加商品&lt;/button&gt;
    
    &lt;!-- 正例3: 使用 computed 计算总价 --&gt;
    &lt;div&gt;总价: {{ totalPrice }}&lt;/div&gt;
    
    &lt;!-- 正例4: 用 v-if 控制渲染 --&gt;
    &lt;div v-if="isVisible"&gt;内容&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';

// 原始数据
const goodsList = ref([
  { id: 1, name: '商品A', price: 150, count: 2 },
  { id: 2, name: '商品B', price: 80, count: 1 },
]);
const isVisible = ref(true);

// 数据处理放在 computed
const filteredGoodsNames = computed(() =&gt; {
  return goodsList.value
    .filter(item =&gt; item.price &gt; 100)
    .map(item =&gt; item.name)
    .join(',');
});

const totalPrice = computed(() =&gt; {
  return goodsList.value
    .reduce((sum, item) =&gt; sum + item.price * item.count, 0)
    .toFixed(2);
});

// 事件处理放在 methods
const handleAddGoods = () =&gt; {
  goodsList.value.push({
    id: Date.now(),
    name: '新商品',
    price: 99,
    count: 1,
  });
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">2. 逻辑层（数据）分离</h3>
<h4 data-id="heading-5">❌ 反例：在 data 中存储派生数据，在模板中直接调用接口</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 反例: 在模板中直接调用接口 --&gt;
    &lt;button @click="fetchGoods"&gt;加载商品&lt;/button&gt;
    &lt;div v-for="item in formattedList" :key="item.id"&gt;
      {{ item.displayName }} - ¥{{ item.formattedPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import axios from 'axios';

// 反例1: 存储格式化后的派生数据
const formattedList = ref([
  { id: 1, displayName: '商品A', formattedPrice: '150.00' },
]);

// 反例2: 在事件中直接写接口请求
const fetchGoods = () =&gt; {
  axios.get('/api/goods').then(res =&gt; {
    // 每次都要手动格式化并同步到 formattedList
    formattedList.value = res.data.map((item: any) =&gt; ({
      id: item.id,
      displayName: `${item.name} (${item.category})`,
      formattedPrice: item.price.toFixed(2),
    }));
  });
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-6">✅ 正例：data 只存原始数据，computed 处理派生数据，接口抽离到 api</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;button @click="handleFetchGoods" :loading="loading"&gt;加载商品&lt;/button&gt;
    &lt;div v-for="item in formattedGoodsList" :key="item.id"&gt;
      {{ item.displayName }} - ¥{{ item.formattedPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { fetchGoodsList } from '@/api/goods'; // 接口抽离到 api

// 正例1: data 只存储原始数据
const goodsList = ref([]);
const loading = ref(false);

// 正例2: 派生数据用 computed 自动计算
const formattedGoodsList = computed(() =&gt; {
  return goodsList.value.map(item =&gt; ({
    id: item.id,
    displayName: `${item.name} (${item.category})`,
    formattedPrice: item.price.toFixed(2),
  }));
});

// 正例3: 接口请求和业务逻辑抽离
const handleFetchGoods = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = res.data; // 只更新原始数据，computed 自动更新
  } catch (error) {
    console.error('加载失败', error);
  } finally {
    loading.value = false;
  }
};
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/api/goods.ts - 接口抽离</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGoodsList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/goods'</span>);
};
</code></pre>
<h3 data-id="heading-7">3. 组件层（业务解耦）</h3>
<h4 data-id="heading-8">❌ 反例：通用组件包含业务逻辑</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Table.vue - 反例: 通用组件直接调用业务接口 --&gt;
&lt;template&gt;
  &lt;el-table :data="tableData" :loading="loading"&gt;
    &lt;el-table-column prop="name" label="名称" /&gt;
    &lt;el-table-column prop="price" label="价格" /&gt;
  &lt;/el-table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue';
import axios from 'axios';

// 反例: 通用组件内部直接调用业务接口
const tableData = ref([]);
const loading = ref(false);

onMounted(() =&gt; {
  loading.value = true;
  axios.get('/api/goods').then(res =&gt; {
    tableData.value = res.data;
    loading.value = false;
  });
});
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue - 反例: 父组件传原始数据，子组件内部格式化 --&gt;
&lt;template&gt;
  &lt;Table :data="goodsList" /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import Table from './Table.vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);

const loadData = async () =&gt; {
  const res = await fetchGoodsList();
  goodsList.value = res.data; // 传原始数据给子组件
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">✅ 正例：通用组件只接收 props，业务组件处理数据</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Table.vue - 正例: 通用组件只接收 props，不包含业务逻辑 --&gt;
&lt;template&gt;
  &lt;el-table :data="data" :loading="loading" v-bind="$attrs"&gt;
    &lt;slot /&gt;
  &lt;/el-table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  data: any[];
  loading?: boolean;
}&gt;();
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue - 正例: 业务组件处理数据，传给通用组件 --&gt;
&lt;template&gt;
  &lt;Table :data="formattedGoodsList" :loading="loading"&gt;
    &lt;el-table-column prop="name" label="名称" /&gt;
    &lt;el-table-column prop="price" label="价格" /&gt;
  &lt;/Table&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import Table from './Table.vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);
const loading = ref(false);

// 业务组件负责数据格式化
const formattedGoodsList = computed(() =&gt; {
  return goodsList.value.map(item =&gt; ({
    ...item,
    price: `¥${item.price.toFixed(2)}`,
  }));
});

const loadData = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = res.data;
  } finally {
    loading.value = false;
  }
};

loadData();
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-10">二、拆分原则</h2>
<h3 data-id="heading-11">1. 函数拆分</h3>
<h4 data-id="heading-12">❌ 反例：过度拆分，逻辑分散</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/goods-list/getItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], id: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id);
};

<span class="hljs-comment">// src/utils/goods-list/setItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], item: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> index = list.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> === item.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
    list[index] = item;
  }
};

<span class="hljs-comment">// src/utils/goods-list/checkItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkItem</span> = (<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> item &amp;&amp; item.<span class="hljs-property">price</span> &gt; <span class="hljs-number">0</span>;
};

<span class="hljs-comment">// src/utils/goods-list/filterItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterItem</span> = (<span class="hljs-params">list: <span class="hljs-built_in">any</span>[], condition: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">price</span> &gt; condition.<span class="hljs-property">minPrice</span>);
};

<span class="hljs-comment">// GoodsList.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/getItem'</span>;
<span class="hljs-keyword">import</span> { setItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/setItem'</span>;
<span class="hljs-keyword">import</span> { checkItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/checkItem'</span>;
<span class="hljs-keyword">import</span> { filterItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/goods-list/filterItem'</span>;

<span class="hljs-comment">// 调用时需要跨文件引入，逻辑链路变长</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpdate</span> = (<span class="hljs-params">id: number, newData: any</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = <span class="hljs-title function_">getItem</span>(goodsList.<span class="hljs-property">value</span>, id);
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">checkItem</span>(item)) {
    <span class="hljs-title function_">setItem</span>(goodsList.<span class="hljs-property">value</span>, { ...item, ...newData });
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-13">✅ 正例：按业务逻辑拆分，函数内聚</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GoodsList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { fetchGoodsList } from '@/api/goods';

const goodsList = ref([]);
const loading = ref(false);

// 正例: 按业务逻辑拆分成核心函数，函数内聚
const loadGoodsData = async () =&gt; {
  try {
    loading.value = true;
    const res = await fetchGoodsList();
    goodsList.value = formatGoodsData(res.data);
  } catch (error) {
    console.error('加载失败', error);
  } finally {
    loading.value = false;
  }
};

// 格式化数据 - 仅当前组件使用，写在组件内
const formatGoodsData = (data: any[]) =&gt; {
  return data.map(item =&gt; ({
    ...item,
    displayPrice: `¥${item.price.toFixed(2)}`,
    isAvailable: item.stock &gt; 0,
  }));
};

// 如需复用，再抽离到 utils/goods.ts
loadGoodsData();
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-14">2. 组件拆分</h3>
<h4 data-id="heading-15">❌ 反例：过度拆分，增加通信成本</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- SearchInput.vue --&gt;
&lt;template&gt;
  &lt;el-input v-model="inputValue" @input="handleInput" /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const inputValue = defineModel&lt;string&gt;('modelValue');
const emit = defineEmits(['update:modelValue']);

const handleInput = (value: string) =&gt; {
  emit('update:modelValue', value);
};
&lt;/script&gt;

&lt;!-- SearchButton.vue --&gt;
&lt;template&gt;
  &lt;el-button @click="handleClick"&gt;{{ text }}&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{ text: string }&gt;();
const emit = defineEmits(['click']);

const handleClick = () =&gt; {
  emit('click');
};
&lt;/script&gt;

&lt;!-- SearchWrapper.vue --&gt;
&lt;template&gt;
  &lt;div class="search-wrapper"&gt;
    &lt;SearchInput v-model="keyword" /&gt;
    &lt;SearchButton text="搜索" @click="handleSearch" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import SearchInput from './SearchInput.vue';
import SearchButton from './SearchButton.vue';

const keyword = ref('');
const emit = defineEmits(['search']);

const handleSearch = () =&gt; {
  emit('search', keyword.value);
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-16">✅ 正例：保留单个组件，内部封装</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- SearchBar.vue - 正例: 单个组件，逻辑闭环 --&gt;
&lt;template&gt;
  &lt;div class="search-bar"&gt;
    &lt;el-input v-model="keyword" placeholder="请输入关键词" clearable /&gt;
    &lt;el-button type="primary" @click="handleSearch"&gt;搜索&lt;/el-button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';

const keyword = ref('');
const emit = defineEmits(['search']);

const handleSearch = () =&gt; {
  emit('search', keyword.value);
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-17">三、目录拆分原则</h2>
<h3 data-id="heading-18">组件目录结构说明</h3>
<p>当工具函数、样式、组合式函数仅被单个组件使用时，应放在该组件所在目录下，而不是全局 <code>src/utils</code>。</p>
<pre><code class="hljs language-bash" lang="bash">组件目录结构示例：
ProductList/
  ├── index.vue              <span class="hljs-comment"># 主组件</span>
  ├── index.scss             <span class="hljs-comment"># 组件样式</span>
  ├── composables/           <span class="hljs-comment"># 仅当前组件使用的组合式函数</span>
  │   ├── useProductData.ts
  │   └── useProductFilter.ts
  ├── utils/                 <span class="hljs-comment"># 仅当前组件使用的工具函数</span>
  │   ├── formatProduct.ts
  │   └── validateProduct.ts
  └── components/            <span class="hljs-comment"># 仅当前组件使用的子组件</span>
      └── ProductCard.vue
</code></pre>
<h3 data-id="heading-19">1. 工具函数拆分</h3>
<h4 data-id="heading-20">❌ 反例：仅单组件使用的函数放在全局 utils</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  utils/
    product-list/            <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
      formatProduct.ts
      filterProduct.ts
      validateProduct.ts
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { formatProduct } from '@/utils/product-list/formatProduct';
import { filterProduct } from '@/utils/product-list/filterProduct';
import { validateProduct } from '@/utils/product-list/validateProduct';

// 引入路径长，且这些函数只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-21">✅ 正例：仅当前组件使用的工具函数放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── utils/                 <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── formatProduct.ts
  │   └── filterProduct.ts
  └── index.scss
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/utils/formatProduct.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductPrice = (<span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`¥<span class="hljs-subst">${price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductName = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">category</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span> (<span class="hljs-subst">${category}</span>)`</span>;
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/utils/filterProduct.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterByPriceRange</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[], min: <span class="hljs-built_in">number</span>, max: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">price</span> &gt;= min &amp;&amp; p.<span class="hljs-property">price</span> &lt;= max);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">filterByCategory</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[], category: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">category</span> === category);
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import { ref, computed } from 'vue';
import { formatProductPrice, formatProductName } from './utils/formatProduct';
import { filterByPriceRange } from './utils/filterProduct';

const products = ref([]);

// 引入路径短，且明确表示这些函数属于当前组件
const formattedProducts = computed(() =&gt; {
  return products.value.map(p =&gt; ({
    ...p,
    displayPrice: formatProductPrice(p.price),
    displayName: formatProductName(p.name, p.category),
  }));
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-22">2. 组合式函数（Composables）拆分</h3>
<h4 data-id="heading-23">❌ 反例：仅单组件使用的 composable 放在全局</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  composables/
    useProductData.ts        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
    useProductFilter.ts      <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import { useProductData } from '@/composables/useProductData';
import { useProductFilter } from '@/composables/useProductFilter';

// 看起来像是全局可复用的，但实际上只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-24">✅ 正例：仅当前组件使用的 composable 放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── composables/           <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── useProductData.ts
  │   └── useProductFilter.ts
  └── index.scss
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/composables/useProductData.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { fetchProductList } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/product'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useProductData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> products = <span class="hljs-title function_">ref</span>([]);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadProducts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProductList</span>();
      products.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err;
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">const</span> formattedProducts = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> products.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> ({
      ...p,
      <span class="hljs-attr">displayPrice</span>: <span class="hljs-string">`¥<span class="hljs-subst">${p.price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
    }));
  });

  <span class="hljs-keyword">return</span> {
    products,
    formattedProducts,
    loading,
    error,
    loadProducts,
  };
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/product/ProductList/composables/useProductFilter.ts</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useProductFilter</span> = (<span class="hljs-params">products: <span class="hljs-built_in">any</span>[]</span>) =&gt; {
  <span class="hljs-keyword">const</span> searchKeyword = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> priceRange = <span class="hljs-title function_">ref</span>([<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>]);
  <span class="hljs-keyword">const</span> selectedCategory = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

  <span class="hljs-keyword">const</span> filteredProducts = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> result = products.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 按关键词过滤</span>
    <span class="hljs-keyword">if</span> (searchKeyword.<span class="hljs-property">value</span>) {
      result = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span>
        p.<span class="hljs-property">name</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(searchKeyword.<span class="hljs-property">value</span>.<span class="hljs-title function_">toLowerCase</span>())
      );
    }

    <span class="hljs-comment">// 按价格范围过滤</span>
    result = result.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">price</span> &gt;= priceRange.<span class="hljs-property">value</span>[<span class="hljs-number">0</span>] &amp;&amp; p.<span class="hljs-property">price</span> &lt;= priceRange.<span class="hljs-property">value</span>[<span class="hljs-number">1</span>]
    );

    <span class="hljs-comment">// 按分类过滤</span>
    <span class="hljs-keyword">if</span> (selectedCategory.<span class="hljs-property">value</span>) {
      result = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">category</span> === selectedCategory.<span class="hljs-property">value</span>);
    }

    <span class="hljs-keyword">return</span> result;
  });

  <span class="hljs-keyword">return</span> {
    searchKeyword,
    priceRange,
    selectedCategory,
    filteredProducts,
  };
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import { useProductData } from './composables/useProductData';
import { useProductFilter } from './composables/useProductFilter';
import { onMounted } from 'vue';

// 引入路径短，且明确表示这些 composable 属于当前组件
const { formattedProducts, loading, loadProducts } = useProductData();
const { searchKeyword, priceRange, filteredProducts } = useProductFilter(formattedProducts);

onMounted(() =&gt; {
  loadProducts();
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;input v-model="searchKeyword" placeholder="搜索商品" /&gt;
    &lt;div v-for="product in filteredProducts" :key="product.id"&gt;
      {{ product.displayName }} - {{ product.displayPrice }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-25">3. 样式拆分</h3>
<h4 data-id="heading-26">❌ 反例：仅单组件使用的样式放在全局</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  styles/
    product-list.scss        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;style lang="scss"&gt;
@use '@/styles/product-list.scss';
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-27">✅ 正例：仅当前组件使用的样式放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── index.scss             <span class="hljs-comment"># 正例：组件主样式</span>
  ├── styles/                <span class="hljs-comment"># 正例：样式拆分（如果样式较多）</span>
  │   ├── variables.scss
  │   └── mixins.scss
  └── components/
      └── ProductCard.vue
      └── ProductCard.scss
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/index.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">@use</span> <span class="hljs-string">'./styles/variables.scss'</span>;
<span class="hljs-keyword">@use</span> <span class="hljs-string">'./styles/mixins.scss'</span>;

<span class="hljs-selector-class">.product-list</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  
  &amp;__header {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: space-between;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  }
  
  &amp;__content {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/styles/variables.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-variable">$product-card-width</span>: <span class="hljs-number">200px</span>;
<span class="hljs-variable">$product-card-gap</span>: <span class="hljs-number">16px</span>;
<span class="hljs-variable">$product-header-height</span>: <span class="hljs-number">60px</span>;
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/views/product/ProductList/styles/mixins.scss</span>
<span class="hljs-comment">// 仅 ProductList 组件使用</span>
<span class="hljs-keyword">@mixin</span> product-card-hover {
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span>;
  
  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>);
  }
}
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;template&gt;
  &lt;div class="product-list"&gt;
    &lt;div class="product-list__header"&gt;...&lt;/div&gt;
    &lt;div class="product-list__content"&gt;...&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped lang="scss"&gt;
@import './index.scss';
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-28">4. 子组件拆分</h3>
<h4 data-id="heading-29">❌ 反例：仅单组件使用的子组件放在全局 components</h4>
<pre><code class="hljs language-bash" lang="bash">src/
  components/
    ProductCard.vue          <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
    ProductFilter.vue        <span class="hljs-comment"># 反例：仅在 ProductList.vue 使用</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList.vue --&gt;
&lt;script setup lang="ts"&gt;
import ProductCard from '@/components/ProductCard.vue';
import ProductFilter from '@/components/ProductFilter.vue';

// 看起来像是全局组件，但实际上只在当前组件使用
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-30">✅ 正例：仅当前组件使用的子组件放在组件目录下</h4>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue
  ├── components/            <span class="hljs-comment"># 正例：仅当前组件使用</span>
  │   ├── ProductCard.vue
  │   ├── ProductCard.scss
  │   ├── ProductFilter.vue
  │   └── ProductFilter.scss
  └── index.scss
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/components/ProductCard.vue --&gt;
&lt;!-- 仅 ProductList 组件使用 --&gt;
&lt;template&gt;
  &lt;div class="product-card"&gt;
    &lt;img :src="product.image" :alt="product.name" /&gt;
    &lt;h3&gt;{{ product.name }}&lt;/h3&gt;
    &lt;p class="price"&gt;{{ product.displayPrice }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  product: any;
}&gt;();
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
@import './ProductCard.scss';
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
import ProductCard from './components/ProductCard.vue';
import ProductFilter from './components/ProductFilter.vue';

// 引入路径短，且明确表示这些组件属于当前组件
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="product-list"&gt;
    &lt;ProductFilter /&gt;
    &lt;ProductCard
      v-for="product in products"
      :key="product.id"
      :product="product"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-31">5. 何时抽离到全局</h3>
<p>当以下情况出现时，再考虑抽离到全局：</p>
<h4 data-id="heading-32">✅ 需要复用时抽离到全局</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 情况1: 多个组件开始使用相同的工具函数</span>
src/views/product/ProductList/utils/formatProduct.ts  <span class="hljs-comment"># 原本在这里</span>
src/views/order/OrderList.vue                        <span class="hljs-comment"># 现在也要用</span>
src/views/cart/CartList.vue                          <span class="hljs-comment"># 现在也要用</span>

<span class="hljs-comment"># 应该抽离到：</span>
src/utils/product/formatProduct.ts
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/product/formatProduct.ts</span>
<span class="hljs-comment">// 多个组件复用，抽离到全局</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductPrice = (<span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`¥<span class="hljs-subst">${price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formatProductName = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">category</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span> (<span class="hljs-subst">${category}</span>)`</span>;
};
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/product/ProductList/index.vue --&gt;
&lt;script setup lang="ts"&gt;
// 从全局引入
import { formatProductPrice } from '@/utils/product/formatProduct';
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/order/OrderList.vue --&gt;
&lt;script setup lang="ts"&gt;
// 从全局引入
import { formatProductPrice } from '@/utils/product/formatProduct';
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-33">完整示例：组件目录结构</h2>
<pre><code class="hljs language-bash" lang="bash">src/views/product/ProductList/
  ├── index.vue                    <span class="hljs-comment"># 主组件</span>
  ├── index.scss                   <span class="hljs-comment"># 组件主样式</span>
  │
  ├── composables/                 <span class="hljs-comment"># 仅当前组件使用的组合式函数</span>
  │   ├── useProductData.ts
  │   ├── useProductFilter.ts
  │   └── useProductPagination.ts
  │
  ├── utils/                       <span class="hljs-comment"># 仅当前组件使用的工具函数</span>
  │   ├── formatProduct.ts
  │   ├── filterProduct.ts
  │   └── validateProduct.ts
  │
  ├── components/                  <span class="hljs-comment"># 仅当前组件使用的子组件</span>
  │   ├── ProductCard/
  │   │   ├── index.vue
  │   │   └── index.scss
  │   ├── ProductFilter/
  │   │   ├── index.vue
  │   │   └── index.scss
  │   └── ProductPagination/
  │       ├── index.vue
  │       └── index.scss
  │
  └── styles/                      <span class="hljs-comment"># 样式拆分（如果样式较多）</span>
      ├── variables.scss
      ├── mixins.scss
      └── animations.scss
</code></pre>
<h2 data-id="heading-34">总结对比</h2>



































<table><thead><tr><th>场景</th><th>❌ 反例（全局）</th><th>✅ 正例（组件目录）</th></tr></thead><tbody><tr><td>仅单组件使用的工具函数</td><td><code>src/utils/product-list/format.ts</code></td><td><code>ProductList/utils/format.ts</code></td></tr><tr><td>仅单组件使用的 composable</td><td><code>src/composables/useProductData.ts</code></td><td><code>ProductList/composables/useProductData.ts</code></td></tr><tr><td>仅单组件使用的样式</td><td><code>src/styles/product-list.scss</code></td><td><code>ProductList/index.scss</code></td></tr><tr><td>仅单组件使用的子组件</td><td><code>src/components/ProductCard.vue</code></td><td><code>ProductList/components/ProductCard.vue</code></td></tr><tr><td>多个组件复用</td><td>-</td><td>抽离到全局 <code>src/utils/</code> 或 <code>src/composables/</code></td></tr></tbody></table>
<p>原则：</p>
<ul>
<li>仅当前组件使用 → 放在组件目录下（<code>utils/</code>、<code>composables/</code>、<code>components/</code>、<code>styles/</code>）</li>
<li>多个组件复用 → 抽离到全局（<code>src/utils/</code>、<code>src/composables/</code>、<code>src/components/</code>）</li>
</ul>
<h2 data-id="heading-35">总结</h2>
<ul>
<li>模板层：只负责渲染，不写复杂表达式和数据操作</li>
<li>逻辑层：data 存原始数据，computed 处理派生数据，接口抽离到 api</li>
<li>组件层：通用组件只接收 props，业务组件处理数据逻辑</li>
<li>拆分原则：按业务逻辑拆分，避免过度拆分增加复杂度</li>
</ul>
<p>这些示例展示了如何在实际项目中应用这些原则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise与async/await]]></title>    <link>https://juejin.cn/post/7594385386739974163</link>    <guid>https://juejin.cn/post/7594385386739974163</guid>    <pubDate>2026-01-13T06:13:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386739974163" data-draft-id="7594403873177452585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise与async/await"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:13:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise与async/await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:13:04.000Z" title="Tue Jan 13 2026 06:13:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本专栏聚焦Promise的核心原理与高级应用，包含：
✓ Promise A+规范深度解读
✓ 手写实现与源码分析
✓ 异步编程设计模式
✓ 性能调优与错误处理</p>
</blockquote>
<blockquote>
<p>适合有JavaScript基础，希望深入异步编程的开发者。我们将用最少的篇幅，讲透最核心的知识。</p>
</blockquote>
<h2 data-id="heading-0">引言</h2>
<p>在之前的文章中，我们学习了Promise的基础和原理实现。从中我们不难发现，即使是链式调用，处理复杂的异步流程仍然有些繁琐，我们来看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise链式调用</span>
<span class="hljs-title function_">fetchUser</span>(userId)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">orders</span> =&gt;</span> <span class="hljs-title function_">processOrders</span>(orders))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">displayResult</span>(result))
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">handleError</span>(error))
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cleanup</span>());
</code></pre>
<p>在这种情况下，async/await语法应运而生，它让我们可以用同步的方式写异步代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// async/await版本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">displayUserOrders</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(userId);
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processOrders</span>(orders);
        <span class="hljs-title function_">displayResult</span>(result);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">handleError</span>(error);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">cleanup</span>();
    }
}
</code></pre>
<h2 data-id="heading-1">async：声明异步函数</h2>
<h3 data-id="heading-2">基本语法</h3>
<p><code>async</code> 关键字用于声明一个异步函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// async函数声明</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
}

<span class="hljs-comment">// async函数表达式</span>
<span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'数据'</span>;
};

<span class="hljs-comment">// async箭头函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
};

<span class="hljs-comment">// async方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-comment">// 异步操作</span>
    }
}
</code></pre>
<h3 data-id="heading-3">函数返回值</h3>
<p><code>async</code> 函数总是返回一个 <code>Promise</code> 。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">basicReturn</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; <span class="hljs-comment">// 等价于 Promise.resolve(42)</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">promiseReturn</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'hello'</span>); <span class="hljs-comment">// 返回的Promise</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'失败'</span>); <span class="hljs-comment">// 等价于 Promise.reject(error)</span>
}
</code></pre>
<h2 data-id="heading-4">await：等待Promise解决</h2>
<h3 data-id="heading-5">基本使用</h3>
<p><code>await</code> 只能在 <code>async</code> 函数内部使用，它会暂停 <code>async</code> 函数的执行，等待Promise解决：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行'</span>);
    
    <span class="hljs-comment">// await会暂停执行，直到Promise解决</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据获取完成:'</span>, result);
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">examplePromise</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据获取完成:'</span>, result);
        <span class="hljs-keyword">return</span> result;
    });
}
</code></pre>
<h2 data-id="heading-6">错误处理：try-catch的回归</h2>
<h3 data-id="heading-7">同步风格的错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统Promise错误处理（分散）</span>
<span class="hljs-title function_">fetchUser</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>)
            .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">orderError</span> =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败:'</span>, orderError);
                <span class="hljs-keyword">return</span> [];
            });
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">userError</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, userError);
    });

<span class="hljs-comment">// async/await错误处理（集中）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserOrders</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
            <span class="hljs-keyword">return</span> orders;
        } <span class="hljs-keyword">catch</span> (orderError) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败:'</span>, orderError);
            <span class="hljs-keyword">return</span> []; <span class="hljs-comment">// 返回默认值</span>
        }
    } <span class="hljs-keyword">catch</span> (userError) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, userError);
        <span class="hljs-keyword">throw</span> userError; <span class="hljs-comment">// 重新抛出</span>
    }
}

<span class="hljs-comment">// 更简洁的版本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserOrdersBetter</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">return</span> orders;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'操作失败:'</span>, error);
        <span class="hljs-comment">// 根据错误类型处理</span>
        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'用户'</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户相关操作失败'</span>);
        }
        <span class="hljs-keyword">return</span> []; <span class="hljs-comment">// 默认值</span>
    }
}
</code></pre>
<h3 data-id="heading-8">多await操作的错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">multipleOperations</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 方法1：分别处理每个await（粒度细）</span>
    <span class="hljs-keyword">let</span> user;
    <span class="hljs-keyword">try</span> {
        user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">let</span> orders;
    <span class="hljs-keyword">try</span> {
        orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败，但用户数据有效:'</span>, user);
        orders = [];
    }
    
    <span class="hljs-comment">// 方法2：统一处理（粒度粗）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProducts</span>(orders);
        <span class="hljs-keyword">return</span> { user, orders, products };
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'某个步骤失败:'</span>, error);
        <span class="hljs-comment">// 无法区分哪个步骤失败</span>
    }
    
    <span class="hljs-comment">// 方法3：组合使用（推荐）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户获取失败，终止流程'</span>);
        });
        
        <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrders</span>(user.<span class="hljs-property">id</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'订单获取失败，使用空数组'</span>);
            <span class="hljs-keyword">return</span> [];
        });
        
        <span class="hljs-comment">// 即使orders为空，也继续执行</span>
        <span class="hljs-keyword">const</span> analysis = <span class="hljs-keyword">await</span> <span class="hljs-title function_">analyzeData</span>(user, orders);
        <span class="hljs-keyword">return</span> analysis;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'致命错误:'</span>, error);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">停止和恢复执行</h2>
<p><code>async/await</code> 中真正起作用的是 <code>await</code> 。<code>async</code> 关键字只是一个标识符。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>));
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> <span class="hljs-string">'2'</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test3</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
}
<span class="hljs-title function_">test</span>();
<span class="hljs-title function_">test2</span>();
<span class="hljs-title function_">test3</span>();
</code></pre>
<p>上述代码的输出结果是：<code>3 2 1</code> 。因为JS运行时，在碰到 <code>await</code> 关键字时，会记录在哪里执行暂停。等待 <code>await</code> 后边的值可以用了，JS运行时会向消息队列中推送一个任务，这个任务会恢复函数执行。</p>
<h2 data-id="heading-10">结语</h2>
<p><code>Promise</code> 和 <code>async/await</code> 是JS异步编程的黄金组合：<code>Promise</code> 提供了底层的异步抽象和组合能力，<code>async/await</code> 提供了上层的语法糖，让异步代码更易读。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习小记1：移动端css适配相关问题]]></title>    <link>https://juejin.cn/post/7594403873177534505</link>    <guid>https://juejin.cn/post/7594403873177534505</guid>    <pubDate>2026-01-13T06:17:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594403873177534505" data-draft-id="7594302398687133750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习小记1：移动端css适配相关问题"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-13T06:17:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一半醒"/> <meta itemprop="url" content="https://juejin.cn/user/4319340647165639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习小记1：移动端css适配相关问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4319340647165639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一半醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:17:13.000Z" title="Tue Jan 13 2026 06:17:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">移动端三种像素</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span>   <span class="hljs-code">`物理像素 (设备像素)`</span>：屏幕硬件上真实存在的发光点；特点：固定不变（比如 iPhone 15 的物理像素是 1179×2556）。
<span class="hljs-bullet">-</span>   <span class="hljs-code">`CSS 像素 (逻辑像素)`</span>：网页代码中写的<span class="hljs-code">`px`</span>单位；特点：可被 Viewport 缩放，是相对单位。
<span class="hljs-bullet">-</span>   <span class="hljs-code">`设备像素比 (DPR)`</span>：DPR = 物理像素 / CSS 像素；特点：高清屏 (DPR=2/3) 下，1 个 CSS 像素对应多个物理像素。
</code></pre>
<h2 data-id="heading-1">Viewport(视口)</h2>
<pre><code class="hljs language-markdown" lang="markdown">Viewport 是浏览器显示网页的区域，移动端默认的布局视口（layout viewport）宽度约 980px，直接导致网页缩放显示。我们需要通过 meta 标签设置<span class="hljs-strong">**理想视口**</span>，让 CSS 像素和设备尺寸匹配：
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 核心Viewport配置，必须加 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span>
</code></pre>
<ul>
<li><code>width=device-width</code>：布局视口宽度等于设备宽度</li>
<li><code>initial-scale=1.0</code>：初始缩放比例为 1</li>
<li><code>user-scalable=no</code>：禁止用户缩放（可选，根据需求调整）</li>
</ul>
<p><strong>⚠️所有适配生效都要先配置好正确的Viewport(width=device-width, initial-scale=1.0)</strong></p>
<h2 data-id="heading-2">实现真实的 1px 边框</h2>
<p>问题根源：高清屏（DPR=2）下，CSS 写的<code>1px</code>会被渲染成 2 个物理像素，导致边框看起来比设计稿粗。</p>
<h5 data-id="heading-3">方案 1：利用 transform 缩放（推荐，兼容性好）</h5>
<p>原理：先设置<code>1px</code>边框，再通过<code>transform: scale()</code>按 DPR 比例缩小，同时用<code>transform-origin</code>控制缩放原点。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 通用1px边框样式 */</span> 
<span class="hljs-selector-class">.border-1px</span> { 
    <span class="hljs-attribute">position</span>: relative; 
    <span class="hljs-comment">/* 防止缩放后的边框超出容器 */</span> 
    <span class="hljs-attribute">overflow</span>: hidden; 
 } 
<span class="hljs-comment">/* 给容器添加伪元素实现边框 */</span> 
<span class="hljs-selector-class">.border-1px</span><span class="hljs-selector-pseudo">::after</span> { 
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>; 
    <span class="hljs-attribute">position</span>: absolute; 
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>; 
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>; 
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; 
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; 
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e5e5e5</span>; 
    <span class="hljs-comment">/* 根据DPR缩放，这里以DPR=2为例，DPR=3则scale(0.333) */</span> 
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.5</span>); 
    * 让缩放原点在左上角，避免边框偏移 */ 
    <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>; 
    <span class="hljs-comment">/* 防止伪元素覆盖内容 */</span> 
    <span class="hljs-attribute">pointer-events</span>: none; 
}
</code></pre>
<h5 data-id="heading-4">方案 2：动态计算（适配所有 DPR）</h5>
<p>结合 JS 获取设备 DPR，动态设置缩放比例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取设备DPR </span>
<span class="hljs-keyword">const</span> dpr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || <span class="hljs-number">1</span>; 
<span class="hljs-comment">// 动态设置Viewport的initial-scale </span>
<span class="hljs-keyword">const</span> metaViewport = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'meta[name="viewport"]'</span>); metaViewport.<span class="hljs-property">content</span> = <span class="hljs-string">`width=device-width, initial-scale=<span class="hljs-subst">${<span class="hljs-number">1</span>/dpr}</span>, maximum-scale=<span class="hljs-subst">${<span class="hljs-number">1</span>/dpr}</span>, user-scalable=no`</span>; 
<span class="hljs-comment">// 给1px边框元素设置对应缩放 </span>
<span class="hljs-keyword">const</span> borderElements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.border-1px'</span>); borderElements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> { 
    <span class="hljs-keyword">const</span> after = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(el, <span class="hljs-string">'::after'</span>); 
    el.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">'--scale'</span>, <span class="hljs-number">1</span>/dpr); 
    el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'::after'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`scale(<span class="hljs-subst">${<span class="hljs-number">1</span>/dpr}</span>)`</span>; 
    <span class="hljs-comment">// 简化写法：直接修改伪元素样式（实际开发可结合CSS变量） el.style.cssText += `--scale: ${1/dpr};`; </span>
});
</code></pre>
<h2 data-id="heading-5">实现真实的 12px 字体大小</h2>
<p>问题根源：很多移动端浏览器（如微信内置浏览器、Safari）默认限制最小字号为 12px，直接写<code>font-size: 12px</code>在低 DPR 设备上可能被强制放大，或在高 DPR 设备上显示偏小。</p>
<h5 data-id="heading-6">方案 1：Viewport 缩放配合 rem（推荐）</h5>
<ol>
<li>先通过 JS 动态计算 rem 基准值</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 设计稿基准宽度（比如750px设计稿） </span>
<span class="hljs-keyword">const</span> designWidth = <span class="hljs-number">750</span>; 
<span class="hljs-comment">// 基准字号（1rem = 100px，方便计算） </span>
<span class="hljs-keyword">const</span> baseFontSize = <span class="hljs-number">100</span>; 
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setRem</span>(<span class="hljs-params"/>) { 
    <span class="hljs-comment">// 获取设备宽度 </span>
    <span class="hljs-keyword">const</span> deviceWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>; 
    <span class="hljs-comment">// 计算当前rem对应的像素值 </span>
    <span class="hljs-keyword">const</span> rem = (deviceWidth / designWidth) * baseFontSize; 
    <span class="hljs-comment">// 设置html根元素字号 </span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = rem + <span class="hljs-string">'px'</span>; 
} 
<span class="hljs-comment">// 初始化执行 </span>
<span class="hljs-title function_">setRem</span>(); 
<span class="hljs-comment">// 窗口大小变化时重新计算 </span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, setRem);
</code></pre>
<ol start="2">
<li>写 12px 字体（基于 750px 设计稿）：</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 12px = 12/100 = 0.12rem */</span> 
<span class="hljs-selector-class">.text-12px</span> { 
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.12rem</span>; 
    <span class="hljs-comment">/* 禁止浏览器自动调整最小字号 */</span> 
    -webkit-text-size-adjust: none; 
    text-size-adjust: none; 
}
</code></pre>
<h5 data-id="heading-7">方案 2：transform 缩放（兼容极端场景）</h5>
<p>如果 rem 适配不生效，可通过缩放实现真实 12px：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.text-12px</span> { 
    <span class="hljs-comment">/* 先放大到24px（避开最小字号限制），再缩放到50% */</span> 
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>; 
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.5</span>); 
    <span class="hljs-comment">/* 缩放后不占原空间 */</span> 
    <span class="hljs-attribute">transform-origin</span>: left center; 
    <span class="hljs-comment">/* 行高也要对应调整 */</span> 
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.2</span>; <span class="hljs-comment">/* 
    防止文字模糊 */</span> 
    -webkit-<span class="hljs-attribute">font-smoothing</span>: antialiased; 
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git分支管理与代码合并实践：保持特性分支与主分支同步]]></title>    <link>https://juejin.cn/post/7594389431836262441</link>    <guid>https://juejin.cn/post/7594389431836262441</guid>    <pubDate>2026-01-13T06:22:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594389431836262441" data-draft-id="7594385386740039699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git分支管理与代码合并实践：保持特性分支与主分支同步"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:22:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一尘子"/> <meta itemprop="url" content="https://juejin.cn/user/2142267148862040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git分支管理与代码合并实践：保持特性分支与主分支同步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2142267148862040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一尘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:22:59.000Z" title="Tue Jan 13 2026 06:22:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景说明</h2>
<p>在团队协作开发中，开发者经常需要在特性分支（如 <code>dev_feature_xxx</code>）上实现新功能，同时需要定期同步主分支（如 <code>develop</code>）的最新代码，避免最终合并时产生严重冲突。本文将通过一个实际案例，演示如何安全地将主分支更新合并到特性分支，并完成代码推送与合并请求。</p>
<hr/>
<h2 data-id="heading-1">完整操作流程</h2>
<h3 data-id="heading-2">1. 保存当前工作进度</h3>
<p>在切换分支前，若当前工作区有未提交的修改，使用 <code>git stash -a</code> 暂存变更：</p>
<pre><code class="hljs language-bash" lang="bash">git stash -a
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31314dd4c8e34b2e86c224a6f426c59e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=xvro%2FuRgvGF9iwS%2BcPwxg8IQ2%2F8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>作用</strong>：将未提交的修改存入栈中，工作区恢复到最近一次提交的状态。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">2. 更新主分支代码</h3>
<p>切换到主分支（假设主分支为 `develop）并拉取远端最新代码：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout develop      <span class="hljs-comment"># 切换到主分支</span>
git pull origin develop   <span class="hljs-comment"># 拉取远端最新代码</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d86bc23d2034f72aea40b75a080d474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=Z6jlAW%2FWlecyqet7Q%2BJdFzqtbnY%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9adba10bbae409e89a32059a75ecd9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=IOmaWu96REPr%2BsrTguHIjp6SaDA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：<code>git pull</code> 是 <code>git fetch</code> + <code>git merge</code> 的组合操作，建议明确指定远程和分支名以避免歧义。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">3. 合并主分支到特性分支</h3>
<p>回到特性分支，将主分支的更新合并到当前分支：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout dev_feature_mengqingchen_20241126_layer  <span class="hljs-comment"># 切换回特性分支</span>
git merge develop                                      <span class="hljs-comment"># 合并主分支代码</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d324d8f9b3144565aa901524d72877b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=RlKnggh2MCWIk1lJV1LlZLdbVPg%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70538c2eceb84a9998acb0eb4858fc14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=ws%2FtbrybLMNFJrBgwo3EKy4VE4U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>冲突处理</strong>：若存在冲突，需手动解决后执行 <code>git add</code> 和 <code>git commit</code>。建议使用 <code>git mergetool</code> 可视化工具。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4. 恢复暂存的工作进度</h3>
<p>将之前暂存的修改重新应用到当前分支：</p>
<pre><code class="hljs language-bash" lang="bash">git stash pop  <span class="hljs-comment"># 恢复最后一次暂存内容，并从栈中删除记录</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09bd95491f604153b30ac3238d6ea800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=9vrG%2FSoDdfuP6Eog0OJAD6IysK8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：<code>git stash apply</code> 可恢复但不删除栈记录，<code>pop</code> 更适用于一次性恢复场景。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">5. 推送代码并创建合并请求</h3>
<p>将合并后的特性分支推送到远程仓库，并通过 GitLab 发起合并请求（Merge Request）：</p>
<pre><code class="hljs language-bash" lang="bash">git push origin dev_feature_mengqingchen_20241126_layer  <span class="hljs-comment"># 推送特性分支</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9d3e266fe2c4575a16f4cf93f43a85c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=X0GBqGmagnmtoxplWRHno50ZYgU%3D" alt="" loading="lazy"/></p>
<p><strong>GitLab 操作</strong>：</p>
<ol>
<li>进入项目仓库页面，点击 <code>Merge Request</code>。</li>
<li>选择源分支（特性分支）与目标分支（<code>develop</code>）。</li>
<li>填写变更说明，触发 CI/CD 流水线，等待审核合并。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3368051d5621465caae7ff2162cf092f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5bCY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768890179&amp;x-signature=JdpIKEXsIwejNUg4i8OfNNytUSA%3D" alt="" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-7">关键点总结</h2>
<ol>
<li><strong>分支命名规范</strong>：推荐使用 <code>feature/username-date-description</code> 格式，例如 <code>feature/mengqingchen-20241126-layer</code>。</li>
<li><strong>及时同步主分支</strong>：每天开始工作前拉取主分支更新，减少后期冲突概率。</li>
<li><strong>善用 Stash 机制</strong>：在切换分支前保存工作进度，避免因未提交代码导致操作中断。</li>
<li><strong>合并顺序原则</strong>：始终将主分支合并到特性分支，而非反向操作，确保特性分支通过测试后再合入主分支。</li>
</ol>
<hr/>
<h2 data-id="heading-8">扩展建议</h2>
<ul>
<li><strong>自动化流水线集成</strong>：在 GitLab 中配置 <code>.gitlab-ci.yml</code>，实现代码推送后自动运行单元测试和代码扫描。</li>
<li><strong>保护主分支</strong>：通过仓库设置禁止直接向 <code>main</code> 分支推送代码，强制使用 Merge Request 机制。</li>
</ul>
<p>通过遵循上述流程，开发者可以高效管理多分支协作，确保代码库的稳定性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Symfony AI v0.2.0 正式发布：功能解读与实战指南]]></title>    <link>https://juejin.cn/post/7594403873177747497</link>    <guid>https://juejin.cn/post/7594403873177747497</guid>    <pubDate>2026-01-13T06:37:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594403873177747497" data-draft-id="7594351060615397395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Symfony AI v0.2.0 正式发布：功能解读与实战指南"/> <meta itemprop="keywords" content="AI编程,PHP,Symfony"/> <meta itemprop="datePublished" content="2026-01-13T06:37:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Symfony AI v0.2.0 正式发布：功能解读与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:37:35.000Z" title="Tue Jan 13 2026 06:37:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsymfony%2Fai" target="_blank" title="https://github.com/symfony/ai" ref="nofollow noopener noreferrer">Symfony AI v0.2.0</a> 已于 2026年1月10日 正式发布。</p>
<p>如果你还在以为 PHP 只能写写 CRUD，那你真的 OUT 了。Symfony AI 组件的出现，标志着 PHP 正式进入了AI 原生开发时代。v0.2.0 不仅仅是一个简单的版本更新，它带来了生产环境急需的故障转移（Failover）、更完善的 CLI 工具 Symfony Mate 的大幅增强，以及对 OpenRouter 和 VertexAI 的深度支持。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2575d9f0574417b96d7e0c64f410b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768891055&amp;x-signature=Ep%2B26OXv9AwYSB6zwe%2BjmUO6mTA%3D" alt="" loading="lazy"/></p>
<p>以下是 v0.2.0 的核心更新解读及实战指南。</p>
<h3 data-id="heading-0">v0.2.0 核心更新速览</h3>
<p>本次更新主要集中在以下几个方面：</p>
<h4 data-id="heading-1"><strong>高可用性</strong> <strong>增强：FailoverPlatform</strong></h4>
<ol>
<li>生产环境中，单一 AI 接口（如 OpenAI）可能会出现波动。新版本引入了 <code>FailoverPlatform</code>，允许配置备用线路。当主接口无响应时，系统会自动切换至备用平台（如 Azure 或 Anthropic），保障服务连续性。</li>
</ol>
<h4 data-id="heading-2"><strong>Mate 组件升级与</strong> <strong>兼容性</strong> <strong>扩展</strong></h4>
<ol>
<li>开发助手 Symfony Mate 得到了大幅改进。CLI 命令新增了详细描述，便于调试。更重要的是，v0.2.0 向下兼容了 Symfony 5.4 和 6.4，这使得维护老旧项目的团队也能接入 AI 能力。</li>
</ol>
<h4 data-id="heading-3"><strong>模型与平台支持扩充</strong></h4>
<ul>
<li><strong>OpenRouter</strong>：完善了流式传输（Streaming）和结构化输出的支持。</li>
<li><strong>VertexAI</strong>：新增 API Key 认证方式，简化了 Google Cloud 的接入流程。</li>
<li><strong>Whisper</strong>：支持 verbose 输出模式，提供更丰富的语音转录元数据。</li>
</ul>
<h4 data-id="heading-4"><strong>接口变更（Breaking Change）</strong></h4>
<ol>
<li>需要特别注意，<code>StoreInterface::add()</code> 方法的签名发生了变化。旧版本的变长参数已被移除，现在必须传入 <code>VectorDocument</code> 对象或数组。升级时需同步修改相关代码。</li>
</ol>
<h3 data-id="heading-5">实战指南：构建智能问答服务</h3>
<p>Symfony AI 的核心设计理念是 <strong>"Everything is Configurable"</strong> （一切皆可配置）。它通过 <code>yaml</code> 文件将复杂的 AI 逻辑抽象化。</p>
<h4 data-id="heading-6">1. 安装组件</h4>
<p>在你的 Symfony 项目中（确保已通过 ServBay 配置好 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">PHP 环境</a>）</p>
<pre><code class="hljs language-bash" lang="bash">composer require symfony/ai-bundle
</code></pre>
<h4 data-id="heading-7">2. 配置 AI 服务</h4>
<p>v0.2.0 的配置更加灵活。下面是一个经典的配置示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ai:</span>
    <span class="hljs-comment"># 1. 平台定义</span>
    <span class="hljs-attr">platform:</span>
        <span class="hljs-attr">primary_openai:</span>
            <span class="hljs-attr">openai:</span>
                <span class="hljs-attr">api_key:</span> <span class="hljs-string">'%env(OPENAI_API_KEY)%'</span>
        
        <span class="hljs-attr">backup_azure:</span>
            <span class="hljs-attr">azure:</span>
                <span class="hljs-attr">gpt_deployment:</span>
                    <span class="hljs-attr">base_url:</span> <span class="hljs-string">'%env(AZURE_BASE_URL)%'</span>
                    <span class="hljs-attr">deployment:</span> <span class="hljs-string">'gpt-4o-backup'</span>
                    <span class="hljs-attr">api_key:</span> <span class="hljs-string">'%env(AZURE_KEY)%'</span>
                    <span class="hljs-attr">api_version:</span> <span class="hljs-string">'2024-02-15-preview'</span>

        <span class="hljs-comment"># v0.2 新特性：故障转移平台</span>
        <span class="hljs-attr">production_mix:</span>
            <span class="hljs-attr">failover:</span>
                <span class="hljs-attr">platforms:</span> [<span class="hljs-string">'primary_openai'</span>, <span class="hljs-string">'backup_azure'</span>]

    <span class="hljs-comment"># 2. 代理定义</span>
    <span class="hljs-attr">agent:</span>
        <span class="hljs-comment"># 定义一个翻译助手</span>
        <span class="hljs-attr">translator_bot:</span>
            <span class="hljs-attr">platform:</span> <span class="hljs-string">'ai.platform.production_mix'</span> <span class="hljs-comment"># 使用上面定义的故障转移平台</span>
            <span class="hljs-attr">model:</span> <span class="hljs-string">'gpt-4o'</span>
            <span class="hljs-attr">prompt:</span>
                <span class="hljs-attr">text:</span> <span class="hljs-string">'你是一位精通多国语言的翻译专家，请直接输出翻译结果，不要包含多余解释。'</span>
                <span class="hljs-comment"># 若需动态加载提示词，也可使用 file: '%kernel.project_dir%/prompts/translator.txt'</span>
            <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.3</span> <span class="hljs-comment"># 控制输出随机性</span>
</code></pre>
<h4 data-id="heading-8">3. 业务代码集成</h4>
<p>配置完成后，AI Agent 会自动注册为服务。通过依赖注入即可在 Service 或 Controller 中使用。</p>
<p>以下代码展示了一个服务类，它封装了调用逻辑，接收用户输入并返回 AI 响应。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Service</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">AI</span>\<span class="hljs-title">Agent</span>\<span class="hljs-title">AgentInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">AI</span>\<span class="hljs-title">Platform</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">Message</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">AI</span>\<span class="hljs-title">Platform</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageBag</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">DependencyInjection</span>\<span class="hljs-title">Attribute</span>\<span class="hljs-title">Autowire</span>;

<span class="hljs-keyword">final</span> <span class="hljs-keyword">readonly</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TranslationService</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        // 通过别名注入配置文件中定义的 translator_bot
        #[Autowire(<span class="hljs-params">service: <span class="hljs-string">'ai.agent.translator_bot'</span></span>)]
        <span class="hljs-keyword">private</span> AgentInterface <span class="hljs-variable">$translator</span>
    </span>) </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">translateText</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$sourceText</span></span>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-comment">// 构建消息上下文</span>
        <span class="hljs-variable">$conversation</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageBag</span>(
            <span class="hljs-title class_">Message</span>::<span class="hljs-title function_ invoke__">ofUser</span>(<span class="hljs-variable">$sourceText</span>)
        );

        <span class="hljs-comment">// 执行调用</span>
        <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;translator-&gt;<span class="hljs-title function_ invoke__">call</span>(<span class="hljs-variable">$conversation</span>);

        <span class="hljs-comment">// v0.2 支持获取更多元数据，如 Token 消耗（需平台支持）</span>
        <span class="hljs-comment">// $usage = $result-&gt;getMetadata()-&gt;get('token_usage');</span>

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">getContent</span>();
    }
}
</code></pre>
<h3 data-id="heading-9">进阶功能：多智能体协作（Multi-Agent）</h3>
<p>这是目前 AI 领域最火的模式。</p>
<p>对于复杂的业务场景，单一 Prompt 往往难以胜任。v0.2.0 优化了多智能体编排配置，能够根据用户意图将请求分发给不同的专业 Agent。</p>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ai:</span>
    <span class="hljs-attr">multi_agent:</span>
        <span class="hljs-attr">support_team:</span>
            <span class="hljs-comment"># 编排者：负责分析用户意图</span>
            <span class="hljs-attr">orchestrator:</span> <span class="hljs-string">'ai.agent.manager'</span>
            
            <span class="hljs-comment"># 分发规则：根据关键词自动路由</span>
            <span class="hljs-attr">handoffs:</span>
                <span class="hljs-comment"># 遇到代码、报错等词汇，转交给技术 Agent</span>
                <span class="hljs-attr">ai.agent.tech_lead:</span> [<span class="hljs-string">'php'</span>, <span class="hljs-string">'exception'</span>, <span class="hljs-string">'debug'</span>, <span class="hljs-string">'code'</span>]
                <span class="hljs-comment"># 遇到发票、退款等词汇，转交给财务 Agent</span>
                <span class="hljs-attr">ai.agent.finance:</span> [<span class="hljs-string">'invoice'</span>, <span class="hljs-string">'refund'</span>, <span class="hljs-string">'payment'</span>]
            
            <span class="hljs-comment"># 默认兜底 Agent</span>
            <span class="hljs-attr">fallback:</span> <span class="hljs-string">'ai.agent.general_faq'</span>
</code></pre>
<p>在代码中，直接注入 <code>ai.multi_agent.support_team</code> 即可使用这套智能分发系统，无需手动编写路由逻辑。</p>
<h3 data-id="heading-10">常用 CLI 工具</h3>
<p>v0.2.0 的 Mate 工具包提供了便捷的命令行调试功能：</p>
<ul>
<li><strong>直接对话测试</strong>：无需编写代码，直接在终端测试 Agent 表现。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">php bin/console ai:agent:call translator_bot
</code></pre>
<ul>
<li><strong>平台连通性测试</strong>：验证 API Key 和网络连接是否正常。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">php bin/console ai:platform:invoke openai gpt-4o <span class="hljs-string">"System check"</span>
</code></pre>
<h3 data-id="heading-11">安装 Symfony</h3>
<p>Symfony 对 PHP 环境是有要求的，需要 PHP 8.4 或更高版本的环境。</p>
<p>这个可以通过ServBay来一键部署。ServBay 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fphp" target="_blank" title="https://www.servbay.com/features/php" ref="nofollow noopener noreferrer">一键配置 PHP 环境</a>以及 Redis、PostgreSQL 等向量存储所需的后端服务，能有效避免环境配置带来的干扰。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d315ef7f505471f988f123269bab2b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768891055&amp;x-signature=%2FTKHYBTmlI76Qlw2YWq3IC%2BBLIY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">总结</h3>
<p>Symfony AI v0.2.0 是一个从实验走向成熟的版本。故障转移机制的加入使其具备了上生产环境的基础，而对旧版本 Symfony 的兼容支持则扩大了其适用范围。配合 ServBay 快速搭建的基础设施，PHP 开发者可以更低成本地在现有项目中落地 AI 功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不修改DOM的高亮黑科技，你可能还不知道]]></title>    <link>https://juejin.cn/post/7594403873177796649</link>    <guid>https://juejin.cn/post/7594403873177796649</guid>    <pubDate>2026-01-13T06:43:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594403873177796649" data-draft-id="7594482829754466350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不修改DOM的高亮黑科技，你可能还不知道"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-13T06:43:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CC码码"/> <meta itemprop="url" content="https://juejin.cn/user/3800389147179720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不修改DOM的高亮黑科技，你可能还不知道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3800389147179720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CC码码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:43:38.000Z" title="Tue Jan 13 2026 06:43:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是CC，在这里欢迎大家的到来～</p>
<h2 data-id="heading-0">背景</h2>
<p>在传统实现文本高亮时通常使用 <strong>span</strong> 标签包裹文本，再给 span 标签添加相应高亮背景色。这种方式会修改原本的 <strong>DOM</strong> 结构，逻辑复杂，也会频繁导致页面重绘，消耗浏览器性能。而基于 <strong>HighLight</strong> 的 <strong>CSS</strong> 自定义高亮 <strong>API</strong> 的这种方式可以实现<strong>在渲染层处理文本高亮，既不影响 DOM 树，而且完全独立于文档结构</strong>。</p>
<h2 data-id="heading-1">实现步骤</h2>
<h3 data-id="heading-2">创建 Range 对象</h3>
<p>标识想要高亮的文本范围。</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div id=<span class="hljs-string">"foo"</span>&gt;纯 <span class="hljs-variable constant_">CSS</span> 实现文本高亮&lt;/div&gt;


<span class="hljs-keyword">const</span> parentNode = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"foo"</span>);

<span class="hljs-keyword">const</span> range1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
range1.<span class="hljs-title function_">setStart</span>(parentNode, <span class="hljs-number">1</span>);
range1.<span class="hljs-title function_">setEnd</span>(parentNode, <span class="hljs-number">2</span>);

<span class="hljs-keyword">const</span> range2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
range2.<span class="hljs-title function_">setStart</span>(parentNode, <span class="hljs-number">4</span>);
range2.<span class="hljs-title function_">setEnd</span>(parentNode, <span class="hljs-number">6</span>);
</code></pre>
<h3 data-id="heading-3">为 Range 对象添加 Highlight 对象</h3>
<p>多个 Range 对象可以与同一个 Highlight 对象关联，这样会以相同方式高亮显示多个文本片段。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> highlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(range1, range2);
</code></pre>
<p>当然也可以在某些场景下创建多个 Highlight 对象，比如在使用协作文本编辑器中每个用户使用不同的文本颜色。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user1Highlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(user1Range1, user1Range2);
<span class="hljs-keyword">const</span> user2Highlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(user2Range1, user2Range2, user2Range3);
</code></pre>
<h3 data-id="heading-4">HighlightRegistry 注册</h3>
<p>注册表是一个 Map 对象，通过名称注册高亮。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"user-1-highlight"</span>, user1Highlight);
<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"user-2-highlight"</span>, user2Highlight);
</code></pre>
<p>当然除了注册之外，也支持删除和清除。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"user-1-highlight"</span>);
<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">clear</span>();
</code></pre>
<h3 data-id="heading-5">::highlight()伪元素定义高亮样式</h3>
<p>为文本片段添加自定义样式进行高亮。</p>
<pre><code class="hljs language-css" lang="css">::<span class="hljs-built_in">highlight</span>(user-<span class="hljs-number">1</span>-highlight) {
  <span class="hljs-attribute">background-color</span>: yellow;
  <span class="hljs-attribute">color</span>: black;
}
::<span class="hljs-built_in">highlight</span>(user-<span class="hljs-number">2</span>-highlight) {
  <span class="hljs-attribute">background-color</span>: black;
  <span class="hljs-attribute">color</span>: yellow;
}
</code></pre>
<h2 data-id="heading-6">应用场景</h2>
<p>这里举例两个 <strong>CSS</strong> 自定义高亮 <strong>API</strong> 的应用场景。</p>
<h3 data-id="heading-7">搜索高亮文本</h3>
<p>在多段文本中搜索检索到文本后直接高亮展示，方便用户查找。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">HighlightText</span> = (<span class="hljs-params">{
  text,
  highlightedWords,
  <span class="hljs-keyword">type</span> = <span class="hljs-string">"text"</span>
}: {
  text: <span class="hljs-built_in">string</span>;
  highlightedWords: <span class="hljs-built_in">string</span>[];
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">"text"</span> | <span class="hljs-string">"html"</span>;
}</span>) =&gt; {
  <span class="hljs-comment">// 将 Node 改为更具体的 HTMLDivElement 以修复 ref 类型错误</span>
  <span class="hljs-keyword">const</span> textRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>) {
      message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"CSS Custom Highlight API not supported."</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">clear</span>();

    <span class="hljs-comment">// 支持多个词语：去重、trim，并过滤空字符串</span>
    <span class="hljs-keyword">const</span> words = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(highlightedWords.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">w</span>) =&gt;</span> w.<span class="hljs-title function_">trim</span>()).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)));
    <span class="hljs-keyword">if</span> (!words.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (!textRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> treeWalker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(textRef.<span class="hljs-property">current</span>, <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_TEXT</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">allTextNodes</span>: <span class="hljs-title class_">Text</span>[] = [];
    <span class="hljs-keyword">let</span> currentNode = treeWalker.<span class="hljs-title function_">nextNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Text</span> | <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">while</span> (currentNode) {
      allTextNodes.<span class="hljs-title function_">push</span>(currentNode);
      currentNode = treeWalker.<span class="hljs-title function_">nextNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Text</span> | <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 为所有词语在所有文本节点中生成 range</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">ranges</span>: <span class="hljs-title class_">Range</span>[] = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> allTextNodes) {
      <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span> || <span class="hljs-string">""</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> word <span class="hljs-keyword">of</span> words) {
        <span class="hljs-keyword">let</span> startPos = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (startPos &lt; content.<span class="hljs-property">length</span>) {
          <span class="hljs-keyword">const</span> index = content.<span class="hljs-title function_">indexOf</span>(word, startPos);
          <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">const</span> range = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
          range.<span class="hljs-title function_">setStart</span>(el, index);
          range.<span class="hljs-title function_">setEnd</span>(el, index + word.<span class="hljs-property">length</span>);
          ranges.<span class="hljs-title function_">push</span>(range);
          startPos = index + word.<span class="hljs-property">length</span>;
        }
      }
    }

    <span class="hljs-keyword">if</span> (ranges.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 统一用一个高亮名称，样式在 ::highlight(search-results) 中定义</span>
      <span class="hljs-keyword">const</span> searchResultsHighlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(...ranges);
      <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"search-results"</span>, searchResultsHighlight);
    }
  }, [highlightedWords, text]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {type === "html" ? (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{textRef}</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{</span>
        {
          <span class="hljs-attr">__html:</span> <span class="hljs-attr">text</span>
        }
      }&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    ) : (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{textRef}</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    )}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">HighlightText</span>;
</code></pre>
<h3 data-id="heading-8">文本差异对比</h3>
<p>对两段文本进行对比时，左侧高亮“不存在于右侧”的文本为绿色（删除），右侧高亮“多于左侧”的文本为红色（新增），可以直观看到差异。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">DiffProps</span> = {
  <span class="hljs-attr">left</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">right</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">"text"</span> | <span class="hljs-string">"html"</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TextDiff</span> = (<span class="hljs-params">{ left, right, <span class="hljs-keyword">type</span> = <span class="hljs-string">"text"</span> }: DiffProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> leftRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> rightRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">"highlights"</span> <span class="hljs-keyword">in</span> <span class="hljs-variable constant_">CSS</span>)) {
      message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"CSS Custom Highlight API not supported."</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">collectNodes</span> = (<span class="hljs-params">root: HTMLElement | <span class="hljs-literal">null</span></span>) =&gt; {
      <span class="hljs-keyword">if</span> (!root) <span class="hljs-keyword">return</span> { <span class="hljs-attr">nodes</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Text</span>[], <span class="hljs-attr">starts</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>[], <span class="hljs-attr">text</span>: <span class="hljs-string">""</span> };
      <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(root, <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_TEXT</span>);
      <span class="hljs-keyword">const</span> <span class="hljs-attr">nodes</span>: <span class="hljs-title class_">Text</span>[] = [];
      <span class="hljs-keyword">const</span> <span class="hljs-attr">starts</span>: <span class="hljs-built_in">number</span>[] = [];
      <span class="hljs-keyword">let</span> text = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">let</span> cur = walker.<span class="hljs-title function_">nextNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Text</span> | <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">while</span> (cur) {
        nodes.<span class="hljs-title function_">push</span>(cur);
        starts.<span class="hljs-title function_">push</span>(text.<span class="hljs-property">length</span>);
        text += cur.<span class="hljs-property">textContent</span> || <span class="hljs-string">""</span>;
        cur = walker.<span class="hljs-title function_">nextNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Text</span> | <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">return</span> { nodes, starts, text };
    };

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">nodes</span>: leftNodes, <span class="hljs-attr">starts</span>: leftStarts, <span class="hljs-attr">text</span>: leftText } = <span class="hljs-title function_">collectNodes</span>(leftRef.<span class="hljs-property">current</span>);
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">nodes</span>: rightNodes, <span class="hljs-attr">starts</span>: rightStarts, <span class="hljs-attr">text</span>: rightText } = <span class="hljs-title function_">collectNodes</span>(rightRef.<span class="hljs-property">current</span>);

    <span class="hljs-keyword">const</span> n = leftText.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> m = rightText.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">dp</span>: <span class="hljs-built_in">number</span>[][] = <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>)
      .<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>(m + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= m; j++) {
        <span class="hljs-keyword">if</span> (leftText[i - <span class="hljs-number">1</span>] === rightText[j - <span class="hljs-number">1</span>]) dp[i][j] = dp[i - <span class="hljs-number">1</span>][j - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - <span class="hljs-number">1</span>]);
      }
    }

    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Op</span> = { <span class="hljs-attr">t</span>: <span class="hljs-string">"equal"</span> | <span class="hljs-string">"del"</span> | <span class="hljs-string">"add"</span>; ai?: <span class="hljs-built_in">number</span>; bi?: <span class="hljs-built_in">number</span> };
    <span class="hljs-keyword">const</span> <span class="hljs-attr">ops</span>: <span class="hljs-title class_">Op</span>[] = [];
    <span class="hljs-keyword">let</span> i = n,
      j = m;
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> || j &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; j &gt; <span class="hljs-number">0</span> &amp;&amp; leftText[i - <span class="hljs-number">1</span>] === rightText[j - <span class="hljs-number">1</span>]) {
        ops.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">t</span>: <span class="hljs-string">"equal"</span>, <span class="hljs-attr">ai</span>: i - <span class="hljs-number">1</span>, <span class="hljs-attr">bi</span>: j - <span class="hljs-number">1</span> });
        i--;
        j--;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; (i === <span class="hljs-number">0</span> || dp[i][j - <span class="hljs-number">1</span>] &gt;= dp[i - <span class="hljs-number">1</span>][j])) {
        ops.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">t</span>: <span class="hljs-string">"add"</span>, <span class="hljs-attr">bi</span>: j - <span class="hljs-number">1</span> });
        j--;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
        ops.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">t</span>: <span class="hljs-string">"del"</span>, <span class="hljs-attr">ai</span>: i - <span class="hljs-number">1</span> });
        i--;
      }
    }
    ops.<span class="hljs-title function_">reverse</span>();

    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Span</span> = { <span class="hljs-attr">start</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> };
    <span class="hljs-keyword">const</span> <span class="hljs-attr">leftDelSpans</span>: <span class="hljs-title class_">Span</span>[] = [];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">rightAddSpans</span>: <span class="hljs-title class_">Span</span>[] = [];
    <span class="hljs-keyword">let</span> posA = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> posB = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">delRunStart</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> delRunLen = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">addRunStart</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> addRunLen = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">flushDel</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (delRunStart !== <span class="hljs-literal">null</span> &amp;&amp; delRunLen &gt; <span class="hljs-number">0</span>) leftDelSpans.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">start</span>: delRunStart, <span class="hljs-attr">length</span>: delRunLen });
      delRunStart = <span class="hljs-literal">null</span>;
      delRunLen = <span class="hljs-number">0</span>;
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">flushAdd</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (addRunStart !== <span class="hljs-literal">null</span> &amp;&amp; addRunLen &gt; <span class="hljs-number">0</span>) rightAddSpans.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">start</span>: addRunStart, <span class="hljs-attr">length</span>: addRunLen });
      addRunStart = <span class="hljs-literal">null</span>;
      addRunLen = <span class="hljs-number">0</span>;
    };

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> op <span class="hljs-keyword">of</span> ops) {
      <span class="hljs-keyword">if</span> (op.<span class="hljs-property">t</span> === <span class="hljs-string">"equal"</span>) {
        <span class="hljs-title function_">flushDel</span>();
        <span class="hljs-title function_">flushAdd</span>();
        posA++;
        posB++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op.<span class="hljs-property">t</span> === <span class="hljs-string">"del"</span>) {
        <span class="hljs-keyword">if</span> (delRunStart === <span class="hljs-literal">null</span>) delRunStart = posA;
        delRunLen++;
        <span class="hljs-title function_">flushAdd</span>();
        posA++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op.<span class="hljs-property">t</span> === <span class="hljs-string">"add"</span>) {
        <span class="hljs-keyword">if</span> (addRunStart === <span class="hljs-literal">null</span>) addRunStart = posB;
        addRunLen++;
        <span class="hljs-title function_">flushDel</span>();
        posB++;
      }
    }
    <span class="hljs-title function_">flushDel</span>();
    <span class="hljs-title function_">flushAdd</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">locate</span> = (<span class="hljs-params">starts: <span class="hljs-built_in">number</span>[], nodes: Text[], pos: <span class="hljs-built_in">number</span></span>) =&gt; {
      <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (idx &lt; nodes.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> nodeLen = (nodes[idx].<span class="hljs-property">textContent</span> || <span class="hljs-string">""</span>).<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> s = starts[idx];
        <span class="hljs-keyword">if</span> (pos &lt; s + nodeLen) <span class="hljs-keyword">return</span> { <span class="hljs-attr">nodeIndex</span>: idx, <span class="hljs-attr">offset</span>: pos - s };
        idx++;
      }
      <span class="hljs-keyword">const</span> lastIdx = nodes.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">nodeIndex</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, lastIdx), <span class="hljs-attr">offset</span>: (nodes[lastIdx]?.<span class="hljs-property">textContent</span> || <span class="hljs-string">""</span>).<span class="hljs-property">length</span> };
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">spansToRanges</span> = (<span class="hljs-params">spans: Span[], starts: <span class="hljs-built_in">number</span>[], nodes: Text[]</span>) =&gt; {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">ranges</span>: <span class="hljs-title class_">Range</span>[] = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { start, length } <span class="hljs-keyword">of</span> spans) {
        <span class="hljs-keyword">const</span> end = start + length;
        <span class="hljs-keyword">const</span> sLoc = <span class="hljs-title function_">locate</span>(starts, nodes, start);
        <span class="hljs-keyword">const</span> eLoc = <span class="hljs-title function_">locate</span>(starts, nodes, end);
        <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
        r.<span class="hljs-title function_">setStart</span>(nodes[sLoc.<span class="hljs-property">nodeIndex</span>], sLoc.<span class="hljs-property">offset</span>);
        r.<span class="hljs-title function_">setEnd</span>(nodes[eLoc.<span class="hljs-property">nodeIndex</span>], eLoc.<span class="hljs-property">offset</span>);
        ranges.<span class="hljs-title function_">push</span>(r);
      }
      <span class="hljs-keyword">return</span> ranges;
    };

    <span class="hljs-keyword">const</span> leftRanges = <span class="hljs-title function_">spansToRanges</span>(leftDelSpans, leftStarts, leftNodes);
    <span class="hljs-keyword">const</span> rightRanges = <span class="hljs-title function_">spansToRanges</span>(rightAddSpans, rightStarts, rightNodes);

    <span class="hljs-keyword">if</span> (leftRanges.<span class="hljs-property">length</span>) <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"diff-del-left"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(...leftRanges));
    <span class="hljs-keyword">else</span> <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"diff-del-left"</span>);

    <span class="hljs-keyword">if</span> (rightRanges.<span class="hljs-property">length</span>) <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"diff-add-right"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(...rightRanges));
    <span class="hljs-keyword">else</span> <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"diff-add-right"</span>);
  }, [left, right, <span class="hljs-keyword">type</span>]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-diff-container"</span>&gt;</span>
      {type === "html" ? (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"text-diff-pane"</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{leftRef}</span>
        <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">__html:</span> <span class="hljs-attr">left</span> }}
        /&gt;</span>
    ) : (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-diff-pane"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{leftRef}</span>&gt;</span>
        {left}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    )}
      {type === "html" ? (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"text-diff-pane"</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{rightRef}</span>
        <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">__html:</span> <span class="hljs-attr">right</span> }}
        /&gt;</span>
    ) : (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-diff-pane"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{rightRef}</span>&gt;</span>
        {right}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TextDiff</span>;
</code></pre>
<h2 data-id="heading-9">总结</h2>
<p>目前来看，CSS Custom Highlight API 就是网页文本高亮的“神器”。特别适合那些需要疯狂标记、又不能动原文档结构的应用，比如在线文档、代码编辑器。只要浏览器支持，用它就对了，绝对是未来的趋势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不再费脑, 拆解 AI 的数学工具, 诠释函数, 向量, 矩阵和神经网络的关系]]></title>    <link>https://juejin.cn/post/7593356633637863458</link>    <guid>https://juejin.cn/post/7593356633637863458</guid>    <pubDate>2026-01-11T23:51:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593356633637863458" data-draft-id="7593573617647222836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不再费脑, 拆解 AI 的数学工具, 诠释函数, 向量, 矩阵和神经网络的关系"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2026-01-11T23:51:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不再费脑, 拆解 AI 的数学工具, 诠释函数, 向量, 矩阵和神经网络的关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-11T23:51:38.000Z" title="Sun Jan 11 2026 23:51:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好, 我是印刻君. 今天我们来聊一个很多 AI 爱好者容易困惑的问题, 函数, 向量, 矩阵与神经网络之间到底是什么关系?</p>
<p>不少朋友接触 AI 时, 常会被一连串数学概念绕得晕头转向. 上一秒是 "函数", 下一秒是 "向量", 过一会又出现 "矩阵", 紧接着又是 "神经网络". 自己似乎每个概念都懂一点, 但放在一起就成了一团乱麻.</p>
<p>今天, 我们就从最基础的概念出发, 一步步把这些知识点串联起来, 梳理出一条清晰的逻辑链, 帮你看懂这些数学概念的关系.</p>
<blockquote>
<p>阅读本文前, 最好对向量, 矩阵有一个基础了解, 阅读体验会更好:</p>
<p>不熟悉向量, 可以看我的文章: <a href="https://juejin.cn/post/7577795545441009698" target="_blank" title="https://juejin.cn/post/7577795545441009698">不再费脑，写给爱好者的 AI 向量 (Vector) 入门课</a></p>
<p>不熟悉矩阵, 可以看我的文章: <a href="https://juejin.cn/post/7588109656042651694" target="_blank" title="https://juejin.cn/post/7588109656042651694">不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南</a></p>
</blockquote>
<h2 data-id="heading-0">1 从函数说起, AI 的本质是用函数刻画世界规律</h2>
<p>要理清这些概念, 我们首先要回到最根本的数学工具<strong>函数</strong>上. 其实人工智能的核心目标很简单, <strong>用函数刻画现实世界的规律.</strong></p>
<p>这个目标可以简化为 "输入-输出" 的转换过程, 输入是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>, 输出是经过函数计算的结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>, 中间的转换过程就是函数.</p>
<p>这里的输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 可以是现实世界的各种数据, 比如苹果的重量, 图片的像素值等; 而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 则是我们想要得到的结果, 比如苹果的总价, 图片的分类标签 (是猫还是狗) 等. AI 要做的核心工作, 就是找出合适的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>, 完成从输入到输出的转换.</p>
<blockquote>
<p>需要注意的是, 现代 AI 并没有找到绝对精准的函数, 找到的只是近似的函数, 这种 "近似" 涉及到概率论的相关知识, 本文为了聚焦核心逻辑链, 暂不展开这部分内容.</p>
</blockquote>
<h2 data-id="heading-1">2 一元函数与线性关系</h2>
<p>要找 AI 需要的函数, 我们先从最简单的规律入手. 现实中最容易理解的规律是线性关系, 对应的数学工具是线性函数, 表达式为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>w</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">f(x) = wx + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>. 这里的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 是两个关键参数.</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></span> 是 "权重", 可以理解为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 对结果的影响程度.</li>
<li>b 是 "偏置", 可以理解为不依赖输入的固定的基准值.</li>
</ul>
<p>举生活例子, 假如 1 斤苹果卖 5 元钱, 那么买 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 斤苹果的总价 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>, 就可以用线性函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>5</mn><mi>x</mi><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f(x) = 5x + 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 表示.</p>
<ul>
<li>这里的权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">w=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span>, 代表每斤苹果的价格对总价的影响;</li>
<li>偏置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">b=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>, 因为买 0 斤苹果时, 总价自然为 0, 没有额外的固定成本. (如果例子是打车, 起步费为 10 块, 偏置就是 10).</li>
</ul>
<h2 data-id="heading-2">3 单输出的多元函数与向量</h2>
<p>刚才苹果的例子,是 "单输入 (单元), 单输出" 的情况. 但实际生活中, 情况其实更复杂, 我们更容易遇见的 "多输入 (多元), 单输出" 的情况.</p>
<p>比如通过 "房间数量, 房间面积, 楼层高度" 这三个输入, 预测 "房屋总价" 这一个输出.</p>
<p>这时候我们需要用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 分别代表三个输入, 对应的函数表达式为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_1, x_2, x_3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace width="1em"/><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>w</mi><mn>3</mn></msub><msub><mi>x</mi><mn>3</mn></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">\quad = w_1x_1 + w_2x_2 + w_3x_3 + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mspace" style="margin-right:1em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">w_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">w_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">w_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 分别是三个输入对应的权重 (比如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">w_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 代表房间面积对房价的影响力度), <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 是偏置项.</p>
<p>如果推广到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 个输入的场景, 函数表达式写为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_1, x_2, ...x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace width="1em"/><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">\quad = w_1x_1 + w_2x_2 + ... + w_nx_n + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mspace" style="margin-right:1em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>我们发现, 当输入变量增多后, 表达式就变得冗长了, 这时候需要一种工具来简化表达.</p>
<p><strong>向量</strong>就是这个关键工具:</p>
<ul>
<li>我们可以把所有输入  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[x_1, x_2, ..., x_n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span> 打包, 用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span></span> (小写字母加粗) 表示, 它就是输入向量;</li>
<li>再把所有权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>w</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[w_1, w_2, ..., w_n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span> 打包, 用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">w</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span></span></span></span></span> (小写字母加粗) 表示, 它就是权重向量.</li>
</ul>
<p>通过点乘运算 (本质是对应元素相乘后求和), 原本冗长的表达式就被简化为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="bold-italic">w</mi><mo>⋅</mo><mi mathvariant="bold-italic">x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">f(\boldsymbol{x}) = \boldsymbol{w} \cdot \boldsymbol{x} + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>这里可以明确一个关系, 一元函数是多元函数的特殊情况, 当输入向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span></span> 只有 1 维时, 多元函数就退化成了一元函数.</p>
<p>这里向量的核心作用, 就是把多个参数打包整合, 让复杂的函数表达式更简洁, 更通用.</p>
<h2 data-id="heading-3">4 多输出的多元函数与矩阵</h2>
<p>前面预测 "房屋总价" 的例子是 "多输入, 单输出", 但现实生活中, 我们还常常会遇到 "多输入, 多输出" 的场景.</p>
<p>同样以房屋为例子, 我们需要通过 "房间数量, 房间面积, 楼层高度" 这三个输入, 预测 "房屋总价, 月租金额" 两个输出.</p>
<p>这种情况下, 我们需要为每个输出单独构建一个多元函数, 形成方程组:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>w</mi><mn>11</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>12</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>w</mi><mn>13</mn></msub><msub><mi>x</mi><mn>3</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>w</mi><mn>21</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>22</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>w</mi><mn>23</mn></msub><msub><mi>x</mi><mn>3</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
f_1(x_1, x_2, x_3) = w_{11}x_1 + w_{12}x_2 + w_{13}x_3 + b_1 \\
f_2(x_1, x_2, x_3) = w_{21}x_1 + w_{22}x_2 + w_{23}x_3 + b_2
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中:</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_1(x_1, x_2, x_3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 是预测房屋总价的函数, 而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_2(x_1, x_2, x_3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 是预测月租金额的函数;</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个输出对应的第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个输入的权重 (比如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>12</mn></msub></mrow><annotation encoding="application/x-tex">w_{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是房间面积 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 对房屋总价 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">f_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的影响权重);</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">b_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">b_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 则是对应两个输出的偏置项</li>
</ul>
<p>观察这个方程组会发现, 如果我们把所有的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 提取出来, 会形成一个 2 行 3 列的 "权重阵列", 再把两个输出, 三个输入, 两个权重打包成向量, 方程组就开始用矩阵乘法简化表示:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>2</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>13</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>w</mi><mn>23</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>3</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>+</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>b</mi><mn>2</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
f_1 \\
f_2
\end{bmatrix} = \begin{bmatrix}
w_{11} &amp; w_{12} &amp; w_{13} \\
w_{21} &amp; w_{22} &amp; w_{23} \\
\end{bmatrix} \cdot \begin{bmatrix}
x_1 \\
x_2 \\
x_3
\end{bmatrix} + \begin{bmatrix}
b_1 \\
b_2
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>我们把这个 "权重阵列" 称为<strong>矩阵</strong>，用大写粗体字母 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">W</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span></span></span></span></span> 表示, 同时用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">f</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">b</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">b</span></span></span></span></span></span></span> 表示竖着排的输出向量, 输入向量和偏置向量, 方程组可以简化为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">f</mi><mo>=</mo><mi mathvariant="bold-italic">W</mi><mo>⋅</mo><mi mathvariant="bold-italic">x</mi><mo>+</mo><mi mathvariant="bold-italic">b</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{f} = \boldsymbol{W} \cdot \boldsymbol{x} + \boldsymbol{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6861em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">b</span></span></span></span></span></span></span></p>
<p>这里要明确核心关系, <strong>矩阵</strong>本质是<strong>向量</strong>的组合, 把多个向量横着或者竖着排, 就形成了矩阵. 反过来, 向量也可以看成是 1 行 n 列, 或者 n 行 1 列的矩阵.</p>
<p>矩阵的核心作用, 就是把 "多输入, 多输出" 的复杂场景, 用一套标准的运算统一整合. 大幅度提升 AI 处理复杂任务的效率.</p>
<h2 data-id="heading-4">5 非线性关系与激活函数</h2>
<p>前面我们讨论的都是线性关系, 但现实生活的规律大多数都是非线性的.</p>
<p>举个例子, 人的年龄和收入的关系. 20 岁之前, 收入可能很低甚至为零; 20~40 岁之间, 收入会快速增长; 40岁之后, 收入可能趋于稳定甚至缓慢下降.</p>
<p>这种 "不按比例线性变化" 的关系, 就是非线性关系. 显然，线性函数无法精准刻画这种复杂的规律.</p>
<p>这时候, <strong>激活函数</strong>就成了解决问题的关键, 我们在原有线性计算的基础上, 加入一个激活函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></span>, 函数表达式变为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">f</mi><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">W</mi><mo>⋅</mo><mi mathvariant="bold-italic">x</mi><mo>+</mo><mi mathvariant="bold-italic">b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\boldsymbol{f} = g(\boldsymbol{W} \cdot \boldsymbol{x} + \boldsymbol{b})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">b</span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>激活函数的作用, 就是给线性计算的结果, 加上 "非线性" 转换, 让函数拥有刻画复杂规律的能力.</p>
<blockquote>
<p>常见的激活函数有:</p>
<ul>
<li>
<p>Sigmoid, 可以将结果映射到 0 和 1 之间, 适合概率预测;</p>
</li>
<li>
<p>ReLU, 在输入为正时直接输出, 为负是输出 0, 是当前 AI 最常用的激活函数之一.</p>
</li>
</ul>
</blockquote>
<p>而 "线性计算 + 非线性激活" 的组合, 就是神经网络中最基础的<strong>神经元</strong>, 它模拟了生物接受信号, 处理信号的过程, 如果用神经网络结构图表示, 单个神经元结构如下:</p>
<ul>
<li>单输入的神经元:</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/733c9380bc8e4801bf0f7eca32b1bfa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768780387&amp;x-signature=IIVc7W2NXpY8Hwh5swnmACKRPKw%3D" alt="1-1.png" loading="lazy"/></p>
<ul>
<li>多输入的神经元:</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5f3eef7bba941718dab9c12e7a156b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768780387&amp;x-signature=Vie3bq8VpeFcJRJ2SuCc83TI2ZQ%3D" alt="n-1.png" loading="lazy"/></p>
<h2 data-id="heading-5">6 多层堆叠与神经网络</h2>
<p>可能有朋友会问, 加入一次非线性转换, 就够拟合所有复杂规律了吗? 答案是 "不够".</p>
<p>现实世界中的很多规律, 比如图像识别 (判断图片是猫还是狗), 自然语言理解 (从文字中读懂情感) 这类复杂任务, 其复杂程度远超一次非线性转换能刻画的范围.</p>
<p>那该怎么办呢? 我们的做法是: <strong>把 "线性计算 + 非线性激活" 的模块, 一层一层地叠加.</strong> 这就是 "多层神经网络" 的核心逻辑.</p>
<p>比如一个 2 层的神经网络, 它的函数表达式为:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">f</mi><mo>=</mo><mi><msub><mi mathvariant="bold-italic">W</mi><mn mathvariant="bold">2</mn></msub></mi><mo>⋅</mo><mi>g</mi><mo stretchy="false">(</mo><mi><msub><mi mathvariant="bold-italic">W</mi><mn mathvariant="bold">1</mn></msub></mi><mo>⋅</mo><mi mathvariant="bold-italic">x</mi><mo>+</mo><mi><msub><mi mathvariant="bold-italic">b</mi><mn mathvariant="bold">1</mn></msub></mi><mo stretchy="false">)</mo><mo>+</mo><mi><msub><mi mathvariant="bold-italic">b</mi><mn mathvariant="bold">2</mn></msub></mi></mrow><annotation encoding="application/x-tex">\boldsymbol{f} = \boldsymbol{W_2} \cdot g(\boldsymbol{W_1} \cdot \boldsymbol{x} + \boldsymbol{b_1}) + \boldsymbol{b_2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8361em;vertical-align:-0.15em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这个过程中:</p>
<ul>
<li>第一层神经元先对原始特征 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span></span> 做初步的特征提取 (比如在图像检测中, 提取边缘/纹理等简单特征. 经过激活函数处理后, 把结果传递到第二层;</li>
<li>第二层神经元, 对第一层的结果做更复杂的特征整合 (比如把边缘, 纹理等特征整合为 "眼睛" "耳朵" 等更高级的特征), 最终输出预测结果.</li>
</ul>
<p>这个过程, 假设最开始的输入是 6 个, 第一层输出是 3 个, 第二层输出是 1 个, 则神经网络结构图为:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e053ef777cf4ca68b59f52c4dc07a71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768780387&amp;x-signature=SEzszpQQTSFD7%2FtvKjEBC9QUSOU%3D" alt="6-3-1.png" loading="lazy"/></p>
<p>层数堆叠越多, 结构越来越复杂, 这就是神经网络:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b481372226447209ce747f50d1f9729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768780387&amp;x-signature=Ez8m%2B0dcdyvTF%2BF8dp8mWR0VrDE%3D" alt="n-n-1.png" loading="lazy"/></p>
<p>当前主流的大模型, 堆叠的层数更是达到了几百甚至上千层.</p>
<h2 data-id="heading-6">总结</h2>
<p>AI 的核心目的是刻画世界的规律, 而函数, 向量, 矩阵, 神经网络是达成这个目的的数学工具. 向量被用来简化多输入的表达, 矩阵被用来整合多输出的运算, 叠加 "线性计算 + 非线性激活" 则形成了神经网络.</p>
<p>我是印刻君，一位探索 AI 的前端程序员，关注我，让 AI 知识有温度，技术落地有深度.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java学习第34天 - 性能优化与系统监控]]></title>    <link>https://juejin.cn/post/7594047593967960102</link>    <guid>https://juejin.cn/post/7594047593967960102</guid>    <pubDate>2026-01-12T07:02:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594047593967960102" data-draft-id="7594242987597791259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java学习第34天 - 性能优化与系统监控"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-12T07:02:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浮游本尊"/> <meta itemprop="url" content="https://juejin.cn/user/2533726710668696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java学习第34天 - 性能优化与系统监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2533726710668696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浮游本尊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T07:02:47.000Z" title="Mon Jan 12 2026 07:02:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    55
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习目标</h2>
<p>掌握性能优化方法，学习系统监控与可观测性，理解安全认证机制，掌握测试方法，了解最佳实践，提升系统性能与稳定性。</p>
<hr/>
<h2 data-id="heading-1">1. 性能优化</h2>
<h3 data-id="heading-2">1.1 JVM调优</h3>
<p><strong>JVM参数配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JVM调优配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JvmTuningConfig</span> {
    
    <span class="hljs-comment">// 堆内存配置</span>
    <span class="hljs-comment">// -Xms2g -Xmx2g：初始堆和最大堆大小</span>
    <span class="hljs-comment">// -XX:NewRatio=2：新生代与老年代比例</span>
    <span class="hljs-comment">// -XX:SurvivorRatio=8：Eden与Survivor比例</span>
    
    <span class="hljs-comment">// GC配置</span>
    <span class="hljs-comment">// -XX:+UseG1GC：使用G1垃圾收集器</span>
    <span class="hljs-comment">// -XX:MaxGCPauseMillis=200：最大GC暂停时间</span>
    <span class="hljs-comment">// -XX:G1HeapRegionSize=16m：G1区域大小</span>
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printJvmInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
        <span class="hljs-type">long</span> <span class="hljs-variable">maxMemory</span> <span class="hljs-operator">=</span> runtime.maxMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">totalMemory</span> <span class="hljs-operator">=</span> runtime.totalMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">freeMemory</span> <span class="hljs-operator">=</span> runtime.freeMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">usedMemory</span> <span class="hljs-operator">=</span> totalMemory - freeMemory;
        
        log.info(<span class="hljs-string">"最大内存: {} MB"</span>, maxMemory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
        log.info(<span class="hljs-string">"总内存: {} MB"</span>, totalMemory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
        log.info(<span class="hljs-string">"已用内存: {} MB"</span>, usedMemory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
        log.info(<span class="hljs-string">"可用内存: {} MB"</span>, freeMemory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
        
        <span class="hljs-comment">// 内存使用率</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">memoryUsage</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) usedMemory / totalMemory * <span class="hljs-number">100</span>;
        log.info(<span class="hljs-string">"内存使用率: {:.2f}%"</span>, memoryUsage);
    }
}

<span class="hljs-comment">// 内存监控服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryMonitorService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MemoryMXBean</span> <span class="hljs-variable">memoryBean</span> <span class="hljs-operator">=</span> ManagementFactory.getMemoryMXBean();
    
    <span class="hljs-comment">// 获取堆内存使用情况</span>
    <span class="hljs-keyword">public</span> MemoryUsage <span class="hljs-title function_">getHeapMemoryUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> memoryBean.getHeapMemoryUsage();
    }
    
    <span class="hljs-comment">// 获取非堆内存使用情况</span>
    <span class="hljs-keyword">public</span> MemoryUsage <span class="hljs-title function_">getNonHeapMemoryUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> memoryBean.getNonHeapMemoryUsage();
    }
    
    <span class="hljs-comment">// 检查内存使用率</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isMemoryUsageHigh</span><span class="hljs-params">(<span class="hljs-type">double</span> threshold)</span> {
        <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">heapUsage</span> <span class="hljs-operator">=</span> getHeapMemoryUsage();
        <span class="hljs-type">long</span> <span class="hljs-variable">used</span> <span class="hljs-operator">=</span> heapUsage.getUsed();
        <span class="hljs-type">long</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> heapUsage.getMax();
        <span class="hljs-type">double</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) used / max * <span class="hljs-number">100</span>;
        
        log.info(<span class="hljs-string">"堆内存使用率: {:.2f}%"</span>, usage);
        <span class="hljs-keyword">return</span> usage &gt; threshold;
    }
    
    <span class="hljs-comment">// 触发GC</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">triggerGC</span><span class="hljs-params">()</span> {
        System.gc();
        log.info(<span class="hljs-string">"手动触发GC"</span>);
    }
    
    <span class="hljs-comment">// 获取GC信息</span>
    <span class="hljs-keyword">public</span> List&lt;GarbageCollectorMXBean&gt; <span class="hljs-title function_">getGCBeans</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ManagementFactory.getGarbageCollectorMXBeans();
    }
    
    <span class="hljs-comment">// 打印GC统计信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGCStats</span><span class="hljs-params">()</span> {
        List&lt;GarbageCollectorMXBean&gt; gcBeans = getGCBeans();
        <span class="hljs-keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) {
            log.info(<span class="hljs-string">"GC名称: {}"</span>, gcBean.getName());
            log.info(<span class="hljs-string">"GC次数: {}"</span>, gcBean.getCollectionCount());
            log.info(<span class="hljs-string">"GC总时间: {} ms"</span>, gcBean.getCollectionTime());
        }
    }
}

<span class="hljs-comment">// 线程监控服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadMonitorService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadMXBean</span> <span class="hljs-variable">threadBean</span> <span class="hljs-operator">=</span> ManagementFactory.getThreadMXBean();
    
    <span class="hljs-comment">// 获取线程信息</span>
    <span class="hljs-keyword">public</span> ThreadInfo[] getAllThreadInfo() {
        <span class="hljs-type">long</span>[] threadIds = threadBean.getAllThreadIds();
        <span class="hljs-keyword">return</span> threadBean.getThreadInfo(threadIds);
    }
    
    <span class="hljs-comment">// 打印线程统计信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printThreadStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> threadBean.getThreadCount();
        <span class="hljs-type">int</span> <span class="hljs-variable">peakThreadCount</span> <span class="hljs-operator">=</span> threadBean.getPeakThreadCount();
        <span class="hljs-type">long</span> <span class="hljs-variable">totalStartedThreadCount</span> <span class="hljs-operator">=</span> threadBean.getTotalStartedThreadCount();
        
        log.info(<span class="hljs-string">"当前线程数: {}"</span>, threadCount);
        log.info(<span class="hljs-string">"峰值线程数: {}"</span>, peakThreadCount);
        log.info(<span class="hljs-string">"总启动线程数: {}"</span>, totalStartedThreadCount);
        
        <span class="hljs-comment">// 打印所有线程信息</span>
        ThreadInfo[] threadInfos = getAllThreadInfo();
        <span class="hljs-keyword">for</span> (ThreadInfo threadInfo : threadInfos) {
            <span class="hljs-keyword">if</span> (threadInfo != <span class="hljs-literal">null</span>) {
                log.info(<span class="hljs-string">"线程: {} - 状态: {} - CPU时间: {} ns"</span>,
                    threadInfo.getThreadName(),
                    threadInfo.getThreadState(),
                    threadBean.getThreadCpuTime(threadInfo.getThreadId())
                );
            }
        }
    }
    
    <span class="hljs-comment">// 检测死锁</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span>[] detectDeadlocks() {
        <span class="hljs-keyword">return</span> threadBean.findDeadlockedThreads();
    }
}
</code></pre>
<h3 data-id="heading-3">1.2 代码级优化</h3>
<p><strong>字符串优化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 字符串优化服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringOptimizationService</span> {
    
    <span class="hljs-comment">// 使用StringBuilder代替字符串拼接</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildString</span><span class="hljs-params">(List&lt;String&gt; items)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (String item : items) {
            sb.append(item);
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-comment">// 使用String.join（Java 8+）</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">joinStrings</span><span class="hljs-params">(List&lt;String&gt; items)</span> {
        <span class="hljs-keyword">return</span> String.join(<span class="hljs-string">""</span>, items);
    }
    
    <span class="hljs-comment">// 字符串常量池优化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareStrings</span><span class="hljs-params">(String str1, String str2)</span> {
        <span class="hljs-comment">// 使用equals比较内容</span>
        <span class="hljs-keyword">return</span> str1.equals(str2);
        
        <span class="hljs-comment">// 使用intern()利用常量池</span>
        <span class="hljs-comment">// return str1.intern() == str2.intern();</span>
    }
    
    <span class="hljs-comment">// 避免在循环中创建字符串</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processStrings</span><span class="hljs-params">(List&lt;String&gt; items)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (String item : items) {
            <span class="hljs-comment">// 避免在循环中创建临时字符串</span>
            result.append(item.toUpperCase());
        }
        <span class="hljs-keyword">return</span> result.toString();
    }
}

<span class="hljs-comment">// 集合优化服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionOptimizationService</span> {
    
    <span class="hljs-comment">// 指定集合初始容量</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">createList</span><span class="hljs-params">(<span class="hljs-type">int</span> expectedSize)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(expectedSize);
    }
    
    <span class="hljs-comment">// 使用合适的集合类型</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">useAppropriateCollection</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 需要快速查找使用HashSet</span>
        Set&lt;String&gt; uniqueItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        
        <span class="hljs-comment">// 需要保持顺序使用LinkedHashSet</span>
        Set&lt;String&gt; orderedItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();
        
        <span class="hljs-comment">// 需要排序使用TreeSet</span>
        Set&lt;String&gt; sortedItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;&gt;();
        
        <span class="hljs-comment">// 需要键值对使用HashMap</span>
        Map&lt;String, String&gt; keyValueMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 需要线程安全使用ConcurrentHashMap</span>
        Map&lt;String, String&gt; concurrentMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">// 使用Stream API优化集合操作</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">filterAndTransform</span><span class="hljs-params">(List&lt;String&gt; items)</span> {
        <span class="hljs-keyword">return</span> items.stream()
            .filter(item -&gt; item.length() &gt; <span class="hljs-number">5</span>)
            .map(String::toUpperCase)
            .collect(Collectors.toList());
    }
    
    <span class="hljs-comment">// 避免不必要的迭代</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsItem</span><span class="hljs-params">(List&lt;String&gt; items, String target)</span> {
        <span class="hljs-comment">// 使用contains方法而不是遍历</span>
        <span class="hljs-keyword">return</span> items.contains(target);
    }
}

<span class="hljs-comment">// 对象创建优化</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectCreationOptimizationService</span> {
    
    <span class="hljs-comment">// 使用对象池</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectPool&lt;StringBuilder&gt; stringBuilderPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledObjectFactory</span>&lt;StringBuilder&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> PooledObject&lt;StringBuilder&gt; <span class="hljs-title function_">makeObject</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPooledObject</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>());
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyObject</span><span class="hljs-params">(PooledObject&lt;StringBuilder&gt; p)</span> {
                p.getObject().setLength(<span class="hljs-number">0</span>);
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateObject</span><span class="hljs-params">(PooledObject&lt;StringBuilder&gt; p)</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">activateObject</span><span class="hljs-params">(PooledObject&lt;StringBuilder&gt; p)</span> {
                p.getObject().setLength(<span class="hljs-number">0</span>);
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">passivateObject</span><span class="hljs-params">(PooledObject&lt;StringBuilder&gt; p)</span> {
                p.getObject().setLength(<span class="hljs-number">0</span>);
            }
        }
    );
    
    <span class="hljs-comment">// 重用对象</span>
    <span class="hljs-keyword">public</span> StringBuilder <span class="hljs-title function_">getStringBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> stringBuilderPool.borrowObject();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"获取StringBuilder失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnStringBuilder</span><span class="hljs-params">(StringBuilder sb)</span> {
        <span class="hljs-keyword">try</span> {
            stringBuilderPool.returnObject(sb);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"归还StringBuilder失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 使用不可变对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutableData</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ImmutableData</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> value)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.value = value;
        }
        
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> name;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> value;
        }
    }
}
</code></pre>
<h3 data-id="heading-4">1.3 数据库优化</h3>
<p><strong>数据库连接池优化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库连接池配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    
    <span class="hljs-comment">// HikariCP连接池配置（推荐）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.hikari")</span>
    <span class="hljs-keyword">public</span> HikariDataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HikariConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariConfig</span>();
        
        <span class="hljs-comment">// 连接池大小</span>
        config.setMaximumPoolSize(<span class="hljs-number">20</span>);
        config.setMinimumIdle(<span class="hljs-number">5</span>);
        
        <span class="hljs-comment">// 连接超时</span>
        config.setConnectionTimeout(<span class="hljs-number">30000</span>);
        config.setIdleTimeout(<span class="hljs-number">600000</span>);
        config.setMaxLifetime(<span class="hljs-number">1800000</span>);
        
        <span class="hljs-comment">// 连接测试</span>
        config.setConnectionTestQuery(<span class="hljs-string">"SELECT 1"</span>);
        config.setValidationTimeout(<span class="hljs-number">5000</span>);
        
        <span class="hljs-comment">// 性能优化</span>
        config.addDataSourceProperty(<span class="hljs-string">"cachePrepStmts"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"prepStmtCacheSize"</span>, <span class="hljs-string">"250"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"prepStmtCacheSqlLimit"</span>, <span class="hljs-string">"2048"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"useServerPrepStmts"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"useLocalSessionState"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"rewriteBatchedStatements"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"cacheResultSetMetadata"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"cacheServerConfiguration"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"elideSetAutoCommits"</span>, <span class="hljs-string">"true"</span>);
        config.addDataSourceProperty(<span class="hljs-string">"maintainTimeStats"</span>, <span class="hljs-string">"false"</span>);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>(config);
    }
}

<span class="hljs-comment">// 数据库查询优化服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseOptimizationService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;
    
    <span class="hljs-comment">// 批量插入优化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsert</span><span class="hljs-params">(List&lt;Map&lt;String, Object&gt;&gt; dataList)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO orders (order_id, user_id, amount) VALUES (?, ?, ?)"</span>;
        
        jdbcTemplate.batchUpdate(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchPreparedStatementSetter</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValues</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i)</span> <span class="hljs-keyword">throws</span> SQLException {
                Map&lt;String, Object&gt; data = dataList.get(i);
                ps.setString(<span class="hljs-number">1</span>, (String) data.get(<span class="hljs-string">"orderId"</span>));
                ps.setLong(<span class="hljs-number">2</span>, (Long) data.get(<span class="hljs-string">"userId"</span>));
                ps.setBigDecimal(<span class="hljs-number">3</span>, (BigDecimal) data.get(<span class="hljs-string">"amount"</span>));
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBatchSize</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> dataList.size();
            }
        });
    }
    
    <span class="hljs-comment">// 使用索引优化查询</span>
    <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">queryWithIndex</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 确保userId字段有索引</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM orders WHERE user_id = ?"</span>;
        <span class="hljs-keyword">return</span> jdbcTemplate.queryForList(sql, userId);
    }
    
    <span class="hljs-comment">// 分页查询优化</span>
    <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">queryWithPagination</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> {
        <span class="hljs-comment">// 使用LIMIT和OFFSET</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (page - <span class="hljs-number">1</span>) * size;
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM orders ORDER BY create_time DESC LIMIT ? OFFSET ?"</span>;
        <span class="hljs-keyword">return</span> jdbcTemplate.queryForList(sql, size, offset);
    }
    
    <span class="hljs-comment">// 避免N+1查询问题</span>
    <span class="hljs-keyword">public</span> List&lt;OrderDTO&gt; <span class="hljs-title function_">getOrdersWithUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用JOIN一次性查询</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT o.*, u.name as user_name "</span> +
                     <span class="hljs-string">"FROM orders o "</span> +
                     <span class="hljs-string">"JOIN users u ON o.user_id = u.id"</span>;
        
        <span class="hljs-keyword">return</span> jdbcTemplate.query(sql, (rs, rowNum) -&gt; {
            <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
            order.setId(rs.getLong(<span class="hljs-string">"id"</span>));
            order.setUserId(rs.getLong(<span class="hljs-string">"user_id"</span>));
            order.setUserName(rs.getString(<span class="hljs-string">"user_name"</span>));
            order.setAmount(rs.getBigDecimal(<span class="hljs-string">"amount"</span>));
            <span class="hljs-keyword">return</span> order;
        });
    }
}

<span class="hljs-comment">// MyBatis Plus查询优化</span>
<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Order&gt; {
    
    <span class="hljs-comment">// 使用索引字段查询</span>
    <span class="hljs-meta">@Select("SELECT * FROM orders WHERE user_id = #{userId} AND status = #{status}")</span>
    List&lt;Order&gt; <span class="hljs-title function_">findByUserIdAndStatus</span><span class="hljs-params">(<span class="hljs-meta">@Param("userId")</span> Long userId, 
                                      <span class="hljs-meta">@Param("status")</span> String status)</span>;
    
    <span class="hljs-comment">// 批量插入</span>
    <span class="hljs-meta">@Insert("&lt;script&gt;" +
            "INSERT INTO orders (order_id, user_id, amount) VALUES " +
            "&lt;foreach collection='orders' item='order' separator=','&gt;" +
            "(#{order.orderId}, #{order.userId}, #{order.amount})" +
            "&lt;/foreach&gt;" +
            "&lt;/script&gt;")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsert</span><span class="hljs-params">(<span class="hljs-meta">@Param("orders")</span> List&lt;Order&gt; orders)</span>;
    
    <span class="hljs-comment">// 使用分页插件</span>
    IPage&lt;Order&gt; <span class="hljs-title function_">selectPage</span><span class="hljs-params">(IPage&lt;Order&gt; page, 
                           <span class="hljs-meta">@Param("userId")</span> Long userId)</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-5">2. 系统监控</h2>
<h3 data-id="heading-6">2.1 APM应用性能监控</h3>
<p><strong>Spring Boot Actuator监控：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Actuator配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActuatorConfig</span> {
    
    <span class="hljs-comment">// 自定义健康检查</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Slf4j</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {
        
        <span class="hljs-meta">@Autowired</span>
        <span class="hljs-keyword">private</span> DataSource dataSource;
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 检查数据库连接</span>
                <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection()) {
                    <span class="hljs-keyword">if</span> (connection.isValid(<span class="hljs-number">1</span>)) {
                        <span class="hljs-keyword">return</span> Health.up()
                            .withDetail(<span class="hljs-string">"database"</span>, <span class="hljs-string">"可用"</span>)
                            .build();
                    }
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"健康检查失败"</span>, e);
                <span class="hljs-keyword">return</span> Health.down()
                    .withDetail(<span class="hljs-string">"database"</span>, <span class="hljs-string">"不可用"</span>)
                    .withException(e)
                    .build();
            }
            
            <span class="hljs-keyword">return</span> Health.down().build();
        }
    }
    
    <span class="hljs-comment">// 自定义指标</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Slf4j</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMetrics</span> {
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter requestCounter;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer requestTimer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Gauge activeUsers;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomMetrics</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> {
            <span class="hljs-built_in">this</span>.meterRegistry = meterRegistry;
            <span class="hljs-built_in">this</span>.requestCounter = Counter.builder(<span class="hljs-string">"custom.requests"</span>)
                .description(<span class="hljs-string">"自定义请求计数"</span>)
                .register(meterRegistry);
            <span class="hljs-built_in">this</span>.requestTimer = Timer.builder(<span class="hljs-string">"custom.request.duration"</span>)
                .description(<span class="hljs-string">"自定义请求耗时"</span>)
                .register(meterRegistry);
            <span class="hljs-built_in">this</span>.activeUsers = Gauge.builder(<span class="hljs-string">"custom.active.users"</span>, 
                () -&gt; getActiveUserCount())
                .description(<span class="hljs-string">"活跃用户数"</span>)
                .register(meterRegistry);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementRequest</span><span class="hljs-params">()</span> {
            requestCounter.increment();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordRequestTime</span><span class="hljs-params">(Duration duration)</span> {
            requestTimer.record(duration);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getActiveUserCount</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 获取活跃用户数</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">100.0</span>;
        }
    }
}

<span class="hljs-comment">// 监控拦截器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoringInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CustomMetrics customMetrics;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler)</span> {
        request.setAttribute(<span class="hljs-string">"startTime"</span>, System.currentTimeMillis());
        customMetrics.incrementRequest();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex)</span> {
        <span class="hljs-type">Long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> (Long) request.getAttribute(<span class="hljs-string">"startTime"</span>);
        <span class="hljs-keyword">if</span> (startTime != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            customMetrics.recordRequestTime(Duration.ofMillis(duration));
            
            log.info(<span class="hljs-string">"请求路径: {}, 耗时: {} ms"</span>, 
                request.getRequestURI(), duration);
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2.2 日志管理</h3>
<p><strong>日志配置与优化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 日志配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingConfig</span> {
    
    <span class="hljs-comment">// Logback配置（logback-spring.xml）</span>
    <span class="hljs-comment">/*
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;configuration&gt;
        &lt;springProfile name="dev"&gt;
            &lt;appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender"&gt;
                &lt;encoder&gt;
                    &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
                &lt;/encoder&gt;
            &lt;/appender&gt;
            &lt;root level="INFO"&gt;
                &lt;appender-ref ref="CONSOLE" /&gt;
            &lt;/root&gt;
        &lt;/springProfile&gt;
        
        &lt;springProfile name="prod"&gt;
            &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
                &lt;file&gt;logs/application.log&lt;/file&gt;
                &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
                    &lt;fileNamePattern&gt;logs/application.%d{yyyy-MM-dd}.%i.log&lt;/fileNamePattern&gt;
                    &lt;maxFileSize&gt;100MB&lt;/maxFileSize&gt;
                    &lt;maxHistory&gt;30&lt;/maxHistory&gt;
                    &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;
                &lt;/rollingPolicy&gt;
                &lt;encoder&gt;
                    &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
                &lt;/encoder&gt;
            &lt;/appender&gt;
            &lt;root level="INFO"&gt;
                &lt;appender-ref ref="FILE" /&gt;
            &lt;/root&gt;
        &lt;/springProfile&gt;
    &lt;/configuration&gt;
    */</span>
}

<span class="hljs-comment">// 结构化日志服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StructuredLoggingService</span> {
    
    <span class="hljs-comment">// 使用MDC添加上下文信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logWithContext</span><span class="hljs-params">(String userId, String operation)</span> {
        MDC.put(<span class="hljs-string">"userId"</span>, userId);
        MDC.put(<span class="hljs-string">"operation"</span>, operation);
        MDC.put(<span class="hljs-string">"requestId"</span>, UUID.randomUUID().toString());
        
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"执行操作: {}"</span>, operation);
            <span class="hljs-comment">// 业务逻辑</span>
        } <span class="hljs-keyword">finally</span> {
            MDC.clear();
        }
    }
    
    <span class="hljs-comment">// 异步日志</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAsync</span><span class="hljs-params">(String message)</span> {
        CompletableFuture.runAsync(() -&gt; {
            log.info(<span class="hljs-string">"异步日志: {}"</span>, message);
        });
    }
    
    <span class="hljs-comment">// 日志采样（降低日志量）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">logCounter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SAMPLE_RATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>; <span class="hljs-comment">// 每100条记录1条</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logWithSampling</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">if</span> (logCounter.incrementAndGet() % SAMPLE_RATE == <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"采样日志: {}"</span>, message);
        }
    }
}

<span class="hljs-comment">// ELK日志收集配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElkLoggingConfig</span> {
    
    <span class="hljs-comment">// Logstash配置</span>
    <span class="hljs-comment">/*
    &lt;appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender"&gt;
        &lt;destination&gt;logstash-server:5000&lt;/destination&gt;
        &lt;encoder class="net.logstash.logback.encoder.LogstashEncoder"&gt;
            &lt;customFields&gt;{"application":"order-service"}&lt;/customFields&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    */</span>
}
</code></pre>
<h3 data-id="heading-8">2.3 指标监控</h3>
<p><strong>Prometheus指标监控：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Prometheus配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrometheusConfig</span> {
    
    <span class="hljs-comment">// 自定义指标</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Slf4j</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessMetrics</span> {
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter orderCounter;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer orderProcessingTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Gauge activeOrders;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Summary orderAmount;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessMetrics</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> {
            <span class="hljs-built_in">this</span>.orderCounter = Counter.builder(<span class="hljs-string">"orders.total"</span>)
                .description(<span class="hljs-string">"订单总数"</span>)
                .tag(<span class="hljs-string">"type"</span>, <span class="hljs-string">"business"</span>)
                .register(meterRegistry);
            
            <span class="hljs-built_in">this</span>.orderProcessingTime = Timer.builder(<span class="hljs-string">"orders.processing.time"</span>)
                .description(<span class="hljs-string">"订单处理时间"</span>)
                .register(meterRegistry);
            
            <span class="hljs-built_in">this</span>.activeOrders = Gauge.builder(<span class="hljs-string">"orders.active"</span>, 
                () -&gt; getActiveOrderCount())
                .description(<span class="hljs-string">"活跃订单数"</span>)
                .register(meterRegistry);
            
            <span class="hljs-built_in">this</span>.orderAmount = Summary.builder(<span class="hljs-string">"orders.amount"</span>)
                .description(<span class="hljs-string">"订单金额"</span>)
                .register(meterRegistry);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOrder</span><span class="hljs-params">(String orderType)</span> {
            orderCounter.increment(
                Tags.of(<span class="hljs-string">"order_type"</span>, orderType)
            );
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordProcessingTime</span><span class="hljs-params">(Duration duration)</span> {
            orderProcessingTime.record(duration);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOrderAmount</span><span class="hljs-params">(BigDecimal amount)</span> {
            orderAmount.record(amount.doubleValue());
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getActiveOrderCount</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 获取活跃订单数</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">50.0</span>;
        }
    }
}

<span class="hljs-comment">// Grafana仪表板配置</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/metrics")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MeterRegistry meterRegistry;
    
    <span class="hljs-meta">@GetMapping("/custom")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getCustomMetrics</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; metrics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 获取计数器值</span>
        <span class="hljs-type">Counter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> meterRegistry.find(<span class="hljs-string">"orders.total"</span>).counter();
        <span class="hljs-keyword">if</span> (counter != <span class="hljs-literal">null</span>) {
            metrics.put(<span class="hljs-string">"ordersTotal"</span>, counter.count());
        }
        
        <span class="hljs-comment">// 获取计时器统计</span>
        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> meterRegistry.find(<span class="hljs-string">"orders.processing.time"</span>).timer();
        <span class="hljs-keyword">if</span> (timer != <span class="hljs-literal">null</span>) {
            metrics.put(<span class="hljs-string">"avgProcessingTime"</span>, timer.mean(TimeUnit.MILLISECONDS));
            metrics.put(<span class="hljs-string">"maxProcessingTime"</span>, timer.max(TimeUnit.MILLISECONDS));
        }
        
        <span class="hljs-keyword">return</span> metrics;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-9">3. 安全与认证</h2>
<h3 data-id="heading-10">3.1 JWT认证</h3>
<p><strong>JWT工具类：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JWT工具类</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtil</span> {
    
    <span class="hljs-meta">@Value("${jwt.secret:mySecretKey}")</span>
    <span class="hljs-keyword">private</span> String secret;
    
    <span class="hljs-meta">@Value("${jwt.expiration:86400000}")</span>
    <span class="hljs-keyword">private</span> Long expiration;
    
    <span class="hljs-comment">// 生成Token</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(UserDetails userDetails)</span> {
        Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        claims.put(<span class="hljs-string">"sub"</span>, userDetails.getUsername());
        claims.put(<span class="hljs-string">"roles"</span>, userDetails.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList()));
        claims.put(<span class="hljs-string">"iat"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        
        <span class="hljs-keyword">return</span> createToken(claims, userDetails.getUsername());
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">(Map&lt;String, Object&gt; claims, String subject)</span> {
        <span class="hljs-keyword">return</span> Jwts.builder()
            .setClaims(claims)
            .setSubject(subject)
            .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())
            .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + expiration))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    <span class="hljs-comment">// 验证Token</span>
    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">validateToken</span><span class="hljs-params">(String token, UserDetails userDetails)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getUsernameFromToken(token);
        <span class="hljs-keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));
    }
    
    <span class="hljs-comment">// 从Token获取用户名</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsernameFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getSubject);
    }
    
    <span class="hljs-comment">// 从Token获取过期时间</span>
    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getExpirationDateFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getExpiration);
    }
    
    <span class="hljs-comment">// 从Token获取指定Claim</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getClaimFromToken</span><span class="hljs-params">(String token, Function&lt;Claims, T&gt; claimsResolver)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> getAllClaimsFromToken(token);
        <span class="hljs-keyword">return</span> claimsResolver.apply(claims);
    }
    
    <span class="hljs-comment">// 从Token获取所有Claims</span>
    <span class="hljs-keyword">private</span> Claims <span class="hljs-title function_">getAllClaimsFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
    }
    
    <span class="hljs-comment">// 检查Token是否过期</span>
    <span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">isTokenExpired</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Date</span> <span class="hljs-variable">expiration</span> <span class="hljs-operator">=</span> getExpirationDateFromToken(token);
        <span class="hljs-keyword">return</span> expiration.before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }
    
    <span class="hljs-comment">// 刷新Token</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">refreshToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> getAllClaimsFromToken(token);
        claims.setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        <span class="hljs-keyword">return</span> createToken(claims, claims.getSubject());
    }
}

<span class="hljs-comment">// JWT认证过滤器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtUtil jwtUtil;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, 
                                   HttpServletResponse response, 
                                   FilterChain filterChain)</span> 
            <span class="hljs-keyword">throws</span> ServletException, IOException {
        
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getTokenFromRequest(request);
        
        <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span> &amp;&amp; jwtUtil.validateToken(token, 
            userDetailsService.loadUserByUsername(
                jwtUtil.getUsernameFromToken(token)))) {
            
            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> jwtUtil.getUsernameFromToken(token);
            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> userDetailsService.loadUserByUsername(username);
            
            <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(
                    userDetails, <span class="hljs-literal">null</span>, userDetails.getAuthorities());
            authentication.setDetails(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));
            
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        
        filterChain.doFilter(request, response);
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getTokenFromRequest</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">bearerToken</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (bearerToken != <span class="hljs-literal">null</span> &amp;&amp; bearerToken.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-keyword">return</span> bearerToken.substring(<span class="hljs-number">7</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">3.2 OAuth2认证</h3>
<p><strong>OAuth2配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OAuth2资源服务器配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableResourceServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeRequests()
            .antMatchers(<span class="hljs-string">"/api/public/**"</span>).permitAll()
            .antMatchers(<span class="hljs-string">"/api/admin/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)
            .antMatchers(<span class="hljs-string">"/api/user/**"</span>).hasAnyRole(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ADMIN"</span>)
            .anyRequest().authenticated()
            .and()
            .oauth2ResourceServer()
            .jwt();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JwtDecoder <span class="hljs-title function_">jwtDecoder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> NimbusJwtDecoder.withJwkSetUri(<span class="hljs-string">"http://auth-server/.well-known/jwks.json"</span>)
            .build();
    }
}

<span class="hljs-comment">// OAuth2授权服务器配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAuthorizationServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2AuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception {
        clients.jdbc(dataSource);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> {
        endpoints
            .authenticationManager(authenticationManager)
            .tokenStore(tokenStore())
            .accessTokenConverter(accessTokenConverter());
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTokenStore</span>(dataSource);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">accessTokenConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();
        converter.setSigningKey(<span class="hljs-string">"mySecretKey"</span>);
        <span class="hljs-keyword">return</span> converter;
    }
}
</code></pre>
<h3 data-id="heading-12">3.3 Spring Security配置</h3>
<p><strong>Spring Security配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring Security配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtAuthenticationFilter jwtAuthenticationFilter;
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userDetailsService)
            .passwordEncoder(passwordEncoder());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeRequests()
            .antMatchers(<span class="hljs-string">"/api/auth/**"</span>).permitAll()
            .antMatchers(<span class="hljs-string">"/api/public/**"</span>).permitAll()
            .antMatchers(<span class="hljs-string">"/api/admin/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)
            .antMatchers(<span class="hljs-string">"/api/user/**"</span>).hasAnyRole(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ADMIN"</span>)
            .anyRequest().authenticated()
            .and()
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();
    }
}

<span class="hljs-comment">// 用户详情服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findByUsername(username)
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">"用户不存在: "</span> + username));
        
        List&lt;GrantedAuthority&gt; authorities = user.getRoles().stream()
            .map(role -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(<span class="hljs-string">"ROLE_"</span> + role.getName()))
            .collect(Collectors.toList());
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            authorities
        );
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">4. 测试与质量</h2>
<h3 data-id="heading-14">4.1 单元测试</h3>
<p><strong>JUnit 5单元测试：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务层单元测试</span>
<span class="hljs-meta">@ExtendWith(MockitoExtension.class)</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceTest</span> {
    
    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;
    
    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-meta">@InjectMocks</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName("创建订单成功")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Given</span>
        <span class="hljs-type">CreateOrderRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateOrderRequest</span>();
        request.setUserId(<span class="hljs-number">1L</span>);
        request.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));
        
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setId(<span class="hljs-number">1L</span>);
        user.setName(<span class="hljs-string">"测试用户"</span>);
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setId(<span class="hljs-number">1L</span>);
        order.setUserId(<span class="hljs-number">1L</span>);
        order.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));
        
        when(userRepository.findById(<span class="hljs-number">1L</span>)).thenReturn(Optional.of(user));
        when(orderRepository.save(any(Order.class))).thenReturn(order);
        
        <span class="hljs-comment">// When</span>
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder(request);
        
        <span class="hljs-comment">// Then</span>
        assertNotNull(result);
        assertEquals(<span class="hljs-number">1L</span>, result.getId());
        assertEquals(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>), result.getAmount());
        verify(orderRepository, times(<span class="hljs-number">1</span>)).save(any(Order.class));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName("用户不存在时创建订单失败")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderUserNotFound</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Given</span>
        <span class="hljs-type">CreateOrderRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateOrderRequest</span>();
        request.setUserId(<span class="hljs-number">999L</span>);
        
        when(userRepository.findById(<span class="hljs-number">999L</span>)).thenReturn(Optional.empty());
        
        <span class="hljs-comment">// When &amp; Then</span>
        assertThrows(UserNotFoundException.class, () -&gt; {
            orderService.createOrder(request);
        });
    }
    
    <span class="hljs-meta">@ParameterizedTest</span>
    <span class="hljs-meta">@ValueSource(doubles = {100.0, 200.0, 500.0})</span>
    <span class="hljs-meta">@DisplayName("不同金额的订单创建")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderWithDifferentAmounts</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-comment">// Given</span>
        <span class="hljs-type">CreateOrderRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateOrderRequest</span>();
        request.setUserId(<span class="hljs-number">1L</span>);
        request.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(amount)));
        
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setId(<span class="hljs-number">1L</span>);
        
        when(userRepository.findById(<span class="hljs-number">1L</span>)).thenReturn(Optional.of(user));
        when(orderRepository.save(any(Order.class))).thenAnswer(invocation -&gt; {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> invocation.getArgument(<span class="hljs-number">0</span>);
            order.setId(<span class="hljs-number">1L</span>);
            <span class="hljs-keyword">return</span> order;
        });
        
        <span class="hljs-comment">// When</span>
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder(request);
        
        <span class="hljs-comment">// Then</span>
        assertNotNull(result);
        assertEquals(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(amount)), result.getAmount());
    }
}
</code></pre>
<h3 data-id="heading-15">4.2 集成测试</h3>
<p><strong>Spring Boot集成测试：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 集成测试</span>
<span class="hljs-meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span>
<span class="hljs-meta">@AutoConfigureMockMvc</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderControllerIntegrationTest</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName("创建订单集成测试")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderIntegration</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// Given</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setUsername(<span class="hljs-string">"testuser"</span>);
        user.setPassword(<span class="hljs-string">"password"</span>);
        user = userRepository.save(user);
        
        <span class="hljs-type">CreateOrderRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateOrderRequest</span>();
        request.setUserId(user.getId());
        request.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));
        
        <span class="hljs-comment">// When</span>
        <span class="hljs-type">MvcResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mockMvc.perform(post(<span class="hljs-string">"/api/orders"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isOk())
            .andReturn();
        
        <span class="hljs-comment">// Then</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">responseContent</span> <span class="hljs-operator">=</span> result.getResponse().getContentAsString();
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> objectMapper.readValue(responseContent, OrderDTO.class);
        
        assertNotNull(orderDTO);
        assertEquals(user.getId(), orderDTO.getUserId());
        assertEquals(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>), orderDTO.getAmount());
        
        <span class="hljs-comment">// 验证数据库</span>
        Optional&lt;Order&gt; savedOrder = orderRepository.findById(orderDTO.getId());
        assertTrue(savedOrder.isPresent());
    }
}
</code></pre>
<h3 data-id="heading-16">4.3 性能测试</h3>
<p><strong>JMeter性能测试：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能测试工具类</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTestService</span> {
    
    <span class="hljs-comment">// 压力测试</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stressTest</span><span class="hljs-params">(String url, <span class="hljs-type">int</span> threads, <span class="hljs-type">int</span> iterations)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threads);
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(threads);
        <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">failCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        List&lt;Long&gt; responseTimes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threads; i++) {
            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; iterations; j++) {
                        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
                        
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 发送HTTP请求</span>
                            <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
                            ResponseEntity&lt;String&gt; response = restTemplate.getForEntity(url, String.class);
                            
                            <span class="hljs-keyword">if</span> (response.getStatusCode().is2xxSuccessful()) {
                                successCount.incrementAndGet();
                            } <span class="hljs-keyword">else</span> {
                                failCount.incrementAndGet();
                            }
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            failCount.incrementAndGet();
                        }
                        
                        <span class="hljs-type">long</span> <span class="hljs-variable">responseTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
                        responseTimes.add(responseTime);
                    }
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();
                }
            });
        }
        
        <span class="hljs-keyword">try</span> {
            latch.await();
            executor.shutdown();
            
            <span class="hljs-comment">// 统计结果</span>
            log.info(<span class="hljs-string">"成功请求数: {}"</span>, successCount.get());
            log.info(<span class="hljs-string">"失败请求数: {}"</span>, failCount.get());
            log.info(<span class="hljs-string">"平均响应时间: {} ms"</span>, 
                responseTimes.stream().mapToLong(Long::longValue).average().orElse(<span class="hljs-number">0</span>));
            log.info(<span class="hljs-string">"最大响应时间: {} ms"</span>, 
                responseTimes.stream().mapToLong(Long::longValue).max().orElse(<span class="hljs-number">0</span>));
            log.info(<span class="hljs-string">"最小响应时间: {} ms"</span>, 
                responseTimes.stream().mapToLong(Long::longValue).min().orElse(<span class="hljs-number">0</span>));
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">5. 最佳实践</h2>
<h3 data-id="heading-18">5.1 代码规范</h3>
<p><strong>代码规范检查：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用Checkstyle、PMD、SpotBugs等工具</span>
<span class="hljs-comment">// 代码规范示例</span>

<span class="hljs-comment">// 1. 命名规范</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  <span class="hljs-comment">// 类名使用大驼峰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRY_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;  <span class="hljs-comment">// 常量使用大写下划线</span>
    
    <span class="hljs-keyword">private</span> Long orderId;  <span class="hljs-comment">// 变量名使用小驼峰</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {  <span class="hljs-comment">// 方法名使用小驼峰</span>
        <span class="hljs-comment">// 方法实现</span>
    }
}

<span class="hljs-comment">// 2. 注释规范</span>
<span class="hljs-comment">/**
 * 订单服务类
 * 
 * <span class="hljs-doctag">@author</span> YourName
 * <span class="hljs-doctag">@version</span> 1.0
 * <span class="hljs-doctag">@since</span> 2024-01-01
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-comment">/**
     * 创建订单
     * 
     * <span class="hljs-doctag">@param</span> request 创建订单请求
     * <span class="hljs-doctag">@return</span> 订单DTO
     * <span class="hljs-doctag">@throws</span> UserNotFoundException 用户不存在异常
     */</span>
    <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-comment">// 3. 异常处理规范</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            <span class="hljs-keyword">return</span> processOrder(request);
        } <span class="hljs-keyword">catch</span> (UserNotFoundException e) {
            log.error(<span class="hljs-string">"用户不存在: {}"</span>, request.getUserId(), e);
            <span class="hljs-keyword">throw</span> e;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"创建订单失败"</span>, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreationException</span>(<span class="hljs-string">"创建订单失败"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-19">5.2 设计模式应用</h3>
<p><strong>常用设计模式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 策略模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(BigDecimal amount)</span>;
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(BigDecimal amount)</span> {
        <span class="hljs-comment">// 支付宝支付逻辑</span>
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatPayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(BigDecimal amount)</span> {
        <span class="hljs-comment">// 微信支付逻辑</span>
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, PaymentStrategy&gt; strategies;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PaymentService</span><span class="hljs-params">(List&lt;PaymentStrategy&gt; strategyList)</span> {
        <span class="hljs-built_in">this</span>.strategies = strategyList.stream()
            .collect(Collectors.toMap(
                s -&gt; s.getClass().getSimpleName().replace(<span class="hljs-string">"Strategy"</span>, <span class="hljs-string">""</span>).toLowerCase(),
                Function.identity()
            ));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(String paymentType, BigDecimal amount)</span> {
        <span class="hljs-type">PaymentStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> strategies.get(paymentType.toLowerCase());
        <span class="hljs-keyword">if</span> (strategy == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的支付方式: "</span> + paymentType);
        }
        strategy.pay(amount);
    }
}

<span class="hljs-comment">// 观察者模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderObserver</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOrderCreated</span><span class="hljs-params">(Order order)</span>;
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailNotificationObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOrderCreated</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 发送邮件通知</span>
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOrderCreated</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 更新库存</span>
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;OrderObserver&gt; observers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(OrderObserver observer)</span> {
        observers.add(observer);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-comment">// 通知观察者</span>
        observers.forEach(observer -&gt; observer.onOrderCreated(order));
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebGPU 开发者福音！在 VS Code 中实时预览你的WGSL着色器作品]]></title>    <link>https://juejin.cn/post/7594000527509258281</link>    <guid>https://juejin.cn/post/7594000527509258281</guid>    <pubDate>2026-01-12T06:55:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594000527509258281" data-draft-id="7593692797766418474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebGPU 开发者福音！在 VS Code 中实时预览你的WGSL着色器作品"/> <meta itemprop="keywords" content="前端,GPU,图形学"/> <meta itemprop="datePublished" content="2026-01-12T06:55:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Taiyuuki"/> <meta itemprop="url" content="https://juejin.cn/user/2986701663249047"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebGPU 开发者福音！在 VS Code 中实时预览你的WGSL着色器作品
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2986701663249047/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Taiyuuki
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T06:55:51.000Z" title="Mon Jan 12 2026 06:55:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">WebGPU 开发者福音！在 VS Code 中实时预览你的WGSL着色器作品</h2>
<h3 data-id="heading-1">为什么要做这个插件？</h3>
<p>WebGPU 是下一代 Web 图形标准，而 WGSL（WebGPU Shading Language）是其着色器语言。但在开发 WGSL 时，由于WebGPU API的复杂性，哪怕是一个最简单的着色器效果，也需要写大量的js代码才能在浏览器中看到效果，而着色器的热更新也非常麻烦，往往得手动刷新浏览器才能看到修改后的效果，另外调试起来也很不友好，着色器错误往往不会直接报错，而是在控制台显示警告，开发体验不好。</p>
<p>而 <strong>WGSL Preview</strong> 就是为了解决这些问题而诞生的。</p>
<h3 data-id="heading-2">核心特性</h3>
<h4 data-id="heading-3">1. 实时预览 &amp; 热重载</h4>
<p>在编辑器右侧直接显示渲染结果，修改代码后自动刷新，无需手动刷新浏览器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3412df0dbed142ada003e55ef745d81a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGFpeXV1a2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768805750&amp;x-signature=BA5sDnXxy%2Fy2HhIabwXy16Nfw7U%3D" alt="vscide-wgsl-preview.gif" loading="lazy"/></p>
<h4 data-id="heading-4">2. 内置 Uniforms</h4>
<p>插件内置了 6 个常用的 uniform 变量，开箱即用：</p>








































<table><thead><tr><th>变量名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>time</code></td><td>f32</td><td>时间</td></tr><tr><td><code>resolution</code></td><td>vec2</td><td>画布分辨率</td></tr><tr><td><code>mouse</code></td><td>vec2</td><td>鼠标位置</td></tr><tr><td><code>frame</code></td><td>f32</td><td>帧计数器</td></tr><tr><td><code>date</code></td><td>vec4</td><td>当前日期时间</td></tr><tr><td><code>keyboard</code></td><td>vec4</td><td>方向键状态</td></tr></tbody></table>
<h4 data-id="heading-5">3. 纹理 &amp; 采样器支持</h4>
<p>轻松加载 PNG/JPEG/WebP 纹理，支持自定义采样器参数。</p>
<h4 data-id="heading-6">4. 自定义 Uniforms</h4>
<p>支持完整的 WGSL uniform 类型：标量（i32/f32等等）、向量（vec2/vec3/vec4）、矩阵（mat2x2/mat3x3/mat4x4），<strong>自动处理 std140 布局和对齐</strong>。</p>
<h4 data-id="heading-7">5.实时错误信息显示</h4>
<p>着色器有错误时，会直接将详细的错误信息显示在界面上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2b968e4848749b5b3d902e7f5739690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGFpeXV1a2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768805750&amp;x-signature=7BWfHADFIuBn7nwrSWGkvKUqIAc%3D" alt="ScreenShot_2026-01-12_143929_594.png" loading="lazy"/></p>
<h4 data-id="heading-8">6. 性能监控</h4>
<p>可选的 FPS 和渲染时间显示，帮你优化 shader 性能。</p>
<h3 data-id="heading-9">技术亮点</h3>
<h4 data-id="heading-10">std140 布局自动处理</h4>
<p>WGSL 的 uniform buffer 需要遵循 std140 标准布局，手动计算偏移和对齐非常容易出错。插件自动处理：</p>
<ul>
<li><strong>标量对齐</strong>：f32/i32/u32 对齐到 4 字节</li>
<li><strong>向量对齐</strong>：vec2 对齐到 8 字节，vec3/vec4 对齐到 16 字节</li>
<li><strong>矩阵转置</strong>：自动将行优先矩阵转为列优先存储</li>
<li><strong>整数类型</strong>：正确处理整数到浮点数的位模式转换</li>
</ul>
<h4 data-id="heading-11">响应式设计</h4>
<ul>
<li>修改 shader 代码 → 自动重渲染</li>
<li>修改配置文件 → 立即生效</li>
<li>切换文件 → 自动切换预览</li>
</ul>
<h3 data-id="heading-12">🚀 快速上手</h3>
<h4 data-id="heading-13">安装</h4>
<p>在 VS Code 扩展市场搜索 <strong>"WGSL Preview"</strong> 或使用命令：</p>
<pre><code class="hljs language-bash" lang="bash">code --install-extension taiyuuki.vscode-wgsl-renderer
</code></pre>
<h4 data-id="heading-14">基础示例</h4>
<p>创建一个 <code>shader.wgsl</code> 文件：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">struct VSOut {
    @builtin(position) pos: vec4&lt;f32&gt;,
    @location(0) uv: vec2&lt;f32&gt;,
}

@vertex
fn vs_main(@location(0) p: vec3&lt;f32&gt;) -&gt; VSOut {
    var o: VSOut;
    o.pos = vec4&lt;f32&gt;(p, 1.0);
    o.uv = p.xy * 0.5 + vec2&lt;f32&gt;(0.5, 0.5);
    o.uv.y = 1.0 - o.uv.y;
    return o;
}

@fragment
fn fs_main(@location(0) uv: vec2&lt;f32&gt;) -&gt; @location(0) vec4&lt;f32&gt; {
    // 创建一个渐变效果
    let color = vec3&lt;f32&gt;(uv, 0.5);
    return vec4&lt;f32&gt;(color, 1.0);
}
</code></pre>
<p>按 <code>Ctrl+Shift+P</code>，输入 <code>WGSL: Preview</code>，即可看到实时渲染效果！</p>
<h4 data-id="heading-15">使用内置 Uniforms</h4>
<p>创建与着色器文件同名的配置文件 <code>shader.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uniforms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"time"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"f32"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"builtin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resolution"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vec2&lt;f32&gt;"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"builtin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mouse"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vec2&lt;f32&gt;"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"builtin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bindings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uniforms"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uniform"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"binding"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Shader 代码：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">struct Uniforms {
    time: f32,
    resolution: vec2&lt;f32&gt;,
    mouse: vec2&lt;f32&gt;,
}

@group(0) @binding(0) var&lt;uniform&gt; u: Uniforms;

@fragment
fn fs_main(@location(0) uv: vec2&lt;f32&gt;) -&gt; @location(0) vec4&lt;f32&gt; {
    // 随时间变化的颜色
    let r = 0.5 + 0.5 * sin(u.time);
    let g = 0.5 + 0.5 * cos(u.time * 0.7);

    // 鼠标交互
    let dist = distance(uv * u.resolution, u.mouse);
    let glow = 1.0 - smoothstep(0.0, 100.0, dist);

    return vec4&lt;f32&gt;(r + glow, g + glow, 0.5, 1.0);
}
</code></pre>
<h3 data-id="heading-16">📦 完整配置示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"canvas"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"width"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">800</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"height"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">600</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"showStats"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"entryPoints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vertex"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vs_main"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fragment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fs_main"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"uniforms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"time"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"f32"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"builtin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resolution"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vec2&lt;f32&gt;"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"builtin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myColor"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vec3&lt;f32&gt;"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myMatrix"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mat4x4&lt;f32&gt;"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"textures"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myTexture"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./image.png"</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bindings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uniforms"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uniform"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"binding"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mySampler"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampler"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"binding"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myTexture"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"texture"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"binding"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">功能展望</h3>
<p>此插件的实现主要得益于我自己写的一个多通道WGSL渲染器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftaiyuuki%2Fwgsl-renderer" target="_blank" title="https://github.com/taiyuuki/wgsl-renderer" ref="nofollow noopener noreferrer">taiyuuki/wgsl-renderer</a> ，但VS Code插件目前还只支持单通道渲染，如果有需求欢迎提交反馈，后续我会将对多通道的支持也覆盖上。</p>
<h3 data-id="heading-18">相关链接</h3>
<ul>
<li><strong>VS Code Marketplace</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dtaiyuuki.vscode-wgsl-renderer" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=taiyuuki.vscode-wgsl-renderer" ref="nofollow noopener noreferrer">WGSL Preview</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftaiyuuki%2Fvscode-wgsl-renderer" target="_blank" title="https://github.com/taiyuuki/vscode-wgsl-renderer" ref="nofollow noopener noreferrer">vscode-wgsl-renderer</a></li>
<li><strong>示例代码</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftaiyuuki%2Fvscode-wgsl-renderer%2Ftree%2Fmain%2Fexample" target="_blank" title="https://github.com/taiyuuki/vscode-wgsl-renderer/tree/main/example" ref="nofollow noopener noreferrer">examples 目录</a></li>
</ul>
<h3 data-id="heading-19">反馈与建议</h3>
<p>如果你在使用过程中遇到任何问题，或有功能建议，欢迎：</p>
<ul>
<li>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftaiyuuki%2Fvscode-renderer%2Fissues" target="_blank" title="https://github.com/taiyuuki/vscode-renderer/issues" ref="nofollow noopener noreferrer">GitHub Issues</a> 提问</li>
<li>在此留言</li>
</ul>
<p><strong>Star</strong> ⭐ 支持一下，让更多 WGSL 开发者受益！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[是的，微信小程序的 show-menu-by-longpress 真的会让你无语]]></title>    <link>https://juejin.cn/post/7594482829754630190</link>    <guid>https://juejin.cn/post/7594482829754630190</guid>    <pubDate>2026-01-13T06:57:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594482829754630190" data-draft-id="7594616268781125659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="是的，微信小程序的 show-menu-by-longpress 真的会让你无语"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T06:57:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知了清语"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498942055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            是的，微信小程序的 show-menu-by-longpress 真的会让你无语
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498942055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知了清语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:57:30.000Z" title="Tue Jan 13 2026 06:57:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fimage.html%23%25E6%2594%25AF%25E6%258C%2581%25E9%2595%25BF%25E6%258C%2589%25E8%25AF%2586%25E5%2588%25AB%25E7%259A%2584%25E7%25A0%2581" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/component/image.html#%E6%94%AF%E6%8C%81%E9%95%BF%E6%8C%89%E8%AF%86%E5%88%AB%E7%9A%84%E7%A0%81" ref="nofollow noopener noreferrer">媒体组件 / image</a>  说给一个图片添加这个属性， 可以实现长按识别二维码的效果</p>
<p>在开发者工具是可以的，也有效果， 发体验版不行。 也没有什么报错信息。 非常的坑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2d8a809aafd4ddabc182315c858f60b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l5LqG5riF6K-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892249&amp;x-signature=z8RJlgt9ZcldkM6cZQsmrakARAU%3D" alt="fd67f83d3676a40e9b78c1007b8bff14_compress.jpg" loading="lazy"/></p>
<p>比如这样的 普通的二维码， 是第三方的 随便找的一个地址</p>
<p>用小程序原生开发  ， 发现就走测试流程不太行</p>
<p>最后发现这东西得发布到生产环境才可以。 文档也没有说这一点。</p>
<pre><code class="hljs language-arduino" lang="arduino">&lt;image show-menu-by-longpress=<span class="hljs-string">"{{true}}"</span> src=<span class="hljs-string">'https://xxxx'</span>&gt;&lt;/image&gt;
</code></pre>
<p>咱就是说， 众多开发者支持你， 好歹能给大家挖一些坑呢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的昆虫智能识别工程实践 [目标检测完整源码]]]></title>    <link>https://juejin.cn/post/7594514040917147675</link>    <guid>https://juejin.cn/post/7594514040917147675</guid>    <pubDate>2026-01-13T06:59:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594514040917147675" data-draft-id="7594616268781191195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的昆虫智能识别工程实践 [目标检测完整源码]"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T06:59:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的昆虫智能识别工程实践 [目标检测完整源码]
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:59:38.000Z" title="Tue Jan 13 2026 06:59:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的昆虫智能识别工程实践 [目标检测完整源码]</h2>
<h3 data-id="heading-1">引言：为什么“虫子识别”值得用深度学习重做一遍？</h3>
<p>在农业生产、林业保护以及生态监测中，<strong>昆虫种类识别</strong>一直是一项高度依赖经验的工作。传统方法通常依赖人工观察或规则特征比对，不仅效率低，而且在复杂光照、虫体姿态变化、多虫同框等情况下，准确率难以保证。</p>
<p>随着计算机视觉技术的发展，目标检测模型已经能够在复杂环境中稳定识别多类别目标。其中，YOLO 系列模型因其<strong>实时性强、部署成本低</strong>，成为实际场景中最具性价比的选择之一。</p>
<p>本文将从工程落地角度，介绍一个<strong>基于 YOLOv8 的昆虫种类识别系统</strong>，覆盖数据准备、模型训练、推理流程以及可视化应用构建，完整展示如何将一个检测模型打造成“真正可用”的 AI 系统。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f2d6927f5774ccca9212fa80f0c15ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=asVefj1%2FKW6VXGvezWFZWz%2BFNiM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方观看：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1sGuRzKEwZ%2F" target="_blank" title="https://www.bilibili.com/video/BV1sGuRzKEwZ/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1sG…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/960b4301757540fb813c0c21b65cf5b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=qV%2FF4GNOQ9AXRLRsuj%2BWX8mlI4g%3D" alt="在这里插入图片描述" loading="lazy"/>
包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<hr/>
<h3 data-id="heading-3">一、系统整体设计：不只是一个模型</h3>
<p>与单纯的算法 Demo 不同，本项目的目标是构建一套<strong>开箱即用的昆虫识别系统</strong>。整体架构分为四个层级：</p>
<ol>
<li><strong>数据层</strong>：多类别昆虫图像数据集与标准化标注</li>
<li><strong>模型层</strong>：基于 YOLOv8 的目标检测网络</li>
<li><strong>推理层</strong>：统一的模型加载与预测接口</li>
<li><strong>应用层</strong>：PyQt5 图形化桌面系统</li>
</ol>
<p>这种分层设计的优势在于：</p>
<ul>
<li>模型可随时替换或重新训练</li>
<li>推理逻辑与界面解耦</li>
<li>便于后续迁移到边缘设备或 Web 服务</li>
</ul>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/373303f633f544bea2af30cbf9c288cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=V%2FWlGTqGfQwr53FyC9ekYJXISrM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6cfbb04fc194aa0994753192afdfabe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=A7V8Tyctcp7oM%2BPnjPIPsaKKNTE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">二、为什么选择 YOLOv8 进行昆虫识别？</h3>
<h4 data-id="heading-5">2.1 昆虫识别的技术挑战</h4>
<p>与常规物体检测相比，昆虫识别具有以下特点：</p>
<ul>
<li>目标尺寸小、细节丰富</li>
<li>类别间外观差异微弱</li>
<li>背景复杂，容易产生误检</li>
<li>多目标同时出现的情况频繁</li>
</ul>
<p>这对模型的定位能力和特征表达能力提出了更高要求。</p>
<h4 data-id="heading-6">2.2 YOLOv8 的工程优势</h4>
<p>YOLOv8 在设计上针对上述问题具备明显优势：</p>
<ul>
<li><strong>Anchor-Free 机制</strong>：减少人为参数依赖</li>
<li><strong>解耦检测头</strong>：提升分类与回归稳定性</li>
<li><strong>Task-Aligned Assigner</strong>：对难样本更友好</li>
<li><strong>轻量化模型结构</strong>：适合实时检测与桌面端运行</li>
</ul>
<p>在实际测试中，YOLOv8 在虫体遮挡、尺度变化较大的场景下仍能保持稳定检测效果。</p>
<hr/>
<h3 data-id="heading-7">三、数据集构建与训练准备</h3>
<h4 data-id="heading-8">3.1 数据组织方式</h4>
<p>项目采用 YOLO 标准数据格式，结构清晰，便于扩展：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train
│   └── <span class="hljs-keyword">val</span>
└── labels/
    ├── train
    └── <span class="hljs-keyword">val</span>
</code></pre>
<p>每张图片对应一个 <code>.txt</code> 标注文件，记录目标类别与归一化后的边框坐标。</p>
<h4 data-id="heading-9">3.2 多类别昆虫标注策略</h4>
<p>在昆虫检测任务中，每一种虫类被视为一个独立检测类别。相比纯分类模型，检测方式具备两个优势：</p>
<ul>
<li>能处理多虫同框场景</li>
<li>可输出精确位置信息，便于后续分析</li>
</ul>
<p>这种设计也为未来的虫害统计、密度分析等任务提供了基础。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4addb004659e441d8733d58e658c7a84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=3VHNX1Ir1%2FiKfMWIOQe2079%2FYnc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">四、模型训练与效果评估</h3>
<h4 data-id="heading-11">4.1 训练流程概述</h4>
<p>模型训练基于 Ultralytics 官方 YOLOv8 接口完成，支持：</p>
<ul>
<li>预训练权重初始化</li>
<li>自定义类别数量</li>
<li>灵活配置训练轮次与 batch size</li>
</ul>
<p>训练过程中会自动生成损失曲线与精度评估指标，方便判断模型收敛状态。</p>
<h4 data-id="heading-12">4.2 如何判断模型是否“可用”？</h4>
<p>在实际工程中，评估模型不仅要看数值，更要结合应用需求：</p>
<ul>
<li><strong>mAP@0.5</strong>：衡量整体检测精度</li>
<li><strong>Loss 曲线趋势</strong>：判断是否过拟合或欠拟合</li>
<li><strong>实际推理效果</strong>：是否存在明显误检或漏检</li>
</ul>
<p>当模型在验证集上表现稳定，并在真实图片中检测效果可靠，即可进入部署阶段。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c92b9ef4c9422eae8ea3f2d3c0097f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=3IQoB%2BvM4xmgxOR64k%2F3NQQge6I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-13">五、推理模块设计：让模型真正跑起来</h3>
<p>训练完成后，模型将被用于实际推理任务。推理模块主要完成以下工作：</p>
<ul>
<li>加载训练好的权重文件</li>
<li>接收图像 / 视频 / 摄像头输入</li>
<li>输出检测框、类别标签与置信度</li>
</ul>
<p>所有推理结果统一封装，供上层 GUI 或其他系统调用。</p>
<hr/>
<h3 data-id="heading-14">六、PyQt5 可视化系统：降低使用门槛</h3>
<h4 data-id="heading-15">6.1 为什么要做图形界面？</h4>
<p>在真实应用场景中，系统使用者往往并非算法工程师。通过 PyQt5 构建桌面端界面，可以实现：</p>
<ul>
<li>无需命令行操作</li>
<li>一键加载模型并检测</li>
<li>实时查看识别结果</li>
</ul>
<p>这使得模型从“技术 Demo”升级为“可交付工具”。</p>
<h4 data-id="heading-16">6.2 支持的检测方式</h4>
<p>当前系统支持多种输入形式：</p>
<ul>
<li>单张图片检测</li>
<li>文件夹批量检测</li>
<li>视频文件逐帧识别</li>
<li>实时摄像头检测</li>
</ul>
<p>所有检测结果均可自动保存，便于后续复核与数据积累。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72a0cbc2547e4dd0837865f5aa1dded3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=DJOiQs%2FcDIiTi0gsEx9EIvwh35I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-17">七、应用场景与扩展方向</h3>
<p>该昆虫识别系统可广泛应用于：</p>
<ul>
<li>农业虫害智能监测</li>
<li>林业生态调查</li>
<li>科研数据自动采集</li>
<li>教学与实验演示</li>
</ul>
<p>在此基础上，还可以进一步扩展：</p>
<ul>
<li>虫类数量统计与趋势分析</li>
<li>边缘设备部署（如 Jetson / RK 平台）</li>
<li>与物联网设备联动，实现自动预警</li>
</ul>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6ce73a89ae04d3996ea871977b86a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768892378&amp;x-signature=IMzg1LW2egbvdH5tZbjLCvigNz0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">总结</h3>
<p>本文从工程实践角度，系统介绍了一套<strong>基于 YOLOv8 的昆虫种类智能识别方案</strong>。该方案不仅涵盖模型训练与推理，还通过 PyQt5 构建了完整的可视化应用，使深度学习模型真正具备“可用性”。</p>
<p>其核心价值体现在三点：</p>
<ol>
<li>将目标检测算法转化为实际可操作系统</li>
<li>显著降低昆虫识别应用的技术门槛</li>
<li>为农业与生态场景提供可扩展的 AI 基础能力</li>
</ol>
<p>本文从工程落地的视角出发，系统介绍了一套基于 YOLOv8 的昆虫种类智能识别解决方案。通过规范化的数据集构建、高效的模型训练与评估流程，以及结合 PyQt5 实现的可视化桌面应用，完整呈现了从算法模型到可用系统的技术闭环。该方案不仅验证了 YOLOv8 在多类别、小目标昆虫识别场景下的准确性与实时性，也显著降低了深度学习技术在农业与生态监测领域的使用门槛，为后续虫害监测、统计分析及边缘设备部署提供了可靠的技术基础。</p>
<p>无论你是希望快速入门 YOLOv8 的学习者，还是计划将视觉技术应用于真实业务场景的开发者，该项目都具备较高的参考价值与实践意义。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 框架设计（五）：契约继承原则]]></title>    <link>https://juejin.cn/post/7594051311647342601</link>    <guid>https://juejin.cn/post/7594051311647342601</guid>    <pubDate>2026-01-12T06:20:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594051311647342601" data-draft-id="7594040270502985766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 框架设计（五）：契约继承原则"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-12T06:20:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 框架设计（五）：契约继承原则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T06:20:33.000Z" title="Mon Jan 12 2026 06:20:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>原名叫《里氏替换原则》, 但感觉这个名字不是很好理解, 便转译成为《契约继承原则》,很多前端同学看到, 第一反应通常是：“这是 Java/C++ 那帮后端搞继承时用的吧？我写 React/Vue 都是组合优于继承，这玩意儿跟我有啥关系？”</p>
<p>这是一个巨大的误区。</p>
<p>如果你曾经遇到过 <strong>“封装了一个组件，别人想加个 <code>style</code> 却死活不生效”</strong> ，或者 <strong>“换了一个数据源 SDK，结果整个页面直接白屏”</strong> ，那么恭喜你，你正好撞在了违反 LSP 的枪口上。</p>
<p>今天我们要聊的就两个字：<strong>契约</strong>。</p>
</blockquote>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b706c9f9eede4c2c8c756fe249fac307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768803632&amp;x-signature=76RC8hhIGLZLi5SZfTUtnBNpP6Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">一、 什么是里氏替换？（别背公式，看人话）</h3>
<p>教科书上说： <em>“若对每个类型 S 的对象 o1，都存在一个类型 T 的对象 o2，使得在所有针对 T 编写的程序 P 中，用 o1 替换 o2 后，程序 P 行为功能不变，则 S 是 T 的子类型。”</em></p>
<p>🤯 <strong>是不是想关网页了？来，翻译成人话：</strong></p>
<p><strong>“老爸能去的地方，儿子必须也能去，而且不能搞破坏。”</strong></p>
<p>在前端语境下，这个“父子关系”不一定是 <code>class extends</code>，更多时候体现为 <strong>接口（Interface）与实现</strong>，或者 <strong>基础组件与业务组件</strong> 的关系。</p>
<p>如果不遵守 LSP，代码就会变成：“看着像个鸭子，走路像个鸭子，但你喂它吃饭时，它突然爆炸了。”</p>
<blockquote>
<p><strong>插播一条星爷语录</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e7d7e405b9423386d6e3accc08c42b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768803632&amp;x-signature=vkzAunbS5guZPpVRJMRPWJnKYDM%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">二、 场景一：UI 组件的“阉割”惨案</h3>
<p>这是前端违反 LSP 最重灾区的现场。</p>
<p>假设你为了统一 UI 风格，基于原生的 <code>&lt;button&gt;</code> 封装了一个 <code>PrimaryButton</code>。</p>
<h4 data-id="heading-2">错误示范：自以为是的封装</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PrimaryButtonProps</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 看起来很清爽，对吧？</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">PrimaryButton</span> = (<span class="hljs-params">{ label, onClick }: PrimaryButtonProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-500 text-white px-4 py-2"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      {label}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>使用者崩溃现场：</strong> 同事 A 拿去用，想给按钮加个 <code>disabled</code> 状态： <code>&lt;PrimaryButton label="提交" disabled={true} /&gt;</code> 👉 <strong>报错</strong>：类型 'PrimaryButtonProps' 上不存在属性 'disabled'。</p>
<p>同事 B 强行用 <code>any</code> 传了进去，结果界面上按钮依然可以点击。 👉 <strong>Bug 原因</strong>：你在内部根本没把 <code>...rest</code> 传给 button。</p>
<p><strong>深度解析：</strong> 这里的 <code>PrimaryButton</code> 既然在语义上是一个“按钮”，它就应该能替换原生 <code>&lt;button&gt;</code> 的绝大部分场景。你为了省事， <strong>“阉割”</strong> 了父类（原生 button）的能力，这就是典型的违反 LSP。</p>
<h4 data-id="heading-3">✅ 正确示范：透传与契约</h4>
<p>符合 LSP 的组件设计，应该遵循“开闭原则”的同时，保证“子类”能完整履行“父类”的职责。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 继承原生属性，确立契约</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PrimaryButtonProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-title class_">ButtonHTMLAttributes</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt; {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 只有 label 是特有的</span>
  <span class="hljs-comment">// 其他的 className, style, onClick, disabled 全部继承</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">PrimaryButton</span> = (<span class="hljs-params">{ label, className, ...rest }: PrimaryButtonProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
      // <span class="hljs-attr">2.</span> <span class="hljs-attr">允许样式叠加</span>（<span class="hljs-attr">而不是覆盖</span>）
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">bg-blue-500</span> <span class="hljs-attr">text-white</span> <span class="hljs-attr">px-4</span> <span class="hljs-attr">py-2</span> ${<span class="hljs-attr">className</span> || ''}`} 
      // <span class="hljs-attr">3.</span> <span class="hljs-attr">核心</span>：<span class="hljs-attr">能力透传</span>
      {<span class="hljs-attr">...rest</span>} 
    &gt;</span>
      {label}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>现在的关系是</strong>：<code>PrimaryButton</code> 是一个更具体的 <code>&lt;button&gt;</code>，它满足了使用 <code>&lt;button&gt;</code> 的所有预期。</p>
<hr/>
<h3 data-id="heading-4">三、 场景二：那些“我也想但我做不到”的接口</h3>
<p>在做架构设计时，我们常使用 DIP（依赖倒置）注入接口。但实现类如果不守规矩，系统一样会崩。</p>
<p>假设我们要设计一个缓存系统：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 定义契约</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ICache</span> </span>{
  <span class="hljs-title function_ invoke__">set</span>(<span class="hljs-attr">key</span>: <span class="hljs-keyword">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-keyword">string</span>): <span class="hljs-keyword">void</span>;
  <span class="hljs-title function_ invoke__">get</span>(<span class="hljs-attr">key</span>: <span class="hljs-keyword">string</span>): <span class="hljs-keyword">string</span> | <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-5">错误示范：抛出异常的子类</h4>
<p>这时候来个需求：我们需要一个“只读缓存”适配器（可能数据源是配置中心，不允许客户端修改）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadOnlyCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ICache</span> {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
  }

  <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">//  违反 LSP！父类承诺能 set，你却抛错？</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"这是只读缓存，别写！"</span>); 
  }
}
</code></pre>
<p><strong>业务代码猝死现场：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">function</span> updateUserData(cache: ICache, <span class="hljs-keyword">user</span>: <span class="hljs-keyword">any</span>) {
  <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 这里的代码以为所有 cache 都能写
  cache.set(<span class="hljs-string">'user'</span>, JSON.stringify(<span class="hljs-keyword">user</span>)); 
}

<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 某天如果不小心注入了 ReadOnlyCache，整个 <span class="hljs-keyword">update</span> 流程直接炸穿
updateUserData(<span class="hljs-keyword">new</span> ReadOnlyCache(), <span class="hljs-keyword">user</span>);
</code></pre>
<h4 data-id="heading-6">深度思考：如何修正？</h4>
<p>违反 LSP 通常意味着<strong>抽象层级出了问题</strong>。如果不具备 <code>set</code> 的能力，它就不应该实现 <code>ICache</code> 接口。</p>
<p>这里需要结合 <strong>接口隔离原则 (ISP)</strong> 进行拆分：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IReadable</span> </span>{
  <span class="hljs-title function_ invoke__">get</span>(<span class="hljs-attr">key</span>: <span class="hljs-keyword">string</span>): <span class="hljs-keyword">string</span> | <span class="hljs-literal">null</span>;
}

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IWritable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IReadable</span> </span>{
  <span class="hljs-title function_ invoke__">set</span>(<span class="hljs-attr">key</span>: <span class="hljs-keyword">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-keyword">string</span>): <span class="hljs-keyword">void</span>;
}

<span class="hljs-comment">// ReadOnlyCache 只实现 IReadable</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadOnlyCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IReadable</span> </span>{ ... }

<span class="hljs-comment">// 业务函数明确要求：我需要可写的缓存</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateUserData</span>(<span class="hljs-params">cache: IWritable, user: any</span>) </span>{ ... }
</code></pre>
<p>这样，TypeScript 静态检查会直接阻止你把 <code>ReadOnlyCache</code> 传给 <code>updateUserData</code>，在编译期就扼杀了 Bug。</p>
<hr/>
<h3 data-id="heading-7">四、 进阶深度：TypeScript 中的协变与逆变</h3>
<p>如果你想在面试中或是架构评审里秀一把深度，<strong>类型系统的 LSP</strong> 是绕不开的。</p>
<p>在 TS 中，LSP 具体表现为：</p>
<ol>
<li><strong>返回类型必须协变（Covariant）</strong> ：子类返回的必须比父类更具体（或相同）。</li>
<li><strong>参数类型必须逆变（Contravariant）</strong> ：子类接收的必须比父类更宽泛（或相同）。</li>
</ol>
<p><strong>听晕了？看个例子：</strong></p>
<p>假设父类定义了一个处理事件的方法： <code>handleEvent(e: MouseEvent): void</code></p>
<p><strong>子类实现 1（安全）：</strong> <code>handleEvent(e: Event): void</code> ✅ <strong>符合 LSP</strong>。父类只能处理鼠标事件，子类说“我也能处理鼠标事件，甚至所有 Event 我都能处理”。<strong>参数更宽泛，这是逆变。</strong></p>
<p><strong>子类实现 2（危险）：</strong> <code>handleEvent(e: ClickEvent): void</code> ❌ <strong>违反 LSP</strong>。父类承诺能处理所有 <code>MouseEvent</code>（比如 <code>MouseMove</code>），但子类说“我只能处理 <code>Click</code>”。如果你传个 <code>MouseMove</code> 给子类，它就处理不了了。</p>
<p><strong>这在 React 的 Props 回调设计中非常重要：</strong> 如果你设计一个组件 <code>List</code>，它的 <code>onItemClick</code> 期望接收 <code>(item: BaseItem) =&gt; void</code>，那么使用者传入的函数最好能处理 <code>BaseItem</code>，而不是只处理 <code>VideoItem</code>，否则可能会在运行时访问不存在的属性。</p>
<hr/>
<h3 data-id="heading-8">五、 总结：架构设计的“信任链”</h3>
<p>里氏替换原则的本质，是<strong>建立信任</strong>。</p>
<ol>
<li><strong>组件信任</strong>：使用者相信你的 <code>CustomInput</code> 真的能像 <code>input</code> 一样工作，支持 <code>value</code> 和 <code>onChange</code>。</li>
<li><strong>对象信任</strong>：业务逻辑相信你注入的 <code>Service</code> 真的实现了接口承诺的所有方法，而不是会在某个方法里偷偷抛出 <code>NotImplementedError</code>。</li>
</ol>
<p><strong>前端架构突围的路上，不要只顾着“复用代码”（继承/封装），更要顾着“遵守契约”。</strong> 一个随时可能“罢工”的子类，比没有子类更可怕。</p>
<p>举例 + 简短文章篇幅,防止内容过于“干巴”</p>
<hr/>
<p><strong>互动环节：</strong> 你在使用第三方组件库（如 Antd/MUI）二次封装时，遇到过最坑的“属性丢失”是什么？欢迎在评论区吐槽！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 框架设计（四）：依赖倒置原则（DIP）]]></title>    <link>https://juejin.cn/post/7593943464053800970</link>    <guid>https://juejin.cn/post/7593943464053800970</guid>    <pubDate>2026-01-12T03:08:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593943464053800970" data-draft-id="7593943464053243914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 框架设计（四）：依赖倒置原则（DIP）"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-12T03:08:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 框架设计（四）：依赖倒置原则（DIP）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T03:08:33.000Z" title="Mon Jan 12 2026 03:08:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>在前端圈子里，我们常说“这个组件太耦合了”或者“这段逻辑改不动”。大多数人习惯性地把锅甩给业务复杂或者前人留下的“屎山”。但如果我们冷静下来复盘，你会发现绝大多数的维护噩梦都指向同一个设计缺陷：<strong>高层逻辑被低层细节给绑架了。</strong></p>
<p>今天我们要聊的<strong>依赖倒置原则（Dependency Inversion Principle, DIP）</strong> ，就是专门用来破解这种“死局”的架构利器。</p>
</blockquote>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/719d029be5994374a49f7d17fe0d4443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768792112&amp;x-signature=%2FKP3opVg1IPRQpgZWVuqLgVN8ZI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">一、 场景：一次痛苦的“技术升级”</h3>
<p>想象一下，你负责一个复杂的 B 端系统。半年前，为了快速上线，你直接在业务 Hooks 里引入了 <code>Axios</code>，并散落到了项目的各个角落：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useUser.ts - 典型的“自上而下”依赖</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useUser</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 业务逻辑直接依赖了具体的实现：axios</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${id}</span>`</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
  };
  <span class="hljs-keyword">return</span> { fetchUser };
};
</code></pre>
<p><strong>噩梦开始了：</strong> 由于公司架构调整，所有请求必须从 <code>Axios</code> 切换到公司自研的 RPC SDK，或者需要统一接入一套极其复杂的签名加密逻辑。</p>
<p>你看着全局搜索出来的 200 多个 <code>axios</code> 引用，陷入了沉思。不仅要改代码，还要面对全量回归测试的风险。这时候你才会意识到：<strong>你的业务逻辑，已经和具体的网络库“殉情”了。</strong></p>
<hr/>
<h3 data-id="heading-1">二、 什么是依赖倒置？（别背定义，看本质）</h3>
<p>传统的开发思维是<strong>自顶向下</strong>的：页面依赖组件，组件依赖工具类。这就像在盖房子时，把电线直接浇筑在混凝土里，想换根线就得拆墙。</p>
<p><strong>依赖倒置原则核心就两句话：</strong></p>
<ol>
<li><strong>高层模块不应依赖低层模块，两者都应依赖抽象。</strong></li>
<li><strong>抽象不应依赖细节，细节应依赖抽象。</strong></li>
</ol>
<p>通俗点说：<strong>谁拥有接口（Interface），谁就是老大。</strong></p>
<p>在架构突围中，我们要把“控制权”翻转过来。高层业务不应该问：“我该怎么去调用 Axios？”而是应该傲娇地声明：“我需要一个能发请求的东西，至于你是用 Axios 还是 Fetch，我不在乎。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d67447c119045b7a19c73024ef95369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768792112&amp;x-signature=3%2B1ll4qC5dRYkHKk6juja5Aan1o%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">三、 代码案例：从“死耦合”到“神解耦”</h3>
<p>让我们用 DIP 的思维重构上面的例子。</p>
<h4 data-id="heading-3">1. 定义抽象（Interface）</h4>
<p>首先，在业务层定义我们要的“形状”，这叫<strong>建立契约</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// domain/http.ts - 这是我们的“主权声明”</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IHttpClient</span> {
  get&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  post&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt;;
}
</code></pre>
<h4 data-id="heading-4">2. 业务层依赖抽象</h4>
<p>现在的业务 Hook 不再关心具体的库。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useUser.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../domain/http'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useUser</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span>, client: IHttpClient</span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 业务只对接口负责</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${id}</span>`</span>);
  };
  <span class="hljs-keyword">return</span> { fetchUser };
};
</code></pre>
<h4 data-id="heading-5">3. 底层实现细节</h4>
<p>具体的库（Axios/Fetch）只是契约的执行者。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// infra/AxiosClient.ts</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../domain/http'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AxiosClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHttpClient</span> {
  <span class="hljs-keyword">async</span> get&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(url);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
  }
  <span class="hljs-comment">// ...实现其他方法</span>
}
</code></pre>
<h4 data-id="heading-6">4. 依赖注入（DI）</h4>
<p>在应用的最顶层（入口处），我们将具体的实现“注入”进去。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// App.tsx</span>
<span class="hljs-type">const</span> httpClient = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AxiosClient</span>(); <span class="hljs-comment">// 后续换成 RPCClient 只需要改这一行</span>
<span class="hljs-type">const</span> { fetchUser } = <span class="hljs-built_in">useUser</span>(<span class="hljs-string">'123'</span>, httpClient);
</code></pre>
<hr/>
<h3 data-id="heading-7">四、 深度思考：前端架构里的 DIP 怎么玩？</h3>
<p>如果你觉得上面的代码只是多写了几行 Interface，那就小看 DIP 了。在复杂的前端工程中，DIP 是实现以下架构的关键：</p>
<h4 data-id="heading-8">1. 跨端架构的统一</h4>
<p>如果你在做一套同时支持 Web 和 小程序的方案。业务逻辑应该是同一套，通过 DIP，你可以为 Web 注入 <code>WebAdapter</code>，为小程序注入 <code>MiniProgramAdapter</code>。</p>
<blockquote>
<p>想象一下，你的团队要开发一个电商应用的“用户模块”，包含登录、获取用户信息、修改收货地址等功能。这个模块需要同时跑在 <strong>Web 端</strong>（用 React/Vue）和 <strong>微信小程序端</strong>。</p>
</blockquote>
<p>业务逻辑（Business Logic）本身其实是一样的：</p>
<p>“用户点击保存 -&gt; 校验表单 -&gt; 发起网络请求保存数据 -&gt; 更新本地状态 -&gt; 提示成功”</p>
<p>但是，底层的技术实现（Infrastructure Layer）却说着完全不同的“方言”：</p>






























<table><thead><tr><th><strong>功能点</strong></th><th><strong>Web 端 "方言"</strong></th><th><strong>小程序端 "方言"</strong></th></tr></thead><tbody><tr><td><strong>网络请求</strong></td><td><code>fetch</code> 或 <code>axios</code></td><td><code>wx.request</code></td></tr><tr><td><strong>本地存储</strong></td><td><code>localStorage.setItem</code></td><td><code>wx.setStorage</code></td></tr><tr><td><strong>路由跳转</strong></td><td><code>history.push</code> / <code>router.push</code></td><td><code>wx.navigateTo</code></td></tr><tr><td><strong>交互反馈</strong></td><td>Antd Message / ElementUI Notification</td><td><code>wx.showToast</code></td></tr></tbody></table>
<h5 data-id="heading-9">错误示范：传统的“自上而下”强耦合</h5>
<p>如果不适用 DIP，为了复用代码，很多团队会写出这种充斥着环境判断的“面条代码”：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// user.service.ts (糟糕的设计)</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 假设通过某种方式注入了环境变量 IS_MINI_PROGRAM</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserProfile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 业务逻辑里夹杂着环境判断</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">IS_MINI_PROGRAM</span>) {
    <span class="hljs-comment">// 小程序方言</span>
    
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">IS_WEB</span>) {
    <span class="hljs-comment">// Web 方言</span>
    
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ...
};
</code></pre>
<p><strong>后果：</strong> 你的业务逻辑层被迫知道了太多它不该知道的“底层细节”。每增加一个端（比如又要支持阿里小程序、字节小程序），这里就要加一个 <code>else if</code>，代码迅速腐化，难以维护。</p>
<h5 data-id="heading-10">正确示范：DIP 主导的跨端统一架构</h5>
<p>用 DIP 的思路，我们要<strong>反客为主</strong>。业务层不再去迁就各个端的方言，而是制定一套“官方语言”（Interface），要求各个端配备“翻译官”（Adapter）来适配这套语言。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// --- Core Business Layer (核心业务层，与平台无关) ---</span>

<span class="hljs-comment">// domain/interfaces/http.interface.ts</span>
<span class="hljs-comment">// 定义网络请求的契约</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IHttpClient</span> {
  get&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, params?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  post&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt;;
}

<span class="hljs-comment">// domain/interfaces/storage.interface.ts</span>
<span class="hljs-comment">// 定义本地存储的契约</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IStorage</span> {
  <span class="hljs-title function_">setItem</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;
  <span class="hljs-title function_">getItem</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt; | <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
}
</code></pre>
<h5 data-id="heading-11">编写纯净的业务逻辑（依赖抽象）</h5>
<p>现在的业务 Service 代码非常干净，它只依赖上面的接口。它不知道自己运行在哪里，它只知道自己有一个能发请求的对象（<code>http</code>）和一个能存东西的对象（<code>storage</code>）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// --- Core Business Layer ---</span>

<span class="hljs-comment">// services/userService.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../domain/interfaces/http.interface'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../domain/interfaces/storage.interface'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">// 通过构造函数注入依赖 (DI)</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> http: IHttpClient,
    <span class="hljs-keyword">private</span> storage: IStorage
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 1. 调用 HTTP 接口</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/login'</span>, { username });
    <span class="hljs-comment">// 2. 调用 Storage 接口</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'user_token'</span>, user.<span class="hljs-property">token</span>);
    <span class="hljs-keyword">return</span> user;
  }
}
</code></pre>
<h5 data-id="heading-12">各端派遣“翻译官”（实现适配器）</h5>
<p>现在轮到基础设施层（Infra Layer）干活了。我们需要为 Web 端和小程序端分别实现上述接口。这就是所谓的 <strong>Adapter（适配器）模式</strong>。</p>
<h6 data-id="heading-13"><strong>Web 端适配器：</strong></h6>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// --- Infra Layer (Web) ---</span>

<span class="hljs-comment">// infra/web/AxiosHttpClient.ts</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../domain/interfaces/http.interface'</span>;

<span class="hljs-comment">// 这就是 Web 端的翻译官，把标准语言翻译成 Axios 方言</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AxiosHttpClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHttpClient</span> {
  <span class="hljs-keyword">async</span> get&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, params?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(url, { params });
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
  }
  <span class="hljs-comment">// ... implement post</span>
}

<span class="hljs-comment">// infra/web/LocalStorageAdapter.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../domain/interfaces/storage.interface'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStorageAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IStorage</span> {
  <span class="hljs-title function_">setItem</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, value);
  }
  <span class="hljs-comment">// ... implement getItem</span>
}
</code></pre>
<h6 data-id="heading-14"><strong>小程序端适配器：</strong></h6>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// --- Infra Layer (Mini Program) ---</span>

<span class="hljs-comment">// infra/mp/WechatHttpClient.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../domain/interfaces/http.interface'</span>;

<span class="hljs-comment">// 这就是小程序端的翻译官，把标准语言翻译成 wx.request 方言</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatHttpClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHttpClient</span> {
  <span class="hljs-keyword">async</span> get&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, params?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
    <span class="hljs-comment">// 将 callback 风格封装成 Promise 风格以符合接口要求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      wx.<span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">`https://api.myapp.com<span class="hljs-subst">${url}</span>`</span>, <span class="hljs-comment">// 小程序需要完整 URL</span>
        <span class="hljs-attr">data</span>: params,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data</span> <span class="hljs-keyword">as</span> T),
        <span class="hljs-attr">fail</span>: reject
      });
    });
  }
  <span class="hljs-comment">// ... implement post</span>
}
<span class="hljs-comment">// 类似地实现 WechatStorageAdapter...</span>
</code></pre>
<h5 data-id="heading-15">在入口处组装（依赖注入）</h5>
<p>这是最后一步见证奇迹的时刻。在不同端的入口文件里，我们将对应的“翻译官”注入到业务逻辑中。</p>
<h6 data-id="heading-16">Web 端入口 (<code>main.web.ts</code> / <code>App.tsx</code>):</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./services/userService'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AxiosHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./infra/web/AxiosHttpClient'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LocalStorageAdapter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./infra/web/LocalStorageAdapter'</span>;

<span class="hljs-comment">// 组装 Web 版的 User Service</span>
<span class="hljs-keyword">const</span> webUserService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">AxiosHttpClient</span>(),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorageAdapter</span>()
);

<span class="hljs-comment">// 现在 webUserService 可以直接在 React/Vue 组件中使用了</span>
</code></pre>
<h6 data-id="heading-17">小程序端入口 (<code>app.ts</code> / <code>main.mp.ts</code>):</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./services/userService'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WechatHttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./infra/mp/WechatHttpClient'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">WechatStorageAdapter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./infra/mp/WechatStorageAdapter'</span>;

<span class="hljs-comment">// 组装小程序版的 User Service</span>
<span class="hljs-keyword">const</span> mpUserService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatHttpClient</span>(),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatStorageAdapter</span>()
);

<span class="hljs-comment">// mpUserService 可以在小程序的 Page 或 Component 中使用了</span>
</code></pre>
<h5 data-id="heading-18">总结</h5>
<p>通过 DIP，我们将跨端架构分成了清晰的三层：</p>
<ol>
<li><strong>核心业务层（稳定）</strong> ：定义 Interface，编写业务逻辑。这一层代码在多端是<strong>完全共用</strong>的，一行都不用改。</li>
<li><strong>接口契约层（抽象）</strong> ：即 <code>IHttpClient</code>, <code>IStorage</code> 等 Interface 定义。</li>
<li><strong>基础设施层（易变）</strong> ：各个端的具体 Adapter 实现（WebAdapter, MiniProgramAdapter）。</li>
</ol>
<h4 data-id="heading-19">2. 制定官方语言（定义抽象接口）</h4>
<p>业务层声明它需要什么能力，而不关心这能力怎么实现。这些 Interface 定义在核心业务域中。</p>
<h4 data-id="heading-20"/>
<h4 data-id="heading-21">3. 无感知的 Mock 与测试</h4>
<p>写单元测试最痛苦的是 Mock 全局库。如果你遵循了 DIP，你只需要给业务逻辑注入一个 <code>MockClient</code>，连 <code>jest.mock('axios')</code> 这种黑盒操作都不用了。</p>
<h4 data-id="heading-22">4. 插件化架构</h4>
<p>像 VS Code 或大型低代码平台，其核心框架并不依赖具体的插件。它定义了一套规范（抽象），所有的插件必须实现这些规范，这正是 DIP 的高级应用。</p>
<hr/>
<h3 data-id="heading-23">五、 结语：突围的核心是“心智负担”的转移</h3>
<p>很多前端同学抗拒 DIP，觉得“我就写个业务，有必要搞这么复杂吗？”</p>
<p>确实，对于三天就扔的小程序，DIP 属于过度设计。但如果你在构建一个<strong>长期迭代的工程</strong>，DIP 的本质是在<strong>隔离变化</strong>。它把最不稳定的部分（第三方库、API 协议、浏览器差异）挡在了抽象层之外。</p>
<p><strong>架构突围，不是为了炫技，而是为了在下一次需求变动、技术迁移时，你能气定神闲地改一行代码，而不是通宵改两百个文件。</strong></p>
<p><strong>互动环节：</strong> 你在项目中遇到过“因为换个库导致全线崩溃”的经历吗？或者你觉得在开发中，Context API 是否已经足够支撑起 DIP 的职责？欢迎在评论区博弈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了都说好的 uniapp 路由框架]]></title>    <link>https://juejin.cn/post/7594262760939749410</link>    <guid>https://juejin.cn/post/7594262760939749410</guid>    <pubDate>2026-01-12T09:33:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594262760939749410" data-draft-id="7594096585728376832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了都说好的 uniapp 路由框架"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-12T09:33:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风度前端"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359562190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了都说好的 uniapp 路由框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359562190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风度前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T09:33:31.000Z" title="Mon Jan 12 2026 09:33:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    45
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在使用 <code>uni-app</code> 开发项目时，路由跳转是极为频繁的操作，<code>uni-app</code> 提供的路由跳转 api <code>uni.navigateTo</code>够用但是却不够好用，主要问题在于，实际业务中经常涉及大量对象传参的情况，而 <code>uni-app</code> 只支持 query 参数，这就导致，对于对象的传参，必须通过<code>encodeURIComponent</code>先编码，然后在新的页面再通过<code>decodeURIComponent</code>进行解码，为了编码 url，还要拼接<code>&amp;</code>，导致一个页面跳转传参又臭又长，可读性还很差，比如像下面这样：</p>
<pre><code class="hljs language-js" lang="js">uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/test/pay?question_id='</span> +
    res.<span class="hljs-property">data</span>.<span class="hljs-property">id</span> + <span class="hljs-string">'&amp;service='</span> +
    <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(
        service)) + <span class="hljs-string">'&amp;doctor='</span> +
    <span class="hljs-built_in">encodeURIComponent</span>(
        <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
            <span class="hljs-attr">name</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">doctor</span>.<span class="hljs-property">name</span>,
    <span class="hljs-attr">dept_name</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">doctor</span>
    .<span class="hljs-property">dept_name</span>,
    <span class="hljs-attr">dept_code</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">doctor</span>
    .<span class="hljs-property">dept_code</span>,
    <span class="hljs-attr">code</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">doctor</span>.<span class="hljs-property">code</span>
    })) + <span class="hljs-string">'&amp;description='</span> +
    <span class="hljs-built_in">encodeURIComponent</span>(desc)
})
</code></pre>
<p>光看着就头大，要增加一个传参或者修改一个传参，都很考察眼力，寻找拼接的位置，获取参数的时候，也很鸡肋：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">onLoad</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">query</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageHeight</span> = uni.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">windowHeight</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">question_id</span> = query.<span class="hljs-property">question_id</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">service</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-built_in">decodeURIComponent</span>(query.<span class="hljs-property">service</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/%/g</span>, <span class="hljs-string">'%25'</span>)))
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">doctor</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-built_in">decodeURIComponent</span>(query.<span class="hljs-property">doctor</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/%/g</span>, <span class="hljs-string">'%25'</span>)))
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = <span class="hljs-built_in">decodeURIComponent</span>(query.<span class="hljs-property">description</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/%/g</span>, <span class="hljs-string">'%25'</span>))
}
</code></pre>
<p>由此，解决这一痛点就势在必行了，项目中虽然使用了<code>u-view</code>框架，提供了<code>$u.route</code>的方法，对 uni-app 的路由跳转方法进行简单的封装，可以支持通过第二个参数以对象的方式传参：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-title function_">route</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/components/empty/index'</span>,
  <span class="hljs-attr">params</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'lisa'</span>
  }
})
</code></pre>
<p>其优点是，对路由跳转传参友好了一点，看起来更简洁些，但是也仅此而已了，存在的缺陷也很大，主要在于：</p>
<ul>
<li>仅支持值类型的传参，不支持引用类型传参，仍旧未解决实际业务中对对象数据传参的需要。</li>
<li>阉割版的封装，无法传递<code>events</code>，对实际业务中页面返回的回调无法监听。</li>
</ul>
<p>但<code>u-view</code>也启发了我对路由封装的一些思路，结合对<code>axios</code>的使用，我对<code>uni-app</code>的路由跳转方法进行了定制化的封装，并单独发布了包<code>caring-route</code>，且成功在业务中使用，基本解决了上述问题。</p>
<h2 data-id="heading-1">caring-route 的特点</h2>
<ul>
<li>继承了<code>uni-app</code> 的所有路由跳转方法，更加方便调用，名称更简洁</li>
<li>支持跳转 <code>tabBar</code> 页面</li>
<li>支持 <code>events</code></li>
<li>支持成功失败回调</li>
<li>支持传递引用类型路由参数</li>
<li>支持解析路由参数</li>
<li>rollup打包压缩，体积更小，仅有<code>2.7kb</code></li>
<li>支持跳转小程序</li>
</ul>
<p><strong>支持两种调用方法</strong></p>
<ol>
<li>函数调用：<code>route(url[,config])</code></li>
<li>类的实例方法调用：<code>route[method](url[,params])</code></li>
</ol>
<ul>
<li><code>method</code> 的类型：</li>
</ul>

<ul>
<li>
<ul>
<li><code>to</code></li>
<li><code>back</code></li>
<li><code>tab</code></li>
<li><code>redirect</code></li>
<li><code>launch</code></li>
<li><code>mini</code> 跳转小程序</li>
<li><code>query</code> 解析路由参数</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">快速上手</h2>
<p><strong>安装</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm i caring-route
</code></pre>
<p><strong>使用</strong></p>
<p><strong>vue</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> route <span class="hljs-keyword">from</span> <span class="hljs-string">'caring-route'</span>

  <span class="hljs-title function_">route</span>(<span class="hljs-string">'/pages/index/home'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">基础使用</h2>
<p>对于不需要传递参数的路由跳转，<code>route</code>函数提供了原生的方法名称和简化的方法名称，并支持两种传参方式：</p>
<p>一种是类似<code>u-view</code>的，传递两个参数<code>route(url,data)</code>，第一个参数<code>url</code>就是要跳转的路由，第二个参数<code>data</code>则是要传递的参数，与<code>$u.route</code>的区别就是支持传递对象参数，是其加强版，当只需要跳转路由和传递参数时，推荐优先使用<code>route(url,data)</code>的调用方式。</p>
<p>第二种是类<code>uni-app</code>的调用方法，传递一个参数<code>route(config)</code>，其基本使用和 uni-app 是相同的，区别在于：</p>
<ul>
<li><code>uniapp</code>中参数需要通过<code>query</code>参数拼到 url 上，而<code>route(config)</code>的 <code>url</code>只传递跳转的页面路径即可，其页面参数用<code>data</code>或者<code>params</code>来接收。</li>
<li><code>uniapp</code>中需要通过不同的方法<code>navigateTo</code>、<code>redirectTo</code>等来执行不同的路由跳转，而<code>route(config)</code>支持<code>type</code>参数来指定跳转类型是<code>navigateTo</code>还是<code>redirectTo</code></li>
</ul>
<p>下面具体说明</p>
<h3 data-id="heading-4">传递两个参数<code>route(url,data)</code>的使用方法</h3>
<h4 data-id="heading-5">对于<code>uni.navigateTo</code>的封装</h4>
<p>这个方法是路由跳转中最常使用的 api，<code>caring-route</code>做了三种方法的封装，三个方法是等价的，实际业务中，直接使用<code>route()</code>函数是最方便的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// uni.navigateTo</span>
<span class="hljs-title function_">route</span>(<span class="hljs-string">'/pages/index/home'</span>)
route.<span class="hljs-title function_">to</span>(<span class="hljs-string">'/pages/index/home'</span>)
route.<span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">'/pages/index/home'</span>)
</code></pre>
<h4 data-id="heading-6">对于<code>uni.redirectTo</code>的封装</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// redirectTo</span>
route.<span class="hljs-title function_">direct</span>(<span class="hljs-string">'/pages/index/home'</span>)
route.<span class="hljs-title function_">redirectTo</span>(<span class="hljs-string">'/pages/index/home'</span>)
</code></pre>
<h4 data-id="heading-7">对于<code>uni.reLaunch</code>的封装</h4>
<pre><code class="hljs language-js" lang="js">route.<span class="hljs-title function_">launch</span>(<span class="hljs-string">'/pages/index/home'</span>)
route.<span class="hljs-title function_">reLaunch</span>(<span class="hljs-string">'/pages/index/home'</span>)
</code></pre>
<h4 data-id="heading-8">对于<code>uni.navigateBack</code>的封装</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// back</span>
route.<span class="hljs-title function_">back</span>(delta)
route.<span class="hljs-title function_">navigateBack</span>(delta)
</code></pre>
<h4 data-id="heading-9">对于<code>uni.switchTab</code>的封装</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// switchTab</span>
route.<span class="hljs-title function_">tab</span>(<span class="hljs-string">'pages/index/index'</span>)
route.<span class="hljs-title function_">switchTab</span>(<span class="hljs-string">'pages/index/index'</span>)
</code></pre>
<h3 data-id="heading-10">传递路由跳转参数</h3>
<p><code>route</code>函数传入第二个参数，类型为对象，即为传递的路由参数，</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">route</span>(<span class="hljs-string">'/pages/index/home'</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'wanko'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-string">'25'</span>,
  <span class="hljs-attr">hoby</span>: {
    <span class="hljs-attr">guitar</span>: {
      <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>
    }
  }
})
route.<span class="hljs-title function_">to</span>(<span class="hljs-string">'/pages/index/home'</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'wanko'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">hoby</span>: {
    <span class="hljs-attr">guitar</span>: {
      <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>
    }
  }
})

route.<span class="hljs-title function_">launch</span>(<span class="hljs-string">'pages/index/index'</span>, {
  <span class="hljs-attr">msg</span>: <span class="hljs-string">'relunch过来'</span>
})
route.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">'/pages/index/home'</span>, {
  <span class="hljs-attr">msg</span>: <span class="hljs-string">'redirect过来'</span>
})
</code></pre>
<h2 data-id="heading-11">传递一个参数<code>route(config)</code>的使用方法</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">route</span>({
    <span class="hljs-attr">url</span>:<span class="hljs-string">'/pages/index/home'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'navigateTo'</span>,<span class="hljs-comment">// 默认的跳转方式，可不传</span>
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'wanko'</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
        <span class="hljs-attr">hoby</span>: {
          <span class="hljs-attr">guitar</span>: {
            <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>
          }
        },
        <span class="hljs-attr">arr</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],
        <span class="hljs-attr">arrObj</span>: [
          {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'wanko'</span>
          },
          <span class="hljs-number">23</span>,
          <span class="hljs-string">'age'</span>
        ]
    },
    <span class="hljs-attr">events</span>: {
      <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'onSuccess'</span>, data)
      }
    }
  })
</code></pre>
<h3 data-id="heading-12">监听events事件</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// A页面</span>
<span class="hljs-title function_">route</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'navigateTo'</span>, <span class="hljs-comment">// 如果是navigateTo，可以不传type</span>
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/home'</span>, 
  <span class="hljs-attr">events</span>: {
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'onSuccess'</span>, data)
    }
  },
})

<span class="hljs-comment">// B页面</span>
<span class="hljs-keyword">const</span> eventChannel = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOpenerEventChannel</span>();
eventChannel.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'onSuccess'</span>, {
  <span class="hljs-attr">data</span>: <span class="hljs-string">'data from home'</span>
})
route.<span class="hljs-title function_">back</span>()
</code></pre>
<h2 data-id="heading-13">获取路由参数</h2>
<p>在onLoad中使用route的 <code>query</code> 方法传入 options ，函授调用的返回值为已经解码的路由参数</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">const</span> query = route.<span class="hljs-title function_">query</span>(options)
}
</code></pre>
<h2 data-id="heading-14">处理跳转成功的回调</h2>
<p>使用函数调用方式，添加 <code>.then</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">route</span>(<span class="hljs-string">'pages/index/index'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转成功'</span>))
</code></pre>
<h2 data-id="heading-15">跳转微信小程序</h2>
<p>使用 <code>mini(appId, path)</code> 方法来跳转微信小程序</p>
<pre><code class="hljs language-js" lang="js">route.<span class="hljs-title function_">mini</span>(<span class="hljs-string">'wx-appid'</span>, <span class="hljs-string">'pages/tabbar/components'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转成功'</span>)
})
</code></pre>
<h2 data-id="heading-16">开源地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcaring-ui%2Fcaring-route" target="_blank" title="https://github.com/caring-ui/caring-route" ref="nofollow noopener noreferrer">github.com/caring-ui/c…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我和TRAE的这一年：从"看不懂"到"玩得转"的AI学习进化史]]></title>    <link>https://juejin.cn/post/7593311807588810758</link>    <guid>https://juejin.cn/post/7593311807588810758</guid>    <pubDate>2026-01-12T02:16:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593311807588810758" data-draft-id="7593311807588581382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我和TRAE的这一年：从&quot;看不懂&quot;到&quot;玩得转&quot;的AI学习进化史"/> <meta itemprop="keywords" content="Trae,前端,程序员"/> <meta itemprop="datePublished" content="2026-01-12T02:16:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhouzhouya"/> <meta itemprop="url" content="https://juejin.cn/user/3931509312987511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我和TRAE的这一年：从"看不懂"到"玩得转"的AI学习进化史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509312987511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhouzhouya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T02:16:09.000Z" title="Mon Jan 12 2026 02:16:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    83
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、初识TRAE：从"这是什么鬼"到"原来如此"</h2>
<p>第一次打开TRAE时，面对满屏的代码和复杂的界面，我内心的OS,"这玩意儿能帮我写代码？"带着这样的怀疑，我开始了和TRAE的第一次对话。</p>
<p><strong>第一次尝试：失败的代码生成</strong></p>
<p>我输入了第一个指令："帮我写一个登录页面"。结果TRAE给我生成了一堆看不懂的代码，还附带了一堆错误提示。首次使用体验感不佳。</p>
<p><strong>转折点：学会提问</strong></p>
<p>后来经过和同样使用TRAE的小伙伴交流，我发现，问题不在TRAE，而在我自己。更好的使用TRAE需要用更精确的语言描述需求：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我用VUE + TypeScript实现一个登录页面，要求：
<span class="hljs-deletion">- 包含用户名和密码输入框</span>
<span class="hljs-deletion">- 支持记住密码功能</span>
<span class="hljs-deletion">- 使用localStorage存储token</span>
<span class="hljs-deletion">- 使用Element Plus组件库</span>
</code></pre>
<p>TRAE给我提供了完整的思考过程及代码执行：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c09b66737644495a0caa53c034c5e75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768804021&amp;x-signature=o44GMTxCxJh7DGFkWr1%2Bu8pFZeU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cffd1873e97f44279f555e9ff1397577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768804021&amp;x-signature=%2BE7HtWVofCl%2BVbHgFhg831SNiyE%3D" alt="image.png" loading="lazy"/></p>
<p>生成的目录及代码如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47530f9c13845c6b7d8330caeb2477b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768804021&amp;x-signature=YqJL08QXjI7jDswzqXx8OCX4i50%3D" alt="image.png" loading="lazy"/></p>
<br/>
<p>实现效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9dc06c00c304be4a2921a1b911c2799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768804021&amp;x-signature=inZzTpLBaACvUp%2FFSGL%2FXkB%2BIoQ%3D" alt="image.png" loading="lazy"/></p>
<p>这一次，TRAE生成的代码几乎可以直接使用，只需要微调一下样式。<strong>所以，AI不是万能的，但它能帮你完成80%的重复性工作，剩下的20%需要你亲自把控。</strong></p>
<h2 data-id="heading-1">二、GPT模型 vs Gemini模型：我的选择策略</h2>
<p>在TRAE中，我主要使用了GPT和Gemini两个模型，它们各有特点，适合不同的场景,接下来我着重介绍下这两个模型。</p>
<h3 data-id="heading-2">GPT模型：我的"代码审查官"</h3>
<p><strong>核心优势：防御性编程思维</strong></p>
<p>GPT模型最大的特点是"过度负责"。它会在代码中自动添加各种校验逻辑、类型检查、错误处理，甚至会在你没想到的地方加上注释。这让我养成了良好的编码习惯——<strong>写代码时先想好边界条件</strong>。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>编写核心业务逻辑时，需要确保代码健壮性</li>
<li>处理敏感数据（如支付、用户信息）时</li>
<li>需要生成详细文档和注释时</li>
</ul>
<p><strong>真实案例：</strong> ​ 有一次我让GPT帮我写一个文件上传功能，它不仅生成了上传逻辑，还自动添加了文件类型校验、大小限制、重试机制，甚至考虑了网络中断的情况。虽然代码量比我自己写的多了一倍，但上线后确实更稳定。</p>
<h3 data-id="heading-3">Gemini模型：我的"快速原型师"</h3>
<p><strong>核心优势：极简主义 + 长文本处理</strong></p>
<p>Gemini的特点是"精准且高效"。它不会添加多余的功能，严格按照你的要求生成代码，而且支持超长上下文，可以一次性分析整个项目。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>快速原型开发，需要快速看到效果</li>
<li>处理大型代码库，需要理解整体架构</li>
<li>需要生成简洁的代码片段时</li>
</ul>
<p><strong>真实案例：</strong> ​ 我需要重构一个老项目的用户模块，有几十个文件。Gemini帮我分析了整个模块的依赖关系，生成了清晰的架构图，并给出了重构建议。整个过程只用了5分钟，如果我自己分析，可能要花半天,大大的节省了开发时间及分析时间</p>
<h3 data-id="heading-4">我的选择策略</h3>
<br/>



































<table><thead><tr><th>场景</th><th>推荐模型</th><th>原因</th></tr></thead><tbody><tr><td>核心业务开发</td><td>GPT</td><td>代码更健壮，考虑更周全</td></tr><tr><td>快速原型</td><td>Gemini</td><td>响应快，代码简洁</td></tr><tr><td>代码审查</td><td>GPT</td><td>能发现潜在问题</td></tr><tr><td>架构分析</td><td>Gemini</td><td>长文本处理能力强</td></tr><tr><td>学习新技术</td><td>两者交替</td><td>对比不同思路</td></tr></tbody></table>
<p><strong>经验总结：</strong> ​ 不要一直只用一个模型，根据任务特点灵活切换。GPT适合"求稳"，Gemini适合"求快"。</p>
<h2 data-id="heading-5">三、Max Mode vs Auto Mode：我的效率提升秘籍</h2>
<p>TRAE提供了两种工作模式：Max Mode和Auto Mode，使用之后，改变了我的开发模式。接下来我主要讲下这两种模式的区别。</p>
<h3 data-id="heading-6">Max Mode：复杂任务的"重型武器"</h3>
<p><strong>特点：</strong> ​ 支持最大1M上下文窗口，最多200次工具调用，不需要手动继续。</p>
<p><strong>我的使用场景：</strong></p>
<ol>
<li><strong>大型项目重构</strong>：需要理解整个项目的依赖关系</li>
<li><strong>复杂业务逻辑</strong>：需要多轮对话才能完成的任务</li>
<li><strong>生成完整项目</strong>：从需求到部署的全流程</li>
</ol>
<p><strong>真实案例：</strong> ​ 我需要开发一个后台管理系统，涉及用户、商品、订单、支付等多个模块。在Max Mode下，我只需要描述需求，TRAE会自动拆解任务、生成代码、配置环境，甚至帮我写测试用例。整个过程我只负责审核和微调，开发效率提升了至少3倍。</p>
<p><strong>使用技巧：</strong></p>
<ul>
<li>开启Max Mode前，先整理好需求文档</li>
<li>使用<code>#</code>符号引用项目文件，让其理解上下文</li>
<li>定期保存对话记录，避免丢失进度</li>
</ul>
<h3 data-id="heading-7">Auto Mode：日常开发的"智能助手"</h3>
<p><strong>特点：</strong> ​ 自动选择最优模型，智能调度资源，省心省力。</p>
<p><strong>我的使用场景：</strong></p>
<ol>
<li><strong>日常代码补全</strong>：写代码时的智能提示</li>
<li><strong>快速问答</strong>：遇到问题随时提问</li>
<li><strong>小功能开发</strong>：简单的增删改查</li>
</ol>
<p><strong>真实案例：</strong> ​ 我每天都会用Auto Mode处理各种小问题：修复一个bug、优化一段代码、解释一个API用法。涉及到小问题的改动，我会选择Auto Mode模式</p>
<p><strong>使用技巧：</strong></p>
<ul>
<li>不需要手动选择模型，让AI自动判断</li>
<li>适合处理简单的、单次对话就能解决的问题</li>
<li>成本更低，适合日常高频使用</li>
</ul>
<h3 data-id="heading-8">我的模式切换策略</h3>
<br/>



































<table><thead><tr><th>任务类型</th><th>推荐模式</th><th>原因</th></tr></thead><tbody><tr><td>完整项目开发</td><td>Max Mode</td><td>需要长上下文和多轮对话</td></tr><tr><td>日常编码</td><td>Auto Mode</td><td>响应快，成本低</td></tr><tr><td>学习源码</td><td>Max Mode</td><td>需要深度理解代码结构</td></tr><tr><td>快速调试</td><td>Auto Mode</td><td>单次对话就能解决</td></tr><tr><td>团队协作</td><td>Max Mode</td><td>需要生成完整文档</td></tr></tbody></table>
<br/>
<p><strong>经验总结：</strong> ​ Max Mode适合"大而全"的任务，Auto Mode适合"小而美"的场景。通常我会在Max Mode下完成核心功能，然后在Auto Mode下进行日常维护。</p>
<h2 data-id="heading-9">四、那些"看不懂"的源码，TRAE帮我读懂了</h2>
<p>大家都知道，有些源码看起来枯燥难懂，后来我尝试使用TRAE帮我分析。</p>
<h3 data-id="heading-10">案例：理解Vue3源码</h3>
<p>当我尝试自己阅读Vue3的源码，对于复杂的响应式系统和虚拟DOM，我很快就懵了。现在用TRAE帮我分析：</p>
<pre><code class="hljs language-markdown" lang="markdown">请帮我分析Vue3的响应式系统：
<span class="hljs-bullet">1.</span> reactive和ref的区别是什么？
<span class="hljs-bullet">2.</span> 依赖收集和派发更新的流程是怎样的？
<span class="hljs-bullet">3.</span> 请用流程图展示整个过程
</code></pre>
<p>根据TRAE生成的解析，很大程度加快了我们理解源码的进度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f52b06da26c844bbbc31d489ecca48e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768804021&amp;x-signature=x7h3gf%2FVf7LN3NkAoby9%2F5pHCk8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">我的源码学习流程</h3>
<ol>
<li><strong>整体了解</strong>：让TRAE生成项目架构图</li>
<li><strong>深入模块</strong>：选择核心模块，让TRAE解释实现原理</li>
<li><strong>细节分析</strong>：遇到具体问题，用Auto Mode快速提问</li>
<li><strong>实践验证</strong>：自己动手写代码，遇到问题再问TRAE</li>
</ol>
<p><strong>经验总结：</strong> ​ TRAE不是让你不学源码，而是帮你降低学习门槛。它把复杂的源码拆解成可理解的知识点，让你能更快地掌握核心技术。</p>
<h2 data-id="heading-12">五、我的TRAE工作流：从需求到上线的全流程</h2>
<p>经过一年的摸索，我总结出了一套高效的TRAE工作流：</p>
<h3 data-id="heading-13">阶段1：需求分析（Max Mode）</h3>
<pre><code class="hljs language-diff" lang="diff">帮我设计一个电商后台管理系统，包含以下功能：
<span class="hljs-deletion">- 用户管理：增删改查、权限控制</span>
<span class="hljs-deletion">- 商品管理：分类、上下架、库存管理</span>
<span class="hljs-deletion">- 订单管理：创建、支付、发货、退款</span>
<span class="hljs-deletion">- 数据统计：销售报表、用户行为分析</span>

技术栈：React + TypeScript + Ant Design + Node.js + MySQL
</code></pre>
<p>TRAE会生成需求文档、技术选型建议、数据库设计，甚至包括API接口文档。</p>
<h3 data-id="heading-14">阶段2：项目搭建（Builder模式）</h3>
<p>在Builder模式下，TRAE会自动创建项目结构、安装依赖、配置环境，并生成基础代码。我只需要审核生成的代码，确认是否符合预期。</p>
<h3 data-id="heading-15">阶段3：功能开发（Max Mode + Auto Mode）</h3>
<ul>
<li><strong>核心功能</strong>：用Max Mode生成完整模块</li>
<li><strong>细节调整</strong>：用Auto Mode快速修改样式、修复bug</li>
<li><strong>代码审查</strong>：用GPT模型进行代码质量检查</li>
</ul>
<h3 data-id="heading-16">阶段4：测试部署（Auto Mode）</h3>
<pre><code class="hljs language-diff" lang="diff">请帮我生成单元测试用例，覆盖以下场景：
<span class="hljs-deletion">- 用户登录成功/失败</span>
<span class="hljs-deletion">- 商品添加/删除</span>
<span class="hljs-deletion">- 订单创建/支付</span>
</code></pre>
<p>TRAE会生成测试用例，我只需要运行测试，确认功能正常。</p>
<h3 data-id="heading-17">阶段5：上线维护（Auto Mode）</h3>
<p>上线后遇到问题，随时用Auto Mode提问：</p>
<pre><code class="hljs">我的项目在Chrome浏览器下样式错乱，请帮我分析原因
</code></pre>
<p>TRAE会给出解决方案，甚至直接生成修复代码。</p>
<h2 data-id="heading-18">六、这一年，关于TRAE,我学到了什么</h2>
<h3 data-id="heading-19">1. <strong>AI不是替代，而是增强</strong></h3>
<p>TRAE可以帮我处理80%的重复性工作，让我有更多时间思考架构设计、业务逻辑、用户体验。</p>
<h3 data-id="heading-20">2. <strong>学会提问比学会写代码更重要</strong></h3>
<p>同样的需求，不同的提问方式，得到的结果天差地别。用结构化的语言描述需求，用具体的例子说明问题，用清晰的逻辑表达意图。<strong>好的提问，是高效使用AI的前提。</strong></p>
<h3 data-id="heading-21">3. <strong>代码质量比代码速度更重要</strong></h3>
<p>TRAE可以快速生成代码，但不一定是最优的。要养成"先让AI生成，再自己优化"的习惯。</p>
<h3 data-id="heading-22">4. <strong>持续学习是唯一的护城河</strong></h3>
<p>AI技术在飞速发展，今天的最优解明天可能就过时了。要不断地学习新技术，关注AI领域的最新动态，尝试新的工具和方法。</p>
<h2 data-id="heading-23">七、给新手的建议</h2>
<p>如果你刚开始使用TRAE，我有几点建议：</p>
<ol>
<li><strong>从小处开始</strong>：不要一上来就让它生成完整项目，先从简单的代码片段开始</li>
<li><strong>学会拒绝</strong>：AI生成的代码不一定都正确，要学会判断和拒绝</li>
<li><strong>多问多试</strong>：同一个问题，用不同的方式提问，看看哪个效果更好</li>
<li><strong>建立知识库</strong>：把常用的Prompt保存下来，形成自己的知识库</li>
<li><strong>保持批判性思维</strong>：AI会犯错，你要有自己的判断</li>
</ol>
<h2 data-id="heading-24">八、结尾：</h2>
<p>这一年，TRAE已经变成了我不可或缺的"小伙伴"。它帮我完成了从"看不懂"到"玩得转"的转变，让我在技术道路上走得更远、更稳。如果你也想提升开发效率，不妨试试TRAE——它会让你成为一个更好的开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【HarmonyOS应用开发】鸿蒙碰一碰分享开发源码和流程讲解]]></title>    <link>https://juejin.cn/post/7593362940072050740</link>    <guid>https://juejin.cn/post/7593362940072050740</guid>    <pubDate>2026-01-12T01:30:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593362940072050740" data-draft-id="7593573617647943732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【HarmonyOS应用开发】鸿蒙碰一碰分享开发源码和流程讲解"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-12T01:30:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeorgePanda"/> <meta itemprop="url" content="https://juejin.cn/user/1239904847930654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【HarmonyOS应用开发】鸿蒙碰一碰分享开发源码和流程讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904847930654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeorgePanda
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T01:30:15.000Z" title="Mon Jan 12 2026 01:30:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【HarmonyOS应用开发】鸿蒙碰一碰分享开发源码和流程讲解</h2>
<h2 data-id="heading-1">一、概述</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1316d396f674fcfbf1cbe02503f1d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768786215&amp;x-signature=OkDA2FaNpYdXMCZWB2PunnzB2mA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>鸿蒙中的碰一碰分享是系统的特色操作。很多开发者都对这个酷炫的效果非常感兴趣。不过在接入该功能之前，下意识的就会觉得很复杂。其实HarmonyOS已经对碰一碰分享的接口做了非常高的封装，开发者在调用实现该效果时，工作量很小。</p>
<p>并且就算没接入碰一碰分享，将两台手机顶部进行靠近，也会触发碰一碰分享功能，只不过会提示无分享内容。前提是都开启了NFC，其实底层是通过NFC进行通信。</p>
<p><strong>碰一碰的接口整体就分为三个：</strong>
（1）监听碰一碰harmonyShare.on('knockShare', this.onKnockShare)
（2）取消监听碰一碰harmonyShare.off('knockShare', this.onKnockShare)
（3）最后最重要的是，收到碰一碰回调后，处理要分享的信息，调用碰一碰分享发送接口。onKnockShare回调函数中的shareData分享包和调用share接口。</p>
<p>当监听了碰一碰分享，两个手机进行碰一碰操作时，就可以收到该操作的时机，此时在分享回调中，可以根据分享宝shareData的参数信息，进行配置，比如分享图片，还是视频，还是链接等等。shareData中的参数非常多，可以实现不同的分享效果和展示样式，具体参考文末的链接。</p>
<p>当不需要处理分享时，关闭监听即可。整体逻辑非常简单。</p>
<h2 data-id="heading-2">二、代码实现和详细解释</h2>
<p><strong>核心工具类HarmonyShareMgr，碰一碰图片分享举例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { harmonyShare, systemShare } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ShareKit"</span>;
<span class="hljs-keyword">import</span> { uniformTypeDescriptor <span class="hljs-keyword">as</span> utd } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;
<span class="hljs-comment">/**
 * 鸿蒙系统分享工具类
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HarmonyShareMgr</span>{

  <span class="hljs-keyword">private</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"HarmonyShareMgr"</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">mHarmonyShareMgr</span>: <span class="hljs-title class_">HarmonyShareMgr</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Ins</span>(){
    <span class="hljs-keyword">if</span>(!<span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-property">mHarmonyShareMgr</span>){
      <span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-property">mHarmonyShareMgr</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HarmonyShareMgr</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-property">mHarmonyShareMgr</span>;
  }

  <span class="hljs-comment">// 分享图片Uri</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">mImageUri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 分享类型</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">mShareType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;

  <span class="hljs-comment">/**
   * 设置图片分享信息包
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">setImageShareData</span>(<span class="hljs-params">imageUri: <span class="hljs-built_in">string</span></span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mImageUri</span> = imageUri;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mShareType</span> = utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">JPEG</span>;
  }

  <span class="hljs-comment">/**
   * 收到碰一碰分享回调
   */</span>
  <span class="hljs-keyword">private</span> onKnockShare = <span class="hljs-function">(<span class="hljs-params">shareTarget: harmonyShare.SharableTarget</span>)=&gt;</span>{
    <span class="hljs-comment">// 打包</span>
    <span class="hljs-keyword">const</span> shareData = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
      <span class="hljs-attr">utd</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mShareType</span>,
      <span class="hljs-attr">uri</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mImageUri</span>,
    });

    <span class="hljs-comment">// 发送分享包</span>
    shareTarget.<span class="hljs-title function_">share</span>(shareData);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerKnock</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">TAG</span>, <span class="hljs-string">" registerKnock"</span>);
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onKnockShare</span>);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterKnock</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">TAG</span>, <span class="hljs-string">" unRegisterKnock"</span>);
    harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onKnockShare</span>);
  }
}

</code></pre>
<p><strong>测试页面内调用：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HarmonyShareMgr</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../mgr/HarmonyShareMgr'</span>;

<span class="hljs-comment">/**
 * 鸿蒙分享测试页面
 */</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">HarmonyShareTestPage</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"AlbumSelectPage"</span>;

  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 当前界面显示时，进行碰一碰监听</span>
    <span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-title class_">Ins</span>().<span class="hljs-title function_">registerKnock</span>();
  }

  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-title class_">Ins</span>().<span class="hljs-title function_">unRegisterKnock</span>();
  }

  onClickSelectPhoto = <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-title class_">PhotoSelectOptions</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();
      <span class="hljs-comment">// 设置筛选过滤条件</span>
      <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;
      <span class="hljs-comment">// 选择用户选择数量</span>
      <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 实例化图片选择器</span>
      <span class="hljs-keyword">let</span> photoPicker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();
      <span class="hljs-comment">// 唤起安全相册组件</span>
      photoPicker.<span class="hljs-title function_">select</span>(<span class="hljs-title class_">PhotoSelectOptions</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, PhotoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">TAG</span>, <span class="hljs-string">"onClickSelectPhoto photoPicker.select error:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 用户选择确认后，会回调到这里。</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">TAG</span>, <span class="hljs-string">"onClickSelectPhoto photoPicker.select successfully:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title class_">PhotoSelectResult</span>));
        <span class="hljs-comment">// 调用碰一碰分享的图片分享赋值</span>
        <span class="hljs-title class_">HarmonyShareMgr</span>.<span class="hljs-title class_">Ins</span>().<span class="hljs-title function_">setImageShareData</span>(<span class="hljs-title class_">PhotoSelectResult</span>.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>]);
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">TAG</span>, <span class="hljs-string">"onClickSelectPhoto photoPicker.select catch failed:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>(){
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击唤起相册选择'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">onClickSelectPhoto</span>)
    }
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">size</span>({
      <span class="hljs-attr">width</span>: <span class="hljs-string">"100%"</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-string">"100%"</span>
    })
  }

}
</code></pre>
<h2 data-id="heading-3">三、引用资料地址</h2>
<p>ShareKit官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fshare-introduction" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-introduction" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>内容分享：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fknock-share-between-phones-content" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-between-phones-content" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>分享信息包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references%2Fshare-system-share%23section816451553012" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-system-share#section816451553012" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Netty的TCP协议的Socket客户端]]></title>    <link>https://juejin.cn/post/7593913760042975241</link>    <guid>https://juejin.cn/post/7593913760042975241</guid>    <pubDate>2026-01-12T02:07:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593913760042975241" data-draft-id="7593845442372403246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Netty的TCP协议的Socket客户端"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-12T02:07:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Netty的TCP协议的Socket客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T02:07:02.000Z" title="Mon Jan 12 2026 02:07:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21674f0711d47a0b9b264acf3461c75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768788422&amp;x-signature=LR9AfeZceOSjxUi38bo0BotHkoY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01引言</h2>
<p>之前分享了关于Socket服务端的代码，这一节我们继续Socket客户端代码的分享。有了之前的代码基础，分享起来客户端端就非常简单了。因为客户端和服务端几位相似，甚至可以直接拷贝，但是有一些细节需要注意。</p>
<h2 data-id="heading-1">02 Socket客户端</h2>
<h3 data-id="heading-2">2.1 代码预览</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockClient</span> {

    <span class="hljs-meta">@Getter</span>
    <span class="hljs-keyword">private</span> SocketChannel socketChannel;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">eventLoopGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
        bootstrap.group(eventLoopGroup);
        bootstrap.channel(NioSocketChannel.class);
        bootstrap.option(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>);
        
        bootstrap.handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(Channel channel)</span> <span class="hljs-keyword">throws</span> Exception {
                <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> channel.pipeline();
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimiterBasedFrameDecoder</span>(<span class="hljs-number">2048</span>, Unpooled.copiedBuffer(<span class="hljs-string">"_"</span>.getBytes())));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>(StandardCharsets.UTF_8));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>(StandardCharsets.UTF_8));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt;(){
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
                        log.info(<span class="hljs-string">"client receive: {}"</span>, msg);
                    }
                });
            }
        });

        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> bootstrap.connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">9091</span>).sync();
        <span class="hljs-built_in">this</span>.socketChannel = (SocketChannel) channelFuture.channel();
    }
}
</code></pre>
<p>同样使用<code>EventLoopGroup</code>线程池，不过这里的线程组只需要一个就可以了，直接用来处理业务。</p>
<h3 data-id="heading-3">2.2 引导类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">eventLoopGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
<span class="hljs-type">Bootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
bootstrap.group(eventLoopGroup);
</code></pre>
<p><code>io.netty.bootstrap.Bootstrap</code>为客户端的引导类和服务端是不一样的。</p>
<ul>
<li><code>io.netty.bootstrap.ServerBootstrap</code> ：服务端的引导类</li>
<li><code>io.netty.bootstrap.Bootstrap</code>：客户端的引导类</li>
</ul>
<p>但是引导类对应的方法非常类似。</p>
<h3 data-id="heading-4">2.3 配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 绑定通道</span>
bootstrap.channel(NioSocketChannel.class);
<span class="hljs-comment">// 保活连接</span>
bootstrap.option(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>);
</code></pre>
<p>绑定的通道区别于服务端的通道：</p>
<ul>
<li><code>io.netty.channel.socket.nio.NioServerSocketChannel</code>：服务端的通道</li>
<li><code>io.netty.channel.socket.nio.NioSocketChannel</code>：客户端的通道</li>
</ul>
<p>类似带<code>Server</code>关键字的都属于服务端的属性或方法。</p>
<h3 data-id="heading-5">2.4 编解码器</h3>
<p>编解码器要和服务端保持一致。</p>
<pre><code class="hljs language-java" lang="java">bootstrap.handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(Channel channel)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> channel.pipeline();
        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimiterBasedFrameDecoder</span>(<span class="hljs-number">2048</span>, Unpooled.copiedBuffer(<span class="hljs-string">"_"</span>.getBytes())));
        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>(StandardCharsets.UTF_8));
        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>(StandardCharsets.UTF_8));
        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt;(){
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
                log.info(<span class="hljs-string">"client receive: {}"</span>, msg);
            }
        });
    }
});
</code></pre>
<p>这里要说明的是，自定义的业务处理器需要我们根据需要处理对应的方法。客户端主要用来发送消息。接不接收消息需要根据具体情况处理，案例为了验证客户端和服务端的相互通信，这里选择打印接收的消息。</p>
<h3 data-id="heading-6">2.5 连接服务端</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> bootstrap.connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">9091</span>).sync();
<span class="hljs-built_in">this</span>.socketChannel = (SocketChannel) channelFuture.channel();
</code></pre>
<p>注意这里的连接服务端的方式和服务端暴漏接口的方式的区别：</p>
<p><code>bootstrap.connect(ip,port)</code>用来连接服务端的<code>IP</code>和<code>端口</code>，而服务端通过<code>serverBootstrap.bind(9091)</code>来绑定端口。</p>
<p>同时，都需要通过同步的等待端口绑定成功或连接服务端的<code>IP</code>和接口成功。</p>
<p>值得注意的是：</p>
<p>客户端的<code>socketChannel.closeFuture().sync();</code>要不要等待通道关闭？客户端主要用来发布消息，可以完全不同处理。如果还要等待接收服务端的消息，并且会随着方法执行完毕而结束，则需要该代码阻塞。</p>
<p>而实际应用都是嵌套在业务应用中的，本身就不会关闭，更加无需阻塞。</p>
<h2 data-id="heading-7">03 SprintBoot配置</h2>
<p>前面介绍了服务端，我们结合客户端和服务端集成到<code>SpringBoot</code>中，形成完整的链路。</p>
<h3 data-id="heading-8">3.1 服务端初始化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StartConfig</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SockerServer socketServer;


    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        socketServer.start();
    }
}
</code></pre>
<p>项目启动的时候可以通过<code>@PostConstruct</code>注解，完成项目启动后服务端的初始化。</p>
<h3 data-id="heading-9">3.2 客户端调用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">MockClient</span> <span class="hljs-variable">mockClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockClient</span>();
    mockClient.connect();
    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> mockClient.getSocketChannel();

    <span class="hljs-comment">// 发送消息</span>
    socketChannel.writeAndFlush(<span class="hljs-string">"foo test..._"</span>);
}
</code></pre>
<h2 data-id="heading-10">04 小结</h2>
<p>客户端的代码到这里基本就结束了。后面就会介绍<code>WebSocket</code>以及在使用过程中的遇到的一些问题，分享给大家。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[视频播放弱网提示实现]]></title>    <link>https://juejin.cn/post/7593550315254218758</link>    <guid>https://juejin.cn/post/7593550315254218758</guid>    <pubDate>2026-01-12T01:55:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593550315254218758" data-draft-id="7593679324248178688" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="视频播放弱网提示实现"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-12T01:55:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古茗前端团队"/> <meta itemprop="url" content="https://juejin.cn/user/3233040624266695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            视频播放弱网提示实现
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dafcebf7c91d402abd52f072a32deba8~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="古茗前端团队" class="title" data-v-d326b38e="">古茗前端团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-12T01:55:48.000Z" title="Mon Jan 12 2026 01:55:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-12
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读1分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @古茗科技
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：陈盛靖</p>
</blockquote>
<h2 data-id="heading-0">一、背景</h2>
<p>业务群里面经常反馈，视频播放卡顿，视频播放总是停留在某一时刻就播放不了了。后面经过排查，发现这是因为弱网导致的。然而，用户数量众多，隔三差五总有人在群里反馈，有时问题一时半会好不了，用户就会怀疑不是网络，而是我们的系统问题。因此，我们希望能在弱网的时候展示提示，这样用户体验会更友好，同时也能减少一定的客诉。</p>
<h2 data-id="heading-1">二、现状分析</h2>
<p>我们使用的播放器是chimee(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chimee.org%2Findex.html" target="_blank" title="https://www.chimee.org/index.html" ref="nofollow noopener noreferrer">www.chimee.org/index.html</a>)。遗憾的是，chimee并没有视频播放卡顿自动展示loading的功能，不过我们可以通过其插件能力，来编写一个自定义video-loading的插件。</p>
<h2 data-id="heading-2">三、方案设计</h2>
<h3 data-id="heading-3">使用NetworkInformation</h3>
<p>常见的方法就是我们通过设定一个标准，然后检测用户设备的网络速度，在到达一定阈值时展示弱网提示。这里需要确定一个重要的点：什么情况下才算弱网？</p>
<p>我们的应用是h5，这里我们可以使用window对象中的NetworkInformation(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FNetworkInformation" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/NetworkInformation" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a>)，我们可以通过浏览器的debug工具，打印window.naviagtor.connection，这个对象内部就存储着网络信息：</p>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b3afc57fe0a4bbdb5f5965e68307e8e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>其中各个属性含义如下表所示：</p>





































<table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>downlink</td><td>返回以兆比特每秒为单位的有效带宽估计，四舍五入到最接近的 25 千比特每秒的倍数。</td></tr><tr><td>downlinkMax</td><td>返回底层连接技术的最大下行速度，以兆比特每秒（Mbps）为单位。</td></tr><tr><td>effectiveType</td><td>返回连接的有效类型（意思是“slow-2g”、“2g”、“3g”或“4g”中的一个）。此值是使用最近观察到的往返时间和下行链路值的组合来确定的。</td></tr><tr><td>rtt</td><td>返回当前连接的有效往返时间估计，四舍五入到最接近的 25 毫秒的倍数。</td></tr><tr><td>saveData</td><td>如果用户在用户代理上设置了减少数据使用的选项，则返回 true。</td></tr><tr><td>type</td><td>返回设备用于网络通信的连接类型。它会是以下值之一：<br/><strong>bluetooth</strong> <br/><strong>cellular</strong> <br/> <strong>ethernet</strong><br/><strong>none</strong><br/><strong>wifi</strong><br/><strong>wimax</strong><br/><strong>other</strong><br/><strong>unknown</strong></td></tr><tr><td>onchange</td><td>接口的 <strong>change</strong> 事件在网络连接信息发生变化时被触发，并且该事件由 NetworkInformation(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FNetworkInformation" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/NetworkInformation" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a>) 对象接收。</td></tr></tbody></table>
<p>其中，我们可以通过effectiveType判断当前网络的大体情况，并且可以拿到一个预估的网络带宽(downlink)。我们可以通过监听onchange事件，在网络变差的时候，展示对应的弱网提示。</p>
<p>这个方案的优点是：</p>
<ul>
<li><strong>浏览器环境原生支持</strong></li>
<li><strong>实现相对简单</strong></li>
</ul>
<p>但缺点却十分明显：</p>
<ul>
<li><strong>网络状态变化非实时</strong></li>
</ul>
<p>effectiveType的变化可能是分钟级别的，对于短暂的网络波动，状态没办法做更精细的把控</p>
<ul>
<li><strong>存在兼容性问题</strong></li>
</ul>
<p>对于不同一些主流浏览器不支持，例如Firefox、Safari等</p>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d189efd937c74d1eb2f31d0b58c0b21a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<ul>
<li><strong>不同设备间存在差异</strong></li>
</ul>
<p>不同的设备和浏览器，由于其差异，在不同的网络情况下，视频的播放情况是不一样的，如果我们固定一个标准，可能会导致在不同设备下，同一个网络速度，有人明明正常播放视频，但是却提示网络异常，这样用户会感到疑惑。</p>
<p>那有没有更好的方法呢？</p>
<h3 data-id="heading-4">监听Video元素事件</h3>
<p>chimee底层也是在html video上进行的二次封装，我们可以在插件的生命周期中，拿到对应的video元素节点。而在video标签中，存在这样两个事件：waiting和canplay。</p>
<p>其事件描述如下图所示：</p>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27bbb9b9011549c5a00873c9814703f4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>当视频播放卡顿时，会触发waiting事件；而当视频播放恢复正常时，会触发canplay事件。只要监听这两个事件，我们就可以实现对应的功能了。</p>
<h2 data-id="heading-5">四、功能拓展</h2>
<p>我们知道，现在大多数网站的视频在提示弱网的时候，都会展示当前设备的网络速度是多少。因此我们也希望在展示对应的信息。那么怎么实现网络速度的检测呢？</p>
<p>一个简单的方法是，我们可以通过获取一张固定大小的图片资源(不一定是图片，也可以是别的类型的资源），并统计请求该资源的请求速度，从而计算当前网络的带宽是多少。当然，图片大小要尽可能小一点，一是为了节省用户流量，二是为了避免在网络不好的情况下，图片请求太慢导致一直计算不出来。</p>
<p>具体代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">funtion <span class="hljs-title function_">calculateSpeed</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 图片大小772Byte</span>
  <span class="hljs-keyword">const</span> fileSize = <span class="hljs-number">772</span>;
  <span class="hljs-comment">// 拼接时间戳，避免缓存</span>
  <span class="hljs-keyword">const</span> imgUrl = <span class="hljs-string">`https://xxx.png?timestamp=<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()}</span>`</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> end = <span class="hljs-number">1000</span>;
    <span class="hljs-keyword">let</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'img'</span>);
    start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();
    img.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        end = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();
        <span class="hljs-comment">// 计算出来的单位为 B/s</span>
        <span class="hljs-keyword">const</span> speed = fileSize / (end &gt; start ? end - start : <span class="hljs-number">1000</span>) * <span class="hljs-number">1000</span>;
        <span class="hljs-title function_">resolve</span>(speed);
    }
    img.<span class="hljs-property">src</span> = imgUrl;
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> { <span class="hljs-keyword">throw</span> err });
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">translateUnit</span>(<span class="hljs-params">speed</span>) {
  <span class="hljs-keyword">if</span>(speed === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'0.00 B/s'</span>;
  <span class="hljs-keyword">if</span>(speed &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(speed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> MB/s`</span>;
  <span class="hljs-keyword">if</span>(speed &gt; <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(speed / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> KB/s`</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${speed.toFixed(<span class="hljs-number">2</span>)}</span> B/s`</span>;
}
</code></pre>
<p>我们可以通过setInterval来轮询调用该函数，从而实时展示当前网络情况。系统流程图如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eec9f120b75446a7a3d69a1a7ee950c9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h2 data-id="heading-6">五、总结</h2>
<p>我们可以通过Chrome浏览器开发者工具中的Network中的网络配置来模拟弱网情况
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1e6c0e3d8de4244a9d68015e5f6f8f5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/>
具体效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76b4b8cc3a8d41dcb9711593605e6287~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>成功实现视频弱网提示，完结撒花🎉🎉🎉🎉🎉🎉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个纯前端的网站集合管理工具]]></title>    <link>https://juejin.cn/post/7594270467029581851</link>    <guid>https://juejin.cn/post/7594270467029581851</guid>    <pubDate>2026-01-12T07:46:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594270467029581851" data-draft-id="7594242987598004251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个纯前端的网站集合管理工具"/> <meta itemprop="keywords" content="前端,Chrome,Vue.js"/> <meta itemprop="datePublished" content="2026-01-12T07:46:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Younglina"/> <meta itemprop="url" content="https://juejin.cn/user/817692381290190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个纯前端的网站集合管理工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692381290190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Younglina
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T07:46:13.000Z" title="Mon Jan 12 2026 07:46:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="zenburn">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#3f3f3f;color:#dcdcdc}.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#e3ceab}.hljs-template-tag{color:#dcdcdc}.hljs-number{color:#8cd0d3}.hljs-attribute,.hljs-template-variable,.hljs-variable{color:#efdcbc}.hljs-literal{color:#efefaf}.hljs-subst{color:#8f8f8f}.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-title,.hljs-type{color:#efef8f}.hljs-bullet,.hljs-link,.hljs-symbol{color:#dca3a3}.hljs-built_in,.hljs-builtin-name,.hljs-deletion,.hljs-string{color:#cc9393}.hljs-addition,.hljs-comment,.hljs-meta,.hljs-quote{color:#7f9f7f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本地化网站管理平台</h2>
<p>一个纯前端的网站集合管理工具，支持本地数据存储、完整的CRUD操作，可作为 Chrome 扩展使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9c18800457946189a3236c59b7d7b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW91bmdsaW5h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768808773&amp;x-signature=6uZZbAwlE0rjo9086FZW7rjufkQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42bb0e6927f2470384848e25cc36ba7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW91bmdsaW5h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768808773&amp;x-signature=4%2B6tgTXm8rJPC%2FImuj5T2BoIH8s%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66fe6cb2f47242d4911ac6efa4a8e371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW91bmdsaW5h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768808773&amp;x-signature=qnFrlCHqlc306blBkW496vwSZhY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b4d919554a642c7b57c331aba0401bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW91bmdsaW5h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768808773&amp;x-signature=d7iooAiOUV39SxIPzVeU0zGtY6M%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">功能特性</h3>
<h4 data-id="heading-2">核心功能</h4>
<ul>
<li>✅ <strong>网站管理</strong>：完整的增删改查功能</li>
<li>✅ <strong>图片上传</strong>：支持上传网站图标（存储到IndexedDB）</li>
<li>✅ <strong>APIKeys管理</strong>：支持多个APIKeys，脱敏显示，一键复制</li>
<li>✅ <strong>分类系统</strong>：支持自定义分类（带图标选择）</li>
<li>✅ <strong>标签系统</strong>：支持自定义标签，多维度筛选</li>
<li>✅ <strong>搜索功能</strong>：支持按网站名称、描述、URL搜索</li>
<li>✅ <strong>本地存储</strong>：所有数据存储在浏览器IndexedDB中，无需服务器</li>
<li>✅ <strong>导入导出</strong>：支持 JSON 格式的数据导入导出</li>
</ul>
<h3 data-id="heading-3">技术栈</h3>
<ul>
<li><strong>框架</strong>：Vue 3 (Composition API + <code>&lt;script setup&gt;</code>)</li>
<li><strong>语言</strong>：TypeScript（宽松模式）</li>
<li><strong>构建工具</strong>：Vite</li>
<li><strong>样式</strong>：Tailwind CSS</li>
<li><strong>数据库</strong>：Dexie.js (IndexedDB封装)</li>
<li><strong>图标</strong>：Material Design Icons</li>
<li><strong>状态管理</strong>：Pinia</li>
</ul>
<h3 data-id="heading-4">快速开始</h3>
<h4 data-id="heading-5">安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install
</code></pre>
<h4 data-id="heading-6">开发模式</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a></p>
<h4 data-id="heading-7">构建 Chrome 扩展</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows</span>
pack.bat

<span class="hljs-comment"># Linux/Mac</span>
./pack.sh
</code></pre>
<p>构建完成后，<code>dist</code> 目录包含完整的 Chrome 扩展文件。</p>
<h3 data-id="heading-8">安装 Chrome 扩展</h3>
<ol>
<li>打开 Chrome，访问 <code>chrome://extensions/</code></li>
<li>开启右上角的 <strong>开发者模式</strong></li>
<li>点击 <strong>加载已解压的扩展程序</strong></li>
<li>选择项目的 <code>dist</code> 文件夹</li>
</ol>
<p>点击扩展图标即可打开工具集。</p>
<h3 data-id="heading-9">项目结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">links/
├── src/
│   ├── components/          <span class="hljs-meta"># 组件</span>
│   │   ├── layouts/        <span class="hljs-meta"># 布局组件</span>
│   │   │   ├── Header.vue
│   │   │   ├── Sidebar.vue
│   │   │   └── MainContent.vue
│   │   ├── website/       <span class="hljs-meta"># 网站相关组件</span>
│   │   │   ├── WebsiteCard.vue
│   │   │   ├── WebsiteDetailDrawer.vue
│   │   │   ├── WebsiteForm.vue
│   │   │   ├── ImageUploader.vue
│   │   │   └── ApiKeyInput.vue
│   │   ├── filter/        <span class="hljs-meta"># 筛选组件</span>
│   │   │   ├── SearchBar.vue
│   │   │   ├── CategoryFilter.vue
│   │   │   └── TagFilter.vue
│   │   └── common/        <span class="hljs-meta"># 通用组件</span>
│   │       ├── ThemeSwitcher.vue
│   │       ├── CategoryDialog.vue
│   │       └── TagDialog.vue
│   ├── composables/        <span class="hljs-meta"># 组合式函数</span>
│   │   ├── useDexie.ts
│   │   ├── useWebsites.ts
│   │   ├── useCategories.ts
│   │   ├── useTags.ts
│   │   ├── useImageUpload.ts
│   │   ├── useApiKey.ts
│   │   └── useTheme.ts
│   ├── db/                 <span class="hljs-meta"># 数据库</span>
│   │   ├── index.ts        <span class="hljs-meta"># Dexie实例</span>
│   │   └── seed.ts         <span class="hljs-meta"># 预置数据</span>
│   ├── stores/             <span class="hljs-meta"># Pinia状态管理</span>
│   │   └── app.ts
│   ├── types/              <span class="hljs-meta"># TypeScript类型定义</span>
│   │   └── index.ts
│   ├── utils/              <span class="hljs-meta"># 工具函数</span>
│   │   ├── validators.ts
│   │   ├── formatters.ts
│   │   └── constants.ts
│   └── styles/             <span class="hljs-meta"># 样式文件</span>
│       ├── main.css
│       └── themes/
│           └── neumorphism.css
├── <span class="hljs-keyword">public</span>/
│   ├── background.js       <span class="hljs-meta"># Chrome 扩展 background script</span>
│   └── tools.png           <span class="hljs-meta"># 扩展图标</span>
├── manifest.json           <span class="hljs-meta"># Chrome 扩展配置</span>
├── vite.config.js          <span class="hljs-meta"># Vite 配置</span>
├── pack.bat                <span class="hljs-meta"># Windows 打包脚本</span>
└── pack.sh                 <span class="hljs-meta"># Linux/Mac 打包脚本</span>
</code></pre>
<h3 data-id="heading-10">使用说明</h3>
<h4 data-id="heading-11">添加网站</h4>
<ol>
<li>点击右上角"添加"下拉菜单，选择"添加网站"</li>
<li>填写网站信息：
<ul>
<li>名称（必填）</li>
<li>URL（必填）</li>
<li>图标（推荐128-256px，&lt;500KB）</li>
<li>描述</li>
<li>分类（必填）</li>
<li>标签（多选）</li>
<li>APIKeys（可选，可添加多个）</li>
</ul>
</li>
<li>点击"添加"保存</li>
</ol>
<h4 data-id="heading-12">管理网站</h4>
<ul>
<li>点击网站卡片查看详情</li>
<li>详情中可以查看APIKeys（脱敏显示）</li>
<li>支持复制完整APIKey</li>
<li>支持编辑和删除网站</li>
</ul>
<h4 data-id="heading-13">筛选网站</h4>
<ul>
<li>使用左侧分类导航筛选</li>
<li>使用标签复选框多选筛选</li>
<li>使用顶部搜索栏搜索</li>
</ul>
<h4 data-id="heading-14">导入导出数据</h4>
<p>点击右上角"添加"下拉菜单：</p>
<ul>
<li><strong>导出数据</strong>：下载当前所有数据的 JSON 文件</li>
<li><strong>导入数据</strong>：选择 JSON 文件导入，支持合并或替换模式</li>
</ul>
<h3 data-id="heading-15">数据存储</h3>
<p>所有数据存储在浏览器的IndexedDB中：</p>
<ul>
<li><code>SitesDB</code> 数据库名</li>
<li>包含3个表：websites, categories, tags</li>
<li>数据只在本地，不会上传到任何服务器</li>
</ul>
<h3 data-id="heading-16">注意事项</h3>
<ol>
<li><strong>图片大小</strong>：建议上传的图标小于500KB，推荐128-256px</li>
<li><strong>APIKey安全</strong>：APIKeys存储在本地IndexedDB中，请妥善保管浏览器数据</li>
<li><strong>数据备份</strong>：定期导出数据作为备份</li>
<li><strong>浏览器兼容性</strong>：支持现代浏览器（Chrome, Firefox, Safari, Edge）</li>
</ol>
<h3 data-id="heading-17">许可证</h3>
<p>MIT License</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀告别Vibe Coding！用Superpowers让Claude Code写出工程级代码，一次通过零报错！遵循TDD最佳实践！支持Codex和OpenCo]]></title>    <link>https://juejin.cn/post/7593573617648123956</link>    <guid>https://juejin.cn/post/7593573617648123956</guid>    <pubDate>2026-01-12T01:55:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593573617648123956" data-draft-id="7593913760042827785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀告别Vibe Coding！用Superpowers让Claude Code写出工程级代码，一次通过零报错！遵循TDD最佳实践！支持Codex和OpenCo"/> <meta itemprop="keywords" content="Claude,AI编程,AIGC"/> <meta itemprop="datePublished" content="2026-01-12T01:55:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀告别Vibe Coding！用Superpowers让Claude Code写出工程级代码，一次通过零报错！遵循TDD最佳实践！支持Codex和OpenCo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T01:55:32.000Z" title="Mon Jan 12 2026 01:55:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Superpowers</strong> 是一个为 AI 编程代理（如 Claude Code、Codex、OpenCode）打造的完整软件开发工作流系统。它的核心理念是：通过一套可组合的"技能"（Skills）和初始指令，让 AI 代理在编写代码时自动遵循最佳实践，而不是像"没有经验的初级工程师"那样随意行事。</p>
<p>🔥🔥🔥本篇笔记所对应的视频： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11urFBrEc4%2F" target="_blank" title="https://www.bilibili.com/video/BV11urFBrEc4/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV11u…</a></p>
<p>项目由 Jesse Vincent（GitHub: obra）开发，目前已获得 16.1k 星标和 1.3k 分叉，社区活跃度很高。</p>
<hr/>
<h3 data-id="heading-0">🚀核心设计哲学</h3>
<p>项目建立在四个核心原则之上：</p>
<p><strong>测试驱动开发（TDD）</strong> ：永远先写测试。没有看到测试失败，就不能确定测试是否真正测试了正确的行为。</p>
<p><strong>系统化而非临时化</strong>：用流程替代猜测。每个技能都有明确的决策流程图（用 DOT/GraphViz 语法定义），作为"可执行规范"。</p>
<p><strong>复杂度削减</strong>：以简洁为首要目标。技能中反复强调 YAGNI（You Aren't Gonna Need It）原则，积极删除不必要的功能。</p>
<p><strong>证据而非声明</strong>：在宣布任务完成之前，必须验证。看到测试通过，看到代码运行，而不是"我觉得应该可以了"。</p>
<hr/>
<h3 data-id="heading-1">🚀完整工作流程</h3>
<p>Superpowers 构建了一个端到端的开发流程：</p>
<p><strong>第一阶段：头脑风暴（brainstorming）</strong> 当你说"我想做一个 X 功能"时，AI 不会直接写代码。它会像苏格拉底式对话一样，一次问一个问题，帮你厘清真正的需求。设计方案分 200-300 字的小节呈现，每节都要你确认"看起来对吗"。</p>
<p><strong>第二阶段：工作区隔离（using-git-worktrees）</strong> 设计确认后，AI 会创建一个新的 git 分支和 worktree，确保开发环境隔离，不污染主分支。</p>
<p><strong>第三阶段：编写计划（writing-plans）</strong> 把设计拆解成 2-5 分钟的小任务。每个任务都有精确的文件路径、完整的代码片段、验证步骤。目标是让"一个没有判断力、没有项目背景、讨厌写测试的热情初级工程师"也能执行。</p>
<p><strong>第四阶段：子代理驱动开发（subagent-driven-development）</strong> 这是 v4.0 的重大创新。主代理为每个任务派遣一个"新鲜"的子代理（没有上下文污染），实现任务后进行两阶段审查：</p>
<ul>
<li>规格符合性审查：代码是否完全符合需求规格？是否多做了？少做了？</li>
<li>代码质量审查：只有规格审查通过后才进行。检查代码是否干净、测试覆盖是否足够</li>
</ul>
<p>审查是循环的：发现问题→修复→再审查，直到通过。</p>
<p><strong>第五阶段：收尾（finishing-a-development-branch）</strong> 所有任务完成后，验证测试、呈现选项（合并/创建 PR/保留/丢弃），清理 worktree。</p>
<hr/>
<h3 data-id="heading-2">🚀技能库详解</h3>
<p>项目包含 14 个核心技能，分为几大类别：</p>
<p><strong>测试类</strong></p>
<ul>
<li><code>test-driven-development</code>：强制执行 RED-GREEN-REFACTOR 循环。核心规则是"先写测试失败的代码？删掉，重新来"，包含详细的反模式参考</li>
</ul>
<p><strong>调试类</strong></p>
<ul>
<li><code>systematic-debugging</code>：四阶段根因定位流程，整合了 root-cause-tracing（逆向追踪调用栈）、defense-in-depth（多层验证）、condition-based-waiting（基于条件的等待替代任意超时）等技术</li>
<li><code>verification-before-completion</code>：确保问题真正被修复</li>
</ul>
<p><strong>协作类</strong></p>
<ul>
<li><code>brainstorming</code>：苏格拉底式设计提炼</li>
<li><code>writing-plans</code>：详细实现计划</li>
<li><code>executing-plans</code>：批量执行与检查点</li>
<li><code>dispatching-parallel-agents</code>：并发子代理工作流</li>
<li><code>requesting-code-review</code> / <code>receiving-code-review</code>：代码审查的请求与响应</li>
<li><code>using-git-worktrees</code>：并行开发分支</li>
<li><code>finishing-a-development-branch</code>：合并/PR 决策工作流</li>
<li><code>subagent-driven-development</code>：两阶段审查的快速迭代</li>
</ul>
<p><strong>元技能</strong></p>
<ul>
<li><code>using-superpowers</code>：技能系统入门</li>
<li><code>writing-skills</code>：如何创建新技能（包含测试方法论）</li>
</ul>
<hr/>
<h3 data-id="heading-3">🚀技术架构亮点</h3>
<p><strong>流程图作为可执行规范</strong>：技能文件使用 DOT 语法定义决策流程图，这不是装饰性的，而是 AI 必须遵循的权威定义。这解决了"描述覆盖流程图"的陷阱。</p>
<p><strong>描述陷阱的发现与解决</strong>：项目团队发现，如果技能描述中包含工作流摘要，AI 会跟随简短描述而忽略详细流程图。解决方案是描述只写触发条件（"Use when X"），不写流程细节。</p>
<p><strong>反合理化设计</strong>：<code>using-superpowers</code> 技能中专门列出了 AI 常见的逃避借口及其反驳，例如"我已经手动测试过了"→错误，临时测试不等于系统化测试。</p>
<p><strong>测试基础设施</strong>：项目包含三套测试框架：</p>
<ul>
<li>技能触发测试：验证技能能否从"朴素"提示触发</li>
<li>Claude Code 集成测试：使用 <code>claude -p</code> 进行无头测试</li>
<li>子代理工作流端到端测试：包含完整的 Go 和 Svelte 测试项目</li>
</ul>
<hr/>
<h3 data-id="heading-4">🚀跨平台支持</h3>
<p><strong>Claude Code</strong>：通过插件市场安装，有原生的 Skill 工具支持</p>
<p><strong>Codex/OpenCode</strong>：通过获取远程指令文件引导安装，共享核心模块 <code>lib/skills-core.js</code></p>
<hr/>
<h3 data-id="heading-5">🚀版本演进亮点</h3>
<p><strong>v4.0.0</strong> 的核心创新是两阶段代码审查和调试技术整合。v3.0 迁移到 Anthropic 官方技能系统。v2.0 实现技能仓库分离，支持社区贡献。</p>
<hr/>
<h3 data-id="heading-6">🚀总结</h3>
<p>Superpowers 本质上是在回答一个问题：<strong>如何让 AI 代理像有经验的工程师一样工作，而不是像"会写代码但不懂工程"的实习生？</strong></p>
<p>答案是：把最佳实践编码成可执行的、不可逃避的工作流。用流程图定义决策点，用测试验证行为，用子代理实现关注点分离，用两阶段审查确保质量。</p>
<p>这个项目对于想要提升 AI 编程效率和质量的开发者来说，是一个非常值得学习和使用的工具。</p>
<h3 data-id="heading-7">🚀Claude Code使用方式</h3>
<p><strong>✅第一步：安装 Superpowers</strong></p>
<p>打开 Claude Code，输入两条命令：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add obra/superpowers-marketplace
</code></pre>
<p><strong>验证安装成功</strong></p>
<p>输入 <code>/help</code>，你应该能看到：</p>
<ul>
<li><code>/superpowers:brainstorm</code> - 头脑风暴</li>
<li><code>/superpowers:write-plan</code> - 写计划</li>
<li><code>/superpowers:execute-plan</code> - 执行计划</li>
</ul>
<p><strong>✅第二步：启动头脑风暴</strong></p>
<p>你有一个想法，但可能还很模糊。头脑风暴阶段就是让 AI 像产品经理一样问你问题，帮你把想法变成清晰的设计。</p>
<p>假设你想做一个"待办事项应用"。你只需要说：“我想做一个待办事项应用”。</p>
<p><strong>注意</strong>：你不需要输入任何特殊命令！Superpowers 会自动触发。当 AI 看到你想"做"或"建"什么东西时，它会自动进入头脑风暴模式。</p>
<p><strong>AI 会怎么做？</strong></p>
<ol>
<li><strong>先侦察</strong>：AI 会先看看你的项目目录，了解现有代码结构</li>
<li><strong>一次问一个问题</strong>：不会一下子问你10个问题</li>
<li><strong>给你选项</strong>：尽量给你 A/B/C 选择，而不是让你从零想</li>
</ol>
<p><strong>设计文档输出</strong></p>
<p>问完所有关键问题后，AI 会：</p>
<ol>
<li>把设计分成 200-300 字的小节展示给你</li>
<li>每节都问你："这部分对吗？"</li>
<li>全部确认后，写入 <code>docs/plans/2025-01-10-todo-app-design.md</code></li>
</ol>
<p><strong>✅第三步：创建隔离工作区</strong></p>
<p><strong>这是什么？</strong></p>
<p>想象你在装修房子。你不会直接在客厅里试验新油漆颜色——你会先找一小块墙试试。Git Worktree 就是那块"试验墙"。</p>
<p><strong>发生了什么？</strong></p>
<p>AI 设计完成后会问你：</p>
<p><code>AI: 设计确认完毕。准备好开始实现了吗？ 你: 是的</code></p>
<p>然后 AI 会自动：</p>
<ol>
<li><strong>创建新分支</strong>：比如 <code>feature/todo-app</code></li>
<li><strong>创建 worktree</strong>：一个独立的工作目录，和主代码完全隔离</li>
<li><strong>运行项目初始化</strong>：确保环境能跑起来</li>
<li><strong>验证测试基线</strong>：确保现有测试都是绿色的</li>
</ol>
<p><strong>为什么这么做？</strong></p>
<ul>
<li>你的主分支（main）保持干净</li>
<li>如果实验失败，直接删掉这个 worktree，不影响任何东西</li>
<li>可以同时开多个功能分支，互不干扰</li>
</ul>
<p><strong>✅第四步：编写实现计划</strong></p>
<p><strong>这是什么？</strong></p>
<p>你不能对一个实习生说"做一个待办事项应用"。你得说：</p>
<ul>
<li>第一步：创建 <code>Todo</code> 数据结构</li>
<li>第二步：实现"添加"功能</li>
<li>第三步：实现"删除"功能</li>
<li>...</li>
</ul>
<p>每一步都要小到 2-5 分钟能完成。</p>
<p><strong>每个步骤详解</strong></p>
<p><strong>RED（红色）</strong> ：写一个会失败的测试</p>
<p>运行测试：<code>npm test</code> → 失败（因为 <code>addTodo</code> 还不存在）</p>
<p><strong>这步的关键</strong>：你必须亲眼看到测试失败！如果测试一开始就通过，说明：</p>
<ul>
<li>你测试的是已有功能（没意义）</li>
<li>测试写错了（危险）</li>
</ul>
<p><strong>GREEN（绿色）</strong> ：写最少的代码让测试通过</p>
<h3 data-id="heading-8">🚀Codex 安装与使用</h3>
<ol>
<li><strong>快速安装（推荐）</strong></li>
</ol>
<p>直接告诉 Codex：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Fetch</span> <span class="hljs-keyword">and</span> follow instructions from &lt;<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/obra</span><span class="hljs-regexp">/superpowers/refs</span><span class="hljs-regexp">/heads/main</span><span class="hljs-regexp">/.codex/</span><span class="hljs-variable constant_">INSTALL</span>.md&gt;
</code></pre>
<p>Codex 会自动完成所有安装步骤。</p>
<ol>
<li><strong>手动安装</strong></li>
</ol>
<p><strong>前置要求</strong></p>
<ul>
<li>OpenAI Codex CLI 已安装</li>
<li>Node.js v14+（推荐 v18+ 以获得更好的 ES 模块支持）</li>
<li>Git 已安装</li>
<li>Shell 访问权限</li>
</ul>
<p><strong>安装步骤</strong></p>
<p><strong>第一步：克隆 Superpowers 仓库</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.codex/superpowers
<span class="hljs-built_in">cd</span> ~/.codex/superpowers
git <span class="hljs-built_in">clone</span> &lt;https://github.com/obra/superpowers.git&gt; .
</code></pre>
<p><strong>第二步：创建个人技能目录</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.codex/skills
</code></pre>
<p><strong>第三步：配置 <a href="https://link.juejin.cn?target=http%3A%2F%2FAGENTS.md" target="_blank" title="http://AGENTS.md" ref="nofollow noopener noreferrer">AGENTS.md</a></strong> 编辑 <code>~/.codex/AGENTS.md</code>，添加以下内容：</p>
<pre><code class="hljs language-sql" lang="sql">## Superpowers <span class="hljs-keyword">System</span>

<span class="hljs-operator">&lt;</span>EXTREMELY_IMPORTANT<span class="hljs-operator">&gt;</span>
You have superpowers. Superpowers teach you <span class="hljs-keyword">new</span> skills <span class="hljs-keyword">and</span> capabilities.

<span class="hljs-keyword">RIGHT</span> NOW run: `<span class="hljs-operator">~</span><span class="hljs-operator">/</span>.codex<span class="hljs-operator">/</span>superpowers<span class="hljs-operator">/</span>.codex<span class="hljs-operator">/</span>superpowers<span class="hljs-operator">-</span>codex bootstrap` 
<span class="hljs-keyword">and</span> follow the instructions it returns.
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>EXTREMELY_IMPORTANT<span class="hljs-operator">&gt;</span>
</code></pre>
<p><strong>第四步：验证安装</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/.codex/</span>superpowers/.<span class="hljs-property">codex</span>/superpowers-codex bootstrap
</code></pre>
<p>如果看到技能列表和引导指令，说明安装成功。</p>
<p><strong>使用方法</strong></p>
<p>查找可用技能</p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/.codex/</span>superpowers/.<span class="hljs-property">codex</span>/superpowers-codex find-skills
</code></pre>
<p>或者告诉 Codex：</p>
<pre><code class="hljs language-arduino" lang="arduino">Run ~/.codex/superpowers/.codex/superpowers-codex find-skills to show available skills
</code></pre>
<p><strong>加载特定技能</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/.codex/</span>superpowers/.<span class="hljs-property">codex</span>/superpowers-codex use-skill <span class="hljs-attr">superpowers</span>:brainstorming
</code></pre>
<p><strong>加载完整引导</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/.codex/</span>superpowers/.<span class="hljs-property">codex</span>/superpowers-codex bootstrap
</code></pre>
<h3 data-id="heading-9">🚀**OpenCode 安装与使用完整脚本</h3>
<p>一键安装脚本**</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># Superpowers for OpenCode - 完整安装脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 安装 Superpowers for OpenCode ==="</span>

<span class="hljs-comment"># 第一步：克隆 Superpowers 仓库</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[1/4] 克隆 Superpowers 仓库..."</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/opencode/superpowers
git <span class="hljs-built_in">clone</span> &lt;https://github.com/obra/superpowers.git&gt; ~/.config/opencode/superpowers

<span class="hljs-comment"># 第二步：创建插件目录并注册插件</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[2/4] 注册插件..."</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/opencode/plugin
<span class="hljs-built_in">ln</span> -sf ~/.config/opencode/superpowers/.opencode/plugin/superpowers.js \\
       ~/.config/opencode/plugin/superpowers.js

<span class="hljs-comment"># 第三步：创建个人技能目录</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[3/4] 创建个人技能目录..."</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/opencode/skills

<span class="hljs-comment"># 第四步：验证安装</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[4/4] 验证安装..."</span>
<span class="hljs-keyword">if</span> [ -f ~/.config/opencode/plugin/superpowers.js ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 插件链接创建成功"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 插件链接创建失败"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [ -d ~/.config/opencode/superpowers/skills ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 技能目录存在"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"   可用技能数量: <span class="hljs-subst">$(ls ~/.config/opencode/superpowers/skills | wc -l)</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 技能目录不存在"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 安装完成！==="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"下一步操作："</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 重启 OpenCode"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 在对话中输入: do you have superpowers?"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 使用 find_skills 工具查看可用技能"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 使用 use_skill 工具加载技能"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"示例命令："</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  use find_skills tool"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  use use_skill tool with skill_name: \\"</span>superpowers:brainstorming\\"<span class="hljs-string">"
</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探索Playwright：前端自动化测试的新纪元]]></title>    <link>https://juejin.cn/post/7594047593967681574</link>    <guid>https://juejin.cn/post/7594047593967681574</guid>    <pubDate>2026-01-12T06:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594047593967681574" data-draft-id="7594047593967665190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探索Playwright：前端自动化测试的新纪元"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-12T06:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探索Playwright：前端自动化测试的新纪元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T06:04:07.000Z" title="Mon Jan 12 2026 06:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">背景</h3>
<p>在前端开发中，自动化测试是确保软件质量和用户体验的关键环节。随着Web应用的复杂性不断增加，手动测试已经无法满足快速迭代和持续交付的需求。自动化测试通过模拟用户与应用的交互，能够高效地执行重复性测试任务，加快测试周期，提升测试覆盖率，从而更早地发现缺陷和问题。这不仅提高了软件的稳定性和可靠性，还降低了维护成本，并为创新和功能增强提供了更多的时间和资源。</p>
<p>在众多自动化测试工具中，Playwright以其创新的特性和强大的功能，迅速在前端测试领域崭露头角。作为一个由微软开发的开源项目，Playwright支持所有现代Web浏览器，包括Chromium、WebKit和Firefox，并能够在Windows、Linux和macOS上运行。它提供了统一的API来实现跨浏览器的测试，这意味着开发者可以编写一次测试脚本，就能在所有支持的浏览器和平台上运行，无需为每个浏览器单独编写或调整测试用例。</p>
<p>Playwright的自动等待机制、丰富的API、以及对现代Web特性的全面支持，使其成为了前端自动化测试的强大工具。它不仅简化了测试脚本的编写和维护，还提高了测试的准确性和可靠性。此外，Playwright的并行测试执行能力也极大地提高了测试的效率，使其成为现代Web应用开发中不可或缺的一部分。随着越来越多的企业和开发者采用Playwright，它的影响力在前端测试领域不断增强，正逐渐成为自动化测试的新标准。</p>
<h3 data-id="heading-1">对比</h3>





















































<table><thead><tr><th>特性</th><th>Playwright</th><th>Selenium</th><th>备注</th></tr></thead><tbody><tr><td>浏览器支持</td><td>支持Chromium、WebKit和Firefox</td><td>支持Chrome、Firefox、Safari、IE等</td><td>Playwright支持所有现代渲染引擎</td></tr><tr><td>跨平台测试</td><td>支持Windows、Linux和macOS</td><td>支持Windows、Linux和macOS</td><td>Playwright提供更一致的跨平台体验</td></tr><tr><td>安装和配置</td><td>自动安装浏览器和驱动</td><td>需要手动下载和配置WebDriver</td><td>Playwright简化了安装和配置过程</td></tr><tr><td>社区和文档</td><td>较新的工具，但社区活跃</td><td>长期存在，拥有庞大的社区支持</td><td>Selenium的社区和文档资源更丰富</td></tr><tr><td>高级功能</td><td>支持无头测试、网络请求拦截等</td><td>支持分布式测试、多种定位方式</td><td>Playwright提供了一些Selenium没有的高级功能</td></tr><tr><td>语言支持</td><td>TypeScript、JavaScript、Python、.NET、Java</td><td>Java、Python、JavaScript、C#等</td><td>两者都支持多种编程语言</td></tr><tr><td>API设计</td><td>简洁而强大</td><td>相对老派，支持多种语言</td><td>Playwright的API更现代化，易于使用</td></tr></tbody></table>
<p>讨论Playwright的API设计，如何支持开发者编写简洁而强大的测试脚本。</p>
<h3 data-id="heading-2">安装</h3>
<p>安装Node.js和npm，Playwright需要Node.js环境，因此首先需要确保你的系统上安装了Node.js和npm。可以从Node.js官网下载并安装。node.js和npm安装忽略，默认为已安装，如有需要安装node.js和npm可联系支持。</p>
<ul>
<li>全局安装Playwright</li>
</ul>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> -D playwright
</code></pre>
<ul>
<li>安装浏览器<br/>
Playwright自带Chromium，Firefox和WebKit浏览器，无需单独下载驱动程序。安装Playwright时，浏览器也会自动安装。</li>
</ul>
<pre><code class="hljs">playwright install
</code></pre>
<h3 data-id="heading-3">配置</h3>
<p>初始化Playwright项目<br/>
如果你的项目是一个新项目，可以使用以下命令来生成配置文件和安装必要的依赖项。</p>
<pre><code class="hljs">npx playwright install
</code></pre>
<h3 data-id="heading-4">Demo</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">const</span> { chromium } = require(<span class="hljs-string">'playwright'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> chromium.launch();
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.newPage();
  <span class="hljs-keyword">await</span> page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">'https://www.baidu.com'</span>);
  <span class="hljs-comment">// 添加你的测试操作...</span>
  <span class="hljs-keyword">await</span> browser.close();
})();
</code></pre>
<h3 data-id="heading-5">运行测试</h3>
<pre><code class="hljs language-bash" lang="bash">npx playwright <span class="hljs-built_in">test</span>
</code></pre>
<h3 data-id="heading-6">常用API</h3>
<ul>
<li>发送get请求</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { request } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'playwright'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 创建一个新的API请求上下文</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">newContext</span>();

  <span class="hljs-comment">// 发送GET请求</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">get</span>(url, {
    <span class="hljs-attr">headers</span>: {
{      <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer "</span>}
    },
    <span class="hljs-attr">params</span>: {
      <span class="hljs-attr">query</span>: <span class="hljs-string">'value'</span>
    }
  });

  <span class="hljs-comment">// 检查响应状态</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">ok</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Response:'</span>, <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>());
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, response.<span class="hljs-title function_">status</span>());
  }

  <span class="hljs-comment">// 释放上下文资源</span>
  <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">dispose</span>();
})();
</code></pre>
<ul>
<li>发送post请求</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { request } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'playwright'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 创建一个新的API请求上下文</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">newContext</span>();

  <span class="hljs-comment">// 定义POST请求的URL和数据</span>
  <span class="hljs-keyword">const</span> url = xxx;
  <span class="hljs-keyword">const</span> data = {
    <span class="hljs-attr">key1</span>: <span class="hljs-string">'value1'</span>,
    <span class="hljs-attr">key2</span>: <span class="hljs-string">'value2'</span>
  };

  <span class="hljs-comment">// 发送POST请求</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">post</span>(url, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-comment">// 如果需要身份验证</span>
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer '</span>
    },
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) <span class="hljs-comment">// 对于JSON数据，需要将对象转换为字符串</span>
  });

  <span class="hljs-comment">// 检查响应状态</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">ok</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Response:'</span>, <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()); <span class="hljs-comment">// 假设响应内容是JSON格式</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, response.<span class="hljs-title function_">status</span>());
  }

  <span class="hljs-comment">// 释放上下文资源</span>
  <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">dispose</span>();
})();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 终于出手了：彻底终结 useEffect 的"闭包陷阱"]]></title>    <link>https://juejin.cn/post/7594276252459024394</link>    <guid>https://juejin.cn/post/7594276252459024394</guid>    <pubDate>2026-01-12T08:12:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594276252459024394" data-draft-id="7594270467029680155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 终于出手了：彻底终结 useEffect 的&quot;闭包陷阱&quot;"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-12T08:12:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 终于出手了：彻底终结 useEffect 的"闭包陷阱"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T08:12:22.000Z" title="Mon Jan 12 2026 08:12:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>译注</strong>：本文翻译自 LogRocket 博客，原文作者 Jack Herrington，发布于 2025 年 1 月 7 日。
原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-has-finally-solved-its-biggest-problem-useeffectevent%2F" target="_blank" title="https://blog.logrocket.com/react-has-finally-solved-its-biggest-problem-useeffectevent/" ref="nofollow noopener noreferrer">React has finally solved its biggest problem: The joys of useEffectEvent</a></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">React 终于解决了它最大的问题：useEffectEvent 的妙用</h2>
<p>如果问你 React 最大的 bug 来源是什么，你会说什么？大多数人都会说 <code>useEffect</code>。这个名字很奇怪的 Hook 允许你执行异步工作，这很好，但也会导致很多问题。特别是无限循环——我们一直在从服务器获取数据时遇到这个问题。</p>
<p>React 团队看到了这个问题，他们想出了一个新的 Hook 叫 <code>useEffectEvent</code>。我知道这个名字很绕口，但当涉及到稳定你的 React 应用时，它是一个救命稻草。</p>
<p>让我带你经历一个非常常见的问题。我们将从今天拥有的 Hooks 开始，这样我们可以看到问题，然后我将展示 <code>useEffectEvent</code> 如何修复它。</p>
<h3 data-id="heading-1">为什么这很重要：Cloudflare 的 useEffect 事故</h3>
<p>Cloudflare 是全球最大的部署提供商之一，他们有一个优秀的工程团队。但即使他们在 useEffect 方面也犯了错误。之前，他们在错误地将一个对象放入依赖数组时，等于对自己的仪表板发起了分布式拒绝服务攻击（DDoS）。该对象在每次重新渲染时改变其引用标识，导致无限循环，搞垮了整个仪表板。</p>
<p>这是一个尴尬的错误，但太容易犯了。这就是为什么 React 编译器和 <code>useEffectEvent</code> 这样的新 Hooks 如此重要。在编译器的情况下，它们稳定对象引用，有助于减少围绕对象标识的潜在 bug。<code>useEffectEvent</code> 则完全从依赖数组中移除对象！</p>
<h3 data-id="heading-2">搭建场景</h3>
<p>这是一个具有可编辑用户名的简单组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyUserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [userName, setUserName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"Bob"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{userName}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(evt)</span> =&gt;</span> setUserName(evt.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>到目前为止一切顺利；我们可以更改用户名。现在假设我们想要追踪用户已登录多长时间，然后显示它：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyUserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [userName, setUserName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"Bob"</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> loggedInTime = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      loggedInTime++;
    }, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{userName}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(evt)</span> =&gt;</span> setUserName(evt.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>我们添加了一个 <code>useEffect</code>，在组件挂载时设置一个计时器来追踪此人登录的秒数。（是的，我知道这不是真正的登录；这是演示代码。）</p>
<p>现在这段代码实际上运行正常，没有 bug。它仅在组件挂载时运行一次，因为有一个空的依赖数组。它通过返回一个清理函数来清理自己，该函数清除间隔，从而杀死计时器。</p>
<p>但在功能方面，它实际上不起作用，因为我们没有在任何地方显示那个数字。为了修复这个问题，让我们添加一个 <code>loginMessage</code> 字符串，我们可以用它来显示那个数字：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyUserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [userName, setUserName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"Bob"</span>);
  <span class="hljs-keyword">const</span> [loginMessage, setLoginMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> loggedInTime = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      loggedInTime++;
      <span class="hljs-title function_">setLoginMessage</span>(
        <span class="hljs-string">`<span class="hljs-subst">${userName}</span> has been logged in for <span class="hljs-subst">${loggedInTime}</span> seconds`</span>
      );
    }, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{loginMessage}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{userName}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(evt)</span> =&gt;</span> setUserName(evt.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>现在这段代码看起来应该可以工作。实际上，它多少有点有效。开始时，它说"Bob 已登录 1 秒"。然后它每秒忠实地往前走。巨大的成功！</p>
<h3 data-id="heading-3">过期闭包问题</h3>
<p>哎呀，实际上有一个 bug。因为我们发送给 <code>useEffect</code> 的函数可能会"过期"。</p>
<p>如果我更改用户名会发生什么？好的，<code>input</code> 会改变，但登录消息仍然说用户名是"Bob"。但不是；我们改变了它。</p>
<p>所以我们发送给 <code>useEffect</code> 的函数已经创建了一个"闭包"，它在当时以当前值（"Bob"）捕获了 <code>userName</code> 的值。它永远不会改变。因为它现在与实际值不同步，我们会认为它是"过期的"。那意味着我们有一个"过期闭包"（stale closure）。</p>
<p>好消息是，React 对此有一个修复（这不是 <code>useEffectEvent</code>，请耐心等待）。我们可以将 <code>userName</code> 添加到依赖数组中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> loggedInTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    loggedInTime++;
    <span class="hljs-title function_">setLoginMessage</span>(
      <span class="hljs-string">`<span class="hljs-subst">${userName}</span> has been logged in for <span class="hljs-subst">${loggedInTime}</span> seconds`</span>
    );
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, [userName]);
</code></pre>
<p>成功了！现在当我们编辑 <code>userName</code> 时，登录消息会改变！太棒了。哦，等等。什么？每次我们进行更改时，登录时间都会重新开始为 1 秒。</p>
<p>啊，所以每次我们创建一个带有新 <code>userName</code> 值的新闭包时，我们都会杀死旧计时器（这很好）。但我们也创建了一个新的 <code>loggedInTime</code> 并再次从零开始。这绝对不好。</p>
<p>我明白一个简单的修复方法是追踪 <code>loggedInTime</code> 状态并在 JSX 中格式化字符串。好的。但让我们假设我们做不到。</p>
<h3 data-id="heading-4">useRef 来救援</h3>
<p>我们怎样才能解决这个问题？好吧，在 <code>useEffectEvent</code> 之前，我们可能会使用 ref：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nameRef = <span class="hljs-title function_">useRef</span>(userName);
nameRef.<span class="hljs-property">current</span> = userName;

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> loggedInTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    loggedInTime++;
    <span class="hljs-title function_">setLoginMessage</span>(
      <span class="hljs-string">`<span class="hljs-subst">${nameRef.current}</span> has been logged in for <span class="hljs-subst">${loggedInTime}</span> seconds`</span>
    );
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);
</code></pre>
<p>这里我们做了几件事。首先，我们创建了一个 ref，其中存储了 <code>userName</code> 的当前值，我们在每次渲染时更新当前值。在渲染期间设置 ref 的 <code>current</code> 值是可以的，因为 React 不像监控状态那样监控 refs。</p>
<p>接下来，我们在模板字符串中使用 <code>nameRef.current</code> 而不是 <code>userName</code>，所以我们总是获得 <code>userName</code> 的当前值，因为它在每次渲染时更新。最后，我们从依赖数组中移除了 <code>userName</code>，这解决了重置 bug。</p>
<p>现在它实际上有效。没有注意事项！除了，它有点笨重，这就是 <code>useEffectEvent</code> 的用武之地。</p>
<h3 data-id="heading-5">useEffectEvent 好得多</h3>
<p>看看这个版本：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> getName = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">() =&gt;</span> userName);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> loggedInTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    loggedInTime++;
    <span class="hljs-title function_">setLoginMessage</span>(
      <span class="hljs-string">`<span class="hljs-subst">${getName()}</span> has been logged in for <span class="hljs-subst">${loggedInTime}</span> seconds`</span>
    );
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);
</code></pre>
<p>我们使用新的 <code>useEffectEvent</code> Hook 创建一个 getter 函数，它返回 <code>userName</code> 的当前值。它可以在 <code>useEffect</code> 中被调用，它永远不会过期。它真的很干净。比 <code>useRef</code> 版本干净和清晰得多。</p>
<p>但实际上还能变得更好，因为它允许我们更一般地思考 <code>useEffect</code>。我是说，如果你想一想，我们多少有一个更通用的"计时器" <code>useEffect</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> onTick = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">(<span class="hljs-params">tick: number</span>) =&gt;</span>
  <span class="hljs-title function_">setLoginMessage</span>(<span class="hljs-string">`<span class="hljs-subst">${userName}</span> has been logged in for <span class="hljs-subst">${tick}</span> seconds`</span>)
);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> ticks = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onTick</span>(++ticks), <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);
</code></pre>
<p>现在我们已将所有状态相关的内容移到 <code>useEffectEvent</code> 中。看看我们的 <code>useEffect</code> 变得多干净了？<code>useEffect</code> 只处理计时器。<code>onTick</code> 处理该计时器的所有逻辑。</p>
<h3 data-id="heading-6">useEffectEvent 是游戏规则改变者</h3>
<p>更好的是，<code>useEffect</code> 对状态没有依赖。而状态依赖正是 <code>useEffect</code> 陷入困境的地方（如我们所见）。依赖于错误状态的坏依赖数组会导致过期闭包问题、无效重置或甚至无限循环。<code>useEffectEvent</code> 允许我们从依赖数组中移除状态。这帮助我们编写更好的 <code>useEffects</code>。</p>
<p>我们甚至可以将其变成自定义 Hook，使其更通用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">onTick: (tick: number) =&gt; <span class="hljs-keyword">void</span></span>) {
  <span class="hljs-keyword">const</span> onTickEvent = <span class="hljs-title function_">useEffectEvent</span>(onTick);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> ticks = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onTickEvent</span>(++ticks), <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, []);
}
</code></pre>
<p>现在我们有了一个完整的 <code>useInterval</code> 实现，它非常干净且无 bug。</p>
<h3 data-id="heading-7">一个小挑战</h3>
<p>如果你想要一个有趣的小挑战：你将如何实现一个版本，其中毫秒数（目前是 1000）是可调整的？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">onTick: (tick: number) =&gt; <span class="hljs-keyword">void</span>, timeout: number = <span class="hljs-number">1000</span></span>) {
  <span class="hljs-comment">// ????</span>
}
</code></pre>
<p>我采取的方法这次有点不同。不是 <code>setInterval</code>，我使用 <code>setTimeout</code> 并在每次迭代中调整超时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">onTick: (tick: number) =&gt; <span class="hljs-keyword">void</span>, timeout: number = <span class="hljs-number">1000</span></span>) {
  <span class="hljs-keyword">const</span> onTickEvent = <span class="hljs-title function_">useEffectEvent</span>(onTick);
  <span class="hljs-keyword">const</span> getTimeout = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">() =&gt;</span> timeout);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> ticks = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> mounted = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onTick</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (mounted) {
        <span class="hljs-title function_">onTickEvent</span>(++ticks);
        <span class="hljs-built_in">setTimeout</span>(onTick, <span class="hljs-title function_">getTimeout</span>());
      }
    }
    <span class="hljs-built_in">setTimeout</span>(onTick, <span class="hljs-title function_">getTimeout</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      mounted = <span class="hljs-literal">false</span>;
    };
  }, []);
}
</code></pre>
<p>让我知道你是否能够优化这个。</p>
<h3 data-id="heading-8">结论：带安全带的 React</h3>
<p>React 团队承认了 <code>useEffect</code> 代码失控运行的问题。他们不仅承认了这一点，还用像编译器和 <code>useEffectEvent</code> 这样的新功能创造了优雅的解决方案，让你可以安全可靠地编写 React 代码。</p>
<p>不要听信反对者的声音——React 并没有停滞不前，它还在进化，而且在大多数情况下，变得更好。</p>
<hr/>
<h3 data-id="heading-9">译者补充</h3>
<p>翻译这篇文章是因为它把 <code>useEffect</code> 依赖数组的痛点讲得很透彻。Cloudflare 的例子不是危言耸听，我自己也遇到过类似的问题——一个看起来无害的对象放进依赖数组，结果页面卡死。</p>
<p>关于 <code>useEffectEvent</code>，补充几点：</p>
<p><strong>现状</strong>：好消息是，<code>useEffectEvent</code> 在 React 19.2（2025 年 10 月发布）中已经是<strong>稳定 API</strong> 了，可以直接使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffectEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<p>如果你还在用 React 19.2 之前的版本，需要用实验前缀：<code>experimental_useEffectEvent</code>。升级到 19.2+ 后记得去掉前缀。</p>
<p>另外，ESLint 插件也需要升级到 <code>eslint-plugin-react-hooks@6</code>，这样 linter 才能正确识别 <code>useEffectEvent</code> 返回的函数不需要加入依赖数组。</p>
<p><strong>原理是什么</strong>：要理解 <code>useEffectEvent</code>，得先明白过期闭包是怎么产生的。</p>
<p>JavaScript 的函数会"记住"创建时的词法环境，这就是闭包。当你写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userName); <span class="hljs-comment">// 闭包捕获了 userName</span>
}, []);
</code></pre>
<p>这个箭头函数在第一次渲染时创建，它捕获的 <code>userName</code> 是当时的值。由于依赖数组是空的，这个函数不会重新创建，所以它永远只能访问到旧值。</p>
<p><code>useRef</code> 的解决思路是：不让闭包直接捕获值，而是捕获一个"容器"（ref），然后每次渲染时更新容器里的内容：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nameRef = <span class="hljs-title function_">useRef</span>(userName);
nameRef.<span class="hljs-property">current</span> = userName; <span class="hljs-comment">// 每次渲染都更新</span>

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nameRef.<span class="hljs-property">current</span>); <span class="hljs-comment">// 闭包捕获的是 ref 对象，读取时拿到最新值</span>
}, []);
</code></pre>
<p><strong><code>useEffectEvent</code> 本质上是 React 帮你做了这套事情</strong>，但更优雅：</p>
<ol>
<li>它返回的函数<strong>引用是稳定的</strong>——每次渲染返回的都是同一个函数对象，所以不需要加入依赖数组</li>
<li>但这个函数<strong>内部能访问到最新的 props/state</strong>——React 在内部维护了一个类似 ref 的机制，每次渲染时更新函数要访问的值</li>
</ol>
<p>你可以把它理解为 React 官方提供的 <code>useRef</code> + "自动同步" 的封装，只是语义更清晰：这是一个"事件"，它描述的是"发生某事时要做什么"，而不是 effect 本身的逻辑。</p>
<p><strong>什么时候用</strong>：文章里的例子是计时器，但更常见的场景是埋点。比如页面加载时发送一次埋点，埋点数据里有用户信息、页面参数等。这些数据可能会变，但你不希望它们变化时重新触发埋点——这正是 <code>useEffectEvent</code> 的典型用例。</p>
<p><strong>还没升级 React 19 怎么办</strong>：如果项目还在 React 18，文章里的 <code>useRef</code> 方案是靠谱的。社区也有一些封装好的 Hook，比如 ahooks 的 <code>useMemoizedFn</code>，思路类似。</p>
<p><strong>配合 React Compiler</strong>：React Compiler 能自动推断依赖，配合 <code>useEffectEvent</code> 效果更好。两者都是 React 团队为了解决 <code>useEffect</code> 心智负担而推出的方案，可以关注一下这个组合。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768810342&amp;x-signature=54h7uHFgWbKggKJxYtVI2qUgJSs%3D" alt="coding-cli-guide" loading="lazy"/></li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app实现网络离线定位]]></title>    <link>https://juejin.cn/post/7593892837898747919</link>    <guid>https://juejin.cn/post/7593892837898747919</guid>    <pubDate>2026-01-12T06:43:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593892837898747919" data-draft-id="7594051966888902691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app实现网络离线定位"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2026-01-12T06:43:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app实现网络离线定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T06:43:54.000Z" title="Mon Jan 12 2026 06:43:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>熟悉的朋友知道我最近一段时间在搞安卓方面的内容，使用uni-app开发的这段时间总算是体会到了网上兄弟们的心声。</p>
<p>怎么说呢？<strong>难以言喻</strong>！</p>
<p>想要无能狂怒的叱骂，却又不得不默默的翻看API文档一点点的摸索，找到解决之路的那一刻，不亚于我买双色球中<strong>五块钱</strong>大奖的那天心情。</p>
<p>最近需要用uni-app实现一下定位的问题，其实就是获取经纬度，然后通过 MQTT 发送到服务器上。（关于MQTT部分详见上文 <a href="https://juejin.cn/post/7593165280488931369" target="_blank" title="https://juejin.cn/post/7593165280488931369"># uni-app实现本地MQTT连接</a>）</p>
<p>接到这个需求的时候感觉非常简单，因为 uni-app 本身就有定位的API。</p>
<pre><code class="hljs language-js" lang="js">uni.<span class="hljs-title function_">getLocation</span>({
	<span class="hljs-attr">type</span>: <span class="hljs-string">'wgs84'</span>,
	<span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) {
		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前位置的经度：'</span> + res.<span class="hljs-property">longitude</span>);
		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前位置的纬度：'</span> + res.<span class="hljs-property">latitude</span>);
	}
});
</code></pre>
<p>一段代码搞定问题，但是，项目那边突然传来消息说：<strong>定位不到</strong>。</p>
<p>我这边使用 <strong>Trae</strong> 紧急排查，但是却没发现任何问题，<strong>Trae</strong> 也表示系统运行非常稳定。</p>
<p>但是项目现场就是反馈定位不到，一下午的时间 <strong>Trae</strong> 建议我排查了设备本身、安卓版本、代码语法、打包过程等等。经过一下午的排查终于确定了原因是"<strong>没联网</strong>"。</p>
<p>气得我当场怒骂...</p>
<p>现在需求确定清楚了：<strong>离线定位</strong>。</p>
<p>这里需要注意一点，虽然设备不接入网络，但事实定位本身是依赖于接收卫星信号。也就是说，没网可以，但是设备必须有<strong>GPS定位模块</strong>，否则是无法实现定位的。</p>
<p>首先在 <code>manifest.json</code> 文件中找到 <code>modules</code>，在下面添加 <code>Geolocation</code> 启用定位模块。</p>
<p>同时在 <code>distribute / android / permissions</code> 权限部分增加定位权限部分。</p>
<p>还需要在 SDK 配置部分增加定位内容。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"modules"</span> : {
    <span class="hljs-string">"Geolocation"</span> : {} <span class="hljs-comment">// 启用定位模块</span>
},
<span class="hljs-comment">/* 应用发布信息 */</span>
<span class="hljs-string">"distribute"</span> : {
    <span class="hljs-comment">/* android打包配置 */</span>
    <span class="hljs-string">"android"</span> : {
        <span class="hljs-string">"permissions"</span> : [
            ...
            <span class="hljs-string">"&lt;uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/&gt;"</span>,
            <span class="hljs-string">"&lt;uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/&gt;"</span>
        ]
    },
},
<span class="hljs-comment">/* SDK配置 */</span>
<span class="hljs-string">"sdkConfigs"</span> : {
    <span class="hljs-string">"geolocation"</span> : {
        <span class="hljs-string">"system"</span> : {
            <span class="hljs-string">"__platform__"</span> : [ <span class="hljs-string">"android"</span> ]
        }
    }
}
</code></pre>
<p>我在网上找到的方案是仍然使用 uni-app 的 <code>getLocation</code> 方法，将请求方式改为 <code>gcj02</code> 的方式。</p>
<pre><code class="hljs language-js" lang="js">uni.<span class="hljs-title function_">getLocation</span>({
	<span class="hljs-attr">type</span>: <span class="hljs-string">'gcj02'</span>,
	<span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) {
		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前位置的经度：'</span> + res.<span class="hljs-property">longitude</span>);
		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前位置的纬度：'</span> + res.<span class="hljs-property">latitude</span>);
	}
});
</code></pre>
<p>但是不知道为什么在我这个终端上这个写法并没有获取到定位信息，甚至代码都不走，多方排查也没有发现问题出在哪儿，遂放弃此方案。</p>
<p>在 <strong>Trae</strong> 的建议下改为使用 <code>html+</code> 的定位方案。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">testGetLocation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-comment">// #ifdef APP-PLUS</span>
    plus.<span class="hljs-property">geolocation</span>.<span class="hljs-title function_">getCurrentPosition</span>(
        <span class="hljs-function">(<span class="hljs-params">position</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'【定位成功】'</span>, position);
            that.<span class="hljs-property">location</span> = {
                <span class="hljs-attr">latitude</span>: position.<span class="hljs-property">coords</span>.<span class="hljs-property">latitude</span>,
                <span class="hljs-attr">longitude</span>: position.<span class="hljs-property">coords</span>.<span class="hljs-property">longitude</span>
            };
        },
        <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'【定位失败】'</span>, error);
            <span class="hljs-keyword">let</span> msg = <span class="hljs-string">'定位失败'</span>;
            <span class="hljs-keyword">switch</span> (error.<span class="hljs-property">code</span>) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    msg = <span class="hljs-string">'用户拒绝定位授权'</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    msg = <span class="hljs-string">'GPS 功能未开启'</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                    msg = <span class="hljs-string">'响应超时'</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-attr">default</span>:
                    msg = <span class="hljs-string">'未知错误'</span>;
            }
        }, {
            <span class="hljs-attr">provider</span>: <span class="hljs-string">'gps'</span>,    <span class="hljs-comment">// 强制使用 GPS 定位</span>
            <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>,     <span class="hljs-comment">// 最大30秒超时</span>
            <span class="hljs-attr">highAccuracy</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用高精度模式</span>
            <span class="hljs-attr">maximumAge</span>: <span class="hljs-number">0</span>       <span class="hljs-comment">// 不使用缓存位置</span>
        }
    );
    <span class="hljs-comment">// #endif</span>
},
</code></pre>
<p>采用这个方案成功获取到了定位信息，但是需要注意两个点：</p>
<ol>
<li>必须获得用户<strong>授权</strong>，尤其是在高版本安卓系统中。（本人采用的是安卓11及以下的设备）</li>
<li>设备尽量在<strong>户外</strong>使用（GPS定位在室内很容易定位不到）</li>
</ol>
<p>授权部分可以参考如下方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">getLocationSafely</span>(<span class="hljs-params">onSuccess, onError</span>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    plus.<span class="hljs-property">geolocation</span>.<span class="hljs-title function_">getCurrentPosition</span>(
        <span class="hljs-function">() =&gt;</span> {},
        <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">code</span> === <span class="hljs-number">4</span>) {
                <span class="hljs-comment">// 位置服务未开启</span>
                uni.<span class="hljs-title function_">showModal</span>({
                    <span class="hljs-attr">title</span>: <span class="hljs-string">'定位服务未开启'</span>,
                    <span class="hljs-attr">content</span>: <span class="hljs-string">'请前往系统设置开启位置信息，才能获取当前位置'</span>,
                    <span class="hljs-attr">showCancel</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-attr">confirmText</span>: <span class="hljs-string">'去设置'</span>,
                    <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) {
                            <span class="hljs-comment">// 跳转到系统设置</span>
                            plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openURL</span>(<span class="hljs-string">'package:com.android.settings'</span>);
                        }
                    }
                });
                onError?.(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'系统定位未开启'</span>));
                <span class="hljs-keyword">return</span>;
            }
        }, {
            <span class="hljs-comment">// 3秒超时</span>
            <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>
        }
    );
},
</code></pre>
<p>还需要注意的一个点是如果采用<strong>自定义基座</strong>，一定要记得将<strong>定位模块</strong>云打包到基座中，否则也是无法定位的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再搞混了！127.0.0.1 和 localhost 背后的秘密]]></title>    <link>https://juejin.cn/post/7593943464052981770</link>    <guid>https://juejin.cn/post/7593943464052981770</guid>    <pubDate>2026-01-12T01:21:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593943464052981770" data-draft-id="7593943464052965386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再搞混了！127.0.0.1 和 localhost 背后的秘密"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-12T01:21:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有追求的开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1310273591851159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再搞混了！127.0.0.1 和 localhost 背后的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273591851159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有追求的开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T01:21:01.000Z" title="Mon Jan 12 2026 01:21:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    72
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再搞混了！127.0.0.1 和 localhost 背后的秘密</h2>
<p>作为一名 <strong>软件开发者</strong>，你可能在开发过程中无数次使用过<code>127.0.0.1</code>和<code>localhost</code>。它们看起来似乎是同一个东西的不同写法，但当面试官抛出这个问题时，你能清晰地说出它们的区别吗？</p>
<p>这个看似简单的问题，实际上涉及了网络协议、DNS 解析、操作系统底层机制等多个知识点。让我们深入探讨一下。</p>
<h3 data-id="heading-1">一、本质区别：IP 地址 vs 主机名</h3>
<p>首先要明确的是，<code>127.0.0.1</code>和<code>localhost</code>在本质上属于不同的概念：</p>
<p><strong>127.0.0.1</strong>是一个实实在在的 IPv4 地址，属于回环地址（Loopback Address）的一部分。整个<code>127.0.0.0/8</code>网段（即 127.0.0.1 到 127.255.255.254）都被保留用于回环测试，但我们最常用的就是<code>127.0.0.1</code>。</p>
<p><strong>localhost</strong>则是一个主机名（hostname），它是一个需要通过 DNS 解析或者本地 hosts 文件映射才能转换为 IP 地址的符号名称。就像<code>www.google.com</code>需要解析为具体的 IP 地址一样，<code>localhost</code>也需要这个过程。</p>
<p>打个比方，<code>127.0.0.1</code>就像是你家的 GPS 坐标，而<code>localhost</code>则是"我家"这个称呼。坐标是固定的、明确的，但"我家"这个称呼需要先知道它指向哪个坐标才能找到。</p>
<h3 data-id="heading-2">二、DNS 解析：一个额外的步骤</h3>
<p>当你在浏览器中输入<code>http://localhost:8000</code>时，操作系统会进行以下步骤：</p>
<ol>
<li>检查本地 hosts 文件（在 Linux/Mac 是<code>/etc/hosts</code>，Windows 是<code>C:\Windows\System32\drivers\etc\hosts</code>）</li>
<li>查找<code>localhost</code>对应的 IP 地址</li>
<li>通常会找到类似这样的配置：</li>
</ol>
<pre><code class="hljs language-makefile" lang="makefile">127.0.0.1       localhost
<span class="hljs-section">::1             localhost</span>
</code></pre>
<ol start="4">
<li>将<code>localhost</code>解析为<code>127.0.0.1</code>（IPv4）或<code>::1</code>（IPv6）</li>
<li>最后使用解析出的 IP 地址建立连接</li>
</ol>
<p>而当你直接使用<code>http://127.0.0.1:8000</code>时，操作系统会跳过 DNS 解析步骤，直接使用这个 IP 地址建立连接。</p>
<p>这意味着什么？在性能上，直接使用 IP 地址会略微快一点点（虽然这个差异在本地回环中几乎可以忽略不计）。但更重要的是，如果你的 hosts 文件被修改或损坏，<code>localhost</code>可能无法正常解析，而<code>127.0.0.1</code>依然可以正常工作。</p>
<h3 data-id="heading-3">三、网络协议层面的差异</h3>
<p>让我们从 OSI 七层模型或 TCP/IP 四层模型的角度来看这个问题：</p>
<p><strong>使用 127.0.0.1 时的数据流向：</strong></p>
<ul>
<li>应用层：你的 Python Flask 应用发送 HTTP 请求</li>
<li>传输层：TCP 协议处理端口和连接</li>
<li>网络层：IP 协议发现目标是<code>127.0.0.1</code>，识别为回环地址</li>
<li>数据包直接在网络层被回环，不经过数据链路层和物理层</li>
<li>数据不会真正发送到网卡，而是在内核中被路由回来</li>
</ul>
<p><strong>使用 localhost 时的数据流向：</strong></p>
<ul>
<li>首先在应用层需要经过域名解析（这实际上涉及到应用层的 DNS 协议，虽然在本地是查询 hosts 文件）</li>
<li>解析完成后，流程与上面相同</li>
</ul>
<p>关键点在于：无论使用哪个，数据包都不会真正离开你的计算机，不会经过物理网卡，所以你可以在断网的情况下正常使用它们。</p>
<h3 data-id="heading-4">四、IPv4 与 IPv6 的考量</h3>
<p>这是一个很多开发者容易忽略的细节：</p>
<p>当你使用<code>localhost</code>时，根据系统配置和应用程序的实现，它可能被解析为：</p>
<ul>
<li><code>127.0.0.1</code>（IPv4）</li>
<li><code>::1</code>（IPv6）</li>
<li>或者两者都尝试</li>
</ul>
<p>例如在 Python 中：</p>
<pre><code class="hljs language-perl" lang="perl">import <span class="hljs-keyword">socket</span>

<span class="hljs-comment"># 这可能返回IPv4或IPv6地址，取决于系统配置</span>
socket.getaddrinfo(<span class="hljs-string">'localhost'</span>, <span class="hljs-number">8000</span>)

<span class="hljs-comment"># 这明确使用IPv4</span>
socket.getaddrinfo(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">8000</span>)
</code></pre>
<p>如果你的应用程序只监听 IPv4 地址（比如在 Flask 中使用<code>app.run(host='127.0.0.1')</code>），而系统将<code>localhost</code>解析为 IPv6 的<code>::1</code>，连接就会失败。这是很多初学者遇到的"明明程序在运行，但就是连不上"的常见原因之一。</p>
<h3 data-id="heading-5">五、安全性考虑</h3>
<p>从安全角度来说，两者也有细微差别：</p>
<p>使用<code>127.0.0.1</code>时，你明确知道流量只会在本地回环，不会有任何可能被错误路由到外部网络的风险。</p>
<p>而<code>localhost</code>依赖于本地解析配置，理论上存在被篡改的可能性（虽然这需要攻击者已经获得了修改 hosts 文件的权限）。在一些安全要求极高的场景中，直接使用 IP 地址会更保险。</p>
<h3 data-id="heading-6">六、实际使用场景推荐</h3>
<p>那么在实际开发中，应该如何选择呢？</p>
<p><strong>推荐使用 localhost 的场景：</strong></p>
<ol>
<li><strong>开发环境的配置文件</strong>：使用<code>localhost</code>让配置更具可读性，也便于将来可能的 IPv6 迁移</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">DATABASE_URL</span> = <span class="hljs-string">"postgresql://user:password@localhost:5432/mydb"</span>
</code></pre>
<ol start="2">
<li><strong>文档和教程</strong>：对初学者更友好，含义一目了然</li>
<li><strong>需要兼容 IPv6 的场景</strong>：让系统自动选择合适的 IP 版本</li>
</ol>
<p><strong>推荐使用 127.0.0.1 的场景：</strong></p>
<ol>
<li><strong>明确需要 IPv4 的场景</strong>：避免 IPv6 相关的歧义</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">app.run(<span class="hljs-attr">host</span>=<span class="hljs-string">'127.0.0.1'</span>, port=<span class="hljs-number">5000</span>)
</code></pre>
<ol start="2">
<li><strong>性能敏感的场景</strong>：虽然差异微乎其微，但跳过解析步骤在理论上更快</li>
<li><strong>排查网络问题</strong>：当怀疑 DNS 或 hosts 配置有问题时，直接用 IP 可以排除这个变量</li>
<li><strong>防火墙或网络策略配置</strong>：使用明确的 IP 地址避免歧义</li>
</ol>
<h3 data-id="heading-7">七、一个实际的 Python 示例</h3>
<p>让我们用代码来演示这些差异：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connection</span>(<span class="hljs-params">host, port=<span class="hljs-number">8000</span></span>):
    start = time.time()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 获取地址信息</span>
        addr_info = socket.getaddrinfo(host, port)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{host}</span> 解析结果:"</span>)
        <span class="hljs-keyword">for</span> info <span class="hljs-keyword">in</span> addr_info:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  地址族: <span class="hljs-subst">{info[<span class="hljs-number">0</span>]}</span>, 地址: <span class="hljs-subst">{info[<span class="hljs-number">4</span>]}</span>"</span>)

        <span class="hljs-comment"># 尝试连接</span>
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        sock.close()

        elapsed = time.time() - start
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接成功，耗时: <span class="hljs-subst">{elapsed*<span class="hljs-number">1000</span>:<span class="hljs-number">.2</span>f}</span>ms"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接失败: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 先启动一个简单的服务器</span>
<span class="hljs-keyword">from</span> http.server <span class="hljs-keyword">import</span> HTTPServer, BaseHTTPRequestHandler

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleHandler</span>(<span class="hljs-title class_ inherited__">BaseHTTPRequestHandler</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_GET</span>(<span class="hljs-params">self</span>):
        self.send_response(<span class="hljs-number">200</span>)
        self.end_headers()
        self.wfile.write(<span class="hljs-string">b"Hello!"</span>)

<span class="hljs-comment"># 在另一个终端运行: python -m http.server 8000</span>
<span class="hljs-comment"># 然后测试</span>

test_connection(<span class="hljs-string">'localhost'</span>, <span class="hljs-number">8000</span>)
test_connection(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">8000</span>)
</code></pre>
<h3 data-id="heading-8">八、常见陷阱和调试技巧</h3>
<p>最后，分享几个与这个主题相关的常见陷阱：</p>
<p><strong>陷阱 1：监听地址错误</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 只监听127.0.0.1，从其他机器无法访问</span>
app.run(<span class="hljs-attr">host</span>=<span class="hljs-string">'127.0.0.1'</span>)

<span class="hljs-comment"># 监听所有地址，包括外部网络</span>
app.run(<span class="hljs-attr">host</span>=<span class="hljs-string">'0.0.0.0'</span>)
</code></pre>
<p><strong>陷阱 2：Docker 容器中的 localhost</strong> 在 Docker 容器中，<code>localhost</code>指向的是容器本身，而不是宿主机。如果要访问宿主机的服务，需要使用特殊地址如<code>host.docker.internal</code>。</p>
<p><strong>陷阱 3：IPv6 优先导致的连接失败</strong> 某些系统默认优先使用 IPv6，如果服务只监听 IPv4，就会出现连接问题。可以通过修改<code>/etc/gai.conf</code>来调整优先级。</p>
<h3 data-id="heading-9">总结</h3>
<p>回到最初的面试问题：<code>127.0.0.1</code>和<code>localhost</code>的区别是什么？</p>
<p>简短回答：<code>127.0.0.1</code>是一个 IP 地址，<code>localhost</code>是一个需要解析的主机名。两者在大多数情况下功能相同，但在解析过程、IPv4/IPv6 支持、性能和明确性上有细微差别。</p>
<p>深入回答：它们代表了网络架构中不同层次的概念，涉及 DNS 解析、网络协议栈、IPv4/IPv6 兼容性等多个方面。在实际使用中，根据场景选择合适的方式可以避免一些潜在问题。</p>
<p>作为开发者，理解这些细节不仅能帮助你回答面试问题，更重要的是能在遇到网络相关问题时，快速定位和解决问题。下次当你的 Flask 应用突然连不上，或者 Docker 容器无法访问宿主机服务时，你就知道该从哪里入手调试了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>