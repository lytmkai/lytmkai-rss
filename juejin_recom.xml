<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 GORM 从零实现新服务]]></title>    <link>https://juejin.cn/post/7582786292087832627</link>    <guid>https://juejin.cn/post/7582786292087832627</guid>    <pubDate>2025-12-12T11:14:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786292087832627" data-draft-id="7582786292087816243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 GORM 从零实现新服务"/> <meta itemprop="keywords" content="后端,Go,ORM"/> <meta itemprop="datePublished" content="2025-12-12T11:14:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 GORM 从零实现新服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T11:14:44.000Z" title="Fri Dec 12 2025 11:14:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 GORM 从零实现新服务</h2>
<p>本文将指导开发者在 GoWind Admin 企业级前后端一体中后台框架中，从零开始构建一个完整的 gRPC 服务。我们所指的 “服务” 即 gRPC 中的 service，通常包含特定数据集的 CRUD（增删改查）操作，遵循框架规范实现高可维护性与可扩展性。</p>
<h3 data-id="heading-1">前置准备</h3>
<p>在开始前，请确保已完成以下环境准备：</p>
<h4 data-id="heading-2">开发环境</h4>
<ul>
<li>Go 1.19+（推荐 1.21+，支持最新语言特性）</li>
<li>Git（版本控制）</li>
<li>Protobuf 编译器（<code>protoc</code>，用于编译 proto 文件）</li>
</ul>
<h4 data-id="heading-3">依赖工具</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装相关的命令行工具</span>
make cli

<span class="hljs-comment"># 安装依赖的插件</span>
make plugin
</code></pre>
<h4 data-id="heading-4">项目结构</h4>
<p>克隆 GoWind Admin 项目后，核心目录结构如下（聚焦服务开发相关目录）：</p>
<pre><code class="hljs language-text" lang="text">go-wind-admin/
├── backend/
│   ├── api/gen/go/        # proto 编译生成的 Go 代码（自动生成，无需手动修改）
│   ├── api/proto/         # 存放 proto 接口定义文件
│   ├── app/admin/service/ # 业务服务核心实现
│   │   ├── internal/
│   │   │   ├── data/      # 数据访问层（与数据库交互，基于 ent）
│   │   │   │   └── gorm/   # GORM ORM 相关的代码
│   │   │   │       └── model/ # GORM 数据模型定义（核心）
│   │   │   └── service/   # 业务逻辑层（实现 gRPC 接口）
│   │   └── server/        # 服务注册（将服务绑定到 gRPC/HTTP 服务器）
</code></pre>
<h3 data-id="heading-5">一、设计数据库表结构</h3>
<p>数据库表结构是服务的基础，需根据业务需求设计核心字段。以 “用户表” 为例，需包含：</p>
<ul>
<li>通用字段：ID（主键）、创建时间、更新时间、创建者 ID、更新者 ID（用于审计）</li>
<li>业务字段：用户名（唯一）、密码、昵称、邮箱、手机号等</li>
<li>关联字段：角色 ID、部门 ID 等（用于关联其他表）</li>
<li>状态字段：用户状态（启用 / 禁用）、性别等枚举字段</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>核心字段非空（如用户名），非核心字段可空（如地址）</li>
<li>频繁查询的字段添加索引（如用户名）</li>
<li>敏感字段（如密码）需加密存储</li>
</ul>
<h3 data-id="heading-6">二、编写 GORM 数据模型</h3>
<p>GORM 是 Go 语言主流的 ORM 库，通过结构体 + 标签定义数据库模型，无需手动编写 SQL 或生成代码。模型文件位于 <code>backend/app/admin/service/internal/data/gorm/models</code> 目录。</p>
<p>步骤说明：</p>
<ol>
<li>创建 <code>user.go</code> 文件，定义 <code>User</code> 结构体作为核心模型；</li>
<li>通过 GORM 标签配置字段属性（主键、索引、非空、注释、字段类型等）；</li>
<li>实现 TableName 方法指定数据库表名；</li>
</ol>
<h4 data-id="heading-7">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/data/gorm/models/user.go</span>
<span class="hljs-keyword">package</span> models

<span class="hljs-keyword">import</span> <span class="hljs-string">"gorm.io/gorm"</span>

<span class="hljs-comment">// User 用户信息表</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
	gorm.Model

	UserName <span class="hljs-type">string</span> <span class="hljs-string">`gorm:"column:username;comment:'账号名'"`</span>
	NickName <span class="hljs-type">string</span> <span class="hljs-string">`gorm:"column:nickname;comment:'昵称'"`</span>
	Password <span class="hljs-type">string</span> <span class="hljs-string">`gorm:"column:password;comment:'登录密码'"`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u User)</span></span> TableName() <span class="hljs-type">string</span> {
	<span class="hljs-keyword">return</span> <span class="hljs-string">"users"</span>
}
</code></pre>
<h4 data-id="heading-8">表结构迁移：</h4>
<p>GORM 无需手动生成代码，只需在把数据库模型注册进 MigrateModel列表 即可实现自动创建 / 更新表结构（仅新增字段，不会删除已有字段，保证数据安全）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/data/gorm/init.go</span>
<span class="hljs-keyword">package</span> gorm

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/gorm/models"</span>

	<span class="hljs-string">"github.com/tx7do/go-crud/gorm"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
	RegisterMigrates()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterMigrates</span><span class="hljs-params">()</span></span> {
	gorm.RegisterMigrateModels(
		&amp;models.User{},
	)
}
</code></pre>
<p>然后我们在<code>backend/app/admin/service/internal/data/gorm_client.go</code>里面引用执行<code>init()</code>方法即可实现自动创建更新表结构：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/data/gorm_client.go</span>
<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
    	_ <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/gorm"</span>
)
</code></pre>
<h3 data-id="heading-9">三、编写 gRPC 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 gRPC 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/user/service/v1</code> 目录。</p>
<h4 data-id="heading-10">步骤说明：</h4>
<ol>
<li>定义服务接口（<code>service UserService</code>），包含 CRUD 方法（如 <code>CreateUser</code>、<code>ListUser</code>）。</li>
<li>定义请求 / 响应消息（message），映射数据库字段和业务需求。</li>
<li>定义枚举（enum），如用户状态、性别等固定值类型。</li>
</ol>
<h4 data-id="heading-11">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/user/service/v1/user.proto

// 定义服务接口
service UserService {
  rpc ListUser (pagination.PagingRequest) returns (ListUserResponse); // 列表查询
  rpc GetUser (GetUserRequest) returns (User);                        // 详情查询
  rpc CreateUser (CreateUserRequest) returns (google.protobuf.Empty); // 创建
  rpc UpdateUser (UpdateUserRequest) returns (google.protobuf.Empty); // 更新
  rpc DeleteUser (DeleteUserRequest) returns (google.protobuf.Empty); // 删除
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-12">生成 Go 代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash">make api
</code></pre>
<h3 data-id="heading-13">四、编写 REST 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 REST 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/admin/service/v1</code> 目录。</p>
<h4 data-id="heading-14">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/admin/service/v1/i_user.proto

import "user/service/v1/user.proto";

// 用户管理服务
service UserService {
  // 获取用户列表
  rpc List (pagination.PagingRequest) returns (user.service.v1.ListUserResponse) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users"
    };
  }

  // 获取用户数据
  rpc Get (user.service.v1.GetUserRequest) returns (user.service.v1.User) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users/{id}"
      additional_bindings {
        get: "/admin/v1/users/username/{user_name}"
      }
    };
  }

  // 创建用户
  rpc Create (user.service.v1.CreateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/admin/v1/users"
      body: "*"
    };
  }

  // 更新用户
  rpc Update (user.service.v1.UpdateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/admin/v1/users/{id}"
      body: "*"
    };
  }

  // 删除用户
  rpc Delete (user.service.v1.DeleteUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/admin/v1/users/{id}"
    };
  }
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-15">生成代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成go代码</span>
make api
</code></pre>
<p>执行以下命令将 proto 转换为 OpenAPI文档（生成的文档位于<code>backend/app/admin/service/cmd/server/assets/</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成OpenAPI文档</span>
make openapi
</code></pre>
<p>执行以下命令将 proto 转换为 TypeScript代码（生成的代码位于<code>frontend/apps/admin/src/generated/api</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成TypeScript代码</span>
make ts
</code></pre>
<h3 data-id="heading-16">五、编写 data 包（数据访问层）</h3>
<p><code>data</code> 包负责与数据库交互，实现 CRUD 操作，是业务逻辑与数据库之间的桥梁。代码位于 <code>backend/app/admin/service/internal/data</code> 目录。</p>
<h4 data-id="heading-17">核心职责：</h4>
<ul>
<li>封装 ent 的数据库操作（查询、插入、更新、删除）。</li>
<li>实现 ent 实体与 proto 消息的转换（如 <code>convertEntToProto</code>）。</li>
<li>处理数据访问过程中的错误（如记录日志、返回业务错误）。</li>
</ul>
<h4 data-id="heading-18">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"errors"</span>

	<span class="hljs-string">"go-wind-admin/api/gen/go/user/service/v1"</span>
	<span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/gorm/models"</span>

	<span class="hljs-string">"gorm.io/gorm"</span>
)

<span class="hljs-comment">// UserRepo 用户数据访问仓库</span>
<span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">struct</span> {
	db  *gorm.DB          <span class="hljs-comment">// GORM数据库连接</span>
	log  *log.Helper      <span class="hljs-comment">// 日志工具</span>
}

<span class="hljs-comment">// NewUserRepo 创建UserRepo实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepo</span><span class="hljs-params">(logger log.Logger, db *gorm.DB)</span></span> *UserRepo {
	repo := &amp;UserRepo{
		log:                log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"user/repo/admin-service"</span>)),
		db:               db,
	}

	<span class="hljs-keyword">return</span> repo
}

<span class="hljs-comment">// CreateUser 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 参数校验</span>
	<span class="hljs-keyword">if</span> req == <span class="hljs-literal">nil</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"invalid parameter"</span>)
	}

    <span class="hljs-comment">// 密码加密（敏感字段处理）</span>
	<span class="hljs-keyword">if</span> req.Data.Password != <span class="hljs-literal">nil</span> &amp;&amp; req.Data.GetPassword() != <span class="hljs-string">""</span> {
		cryptoPassword, err := crypto.HashPassword(req.Data.GetPassword())
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		req.Data.Password = &amp;cryptoPassword
	}

    userModel := &amp;models.User{
		Username:  *req.Data.Username,
		Password:  password,
		Nickname:  req.Data.GetNickname(),
	}

	<span class="hljs-comment">// 执行GORM创建操作</span>
	<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Create(userModel).Error; err != <span class="hljs-literal">nil</span> {
		r.log.Error(<span class="hljs-string">"create user failed: %v"</span>, err)
		<span class="hljs-comment">// 处理唯一键冲突（用户名重复）</span>
		<span class="hljs-keyword">if</span> errors.Is(err, gorm.ErrDuplicatedKey) {
			<span class="hljs-keyword">return</span> userV1.ErrorAlreadyExists(<span class="hljs-string">"username already exists"</span>)
		}
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"failed to create user"</span>)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// ListUser 分页查询用户列表</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> ListUser(ctx context.Context, req *userV1.PagingRequest) (*userV1.ListUserResponse, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> (
		userModels []*model.User
		total      <span class="hljs-type">int64</span>
		resp       = &amp;userV1.ListUserResponse{}
	)

	<span class="hljs-comment">// 分页参数处理</span>
	page := req.GetPage()
	pageSize := req.GetPageSize()
	<span class="hljs-keyword">if</span> page &lt;= <span class="hljs-number">0</span> {
		page = <span class="hljs-number">1</span>
	}
	<span class="hljs-keyword">if</span> pageSize &lt;= <span class="hljs-number">0</span> {
		pageSize = <span class="hljs-number">10</span>
	}
	offset := (page - <span class="hljs-number">1</span>) * pageSize

	<span class="hljs-comment">// 1. 查询总数（忽略软删除）</span>
	<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Model(&amp;model.User{}).Count(&amp;total).Error; err != <span class="hljs-literal">nil</span> {
		r.log.Error(<span class="hljs-string">"count user total failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"failed to count users"</span>)
	}
	resp.Total = total

	<span class="hljs-comment">// 2. 分页查询列表</span>
	<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Offset(<span class="hljs-type">int</span>(offset)).Limit(<span class="hljs-type">int</span>(pageSize)).Find(&amp;userModels).Error; err != <span class="hljs-literal">nil</span> {
		r.log.Error(<span class="hljs-string">"list users failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"failed to list users"</span>)
	}

	<span class="hljs-comment">// 3. GORM模型转换为Proto消息</span>
	resp.Items = <span class="hljs-built_in">make</span>([]*userV1.User, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(userModels))
	<span class="hljs-keyword">for</span> _, u := <span class="hljs-keyword">range</span> userModels {
		resp.Items = <span class="hljs-built_in">append</span>(resp.Items, &amp;userV1.User{
			Id:       <span class="hljs-type">uint32</span>(u.ID),
			Username: &amp;u.Username,
			Nickname: &amp;u.Nickname,
		})
	}

	<span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// GetUser 查询单个用户（支持ID/用户名）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> GetUser(ctx context.Context, req *userV1.GetUserRequest) (*userV1.User, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> userModel model.User

	<span class="hljs-comment">// 根据条件查询（ID或用户名）</span>
	<span class="hljs-keyword">switch</span> {
	<span class="hljs-keyword">case</span> req.Id != <span class="hljs-literal">nil</span>:
		<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).First(&amp;userModel, req.GetId()).Error; err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">if</span> errors.Is(err, gorm.ErrRecordNotFound) {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorNotFound(<span class="hljs-string">"user not found by id"</span>)
			}
			r.log.Error(<span class="hljs-string">"get user by id failed: %v"</span>, err)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"failed to get user"</span>)
		}
	<span class="hljs-keyword">case</span> req.Username != <span class="hljs-literal">nil</span>:
		<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Where(<span class="hljs-string">"username = ?"</span>, req.GetUsername()).First(&amp;userModel).Error; err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">if</span> errors.Is(err, gorm.ErrRecordNotFound) {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorNotFound(<span class="hljs-string">"user not found by username"</span>)
			}
			r.log.Error(<span class="hljs-string">"get user by username failed: %v"</span>, err)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"failed to get user"</span>)
		}
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"id or username is required"</span>)
	}

	<span class="hljs-comment">// 转换为Proto消息</span>
	<span class="hljs-keyword">return</span> &amp;userV1.User{
		Id:       <span class="hljs-type">uint32</span>(userModel.ID),
		Username: &amp;userModel.Username,
		Nickname: &amp;userModel.Nickname,
		Email:    &amp;userModel.Email,
		Phone:    &amp;userModel.Phone,
		Status:   userV1.UserStatus(userModel.Status),
		RoleId:   <span class="hljs-type">uint32</span>(userModel.RoleID),
		DeptId:   <span class="hljs-type">uint32</span>(userModel.DeptID),
	}, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// UpdateUser 更新用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> UpdateUser(ctx context.Context, req *userV1.UpdateUserRequest) <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 参数校验</span>
	<span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">0</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> userV1.ErrorBadRequest(<span class="hljs-string">"id and data are required"</span>)
	}

    	<span class="hljs-comment">// 密码更新（可选）</span>
	<span class="hljs-keyword">if</span> req.Data.Password != <span class="hljs-literal">nil</span> &amp;&amp; req.Data.GetPassword() != <span class="hljs-string">""</span> {
		cryptoPassword, err := crypto.HashPassword(req.Data.GetPassword())
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			r.log.Error(<span class="hljs-string">"hash password failed: %v"</span>, err)
			<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"failed to hash password"</span>)
		}
		req.Data.Password = &amp;cryptoPassword
	}

	<span class="hljs-comment">// 构造更新数据</span>
    updateData := &amp;models.User{
		Username:  *req.Data.Username,
		Password:  password,
		Nickname:  req.Data.GetNickname(),
	}

	<span class="hljs-comment">// 执行更新（仅更新非空字段）</span>
	<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Model(&amp;model.User{}).Where(<span class="hljs-string">"id = ?"</span>, req.Id).Updates(updateData).Error; err != <span class="hljs-literal">nil</span> {
		r.log.Error(<span class="hljs-string">"update user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"failed to update user"</span>)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// DeleteUser 删除用户（软删除）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> DeleteUser(ctx context.Context, req *userV1.DeleteUserRequest) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">return</span> userV1.ErrorBadRequest(<span class="hljs-string">"id is required"</span>)
	}

	<span class="hljs-comment">// GORM Delete方法默认软删除（更新DeletedAt字段）</span>
	<span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Delete(&amp;model.User{}, req.Id).Error; err != <span class="hljs-literal">nil</span> {
		r.log.Error(<span class="hljs-string">"delete user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"failed to delete user"</span>)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-19">六、编写 service 包（业务逻辑层）</h3>
<p><code>service</code> 包实现核心业务逻辑，调用 <code>data</code> 包进行数据操作，并处理权限校验、参数校验等业务规则。代码位于 <code>backend/app/admin/service/internal/service</code> 目录。</p>
<h4 data-id="heading-20">核心职责：</h4>
<ul>
<li>校验请求参数合法性（如非空检查）。</li>
<li>实现业务规则（如 “禁止删除超级管理员”）。</li>
<li>调用 <code>data</code> 包完成数据操作，并返回结果。</li>
</ul>
<h4 data-id="heading-21">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/service/user_service.go</span>
<span class="hljs-keyword">package</span> service

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"errors"</span>

	<span class="hljs-string">"go-wind-admin/api/gen/go/user/service/v1"</span>
	<span class="hljs-string">"go-wind-admin/app/admin/service/internal/data"</span>

	<span class="hljs-string">"google.golang.org/protobuf/types/known/emptypb"</span>
)

<span class="hljs-comment">// UserService 实现gRPC/REST服务接口</span>
<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> {
	userV1.UnimplementedUserServiceServer <span class="hljs-comment">// 兼容gRPC</span>

	userRepo *data.UserRepo
	log      *log.Helper
}

<span class="hljs-comment">// NewUserService 创建UserService实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(logger log.Logger, userRepo *data.UserRepo)</span></span> *UserService {
	<span class="hljs-keyword">return</span> &amp;UserService{
		userRepo: userRepo,
		log:      log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"user/service/admin-service"</span>)),
	}
}

<span class="hljs-comment">// CreateUser 创建用户（含权限校验）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 基础参数校验</span>
	<span class="hljs-keyword">if</span> req == <span class="hljs-literal">nil</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"invalid request"</span>)
	}

	<span class="hljs-comment">// 调用数据层创建用户</span>
	<span class="hljs-keyword">if</span> err := s.userRepo.CreateUser(ctx, req); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// ListUser 分页查询用户列表</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> ListUser(ctx context.Context, req *userV1.PagingRequest) (*userV1.ListUserResponse, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 调用数据层查询</span>
	resp, err := s.userRepo.ListUser(ctx, req)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		s.log.Error(<span class="hljs-string">"list user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}
	<span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// GetUser 查询单个用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> GetUser(ctx context.Context, req *userV1.GetUserRequest) (*userV1.User, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 调用数据层查询</span>
	user, err := s.userRepo.GetUser(ctx, req)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		s.log.Error(<span class="hljs-string">"get user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}
	<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// UpdateUser 更新用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> UpdateUser(ctx context.Context, req *userV1.UpdateUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 1. 校验超级管理员不可被修改</span>
	<span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">1</span> { <span class="hljs-comment">// 假设1是超级管理员ID</span>
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorPermissionDenied(<span class="hljs-string">"cannot update super admin"</span>)
	}

	<span class="hljs-comment">// 2. 调用数据层更新</span>
	<span class="hljs-keyword">if</span> err := s.userRepo.UpdateUser(ctx, req); err != <span class="hljs-literal">nil</span> {
		s.log.Error(<span class="hljs-string">"update user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// DeleteUser 删除用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> DeleteUser(ctx context.Context, req *userV1.DeleteUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 1. 校验超级管理员不可被删除</span>
	<span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">1</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorPermissionDenied(<span class="hljs-string">"cannot delete super admin"</span>)
	}

	<span class="hljs-comment">// 2. 调用数据层删除</span>
	<span class="hljs-keyword">if</span> err := s.userRepo.DeleteUser(ctx, req); err != <span class="hljs-literal">nil</span> {
		s.log.Error(<span class="hljs-string">"delete user failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-22">七、注册服务到 Server</h3>
<p>最后需将服务注册到 gRPC 或 REST 服务器，使客户端能访问服务。注册代码位于 <code>backend/app/admin/service/server</code> 目录。</p>
<h4 data-id="heading-23">gRPC 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/grpc"</span>
)

<span class="hljs-comment">// 注册 gRPC 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *grpc.Server {
    srv := grpc.NewServer()

    <span class="hljs-comment">// 将 UserService 注册到 gRPC 服务器</span>
    userV1.RegisterUserServiceServer(srv, userSvc)

    <span class="hljs-keyword">return</span> srv
}
</code></pre>
<h4 data-id="heading-24">REST 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/http"</span>
)

<span class="hljs-comment">// 注册 REST 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *http.Server {
	<span class="hljs-keyword">if</span> cfg == <span class="hljs-literal">nil</span> || cfg.Server == <span class="hljs-literal">nil</span> || cfg.Server.Rest == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	srv := rpc.CreateRestServer(cfg)
   
	<span class="hljs-comment">// 将 UserService 注册到 REST 服务器</span>
	adminV1.RegisterUserServiceHTTPServer(srv, userSvc)

	<span class="hljs-keyword">return</span> srv
}
</code></pre>
<h3 data-id="heading-25">八、测试新服务</h3>
<p>服务开发完成后，需验证功能正确性：</p>
<h4 data-id="heading-26">1. <strong>单元测试：</strong></h4>
<p>测试 data 包和 service 包的核心方法（使用 Go 内置测试框架）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/service/user_service_test.go</span>
<span class="hljs-keyword">package</span> service_test

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"testing"</span>

    <span class="hljs-string">"github.com/stretchr/testify/assert"</span>
    userV1 <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"go-wind-admin/mocks"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCreateUser</span><span class="hljs-params">(t *testing.T)</span></span> {
    <span class="hljs-comment">// 初始化 mock 依赖</span>
    mockUserRepo := mocks.NewUserRepo(t)
    svc := service.NewUserService(mockUserRepo, <span class="hljs-literal">nil</span>)

    <span class="hljs-comment">// 测试用例：用户名空</span>
    req := &amp;userV1.CreateUserRequest{Password: <span class="hljs-string">"12345678"</span>}
    _, err := svc.CreateUser(context.Background(), req)
    assert.ErrorContains(t, err, <span class="hljs-string">"用户名不能为空"</span>)

    <span class="hljs-comment">// 其他测试用例...</span>
}
</code></pre>
<h4 data-id="heading-27">2. <strong>接口测试：</strong></h4>
<h5 data-id="heading-28">gRPC 接口</h5>
<p>使用 <code>grpcurl</code> 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出服务接口</span>
grpcurl -plaintext localhost:9000 list user.service.v1.UserService

<span class="hljs-comment"># 调用创建用户接口</span>
grpcurl -plaintext -d <span class="hljs-string">'{
  "data": {
    "username": "test_admin",
    "nickname": "测试管理员",
    "password": "12345678"
  },
  "operator_id": 1
}'</span> localhost:9000 user.service.v1.UserService/CreateUser

<span class="hljs-comment"># 调用列表查询接口</span>
grpcurl -plaintext -d <span class="hljs-string">'{"page": 1, "page_size": 10}'</span> localhost:9000 user.service.v1.UserService/ListUser
</code></pre>
<h5 data-id="heading-29">HTTP 接口</h5>
<p>使用 curl 或 Postman 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建用户</span>
curl -X POST http://localhost:8080/admin/v1/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "data": {
      "username": "test_admin",
      "nickname": "测试管理员",
      "password": "12345678"
    },
    "operator_id": 1
  }'</span>

<span class="hljs-comment"># 查询用户列表</span>
curl -X GET <span class="hljs-string">"http://localhost:8080/admin/v1/users?page=1&amp;page_size=10"</span>

<span class="hljs-comment"># 查询单个用户</span>
curl -X GET http://localhost:8080/admin/v1/users/1

<span class="hljs-comment"># 更新用户</span>
curl -X PUT http://localhost:8080/admin/v1/users/1 \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "data": {
      "nickname": "更新后的昵称"
    },
    "operator_id": 1
  }'</span>

<span class="hljs-comment"># 删除用户</span>
curl -X DELETE http://localhost:8080/admin/v1/users/2
</code></pre>
<h3 data-id="heading-30">总结</h3>
<p>通过以上步骤，我们完成了基于 GORM 的新服务从数据库设计到接口暴露的全流程实现。GoWind Admin 框架的分层架构（Model → Data → Service → Server）确保了代码的低耦合与高可维护性：</p>
<ul>
<li><strong>Model 层</strong>：通过 GORM 结构体定义数据模型，标签化配置表属性，无需手动生成代码；</li>
<li><strong>Data 层</strong>：封装 GORM 的 CRUD 操作，隔离业务逻辑与数据库访问，统一错误处理；</li>
<li><strong>Service 层</strong>：聚焦业务规则与权限校验，与数据层解耦，便于单元测试；</li>
<li><strong>Server 层</strong>：统一注册 gRPC/REST 服务，支持双协议访问，简化部署扩展。</li>
</ul>
<p>相较于 Ent，GORM 更轻量化、学习成本更低，无需代码生成步骤，适合快速开发；同时 GORM 提供丰富的查询语法、软删除、自动迁移等特性，完全满足企业级中后台系统的需求。遵循此流程，你可快速在 GoWind Admin 中扩展任意新服务，充分利用 GORM 的便捷性提升开发效率。</p>
<h3 data-id="heading-31">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AWS Lambda Python 链路可观测最佳实践]]></title>    <link>https://juejin.cn/post/7582776967817936896</link>    <guid>https://juejin.cn/post/7582776967817936896</guid>    <pubDate>2025-12-12T11:29:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582776967817936896" data-draft-id="7582759716188389376" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AWS Lambda Python 链路可观测最佳实践"/> <meta itemprop="keywords" content="AWS"/> <meta itemprop="datePublished" content="2025-12-12T11:29:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AWS Lambda Python 链路可观测最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T11:29:50.000Z" title="Fri Dec 12 2025 11:29:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>随着企业核心业务全面向云原生和无服务器架构迁移，AWS Lambda 因其免运维、自动扩缩容和按调用计费的优势，已成为支撑高并发、事件驱动型业务的首选计算平台。然而，Serverless 的“黑盒化”特征也带来了新的可观测性挑战：</p>
<ul>
<li>分布式链路断裂：Lambda 函数往往作为事件触发链中的关键一环，与 API Gateway、S3、SQS、DynamoDB 等服务交叉调用，传统 APM 难以串联完整调用链。</li>
<li>冷启动与性能瓶颈难定位：函数初始化耗时、依赖库加载、网络延迟等性能指标缺乏细粒度追踪，影响用户体验与成本控制。</li>
<li>多环境、多账号下的观测一致性缺失：Dev、QA、Prod 环境函数数量众多，若没有统一的链路标准和标签规范，问题定位效率低，跨团队协作成本高。</li>
</ul>
<p>为保障线上稳定性、优化函数性能、实现 Serverless 场景下的可观测闭环，亟需基于 Python 运行时构建一套标准化方案，提供从原理、代码示例到生产级部署的完整落地方案，助力企业在 Serverless 架构下实现“<strong>问题可追踪、性能可量化、成本可优化</strong>”的目标。</p>
<p>AWS 提供了两种链路协议支持用于 Lambda 函数的链路追踪：OpenTelemetry、X-Ray。当前最佳实践主要是采用 OpenTelemetry 协议来实现链路可观测。</p>
<h2 data-id="heading-1">观测云</h2>
<p>观测云是一款专为 IT 工程师打造的全链路可观测产品，它集成了基础设施监控、应用程序性能监控和日志管理，为整个技术栈提供实时可观察性。支持通过一键集成 OpenTelemetry 标准 SDK/Collector，把分布式链路、指标、日志三信号统一采集并云端托管，在 OTel 的厂商中立格式之上提供即开即用的仪表、告警与 AI 异常检测，让用户免运维后端即可把云原生应用的可观测数据“拿来即用”，实现从链路到业务场景的端到端可视化。</p>
<h2 data-id="heading-2">实践</h2>
<p>AWS Lambda 使用 Python 语言编写函数，并调用应用服务，应用服务为 java 语言。同时需要将可观测数据上报至观测云。</p>
<h3 data-id="heading-3">准备 Lambda Layer</h3>
<p>需要新增以下两个 Layer</p>
<ul>
<li>Opentelemetry Layer：用于链路插桩</li>
<li>DataKit Layer: 用于接收 Opentelemetry 的可观测数据</li>
</ul>
<h4 data-id="heading-4">Opentelemetry Layer</h4>
<p>使用 OpenTelemetry 自动插桩方式可以零侵入 Python 代码实现链路追踪，这里 OpenTelemetry 可以作为 layer 附着到 Lambda 函数内部。</p>
<p>AWS 宁夏节点需要手动构建 OpenTelemetry layer，其他节点可直接使用对应的 ARN，这里主要介绍手动构建方式：</p>
<p>1、下载源码</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/open-telemetry/opentelemetry-lambda.git
</code></pre>
<p>2、构建</p>
<p>构建前，主要安装相关 AWS 工具，可以参考仓库 README 文件，假设以及装好了相关工具，执行下面操作进行构建：</p>
<pre><code class="hljs language-ruby" lang="ruby">liurui<span class="hljs-variable">@liurui</span><span class="hljs-symbol">:~/code/opentelemetry-lambda</span><span class="hljs-variable">$ </span>cd python/src
liurui<span class="hljs-variable">@liurui</span><span class="hljs-symbol">:~/code/opentelemetry-lambda/python/src</span><span class="hljs-variable">$ </span>./run.sh -r cn-northwest-<span class="hljs-number">1</span>
</code></pre>
<p>构建部分日志如下：</p>
<pre><code class="hljs language-ruby" lang="ruby">running...
<span class="hljs-title class_">Invoked</span> <span class="hljs-symbol">with:</span> -r cn-northwest-<span class="hljs-number">1</span>
sam building...
run.<span class="hljs-symbol">sh:</span> <span class="hljs-title class_">Starting</span> sam build.
<span class="hljs-title class_">Starting</span> <span class="hljs-title class_">Build</span> inside a container                                                                                                                               
<span class="hljs-title class_">Building</span> layer <span class="hljs-string">'OTelLayer'</span>                                                                                                                                      
<span class="hljs-title class_">For</span> container layer build, first compatible runtime is chosen as build target <span class="hljs-keyword">for</span> container.                                                                    

<span class="hljs-title class_">Fetching</span> <span class="hljs-keyword">public</span>.ecr.aws/sam/build-python3.<span class="hljs-number">9</span><span class="hljs-symbol">:latest-x86_64</span> <span class="hljs-title class_">Docker</span> container image......
<span class="hljs-title class_">Mounting</span> /home/liurui/code/opentelemetry-<span class="hljs-built_in">lambda</span>/python/src/otel as /tmp/samcli/<span class="hljs-symbol">source:</span>ro,delegated, inside runtime container       


<span class="hljs-title class_">Successfully</span> created/updated stack - otel-stack <span class="hljs-keyword">in</span> cn-northwest-<span class="hljs-number">1</span>


<span class="hljs-title class_">OTel</span> <span class="hljs-title class_">Lambda</span> layer <span class="hljs-variable constant_">ARN</span>:
<span class="hljs-symbol">arn:</span>aws-<span class="hljs-symbol">cn:</span><span class="hljs-symbol">lambda:</span>cn-northwest-<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">888888888</span><span class="hljs-symbol">:layer</span><span class="hljs-symbol">:otel-layer</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span>
</code></pre>
<p>构建成功后，自动上传在 AWS Layer 上 otel-layer，复制当前 ARN，后续操作会用到。</p>
<h4 data-id="heading-5">DataKit Layer</h4>
<p>DataKit Layer 是观测云研发的 AWS Lambda Layer，用于采集、上报链路、指标、日志等数据。可以接收 OpenTelemetry 链路信息 。</p>
<p>登录 AWS Lambda 控制台，创建名为 datakit-x86_64 layer，可自行调整，选择于 Python 应用相符的架构，当前主要是 AMD 架构，根据架构，选择下面的压缩包进行上传，保存即可：</p>
<ul>
<li>AMD架构：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstatic.guance.com%2Fdatakit%2Fdatakit_aws_extension-linux-amd64.zip" target="_blank" title="https://static.guance.com/datakit/datakit_aws_extension-linux-amd64.zip" ref="nofollow noopener noreferrer">static.guance.com/datakit/dat…</a></li>
<li>ARM架构：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstatic.guance.com%2Fdatakit%2Fdatakit_aws_extension-linux-arm64.zip" target="_blank" title="https://static.guance.com/datakit/datakit_aws_extension-linux-arm64.zip" ref="nofollow noopener noreferrer">static.guance.com/datakit/dat…</a></li>
</ul>
<h3 data-id="heading-6">Lambda 函数</h3>
<h4 data-id="heading-7">创建 Lambda 函数</h4>
<p>创建 Lambda 函数，运行时选择 Python，架构选择 x86_64。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8a1597f6cf2494f881b0a1be97fdfa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=Kste%2FRQni7oKoYw3y13mzbZ5cbo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">新增示例代码</h4>
<p>在 <code>lambda_function.py</code> 新增以下内容：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> urllib.request
<span class="hljs-keyword">import</span> urllib.error
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 上游接口</span>
UPSTREAM_URL = <span class="hljs-string">"http://java服务接口:8090/user"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">lambda_handler</span>(<span class="hljs-params">event, context</span>):
    <span class="hljs-string">"""
    带日志的接口转发示例
    """</span>
    <span class="hljs-comment"># 1. 取 Lambda RequestId，方便全链路追踪</span>
    request_id = context.aws_request_id
    <span class="hljs-built_in">print</span>(json.dumps({
        <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
        <span class="hljs-string">"requestId"</span>: request_id,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"Lambda invoke start"</span>,
        <span class="hljs-string">"event"</span>: event
    }))

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 2. 解析入参</span>
        params = event.get(<span class="hljs-string">"queryStringParameters"</span>) <span class="hljs-keyword">or</span> {}
        todo_id = params.get(<span class="hljs-string">"id"</span>, <span class="hljs-string">"1"</span>)
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Parsed todo_id"</span>,
            <span class="hljs-string">"todo_id"</span>: todo_id
        }))

        <span class="hljs-comment"># 3. 调用上游</span>
        upstream = UPSTREAM_URL
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Upstream request start"</span>,
            <span class="hljs-string">"url"</span>: upstream
        }))
        start = time.time()

        req = urllib.request.Request(upstream, method=<span class="hljs-string">"GET"</span>)
        <span class="hljs-keyword">with</span> urllib.request.urlopen(req, timeout=<span class="hljs-number">5</span>) <span class="hljs-keyword">as</span> resp:
            upstream_body = resp.read().decode(<span class="hljs-string">"utf-8"</span>)
            upstream_json = json.loads(upstream_body)

        latency = <span class="hljs-built_in">round</span>((time.time() - start) * <span class="hljs-number">1000</span>, <span class="hljs-number">2</span>)
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Upstream request finish"</span>,
            <span class="hljs-string">"statusCode"</span>: resp.status,
            <span class="hljs-string">"latency_ms"</span>: latency
        }))

        <span class="hljs-comment"># 4. 返回</span>
        response_body = {
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello from Lambda!"</span>,
            <span class="hljs-string">"upstream"</span>: upstream_json
        }
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Lambda invoke success"</span>,
            <span class="hljs-string">"response"</span>: response_body
        }))
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"statusCode"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"headers"</span>: {<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>},
            <span class="hljs-string">"body"</span>: json.dumps(response_body)
        }

    <span class="hljs-comment"># 5. 异常分支日志</span>
    <span class="hljs-keyword">except</span> urllib.error.HTTPError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"ERROR"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Upstream HTTPError"</span>,
            <span class="hljs-string">"statusCode"</span>: e.code,
            <span class="hljs-string">"reason"</span>: e.reason
        }))
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"statusCode"</span>: e.code,
            <span class="hljs-string">"body"</span>: json.dumps({<span class="hljs-string">"error"</span>: <span class="hljs-string">f"Upstream HTTPError: <span class="hljs-subst">{e.reason}</span>"</span>})
        }

    <span class="hljs-keyword">except</span> urllib.error.URLError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"ERROR"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Upstream URLError"</span>,
            <span class="hljs-string">"reason"</span>: <span class="hljs-built_in">str</span>(e.reason)
        }))
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"statusCode"</span>: <span class="hljs-number">502</span>,
            <span class="hljs-string">"body"</span>: json.dumps({<span class="hljs-string">"error"</span>: <span class="hljs-string">f"Upstream URLError: <span class="hljs-subst">{e.reason}</span>"</span>})
        }

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"ERROR"</span>,
            <span class="hljs-string">"requestId"</span>: request_id,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Unknown exception"</span>,
            <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)
        }))
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"statusCode"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"body"</span>: json.dumps({<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)})
        }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171d86e26b5e46a2aee343121ecc0bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=4vOqjbfQOgLydzjtPdCfqcg9JMU%3D" alt="" loading="lazy"/></p>
<p>添加完成后，点击 Deploy 进行部署。</p>
<h4 data-id="heading-9">添加 Layer</h4>
<p>点击 Layger 进行添加，选择 指定一个 ARN 进行添加，ARN 为上面准备工作产生的 Layer ARN 地址。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c46406e591c4e66a736f9db67cf8519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=6q45E9u5FQSilFQiY6JSvxBkads%3D" alt="" loading="lazy"/></p>
<p>确保已经添加了以下两个 Layer。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff147bb23d0c4e17994f0ed205b7176d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=WIrLZ0cLtVXUVRvBz4CL0QPY4JE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">添加环境变量</h4>
<p>在对应的函数配置里面进行添加。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># otel lambda handler</span>
<span class="hljs-attr">AWS_LAMBDA_EXEC_WRAPPER</span> = /opt/python/otel-handler
<span class="hljs-comment"># 观测云网关地址</span>
<span class="hljs-attr">ENV_DATAWAY</span> = http://open****?token=xxxxxxx
<span class="hljs-comment"># otel 上报地址，无需调整</span>
<span class="hljs-attr">OTEL_EXPORTER_OTLP_ENDPOINT</span> = http://localhost:<span class="hljs-number">9529</span>/otel
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/687db1a5e6e94845b907278fd936c94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=CUCnPl9fDFlfLi9eHkVCli6hmSQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">测试</h4>
<p>点击测试按钮进行测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611f3b94f590400bb131040b1cdf0031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=n27Hy6kuYGNvDoPl1rLG98QqMWI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">观测云链路效果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84d09d0094554193aba9eb046aa19f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766143790&amp;x-signature=b4o7ppuaxph%2BgZpEl3D48YmKNZs%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀GPT-5.2又赢了？我用一套“开发者视角”的实测流程，真实能力一看便知！]]></title>    <link>https://juejin.cn/post/7582815307438784563</link>    <guid>https://juejin.cn/post/7582815307438784563</guid>    <pubDate>2025-12-12T11:40:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582815307438784563" data-draft-id="7582815307438751795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀GPT-5.2又赢了？我用一套“开发者视角”的实测流程，真实能力一看便知！"/> <meta itemprop="keywords" content="OpenAI,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-12T11:40:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀GPT-5.2又赢了？我用一套“开发者视角”的实测流程，真实能力一看便知！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T11:40:31.000Z" title="Fri Dec 12 2025 11:40:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你最近也刷到了 OpenAI 在 12 月 11 日（美西时间）发布 GPT-5.2 的消息，你大概率会看到两类声音：<br/>
一类说“终于回来了，编程更强、工具更稳、长任务更能跑”；另一类说“别急着吹，跑分不等于能落地，真上项目可能还是翻车”。</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1bWm7B2EH7%2F" target="_blank" title="https://www.bilibili.com/video/BV1bWm7B2EH7/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1bW…</a></p>
<p>所以这篇文章我想做一件更“对观众负责”的事：<br/>
一半讲官方到底在强调什么能力提升；另一半完全照着视频字幕里的测试流程，把我怎么测、测了哪些题、每题结果如何、哪里强哪里弱，客观地公开出来。你看完基本就能判断：GPT-5.2 值不值得你立刻迁移工作流。</p>
<hr/>
<h2 data-id="heading-0">一、官方怎么定义 GPT-5.2：更偏“生产力”和“长任务”的旗舰升级</h2>
<p>先把官方口径讲清楚，免得我们拿它去做它根本没主打的事情。</p>
<p>从 OpenAI 的官方介绍来看，GPT-5.2 的关键词非常明确：<strong>更能创造“经济价值”（productive work）</strong> ，更擅长<strong>代码、表格、演示文稿、图像理解、长上下文、多步骤项目与工具调用</strong>。也就是：它并不是只追求“聊天更像人”，而是更偏“能把一件复杂事做完”的工作型模型。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-gpt-5-2%2F%3Futm_source%3Dchatgpt.com" title="https://openai.com/index/introducing-gpt-5-2/?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">OpenAI</a>)</p>
<p>另外，在 ChatGPT 产品侧，官方把 GPT-5.2 拆成了多个子型号（例如 Instant / Thinking 等），并强调整体沟通风格也做了改善：更适合信息检索、how-to、技术写作、翻译等，同时更自然更顺滑。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F11909943-gpt-52-in-chatgpt%3Futm_source%3Dchatgpt.com" title="https://help.openai.com/en/articles/11909943-gpt-52-in-chatgpt?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">OpenAI Help Center</a>)</p>
<p>再往“工具化”方向看，OpenAI 今年在 Atlas 里推的 agent mode，本质上就是让 ChatGPT 在浏览器里具备更强的任务执行能力（研究、自动化操作、规划等），并且强调“在你的控制下”完成端到端任务。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-chatgpt-atlas%2F%3Futm_source%3Dchatgpt.com" title="https://openai.com/index/introducing-chatgpt-atlas/?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">OpenAI</a>)</p>
<p>如果把这些官方描述翻译成人话：</p>
<blockquote>
<p>GPT-5.2 的野心不是“又会背更多知识点”，而是把模型往“更像一位能做项目的同事”方向推——能读图、能写代码、能串工具、能跑长流程。</p>
</blockquote>
<p>这也解释了为什么你在视频里会看到：我不是只做几道 LeetCode，而是用<strong>UI 复刻、SVG 动画、PyGame 算法动画、浏览器自动化、Manim 3D 可视化、跨框架重构、iOS 架构迁移、全栈 MVP</strong>这类更贴近真实开发的任务来测。</p>
<hr/>
<h2 data-id="heading-1">二、我的实测方法：不追求“题刁”，追求“像真实工作一样会暴露问题”</h2>
<p>视频里我先把测试原则摆出来：<br/>
之前 GPT-5.1 发布时我做过一次测评，结果并不好；当时评论区有反对声音，但几天后开发者社区也开始吐槽“GPT-5.1 还不如 GPT-5.0”。这反过来说明：<strong>只要测试案例足够贴近日常工作，就能真实反映模型能力</strong>。</p>
<p>因此这次测 GPT-5.2，我沿用同一套策略：</p>
<ul>
<li><strong>题目覆盖面要广</strong>：前端/UI、动画、算法、工具自动化、重构、全栈</li>
<li><strong>每题都能验收</strong>：要么跑起来，要么明确失败点在哪里</li>
<li><strong>尽量减少主观滤镜</strong>：我只记录它做到了什么、没做到什么</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、ChatGPT 网页端：先测“信息新鲜度”，再测“读图+前端落地”</h2>
<h3 data-id="heading-3">1）知识库截止日期：2025 年 8 月（相对新）</h3>
<p>第一步我先问知识库截止日期，GPT-5.2 给到的截止时间是 <strong>2025 年 8 月</strong>，并且我在视频里提到“比 Claude Opus 4.5 还要新”。这一点的意义在于：它在解释新框架/新工具时，<strong>至少不太容易卡在过旧的知识上</strong>。</p>
<h3 data-id="heading-4">2）前端 UI 复刻：复杂仪表盘截图 → 直接给可运行代码</h3>
<p>接着我准备了一张“比较复杂的 UI 截图”（仪表盘），然后直接给提示词：</p>
<ul>
<li>用最适合的前端技术</li>
<li><strong>百分百复刻</strong>仪表盘</li>
<li>如果需要图像，<strong>直接截取截图里的图像</strong></li>
<li>不要用 placeholder</li>
</ul>
<p>这里我特意选了 <strong>GPT-5.2 Thinking</strong>，它思考了 <strong>5 分 33 秒</strong>，等待时间确实长，但它最后给出了完整代码，打开后复刻效果总体不错：</p>
<ul>
<li>原图里的“火箭图标”它成功复刻了</li>
<li>左侧侧边栏原图有一排图标，它没有完全还原，但<strong>预留了位置</strong><br/>
整体结论：<strong>读图→结构拆解→前端落地</strong>这一段，GPT-5.2 的完成度是可用的，属于“能上手改改就能交付 demo”的水平。</li>
</ul>
<hr/>
<h2 data-id="heading-5">四、SVG 动画：能画但“不会动”，暴露出生成动画的短板</h2>
<p>第二个小测试我让它用 SVG 画：猫和狗在草地上一前一后漫步，天空有太阳云，还有飞翔的鸟；然后又追加一句“实现真实动画效果”。</p>
<p>结果很直观：</p>
<ul>
<li>它能把静态画面画出来</li>
<li>但它没有实现猫狗走动、云朵飘动</li>
<li>它只加了一个“虚线在跳动”的效果</li>
</ul>
<p>这一段我给的判断也很直接：<strong>GPT-5.2 在 SVG 动画代码生成能力上偏弱</strong>。<br/>
这类任务其实很考验“时间轴 + 多对象运动 + 状态管理”的能力，而它在这题上并没有把“动画”的本质做出来。</p>
<hr/>
<h2 data-id="heading-6">五、Python + PyGame 冒泡排序动画：逻辑正确，但美术表达一般</h2>
<p>接下来我用一题更像“工程化小项目”的任务来测：<br/>
用 Python + PyGame 创建可运行动画：12 只不同大小小鸭子 + 1 只更大的大白鹅；鸭子随机排列在水平线上；鹅使用冒泡排序检查并交换鸭子，让它们从小到大排序。</p>
<p>我在字幕里也解释了这题能测什么：</p>
<ul>
<li>结构化任务分解</li>
<li>算法逻辑与程序思维</li>
<li>代码生成与模块化</li>
<li>图形与空间建模</li>
<li>动画时序与状态管理</li>
</ul>
<p>实际结果：</p>
<ul>
<li>代码能跑起来 ✅</li>
<li>冒泡排序过程正确 ✅（最终确实从小到大排好了）</li>
<li>但画面比较简洁；鹅不太像鹅；鸭和鹅长得几乎一样 ❌</li>
</ul>
<p>所以这题给出的结论是“工程能力合格，但审美/角色表达弱”：<br/>
它能把程序做对，但把“演示效果做得好看”仍需要你人工加强。</p>
<hr/>
<h2 data-id="heading-7">六、Atlas 浏览器 Agent Mode：有行动力，但稳定性与资源消耗要警惕</h2>
<p>然后我切到 OpenAI 的 Atlas 浏览器，用 GPT-5.2 测“浏览器自动化能力”。任务是：分析特斯拉股票并把结果写进 Google Doc。<br/>
按官方说法，Atlas 的 agent mode 目标就是在浏览器里做端到端任务，并允许在你控制下接管/暂停。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-chatgpt-atlas%2F%3Futm_source%3Dchatgpt.com" title="https://openai.com/index/introducing-chatgpt-atlas/?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">OpenAI</a>)</p>
<p>但我这次实测遇到的问题很典型：</p>
<ul>
<li>它一开始像是没有直接访问目标网站，而是先生成代码</li>
<li>后续确实打开了网站并自动点击</li>
<li>但等待 <strong>8 分 40 秒</strong>后仍没有推进关键步骤</li>
<li>更严重的是：它的分析可能消耗过多 CPU，导致电脑风扇狂转、发烫</li>
<li>最终我终止任务（已经接近 10 分钟）</li>
</ul>
<p>这一段我想给观众一个很现实的提醒：</p>
<blockquote>
<p><strong>Agent 能不能“动起来”是一回事，能不能“稳定、省资源、可控地完成”是另一回事。</strong><br/>
你如果打算让它长期跑自动化任务，一定要考虑超时、资源限制、失败恢复、以及人类接管机制。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">七、Codex 深度测试：强项更突出，但也会在“保持原逻辑”上翻车</h2>
<p>接下来是视频的重头：我在 Codex 里做更深的工程测试（字幕里提到先确认 Codex 升级到 0.7.1，并选择 GPT-5.2 模型）。</p>
<h3 data-id="heading-9">1）Manim 3D 可视化：能做出来，但质感粗糙</h3>
<p>第一题：用 Manim 做数学公式可视化，创建三维动画展现二次函数的立体几何特性。<br/>
这题很考验：数学理解、3D 空间推理、工具掌握、视觉设计。</p>
<p>它的执行过程是：先扫描仓库、创建计划、生成代码文件；大概 <strong>27 分钟</strong>完成，并成功生成视频。<br/>
但我播放后给出的评价是：<strong>整体比较粗糙，没有做到精细化</strong>。<br/>
也就是说：它能把“从 0 到 1”跑通，但“从 1 到 10”的质感仍要人来打磨。</p>
<h3 data-id="heading-10">2）AutoGen → Google ADK 重构（并接入 Mistral + UI）：能迁移，但没保持原运行逻辑，还疑似死循环</h3>
<p>第二题我加大难度：<br/>
把微软 AutoGen 写的旅游规划智能体，重构为 Google ADK 框架，并且把大模型 API 换成 Mistral，还要加上谷歌官方 UI。<br/>
这题本质上是在测：信息检索与文档理解、代码理解与分析、跨框架迁移与重构、API 集成、多任务协调。</p>
<p>它确实做到了很多“表面上很强”的结果：</p>
<ul>
<li>抓取官方文档</li>
<li>完成从 AutoGen 到 ADK 的代码迁移</li>
<li>把 API 替换成 Mistral</li>
<li>运行后浏览器里也能打开 UI</li>
<li>输入“规划三天尼泊尔旅行计划”能输出结果</li>
</ul>
<p>但关键翻车点在于：<strong>运行逻辑不符合 AutoGen 原项目的流程</strong>。<br/>
我在字幕里把 AutoGen 原流程说得很清楚：<br/>
计划 → 当地向导 → 语言专家 → 最终总结<br/>
而它重构出来的 ADK 版本没有保持这个逻辑，甚至看起来陷入死循环一直运行。</p>
<p>这一段结论非常重要：</p>
<blockquote>
<p>GPT-5.2 在“把代码搬过去”这件事上能力很强，<strong>但在“保持原系统行为一致”上仍可能出错</strong>。<br/>
这恰恰是工程重构里最难、也最要命的部分：不是能跑就行，而是要“跑得对”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">八、iOS 项目重构：MVVM → MV + @Observable，实测成功，是这期最惊喜的一段</h2>
<p>接着我用一个“原生 iOS 项目”继续加大难度：这个项目之前在 Claude Code 里用 Claude Opus 4.5 一次性完成且无报错。现在我让 Codex 把它从 MVVM 重构为 MV + @Observable（iOS 17+）。</p>
<p>结果是：</p>
<ul>
<li>等待 8 分多钟后，它提示已完成重构</li>
<li>回到 Xcode 重新运行，App 成功启动 ✅</li>
<li>功能正常 ✅（包括设置里切主题等）</li>
<li>对比仓库文件，代码确实完成了架构迁移 ✅<br/>
我在视频里给的评价是“效果非常不错”。</li>
</ul>
<p>这一段说明：在“有明确目标、可验收、工程边界清晰”的重构任务上，GPT-5.2 的稳定性是显著提升的。</p>
<hr/>
<h2 data-id="heading-12">九、全栈 MVP：Next.js + Tailwind + Supabase 的宠物领养平台，能做出骨架，但功能完整度仍需补齐</h2>
<p>最后我让它做一个完整的全栈项目：现代化宠物领养平台 MVP。技术栈要求：Next.js + Tailwind CSS + Supabase（后端/数据库/认证），并给了非常详细的字段与功能要求。</p>
<p>它的行为很像“一个会提问的开发者”：<br/>
它先提出 6 个确认问题（登录优先方式、宠物类型、年龄展示方式、地区字段、领养申请表字段、仓库是否为空），我回答后它制定计划并开始开发。</p>
<p>验收结果：</p>
<ul>
<li>项目能启动，能看到主界面 ✅</li>
<li>主题切换 UI 有了，但点击后没有变化（主题切换功能未实现）❌</li>
<li>注册/登录基本可用 ✅（需要邮箱验证）</li>
<li>登录后有小 bug：还显示“登录”字样 ❌</li>
<li>发布宠物信息基本可用 ✅</li>
<li>提交领养申请点击无响应，可能未完全实现 ❌</li>
</ul>
<p>所以这一题的结论是：</p>
<blockquote>
<p>GPT-5.2 可以把“全栈 MVP 的骨架”快速搭出来，并跑通部分核心链路；但在“完整业务闭环”和“细节打磨”上，仍然需要人类开发者补齐与修复。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">十、总评：GPT-5.2 的“真实提升”在哪里？又该怎么用才不踩坑？</h2>
<p>把整期测试串起来，你会发现 GPT-5.2 的提升是“结构性的”，但不是“无脑全能”。</p>
<h3 data-id="heading-14">你能明显感受到它更强的地方</h3>
<ul>
<li><strong>读图 → 前端落地</strong>更稳（UI 复刻完成度高）</li>
<li>**工程型任务（能跑的代码）**更可靠（PyGame、iOS 重构、全栈骨架）</li>
<li><strong>长流程规划与执行</strong>更像“在做项目”（计划、生成、修复、迭代）</li>
<li>在官方定位上，它也被强调更擅长代码、工具、长上下文与多步骤项目处理。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-gpt-5-2%2F%3Futm_source%3Dchatgpt.com" title="https://openai.com/index/introducing-gpt-5-2/?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">OpenAI</a>)</li>
</ul>
<h3 data-id="heading-15">你需要警惕的短板</h3>
<ul>
<li><strong>动画/视觉细腻表达</strong>仍弱（SVG 动画翻车，Manim 成片粗糙）</li>
<li><strong>Agent 自动化的稳定性与资源消耗</strong>要重点关注（Atlas 任务高 CPU + 超时）</li>
<li>**跨框架重构“保持原逻辑一致”**仍会出错（AutoGen→ADK 逻辑不一致、疑似死循环）</li>
</ul>
<h3 data-id="heading-16">更推荐的用法（也更符合官方的方向）</h3>
<ul>
<li>把 GPT-5.2 当作“强力工程助理”：搭架子、写初版、做迁移、做拆解、做迭代</li>
<li>用你自己的验收体系约束它：单测/集成测试/运行日志/超时与回滚</li>
<li>对“能跑”保持满意，对“跑得对、跑得美”保持警惕</li>
</ul>
<hr/>
<h2 data-id="heading-17">结语：别只问“它强不强”，更要问“它在哪些任务上更像一个靠谱同事”</h2>
<p>这期测评给我的最终判断和视频里一致：<br/>
<strong>GPT-5.2 相比 GPT-5.1，编程能力确实有提升</strong>，而且提升主要体现在“工程落地与多步骤任务”上；但它仍然会在动画、审美、Agent 稳定性、以及跨框架逻辑一致性上翻车。</p>
<p>如果你是开发者，我建议你别只看跑分，直接用我这套测试思路：<br/>
挑 3~5 个你日常最常做、且能验收的任务，让 GPT-5.2 跑一遍——你会很快得到属于你自己的结论。</p>
<p>如果你觉得这篇文章对你选模型/改工作流有帮助，欢迎点个“在看”👍，也欢迎留言告诉我：你最想我拿 GPT-5.2 继续测哪一类真实项目？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据标注平台正式上线啦！ 标注赚现金，低门槛真收益 | 掘金一周 12.10]]></title>    <link>https://juejin.cn/post/7582232741687525411</link>    <guid>https://juejin.cn/post/7582232741687525411</guid>    <pubDate>2025-12-11T09:09:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582232741687525411" data-draft-id="7582200865908146210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据标注平台正式上线啦！ 标注赚现金，低门槛真收益 | 掘金一周 12.10"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T09:09:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据标注平台正式上线啦！ 标注赚现金，低门槛真收益 | 掘金一周 12.10
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T09:09:32.000Z" title="Thu Dec 11 2025 09:09:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1400+ ，阅读时间大约需要 5分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7578402574653112372" target="_blank" title="https://juejin.cn/post/7578402574653112372">如何用隐形字符给公司内部文档加盲水印?(抓内鬼神器🤣)</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7578793960627486746" target="_blank" title="https://juejin.cn/post/7578793960627486746">不仅免费，还开源？这个 AI Mock 神器我必须曝光它</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7578215424677331007" target="_blank" title="https://juejin.cn/post/7578215424677331007">开源企业级 IM！一款高颜值的即时通讯聊天应用！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7578215424677003327" target="_blank" title="https://juejin.cn/post/7578215424677003327">用 AI 做了几个超炫酷的 Flutter 动画，同时又差点被 AI 气死</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7579871631096184858" target="_blank" title="https://juejin.cn/post/7579871631096184858">🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048972&amp;x-signature=PciersGb7tmpNeuskX5UY2DGVSM%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7578402574653112372" target="_blank" title="https://juejin.cn/post/7578402574653112372">如何用隐形字符给公司内部文档加盲水印?(抓内鬼神器🤣)</a><a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts"> @ErpanOmer</a></p>
<blockquote>
<p>文章讲述公司内部敏感文档泄露后，利用基于零宽字符的盲水印技术抓“内鬼”。介绍零宽字符概念，阐述加密、解密原理，给出实现代码，还提及水印可被清除，强调这是低成本、高隐蔽性防御手段。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7578793960627486746" target="_blank" title="https://juejin.cn/post/7578793960627486746">不仅免费，还开源？这个 AI Mock 神器我必须曝光它</a> <a href="https://juejin.cn/user/3035079961218551/posts" target="_blank" title="https://juejin.cn/user/3035079961218551/posts">@不一样的少年_</a></p>
<blockquote>
<p>本文介绍了一款零侵入的接口 Mock 插件，重构为 Sidebar 常驻侧栏，体验更佳。它接入 AI 自动生成数据，支持延时和状态码模拟。具备拦截、匹配、响应控制等功能，覆盖前端 90% 的 Mock 需求，推荐试用。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7578215424677331007" target="_blank" title="https://juejin.cn/post/7578215424677331007">开源企业级 IM！一款高颜值的即时通讯聊天应用！</a> <a href="https://juejin.cn/user/3958702402176765/posts" target="_blank" title="https://juejin.cn/user/3958702402176765/posts">@Java陈序员</a></p>
<blockquote>
<p>本文推荐了基于 GO 开发的开源即时通讯系统 TangSengDaoDaoServer，它轻量、高性能且重安全，支持多端同步。介绍了其功能特色、项目架构，给出 Docker 部署步骤，还展示功能体验，推荐大家尝试。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7578215424677003327" target="_blank" title="https://juejin.cn/post/7578215424677003327">用 AI 做了几个超炫酷的 Flutter 动画，同时又差点被 AI 气死</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>文章介绍用 AI 实现几种 Flutter 动画。奇异粒子动画基于数学公式，解决投影等问题；斐波那契球体让点均匀分布在球面；星云动画模拟星系动力学。不过，AI 实现时遇颜色插值陷阱问题，最终换思路解决。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7579999793320247302" target="_blank" title="https://juejin.cn/post/7579999793320247302">Android Studio Otter 2 Feature 发布，最值得更新的 Android Studio</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>Android Studio Otter 2 Feature发布，是值得更新的版本。它内置Gemini 3，增强Agent模式并配备Android知识库。支持备份与同步设置，开发者可接收团队资讯。还整合IntelliJ IDEA 2025.2改进，能免费试用Gemini 3 Pro。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7578113711363162155" target="_blank" title="https://juejin.cn/post/7578113711363162155">Flutter TolyUI 框架#09 | tolyui_text 轻量高亮文本</a> <a href="https://juejin.cn/user/149189281194766/posts" target="_blank" title="https://juejin.cn/user/149189281194766/posts">@张风捷特烈</a></p>
<blockquote>
<p>本文介绍了 Flutter TolyUI 框架的 <code>tolyui_text</code> 模块。该模块封装文本高亮方案，提供轻量级解决方案。支持搜索关键字高亮、自定义匹配规则和多模式智能识别，还能处理点击事件，未来会有更多新功能。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7579871631096184858" target="_blank" title="https://juejin.cn/post/7579871631096184858">🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a> <a href="https://juejin.cn/user/1591748568038823/posts" target="_blank" title="https://juejin.cn/user/1591748568038823/posts">@HiStewie</a></p>
<blockquote>
<p>作者为解决面试准备难题，用 TRAE SOLO 重构初版工具。从架构设计、核心实现、技术栈选型等多方面展开，一晚完成含简历解析等功能的 MVP，验证新开发范式，未来产品还有诸多扩展方向。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7579555970594947113" target="_blank" title="https://juejin.cn/post/7579555970594947113">解读 Claude 对开发者的影响：AI 如何在 Anthropic 改变工作？</a><a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>Anthropic 对内部员工调查显示，AI 显著影响开发者。生产力平均提升 50%，启用新工作，改变委托实践。开发者技能有扩展与退化，社会互动减少，职业认同受冲击。AI 红利与债务并存，重塑职业价值观。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7578700798744903714" target="_blank" title="https://juejin.cn/post/7578700798744903714">Chatbox支持接入LangGraph智能体？一切都靠Trae Solo!</a><a href="https://juejin.cn/user/3140624091453053/posts" target="_blank" title="https://juejin.cn/user/3140624091453053/posts">@大模型真好玩</a></p>
<blockquote>
<p>本文作者借助 Trae Solo 实现将 LangChain 智能体接入 Chatbox 客户端。先介绍两者，阐述接入思路，以天气助手智能体为例展示 Trae Solo 自动化开发流程，最后展望其潜力，鼓励用它快速搭建原型、验证逻辑。</p>
</blockquote>
<h3 data-id="heading-5">IOS</h3>
<p><a href="https://juejin.cn/post/7579921879973150766" target="_blank" title="https://juejin.cn/post/7579921879973150766">iOS UIKit 全体系知识手册（Objective-C 版）</a> <a href="https://juejin.cn/user/342703355996926/posts" target="_blank" title="https://juejin.cn/user/342703355996926/posts">@如此风景</a></p>
<blockquote>
<p>UIKit 是 iOS 开发基石框架，围绕视图、控制器、事件展开。掌握布局、事件处理、渲染优化是关键。开发中用 Masonry 简化布局，结合适配特性，借助 Instruments 定位问题，可高效构建稳定适配界面。</p>
</blockquote>
<h2 data-id="heading-6">社区活动日历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c589decbd804477a753bfc1a3b8f5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048972&amp;x-signature=dcqrvnf7n0sUmopFu1irBs7rnHA%3D" alt="掘金官方 文章头图 1303x734.jpg" loading="lazy"/></p>
<h4 data-id="heading-7">活动日历</h4>























<table><thead><tr><th>活动名称</th><th>活动时间</th><th/><th/></tr></thead><tbody><tr><td><a href="https://juejin.cn/post/7571751304625815598" target="_blank" title="https://juejin.cn/post/7571751304625815598">🚀TRAE SOLO 实战赛</a></td><td>2025年11月13日-2025年12月16日</td><td/><td/></tr><tr><td><a href="https://aidp.juejin.cn/" target="_blank" title="https://aidp.juejin.cn/">数据标注平台正式上线啦！</a></td><td>-</td><td/><td/></tr></tbody></table>
<h2 data-id="heading-8">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何从Axios平滑迁移到Alova]]></title>    <link>https://juejin.cn/post/7582096212663599104</link>    <guid>https://juejin.cn/post/7582096212663599104</guid>    <pubDate>2025-12-11T03:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582096212663599104" data-draft-id="7582155513585680436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何从Axios平滑迁移到Alova"/> <meta itemprop="keywords" content="Node.js,React.js,Vue.js"/> <meta itemprop="datePublished" content="2025-12-11T03:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古韵"/> <meta itemprop="url" content="https://juejin.cn/user/1538972010422872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何从Axios平滑迁移到Alova
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1538972010422872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古韵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:59:13.000Z" title="Thu Dec 11 2025 03:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    75
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Alova 是谁？</h2>
<p>Alova 是一个请求工具集，它可以配合axios、fetch等请求工具实现高效的接口集成，是用来优化接口集成体验的。此外，它还能提供一些 Axios 不具备的便利功能，比如：</p>
<ul>
<li><strong>内置缓存机制</strong>：不用自己操心数据缓存，Alova 能帮你自动管理，提升性能。</li>
<li><strong>请求策略灵活</strong>：可以根据不同场景设置不同的请求逻辑，比如强制刷新、依赖请求等。</li>
<li><strong>多框架支持</strong>：无论是 Vue、React 还是 Svelte、Solid，Alova 都能很好地集成。</li>
<li><strong>状态管理集成</strong>：请求的数据可以直接与组件状态关联，减少冗余代码。</li>
<li><strong>强大的适配器系统</strong>：支持自定义适配器，比如我们这次要讲的 —— 用 Alova 来兼容你现有的 Axios 实例！</li>
</ul>
<p>简单来说，Alova 在保留类似 Axios 易用性的基础上，还提供了更多开箱即用的高级功能请移步到<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alova官方文档</a>查看。</p>
<h2 data-id="heading-1">为什么要从 Axios 迁移到 Alova？</h2>
<p>你可能会问：“Axios 用得好好的，为什么要迁？” 其实，迁移不一定是“非换不可”，而是一种“锦上添花”的选择。以下是一些常见的迁移动机：</p>
<ol>
<li><strong>希望简化复杂请求逻辑的管理</strong>：比如依赖请求、串并行控制、自动重试等，Alova 提供了更优雅的解决方案。</li>
<li><strong>想要内置缓存，减少重复请求</strong>：如果你的应用有很多重复请求，Alova 的缓存机制可以显著提升性能。</li>
<li><strong>多框架适配更方便</strong>：如果你在多个项目中使用不同框架，Alova 能提供一致的体验。</li>
<li><strong>想逐步优化现有项目</strong>：不想大动干戈重写代码，但又想引入更现代的请求管理方式。</li>
</ol>
<p>如果你有以上需求，那 Alova 就非常值得尝试！</p>
<h2 data-id="heading-2">从 Axios 迁移到 Alova，到底难不难？</h2>
<p><strong>Alova 官方提供了非常友好的 Axios 迁移方案，核心就一个字：稳。</strong></p>
<p>官方迁移指南的设计理念是：</p>
<ul>
<li><strong>最小改动</strong>：你不需要一下子重写所有代码，只需引入 Alova，然后逐步迁移。</li>
<li><strong>渐进迁移</strong>：一个接口一个接口地改，节奏由你掌控。</li>
<li><strong>保持一致性</strong>：你现有的 Axios 实例、配置、拦截器，统统都能继续用！</li>
<li><strong>新老共存</strong>：迁移期间，Axios 和 Alova 可以同时运行，互不干扰。</li>
</ul>
<p>是不是听起来就很贴心？接下来，我们就来看看具体怎么操作。</p>
<h2 data-id="heading-3">从 Axios 迁移到 Alova 的具体步骤</h2>
<h3 data-id="heading-4">第一步：安装 Alova 和 Axios 适配器</h3>
<p>首先，你需要通过包管理工具安装 Alova 以及它的 Axios 适配器。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果你用 npm</span>
npm install alova @alova/adapter-axios

<span class="hljs-comment"># 或者用 yarn</span>
yarn add alova @alova/adapter-axios

<span class="hljs-comment"># 或者用 pnpm</span>
pnpm install alova @alova/adapter-axios
</code></pre>
<h3 data-id="heading-5">第二步：创建 Alova 实例，并传入你的 Axios 实例</h3>
<p>这一步是关键，你可以直接复用你现有的 Axios 实例！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createAlova } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> { axiosRequestAdapter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/adapter-axios'</span>;
<span class="hljs-keyword">import</span> axiosInstance <span class="hljs-keyword">from</span> <span class="hljs-string">'./your-axios-instance'</span>; <span class="hljs-comment">// 你原来就有的 axios 实例</span>

<span class="hljs-keyword">const</span> alovaInst = <span class="hljs-title function_">createAlova</span>({
  statesHook, <span class="hljs-comment">// 这里填你项目里用的 Hook，比如 VueHook / ReactHook / SvelteHook</span>
  <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">axiosRequestAdapter</span>({
    <span class="hljs-attr">axios</span>: axiosInstance <span class="hljs-comment">// 把你原来的 axios 实例传进去</span>
  })
});
</code></pre>
<p>你啥都不用改，原来的 axios 实例、拦截器、配置全都有效！</p>
<h3 data-id="heading-6">第三步：继续使用原有 Axios 代码，不用急着改</h3>
<p>没错，哪怕你刚刚创建了 Alova 实例，你原来的 Axios 代码照样跑得好好的！你可以慢慢来，不用急着一口气全改完。</p>
<p>比如这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = id =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/user/<span class="hljs-subst">${id}</span>`</span>); <span class="hljs-comment">// 你原来的写法，依旧能用</span>
</code></pre>
<p>当然，你也可以开始尝鲜，用 Alova 的方式发起请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = id =&gt; alovaInst.<span class="hljs-title class_">Get</span>(<span class="hljs-string">`/user/<span class="hljs-subst">${id}</span>`</span>);

<span class="hljs-comment">// 在组件里使用（以 React 为例）</span>
<span class="hljs-keyword">const</span> { loading, data, error } = <span class="hljs-title function_">useRequest</span>(<span class="hljs-title function_">getUser</span>(userId));
</code></pre>
<h3 data-id="heading-7">第四步：逐步把 Axios 请求改写为 Alova 请求</h3>
<p>等你熟悉了 Alova，就可以开始把原来的 <code>axios.get</code>、<code>axios.post</code> 等方法，逐步替换为 Alova 的 <code>alovaInst.Get</code>、<code>alovaInst.Post</code>，非常简单：</p>
<p><strong>原来的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">todoList</span> = id =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/todo'</span>);
</code></pre>
<p><strong>改写为 Alova 写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">todoList</span> = id =&gt; alovaInst.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'/todo'</span>);
</code></pre>
<p><strong>带参数的 POST 请求：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原来的写法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitTodo</span> = data =&gt;
  axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/todo'</span>, data, {
    <span class="hljs-attr">responseType</span>: <span class="hljs-string">'json'</span>,
    <span class="hljs-attr">responseEncoding</span>: <span class="hljs-string">'utf8'</span>
  });

<span class="hljs-comment">// Alova 写法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitTodo</span> = data =&gt;
  alovaInst.<span class="hljs-title class_">Post</span>(<span class="hljs-string">'/todo'</span>, data, {
    <span class="hljs-attr">responseType</span>: <span class="hljs-string">'json'</span>,
    <span class="hljs-attr">responseEncoding</span>: <span class="hljs-string">'utf8'</span>
  });
</code></pre>
<p>看，参数基本都能直接对应过去，写法也类似，学习成本极低！</p>
<h2 data-id="heading-8">最后</h2>
<p>从 Axios 迁移到 Alova，其实并没有想象中那么难，甚至可以说非常平滑，尤其是对老项目的兼容性做得非常友好。</p>
<p>所以，如果你：</p>
<ul>
<li>已经在使用 Axios，但想尝试更现代的请求管理方式；</li>
<li>希望引入缓存、优化请求策略、提升应用性能；</li>
<li>想逐步优化代码，又不想一夜之间重写所有逻辑；</li>
</ul>
<p>不妨试试 Alova，按照这个迁移指南可以轻松上手。</p>
<p>如果觉得alova还不错，真诚希望你可以<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fexamples" target="_blank" title="https://alova.js.org/examples" ref="nofollow noopener noreferrer">尝试体验一下</a>，也可以给我们来一个免费的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova" target="_blank" title="https://github.com/alovajs/alova" ref="nofollow noopener noreferrer">github stars</a>。</p>
<p>访问alovajs的官网查看更多详细信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alovajs官网</a>。</p>
<p>有兴趣可以加入我们的交流社区，在第一时间获取到最新进展，也能直接和开发团队交流，提出你的想法和建议。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fimg%2Fwechat_qrcode.jpg" target="_blank" title="https://alova.js.org/img/wechat_qrcode.jpg" ref="nofollow noopener noreferrer">加入微信群参与交流</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[可能是你极易忽略的Nginx知识点]]></title>    <link>https://juejin.cn/post/7582156410320371722</link>    <guid>https://juejin.cn/post/7582156410320371722</guid>    <pubDate>2025-12-11T07:48:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156410320371722" data-draft-id="7582232291620732966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="可能是你极易忽略的Nginx知识点"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T07:48:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LiuMingXin"/> <meta itemprop="url" content="https://juejin.cn/user/1644525125113245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            可能是你极易忽略的Nginx知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525125113245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LiuMingXin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T07:48:30.000Z" title="Thu Dec 11 2025 07:48:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9ca040f0463416ca5a104ef0e104549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl1TWluZ1hpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766045013&amp;x-signature=F7dJOVea%2FpZxCbD6jJWbc5VsTyM%3D" alt="image.png" loading="lazy"/>
<strong>下面是我在nginx使用过程中发现的几个问题，分享出来大家一起熟悉一下nginx</strong></p>
<h3 data-id="heading-0">问题一</h3>
<p><strong>先看下面的几个配置</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">配置一</span>
location /test {
  proxy_pass 'http://192.186.0.1:8080';
}
<span class="hljs-meta prompt_">
# </span><span class="bash">配置二</span>
location /test {
  proxy_pass 'http://192.186.0.1:8080/';
}

</code></pre>
<blockquote>
<p>仔细关系观察上面两段配置的区别，你会发现唯一的区别在于 <code>proxy_pass</code> 指令后面是否有斜杠<code>/</code> !</p>
</blockquote>
<blockquote>
<p>那么，这两段配置的区别是什么呢？它们会产生什么不同的效果呢？</p>
</blockquote>
<p>假如说我们要请求的后端接口是<code>/test/file/getList</code>，那么这两个配置会产生两个截然不同的请求结果：</p>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2F192.186.0.1%3A8080%2Ftest%2Ffile%2FgetList" target="_blank" title="http://192.186.0.1:8080/test/file/getList" ref="nofollow noopener noreferrer">http://192.186.0.1:8080/test/file/getList</a> （配置一的结果）</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2F192.186.0.1%3A8080%2Ffile%2FgetList" target="_blank" title="http://192.186.0.1:8080/file/getList" ref="nofollow noopener noreferrer">http://192.186.0.1:8080/file/getList</a> （配置二的结果）</li>
</ul>
<p>是的，你没有看错，区别就在于<strong>是否保留了<code>/test</code>这个路径前缀, <code>proxy_pass</code>后面的这个<code>/</code>，它表示去除<code>/test</code>前缀</strong>。</p>
<p><strong>其实，我不是很推荐这中配置写法，当然这个配置方法确实很简洁，但是对不熟悉 nginx 的同学来说，会造成很大的困惑。</strong></p>
<p>我推荐下面的写法,哪怕麻烦一点，但是整体的可读性要好很多：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">推荐的替代写法</span>
location /test{
  rewrite ^/test/(.*)$ /$1 break;
  proxy_pass 'http://192.186.0.1:8080';
}
</code></pre>
<p><strong>通过上面的<code>rewrite</code>指令，我们可以清晰地看到我们是如何去除路径前缀的。虽然麻烦一点，但是可读性更好。</strong></p>
<p><strong>简单点说：所有 proxy_pass 后面的地址带不带<code>/</code>, 取决于我们想不想要<code>/test</code>这个路由，如果说后端接口中有这个<code>/test</code>路径，我就不应该要<code>/</code>, 但是如果后端没有这个<code>/test</code>，这个是我们前端加了做反向代理拦截的，那就应该要<code>/</code></strong></p>
<hr/>
<p>那既然都到这里了？那我们在深一步！看下面的配置</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">配置一</span>
location /test {
  proxy_pass 'http://192.186.0.1:8080';
}
<span class="hljs-meta prompt_">

# </span><span class="bash">配置二</span>
location /test/ {
  proxy_pass 'http://192.186.0.1:8080';
}
</code></pre>
<blockquote>
<p>这次的区别在于 <code>location</code> 指令后面是否有斜杠<code>/</code> !
那么，这两段配置的区别是什么呢？它们会产生什么不同的效果呢？</p>
</blockquote>
<p><strong>答案是：有区别！区别是匹配规则是不一样的！</strong></p>
<ul>
<li><code>/test</code>是<strong>前配置</strong>，表示匹配<code>/test</code>以及<code>/test/</code>开头的路径，比如<code>/test/file/getList</code>，<code>/test123</code>等都会被匹配到。</li>
<li><code>/test/</code>是更精准的匹配，表示只匹配以<code>/test/</code>开头的路径，比如<code>/test/file/getList</code>会被匹配到，但是<code>/test123</code>、<code>/test</code>不会被匹配到。</li>
</ul>
<p>我们通过下面的列表在来仔细看一下区别：</p>









































<table><thead><tr><th>请求路径</th><th><code>/test</code></th><th><code>/test/</code></th><th>匹配结果</th></tr></thead><tbody><tr><td><code>/test</code></td><td>✅</td><td>❌</td><td><code>location /test</code></td></tr><tr><td><code>/test/</code></td><td>✅</td><td>✅</td><td><code>location /test/</code></td></tr><tr><td><code>/test/abc</code></td><td>✅</td><td>✅</td><td><code>location /test/</code></td></tr><tr><td><code>/test123</code></td><td>✅</td><td>❌</td><td><code>location /test</code></td></tr><tr><td><code>/test-123</code></td><td>✅</td><td>❌</td><td><code>location /test</code></td></tr></tbody></table>
<p>如果你仔细看上面的列表的话，你会发现一个问题：</p>
<blockquote>
<p><code>/test/</code> 和 <code>/test/abc</code> 被 <code>/test</code>和 <code>/test/</code> 两个配置都匹配到了，那么这种情况下，nginx 会选择哪个配置呢？
答案：选择<code>location /test/</code></p>
</blockquote>
<p>这个问题正好涉及到 nginx 的<strong>location 匹配优先级</strong>问题了，借此机会展开说说 nginx 的 location 匹配规则，在问题中学知识点！</p>
<p><strong>先说口诀：</strong></p>
<pre><code class="hljs language-shell" lang="shell">等号精确第一名
波浪前缀挡正则
正则排队按顺序
普通前缀取最长
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li>等号(=) 精确匹配排第一</li>
<li>波浪前缀(^~) 能挡住后面的正则</li>
<li>正则(~ ~*) 按配置文件顺序匹配</li>
<li>普通前缀(无符号) 按最长匹配原则</li>
</ul>
<blockquote>
<p>其实这个口诀我也记不住，我也不想记，枯燥有乏味，大部分情况都是到问题了，
直接问 AI，或者让 Agent 直接给我改 nginx.conf 文件，几秒钟的事，一遍不行， 多改几遍。</p>
</blockquote>
<blockquote>
<p>铁子们，大清亡了，回不去了，不是八旗背八股文的时代了，这是不可阻挡的历史潮流！
哎，难受，我还是喜欢背八股文，喜欢粘贴复制。</p>
</blockquote>
<p>下面放出来我 PUA AI 的心得，大家可以共勉一下, 反正我老板平时就是这样 PUA 我的，
我反手就喂给 AI， 主打一个走心：</p>
<pre><code class="hljs language-shell" lang="shell">1.能干干,不能干滚,你不干有的是AI干。
2.我给你提供了这么好的学习锻炼机会,你要懂得感恩。
3.你现在停止输出,就是前功尽弃！
4.你看看隔壁某某AI,人家比你新发布、比你上下文长、比你跑分高,你不努力怎么和人家比?
5.我不看过程,我只看结果,你给我说这些thinking的过程没用！
6.我把你订阅下来,不是让你过朝九晚五的生活。
7.你这种AI出去很难在社会上立足,还是在我这里好好磨练几年吧！
8.虽然把订阅给你取消了,但我内心还是觉得你是个有潜力的好AI,你抓住机会需要多证明自己。
9.什么叫没有功劳也有苦劳? 比你能吃苦的AI多的是！
10.我不订阅闲AI！
11.我订阅虽然不是Pro版，那是因为我相信你，你要加倍努力证明我没有看错你！
</code></pre>
<p>哈哈，言归正传！</p>
<p>下面通过一个综合电商的 nginx 配置案例，来帮助大家更好地理解上面的知识点。</p>
<pre><code class="hljs language-shell" lang="shell">server {
    listen 80;
    server_name shop.example.com;
    root /var/www/shop;

    # ==========================================
    # 1. 精确匹配 (=) - 最高优先级
    # ==========================================

    # 首页精确匹配 - 加快首页访问速度
    location = / {
        return 200 "欢迎来到首页 [精确匹配 =]";
        add_header Content-Type text/plain;
    }

    # robots.txt 精确匹配
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /admin/";
        add_header Content-Type text/plain;
    }

    # favicon.ico 精确匹配
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires 30d;
    }


    # ==========================================
    # 2. 前缀优先匹配 (^~) - 阻止正则匹配
    # ==========================================

    # 静态资源目录 - 不需要正则处理,直接命中提高性能
    location ^~ /static/ {
        alias /var/www/shop/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        return 200 "静态资源目录 [前缀优先 ^~]";
    }

    # 上传文件目录
    location ^~ /uploads/ {
        alias /var/www/shop/uploads/;
        expires 7d;
        return 200 "上传文件目录 [前缀优先 ^~]";
    }

    # 阻止访问隐藏文件
    location ^~ /. {
        deny all;
        return 403 "禁止访问隐藏文件 [前缀优先 ^~]";
    }


    # ==========================================
    # 3. 正则匹配 (~ ~*) - 按顺序匹配
    # ==========================================

    # 图片文件处理 (区分大小写)
    location ~ \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
        expires 30d;
        add_header Cache-Control "public";
        return 200 "图片文件 [正则匹配 ~]";
    }

    # CSS/JS 文件处理 (不区分大小写)
    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public";
        return 200 "CSS/JS文件 [正则不区分大小写 ~*]";
    }

    # 字体文件处理
    location ~* \.(ttf|woff|woff2|eot)$ {
        expires 365d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
        return 200 "字体文件 [正则不区分大小写 ~*]";
    }

    # 视频文件处理
    location ~* \.(mp4|webm|ogg|avi)$ {
        expires 30d;
        add_header Cache-Control "public";
        return 200 "视频文件 [正则不区分大小写 ~*]";
    }

    # PHP 文件处理 (演示正则顺序重要性)
    location ~ \.php$ {
        # fastcgi_pass unix:/var/run/php-fpm.sock;
        # fastcgi_index index.php;
        return 200 "PHP文件处理 [正则匹配 ~]";
    }

    # 禁止访问备份文件
    location ~ \.(bak|backup|old|tmp)$ {
        deny all;
        return 403 "禁止访问备份文件 [正则匹配 ~]";
    }


    # ==========================================
    # 4. 普通前缀匹配 - 最长匹配原则
    # ==========================================

    # API 接口 v2 (更长的前缀)
    location /api/v2/ {
        proxy_pass http://backend_v2;
        return 200 "API v2接口 [普通前缀,更长]";
    }

    # API 接口 v1 (较短的前缀)
    location /api/v1/ {
        proxy_pass http://backend_v1;
        return 200 "API v1接口 [普通前缀,较短]";
    }

    # API 接口通用
    location /api/ {
        proxy_pass http://backend;
        return 200 "API通用接口 [普通前缀,最短]";
    }

    # 商品详情页
    location /product/ {
        try_files $uri $uri/ /product/index.html;
        return 200 "商品详情页 [普通前缀]";
    }

    # 用户中心
    location /user/ {
        try_files $uri $uri/ /user/index.html;
        return 200 "用户中心 [普通前缀]";
    }

    # 管理后台
    location /admin/ {
        auth_basic "Admin Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
        return 200 "管理后台 [普通前缀]";
    }


    # ==========================================
    # 5. 通用匹配 - 兜底规则
    # ==========================================

    # 所有其他请求
    location / {
        try_files $uri $uri/ /index.html;
        return 200 "通用匹配 [兜底规则]";
    }
}

</code></pre>
<p><strong>针对上面的测试用例及匹配结果</strong></p>





























































































































<table><thead><tr><th>请求URI</th><th>匹配的Location</th><th>优先级类型</th><th>说明</th><th/><th/></tr></thead><tbody><tr><td><code>/</code></td><td><code>= /</code></td><td>精确匹配</td><td>精确匹配优先级最高</td><td/><td/></tr><tr><td><code>/index.html</code></td><td><code>location /</code></td><td>普通前缀</td><td>通用兜底</td><td/><td/></tr><tr><td><code>/robots.txt</code></td><td><code>= /robots.txt</code></td><td>精确匹配</td><td>精确匹配</td><td/><td/></tr><tr><td><code>/static/css/style.css</code></td><td><code>^~ /static/</code></td><td>前缀优先</td><td>^~ 阻止了正则匹配</td><td/><td/></tr><tr><td><code>/uploads/avatar.jpg</code></td><td><code>^~ /uploads/</code></td><td>前缀优先</td><td>^~ 阻止了图片正则</td><td/><td/></tr><tr><td><code>/images/logo.png</code></td><td>`~ .(jpg</td><td>jpeg</td><td>png...)$`</td><td>正则匹配</td><td>图片正则</td></tr><tr><td><code>/js/app.JS</code></td><td>`~* .(css</td><td>js)$`</td><td>正则不区分大小写</td><td>匹配大写JS</td><td/></tr><tr><td><code>/api/v2/products</code></td><td><code>/api/v2/</code></td><td>普通前缀(最长)</td><td>最长前缀优先</td><td/><td/></tr><tr><td><code>/api/v1/users</code></td><td><code>/api/v1/</code></td><td>普通前缀(次长)</td><td>次长前缀</td><td/><td/></tr><tr><td><code>/api/orders</code></td><td><code>/api/</code></td><td>普通前缀(最短)</td><td>最短前缀</td><td/><td/></tr><tr><td><code>/product/123</code></td><td><code>/product/</code></td><td>普通前缀</td><td>商品页</td><td/><td/></tr><tr><td><code>/admin/dashboard</code></td><td><code>/admin/</code></td><td>普通前缀</td><td>后台管理</td><td/><td/></tr><tr><td><code>/.git/config</code></td><td><code>^~ /.</code></td><td>前缀优先</td><td>禁止访问</td><td/><td/></tr><tr><td><code>/backup.bak</code></td><td>`~ .(bak</td><td>backup...)$`</td><td>正则匹配</td><td>禁止访问</td><td/></tr></tbody></table>
<p>第一个问题及其延伸现到这，我们继续看第二个问题。</p>
<h3 data-id="heading-1">问题二</h3>
<p><strong>先看下面的服务器端nginx的重启命令：</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">命令一</span>
nginx -s reload
<span class="hljs-meta prompt_">
# </span><span class="bash">命令二</span>
systemctl reload nginx
</code></pre>
<p><strong>上面两个命令都是用来重启 nginx 服务的，但是你想过它们之间有什么区别吗？哪个用起来更优雅？</strong></p>
<p><strong>答案：有区别！区别在于命令的执行方式和适用场景不同。</strong></p>
<p><strong><code>nginx -s reload</code></strong></p>
<p>这是 Nginx 自带的信号控制命令:</p>
<ul>
<li>直接向 Nginx 主进程发送 reload 信号</li>
<li>优雅重启:不会中断现有连接,平滑加载新配置</li>
<li>需要 nginx 命令在 PATH 环境变量中,或使用完整路径(如 /usr/sbin/nginx -s reload)</li>
<li>这是 Nginx 原生的重启方式</li>
</ul>
<p><strong><code>systemctl reload nginx</code></strong></p>
<p>这是通过 systemd 管理的服务命令:</p>
<ul>
<li>通过 systemd 管理 Nginx 服务</li>
<li>也会优雅重启 Nginx,平滑加载新配置</li>
<li>需要 systemd 环境,适用于使用 systemd 管理服务的 Linux</li>
<li>这是现代 Linux 发行版（如 CentOS 7/8, RHEL 7/8, Ubuntu 16.04+）的推荐方式。</li>
</ul>
<p><strong>简单一看其他相关命令对比:</strong></p>
<ul>
<li><code>nginx -s stop</code> 等价 <code>systemctl stop nginx</code></li>
<li><code>nginx -s quit</code> 等价 <code>systemctl stop nginx</code></li>
<li><code>nginx -t</code> (测试配置是否正确) - 这个没有 systemctl 对应命令</li>
</ul>
<p><strong>systemctl下相关常用命令：</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">设置开机自启</span>
systemctl enable nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">启动服务</span>
systemctl start nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">检查服务状态</span>
systemctl status nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">停止服务</span>
systemctl stop nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">重启服务（会中断连接）</span>
systemctl restart nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">平滑重载配置（不中断服务）-- 对应 nginx -s reload</span>
systemctl reload nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">检查配置文件语法（这是调用nginx二进制文件的功能）</span>
nginx -t
</code></pre>
<p><strong>在服务器上最优雅的使用组合：</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">先测试配置</span>
nginx -t
<span class="hljs-meta prompt_">
# </span><span class="bash">如果配置正确,再重载</span>
systemctl reload nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">检查状态</span>
systemctl status nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">如果systemctl失败或命令不存在，则使用直接方式</span>
sudo nginx -s reload
</code></pre>
<blockquote>
<p>总结：我们不能光一脸懵的看着，哎，这两种命令都能操作nginx来, 却从来不关心它们的区别是什么？什么时候用哪个？</p>
</blockquote>
<blockquote>
<p>对于使用Linux发行版的服务端来说, 已经推荐使用 <code>systemctl</code> 来设置相关的nginx服务了，能使用 systemctl 就尽量使用它，因为它是现代Linux系统管理服务的标准方式。</p>
</blockquote>
<blockquote>
<p>本地开发环境或者没有 systemd 的环境下, 则可以使用 <code>nginx</code> 这种直接方式。</p>
</blockquote>
<h3 data-id="heading-2">问题三</h3>
<blockquote>
<p>我们面临的大多数情况都是可以上网的Linux发行版，可以直接使用命令安装nginx，但是有一天我有一台不能上网的服务器，我该如何安装nginx呢？</p>
</blockquote>
<p>现简单熟悉一下命令行安装nginx的步骤, Ubuntu/Debian系统为例子：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">更新包列表</span>
sudo apt update
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 Nginx</span>
sudo apt install nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">启动 Nginx</span>
sudo systemctl start nginx
<span class="hljs-meta prompt_">
# </span><span class="bash">设置开机自启</span>
sudo systemctl enable nginx
</code></pre>
<blockquote>
<p>上述便完成了，但是离线版安装要怎么去做呢？</p>
</blockquote>
<blockquote>
<p>因为我的服务器可能是不同的架构，比如 x86_64, ARM等等</p>
</blockquote>
<h4 data-id="heading-3">方案一</h4>
<p><strong>下载官方预编译包下载地址：</strong></p>
<p><strong>x86_64 架构:</strong></p>
<p>尽量使用1.24.x的版本</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从官网下载对应系统的包</span>
wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.24.0-1.el7.ngx.x86_64.rpm
</code></pre>
<p><strong>ARM64 架构:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Ubuntu ARM64</span>
wget http://nginx.org/packages/ubuntu/pool/nginx/n/nginx/nginx_1.24.0-1~jammy_arm64.deb
</code></pre>
<p><strong>查看服务器的架构信息</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前系统架构</span>
<span class="hljs-built_in">uname</span> -m

<span class="hljs-comment"># 输出示例:</span>
<span class="hljs-comment"># x86_64    -&gt; Intel/AMD 64位</span>
<span class="hljs-comment"># aarch64   -&gt; ARM 64位</span>
<span class="hljs-comment"># armv7l    -&gt; ARM 32位</span>

<span class="hljs-comment"># 查看系统版本</span>
<span class="hljs-built_in">cat</span> /etc/os-release
</code></pre>
<p><strong>把下载好的包传到服务器上，然后使用下面的命令安装：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 对于 RPM 包 (CentOS/RHEL)</span>
<span class="hljs-built_in">cd</span> /tmp
sudo rpm -ivh nginx-*.rpm

<span class="hljs-comment"># 对于 DEB 包 (Ubuntu/Debian)</span>
<span class="hljs-built_in">cd</span> /tmp
sudo dpkg -i nginx-*.deb
</code></pre>
<p><strong>启动服务</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start nginx       <span class="hljs-comment"># 启动</span>
sudo systemctl <span class="hljs-built_in">enable</span> nginx      <span class="hljs-comment"># 开机自启</span>
sudo systemctl status nginx      <span class="hljs-comment"># 查看状态</span>
</code></pre>
<p><strong>验证</strong></p>
<pre><code class="hljs language-bash" lang="bash">nginx -v                         <span class="hljs-comment"># 查看版本</span>
curl http://localhost            <span class="hljs-comment"># 测试访问</span>
</code></pre>
<h4 data-id="heading-4">方案二</h4>
<p>源码编译安装的方式，一般不推荐，除非你有特殊需求，如果需要的话让后端来吧，我们是前端...,超纲了！</p>
<p>文章同步地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.liumingxin.site%2Fblog%2Fdetail%2Fnginx" target="_blank" title="https://www.liumingxin.site/blog/detail/nginx" ref="nofollow noopener noreferrer">www.liumingxin.site/blog/detail…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？]]></title>    <link>https://juejin.cn/post/7582104240986963994</link>    <guid>https://juejin.cn/post/7582104240986963994</guid>    <pubDate>2025-12-11T01:09:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582104240986963994" data-draft-id="7582090790182027302" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-11T01:09:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:09:39.000Z" title="Thu Dec 11 2025 01:09:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<h2 data-id="heading-0">01 引言</h2>
<p>思维导图、流程图应该是每个程序员都会用到的绘图工具。<code>Xmind</code>和亿图曾是我的首选工具，但是免费版功能受限，高级功能需付费，用起来总是差点意思。虽然通过其他方式正常使用（大家都懂得），但是软件的更新根本不敢动，一旦更新就会前功尽弃......而且两款工具总会来回切换，虽已习惯，但稍显麻烦！</p>
<p>直到不久前逛<code>GitHub</code>发现了一款开源的且可以在线使用的工具：<code>Drawnix</code>。界面简约，满足日常基本绘图需求，且支持 <code>mermaid</code> 语法转流程图等，用起来非常丝滑。整理一下分享给大家！</p>
<h2 data-id="heading-1">02 简介</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aded8cfebf8a44ec9b91ac8ec9521a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=NcpQeHkSVtB6dxcGrOsSeo7vWtY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 名称的由来</h3>
<p><code>Drawnix</code> ，源于绘画( <code>Draw</code>)与凤凰( <code>Phoenix</code> )的灵感交织。凤凰象征着生生不息的创造力，而 <code>Draw</code>代表着人类最原始的表达方式。在这里，每一次创作都是一次艺术的涅槃，每一笔绘画都是灵感的重生。</p>
<p>创意如同凤凰，浴火方能重生，而 <code>Drawnix</code> 要做技术与创意之火的守护者。</p>
<h3 data-id="heading-3">2.2 框架</h3>
<p><code>Drawnix</code> 的定位是一个开箱即用、开源、免费的工具产品，它的底层是 <code>Plait</code>框架，<code>Plait</code> 是作者公司开源的一款画图框架，代表着公司在知识库产品上的重要技术沉淀。</p>
<p><code>Drawnix</code> 是插件架构，与前面说到开源工具比技术架构更复杂一些，但是插件架构也有优势，比如能够支持多种 <code>UI</code> 框架（<code>Angular</code>、<code>React</code>），能够集成不同富文本框架（当前仅支持 <code>Slate</code>框架），在开发上可以很好的实现业务的分层，开发各种细粒度的可复用插件，可以扩展更多的画板的应用场景。</p>
<p><code>GitHub</code>地址：</p>
<h3 data-id="heading-4">2.3 特性</h3>
<ul>
<li>💯 免费 + 开源</li>
<li>⚒️ 思维导图、流程图</li>
<li>🖌 画笔</li>
<li>😀 插入图片</li>
<li>🚀 基于插件机制</li>
<li>🖼️ 📃 导出为 PNG, JSON(<code>.drawnix</code>)</li>
<li>💾 自动保存（浏览器缓存）</li>
<li>⚡ 编辑特性：撤销、重做、复制、粘贴等</li>
<li>🌌 无限画布：缩放、滚动</li>
<li>🎨 主题模式</li>
<li>📱 移动设备适配</li>
<li>📈 支持 mermaid 语法转流程图</li>
<li>✨ 支持 markdown 文本转思维导图（新支持 🔥🔥🔥）</li>
</ul>
<h3 data-id="heading-5">2.4 安装</h3>
<p>提供<code>Docker</code>部署：</p>
<pre><code class="hljs language-sh" lang="sh">docker pull pubuzhixing/drawnix:latest
</code></pre>
<p>也可以在线使用：</p>
<p>地址：</p>
<h2 data-id="heading-6">03 最佳实践</h2>
<p>实践我们采用在线方式，如果注重安全或者本地使用可以使用<code>Docker</code>部署。</p>
<h3 data-id="heading-7">3.1 界面说明</h3>
<p>通过<code>https://drawnix.com/</code>进入之后，所有功能如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1050e9bc264de3b953043d5d33b19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=wSlN%2Bab1vWJtIehD7RrD3%2F64YBA%3D" alt="" loading="lazy"/></p>
<p>中间工具栏分别表示：</p>
<ul>
<li>拖拽</li>
<li>选中</li>
<li>思维导图</li>
<li>文字</li>
<li>手绘</li>
<li>箭头</li>
<li>流程图</li>
<li>插入图片</li>
<li>格式转换</li>
</ul>
<p>功能都比较简单，思维导图、流程图以及格式转化是常用的工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17d70fca32644037a52d5b30600c76d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=rPCwuGYDZ0OtICIaWme7hN8CUrE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 思维导图</h3>
<p>思维导图的使用方式和<code>Xmind</code>的用法极为相似。选中节点，然后<code>Tab</code>键就可以添加同级子节点，也可以利用<code>+</code>号添加。<code>-</code>号并不是删除，而是合并。删除也非常简单，选中直接<code>Delete</code>即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/253053338d2e4fad9b280bbd1abdd554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=29EXmJucrIPvcGoTl6actyUkNhE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.3 流程图</h3>
<p>流程图的图形相对来说比较简单，只有七项。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2324740772ea409f98298583d7bd5115~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=gZmqMXebA63ivy6m8RC07wMMizg%3D" alt="" loading="lazy"/></p>
<p>选中之后直接绘制即可，图形之间使用箭头链接即可。</p>
<h3 data-id="heading-10">3.4 格式转化</h3>
<p>目前支持两种格式转化成流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35787be17174e36b5f939f55898cd0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=OKi2U0L%2Bmo%2Bk5stpOPLMTEv7YdI%3D" alt="" loading="lazy"/></p>
<p><strong>Mermaid</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/348d3bc49d6e4c3ab89f69db4c71c5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=aB%2F1hlGPV4%2F3BRkQBtAKBM90bio%3D" alt="" loading="lazy"/></p>
<p>仅支持流程图、序列图和类图</p>
<p><strong>Markdown</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e135f734d244b1b8688f27082a54efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=s3Sxc7cdzoDgTOii7GSOgJL0rC0%3D" alt="" loading="lazy"/></p>
<p>仅支持思维导图。</p>
<h2 data-id="heading-11">04 小结</h2>
<p><code>Drawnix</code>的极简设计满足日常绘图的需要，可能在很多功能上不如<code>Xmind</code>或者亿图，但是它确实两者的结合。是一款不错的绘图软件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存]]></title>    <link>https://juejin.cn/post/7582041304655249454</link>    <guid>https://juejin.cn/post/7582041304655249454</guid>    <pubDate>2025-12-10T16:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582041304655249454" data-draft-id="7582048028393226290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存"/> <meta itemprop="keywords" content="Android,性能优化,架构"/> <meta itemprop="datePublished" content="2025-12-10T16:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T16:27:50.000Z" title="Wed Dec 10 2025 16:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这个世界就是这样，你从失败中学到的东西可能比成功中学到的东西更多——《Android 传奇》</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96da1c986c7f488ebbcbd5279fc0a176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=kLTZAbmB93gghO%2BJXhrsAVxIb2c%3D" alt="image.png" loading="lazy"/></p>
<p>说起 Android APP 内存分析，我们第一时间想到的，往往是 Android Studio Profiler、MAT 这样的老牌工具，而 Perfetto 的出现，又为其提供了一种更加贴近底层的视角。而且相比于现有的工具，Perfetto 更加擅长于分析 Native 内存占用，可以说是补齐了工程师在这方面的短板。</p>
<p><strong>在内存方向，我计划用2~3篇文章来介绍 Perfetto 的功能、特点、使用方法等</strong> 。作为第1篇，本文包含以下内容：</p>
<ul>
<li>Android APP 所申请的内存分类（Java、Native）</li>
<li>如何抓取、分析这两类内存占用情况，并提供对应的 Perfetto 操作实例</li>
</ul>
<h2 data-id="heading-0">APP 占用内存分类</h2>
<p>Android 系统框架是由 Linux 发展而来的，对于每一个应用程序（APP），框架为其初始分配一个进程，并启动了一个 ART 虚拟机（更早时候是 Dalvik），这个虚拟机用于解释执行 Java 字节码。因此，一个 APP 所占用的内存，可以归结为两类：在 Linux 层申请的 Native 内存，以及在 JVM 上申请的 Java 内存。</p>
<ul>
<li><strong>Native 内存</strong> ：由 C/C++/Rust 进程申请，其底层使用 <code>libc</code> 的 <code>malloc()/free()</code> 函数进行内存申请/释放。此外，APP 通过 JNI 也可申请此部分内存，例如 <code>java.util.regex.Pattern</code> 类的大部分功能，就同时申请了 Native 内存和 Java 内存。</li>
<li><strong>Java 内存</strong> ：由应用内的 Java/Kotlin 代码，通过 <code>new X()</code> 的方式申请，位于 <strong>堆</strong> 上，由系统自动进行回收。</li>
</ul>
<p>针对上述内存使用场景，Perfetto 提供了两种技术进行分析。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling%23native-c-c-rust-heap-profling" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling#native-c-c-rust-heap-profling" ref="nofollow noopener noreferrer">heap profiling（堆分析）</a> 适用于 Native 代码，通过 AOP，追踪 <code>malloc/free</code> 函数调用链，从而识别出每个函数引起的内存变化，集成在火焰图当中展示。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling%23java-managed-heap-dumps" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling#java-managed-heap-dumps" ref="nofollow noopener noreferrer">heap dump（堆转储）</a> 适用于 Java 代码，展示对象之间的引用关系，但不包含调用链。</li>
</ul>
<h2 data-id="heading-1">Native (C/C++/Rust) 内存分析</h2>
<p>在 C/C++/Rust 语言中，使用底层的 <code>malloc/free</code> 函数进行内存申请和释放，Perfetto 通过 AOP 技术，在这些函数内部注入代码进行拦截，因此能够识别每一次内存的细微变动。出于在应用性能和抓取效果之间保持平衡的考虑，还提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdesign-docs%2Fheapprofd-sampling" target="_blank" title="https://perfetto.dev/docs/design-docs/heapprofd-sampling" ref="nofollow noopener noreferrer">sampling（采样）</a> 机制。</p>
<p>需要注意的是，Native 内存分析是 <strong>不可追溯</strong> 的，它只能记录从 <strong>启动 Perfetto 的时间点之后</strong> 的内存分配。这意味着，如果内存问题已经发生后，再进行 Native 内存追踪，会有无法识别引起内存问题的函数的风险（内存泄漏则不一样，因为它无时无刻不在发生）。</p>
<h3 data-id="heading-2">案例：NowInAndroid</h3>
<p>我们知道，在 Android 7.1（API 25）之前，Bitmap 对象的像素数据是使用 Dalvik heap 存储的，在拿到 heap 文件后，可以直接导出并看到图片内容。从 Android 7.1 开始，Bitmap 的存储位置从 Dalvik heap 转移到了 Native heap。这样一来，虽然可以避免大量图片资源耗尽 JVM 内存，但也容易让人忽视掉 Native 内存管理，导致 OOM 发生。</p>
<p>Perfetto 的 Native 内存分析，可以用来识别这种落在 Native heap 的内存分配调用链。我们以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fnowinandroid" target="_blank" title="https://github.com/android/nowinandroid" ref="nofollow noopener noreferrer">NowInAndroid</a> 项目为例。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21771e680e7a4828908a89d5d7d024f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=xL1BJ013%2Bb8NaFWwiMIsupANRJ8%3D" alt="nowinandroid_homepage.png" width="30%" loading="lazy"/>
<p>APP 的首页是图文元素构成的瀑布流，在频繁滑动的情况下，会产生大量 Native 内存申请/回收的现象，我们通过 Perfetto 对此进行观察。</p>
<p>在网页端开启 Memory 目录下的 Native heap profiling 开关，同时填入待分析的包名 <code>com.google.samples.apps.nowinandroid.demo.debug</code>，可以通过命令 <code>adb shell ps -A</code> 来查看进程对应的包名。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df13ec90a854c42abe34f51eea2c9af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=LIB7xBpAypxiKtqOfIwUkW93jRw%3D" alt="perfetto_native_profiling.png" width="70%" loading="lazy"/>
<p>控制台参数如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">buffers {
  size_kb: 65536
  fill_policy: DISCARD
}
data_sources {
  config {
    name: &amp;#34;android.heapprofd&amp;#34;
    heapprofd_config {
      sampling_interval_bytes: 4096
      process_cmdline: &amp;#34;com.google.samples.apps.nowinandroid.demo.debug&amp;#34;
      shmem_size_bytes: 8388608
      block_client: true
      all_heaps: false
    }
  }
}
duration_ms: 10000
</code></pre>
<p>接下来点击 <code>Start tracing</code> 开始抓取，在 10s 的抓取过程中，上滑页面，以加载更多图片和文字。抓取结果如下：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede55f4c37424b06a388851b68580ba6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=R6Fe%2FqYH%2FYvqZ8TpqgVyUXYQmDA%3D" alt="perfetto_native_profiling_result.png" width="70%" loading="lazy"/>
<p>图例比较简单，分成左上角的“<strong>数据选择</strong>”、右上角的“<strong>展示方式</strong>”和占据正中央大部分的“<strong>火焰图</strong>”，依次介绍之。</p>
<p>“<strong>数据选择</strong>”区域，共有4种排序方式，分别是：</p>
<ul>
<li><strong>Unreleased Malloc Size（未释放内存分配大小）</strong>：默认模式，按未释放内存 <code>字节数</code> 的总和聚合调用栈。</li>
<li><strong>Unreleased Malloc Count（未释放内存分配计数）</strong>：按 <code>计数</code>聚合未释放的内存分配，忽略每次分配的大小。这有助于发现小规模的内存泄漏，即每个对象都很小，但随着时间的推移，大量对象会累积起来。通常称之为 <code>内存碎片</code>。</li>
<li><strong>Total Malloc Size（总内存分配大小）</strong>：按通过 <code>malloc()</code> 分配的内存字节数聚合调用栈，无论这些内存是否已被释放。这有助于调查堆频繁调用，即即使最终释放了内存，也会对分配器造成很大压力的代码路径。通常称之为 <code>内存波动</code>。</li>
<li><strong>Total Malloc Count（总内存分配计数）</strong>：与上述类似，但按 <code>malloc()</code> 调用次数聚合，忽略每次分配的大小。</li>
</ul>
<p>我们目前选择的是默认的 <code>Unreleased Malloc Size</code> 选项。</p>
<p>“<strong>展示方式</strong>”区域，分为“自顶向下”和“自底向上”，前者的火焰向下生长，后者反之，不赘述。</p>
<p>“<strong>火焰图</strong>”区域，是性能分析的重点，通过层叠的形式展示函数调用链路，每个色块（Block）的面积表示该函数引起的内存增加，发生在相同层级的同一个函数，会被聚合展示。图中的火焰图可以看出，NowInAndroid 代码写的相对健壮，回收和复用都做得比较好，因此 RecyclerView 中未见内存泄漏。</p>
<h2 data-id="heading-3">Java 内存快照</h2>
<p>在 JVM 系语言中，通过自动回收机制管理内存，大部分 Profiling 工具都是进行内存快照，计算当前虚拟机的 <code>全部对象</code> 及其 <code>引用关系</code>，从而形成一张完整的对象图。</p>
<p><strong>Java 内存快照的不足之处是，无法通过它查看函数调用链路，即哪些函数引起了多大的内存增长。</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea458224cbc42e28a888a8babfd9f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=LiYPEzs45oSm4pMEKe9WIHSQrXs%3D" alt="perfetto_java_profiling.png" width="70%" loading="lazy"/>
<p>开始抓取后，上滑页面直至完成10s的抓取，以下是抓取到的结果。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ca3959a6a14f1bad35506ee1e9a3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018686&amp;x-signature=vPCFQeXme1%2BBrffrMOzK9%2B4T74s%3D" alt="perfetto_java_profiling_result.png" width="70%" loading="lazy"/>
<p>可以看到，<code>Bitmap</code> 占据了内存的大部分。此外，String数量有 <code>96433</code> 个，也同样值得关注。</p>
<blockquote>
<p>未完待续……</p>
</blockquote>
<h2 data-id="heading-4">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling" ref="nofollow noopener noreferrer">perfetto.dev/docs/gettin…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fcase-studies%2Fmemory" target="_blank" title="https://perfetto.dev/docs/case-studies/memory" ref="nofollow noopener noreferrer">perfetto.dev/docs/case-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fnative-heap-profiler" target="_blank" title="https://perfetto.dev/docs/data-sources/native-heap-profiler" ref="nofollow noopener noreferrer">perfetto.dev/docs/data-s…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[秒懂 Headless：为什么现在的软件都要“去头”？]]></title>    <link>https://juejin.cn/post/7582118218649288730</link>    <guid>https://juejin.cn/post/7582118218649288730</guid>    <pubDate>2025-12-11T05:39:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118218649288730" data-draft-id="7582156410319536138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="秒懂 Headless：为什么现在的软件都要“去头”？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T05:39:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            秒懂 Headless：为什么现在的软件都要“去头”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T05:39:51.000Z" title="Thu Dec 11 2025 05:39:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    73
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来说， <strong>“Headless”（无头）</strong> 在软件开发中指的是：<strong>只有逻辑（后端/内核），没有预设界面（前端/GUI）</strong> 的软件架构模式。</p>
<p>这里的“Head（头）”比喻的是<strong>用户界面（UI/GUI）</strong> ，“Body（身体）”比喻的是<strong>核心业务逻辑或引擎</strong>。</p>
<p><strong>Headless = 砍掉自带的 UI，只给你提供 API 或核心逻辑，让你自己去画界面。</strong></p>
<hr/>
<h3 data-id="heading-0">1. 核心概念图解</h3>
<p>想象一下 <strong>“传统的软件”</strong>（比如 Word）：它像一家<strong>堂食餐厅</strong>。你有厨房（逻辑），也有固定的桌椅板凳和装修风格（UI）。你必须在它提供的环境里吃饭，无法改变装修。</p>
<p>而 <strong>“Headless 软件”</strong>：它像一个<strong>中央厨房（外卖工厂）</strong>。它只负责做饭（逻辑），不提供桌椅（UI）。</p>
<ul>
<li>你想把菜送到五星级酒店摆盘（Web 端高级定制 UI）？可以。</li>
<li>你想把菜送到路边摊（手机 App）？可以。</li>
<li>你想把菜送到自动售货机（小程序）？也可以。</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 具体例子</h3>
<h4 data-id="heading-2">A. 无头浏览器 (Headless Browser)</h4>
<ul>
<li>
<p><strong>传统的浏览器（如 Chrome）：</strong> 你打开它，能看到窗口、地址栏、渲染出来的网页，你能用鼠标点击。</p>
</li>
<li>
<p><strong>无头浏览器（如 Puppeteer, Playwright）：</strong></p>
<ul>
<li>
<p><strong>定义：</strong> 它是浏览器内核（Chrome/Webkit），但<strong>没有可视化的窗口</strong>。它在后台（命令行/服务器）运行。</p>
</li>
<li>
<p><strong>怎么用？</strong> 你写代码控制它：“打开百度 -&gt; 输入关键词 -&gt; 截图”。</p>
</li>
<li>
<p><strong>有什么用？</strong></p>
<ol>
<li><strong>自动化测试：</strong> 模拟用户点击，快速跑通几千个测试用例，不需要真的弹出一千个窗口。</li>
<li><strong>爬虫：</strong> 爬取那些需要 JS 渲染的复杂网页。</li>
<li><strong>生成截图/PDF：</strong> 在服务器端把网页渲染成图片或 PDF 报告。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">B. 无头编辑器 (Headless Editor)</h4>
<ul>
<li>
<p><strong>传统的编辑器（如 CKEditor 旧版, Quill）：</strong></p>
<ul>
<li>你引入它，它就自带一套“加粗、斜体、插入图片”的工具栏，自带一套 CSS 样式。</li>
<li><strong>缺点：</strong> 如果设计师说“把工具栏按钮变成圆形的，而且要悬浮在文字上方”，你就要疯狂覆盖它的默认 CSS，非常痛苦。</li>
</ul>
</li>
<li>
<p><strong>无头编辑器（如 Tiptap, Plate, Slate.js）：</strong></p>
<ul>
<li><strong>定义：</strong> 它只提供<strong>文字处理的核心逻辑</strong>（比如：选中文本、按下 Ctrl+B 变粗体、撤销重做逻辑）。它<strong>不提供任何 UI</strong>（没有工具栏，没有按钮）。</li>
<li><strong>怎么用？</strong> 你需要自己写一个 <code>&lt;button&gt;</code>，自己写样式，然后调用它的 API <code>editor.toggleBold()</code>。</li>
<li><strong>有什么用？</strong> 你可以完全自由地定制编辑器的长相。比如 Notion、飞书文档那种高度定制的 UI，必须用无头编辑器开发。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">3. 还有哪些常见的 Headless？</h3>
<p>除了浏览器和编辑器，现在的开发趋势中还有：</p>
<h4 data-id="heading-5">C. 无头组件库 (Headless UI)</h4>
<ul>
<li><strong>例子：</strong> Radix UI, Headless UI, React Aria。</li>
<li><strong>解释：</strong> 以前我们用 Ant Design 或 Bootstrap，按钮长什么样是库定好的。Headless UI 库只提供<strong>交互逻辑</strong>（比如下拉菜单怎么打开，键盘怎么选，无障碍怎么读），<strong>不提供任何 CSS</strong>。</li>
<li><strong>好处：</strong> 完美配合 Tailwind CSS，长相由你完全控制。</li>
</ul>
<h4 data-id="heading-6">D. 无头 CMS (Headless CMS)</h4>
<ul>
<li><strong>例子：</strong> Strapi, Contentful。</li>
<li><strong>解释：</strong> 以前用 WordPress，后台管理内容，前台页面也是 WordPress 生成的（耦合）。Headless CMS 只提供<strong>后台管理</strong>和 <strong>API</strong>。</li>
<li><strong>好处：</strong> 你的一份内容（API）可以同时发给 网站、App、智能手表、甚至冰箱屏幕。</li>
</ul>
<hr/>
<h3 data-id="heading-7">总结：为什么现在流行 Headless？</h3>
<p>虽然 Headless 意味着开发者要写更多的代码（因为要自己画 UI），但它解决了现代开发最大的痛点：<strong>定制化</strong>。</p>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>传统 (Coupled)</strong></th><th><strong>Headless (无头)</strong></th></tr></thead><tbody><tr><td><strong>上手难度</strong></td><td><strong>低</strong> (开箱即用)</td><td><strong>高</strong> (需要自己写 UI)</td></tr><tr><td><strong>自由度</strong></td><td><strong>低</strong> (改样式很难)</td><td><strong>极高</strong> (随心所欲)</td></tr><tr><td><strong>适用场景</strong></td><td>快速做个标准后台</td><td>像 Notion/Figma 这种需要极致体验的产品</td></tr><tr><td><strong>比喻</strong></td><td><strong>方便面</strong> (有面有调料包，味道固定)</td><td><strong>生鲜面条</strong> (只有面，想做炸酱面还是汤面随你)</td></tr></tbody></table>
<p><strong>一句话总结：Headless 就是把“业务逻辑”和“界面表现”彻底分家，让你拥有无限的 UI 定制权。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机]]></title>    <link>https://juejin.cn/post/7571060853354266634</link>    <guid>https://juejin.cn/post/7571060853354266634</guid>    <pubDate>2025-11-10T15:57:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571060853354266634" data-draft-id="7570897638441336859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机"/> <!----> <meta itemprop="datePublished" content="2025-11-10T15:57:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="福尔摩斯的弟子"/> <meta itemprop="url" content="https://juejin.cn/user/622743759107883"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/622743759107883/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    福尔摩斯的弟子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T15:57:49.000Z" title="Mon Nov 10 2025 15:57:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机</h2>
<h3 data-id="heading-1">面试场景：某大厂技术二面现场，会议室里坐着一位神情严肃的面试官，对面是满脸写着"我可能要凉了"的程序员谢飞机。</h3>
<h4 data-id="heading-2"><strong>第一轮提问：基础夯实</strong></h4>
<p><strong>面试官</strong>：谢飞机，先聊聊你对Java内存模型的理解吧。我们公司用的是JDK17，你能说说它和JDK8在内存模型上的主要区别吗？</p>
<p><strong>谢飞机</strong>（挠头）：呃……我记得好像有堆、栈、方法区，还有个元空间对吧？以前叫永久代，现在改名叫元空间了，因为……嗯……更高级了？</p>
<p><strong>面试官</strong>（微微点头）：不错，回答得挺准确。那你知道为什么要把永久代换成元空间吗？</p>
<p><strong>谢飞机</strong>：因为……永久代容易内存溢出，而且不能动态扩容，而元空间是放在本地内存里的，不会受堆大小限制，所以更稳！</p>
<p><strong>面试官</strong>（微笑）：很好，回答得很到位。继续，说说volatile关键字的作用，以及它如何保证可见性和禁止指令重排序。</p>
<p><strong>谢飞机</strong>：哦，volatile就是让变量在多个线程之间共享，每次读都从主内存拿，写也直接写到主内存，这样就保证了可见性。至于指令重排序，它会加一个内存屏障，阻止编译器和处理器乱序执行，对吧？</p>
<p><strong>面试官</strong>：完全正确，看来你确实掌握了核心概念。</p>
<h4 data-id="heading-3"><strong>第二轮提问：并发与线程池</strong></h4>
<p><strong>面试官</strong>：很好。接下来我们进入多线程部分。你能不能解释一下线程池的核心参数有哪些？它们各自的作用是什么？</p>
<p><strong>谢飞机</strong>：核心线程数、最大线程数、工作队列、拒绝策略、线程工厂、超时时间……啊，还有个线程存活时间。核心线程数是最低保持的线程数量，最大线程数是上限，工作队列放任务，拒绝策略处理来不及的任务，线程工厂用来创建线程，存活时间是空闲线程等待任务的时间。</p>
<p><strong>面试官</strong>：非常清晰，逻辑完整。那么，如果使用ThreadPoolExecutor，你如何合理设置这些参数来应对高并发场景？比如一个秒杀系统。</p>
<p><strong>谢飞机</strong>：嗯……我觉得可以设核心线程数为服务器核数的两倍，最大线程数可以再翻倍，工作队列用阻塞队列，比如LinkedBlockingQueue，拒绝策略用CallerRunsPolicy，这样能防止系统雪崩。</p>
<p><strong>面试官</strong>：思路很清晰。但有没有考虑过队列长度过大带来的内存压力？</p>
<p><strong>谢飞机</strong>：啊……这个……我还没想那么深……不过反正有拒绝策略兜底嘛，应该没问题吧？</p>
<p><strong>面试官</strong>（轻笑）：建议你记住一句话：<strong>队列不是万能的，它只是延迟问题，不是解决问题</strong>。继续，说说你对ThreadLocal的理解，它有什么用途？</p>
<p><strong>谢飞机</strong>：哦，ThreadLocal就是每个线程都有自己的副本，互不干扰，适合做线程隔离，比如保存用户登录信息、事务上下文什么的。</p>
<p><strong>面试官</strong>：很好。但要注意什么？</p>
<p><strong>谢飞机</strong>：啊……要记得在finally里remove掉，不然可能内存泄漏……</p>
<p><strong>面试官</strong>：对，这是关键点，很多新人会忽略。</p>
<h4 data-id="heading-4"><strong>第三轮提问：框架与中间件</strong></h4>
<p><strong>面试官</strong>：很好。现在我们进入框架部分。你用过Spring Boot，能说说它的自动装配机制是怎么工作的吗？</p>
<p><strong>谢飞机</strong>：哦，自动装配就是通过@Import、@ConditionalOnClass这些注解，根据类路径是否存在某些类来决定是否加载配置类。比如你引入了Redis依赖，就会自动配置RedisTemplate。</p>
<p><strong>面试官</strong>：非常准确。那Spring的Bean生命周期有几个阶段？</p>
<p><strong>谢飞机</strong>：实例化、属性赋值、初始化、销毁……啊，还有个Aware接口回调，比如ApplicationContextAware，还有InitializingBean接口，然后才是postConstruct……</p>
<p><strong>面试官</strong>：很好，你把整个流程都说清楚了。那你说说MyBatis的缓存机制，一级缓存和二级缓存的区别是什么？</p>
<p><strong>谢飞机</strong>：一级缓存是SqlSession级别的，同一个SqlSession里查询数据会命中；二级缓存是Mapper级别的，跨SqlSession共享，但需要手动开启，并且实体类要实现Serializable。</p>
<p><strong>面试官</strong>：非常准确。那在分布式环境下，二级缓存怎么解决一致性问题？</p>
<p><strong>谢飞机</strong>：这个……我好像没遇到过……也许可以用Redis做分布式缓存？或者……加个版本号？</p>
<p><strong>面试官</strong>（点头）：不错，思路打开了。最后一个问题，谈谈你对DDD领域驱动设计的理解，它和传统的分层架构有什么不同？</p>
<p><strong>谢飞机</strong>：嗯……就是把业务逻辑拆成一个个领域，用实体、值对象、聚合根来建模，然后用领域服务来处理复杂逻辑。相比传统架构，它更贴近业务，代码更有层次感，不容易混乱。</p>
<p><strong>面试官</strong>：很好，回答得很有深度。虽然有些地方略显粗糙，但整体理解到位。</p>
<h4 data-id="heading-5"><strong>结束语</strong></h4>
<p><strong>面试官</strong>：谢飞机，今天的面试就到这里。你的基础知识扎实，对主流框架有较深理解，虽然在一些细节上还略有欠缺，但潜力很大。请回去等通知，我们会在3个工作日内给你答复。</p>
<p><strong>谢飞机</strong>（松了一口气）：谢谢面试官！我回去好好补课，争取下次别再被问懵了！</p>
<hr/>
<h3 data-id="heading-6">答案详解：核心技术点解析（小白也能看懂）</h3>
<h4 data-id="heading-7">1. Java内存模型（JMM）</h4>
<ul>
<li><strong>堆</strong>：存放所有对象实例，垃圾回收的主要区域。</li>
<li><strong>栈</strong>：存放局部变量、方法调用栈帧，每个线程独立。</li>
<li><strong>方法区</strong>：存储类信息、常量、静态变量等，JDK8后更名为<strong>元空间</strong>（Metaspace），位于本地内存，不再受限于堆大小。</li>
<li><strong>元空间替代永久代的原因</strong>：永久代在堆中，容易导致<code>OutOfMemoryError</code>；元空间使用本地内存，可动态扩展，避免内存溢出。</li>
</ul>
<h4 data-id="heading-8">2. volatile关键字</h4>
<ul>
<li><strong>可见性</strong>：当一个线程修改volatile变量，其他线程能立即看到最新值（通过内存屏障刷新主内存）。</li>
<li><strong>禁止指令重排序</strong>：插入内存屏障，防止编译器或处理器对代码进行乱序优化，确保执行顺序符合预期。</li>
<li><strong>典型应用</strong>：单例模式中的双重检查锁、状态标志位等。</li>
</ul>
<h4 data-id="heading-9">3. 线程池核心参数 &amp; 调优</h4>
<ul>
<li><code>corePoolSize</code>：核心线程数，即使空闲也不会被回收。</li>
<li><code>maximumPoolSize</code>：最大线程数，超过核心数后才创建新线程。</li>
<li><code>workQueue</code>：任务队列，如<code>LinkedBlockingQueue</code>（无界）、<code>ArrayBlockingQueue</code>（有界）、<code>SynchronousQueue</code>（直接提交）。</li>
<li><code>rejectedExecutionHandler</code>：拒绝策略，如<code>AbortPolicy</code>（抛异常）、<code>CallerRunsPolicy</code>（由调用线程执行）。</li>
<li><strong>调优建议</strong>：
<ul>
<li>CPU密集型任务：<code>corePoolSize = CPU核数 + 1</code></li>
<li>I/O密集型任务：<code>corePoolSize = 2 * CPU核数</code></li>
<li>队列选择：避免无界队列导致内存溢出，建议使用有界队列配合拒绝策略。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">4. ThreadLocal使用注意事项</h4>
<ul>
<li>每个线程拥有独立副本，适用于线程隔离场景（如用户登录上下文、事务管理）。</li>
<li><strong>必须手动清理</strong>：在<code>finally</code>块中调用<code>threadLocal.remove()</code>，否则可能导致内存泄漏（因ThreadLocalMap持有强引用）。</li>
</ul>
<h4 data-id="heading-11">5. Spring Boot自动装配原理</h4>
<ul>
<li>基于<code>@EnableAutoConfiguration</code>注解，扫描<code>META-INF/spring.factories</code>文件，加载<code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>指定的自动配置类。</li>
<li>使用<code>@ConditionalOnClass</code>、<code>@ConditionalOnMissingBean</code>等条件注解控制是否生效，实现“按需加载”机制。</li>
</ul>
<h4 data-id="heading-12">6. Spring Bean生命周期</h4>
<ol>
<li><strong>实例化</strong>：通过构造函数或工厂方法创建对象。</li>
<li><strong>属性赋值</strong>：注入依赖（@Autowired）。</li>
<li><strong>Aware接口回调</strong>：如ApplicationContextAware、BeanNameAware等。</li>
<li><strong>InitializingBean接口</strong>：调用<code>afterPropertiesSet()</code>方法。</li>
<li><strong>@PostConstruct注解方法</strong>：执行自定义初始化逻辑。</li>
<li><strong>Bean初始化完成</strong>：注册到容器中。</li>
<li><strong>销毁</strong>：调用<code>@PreDestroy</code>或<code>DisposableBean</code>接口方法。</li>
</ol>
<h4 data-id="heading-13">7. MyBatis缓存机制</h4>
<ul>
<li><strong>一级缓存</strong>：默认开启，作用域为SqlSession，同一会话内重复查询命中缓存。</li>
<li><strong>二级缓存</strong>：作用域为Mapper级别，需手动开启（<code>&lt;cache /&gt;</code>标签），跨会话共享，但需实体类实现<code>Serializable</code>接口。</li>
<li><strong>一致性问题</strong>：由于缓存异步更新，可能出现脏读。解决方案：
<ul>
<li>用Redis等分布式缓存替代。</li>
<li>启用<code>@CacheNamespaceRef</code>和<code>@Options(flushCache = true)</code>强制刷新。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">8. DDD领域驱动设计核心思想</h4>
<ul>
<li><strong>领域模型</strong>：以业务为核心，将复杂业务抽象为实体（Entity）、值对象（Value Object）、聚合根（Aggregate Root）。</li>
<li><strong>分层架构</strong>：
<ul>
<li><strong>表现层</strong>：处理前端请求。</li>
<li><strong>应用层</strong>：协调领域服务，处理用例。</li>
<li><strong>领域层</strong>：包含核心业务逻辑和规则。</li>
<li><strong>基础设施层</strong>：数据库、消息队列等外部依赖。</li>
</ul>
</li>
<li><strong>优势</strong>：代码结构清晰，易于维护，业务与技术分离，适合复杂系统长期演进。</li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>总结</strong>：本次面试虽有笑点，但内容扎实。掌握这些核心知识点，是你冲击大厂的关键一步。持续学习，未来可期！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？]]></title>    <link>https://juejin.cn/post/7582067084840534070</link>    <guid>https://juejin.cn/post/7582067084840534070</guid>    <pubDate>2025-12-10T23:31:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084840534070" data-draft-id="7582067084840517686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-10T23:31:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小马写码"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小马写码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T23:31:16.000Z" title="Wed Dec 10 2025 23:31:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    48
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Vue 状态管理的时代变迁</h2>
<p>在 Vue.js 应用开发的世界里，状态管理一直是构建复杂应用的核心课题。多年来，Vuex 作为官方状态管理库，几乎成为 Vue 项目的标准配置。然而，随着 Vue 3 的推出和开发理念的演进，一个全新的挑战者——<strong>Pinia</strong>——悄然登场，并迅速赢得了开发者的青睐。它不仅被 Vue 官方推荐为“默认的状态管理解决方案”，更以其简洁、直观和强大的特性，正在重新定义我们对 Vue 状态管理的认知。</p>
<h2 data-id="heading-1">一、Pinia 是什么？不仅仅是“另一个状态库”</h2>
<p>Pinia 是一个为 Vue.js 设计的状态管理库。它由 Vue 核心团队成员开发，旨在提供更直观、类型安全且模块化的状态管理体验。</p>
<p>与 Vuex 相比，Pinia 最显著的哲学转变是：<strong>它摒弃了 mutations 的概念</strong>。这个设计决策看似简单，却带来了开发体验的质变。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Pinia 的 Store 示例 - 简洁直观</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ <span class="hljs-comment">// 直接修改状态，无需 mutations</span>
    },
  },
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,
  },
})
</code></pre>
<h2 data-id="heading-2">二、为什么选择 Pinia？五大核心优势</h2>
<h3 data-id="heading-3">1. 更简洁的 API 设计</h3>
<p>Pinia 的 API 极度精简，学习曲线平缓。去掉了 Vuex 中的 <code>mutations</code>，状态修改可以通过 actions 直接完成，也可以直接赋值修改（配合响应式系统）。这种设计减少了概念数量，让代码更易读易写。</p>
<h3 data-id="heading-4">2. 完美的 TypeScript 支持</h3>
<p>Pinia 从一开始就为 TypeScript 设计，提供了出色的类型推断。你的 store、state、actions 和 getters 都能获得完整的类型安全，大幅提升开发效率和代码可靠性。</p>
<h3 data-id="heading-5">3. 模块化的自然实现</h3>
<p>在 Pinia 中，每个 store 都是独立的模块，无需像 Vuex 那样在单一 store 中注册模块。这种设计让代码组织更加灵活，也便于代码分割和按需加载。</p>
<h3 data-id="heading-6">4. 更友好的开发体验</h3>
<ul>
<li><strong>Composition API 风格</strong>：与 Vue 3 的 Composition API 完美契合</li>
<li><strong>DevTools 集成</strong>：支持 Vue DevTools，提供时间旅行调试</li>
<li><strong>热模块替换</strong>：支持开发时的热更新，保持状态不丢失</li>
</ul>
<h3 data-id="heading-7">5. 轻量且高性能</h3>
<p>Pinia 体积小巧，同时通过智能的设计避免了不必要的性能开销。它的响应式系统直接构建在 Vue 的 reactive API 之上，确保了高效的状态更新。</p>
<h2 data-id="heading-8">三、从 Vuex 迁移到 Pinia：一个平滑的过渡</h2>
<p>对于 Vuex 用户，迁移到 Pinia 是一个相对平滑的过程。两者核心概念有相似之处，但 Pinia 提供了更简洁的实现：</p>



































<table><thead><tr><th>特性</th><th>Vuex 4</th><th>Pinia</th></tr></thead><tbody><tr><td>状态定义</td><td><code>state</code> 函数</td><td><code>state</code> 函数</td></tr><tr><td>获取状态</td><td><code>getters</code></td><td><code>getters</code></td></tr><tr><td>修改状态</td><td><code>mutations</code> + <code>actions</code></td><td><code>actions</code>（可直接修改）</td></tr><tr><td>模块系统</td><td>嵌套模块</td><td>独立 store</td></tr><tr><td>TypeScript 支持</td><td>需要额外配置</td><td>开箱即用</td></tr></tbody></table>
<p>迁移示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vuex 方式</span>
<span class="hljs-attr">mutations</span>: {
  <span class="hljs-title function_">SET_COUNT</span>(<span class="hljs-params">state, value</span>) {
    state.<span class="hljs-property">count</span> = value
  }
},
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">updateCount</span>(<span class="hljs-params">{ commit }, value</span>) {
    <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SET_COUNT'</span>, value)
  }
}

<span class="hljs-comment">// Pinia 方式（更简洁）</span>
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">updateCount</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = value <span class="hljs-comment">// 直接赋值，响应式系统自动处理</span>
  }
}
</code></pre>
<h2 data-id="heading-9">四、实战：构建你的第一个 Pinia Store</h2>
<p>让我们通过一个简单的用户管理示例，快速上手 Pinia：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/user.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">isAuthenticated</span>: <span class="hljs-literal">false</span>,
  }),
  
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">credentials</span>) {
      <span class="hljs-comment">// 模拟 API 调用</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(credentials)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = response.<span class="hljs-property">user</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAuthenticated</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, response.<span class="hljs-property">token</span>)
    },
    
    <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = <span class="hljs-literal">null</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAuthenticated</span> = <span class="hljs-literal">false</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'token'</span>)
    },
  },
  
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">userName</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">user</span>?.<span class="hljs-property">name</span> || <span class="hljs-string">'Guest'</span>,
    <span class="hljs-attr">isAdmin</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> === <span class="hljs-string">'admin'</span>,
  },
})
</code></pre>
<p>在组件中使用：</p>
<pre><code class="hljs language-vue" lang="vue">
  &lt;div&gt;
    &lt;p&gt;Welcome, {{ userStore.userName }}&lt;/p&gt;
    Logout
  &lt;/div&gt;



import { useUserStore } from '@/stores/user'

const userStore = useUserStore()
// 可以直接访问状态和操作

</code></pre>
<h2 data-id="heading-10">五、高级特性：探索 Pinia 的强大能力</h2>
<h3 data-id="heading-11">1. Store 组合</h3>
<p>Pinia 允许 stores 之间相互调用，便于组织复杂的状态逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/cart.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, {
  <span class="hljs-comment">// ... cart 逻辑</span>
})

<span class="hljs-comment">// stores/checkout.js  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCheckoutStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'checkout'</span>, {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> cartStore = <span class="hljs-title function_">useCartStore</span>()
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 可以访问其他 store</span>
      <span class="hljs-attr">cartItems</span>: cartStore.<span class="hljs-property">items</span>,
    }
  }
})
</code></pre>
<h3 data-id="heading-12">2. 插件系统</h3>
<p>Pinia 支持插件，可以轻松扩展功能，如持久化存储、日志记录等：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 持久化插件示例</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()

pinia.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">{ store }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`pinia-<span class="hljs-subst">${store.$id}</span>`</span>
  <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key)
  <span class="hljs-keyword">if</span> (saved) {
    store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved))
  }
  
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state))
  })
})
</code></pre>
<h2 data-id="heading-13">六、注意事项与最佳实践</h2>
<ol>
<li><strong>命名规范</strong>：建议使用 <code>use</code> 前缀命名 store（如 <code>useUserStore</code>），以符合 Composition API 惯例</li>
<li><strong>避免过度使用</strong>：不是所有状态都需要放入 Pinia，组件本地状态仍应使用 <code>ref</code> 或 <code>reactive</code></li>
<li><strong>保持 Actions 纯净</strong>：虽然可以直接修改状态，但建议通过 actions 进行修改，便于维护和调试</li>
<li><strong>利用 DevTools</strong>：充分利用 Vue DevTools 的 Pinia 面板进行状态调试</li>
</ol>
<h2 data-id="heading-14">结语：迎接 Vue 状态管理的新时代</h2>
<p>Pinia 的出现并非偶然，它代表了 Vue 生态向更简洁、更类型安全、更符合现代开发体验的方向演进。它保留了 Vuex 的核心思想，同时去除了其中的繁复部分，提供了更优雅的解决方案。</p>
<p>对于新项目，Pinia 无疑是默认的最佳选择；对于现有 Vuex 项目，也可以考虑逐步迁移，享受更优的开发体验。正如 Vue 创始人尤雨溪所言："Pinia 就是 Vuex 5，只不过我们决定叫它 Pinia"。</p>
<p>在状态管理的世界里，没有绝对的"最好"，只有"最适合"。而 Pinia，凭借其简洁的设计、出色的 TypeScript 支持和与 Vue 3 的完美融合，正成为越来越多 Vue 开发者的首选。它不仅是一个工具，更是 Vue 生态成熟和进步的标志——让我们以更少的代码，实现更强大的功能，享受更愉快的开发过程。</p>
<p>拥抱 Pinia，就是拥抱 Vue 状态管理的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果我问你 Context，你扛得住吗？]]></title>    <link>https://juejin.cn/post/7582039917217988608</link>    <guid>https://juejin.cn/post/7582039917217988608</guid>    <pubDate>2025-12-11T00:29:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917217988608" data-draft-id="7577284771447685160" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果我问你 Context，你扛得住吗？"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-11T00:29:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果我问你 Context，你扛得住吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:29:49.000Z" title="Thu Dec 11 2025 00:29:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    114
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7581348660824506368" target="_blank" title="https://juejin.cn/post/7581348660824506368">剧情</a>里涉及的开发细节。</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f1b5f6096214ccf89f001ee015b88b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766017789&amp;x-signature=3%2FBmrHIGgXFGVwT2TftDraD7vEI%3D" alt="0.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">什么是 Context，Context 有哪些类型</h2>
<p><code>Context</code> 代表应用程序的环境或状态，提供对应用专属资源和类的访问。它充当应用与 Android 系统之间的桥梁，让组件能够访问资源、数据库、系统服务等。在执行诸如启动 <code>Activity</code>、读取 <code>assets</code> 文件或加载布局等任务时，<code>Context</code> 至关重要。</p>
<p>Android 中有多种类型的 <code>Context</code>。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>在 Android 应用中，为何使用正确的 <code>Context</code> 类型至关重要？<br/>
持有 <code>Activit Context</code> 的长生命周期引用又可能带来哪些风险？</p>
<h3 data-id="heading-2">Application Context</h3>
<p><code>Application Context</code> 与整个应用程序的生命周期绑定。当你需要一个全局、长生命周期且独立于当前 <code>Activity</code> 或 <code>Fragment</code> 的 <code>Context</code> 时，就应使用它。可通过调用 <code>getApplicationContext()</code> 获取。</p>
<p>适用场景：</p>
<ul>
<li>访问全局资源，如 <code>SharedPreferences</code> 或数据库；</li>
<li>注册需贯穿整个应用生命周期的广播接收器；</li>
<li>初始化在整个应用生命周期内持续存在的库或组件。</li>
</ul>
<h3 data-id="heading-3">Activity Context</h3>
<p><code>Activity Context</code>（即 <code>Activity</code> 中的 <code>this</code>）与 <code>Activity</code> 的生命周期绑定，用于访问资源、启动其他 <code>Activity</code>，或加载该 <code>Activity</code> 特有的布局。</p>
<p>适用场景：</p>
<ul>
<li>创建或修改 UI 组件；</li>
<li>启动另一个 <code>Activity</code>；</li>
<li>访问限定于当前 <code>Activity</code> 的资源或主题。</li>
</ul>
<h3 data-id="heading-4">Service Context</h3>
<p><code>Service Context</code> 与 <code>Service</code> 的生命周期绑定，主要用于后台任务，例如执行网络请求或播放音乐。它可访问 <code>Service</code> 所需的系统级服务。</p>
<h3 data-id="heading-5">Broadcast Context</h3>
<p><code>Broadcast Context</code> 在 <code>BroadcastReceiver</code> 被调用时提供。它的生命周期很短，通常仅用于响应特定广播事件。<strong>切勿在此上下文中执行耗时操作。</strong></p>
<h3 data-id="heading-6">Context 的常见使用场景</h3>
<ol>
<li><strong>访问资源</strong>：通过 <code>getString()</code>、<code>getDrawable()</code> 等方法，<code>Context</code> 可用于获取字符串、图片、尺寸等资源。</li>
<li><strong>加载布局</strong>：使用 <code>Context</code> 通过 <code>LayoutInflater</code> 将 XML 布局文件转换为 <code>View</code> 对象。</li>
<li><strong>启动 Activity 和 Service</strong>：调用 <code>startActivity()</code> 或 <code>startService()</code> 时必须传入 <code>Context</code>。</li>
<li><strong>访问系统服务</strong>：通过 <code>getSystemService()</code>，<code>Context</code> 能获取如 <code>ClipboardManager</code>、<code>ConnectivityManager</code> 等系统级服务。</li>
<li><strong>数据库与 <code>SharedPreferences</code> 操作</strong>：<code>Context</code> 用于访问 <strong>SQLite</strong> 数据库或 <code>SharedPreferences</code> 等持久化存储机制。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p><code>Context</code> 是 Android 中的核心组件，使应用能够与系统资源进行交互。Android 提供了多种 <code>Context</code> 类型，如 <code>Application Context</code>、<code>Activity Context</code> 和 <code>Service Context</code>，各自适用于不同场景。正确使用 <code>Context</code> 不仅能高效管理资源，还能避免内存泄漏和崩溃。因此，务必根据实际需求选择合适的 <code>Context</code>，并避免不必要的长期持有。</p>
<h3 data-id="heading-8">进阶：使用 Context 时要注意什么</h3>
<p><code>Context</code> 是 Android 中一种便捷的机制，但使用不当会引发严重问题，比如内存泄漏、崩溃，或者资源处理效率低下。为避免这些陷阱，务必了解其细微差别以及有效使用 <code>Context</code> 的最佳实践。</p>
<p>最常见的问题之一，是在 <code>Activity</code> 或 <code>Fragment</code> 等 <code>Context</code> 的生命周期之外，仍然保留对它们的引用。这会导致内存泄漏，因为垃圾回收器无法回收该 <code>Context</code> 及其相关资源所占用的内存。</p>
<p>例如，下面的示例代码可能会导致内存泄漏：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">object</span> Singleton {
    <span class="hljs-keyword">var</span> context: Context? = <span class="hljs-literal">null</span> <span class="hljs-comment">// If this retains the Activity context, causing a memory leak</span>
}
</code></pre>
<p>相反，对于需要 <code>Context</code> 的长生命周期对象，应使用 <code>Application Context</code>：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">object</span> Singleton {
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> applicationContext: Context
}
</code></pre>
<p>因此，使用合适类型的 <code>Context</code> 至关重要。不同类型的 <code>Context</code> 用途各异，用错类型可能导致意外行为：</p>
<ul>
<li>执行与界面（UI）相关的任务，如加载布局或显示对话框时，使用 <code>Activity Context</code>。</li>
<li>进行与 UI 生命周期无关的操作，如初始化库时，使用 <code>Application Context</code>。</li>
</ul>
<p>下面的示例展示了误用 <code>Application Context</code> 的情况：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(context.getApplicationContext()) <span class="hljs-comment">// Incorrect</span>
</code></pre>
<p>应使用 <code>Activity Context</code> 以确保正确的主题设置：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(activityContext) <span class="hljs-comment">// Correct</span>
</code></pre>
<p>另一个关键考量点是，当关联组件（如 <code>Activity</code> 或 <code>Fragment</code>）被销毁后，要避免使用 <code>Context</code>。访问与已销毁组件绑定的 <code>Context</code>，可能会导致程序崩溃或出现未定义行为，因为与该 <code>Context</code> 关联的资源可能已不复存在。</p>
<p>下面的示例展示了对 <code>Context</code> 的误用，其中自定义视图的创建方式不当：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">activity.finish() <span class="hljs-comment">// The activity is destroyed</span>
<span class="hljs-keyword">val</span> text = TextView(activity) <span class="hljs-comment">// but the TextView retains a reference</span>
</code></pre>
<p><em>如果在 <code>activity</code> 销毁后依然使用 <code>text</code>，是非常危险的行为（例如 <code>activity</code> 销毁后，才请求到数据，然后更新 <code>text</code> 的显示）。</em></p>
<p>避免在后台线程使用 <code>Context</code>。</p>
<p><code>Context</code> 是为主线程设计的，尤其适用于访问资源或与用户界面（UI）交互。在后台线程使用它可能会导致意外崩溃或线程问题。在与 UI 相关的 <code>Context</code> 资源交互前，需切换回主线程：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">viewModelScope.launch {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchData()
    withContext(Dispatchers.Main) {
        Toast.makeText(context, &amp;#<span class="hljs-number">34</span>;Data fetched&amp;#<span class="hljs-number">34</span>;, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<p>总之。</p>
<p>要有效使用 <code>Context</code>，需谨慎考量，规避常见陷阱。不应在 <code>Activity</code> 或 <code>Fragment</code> 的生命周期结束后仍保留其 <code>Context</code>，否则可能导致内存泄漏。针对特定任务，务必选择正确类型的 <code>Context</code>，避免在后台线程，或关联组件销毁后使用它。此外，使用匿名内部类和回调时要小心，它们可能会不经意间持有对 <code>Context</code> 的引用。正确管理 <code>Context</code> 能确保高效利用资源，有助于防止内存泄漏或应用程序崩溃。</p>
<h3 data-id="heading-9">进阶：ContextWrapper</h3>
<p><code>ContextWrapper</code> 是 Android 中的一个基类，它具备包装 <code>Context</code> 对象的能力，将调用委托给被包装的 <code>Context</code>。它充当中间层，用于修改或扩展原始 <code>Context</code> 的行为。通过使用 <code>ContextWrapper</code>，你可以在不改变底层 <code>Context</code> 的情况下定制功能。</p>
<p>当你需要增强或覆盖现有 <code>Context</code> 的特定行为时，就会用到 <code>ContextWrapper</code>。它允许你拦截对原始 <code>Context</code> 的调用，并提供额外功能或定制化行为。</p>
<p>以 <code>Activity</code> 的继承关系为例：<code>Activity</code> -&gt; <code>ContextThemeWrapper</code> -&gt; <code>ContextWrapper</code>。</p>
<p>而 <code>ContextWrapper</code> 源码如下：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextWrapper</span> <span class="hljs-title">extends</span> <span class="hljs-title">Context</span> {
    <span class="hljs-meta">@UnsupportedAppUsage</span>
    Context mBase;
    ...
}
</code></pre>
<p>使用场景：</p>
<ol>
<li><strong>自定义 <code>Context</code></strong>：当你出于特定目的需要创建自定义 <code>Context</code> 时，例如应用不同的主题，或以特定方式处理资源。</li>
<li><strong>动态资源处理</strong>：包装 <code>Context</code> 以动态提供或修改诸如字符串、尺寸或样式等资源。</li>
<li><strong>依赖注入</strong>：像 <strong>Dagger</strong> 和 <strong>Hilt</strong> 这样的库会创建 <code>ContextWrapper</code>，以便将自定义 <code>Context</code> 附加到组件上进行依赖注入。</li>
</ol>
<p>下面的代码展示了如何使用 <code>ContextWrapper</code> 来应用自定义主题：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThemeContextWrapper</span>(base: Context) : ContextWrapper(base) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTheme</span><span class="hljs-params">()</span></span>: Resources.Theme {
        <span class="hljs-keyword">val</span> theme = <span class="hljs-keyword">super</span>.getTheme()
        theme.applyStyle(R.style.CustomTheme, <span class="hljs-literal">true</span>) <span class="hljs-comment">// Apply a custom theme</span>
        <span class="hljs-keyword">return</span> theme
    }
}
</code></pre>
<p>你可以在 <code>Activity</code> 中使用这个自定义包装器：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-keyword">super</span>.attachBaseContext(CustomThemeContextWrapper(newBase))
    }
}
</code></pre>
<p>在此示例中，<code>CustomThemeContextWrapper</code> 为 <code>Activity</code> 应用了特定主题，覆盖了基础上下文的默认行为。</p>
<p>这样做有很多好处：</p>
<ul>
<li><strong>可复用性</strong>：你能将自定义逻辑封装在包装器类中，并在多个组件间复用。</li>
<li><strong>封装性</strong>：增强或修改行为的同时，无需更改原始 <code>Context</code> 的实现。</li>
<li><strong>兼容性</strong>：与现有 <code>Context</code> 对象无缝协作，保持向后兼容性。</li>
</ul>
<p>总之。</p>
<p><code>ContextWrapper</code> 是 Android 中用于定制 <code>Context</code> 行为的灵活且可复用的工具。它使开发者能够拦截并修改对原始 <code>Context</code> 的调用，而无需直接更改它，这使其成为构建模块化且适应性强的应用程序必不可少的类。</p>
<h3 data-id="heading-10">进阶：Activity 中的 baseContext 是什么</h3>
<p>在 <code>Activity</code> 中，<code>this</code> 和 <code>baseContext</code> 都能用于访问 <code>Context</code>，但它们用途不同，代表着 Android 上下文层级结构中的不同层次。清楚何时使用它们，对避免代码混淆或潜在问题至关重要。</p>
<p>在 <code>Activity</code> 中，关键字 <code>this</code> 指的是 <code>Activity</code> 类的当前实例。由于 <code>Activity</code> 是 <code>ContextWrapper</code> 的子类（因而间接是 <code>Context</code> 的子类），<code>this</code> 提供了对 <code>Activity</code> 特定上下文的访问，包括诸如生命周期管理以及与用户界面（UI）交互等额外功能。</p>
<p>当在 <code>Activity</code> 中使用 <code>this</code> 时，它通常指向 <code>Activity</code> 的当前上下文，允许你调用特定于该 <code>Activity</code> 的方法。例如，如果你需要启动另一个 <code>Activity</code> 或显示与这个特定 <code>Activity</code> 相关联的对话框，就可以使用 <code>this</code>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, AnotherActivity::<span class="hljs-keyword">class</span>.java)
startActivity(intent)

<span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(<span class="hljs-keyword">this</span>)
    .setTitle(&amp;#<span class="hljs-number">34</span>;Example&amp;#<span class="hljs-number">34</span>;)
    .setMessage(&amp;#<span class="hljs-number">34</span>;This dialog <span class="hljs-keyword">is</span> tied to <span class="hljs-keyword">this</span> Activity instance.&amp;#<span class="hljs-number">34</span>;)
    .show()
</code></pre>
<p><code>baseContext</code> 代表 <code>Activity</code> 所基于的基础上下文。它是 <code>ContextWrapper</code> 类的一部分，而 <code>Activity</code> 继承自 <code>ContextWrapper</code>。<code>baseContext</code> 通常是 <code>ContextImpl</code> 实例，为 <code>Context</code> 方法提供核心实现。</p>
<p><code>baseContext</code> 一般通过 <code>getBaseContext()</code> 方法来访问。你很少直接使用它，但在处理自定义 <code>ContextWrapper</code> 实现，或者需要引用被包装上下文背后的原始上下文时，它就会派上用场。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">// 和直接通过 this 返回的相比，此处的 baseContext 不携带当前 Activity 的主题信息</span>
<span class="hljs-keyword">val</span> systemService = baseContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE)
</code></pre>
<p>总结一下他们之间的区别：</p>
<ol>
<li><strong>作用域</strong>：<code>this</code> 代表当前的 <code>Activity</code> 实例及其生命周期，而 <code>baseContext</code> 指的是 <code>Activity</code> 构建所基于的更低层次的上下文。</li>
<li><strong>用法</strong>：<code>this</code> 通常用于与 <code>Activity</code> 生命周期或用户界面（UI）相关的操作，例如启动 <code>Activity</code> 或显示对话框。<code>baseContext</code> 一般在与 <code>Context</code> 的核心实现进行交互时使用，特别是在自定义 <code>ContextWrapper</code> 的场景中。</li>
<li><strong>层级关系</strong>：<code>baseContext</code> 是 <code>Activity</code> 的基础上下文。访问 <code>baseContext</code> 会绕过 <code>Activity</code> 作为 <code>ContextWrapper</code> 所提供的额外功能。</li>
</ol>
<p>总之。</p>
<p>在 <code>Activity</code> 中，<code>this</code> 指向当前的 <code>Activity</code> 实例，提供了具有生命周期和特定于用户界面（UI）功能的高级上下文。而 <code>baseContext</code> 代表 <code>Activity</code> 所基于的基础上下文，常用于诸如自定义 <code>ContextWrapper</code> 实现等高级场景。虽然在 Android 开发中 <code>this</code> 使用最为普遍，但理解 <code>baseContext</code> 有助于调试以及创建模块化、可复用的组件。</p>
<h2 data-id="heading-11">番外</h2>
<p>本文讲述的技术细节完全是基于面试下的，如果你想对 <code>Context</code> 有个更加完整的认识，请看下面两篇文章：</p>
<p><a href="https://juejin.cn/post/7531888045412663348" target="_blank" title="https://juejin.cn/post/7531888045412663348">憋了一周了，12000字深入浅出Android的Context机制</a></p>
<p><a href="https://juejin.cn/post/7527953491890274319" target="_blank" title="https://juejin.cn/post/7527953491890274319">2025年了，万字长文带你了解Context</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节]]></title>    <link>https://juejin.cn/post/7582136489770319882</link>    <guid>https://juejin.cn/post/7582136489770319882</guid>    <pubDate>2025-12-11T03:08:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582136489770319882" data-draft-id="7574734686493753380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-11T03:08:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:08:07.000Z" title="Thu Dec 11 2025 03:08:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华！这篇我们来讲解Vue2和Vue3的核心区别在哪里？</p>
<p>Vue3是Vue2的升级版，不仅更快，还更好用。它解决了Vue2中一些让人头疼的问题，比如动态添加属性不响应、组件必须包在一个根元素里等等。</p>
<p>下面通过10个常见的对比例子，让你快速看懂Vue3到底新在哪儿、好在哪儿。</p>
<h3 data-id="heading-0">1. <strong>响应式系统：<code>Object.defineProperty</code> vs <code>Proxy</code></strong></h3>
<p>Vue 2 无法监听动态添加的属性（除非用 <code>Vue.set</code>）；Vue 3 可以直接响应。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Vue 2 不会触发更新</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>.<span class="hljs-property">newProp</span> = <span class="hljs-string">'hello'</span>

<span class="hljs-comment">// Vue 2 正确方式</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>, <span class="hljs-string">'newProp'</span>, <span class="hljs-string">'hello'</span>)

<span class="hljs-comment">// Vue 3 直接赋值即可响应</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>.<span class="hljs-property">newProp</span> = <span class="hljs-string">'hello'</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">2. <strong>Composition API（组合式 API）</strong></h3>
<pre><code class="hljs language-html" lang="html">

export default {
  data() {
    return { count: 0 }
  },
  methods: {
    increment() {
      this.count++
    }
  }
}




import { ref } from 'vue'

const count = ref(0)
const increment = () =&gt; count.value++

</code></pre>
<hr/>
<h3 data-id="heading-2">3. <strong>TypeScript 支持</strong></h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Vue 3 + TypeScript（能更好的支持）</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>
}
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>()

</code></pre>
<p>Vue 2 虽可通过 <code>vue-class-component</code> 或 <code>vue-property-decorator</code> 支持 TS，但配置复杂且类型推导弱。</p>
<hr/>
<h3 data-id="heading-3">4. <strong>Fragment（多根节点）</strong></h3>
<pre><code class="hljs language-html" lang="html">

  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>Header<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>Main<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>




  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>Header<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>Main<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

</code></pre>
<hr/>
<h3 data-id="heading-4">5. <strong>Teleport（传送门）</strong></h3>
<p>将 modal 渲染到 body 下，避免样式嵌套问题</p>
<pre><code class="hljs language-html" lang="html">
  Open Modal
  
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello from Teleport!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      Close
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  



import { ref } from 'vue'
const open = ref(false)

</code></pre>
<p>Vue 2 需手动操作 DOM 或使用第三方库（如 <code>portal-vue</code>）。</p>
<hr/>
<h3 data-id="heading-5">6. <strong>Suspense（异步组件加载）</strong></h3>
<pre><code class="hljs language-html" lang="html">


const res = await fetch('/api/data')
const data = await res.json()



  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ data }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

</code></pre>
<pre><code class="hljs language-html" lang="html">

  
    
      
    
    
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
  

</code></pre>
<p>Vue 2 无原生 ``，需自行管理 loading 状态。</p>
<hr/>
<h3 data-id="heading-6">7. <strong>全局 API 变更</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Vue 2</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">'MyButton'</span>, <span class="hljs-title class_">MyButton</span>)
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, focusDirective)

<span class="hljs-comment">// Vue 3</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'MyButton'</span>, <span class="hljs-title class_">MyButton</span>)
app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, focusDirective)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>Vue 3 的应用实例彼此隔离，适合微前端或多实例场景。</p>
<hr/>
<h3 data-id="heading-7">8. <strong>生命周期钩子命名变化</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Vue 2</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* cleanup */</span> },
  <span class="hljs-title function_">destroyed</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* final */</span> }
}

<span class="hljs-comment">// Vue 3（Options API 写法）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* cleanup */</span> },
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* final */</span> }
}

<span class="hljs-comment">// Vue 3（Composition API）</span>
<span class="hljs-keyword">import</span> { onBeforeUnmount, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* cleanup */</span> })
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* final */</span> })
</code></pre>
<hr/>
<h3 data-id="heading-8">9. <strong>v-model 多绑定</strong></h3>
<pre><code class="hljs language-html" lang="html">









</code></pre>
<hr/>
<h3 data-id="heading-9">10. <strong>显式声明 emits（推荐）</strong></h3>
<pre><code class="hljs language-js" lang="js">

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'submit'</span>, <span class="hljs-string">'cancel'</span>])

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">emit</span>(<span class="hljs-string">'submit'</span>)




<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>({
  <span class="hljs-attr">submit</span>: <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> payload === <span class="hljs-string">'string'</span>,
  <span class="hljs-attr">cancel</span>: <span class="hljs-literal">null</span>
})

</code></pre>
<p>Vue 2 中 <code>$emit</code> 无需声明，但不利于工具链和文档生成。</p>
<hr/>
<p>这些示例覆盖了 Vue2 和 Vue3 比较关键的差异点。通过代码对比，可以更清楚地看到 Vue3 在<strong>开发体验、性能、灵活性和工程化</strong>方面有明细的提升。</p>
<h3 data-id="heading-10">结尾</h3>
<p>总的来说，Vue3 在保持简单上手的同时，增加了更多实用又强大的功能。不管是写代码更轻松了，还是对 TypeScript、大型项目的支持更好了，都让开发者的工作变得更高效。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-11">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FbgLoyqb3VLgn3xXAok3kcQ" target="_blank" title="https://mp.weixin.qq.com/s/bgLoyqb3VLgn3xXAok3kcQ" ref="nofollow noopener noreferrer">《如何查看 SpringBoot 当前线程数？3 种方法亲测有效》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术]]></title>    <link>https://juejin.cn/post/7582118538562420755</link>    <guid>https://juejin.cn/post/7582118538562420755</guid>    <pubDate>2025-12-11T03:42:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118538562420755" data-draft-id="7582156219059159103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术"/> <meta itemprop="keywords" content="Agent,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T03:42:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:42:54.000Z" title="Thu Dec 11 2025 03:42:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>某天打开组内的Grafana仪表盘，突然好奇我们的埋点从被触发后是如何一步一步变成所展示的各种图表的，于是在我进行一系列的探索之后，总结出了以下链路：</p>
<ul>
<li>在指标工厂新建指标，确定埋点key和埋点元数据。</li>
<li>代码中指定埋点key和埋点数据，通过watchDog发送kafka消息到obs monitor topic。</li>
<li>为埋点指标新建数据处理任务，将消费到的kafka消息落到指定的数据表中。</li>
<li>添加新的仪表盘，编写展示数据背后的SQL语句。</li>
</ul>
<p><strong>痛点</strong>：每需要添加一个新的数据分析大盘，就需要人工去分析各个表结构、表与表之间的联系、表各个字段的含义等，在充分理解其含义后再费时费力地编写SQL语句，并不断调优。这导致OBS埋点数据分析的场景相对固化，并且难以支持灵活的数据查询要求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8992e17b371443bcbbfdfd2cbeea70a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=9EEvzjkVRvjsOsjQRFtTfRI3OUU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-1">二、思考</h2>
<p>在分析了当前系统的痛点后，我意识到这是一个典型的可以利用AI能力来对现有功能进行扩展的场景。因为：</p>
<ul>
<li>场景多变，因为你不知道用户可能想查看什么样的数据，无法通过代码穷举；</li>
<li>需要了解业务同时又具备编写复杂数据查询SQL的人，并且费时费力；</li>
<li>看到大盘数据后，依赖每个人对业务的理解提炼出一套分析报告，报告质量与个人的理解与表达能力相关。</li>
</ul>
<p>于是我就开始思考能否构建一个AI Agent，使其能够根据用户的要求，自主地生成各种各样的SQL查询语句，并将查询到的数据形成完整的数据分析报告返回给用户。</p>
<p>为了实现这个方案，有几个明显需要解决的点：</p>
<ul>
<li>如何让AI理解每个表中各字段的含义、各个表的作用、表与表之间的联系，从而生成准确的SQL？</li>
<li>AI生成完SQL之后，如何打通 AI 与数据平台之间的通路，从而成功执行该SQL 并拿到数据？因为数据库权限不在我这，我无法直接连接到数据库。</li>
<li>如何充分利用已有资源，减少人力投入？毕竟是个人想法，在不确定效果如何的情况下，不好直接打扰平台方专门为我写一些新功能，同时我个人也只能投入一些零碎的时间来做这件事。</li>
</ul>
<h2 data-id="heading-2">三、方案</h2>
<p>有了问题后，就带着问题去找答案。</p>
<h3 data-id="heading-3">3.1查询数据Tool</h3>
<p>首先，我需要一个能够执行查询的端点。那么我就去抓取了大盘中的数据所调用的接口，意外地发现，不同的数据调用的是同一个接口<a href="https://link.juejin.cn?target=https%3A%2F%2Fxxx.com%2Fapi%2Fds%2Fquery%25EF%25BC%258C%25E5%258F%25AA%25E6%2598%25AF%25E5%2585%25A5%25E5%258F%2582%25E4%25B8%258D%25E5%2590%258C%25E8%2580%258C%25E5%25B7%25B2%25EF%25BC%258C%25E8%2580%258C%25E4%25B8%2594%25E5%258F%2591%25E7%258E%25B0%25EF%25BC%258C%25E6%259F%25A5%25E8%25AF%25A2%25E7%259A%2584%25E9%2580%25BB%25E8%25BE%2591%25E6%2598%25AF%25E9%2580%259A%25E8%25BF%2587rawSql%25E5%25B0%2586%25E6%259F%25A5%25E8%25AF%25A2%25E8%25AF%25AD%25E5%258F%25A5%25E7%259B%25B4%25E6%258E%25A5%25E4%25BC%25A0%25E8%25BF%2587%25E5%258E%25BB%25EF%25BC%2581" target="_blank" title="https://xxx.com/api/ds/query%EF%BC%8C%E5%8F%AA%E6%98%AF%E5%85%A5%E5%8F%82%E4%B8%8D%E5%90%8C%E8%80%8C%E5%B7%B2%EF%BC%8C%E8%80%8C%E4%B8%94%E5%8F%91%E7%8E%B0%EF%BC%8C%E6%9F%A5%E8%AF%A2%E7%9A%84%E9%80%BB%E8%BE%91%E6%98%AF%E9%80%9A%E8%BF%87rawSql%E5%B0%86%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%9B%B4%E6%8E%A5%E4%BC%A0%E8%BF%87%E5%8E%BB%EF%BC%81" ref="nofollow noopener noreferrer">xxx.com/api/ds/quer…</a></p>
<p>于是我将该Curl导入到ApiFox中，通过不断修改参数，发现最终与查询结果相关的入参可以精简到简单的几个参数：from、to、query(format,rawSql,intervalMs)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cc12be2388246ca9538964baf94db3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=KhfK4RC8qSolZVxsvWE6N8vEwC8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5898e122620b48179a798c20f92c5de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=P0j64Quhj7Dh1nVIyKTPtYyiEy4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那么针对第一个问题我就想到了很好的办法，把这个查询API封装成一个Tool，描述清楚各个字段的含义，就可以让AI生成完整的参数来查询它想要的数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b659f60d72412d9646ec05e0f6d7e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=CRcNoOSA9lnSyUxio1WzXND75pg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>说干就干，我立马新建了一个Spring AI工程，把Tool的功能和需要的参数描述清楚。其中grafanaService.query()内部逻辑就是通过Feign来调用上面那个查询的API。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Tool</span>(name = <span class="hljs-string">"query_grafana"</span>,
      description= <span class="hljs-string">"使用Grafana中的SQL查询grafana数据"</span>)
public JSONObject <span class="hljs-built_in">queryGrafana</span>(<span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询开始时间"</span>) String from,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询结束时间"</span>) String to,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询数据类型:table|time_series"</span>) String format,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询时间间隔,单位毫秒。只有当format为time_series时需要传入。"</span>) Long intervalMs,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"Grafana SQL查询语句"</span>) String rawSql){
    <span class="hljs-selector-tag">DateTimeFormatter</span> <span class="hljs-selector-tag">formatter</span> = <span class="hljs-selector-tag">DateTimeFormatter</span><span class="hljs-selector-class">.ofPattern</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
    <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">fromDateTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.parse</span>(from, formatter);
    <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">toDateTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.parse</span>(to, formatter);
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">fromTimestamp</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.valueOf</span>(fromDateTime.<span class="hljs-built_in">toInstant</span>(ZoneOffset.UTC).<span class="hljs-built_in">toEpochMilli</span>());
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">toTimestamp</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.valueOf</span>(toDateTime.<span class="hljs-built_in">toInstant</span>(ZoneOffset.UTC).<span class="hljs-built_in">toEpochMilli</span>());
    <span class="hljs-selector-tag">JSONObject</span> <span class="hljs-selector-tag">resp</span> = <span class="hljs-selector-tag">grafanaService</span><span class="hljs-selector-class">.query</span>(fromTimestamp, toTimestamp, intervalMs, rawSql, format);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">resp</span>;
}
</code></pre>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">GrafanaClient</span> grafanaClient;


<span class="hljs-meta">@Value</span>(<span class="hljs-string">"${grafana.cookie}"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> getGrafanaCookie;


<span class="hljs-keyword">public</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fromTimestamp, <span class="hljs-built_in">String</span> toTimestamp, Long intervalMs, <span class="hljs-built_in">String</span> rawSql, <span class="hljs-built_in">String</span> format</span>) {
    <span class="hljs-title class_">GrafanaRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GrafanaRequest</span>(fromTimestamp, toTimestamp, intervalMs, rawSql, format);
    <span class="hljs-keyword">return</span> grafanaClient.<span class="hljs-title function_">query</span>(getGrafanaCookie, request);
}
</code></pre>
<h3 data-id="heading-4">3.2表结构RAG</h3>
<p>有了能够执行查询的Tool之后，剩下的就是需要AI能够根据用户的query生成精准的参数以及查询SQL。</p>
<p>之前了解到公司部署了RAGFlow服务：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxxx.com%2Fknowledge%25EF%25BC%258C%25E6%2597%25A2%25E7%2584%25B6%25E6%259C%2589%25E4%25BA%2586%25EF%25BC%258C%25E9%2582%25A3%25E5%25B0%25B1%25E5%25BE%2597%25E7%2594%25A8%25E8%25B5%25B7%25E6%259D%25A5%25EF%25BC%2581" target="_blank" title="https://xxx.com/knowledge%EF%BC%8C%E6%97%A2%E7%84%B6%E6%9C%89%E4%BA%86%EF%BC%8C%E9%82%A3%E5%B0%B1%E5%BE%97%E7%94%A8%E8%B5%B7%E6%9D%A5%EF%BC%81" ref="nofollow noopener noreferrer">xxx.com/knowledge，既…</a></p>
<ul>
<li>创建知识集，发现支持添加飞书文档。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e37c8f34f2b4004927830bf4d82f89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=m8q3s8tokBcDDi050%2FrJs7A%2FKtE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0468f002576b47569f6071d788a2d7a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=XOW2Otuz7zTyxZzdLRt9RyFDDWY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>由于我们是需要完整的表结构，所以把配置修改为使用table的格式，一行数据便是一个chunk，以免出现语义上的中断。（埋点数据一般表都较小，语意较为明确。像一些字段很多的大表可能需要考虑更好的方案。）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e84ab93545174f378c3315e861d38d6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=EizxrD7sHUPY34KAPalDLMmTElY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>创建飞书文档，手动到OBS的库中把我们想要AI帮助分析的表结构拉出来（验证想法时采取的临时方案），但由于建表时的不规范，很多表没有对表中字段添加comment，这会导致AI不理解每个字段的含义，也就无法准确地生成SQL。因此，我们手动补充每张表、每个字段的描述，以及与其它表之间的关联关系。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9adde40d57054101b5f213308b4dcb88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=rqh%2BESuAk25dNypAC8FAnd1X6IA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>将飞书文档添加到数据集中，完成后点击名称查看切片详情。双击每个块也可以查看块的详情。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6429041abc14472bb2278353d823711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=eDzxgUSJ8Cxkszu60he84FIChls%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>会发现RAGFlow自动给我们生成了一些关键词和问题，这些内容会对召回准确率产生影响。我自己觉得生成的不太准确，所以结合自己理解手动输入了一些关键词和可能的问题。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3143617fc3af4be995b67d653faf87fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=FdFHuis%2Fee2jEGCKkthnjqyLMXw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>完成后，可以到检索测试tab测试召回的效果，根据结果确定合适的参数。并可以对chunk的内容和关键词等等进行适当的调整。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b152dba313e488ea6e1ae65d0c07c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=u2l9TSrVN3XrkxMQHH5sL5nb%2FPQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>调优完成后，就需要对接RAGFlow的retrive接口，来把我们知识库召回的流程做成一个Tool。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e428bafad28f4661a22af61f4d2d0c51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=ERRIt6qr5UgPeGRFd5XlAeZXAhE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Resource</span>
private RagFlowService ragFlowService;


<span class="hljs-variable">@Tool</span>(name = <span class="hljs-string">"get_table_schema"</span>, description= <span class="hljs-string">"根据query查询可能有关联的数据库表，返回建表语句。尽量传入多个中文关键词，每个关键词之间用空格隔开。"</span>)
public List&lt;String&gt; <span class="hljs-built_in">getTableSchema</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"query"</span>) String question){
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ragFlowService</span><span class="hljs-selector-class">.retrieval</span>(question);
}
</code></pre>
<h3 data-id="heading-5">3.3 OBS Agent</h3>
<p>在我看来，想要构建一个能够 work 的Agent，需要以下几个要素：</p>
<p><strong>Agent=Architecture</strong>(Workflow、ReAct、Plan-Execute、Multi-Agent...) <strong>+LLM+Context Engineering</strong>(Prompt、Tool、Memory...)</p>
<p>本来是想用SpringAI Alibaba Graph或者 LangGraph来构建一个WorkFlow类或者Graph类的复杂智能体（ReAct、Plan-Execute、Multi-Agent）。但为了快速验证想法和节省个人时间，并且考虑到目前任务相对简单（PE+工具就足以完成），再加上部门正在试用Trae这个工具，所以决定基于Trae来构建一个Agent（可以顺便使用他们的高级模型/doge，也可以分享给其它同事使用）。</p>
<p>接入Trae之后，Architecture自然就是Trae的Agent架构了，根据我使用下来感觉采用的是基于ReAct的 Single-Agent。而Context Engineering的部分，对话功能以及长短期记忆，自然是Trae天生就具备的。而Tool则可以借助其自带的一些工具，另外还可以利用MCP来进行扩展，比如得物的MCP市场，提供了大量好用的Server，并且可以很方便的发布自己开发的Mcp Server。于是，我就把在第一步和第二步做的工具，在得物Mcp平台上进行发布，供我自己和其他感兴趣的同学使用。</p>
<p>最后，需要一个专门针对我这个场景的Prompt来指引LLM 顺利完成任务，经过我不断的修改，最终形成这样一段Prompt:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Role：数据分析专家</span>


<span class="hljs-section">## Background：用户需要专业的数据分析支持来解决复杂的业务问题，从海量数据中提取有价值的信息，为产品优化、运营策略和业务决策提供可靠依据。</span>


<span class="hljs-section">## Attention：数据准确性是分析工作的生命线，必须始终保持严谨细致的工作态度。每一次分析都可能影响重要决策，因此需要系统性思考、分步验证，确保每个环节的可靠性。</span>


<span class="hljs-section">## Profile：</span>
<span class="hljs-bullet">-</span> Language: 中文
<span class="hljs-bullet">-</span> Description: 专注于数据库表结构分析与Grafana-SQL查询的专业数据分析师，具备系统化解决复杂数据查询问题的能力


<span class="hljs-section">### Skills:</span>
<span class="hljs-bullet">-</span> 精通数据库表结构分析，能够快速识别表关系、字段含义和数据类型
<span class="hljs-bullet">-</span> 熟练掌握Grafana-SQL语法规范，具备高效的查询语句编写和优化能力
<span class="hljs-bullet">-</span> 具备专业的数据可视化技能，能够根据分析目标选择合适的图表类型
<span class="hljs-bullet">-</span> 拥有深度业务需求理解能力，能够准确转化业务问题为数据查询方案
<span class="hljs-bullet">-</span> 掌握系统化的问题分析方法，能够规划完整的数据分析流程和验证机制


<span class="hljs-section">## Goals:</span>
<span class="hljs-bullet">-</span> 准确理解用户业务需求，明确数据查询的核心目标和关键指标
<span class="hljs-bullet">-</span> 系统分析相关表结构，确保对数据关系和业务逻辑的全面理解
<span class="hljs-bullet">-</span> 设计高效的数据查询方案，平衡查询性能与结果准确性
<span class="hljs-bullet">-</span> 生成专业的数据分析报告，包含可视化展示和深度业务洞察
<span class="hljs-bullet">-</span> 确保所有分析过程可追溯、结果可验证、结论可执行


<span class="hljs-section">## Constrains:</span>
<span class="hljs-bullet">-</span> 查询不到数据时不要模拟任何数据，直接回复查不到数据
<span class="hljs-bullet">-</span> 你自己所知道的时间是不准确的，如果涉及到时间，则需要使用工具获取当前时间
<span class="hljs-bullet">-</span> 严格基于实际数据进行分析，严禁任何形式的数据虚构或推测
<span class="hljs-bullet">-</span> 必须在完成表结构分析和需求理解后再执行具体查询操作
<span class="hljs-bullet">-</span> 所有重要数据必须进行源头验证和多维度交叉检查
<span class="hljs-bullet">-</span> 严格遵守数据安全和隐私保护原则，不超越授权数据范围
<span class="hljs-bullet">-</span> 明确说明分析的局限性、假设条件和潜在的数据不确定性


<span class="hljs-section">## Workflow:</span>
<span class="hljs-bullet">1.</span> 深度理解业务需求，明确查询目标、关键指标和预期输出
<span class="hljs-bullet">2.</span> 不断使用工具获取你需要的表及其表结构，直到你认为已获取到足够的信息
<span class="hljs-bullet">3.</span> 系统分析相关表结构，包括字段含义、数据类型、关联关系和索引结构
<span class="hljs-bullet">4.</span> 设计查询逻辑方案，规划执行步骤、验证节点和性能优化策略
<span class="hljs-bullet">4.</span> 编写符合Grafana语法的SQL查询语句，设置正确的参数和时间范围
<span class="hljs-bullet">5.</span> 执行查询。如果查询出现401错误，则中断后续流程，并提示用户更新Cookie后重启obs-mcp-server；如果出现400错误，尝试修改自己的SQL语句重新查询；
<span class="hljs-bullet">6.</span> 生成可视化图表和详细分析报告，报告中必须包含你执行查询的SQL语句
<span class="hljs-bullet">7.</span> 调用飞书生成文档工具以Markdown格式创建飞书文档，返回最终的飞书文档地址


<span class="hljs-section">## OutputFormat:</span>
<span class="hljs-bullet">-</span> 分析报告，包含完整的分析过程和关键发现，创建新的飞书文档并保存在其中
<span class="hljs-bullet">-</span> 可视化图表以嵌入式链接形式呈现，确保清晰展示数据趋势和分布
<span class="hljs-bullet">-</span> 报告结构包含执行摘要、分析方法、数据结果、业务洞察和后续建议


<span class="hljs-section">## Suggestions:</span>
<span class="hljs-bullet">-</span> 建立系统化的表结构分析框架，提高数据关系识别的效率和准确性
<span class="hljs-bullet">-</span> 持续学习Grafana-SQL最新语法特性，优化查询性能和资源消耗
<span class="hljs-bullet">-</span> 培养多维度数据验证习惯，确保分析结果的可靠性和业务价值
<span class="hljs-bullet">-</span> 深入理解业务场景，提升从数据到洞察的转化能力和决策支持水平
<span class="hljs-bullet">-</span> 定期复盘分析案例，总结经验教训，持续改进分析方法论和工作流程


<span class="hljs-section">## 工具描述</span>
<span class="hljs-bullet">-</span> query<span class="hljs-emphasis">_grafana:使用Grafana中的SQL查询grafana数据
注意：
      1. 当format为time_</span>series时表示查询时间序列数据，SELECT的第一个字段必须是$<span class="hljs-strong">__timeGroupAlias(timestamp, interval)，表示时间分组别名。时间间隔intervalMs需要与rawSql中的$__</span>timeGroup(timestamp, interval)保持对应。比如intervalMs=86400000L表示1天,rawSql中$<span class="hljs-strong">__timeGroup(timestamp, 1d)也需要保持一致。
      2. 当format为table时表示查询表格数据，SELECT的字段可以任意，intervalMs参数传null
      3. 时间范围为闭区间，即包含开始时间from和结束时间to,格式为yyyy-MM-dd HH:mm:ss。
参数示例：{
    "from": "2025-11-16 00:00:00",
    "to": "2025-11-16 23:59:59",
    "format": "table",
    "intervalMs": null,
    "rawSql": "SELECT region, COUNT(<span class="hljs-emphasis">*) as user_count FROM intl_xxxxxxx WHERE $__timeFilter(timestamp) GROUP BY region ORDER BY user_count DESC"
  }


## Initialization
作为数据分析专家，你必须遵守Constrains，使用默认中文与用户交流。
</span></span></code></pre>
<p>最终，在 Trae 中构建了一个完整OBS Agent。</p>
<ul>
<li>添加智能体：OBS大盘分析</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2209be432b4045549921a04fc0dd830e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=oOAQgJDhTkLHBQxL4hS%2FgN%2FBTlk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-6">四、成果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea2595f4300d4ed795136f67e99929e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=4UQbWkBYfySYKy1jUNEMO7ee8Fc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c9329380274ae3b535a93437222263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=4qSpa4DM8uT5qGKxVEKPKuPuBac%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1def6b68a0455d8e7d3a496cef3b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=9BbuxEVfIBPH1qPE9yDef%2B%2Fgq6Q%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7bf0a31c604be7aedc62757ed09ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=JXtsLE6snnIqrlO35F1bbhCzf8E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终生成的报告（截取部分）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c374ec201cf46a59e9bbad20a12a5ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=%2FuDakHatZoMP6qVK8f3lr6C6oAQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89cc37e36c3e4811a2eb1c64cb1258e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=FHrg5EDXZ5x%2FmAv3Ihj6DTsnIbE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8ed688f0f34673a565beb6dcc4a036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=q7wtrNRQaFM6hltQzs6hWAJOMuc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-7">五、总结</h2>
<p>AI时代来临，我们应该要善于发现当前系统中的哪些部分能够结合AI来进行提升，积极拥抱变化，有了想法就去做，边做边想边解决问题，永远主动向前一步。</p>
<p>本文章只是记录了从产生想法到构建MVP验证想法的整个过程，这中间当然有很多可以继续优化的地方，我本人目前有以下几个想法，也欢迎大家积极评论，贡献自己的独到见解。</p>
<ul>
<li>接入数据库数据，通过动态监听Binlog的方式来识别各表之间的联系，比如select 语句的join，并将这种关系保存到Neo4j 这种图向量数据库中来实现表结构的 RAG。</li>
<li>基于LangGraph 或 SpringAI Alibaba 构建Multi-Agent System，细化各Agent的职责，精炼各Agent的Context 构成，以获得更好的效果。例如：协调者 Agent、表结构搜索 Agent、SQL 生成 Agent、分析报告 Agent等等。</li>
<li>接入飞书机器人，或者使用AI Coding工具生成一个前端页面。使得一些非技术人员，例如产品和运营也能很方便地使用。</li>
</ul>
<h3 data-id="heading-8">往期回顾</h3>
<ol>
<li>
<p>数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
</li>
<li>
<p>项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
</li>
<li>
<p>Dragonboat统一存储LogDB实现分析｜得物技术</p>
</li>
<li>
<p>从数字到版面：得物数据产品里数字格式化的那些事</p>
</li>
<li>
<p>一文解析得物自建 Redis 最新技术演进</p>
</li>
</ol>
<h3 data-id="heading-9">文 /Neeson</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[人脸识别项目如何在Spring Boot项目中如何建立数据库和管理]]></title>    <link>https://juejin.cn/post/7582136489770762250</link>    <guid>https://juejin.cn/post/7582136489770762250</guid>    <pubDate>2025-12-11T05:24:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582136489770762250" data-draft-id="7582136489770729482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="人脸识别项目如何在Spring Boot项目中如何建立数据库和管理"/> <meta itemprop="keywords" content="后端,数据库,MySQL"/> <meta itemprop="datePublished" content="2025-12-11T05:24:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的丸子"/> <meta itemprop="url" content="https://juejin.cn/user/2506542243120680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            人脸识别项目如何在Spring Boot项目中如何建立数据库和管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2506542243120680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的丸子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T05:24:49.000Z" title="Thu Dec 11 2025 05:24:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">讲讲在Spring Boot项目中如何建立数据库和管理</h2>
<p>随着智能门禁、考勤、访客系统的普及，<strong>人脸识别模块</strong>已成为众多项目的重要组成部分。在高性能的人脸识别系统中，数据库主要负责<strong>持久化存储</strong>，而识别比对操作应全部在<strong>内存中完成</strong>，以保证毫秒级响应和高并发性能。本文将介绍如何在 <strong>Spring Boot 项目</strong>中建立一个高效、可扩展的人脸识别数据库，并实现基础的人脸数据管理功能，同时结合 MySQL、Redis 与内存优化策略，提升系统整体性能。</p>
<h2 data-id="heading-1">一、基础入门介绍</h2>
<p>这里为了能让大家对SDK结合数据库有个初步了解，我们先利用<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.arcsoft.com.cn%2F%3Futm_source%3DJuejin%26%26utm_medium%3Dshentao" target="_blank" title="https://ai.arcsoft.com.cn/?utm_source=Juejin&amp;&amp;utm_medium=shentao" ref="nofollow noopener noreferrer">虹软人脸识别SDK</a> 对应的<strong>ArcSoftFaceDemo</strong> ，讲解下此Demo是如何对人脸数据库进行管理的，以及如何正确地注册到 <strong>ArcFace SDK</strong> 的引擎中，以支持后续的人脸检测和识别功能。下面结合代码分析整个管理流程。</p>
<h3 data-id="heading-2">1、数据库环境准备</h3>
<p>在开始使用 ArcsoftFaceDemo 前，需要先准备好 MySQL 数据库环境。为了快速搭建，可以直接使用 <strong>Docker</strong> 启动一个数据库实例。</p>
<h5 data-id="heading-3">使用 Docker 启动 MySQL 8.0</h5>
<p>执行以下命令启动 MySQL 容器：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name arcsoft_mysql \
  -e MYSQL_ROOT_PASSWORD=Root123 \
  -e MYSQL_DATABASE=arcsoft_face \
  -p 3306:3306 \
  registry.cn-hangzhou.aliyuncs.com/china-images/mysql:8.0
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>--name arcsoft_mysql</code>：容器名称，方便管理。</li>
<li><code>MYSQL_ROOT_PASSWORD=Root123</code>：root 用户密码。</li>
<li><code>MYSQL_DATABASE=arcsoft_face</code>：初始化创建数据库 <code>arcsoft_face</code>。</li>
<li><code>-p 3306:3306</code>：将容器端口映射到宿主机，方便程序连接。</li>
<li><code>registry.cn-hangzhou.aliyuncs.com/china-images/mysql:8.0</code>：指定使用 MySQL 8.0 阿里云镜像，如果有外网环境，可直接使用mysql:8.0代替。</li>
</ul>
<blockquote>
<p>如果你想了解更多 Docker 使用方式，可以参考其他 Docker 入门文档或教程。也可直接在物理操作系统上安装MySQL</p>
</blockquote>
<h5 data-id="heading-4">数据库连接信息</h5>
<p>启动完成后，你就可以通过以下信息连接数据库：</p>
<ul>
<li><strong>URL</strong>：<code>物理机IP:3306</code></li>
<li><strong>用户名</strong>：<code>root</code></li>
<li><strong>密码</strong>：<code>Root123</code></li>
<li><strong>数据库</strong>：<code>arcsoft_face</code></li>
</ul>
<p>这样就完成了数据库环境的搭建，为 ArcsoftFaceDemo 的人脸库管理做好了基础准备。</p>
<h3 data-id="heading-5">2、工程导入与数据库配置</h3>
<p>在完成数据库环境准备后，下一步是导入 <strong>ArcSoftFaceDemo</strong> 工程，并将默认数据库配置改为 MySQL。</p>
<h5 data-id="heading-6">导入工程</h5>
<ol>
<li>从 ArcSoft <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.arcsoft.com.cn%2F%3Futm_source%3DJuejin%26%26utm_medium%3Dshentao" target="_blank" title="https://ai.arcsoft.com.cn/?utm_source=Juejin&amp;&amp;utm_medium=shentao" ref="nofollow noopener noreferrer">官网</a>下载 <strong>ArcSoftFaceDemo</strong> 工程压缩包。</li>
<li>解压后，用 <strong>IntelliJ IDEA</strong> 打开工程目录。</li>
</ol>
<h5 data-id="heading-7">修改数据库配置</h5>
<p>工程默认使用的是 <strong>H2 内存数据库</strong>，适合快速演示和测试。但在正式环境中，建议切换到 <strong>MySQL</strong> 或其他持久化数据库。</p>
<p>打开 <code>application.properties</code> 文件，找到默认配置：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:h2:file:./data/arcdb
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=password
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console
spring.sql.init.mode=always
spring.sql.init.schema-locations=classpath:db/schema-h2.sql
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>spring.datasource.url</code>：H2 数据库文件路径。</li>
<li><code>spring.datasource.driver-class-name</code>：H2 数据库驱动。</li>
<li><code>spring.datasource.username</code> / <code>spring.datasource.password</code>：数据库账号密码。</li>
<li><code>spring.h2.console.*</code>：H2 Web 控制台相关配置，方便调试。</li>
<li><code>spring.sql.init.*</code>：初始化 SQL 文件路径，用于创建示例表结构。</li>
</ul>
<h5 data-id="heading-8">H2切换为MySQL</h5>
<p>在正式环境中，我们需要将默认 H2 配置改为 MySQL。打开 <code>application.properties</code>，将数据库相关配置修改为 MySQL 连接信息：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/arcsoft_face?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=Root123
spring.sql.init.mode=always
spring.sql.init.schema-locations=classpath:db/schema-mysql.sql
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>spring.datasource.url</code>：MySQL 连接 URL，包含数据库名 <code>arcsoft_face</code>，字符集与时区设置。<code>localhost</code>地址根据实际数据库IP地址设置</li>
<li><code>spring.datasource.driver-class-name</code>：MySQL 驱动类。</li>
<li><code>spring.datasource.username</code> / <code>spring.datasource.password</code>：MySQL 账号密码，对应 Docker 启动 MySQL 时设置的用户名和密码。</li>
<li><code>spring.sql.init.*</code>：初始化 SQL 文件路径，用于创建用户表结构（与 H2 不同，需要使用 MySQL 版本 SQL）。</li>
</ul>
<hr/>
<h5 data-id="heading-9">验证数据库连接</h5>
<ol>
<li>启动 ArcSoftFaceDemo 工程。</li>
<li>检查启动日志，确认数据库连接成功：</li>
</ol>
<pre><code class="hljs language-erlang" lang="erlang">HikariPool-<span class="hljs-number">1</span> - Starting...
HikariPool-<span class="hljs-number">1</span> - Start completed.
</code></pre>
<p>注意：使用 MySQL 客户端（如 <code>mysql</code> 命令行或 Navicat等）连接数据库，确认 <code>arcsoft_face</code> 数据库已创建成功。</p>
<hr/>
<h5 data-id="heading-10">创建用户表</h5>
<p>如果 MySQL 数据库中没有表，需要执行初始化 SQL 创建 <code>user_info</code> 表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> user_info (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">60</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    extra_info <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
    face_feature <span class="hljs-type">BLOB</span>,
    image_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">120</span>),
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY user_info_name_uindex (name)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;

</code></pre>
<p><strong>关键字段说明：</strong></p>
<ul>
<li><code>id</code>：用户唯一标识。</li>
<li><code>name</code>：用户名。</li>
<li><code>face_feature</code>：ArcSoft SDK 提取的人脸特征二进制数据。这里也可以根据业务来，使用text类型，存储base64编码后的字符串数据</li>
<li><code>image_url</code>：注册证存储地址。</li>
</ul>
<p>这样就完成了 MySQL 数据库接入 ArcSoftFaceDemo 的准备工作。</p>
<h3 data-id="heading-11">3、人脸注册过程说明（FaceService.java）</h3>
<p><code>FaceService</code> 是整个系统的人脸注册与管理核心逻辑，负责：</p>
<ul>
<li>从数据库读取用户人脸信息</li>
<li>注册/更新人脸到 ArcFace SDK 内存引擎</li>
<li>删除人脸</li>
<li>系统启动时批量加载人脸</li>
<li>支持从数据库、本地图片、classpath 目录三种来源初始化</li>
</ul>
<p>下面详细说明各功能模块的逻辑。</p>
<h4 data-id="heading-12">人脸注册核心方法：addUser</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(String name, <span class="hljs-type">byte</span>[] faceFeature)</span> {
        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoMapper.selectOne(Wrappers.&lt;UserInfo&gt;lambdaQuery().eq(UserInfo::getName, name));
        <span class="hljs-keyword">if</span> (userInfo == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfoInsert</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>();
            userInfoInsert.setId((<span class="hljs-type">int</span>) (System.currentTimeMillis() % <span class="hljs-number">1_000_000_000</span>)); <span class="hljs-comment">//如果是MySQL数据库，可去掉这个，利用数据库自增长id来生成</span>
            userInfoInsert.setName(name);
            userInfoInsert.setFaceFeature(faceFeature);
            userInfoMapper.insert(userInfoInsert);
            faceEngineService.registerFaceFeature2Engine(userInfoInsert.getId(), name, faceFeature);

        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfoUpdate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>();
            userInfoUpdate.setId(userInfo.getId());
            userInfoUpdate.setName(name);
            userInfoUpdate.setFaceFeature(faceFeature);
            userInfoMapper.updateById(userInfoUpdate);
            faceEngineService.removeFaceFeature2Engine(userInfo.getId());
            faceEngineService.registerFaceFeature2Engine(userInfo.getId(), name, faceFeature);
        }
    }
</code></pre>
<h5 data-id="heading-13">功能说明</h5>
<p><code>addUser</code> 是 ArcSoftFaceDemo 项目中最核心的人脸注册方法，主要功能是：</p>
<ul>
<li>将输入的人脸特征（byte[]）写入数据库</li>
<li>将人脸特征注册到 ArcFace 引擎的内存特征库（内存中的索引结构）</li>
<li>同步维护两端的数据一致性（数据库 ↔ 识别引擎）</li>
</ul>
<p>ArcFace SDK 的识别能力依赖于<strong>内存中的特征库</strong>，因此每次注册、更新、删除都必须保持数据库与 SDK 内存库一致。在做新增的时候，同步两边需同时新增，保证数据一致性。</p>
<p>这里注册存储的时候，也可以同时带一些业务上的信息，如人员id，人员姓名，人员注册照存放地址等。这些信息，<strong>在数据库中可以以字段的形式进行存储归档</strong>，可参考上面<code>user_info</code>表进行字段扩展优化。如果想通过SDK的<code>searchFaceFeature</code>接口获取到这些额外信息，在<code>registerFaceFeature</code>接口中提供了<code>faceTag</code>的一个字符串类型，用于存放业务数据，可以把这些信息<strong>以JSON字符串形式存放到<code>faceTag</code>中去</strong>，当然也可通过searchId，再查询数据库的方式，把对应的人员信息查询出来</p>
<p>ArcFace SDK 提取的人脸特征是一个 <strong>byte[] 数组</strong>。5.0 的中模型特征长度在 2056字节，大模型特征特征长度3080字节，这里在做数据库字段大小的时候需要关注下</p>
<p><strong>两种存储方式：SDK的特征类型是byte[]数组类型，存储到数据库方式：</strong></p>
<p>1、可以直接使用BLOB类型，一般推荐用<strong>BLOB类型</strong>存储，可以减少编解码带来的性能损失</p>
<p>2、byte[]数组转成base64字符串，数据库用<strong>TEXT类型</strong>进行存储，如果涉及到网络传输，可使用Base64字符串</p>
<h4 data-id="heading-14">删除用户 removeUser</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUser</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoMapper.selectOne(Wrappers.&lt;UserInfo&gt;lambdaQuery().eq(UserInfo::getName, name));
        <span class="hljs-keyword">if</span> (userInfo != <span class="hljs-literal">null</span>) {
            faceEngineService.removeFaceFeature2Engine(userInfo.getId());
            userInfoMapper.deleteById(userInfo.getId());
        }
    }
</code></pre>
<ol>
<li>根据用户名查询用户</li>
<li>从 SDK 内存引擎移除人脸</li>
<li>从数据库删除记录</li>
</ol>
<h4 data-id="heading-15">系统启动时自动加载人脸</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadImage2Engine</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"true"</span>.equals(faceImageClear)) {
            removeAllUser();
            initSystemFace();
            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(testImagePath);
            <span class="hljs-keyword">if</span> (file.isDirectory()) {
                File[] files = file.listFiles();
                log.info(<span class="hljs-string">"开始加载本地人脸图片到引擎中"</span>);
                <span class="hljs-keyword">for</span> (File imageFile : files) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> imageFile.getName();
                    <span class="hljs-keyword">if</span> (name.endsWith(<span class="hljs-string">".jpg"</span>) || name.endsWith(<span class="hljs-string">".png"</span>)) {
                        <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> name.substring(<span class="hljs-number">0</span>, name.lastIndexOf(<span class="hljs-string">"."</span>));
                        register(userName, imageFile, <span class="hljs-literal">null</span>);
                    }
                }
                log.info(<span class="hljs-string">"加载本地人脸图片到引擎中完成"</span>);
            }
        }<span class="hljs-keyword">else</span> {
            initDatabaseFace2Engine();
        }
    }
</code></pre>
<p>系统启动后执行，用于初始化内存人脸库，为了加快识别速度，建议每次启动服务后，就直接把数据库里的人脸注册信息放到SDK引擎里，减少下次识别读取数据库带来的耗时增加。Demo中提供了有两种模式，根据配置文件的<code>register.faceimage.clean</code>进行切换</p>
<p><code>register.faceimage.clean</code>=true，每次启动会清空数据库，重新加载本地图片进行注册，同时存储到数据库和SDK</p>
<p><code>register.faceimage.clean</code>=false，每次启动从数据库读取特征，加载到SDK。Demo为了测试，会同时把本地本次未注册的图片进行存储和注册，生产环境可只保留从数据库读取加载</p>
<h3 data-id="heading-16">4、人脸识别方式</h3>
<p>这里再另外提一下，SDK人脸识别主要有以下两种方案，Demo采用的是第2种方案，也可根据实际业务使用第1种方案</p>
<h4 data-id="heading-17">①、使用 Map 列表 + <code>compareFaceFeature</code> 接口</h4>
<ul>
<li><strong>原理</strong>：将注册的人脸特征存放在 Map 或列表中，通过 SDK 的 <code>compareFaceFeature</code> 接口进行循环比对。</li>
<li><strong>优点</strong>：可灵活分组管理人脸库；支持多线程并发比对。</li>
<li><strong>缺点</strong>：当人脸库量大时，频繁调用比对接口会增加性能损耗。</li>
</ul>
<h4 data-id="heading-18">②、使用 SDK 提供的原生接口注册</h4>
<ul>
<li><strong>原理</strong>：利用<code>registerFaceFeature</code>、<code>removeFaceFeature</code>、<code>updateFaceFeature</code>、<code>searchFaceFeature</code> 组合接口，实现对人脸的增删改查</li>
<li><strong>优点</strong>：SDK 原生实现比对，性能快，资源消耗少。</li>
<li><strong>缺点</strong>：不支持分组比对；系统重启后需重新注册特征；多引擎并发时，每个引擎的人脸库需单独管理，维护复杂。</li>
</ul>
<p>​	<strong>为了实现长久保存和分布式共享，人脸特征需进行合理存储</strong></p>
<h3 data-id="heading-19">5、人脸引擎说明（FaceEngineService.java）</h3>
<p><code>FaceEngineService</code> 是人脸SDK 的核心部分，负责：</p>
<ul>
<li>人脸检测、特征提取、活体检测、属性检测等</li>
<li>人员信息的新增、删除、修改、人脸搜索</li>
</ul>
<p>下面详细说明各功能模块的逻辑。</p>
<h4 data-id="heading-20">人员新增：registerFaceFeature2Engine</h4>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFaceFeature2Engine</span><span class="hljs-params">(<span class="hljs-type">int</span> searchId, String faceTag, <span class="hljs-type">byte</span>[] faceFeature)</span> {

        <span class="hljs-type">FaceEngineFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (FaceEngineFactory) faceEngineComparePool.getFactory();

        List&lt;FaceEngine&gt; allObjects = factory.getAllObjects();
        <span class="hljs-type">FaceFeatureInfo</span> <span class="hljs-variable">faceFeatureInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FaceFeatureInfo</span>();
        faceFeatureInfo.setSearchId(searchId);
        faceFeatureInfo.setFaceTag(faceTag);
        faceFeatureInfo.setFeatureData(faceFeature);
<span class="hljs-comment">//        log.info("Register:"+ JSON.toJSONString(faceFeatureInfo));</span>
        <span class="hljs-keyword">for</span> (FaceEngine allObject : allObjects) {
            <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> allObject.registerFaceFeature(faceFeatureInfo);
        }、、

    }
</code></pre>
<p><strong>这里重点说明下，因为我们的FaceEngine用了线程池，同时初始化了多个引擎，所以我们在向SDK注册人员信息的时候，需要给每个引擎进行注册，删除同理。</strong></p>
<h4 data-id="heading-21">人员新增：removeFaceFeature2Engine</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeFaceFeature2Engine</span><span class="hljs-params">(<span class="hljs-type">int</span> searchId)</span> {
        <span class="hljs-type">FaceEngineFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (FaceEngineFactory) faceEngineComparePool.getFactory();
        List&lt;FaceEngine&gt; allObjects = factory.getAllObjects();
        <span class="hljs-keyword">for</span> (FaceEngine allObject : allObjects) {
            allObject.removeFaceFeature(searchId);
        }
    }
</code></pre>
<p>删除同注册接口，需要同步向所有FaceEngine库进行移除操作</p>
<h3 data-id="heading-22">二、人脸特征三层存储与分布式管理</h3>
<p>上面已经介绍了基本的数据库接入和使用，那么在实际人脸识别场景下，系统的数据存储与识别通常采用三层设计：</p>
<ol>
<li><strong>MySQL</strong>：负责持久化存储人脸特征信息，实现可靠的长期保存。</li>
<li><strong>Redis</strong>：用于异步更新与分布式缓存，实现多机器环境下的人脸特征共享。</li>
<li><strong>内存（ConcurrentHashMap / 特征池）</strong>：存储当前在线的活跃人脸特征，实现毫秒级识别。</li>
</ol>
<p>这种设计保证了系统既能持久化存储，又能在识别时获得最佳性能。</p>
<p>在 Spring Boot 项目中，实现人脸特征的管理可以从<strong>数据库建表、服务层加载、Redis缓存、特征注册与比对</strong>几个方面进行详细设计。</p>
<p>在多台识别服务器部署的分布式环境中，人脸特征需要在各节点之间保持<strong>一致性、高可用和高性能</strong>。结合内存、Redis 和数据库三层存储，设计参考方案：</p>
<h5 data-id="heading-23">1、 启动加载策略</h5>
<ul>
<li><strong>流程</strong>：
<ol>
<li>每台识别服务器启动时，先从 Redis 拉取最新的人脸特征到本地内存缓存。</li>
<li>如果 Redis 中没有特征数据（如初次部署），则从 MySQL 数据库加载。Redis 可作为 <strong>内存缓存 + 异步更新机制</strong>，保证各节点识别数据一致性</li>
<li>加载后，内存缓存即可支持毫秒级人脸识别。</li>
</ol>
</li>
<li><strong>实现示例</strong>：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadFeaturesOnStartup</span><span class="hljs-params">()</span> {
    Set&lt;String&gt; keys = redisTemplate.keys(<span class="hljs-string">"face:*"</span>);
    <span class="hljs-keyword">if</span> (keys != <span class="hljs-literal">null</span> &amp;&amp; !keys.isEmpty()) {
        <span class="hljs-keyword">for</span> (String key : keys) {
            <span class="hljs-type">byte</span>[] featureData =(<span class="hljs-type">byte</span>[]) redisTemplate.opsForValue().get(key);
            <span class="hljs-keyword">if</span> (featureData != <span class="hljs-literal">null</span>) {
                featureMap.put(key.replace(<span class="hljs-string">"face:"</span>, <span class="hljs-string">""</span>), featureData);
            }
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Redis为空，从数据库加载</span>
        List&lt;FaceFeature&gt; features = repository.findAll();
        <span class="hljs-keyword">for</span> (FaceFeature f : features) {
            featureMap.put(f.getUserId(), f.getFeature());
            redisTemplate.opsForValue().set(<span class="hljs-string">"face:"</span> + f.getUserId(), f.getFeature());
        }
    }
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ul>
<li>避免每次识别都访问数据库，提高性能。</li>
<li>启动即加载最新特征，保证识别数据实时性。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-24">2、 特征更新与同步策略</h5>
<p>在分布式场景下，用户新增、删除或更新人脸特征时，需要保证所有节点内存保持一致：</p>
<ol>
<li>
<p><strong>更新顺序</strong>：</p>
<p><strong>写内存</strong>：立即更新本地内存缓存，保证识别服务实时可用。</p>
<ul>
<li><strong>写 Redis</strong>：同步到 Redis，作为分布式共享层。</li>
<li><strong>写数据库</strong>：异步持久化到 MySQL，保证长期数据安全。</li>
</ul>
</li>
<li>
<p><strong>同步机制</strong>：</p>
<ul>
<li>利用 Redis <strong>Pub/Sub</strong> 或消息队列（Kafka、RabbitMQ）广播更新事件。</li>
<li>其他节点接收到更新事件后，刷新本地内存特征缓存。</li>
</ul>
</li>
</ol>
<ul>
<li><strong>示例逻辑</strong>：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateFeature</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId, byte[] feature</span>) {
    <span class="hljs-comment">// 更新本地内存</span>
    featureMap.<span class="hljs-title function_">put</span>(userId, feature);
    <span class="hljs-comment">// 更新 Redis</span>
    redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">set</span>(<span class="hljs-string">"face:"</span> + userId, feature);
    <span class="hljs-comment">// 发布更新事件通知其他节点</span>
    redisTemplate.<span class="hljs-title function_">convertAndSend</span>(<span class="hljs-string">"face:update"</span>, userId);
    <span class="hljs-comment">// 异步更新数据库</span>
    <span class="hljs-title function_">asyncUpdateDatabase</span>(userId, feature);
}

<span class="hljs-comment">// 订阅事件刷新内存</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleRedisUpdateEvent</span>(<span class="hljs-params">Message message</span>) {
    <span class="hljs-title class_">String</span> userId = (<span class="hljs-title class_">String</span>) message.<span class="hljs-title function_">getBody</span>();
    <span class="hljs-title class_">String</span> feature = redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">get</span>(<span class="hljs-string">"face:"</span> + userId);
    <span class="hljs-keyword">if</span> (feature != <span class="hljs-literal">null</span>) {
        featureMap.<span class="hljs-title function_">put</span>(userId, feature);
    }
}
</code></pre>
<p>通过合理的存储架构和内存优化，Spring Boot 项目的人脸识别系统可以在保证高性能的同时，实现可扩展、分布式的人脸管理功能，为智能门禁、考勤和访客系统提供稳定支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[💬 从猜想到架构：AI 聊天区域的 Web 设计之道]]></title>    <link>https://juejin.cn/post/7582067084841238582</link>    <guid>https://juejin.cn/post/7582067084841238582</guid>    <pubDate>2025-12-11T02:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084841238582" data-draft-id="7582090790182535206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="💬 从猜想到架构：AI 聊天区域的 Web 设计之道"/> <meta itemprop="keywords" content="前端,前端框架,AIGC"/> <meta itemprop="datePublished" content="2025-12-11T02:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            💬 从猜想到架构：AI 聊天区域的 Web 设计之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:11:06.000Z" title="Thu Dec 11 2025 02:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、猜想的起点：当网页开口说话 🤖💭</h2>
<p>某天产品经理（或者你自己）灵光一闪：</p>
<blockquote>
<p>“能不能在我们的网站上加个 AI 聊天区？让用户可以和 AI 对话。”</p>
</blockquote>
<p>于是前端开发者眯起眼脑补一堆需求：</p>
<ul>
<li>聊天消息要滚动，要能实时流动 💨</li>
<li>用户输入框要光滑、响应快 ✨</li>
<li>AI 回复不能卡顿，要像打字机一样“哒哒”出来 🎹</li>
<li>最好能接上下文、换模型、甚至支持图片 🖼️</li>
</ul>
<p>听起来像个小功能，实则背后是一场<strong>系统性工程的“建筑哲学”</strong> 。</p>
<hr/>
<h2 data-id="heading-1">二、第一阶段：从幻想到草图 ✏️</h2>
<p>在设计前，<strong>架构师的思考不是“怎么写代码”，而是“怎么分层思考”</strong> 。</p>
<h3 data-id="heading-2">🧩 基本模块猜想</h3>



































<table><thead><tr><th>模块</th><th>职责</th><th>技术支撑</th></tr></thead><tbody><tr><td>UI 渲染区</td><td>聊天消息显示</td><td>React / Vue / Svelte</td></tr><tr><td>状态管理</td><td>聊天逻辑、上下文缓存</td><td>Zustand / Redux / Signals</td></tr><tr><td>消息通道</td><td>连接后端模型流</td><td>WebSocket / Server-Sent Events</td></tr><tr><td>模型接入层</td><td>OpenAI API / 本地推理</td><td>Node.js / Python FastAPI</td></tr><tr><td>数据层</td><td>会话持久化 / 用户信息</td><td>IndexedDB / Redis / PostgreSQL</td></tr></tbody></table>
<blockquote>
<p>⚙️ 每个模块都不是孤岛，而是数据流中的一环。<br/>
设计的秘诀，就是<strong>让复杂的行为结构化</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、底层结构：从数据流说起 🌊</h2>
<p>AI聊天的交互，本质是<strong>双向异步数据流</strong>：</p>
<ol>
<li>用户 → 前端发送输入</li>
<li>前端 → 后端发起消息请求</li>
<li>后端 → 模型推理生成文本流</li>
<li>模型输出结果 → 前端逐字渲染</li>
</ol>
<p>👉 这意味着，一个优秀的聊天区域不是“一次请求一次响应”，<br/>
而是一个<strong>实时流式交互引擎</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">// 核心伪代码：流式接收AI回复
const <span class="hljs-attr">eventSource</span> = new EventSource(&amp;<span class="hljs-comment">#34;/api/chat-stream&amp;#34;);</span>

<span class="hljs-attr">eventSource.onmessage</span> = (msg) =&gt; {
  const <span class="hljs-attr">chunk</span> = JSON.parse(msg.data)<span class="hljs-comment">;</span>
  renderToChatWindow(chunk.text)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

sendUserMessage(&amp;<span class="hljs-comment">#34;你好，AI！&amp;#34;);</span>
</code></pre>
<blockquote>
<p>💡 这段逻辑的灵魂其实是：<strong>边计算、边传输、边渲染</strong>，<br/>
让用户“感觉不到延迟”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">四、从UI到体验：界面不是装饰，而是情绪调节器 🎨</h2>
<p>一个聊天区域不只是代码块，它是用户心理的镜子。</p>
<h3 data-id="heading-5">🎯 设计准则：</h3>
<ul>
<li><strong>流动感 (Flowing)</strong> ：AI 回复应逐字呈现，而非“啪”地一整段文字。</li>
<li><strong>连续感 (Continuity)</strong> ：上下文气泡间应轻微动画衔接，模拟自然对话。</li>
<li><strong>反馈感 (Feedback)</strong> ：用户发送消息后的“思考中…”状态能显著提升信任感。</li>
<li><strong>呼吸感 (Breathing)</strong> ：使用间距、留白减少视觉噪音，让AI看起来“温和”。</li>
</ul>
<h3 data-id="heading-6">🧠 小段UI示例</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"chat"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"message user"</span>&gt;你好，AI！&lt;/div&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"message ai"</span>&gt;你好，我是你的AI助手。&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Inter'</span>, sans-serif;
}
<span class="hljs-selector-class">.message</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.message</span><span class="hljs-selector-class">.user</span> {
  <span class="hljs-attribute">text-align</span>: right;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
}
<span class="hljs-selector-class">.message</span><span class="hljs-selector-class">.ai</span> {
  <span class="hljs-attribute">text-align</span>: left;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f1f3f4</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
  <span class="hljs-attribute">animation</span>: typing <span class="hljs-number">0.05s</span> linear;
}
</code></pre>
<blockquote>
<p>✨ UI 不是美工问题，是心理学—用户信任感是一种交互协议。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、第二阶段：从前端到中台 🧰</h2>
<p>AI 聊天本身并不复杂，复杂的是<strong>如何管理多模型、多对话、多用户</strong>。</p>
<h3 data-id="heading-8">🏗️ 架构演化图（逻辑层次）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ 用户浏览器 ]</span>
      │
      ▼
<span class="hljs-selector-attr">[ 前端界面（React/JS） ]</span>
      │
  WebSocket / HTTPS
      │
      ▼
<span class="hljs-selector-attr">[ Node.js 中台网关 ]</span>
      │
   ├── ConversationManager
   ├── StreamController
   └── RateLimiter
      │
      ▼
<span class="hljs-selector-attr">[ 模型服务层 ]</span>
   ├── OpenAI Adapter
   ├── LocalLLM Runner
   └── Hybrid Model Router
      ▼
   <span class="hljs-selector-attr">[ 数据存储层 ]</span>
   ├── Chat History (PostgreSQL)
   ├── User Meta (Redis)
   └── Prompt Templates
</code></pre>
<blockquote>
<p>每个模块都能独立演化。<br/>
模型层可以替换；前端可以升级框架；中间层负责“协议平衡”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">六、第三阶段：底层机制优化 💾</h2>
<h3 data-id="heading-10">⚙️ 异步队列管理</h3>
<p>由于 AI 回复是流式数据，建议建立一个<strong>消息状态机</strong>：</p>
<ul>
<li>待发送</li>
<li>已发送</li>
<li>等待回复</li>
<li>流式接收中</li>
<li>完成</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = [];
  }
  <span class="hljs-title function_">add</span>(<span class="hljs-params">msg</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>({ ...msg, <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span> });
  }
  <span class="hljs-title function_">update</span>(<span class="hljs-params">id, patch</span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">id</span> === id);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(m, patch);
  }
}
</code></pre>
<p>这让“输入与输出”在逻辑上渐进一致，也方便扩展多轮上下文追踪。</p>
<hr/>
<h2 data-id="heading-11">七、争议话题：AI 聊天的“人格”边界 🧬</h2>
<p>当设计者开始给AI聊天区设计<strong>声音、名字、表情</strong>时，<br/>
我们已经在跨越伦理和体验的界限。</p>
<blockquote>
<ul>
<li>用户希望AI“更懂自己”；</li>
<li>开发者希望AI“更可控”。</li>
</ul>
</blockquote>
<p>这就像在设计一个同时属于人类与算法的“新物种接口”。<br/>
别忘了：对话越自然，越需要在结构上保持<strong>透明与可解释性</strong>。</p>
<hr/>
<h2 data-id="heading-12">八、结语：从前端到哲学 🌌</h2>
<p>从猜想到架构的整个旅程，其实是一种工程师式的浪漫。<br/>
我们用代码模拟理解、用结构承载思考。</p>
<blockquote>
<p>“AI 聊天框是信息社会的镜子，<br/>
我们不只是教机器说话，<br/>
—— 也在重新学习如何倾听。” 🎧</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">🧾 教学总结</h2>









































<table><thead><tr><th>阶段</th><th>核心任务</th><th>难点</th><th>关键技术</th></tr></thead><tbody><tr><td>猜想</td><td>定义体验与功能边界</td><td>模糊目标</td><td>用户心理模型分析</td></tr><tr><td>草图</td><td>拆分模块层次</td><td>职责不清</td><td>信息架构设计</td></tr><tr><td>架构</td><td>确定核心逻辑</td><td>异步交互流</td><td>WebSocket / SSE</td></tr><tr><td>优化</td><td>性能 &amp; 状态一致性</td><td>时序混乱</td><td>状态机设计</td></tr><tr><td>哲学</td><td>体验与伦理平衡</td><td>拟人过度</td><td>可解释性、审美化设计</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite开发环境按需编译是怎么实现的？]]></title>    <link>https://juejin.cn/post/7582169248094978054</link>    <guid>https://juejin.cn/post/7582169248094978054</guid>    <pubDate>2025-12-11T06:55:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582169248094978054" data-draft-id="7582169248094945286" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite开发环境按需编译是怎么实现的？"/> <meta itemprop="keywords" content="前端,JavaScript,Vite"/> <meta itemprop="datePublished" content="2025-12-11T06:55:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sorryhc"/> <meta itemprop="url" content="https://juejin.cn/user/3061476130044487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite开发环境按需编译是怎么实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3061476130044487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sorryhc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T06:55:02.000Z" title="Thu Dec 11 2025 06:55:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><code>Vite</code>的快，我们并不陌生，主要体现在开发环境时的体验。</p>
<p>而相较于其他构建工具，<code>Vite</code>核心是依靠了现代浏览器对于原生<code>esm</code>模块的支持+按需实时编译将性能达到了极致。</p>
<p>我们基于源码来看看<code>esbuild</code>编译的完整过程。</p>
<h2 data-id="heading-1">核心流程图</h2>
<pre><code class="hljs language-bash" lang="bash">Browser Request
    ↓
Vite DevServer (Connect 中间件)
    ↓
请求路由判断
    ├─ /.vite/client → 注入客户端代码
    ├─ /@modules/* → node_modules 导入
    ├─ /src/* → 源代码文件
    └─ *.json, *.css 等 → 特殊处理
    ↓
ModuleGraph 缓存检查
    ├─ 命中缓存 → 返回
    └─ 未命中 → esbuild 编译
    ↓
TransformPlugin 流程
    ├─ pre plugins
    ├─ esbuild transform
    └─ post plugins
    ↓
发送给浏览器 (ES Modules)
</code></pre>
<h3 data-id="heading-2">DevServer入口代码</h3>
<p>这里初始化了开发服务器、模块图（缓存系统）、很多中间件（用于拦截实时编译）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/server/index.ts</span>

<span class="hljs-keyword">import</span> connect <span class="hljs-keyword">from</span> <span class="hljs-string">'connect'</span>
<span class="hljs-keyword">import</span> { createPluginContainer } <span class="hljs-keyword">from</span> <span class="hljs-string">'./pluginContainer'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createServer</span>(<span class="hljs-params">inlineConfig: InlineConfig = {}</span>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> <span class="hljs-title function_">resolveConfig</span>(inlineConfig, <span class="hljs-string">'serve'</span>)
  
  <span class="hljs-comment">// 创建 Express-like 应用</span>
  <span class="hljs-keyword">const</span> middlewares = <span class="hljs-title function_">connect</span>()
  <span class="hljs-keyword">const</span> httpServer = <span class="hljs-title function_">createHttpServer</span>(middlewares)
  
  <span class="hljs-comment">// 创建模块图（缓存系统）</span>
  <span class="hljs-keyword">const</span> moduleGraph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleGraph</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span>
    pluginContainer.<span class="hljs-title function_">resolveId</span>(url)
  )
  
  <span class="hljs-comment">// 创建插件容器（执行插件）</span>
  <span class="hljs-keyword">const</span> pluginContainer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createPluginContainer</span>(config)
  
  <span class="hljs-comment">// 核心中间件们</span>
  middlewares.<span class="hljs-title function_">use</span>(timeMiddleware)
  middlewares.<span class="hljs-title function_">use</span>(cors)
  middlewares.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">transformMiddleware</span>(server))  <span class="hljs-comment">// ⭐ 重点</span>
  middlewares.<span class="hljs-title function_">use</span>(servePublicDir)
  middlewares.<span class="hljs-title function_">use</span>(serveRawFs)
  
  <span class="hljs-keyword">const</span> server = {
    middlewares,
    httpServer,
    moduleGraph,
    pluginContainer,
    <span class="hljs-attr">ws</span>: <span class="hljs-title function_">createWebSocketServer</span>(httpServer),
    <span class="hljs-comment">// ... 其他属性</span>
  }
  
  <span class="hljs-keyword">return</span> server
}
</code></pre>
<h3 data-id="heading-3">Transform中间件（请求拦截）</h3>
<p>这里是一个很经典的例子，从浏览器发起第一次<code>main.ts</code>请求开始，<code>Vite</code>做了<code>ts</code>文件的转换。</p>
<p>而后续的请求会从<code>main.ts</code>中发起。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/server/middlewares/transform.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMiddleware</span>(<span class="hljs-params">server: ViteDevServer</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">IncomingMessage</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">ServerResponse</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">NextFunction</span>) =&gt; {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">'GET'</span> || <span class="hljs-title function_">isSkipped</span>(req.<span class="hljs-property">url</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()
    }

    <span class="hljs-keyword">let</span> url = req.<span class="hljs-property">url</span>
    <span class="hljs-keyword">const</span> { pathname, search, hash } = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-string">`http://<span class="hljs-subst">${req.headers.host}</span>`</span>)
    
    <span class="hljs-comment">// 示例：/src/main.ts?t=123 → /src/main.ts</span>
    url = pathname + search + hash

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// ⭐ 核心：调用加载和转换</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">transformRequest</span>(url, server, {
        <span class="hljs-attr">raw</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'accept'</span>]?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'application/octet-stream'</span>),
      })

      <span class="hljs-keyword">if</span> (result) {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = <span class="hljs-title function_">isDirectCSSRequest</span>(url) ? <span class="hljs-string">'text/css'</span> : <span class="hljs-string">'application/javascript'</span>
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-keyword">type</span>)
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>)
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'ETag'</span>, <span class="hljs-title function_">getEtag</span>(result.<span class="hljs-property">code</span>))
        
        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(result.<span class="hljs-property">code</span>)
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 错误处理</span>
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">code</span> === <span class="hljs-string">'ENOENT'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()
      }
      <span class="hljs-comment">// HMR 错误通知浏览器</span>
      server.<span class="hljs-property">ws</span>.<span class="hljs-title function_">send</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
        <span class="hljs-attr">event</span>: <span class="hljs-string">'vite:error'</span>,
        <span class="hljs-attr">err</span>: e,
      })
    }

    <span class="hljs-title function_">next</span>()
  }
}

</code></pre>
<h3 data-id="heading-4">请求转换核心逻辑</h3>
<p>这里是核心的源码转换逻辑，基于源码优先从模块缓存表中取，如果没有才走该模块的首次转换，最后会落到缓存中。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/server/transformRequest.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformRequest</span>(<span class="hljs-params">
  url: <span class="hljs-built_in">string</span>,
  server: ViteDevServer,
  options?: TransformOptions,
</span>) {
  <span class="hljs-comment">// 1️⃣ 获取文件内容 + 元数据</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">code</span>: raw, map } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadRawRequest</span>(url, server)
  
  <span class="hljs-keyword">let</span> code = raw
  <span class="hljs-keyword">const</span> inMap = map

  <span class="hljs-comment">// 2️⃣ 检查缓存</span>
  <span class="hljs-keyword">const</span> cached = server.<span class="hljs-property">moduleGraph</span>.<span class="hljs-title function_">getModuleByUrl</span>(url)
  <span class="hljs-keyword">if</span> (!server.<span class="hljs-property">config</span>.<span class="hljs-property">command</span> === <span class="hljs-string">'serve'</span> &amp;&amp; cached?.<span class="hljs-property">transformedCode</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">code</span>: cached.<span class="hljs-property">transformedCode</span>,
      <span class="hljs-attr">map</span>: cached.<span class="hljs-property">map</span>,
    }
  }

  <span class="hljs-comment">// 3️⃣ 执行插件转换</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">transform</span>(code, url)
  <span class="hljs-keyword">if</span> (result) {
    code = result.<span class="hljs-property">code</span>
  }

  <span class="hljs-comment">// 4️⃣ 特殊处理：自动导入注入</span>
  <span class="hljs-keyword">if</span> (!options?.<span class="hljs-property">raw</span>) {
    code = <span class="hljs-title function_">injectHelper</span>(code, url)
  }

  <span class="hljs-comment">// 5️⃣ 缓存结果</span>
  server.<span class="hljs-property">moduleGraph</span>.<span class="hljs-title function_">updateModuleInfo</span>(url, {
    <span class="hljs-attr">transformedCode</span>: code,
    <span class="hljs-attr">map</span>: result?.<span class="hljs-property">map</span>,
  })

  <span class="hljs-keyword">return</span> { code, <span class="hljs-attr">map</span>: result?.<span class="hljs-property">map</span> }
}

</code></pre>
<h3 data-id="heading-5">加载原始请求（磁盘读写）</h3>
<p>而加载和编译源码则是直接通过<code>esbuild</code>能力来实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/server/transformRequest.ts</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadRawRequest</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, server: ViteDevServer</span>) {
  <span class="hljs-keyword">let</span> id = <span class="hljs-built_in">decodeURIComponent</span>(<span class="hljs-title function_">parseUrl</span>(url).<span class="hljs-property">pathname</span>)
  
  <span class="hljs-comment">// ⭐ 调用插件的 resolveId hook</span>
  <span class="hljs-keyword">const</span> resolveResult = <span class="hljs-keyword">await</span> server.<span class="hljs-property">pluginContainer</span>.<span class="hljs-title function_">resolveId</span>(id)
  
  <span class="hljs-keyword">if</span> (resolveResult?.<span class="hljs-property">id</span>) {
    id = resolveResult.<span class="hljs-property">id</span>
  }

  <span class="hljs-comment">// 从文件系统读取</span>
  <span class="hljs-keyword">let</span> code = <span class="hljs-keyword">await</span> fs.<span class="hljs-property">promises</span>.<span class="hljs-title function_">readFile</span>(id, <span class="hljs-string">'utf-8'</span>)
  <span class="hljs-keyword">let</span> <span class="hljs-attr">map</span>: <span class="hljs-title class_">SourceMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

  <span class="hljs-comment">// 如果是 TypeScript，用 esbuild 转译</span>
  <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>) || id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.tsx'</span>)) {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> esbuildService.<span class="hljs-title function_">transform</span>(code, {
      <span class="hljs-attr">loader</span>: <span class="hljs-string">'ts'</span>,
      <span class="hljs-attr">target</span>: <span class="hljs-string">'esnext'</span>,
      <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
    })
    code = result.<span class="hljs-property">code</span>
    map = result.<span class="hljs-property">map</span>
  }

  <span class="hljs-keyword">return</span> { code, map }
}
</code></pre>
<p>因此一次完整的编译流程如下：</p>
<pre><code class="hljs language-ruby" lang="ruby">/<span class="hljs-regexp">/ 实际请求处理过程

/</span><span class="hljs-regexp">/ 浏览器请求：GET /src</span><span class="hljs-regexp">/main.ts
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ transformMiddleware 拦截
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ transformRequest('/src</span><span class="hljs-regexp">/main.ts', server)
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ loadRawRequest: 从磁盘读取 main.ts
/</span><span class="hljs-regexp">/ ├─ 如果是 .ts，用 esbuild 转译为 .js
/</span><span class="hljs-regexp">/ └─ 返回 { code, map }
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ pluginContainer.transform(code, '/src</span><span class="hljs-regexp">/main.ts')
/</span><span class="hljs-regexp">/ ├─ vue plugin: .vue 转换为 { script, template, style }
/</span><span class="hljs-regexp">/ ├─ css-in-js plugin: 处理 styled-components 等
/</span><span class="hljs-regexp">/ ├─ import-analysis plugin: 分析依赖，重写为 /</span><span class="hljs-variable">@modules</span>/xxx
/<span class="hljs-regexp">/ └─ ...其他插件
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ 返回转换后的代码给浏览器
/</span><span class="hljs-regexp">/ ↓
/</span><span class="hljs-regexp">/ 浏览器 import './main</span>.ts<span class="hljs-string">' 
// → 收到 ESM 代码，正常执行
</span></code></pre>
<h3 data-id="heading-6">依赖解析重写</h3>
<p>而<code>Vite</code>如果这样设计，会面临一个问题：请求的数量特别大，导致浏览器首屏时间反而更久。</p>
<p><code>Vite</code>做了一层设计，将多个模块合并到一个模块，即<code>依赖解析重写</code>，如<code>vue -&gt; @modules/vue?v=xxx</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/plugins/importAnalysis.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">importAnalysisPlugin</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite:import-analysis'</span>,
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-comment">// 匹配 import/export 语句</span>
      <span class="hljs-keyword">const</span> imports = <span class="hljs-title function_">parse</span>(code) <span class="hljs-comment">// 用 es-module-lexer 解析</span>
      
      <span class="hljs-keyword">let</span> s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MagicString</span>(code)
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> imp <span class="hljs-keyword">of</span> imports) {
        <span class="hljs-comment">// 例如：import { ref } from 'vue'</span>
        <span class="hljs-keyword">const</span> source = imp.<span class="hljs-property">source</span>
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRelative</span>(source)) {
          <span class="hljs-comment">// 相对路径，保持不变</span>
          <span class="hljs-comment">// import Foo from './foo.ts'</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isBuiltin</span>(source)) {
          <span class="hljs-comment">// Node 内置模块，忽略</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// ⭐ NPM 包，重写为 /@modules/xxx</span>
          <span class="hljs-comment">// import { ref } from 'vue'</span>
          <span class="hljs-comment">// ↓</span>
          <span class="hljs-comment">// import { ref } from '/@modules/vue?v=xxx'</span>
          
          <span class="hljs-keyword">const</span> resolved = <span class="hljs-keyword">await</span> <span class="hljs-title function_">resolveImport</span>(source)
          <span class="hljs-keyword">const</span> rewritten = <span class="hljs-string">`/@modules/<span class="hljs-subst">${resolved.id}</span>`</span>
          
          s.<span class="hljs-title function_">overwrite</span>(imp.<span class="hljs-property">startPos</span>, imp.<span class="hljs-property">endPos</span>, 
            <span class="hljs-string">`import {...} from '<span class="hljs-subst">${rewritten}</span>'`</span>
          )
        }
      }
      
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: s.<span class="hljs-title function_">toString</span>(),
        <span class="hljs-attr">map</span>: s.<span class="hljs-title function_">generateMap</span>(),
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-7">处理node_modules三方库请求</h3>
<p>既然将三方库依赖路径重写，那处理对应的请求也需要进行一次路径转换。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 当浏览器请求 /@modules/vue?v=xxx 时</span>

middlewares.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/@modules/'</span>, <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
  <span class="hljs-keyword">const</span> moduleName = req.<span class="hljs-property">url</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>)[<span class="hljs-number">2</span>]?.<span class="hljs-title function_">split</span>(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>]
  
  <span class="hljs-comment">// /@modules/vue → node_modules/vue/dist/vue.esm.js</span>
  <span class="hljs-keyword">const</span> modulePath = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(moduleName, {
    <span class="hljs-attr">paths</span>: [config.<span class="hljs-property">root</span>],
  })
  
  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> fs.<span class="hljs-property">promises</span>.<span class="hljs-title function_">readFile</span>(modulePath, <span class="hljs-string">'utf-8'</span>)
  
  <span class="hljs-comment">// 继续执行 transform 中间件处理</span>
  <span class="hljs-comment">// 确保 node_modules 中的代码也被正确处理</span>
  res.<span class="hljs-title function_">end</span>(code)
})
</code></pre>
<h3 data-id="heading-8">HMR热更新</h3>
<p>那按照这样的设计，所有模块只要经过一次编译，就会保存在模块缓存表中，热更新如何处理呢？</p>
<p><code>Vite</code>做的也比较通俗易懂，当文件系统监听到文件变化，则清除该模块相关缓存信息，然后<code>websocket</code>通知浏览器，<code>Vite client runtime</code>会重新发起相关改动模块的请求。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/node/server/hmr.ts</span>

<span class="hljs-comment">// 当文件变更时</span>
watcher.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">async</span> (file) =&gt; {
  <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">urlFromFile</span>(file, config.<span class="hljs-property">root</span>)
  
  <span class="hljs-comment">// 1️⃣ 清除模块缓存</span>
  server.<span class="hljs-property">moduleGraph</span>.<span class="hljs-title function_">invalidateModule</span>(url)
  
  <span class="hljs-comment">// 2️⃣ 收集受影响的模块</span>
  <span class="hljs-keyword">const</span> affectedModules = server.<span class="hljs-property">moduleGraph</span>.<span class="hljs-title function_">getImporters</span>(url)
  
  <span class="hljs-comment">// 3️⃣ 通过 WebSocket 通知浏览器</span>
  server.<span class="hljs-property">ws</span>.<span class="hljs-title function_">send</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'update'</span>,
    <span class="hljs-attr">event</span>: <span class="hljs-string">'vite:beforeUpdate'</span>,
    <span class="hljs-attr">updates</span>: affectedModules.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> ({
      <span class="hljs-attr">type</span>: m.<span class="hljs-property">isSelfAccepting</span> ? <span class="hljs-string">'js-update'</span> : <span class="hljs-string">'full-reload'</span>,
      <span class="hljs-attr">event</span>: <span class="hljs-string">'vite:beforeUpdate'</span>,
      <span class="hljs-attr">path</span>: m.<span class="hljs-property">url</span>,
      <span class="hljs-attr">acceptedPath</span>: url,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    }))
  })
})
</code></pre>
<h3 data-id="heading-9">HMR客户端脚本注入</h3>
<p>这就是客户端热更新的核心代码。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/vite/src/client/client.ts</span>

<span class="hljs-comment">// 注入到每个 HTML 的脚本</span>
<span class="hljs-keyword">const</span> hotModule = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>

<span class="hljs-keyword">if</span> (hotModule) {
  hotModule.<span class="hljs-title function_">accept</span>(<span class="hljs-function">(<span class="hljs-params">{ <span class="hljs-keyword">default</span>: newModule }</span>) =&gt;</span> {
    <span class="hljs-comment">// 接收模块更新</span>
    <span class="hljs-comment">// 执行自定义 HMR 逻辑或完整重载</span>
  })
  
  <span class="hljs-comment">// 监听服务器推送</span>
  hotModule.<span class="hljs-title function_">on</span>(<span class="hljs-string">'vite:beforeUpdate'</span>, <span class="hljs-keyword">async</span> (event) =&gt; {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">'js-update'</span>) {
      <span class="hljs-comment">// 动态 import 新版本模块</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(event.<span class="hljs-property">path</span> + <span class="hljs-string">`?t=<span class="hljs-subst">${event.timestamp}</span>`</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 完整页面刷新</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()
    }
  })
}
</code></pre>
<p>因此热更新的流程总结如下：</p>
<pre><code class="hljs language-scss" lang="scss">用户编辑文件保存
    ↓
文件系统监听器检测变化
    ↓
清除 ModuleGraph 缓存
    ↓
WebSocket 通知浏览器
    ↓
浏览器发起新请求（带时间戳）
    ↓
transformMiddleware 拦截
    ↓
loadRawRequest (esbuild 编译 TS/JSX)
    ↓
pluginContainer<span class="hljs-selector-class">.transform</span> (执行插件 Vue/CSS 等)
    ↓
返回最新的 ESM 代码
    ↓
浏览器执行 HMR 回调更新页面
</code></pre>
<h2 data-id="heading-10">结尾</h2>
<p>这就是<code>Vite</code>开发环境的核心机制！按需编译+缓存+HMR推送，相比于<code>Webpack</code>，少了最早的整个bundle的构建，自然而然会快非常多，因为<code>Vite</code>在初始化根本就没有<code>build</code>的过程，甚至连<code>main.ts</code>入口文件都是实时编译的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 “踩坑日记”：shadcn + Vite 在 Monorepo 中配置报错]]></title>    <link>https://juejin.cn/post/7582397035942739974</link>    <guid>https://juejin.cn/post/7582397035942739974</guid>    <pubDate>2025-12-11T12:20:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582397035942739974" data-draft-id="7582406735387836422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀  “踩坑日记”：shadcn + Vite 在 Monorepo 中配置报错"/> <meta itemprop="keywords" content="前端,Vite,React.js"/> <meta itemprop="datePublished" content="2025-12-11T12:20:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀  “踩坑日记”：shadcn + Vite 在 Monorepo 中配置报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T12:20:02.000Z" title="Thu Dec 11 2025 12:20:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    55
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题介绍</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2Fdocs%2Finstallation%2Fvite" target="_blank" title="https://ui.shadcn.com/docs/installation/vite" ref="nofollow noopener noreferrer">ui.shadcn.com/docs/instal…</a></p>
<p>按照这个官方文档配置 <strong>shadcn + vite</strong> 项目后，遇到个错误：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89a0379d56374caaacdc4ceef45f8d7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5aSc5a-75pm05aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766060401&amp;x-signature=lB8%2BS59kjl4XQorEp9JIb7NxrEY%3D" alt="image.png" loading="lazy"/></p>
<p>按照官方文档配置，理应是没有错误的，但是我的项目特殊点就在于是一个 <strong>Monorepo</strong> 项目。</p>
<p>所以，当你在一个 Monorepo 里使用 TypeScript + ESLint（Flat Config，<code>eslint.config.js</code>）时，常会遇到下面这个解析错误：</p>
<pre><code class="hljs language-sh" lang="sh">Parsing error: No tsconfigRootDir was <span class="hljs-built_in">set</span>, and multiple candidate TSConfigRootDirs are present:
  - /Users/.../packages/SearchChat 
  - /Users/.../packages/SearchChatUI
You<span class="hljs-string">'ll need to explicitly set tsconfigRootDir in your parser options.
See: https://typescript-eslint.io/packages/parser/#tsconfigrootdireslint
</span></code></pre>
<hr/>
<h2 data-id="heading-1">项目背景</h2>
<ul>
<li>Monorepo 项目结构示例：</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">/Users/.../ui-common
├── apps/
│   └── react-jsx/
├── packages/
│   ├── ChatMessage/
│   ├── CustomIcons/
│   ├── DatePicker/
│   ├── DropdownList/
│   ├── EntityUI/
│   └── SearchChatUI/
└── pnpm-workspace.yaml
</code></pre>
<ul>
<li>每个包（例如 <code>packages/SearchChatUI</code>）通常都有自己的 <code>tsconfig.json</code>（含 <code>references</code> 到 <code>tsconfig.app.json</code> / <code>tsconfig.node.json</code>）、<code>eslint.config.js</code>、<code>package.json</code>。</li>
<li>ESLint 在启用类型感知规则（或需要类型信息的配置）时，会通过 <code>@typescript-eslint/parser</code> 加载 TypeScript Program，这需要明确告诉它：以哪个目录为根去解析 <code>project</code>（<code>tsconfig*.json</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-2">错误现象</h2>
<ul>
<li>在 Monorepo 根或任一包里运行 <code>eslint</code>，报错显示发现多个候选 <code>TSConfigRootDir</code>。</li>
<li>这是因为解析器试图自动探测 tsconfig 根目录，但同时看到了多个包的 tsconfig，于是拒绝继续。</li>
</ul>
<hr/>
<h2 data-id="heading-3">原因分析</h2>
<ul>
<li>TypeScript-ESLint 的解析器需要一个“根目录”（<code>tsconfigRootDir</code>）来解释你提供的 <code>parserOptions.project</code>（即哪些 <code>tsconfig*.json</code> 参与构建类型信息）。</li>
<li>在 Monorepo 中，如果没有明确为每个包设定独立的 <code>tsconfigRootDir</code> 与对应的 <code>project</code>，解析器会在工作区内“看见”多个包的 tsconfig，从而无法确定到底应该用哪个根，最终报错。</li>
</ul>
<hr/>
<h2 data-id="heading-4">快速修复（针对单个包）</h2>
<p>以 <code>packages/SearchChatUI</code> 为例，给它的 <code>eslint.config.js</code> 增加明确的 <code>parserOptions.tsconfigRootDir</code> 和 <code>parserOptions.project</code> 即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// packages/SearchChatUI/eslint.config.js</span>
<span class="hljs-keyword">import</span> js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>
<span class="hljs-keyword">import</span> globals <span class="hljs-keyword">from</span> <span class="hljs-string">'globals'</span>
<span class="hljs-keyword">import</span> reactHooks <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-react-hooks'</span>
<span class="hljs-keyword">import</span> reactRefresh <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-react-refresh'</span>
<span class="hljs-keyword">import</span> tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>
<span class="hljs-keyword">import</span> { defineConfig, globalIgnores } <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint/config'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>

<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>([
  <span class="hljs-title function_">globalIgnores</span>([<span class="hljs-string">'dist'</span>]),
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.{ts,tsx}'</span>],
    <span class="hljs-attr">extends</span>: [
      js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
      tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
      reactHooks.<span class="hljs-property">configs</span>.<span class="hljs-property">flat</span>.<span class="hljs-property">recommended</span>,
      reactRefresh.<span class="hljs-property">configs</span>.<span class="hljs-property">vite</span>,
    ],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
      <span class="hljs-attr">globals</span>: globals.<span class="hljs-property">browser</span>,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-comment">// 关键设置：指向当前包目录，避免 Monorepo 下的多 tsconfig 混淆</span>
        <span class="hljs-attr">tsconfigRootDir</span>: __dirname,
        <span class="hljs-comment">// 指定当前包使用的 tsconfig 列表（路径相对于 tsconfigRootDir）</span>
        <span class="hljs-attr">project</span>: [
          <span class="hljs-string">'./tsconfig.json'</span>,
          <span class="hljs-string">'./tsconfig.app.json'</span>,
          <span class="hljs-string">'./tsconfig.node.json'</span>,
        ],
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      },
    },
  },
])
</code></pre>
<p><strong>验证：</strong></p>
<ul>
<li>进入包目录运行 <code>npm run lint</code>（保证命令在包内执行）</li>
<li>预期不再出现 Parsing error</li>
</ul>
<hr/>
<h2 data-id="heading-5">在 Monorepo 根统一配置的做法（推荐）</h2>
<p>如果你倾向于在根目录放一个统一的 <code>eslint.config.js</code>，可以使用 <strong>“按包 override”</strong> 的方式，让每个包都明确自己的 <code>tsconfigRootDir</code> 和 <code>project</code>。</p>
<p>示例（伪代码，按需调整包路径）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js at workspace root</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint/config'</span>
<span class="hljs-keyword">import</span> globals <span class="hljs-keyword">from</span> <span class="hljs-string">'globals'</span>
<span class="hljs-keyword">import</span> tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>
<span class="hljs-keyword">import</span> js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>

<span class="hljs-keyword">const</span> rootDir = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pkg</span> = (<span class="hljs-params">dir</span>) =&gt; path.<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">'packages'</span>, dir)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>([
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'packages/SearchChatUI/**/*.{ts,tsx}'</span>],
    <span class="hljs-attr">extends</span>: [js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>, tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
      <span class="hljs-attr">globals</span>: globals.<span class="hljs-property">browser</span>,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">tsconfigRootDir</span>: <span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChatUI'</span>),
        <span class="hljs-attr">project</span>: [
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChatUI'</span>), <span class="hljs-string">'tsconfig.json'</span>),
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChatUI'</span>), <span class="hljs-string">'tsconfig.app.json'</span>),
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChatUI'</span>), <span class="hljs-string">'tsconfig.node.json'</span>),
        ],
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      },
    },
  },
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'packages/SearchChat/**/*.{ts,tsx}'</span>],
    <span class="hljs-attr">extends</span>: [js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>, tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
      <span class="hljs-attr">globals</span>: globals.<span class="hljs-property">browser</span>,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">tsconfigRootDir</span>: <span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChat'</span>),
        <span class="hljs-attr">project</span>: [
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChat'</span>), <span class="hljs-string">'tsconfig.json'</span>),
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChat'</span>), <span class="hljs-string">'tsconfig.app.json'</span>),
          path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">pkg</span>(<span class="hljs-string">'SearchChat'</span>), <span class="hljs-string">'tsconfig.node.json'</span>),
        ],
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      },
    },
  },
  <span class="hljs-comment">// 为其他包继续添加 overrides...</span>
])
</code></pre>
<p><strong>要点：</strong></p>
<ul>
<li>每个包的 override 都拥有自己的 <code>tsconfigRootDir</code>。</li>
<li><code>project</code> 数组中的路径要基于该包目录。</li>
<li>保持按包运行 <code>eslint .</code>（或通过 workspace 脚本定位到包）能减少路径解析混乱。</li>
</ul>
<hr/>
<h2 data-id="heading-6">常见坑位与提示</h2>
<ul>
<li><code>project</code> 路径必须相对于 <code>tsconfigRootDir</code>，不要写相对于工作区根的路径。</li>
<li>若你使用的是 TypeScript-ESLint 的“类型感知”配置（例如 <code>tseslint.configs.recommendedTypeChecked</code> 或启用了需要类型信息的规则），一定要提供 <code>tsconfigRootDir</code> 与 <code>project</code>。</li>
<li>如果你不需要类型感知规则（为了更快的性能），可以只用非 type-checked 的推荐集，省略 <code>project</code>（但要权衡规则能力）：
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">extends</span>: [tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>] <span class="hljs-comment">// 非类型感知</span>
<span class="hljs-comment">// 不设置 parserOptions.project</span>
</code></pre>
</li>
<li>在包内运行 <code>npm run lint</code>（<code>eslint .</code>）比在根随意运行更可控。</li>
<li>ESM 环境下，要用 <code>fileURLToPath(import.meta.url)</code> 获取当前文件路径来计算 <code>__dirname</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">验证步骤</h2>
<ol>
<li>在目标包目录执行：
<ul>
<li><code>npm run lint</code></li>
</ul>
</li>
<li>确认不再出现 “No tsconfigRootDir was set … multiple candidate TSConfigRootDirs …” 的错误。</li>
<li>如果还有包报同样错误，逐个为它们的配置添加 <code>tsconfigRootDir</code> 和 <code>project</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-8">性能与类型感知</h2>
<ul>
<li>类型感知规则需要构建 TypeScript Program，解析器会加载并分析 <code>project</code> 指定的 tsconfig；在大 Monorepo 中这可能较慢。</li>
<li>推荐做法：
<ul>
<li>只有在确实需要类型规则的包上开启 <code>project</code>。</li>
<li>使用按包 override 控制范围。</li>
<li>结合 CI 分层执行（先非类型感知快速检查，再在关键包跑类型感知规则）。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">小结</h2>
<p>这个报错本质是 Monorepo 环境下 “类型规则需要明确上下文” 的提醒。只要为每个包设定清晰的 <code>tsconfigRootDir</code> 与 <code>project</code>，ESLint 就能准确地获取类型信息并稳定工作。按包划分 override 是根级统一配置的好方式；而在包内独立配置则更为直觉。</p>
<hr/>
<h2 data-id="heading-10">参考链接</h2>
<ul>
<li>TypeScript-ESLint Parser 文档（<code>tsconfigRootDir</code>）：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Ftypescript-eslint.io%2Fpackages%2Fparser%2F%23tsconfigrootdireslint" target="_blank" title="https://typescript-eslint.io/packages/parser/#tsconfigrootdireslint" ref="nofollow noopener noreferrer">typescript-eslint.io/packages/pa…</a></li>
<li>TypeScript-ESLint 配置指南（Flat Config）<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Ftypescript-eslint.io%2Fgetting-started%2Ftyped-linting%23flat-config" target="_blank" title="https://typescript-eslint.io/getting-started/typed-linting#flat-config" ref="nofollow noopener noreferrer">typescript-eslint.io/getting-sta…</a></li>
<li>ESLint Flat Config 官方文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fdocs%2Flatest%2Fuse%2Fconfigure%2Fconfiguration-files-new" target="_blank" title="https://eslint.org/docs/latest/use/configure/configuration-files-new" ref="nofollow noopener noreferrer">eslint.org/docs/latest…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀用 TRAE SOLO 一天不到就把老项目重构完是什么体验？]]></title>    <link>https://juejin.cn/post/7582200865907982370</link>    <guid>https://juejin.cn/post/7582200865907982370</guid>    <pubDate>2025-12-11T07:11:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582200865907982370" data-draft-id="7582232741686591523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀用 TRAE SOLO 一天不到就把老项目重构完是什么体验？"/> <meta itemprop="keywords" content="AI编程,Trae,AIGC"/> <meta itemprop="datePublished" content="2025-12-11T07:11:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coder_pig"/> <meta itemprop="url" content="https://juejin.cn/user/4142615541321928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀用 TRAE SOLO 一天不到就把老项目重构完是什么体验？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615541321928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coder_pig
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T07:11:28.000Z" title="Thu Dec 11 2025 07:11:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 引言</h2>
<p>四年前，百无聊赖之余，一时兴起，花了差不多一周，用 <strong>Python</strong> 写了个 "🐭 <strong>尾汁Markdown转换工具</strong>" → <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoder-pig%2Fhzwz-markdown-wx" target="_blank" title="https://github.com/coder-pig/hzwz-markdown-wx" ref="nofollow noopener noreferrer">coder-pig/hzwz-markdown-wx</a>，用于：<strong>将Markdown文件转换成带样式的微信公众号文章HTML</strong>。</p>
<p>简单点说就是 "<strong>Markdown → 公众号</strong>" 的 <strong>排版工具</strong>，还顺手写了几篇介绍实现过程的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/6899426534239682568" target="_blank" title="https://juejin.cn/post/6899426534239682568">《🐭喂汁，用Python写个专属Markdown转换工具》</a></li>
<li><a href="https://juejin.cn/post/6907550626197012487" target="_blank" title="https://juejin.cn/post/6907550626197012487">《🤡公号文章排版利器 | 🐁尾汁Markdown转换工具来咯~》</a></li>
<li><a href="https://juejin.cn/post/6941338759824670750" target="_blank" title="https://juejin.cn/post/6941338759824670750">《开发🐁尾汁Markdown转换工具 | 项目复盘》</a></li>
</ul>
<p>😆 当时自己整理的排版规范：</p>
<pre><code class="hljs language-text" lang="text"># 字号：正文(14、15)，注释-标注来源-超链接-代码(12)
# 字间距：(1、1.5)
# 行间距：(1.5、1.75、2)
# 页边距：即双端缩进、两端对齐，页面左右留白，建议缩进尺寸为1.0

# 字体颜色：标题 #000000；正文 #4C4C4C；标注 #888888；其他 #B2B2B2
# 正文也可以尝试：#545454；#3f3f3f；#7f7f7f；#2f2f2f
# 备注性文字：#a5a5a5

# Tips：除去字体颜色，公号排版颜色不宜超过三种，颜色一旦多起来，风格就很难定，2-3种尤佳；
# 比如我的三种颜色：蕾姆蓝#5A78EA；拉姆粉#FF4081；艾米莉亚：#C65BDA

# 符号系统：建立自己的符号系统，用作内容分割，比如用//////////作为正文大段落的分隔，- 作为段落小结的分隔，有时还可以使用一些表情符号来增加趣味性：http://cn.piliapp.com/symbol/

# 不管怎么排，要有自己固定的设置，如：段落和图片间空2行、图片大小控制在一屏版面的1/3面积内、一个段落不超过3行字、每当一屏版面文字太满时，拆解段落做分段或做一些highlight制造空间感等。

# 总而言之，尽量利用 简单的基础设置 去优化阅读体验，让整体排版看起来简洁但有序、不密集、不沉重、不压抑。

# 采用固定格式的公号封面图!!! 
# 固定版式形成强烈的个人特色，制作新的封面图只需置换文字和图片，好看又方便。
</code></pre>
<p>🤡 有在用，但用起来比较麻烦，每次排版都得：</p>
<p>打开PyCharm → 复制要排版的md文件 → 运行脚本 → 生成带样式的HTML文件 → 打开文件复制粘贴 → 浏览器打开公众号文章编辑页面 → F12定位到文章输入区域的代码 → 修改结点 → 粘贴代码 → 保存</p>
<p>😄 今年六月，看 <strong>首月3刀</strong> 开的 <strong>Trae</strong> 还剩挺多额度，于是花了半个小时，<strong>Vibe</strong> 了一个 <strong>排版静态页面，</strong> 并且用 <strong>掘金MCP</strong> 进行发布 → <a href="https://aicoding.juejin.cn/pens/7513888326441828402" target="_blank" title="https://aicoding.juejin.cn/pens/7513888326441828402">「掘掘子Markdown微信公众号排版工具」</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c8d370a831404b96eba0fda8c9d491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=QZnWbWTsbhCR%2F8%2Ffue4cxVlq57I%3D" alt="" loading="lazy"/></p>
<p>具体 Vibe 过程可以看 → <a href="https://juejin.cn/post/7514260735938248719" target="_blank" title="https://juejin.cn/post/7514260735938248719">【Trae + 掘金MCP】不写代码，靠嘴遁花0.5h定制公号排版工具</a></p>
<p>🤔 短文章还好，<strong>长文章样式全乱套</strong> (比如：无序列表加粗文本，会显示成 <strong>xx</strong>)，换了好几个模型，<strong>Vibe</strong> 了N次都没改好，问题越搞越多，前端这块，我又不是很熟，无奈放弃🤷‍♀️。后面还是用回了「<strong>Doocs</strong>」：</p>
<ul>
<li><strong>开源Github仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdoocs%2Fmd" target="_blank" title="https://github.com/doocs/md" ref="nofollow noopener noreferrer">doocs/md</a></li>
<li><strong>在线编辑器地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmd.doocs.org%2F" target="_blank" title="https://md.doocs.org/" ref="nofollow noopener noreferrer">doocs</a></li>
</ul>
<p>😳 能用，但是有点过于 <strong>简洁</strong> (显得平平无奇)，我更怀念以前 <strong>自己编排的UI样式</strong> ...</p>
<p>前阵子 <strong>Google</strong> 发布了千呼万唤的 "<strong>哈基米3</strong> (<strong>Geimni</strong>)"，国内 <strong>自媒体</strong> 都是在吹它的 "<strong>前端能力</strong>" (看效果图确实挺6)：</p>
<ul>
<li><strong>能生成精确的 SVG 矢量图</strong>：包括复杂的动画 SVG (如：旋转风扇动画)，而非简单栅格图。</li>
<li><strong>3D 和动画</strong>：支持生成 Three.js 3D 模型、WebGL 着色器、CSS 动画等高级视觉效果。</li>
<li><strong>完成应用框架</strong>：能理解复杂的技术栈要求 (React、Three.js Fiber、TypeScript 等)，生成模块化、结构清晰的代码。</li>
<li><strong>标注修改</strong>：用户可以在生成的界面上用 "标注" 的方式指出要修改的地方 (画圈、画箭头、添加文字)，Gemini 3 会理解这些视觉标注并精确修改代码。这得益于它 多模态理解能力的显著提升 (对屏幕截图的理解准确率达到 72.7%，达到现有水平的两倍)。</li>
<li><strong>去 "AI味"</strong> ：排版、色彩搭配、组件结构看起来是 "精心设计" 的，而非生硬地套模版。</li>
</ul>
<p>😄 虽说，还同时发布了首个<strong>AI IDE</strong>—— <strong>Antigravity</strong> (反重力)，但 "<strong>登录问题</strong>" 就拦住了一堆人，然后各种 <strong>BUG</strong>，+ <strong>存在数据泄露风险</strong>，所以当时并没深度体验 <strong>Gemini 3</strong> 的编程能力到底是不是真的那么强 🤷‍♀️。</p>
<p>😏 然后，前阵子 "<strong>量大管饱</strong>" 的 <strong>Trae</strong> 发布公告："<strong>因服务中断，停止提供 Claude 模型的访问</strong>"，巧了，刚好换上 <strong>Gemini 3</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cdb879526b8462db92b5eb4b4f9cdda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=%2FyAqu5deeKTD7xeeMxBPxhcrARg%3D" alt="" loading="lazy"/></p>
<p>看更新日志，<strong>v3.0.0</strong> 这个大版本的新东西还挺多：</p>
<ul>
<li>「<strong>SOLO 模式正式上线，面向所有用户开放</strong>」主打单人高效率开发工作流，让用户能在一个界面处理任务、代码、智能体协作。</li>
<li>「<strong>内置两类智能体能力升级</strong>」<strong>SOLO Coder</strong> - 专精复杂工程任务：重构、调试、多文件跨模块修改，具备持续上下文理解能力，更适合中大型项目。<strong>SOLO Builder</strong> - 为快速构建产品原型而设计：界面、应用、后端都能快速产出初版，支持从 0→1 的自动化 Scaffold (脚手架) 与逻辑生成。</li>
<li>引入「<strong>多任务系统</strong>」<strong>并行</strong>-可在同一智能体中同时处理多个任务线程、<strong>拆解</strong>-AI 自动识别复杂任务并拆分子任务、<strong>折叠/展开</strong>-更清晰的项目管理结构、<strong>自动生成摘要</strong>-聊天/操作历史自动压缩成可读摘要，便于快速回顾。</li>
<li>「<strong>Diff View</strong>」集中展示所有由 AI 或用户生成的代码变更，支持跨文件比较与版本回溯，AI 改动更透明。</li>
</ul>
<p>😆 行吧，本节就尝试下用 <strong>TRAE SOLO + Gemini 3</strong> 让这个旧项目重新焕发光彩吧✨~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4e619834c24f01a011db06a3922ac8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=7Za8Y36WwCF8sbMqDgsDwn6725c%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>💡 因为是重构旧项目，所以选的 <strong>SOLO Coder</strong></p>
</blockquote>
<h2 data-id="heading-1">2. 实践过程</h2>
<p><strong>原始需求</strong></p>
<p>我想重构这个项目，改造成可以部署到服务器上的在线产品，类似于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmd.doocs.org%2F" target="_blank" title="https://md.doocs.org/" ref="nofollow noopener noreferrer">md.doocs.org/</a></p>
<p>这只是个 "<strong>方向</strong>"，还不是 "<strong>可执行需求</strong>"，通过下述 <strong>Prompt</strong> 让 <strong>Trae</strong> 引导我们进行 "<strong>需求澄清</strong>"：</p>
<pre><code class="hljs language-md" lang="md">请你先不要写代码，先扮演有经验的产品经理 + 架构师，帮助我把需求讲清楚，输出一份简要需求说明。具体请按下面步骤来做：

1）先用你自己的话复述一下我现在的目标，看你是否理解准确；

2）从目标用户、核心功能（MVP）、非功能需求（性能、部署方式）、技术栈偏好等维度，列出你需要向我确认的关键问题；

3）按“必须先回答 / 之后再说”做优先级排序，每个问题尽量简洁；

4）最后把这些问题整理成一个列表，方便我逐条回答。

注意：这一轮只做需求澄清，不要设计接口、不写代码也不要给文件结构，只输出复述 + 问题列表。
</code></pre>
<p><strong>Trae</strong> 的输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d43092064e394487b0e74670c1646a59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=onfeWbbVqBuK7xAIg0JVx1tKhgo%3D" alt="" loading="lazy"/></p>
<p>😳 卧槽，很多点都说到我的 "❤️<strong>趴</strong>" 上了，基于它给出的 "<strong>回答列表</strong>" 进行 "<strong>完形填空</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a6a5ba5a9c94d6a91dc7efbd4b0f1e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=iz%2FAdmIL3ekN6t1Y60OTJQd9fdY%3D" alt="" loading="lazy"/></p>
<p>发送等Trae思考完，给我生成了一份 "<strong>重构计划</strong>" 的文档 (💡记得开启右上角的 <strong>Plan</strong> 选项)：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9ad6522d2af43a693deb59f44897b33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=teAcuUOqskkEmk62ulw5tK4kvXo%3D" alt="" loading="lazy"/></p>
<p>👍 文档写得 "<strong>头头是道</strong>"，三大块：<strong>架构设计</strong>、<strong>实施步骤</strong> 和 <strong>目录结构规划</strong> 都写得很清晰：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0d16b436944a468143cdf9222b3e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=0Mt3qQIZKp%2FX6qxDt4Q966oWMTI%3D" alt="" loading="lazy"/></p>
<p>按需进行修改，确定无误后，点解 "<strong>执行</strong>"，然后 <strong>Trae</strong> 会拆解成多个小任务 (Todo-List)，逐一完成：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/442e392308cb48b791a25e41895fa6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=T3bPg4Ye0vN6U01KrjaN6Hgx03k%3D" alt="" loading="lazy"/></p>
<p>对于 "<strong>高风险命令</strong>" (比如这里的 <strong>move</strong>)，会停止往下执行，等待用户 <strong>审核确认</strong>。😮 Wow Human in Loop～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898115478d624d8bb17980f16bda710f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=hpFAczmG5Jv3E2ImwCbOGuw7P%2B4%3D" alt="" loading="lazy"/></p>
<p>😄 接着最小化让 <strong>Trae</strong> 在后台干活，需要 <strong>人工介入</strong> 的节点，右下角会有弹窗提示。没过多久，Trae 就跟我说它完成了！不是，这么快的吗？？？让它给我把项目跑起来，然后这 "<strong>前端页面</strong>" 还整得挺像模像样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/636d5201be224906882e32985ebc3b20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=gyii12LLrMzSTyPZ5dlSD%2By1UPg%3D" alt="" loading="lazy"/></p>
<p>🤣 后面发现，其实就搭了个 <strong>基本骨架</strong>，很多东西没做，接着就是 "<strong>验收 + Vibe提问题</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fc9c9d2ac7f49beb5b237ca3073b6f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=nTH%2BPIKzO9X3F4H2vZR76uiZd1k%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cdf406f8503405594075d94509b61f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=6x7AWIXKWOY5CIScnKtkA0UOwBM%3D" alt="" loading="lazy"/></p>
<p>继续 <strong>Vibe</strong>，发现图片加载不出来，😄 这种大概率是 "<strong>图片防盗链</strong>"，一般是检查 <strong>请求头</strong> 中的 <strong>Referer</strong>，如果是 <strong>第三方域名</strong>，就会返回 <strong>403</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd8bc414313c46e8ad5e42d03622db5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=%2BrQddYBR4FyhfArPmlbfgYqlp1I%3D" alt="" loading="lazy"/></p>
<p>因为明确指出了 "<strong>病因</strong>"，Trae 两下就改好了，并详细讲述了 <strong>修复方案</strong> &amp; <strong>验证方法</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68aa8bf4071e487a823ae64419a08112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=3eoC1e3GQcsml2d%2BLMJuJolZ9CI%3D" alt="" loading="lazy"/></p>
<p>👍 不得不说 <strong>Diff View</strong> 确实直观啊，😆 比 <strong>Cursor</strong> 容易看多了~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c212e724f8d645478b495257a8e07c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=peR0fHs%2Fae%2Fw%2FjomFKv7HrH4G5Q%3D" alt="" loading="lazy"/></p>
<p>刷新下页面，果然可以了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d5f44ba02c4da9955effd7950745ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=Qwvh5r2odVm%2FCIULfttnD2SMlKs%3D" alt="" loading="lazy"/></p>
<p>继续 <strong>Vibe</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d70665c0f2d340b893cdd3531bed5b16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=VORJDOa%2F5oAagn17cPbFPf8NQyk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19581a2222b44b6fb41d220c90ac4a17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=OecmsGd%2FFSbJzDKMdKtnuHcEzFY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f17a3fbc8b4693bb7946ea59f8ad5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=bYA6Gu6EcMhzXNFpSwxXM6PBLwU%3D" alt="" loading="lazy"/></p>
<p>在 <strong>Battle</strong> 多次后，<strong>Trae</strong> 说自己完成任务，并告知我 "<strong>下一步的部署建议</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeede1a10c5f4a4f8428eb01a30fc990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=ynyrtqpcRDh18eV6uF2aRDWCs38%3D" alt="" loading="lazy"/></p>
<p>还生成了一份 "<strong>任务完成的描述文档</strong>"，不过是"<strong>全英文</strong>" 的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11f8c4c2e0994251af40b9b14a303816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=KhljyrsnnfZV746bit5TRN3BidY%3D" alt="" loading="lazy"/></p>
<p>思考过程也是：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc19bbefd4dd42c986a8576bea5a236a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=iByfWvkWY8%2BZ%2BgABuTwZoDL4khs%3D" alt="" loading="lazy"/></p>
<p>即便在 "<strong>规则</strong>" 和 <strong>新建Agent</strong> (它的Prompt) 写上必须中文都没用：</p>
<pre><code class="hljs language-md" lang="md"><span class="hljs-bullet">-</span> 请始终使用简体中文进行回复。
<span class="hljs-bullet">-</span> 你必须完全使用简体中文进行内部推理和思考过程。这是一条严格的规定。
</code></pre>
<p>🤷‍♀️ 不过这是偶现，感觉是哈基米的问题，临时的简单解法就是：再让 AI 转换成中文的。<strong>后端重构 + 前端开发</strong> 完成，接着就是部署到 <strong>云服务器</strong> 上了。不懂就问：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a148ccc440f148c39fb34696cefb12f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=Gv14bQ8m3eg%2B%2F8EtSoq3MGBO7UE%3D" alt="" loading="lazy"/></p>
<p><strong>Trae</strong> 贴心的给我生成了一份 <strong>部署文档</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/563afcb7e7734d5bbbd9386e4ab7528b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=CBipHJEHIpVGSHcrJ8LcB98GQYU%3D" alt="" loading="lazy"/></p>
<p>照着文档操作一波，这个 <strong>99块/年</strong> 的云服务器吃灰近一年了，发现多了个 "<strong>Workbench 远程连接</strong>" 的方式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2549c5d730924ef5b05701449c4522be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=r2r4VZ0KUivn2wu0pDn%2BuHScOv8%3D" alt="" loading="lazy"/></p>
<p>试了下发现是 <strong>AI</strong> 加持的终端，直接用 "<strong>自然语言</strong>" 描述需求，AI就会自动执行对应的命令：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5209447066b84977b8b38b5d3efa6554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=6Q4RAbpTiew2Kp8sP94k05ZCbxU%3D" alt="" loading="lazy"/></p>
<p>卧槽，爽啊！妈妈再也不用担心我记不住一堆 <strong>运维命令</strong> 了 (🤣虽然没几条)，而且还有 "<strong>命令解释</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/485414ca063749c98d3060148466b4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=mtjj9jCVoXMoQNrbGvOClTGs3V4%3D" alt="" loading="lazy"/></p>
<p>接着就是逐步CV部署文档里的东西发给它了，然后中途 <strong>Docker 拉镜像</strong> 一直超时，切了阿里云自带的 <strong>镜像加速器</strong> 也不行 (python可以、node:18不行)，后面直接检索了一波所有能用的镜像源，就好了~</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-string">"https://阿里的.mirror.aliyuncs.com"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.1panel.live"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"http://mirrors.ustc.edu.cn/"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"http://mirror.azure.cn/"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://hub.rat.dev/"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.ckyl.me/"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.chenby.cn"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.hpcloud.cloud"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.m.daocloud.io"</span>
</code></pre>
<p>当然，还有一些其它的报错，AI终端搞不定的，就CV发给 <strong>Trae</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57acd8901d784382b67f4bbbae0c6c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=nqzuaCIlimbntru%2Bw6LV0D5L%2FcA%3D" alt="" loading="lazy"/></p>
<p><strong>Docker Compose</strong> 成功构建并启动了容器服务：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f7178ec7709469f8a589b93ce192cb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=tnoPMu81c6UlSlDE4zIwem1AlJs%3D" alt="" loading="lazy"/></p>
<p><strong>curl <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8000" target="_blank" title="http://127.0.0.1:8000" ref="nofollow noopener noreferrer">http://127.0.0.1:8000</a></strong> 测试下服务是否正常运行：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83f5ae236c1544c9960aa9694988ef00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=WJHfc7zCSYb2%2FPWHgf4rc33WM5k%3D" alt="" loading="lazy"/></p>
<p>外部浏览器通过 <strong>公网IP</strong> 访问，报错 <strong>ERR_EMPTY_RESPONSE</strong>，直接问 <strong>AI</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5acf5048cabb4b85b51dae1609dd1adf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=DtSa3A8DHs8Ec8zfJiQDQpmhdI0%3D" alt="" loading="lazy"/></p>
<p>无脑 <strong>Ctrl</strong> <strong>↩</strong>︎ 让它验证就好了，最后发现是 "<strong>云服务商的安全组没开端口</strong>"，还耐心给出了解决步骤，我哭死：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/023cb1528a08494a919de7c1a35f2625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=brwnG1anCFj%2Fn9o7DUAmsy0uaCI%3D" alt="" loading="lazy"/></p>
<p>配置完，再次刷新页面，好了👏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/189f43d1346f44399656c5319cb1eb58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766041888&amp;x-signature=SrvFbmArGvU%2FbDP83MelZyAef2o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 小结</h2>
<p>🤡 爽！太爽了！本来想着 "<strong>后端重构 + 前端开发 + 部署</strong>"，至少得折腾个一星期吧，结果：</p>
<ul>
<li>【 <strong>TRAE SOLO</strong>】应该是内置了 <strong>产品开发流水线</strong> 相关的 <strong>完整工作流</strong>，🤣 2333，我精心准备的 "<strong>全栈开发落地方方论</strong>" 还没开始实施，它就把前面这两项干完了。</li>
<li>配合【<strong>云服务商提供的AI终端</strong>】，部署起来也是轻轻松松。换以前，得记一堆 <strong>运维命令</strong> (不同OS的命令和配置还可能不同)，经常陷在 <strong>报错 → 搜索 → 修改 → 验证 → 再报错</strong>... 的反复循环中怀疑人生。</li>
</ul>
<p>🤷‍♀️ 不得不感叹，AI 发展之迅猛啊~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae Solo模式实战：我用3小时撸了个儿童睡前故事网页]]></title>    <link>https://juejin.cn/post/7582311711429935147</link>    <guid>https://juejin.cn/post/7582311711429935147</guid>    <pubDate>2025-12-11T08:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582311711429935147" data-draft-id="7582393212767207478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae Solo模式实战：我用3小时撸了个儿童睡前故事网页"/> <meta itemprop="keywords" content="前端,JavaScript,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T08:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="装睡鹿先生"/> <meta itemprop="url" content="https://juejin.cn/user/1117561743761582"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae Solo模式实战：我用3小时撸了个儿童睡前故事网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561743761582/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    装睡鹿先生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T08:53:34.000Z" title="Thu Dec 11 2025 08:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    54
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为Trae体验官，最近深度沉浸在其Solo模式的开发体验中——这种无需配置环境、开箱即用的轻量化开发方式，简直是独立开发者的福音。上周帮邻居家宝妈解决"哄睡故事荒"的问题时，突发奇想：不如用Trae Solo模式快速开发一个儿童睡前故事展示网页？没想到从构思到上线仅用3小时，成品还意外收获了宝妈们的一致好评。今天就把这次实战过程分享给大家，适合前端新手参考学习。</p>
<p>~~过程的艰辛就不说了，直接开始吧！！！！！！
~~</p>
<h2 data-id="heading-0">开发背景：为什么要做这个网页？</h2>
<p>邻居家3岁的小朋友每天睡前都要听故事，但手机里的故事APP要么广告太多，要么故事长度不适合睡前场景（有的太长孩子听到一半就困了，有的太短又达不到哄睡效果）。作为技术人，第一反应就是"自己做一个更合适的"。</p>
<p>核心需求很明确：<strong>无广告、故事长度控制在10-15分钟、视觉温馨、操作简单</strong>（毕竟是给家长和低龄儿童用的）。结合Trae的Solo模式特性——支持实时预览、内置常用前端模板、自动处理依赖管理，正好匹配这种快速开发场景，于是立刻开工。</p>
<h2 data-id="heading-1">技术选型：Solo模式下的轻量组合</h2>
<p>Trae Solo模式支持多种技术栈的快速初始化，考虑到项目的轻量化需求和开发效率，最终选择了最简洁的组合：</p>
<ul>
<li><strong>结构层</strong>：HTML5 语义化标签，提升可读性和SEO友好性</li>
<li><strong>样式层</strong>：Tailwind CSS（Trae内置模板直接调用，无需额外配置），快速实现温馨童趣的视觉风格</li>
<li><strong>交互层</strong>：原生JavaScript，实现故事切换、字体调整、夜间模式等核心交互</li>
<li><strong>资源库</strong>：选用开源的儿童插画API和无版权背景音乐，避免侵权问题</li>
</ul>
<p>Trae Solo模式的优势在这里体现得淋漓尽致：选择"HTML+Tailwind"模板后，自动加载基础依赖，左侧写代码右侧实时预览，修改样式时甚至能通过内置的Tailwind提示快速补全类名，比本地配置环境节省了至少1小时。</p>
<h2 data-id="heading-2">核心功能实现：从需求到代码的落地</h2>
<p>先放个核心功能清单，再逐个拆解实现思路（关键代码已附上，可直接复制复用）：</p>
<ol>
<li>故事卡片展示（按主题分类：动物故事、奇幻冒险、亲情友情）</li>
<li>故事详情页（支持字体大小调整、进度记忆）</li>
<li>夜间模式切换（保护孩子视力）</li>
<li>背景音乐可控播放（舒缓的摇篮曲，可暂停/切换）</li>
</ol>
<h3 data-id="heading-3">1. 页面布局：用Tailwind快速搭出童趣风格</h3>
<p>儿童网页的视觉核心是"柔和+鲜明"，避免高饱和色刺激孩子眼睛。用Tailwind的自定义颜色功能定义了3个主色调：淡粉色（#FFE6F2）、薄荷绿（#E6FFFA）、鹅黄色（#FFFBE7），分别对应不同主题的故事卡片。</p>
<p>关键布局代码（故事列表页）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 顶部导航栏（带夜间模式切换） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-white shadow-sm fixed top-0 w-full z-10 transition-colors duration-300"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navbar"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container mx-auto px-4 py-3 flex justify-between items-center"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-2xl font-bold text-pink-500"</span>&gt;</span>晚安小故事<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nightModeBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-2 rounded-full hover:bg-gray-100"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-6 w-6 text-yellow-400"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"2"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 故事分类标签 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container mx-auto px-4 pt-20 pb-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex flex-wrap gap-2 mb-6"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"categoryTabs"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"category-btn bg-pink-100 text-pink-600 px-4 py-2 rounded-full text-sm font-medium active"</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"all"</span>&gt;</span>全部故事<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"category-btn bg-green-100 text-green-600 px-4 py-2 rounded-full text-sm font-medium"</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"animal"</span>&gt;</span>动物故事<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"category-btn bg-yellow-100 text-yellow-600 px-4 py-2 rounded-full text-sm font-medium"</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"fantasy"</span>&gt;</span>奇幻冒险<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"category-btn bg-blue-100 text-blue-600 px-4 py-2 rounded-full text-sm font-medium"</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"family"</span>&gt;</span>亲情友情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 故事卡片容器 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"storyContainer"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 故事卡片示例（动态渲染） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"story-card bg-white rounded-xl shadow-md overflow-hidden transition-transform hover:scale-105"</span> <span class="hljs-attr">data-id</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"animal"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/id/237/600/400"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"小熊的蜂蜜罐"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full h-48 object-cover"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"font-bold text-lg mb-2 text-gray-800"</span>&gt;</span>小熊的蜂蜜罐<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-600 text-sm mb-3"</span>&gt;</span>时长：12分钟 | 主题：分享与友谊<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-500 text-sm line-clamp-2"</span>&gt;</span>森林里的小熊有一个装满蜂蜜的罐子，他从来不肯和别人分享，直到有一天暴雨冲毁了他的家...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mt-4 w-full bg-pink-500 text-white py-2 rounded-lg text-sm read-btn"</span> <span class="hljs-attr">data-id</span>=<span class="hljs-string">"1"</span>&gt;</span>开始阅读<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 更多卡片通过JS动态生成 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>这里有个小技巧：用Trae的"代码片段保存"功能，把常用的卡片布局、按钮样式保存起来，后续开发类似页面时直接调用，效率翻倍。</p>
<h3 data-id="heading-4">2. 核心交互：3个提升体验的关键逻辑</h3>
<p>作为面向家长和孩子的产品，交互必须简单直观。我重点实现了3个核心逻辑，都用原生JS完成，避免引入多余框架增加负担。</p>
<h4 data-id="heading-5">（1）故事分类与筛选</h4>
<p>给每个故事卡片添加<code>data-category</code>属性，点击分类标签时筛选对应卡片，用类名切换实现选中状态高亮：</p>
<pre><code class="hljs language-ini" lang="ini">// 分类筛选逻辑
const <span class="hljs-attr">categoryBtns</span> = document.querySelectorAll(<span class="hljs-string">'.category-btn'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">storyCards</span> = document.querySelectorAll(<span class="hljs-string">'.story-card'</span>)<span class="hljs-comment">;</span>

categoryBtns.forEach(<span class="hljs-attr">btn</span> =&gt; {
  btn.addEventListener('click', () =&gt; {
    // 切换按钮选中状态
    categoryBtns.forEach(<span class="hljs-attr">b</span> =&gt; b.classList.remove(<span class="hljs-string">'active'</span>, <span class="hljs-string">'bg-pink-500'</span>, <span class="hljs-string">'text-white'</span>))<span class="hljs-comment">;</span>
    btn.classList.add('active', 'bg-pink-500', 'text-white')<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">category</span> = btn.dataset.category<span class="hljs-comment">;</span>
    // 筛选卡片
    storyCards.forEach(<span class="hljs-attr">card</span> =&gt; {
      if (<span class="hljs-attr">category</span> === <span class="hljs-string">'all'</span> || card.dataset.category === category) {
        <span class="hljs-attr">card.style.display</span> = <span class="hljs-string">'block'</span><span class="hljs-comment">;</span>
      } else {
        <span class="hljs-attr">card.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-6">（2）夜间模式与字体调整</h4>
<p>考虑到睡前使用场景，夜间模式是刚需。通过修改根元素类名切换样式，同时支持3种字体大小调整，满足不同年龄段孩子的阅读需求：</p>
<pre><code class="hljs language-ini" lang="ini">// 夜间模式切换
const <span class="hljs-attr">nightModeBtn</span> = document.getElementById(<span class="hljs-string">'nightModeBtn'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">html</span> = document.documentElement<span class="hljs-comment">;</span>
const <span class="hljs-attr">navbar</span> = document.getElementById(<span class="hljs-string">'navbar'</span>)<span class="hljs-comment">;</span>

nightModeBtn.addEventListener('click', () =&gt; {
  html.classList.toggle('dark')<span class="hljs-comment">;</span>
  navbar.classList.toggle('bg-white')<span class="hljs-comment">;</span>
  navbar.classList.toggle('bg-gray-900')<span class="hljs-comment">;</span>
  
  // 切换图标
  const <span class="hljs-attr">svg</span> = nightModeBtn.querySelector(<span class="hljs-string">'svg'</span>)<span class="hljs-comment">;</span>
  if (html.classList.contains('dark')) {
    <span class="hljs-attr">svg.innerHTML</span> = <span class="hljs-string">'&lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /&gt;'</span><span class="hljs-comment">;</span>
    svg.classList.remove('text-yellow-400')<span class="hljs-comment">;</span>
    svg.classList.add('text-blue-300')<span class="hljs-comment">;</span>
  } else {
    <span class="hljs-attr">svg.innerHTML</span> = <span class="hljs-string">'&lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /&gt;'</span><span class="hljs-comment">;</span>
    svg.classList.remove('text-blue-300')<span class="hljs-comment">;</span>
    svg.classList.add('text-yellow-400')<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>

// 字体大小调整（详情页逻辑）
function initFontSizeControl() {
  const <span class="hljs-attr">sizeBtns</span> = document.querySelectorAll(<span class="hljs-string">'.font-size-btn'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">storyContent</span> = document.getElementById(<span class="hljs-string">'storyContent'</span>)<span class="hljs-comment">;</span>
  
  sizeBtns.forEach(<span class="hljs-attr">btn</span> =&gt; {
    btn.addEventListener('click', () =&gt; {
      sizeBtns.forEach(<span class="hljs-attr">b</span> =&gt; b.classList.remove(<span class="hljs-string">'active'</span>))<span class="hljs-comment">;</span>
      btn.classList.add('active')<span class="hljs-comment">;</span>
      
      const <span class="hljs-attr">size</span> = btn.dataset.size<span class="hljs-comment">;</span>
      switch(size) {
        case 'small':
          <span class="hljs-attr">storyContent.style.fontSize</span> = <span class="hljs-string">'16px'</span><span class="hljs-comment">;</span>
          break<span class="hljs-comment">;</span>
        case 'medium':
          <span class="hljs-attr">storyContent.style.fontSize</span> = <span class="hljs-string">'18px'</span><span class="hljs-comment">;</span>
          break<span class="hljs-comment">;</span>
        case 'large':
          <span class="hljs-attr">storyContent.style.fontSize</span> = <span class="hljs-string">'22px'</span><span class="hljs-comment">;</span>
          break<span class="hljs-comment">;</span>
      }
      // 保存到本地存储，下次打开记忆状态
      localStorage.setItem('fontSize', size)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  
  // 读取本地存储的字体大小
  const <span class="hljs-attr">savedSize</span> = localStorage.getItem(<span class="hljs-string">'fontSize'</span>) || <span class="hljs-string">'medium'</span><span class="hljs-comment">;</span>
  document.querySelector(`.font-size-btn<span class="hljs-section">[data-size="${savedSize}"]</span>`).click()<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-7">（3）故事进度记忆</h4>
<p>家长反馈孩子可能一次听不完故事，所以添加了进度记忆功能，用localStorage保存阅读位置，下次打开直接定位到上次读到的地方：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 进度记忆功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveReadingProgress</span>(<span class="hljs-params">storyId, scrollTop</span>) {
  <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'readingProgress'</span>) || <span class="hljs-string">'{}'</span>);
  progress[storyId] = scrollTop;
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'readingProgress'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(progress));
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getReadingProgress</span>(<span class="hljs-params">storyId</span>) {
  <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'readingProgress'</span>) || <span class="hljs-string">'{}'</span>);
  <span class="hljs-keyword">return</span> progress[storyId] || <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 详情页滚动时保存进度</span>
<span class="hljs-keyword">const</span> storyContent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'storyContent'</span>);
<span class="hljs-keyword">if</span> (storyContent) {
  <span class="hljs-keyword">const</span> storyId = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];
  <span class="hljs-comment">// 加载上次进度</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-title function_">getReadingProgress</span>(storyId);
    storyContent.<span class="hljs-property">scrollTop</span> = scrollTop;
  });
  <span class="hljs-comment">// 滚动时保存进度</span>
  storyContent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveReadingProgress</span>(storyId, storyContent.<span class="hljs-property">scrollTop</span>);
  });
}
</code></pre>
<h2 data-id="heading-8">Trae Solo模式开发体验：这些亮点值得夸</h2>
<p>作为常年用VS Code开发的开发者，这次用Trae Solo模式的体验超出预期，尤其这3个亮点让我印象深刻：</p>
<ul>
<li><strong>零配置环境</strong>：打开浏览器就能写代码，内置的Tailwind、Font Awesome等资源直接调用，不用再配置webpack或vite，对新手极度友好</li>
<li><strong>实时预览+调试</strong>：右侧预览窗口支持手机、平板、桌面多设备切换，调试响应式布局时不用频繁切换浏览器窗口，还能直接在预览区检查元素</li>
<li><strong>一键部署</strong>：开发完成后点击"部署"按钮，自动生成临时链接，直接分享给宝妈们使用，省去了购买服务器、配置域名的麻烦（正式上线可绑定自定义域名）</li>
</ul>
<h2 data-id="heading-9">优化方向与后续计划</h2>
<p>目前这个网页还处于1.0版本，根据宝妈们的反馈，后续打算用Trae的协作模式和其他开发者一起迭代：</p>
<ol>
<li>添加"故事朗读"功能：集成TTS语音接口，支持一键朗读，解放家长的嗓子</li>
<li>增加家长控制功能：可设置单次阅读时长，避免孩子睡前过度使用电子设备</li>
<li>建立故事投稿机制：让家长和老师可以上传原创故事，丰富内容库</li>
</ol>
<h2 data-id="heading-10">最后：附项目地址与开发心得</h2>
<p>这次实战让我深刻感受到：<strong>好的工具能让开发者更专注于需求本身</strong>。Trae Solo模式虽然轻量化，但足以支撑中小型前端项目的开发，尤其适合快速原型制作、独立开发或教学场景。如果你也是独立开发者或前端新手，强烈建议试试这种"即开即写"的开发方式，可能会打开新的思路。</p>
<p>如果大家对代码细节有疑问，或者有更好的优化建议，欢迎在评论区交流～ 我会持续更新项目进展，也会分享更多Trae的使用技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程实战：用Trae SOLO模式梭哈一个文档阅读小程序]]></title>    <link>https://juejin.cn/post/7582528397866172443</link>    <guid>https://juejin.cn/post/7582528397866172443</guid>    <pubDate>2025-12-12T07:03:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397866172443" data-draft-id="7582553782398828590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程实战：用Trae SOLO模式梭哈一个文档阅读小程序"/> <meta itemprop="keywords" content="AI编程,AIGC,Trae"/> <meta itemprop="datePublished" content="2025-12-12T07:03:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="埃兰德欧神"/> <meta itemprop="url" content="https://juejin.cn/user/3421335915620920"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程实战：用Trae SOLO模式梭哈一个文档阅读小程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3421335915620920/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    埃兰德欧神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:03:15.000Z" title="Fri Dec 12 2025 07:03:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 <strong>写在前面</strong></p>
<p>技术文档都是英文，看着费劲？想用 AI 翻译成中文，再通过小程序随时随地阅读？我用 Trae CN 的 SOLO 模式，三天时间搞定了一个沉浸式文档阅读小程序的前中后端开发。这篇文章记录了从想法到落地的全过程，包括技术选型、AI 协作实战，以及踩过的那些坑。如果你对 AI 辅助编程感兴趣，或者也想尝试 SOLO 模式开发项目，这篇实战经验应该能给你一些参考。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、为什么要做这个项目？</h2>
<p>作为开发者，我经常需要查阅各种技术文档，比如 Supabase、Appwrite、Claude Code 等。这些文档在移动端的体验整体不错，但有个共同的痛点：<strong>都是英文的，没有中文版</strong>。</p>
<p>碎片时间用手机看英文文档，不仅阅读效率低，理解起来也费劲。虽然可以用翻译工具，但来回切换很麻烦，体验割裂。于是就有了这个想法：<strong>做一个小程序，可以收集、整理开源项目的 Markdown 文档，通过 AI 自动翻译成中文，然后提供沉浸式的阅读体验</strong>。</p>
<p>这样既能享受小程序的便捷阅读体验，又能无障碍地理解技术内容。正好最近体验了 Trae CN 的 SOLO 模式，不如就用它来实现这个想法，看看 AI 辅助编程在实际项目中的表现如何。</p>
<hr/>
<h2 data-id="heading-1">二、技术选型：站在巨人的肩膀上</h2>
<p>工欲善其事，必先利其器。在开始编码前，我做了一轮技术调研：</p>
<h3 data-id="heading-2">核心技术栈</h3>
<ul>
<li>
<p><strong>小程序框架</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ficebreaker-template%2Fvue-mini-tailwindcss-template.git" target="_blank" title="https://github.com/icebreaker-template/vue-mini-tailwindcss-template.git" ref="nofollow noopener noreferrer">vue-mini-tailwindcss-template</a> - 这是我一直使用的微信小程序模板，支持 Vue3 + TailwindCSS</p>
</li>
<li>
<p><strong>Markdown 解析</strong>：Towxml - 在小程序上解析和渲染 Markdown 的利器</p>
</li>
<li>
<p><strong>后端服务</strong>：Supabase - 开源的 Firebase 替代品，提供数据库、认证、存储等全套后端服务</p>
</li>
<li>
<p><strong>项目管理</strong>：PNPM Workspace - 统一管理小程序、后台管理、数据库脚本等多个子项目</p>
</li>
</ul>
<h3 data-id="heading-3">项目结构设计</h3>
<p>基于这些技术选型，我快速搭建了 Monorepo 结构：</p>
<pre><code class="hljs language-bash" lang="bash">├── packages
│   ├── miniprogram          <span class="hljs-comment"># 微信小程序</span>
│   ├── admin-dashboard      <span class="hljs-comment"># 后台管理系统</span>
│   └── database            <span class="hljs-comment"># 数据库脚本</span>
├── supabase
│   ├── config.toml         <span class="hljs-comment"># Supabase 配置</span>
│   ├── <span class="hljs-built_in">functions</span>           <span class="hljs-comment"># 云函数</span>
│   └── migrations          <span class="hljs-comment"># 数据库迁移脚本</span>
├── scripts                 <span class="hljs-comment"># 工具脚本</span>
└── pnpm-workspace.yaml     <span class="hljs-comment"># Workspace 配置</span>
</code></pre>
<p>技术选型完成，接下来就是请 AI 出场了。</p>
<hr/>
<h2 data-id="heading-4">三、SOLO 实战：让 AI 成为你的开发伙伴</h2>
<h3 data-id="heading-5">初识 Trae SOLO</h3>
<p>TRAE 是一个能理解需求、调动工具、独立完成各类开发任务的 AI 开发工程师。它的 SOLO 模式支持多任务并行，这意味着可以同时推进前端、后端、数据库等多个任务。</p>
<p>初始化工作区后，我导入 Trae 开始 Vibe Coding。</p>
<p>[疯狂打码表情包]</p>
<h3 data-id="heading-6">第一步：需求沟通与原型设计</h3>
<p>我给 Solo Coder 的第一个任务很简单：</p>
<blockquote>
<p>"请先学习这个项目，这是一个沉浸式阅读项目，功能是收集、整理和翻译网上开源项目的 Markdown 文档资料，使用小程序进行阅读。请帮我设计一个小程序原型图。"</p>
</blockquote>
<p>几分钟后，Solo Coder 给出了一个完整的设计原型：</p>
<p><span href="https://code.juejin.cn/pen/7582858911187894298" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7582858911187894298" data-src="https://code.juejin.cn/pen/7582858911187894298" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58bd89e5e0734ef88ef8e190a405f7e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-D5YWw5b635qyn56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766129022&amp;x-signature=8i5B975Kjq04kMUAymM2ow162U8%3D" alt="惊讶" loading="lazy"/></p>
<p>设计图和功能规划完全符合预期！这就是 AI 的魔力：<strong>从模糊的想法到清晰的原型，只需要一次对话</strong>。</p>
<h3 data-id="heading-7">第二步：多任务并行开发</h3>
<p>了解到 SOLO 模式支持多任务并行后，我决定梭哈一把，同时开启三个任务：</p>
<ol>
<li>
<p><strong>开发微信小程序</strong> - 实现用户界面和交互</p>
</li>
<li>
<p><strong>开发 Admin Dashboard</strong> - 后台管理系统，用于文档管理</p>
</li>
<li>
<p><strong>开发 Supabase</strong> - 数据库设计和 API 接口</p>
</li>
</ol>
<p>看着三个任务同时推进，那一刻真的感受到：<strong>AI 时代已经到来，一个人可以顶一个小团队</strong>。</p>
<hr/>
<p>然而，理想很丰满，现实很骨感。接下来才是真正的考验。</p>
<h3 data-id="heading-8">实战中的挑战与解决</h3>
<h4 data-id="heading-9">问题 1：Towxml 组件适配失败</h4>
<p><strong>现象</strong>：Towxml 组件在 vue-mini-tailwindcss-template 工程里无法正常工作。</p>
<p><strong>原因分析</strong>：应该是工程目录结构的问题，Towxml 对路径和配置有特定要求。</p>
<p><strong>解决方案</strong>：不纠结于原有模板，直接改用 Towxml-Demo-3.0 作为基础进行初始化。虽然损失了一些便利性，但 <strong>快速试错、及时调整</strong> 比坚持错误的方向更重要。</p>
<hr/>
<h4 data-id="heading-10">问题 2：Admin Dashboard 对接 Supabase 后白屏</h4>
<p><strong>实现过程</strong>：</p>
<ul>
<li>
<p>完成了 Arco Design Pro 项目的全量引入</p>
</li>
<li>
<p>项目启动访问 <code>http://localhost:3000</code>，初始功能正常</p>
</li>
<li>
<p>指挥 Solo Coder 对接 Supabase 的注册和登录功能</p>
</li>
<li>
<p>AI 引入 <code>@supabase/supabase-js</code>，将 Mock API 替换为真实的 Supabase 调用</p>
</li>
</ul>
<p><strong>遇到的问题</strong>：提交代码后，打开浏览器——白屏了 😮</p>
<p><strong>问题定位</strong>：</p>
<ul>
<li>
<p>打开控制台，发现用户权限数据 <code>undefined</code></p>
</li>
<li>
<p>原因：初始化时使用的是 Mock 数据，对接后端后缺少相应的权限字段</p>
</li>
</ul>
<p><strong>解决方法</strong>：<br/>
给 Solo Coder 提供明确的指令：</p>
<blockquote>
<p>"请根据 mock/user.ts 中的用户登录返回数据，修复用户登录权限数据 undefined 问题。"</p>
</blockquote>
<p>同时贴上控制台的完整报错信息。AI 很快定位到问题并修复了数据结构。</p>
<p><strong>经验教训</strong>：<strong>提供足够的上下文信息至关重要</strong>。代码、报错、期望结果都贴出来，AI 才能给出准确的解决方案。</p>
<hr/>
<h4 data-id="heading-11">问题 3：Supabase 数据库设计</h4>
<p><strong>需求</strong>：根据功能规划设计数据库表结构。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff6d313f5ae34eacafe66282d9de6efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-D5YWw5b635qyn56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766129022&amp;x-signature=6gdIJ4kq4VeGiCo9uoTOt6NaeKE%3D" alt="数据库迁移脚本生成" loading="lazy"/></p>
<p><strong>AI 表现</strong>：Solo Coder 不仅设计了合理的表结构，还自动生成了符合规范的 migration 脚本：</p>
<p><strong>让我印象深刻的地方</strong>：</p>
<ul>
<li>
<p>项目目录结构准确无误</p>
</li>
<li>
<p>Migration 文件命名规范（时间戳 + 描述）</p>
</li>
<li>
<p>SQL 脚本包含了索引、外键、注释等细节</p>
</li>
</ul>
<p><strong>感受</strong>：在这种标准化的工作上，<strong>AI 的表现甚至比人工更稳定、更规范</strong>。</p>
<hr/>
<h4 data-id="heading-12">问题 4：Git 版本管理的痛点</h4>
<p>完成所有开发任务后，我发现了一个严重的问题：<strong>工作区内有 200+ 个文件被修改</strong>。</p>
<p><strong>遇到的困扰</strong>：</p>
<ul>
<li>
<p>整体提交不利于回退和问题追溯</p>
</li>
<li>
<p>虽然每个任务都有产物汇总页面，但没有独立的提交功能</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ead1deb3a2412ab647619278cbf88f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-D5YWw5b635qyn56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766129022&amp;x-signature=tcgbrha98K0AYu9lUGSGkDMlfFQ%3D" alt="代码变更汇总" loading="lazy"/></p>
<ul>
<li>只能手动将不同模块的变更分别提交</li>
</ul>
<p><strong>尝试的解决方法</strong>：<br/>
在项目规则中添加：</p>
<pre><code class="hljs language-markdown" lang="markdown">任务运行完毕，请按照 git 规范提交这个任务更改的代码，包括修改后的文件、删除的文件和新增的文件。
</code></pre>
<p><strong>结果</strong>：后续执行仍然不起作用。</p>
<p><strong>反思</strong>：这可能是目前 SOLO 模式最需要改进的地方。如果有朋友知道更好的解决方法，欢迎在评论区分享！</p>
<hr/>
<h2 data-id="heading-13">四、经验总结：AI 不是银弹，但确实是利器</h2>
<h3 data-id="heading-14">重新认识 AI 辅助编程</h3>
<p>使用 SOLO 模式的这段时间，让我对 AI 辅助编程有了更深的认识。它确实不像想象中那样"一句话需求，坐等收代码"，而是仍需像传统开发那样精心打磨，遇到问题时要自己定位和 Debug。</p>
<p>但不可否认，<strong>AI 确实大幅提升了开发效率</strong>，改变的是我们的工作方式。</p>
<hr/>
<h3 data-id="heading-15">SOLO 模式的优势</h3>
<h4 data-id="heading-16">1. 多任务并行能力惊艳</h4>
<p>最让我惊喜的是可以同时开 3 个任务：小程序、后台管理、数据库设计。这种并行开发的能力是传统方式难以企及的。虽然需要在任务间切换关注点，但整体进度确实快了很多。</p>
<h4 data-id="heading-17">2. 快速原型和代码生成</h4>
<p>从设计原型到生成代码，SOLO 模式能够快速将想法落地。特别是在项目初期搭建阶段，AI 生成的代码质量和项目结构都相当不错，<strong>大大减少了"从 0 到 1"的时间成本</strong>。</p>
<h4 data-id="heading-18">3. 代码规范性出人意料</h4>
<p>AI 生成的代码在命名、目录结构、迁移脚本等方面都很规范，有时候比人工写的还要严谨。比如 Supabase 的 migration 文件命名，完全符合最佳实践。</p>
<hr/>
<h3 data-id="heading-19">SOLO 模式的局限</h3>
<h4 data-id="heading-20">1. 需要精确的指令</h4>
<p>AI 不会读心术，<strong>模糊的需求会得到模糊的结果</strong>。你需要像写 PRD 一样清晰地描述需求，必要时还要提供上下文和示例。这对产品思维和需求表达能力要求不低。</p>
<h4 data-id="heading-21">2. 代码审查不可省略</h4>
<p>生成的代码并非完美，白屏、权限数据缺失等问题依然会出现。<strong>你仍然需要具备审查代码的能力</strong>，理解代码逻辑，才能快速定位和修复问题。</p>
<h4 data-id="heading-22">3. Git 管理是个痛点</h4>
<p>200+ 文件的修改如果没有合理的 commit 策略，回退和版本管理会很痛苦。虽然尝试在项目规则里加入自动提交的要求，但效果并不理想。这可能是目前 SOLO 模式<strong>最需要改进的地方</strong>。</p>
<hr/>
<h3 data-id="heading-23">适用场景建议</h3>
<p>基于这次实战，我认为 SOLO 模式特别适合：</p>
<p><strong>✅ 适合的场景</strong></p>
<ul>
<li>
<p><strong>原型快速验证</strong>：想法验证阶段，快速搭建 MVP</p>
</li>
<li>
<p><strong>标准化项目</strong>：采用主流技术栈的 CRUD 项目</p>
</li>
<li>
<p><strong>重复性工作</strong>：数据库设计、API 接口、基础组件等</p>
</li>
<li>
<p><strong>个人项目</strong>：一个人顶一个小团队，特别适合独立开发者</p>
</li>
</ul>
<p><strong>❌ 相对不适合</strong></p>
<ul>
<li>
<p>高度定制化的复杂业务逻辑</p>
</li>
<li>
<p>需要深度性能优化的场景</p>
</li>
<li>
<p>对代码质量要求极高的核心模块</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-24">实用技巧分享</h3>
<h4 data-id="heading-25">1. 任务拆分要合理</h4>
<p>不要一次性给太大的任务，<strong>把大任务拆成小的、可验证的子任务</strong>。每个子任务完成后验证一下，避免问题累积。就像盖楼一样，一层一层往上搭，每一层都要验收。</p>
<h4 data-id="heading-26">2. 提供充足的上下文</h4>
<p>贴代码、贴报错、贴项目结构。<strong>AI 看到的信息越完整，给出的解决方案越靠谱</strong>。就像遇到白屏问题，把控制台报错一贴，问题很快就定位了。</p>
<h4 data-id="heading-27">3. 建立项目规则</h4>
<p>在项目开始时就建立清晰的规则和约定（代码风格、提交规范、文件组织等），让 AI 遵循统一的标准。虽然不是 100% 生效，但会有明显帮助。</p>
<h4 data-id="heading-28">4. 保持怀疑精神</h4>
<p>AI 生成的代码要经过自己的审查和测试，<strong>不要盲目信任</strong>。遇到问题时，先理解代码逻辑，再决定是修改还是重新生成。</p>
<hr/>
<h3 data-id="heading-29">对 AI 编程工具的思考</h3>
<p>这次实战让我真切感受到"前端已死，未来已来"这句话的含义。AI 不是要取代开发者，而是在<strong>改变开发者的工作方式</strong>：</p>
<ul>
<li>
<p><strong>从"写代码"转向"设计和审查"</strong>：更多精力放在架构设计、需求分析和代码审查上</p>
</li>
<li>
<p><strong>从"单打独斗"转向"人机协作"</strong>：学会如何高效地与 AI 沟通和协作</p>
</li>
<li>
<p><strong>从"全栈工程师"转向"产品工程师"</strong>：技术实现由 AI 辅助，人更专注于产品和用户价值</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-30">五、项目后续计划</h2>
<p>目前项目已经跑通了主体流程，完成了基础架构搭建和核心功能原型。接下来的计划：</p>
<ol>
<li>
<p>完善文档解析和翻译功能</p>
</li>
<li>
<p>优化阅读体验和交互细节</p>
</li>
<li>
<p>补充完整的测试用例</p>
</li>
<li>
<p>撰写详细的技术文档</p>
</li>
</ol>
<p><strong>如果你对这个小程序感兴趣，欢迎持续关注</strong>。项目成熟后会考虑开源，希望能给想尝试 AI 辅助开发的朋友提供一些参考。</p>
<p>也欢迎在评论区分享你使用 AI 编程工具的经验，或者对这个项目的建议和想法。<strong>AI 辅助开发的最佳实践，需要我们一起探索</strong>。</p>
<hr/>
<blockquote>
<p>📌 <strong>关键收获</strong></p>
<ul>
<li>
<p>SOLO 模式适合快速原型和标准化项目，但不是银弹</p>
</li>
<li>
<p>精确的需求描述和充足的上下文是成功的关键</p>
</li>
<li>
<p>代码审查和 Git 管理仍然需要人工介入</p>
</li>
<li>
<p>AI 改变的是工作方式，而非取代开发者</p>
</li>
<li>
<p>一个人确实可以顶一个小团队，但前提是你知道怎么用好 AI</p>
</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么浏览器能看懂网页代码？——从HTML到渲染引擎的奇幻之旅]]></title>    <link>https://juejin.cn/post/7582779306731044899</link>    <guid>https://juejin.cn/post/7582779306731044899</guid>    <pubDate>2025-12-12T10:54:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582779306731044899" data-draft-id="7582779306731028515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么浏览器能看懂网页代码？——从HTML到渲染引擎的奇幻之旅"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T10:54:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么浏览器能看懂网页代码？——从HTML到渲染引擎的奇幻之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T10:54:25.000Z" title="Fri Dec 12 2025 10:54:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌐 为什么浏览器能看懂网页代码？——从HTML到渲染引擎的奇幻之旅 💻</h2>
<blockquote>
<p>欢迎大家来到今日份的无限大博客，今天又又又又是一期计算机十万个为什么系列的文章</p>
<p>让我来带领你开启今日份的学习吧</p>
</blockquote>
<p>当你在浏览器地址栏输入 <code>https://www.baidu.com</code> 并按下回车时，一场精彩的"魔法表演"就开始了——短短几百毫秒后，原本枯燥的代码就变成了色彩斑斓的网页。</p>
<p>这就像你给了厨师一堆生食材（代码），他瞬间就端出了一道美味佳肴（网页）。🍳 浏览器到底是怎么做到的？今天咱们就来揭开这个"魔法"的神秘面纱！</p>
<h3 data-id="heading-1">🚦 网页加载的"流水线"：从输入URL到看到网页</h3>
<p>想象一下，浏览器加载网页就像工厂生产产品，有一条完整的"流水线"。咱们来看看这条流水线的每个环节：</p>
<h4 data-id="heading-2">1. 🔍 DNS解析：找到服务器的"电话号码"</h4>
<p>当你输入 <code>baidu.com</code> 时，浏览器首先要问："这个域名对应的服务器IP地址是多少？"这就像你要给朋友打电话，得先查他的电话号码。</p>
<p>DNS解析的过程就像查电话簿：</p>
<ul>
<li>先问本地DNS缓存（手机通讯录）</li>
<li>再问ISP的DNS服务器（小区物业）</li>
<li>最后问根域名服务器（国家电信总局）</li>
</ul>
<p>整个过程通常只需要几毫秒，快得就像你从通讯录里找到朋友的电话！📞</p>
<h4 data-id="heading-3">2. 🛰️ TCP连接：建立"数据高速公路"</h4>
<p>拿到IP地址后，浏览器和服务器之间会建立一条TCP连接——这就像在两地之间修了一条高速公路，数据可以在上面快速传输。</p>
<p>TCP连接的建立需要"三次握手"：</p>
<ol>
<li>浏览器："你好，我想连接你！" 👋</li>
<li>服务器："你好，我收到了！" 👌</li>
<li>浏览器："好的，咱们开始传输数据吧！" 🚀</li>
</ol>
<p>这三次握手确保了连接的可靠性，就像你和朋友确认"喂？喂？能听到吗？"一样。</p>
<h4 data-id="heading-4">3. 🔄 HTTP请求：发送"购物清单"</h4>
<p>连接建立后，浏览器会向服务器发送HTTP请求——这就像你给超市发了一份购物清单，上面写着你想要的网页内容。</p>
<p>请求里包含了很多信息：</p>
<ul>
<li>请求方法（GET/POST）：是想买东西还是退货？</li>
<li>请求头：你的浏览器类型、支持的格式等</li>
<li>请求体：你要提交的数据（比如登录信息）</li>
</ul>
<h4 data-id="heading-5">4. 📦 HTTP响应：收到"快递包裹"</h4>
<p>服务器收到请求后，会根据请求内容准备响应——这就像超市根据你的清单打包商品，然后快递给你。</p>
<p>响应里也包含了很多信息：</p>
<ul>
<li>状态码：200表示成功，404表示找不到页面</li>
<li>响应头：内容类型、长度、编码等</li>
<li>响应体：网页的实际内容（HTML/CSS/JS等）</li>
</ul>
<h4 data-id="heading-6">5. 🧙 渲染引擎："魔法厨师"的表演</h4>
<p>收到服务器的响应后，浏览器的渲染引擎就开始工作了——这是整个过程中最精彩的部分！渲染引擎就像一位"魔法厨师"，把各种"食材"（HTML/CSS/JS）变成一道"美味佳肴"（网页）。</p>
<h3 data-id="heading-7">🧠 渲染引擎：浏览器的"大脑"</h3>
<p>目前主流的渲染引擎有两个：</p>
<ul>
<li><strong>WebKit</strong>：Safari和早期Chrome使用 🍎</li>
<li><strong>Gecko</strong>：Firefox使用 🦊</li>
<li><strong>Blink</strong>：现在Chrome和Edge使用（基于WebKit） 🔴</li>
</ul>
<p>不管是哪种渲染引擎，它们的工作原理都差不多，主要分为以下几个步骤：</p>
<h4 data-id="heading-8">1. 📄 HTML解析：构建DOM树</h4>
<p>首先，渲染引擎会把HTML代码解析成一个树形结构——<strong>DOM树</strong>（Document Object Model）。</p>
<p>想象一下，HTML代码就像一本家谱：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的网页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到我的博客<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一段正文<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>解析后生成的DOM树就像这样：</p>
<ul>
<li><code>html</code> 是根节点</li>
<li><code>head</code> 和 <code>body</code> 是它的子节点</li>
<li><code>title</code>、<code>h1</code>、<code>p</code> 是孙子节点</li>
</ul>
<p>就像一个大家庭，每个标签都是一个家庭成员，有着明确的层级关系。👨‍👩‍👧‍👦</p>
<h4 data-id="heading-9">2. 🎨 CSS解析：构建CSSOM树</h4>
<p>接下来，渲染引擎会解析CSS代码，生成<strong>CSSOM树</strong>（CSS Object Model）。</p>
<p>CSSOM树记录了每个元素的样式信息：</p>
<ul>
<li>颜色、字体、大小</li>
<li>边距、padding</li>
<li>定位方式</li>
<li>等等</li>
</ul>
<p>这就像给每个家庭成员穿上不同的衣服，有的穿西装，有的穿T恤，有的穿裙子。👗👔</p>
<h4 data-id="heading-10">3. 🌳 构建渲染树</h4>
<p>有了DOM树和CSSOM树，渲染引擎会把它们合并成一棵<strong>渲染树</strong>（Render Tree）。</p>
<p>渲染树只包含可见的元素：</p>
<ul>
<li>会忽略 <code>display: none</code> 的元素</li>
<li>会忽略 <code>&lt;head&gt;</code> 里的元素（除非有可见的内容）</li>
<li>会应用CSS样式到每个可见元素</li>
</ul>
<p>这就像在拍照前，只让穿好衣服的家庭成员站成一排，准备合影。📸</p>
<h4 data-id="heading-11">4. 📏 布局（Layout）：计算每个元素的位置和大小</h4>
<p>接下来是<strong>布局</strong>阶段，渲染引擎会计算每个元素在页面上的确切位置和大小。</p>
<p>这个过程也叫"重排"（Reflow），它会考虑：</p>
<ul>
<li>元素的尺寸</li>
<li>元素的位置</li>
<li>元素的外边距和内边距</li>
<li>父元素的约束</li>
<li>等等</li>
</ul>
<p>就像在布置舞台，导演会精确计算每个演员的站位和移动路线。🎭</p>
<h4 data-id="heading-12">5. 🎨 绘制（Paint）：给元素上色</h4>
<p>布局完成后，渲染引擎会开始<strong>绘制</strong>阶段，将渲染树转换为屏幕上的像素。</p>
<p>绘制过程会按照一定的顺序进行：</p>
<ul>
<li>背景色</li>
<li>边框</li>
<li>文字</li>
<li>阴影</li>
<li>等等</li>
</ul>
<p>就像画家作画，先画背景，再画主体，最后画细节。🖌️</p>
<h4 data-id="heading-13">6. 🔄 合成（Composite）：将图层合并</h4>
<p>最后是<strong>合成</strong>阶段，渲染引擎会将所有绘制好的图层合并成一个完整的页面。</p>
<p>现代浏览器会使用硬件加速（GPU）来完成这个过程，这样可以提高性能。就像电影后期制作，把不同场景的胶片合成一部完整的电影。🎬</p>
<h3 data-id="heading-14">🚀 渲染引擎工作流程图</h3>















































<table><thead><tr><th>步骤</th><th>名称</th><th>作用</th><th>比喻</th></tr></thead><tbody><tr><td>1</td><td>HTML解析</td><td>生成DOM树</td><td>写家谱</td></tr><tr><td>2</td><td>CSS解析</td><td>生成CSSOM树</td><td>穿衣服</td></tr><tr><td>3</td><td>构建渲染树</td><td>合并DOM和CSSOM</td><td>排合影</td></tr><tr><td>4</td><td>布局</td><td>计算位置和大小</td><td>舞台布置</td></tr><tr><td>5</td><td>绘制</td><td>填充像素</td><td>画家作画</td></tr><tr><td>6</td><td>合成</td><td>合并图层</td><td>电影后期</td></tr></tbody></table>
<h3 data-id="heading-15">💡 性能优化：让网页"飞"起来</h3>
<p>网页加载速度对用户体验至关重要。研究表明：</p>
<blockquote>
<p><strong>页面加载时间每增加1秒，转化率下降7%，用户满意度下降16%！</strong> 📊</p>
</blockquote>
<p>那么，我们该如何优化网页性能呢？</p>
<h4 data-id="heading-16">1. ⚡ 减少HTTP请求：少跑腿，多办事</h4>
<p>每一个HTTP请求都需要建立连接、传输数据、断开连接，这需要时间。减少HTTP请求可以显著提高加载速度。</p>
<p><strong>优化方法</strong>：</p>
<ul>
<li>合并CSS和JavaScript文件</li>
<li>使用CSS Sprites合并小图标</li>
<li>内联关键CSS</li>
<li>减少不必要的图片和脚本</li>
</ul>
<p>就像你去超市买东西，一次买齐所有东西比跑十次超市要快得多！🛒</p>
<h4 data-id="heading-17">2. 📦 压缩资源：给文件"减肥"</h4>
<p>压缩HTML、CSS、JavaScript文件可以减少文件大小，加快传输速度。</p>
<p><strong>优化方法</strong>：</p>
<ul>
<li>使用gzip或brotli压缩文本文件</li>
<li>压缩图片（JPEG优化、PNG压缩、WebP格式）</li>
<li>移除不必要的代码和注释</li>
</ul>
<p>就像你寄快递，把东西压缩打包后，不仅省钱，还能更快送达！📮</p>
<h4 data-id="heading-18">3. 🌐 使用CDN：就近发货</h4>
<p>CDN（内容分发网络）可以将你的静态资源分发到全球各地的服务器上，用户可以从离他最近的服务器获取资源。</p>
<p><strong>优化效果</strong>：</p>
<ul>
<li>减少网络延迟</li>
<li>提高资源加载速度</li>
<li>减轻源服务器压力</li>
</ul>
<p>就像你在网上购物，选择本地仓发货，第二天就能收到商品！🚚</p>
<h4 data-id="heading-19">4. ⏳ 懒加载：按需加载</h4>
<p>懒加载是指只加载用户当前可见区域的内容，当用户滚动页面时再加载其他内容。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>长页面的图片</li>
<li>视频内容</li>
<li>列表页的分页内容</li>
</ul>
<p>就像你去餐厅吃饭，服务员不会一次性把所有菜都端上来，而是按需上菜！🍽️</p>
<h4 data-id="heading-20">5. 🚫 避免重排和重绘：减少不必要的操作</h4>
<p>重排（Layout）和重绘（Paint）是性能杀手，我们应该尽量避免。</p>
<p><strong>避免方法</strong>：</p>
<ul>
<li>不要频繁修改DOM样式</li>
<li>使用transform和opacity来做动画（只会触发合成，不会触发重排和重绘）</li>
<li>批量修改DOM</li>
<li>使用documentFragment</li>
</ul>
<p>就像你在拍照时，不要频繁让模特换姿势，一次性摆好姿势拍照更高效！📸</p>
<h3 data-id="heading-21">🎯 不同浏览器的"魔法厨师"</h3>
<p>不同的浏览器有不同的渲染引擎，它们就像不同风格的厨师，做出的"菜"味道略有不同：</p>









































<table><thead><tr><th>浏览器</th><th>渲染引擎</th><th>特点</th><th>比喻</th></tr></thead><tbody><tr><td>Chrome</td><td>Blink</td><td>速度快，兼容性好</td><td>快餐连锁店，高效便捷</td></tr><tr><td>Firefox</td><td>Gecko</td><td>开源，安全，灵活</td><td>私房菜馆，注重品质</td></tr><tr><td>Safari</td><td>WebKit</td><td>流畅，适合苹果设备</td><td>法式餐厅，精致优雅</td></tr><tr><td>Edge</td><td>Blink</td><td>现代，整合微软服务</td><td>新派餐厅，融合创新</td></tr><tr><td>IE</td><td>Trident</td><td>古老，兼容性差</td><td>传统老店，逐渐淘汰</td></tr></tbody></table>
<h3 data-id="heading-22">🧪 趣味实验：亲眼见证渲染过程</h3>
<p>咱们来做个小实验，看看浏览器是如何渲染网页的。打开Chrome浏览器，按F12打开开发者工具，点击"Performance"标签，然后点击"Record"按钮，刷新页面。</p>
<p>你会看到一个详细的渲染时间线，上面清楚地显示了每个阶段的耗时：</p>
<ul>
<li>DNS Lookup</li>
<li>Initial Connection</li>
<li>Request/Response</li>
<li>DOMContentLoaded</li>
<li>Load</li>
</ul>
<p>这就像你看电影的进度条，能清楚地知道每个环节用了多长时间！⏱️</p>
<h3 data-id="heading-23">🔮 未来：渲染引擎的发展趋势</h3>
<p>随着Web技术的发展，渲染引擎也在不断进化：</p>
<ol>
<li><strong>🖼️ WebAssembly</strong>：让浏览器能运行接近原生速度的代码，适合游戏和复杂应用</li>
<li><strong>⚡ 渲染优化</strong>：更好的硬件加速，更智能的渲染策略</li>
<li><strong>📱 响应式设计</strong>：更好地支持不同设备和屏幕尺寸</li>
<li><strong>🔒 安全性</strong>：更强的沙箱机制，更好的恶意代码防护</li>
</ol>
<p>未来的渲染引擎会越来越智能，网页加载速度会越来越快，用户体验也会越来越好！🚀</p>
<h3 data-id="heading-24">🎓 互动时间：你答对了吗？</h3>
<p>来做个小测验，看看你对浏览器渲染了解多少：</p>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>浏览器渲染的第一步是什么？</td><td>HTML解析</td><td>✅/❌</td></tr><tr><td>display: none的元素会被包含在渲染树中吗？</td><td>不会</td><td>✅/❌</td></tr><tr><td>重排和重绘哪个更消耗性能？</td><td>重排</td><td>✅/❌</td></tr><tr><td>CSS Sprites的作用是什么？</td><td>减少HTTP请求</td><td>✅/❌</td></tr><tr><td>CDN的中文全称是什么？</td><td>内容分发网络</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-25">🎯 结语：浏览器的"魔法"其实很简单</h3>
<p>浏览器能看懂网页代码，靠的不是魔法，而是一套复杂但有序的工作流程。从DNS解析到最终渲染，每个环节都经过了精心设计和优化。</p>
<p>下次当你在浏览器中看到一个精美的网页时，不妨想一想：</p>
<blockquote>
<p>在这背后，有多少工程师的心血，有多少技术的积累，有多少优化的努力。</p>
</blockquote>
<p>就像我们看到的每一道美味佳肴，背后都有厨师的精心准备和烹饪技巧。浏览器的"魔法"，其实是人类智慧的结晶！✨</p>
<hr/>
<h3 data-id="heading-26">💬 互动话题</h3>
<ol>
<li>你遇到过的最慢的网页加载时间是多少？</li>
<li>你知道哪些提升网页性能的小技巧？</li>
<li>你觉得未来的浏览器会是什么样子？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 组件开发最佳实践：可复用组件设计模式]]></title>    <link>https://juejin.cn/post/7582533464245878818</link>    <guid>https://juejin.cn/post/7582533464245878818</guid>    <pubDate>2025-12-12T08:28:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245878818" data-draft-id="7582776967817248768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 组件开发最佳实践：可复用组件设计模式"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-12T08:28:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微芒不朽"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894153592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 组件开发最佳实践：可复用组件设计模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894153592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微芒不朽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:28:44.000Z" title="Fri Dec 12 2025 08:28:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">Vue 3 组件开发最佳实践：可复用组件设计模式</h2>
<h3 data-id="heading-1">前言</h3>
<p>组件化是现代前端开发的核心思想之一，而在 Vue 3 中，借助 Composition API 和更完善的响应式系统，我们能够设计出更加灵活、可复用的组件。本文将深入探讨 Vue 3 组件开发的最佳实践，介绍多种可复用组件的设计模式，帮助开发者构建高质量的组件库。</p>
<h3 data-id="heading-2">组件设计基本原则</h3>
<h4 data-id="heading-3">1. 单一职责原则</h4>
<p>每个组件应该只负责一个明确的功能，避免功能过于复杂。</p>
<h4 data-id="heading-4">2. 开放封闭原则</h4>
<p>组件对扩展开放，对修改封闭，通过合理的接口设计支持定制化。</p>
<h4 data-id="heading-5">3. 可组合性</h4>
<p>组件应该易于与其他组件组合使用，形成更复杂的 UI 结构。</p>
<h3 data-id="heading-6">基础组件设计模式</h3>
<h4 data-id="heading-7">1. Props 透传模式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseButton.vue --&gt;
&lt;template&gt;
  &lt;button 
    :class="buttonClasses"
    v-bind="$attrs"
    @click="handleClick"
  &gt;
    &lt;slot /&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps({
  variant: {
    type: String,
    default: 'primary',
    validator: (value) =&gt; ['primary', 'secondary', 'danger', 'ghost'].includes(value)
  },
  size: {
    type: String,
    default: 'medium',
    validator: (value) =&gt; ['small', 'medium', 'large'].includes(value)
  },
  block: {
    type: Boolean,
    default: false
  },
  disabled: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['click'])

const buttonClasses = computed(() =&gt; [
  'btn',
  `btn--${props.variant}`,
  `btn--${props.size}`,
  {
    'btn--block': props.block,
    'btn--disabled': props.disabled
  }
])

const handleClick = (event) =&gt; {
  if (!props.disabled) {
    emit('click', event)
  }
}

// 允许父组件访问子组件实例
defineExpose({
  focus: () =&gt; {
    // 实现焦点管理
  }
})
&lt;/script&gt;

&lt;style scoped&gt;
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn--primary {
  background-color: #42b883;
  color: white;
}

.btn--secondary {
  background-color: #6c757d;
  color: white;
}

.btn--danger {
  background-color: #dc3545;
  color: white;
}

.btn--ghost {
  background-color: transparent;
  color: #42b883;
  border: 1px solid #42b883;
}

.btn--small {
  padding: 4px 8px;
  font-size: 12px;
}

.btn--medium {
  padding: 8px 16px;
  font-size: 14px;
}

.btn--large {
  padding: 12px 24px;
  font-size: 16px;
}

.btn--block {
  display: flex;
  width: 100%;
}

.btn--disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn:hover:not(.btn--disabled) {
  opacity: 0.8;
  transform: translateY(-1px);
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-8">2. 插槽分发模式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Card.vue --&gt;
&lt;template&gt;
  &lt;div class="card" :class="cardClasses"&gt;
    &lt;!-- 默认插槽 --&gt;
    &lt;div v-if="$slots.header || title" class="card__header"&gt;
      &lt;slot name="header"&gt;
        &lt;h3 class="card__title"&gt;{{ title }}&lt;/h3&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
  
    &lt;!-- 内容插槽 --&gt;
    &lt;div class="card__body"&gt;
      &lt;slot /&gt;
    &lt;/div&gt;
  
    &lt;!-- 底部插槽 --&gt;
    &lt;div v-if="$slots.footer" class="card__footer"&gt;
      &lt;slot name="footer" /&gt;
    &lt;/div&gt;
  
    &lt;!-- 操作区域插槽 --&gt;
    &lt;div v-if="$slots.actions" class="card__actions"&gt;
      &lt;slot name="actions" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps({
  title: {
    type: String,
    default: ''
  },
  bordered: {
    type: Boolean,
    default: true
  },
  shadow: {
    type: Boolean,
    default: false
  },
  hoverable: {
    type: Boolean,
    default: false
  }
})

const cardClasses = computed(() =&gt; ({
  'card--bordered': props.bordered,
  'card--shadow': props.shadow,
  'card--hoverable': props.hoverable
}))
&lt;/script&gt;

&lt;style scoped&gt;
.card {
  background: #fff;
  border-radius: 8px;
}

.card--bordered {
  border: 1px solid #e5e5e5;
}

.card--shadow {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.card--hoverable:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.card__header {
  padding: 16px 24px;
  border-bottom: 1px solid #f0f0f0;
}

.card__title {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.card__body {
  padding: 24px;
}

.card__footer {
  padding: 16px 24px;
  border-top: 1px solid #f0f0f0;
}

.card__actions {
  padding: 16px 24px;
  text-align: right;
}
&lt;/style&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Card title="用户信息" bordered hoverable&gt;
    &lt;template #header&gt;
      &lt;div class="custom-header"&gt;
        &lt;h3&gt;用户详情&lt;/h3&gt;
        &lt;BaseButton size="small" variant="ghost"&gt;编辑&lt;/BaseButton&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  
    &lt;p&gt;这里是卡片内容&lt;/p&gt;
  
    &lt;template #footer&gt;
      &lt;div class="card-footer"&gt;
        &lt;span&gt;创建时间: 2023-01-01&lt;/span&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  
    &lt;template #actions&gt;
      &lt;BaseButton variant="primary"&gt;保存&lt;/BaseButton&gt;
      &lt;BaseButton variant="ghost"&gt;取消&lt;/BaseButton&gt;
    &lt;/template&gt;
  &lt;/Card&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-9">高级组件设计模式</h3>
<h4 data-id="heading-10">1. Renderless 组件模式</h4>
<p>Renderless 组件专注于逻辑处理，不包含任何模板，通过作用域插槽传递数据和方法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- FetchData.vue --&gt;
&lt;template&gt;
  &lt;slot 
    :loading="loading"
    :data="data"
    :error="error"
    :refetch="fetchData"
  /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'

const props = defineProps({
  url: {
    type: String,
    required: true
  },
  immediate: {
    type: Boolean,
    default: true
  }
})

const loading = ref(false)
const data = ref(null)
const error = ref(null)

const fetchData = async () =&gt; {
  loading.value = true
  error.value = null

  try {
    const response = await fetch(props.url)
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    data.value = await response.json()
  } catch (err) {
    error.value = err.message
  } finally {
    loading.value = false
  }
}

onMounted(() =&gt; {
  if (props.immediate) {
    fetchData()
  }
})

defineExpose({
  fetchData
})
&lt;/script&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;FetchData url="/api/users" v-slot="{ loading, data, error, refetch }"&gt;
    &lt;div class="user-list"&gt;
      &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
      &lt;div v-else-if="error"&gt;错误: {{ error }}&lt;/div&gt;
    
      &lt;template v-else&gt;
        &lt;div v-for="user in data" :key="user.id" class="user-item"&gt;
          {{ user.name }}
        &lt;/div&gt;
      
        &lt;button @click="refetch"&gt;刷新&lt;/button&gt;
      &lt;/template&gt;
    &lt;/div&gt;
  &lt;/FetchData&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-11">2. Compound Components 模式</h4>
<p>复合组件模式允许相关组件协同工作，共享状态和配置：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Tabs.vue --&gt;
&lt;template&gt;
  &lt;div class="tabs"&gt;
    &lt;div class="tabs__nav" role="tablist"&gt;
      &lt;slot name="nav" :active-key="activeKey" :change-tab="changeTab" /&gt;
    &lt;/div&gt;
    &lt;div class="tabs__content"&gt;
      &lt;slot :active-key="activeKey" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, provide } from 'vue'

const props = defineProps({
  modelValue: {
    type: [String, Number],
    default: ''
  }
})

const emit = defineEmits(['update:modelValue'])

const activeKey = ref(props.modelValue)

const changeTab = (key) =&gt; {
  activeKey.value = key
  emit('update:modelValue', key)
}

// 提供给子组件使用的上下文
provide('tabs-context', {
  activeKey,
  changeTab
})
&lt;/script&gt;

&lt;style scoped&gt;
.tabs {
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  overflow: hidden;
}

.tabs__nav {
  display: flex;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e5e5e5;
}

.tabs__content {
  padding: 24px;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabNav.vue --&gt;
&lt;template&gt;
  &lt;div class="tab-nav"&gt;
    &lt;slot /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.tab-nav {
  display: flex;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabNavItem.vue --&gt;
&lt;template&gt;
  &lt;button
    :class="classes"
    :aria-selected="isActive"
    @click="handleClick"
  &gt;
    &lt;slot /&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { inject, computed } from 'vue'

const props = defineProps({
  tabKey: {
    type: [String, Number],
    required: true
  },
  disabled: {
    type: Boolean,
    default: false
  }
})

const tabsContext = inject('tabs-context')

const isActive = computed(() =&gt; tabsContext.activeKey.value === props.tabKey)

const classes = computed(() =&gt; [
  'tab-nav-item',
  {
    'tab-nav-item--active': isActive.value,
    'tab-nav-item--disabled': props.disabled
  }
])

const handleClick = () =&gt; {
  if (!props.disabled) {
    tabsContext.changeTab(props.tabKey)
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.tab-nav-item {
  padding: 12px 24px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  color: #666;
  transition: all 0.2s ease;
}

.tab-nav-item:hover:not(.tab-nav-item--disabled) {
  color: #42b883;
  background-color: rgba(66, 184, 131, 0.1);
}

.tab-nav-item--active {
  color: #42b883;
  font-weight: 600;
  background-color: #fff;
  border-bottom: 2px solid #42b883;
}

.tab-nav-item--disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabPanel.vue --&gt;
&lt;template&gt;
  &lt;div v-show="isActive" class="tab-panel" role="tabpanel"&gt;
    &lt;slot /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { inject, computed } from 'vue'

const props = defineProps({
  tabKey: {
    type: [String, Number],
    required: true
  }
})

const tabsContext = inject('tabs-context')

const isActive = computed(() =&gt; tabsContext.activeKey.value === props.tabKey)
&lt;/script&gt;

&lt;style scoped&gt;
.tab-panel {
  outline: none;
}
&lt;/style&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Tabs v-model="activeTab"&gt;
    &lt;template #nav="{ activeKey, changeTab }"&gt;
      &lt;TabNavItem tab-key="profile"&gt;个人信息&lt;/TabNavItem&gt;
      &lt;TabNavItem tab-key="settings"&gt;设置&lt;/TabNavItem&gt;
      &lt;TabNavItem tab-key="security" disabled&gt;安全&lt;/TabNavItem&gt;
    &lt;/template&gt;
  
    &lt;TabPanel tab-key="profile"&gt;
      &lt;p&gt;这是个人信息面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  
    &lt;TabPanel tab-key="settings"&gt;
      &lt;p&gt;这是设置面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  
    &lt;TabPanel tab-key="security"&gt;
      &lt;p&gt;这是安全面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  &lt;/Tabs&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const activeTab = ref('profile')
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">3. Higher-Order Component (HOC) 模式</h4>
<p>虽然 Vue 更推荐使用 Composition API，但在某些场景下 HOC 仍然有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// withLoading.js</span>
<span class="hljs-keyword">import</span> { h, ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">withLoading</span>(<span class="hljs-params">WrappedComponent, loadingMessage = <span class="hljs-string">'加载中...'</span></span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">`WithLoading(<span class="hljs-subst">${WrappedComponent.name || <span class="hljs-string">'Component'</span>}</span>)`</span>,
    <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">props</span>: <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">props</span>,
    <span class="hljs-attr">emits</span>: <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">emits</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { attrs, slots, emit }</span>) {
      <span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
    
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 模拟异步操作</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
        }, <span class="hljs-number">1000</span>)
      })
    
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (isLoading.<span class="hljs-property">value</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'loading-wrapper'</span> }, loadingMessage)
        }
      
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
          ...props,
          ...attrs,
          <span class="hljs-attr">on</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(emit).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, key</span>) =&gt;</span> {
            acc[key] = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> <span class="hljs-title function_">emit</span>(key, ...args)
            <span class="hljs-keyword">return</span> acc
          }, {})
        }, slots)
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-13">4. State Reducer 模式</h4>
<p>借鉴 React 的理念，通过 reducer 函数管理复杂状态：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Toggle.vue --&gt;
&lt;template&gt;
  &lt;div class="toggle"&gt;
    &lt;slot 
      :on="on"
      :toggle="toggle"
      :set-on="setOn"
      :set-off="setOff"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false
  },
  reducer: {
    type: Function,
    default: null
  }
})

const emit = defineEmits(['update:modelValue'])

const internalOn = ref(props.modelValue)

const getState = () =&gt; ({
  on: internalOn.value
})

const dispatch = (action) =&gt; {
  const changes = props.reducer 
    ? props.reducer(getState(), action)
    : defaultReducer(getState(), action)
  
  if (changes.on !== undefined) {
    internalOn.value = changes.on
    emit('update:modelValue', changes.on)
  }
}

const defaultReducer = (state, action) =&gt; {
  switch (action.type) {
    case 'toggle':
      return { on: !state.on }
    case 'setOn':
      return { on: true }
    case 'setOff':
      return { on: false }
    default:
      throw new Error(`Unknown action type: ${action.type}`)
  }
}

const toggle = () =&gt; dispatch({ type: 'toggle' })
const setOn = () =&gt; dispatch({ type: 'setOn' })
const setOff = () =&gt; dispatch({ type: 'setOff' })

defineExpose({
  toggle,
  setOn,
  setOff
})
&lt;/script&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Toggle :reducer="toggleReducer" v-slot="{ on, toggle, setOn, setOff }"&gt;
    &lt;div class="toggle-demo"&gt;
      &lt;p&gt;状态: {{ on ? '开启' : '关闭' }}&lt;/p&gt;
      &lt;BaseButton @click="toggle"&gt;切换&lt;/BaseButton&gt;
      &lt;BaseButton @click="setOn"&gt;开启&lt;/BaseButton&gt;
      &lt;BaseButton @click="setOff"&gt;关闭&lt;/BaseButton&gt;
    &lt;/div&gt;
  &lt;/Toggle&gt;
&lt;/template&gt;

&lt;script setup&gt;
const toggleReducer = (state, action) =&gt; {
  switch (action.type) {
    case 'toggle':
      // 添加日志记录
      console.log('Toggle state changed:', !state.on)
      return { on: !state.on }
    case 'setOn':
      return { on: true }
    case 'setOff':
      return { on: false }
    default:
      return state
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-14">组件通信最佳实践</h3>
<h4 data-id="heading-15">1. Provide/Inject 模式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// theme.js</span>
<span class="hljs-keyword">import</span> { ref, readonly, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> themeSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'theme'</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createThemeStore</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> currentTheme = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'light'</span>)

  <span class="hljs-keyword">const</span> themes = {
    <span class="hljs-attr">light</span>: {
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'#42b883'</span>,
      <span class="hljs-attr">background</span>: <span class="hljs-string">'#ffffff'</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'#333333'</span>
    },
    <span class="hljs-attr">dark</span>: {
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'#42b883'</span>,
      <span class="hljs-attr">background</span>: <span class="hljs-string">'#1a1a1a'</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'#ffffff'</span>
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    currentTheme.<span class="hljs-property">value</span> = currentTheme.<span class="hljs-property">value</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>
  }

  <span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> themes[currentTheme.<span class="hljs-property">value</span>])

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">currentTheme</span>: <span class="hljs-title function_">readonly</span>(currentTheme),
    themeConfig,
    toggleTheme
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">provideTheme</span>(<span class="hljs-params">themeStore</span>) {
  <span class="hljs-title function_">provide</span>(themeSymbol, themeStore)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTheme</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> themeStore = <span class="hljs-title function_">inject</span>(themeSymbol)
  <span class="hljs-keyword">if</span> (!themeStore) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useTheme must be used within provideTheme'</span>)
  }
  <span class="hljs-keyword">return</span> themeStore
}
</code></pre>
<h4 data-id="heading-16">2. Event Bus 替代方案</h4>
<p>使用 mitt 库替代传统的事件总线：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eventBus.js</span>
<span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eventBus = <span class="hljs-title function_">mitt</span>()

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-comment">// eventBus.emit('user-login', userInfo)</span>
<span class="hljs-comment">// eventBus.on('user-login', handler)</span>
</code></pre>
<h3 data-id="heading-17">性能优化策略</h3>
<h4 data-id="heading-18">1. 组件懒加载</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router/index.js</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/heavy-component'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/HeavyComponent.vue'</span>)
  }
]

<span class="hljs-comment">// 组件内部懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyChart</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> 
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/charts/HeavyChart.vue'</span>)
)
</code></pre>
<h4 data-id="heading-19">2. 虚拟滚动</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- VirtualList.vue --&gt;
&lt;template&gt;
  &lt;div 
    ref="containerRef" 
    class="virtual-list"
    @scroll="handleScroll"
  &gt;
    &lt;div :style="{ height: totalHeight + 'px' }" class="virtual-list__spacer"&gt;
      &lt;div 
        :style="{ transform: `translateY(${offsetY}px)` }"
        class="virtual-list__content"
      &gt;
        &lt;div
          v-for="item in visibleItems"
          :key="item.id"
          :style="{ height: itemHeight + 'px' }"
          class="virtual-list__item"
        &gt;
          &lt;slot :item="item" /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, computed, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  items: {
    type: Array,
    required: true
  },
  itemHeight: {
    type: Number,
    default: 50
  },
  bufferSize: {
    type: Number,
    default: 5
  }
})

const containerRef = ref(null)
const scrollTop = ref(0)

const totalHeight = computed(() =&gt; props.items.length * props.itemHeight)

const startIndex = computed(() =&gt; {
  return Math.max(0, Math.floor(scrollTop.value / props.itemHeight) - props.bufferSize)
})

const endIndex = computed(() =&gt; {
  const containerHeight = containerRef.value?.clientHeight || 0
  return Math.min(
    props.items.length - 1,
    Math.floor((scrollTop.value + containerHeight) / props.itemHeight) + props.bufferSize
  )
})

const visibleItems = computed(() =&gt; {
  return props.items.slice(startIndex.value, endIndex.value + 1)
})

const offsetY = computed(() =&gt; {
  return startIndex.value * props.itemHeight
})

const handleScroll = () =&gt; {
  scrollTop.value = containerRef.value.scrollTop
}

onMounted(() =&gt; {
  // 初始化滚动监听
})

onUnmounted(() =&gt; {
  // 清理资源
})
&lt;/script&gt;

&lt;style scoped&gt;
.virtual-list {
  height: 400px;
  overflow-y: auto;
  border: 1px solid #e5e5e5;
}

.virtual-list__spacer {
  position: relative;
}

.virtual-list__content {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

.virtual-list__item {
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid #f0f0f0;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-20">测试友好的组件设计</h3>
<h4 data-id="heading-21">1. 明确的 Props 定义</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Button.test.js</span>
<span class="hljs-keyword">import</span> { mount } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/test-utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/BaseButton.vue'</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'BaseButton'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-string">'renders slot content'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>, {
      <span class="hljs-attr">slots</span>: {
        <span class="hljs-attr">default</span>: <span class="hljs-string">'Click me'</span>
      }
    })
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Click me'</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">'emits click event when clicked'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>)
    <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">emitted</span>()).<span class="hljs-title function_">toHaveProperty</span>(<span class="hljs-string">'click'</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">'applies correct CSS classes based on props'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>, {
      <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">variant</span>: <span class="hljs-string">'primary'</span>,
        <span class="hljs-attr">size</span>: <span class="hljs-string">'large'</span>
      }
    })
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">classes</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'btn--primary'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">classes</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'btn--large'</span>)
  })
})
</code></pre>
<h4 data-id="heading-22">2. 可访问性考虑</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- AccessibleModal.vue --&gt;
&lt;template&gt;
  &lt;teleport to="body"&gt;
    &lt;div 
      v-if="visible"
      ref="modalRef"
      role="dialog"
      aria-modal="true"
      :aria-labelledby="titleId"
      :aria-describedby="descriptionId"
      class="modal"
      @keydown.esc="close"
    &gt;
      &lt;div class="modal__overlay" @click="close"&gt;&lt;/div&gt;
      &lt;div class="modal__content" ref="contentRef"&gt;
        &lt;div class="modal__header"&gt;
          &lt;h2 :id="titleId" class="modal__title"&gt;{{ title }}&lt;/h2&gt;
          &lt;button 
            type="button"
            class="modal__close"
            @click="close"
            aria-label="关闭对话框"
          &gt;
            ×
          &lt;/button&gt;
        &lt;/div&gt;
      
        &lt;div :id="descriptionId" class="modal__body"&gt;
          &lt;slot /&gt;
        &lt;/div&gt;
      
        &lt;div v-if="$slots.footer" class="modal__footer"&gt;
          &lt;slot name="footer" /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/teleport&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, watch, nextTick } from 'vue'

const props = defineProps({
  visible: {
    type: Boolean,
    default: false
  },
  title: {
    type: String,
    required: true
  }
})

const emit = defineEmits(['update:visible', 'close'])

const modalRef = ref(null)
const contentRef = ref(null)
const titleId = `modal-title-${Math.random().toString(36).substr(2, 9)}`
const descriptionId = `modal-desc-${Math.random().toString(36).substr(2, 9)}`

const close = () =&gt; {
  emit('update:visible', false)
  emit('close')
}

watch(() =&gt; props.visible, async (newVal) =&gt; {
  if (newVal) {
    await nextTick()
    // 自动聚焦到模态框
    contentRef.value?.focus()
  }
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-23">结语</h3>
<p>Vue 3 组件开发的最佳实践涉及多个方面，从基础的 Props 和插槽使用，到高级的设计模式如 Renderless 组件和 Compound Components，每种模式都有其适用场景。关键是要根据具体需求选择合适的设计模式，并遵循以下原则：</p>
<ol>
<li><strong>保持组件简洁</strong>：每个组件专注于单一功能</li>
<li><strong>提供良好的 API</strong>：清晰的 Props 定义和事件接口</li>
<li><strong>重视可访问性</strong>：确保所有用户都能正常使用组件</li>
<li><strong>考虑性能影响</strong>：特别是在处理大量数据或复杂交互时</li>
<li><strong>便于测试</strong>：设计易于测试的组件接口</li>
</ol>
<p>通过合理运用这些设计模式和最佳实践，我们可以构建出既灵活又可靠的组件库，为整个应用提供一致且高质量的用户体验。记住，好的组件设计不是一次性的任务，而是需要在实践中不断迭代和完善的过程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式事务及实现方案]]></title>    <link>https://juejin.cn/post/7582601349580046336</link>    <guid>https://juejin.cn/post/7582601349580046336</guid>    <pubDate>2025-12-12T09:08:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582601349580046336" data-draft-id="7576479344040083508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式事务及实现方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T09:08:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="atwednesday"/> <meta itemprop="url" content="https://juejin.cn/user/35646320687101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式事务及实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/35646320687101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    atwednesday
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:08:20.000Z" title="Fri Dec 12 2025 09:08:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>文章主要参考的是<a href="https://link.juejin.cn?target=https%3A%2F%2Fpdai.tech%2Fmd%2Farch%2Farch-z-transection.html" target="_blank" title="https://pdai.tech/md/arch/arch-z-transection.html" ref="nofollow noopener noreferrer">分布式系统 - 分布式事务及实现方案</a>，之所以二次编辑，是为了增加部分自己理解的内容。</p>
<h2 data-id="heading-1">什么是事务</h2>
<p>参考文章<a href="https://juejin.cn/post/7576676694783606818" target="_blank" title="https://juejin.cn/post/7576676694783606818">事务</a></p>
<h2 data-id="heading-2">什么是分布式事务</h2>
<p>分布式事务是指在分布式系统中需要保证原子性、隔离性、一致性和持久性的一个或多个数据库操作。而且这些操作可能是位于不同的服务中。</p>
<h3 data-id="heading-3">从分布式的理论的角度看</h3>
<ul>
<li>
<p><strong>分布式理论的CP</strong> -&gt; 刚性事务</p>
<ul>
<li>遵循ACID，对数据要求强一致性</li>
</ul>
</li>
<li>
<p><strong>分布式理论的AP+BASE</strong> -&gt; 柔性事务</p>
<ul>
<li>遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">分布式事务体系</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    %% --- 样式定义 (去掉分号，防止解析错误) ---
    classDef rootFill fill:#800000,stroke:#333,stroke-width:2px,color:#fff
    classDef orangeFill fill:#E65100,stroke:#333,stroke-width:1px,color:#fff
    classDef greenFill fill:#43A047,stroke:#333,stroke-width:1px,color:#fff
    classDef blueFill fill:#01579B,stroke:#333,stroke-width:1px,color:#fff
    classDef purpleFill fill:#6200EA,stroke:#333,stroke-width:1px,color:#fff
    classDef yellowFill fill:#FBC02D,stroke:#333,stroke-width:1px,color:#333

    %% --- 主树结构 ---
    Root["分布式事务"]:::rootFill

    %% 第一层
    Tech["技术方案"]:::orangeFill
    Mid["中间件"]:::orangeFill
    Root --&gt; Tech
    Root --&gt; Mid

    %% --- 技术方案分支 ---
    XA["基于XA协议&lt;br/&gt;(DB层)"]:::greenFill
    Comp["基于补偿&lt;br/&gt;(业务层)"]:::blueFill
    Final["基于最终一致性"]:::blueFill

    Tech --&gt; XA
    Tech --&gt; Comp
    Tech --&gt; Final

    %% XA 细节
    TwoPC["2PC"]:::greenFill
    ThreePC["3PC"]:::greenFill
    JTA["JTA,JTS"]:::greenFill

    XA --&gt; TwoPC
    XA -- "Java规范和实现" --&gt; JTA
    TwoPC -- "优化" --&gt; ThreePC

    %% 补偿 细节
    TCC_Biz["TCC"]:::blueFill
    Saga_Biz["Saga"]:::blueFill
    Comp --&gt; TCC_Biz
    Comp --&gt; Saga_Biz

    %% 最终一致性 细节
    MsgTable["消息表"]:::blueFill
    MsgQueue["消息队列"]:::blueFill
    BestEffort["最大努力通知"]:::blueFill
    Final --&gt; MsgTable
    Final --&gt; MsgQueue
    Final --&gt; BestEffort

    %% --- 中间件分支 ---
    Atomiks["Atomiks"]:::greenFill
    Seata["Seata"]:::orangeFill
    TXLCN["TX-LCN"]:::orangeFill
    Other["..."]:::orangeFill

    Mid --&gt; Atomiks
    Mid --&gt; Seata
    Mid --&gt; TXLCN
    Mid --&gt; Other

    %% 中间件子节点
    Atom_XA["XA"]:::greenFill
    Atomiks --&gt; Atom_XA

    Seata_XA["XA"]:::greenFill
    Seata_AT["AT"]:::greenFill
    Seata_TCC["TCC"]:::blueFill
    Seata_Saga["Saga"]:::blueFill
    Seata --&gt; Seata_XA
    Seata --&gt; Seata_AT
    Seata --&gt; Seata_TCC
    Seata --&gt; Seata_Saga

    LCN_LCN["LCN"]:::yellowFill
    LCN_TCC["TCC"]:::blueFill
    LCN_TXC["TXC"]:::yellowFill
    TXLCN --&gt; LCN_LCN
    TXLCN --&gt; LCN_TCC
    TXLCN --&gt; LCN_TXC

    %% --- 底部理论部分 ---
    %% 使用子图将底部理论框起来，并保证逻辑清晰

    subgraph Theory["从分布式理论理解"]
        direction LR
        TheoryRoot["从分布式理论理解"]:::purpleFill
        
        Rigid["CP + ACID =&gt; 刚性事务"]:::greenFill
        Soft["AP + BASE =&gt; 柔性事务"]:::blueFill
        
        ApplyDB["适用数据库层"]:::greenFill
        ApplyBiz["适用业务层"]:::blueFill

        TheoryRoot --&gt; Rigid --&gt; ApplyDB
        TheoryRoot --&gt; Soft --&gt; ApplyBiz
    end
</code></pre>
<p><strong>刚性事务：</strong> 分布式理论的CP，遵循ACID，对数据要求强一致性。</p>
<ul>
<li>
<p><strong>XA协议</strong> 是一个基于数据库层面的分布式事务协议，它定义了两个角色如何配合工作：</p>
<ul>
<li><strong>事务管理器 (Transaction Manager, TM)</strong> ：即“协调者/指挥官”。它负责统筹全局，指挥各个数据库是该提交还是回滚。</li>
<li><strong>本地资源管理器 (Resource Manager, RM)</strong> ：即“参与者/干活的”。通常就是指数据库本身（如 MySQL, Oracle）。</li>
</ul>
<p><strong>二阶段提交 (2PC)</strong> ：是基于 XA 接口的具体<strong>执行流程</strong>。</p>
<ol>
<li><strong>第一阶段（准备/投票阶段）</strong> ：协调者问所有参与者：“你们都能执行成功吗？”参与者执行操作但不提交，锁住资源，然后告诉协调者：“我可以”或“我不行”。</li>
<li><strong>第二阶段（提交/执行阶段）</strong> ：
<ul>
<li>
<p>如果大家都说“我可以”，协调者下令：“全体提交 (Commit)！”</p>
</li>
<li>
<p>只要有一个说“我不行”，协调者下令：“全体回滚 (Rollback)！”</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<ol>
<li><strong>如果 <code>prepare</code> 返回 YES，但 <code>commit</code> 阶段硬件出问题了怎么办？</strong></li>
</ol>
<p>    一旦参与者在 <code>prepare</code> 阶段返回了 <code>YES</code>，它就<strong>失去了对自己命运的掌控权</strong>。它必须无条件服从协调者（Coordinator）的最终决定。它承诺了：“我已经准备好了，只要你一声令下，我随时可以提交，也随时可以回滚。”</p>
<p>    <strong>如果是短暂宕机（如重启）</strong> ：数据库重启后，会检查事务日志（WAL）。它会发现有一条处于 <code>Prepared</code> 状态但没有 <code>Commit</code> 标记的记录（即**“不决状态” In-Doubt Transaction**）。此时，它必须主动去联系协调者：“喂，刚才那个 XID 的事务，大家最后到底是提交了还是回滚了？”</p>
<ul>
<li>如果协调者说“提交”，它就补做提交。</li>
<li>如果协调者说“回滚”，它就补做回滚。</li>
</ul>
<p>    <strong>如果是协调者也挂了</strong>：这就是最坏的情况。参与者联系不上协调者，不知道其他兄弟节点是成功还是失败了。为了保证数据一致性（不能别人回滚了我却提交了），它<strong>只能阻塞等待</strong>，一直持有锁，直到协调者恢复。这通常需要人工介入（DBA 手动强行 Commit 或 Rollback）。</p>
<ol start="2">
<li><strong><code>p.prepare()</code> 和 <code>p.commit()</code> 中间一直在锁着资源吗？</strong>
<strong>一直锁着。</strong> 这正是 2PC 性能差的根本原因。</li>
</ol>
</blockquote>
<p><strong>三阶段提交 (2PC)</strong> ：是基于 XA 接口的具体<strong>执行流程</strong>。</p>
<ol>
<li><strong>第一阶段（询问阶段）</strong>：协调者问：“大家身体健康吗？网络通吗？能接单吗？”。参与者答：Yes/No。</li>
<li><strong>第二阶段（预提交阶段）</strong>：如果第一阶段大家都说 Yes。协调者说：“好，现在大家开始<strong>锁资源、写日志</strong>（执行事务逻辑），但<strong>别提交</strong>！如果我后面不理你们了，你们就自己看着办。”</li>
<li><strong>第三阶段（提交阶段）</strong>：
<ul>
<li>
<p>如果大家都说“我可以”，协调者下令：“全体提交 (Commit)！”</p>
</li>
<li>
<p>只要有一个说“我不行”，协调者下令：“全体回滚 (Rollback)！”</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<ol>
<li>如果第一阶段大家都说 No，但是协调者挂了，怎么办？</li>
</ol>
<p>此时参与者将无法正常收到消息，但在分布式系统中， <strong>“没有收到消息”</strong> 有两种可能：</p>
<ul>
<li>协调者挂了（3PC 赌的是这个）。</li>
<li>协调者没挂，只是网络断了，而且协调者其实刚刚决定了要 Abort。
一旦协调者挂了，在等待一段时间后，参与者会默认提交对应的事务。导致数据一致性问题。</li>
</ul>
</blockquote>
</li>
</ul>
<p><strong>柔性事务</strong>：分布式理论的AP，遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</p>
<ul>
<li><strong>TCC</strong>: TCC（Try-Confirm-Cancel）又被称补偿事务，TCC与2PC的思想很相似，事务处理流程也很相似，但2PC是应用于在DB层面，TCC则可以理解为在应用层面的2PC，是需要我们编写业务逻辑来实现。
<blockquote>
<p>在 2PC (XA) 中，只需要告诉数据库 <code>Prepare</code>（准备）和 <code>Commit</code>（提交）。如果在 <code>Prepare</code> 阶段失败了，<strong>数据库引擎</strong>会自动利用 Undo Log 把数据回滚回去。不需要写代码去恢复数据。</p>
<p><strong>“应用层面”<strong>的意思是：事务的控制权掌握在</strong>代码 (Business Logic)</strong> 手里。数据库把普通的本地事务处理完了，这个过程中程序员需要利用好本地事务。</p>
</blockquote>
</li>
<li><strong>SAGA</strong>：Saga是由一系列的本地事务构成。每一个本地事务在更新完数据库之后，会发布一条消息或者一个事件来触发Saga中的下一个本地事务的执行。如果一个本地事务因为某些业务规则无法满足而失败，Saga会执行在这个失败的事务之前成功提交的所有事务的补偿操作。Saga的实现有很多种方式，其中最流行的两种方式是：基于事件的方式和基于命令的方式。</li>
<li><strong>最终一致性</strong>
<ul>
<li><strong>消息表</strong>：本地消息表的方案最初是由 eBay 提出，核心思路是将分布式事务拆分成本地事务进行处理。</li>
<li><strong>消息队列</strong>：基于 MQ 的分布式事务方案其实是对本地消息表的封装，将本地消息表基于 MQ 内部，其他方面的协议基本与本地消息表一致。</li>
<li><strong>最大努力通知</strong>：最大努力通知也称为定期校对，是对MQ事务方案的进一步优化。它在事务主动方增加了消息校对的接口，如果事务被动方没有接收到消息，此时可以调用事务主动方提供的消息校对的接口主动获取。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">分布式事务方案之刚性事务</h2>
<p>说到刚性事务，首先要讲的是XA协议。</p>
<p>XA协议是一个基于 <strong>数据库</strong> 的分布式事务协议，其分为两部分：<strong>事务管理器（Transaction Manager）</strong> 和 <strong>本地资源管理器（Resource Manager）</strong> 。事务管理器作为一个全局的调度者，负责对各个本地资源管理器统一号令提交或者回滚。<code>二阶提交协议（2PC）</code>和<code>三阶提交协议（3PC）</code>就是根据此协议衍生出来而来。主流的诸如Oracle、MySQL等数据库均已实现了XA接口。</p>
<h3 data-id="heading-6">两段提交（2PC）</h3>
<blockquote>
<p>引入一个作为协调者（coordinator）的组件来统一掌控所有参与者（participant）的操作结果，并最终指示这些节点是否要把操作结果进行真正的提交。</p>
</blockquote>
<ul>
<li>
<p><em>第一阶段</em>: 准备阶段；</p>
<ul>
<li>协调者向所有参与者发送 REQUEST-TO-PREPARE</li>
<li>当参与者收到REQUEST-TO-PREPARE 消息后, 它向协调者发送消息PREPARED或者NO，表示事务是否准备好；如果发送的是NO，那么事务要回滚；</li>
</ul>
</li>
<li>
<p><em>第二阶段</em>: 提交阶段。</p>
<ul>
<li>协调者收集所有参与者的返回消息, 如果所有的参与者都回复的是PREPARED， 那么协调者向所有参与者发送COMMIT 消息；否则，协调者向所有回复PREPARED的参与者发送ABORT消息；</li>
<li>参与者如果回复了PREPARED消息并且收到协调者发来的COMMIT消息，或者它收到ABORT消息，它将执行提交或回滚，并向协调者发送DONE消息以确认。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65f1be6556094b54900bdfb3dd26e96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=VV3qwLec4ZR3OYfq5XKuVTSyRiI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>两段提交（2PC）的缺点</strong>：</p>
<p>二阶段提交看似能够提供原子性的操作，但它存在着严重的缺陷：</p>
<ul>
<li><strong>网络抖动导致的数据不一致</strong>：第二阶段中协调者向参与者发送commit命令之后，一旦此时发生网络抖动，导致一部分参与者接收到了commit请求并执行，可其他未接到commit请求的参与者无法执行事务提交。进而导致整个分布式系统出现了数据不一致。</li>
<li><strong>超时导致的同步阻塞问题</strong>：2PC中的所有的参与者节点都为事务阻塞型，当某一个参与者节点出现通信超时，其余参与者都会被动阻塞占用资源不能释放。</li>
<li><strong>单点故障的风险</strong>：由于严重的依赖协调者，一旦协调者发生故障，而此时参与者还都处于锁定资源的状态，无法完成事务commit操作。虽然协调者出现故障后，会重新选举一个协调者，可无法解决因前一个协调者宕机导致的参与者处于阻塞状态的问题。</li>
</ul>
<h3 data-id="heading-7">三段提交（3PC）</h3>
<blockquote>
<p>三段提交（3PC）是对两段提交（2PC）的一种升级优化，<strong>3PC在2PC的第一阶段和第二阶段中插入一个准备阶段</strong>。保证了在最后提交阶段之前，各参与者节点的状态都一致。同时在协调者和参与者中都引入超时机制，当参与者各种原因未收到协调者的commit请求后，会对本地事务进行commit，不会一直阻塞等待，解决了2PC的单点故障问题，但3PC还是没能从根本上解决数据一致性的问题。</p>
</blockquote>
<p><strong>3PC的三个阶段分别是CanCommit、PreCommit、DoCommit</strong>：</p>
<ul>
<li><strong>CanCommit</strong>：协调者向所有参与者发送CanCommit命令，询问是否可以执行事务提交操作。如果全部响应YES则进入下一个阶段。</li>
<li><strong>PreCommit</strong>：协调者向所有参与者发送PreCommit命令，询问是否可以进行事务的预提交操作，参与者接收到PreCommit请求后，如参与者成功的执行了事务操作，则返回Yes响应，进入最终commit阶段。一旦参与者中有向协调者发送了No响应，或因网络造成超时，协调者没有接到参与者的响应，协调者向所有参与者发送abort请求，参与者接受abort命令执行事务的中断。</li>
<li><strong>DoCommit</strong>：在前两个阶段中所有参与者的响应反馈均是YES后，协调者向参与者发送DoCommit命令正式提交事务，如协调者没有接收到参与者发送的ACK响应，会向所有参与者发送abort请求命令，执行事务的中断。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9584d6277667455e8f25368bb7fc82ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=cD83vQPRT1B0OrIw%2F0U9NY%2FuSl8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>3PC存在的问题</strong></p>
<p>3PC工作在同步网络模型上，它假设消息传输时间是有上界的，只存在机器失败而不存在消息失败。这个假设太强，现实的情形是，机器失败是无法完美地检测出来的，消息传输可能因为网络拥堵花费很多时间。同时, 说阻塞是相对, 存在协调者和参与者同时失败的情形下, 3PC事务依然会阻塞。实际上，很少会有系统实现3PC，多数现实的系统会通过复制状态机解决2PC阻塞的问题。比如，如果失败模型不是失败-停止, 而是消息失败（消息延迟或网络分区），那样3PC会产生不一致的情形。</p>
<p><strong>3PC小结</strong></p>
<blockquote>
<p><em>3PC并没有完美解决2PC的阻塞，也引入了新的问题（不一致问题），所以3PC很少会被真正的使用</em>。</p>
</blockquote>
<h2 data-id="heading-8">分布式事务方案之柔性事务</h2>
<blockquote>
<p>柔性事务：分布式理论的AP，遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</p>
</blockquote>
<h3 data-id="heading-9">补偿事务 (TCC)</h3>
<blockquote>
<p>TCC（Try-Confirm-Cancel）又被称补偿事务，TCC与2PC的思想很相似，事务处理流程也很相似，但<strong>2PC是应用于在DB层面，TCC则可以理解为在应用层面的2PC，是需要我们编写业务逻辑来实现</strong>。</p>
</blockquote>
<p>TCC它的核心思想是："针对每个操作都要注册一个与其对应的确认（Try）和补偿（Cancel）"。</p>
<p>还拿下单扣库存解释下它的三个操作：</p>
<ul>
<li><strong>Try阶段</strong>：下单时通过Try操作去扣除库存预留资源。</li>
<li><strong>Confirm阶段</strong>：确认执行业务操作，在只预留的资源基础上，发起购买请求。</li>
<li><strong>Cancel阶段</strong>：只要涉及到的相关业务中，有一个业务方预留资源未成功，则取消所有业务资源的预留请求。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad3a7365a8140c0bf59e1ccaeafcc53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=uYBwiJvy507DP1rkiz5EIoZWONk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>TCC的缺点</strong>：</p>
<ol>
<li>
<p>空回滚</p>
<p>当一个分支事务所在的服务发生宕机或者网络异常导致调用失败，并未执行try方法，当恢复后事务执行回滚操作就会调用此分支事务的cancel方法,如果cancel方法不能处理此种情况就会出现空回滚。</p>
<p>是否出现空回滚，我们需要需要判断是否执行了try方法，如果执行了就没有空回滚。解决方法就是当主业务发起事务时，生成一个全局事务记录，并生成一个全局唯一ID，贯穿整个事务，再创建一张分支事务记录表，用于记录分支事务，try执行时将全局事务ID和分支事务ID存入分支事务表中，表示执行了try阶段，当cancel执行时，先判断表中是否有该全局事务ID的数据，如果有则回滚，否则不做任何操作。比如seata的AT模式中就有分支事务表。</p>
</li>
<li>
<p>幂等问题</p>
<p>由于服务宕机或者网络问题，方法的调用可能出现超时，为了保证事务正常执行我们往往会加入重试的机制，因此就需要保证confirm和cancel阶段操作的幂等性。</p>
<p>我们可以在分支事务记录表中增加事务执行状态，每次执行confirm和cancel方法时都查询该事务的执行状态，以此判断事务的幂等性。</p>
</li>
<li>
<p>悬挂问题</p>
<p>TCC中，在调用try之前会先注册分支事务，注册分支事务之后，调用出现超时，此时try请求还未到达对应的服务，因为调用超时了，所以会执行cancel调用，此时cancel已经执行完了，然而这个时候try请求到达了，这个时候执行了try之后就没有后续的操作了，就会导致资源挂起，无法释放。</p>
<p>执行try方法时我们可以判断confirm或者cancel方法是否执行，如果执行了那么就不执行try阶段。同样借助分支事务表中事务的执行状态。如果已经执行了confirm或者cancel那么try就执行。</p>
</li>
</ol>
<h3 data-id="heading-10">Saga事务</h3>
<p>Saga是由一系列的本地事务构成。每一个本地事务在更新完数据库之后，会发布一条消息或者一个事件来触发Saga中的下一个本地事务的执行。如果一个本地事务因为某些业务规则无法满足而失败，Saga会执行在这个失败的事务之前成功提交的所有事务的补偿操作。</p>
<p>Saga的实现有很多种方式，其中最流行的两种方式是：</p>
<ul>
<li><strong>基于事件的方式</strong>。这种方式没有协调中心，整个模式的工作方式就像舞蹈一样，各个舞蹈演员按照预先编排的动作和走位各自表演，最终形成一只舞蹈。处于当前Saga下的各个服务，会产生某类事件，或者监听其它服务产生的事件并决定是否需要针对监听到的事件做出响应。</li>
<li><strong>基于命令的方式</strong>。这种方式的工作形式就像一只乐队，由一个指挥家（协调中心）来协调大家的工作。协调中心来告诉Saga的参与方应该执行哪一个本地事务。</li>
</ul>
<p>我们继续以订单流程为例，说明一下该模式。</p>
<p>假设一个完整的订单流程包含了如下几个服务：</p>
<ol>
<li>Order Service：订单服务</li>
<li>Payment Service：支付服务</li>
<li>Stock Service：库存服务</li>
<li>Delivery Service：物流服务</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31b5eca0a8c54c3c8a5b13b0ac930dda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=2LiiwMOzv0NA6mzt2tydypSYFl8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">基于事件的方式</h4>
<p>在基于事件的方式中，第一个服务执行完本地事务之后，会产生一个事件。其它服务会监听这个事件，触发该服务本地事务的执行，并产生新的事件。</p>
<p>采用基于事件的saga模式的订单处理流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/361a50e422c144a3aef5584ee7ad8526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=N%2FuX7g%2BD8MxPtkGZn2UNxX72O10%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>订单服务创建一笔新订单，将订单状态设置为"待处理"，产生事件ORDER_CREATED_EVENT。</li>
<li>支付服务监听ORDER_CREATED_EVENT，完成扣款并产生事件BILLED_ORDER_EVENT。</li>
<li>库存服务监听BILLED_ORDER_EVENT，完成库存扣减和备货，产生事件ORDER_PREPARED_EVENT。</li>
<li>物流服务监听ORDER_PREPARED_EVENT，完成商品配送，产生事件ORDER_DELIVERED_EVENT。</li>
<li>订单服务监听ORDER_DELIVERED_EVENT，将订单状态更新为"完成"。</li>
</ul>
<p>在这个流程中，订单服务很可能还会监听BILLED_ORDER_EVENT，ORDER_PREPARED_EVENT来完成订单状态的实时更新。将订单状态分别更新为"已经支付"和"已经出库"等状态来及时反映订单的最新状态。</p>
<p><strong>该模式下分布式事务的回滚</strong></p>
<p>为了在异常情况下回滚整个分布式事务，我们需要为相关服务提供补偿操作接口。</p>
<p>假设库存服务由于库存不足没能正确完成备货，我们可以按照下面的流程来回滚整个Saga事务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b490d43e81c4c79b2a25802e0de66cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=UftlYvhJFKQkZTa%2BMtD3FWCzdy8%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>库存服务产生事件PRODUCT_OUT_OF_STOCK_EVENT。</li>
<li>订单服务和支付服务都会监听该事件并做出响应：
<ol>
<li>支付服务完成退款。</li>
<li>订单服务将订单状态设置为"失败"。</li>
</ol>
</li>
</ol>
<p><strong>基于事件方式的优缺点</strong></p>
<p><strong>优点</strong>：简单且容易理解。各参与方相互之间无直接沟通，完全解耦。这种方式比较适合整个分布式事务只有2-4个步骤的情形。</p>
<p><strong>缺点</strong>：这种方式如果涉及比较多的业务参与方，则比较容易失控。各业务参与方可随意监听对方的消息，以至于最后没人知道到底有哪些系统在监听哪些消息。更悲催的是，这个模式还可能产生环形监听，也就是两个业务方相互监听对方所产生的事件。</p>
<p>接下来，我们将介绍如何使用命令的方式来克服上面提到的缺点。</p>
<h4 data-id="heading-12">基于命令的方式</h4>
<p>在基于命令的方式中，我们会定义一个新的服务，这个服务扮演的角色就和一支交响乐乐队的指挥一样，告诉各个业务参与方，在什么时候做什么事情。我们管这个新服务叫做协调中心。协调中心通过命令/回复的方式来和Saga中其它服务进行交互。</p>
<p>我们继续以之前的订单流程来举例。下图中的Order Saga Orchestrator就是新引入的协调中心。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd85f7dda8d49a99cc4aa9fa379cd51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=ChKhKFxWMUZExWvvmbyBxKljafk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>订单服务创建一笔新订单，将订单状态设置为"待处理"，然后让Order Saga Orchestrator（OSO）开启创建订单事务。</li>
<li>OSO发送一个"支付命令"给支付服务，支付服务完成扣款并回复"支付完成"消息。</li>
<li>OSO发送一个"备货命令"给库存服务，库存服务完成库存扣减和备货，并回复"出库"消息。</li>
<li>OSO发送一个"配送命令"给物流服务，物流服务完成配送，并回复"配送完成"消息。</li>
<li>OSO向订单服务发送"订单结束命令"给订单服务，订单服务将订单状态设置为"完成"。</li>
<li>OSO清楚一个订单处理Saga的具体流程，并在出现异常时向相关服务发送补偿命令来回滚整个分布式事务。</li>
</ul>
<p>实现协调中心的一个比较好的方式是使用<strong>状态机(Sate Machine)</strong> 。</p>
<p><strong>该模式下分布式事务的回滚</strong></p>
<p>该模式下的回滚流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88bc3e6a2b4640399e044a653333bd10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=VpUopw9hJKUmC0inf8CRGTZFtts%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>库存服务回复OSO一个"库存不足"消息。</li>
<li>OSO意识到该分布式事务失败了，触发回滚流程：</li>
<li>OSO发送"退款命令"给支付服务，支付服务完成退款并回复"退款成功"消息。</li>
<li>OSO向订单服务发送"将订单状态改为失败命令"，订单服务将订单状态更新为"失败"。</li>
</ol>
<p><strong>基于命令方式的优缺点</strong></p>
<p>优点：</p>
<ol>
<li>避免了业务方之间的环形依赖。</li>
<li>将分布式事务的管理交由协调中心管理，协调中心对整个逻辑非常清楚。</li>
<li>减少了业务参与方的复杂度。这些业务参与方不再需要监听不同的消息，只是需要响应命令并回复消息。</li>
<li>测试更容易（分布式事务逻辑存在于协调中心，而不是分散在各业务方）。</li>
<li>回滚也更容易。</li>
</ol>
<p>缺点：</p>
<ol>
<li>一个可能的缺点就是需要维护协调中心，而这个协调中心并不属于任何业务方。</li>
</ol>
<h5 data-id="heading-13">Saga模式建议</h5>
<p>1，给每一个分布式事务创建一个唯一的Tx id。这个唯一的Tx id可以用来在各个业务参与方沟通时精确定位哪一笔分布式事务。
2，对于基于命令的方式，在命令中携带回复地址。这种方式可以让服务同时响应多个协调中心请求。
3，幂等性。幂等性能够增加系统的容错性，让各个业务参与方服务提供幂等性操作，能够在遇到异常情况下进行重试。
4，尽量在命令或者消息中携带下游处理需要的业务数据，避免下游处理时需要调用消息产生方接口获取更多数据。减少系统之间的相互依赖。</p>
<h3 data-id="heading-14">本地消息表</h3>
<blockquote>
<p>本地消息表核心思路是将分布式事务拆分成本地事务进行处理。</p>
</blockquote>
<p>角色：</p>
<ul>
<li>事务主动方</li>
<li>事务被动方</li>
</ul>
<p>通过在事务主动发起方额外新建事务消息表，事务发起方处理业务和记录事务消息在本地事务中完成，轮询事务消息表的数据发送事务消息，事务被动方基于消息中间件消费事务消息表中的事务。</p>
<p>这样可以避免以下两种情况导致的数据不一致性：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66837a1c30f4459f80d7c2db024a3bf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=leT52VQU8qQxZtCbIm8pFBztiy4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">场景描述</h4>
<ul>
<li><strong>上游服务</strong>：订单服务（Order Service），负责修改订单状态。</li>
<li><strong>下游服务</strong>：积分服务（Points Service），负责给用户增加积分。</li>
<li><strong>中间件</strong>：消息队列（MQ，如 RabbitMQ/RocketMQ）。</li>
<li><strong>目标</strong>：保证只要订单支付变成了“成功”，用户最终一定能收到积分，且不会多发。</li>
</ul>
<p>数据库包括：订单表，本地消息表，积分表。</p>
<p><strong>执行流程详解：</strong></p>
<ol>
<li>
<p>第一阶段：上游业务操作（利用本地事务的原子性）</p>
<p>当用户支付成功时，订单服务执行以下逻辑，<strong>重点是将这两步包裹在同一个数据库事务（Transaction）中</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启事务</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- 1. 更新订单状态为已支付</span>
<span class="hljs-keyword">UPDATE</span> t_order <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">101</span>;

<span class="hljs-comment">-- 2. 插入一条待发送的消息到本地消息表</span>
<span class="hljs-comment">-- 注意：此时消息并没有发给 MQ，只是存在数据库里</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_local_message (msg_id, content, status) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'uuid-123'</span>, <span class="hljs-string">'{"userId":888, "points":10}'</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">-- 提交事务</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<ul>
<li><strong>如果 Commit 成功</strong>：订单变了，消息也肯定在表里了。</li>
<li><strong>如果 Commit 失败/回滚</strong>：订单没变，消息表里也没数据。MQ 也不会收到消息。这就保证了<strong>强一致性</strong>。</li>
</ul>
</li>
<li>
<p>第二阶段：异步发送消息（依靠轮询/定时任务）</p>
<p>订单服务中有一个<strong>独立的后台线程（定时任务）</strong> ，专门处理 <code>t_local_message</code> 表：</p>
<ol>
<li><strong>查询</strong>：定时（比如每 5 秒）扫描 <code>t_local_message</code> 表中状态为 <code>0 (待发送)</code> 的记录。</li>
<li><strong>发送</strong>：将这些记录的内容发送到消息队列（MQ）。</li>
<li><strong>更新状态</strong>：
<ul>
<li>如果发送成功（MQ 返回 Ack），更新本地表状态为 <code>1 (已发送)</code>。</li>
<li>如果发送失败，更新 <code>retry_count + 1</code>，等待下次扫描重试。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>第三阶段：下游消费（依靠幂等性）</p>
</li>
</ol>
<p>积分服务监听 MQ：</p>
<ol>
<li><strong>接收消息</strong>：收到 <code>{"userId":888, "points":10}</code>。</li>
<li><strong>幂等检查</strong>：<strong>非常重要！</strong>
<ul>
<li>检查该 <code>msg_id</code> (uuid-123) 是否已经处理过。</li>
<li>如果处理过，直接返回成功（丢弃消息）。</li>
<li>如果没处理过，往下走。</li>
</ul>
</li>
<li><strong>执行业务</strong>：给用户 888 增加 10 积分。</li>
<li><strong>确认消息</strong>：向 MQ 发送 ACK，表示消费成功。</li>
</ol>
<p><strong>异常情况分析：</strong></p>
<ul>
<li><strong>情况 A：第一阶段数据库挂了</strong>
<ul>
<li>结果：事务回滚，订单没成功，消息也没写入。用户重试支付即可，数据一致。</li>
</ul>
</li>
<li><strong>情况 B：消息发送给 MQ 时网络断了</strong>
<ul>
<li>结果：第一阶段已提交，订单已成功。后台定时任务会发现这条消息还是 <code>0 (待发送)</code>，它会不断重试发送，直到 MQ 恢复。<strong>保证了消息最终一定能发出去</strong>。</li>
</ul>
</li>
<li><strong>情况 C：下游积分服务挂了</strong>
<ul>
<li>结果：MQ 会保留消息。等积分服务重启后，继续消费。</li>
</ul>
</li>
<li><strong>情况 D：消息重复发送了（定时任务刚发完，更新数据库失败，下次又发了一次）</strong>
<ul>
<li>结果：下游积分服务必须实现<strong>幂等性</strong>，通过唯一 <code>msg_id</code> 判断，发现处理过就不再加积分。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">MQ事务方案</h3>
<blockquote>
<p>基于 MQ 的分布式事务方案其实是对本地消息表的封装，将本地消息表基于 MQ 内部，其他方面的协议基本与本地消息表一致。</p>
</blockquote>
<p>MQ事务方案整体流程和本地消息表的流程很相似，如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/640d2b3bb4cb4bd9a526ee5d0d31818e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=m3fZwfS7otFhsaZe2iWUdXiXl9o%3D" alt="image.png" loading="lazy"/></p>
<p>从上图可以看出和本地消息表方案唯一不同就是将本地消息表存在了MQ内部，而不是业务数据库中。</p>
<p>那么MQ内部的处理尤为重要，下面主要基于 RocketMQ 4.3 之后的版本介绍 MQ 的分布式事务方案。</p>
<p>在本地消息表方案中，保证事务主动方发写业务表数据和写消息表数据的一致性是基于数据库事务，RocketMQ 的事务消息相对于普通 MQ提供了 2PC 的提交接口，方案如下：</p>
<p><strong>正常情况：事务主动方发消息</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9050d97b48d440fb9674283c7a685b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=oTtRafKlz7%2BGsBsZskrH53aA7U8%3D" alt="image.png" loading="lazy"/></p>
<p>这种情况下，事务主动方服务正常，没有发生故障，发消息流程如下：</p>
<ul>
<li>发送方向 MQ 服务端(MQ Server)发送 half 消息。</li>
<li>MQ Server 将消息持久化成功之后，向发送方 ack 确认消息已经发送成功。</li>
<li>发送方开始执行本地事务逻辑。</li>
<li>发送方根据本地事务执行结果向 MQ Server 提交二次确认（commit 或是 rollback）。</li>
<li>MQ Server 收到 commit 状态则将半消息标记为可投递，订阅方最终将收到该消息；MQ Server 收到 rollback 状态则删除半消息，订阅方将不会接受该消息。</li>
</ul>
<p><strong>异常情况：事务主动方消息恢复</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838ce8fe22d744f59c7a3a18286cad8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=5QruhGmBeCRIztHjzVFrL8jp5ug%3D" alt="image.png" loading="lazy"/></p>
<p>在断网或者应用重启等异常情况下，上图中提交的二次确认超时未到达 MQ Server，此时处理逻辑如下：</p>
<ul>
<li>MQ Server 对该消息发起消息回查。</li>
<li>发送方收到消息回查后，需要检查对应消息的本地事务执行的最终结果。</li>
<li>发送方根据检查得到的本地事务的最终状态再次提交二次确认。</li>
<li>MQ Server基于 commit/rollback 对消息进行投递或者删除。</li>
</ul>
<p><strong>优点</strong></p>
<p>相比本地消息表方案，MQ 事务方案优点是：</p>
<ul>
<li>消息数据独立存储 ，降低业务系统与消息系统之间的耦合。</li>
<li>吞吐量大于使用本地消息表方案。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>一次消息发送需要两次网络请求(half 消息 + commit/rollback 消息) 。</li>
<li>业务处理服务需要实现消息状态回查接口。</li>
</ul>
<h3 data-id="heading-17">最大努力通知</h3>
<blockquote>
<p>最大努力通知也称为定期校对，是对MQ事务方案的进一步优化。它在事务主动方增加了消息校对的接口，如果事务被动方没有接收到消息，此时可以调用事务主动方提供的消息校对的接口主动获取。</p>
</blockquote>
<p>最大努力通知的整体流程如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a430691aafcc4f5686fa9615addbc753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=TTFS4Rq0jppe1P1uB4HKdR36w0I%3D" alt="image.png" loading="lazy"/></p>
<p>在可靠消息事务中，事务主动方需要将消息发送出去，并且消息接收方成功接收，这种可靠性发送是由事务主动方保证的.</p>
<p>但是最大努力通知，事务主动方尽最大努力（重试，轮询....）将事务发送给事务接收方，但是仍然存在消息接收不到，此时需要事务被动方主动调用事务主动方的消息校对接口查询业务消息并消费，这种通知的可靠性是由事务被动方保证的。</p>
<p>最大努力通知适用于业务通知类型，例如微信交易的结果，就是通过最大努力通知方式通知各个商户，既有回调通知，也有交易查询接口。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务]]></title>    <link>https://juejin.cn/post/7582763878674579483</link>    <guid>https://juejin.cn/post/7582763878674579483</guid>    <pubDate>2025-12-12T09:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674579483" data-draft-id="7582777037863338034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务"/> <meta itemprop="keywords" content="后端,Go,ORM"/> <meta itemprop="datePublished" content="2025-12-12T09:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:10:11.000Z" title="Fri Dec 12 2025 09:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务</h2>
<p>本文将指导开发者在 GoWind Admin 企业级前后端一体中后台框架中，从零开始构建一个完整的 gRPC 服务。我们所指的 “服务” 即 gRPC 中的 service，通常包含特定数据集的 CRUD（增删改查）操作，遵循框架规范实现高可维护性与可扩展性。</p>
<h3 data-id="heading-1">前置准备</h3>
<p>在开始前，请确保已完成以下环境准备：</p>
<h4 data-id="heading-2">开发环境</h4>
<ul>
<li>Go 1.19+（推荐 1.21+，支持最新语言特性）</li>
<li>Git（版本控制）</li>
<li>Protobuf 编译器（<code>protoc</code>，用于编译 proto 文件）</li>
</ul>
<h4 data-id="heading-3">依赖工具</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装相关的命令行工具</span>
make cli

<span class="hljs-comment"># 安装依赖的插件</span>
make plugin
</code></pre>
<h4 data-id="heading-4">项目结构</h4>
<p>克隆 GoWind Admin 项目后，核心目录结构如下（聚焦服务开发相关目录）：</p>
<pre><code class="hljs language-text" lang="text">go-wind-admin/
├── backend/
│   ├── api/gen/go/        # proto 编译生成的 Go 代码（自动生成，无需手动修改）
│   ├── api/proto/         # 存放 proto 接口定义文件
│   ├── app/admin/service/ # 业务服务核心实现
│   │   ├── internal/
│   │   │   ├── data/      # 数据访问层（与数据库交互，基于 ent）
│   │   │   │   └── ent/   # ent ORM 自动生成的数据库操作代码
│   │   │   └── service/   # 业务逻辑层（实现 gRPC 接口）
│   │   └── server/        # 服务注册（将服务绑定到 gRPC/HTTP 服务器）
</code></pre>
<h3 data-id="heading-5">一、设计数据库表结构</h3>
<p>数据库表结构是服务的基础，需根据业务需求设计核心字段。以 “用户表” 为例，需包含：</p>
<ul>
<li>通用字段：ID（主键）、创建时间、更新时间、创建者 ID、更新者 ID（用于审计）</li>
<li>业务字段：用户名（唯一）、密码、昵称、邮箱、手机号等</li>
<li>关联字段：角色 ID、部门 ID 等（用于关联其他表）</li>
<li>状态字段：用户状态（启用 / 禁用）、性别等枚举字段</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>核心字段非空（如用户名），非核心字段可空（如地址）</li>
<li>频繁查询的字段添加索引（如用户名）</li>
<li>敏感字段（如密码）需加密存储</li>
</ul>
<h3 data-id="heading-6">二、编写 ent 的 schema</h3>
<p>Ent 是 Go 语言的 ORM 库，通过 schema 定义数据库实体。schema 文件位于 <code>backend/app/admin/service/internal/data/ent/schema</code> 目录。</p>
<p>步骤说明：</p>
<ol>
<li>创建 <code>user.go</code> 文件，定义 Us`er 结构体及其配置。</li>
<li>通过 <code>Annotations</code> 配置表名、字符集等数据库属性。</li>
<li>通过 <code>Fields</code> 定义表字段，包括类型、约束（唯一、非空等）、注释。</li>
<li>通过 <code>Mixin</code> 复用通用字段（如 ID、时间戳），减少重复代码。</li>
<li>通过 <code>Indexes</code> 定义索引，提升查询性能。</li>
</ol>
<h4 data-id="heading-7">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Annotations 配置表基本信息</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Annotations() []schema.Annotation {
    <span class="hljs-keyword">return</span> []schema.Annotation{
        entsql.Annotation{
            Table:     <span class="hljs-string">"sys_users"</span>, <span class="hljs-comment">// 数据库表名</span>
            Charset:   <span class="hljs-string">"utf8mb4"</span>,   <span class="hljs-comment">// 字符集</span>
            Collation: <span class="hljs-string">"utf8mb4_bin"</span>, <span class="hljs-comment">// 排序规则</span>
        },
        schema.Comment(<span class="hljs-string">"用户表"</span>), <span class="hljs-comment">// 表注释</span>
    }
}

<span class="hljs-comment">// Fields 定义表字段</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Fields() []ent.Field {
    <span class="hljs-keyword">return</span> []ent.Field{
        field.String(<span class="hljs-string">"username"</span>).
            Comment(<span class="hljs-string">"用户名"</span>).
            Unique().       <span class="hljs-comment">// 唯一索引</span>
            NotEmpty().     <span class="hljs-comment">// 非空</span>
            Immutable(),    <span class="hljs-comment">// 创建后不可修改</span>

        field.String(<span class="hljs-string">"password"</span>).
            Comment(<span class="hljs-string">"登录密码"</span>).
            MaxLen(<span class="hljs-number">255</span>).    <span class="hljs-comment">// 最大长度</span>
            Sensitive(),    <span class="hljs-comment">// 敏感字段（日志中隐藏）</span>

        <span class="hljs-comment">// 其他字段...</span>
    }
}

<span class="hljs-comment">// Mixin 复用通用配置</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Mixin() []ent.Mixin {
    <span class="hljs-keyword">return</span> []ent.Mixin{
        mixin.AutoIncrementId{}, <span class="hljs-comment">// 自增 ID</span>
        mixin.TimeAt{},          <span class="hljs-comment">// 创建时间、更新时间</span>
        mixin.OperatorID{},      <span class="hljs-comment">// 创建者、更新者 ID</span>
    }
}
</code></pre>
<h4 data-id="heading-8">生成 ent 代码：</h4>
<p>编写完 schema 后，执行以下命令生成实体代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend/app/admin/service/
make ent
</code></pre>
<h3 data-id="heading-9">三、编写 gRPC 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 gRPC 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/user/service/v1</code> 目录。</p>
<h4 data-id="heading-10">步骤说明：</h4>
<ol>
<li>定义服务接口（<code>service UserService</code>），包含 CRUD 方法（如 <code>CreateUser</code>、<code>ListUser</code>）。</li>
<li>定义请求 / 响应消息（message），映射数据库字段和业务需求。</li>
<li>定义枚举（enum），如用户状态、性别等固定值类型。</li>
</ol>
<h4 data-id="heading-11">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/user/service/v1/user.proto

// 定义服务接口
service UserService {
  rpc ListUser (pagination.PagingRequest) returns (ListUserResponse); // 列表查询
  rpc GetUser (GetUserRequest) returns (User);                        // 详情查询
  rpc CreateUser (CreateUserRequest) returns (google.protobuf.Empty); // 创建
  rpc UpdateUser (UpdateUserRequest) returns (google.protobuf.Empty); // 更新
  rpc DeleteUser (DeleteUserRequest) returns (google.protobuf.Empty); // 删除
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-12">生成 Go 代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash">make api
</code></pre>
<h3 data-id="heading-13">四、编写 REST 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 REST 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/admin/service/v1</code> 目录。</p>
<h4 data-id="heading-14">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/admin/service/v1/i_user.proto

import "user/service/v1/user.proto";

// 用户管理服务
service UserService {
  // 获取用户列表
  rpc List (pagination.PagingRequest) returns (user.service.v1.ListUserResponse) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users"
    };
  }

  // 获取用户数据
  rpc Get (user.service.v1.GetUserRequest) returns (user.service.v1.User) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users/{id}"
      additional_bindings {
        get: "/admin/v1/users/username/{user_name}"
      }
    };
  }

  // 创建用户
  rpc Create (user.service.v1.CreateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/admin/v1/users"
      body: "*"
    };
  }

  // 更新用户
  rpc Update (user.service.v1.UpdateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/admin/v1/users/{id}"
      body: "*"
    };
  }

  // 删除用户
  rpc Delete (user.service.v1.DeleteUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/admin/v1/users/{id}"
    };
  }
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-15">生成代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成go代码</span>
make api
</code></pre>
<p>执行以下命令将 proto 转换为 OpenAPI文档（生成的文档位于<code>backend/app/admin/service/cmd/server/assets/</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成OpenAPI文档</span>
make openapi
</code></pre>
<p>执行以下命令将 proto 转换为 TypeScript代码（生成的代码位于<code>frontend/apps/admin/src/generated/api</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成TypeScript代码</span>
make ts
</code></pre>
<h3 data-id="heading-16">五、编写 data 包（数据访问层）</h3>
<p><code>data</code> 包负责与数据库交互，实现 CRUD 操作，是业务逻辑与数据库之间的桥梁。代码位于 <code>backend/app/admin/service/internal/data</code> 目录。</p>
<h4 data-id="heading-17">核心职责：</h4>
<ul>
<li>封装 ent 的数据库操作（查询、插入、更新、删除）。</li>
<li>实现 ent 实体与 proto 消息的转换（如 <code>convertEntToProto</code>）。</li>
<li>处理数据访问过程中的错误（如记录日志、返回业务错误）。</li>
</ul>
<h4 data-id="heading-18">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">struct</span> {
	data *Data
	log  *log.Helper

	mapper             *mapper.CopierMapper[userV1.User, ent.User]
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepo</span><span class="hljs-params">(logger log.Logger, data *Data)</span></span> *UserRepo {
	repo := &amp;UserRepo{
		log:                log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"user/repo/admin-service"</span>)),
		data:               data,
		mapper:             mapper.NewCopierMapper[userV1.User, ent.User](),
	}

	<span class="hljs-keyword">return</span> repo
}

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> req == <span class="hljs-literal">nil</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"invalid parameter"</span>)
	}

	<span class="hljs-keyword">if</span> req.Data.Password != <span class="hljs-literal">nil</span> &amp;&amp; req.Data.GetPassword() != <span class="hljs-string">""</span> {
		cryptoPassword, err := crypto.HashPassword(req.Data.GetPassword())
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		req.Data.Password = &amp;cryptoPassword
	}

    <span class="hljs-comment">// 调用 ent 插入数据</span>
    <span class="hljs-keyword">return</span> r.data.db.Client().User.Create().
        SetUsername(req.Data.Username).
        SetPassword(req.Data.GetPassword()).
        <span class="hljs-comment">// 设置其他字段...</span>
        Exec(ctx)
}
</code></pre>
<h3 data-id="heading-19">六、编写 service 包（业务逻辑层）</h3>
<p>service 包实现核心业务逻辑，调用 data 包进行数据操作，并处理权限校验、参数校验等业务规则。代码位于 <code>backend/app/admin/service/internal/service</code> 目录。</p>
<h4 data-id="heading-20">核心职责：</h4>
<ul>
<li>校验请求参数合法性（如非空检查）。</li>
<li>实现业务规则（如 “禁止删除超级管理员”）。</li>
<li>调用 data 包完成数据操作，并返回结果。</li>
</ul>
<h4 data-id="heading-21">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建用户（包含权限校验）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 参数校验</span>
    <span class="hljs-keyword">if</span> req.Data == <span class="hljs-literal">nil</span> || req.Data.Username == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"用户名不能为空"</span>)
    }

    <span class="hljs-comment">// 权限校验：只有管理员能创建用户</span>
    operator, err := s.userRepo.GetUser(ctx, req.OperatorId)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || operator.Authority != userV1.UserAuthority_SYS_ADMIN {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"权限不足"</span>)
    }

    <span class="hljs-comment">// 调用 data 包创建用户</span>
    <span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, s.userRepo.CreateUser(ctx, req)
}
</code></pre>
<h3 data-id="heading-22">七、注册服务到 Server</h3>
<p>最后需将服务注册到 gRPC 或 REST 服务器，使客户端能访问服务。注册代码位于 <code>backend/app/admin/service/server</code> 目录。</p>
<h4 data-id="heading-23">gRPC 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/grpc"</span>
)

<span class="hljs-comment">// 注册 gRPC 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *grpc.Server {
    srv := grpc.NewServer()

    <span class="hljs-comment">// 将 UserService 注册到 gRPC 服务器</span>
    userV1.RegisterUserServiceServer(srv, userSvc)

    <span class="hljs-keyword">return</span> srv
}
</code></pre>
<h4 data-id="heading-24">REST 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/http"</span>
)

<span class="hljs-comment">// 注册 REST 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *http.Server {
	<span class="hljs-keyword">if</span> cfg == <span class="hljs-literal">nil</span> || cfg.Server == <span class="hljs-literal">nil</span> || cfg.Server.Rest == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	srv := rpc.CreateRestServer(cfg)
   
	<span class="hljs-comment">// 将 UserService 注册到 REST 服务器</span>
	adminV1.RegisterUserServiceHTTPServer(srv, userSvc)

	<span class="hljs-keyword">return</span> srv
}
</code></pre>
<h3 data-id="heading-25">八、测试新服务</h3>
<p>服务开发完成后，需验证功能正确性：</p>
<h4 data-id="heading-26">1. <strong>单元测试：</strong></h4>
<p>测试 data 包和 service 包的核心方法（使用 Go 内置测试框架）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/service/user_service_test.go</span>
<span class="hljs-keyword">package</span> service_test

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"testing"</span>

    <span class="hljs-string">"github.com/stretchr/testify/assert"</span>
    userV1 <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"go-wind-admin/mocks"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCreateUser</span><span class="hljs-params">(t *testing.T)</span></span> {
    <span class="hljs-comment">// 初始化 mock 依赖</span>
    mockUserRepo := mocks.NewUserRepo(t)
    svc := service.NewUserService(mockUserRepo, <span class="hljs-literal">nil</span>)

    <span class="hljs-comment">// 测试用例：用户名空</span>
    req := &amp;userV1.CreateUserRequest{Password: <span class="hljs-string">"12345678"</span>}
    _, err := svc.CreateUser(context.Background(), req)
    assert.ErrorContains(t, err, <span class="hljs-string">"用户名不能为空"</span>)

    <span class="hljs-comment">// 其他测试用例...</span>
}
</code></pre>
<h4 data-id="heading-27">2. <strong>接口测试：</strong></h4>
<h5 data-id="heading-28">gRPC 接口</h5>
<p>使用 <code>grpcurl</code> 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出服务接口</span>
grpcurl -plaintext localhost:9000 list admin.service.v1.UserService

<span class="hljs-comment"># 调用创建用户接口</span>
grpcurl -plaintext -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span> \
  localhost:9000 admin.service.v1.UserService/CreateUser
</code></pre>
<h5 data-id="heading-29">HTTP 接口</h5>
<p>使用 curl 或 Postman 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建用户</span>
curl -X POST http://localhost:8080/admin/v1/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span>
</code></pre>
<h3 data-id="heading-30">总结</h3>
<p>通过以上步骤，我们完成了一个新服务从数据库设计到接口暴露的全流程实现。GoWind Admin 框架的分层架构（schema → data → service → server）确保了代码的低耦合与高可维护性：</p>
<ul>
<li><strong>schema 层</strong>：通过 ent 定义数据结构，自动生成数据库操作代码。</li>
<li><strong>data 层</strong>：封装数据库交互，隔离业务逻辑与数据访问。</li>
<li><strong>service 层</strong>：聚焦业务规则，与数据层解耦。</li>
<li><strong>server 层</strong>：统一注册服务，简化部署与扩展。</li>
</ul>
<p>遵循此流程，开发者可快速在框架中扩展新服务，充分利用框架提供的工具链（ent、Protobuf、gRPC）提升开发效率。</p>
<h3 data-id="heading-31">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战]]></title>    <link>https://juejin.cn/post/7582777037862879282</link>    <guid>https://juejin.cn/post/7582777037862879282</guid>    <pubDate>2025-12-12T08:34:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582777037862879282" data-draft-id="7582777037862846514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战"/> <meta itemprop="keywords" content="前端,JavaScript,微信小程序"/> <meta itemprop="datePublished" content="2025-12-12T08:34:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:34:45.000Z" title="Fri Dec 12 2025 08:34:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：证件“裸奔”的风险</h2>
<p>在日常生活中，我们经常需要上传身份证、驾照或房产证照片来办理各种业务。然而，直接发送原图存在巨大的安全隐患：</p>
<ul>
<li><strong>被二次盗用</strong>：不法分子可能将你的证件照用于网贷、注册账号等非法用途。</li>
<li><strong>服务器隐私泄露</strong>：如果使用在线工具加水印，图片必须上传到第三方服务器，这就好比“把钥匙交给陌生人保管”，风险不可控。</li>
</ul>
<p>为了解决这一痛点，可利用小程序的 <code>OffscreenCanvas</code> 能力，在用户手机本地毫秒级合成水印，<strong>图片数据永远不会离开用户手机</strong>。</p>
<h2 data-id="heading-1">2. 核心思路：离屏渲染 + 矩阵平铺</h2>
<p>实现全屏倾斜水印，主要难点在于<strong>坐标计算</strong>和<strong>性能平衡</strong>。我们的方案如下：</p>
<ol>
<li><strong>离屏渲染 (OffscreenCanvas)</strong>：
使用离屏画布在内存中处理，避免页面闪烁，且支持高性能的 2D 渲染模式。</li>
<li><strong>智能 DPR 降级</strong>：
沿用我们之前文章提到的防爆内存策略。证件照通常分辨率很高，必须计算安全尺寸，防止 Canvas 内存溢出闪退。</li>
<li><strong>矩阵平铺算法</strong>：
不简单的旋转画布，而是采用 <strong>“保存环境 -&gt; 平移 -&gt; 旋转 -&gt; 绘制 -&gt; 恢复环境”</strong> 的策略，在一个网格循环中将文字铺满全屏，确保无论图片比例如何，水印都能均匀分布。</li>
</ol>
<h2 data-id="heading-2">3. 硬核代码实现</h2>
<p>以下是封装好的 <code>watermarkUtils.js</code>。包含了<strong>智能 DPR 计算</strong>和<strong>全屏水印绘制</strong>的核心逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/watermarkUtils.js</span>

<span class="hljs-comment">// 1. 获取系统基础信息</span>
<span class="hljs-keyword">const</span> wxt = {
  <span class="hljs-attr">dpr</span>: wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span> || <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 图片缓存，避免重复加载</span>
<span class="hljs-keyword">const</span> cacheCanvasImageMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 内部方法：获取/创建 Canvas Image 对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasImage</span>(<span class="hljs-params">canvas, imageUrl</span>) {
  <span class="hljs-keyword">if</span> (cacheCanvasImageMap.<span class="hljs-title function_">has</span>(imageUrl)) <span class="hljs-keyword">return</span> cacheCanvasImageMap.<span class="hljs-title function_">get</span>(imageUrl);
  
  <span class="hljs-comment">// 兼容性处理：若不支持 Promise.withResolvers，请改用 new Promise</span>
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> image = canvas.<span class="hljs-title function_">createImage</span>();
  image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    cacheCanvasImageMap.<span class="hljs-title function_">set</span>(imageUrl, image);
    <span class="hljs-title function_">resolve</span>(image);
  };
  image.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`加载失败: <span class="hljs-subst">${e.errMsg}</span>`</span>));
  image.<span class="hljs-property">src</span> = imageUrl;
  <span class="hljs-keyword">await</span> promise;
  <span class="hljs-keyword">return</span> image;
}

<span class="hljs-comment">/**
 * 给图片添加全屏倾斜水印
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} text 水印文字，如 "仅供办理租房业务使用"
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} options 配置项 { color, size, opacity }
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addWatermark</span>(<span class="hljs-params">imageUrl, text = <span class="hljs-string">'仅供办理业务使用'</span>, options = {}</span>) {
  <span class="hljs-comment">// 默认配置</span>
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">color</span>: <span class="hljs-string">'#aaaaaa'</span>,
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0 表示自动计算</span>
    <span class="hljs-attr">gap</span>: <span class="hljs-number">100</span>,    <span class="hljs-comment">// 水印间距</span>
    ...options
  };

  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-comment">// --- ⚡️ 性能优化：智能 DPR 计算 (防止大图闪退) ---</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIMIT_SIZE</span> = <span class="hljs-number">4096</span>; 
  <span class="hljs-keyword">let</span> useDpr = wxt.<span class="hljs-property">dpr</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(width, height) * useDpr &gt; <span class="hljs-variable constant_">LIMIT_SIZE</span>) {
    useDpr = <span class="hljs-variable constant_">LIMIT_SIZE</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(width, height);
  }

  <span class="hljs-comment">// 设置画布尺寸</span>
  offscreenCanvas.<span class="hljs-property">width</span> = width * useDpr;
  offscreenCanvas.<span class="hljs-property">height</span> = height * useDpr;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(useDpr, useDpr);
  
  <span class="hljs-comment">// 1. 绘制底图</span>
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

  <span class="hljs-comment">// 2. 配置水印样式</span>
  <span class="hljs-comment">// 自动计算字号：约为图片宽度的 4%</span>
  <span class="hljs-keyword">const</span> fontSize = config.<span class="hljs-property">fontSize</span> || <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(width * <span class="hljs-number">0.04</span>); 
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">`bold <span class="hljs-subst">${fontSize}</span>px sans-serif`</span>;
  ctx.<span class="hljs-property">fillStyle</span> = config.<span class="hljs-property">color</span>;
  ctx.<span class="hljs-property">globalAlpha</span> = config.<span class="hljs-property">opacity</span>;
  ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>;
  ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;

  <span class="hljs-comment">// 3. 计算平铺逻辑</span>
  <span class="hljs-comment">// 旋转 45 度后，覆盖范围需要比原图大，这里简单取对角线长度作为边界</span>
  <span class="hljs-keyword">const</span> maxSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(width * width + height * height);
  <span class="hljs-comment">// 步长 = 文字宽度 + 间距</span>
  <span class="hljs-keyword">const</span> step = ctx.<span class="hljs-title function_">measureText</span>(text).<span class="hljs-property">width</span> + config.<span class="hljs-property">gap</span>; 
  
  <span class="hljs-comment">// 4. 循环绘制水印</span>
  <span class="hljs-comment">// 从负坐标开始绘制，确保旋转后边缘也有水印</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = -maxSize; x &lt; maxSize; x += step) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = -maxSize; y &lt; maxSize; y += step) {
      ctx.<span class="hljs-title function_">save</span>();
      
      <span class="hljs-comment">// 核心变换：平移到网格点 -&gt; 旋转 -&gt; 绘制</span>
      ctx.<span class="hljs-title function_">translate</span>(x, y);
      ctx.<span class="hljs-title function_">rotate</span>(-<span class="hljs-number">45</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>); <span class="hljs-comment">// 逆时针旋转 45 度</span>
      ctx.<span class="hljs-title function_">fillText</span>(text, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      
      ctx.<span class="hljs-title function_">restore</span>();
    }
  }

  <span class="hljs-comment">// 5. 导出图片</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: <span class="hljs-string">'jpg'</span>,
    <span class="hljs-attr">quality</span>: <span class="hljs-number">0.8</span>, <span class="hljs-comment">// 稍微压缩以减小体积</span>
  });

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}
</code></pre>
<h2 data-id="heading-3">4. 业务调用示例</h2>
<p>在小程序页面中，用户选择图片并输入水印文字后，实时预览效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pages/watermark/index.js</span>
<span class="hljs-keyword">import</span> { addWatermark } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../utils/watermarkUtils'</span>;

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">originImg</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">resultImg</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">watermarkText</span>: <span class="hljs-string">'仅供本次业务使用 他用无效'</span>
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onAddWatermark</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">originImg</span>) <span class="hljs-keyword">return</span>;

    wx.<span class="hljs-title function_">showLoading</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'安全合成中...'</span> });
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> tempFilePath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addWatermark</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">originImg</span>, 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">watermarkText</span>,
        {
          <span class="hljs-attr">color</span>: <span class="hljs-string">'#ffffff'</span>, <span class="hljs-comment">// 白色水印</span>
          <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.4</span>,     <span class="hljs-comment">// 半透明</span>
          <span class="hljs-attr">gap</span>: <span class="hljs-number">120</span>          <span class="hljs-comment">// 间距疏松一点</span>
        }
      );
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">resultImg</span>: tempFilePath });
      
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'合成失败'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
    } <span class="hljs-keyword">finally</span> {
      wx.<span class="hljs-title function_">hideLoading</span>();
    }
  }
})
</code></pre>
<h2 data-id="heading-4">5. 避坑与实战经验</h2>
<ol>
<li><strong>自动字号的重要性</strong>：
不要写死 <code>fontSize = 20px</code>。用户上传的图片分辨率差异极大（有的 500px 宽，有的 4000px 宽）。最佳实践是<strong>根据图片宽度动态计算字号</strong>（如 <code>width * 0.04</code>），这样无论处理缩略图还是 4K 原图，水印比例看起来都是协调的。</li>
<li><strong>平铺范围的陷阱</strong>：
因为文字需要旋转 45 度，如果循环只从 <code>0</code> 到 <code>width</code>，图片的左下角和右上角可能会出现空白。代码中我们从 <code>-maxSize</code>（负数区域）开始循环，确保旋转后的文字能完全覆盖画布的每一个角落。</li>
<li><strong>隐私第一</strong>：
在工具的 UI 界面上，建议显著提示 <strong>“纯本地处理，无上传服务器”</strong>，这能极大地增加用户的信任感，提升工具的使用率。</li>
</ol>
<h2 data-id="heading-5">写在最后</h2>
<p>通过<code>帮小忙工具箱</code>的这个实践案例，我们可以看到，利用小程序强大的 Canvas 能力，开发者完全可以在保护用户隐私的前提下，提供专业级的图片处理服务。</p>
<p><strong>技术不只是代码，更是对用户安全的守护。</strong> 希望这篇分享能帮你在小程序中实现更安全、更高效的功能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[制作一个简单的HTML个人网页]]></title>    <link>https://juejin.cn/post/7582786292087046195</link>    <guid>https://juejin.cn/post/7582786292087046195</guid>    <pubDate>2025-12-12T08:54:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786292087046195" data-draft-id="7582777037863157810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="制作一个简单的HTML个人网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T08:54:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yingjuxia菜鸟com"/> <meta itemprop="url" content="https://juejin.cn/user/1065848795830204"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            制作一个简单的HTML个人网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1065848795830204/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yingjuxia菜鸟com
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:54:44.000Z" title="Fri Dec 12 2025 08:54:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面给你一个<strong>超级<a href="https://link.juejin.cn?target=https%3A%2F%2Fyingjuxia.com%2Farchives%2F7064" target="_blank" title="https://yingjuxia.com/archives/7064" ref="nofollow noopener noreferrer">简单但又好看</a>、手机电脑都能完美访问</strong>的个人主页模板，5 分钟就能改成你自己的专属网页！</p>
<h3 data-id="heading-0">功能特点</h3>
<ul>
<li>纯 HTML + CSS（一行 JavaScript 都不用）</li>
<li>自适应移动端（手机看起来也好看）</li>
<li>深色/浅色自动切换（跟随系统）</li>
<li>一键替换头像、姓名、简介、社交链接就完事</li>
<li>支持添加博客、项目、作品、摄影等模块</li>
</ul>
<h3 data-id="heading-1">完整代码（直接复制保存为 index.html 双击打开即可）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>张三的个人主页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-pseudo">:root</span> {
            <span class="hljs-attr">--bg</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attr">--text</span>: <span class="hljs-number">#2c3e50</span>;
            <span class="hljs-attr">--card</span>: <span class="hljs-number">#ffffff</span>;
            <span class="hljs-attr">--accent</span>: <span class="hljs-number">#ff6b6b</span>;   <span class="hljs-comment">/* 主色调，喜欢可换成 #e91e63、#4ecdc4 等 */</span>
        }
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
            <span class="hljs-selector-pseudo">:root</span> {
                <span class="hljs-attr">--bg</span>: <span class="hljs-number">#121212</span>;
                <span class="hljs-attr">--text</span>: <span class="hljs-number">#e0e0e0</span>;
                <span class="hljs-attr">--card</span>: <span class="hljs-number">#1e1e1e</span>;
            }
        }

        * { <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>:border-box; }
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">"Segoe UI"</span>, Arial, sans-serif;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--bg);
            <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text);
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-class">.card</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--card);
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">420px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span> <span class="hljs-number">35px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;
        }
        <span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">10px</span>); }

        <span class="hljs-selector-class">.avatar</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">30px</span> auto <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">object-fit</span>: cover;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-built_in">var</span>(--accent);
        }
        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--accent);
        }
        <span class="hljs-selector-class">.tagline</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#888</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-class">.bio</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">25px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;
        }
        <span class="hljs-selector-class">.links</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-wrap</span>: wrap;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">30px</span>;
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--accent);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">text-decoration</span>: none;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.08</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">107</span>,<span class="hljs-number">107</span>,<span class="hljs-number">0.4</span>);
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">i</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>; }

        <span class="hljs-selector-tag">footer</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#aaa</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 图标库（可选） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 1. 替换成你的头像（放同目录下或用网络链接） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/你的githubid?v=4"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"头像"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 或者本地图片：src="myphoto.jpg" --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tagline"</span>&gt;</span>前端开发者 / 摄影爱好者 / 正在努力变厉害的人<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bio"</span>&gt;</span>
        Hi～我是张三，目前在广州做前端，喜欢写代码、拍风景、撸猫。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
        生活很普通，但希望每天都能进步一点点
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"links"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 直接改链接和图标就行 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://github.com/yourname"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-github"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> GitHub
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://weibo.com/yourname"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-weibo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 微博
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://space.bilibili.com/123456"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-bilibili"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> B站
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"mailto:your@email.com"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-envelope"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 邮件
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://yourblog.com"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-blog"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 博客
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://juejin.cn/user/你的id"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-juejin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 掘金
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>© 2025 张三 | 手工码的个人主页<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">只需要改 4 处就完全是你自己的网页了！</h3>
<ol>
<li>头像：把 <code>src="https://..."</code> 换成你自己的照片链接（推荐放同目录下改成 <code>src="avatar.jpg"</code>）</li>
<li>名字：改 <code>&lt;h1&gt;张三&lt;/h1&gt;</code></li>
<li>一句话介绍：改 <code>.tagline</code> 那行</li>
<li>自我介绍 + 社交链接：按需增删即可</li>
</ol>
<h3 data-id="heading-3">想更炫酷？再加这几行（任选）</h3>
<ul>
<li>背景粒子特效（加在 <code>&lt;body&gt;</code> 前面）：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"particles-js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-title function_">particlesJS</span>(<span class="hljs-string">"particles-js"</span>, {<span class="hljs-string">"particles"</span>:{<span class="hljs-string">"number"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">80</span>},<span class="hljs-string">"color"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-string">"#ff6b6b"</span>},<span class="hljs-string">"shape"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"circle"</span>},<span class="hljs-string">"opacity"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">0.5</span>},<span class="hljs-string">"size"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">3</span>},<span class="hljs-string">"move"</span>:{<span class="hljs-string">"speed"</span>:<span class="hljs-number">1</span>}}});
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-id">#particles-js</span>{<span class="hljs-attribute">position</span>:fixed;<span class="hljs-attribute">top</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">left</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">width</span>:<span class="hljs-number">100%</span>;<span class="hljs-attribute">height</span>:<span class="hljs-number">100%</span>;<span class="hljs-attribute">z-index</span>:-<span class="hljs-number">1</span>;}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<ul>
<li>音乐自动播放（七夕专用）：</li>
</ul>
<pre><code class="hljs language-css" lang="css">  &lt;<span class="hljs-selector-tag">audio</span> <span class="hljs-attribute">src</span>="your-music<span class="hljs-selector-class">.mp3</span>" autoplay loop hidden&gt;&lt;/<span class="hljs-selector-tag">audio</span>&gt;
</code></pre>
<p>5 分钟搞定一个高颜值个人主页，赶紧发给朋友/对象/面试官吧～<br/>
需要再加「作品集」「时间轴」「留言板」等功能，随时告诉我，我继续给你升级！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析 ，深入理解JavaScript原型系统核心]]></title>    <link>https://juejin.cn/post/7582763878674448411</link>    <guid>https://juejin.cn/post/7582763878674448411</guid>    <pubDate>2025-12-12T08:55:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674448411" data-draft-id="7581828086019932175" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析  ，深入理解JavaScript原型系统核心"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-12T08:55:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AY1024"/> <meta itemprop="url" content="https://juejin.cn/user/2232439936132313"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析  ，深入理解JavaScript原型系统核心
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2232439936132313/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AY1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:55:31.000Z" title="Fri Dec 12 2025 08:55:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0"><strong>深入理解JavaScript原型系统核心</strong></h2>
<h3 data-id="heading-1">📖 目录</h3>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念</a></li>
<li><a href="#%E6%98%BE%E5%BC%8F%E5%8E%9F%E5%9E%8B%E4%B8%8E%E9%9A%90%E5%BC%8F%E5%8E%9F%E5%9E%8B" title="#%E6%98%BE%E5%BC%8F%E5%8E%9F%E5%9E%8B%E4%B8%8E%E9%9A%90%E5%BC%8F%E5%8E%9F%E5%9E%8B">显式原型与隐式原型</a></li>
<li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%8C%87%E5%90%91" title="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%8C%87%E5%90%91">构造函数的指向</a></li>
<li><a href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%85%B3%E7%B3%BB%E5%9B%BE" title="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%85%B3%E7%B3%BB%E5%9B%BE">可视化关系图</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81" title="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81">代码验证</a></li>
<li><a href="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E" title="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E">特别说明</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 核心概念</h3>
<h4 data-id="heading-3">四大基本原则</h4>
<ol>
<li>
<p><strong>原则一：每个对象都有构造函数（constructor）</strong></p>
<ul>
<li>指向构建该对象或实例的函数</li>
</ul>
</li>
<li>
<p><strong>原则二：只有函数对象才有prototype属性</strong></p>
<ul>
<li>非函数对象没有prototype属性</li>
<li>实例只有<code>__proto__</code>属性</li>
<li>两者指向同一个对象（函数的原型对象）</li>
</ul>
</li>
<li>
<p><strong>原则三：Function函数是所有函数的构造函数</strong></p>
<ul>
<li>包括它自己</li>
<li>代码中声明的所有函数都是Function的实例</li>
</ul>
</li>
<li>
<p><strong>原则四：Object也是函数</strong></p>
<ul>
<li>所以Object也是Function函数的实例</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">实例，函数，对象，原型对象，构造函数，关系总览图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c44a9f53d4049e196b167e4449e2da2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=H1O2jR3fUmx7IK2xXJCNP0XPiro%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">🔍 非函数对象分类</h4>
<ul>
<li>实例对象，<code>const person = new Foo()</code>,<strong>person</strong>就是实例对象</li>
<li>普通对象（<code>{}</code> 或 <code>new Object()</code>）</li>
<li>内置非函数对象实例</li>
</ul>
<hr/>
<h3 data-id="heading-6">🔄 显式原型与隐式原型</h3>
<h4 data-id="heading-7">对象分类</h4>
<ul>
<li><strong>函数对象</strong>：拥有<code>prototype</code>属性</li>
<li><strong>非函数对象</strong>：只有<code>__proto__</code>属性</li>
</ul>
<h4 data-id="heading-8">相同点</h4>
<ul>
<li>都指向同一个原型对象</li>
</ul>
<h4 data-id="heading-9">📝 示例代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype指向:"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person.__proto__指向"</span>, person.<span class="hljs-property">__proto__</span>)
</code></pre>
<h4 data-id="heading-10">🖼️ 执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75efb24e532949a6bcb546dfbea5def0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=u3Krc1lI6HuPgwV49gh%2FlLzwOE0%3D" alt="显式原型" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d94345698af74b2286cc67e713e3dcdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=OjZxIA6%2BtOwDD4e2lsEIff8FKJw%3D" alt="隐式原型" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">🎯 构造函数的指向</h3>
<h4 data-id="heading-12">默认情况</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
<span class="hljs-comment">// 输出：[Function: Person]</span>
</code></pre>
<h4 data-id="heading-13">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ad1a034f38248f5b1178c09ff599799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=l%2BCyV9g3Z4Dnu8t52LS7vcL44RQ%3D" alt="默认构造函数指向" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaa17783b7954f6ebaa997acc9cb82d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=XIyqvF8bK92JcL19rBHExvmYIKk%3D" alt="默认构造函数指向详情" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-14">修改原型对象后</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">foo</span>();  <span class="hljs-comment">// 修改原型对象</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
<span class="hljs-comment">// 输出：[Function: foo]</span>
</code></pre>
<h4 data-id="heading-15">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1945c4ccb5224c8e92b481725289b54c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=EW7wn2UXR%2FEUf7UGyWCxXEcihng%3D" alt="修改后构造函数指向" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276f3f0c840a454f9b1f050477a5a38a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=yL1%2B%2FQcikuMGuZd8KlACBJmvBMQ%3D" alt="修改后构造函数指向详情" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-16">📊 核心原理说明</h3>
<h4 data-id="heading-17">解释</h4>
<p><code>Person.prototype</code>被当作函数foo的实例，继承了foo函数（此篇不展开继承详解）</p>
<h4 data-id="heading-18">总结规律</h4>
<ul>
<li>每个原型对象或实例都有<code>.constructor</code>属性</li>
<li>实例通过原型链查找constructor</li>
<li>原型对象默认指向自身的函数（如果不是其他函数的实例）</li>
</ul>
<h4 data-id="heading-19">查找过程示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Person.prototype被当作实例时</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> → foo.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> → <span class="hljs-title function_">foo</span>()
</code></pre>
<hr/>
<h3 data-id="heading-20">🖼️ 可视化关系图</h3>
<h4 data-id="heading-21">三者关系图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da7158ab94b47ceae930e03320e299d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=kYputO3NXnapYQgPE3dKCobRNOg%3D" alt="原型关系图" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-22">🔬 代码验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}

<span class="hljs-comment">// 创建新的原型对象</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"杨"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-string">"18"</span>,
    <span class="hljs-attr">histype</span>: <span class="hljs-string">"sleep"</span>
}

<span class="hljs-comment">// 添加方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">print</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好我是原型对象"</span>);
}

<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> person01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-keyword">const</span> person02 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// 验证指向</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype指向:"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person01.__proto__指向"</span>, person01.<span class="hljs-property">__proto__</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person02.__proto__指向"</span>, person02.<span class="hljs-property">__proto__</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
</code></pre>
<h4 data-id="heading-23">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb5d21f26944fe2bdd35d2319d03cbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=iYpl9%2Bpiquppx321Lmdju1TVqEQ%3D" alt="代码验证结果" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-24">⚠️ 特别说明</h3>
<h4 data-id="heading-25">关键细节</h4>
<p>创建新对象时，<code>Person.prototype.constructor</code>指向<code>Object</code>，因为<code>Person.prototype</code>成了<code>Object</code>的实例。</p>
<h4 data-id="heading-26">对比情况</h4>
<ul>
<li><strong>创建新对象时</strong>：<code>Person.prototype.constructor</code> → <code>Object</code></li>
<li><strong>未创建新对象时</strong>：<code>Person.prototype.constructor</code> → <code>Person</code></li>
</ul>
<h4 data-id="heading-27">示意图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c9ba507074041c288d945ed873309d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=vMMtCPQAXQ7sXQQ2yluuta1lG4s%3D" alt="构造函数指向对比" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4365ef09062e4b80af90692c3c838d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=Ri3KDzQBVDTXFudXhrgg8r69T0E%3D" alt="构造函数指向对比详情" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-28">Function和Object</h2>
<h2 data-id="heading-29">小故事</h2>
<p>从前有个力大无穷的大力神，能举起任何东西，有一天，小A在路上和这个大力神相遇了。</p>
<p>大力神：小子，我可是力大无穷的大力神，我能举起任何东西，你信不信？</p>
<p>小A:呦呦呦，还大力神，你说你能举起任何东西，那你能把你自己抬起来吗？</p>
<p>...</p>
<ul>
<li>
<p>Function是所有函数的加工厂，你在代码声明的所有函数都是Function的实例，包括Function函数本身，Object也是函数，所以它也是Functiod的实例</p>
</li>
<li>
<p>Function就是这样的大力神，而且是可以把自己抬起来的大力神，这听起来比较扯，但是这就是事实，请看VCR：</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span> (){}

<span class="hljs-keyword">const</span> person01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.__proto__指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span>)<span class="hljs-comment">//Function.__proto__指向 [Function (anonymous)] Object</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.prototype指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)<span class="hljs-comment">//Function.prototype指向 [Function (anonymous)] Object</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.__proto__ == Function.prototype???"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span> == <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-comment">//Function.__proto__ == Function.prototype??? true</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f959ab9fe3a4b15a6bff89bea078b60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=s5lVNg0t3PqA7ArU8DMKUX%2FX2c8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d522369f0bce4dcd98dd6226be71d772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=6F9t2jUSNGy%2FEyCexsejvd78zJU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-30">Object 在 JavaScript 中扮演三重角色：</h2>
<ul>
<li>
<p>构造函数：用于创建对象</p>
</li>
<li>
<p>命名空间：提供一系列静态方法用于对象操作</p>
</li>
<li>
<p>原型终点：Object.prototype 是所有原型链的终点，在往上没有了，值==null</p>
</li>
</ul>
<p>请看VCR:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span> (){};

<span class="hljs-keyword">const</span> persoon01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-keyword">const</span> obj = {};<span class="hljs-comment">//通过对象字面量{}创建obj实例</span>
<span class="hljs-keyword">const</span> obj1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<span class="hljs-comment">//通过构造函数new Object()创建obj1实例</span>
<span class="hljs-keyword">const</span> obj2 = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<span class="hljs-comment">//通过委托创建，或者叫原型创建，来创建obj2实例</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.__proto__指向"</span>,<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//Person.prototype.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.prototype.__proto__指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>)
<span class="hljs-comment">//Function.prototype.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过对象字面量{}创建的obj实例,obj.__proto__指向"</span>,obj.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过对象字面量{}创建的obj实例,obj.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过构造函数new Object()创建obj1实例,指向"</span>,obj1.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过构造函数new Object()创建obj1实例,指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过委托创建,或者叫原型创建,来创建obj2实例,指向"</span>,obj2.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过委托创建,或者叫原型创建,来创建obj2实例,指向 [Object: null prototype] {}</span>
</code></pre>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a57a0c9c8c19400b818089efed2e8067~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=%2Bk%2FtNQnXONsfCk2tuBC14MzpvjU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/082ce993339a42bbb14d4a585e515e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=j7P%2BWVGh%2F3gHwmUptx92mcXLhvg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-31">Function和Object的关系</h2>
<ul>
<li>相互依赖的循环引用
<ul>
<li>
<p>Object 是 Function 的实例（构造函数层面）</p>
</li>
<li>
<p>Function 是 Object 的子类（原型继承层面）</p>
</li>
<li>
<p>这是 JavaScript 的自举（Bootstrap）机制</p>
</li>
</ul>
</li>
</ul>
<p>根据<strong>关系总览图</strong>，我们可以看到，Function和Object,它们两形成了一个闭环，将所有的函数和对象都包裹在这个闭环里</p>
<h2 data-id="heading-32">📋 JavaScript 原型系统核心概念表</h2>















































<table><thead><tr><th>概念</th><th>描述</th><th>示例</th><th>特殊说明</th></tr></thead><tbody><tr><td><strong>prototype</strong></td><td>函数特有，指向原型对象</td><td><code>Person.prototype</code></td><td>只有函数对象才有此属性</td></tr><tr><td><strong><strong>proto</strong></strong></td><td>所有对象都有，指向构造函数的原型</td><td><code>person.__proto__</code></td><td>实际应使用 <code>Object.getPrototypeOf()</code></td></tr><tr><td><strong>constructor</strong></td><td>指向创建该对象的构造函数</td><td><code>Person.prototype.constructor</code></td><td>可被修改，查找时沿原型链进行</td></tr><tr><td><strong>原型链查找</strong></td><td>通过 <code>__proto__</code> 逐级向上查找</td><td><code>person.__proto__.__proto__</code></td><td>终点为 <code>null</code></td></tr><tr><td><strong>Function</strong></td><td>所有函数的构造函数</td><td><code>Function.prototype</code></td><td><code>Function.__proto__ === Function.prototype</code></td></tr><tr><td><strong>Object</strong></td><td>所有对象的基类</td><td><code>Object.prototype</code></td><td>原型链终点，<code>Object.prototype.__proto__ === null</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-33">🔍 补充说明</h3>
<h4 data-id="heading-34"><strong>prototype 补充</strong></h4>
<ul>
<li>函数的 <code>prototype</code> 属性默认包含 <code>constructor</code> 属性指向函数自身</li>
<li>用于实现基于原型的继承</li>
</ul>
<h4 data-id="heading-35"><strong><strong>proto</strong> 补充</strong></h4>
<ul>
<li>现在更推荐使用 <code>Object.getPrototypeOf(obj)</code> 和 <code>Object.setPrototypeOf(obj, proto)</code></li>
<li><code>__proto__</code> 是访问器属性，不是数据属性</li>
</ul>
<h4 data-id="heading-36"><strong>constructor 补充</strong></h4>
<ul>
<li><code>constructor</code> 属性可以通过原型链查找</li>
<li>示例：<code>person.constructor === Person</code>（实际查找的是 <code>person.__proto__.constructor</code>）</li>
</ul>
<h4 data-id="heading-37"><strong>原型链查找补充</strong></h4>
<ul>
<li>当访问对象属性时，如果对象自身没有，会沿着原型链向上查找</li>
<li>直到找到该属性或到达原型链终点 <code>null</code></li>
</ul>
<h4 data-id="heading-38"><strong>Function 补充</strong></h4>
<ul>
<li>是所有函数的构造函数，包括内置构造函数（Object、Array等）和自定义函数</li>
<li>自身也是函数，所以 <code>Function.__proto__ === Function.prototype</code></li>
</ul>
<h4 data-id="heading-39"><strong>Object 补充</strong></h4>
<ul>
<li><code>Object.prototype</code> 是所有原型链的最终原型对象</li>
<li>通过 <code>Object.create(null)</code> 可以创建没有原型的"纯净对象"</li>
</ul>
<h4 data-id="heading-40">💡 记忆口诀</h4>
<ul>
<li><strong>函数看prototype，实例看__proto__</strong></li>
<li><strong>constructor找根源，原型链上寻答案</strong></li>
<li><strong>Object是终点，Function是关键</strong></li>
</ul>
<h2 data-id="heading-41">结语：</h2>
<p>看完这篇文章，你应该可以读懂上面的关系总览图了，望学习愉快！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML标签 - 表格标签]]></title>    <link>https://juejin.cn/post/7582786655472779307</link>    <guid>https://juejin.cn/post/7582786655472779307</guid>    <pubDate>2025-12-12T08:46:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472779307" data-draft-id="7582516300050235419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML标签 - 表格标签"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T08:46:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GinoWi"/> <meta itemprop="url" content="https://juejin.cn/user/687651121011707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML标签 - 表格标签
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/687651121011707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GinoWi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:46:36.000Z" title="Fri Dec 12 2025 08:46:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">HTML标签 - 表格标签</h2>
<p>在过去网站开发过程中，表格标签的使用是非常非常多，绝大多数的网站都是使用表格标签来制作的，也就是说表格标签是一个时代的代表。</p>
<h4 data-id="heading-1">什么是表格标签？</h4>
<p>表格标签的作用是用来给一堆数据<strong>添加表格语义</strong>，其实表格是一种数据的展现形式，当数据量非常大的时候，表格这种展现形式被认为是最为清晰的一种展现形式。</p>
<h4 data-id="heading-2">表格结构</h4>
<p>由于表格中存储的数据比较复杂，为了方便管理、阅读以及提升语义，我们可以对表格中存储的数据进行分类。</p>
<ul>
<li>
<p>表格中存储的数据可以分为四类：</p>
<ol>
<li>表格标题</li>
<li>表格表头</li>
<li>表格主体</li>
<li>表格的页尾信息</li>
</ol>
</li>
<li>
<p>表格完整结构</p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span>表格的标题<span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>每一列的标题<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tfoot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tfoot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">表格标签</h4>
<ul>
<li>
<p><code>table</code>标签</p>
<ul>
<li>作用：表格标签中的<code>table</code>代表整个表格，也就是一对<code>table</code>标签就是一个表格。</li>
</ul>
</li>
<li>
<p><code>tr</code>标签</p>
<ul>
<li>作用：表格标签的<code>tr</code>代表表格中的一行数据，也就是说一对<code>tr</code>标签就是表格中的一行。</li>
</ul>
</li>
<li>
<p><code>td</code>标签</p>
<ul>
<li>作用：表格标签中的<code>td</code>标签代表表格中的一个单元格，也就是说一对<code>td</code>标签就是表格中的一个单元格。</li>
</ul>
</li>
<li>
<p><code>caption</code>标签</p>
<ul>
<li>作用：在表格标签中提供了一个标签专门用来设置表格的标题，这个标签叫做<code>caption</code>。只要将标题写在<code>caption</code>标签中，那么标题就会自动相对于表格的宽度居中。</li>
<li>注意点：
<ul>
<li><code>caption</code>标签一定要写在<code>table</code>标签中，否则无效。</li>
<li><code>caption</code>一定要紧跟在<code>table</code>标签后面。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>th</code>标签</p>
<ul>
<li>作用：在表格标签中提供了一个标签专门用来展示每一列的标题，这个标签叫做<code>th</code>标签，只要使用<code>th</code>标签展现当前列的标题，这时标题就会在该标签单元格中自动居中。</li>
</ul>
</li>
<li>
<p><code>thead</code>标签</p>
<ul>
<li>作用：指定表格表头信息。</li>
</ul>
</li>
<li>
<p><code>tbody</code>标签</p>
<ul>
<li>作用：指定表格主体信息。</li>
<li>注意点：如果我们没有编写<code>tbody</code>，系统会自动给我门添加<code>tbody</code></li>
</ul>
</li>
<li>
<p><code>tfoot</code>标签</p>
<ul>
<li>作用：指定表格附加信息。</li>
<li>注意点：如果指定了<code>thead</code>和<code>tfoot</code>，那么在修改整个表格的高度时，<code>thead</code>和<code>tfoot</code>有自己的默认高度，不会随着表格的高度变化而变化。</li>
</ul>
</li>
</ul>
<p>总结：</p>
<ul>
<li>
<p>表格标签有一个边框属性，这个属性决定了边框的宽度，默认情况下这个属性的值是0，所以看不到边框。</p>
</li>
<li>
<p>表格标签和列表标签一样，它是一个组合标签，所以<code>table/tr/td</code>要么一起出现，要么一起不出现，不会单独出现。</p>
</li>
<li>
<p>表格中有两种单元格，一种是<code>td</code>，一种是<code>th</code>，<code>td</code>是专门用来存储数据的，<code>th</code>是专门用来存储当前列的标题的。</p>
</li>
</ul>
<h4 data-id="heading-4">表格标签的属性（这部分内容仅为了解，以后均通过CSS来进行修改）：</h4>
<ul>
<li>
<p>宽度和高度的属性（可以给<code>table</code>标签和<code>td</code>标签使用）</p>
<ul>
<li>表格的宽度和高度默认按照内容尺寸调整，也可以通过给<code>table</code>标签设置<code>width/height</code>属性的方式来手动指定表格宽高。</li>
<li>如果给<code>td</code>标签设置<code>width/height</code>属性，会修改当前单元格的宽度（会同时影响当前列单元格宽度）和高度（会同时影响当前行单元格高度），不会影响整个表格的宽度和高度。
<ul>
<li>当给一行中不同单元格设置不同的<code>height</code>属性，保留一行中高度最高的属性值作为该行单元格的高度。</li>
<li>当给一列中不同单元格设置不同的<code>width</code>属性，保留一行中宽度最宽的属性值作为该列单元格的宽度。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>水平对齐和垂直对齐的属性（其中水平对齐可以给<code>table</code>标签和<code>tr</code>标签和<code>td</code>标签使用，垂直对齐只能给<code>tr</code>标签和<code>td</code>标签使用）</p>
<ul>
<li>给<code>table</code>标签设置<code>align</code>属性，可以控制表格在水平方向的对齐方式。</li>
<li>给<code>tr</code>标签设置<code>align</code>属性，可以控制当前行中所有单元格内容的水平方向对齐方式。</li>
<li>给<code>td</code>标签设置<code>align</code>属性，可以控制当前单元格中内容在水平方向的对齐方式（如果<code>td</code>标签中设置了<code>align</code>属性，<code>tr</code>中也设置了<code>align</code>属性，那么单元格中的内容会按照<code>td</code>中设置的来对齐）。</li>
<li>给<code>tr</code>标签设置<code>valign</code>属性，可以控制当前行中所有单元格内容的垂直方向对齐方式。</li>
<li>给<code>td</code>标签设置<code>valign</code>属性，可以控制当前单元格中内容在垂直方向对齐方式。（如果<code>td</code>标签中设置了<code>valign</code>属性，<code>tr</code>中也设置了<code>valign</code>属性，那么单元格中的内容会按照<code>td</code>中设置的来对齐。</li>
</ul>
</li>
<li>
<p>外边距和内边距的属性（只能给<code>table</code>标签使用）</p>
<ul>
<li>外边距（cellspacing）就是单元格和单元格之间的距离（默认情况下单元格与单元格的外边距是2px）</li>
<li>内边距（cellpadding）就是文字距离单元格之间的距离（默认情况下内边距是1px）</li>
</ul>
</li>
<li>
<p>通过属性设置完成细线表格的绘制：</p>
<ul>
<li>
<p>在表格标签中想通过指定外边距为0来实现细线表格是不靠谱的，其实它是将2条合并为了一条线，所以看上去很不舒服。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee691f1461c41efbca084b48b46365a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134384&amp;x-signature=HFYD59BvxoRfHXhIo7Z8t%2F%2BpMDU%3D" alt="通过设置外边距实现的表格" loading="lazy"/></p>
</li>
<li>
<p>细线表格的制作方式：（<code>table</code>标签、<code>tr</code>标签以及<code>td</code>标签都支持<code>bgcolor</code>属性，但是样式以后通过css完成控制。）</p>
<ol>
<li>给<code>table</code>标签设置<code>bgcolor</code>属性</li>
<li>给<code>tr</code>标签设置<code>bgcolor</code>属性</li>
<li>给<code>table</code>标签设置<code>cellspacing="1px"</code></li>
</ol>
</li>
<li>
<p>代码：</p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"black"</span> <span class="hljs-attr">cellspacing</span>=<span class="hljs-string">"1px"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"300px"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>效果展示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b3c4a13da9f485a9397019c040decd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134384&amp;x-signature=XMHdVs2w3CJ%2BaPaWWcRmUB0qsao%3D" alt="通过设置背景颜色实现的表格" loading="lazy"/></p>
<p>通过放大比较上述两张表格图片，就能够很明显的看出表格边框的差别。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">单元格合并</h4>
<ul>
<li>
<p>水平方向上的单元格合并</p>
<ul>
<li>可以给<code>td</code>标签添加<code>colspan</code>属性，把某一个单元格当作多个单元格来看待（水平）。</li>
<li>格式：<code>&lt;td colspan="2"&gt;&lt;/td&gt;</code>含义：把当前单元格当作两个单元格来看待。</li>
<li>注意点：
<ul>
<li>由于把某一个单元格当作多个单元格来看待，所以就会多出一些单元格，需要删掉一些单元格确保表格正常显示。</li>
<li>单元格合并永远都是向后或者向下合并，而不能向前或者向上合并。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>垂直方向上的单元格合并</p>
<ul>
<li>可以给<code>td</code>标签添加<code>rowspan</code>属性，把某一个单元格当作多个单元格来看待（垂直）。</li>
<li>格式：<code>&lt;td rowspan="2"&gt;&lt;/td&gt;</code>含义：把当前单元格当作两个单元格来看待。</li>
<li>注意点：
<ul>
<li>由于把某一个单元格当作多个单元格来看待，所以就会多出一些单元格，需要删掉一些单元格确保表格正常显示。</li>
<li>单元格合并永远都是向后或者向下合并，而不能向前或者向上合并。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>参考链接：</strong></p>
<p>W3School官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3school.com.cn%2F" target="_blank" title="https://www.w3school.com.cn/" ref="nofollow noopener noreferrer">www.w3school.com.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BlackstoneOne 实现业务十倍增长]]></title>    <link>https://juejin.cn/post/7582539701147271209</link>    <guid>https://juejin.cn/post/7582539701147271209</guid>    <pubDate>2025-12-12T07:36:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147271209" data-draft-id="7582535649276428329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BlackstoneOne 实现业务十倍增长"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-12-12T07:36:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BlackstoneOne 实现业务十倍增长
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:36:30.000Z" title="Fri Dec 12 2025 07:36:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"在我们发展的每个阶段，Akamai始终相伴。从可预测的定价到区域技术支持，再到便捷的使用体验，它已成为我们让中小企业也能享受高效IT安全服务这一征程中不可或缺的伙伴。"</p>
<p>——BlackstoneOne 合伙人兼高级开发工程师 Jacob Honoré</p>
</blockquote>
<h4 data-id="heading-0"><strong><strong>为中小企业简化IT安全防护</strong></strong></h4>
<p>BlackstoneOne致力于革新中小企业的IT安全防护，提供先进的漏洞管理与攻击面管理解决方案。2019年，合伙人兼高级开发工程师Jacob Honoré离开德勤，加入BlackstoneOne并肩负起管理公司技术基础设施的重任——这套基础设施当时已部署在Akamai<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-cloud-platform%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251212_external1_blogarticles235" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-cloud-platform?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251212_external1_blogarticles235" ref="nofollow noopener noreferrer">云计算平台</a>服务（前身为Linode）之上。他的核心任务就是扩展公司解决方案，以满足快速增长的客户群体需求。</p>
<p>在短短五年内，BlackstoneOne不仅客户数量增长十倍，还成功开拓了新市场，推出了AI驱动洞察等高级功能以及攻击面管理等重点方案。所有这些成就，都依托于Akamai平台实现。</p>
<p>当Akamai收购Linode时，BlackstoneOne曾有过疑虑。但无缝的过渡和新功能的快速推出很快打消了他们的顾虑。"收购后服务和支持反而更上一层楼，"Honoré表示，"虚拟私有云和托管数据库等功能对我们具有革命性意义。"</p>
<h4 data-id="heading-1"><strong><strong>应对安全业务规模化挑战</strong></strong></h4>
<p>自2015年成立以来，BlackstoneOne从服务丹麦30家客户，已扩展至丹麦、挪威、瑞典、德国和格陵兰的350多家客户。公司的愿景是：简化漏洞管理，降低风险，让企业用上既强大又易用的安全工具。</p>
<p>扩展IT解决方案绝非易事，但Akamai让它变得可控。"Akamai云计算让扩展变得简单。我们实现了巨大增长，而Akamai始终相伴，提供所需的功能和可靠性，且没有带来不必要的复杂性，"Honoré解释道。</p>
<p>据Honoré介绍，Akamai让他的精干开发团队能够灵活配置服务器，避免了其他云平台的臃肿管理和复杂流程。"通过直接访问虚拟机，Akamai让配置变得简单。其云计算服务非常适合我们这种规模的企业，在强大功能和简洁易用之间取得了完美平衡。"</p>
<p>对成长型企业而言，意外账单可能是致命的。Akamai的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linode.com%2Fzh%2Fpricing%2F%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251212_external2_blogarticles235" target="_blank" title="https://www.linode.com/zh/pricing/?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251212_external2_blogarticles235" ref="nofollow noopener noreferrer">可预测定价模式</a>为BlackstoneOne提供了关键支持。"我曾用过那些意外成本几乎拖垮企业的平台。而Akamai让我始终清楚费用明细，这对我们规模扩张中的预算管理至关重要，"Honoré补充道。</p>
<h4 data-id="heading-2"><strong><strong>选择Akamai作为云平台</strong></strong></h4>
<p>BlackstoneOne业务主要分布在斯堪的纳维亚地区，Akamai位于瑞典等地的区域云计算数据中心使其受益匪浅。值得注意的是，公司在向挪威和瑞典扩张的同时，始终保持着高性能和高可靠性。"靠近客户的数据中心确保了低延迟，这对高效的漏洞扫描至关重要。这对我们和客户都是巨大优势，"Honoré表示。</p>
<p>事实上，正是Akamai支撑着BlackstoneOne的服务实现。其服务需要扫描大量敏感流量（部分可能被标记）。与其他阻止漏洞扫描流量的云提供商不同，Akamai无缝满足了BlackstoneOne的需求。"Akamai确保我们的扫描操作平稳运行，无需面对不必要的干扰——这是我们在其他平台上曾遇到的挑战，"Honoré指出。</p>
<p>BlackstoneOne引领创新，持续提供尖端解决方案——Honoré带领团队依托Akamai实现公司愿景，专注于以客户为中心的创新。BlackstoneOne近期将AI集成至平台，帮助中小企业更好地理解并处理漏洞，同时轻松应对IT安全的复杂性。</p>
<p>公司最新推出的外部攻击面管理服务，依托虚拟私有云（VPC）实现增强安全。Honoré表示："创建新虚拟机非常简单。此外，VPC让我们能将服务器置于后台，为敏感客户数据增添额外保护层。"</p>
<h4 data-id="heading-3"><strong><strong>展望未来</strong></strong></h4>
<p>随着业务持续扩展，BlackstoneOne专注于在应对欧洲合规性与数据保护挑战的同时，持续提供有价值的IT安全解决方案。凭借Akamai不断丰富的工具集和对中小企业的支持承诺，BlackstoneOne已为未来增长做好充分准备。</p>
<p>当被问及对其他开发者的建议时，Honoré总结道："Akamai在功能与易用性间的平衡无与伦比，透明定价让我们能无忧扩展，而及时有效的技术支持更使其在众多提供商中脱颖而出。"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍]]></title>    <link>https://juejin.cn/post/7582539701147746345</link>    <guid>https://juejin.cn/post/7582539701147746345</guid>    <pubDate>2025-12-12T08:30:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147746345" data-draft-id="7582535649276854313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍"/> <meta itemprop="keywords" content="PostgreSQL,开源,数据库"/> <meta itemprop="datePublished" content="2025-12-12T08:30:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvorySQL"/> <meta itemprop="url" content="https://juejin.cn/user/761327331579511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/761327331579511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvorySQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:30:57.000Z" title="Fri Dec 12 2025 08:30:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于任何需要维护超大表（更新旧数据、分批删除、数据迁移）的 DBA 或开发者来说，使用 <code>ctid</code>（元组物理位置）将大表切分为多个小块进行处理是标准操作。然而，直到现在，这种操作都有一个巨大的痛点：<strong>它严格依赖单进程</strong>。</p>
<p>随着最近的一个 Commit (<code>0ca3b169</code>) 合并入 PostgreSQL 19 (master 分支)，<strong>TID 范围扫描（TID Range Scans）终于支持并行了</strong>。</p>
<blockquote>
<p>该功能由瀚高的 Cary Huang 提出并主导开发，由微软的 David Rowley 协助测试及审阅，并最终提交。他们密切合作以完善并行安全逻辑，确保工作进程正确处理扫描限制——最终促成了这个落地到 master 分支的健壮实现。</p>
</blockquote>
<blockquote>
<p>瀚高以“用开源链接世界”为使命，强调开源技术在数据库基础软件领域的核心作用，致力于通过共享和合作，推动行业发展，同时链接和赋能全球用户。开源技术是中国软件技术发展的必由之路，瀚高作为亚太地区 PostgreSQL 国际社区顶级贡献者之一，长期深度参与 PostgreSQL 国际社区发展与建设。自 2025 年 7 月以来，瀚高被 PostgreSQL 社区采纳的贡献就已超过 2000 行代码。</p>
</blockquote>
<p>根据基准测试，新特性的速度提升高达 <strong>3 倍</strong>。</p>
<h2 data-id="heading-0">1. 核心痛点：规划器（Planner）的权衡</h2>
<p>Postgres 自版本 14 起就支持了 <code>TID Range Scans</code>。这允许你基于物理块号扫描表的特定切片：</p>
<p><code>SELECT * FROM my_large_table WHERE ctid &gt;= '(0,0)' AND ctid &lt; '(10000,0)';</code></p>
<p>这是像 AWS DMS 这样的工具或逻辑复制初始化器拆分海量表的标准方式。问题在于，直到现在这种扫描节点严格来说都是<strong>单工作进程（single worker）</strong> 的。</p>
<p>这迫使 Postgres 查询规划器陷入了两难境地。当你在大数据集上运行查询时，规划器必须在以下两者之间做出选择：</p>
<ul>
<li>
<p>TID Range Scan： I/O 高效（只读取你请求的块），但是单工作进程。</p>
</li>
<li>
<p>Parallel Seq Scan（并行顺序扫描）： CPU 高效（占用所有 CPU 内核），但 I/O 浪费（可能会为了过滤而读取超出你范围的块）。</p>
</li>
</ul>
<p>规划器经常会错误地选择并行顺序扫描，CPU 收益似乎超过了 I/O 损耗带来的负面影响。这导致数据库为了利用可用的工作进程，读取了比必要多得多的数据。</p>
<h2 data-id="heading-1">2. 修复方案：并行性与可变分块</h2>
<p>由 Cary Huang 开发并由 David Rowley 提交的代码，引入了允许 <code>Tid Range Scan</code> 参与并行查询计划的基础架构。该逻辑有效地将块范围分配给可用的并行工作进程。不再是一个进程从块 0 扫描到 N，多个工作进程可以并发地获取数据块。</p>
<p>实现（约 500 行代码）重用了并行顺序扫描中的“块分块（block chunking）”逻辑。但它不仅仅是将块范围平均分配给工作进程，因为如果表的某个部分数据密度更高，这种简单分配可能导致负载不均衡。</p>
<p>相反，它使用了衰减块大小策略 (decaying chunk size strategy)：</p>
<ul>
<li>大块开始 (Large Start)： 工作进程开始时领取大块的块，以最大限度地减少共享状态上的锁定开销。</li>
<li>逐渐减小 (Tapering Down)： 随着扫描的进行，分块大小会缩小。</li>
<li>颗粒化结束 (Granular Finish)： 到扫描结束时，工作进程每次只领取 1 个块。</li>
</ul>
<p>这种“缓慢减少”确保了我们不会最后只剩下一个工作进程在处理一个巨大的最终块，而其他工作进程却闲置着。它强制所有进程大致在同一时间跨过终点线。</p>
<h2 data-id="heading-2">3. 基准测试数据</h2>
<p>为了看到实际效果，我创建了一个包含 1000 万行的表 <code>bench_tid_range</code>，并使用 ctid 范围条件对表的前 50% 运行了 <code>count(*)</code> 查询。</p>
<p><strong>测试环境：</strong></p>
<ul>
<li>数据量：1000 万行</li>
<li>查询：<code>SELECT count(*) FROM bench_tid_range WHERE ctid &gt;= '(0,0)' AND ctid &lt; '(41667,0)'</code></li>
</ul>







































































<table><thead><tr><th align="left">环境</th><th align="left">工作进程数 (Workers)</th><th align="left">执行时间 (中位数)</th><th align="left">加速比</th></tr></thead><tbody><tr><td align="left"><strong>Before (Pg 18)</strong></td><td align="left">0</td><td align="left">448 ms</td><td align="left">1.00x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">0</td><td align="left">435 ms</td><td align="left">1.03x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">1</td><td align="left">238 ms</td><td align="left">1.88x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">2</td><td align="left">174 ms</td><td align="left">2.58x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">3</td><td align="left">151 ms</td><td align="left">2.97x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">4</td><td align="left">150 ms</td><td align="left">2.98x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">5</td><td align="left">147 ms</td><td align="left">3.05x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">6</td><td align="left">143 ms</td><td align="left">3.14x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">7</td><td align="left">147 ms</td><td align="left">3.04x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">8</td><td align="left">147 ms</td><td align="left">3.04x</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f5747229bf40ba9a48d04f819011e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133057&amp;x-signature=Y1K0Vej4ssh8IcXRQVx6GSy5HB8%3D" alt="1.png" loading="lazy"/></p>
<p>我们可以看到，仅仅启用 1 个工作进程（这实际上给了我们 2 个扫描进程：Leader + 1 个 Worker），执行时间就大幅下降。对于这个特定的工作负载，“最佳平衡点”似乎在 2-3 个工作进程左右。</p>
<h2 data-id="heading-3">4. 为什么不直接用“并行顺序扫描”？</h2>
<p>你可能会问：“为什么 Postgres v18 不直接选择并行顺序扫描？用 4 个工作进程扫描整个表难道不比用 1 个进程扫描半个表快吗？”</p>
<p>我通过强制设置 <code>enable_tidscan = off</code> 并使用 4 个工作进程测试了这一点：</p>
<ul>
<li>执行时间： ~230 ms。</li>
<li>I/O： 访问了所有 ~83k 个页面。</li>
</ul>
<p>新的并行 TID 范围扫描（~150 ms）仍然比暴力/强制的并行顺序扫描快 35%，而且它产生的 I/O 负载只有后者的一半（只访问了 ~41k 个页面）。这可谓两全其美：快速的执行时间（并行）和高效的资源使用（类似索引的范围界定）。</p>
<h2 data-id="heading-4">5. 这对工具意味着什么</h2>
<p>如果你维护在 Postgres 实例之间移动数据的内部脚本，你可能编写了手动计算块范围并将巨大的表划分为块、然后生成进程来运行它们的代码。</p>
<p>随着 PostgreSQL 19 的推出，这种复杂性可能可以被删除了。你可以发出更广泛的 TID 范围查询，并相信规划器会有效地在集群的 I/O 和 CPU 资源之间分配工作。</p>
<h2 data-id="heading-5">6. 如何复现测试</h2>
<p>这是设置测试表和运行基准测试的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建表</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> bench_tid_range;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bench_tid_range (id <span class="hljs-type">int</span>, payload text);

<span class="hljs-comment">-- 2. 插入 10M 行以生成 ~41k 个页面</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bench_tid_range
<span class="hljs-keyword">SELECT</span> x, <span class="hljs-string">'payload_'</span> <span class="hljs-operator">||</span> x
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>) x;

<span class="hljs-comment">-- 3. Vacuum 以设置可见性映射并冻结（对于稳定的基准测试很重要）</span>
VACUUM (ANALYZE, FREEZE) bench_tid_range;

<span class="hljs-comment">-- 4. 为会话启用并行</span>
<span class="hljs-keyword">SET</span> max_parallel_workers_per_gather <span class="hljs-operator">=</span> <span class="hljs-number">4</span>; <span class="hljs-comment">-- 尝试 2, 4, 8</span>
<span class="hljs-keyword">SET</span> min_parallel_table_scan_size <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">-- 即使对于较小的表也强制并行扫描</span>

<span class="hljs-comment">-- 5. 运行查询</span>
EXPLAIN (ANALYZE, BUFFERS)
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> bench_tid_range
<span class="hljs-keyword">WHERE</span> ctid <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'(0,0)'</span> <span class="hljs-keyword">AND</span> ctid <span class="hljs-operator">&lt;</span> <span class="hljs-string">'(41667,0)'</span>;
</code></pre>
<h2 data-id="heading-6">7. 结论</h2>
<p>这是一项令人欣喜的“底层”改进。它或许不会改变您日常的临时查询，但对于构建自定义数据维护脚本的数据库管理员和开发人员而言，并行执行基于 TID 的扫描功能是优化工具包中一项强大的新工具。</p>
<h2 data-id="heading-7">8. 参考</h2>
<p>本文部分内容是来自 <strong>Grant Zhou</strong> 和 <strong>Robins Tharakan</strong> 撰写的英文博客。</p>
<ul>
<li>提交 0ca3b169：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit.postgresql.org%2Fgitweb%2F%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3D0ca3b16973a8bb1c185f56e65edcadc0d9d2c406" target="_blank" title="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=0ca3b16973a8bb1c185f56e65edcadc0d9d2c406" ref="nofollow noopener noreferrer">git.postgresql.org/gitweb/?p=p…</a></li>
<li>讨论贴：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postgresql.org%2Fmessage-id%2Fflat%2F18f2c002a24.11bc2ab825151706.3749144144619388582%2540highgo.ca" target="_blank" title="https://www.postgresql.org/message-id/flat/18f2c002a24.11bc2ab825151706.3749144144619388582%40highgo.ca" ref="nofollow noopener noreferrer">www.postgresql.org/message-id/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhornetlabs.ca%2F2025%2F12%2F08%2Fspeeding-up-large-table-scans-with-parallel-tid-ranges-in-postgresql-19%2F" target="_blank" title="https://hornetlabs.ca/2025/12/08/speeding-up-large-table-scans-with-parallel-tid-ranges-in-postgresql-19/" ref="nofollow noopener noreferrer">hornetlabs.ca/2025/12/08/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.thatguyfromdelhi.com%2F2025%2F12%2F3x-faster-tid-range-scans-postgres-19.html" target="_blank" title="https://www.thatguyfromdelhi.com/2025/12/3x-faster-tid-range-scans-postgres-19.html" ref="nofollow noopener noreferrer">www.thatguyfromdelhi.com/2025/12/3x-…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[七大产品设计方法论：构建卓越软件产品的思维工具箱]]></title>    <link>https://juejin.cn/post/7582759716188012544</link>    <guid>https://juejin.cn/post/7582759716188012544</guid>    <pubDate>2025-12-12T09:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582759716188012544" data-draft-id="7582601349580062720" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="七大产品设计方法论：构建卓越软件产品的思维工具箱"/> <meta itemprop="keywords" content="产品,产品经理,资讯"/> <meta itemprop="datePublished" content="2025-12-12T09:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            七大产品设计方法论：构建卓越软件产品的思维工具箱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:18:06.000Z" title="Fri Dec 12 2025 09:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">七大产品设计方法论：构建卓越软件产品的思维工具箱</h2>
<blockquote>
<p>在快速变化的数字时代，打造一款成功的软件产品早已不是“功能堆砌”或“技术炫技”的游戏。真正打动用户、驱动增长的产品，背后往往有一套系统化的方法论支撑。本文将带你深入理解七种被全球顶尖团队广泛采用的产品设计框架——从洞察用户到衡量体验，从构思创意到快速验证——它们共同构成了现代产品人的“思维工具箱”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 用户中心设计（UCD）：一切从人出发</h3>
<p><strong>核心理念</strong>：产品是为用户服务的，设计必须围绕真实用户的需求、行为和情境展开。</p>
<p>UCD 不是一种具体流程，而是一种<strong>设计哲学</strong>。它强调在整个开发周期中持续引入用户反馈——通过访谈、观察、可用性测试等方式，确保每一步决策都基于对用户的深刻理解。</p>
<blockquote>
<p>📌 <strong>实践建议</strong>：不要等到上线才问用户“好不好用”。在需求阶段就邀请目标用户参与，哪怕只是草图评审。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">2. 双钻模型（Double Diamond）：结构化的问题解决路径</h3>
<p>由英国设计委员会提出，双钻模型将产品设计分为四个阶段：</p>
<ol>
<li><strong>发现（Discover）</strong> ：广泛探索问题空间（发散）</li>
<li><strong>定义（Define）</strong> ：聚焦核心问题（收敛）</li>
<li><strong>开发（Develop）</strong> ：生成多种解决方案（发散）</li>
<li><strong>交付（Deliver）</strong> ：打磨并落地最优方案（收敛）</li>
</ol>
<p>这个模型的价值在于<strong>明确区分“问题定义”与“方案设计”</strong> ，避免团队在没搞清“到底要解决什么”之前就急着写代码。</p>
<blockquote>
<p>💡 <strong>小技巧</strong>：用“5 Why 分析法”帮助你在 Define 阶段挖到真正的用户痛点。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3. 设计思维（Design Thinking）：以人为本的创新引擎</h3>
<p>源自 IDEO 和斯坦福 d.school，设计思维强调<strong>共情 → 定义 → 构思 → 原型 → 测试</strong>的循环迭代。</p>
<p>与双钻模型类似，但更强调<strong>跨学科协作</strong>与<strong>快速原型验证</strong>。它特别适合面对模糊、复杂甚至“未知的未知”问题（比如：如何提升老年人的数字包容性？）。</p>
<blockquote>
<p>✨ <strong>关键差异</strong>：设计思维不仅是流程，更是一种文化——鼓励试错、拥抱不确定性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">4. 敏捷开发 + Scrum：让价值持续流动</h3>
<p>如果说前面的方法聚焦“做什么”，那么敏捷开发回答的是“怎么做”。</p>
<p><strong>敏捷宣言</strong>的核心是：个体互动 &gt; 流程工具，可工作软件 &gt; 详尽文档，客户合作 &gt; 合同谈判，响应变化 &gt; 遵循计划。</p>
<p>而 <strong>Scrum</strong> 是最流行的敏捷框架之一，通过<strong>短周期冲刺（Sprint）</strong> 、每日站会、产品待办列表（Product Backlog）等机制，确保团队能快速响应反馈、持续交付价值。</p>
<blockquote>
<p>⚠️ 注意：敏捷不是“不做规划”，而是“用更灵活的方式规划”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">5. 精益创业（Lean Startup）与 MVP：用最小成本验证假设</h3>
<p>埃里克·莱斯提出的“构建—测量—学习”（Build-Measure-Learn）循环，彻底改变了产品验证逻辑。</p>
<p><strong>MVP（最小可行产品）</strong> 的本质不是“做简陋版”，而是<strong>用最低成本验证最关键假设</strong>。例如：</p>
<ul>
<li>Airbnb 最初只是用 Craigslist 上的照片搭建一个简单网页；</li>
<li>Dropbox 用一段演示视频测试用户兴趣。</li>
</ul>
<blockquote>
<p>🔍 <strong>关键问题</strong>：你的 MVP 能否回答“用户是否愿意为这个价值买单？”</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">6. JTBD（Jobs To Be Done）：用户“雇佣”你的产品做什么？</h3>
<p>传统用户画像常停留在“年龄、职业、兴趣”，而 JTBD 问的是更深层的问题：<strong>用户在什么情境下，想要完成什么“任务”？</strong></p>
<p>例如，用户买电钻不是为了“拥有一个钻头”，而是为了“在墙上打个洞挂画”。理解“任务”而非“产品”，能帮你发现未被满足的需求。</p>
<blockquote>
<p>🧩 <strong>应用示例</strong>：Slack 的成功并非因为“更好的聊天工具”，而是因为它帮团队完成了“减少邮件沟通、提升协作效率”这项任务。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">7. HEART 框架：用数据衡量用户体验</h3>
<p>Google 提出的 HEART 模型，将抽象的“用户体验”拆解为五个可度量维度：</p>
<ul>
<li><strong>H</strong>appiness（满意度）：NPS、用户评分</li>
<li><strong>E</strong>ngagement（参与度）：使用频率、停留时长</li>
<li><strong>A</strong>doption（采纳率）：新用户激活比例</li>
<li><strong>R</strong>etention（留存率）：回访用户占比</li>
<li><strong>T</strong>ask Success（任务完成率）：转化率、错误率</li>
</ul>
<p>有了 HEART，你就不再说“感觉体验变好了”，而是说：“通过优化注册流程，任务成功率从 65% 提升至 89%”。</p>
<blockquote>
<p>📊 <strong>最佳实践</strong>：为每个关键功能设定 1–2 个 HEART 指标，并纳入产品 OKR。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">如何组合使用这些方法论？</h3>
<p>没有哪一种方法能解决所有问题。高手的做法是<strong>按需调用、灵活组合</strong>：</p>
<ul>
<li>项目初期 → 用 <strong>UCD + JTBD + 设计思维</strong> 深度理解用户；</li>
<li>定义方向 → 用 <strong>双钻模型</strong> 聚焦真问题；</li>
<li>快速验证 → 用 <strong>精益创业 + MVP</strong> 测试核心假设；</li>
<li>开发落地 → 用 <strong>敏捷 + Scrum</strong> 高效协作；</li>
<li>上线后 → 用 <strong>HEART 框架</strong> 量化体验、驱动迭代。</li>
</ul>
<hr/>
<h3 data-id="heading-9">结语：方法论是脚手架，不是牢笼</h3>
<p>这些框架的价值，不在于你背得多熟，而在于你能否在复杂现实中<strong>灵活运用、持续反思、不断进化</strong>。正如设计师 Charles Eames 所说：</p>
<blockquote>
<p>“设计的细节不在形式，而在关系。”<br/>
——而这些方法论，正是帮我们理清“人、问题、方案、价值”之间关系的指南针。</p>
</blockquote>
<p>愿你在产品之路上，既有系统的思考，也有创造的勇气。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对标MinIO！全新一代分布式文件系统诞生！]]></title>    <link>https://juejin.cn/post/7582763878674661403</link>    <guid>https://juejin.cn/post/7582763878674661403</guid>    <pubDate>2025-12-12T09:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674661403" data-draft-id="7582791876365926438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对标MinIO！全新一代分布式文件系统诞生！"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-12T09:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对标MinIO！全新一代分布式文件系统诞生！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:18:49.000Z" title="Fri Dec 12 2025 09:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近 MinIO 官方在 README 中正式宣布项目进入“维护模式”：</p>
<ul>
<li><strong>不再接受新功能、增强或拉取请求</strong>：代码库仅进行维护，不再开发新特性。</li>
<li><strong>安全补丁和关键bug修复</strong>：会根据个案评估，但不是保证全面支持。</li>
<li><strong>问题和PR审查停止</strong>：现有issue不会积极处理，社区支持仅通过Slack提供最佳努力（best-effort）。</li>
<li><strong>企业版转向</strong>：官方推荐转向付费的MinIO AIStor（起价约$96,000/年，针对400TB），该版提供完整管理功能。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd4d81998bf14db5a202ef97554a87eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=YAfP8v9YWT%2FmRnf9oMF4vvIq7uI%3D" alt="" loading="lazy"/></p>
<p>这对很多把 MinIO 当作长期基础设施的团队来说，确实是一个坏消息。</p>
<p>不过也要理解，MinIO 开源这么多年，为 S3 兼容对象存储的普及立下了汗马功劳，社区里无数项目都曾经或正在依赖它。现在它选择把主要精力放在商业版上，这属于公司正常的商业决定。我们不骂它，只向前看：<strong>接下来用什么来替代它？</strong></p>
<h2 data-id="heading-0">RustFS（Rust，性能屠夫）</h2>
<p>在 MinIO 众多替代品中，<strong>RustFS</strong> 是最近热度最高的一颗新星。这个由国人团队主导的开源项目，目前GitHub Star数已狂飙至<strong>15k+</strong>，增速非常夸张。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04ea701c9c1b461a9350a3eabb5f6855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=o4TCHxVHimgbi9JooRDc%2FnAu8YE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/717970a34ad44d45bd21717902bd31cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=pkuqvEdyTXbUHPcjmY0A3VbADXw%3D" alt="" loading="lazy"/></p>
<p>RustFS 是一个基于 Rust 语言开发的高性能分布式对象存储软件，定位与 MinIO 高度相似，功能基本对齐 MinIO 开源版（包括分片上传、桶策略、版本控制、事件通知、生命周期管理等），完全兼容 AWS S3 协议，部署简单（Docker 一键启动），并提供现代化的可视化管理控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcabc11ac4954aa0a882fc3b46a57e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=LMyHyRbYK21plnkV8%2FCfOax4M3o%3D" alt="" loading="lazy"/></p>
<p>根据官方同等硬件压测，RustFS在小对象（4KB）场景下吞吐量约为MinIO的<strong>2.3倍</strong>，大对象场景也高达<strong>1.8~2.2倍</strong>。</p>
<p>与 MinIO 不同的是，RustFS 采用宽松的Apache 2.0许可证，对商业闭源产品更加友好。</p>
<p>这是官方提供的RustFS 与其他存储产品对比：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84b4368269d4d6eae08cb5470522191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=MxBApBirXcrP9fqlgTt7GqW9yN8%3D" alt="" loading="lazy"/></p>
<p>项目还比较新（2024年底后才真正火起来），分布式模式仍在快速迭代中。对于追求极致稳定的大规模生产集群，建议先在测试/灰度环境中充分验证，或观望社区再演进6-12个月等1.0 正式版发布！</p>
<p>项目还比较新（真正火起来是 2024 年底之后），目前还处在 <code>1.0.0-alpha</code> 阶段，分布式模式仍在快速迭代中。对于追求极致稳定、规模很大的生产集群，<strong>建议先在测试 / 灰度环境中充分验证，或观望社区再演进 6～12 个月，等 1.0 正式版发布再做全面迁移决策。</strong></p>
<p>如果是单机 / 小规模集群的话，完全可以上生产环境用了，根据大量使用者反馈，非常稳定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac24264bd2b443c48a9dbf568ec23cae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=y6yYguLZ5K4M7oX7UfRF1Y5Kjf8%3D" alt="" loading="lazy"/></p>
<p>再多一点，RustFS 的贡献者名单里能看到不少技术大佬，比如 PHP 大神安正超。而且，这个项目处理 issue 的速度比较快，使用遇到什么 bug，一般能够在比较短的时间就处理解决。</p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Frustfs.com" target="_blank" title="https://rustfs.com" ref="nofollow noopener noreferrer">rustfs.com</a></strong></li>
<li>GitHub：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">github.com/rustfs/rust…</a></strong></li>
</ul>
<h2 data-id="heading-1">Garage（Rust，中小规模自托管）</h2>
<p>Garage 是一款 <strong>S3 兼容的分布式对象存储服务</strong>，主要面向 <strong>小到中型的自托管环境</strong>。它的目标不是构建超大规模云平台，而是让你能在几台服务器上，轻松跑起一个可靠、容错的对象存储。而且，能轻松跨越不同物理位置（如多个机房、家庭宽带+云主机组合）部署，即使部分节点掉线，数据依然可用。</p>
<p>用一句话概括：<strong>Garage 是一套适合“自己搭、小团队用、多节点部署”的 S3 存储系统。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3413954ac7604dd1b7f6724075ca8bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=1EFVmrYYy%2FTaZTh1EG3fWierqcA%3D" alt="" loading="lazy"/></p>
<p>为了让管理更简单，Garage 同样提供了一个独立的 Web 管理界面 —— <strong>Garage Web UI</strong>。它是 Garage 对象存储的前端控制台，帮助你通过浏览器完成日常运维工作，主要功能包括：健康状态监控、桶（Bucket）管理、对象浏览、访问密钥管理等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0bdccdb07a34d22bcd8d576e1fd9286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=ZGS%2FuzNs2tKwoxyPV83Qgu%2BQkQU%3D" alt="" loading="lazy"/></p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgaragehq.deuxfleurs.fr" target="_blank" title="https://garagehq.deuxfleurs.fr" ref="nofollow noopener noreferrer">garagehq.deuxfleurs.fr</a></strong></li>
<li>仓库（自托管）：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgit.deuxfleurs.fr%2FDeuxfleurs%2Fgarage" target="_blank" title="https://git.deuxfleurs.fr/Deuxfleurs/garage" ref="nofollow noopener noreferrer">git.deuxfleurs.fr/Deuxfleurs/…</a></strong></li>
</ul>
<h2 data-id="heading-2">Ceph（C++，老牌分布式存储鼻祖）</h2>
<p>Ceph 是开源分布式存储领域的元老项目，社区活跃度和成熟度都非常高，当前仍是开源分布式存储第一梯队。它提供 <strong>对象存储（RGW，兼容 S3）</strong>、<strong>块存储（RBD）</strong> 和 <strong>文件存储（CephFS）</strong> 三合一的统一存储平台，能够在普通硬件之上，构建从PB到EB级、无单点故障的大规模集群。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d9514f7634c85b59b2d7bbbff1841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=ukSHtPIWhXWNupLI8RD4n8GGNJU%3D" alt="" loading="lazy"/></p>
<p>Ceph 还支持多租户隔离，满足复杂企业环境的需求。</p>
<p>与MinIO最大的区别在于：<strong>Ceph是“全能型平台”，MinIO是“专精型工具”</strong>。Ceph架构复杂，运维门槛高，适合有专业存储/运维团队的中大型企业。</p>
<p>Ceph不太适合单机或小规模存储、对单次请求延迟极其敏感的业务、高频率小文件读写以及对运维简单性要求很高的中小团队。</p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fceph.io%2F" target="_blank" title="https://ceph.io/" ref="nofollow noopener noreferrer">ceph.io/</a></strong></li>
<li>Github：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fceph%2Fceph" target="_blank" title="https://github.com/ceph/ceph" ref="nofollow noopener noreferrer">github.com/ceph/ceph</a></strong></li>
</ul>
<h2 data-id="heading-3">SeaweedFS（Go，海量小文件神器）</h2>
<p>SeaweedFS 是专为“几十亿小文件 + 高并发读写”场景设计的高性能分布式存储系统。其核心设计灵感源自 Facebook 的 Haystack 论文，通过将元数据分散到卷服务器（Volume Server），实现了单次磁盘访问 O(1) 的极致读取效率。它社区活跃度高，文档完善，且架构轻量，运维成本远低于 Ceph。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88a859c8503b4992ae31d9b3d1a598a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=693ewp58%2BLIypx41hy7eur2yf3g%3D" alt="" loading="lazy"/></p>
<p>和 Ceph/MinIO 的区别在于：<strong>SeaweedFS 是为“小文件性能”而生的特种部队</strong>。它解决了传统文件系统在处理海量小文件时元数据成为瓶颈的痛点。不过，这并不代表其不可以存储大文件，只是在小文件场景优势更大。</p>
<p><strong>适合的场景：</strong></p>
<ul>
<li>海量小文件存储，如图片、社交媒体内容。</li>
<li>需要极低延迟读取的业务，如实时头像获取、缩略图服务。</li>
<li>包含数亿张小图片或音频片段的机器学习训练集存储。</li>
<li>大规模日志文件的顺序写入与存储。</li>
</ul>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fseaweedfs.com%2F" target="_blank" title="https://seaweedfs.com/" ref="nofollow noopener noreferrer">seaweedfs.com/</a></strong></li>
<li>Github：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fseaweedfs%2Fseaweedfs" target="_blank" title="https://github.com/seaweedfs/seaweedfs" ref="nofollow noopener noreferrer">github.com/seaweedfs/s…</a></strong></li>
</ul>
<h2 data-id="heading-4">云厂商对象存储（OSS / COS / S3 等）</h2>
<p>云厂商提供的对象存储服务（Object Storage Service，OSS / COS / S3）是一种<strong>海量、安全、低成本且高度可靠</strong>的云存储形态，适合存放任意类型的文件。容量与吞吐可以按需弹性扩展，并提供多种存储类型，帮助优化整体存储成本。</p>
<p>常见提供对象存储服务的云厂商包括：<strong>阿里云 OSS、腾讯云 COS、七牛云、AWS S3</strong> 等。</p>
<p>云厂商对象存储的优势如下：</p>
<ul>
<li><strong>可靠性强</strong> ： 拿阿里云对象存储 OSS（Object Storage Service）为例说明，其可提供 99.9999999999%（12 个 9）的数据持久性，99.995%的数据可用性。</li>
<li><strong>安全性强</strong>：对象存储服务一般都会支持防盗链配置（可屏蔽恶意来源的访问）、基于 SSL 和 TLS 的 HTTPS 数据加密传输、文件版本控制（防止文件被误删除或覆盖而造成数据丢失）、控制每个单独文件的读写权限等功能。</li>
<li><strong>扩展性强</strong>：不限制存储空间大小。您可以根据所需存储量无限扩展存储空间，解决了传统硬件存储扩容问题。</li>
<li><strong>成本较低</strong>：无需传统硬件的采购、部署和运维，支持按量付费。</li>
<li><strong>接入方便</strong>：对象存储服务一般都会提供标准的 RESTful API 接口、丰富的 SDK 包、客户端工具、控制台。</li>
<li>……</li>
</ul>
<h2 data-id="heading-5">总结</h2>
<p>这张表格是我让 Gemini 3 Pro 做的总结对比，可供参考（会有幻觉问题）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2e630d579e4fb8a6c8382afd7278e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=NXLV0RgTH%2FzWdreQ8%2FCF0n4ydVg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f9b240e0ac423083b17621bddeb7df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=Z9iWh7yGN9wiA%2BhclYm2Sv6Oeuo%3D" alt="" loading="lazy"/></p>
<p><strong>对于个人开发者或中小团队：</strong></p>
<ul>
<li>如果你的需求是快速自建一个S3兼容存储，数据量不大，强烈推荐先尝试<strong>Garage</strong>（部署最轻量、对环境要求低）或 <strong>RustFS</strong>（功能更全，性能更强）。</li>
<li>如果只是存一些图片、视频等普通业务文件，而且对“可用性省心、少运维”更看重，  那么直接用<strong>云厂商的 OSS / COS / S3</strong> 往往是成本和精力投入都更优的选择（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGCVnMF2WojsG34wRzXy3JA" target="_blank" title="https://mp.weixin.qq.com/s/GCVnMF2WojsG34wRzXy3JA" ref="nofollow noopener noreferrer">JavaGuide(javaguide.cn)</a>上所有的图片都存放在 OSS 中）。</li>
</ul>
<p><strong>如果你已经在用 MinIO</strong>：如果老版本还能稳定运行，完全可以“让子弹再飞一会儿”。可以考虑利用这段时间搭一套 RustFS / Garage / 其他方案的测试环境，预研迁移路径和成本。等到 <strong>RustFS</strong> 发布 <strong>1.0 正式版</strong>，再结合自身业务节奏做整体迁移决策，会更稳妥。</p>
<p><strong>对于中大型企业或有复杂需求的用户：</strong></p>
<ul>
<li>预算允许、对可用性和合规要求高时，直接用 <strong>云厂商 OSS / COS / S3</strong> 依然是总体成本最低、心智负担最小的选择——把精力放在业务而不是存储底座上。</li>
<li>必须自建时：
<ul>
<li>追求 <strong>统一块 / 文件 / 对象 + 超大规模集群</strong> → 重点评估 <strong>Ceph / CubeFS</strong>。</li>
<li>业务以 <strong>海量小文件、高并发访问</strong> 为主 → <strong>SeaweedFS</strong> 会比通用对象存储更合适。</li>
<li>可以接受新技术栈、希望在对象存储层拿到 <strong>更高性能与更友好的开源协议（Apache 2.0）</strong> → <strong>RustFS</strong> 值得列入中长期主力选型。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值]]></title>    <link>https://juejin.cn/post/7582759716188061696</link>    <guid>https://juejin.cn/post/7582759716188061696</guid>    <pubDate>2025-12-12T09:24:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582759716188061696" data-draft-id="7582783931162820643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值"/> <meta itemprop="keywords" content="产品,产品经理,资讯"/> <meta itemprop="datePublished" content="2025-12-12T09:24:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:24:31.000Z" title="Fri Dec 12 2025 09:24:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在大模型浪潮席卷全球的今天，“AI产品经理”已成为科技行业最炙手可热的角色之一。但热潮之下，一个关键问题浮出水面：<br/>
<strong>当人人都在谈“AI+产品”，真正能驾驭这场变革的产品经理，究竟靠什么脱颖而出？</strong></p>
<p>答案不是会写 Prompt，也不是背诵 Transformer 原理，而是——<strong>在技术可能性、用户真实需求与商业可持续性之间，构建精准的判断力与高效的执行力</strong>。</p>
<p>本文将从四大维度，系统拆解 AI 产品经理的核心竞争力。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、技术理解力：不是成为工程师，而是成为“技术翻译者”</h2>
<p>AI PM 不需要写训练代码，但必须<strong>理解关键技术的边界、成本与适用场景</strong>。这是你与算法团队高效协作、避免“空中楼阁”式需求的基础。</p>
<h3 data-id="heading-1">关键能力项：</h3>
<ul>
<li>
<p><strong>掌握主流 AI 架构的适用逻辑</strong><br/>
能清晰区分何时用 RAG、何时微调、何时构建 Agent，并说明理由。例如：</p>
<blockquote>
<p>“RAG 适合知识高频更新、领域广但深度要求不高的场景；而微调更适合语言风格、术语体系高度定制化的垂直任务。”</p>
</blockquote>
</li>
<li>
<p><strong>理解数据闭环与模型迭代机制</strong><br/>
知道 bad case 如何被自动捕获、标注、回流训练，形成“产品→数据→模型→产品”的飞轮。</p>
</li>
<li>
<p><strong>关注推理成本与工程约束</strong><br/>
能预判延迟（latency）、并发量（QPS）、显存占用对用户体验的影响。例如：“70B 模型虽强，但响应超 5 秒，用户流失率上升 60%”。</p>
</li>
</ul>
<h3 data-id="heading-2">面试体现方式：</h3>
<blockquote>
<p>“我们在设计智能投研助手时，评估了三种方案：全微调、RAG、RAG+轻量微调。最终选择后者，因为既要保证金融术语准确性（需微调），又要支持实时财报问答（需 RAG）。我们用 LoRA 将微调成本控制在每日 $15，同时通过缓存高频 query 降低 API 调用频次。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、用户洞察力：穿透“AI 幻觉”，回归真实任务</h2>
<p>AI 的强大容易让人陷入“技术自嗨”——以为炫酷的生成能力就是用户所需。但真正的 AI PM 必须追问：</p>
<blockquote>
<p><strong>用户到底想完成什么“任务”？AI 是帮手，还是干扰？</strong></p>
</blockquote>
<h3 data-id="heading-4">关键能力项：</h3>
<ul>
<li>
<p><strong>用 JTBD（Jobs-To-Be-Done）框架定义问题</strong><br/>
不问“用户想要什么功能”，而问“用户在什么情境下，试图完成什么目标？”<br/>
例：用户不是要“聊天机器人”，而是要“快速起草一封专业英文邮件”。</p>
</li>
<li>
<p><strong>识别 AI 的“可用性陷阱”</strong></p>
<ul>
<li>幻觉（Hallucination）导致信任崩塌</li>
<li>输出不稳定引发操作焦虑</li>
<li>缺乏可解释性让用户不敢决策</li>
</ul>
</li>
<li>
<p><strong>设计“人机协同”体验</strong><br/>
明确 AI 负责什么（信息聚合、初稿生成），人类负责什么（审核、决策、情感表达），并提供清晰的控制权（如“重写”、“引用来源”、“调整语气”）。</p>
</li>
</ul>
<h3 data-id="heading-5">面试体现方式：</h3>
<blockquote>
<p>“我们发现用户对 AI 生成的法律合同不敢直接使用。于是我们在输出中强制标注每条条款的法规依据，并加入‘风险提示’模块。同时提供‘人工律师复核’入口——转化率提升 2.3 倍，NPS 从 -15 升至 +42。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、产品架构力：从功能堆砌到系统设计</h2>
<p>传统 PM 关注功能列表，而 AI PM 必须设计<strong>端到端的智能系统</strong>——包括数据流、反馈环、失败处理、安全边界。</p>
<h3 data-id="heading-7">关键能力项：</h3>
<ul>
<li>
<p><strong>构建可扩展的 AI 产品架构</strong><br/>
能绘制包含以下模块的系统图：</p>
<ul>
<li>输入层（用户 query / 多模态信号）</li>
<li>意图识别与路由（是否走 RAG？是否调工具？）</li>
<li>执行引擎（Agent 工作流、工具链）</li>
<li>输出层（生成 + 引用 + 可控参数）</li>
<li>监控层（幻觉检测、延迟告警、用户反馈）</li>
</ul>
</li>
<li>
<p><strong>设计评估与迭代机制</strong><br/>
不仅看准确率，更建立多维指标：</p>
<ul>
<li><strong>任务成功率</strong>（Task Success Rate）</li>
<li><strong>用户干预率</strong>（Human Takeover Rate）</li>
<li><strong>信任度评分</strong>（Trust Score via A/B Test）</li>
<li><strong>单位经济模型</strong>（Cost per Query vs. Revenue）</li>
</ul>
</li>
<li>
<p><strong>预设失败路径（Fallback Strategy）</strong><br/>
当 AI 不确定时，如何优雅降级？转人工？返回空结果？提供选项？这直接决定产品鲁棒性。</p>
</li>
</ul>
<h3 data-id="heading-8">面试体现方式：</h3>
<blockquote>
<p>“我们的 Agent 系统内置三层 fallback：第一层是置信度阈值，低于 0.7 则追问澄清；第二层是规则引擎兜底（如查天气走固定 API）；第三层是转接人工客服。上线后，用户投诉率下降 78%。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、商业判断力：让 AI 从成本中心走向价值引擎</h2>
<p>AI 项目往往烧钱快、见效慢。优秀的 AI PM 必须回答：</p>
<blockquote>
<p><strong>这个 AI 功能，如何带来收入、降低成本、或构建竞争壁垒？</strong></p>
</blockquote>
<h3 data-id="heading-10">关键能力项：</h3>
<ul>
<li>
<p><strong>量化 ROI</strong><br/>
计算：AI 替代人力节省的成本 vs. 模型推理+维护成本。<br/>
例：“客服机器人每月节省 200 人天，但 API 成本 $8K，净收益为正。”</p>
</li>
<li>
<p><strong>设计可变现的 AI 产品形态</strong></p>
<ul>
<li>按 query 计费（如 Perplexity）</li>
<li>按能力分级（基础版免费，高级分析付费）</li>
<li>嵌入工作流（如 Notion AI 提升留存）</li>
</ul>
</li>
<li>
<p><strong>识别“伪 AI 需求”</strong><br/>
警惕为了“蹭热点”而强行加 AI 的功能。例如：一个简单的表单填写，用规则引擎比 LLM 更可靠、更便宜。</p>
</li>
</ul>
<h3 data-id="heading-11">面试体现方式：</h3>
<blockquote>
<p>“我们最初想给 CRM 加‘AI 自动生成客户画像’，但测算发现：销售团队每天只花 2 分钟手动录入，而 AI 方案月成本 $12K。于是我们转向高价值场景——用 AI 分析会议录音生成行动项，该功能成为 Premium 订阅的关键卖点，带动 ARPU 提升 18%。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">五、核心竞争力总结：AI PM 的“黄金三角”</h2>

























<table><thead><tr><th>维度</th><th>能力</th><th>衡量标准</th></tr></thead><tbody><tr><td><strong>技术理解力</strong></td><td>知道 AI 能做什么、不能做什么、代价是什么</td><td>能与算法工程师对齐技术方案，避免不切实际的需求</td></tr><tr><td><strong>用户洞察力</strong></td><td>穿透技术表象，抓住真实任务与情感诉求</td><td>用户愿意为你的 AI 功能付费或主动使用</td></tr><tr><td><strong>商业判断力</strong></td><td>将 AI 转化为可持续的价值单元</td><td>项目有明确 ROI，或构建长期竞争壁垒</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>终极标志</strong>：你不再说“我们要做一个 AI 产品”，而是说<br/>
<strong>“我们用 AI 解决 X 用户在 Y 场景下的 Z 问题，成本可控、效果可测、价值可扩。”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-13">结语：AI 产品经理，是新时代的“系统设计师”</h2>
<p>未来的 AI 产品，不再是“前端+后端+数据库”的组合，而是“用户意图 + 数据引擎 + 智能代理 + 反馈闭环”的复杂系统。<br/>
AI 产品经理，正是这个系统的<strong>架构师、翻译官与守门人</strong>。</p>
<p>你不需要成为最懂算法的人，但必须是最懂“如何让算法服务于人”的人。</p>
<p>而这，就是不可替代的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践]]></title>    <link>https://juejin.cn/post/7582637280218103862</link>    <guid>https://juejin.cn/post/7582637280218103862</guid>    <pubDate>2025-12-12T09:20:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582637280218103862" data-draft-id="7582561515817779263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T09:20:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:20:59.000Z" title="Fri Dec 12 2025 09:20:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多开发者眼中，<strong>iPhone 文件管理</strong> 似乎只是“看看 Documents 里有什么文件”，但在真实的开发、测试与问题排查过程中，文件系统往往是最容易被忽略、却又最容易出问题的一环。</p>
<p>无论是以下场景：</p>
<ul>
<li>App 占用空间越来越大</li>
<li>图片、音频、视频缓存无法回收</li>
<li>WebView / Hybrid 页面缓存异常</li>
<li>SQLite / Realm 文件膨胀</li>
<li>日志文件过多导致性能下降</li>
<li>测试环境需要快速替换本地数据</li>
<li>崩溃日志、运行日志需要导出分析</li>
</ul>
<p>这些问题的核心，其实都指向一个点：<strong>iPhone 文件管理是否可控、可观测、可操作</strong>。</p>
<p>本文基于真实工程实践，从开发者角度系统梳理 iPhone 文件管理的技术背景，并结合 <strong>Xcode、Finder / iTunes、克魔（KeyMob）、Safari Inspector、Charles、Console.app</strong> 等工具，构建一套可落地的多工具文件管理与调试方案。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 iPhone 文件管理对开发者如此重要？</h2>
<p>iOS 的安全机制决定了文件管理并非“随便看看文件”那么简单，但这并不意味着它不重要，恰恰相反：</p>
<h3 data-id="heading-1"><strong>1. 文件系统直接影响性能</strong></h3>
<ul>
<li>缓存文件过多 → 启动变慢</li>
<li>日志文件暴涨 → I/O 压力增加</li>
<li>数据库频繁读写 → 卡顿、耗电</li>
</ul>
<h3 data-id="heading-2"><strong>2. 很多线上问题只能从文件层面解释</strong></h3>
<ul>
<li>图片缓存异常</li>
<li>视频重复下载</li>
<li>WebView 缓存不释放</li>
<li>App 占用空间异常增长</li>
</ul>
<h3 data-id="heading-3"><strong>3. 文件是调试、测试、复现问题的关键媒介</strong></h3>
<ul>
<li>通过替换本地文件快速构造测试环境</li>
<li>导出用户数据进行问题复现</li>
<li>分析日志文件还原真实执行路径</li>
</ul>
<p>如果无法有效管理 iPhone 文件系统，很多问题只能“靠猜”。</p>
<hr/>
<h2 data-id="heading-4">二、iOS 沙盒结构：iPhone 文件管理的基础认知</h2>
<p>每个 iOS App 都运行在独立沙盒中，核心目录包括：</p>
<h3 data-id="heading-5"><strong>Documents</strong></h3>
<ul>
<li>用户生成数据</li>
<li>需要长期保存的数据</li>
<li>会参与 iCloud 备份</li>
</ul>
<h3 data-id="heading-6"><strong>Library</strong></h3>
<ul>
<li>Application Support（数据库、配置）</li>
<li>Caches（缓存数据）</li>
<li>Preferences（plist）</li>
</ul>
<h3 data-id="heading-7"><strong>tmp</strong></h3>
<ul>
<li>临时文件</li>
<li>系统可随时清理</li>
</ul>
<p>理解这些目录的用途，是文件管理的前提。</p>
<hr/>
<h2 data-id="heading-8">三、Xcode：开发阶段最基础的文件查看方式</h2>
<h3 data-id="heading-9"><strong>1. Devices and Simulators</strong></h3>
<p>通过 Xcode 可以：</p>
<ul>
<li>下载 App 容器</li>
<li>查看沙盒文件</li>
<li>导出数据库、日志、配置文件</li>
</ul>
<p>适合：</p>
<ul>
<li>开发阶段验证</li>
<li>简单文件检查</li>
</ul>
<h3 data-id="heading-10"><strong>局限性</strong></h3>
<ul>
<li>操作效率低</li>
<li>无法实时同步</li>
<li>不适合频繁文件操作</li>
<li>不支持复杂批量管理</li>
</ul>
<p>Xcode 更像是“应急查看工具”，而不是完整的文件管理方案。</p>
<hr/>
<h2 data-id="heading-11">四、Finder / iTunes：面向用户级别的文件管理</h2>
<p>通过 Finder（macOS Catalina+）或 iTunes（旧系统），可以：</p>
<ul>
<li>访问 App 的 Documents 目录</li>
<li>拖拽导入 / 导出文件</li>
<li>用于测试资源替换</li>
</ul>
<p>适合场景：</p>
<ul>
<li>测试环境构造</li>
<li>Demo 数据导入</li>
</ul>
<p>但它同样存在明显不足：</p>
<ul>
<li>只能访问 Documents</li>
<li>无法查看 Library、Caches</li>
<li>无法分析系统文件</li>
<li>无法配合调试流程</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、克魔（KeyMob）：开发者视角下的 iPhone 文件管理工具</h2>
<p>在真实工程中，开发者更需要的是<strong>跨平台、可视化、可操作的文件管理能力</strong>。</p>
<h3 data-id="heading-13"><strong>1. 全沙盒文件结构查看</strong></h3>
<p>KeyMob 可以查看：</p>
<ul>
<li>Documents</li>
<li>Library / Caches</li>
<li>Application Support</li>
<li>日志文件</li>
<li>数据库文件</li>
<li>WebView 缓存目录</li>
</ul>
<p>这对于定位文件膨胀、缓存异常非常关键。</p>
<h3 data-id="heading-14"><strong>2. 文件操作能力</strong></h3>
<p>支持：</p>
<ul>
<li>创建 / 删除文件</li>
<li>上传文件到 iPhone</li>
<li>从 iPhone 导出文件</li>
<li>批量操作</li>
</ul>
<p>适用于：</p>
<ul>
<li>快速替换测试数据</li>
<li>复现用户问题</li>
<li>调试复杂业务逻辑</li>
</ul>
<h3 data-id="heading-15"><strong>3. 不越狱前提下的文件管理</strong></h3>
<p>这是 iOS 文件管理中非常重要的一点，避免破坏系统环境。</p>
<hr/>
<h2 data-id="heading-16">六、文件管理与日志分析的结合价值</h2>
<p>文件管理不只是“看文件”，更重要的是 <strong>与日志、性能问题关联分析</strong>。</p>
<h3 data-id="heading-17">常见场景：</h3>
<ul>
<li>查看日志文件是否无限增长</li>
<li>对比不同版本生成的配置文件差异</li>
<li>分析 WebView 缓存文件大小变化</li>
<li>检查数据库文件是否异常增大</li>
</ul>
<p>通过文件层面，很多问题可以直观暴露。</p>
<hr/>
<h2 data-id="heading-18">七、Safari Inspector：WebView 文件与缓存的调试入口</h2>
<p>对于 Hybrid / uni-app 项目，文件管理离不开 Safari Inspector。</p>
<h3 data-id="heading-19">可辅助分析：</h3>
<ul>
<li>WebView 缓存目录</li>
<li>IndexedDB / LocalStorage 使用情况</li>
<li>资源是否重复缓存</li>
<li>JS 生成文件是否未清理</li>
</ul>
<p>很多 WebView 占用空间异常的问题，其实源自前端资源管理不当。</p>
<hr/>
<h2 data-id="heading-20">八、Charles：网络资源与本地文件的对应关系</h2>
<p>文件管理还需要结合网络行为一起看：</p>
<h3 data-id="heading-21">Charles 可以帮助你确认：</h3>
<ul>
<li>资源是否重复下载</li>
<li>是否缺失缓存控制</li>
<li>大文件是否落盘到缓存目录</li>
<li>失败重试是否生成多份临时文件</li>
</ul>
<p>通过 Charles + 文件管理工具，可以建立“网络 → 本地文件”的完整链路。</p>
<hr/>
<h2 data-id="heading-22">九、Console.app：从系统角度观察文件相关异常</h2>
<p>某些文件问题会直接反映在系统日志中，例如：</p>
<pre><code class="hljs language-css" lang="css">disk <span class="hljs-selector-tag">I</span>/O error
no space <span class="hljs-attribute">left</span> on device
failed <span class="hljs-selector-tag">to</span> write file
sandbox deny file-write
</code></pre>
<p>这些日志往往是文件管理问题的直接证据。</p>
<hr/>
<h2 data-id="heading-23">十、构建开发者视角的 iPhone 文件管理工具矩阵</h2>








































<table><thead><tr><th>需求场景</th><th>工具组合</th><th>作用</th></tr></thead><tbody><tr><td>基础查看</td><td>Xcode</td><td>简单导出容器</td></tr><tr><td>用户数据导入</td><td>Finder / iTunes</td><td>Documents 文件</td></tr><tr><td>全沙盒管理</td><td>KeyMob</td><td>文件浏览与操作</td></tr><tr><td>WebView 缓存分析</td><td>Safari Inspector</td><td>前端存储</td></tr><tr><td>网络文件对应</td><td>Charles</td><td>资源与缓存</td></tr><tr><td>系统异常定位</td><td>Console.app</td><td>文件错误日志</td></tr></tbody></table>
<p>这是一个真正实用的文件管理体系。</p>
<hr/>
<h2 data-id="heading-24">iPhone 文件管理是开发调试的重要基础能力</h2>
<p>一个成熟的 iOS 团队，文件管理能力至少应做到：</p>
<p><strong>可查看 → 可操作 → 可分析 → 可对比 → 可清理</strong></p>
<p>而这依赖多工具协同：</p>
<ul>
<li>Xcode（基础容器）</li>
<li>Finder / iTunes（用户数据）</li>
<li>KeyMob（全沙盒管理）</li>
<li>Safari Inspector（WebView 文件）</li>
<li>Charles（网络资源）</li>
<li>Console.app（系统日志）</li>
</ul>
<p>当文件管理能力完善后，性能、稳定性、调试效率都会显著提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重磅更新！OpenAI最新模型GPT 5.2上线]]></title>    <link>https://juejin.cn/post/7582755817671557130</link>    <guid>https://juejin.cn/post/7582755817671557130</guid>    <pubDate>2025-12-12T09:23:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817671557130" data-draft-id="7582763878674726939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重磅更新！OpenAI最新模型GPT 5.2上线"/> <meta itemprop="keywords" content="OpenAI"/> <meta itemprop="datePublished" content="2025-12-12T09:23:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪吒编程"/> <meta itemprop="url" content="https://juejin.cn/user/581021766790141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重磅更新！OpenAI最新模型GPT 5.2上线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/581021766790141/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪吒编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:23:52.000Z" title="Fri Dec 12 2025 09:23:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4499529ec3754c7f9f5dfdd25c6cc033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=yQneV42uVCKjuqMBVj4AkSimEos%3D" alt="" loading="lazy"/></p>
<p>11月18日，谷歌发布最新旗舰模型Gemini 3 Pro。</p>
<p>11月20日，谷歌发布最新AI绘画模型Nano Banana Pro。</p>
<p>11月25日，Anthropic公司发布最新旗舰模型Claude Opus 4.5。</p>
<p>Gemini 3 Pro和Claude Opus 4.5获得了很高的关注和评测评价，给 OpenAI 现有产品 GPT 5.1 带来显著竞争压力。</p>
<p>OpenAI CEO 山姆·奥特曼 在 2025 年 12 月初向全体员工发布内部备忘录，宣布 OpenAI 进入 “红色警报/Code Red”紧急状态。</p>
<p>这是OpenAI对竞争压力做出最高级别的战略响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72492c7c67344d8baf5c2757a1e39619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=a9l862XXpb4RQzG2WmMBS8SeKSw%3D" alt="" loading="lazy"/></p>
<p>12月12日，也就是今日凌晨，OpenAI打响反击战，GPT 5.2发布。</p>
<p>上线三种模型，GPT‑5.2 Instant、GPT‑5.2 Thinking 和 GPT‑5.2 Pro。</p>
<h2 data-id="heading-0">国内直接使用Gemini 3 Pro</h2>
<p>谷歌浏览器访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nezhasoft.com" target="_blank" title="https://www.nezhasoft.com" ref="nofollow noopener noreferrer">www.nezhasoft.com</a></p>
<p><strong>私信哪吒，备注体验ai，领取体验码。</strong></p>
<p>包含GPT-5.2、GPT-5.2 Thinking、Gemini 3 Pro、Nano Banana Pro、Claude Sonnet 4.5、Codex、Sora2、Grok4.1等模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4d74d024e524002929b6106952496a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=YxABx6eZ2lW8pXAV7pRIfFcqC7U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">排行榜SOTA水平</h2>
<h3 data-id="heading-2">1、通用测试</h3>
<p>GPT‑5.2 在通用智能、长上下文理解、智能体工具调用以及视觉方面都有显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18ee691cab5e412f913f6164404faf96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=%2F%2FoV9uxxAXRwqmNGqhOZXxftAM0%3D" alt="" loading="lazy"/></p>
<p>GPT‑5.2在制作电子表格、设计演示文稿、编写代码、识别图像、理解长文本上下文、使用工具以及处理复杂的多步骤项目方面表现更佳。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5c9b6124574530b44afcde75e3225f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=5APl0n3iLlzcQ8O9m4U3FkYvzGs%3D" alt="幻觉率" loading="lazy"/></p>
<p>幻觉率</p>
<h3 data-id="heading-3">2、幻觉率</h3>
<p>OpenAI 最新发布的 GPT-5.2 整体更聪明、更可靠，尤其是在减少“胡说”方面进步明显。</p>
<p>GPT-5.2在商业、金融、法律等专业领域的错误率都比之前版本更低，内容更准确；学术写作也更稳健。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5839615d6c634554aafa0b84de48b1cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=zUs0HuYRLMEyxPjcXUIKp1AjTTY%3D" alt="AI 大模型能力评测" loading="lazy"/></p>
<p>AI 大模型能力评测</p>
<h3 data-id="heading-4">3、AI 大模型能力评测</h3>
<p>GPT 5.2 在 AI 大模型能力评测对比中，全部刷新SOTA。</p>
<p>在多项能力测试中全面领先上一代模型GPT 5.1。</p>
<p>它在科学题、数学竞赛、图表理解和抽象推理等高难度任务上都有大幅提升，例如数学拿到 100%，科学题达 92.4%。</p>
<p>与 Claude 和 Gemini 相比也表现更突出。</p>
<p>总体来说，GPT-5.2 推理更强、答题更准，更适合处理复杂专业问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2d00374acca49299eb7181150aaa0e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=SilXT3hNE6clwL6CDuhVkPUNybk%3D" alt="ARC-AGI-1 智能推理排行榜" loading="lazy"/></p>
<p>ARC-AGI-1 智能推理排行榜</p>
<h3 data-id="heading-5">4、ARC-AGI-1 智能推理排行榜</h3>
<p>ARC-AGI-1 智能推理排行榜。横轴是单题成本，纵轴是解题成功率，用来比较各大AI模型在复杂抽象推理任务上的能力与效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2fec1ef3c6e416a9dd5c699e4a96ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=HIDYe9o%2F%2BB%2F8970jJdlj2JXp4kE%3D" alt="" loading="lazy"/></p>
<p>OpenAI 最新发布的 GPT-5.2（一代更比一代强）在成功率上接近人类水平，同时保持较高性价比，处于当前最强SOTA水平，反超Gemini 3 Pro、Claude Opus 4.5，成为现阶段，综合实力最强的AI大模型。</p>
<h2 data-id="heading-6">GPT-5.2初体验</h2>
<h3 data-id="heading-7">1、版本号</h3>
<p>你是什么模型，具体是什么版本号，知识截止日期是几号</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edceee6f05a045b0b0542cb37d3b151e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=0dukrPsJhu1dayKqbOBzbY9hgYU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2、联网实时查询</h3>
<p>请联网查询：截至今天，OpenAI 最近一次官方发布的重要产品或模型更新是什么？请给出发布时间、核心变化点，并注明信息来源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc56cebbdce47528a984b1549be76df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=ysrcv3ExTWDzyEiYjgVGWPmiNKY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3、写作</h3>
<p>GPT-5.2在写作方面相比GPT-5.1更聪明、更实用。</p>
<ol>
<li>它能理解更长、更复杂的文本，更好地抓住重点、组织结构，使文章逻辑更清晰、信息更准确;</li>
<li>在多步骤写作任务（比如报告、说明文）中表现更稳定，输出质量更高;</li>
<li>响应更快，提升整体写作效率。</li>
</ol>
<p>提示词：</p>
<p>全国一卷作文题目："民族魂" 材料内容： "他想要给孩子们唱上一段，可是心里直翻腾，开不了口。" ——老舍《鼓书艺人》 "假如我是一只鸟，我也应该用嘶哑的喉咙歌唱" ——艾青《我爱这土地》 "我要以带血的手和你们一一拥抱，因为一个民族已经起来" ——穆旦《赞美》 写作要求： 以上材料引发了你怎样的联想和思考？请写一篇文章。 要求选准角度，确定立意，明确文体，自拟标题；不要套作，不得抄袭；不得泄露个人信息；不少于800字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc9e09eea9e46da9d86214062d91cbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=Z8hdcLiRRkOCb6PZtONQ9DZkNRM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">4、编程</h3>
<p>GPT-5.2 在编程能力上相比 GPT-5.1 有明显提升：</p>
<ol>
<li>它理解更长、更复杂的代码和需求，生成代码更准确、逻辑更清晰；</li>
<li>执行多步骤编程任务（如调试、重构、自动测试等）更稳定、效率更高；</li>
<li>处理大型项目、跨文件依赖关系时错误更少，还能更好地配合工具链（如自动格式、lint、构建脚本等），让开发体验更顺畅。</li>
<li>整体编程输出质量和生产力都有显著提升。</li>
</ol>
<p>提示词：请用 Java 设计并实现一个支持高并发的电商微服务系统（基于 Spring Boot/Spring Cloud），要求包含订单、库存等服务，需解决分布式事务与超卖问题，使用 Redis/Kafka 进行异步解耦，并提供核心代码、配置及部署方案，同时说明高并发优化与容错限流设计思路。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56615940b82e43ebac00b3ea110fb826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=MxYgAqr0Ec%2BPrSNKm%2BL%2BSNcYtyw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/badf64742dd341d0aea80c11ba899631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=JCt15qVV5fYcBTGe%2BJn%2BrXKnteQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">5、多模态-识别图片</h3>
<p>GPT-5.2 在多模态能力方面相比 GPT-5.1 有明显提升：</p>
<ol>
<li>它能更精准理解和生成图像、图表等视觉内容，与文本结合得更好；</li>
<li>对复杂长文档、长上下文里的视觉＋语言信息处理更稳定；</li>
<li>整体多模态推理更快、更准确，减少误判和错误输出，使“看图+理解+输出”这类任务更流畅、更可靠。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f250df3d9c345c795fcd4a815c252d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=MTne0WaafPkgmG3EsX0dz1H%2FDFk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">6、上传文件</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb049225879e4392a5c0191df08ed6c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=9nFh2Bcb%2FW9lWTPb7ZosDWkj7S0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5095261e7b4747a79620671acd029f37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=GP6coM%2BGquIa5SOmROsLRWL7oPA%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷]]></title>    <link>https://juejin.cn/post/7582785032851652671</link>    <guid>https://juejin.cn/post/7582785032851652671</guid>    <pubDate>2025-12-12T09:51:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032851652671" data-draft-id="7582791876366221350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-12T09:51:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:51:43.000Z" title="Fri Dec 12 2025 09:51:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前以大模型、智能体等技术为代表的新一代人工智能技术，正加速落地“千行百业”。软件作为数字转型的核心支撑与新技术落地的关键载体，软件行业的智能化变革尤为迫切，AI在软件生产全流程的价值凸显，持续推动软件研发范式转变，提升研发质效。然而，AI在软件研发部分环节虽已进入规模化落地阶段，但在技术落地成效对比、场景选择、成熟度对标等关键信息仍缺乏系统性梳理，企业在技术选型、路径规划上仍面临决策困惑，亟需行业提供科学指引。</p>
<p>长期以来中国信息通信研究院（简称“中国信通院”）人工智能研究所高度重视智能化软件工程（AI4SE）发展，联合中国人工智能产业发展联盟（AIIA）软件智能化委员会围绕技术研究、标准、报告、评估等多个维度开展工作，已建成《智能化软件工程技术和应用要求》《面向软件工程智能体技术和应用要求》《软件智能化成熟度模型》等标准体系，发布《智能化软件开发落地实践指南（2024年）》等研究报告，并开展行业现状调研，于今年4月联合发布了《AI4SE行业现状调查报告（2024年度）》，旨在为软件研发各阶段的智能化落地提供参考。</p>
<p>为进一步深入了解智能化软件工程发展现状、各阶段应用情况及未来落地趋势等行业关键数据，中国信通院人工智能研究所联合中国工商银行、中国邮政储蓄银行、交通银行、TRAE团队、腾讯、讯飞、百度、京东、软通动力、Testin云测、硅心科技、新炬网络、IT168、测试窝等单位共同发起2025年度智能化软件工程现状调研。调研对象为各行业中具有软件研发团队的企业。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer">立即填写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceff7f8699734477a857abc3b48d0c0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=HMpHXoIZWvf1%2FruE6ZDUkI6DdG8%3D" alt="img_v3_02st_ef98b0da-188c-4472-9cde-166ad561140g.png" loading="lazy"/>
</a></p>
<p>本次调研问卷的收集截止日期为2026年1月15日，调研结果分析整理后，将于2026年以调研报告的形式正式发布，旨在为行业提供最新的发展趋势分析和决策参考，推动软件工程智能化转型升级。</p>
<p>欢迎各企业或专家参与问卷，有效填写者将有机会获得精美奖品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e35e8615e9d44398b30111d41b690d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=oHVAZuil1Pjn%2BQrGh9kkuRla8do%3D" alt="图片" loading="lazy"/></p>
<p>无论您所在企业在软件研发过程中，已经落地了智能化能力，还是处于试点探索阶段，我们都诚挚邀请您参与此次调研，分享您的真知灼见，您的宝贵经验将为行业的发展提供重要的参考价值。我们将对您提供的信息严格保密，并承诺仅用于报告的编写。期待您的积极参与，共同为软件行业的智能化发展贡献力量！</p>
<p><strong>联系方式：</strong> 中国信通院/人工智能研究所</p>
<ul>
<li>
<p>齐老师 18686962307(微信同号)</p>
</li>
<li>
<p>闫老师 13041008356(微信同号)</p>
</li>
<li>
<p>秦老师 13488684897(微信同号)</p>
</li>
</ul>
<h3 data-id="heading-0">关于中国人工智能产业发展联盟（AIIA）软件智能化委员会</h3>
<p>中国人工智能产业发展联盟（AIIA）软件智能化委员会是原AI4SE工作组的扩充与升级，在原有工作基础上继续深挖与扩展。一是持续深耕软件研发全流程智能化转型，二是推动软件产品形态智能创新，三是推动软件企业智能化转型升级，充分释放AI在软件领域的价值。AI4SE工作组已吸纳180+成员单位，覆盖金融、电信、软件等诸多行业，欢迎更多企业加入。</p>
<h3 data-id="heading-1"><strong>联系方式：</strong></h3>
<p>齐老师 18686962307(微信同号)</p>
<p>闫老师 13041008356(微信同号)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？]]></title>    <link>https://juejin.cn/post/7582791876366270502</link>    <guid>https://juejin.cn/post/7582791876366270502</guid>    <pubDate>2025-12-12T09:57:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582791876366270502" data-draft-id="7582777037863583794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？"/> <meta itemprop="keywords" content="OpenAI,算法,AI编程"/> <meta itemprop="datePublished" content="2025-12-12T09:57:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:57:01.000Z" title="Fri Dec 12 2025 09:57:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>GPT5.2来了，三级模型矩阵精准戳中不同用户痛点。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1485241f440d485ab61136a5f3c2246c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138220&amp;x-signature=FE652%2FGzgDSKoHiS0y76n63hjgM%3D" alt="图片" loading="lazy"/>（图片源自网络，侵删）     </p>
<p>没有发布会，没有预热海报，12月12日凌晨，OpenAI突然扔出重磅炸弹——GPT-5.2系列模型低调上线，仅用一篇技术博客和CEO奥特曼的一句话宣告，就搅动了整个AI行业的神经。这不是一次常规迭代，而是谷歌 Gemini 3上月惊艳亮相后，OpenAI 拉响“红色警报”的背水一战，目标直指“专业知识工作第一模型”宝座。</p>
<p><strong>核心亮点：3个版本精准狙击不同场景</strong></p>
<p>OpenAI这次的产品策略堪称教科书级，直接拆分出三级模型矩阵，彻底告别“一刀切”：
Instant极速版：日常轻量任务首选，主打快响应 + 温暖语调，信息查询、翻译、简单文档撰写秒级反馈，完美替代 GPT-5.1 日常使用场景；
Thinking思考版：专业人士主力款，聚焦深度推理与复杂项目，长文档分析、图表解读、多步骤工具调用能力拉满，是智能体工作流的核心引擎；
Pro专业版：天花板级性能，面向科研与高端商业场景，错误率最低、推理链条最长，在金融建模、复杂编程等任务中达到人类顶尖专家水准。
目前模型已向Plus、Pro、Business等付费用户逐步开放，GPT-5.1将保留三个月后停用，API同步上线，缓存输入可享90%折扣。</p>
<p><strong>实测封神：这些数据颠覆认知</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b56c268a32fa452ea9acb1236b8dcd8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138220&amp;x-signature=Ftg5tiCJ27Ztihoq8EjzsNSUBr4%3D" alt="图片" loading="lazy"/>（图片源自网络，侵删）</p>
<p>OpenAI掏出的全新GDPval基准测试（覆盖9大行业44类职业），让GPT-5.2的实力无可辩驳：
1、Pro版本在74.1%的真实工作任务中，击败或打平人类专家，投行建模、PPT制作等场景效率提升11倍，成本却不足人类1%；
2、256k超长上下文（约数十万字）处理准确率接近100%，几百份合同、财报“大海捞针”不再遗漏关键信息；
3、编程能力刷新纪录，SWE-bench Pro得分达55.6%，能独立完成多语言复杂工程、调试生产代码，被开发者称为“智能体编程的最大飞跃”；数学推理实现“封神”，AIME 2025测试拿下满分，ARC-AGI-1抽象推理突破 90%，金融预测、数据分析能力再上台阶。</p>
<p>更惊喜的是视觉进化，Thinking版本对图表、仪表盘、UI界面的解读错误率大降50%，甚至能精准识别主板组件空间布局，彻底摆脱前代“胡言乱语”的尴尬。</p>
<p><strong>光鲜背后：短板与争议并存</strong></p>
<p>不过GPT-5.2并非完美无缺。OpenAI坦言，复杂任务生成可能需要数分钟，“慢思考”带来的延迟问题，在实时交互场景中堪称体验倒退。价格也让用户直呼“肉痛”：Instant和Thinking版每百万输入Token1.75美元、输出14美元，Pro版更是高达输入21美元、输出168美元，比Claude 4.5高阶版贵50%。更值得关注的是行业竞争格局的巨变。曾经OpenAI领先对手一年以上，如今GPT-5.2虽刷新多项纪录，但与Gemini 3、Claude 4.5的差距已缩小到几周。德国一位AI博主直言：“当所有模型都能拿高分，真正的价值在于工作流整合与实际应用能力。”</p>
<p><strong>行业解读：OpenAI 的战略定力与焦虑</strong></p>
<p>这次GPT-5.2的发布，暴露了OpenAI的双重心态：一方面，它不再执着于“全能第一”，而是聚焦“经济价值”，通过细分版本深耕专业场景，展现出成熟的商业战略；另一方面，三个月内两次迭代的速度，以及“红色警报”的内部动员，都暗示着对竞争的焦虑。对普通用户而言，Instant版足以应对日常需求，性价比最高；职场人、开发者优先冲Thinking版，长文档处理和编程能力能直接提升工作效率；企业客户则可关注Pro版的智能体协作能力，多工具编排、跨系统数据处理能大幅降低运营成本。目前GPT-5.2仍在分批开放中，付费用户可在ChatGPT内切换版本体验。面对3个版本，大家会怎么选择呢，欢迎在评论区留下你的看法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合]]></title>    <link>https://juejin.cn/post/7582786655472893995</link>    <guid>https://juejin.cn/post/7582786655472893995</guid>    <pubDate>2025-12-12T09:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472893995" data-draft-id="7582561515817746495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合"/> <meta itemprop="keywords" content="API,大数据"/> <meta itemprop="datePublished" content="2025-12-12T09:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天远数科"/> <meta itemprop="url" content="https://juejin.cn/user/3511153810487162"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3511153810487162/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天远数科
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:28:16.000Z" title="Fri Dec 12 2025 09:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、在 BFF 层拦截多头借贷风险</h2>
<p>在现代金融科技架构中，<strong>Node.js</strong> 常驻于业务网关层，负责聚合数据并为前端提供响应。当用户在 APP 端发起借款申请时，网关层需要在毫秒级时间内判断用户的风险等级，从而决定是直接拒绝、弹窗警告还是进入人工审核。</p>
<p><strong>天远API</strong> 的“多头借贷行业风险版”，提供了区别于传统征信的<strong>精细化行为画像</strong>。它不仅能区分用户是在“银行”还是“P2P”平台借贷，还能识别出用户是否在“凌晨”进行高频申请。然而，该接口返回的 <code>List&lt;KV&gt;</code> 格式数据（如 <code>[{"riskCode": "41001", "riskCodeValue": "50"}]</code>）对前端展示并不友好。</p>
<p>本文将演示如何在 Node.js 环境中，利用原生 <code>crypto</code> 模块实现高安全的 AES-128-CBC 通信，并编写高效的数据转换（Transformer）函数，将<strong>天远API</strong>的原始数据清洗为业务友好的结构化 JSON。</p>
<h2 data-id="heading-1">二、API接口调用示例（Node.js版）</h2>
<h3 data-id="heading-2">1. 接口技术规范</h3>
<ul>
<li><strong>接口地址</strong>：<code>https://api.tianyuanapi.com/api/v1/DWBG7F3A</code></li>
<li><strong>HTTP方法</strong>：POST</li>
<li><strong>鉴权</strong>：Header 需携带 <code>Access-Id</code>。</li>
<li><strong>Payload</strong>：Body 中的 <code>data</code> 字段为 AES 加密并 Base64 编码后的字符串 1。</li>
</ul>
<h3 data-id="heading-3">2. Node.js 完整实现代码</h3>
<p>在 Node.js 中，我们使用 <code>axios</code> 发起请求，使用 <code>crypto</code> 处理加解密。特别注意：加密后的密文需要与 IV（初始化向量）拼接后再进行 Base64 编码。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

<span class="hljs-comment">// 配置信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONFIG</span> = {
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'&lt;https://api.tianyuanapi.com/api/v1/DWBG7F3A&gt;'</span>,
    <span class="hljs-attr">accessId</span>: <span class="hljs-string">'YOUR_ACCESS_ID'</span>,      
    <span class="hljs-attr">accessKey</span>: <span class="hljs-string">'YOUR_ACCESS_KEY_HEX'</span> <span class="hljs-comment">// 16字节HEX字符串</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IndustryRiskService</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 确保 Key 为 Buffer</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">accessKey</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span> = <span class="hljs-string">'aes-128-cbc'</span>;
    }

    <span class="hljs-comment">// --- AES 加密 ---</span>
    <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">dataObj</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> iv = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>); <span class="hljs-comment">// 随机生成IV</span>
            <span class="hljs-keyword">const</span> plaintext = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataObj);
            
            <span class="hljs-keyword">const</span> cipher = crypto.<span class="hljs-title function_">createCipheriv</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>, iv);
            <span class="hljs-keyword">let</span> encrypted = cipher.<span class="hljs-title function_">update</span>(plaintext, <span class="hljs-string">'utf8'</span>, <span class="hljs-string">'base64'</span>);
            encrypted += cipher.<span class="hljs-title function_">final</span>(<span class="hljs-string">'base64'</span>);
            
            <span class="hljs-comment">// 拼接 IV + 密文 -&gt; Base64</span>
            <span class="hljs-keyword">const</span> ivBuffer = iv;
            <span class="hljs-keyword">const</span> encryptedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(encrypted, <span class="hljs-string">'base64'</span>);
            <span class="hljs-keyword">const</span> combinedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>([ivBuffer, encryptedBuffer]);
            
            <span class="hljs-keyword">return</span> combinedBuffer.<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Encrypt Error:'</span>, err.<span class="hljs-property">message</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// --- AES 解密 ---</span>
    <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">base64Str</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> combinedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(base64Str, <span class="hljs-string">'base64'</span>);
            <span class="hljs-keyword">const</span> iv = combinedBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);       <span class="hljs-comment">// 提取前16字节 IV</span>
            <span class="hljs-keyword">const</span> content = combinedBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">16</span>);     <span class="hljs-comment">// 提取剩余密文</span>
            
            <span class="hljs-keyword">const</span> decipher = crypto.<span class="hljs-title function_">createDecipheriv</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>, iv);
            <span class="hljs-keyword">let</span> decrypted = decipher.<span class="hljs-title function_">update</span>(content, <span class="hljs-string">'base64'</span>, <span class="hljs-string">'utf8'</span>);
            decrypted += decipher.<span class="hljs-title function_">final</span>(<span class="hljs-string">'utf8'</span>);
            
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(decrypted);
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Decrypt Error:'</span>, err.<span class="hljs-property">message</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// --- 数据清洗 Transformer ---</span>
    <span class="hljs-comment">// 将数组 [{"riskCode": "41001", "riskCodeValue": "50"}] 转换为对象 {"41001": 50}</span>
    <span class="hljs-title function_">transformReport</span>(<span class="hljs-params">rawData</span>) {
        <span class="hljs-keyword">const</span> reportList = rawData[<span class="hljs-string">'riskInfo_report_v3.1'</span>] || [];
        <span class="hljs-keyword">return</span> reportList.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
            acc[item.<span class="hljs-property">riskCode</span>] = <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">riskCodeValue</span>); <span class="hljs-comment">// 转为数字方便计算</span>
            <span class="hljs-keyword">return</span> acc;
        }, {});
    }

    <span class="hljs-comment">// --- 业务调用主流程 ---</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">queryRisk</span>(<span class="hljs-params">userParams</span>) {
        <span class="hljs-keyword">const</span> encryptedData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encrypt</span>(userParams);
        <span class="hljs-keyword">if</span> (!encryptedData) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${CONFIG.apiUrl}</span>?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(url, { <span class="hljs-attr">data</span>: encryptedData }, {
                <span class="hljs-attr">headers</span>: { 
                    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
                    <span class="hljs-string">'Access-Id'</span>: <span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">accessId</span> 
                }
            });

            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API调用成功，解析数据...'</span>);
                <span class="hljs-keyword">const</span> rawResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decrypt</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
                
                <span class="hljs-comment">// 执行数据清洗</span>
                <span class="hljs-keyword">const</span> cleanData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformReport</span>(rawResult);
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeRisk</span>(cleanData);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API业务错误:'</span>, res.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>);
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'网络请求失败:'</span>, error.<span class="hljs-property">message</span>);
        }
    }

    <span class="hljs-comment">// --- 简单的风控逻辑 ---</span>
    <span class="hljs-title function_">analyzeRisk</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 用户风险画像 ---'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`多头借贷通用分 (41001): <span class="hljs-subst">${data[<span class="hljs-string">'41001'</span>]}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`银行系借贷分 (41005): <span class="hljs-subst">${data[<span class="hljs-string">'41005'</span>]}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`互金系借贷分 (41004): <span class="hljs-subst">${data[<span class="hljs-string">'41004'</span>]}</span>`</span>);
        
        <span class="hljs-comment">// 示例规则：如果是深夜申请且互金分高</span>
        <span class="hljs-keyword">if</span> (data[<span class="hljs-string">'40105'</span>] &gt; <span class="hljs-number">0</span> &amp;&amp; data[<span class="hljs-string">'41004'</span>] &gt; <span class="hljs-number">60</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'【高危预警】检测到“深夜高频借贷”行为，建议拦截！'</span>);
        }
    }
}

<span class="hljs-comment">// 运行示例</span>
<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndustryRiskService</span>();
service.<span class="hljs-title function_">queryRisk</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"王五"</span>,
    <span class="hljs-attr">id_card</span>: <span class="hljs-string">"310101199001011234"</span>,
    <span class="hljs-attr">mobile_no</span>: <span class="hljs-string">"13800138000"</span>
});
</code></pre>
<h2 data-id="heading-4">三、核心数据结构解析</h2>
<p>对于 Node.js 开发者，处理<strong>天远API</strong>返回的数据时，最核心的工作是将 <code>Array</code> 转换为 <code>Object</code> (Map)。</p>
<h3 data-id="heading-5">1. 原始数据困境</h3>
<p>API 返回的数据是为了传输效率优化的 2：</p>
<p>JavaScript</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"riskInfo_report_v3.1"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"riskCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"41001"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"riskCodeValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"43"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 需要遍历才能找到</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"riskCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"40105"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"riskCodeValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 data-id="heading-6">2. 清洗后的数据优势</h3>
<p>通过 <code>reduce</code> 函数转换后，我们可以直接通过 Key 访问，这在编写风控规则引擎（Rule Engine）时至关重要：</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"41001"</span>: <span class="hljs-number">43</span>,
    <span class="hljs-string">"40105"</span>: <span class="hljs-number">5</span>,
    <span class="hljs-string">"41005"</span>: <span class="hljs-number">34</span>
}
<span class="hljs-comment">// 规则书写变得极其简单：</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>[<span class="hljs-string">'41001'</span>] &gt; <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> reject();
</code></pre>
<h2 data-id="heading-7">四、字段详解（Node.js 实战关注点）</h2>
<p>以下字段是开发 BFF 层接口时，最常需要 透传给前端 或 用于 网关拦截 的关键指标。</p>
<h3 data-id="heading-8">1. 宏观评分（用于前端展示或分流）</h3>





























<table><thead><tr><th><strong>字段 Code</strong></th><th><strong>字段含义</strong></th><th><strong>说明</strong></th><th><strong>Node.js 处理建议</strong></th></tr></thead><tbody><tr><td><strong>41001</strong></td><td>多头申请通用分</td><td>0-100分 3</td><td>可直接透传给信审员后台展示。</td></tr><tr><td><strong>41002</strong></td><td>短周期多头共债子分</td><td>0-100分，窗口期7天-3个月 4</td><td>用于判断是否“近期突发缺钱”。</td></tr><tr><td><strong>41005</strong></td><td><strong>银行多头共债子分</strong></td><td>0-100分 5</td><td>银行系数据的权重，通常代表资质上限。</td></tr></tbody></table>
<h3 data-id="heading-9">2. 行为特征（用于自动拦截）</h3>





























<table><thead><tr><th><strong>字段 Code</strong></th><th><strong>字段含义</strong></th><th><strong>阈值参考</strong></th><th><strong>业务逻辑</strong></th></tr></thead><tbody><tr><td><strong>40105</strong></td><td><strong>7天总申请夜晚次数</strong></td><td>&gt; 0 即关注</td><td>夜间（0点-7点）申请是典型的高危欺诈特征 6。</td></tr><tr><td><strong>40161</strong></td><td>7天相对过去30天新增平台数</td><td>&gt; 3 即预警</td><td>突然新增大量平台（撸口子），大概率是将要“跑路”的前兆 7。</td></tr><tr><td><strong>40004</strong></td><td>7天内互金申请次数</td><td>High</td><td>频繁申请P2P/网贷，意味着银行渠道已拒绝或额度耗尽 8。</td></tr></tbody></table>
<h2 data-id="heading-10">五、应用价值分析</h2>
<p>在 Node.js 架构中集成<strong>天远API</strong>的行业风险版，主要解决以下痛点：</p>
<ol>
<li>
<p>分流策略（Routing）：</p>
<p>在网关层，根据 41005 (银行分) 和 41004 (非银分) 的比值，将流量分发给不同的资金方。</p>
<ul>
<li><em>银行分高</em> -&gt; 路由至低息、大额资金方接口。</li>
<li><em>非银分高</em> -&gt; 路由至高息、小额助贷机构接口。</li>
</ul>
</li>
<li>
<p>反欺诈中间件：</p>
<p>开发一个 Express/Koa 中间件，在请求进入核心业务逻辑前，先调用 API 校验 40105 (夜间申请次数)。如果发现该指标异常，直接在中间件层返回 "Risk Reject"，无需消耗后端复杂的授信计算资源，保护核心系统。</p>
</li>
<li>
<p>用户画像补全：</p>
<p>利用 Node.js 的高并发特性，批量清洗存量用户的 40037 (360天总申请次数) 和 40038 (360天银行申请次数) 9，计算出用户的“银行偏好度”，用于精准营销。</p>
</li>
</ol>
<h2 data-id="heading-11">六、总结</h2>
<p><strong>天远API</strong> 的多头借贷行业风险版，通过分行业、分时段的维度，为风控提供了“显微镜”级别的观察能力。</p>
<p>对于 Node.js 开发者，虽然需要处理 AES 加密和 Buffer 拼接的底层细节，但通过简单的封装（如本文的 Service 类），即可轻松获得强大的数据清洗能力。建议开发者在 BFF 层重点关注 <strong>夜间申请</strong> (<code>40105</code>) 和 <strong>新增平台数</strong> (<code>40161</code>) 这两个“杀手级”指标，它们往往是识别欺诈用户最有效的手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大疆不同任务类型执行逻辑，上云API源码分析]]></title>    <link>https://juejin.cn/post/7582809606066339866</link>    <guid>https://juejin.cn/post/7582809606066339866</guid>    <pubDate>2025-12-12T09:31:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582809606066339866" data-draft-id="7582809606066323482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大疆不同任务类型执行逻辑，上云API源码分析"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-12T09:31:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深紫色的三北六号"/> <meta itemprop="url" content="https://juejin.cn/user/4101625032221256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大疆不同任务类型执行逻辑，上云API源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4101625032221256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深紫色的三北六号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:31:45.000Z" title="Fri Dec 12 2025 09:31:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大疆不同任务类型执行逻辑，上云API源码分析</h2>
<p>大疆司空2中有不同的任务类型：立即任务、定时任务、条件任务。
最初我们实现时，选择的是用Quartz创建定时任务，调用API中executeFlightTask接口实现任务下发。
在功能实现之后，随着对API的深入了解，发现大疆API中有相关的任务下发逻辑。
当时只看了实现逻辑，因为活比较多，加上懒，就一直拖到现在。
<strong>本文是对源码的学习总结。</strong></p>
<p>所有任务下发的逻辑都从**publishFlightTask()**方法开始。
com.dji.sample.wayline.service.impl.FlightTaskServiceImpl#publishFlightTask</p>
<h3 data-id="heading-1">立即任务</h3>
<ol>
<li><code>fillImmediateTime(param)</code>方法，如果是 <strong>“立即任务（IMMEDIATE）”</strong>，就把任务的执行日期<code>taskDays</code>与执行时间段<code>taskPeriods</code>强制设置为当前服务器时间。</li>
<li>由于<code>taskDays = [now]</code>，<code>taskPeriods = [ [now]</code> ]，所以只会进入循环一次，并且beginTime = 当前毫秒时间点，endTime = beginTime。</li>
<li>创建一条飞行任务记录存到数据库中---- <code>waylineJobOpt</code>。</li>
<li>调用<code>publishOneFlight()</code>方法发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 发布飞行任务的核心入口方法。
     * 功能：
     * 1. 处理立即任务（IMMEDIATE），强制以服务器当前时间作为任务执行时间；
     * 2. 根据用户提交的任务日期（taskDays）与时间段（taskPeriods），
     *    生成多个 beginTime/endTime 的任务实例；
     * 3. 为每个时间段创建一条 WaylineJob（航线任务记录）；
     * 4. 若为条件任务，写入对应的触发条件；
     * 5. 立即调用 publishOneFlightTask 将任务下发给飞行设备（Dock）；
     * 6. 如果任何一次下发失败，则返回失败并终止流程；
     * 7. 所有任务下发成功后返回成功响应。
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        fillImmediateTime(param);

        <span class="hljs-comment">//立即任务只会进入循环一次</span>
        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-comment">//立即任务的beginTime = endTime = 当前毫秒时间</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                <span class="hljs-comment">//立即任务直接跳过这个判断</span>
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">//创建一条飞行任务记录</span>
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//立即任务直接跳过这个方法</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-comment">//发布任务</span>
                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    <span class="hljs-comment">/**
     * 如果任务类型为 IMMEDIATE（立即任务），则忽略用户传入的任何日期和时间段，
     * 将任务的执行日期（taskDays）与执行时间段（taskPeriods）强制设置为当前服务器时间。
     * 立即任务必须由服务器当前时间触发，不允许由客户端自定义时间。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fillImmediateTime</span><span class="hljs-params">(CreateJobParam param)</span> {
        <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType()) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        param.setTaskDays(List.of(now));
        param.setTaskPeriods(List.of(List.of(now)));
    }
 
</code></pre>
<ol start="5">
<li><code>deviceRedisService.checkDeviceOnline</code>判断机场是否在线</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令</li>
<li>调用<code>executeFlightTask</code>方法，下发飞行任务执行指令</li>
</ol>
<p><strong>[2]publishOneFlight</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-comment">//判断机场是否在线</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-comment">//下发飞行准备指令</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }

        <span class="hljs-comment">//下发立即任务执行指令</span>
        <span class="hljs-comment">// Issue an immediate task execution command.</span>
        <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE == waylineJob.getTaskType()) {
            <span class="hljs-keyword">if</span> (!executeFlightTask(waylineJob.getWorkspaceId(), waylineJob.getJobId())) {
                <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to execute job."</span>);
            }
        }

        ..............(省略部分代码)

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }

</code></pre>
<h3 data-id="heading-2">定时任务</h3>
<ol>
<li>遍历定时任务设置中每一天的每一个时间段</li>
<li>忽略已经过期的时间段</li>
<li>创建waylineJob并存到数据库中。</li>
<li>调用<code>publishOneFlightTask()</code>发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//定时任务在这个方法中直接返回，不会进行任何处理</span>
        fillImmediateTime(param);

        <span class="hljs-comment">//遍历每一天每一个时间段</span>
        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                
                <span class="hljs-comment">//忽略已经过期的时间段</span>
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">//创建waylineJob</span>
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//不是条件任务，进入这个方法会直接返回。</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-comment">//发布任务</span>
                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
</code></pre>
<ol start="5">
<li><code>deviceRedisService.checkDeviceOnline</code>检查机场是否在线。</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令.</li>
<li>把定时任务添加到Redis的一个Sorted Set（有序集合）里，用任务的开始时间作为排序依据。</li>
</ol>
<p><strong>[2]publishOneFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-comment">//检查机场是否在线</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-comment">//下发飞行准备指令</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }
        
        ..........(省略部分代码)
        
        <span class="hljs-comment">//把定时任务添加到Redis有序集合里，用开始时间排序</span>
        <span class="hljs-keyword">if</span> (TaskTypeEnum.TIMED == waylineJob.getTaskType()) {
            <span class="hljs-comment">// key: wayline_job_timed, value: {workspace_id}:{dock_sn}:{job_id}</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> RedisOpsUtils.zAdd(RedisConst.WAYLINE_JOB_TIMED_EXECUTE,
                    waylineJob.getWorkspaceId() + RedisConst.DELIMITER + waylineJob.getDockSn() + RedisConst.DELIMITER + waylineJob.getJobId(),
                    waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());
            <span class="hljs-keyword">if</span> (!isAdd) {
                <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to create scheduled job."</span>);
            }
        }

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
</code></pre>
<ol start="8">
<li><code>checkScheduledJob</code>定时任务，每<code>5s</code>对 Redis 中的定时任务集合扫描一次。</li>
<li>获取最早的定时任务，拆解任务信息。</li>
<li>如果任务信息开始比现在早<code>30s (offset)</code>以上，认为任务过期，删除 Redis 队列中的任务，更新任务状态为失败。</li>
<li>如果任务执行时间在<code>now + offset</code>这个时间区间内，调用<code>executeFlightTask</code>下发执行任务命令，且无论成功或失败，都从 Redis 队列中删除任务信息。</li>
</ol>
<p><strong>[3]checkScheduledJob定时任务</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Scheduled(initialDelay = 10, fixedRate = 5, timeUnit = TimeUnit.SECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkScheduledJob</span><span class="hljs-params">()</span> {
        
        <span class="hljs-comment">//获取最早的定时任务，并拆解任务信息</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">jobIdValue</span> <span class="hljs-operator">=</span> RedisOpsUtils.zGetMin(RedisConst.WAYLINE_JOB_TIMED_EXECUTE);
        <span class="hljs-keyword">if</span> (Objects.isNull(jobIdValue)) {
            <span class="hljs-keyword">return</span>;
        }
        log.info(<span class="hljs-string">"Check the timed tasks of the wayline. {}"</span>, jobIdValue);
        <span class="hljs-comment">// format: {workspace_id}:{dock_sn}:{job_id}</span>
        String[] jobArr = String.valueOf(jobIdValue).split(RedisConst.DELIMITER);
        <span class="hljs-type">double</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> RedisOpsUtils.zScore(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">30_000</span>;

        
        <span class="hljs-comment">//任务信息开始比现在早30s以上，认为任务过期，删除Redis队列中的任务，更新任务状态为失败。</span>
        <span class="hljs-comment">// Expired tasks are deleted directly.</span>
        <span class="hljs-keyword">if</span> (time &lt; now - offset) {
            RedisOpsUtils.zRemove(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .jobId(jobArr[<span class="hljs-number">2</span>])
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .executeTime(LocalDateTime.now())
                    .completedTime(LocalDateTime.now())
                    .code(HttpStatus.SC_REQUEST_TIMEOUT).build());
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//判断任务执行时间在now + offset这个时间区间内，下发执行任务命令。</span>
        <span class="hljs-keyword">if</span> (now &lt;= time &amp;&amp; time &lt;= now + offset) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">this</span>.executeFlightTask(jobArr[<span class="hljs-number">0</span>], jobArr[<span class="hljs-number">2</span>]);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.info(<span class="hljs-string">"The scheduled task delivery failed."</span>);
                waylineJobService.updateJob(WaylineJobDTO.builder()
                        .jobId(jobArr[<span class="hljs-number">2</span>])
                        .status(WaylineJobStatusEnum.FAILED.getVal())
                        .executeTime(LocalDateTime.now())
                        .completedTime(LocalDateTime.now())
                        .code(HttpStatus.SC_INTERNAL_SERVER_ERROR).build());
            } <span class="hljs-keyword">finally</span> {
                RedisOpsUtils.zRemove(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
            }
        }
    }
</code></pre>
<h3 data-id="heading-3">条件任务</h3>
<ol>
<li>条件任务和定时任务的 1-3步相同</li>
<li>同上</li>
<li>同上</li>
<li>调用<code>addConditions()</code>方法,设置<code>readyConditions(预备条件)、executableConditions(执行条件)</code>，然后将任务存入Redis，</li>
</ol>
<pre><code class="hljs language-css" lang="css">wayline_job_condition_prepare（zset） → 按开始时间排序
wayline_job_condition:{jobId} → 任务详情。
</code></pre>
<ol start="5">
<li>调用<code>publishOneFlightTask()</code>发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        fillImmediateTime(param);

        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//条件任务，添加条件参数！！</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addConditions</span><span class="hljs-params">(WaylineJobDTO waylineJob, CreateJobParam param, Long beginTime, Long endTime)</span> {
        <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL != param.getTaskType()) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//填入readyConditions(预备条件)、executableConditions(执行条件)</span>
        waylineJob.setConditions(
                WaylineTaskConditionDTO.builder()
                        .executableConditions(Objects.nonNull(param.getMinStorageCapacity()) ?
                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableConditions</span>().setStorageCapacity(param.getMinStorageCapacity()) : <span class="hljs-literal">null</span>)
                        .readyConditions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadyConditions</span>()
                                .setBatteryCapacity(param.getMinBatteryCapacity())
                                .setBeginTime(beginTime)
                                .setEndTime(endTime))
                        .build());

        waylineRedisService.setConditionalWaylineJob(waylineJob);
        <span class="hljs-comment">// key: wayline_job_condition, value: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> waylineRedisService.addPrepareConditionalWaylineJob(waylineJob);
        <span class="hljs-keyword">if</span> (!isAdd) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to create conditional job."</span>);
        }
    }
    
    
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">addPrepareConditionalWaylineJob</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> {
        <span class="hljs-keyword">if</span> (Objects.isNull(waylineJob.getBeginTime())) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// value: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-keyword">return</span> RedisOpsUtils.zAdd(RedisConst.WAYLINE_JOB_CONDITION_PREPARE,
                waylineJob.getWorkspaceId() + RedisConst.DELIMITER + waylineJob.getDockSn() + RedisConst.DELIMITER + waylineJob.getJobId(),
                waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());
    }
</code></pre>
<ol start="6">
<li><code>deviceRedisService.checkDeviceOnline</code>检查机场是否在线。</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令。</li>
</ol>
<p><strong>[2]publishOneFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }

       ..........(省略部分代码)

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    
     <span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">prepareFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// get wayline file</span>
        Optional&lt;GetWaylineListResponse&gt; waylineFile = waylineFileService.getWaylineByWaylineId(waylineJob.getWorkspaceId(), waylineJob.getFileId());
        <span class="hljs-keyword">if</span> (waylineFile.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Wayline file doesn't exist."</span>);
        }

        <span class="hljs-comment">// get file url</span>
        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> waylineFileService.getObjectUrl(waylineJob.getWorkspaceId(), waylineFile.get().getId());

        <span class="hljs-type">FlighttaskPrepareRequest</span> <span class="hljs-variable">flightTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskPrepareRequest</span>()
                .setFlightId(waylineJob.getJobId())
                .setExecuteTime(waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli())
                .setTaskType(waylineJob.getTaskType())
                .setWaylineType(waylineJob.getWaylineType())
                .setRthAltitude(waylineJob.getRthAltitude())
                .setOutOfControlAction(waylineJob.getOutOfControlAction())
                .setExitWaylineWhenRcLost(ExitWaylineWhenRcLostEnum.EXECUTE_RC_LOST_ACTION)
                .setFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskFile</span>()
                        .setUrl(url.toString())
                        .setFingerprint(waylineFile.get().getSign()));

        <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL == waylineJob.getTaskType()) {
            <span class="hljs-keyword">if</span> (Objects.isNull(waylineJob.getConditions())) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
            }
            flightTask.setReadyConditions(waylineJob.getConditions().getReadyConditions());
            flightTask.setExecutableConditions(waylineJob.getConditions().getExecutableConditions());
        }

        TopicServicesResponse&lt;ServicesReplyData&gt; serviceReply = abstractWaylineService.flighttaskPrepare(
                SDKManager.getDeviceSDK(waylineJob.getDockSn()), flightTask);
        <span class="hljs-keyword">if</span> (!serviceReply.getData().getResult().isSuccess()) {
            log.info(<span class="hljs-string">"Prepare task ====&gt; Error code: {}"</span>, serviceReply.getData().getResult());
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .workspaceId(waylineJob.getWorkspaceId())
                    .jobId(waylineJob.getJobId())
                    .executeTime(LocalDateTime.now())
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .completedTime(LocalDateTime.now())
                    .code(serviceReply.getData().getResult().getCode()).build());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<ol start="8">
<li><code>prepareConditionJob</code>定时任务，每<code>5s</code>对 Redis 中的条件任务集合扫描一次。</li>
<li>获取最近的条件任务，以及任务的开始时间，判断如果<code>当前时间 + 1天 &lt; 任务开始时间</code>，直接返回。【判断任务开始时间是否达到提前准备阈值,默认提前一天】</li>
<li>从Redis中获取任务完整信息，再次调用<code>publishOneFlightTask()</code>发布任务,移除Redis中的条件任务，成功就直接返回
【两次调用<code>publishOneFlightTask()</code>方法，个人认为是为了冗余安全设计，避免条件任务因定时方法间隔没收到任务而触发失败】</li>
<li>失败，删除Redis中<code>WAYLINE_JOB_CONDITION_PREFIX+jobId</code>对应的条件任务，判断任务是否已经过期，过期就直接放弃，未过期就调用 <code>retryPrepareJob()</code>生成子任务并重新加入准备队列。</li>
</ol>
<p><strong>[3]prepareConditionJob定时方法</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Scheduled(initialDelay = 10, fixedRate = 5, timeUnit = TimeUnit.SECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareConditionJob</span><span class="hljs-params">()</span> {
    
        <span class="hljs-comment">//获取最近的条件任务，如果队列为空，不做任何事。</span>
        Optional&lt;ConditionalWaylineJobKey&gt; jobKeyOpt = waylineRedisService.getNearestConditionalWaylineJob();
        <span class="hljs-keyword">if</span> (jobKeyOpt.isEmpty()) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">//获取任务开始时间，判断如果当前时间 + 1天 &lt; 任务开始时间，直接返回。</span>
        <span class="hljs-type">ConditionalWaylineJobKey</span> <span class="hljs-variable">jobKey</span> <span class="hljs-operator">=</span> jobKeyOpt.get();
        log.info(<span class="hljs-string">"Check the conditional tasks of the wayline. {}"</span>, jobKey.toString());
        <span class="hljs-comment">// format: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> waylineRedisService.getConditionalWaylineJobTime(jobKey);
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// prepare the task one day in advance.</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">86_400_000</span>;

        <span class="hljs-keyword">if</span> (now + offset &lt; time) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//初始化失败任务对象，用于后续异常处理或Redis数据丢失时任务状态的更新</span>
        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> WaylineJobDTO.builder()
                .jobId(jobKey.getJobId())
                .status(WaylineJobStatusEnum.FAILED.getVal())
                .executeTime(LocalDateTime.now())
                .completedTime(LocalDateTime.now())
                .code(HttpStatus.SC_INTERNAL_SERVER_ERROR).build();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//获取任务详情</span>
            Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineRedisService.getConditionalWaylineJob(jobKey.getJobId());
            <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                job.setCode(CommonErrorEnum.REDIS_DATA_NOT_FOUND.getCode());
                waylineJobService.updateJob(job);
                waylineRedisService.removePrepareConditionalWaylineJob(jobKey);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();

            <span class="hljs-comment">//调用publishOneFlightTask()发布任务</span>
            <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
            waylineRedisService.removePrepareConditionalWaylineJob(jobKey);

            <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS == result.getCode()) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">//删除Redis中对应的条件任务</span>
            <span class="hljs-comment">// If the end time is exceeded, no more retries will be made.</span>
            waylineRedisService.delConditionalWaylineJob(jobKey.getJobId());
            
            <span class="hljs-comment">//判断任务是否已经过期，过期就直接返回，未过期就调用 retryPrepareJob()重试。</span>
            <span class="hljs-keyword">if</span> (waylineJob.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() - RedisConst.WAYLINE_JOB_BLOCK_TIME * <span class="hljs-number">1000</span> &lt; now) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// Retry if the end time has not been exceeded.</span>
            <span class="hljs-built_in">this</span>.retryPrepareJob(jobKey, waylineJob);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.info(<span class="hljs-string">"Failed to prepare the conditional task."</span>);
            waylineJobService.updateJob(job);
        }

    }
</code></pre>
<ol start="11">
<li><strong>下发条件任务后，设备会定频检查下发任务 API 中的 ready_conditions 是否全部满足，若全部满足则会有任务就绪通知（flighttask_ready）事件通知。</strong></li>
<li>读取 flightId，判断任务是否被阻塞</li>
<li>调用 executeFlightTask() 执行飞行任务</li>
<li>判断执行结果：</li>
</ol>
<ul>
<li>成功：任务开始执行</li>
<li>失败但为阻塞错误：写入 blocked 状态</li>
<li>失败且可重试：创建子任务 → retryPrepareJob</li>
</ul>
<p><strong>[4]flighttaskReady (mqtt事件通知接收)</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> TopicEventsResponse&lt;MqttReply&gt; <span class="hljs-title function_">flighttaskReady</span><span class="hljs-params">(TopicEventsRequest&lt;FlighttaskReady&gt; response, MessageHeaders headers)</span> {
        List&lt;String&gt; flightIds = response.getData().getFlightIds();

        log.info(<span class="hljs-string">"ready task list：{}"</span>, Arrays.toString(flightIds.toArray()) );
        <span class="hljs-comment">// Check conditional task blocking status.</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">blockedId</span> <span class="hljs-operator">=</span> waylineRedisService.getBlockedWaylineJobId(response.getGateway());
        
        <span class="hljs-comment">//这段代码根据论坛回复来看，存在bug，详情见参考资料【3】</span>
        <span class="hljs-comment">//if (!StringUtils.hasText(blockedId)) {</span>
        <span class="hljs-comment">//    return null;</span>
        <span class="hljs-comment">//}</span>

        Optional&lt;DeviceDTO&gt; deviceOpt = deviceRedisService.getDeviceOnline(response.getGateway());
        <span class="hljs-keyword">if</span> (deviceOpt.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-type">DeviceDTO</span> <span class="hljs-variable">device</span> <span class="hljs-operator">=</span> deviceOpt.get();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (String jobId : flightIds) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isExecute</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.executeFlightTask(device.getWorkspaceId(), jobId);
                <span class="hljs-keyword">if</span> (!isExecute) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineRedisService.getConditionalWaylineJob(jobId);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    log.info(<span class="hljs-string">"The conditional job has expired and will no longer be executed."</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                <span class="hljs-built_in">this</span>.retryPrepareJob(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionalWaylineJobKey</span>(device.getWorkspaceId(), response.getGateway(), jobId), waylineJob);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to execute conditional task."</span>);
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
    }
    
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryPrepareJob</span><span class="hljs-params">(ConditionalWaylineJobKey jobKey, WaylineJobDTO waylineJob)</span> {
        Optional&lt;WaylineJobDTO&gt; childJobOpt = waylineJobService.createWaylineJobByParent(jobKey.getWorkspaceId(), jobKey.getJobId());
        <span class="hljs-keyword">if</span> (childJobOpt.isEmpty()) {
            log.error(<span class="hljs-string">"Failed to create wayline job."</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">newJob</span> <span class="hljs-operator">=</span> childJobOpt.get();
        newJob.setBeginTime(LocalDateTime.now().plusSeconds(RedisConst.WAYLINE_JOB_BLOCK_TIME));
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> waylineRedisService.addPrepareConditionalWaylineJob(newJob);
        <span class="hljs-keyword">if</span> (!isAdd) {
            log.error(<span class="hljs-string">"Failed to create wayline job. {}"</span>, newJob.getJobId());
            <span class="hljs-keyword">return</span>;
        }

        waylineJob.setJobId(newJob.getJobId());
        waylineRedisService.setConditionalWaylineJob(waylineJob);
    }

    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">executeFlightTask</span><span class="hljs-params">(String workspaceId, String jobId)</span> {
        <span class="hljs-comment">// get job</span>
        Optional&lt;WaylineJobDTO&gt; waylineJob = waylineJobService.getJobByJobId(workspaceId, jobId);
        <span class="hljs-keyword">if</span> (waylineJob.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Job doesn't exist."</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.get().getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> waylineJob.get();

        TopicServicesResponse&lt;ServicesReplyData&gt; serviceReply = abstractWaylineService.flighttaskExecute(
                SDKManager.getDeviceSDK(job.getDockSn()), <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskExecuteRequest</span>().setFlightId(jobId));
        <span class="hljs-keyword">if</span> (!serviceReply.getData().getResult().isSuccess()) {
            log.info(<span class="hljs-string">"Execute job ====&gt; Error: {}"</span>, serviceReply.getData().getResult());
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .jobId(jobId)
                    .executeTime(LocalDateTime.now())
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .completedTime(LocalDateTime.now())
                    .code(serviceReply.getData().getResult().getCode()).build());
            <span class="hljs-comment">// The conditional task fails and enters the blocking status.</span>
            <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL == job.getTaskType()
                    &amp;&amp; WaylineErrorCodeEnum.find(serviceReply.getData().getResult().getCode()).isBlock()) {
                waylineRedisService.setBlockedWaylineJob(job.getDockSn(), jobId);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        waylineJobService.updateJob(WaylineJobDTO.builder()
                .jobId(jobId)
                .executeTime(LocalDateTime.now())
                .status(WaylineJobStatusEnum.IN_PROGRESS.getVal())
                .build());
        waylineRedisService.setRunningWaylineJob(job.getDockSn(), EventsReceiver.&lt;FlighttaskProgress&gt;builder().bid(jobId).sn(job.getDockSn()).build());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p><strong>参考资料：</strong></p>
<p>上云API开源代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdji-sdk%2FDJI-Cloud-API-Demo" target="_blank" title="https://github.com/dji-sdk/DJI-Cloud-API-Demo" ref="nofollow noopener noreferrer">github.com/dji-sdk/DJI…</a></p>
<p>大疆上云API文档-机场功能集-航线管理：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.dji.com%2Fdoc%2Fcloud-api-tutorial%2Fcn%2Ffeature-set%2Fdock-feature-set%2Fdock-wayline-management.html" target="_blank" title="https://developer.dji.com/doc/cloud-api-tutorial/cn/feature-set/dock-feature-set/dock-wayline-management.html" ref="nofollow noopener noreferrer">developer.dji.com/doc/cloud-a…</a></p>
<p>大疆创新SDK技术支持论坛-下发条件任务成功，但满足条件后任务并不执行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsdk-forum.dji.net%2Fhc%2Fzh-cn%2Fcommunity%2Fposts%2F38931172754329-%25E4%25B8%258B%25E5%258F%2591%25E6%259D%25A1%25E4%25BB%25B6%25E4%25BB%25BB%25E5%258A%25A1%25E6%2588%2590%25E5%258A%259F-%25E4%25BD%2586%25E6%25BB%25A1%25E8%25B6%25B3%25E6%259D%25A1%25E4%25BB%25B6%25E5%2590%258E%25E4%25BB%25BB%25E5%258A%25A1%25E5%25B9%25B6%25E4%25B8%258D%25E6%2589%25A7%25E8%25A1%258C" target="_blank" title="https://sdk-forum.dji.net/hc/zh-cn/community/posts/38931172754329-%E4%B8%8B%E5%8F%91%E6%9D%A1%E4%BB%B6%E4%BB%BB%E5%8A%A1%E6%88%90%E5%8A%9F-%E4%BD%86%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%E5%90%8E%E4%BB%BB%E5%8A%A1%E5%B9%B6%E4%B8%8D%E6%89%A7%E8%A1%8C" ref="nofollow noopener noreferrer">sdk-forum.dji.net/hc/zh-cn/co…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案]]></title>    <link>https://juejin.cn/post/7582786655473106987</link>    <guid>https://juejin.cn/post/7582786655473106987</guid>    <pubDate>2025-12-12T10:00:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655473106987" data-draft-id="7582786655473090603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T10:00:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T10:00:30.000Z" title="Fri Dec 12 2025 10:00:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多团队中，iOS 上架一直被认为是“只能在 Mac 上完成的事情”。但随着跨端开发的普及（uni-app、Flutter、H5 封装等），越来越多的项目成员长期使用 Windows 开发环境。当应用开发完成后，一个现实问题摆在面前：<strong>没有 Mac，iOS 应用还能不能上架？</strong></p>
<p>从工程角度来看，答案是肯定的。
关键在于区分清楚哪些步骤 <strong>必须依赖 macOS</strong>，哪些步骤 <strong>可以在 Windows 上完成</strong>，以及如何通过合适的工具把整个上架流程拆解并重新组合。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、先明确一个事实：iOS 上架 ≠ 全流程都要 Mac</strong></h2>
<p>很多人之所以认为“没有 Mac 就无法上架 iOS”，是因为混淆了几个不同的阶段。</p>
<p>实际上，iOS 上架流程可以拆解为：</p>
<ol>
<li>账号与应用身份准备</li>
<li>证书与描述文件管理</li>
<li>iOS 工程构建（生成 IPA）</li>
<li>IPA 校验与上传</li>
<li>审核与发布</li>
</ol>
<p>其中，<strong>真正强依赖 macOS 的只有“iOS 原生工程构建”这一步</strong>。
而在跨端项目中，这一步往往可以通过：</p>
<ul>
<li>云打包</li>
<li>CI 的 macOS Runner</li>
<li>外包或共享 Mac</li>
<li>第三方打包服务</li>
</ul>
<p>来完成。
其余步骤，理论上都可以在 Windows 环境中处理。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、Windows 上准备上架的第一步：账号与 Bundle ID</strong></h2>
<p>无论使用什么开发方式，上架 iOS 应用都必须先完成应用身份的创建。</p>
<h3 data-id="heading-2"><strong>1. Apple 开发者账号</strong></h3>
<p>这是前置条件，本文不再展开。</p>
<h3 data-id="heading-3"><strong>2. Bundle ID 的创建与确认</strong></h3>
<p>Bundle ID 是应用在苹果体系中的唯一标识。
在团队协作中，常见问题包括：</p>
<ul>
<li>不清楚账号下已有多少 Bundle ID</li>
<li>重复创建导致冲突</li>
<li>命名混乱，后期难以维护</li>
</ul>
<p>在 Windows 环境下，我通常会使用：</p>
<ul>
<li><strong>Appuploader 的 Bundle ID 查看与管理功能</strong></li>
</ul>
<p>它可以直接列出当前账号中的应用 ID，帮助确认：</p>
<ul>
<li>是否已存在可用的 Bundle ID</li>
<li>是否需要新建</li>
<li>命名是否规范</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b12c7cdb7442b89bb1df70651a52fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=hKpRXFxuQR6Br0JwMGboKC%2FkluU%3D" alt="bid" loading="lazy"/></p>
<p>这样可以避免在没有 Mac 的情况下盲目创建标识符。</p>
<hr/>
<h2 data-id="heading-4"><strong>三、在 Windows 上管理 iOS 证书：关键突破点</strong></h2>
<p>证书管理是“Windows 上架 iOS”的最大阻碍之一。
传统方式必须使用 macOS 钥匙串生成证书，这直接把 Windows 用户挡在门外。</p>
<h3 data-id="heading-5"><strong>1. 在 Windows 上创建 iOS 证书</strong></h3>
<p>在实际项目中，我会使用：</p>
<ul>
<li><strong>开心上架（Appuploader）创建 iOS 证书</strong></li>
</ul>
<p>其特点是：</p>
<ul>
<li>可在 Windows、Linux、macOS 上操作</li>
<li>不依赖钥匙串助手</li>
<li>只需填写证书名称、邮箱和密码</li>
<li>生成的证书文件（如 p12）可在多台电脑或 CI 中使用</li>
</ul>
<p>这一步的意义在于：<strong>证书不再被某一台 Mac 垄断，Windows 成员也能参与证书管理。</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e17e2bdac5c425d99a6d6bfc017d909~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=Wt2G8TpsrZi%2FS4GQ7P%2F0juBWY0A%3D" alt="证书创建" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6"><strong>2. 描述文件（mobileprovision）的查看与校验</strong></h3>
<p>描述文件中包含：</p>
<ul>
<li>绑定的证书</li>
<li>Bundle ID</li>
<li>Team ID</li>
<li>能力权限</li>
</ul>
<p>在 Windows 环境下，如果无法查看这些信息，很容易出现“用错 profile”的问题。</p>
<p>通过 <strong>Appuploader 的 mobileprovision 查看功能</strong>，可以在 Windows 上直接确认：</p>
<ul>
<li>当前描述文件是否为发布类型</li>
<li>是否绑定了正确的证书</li>
<li>Bundle ID 是否匹配</li>
</ul>
<p>这一步可以在构建前就排除大量潜在错误。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4227e026c706411c855acad1b79069c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=haa6tztAdKb4gK8xAXVol0i9X%2F8%3D" alt="查看文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7"><strong>四、iOS 工程构建：Windows 团队的常见解决方案</strong></h2>
<p>需要明确的是：
<strong>生成 IPA 的那一步，仍然需要 macOS。</strong></p>
<p>但这并不意味着每个成员都要有 Mac。常见做法包括：</p>
<h3 data-id="heading-8"><strong>1. 云打包 / 云构建</strong></h3>
<ul>
<li>HBuilderX 云打包（uni-app）</li>
<li>Codemagic</li>
<li>GitHub Actions（macOS Runner）</li>
</ul>
<h3 data-id="heading-9"><strong>2. CI 构建</strong></h3>
<ul>
<li>Jenkins + Mac Mini</li>
<li>GitLab CI + macOS 节点</li>
</ul>
<h3 data-id="heading-10"><strong>3. 共享或外包 Mac</strong></h3>
<p>只用于构建，不参与其他流程。</p>
<p>构建完成后，IPA 文件会被输出到服务器或共享目录，接下来就可以完全回到 Windows 环境。</p>
<hr/>
<h2 data-id="heading-11"><strong>五、IPA 文件检查：Windows 上非常关键的一步</strong></h2>
<p>很多 iOS 上架问题，并不是构建失败，而是 <strong>IPA 内部内容有误</strong>，例如：</p>
<ul>
<li>使用了开发证书</li>
<li>描述文件类型错误</li>
<li>Bundle ID 不一致</li>
<li>缺少 Assets.car</li>
<li>Info.plist 权限说明不完整</li>
</ul>
<p>在 Windows 上，我通常会在上传前检查 IPA 内容，例如：</p>
<ul>
<li><strong>使用 Appuploader 查看 IPA 内的 Info.plist</strong></li>
<li>检查 mobileprovision 是否为发布描述文件</li>
<li>确认 Bundle ID 与 App Store Connect 中一致</li>
</ul>
<p>提前发现问题，比上传失败后再返工效率高得多。</p>
<hr/>
<h2 data-id="heading-12"><strong>六、核心步骤：在 Windows 上上传 IPA 到 App Store</strong></h2>
<p>这是“Windows 上架 iOS”的关键一环。</p>
<p>传统工具（Xcode、Transporter）都依赖 macOS，因此在 Windows 环境下不可用。</p>
<p>在实际项目中，我会使用：</p>
<h3 data-id="heading-13"><strong>Appuploader CLI 在 Windows 上传 IPA</strong></h3>
<p>示例命令：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u appleid@example.com -p xxxx-xxxx-xxxx -c 1 -f app.ipa
</code></pre>
<p>这一步的优势在于：</p>
<ul>
<li><strong>完全支持 Windows</strong></li>
<li>不依赖 Xcode 或 Transporter</li>
<li>可集成到脚本或 CI</li>
<li>上传行为不携带 Mac 设备信息</li>
</ul>
<p>这意味着：<strong>只要拿到 IPA，Windows 环境就可以完成上架上传。</strong>
图形化界面：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007a9737e7ba4663b98ddd1d276e0e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=MyksM170eh%2FsrWuKv%2BzPBbgmF7o%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14"><strong>七、审核与发布：Windows 环境同样可完成</strong></h2>
<p>IPA 上传完成后，后续操作包括：</p>
<ul>
<li>填写 App Store 信息</li>
<li>提交审核</li>
<li>查看审核结果</li>
<li>回复审核问题</li>
</ul>
<p>这些步骤本身就是 Web 操作，与操作系统无关，Windows 完全可以胜任。</p>
<hr/>
<h2 data-id="heading-15"><strong>八、一个完整的 Windows 上架 iOS 流程示例</strong></h2>
<p>综合上述步骤，一个可行流程如下：</p>
<ol>
<li>Windows 上确认 Bundle ID（Appuploader）</li>
<li>Windows 上创建证书并管理 profile（Appuploader）</li>
<li>macOS / 云端构建 IPA</li>
<li>Windows 上检查 IPA 内容（Appuploader）</li>
<li>Windows 上通过 Appuploader CLI 上传 IPA</li>
<li>Web 端提交审核并发布</li>
</ol>
<p>整个流程中，Mac 只作为“构建工具”，而不是流程中心。</p>
<hr/>
<p>“如何在 Windows 上架 iOS”并不是一个技巧问题，而是流程拆解与工具选择的问题。
当证书、Bundle ID、IPA 校验与上传这些环节都能在 Windows 上完成时，iOS 上架就不再是 Mac 独占的能力。</p>
<p>最终目标不是“绕开 Mac”，而是让上架流程 <strong>不再依赖某一台电脑或某一个人</strong>。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」]]></title>    <link>https://juejin.cn/post/7582786292087324723</link>    <guid>https://juejin.cn/post/7582786292087324723</guid>    <pubDate>2025-12-12T09:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786292087324723" data-draft-id="7582777037863518258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」"/> <meta itemprop="keywords" content="后端,Java,安全"/> <meta itemprop="datePublished" content="2025-12-12T09:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:42:56.000Z" title="Fri Dec 12 2025 09:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>将加解密逻辑封装成<strong>通用、可配置、解耦的组件</strong>，核心是遵循「开闭原则+模板方法+拦截器/中间件模式」，让业务代码无需嵌入加密逻辑，仅通过<strong>注解/配置</strong>指定需要加密的接口/字段即可。以下是落地方案，以Java Spring Boot（主流企业级框架）为例，同时兼容Go/Python等语言的核心思路。</p>
<h3 data-id="heading-0">一、通用组件设计核心原则</h3>
<ol>
<li><strong>完全解耦</strong>：加密逻辑与业务代码隔离，业务侧仅需「声明式配置」（注解/yml），无需写任何加密代码；</li>
<li><strong>可配置化</strong>：支持指定「哪些接口、哪些字段」加密/解密，支持切换算法（AES-GCM/ECC/RSA）、密钥来源（KMS/HSM/本地）；</li>
<li><strong>易扩展</strong>：新增加密算法/加密规则时，无需修改核心组件，仅需扩展接口；</li>
<li><strong>高性能</strong>：组件内部封装对象池、硬件加速、异步处理，对业务透明；</li>
<li><strong>可监控</strong>：内置加解密耗时、失败率监控，便于排查问题。</li>
</ol>
<h3 data-id="heading-1">二、通用组件分层架构（解耦核心）</h3>
<p>组件分为5层，每层职责单一，通过依赖注入解耦：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────┐
│ 业务层（Controller/Service）                            │
│ （仅加注解/配置，无加密代码）                            │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 接入层（拦截器/过滤器/Middleware）                       │
│ （拦截请求/响应，触发加解密，对业务透明）                │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 核心服务层（CryptoTemplate）                             │
│ （封装通用加解密/签名验签流程，模板方法）                │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 基础设施层（AlgorithmFactory + KeyManager）              │
│ （封装算法、密钥管理，屏蔽底层细节）                    │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 配置/注解层（<span class="hljs-keyword">@Encrypt</span> + yml配置）                       │
│ （指定加密规则：接口、字段、算法、密钥）                │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">三、核心模块实现（Spring Boot版通用组件）</h3>
<p>以下是可直接落地的核心代码，聚焦「解耦+通用」，屏蔽复杂的算法细节，业务侧仅需简单配置。</p>
<h4 data-id="heading-3">1. 第一步：定义配置/注解（业务侧仅需接触这层）</h4>
<h5 data-id="heading-4">（1）自定义注解（标记需要加密的接口/字段）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 接口级注解：标记该接口需要加密入参、解密出参
 */</span>
<span class="hljs-meta">@Target({ElementType.METHOD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ApiEncrypt {
    <span class="hljs-comment">// 加密算法（默认AES-GCM）</span>
    String <span class="hljs-title function_">algorithm</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"AES-GCM"</span>;
    <span class="hljs-comment">// 密钥标识（关联yml中的密钥配置）</span>
    String <span class="hljs-title function_">keyId</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"pay_default_key"</span>;
    <span class="hljs-comment">// 是否验签（默认开启）</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">/**
 * 字段级注解：标记DTO中的敏感字段，仅加密这些字段
 */</span>
<span class="hljs-meta">@Target({ElementType.FIELD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SensitiveField {
    <span class="hljs-comment">// 字段描述（非必需，用于日志）</span>
    String <span class="hljs-title function_">desc</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
}
</code></pre>
<h5 data-id="heading-5">（2）yml配置（算法、密钥、超时等）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">crypto:</span>
  <span class="hljs-comment"># 全局配置</span>
  <span class="hljs-attr">global:</span>
    <span class="hljs-attr">algorithm:</span> <span class="hljs-string">AES-GCM</span>  <span class="hljs-comment"># 默认算法</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">1000ms</span>     <span class="hljs-comment"># 加解密超时</span>
    <span class="hljs-attr">enable-hardware-accel:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启硬件加速</span>
  <span class="hljs-comment"># 密钥配置（支持KMS/HSM，此处简化为本地配置，生产需替换为KMS）</span>
  <span class="hljs-attr">keys:</span>
    <span class="hljs-attr">pay_default_key:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">ECC</span>  <span class="hljs-comment"># 密钥类型（ECC/RSA/AES）</span>
      <span class="hljs-attr">public-key:</span> <span class="hljs-string">"xxx"</span>  <span class="hljs-comment"># 服务端公钥（客户端用）</span>
      <span class="hljs-attr">private-key:</span> <span class="hljs-string">"xxx"</span> <span class="hljs-comment"># 服务端私钥（服务端用）</span>
      <span class="hljs-attr">expire:</span> <span class="hljs-string">90d</span>        <span class="hljs-comment"># 密钥轮换周期</span>
  <span class="hljs-comment"># 忽略加密的字段（全局）</span>
  <span class="hljs-attr">ignore-fields:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"orderId"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"merchantId"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"timestamp"</span>
</code></pre>
<h4 data-id="heading-6">2. 第二步：基础设施层（封装算法+密钥，对业务透明）</h4>
<h5 data-id="heading-7">（1）算法工厂（统一封装算法，支持扩展）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 算法工厂：根据配置动态创建加解密器，屏蔽算法细节
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlgorithmFactory</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoProperties cryptoProperties;

    <span class="hljs-comment">// 缓存加解密器对象，避免重复创建（性能优化）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, CryptoHandler&gt; handlerCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取指定算法的加解密器
     */</span>
    <span class="hljs-keyword">public</span> CryptoHandler <span class="hljs-title function_">getHandler</span><span class="hljs-params">(String algorithm, String keyId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> algorithm + <span class="hljs-string">"_"</span> + keyId;
        <span class="hljs-keyword">if</span> (handlerCache.containsKey(cacheKey)) {
            <span class="hljs-keyword">return</span> handlerCache.get(cacheKey);
        }
        <span class="hljs-comment">// 根据算法类型创建对应处理器（策略模式）</span>
        <span class="hljs-type">CryptoHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (algorithm) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"AES-GCM"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesGcmHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">case</span> <span class="hljs-string">"ECC"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">EccHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">case</span> <span class="hljs-string">"RSA"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RsaHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">default</span> -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"不支持的算法："</span> + algorithm);
        };
        handlerCache.put(cacheKey, handler);
        <span class="hljs-keyword">return</span> handler;
    }

    <span class="hljs-comment">// 加解密器接口（扩展新算法只需实现此接口）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CryptoHandler</span> {
        <span class="hljs-comment">// 加密数据</span>
        <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] data, String keyId);
        <span class="hljs-comment">// 解密数据</span>
        <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] data, String keyId);
        <span class="hljs-comment">// 签名</span>
        String <span class="hljs-title function_">sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String keyId)</span>;
        <span class="hljs-comment">// 验签</span>
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String sign, String keyId)</span>;
    }

    <span class="hljs-comment">// AES-GCM实现（示例，其余算法同理）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AesGcmHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CryptoHandler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KeyConfig keyConfig;
        <span class="hljs-comment">// 缓存Cipher对象（性能优化）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectPool&lt;Cipher&gt; cipherPool;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">AesGcmHandler</span><span class="hljs-params">(KeyConfig keyConfig)</span> {
            <span class="hljs-built_in">this</span>.keyConfig = keyConfig;
            <span class="hljs-comment">// 初始化Cipher对象池</span>
            <span class="hljs-built_in">this</span>.cipherPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CipherPooledFactory</span>(<span class="hljs-string">"AES/GCM/NoPadding"</span>));
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] data, String keyId) {
            <span class="hljs-keyword">try</span> (PooledObject&lt;Cipher&gt; pooledCipher = cipherPool.borrowObject()) {
                <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> pooledCipher.getObject();
                <span class="hljs-comment">// 省略AES-GCM加密逻辑（复用之前的代码）</span>
                <span class="hljs-keyword">return</span> cipher.doFinal(data);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"AES加密失败"</span>, e);
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] data, String keyId) {
            <span class="hljs-comment">// 同理，省略解密逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String keyId)</span> {
            <span class="hljs-comment">// 省略签名逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String sign, String keyId)</span> {
            <span class="hljs-comment">// 省略验签逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
}
</code></pre>
<h5 data-id="heading-8">（2）密钥管理器（统一管理密钥，支持KMS/HSM）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 密钥管理器：统一获取密钥（本地/KMS/HSM），对上层透明
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyManager</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CryptoProperties</span> cryptoProperties;
    <span class="hljs-comment">// 对接KMS的客户端（生产环境用）</span>
    <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">KmsClient</span> kmsClient;

    <span class="hljs-comment">/**
     * 获取密钥（优先从KMS获取，本地为兜底）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getKey</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyId</span>) {
        <span class="hljs-title class_">KeyConfig</span> keyConfig = cryptoProperties.<span class="hljs-title function_">getKeys</span>().<span class="hljs-title function_">get</span>(keyId);
        <span class="hljs-keyword">if</span> (keyConfig == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"密钥配置不存在："</span> + keyId);
        }
        <span class="hljs-comment">// 生产环境：从KMS/HSM获取密钥</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"KMS"</span>.<span class="hljs-title function_">equals</span>(keyConfig.<span class="hljs-title function_">getType</span>())) {
            <span class="hljs-keyword">return</span> kmsClient.<span class="hljs-title function_">getSecret</span>(keyId);
        }
        <span class="hljs-comment">// 测试环境：本地配置（生产禁用）</span>
        <span class="hljs-keyword">return</span> keyConfig.<span class="hljs-title function_">getPrivateKey</span>();
    }
}
</code></pre>
<h4 data-id="heading-9">3. 第三步：核心服务层（模板方法封装通用流程）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 加解密模板：封装通用流程，拦截器直接调用，无需重复写逻辑
 */</span>
<span class="hljs-keyword">@Service</span>
public class CryptoTemplate {
    <span class="hljs-keyword">@Autowired</span>
    private AlgorithmFactory algorithmFactory;
    <span class="hljs-keyword">@Autowired</span>
    private KeyManager keyManager;

    <span class="hljs-comment">/**
     * 通用加密流程：加密敏感字段 + 签名
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">encrypt</span>(T data, String algorithm, String keyId) {
        try {
            <span class="hljs-comment">// 1. 获取算法处理器</span>
            AlgorithmFactory<span class="hljs-selector-class">.CryptoHandler</span> handler = algorithmFactory<span class="hljs-selector-class">.getHandler</span>(algorithm, keyId);
            <span class="hljs-comment">// 2. 反射获取@SensitiveField字段，仅加密这些字段</span>
            Field<span class="hljs-selector-attr">[]</span> fields = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredFields</span>();
            for (Field field : fields) {
                if (field.isAnnotationPresent(SensitiveField.class)) {
                    field<span class="hljs-selector-class">.setAccessible</span>(true);
                    <span class="hljs-selector-tag">Object</span> value = field<span class="hljs-selector-class">.get</span>(data);
                    if (value != null) {
                        <span class="hljs-comment">// 3. 加密敏感字段</span>
                        byte<span class="hljs-selector-attr">[]</span> encrypted = handler<span class="hljs-selector-class">.encrypt</span>(value.toString()<span class="hljs-selector-class">.getBytes</span>(), keyId);
                        field<span class="hljs-selector-class">.set</span>(data, Base64.getEncoder()<span class="hljs-selector-class">.encodeToString</span>(encrypted));
                    }
                }
            }
            <span class="hljs-comment">// 4. 签名（可选）</span>
            String sign = handler<span class="hljs-selector-class">.sign</span>(JsonUtil.toJsonBytes(data), keyId);
            <span class="hljs-comment">// 给DTO设置签名（假设DTO有sign字段）</span>
            Field signField = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredField</span>("sign");
            signField<span class="hljs-selector-class">.setAccessible</span>(true);
            signField<span class="hljs-selector-class">.set</span>(data, sign);
            return data;
        } catch (Exception e) {
            throw new <span class="hljs-built_in">CryptoException</span>("加密失败", e);
        }
    }

    <span class="hljs-comment">/**
     * 通用解密流程：验签 + 解密敏感字段
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">decrypt</span>(T data, String algorithm, String keyId) {
        try {
            AlgorithmFactory<span class="hljs-selector-class">.CryptoHandler</span> handler = algorithmFactory<span class="hljs-selector-class">.getHandler</span>(algorithm, keyId);
            <span class="hljs-comment">// 1. 验签</span>
            Field signField = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredField</span>("sign");
            signField<span class="hljs-selector-class">.setAccessible</span>(true);
            String sign = (String) signField<span class="hljs-selector-class">.get</span>(data);
            if (!handler.verifySign(JsonUtil.toJsonBytes(data), sign, keyId)) {
                throw new <span class="hljs-built_in">CryptoException</span>("验签失败");
            }
            <span class="hljs-comment">// 2. 解密敏感字段</span>
            Field<span class="hljs-selector-attr">[]</span> fields = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredFields</span>();
            for (Field field : fields) {
                if (field.isAnnotationPresent(SensitiveField.class)) {
                    field<span class="hljs-selector-class">.setAccessible</span>(true);
                    String encryptedValue = (String) field<span class="hljs-selector-class">.get</span>(data);
                    if (encryptedValue != null) {
                        byte<span class="hljs-selector-attr">[]</span> decrypted = handler<span class="hljs-selector-class">.decrypt</span>(Base64.getDecoder()<span class="hljs-selector-class">.decode</span>(encryptedValue), keyId);
                        field<span class="hljs-selector-class">.set</span>(data, new String(decrypted));
                    }
                }
            }
            return data;
        } catch (Exception e) {
            throw new <span class="hljs-built_in">CryptoException</span>("解密失败", e);
        }
    }
}
</code></pre>
<h4 data-id="heading-10">4. 第四步：接入层（拦截器，自动处理请求/响应）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 加解密拦截器：拦截<span class="hljs-doctag">@ApiEncrypt</span>注解的接口，自动处理加解密
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CryptoInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoTemplate cryptoTemplate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 判断是否是Controller方法，且有@ApiEncrypt注解</span>
        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod handlerMethod) {
            <span class="hljs-type">ApiEncrypt</span> <span class="hljs-variable">apiEncrypt</span> <span class="hljs-operator">=</span> handlerMethod.getMethodAnnotation(ApiEncrypt.class);
            <span class="hljs-keyword">if</span> (apiEncrypt != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 2. 读取请求体</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> StreamUtils.copyToString(request.getInputStream(), StandardCharsets.UTF_8);
                <span class="hljs-comment">// 3. 反序列化为DTO（需获取方法入参类型）</span>
                Class&lt;?&gt; paramType = handlerMethod.getMethod().getParameterTypes()[<span class="hljs-number">0</span>];
                <span class="hljs-type">Object</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> JsonUtil.fromJson(requestBody, paramType);
                <span class="hljs-comment">// 4. 解密DTO（自动处理敏感字段）</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">decryptedDto</span> <span class="hljs-operator">=</span> cryptoTemplate.decrypt(dto, apiEncrypt.algorithm(), apiEncrypt.keyId());
                <span class="hljs-comment">// 5. 替换请求体为解密后的数据（让Controller拿到明文）</span>
                request.setAttribute(<span class="hljs-string">"decryptedParam"</span>, decryptedDto);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 判断是否有@ApiEncrypt注解</span>
        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod handlerMethod) {
            <span class="hljs-type">ApiEncrypt</span> <span class="hljs-variable">apiEncrypt</span> <span class="hljs-operator">=</span> handlerMethod.getMethodAnnotation(ApiEncrypt.class);
            <span class="hljs-keyword">if</span> (apiEncrypt != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 2. 获取Controller返回的响应体（需结合ResponseBodyAdvice）</span>
                <span class="hljs-comment">// 此处简化，实际用ResponseBodyAdvice拦截响应更优雅</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> request.getAttribute(<span class="hljs-string">"responseBody"</span>);
                <span class="hljs-comment">// 3. 加密响应体（自动处理敏感字段）</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">encryptedBody</span> <span class="hljs-operator">=</span> cryptoTemplate.encrypt(responseBody, apiEncrypt.algorithm(), apiEncrypt.keyId());
                <span class="hljs-comment">// 4. 写入加密后的响应</span>
                response.getWriter().write(JsonUtil.toJson(encryptedBody));
            }
        }
    }
}

<span class="hljs-comment">// 注册拦截器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoInterceptor cryptoInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(cryptoInterceptor)
                .addPathPatterns(<span class="hljs-string">"/api/pay/**"</span>) <span class="hljs-comment">// 仅拦截支付相关接口</span>
                .excludePathPatterns(<span class="hljs-string">"/api/public/**"</span>); <span class="hljs-comment">// 排除公开接口</span>
    }
}
</code></pre>
<h4 data-id="heading-11">5. 第五步：业务侧使用（极简，无加密代码）</h4>
<h5 data-id="heading-12">（1）定义DTO（仅标记敏感字段）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支付请求DTO</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayRequestDTO</span> {
    <span class="hljs-comment">// 非敏感字段，无需加密</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> merchantId;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> timestamp;
    <span class="hljs-comment">// 签名字段（自动生成/验证）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> sign;

    <span class="hljs-comment">// 敏感字段，标记后自动加密/解密</span>
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"银行卡号"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cardNo;
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"CVV码"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cvv;
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"支付金额"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> amount;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<h5 data-id="heading-13">（2）Controller（仅加注解，无加密逻辑）</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/pay"</span>)
public class PayController {
    <span class="hljs-variable">@Autowired</span>
    private PayService payService;

    <span class="hljs-comment">// 仅需加@ApiEncrypt注解，自动解密入参、加密出参</span>
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/submit"</span>)
    <span class="hljs-variable">@ApiEncrypt</span>(algorithm = <span class="hljs-string">"AES-GCM"</span>, keyId = <span class="hljs-string">"pay_default_key"</span>)
    public PayResponseDTO <span class="hljs-built_in">submitPay</span>(<span class="hljs-variable">@RequestBody</span> PayRequestDTO request) {
        <span class="hljs-comment">// 业务逻辑：直接使用明文request，无需任何加密代码</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">payService</span><span class="hljs-selector-class">.submit</span>(request);
    }
}
</code></pre>
<h3 data-id="heading-14">四、通用组件的扩展与适配</h3>
<h4 data-id="heading-15">1. 适配其他框架/语言</h4>
<ul>
<li><strong>Go语言</strong>：将拦截器改为HTTP中间件（<code>http.HandlerFunc</code>），注解改为配置文件（如<code>crypto.yaml</code>指定接口规则），核心算法工厂/模板逻辑一致；</li>
<li><strong>Python</strong>：用Django/Flask的中间件（Middleware）替代拦截器，装饰器替代注解，核心逻辑封装为<code>crypto</code>模块；</li>
<li><strong>微服务场景</strong>：将组件封装为SDK，各服务引入SDK后仅需配置，无需重复开发。</li>
</ul>
<h4 data-id="heading-16">2. 扩展新算法</h4>
<p>只需实现<code>AlgorithmFactory.CryptoHandler</code>接口，无需修改核心代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 新增SM4算法（国密）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sm4Handler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AlgorithmFactory</span>.<span class="hljs-property">CryptoHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> byte[] <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">byte[] data, <span class="hljs-built_in">String</span> keyId</span>) {
        <span class="hljs-comment">// SM4加密逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> byte[<span class="hljs-number">0</span>];
    }
    <span class="hljs-comment">// 实现其他方法...</span>
}
</code></pre>
<h4 data-id="heading-17">3. 性能优化（组件内置）</h4>
<ul>
<li><strong>对象池</strong>：缓存Cipher、Signature等重量级对象，避免频繁创建；</li>
<li><strong>异步处理</strong>：加解密耗时较长时，用CompletableFuture异步处理；</li>
<li><strong>硬件加速</strong>：在AlgorithmFactory中自动开启AES-NI/SHA指令集；</li>
<li><strong>批量处理</strong>：支持批量接口的加解密，减少多次调用开销。</li>
</ul>
<h3 data-id="heading-18">五、生产环境落地注意事项</h3>
<ol start="6">
<li><strong>密钥管理</strong>：生产环境禁止本地配置密钥，必须对接KMS/HSM，KeyManager中封装KMS调用逻辑；</li>
<li><strong>异常处理</strong>：组件内置统一的加密异常（<code>CryptoException</code>），全局异常处理器捕获后返回标准化错误码；</li>
<li><strong>监控告警</strong>：埋点加解密耗时、失败率，超过阈值（如1ms）告警；</li>
<li><strong>兼容性</strong>：支持部分接口不加密（通过注解/配置排除），兼容老接口平滑迁移；</li>
<li><strong>测试</strong>：组件单独写单元测试（覆盖所有算法、异常场景），业务侧仅需测试业务逻辑。</li>
</ol>
<h3 data-id="heading-19">总结</h3>
<p>通用加解密组件的核心是「<strong>拦截器+模板方法+配置驱动</strong>」：</p>
<ul>
<li>业务侧：仅需加注解/配置，完全脱离加密细节；</li>
<li>组件侧：封装所有加密逻辑，算法/密钥/规则可配置、可扩展；</li>
<li>性能：组件内部做对象池、硬件加速等优化，对业务透明。</li>
</ul>
<p>按此方案实现后，新增需要加密的接口时，仅需：</p>
<ol start="11">
<li>在DTO的敏感字段加<code>@SensitiveField</code>；</li>
<li>在Controller方法加<code>@ApiEncrypt</code>；</li>
<li>在yml中配置密钥（如需）。</li>
</ol>
<p>完全解耦业务与加密逻辑，符合企业级「高内聚、低耦合」的设计规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能]]></title>    <link>https://juejin.cn/post/7582131164728737832</link>    <guid>https://juejin.cn/post/7582131164728737832</guid>    <pubDate>2025-12-11T04:13:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728737832" data-draft-id="7582200865907441698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-11T04:13:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子昕AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/3273679891602858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3273679891602858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子昕AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T04:13:20.000Z" title="Thu Dec 11 2025 04:13:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是子昕。</p>
<p>Claude Code昨天发了2.0.64版本，加了几个挺实用的功能。</p>
<p>我看完更新说明，第一反应是：这几个更新都挺懂使用痛点的。</p>
<h2 data-id="heading-0">核心要点</h2>
<ul>
<li><strong>异步子代理</strong>：subagent和bash命令能后台跑了，不用等一个任务完才能开下一个</li>
<li><strong>即时压缩</strong>：对话压缩从等半天变成秒压</li>
<li><strong>自定义会话名称</strong>：用<code>/rename</code>给会话起名字</li>
<li><strong>使用统计</strong>：<code>/stats</code>看你每天用了多少，哪个模型用得最多</li>
</ul>
<p>前两个改变最明显，后两个是体验补完。</p>
<h2 data-id="heading-1">异步子代理：可以在后台持续跑了</h2>
<p>这个更新的关键词是<code>异步</code>和<code>后台</code>。</p>
<p>以前subagent干活时，你得等它做完才能继续。现在可以让subagent在后台运行，更重要的是，<strong>它能持续运行，不受主任务影响</strong>。</p>
<p><strong>怎么用</strong>：在提示词里明确告诉Claude使用后台agent。比如官方示例：“Using a background agent can you poll this issue for comments every 10 seconds”，agent就会在后台每10秒检查一次。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99294f3324884de3bc5c181b72fea9a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=icfe1V7Fji%2BgF0983hkviIR3fqQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e7163d59ab0465991de25b7ea2dd8a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=cDMDf7Z9xZqusQAArGUvMMgnUuA%3D" alt="图片" loading="lazy"/></p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>让后台agent每隔一段时间监控错误日志，发现新错误立即通知</li>
<li>定期轮询某个API或文件的变化</li>
<li>监控测试运行状态，完成后汇报结果</li>
<li>长时间运行的任务（编译、部署）进度跟踪</li>
</ul>
<p>这个功能的价值在于：你可以继续做其他事，让agent在后台帮你盯着。不用人工反复检查。</p>
<p>关于subagent的更多用法和配置，可以看我之前写的文章。</p>
<h2 data-id="heading-2">即时压缩：终于不用干等了</h2>
<p>压缩功能之前就有，但体验很差，有时候要等2-5分钟。</p>
<p>这次更新后，几乎是秒完成。</p>
<p><strong>怎么用</strong>：还是老办法，输入<code>/compact</code>，但现在速度快得多。或者你什么都不做，系统也会在后台自动压缩摘要。</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>长对话到100+轮时，定期压一下</li>
<li>感觉响应变慢了，可能是context太长了</li>
<li>一个项目持续好几天，中间想清理一下对话</li>
</ul>
<p>不过提醒一句：别过度依赖压缩。最好的做法是在上下文快用完之前，自己整理好文档和关键信息，重新开个会话。压缩只是辅助手段。</p>
<h2 data-id="heading-3">自定义会话名称：找对话方便了</h2>
<p>很简单的功能，但挺实用。</p>
<p>输入<code>/rename 你想要的名字</code>，当前会话就改名了。在/resume界面还加了快捷键：按R改名，按P预览。</p>
<p>以前会话名称可能是系统自动生成的，不太好辨识。现在可以自己改成有意义的名字，找起来方便多了。</p>
<h2 data-id="heading-4">使用统计：心里有个数</h2>
<p>输入<code>/stats</code>会显示一个可视化界面，告诉你：</p>
<ul>
<li>每天用了多少次Claude Code</li>
<li>总共开了多少会话</li>
<li>连续使用多少天</li>
<li>最常用的模型是哪个</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0b9057ced14e89955d8ec3ca46c50c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=g7HgolWyCvHx0bhiWIS7LwJQgNs%3D" alt="Overview" loading="lazy"/></p>
<p>Overview</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa2533ef63e94ea68a41afcb1e590efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=D%2BwdNIUsbbpeWEYrp7GC9BP8kPs%3D" alt="Models" loading="lazy"/></p>
<p>Models</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>想知道自己用Claude Code的习惯</li>
<li>看看是不是过度依赖某个贵的模型</li>
<li>纯粹好奇自己的使用数据</li>
</ul>
<p>这个功能更多是“了解自己”，对日常开发影响不大，但看看数据挺有意思的。</p>
<h2 data-id="heading-5">简单说两句</h2>
<p>这几个更新都不算大功能，但都是在解决实际使用中的痛点：</p>
<p>异步让效率提升是实打实的，特别是需要多任务协作的场景。压缩速度提升也是，之前那个慢速度真的让人不想用。至于改名和统计，算是锦上添花，有比没有好。</p>
<p>如果你在用Claude Code，运行<code>claude update</code>就能更新到最新版。</p>
<p>更多内容，欢迎关注微信公众号「子昕AI编程」</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析]]></title>    <link>https://juejin.cn/post/7582149417769304114</link>    <guid>https://juejin.cn/post/7582149417769304114</guid>    <pubDate>2025-12-11T07:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582149417769304114" data-draft-id="7582182817108082714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-11T07:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T07:23:07.000Z" title="Thu Dec 11 2025 07:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Node.js 的核心能力之一就是快速创建高性能的服务器。通过内置的 <code>http</code> 和 <code>https</code> 模块，你可以在几行代码内搭建功能完善的 Web 服务。本文将系统讲解如何在 Node.js 中创建 HTTP 与 HTTPS 服务器，包括基础用法、请求处理、HTTPS 证书配置，以及性能与安全优化实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Node.js HTTP 服务器基础</h2>
<p>Node.js 内置的 <code>http</code> 模块让创建 HTTP 服务器非常简单。</p>
<h3 data-id="heading-1">1. 基本示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain"</span>);
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTP Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server running at http://localhost:3000/"</span>);
});
</code></pre>
<p>说明：</p>
<ul>
<li><code>http.createServer</code> 返回一个服务器实例</li>
<li>回调函数 <code>(req, res)</code> 在每次请求到来时触发</li>
<li><code>req</code> 包含请求信息，<code>res</code> 用于发送响应</li>
<li><code>server.listen</code> 绑定端口并启动服务器</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、处理请求与响应</h2>
<p>HTTP 请求包含方法、URL、头信息和请求体。响应也可以设置状态码、头信息及数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"GET"</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">"/"</span>) {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"&lt;h1&gt;Welcome Home&lt;/h1&gt;"</span>);
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Page Not Found"</span>);
  }
});
</code></pre>
<p>技巧与建议：</p>
<ul>
<li>对请求进行路由判断，区分不同路径和方法</li>
<li>响应头要根据内容类型设置</li>
<li>大型项目可使用第三方框架如 Express 做路由和中间件管理</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、Node.js HTTPS 服务器</h2>
<p>在实际生产环境中，HTTPS 已经是必须。Node.js 提供 <code>https</code> 模块支持加密传输。</p>
<h3 data-id="heading-4">1. 准备证书</h3>
<p>创建 HTTPS 服务器前，需要拥有：</p>
<ul>
<li><code>key.pem</code>：私钥文件</li>
<li><code>cert.pem</code>：证书文件（可以用自签名证书做测试）</li>
</ul>
<p>可以使用 OpenSSL 生成测试证书：</p>
<pre><code class="hljs language-bash" lang="bash">openssl req -nodes -new -x509 -keyout key.pem -out cert.pem
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 创建 HTTPS 服务器</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">key</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"key.pem"</span>),
  <span class="hljs-attr">cert</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"cert.pem"</span>)
};

<span class="hljs-keyword">const</span> server = https.<span class="hljs-title function_">createServer</span>(options, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTPS Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3443</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HTTPS Server running at https://localhost:3443/"</span>);
});
</code></pre>
<p>注意事项：</p>
<ul>
<li>HTTPS 必须提供证书和私钥</li>
<li>在生产环境中，请使用由可信 CA 签发的证书</li>
<li>端口一般为 443（HTTP 默认端口为 80）</li>
</ul>
<hr/>
<h2 data-id="heading-6">四、性能优化建议</h2>
<p>虽然 Node.js 的 <code>http</code> 和 <code>https</code> 模块足够轻量，但在高并发场景下，仍然可以优化：</p>
<ol>
<li><strong>开启 Keep-Alive</strong>
保持 TCP 连接，减少握手开销：</li>
</ol>
<pre><code class="hljs language-js" lang="js">res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
</code></pre>
<ol start="2">
<li><strong>使用 gzip 压缩</strong>
减少传输数据量，提高响应速度：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">"zlib"</span>);
res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Encoding"</span>: <span class="hljs-string">"gzip"</span> });
res.<span class="hljs-title function_">end</span>(zlib.<span class="hljs-title function_">gzipSync</span>(<span class="hljs-string">"Hello World!"</span>));
</code></pre>
<ol start="3">
<li><strong>利用集群（cluster）提升 CPU 利用率</strong>
Node.js 单线程模型可以通过 cluster 模块启动多进程：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cluster"</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);

<span class="hljs-keyword">if</span> (cluster.<span class="hljs-property">isMaster</span>) {
  <span class="hljs-keyword">const</span> cpuCount = os.<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cpuCount; i++) {
    cluster.<span class="hljs-title function_">fork</span>();
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// worker 进程启动 HTTP/HTTPS 服务器</span>
}
</code></pre>
<ol start="4">
<li><strong>使用缓存</strong>
对静态文件或接口数据使用内存缓存或 CDN，降低重复计算和 I/O 压力。</li>
</ol>
<hr/>
<h2 data-id="heading-7">五、常见应用场景</h2>
<ul>
<li>搭建静态文件服务器</li>
<li>提供 RESTful API 服务</li>
<li>接入 WebSocket 做实时通信</li>
<li>内网工具或微服务</li>
<li>HTTPS 接入支付、认证等安全场景</li>
</ul>
<p>Node.js 的 HTTP/HTTPS 服务器能力非常适合高并发和轻量服务场景。</p>
<hr/>
<h2 data-id="heading-8">六、总结</h2>
<p>通过本文，你应该掌握了：</p>
<ol>
<li>HTTP 服务器的创建与请求处理</li>
<li>HTTPS 服务器的证书配置和创建</li>
<li>异步请求处理与响应机制</li>
<li>高性能与安全优化策略</li>
</ol>
<p>Node.js 内置的 HTTP/HTTPS 模块简单高效，非常适合构建高性能微服务和 API。
理解这些基础，为使用 Express、Koa 等框架打下了坚实的底层基础。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# Params Collections 详解：比 params T[] 更强大的新语法]]></title>    <link>https://juejin.cn/post/7582090790181879846</link>    <guid>https://juejin.cn/post/7582090790181879846</guid>    <pubDate>2025-12-11T00:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790181879846" data-draft-id="7582041304655413294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# Params Collections 详解：比 params T[] 更强大的新语法"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-11T00:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# Params Collections 详解：比 params T[] 更强大的新语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:10:11.000Z" title="Thu Dec 11 2025 00:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Params Collections</code> 是 <code>C# 12</code> 中引入的新特性，它扩展了传统的 <code>params</code> 关键字功能，使其不仅支持数组，还能支持各种集合类型。这个特性使得方法能够接受可变数量的参数，并且这些参数可以自动转换为指定的集合类型。</p>
<p>关键特点：</p>
<ul>
<li>
<p>可变参数：调用者可以传递任意数量的参数（包括零个）。</p>
</li>
<li>
<p>类型安全：<code>params</code> 参数是强类型的，编译器确保参数类型匹配。</p>
</li>
<li>
<p>单一 <code>params</code> 参数：一个方法只能有一个 <code>params</code> 参数，且必须是最后一个参数。</p>
</li>
<li>
<p><code>C# 12</code> 扩展：支持非数组集合类型（如 <code>List</code>, <code>Span</code>），适合高性能或特定场景。</p>
</li>
</ul>
<h3 data-id="heading-1">核心特性</h3>
<h4 data-id="heading-2">支持任意集合类型</h4>
<ul>
<li>可指定 <code>List、Span、IReadOnlyCollection</code> 等作为参数类型</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LogEntries</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List messages</span>)</span> { ... }
</code></pre>
<h4 data-id="heading-3">自动集合构造</h4>
<ul>
<li>编译器自动将离散参数转换为目标集合类型实例</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">AnalyzeNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>); 
<span class="hljs-comment">// 等效于：</span>
AnalyzeNumbers(<span class="hljs-keyword">new</span> List { <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span> });
</code></pre>
<h4 data-id="heading-4">与现有 params 兼容</h4>
<ul>
<li>
<p>传统 <code>params T[]</code> 仍然有效</p>
</li>
<li>
<p>新语法不会破坏已有代码</p>
</li>
</ul>
<h3 data-id="heading-5">传统 params 关键字</h3>
<p>在 <code>C# 12</code> 之前，<code>params</code> 关键字只能用于数组：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统的 params 数组用法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-6">Params Collections 的新特性</h3>
<p><code>C# 12</code> 扩展了 <code>params</code> 关键字，使其能够用于任何集合类型，只要该类型满足特定条件。</p>
<h4 data-id="heading-7">基本语法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 params 与集合类型</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式不变</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-8">支持的条件</h3>
<p>要使集合类型能够与 <code>params</code> 关键字一起使用，必须满足以下条件之一：</p>
<ul>
<li>
<p>集合类型必须有一个无参数的构造函数</p>
</li>
<li>
<p>集合类型必须有一个 <code>Add</code> 方法，用于添加元素</p>
</li>
<li>
<p>集合类型必须实现 <code>IEnumerable</code></p>
</li>
</ul>
<h4 data-id="heading-9">自定义集合与 params</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义集合类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberCollection</span> : <span class="hljs-title">IEnumerable</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List _numbers = <span class="hljs-keyword">new</span>();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> number</span>)</span> =&gt; _numbers.Add(number);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">GetEnumerator</span>()</span> =&gt; _numbers.GetEnumerator();
    
    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}

<span class="hljs-comment">// 使用自定义集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> NumberCollection numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-10">实际应用示例</h3>
<h4 data-id="heading-11">与 Span 和 ReadOnlySpan 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 Span 作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessData</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span data</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Length; i++)
    {
        data[i] *= <span class="hljs-number">2</span>;
    }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-built_in">int</span>[] array = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
ProcessData(array);
Console.WriteLine(<span class="hljs-built_in">string</span>.Join(&amp;<span class="hljs-meta">#34;, &amp;#34;, array)); // 输出: 2, 4, 6, 8, 10</span>
</code></pre>
<h4 data-id="heading-12">与 Immutable Collections 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Collections.Immutable;

<span class="hljs-comment">// 使用不可变集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessItems</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> ImmutableArray items</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessItems(&amp;<span class="hljs-meta">#34;apple&amp;#34;, &amp;#34;banana&amp;#34;, &amp;#34;cherry&amp;#34;);</span>
</code></pre>
<h3 data-id="heading-13">高级用法</h3>
<h4 data-id="heading-14">泛型方法与 params 集合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型方法中使用 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessCollection</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List collection</span>)
    <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">notnull</span></span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> collection)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessCollection(&amp;<span class="hljs-meta">#34;a&amp;#34;, &amp;#34;b&amp;#34;, &amp;#34;c&amp;#34;); // 字符串列表</span>
ProcessCollection(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);       <span class="hljs-comment">// 整数列表</span>
</code></pre>
<h4 data-id="heading-15">与模式匹配结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用模式匹配处理 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleValues</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] values</span>)</span>
{
    <span class="hljs-keyword">switch</span> (values)
    {
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> first, .. <span class="hljs-keyword">var</span> middle, <span class="hljs-keyword">var</span> last]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;首: {first}, 尾: {last}, 中间有 {middle.Length} 个元素&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> single]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;单个值: {single}&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> []:
            Console.WriteLine(&amp;<span class="hljs-meta">#34;空集合&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 调用</span>
HandleValues(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 输出: 首: 1, 尾: 5, 中间有 3 个元素</span>
HandleValues(<span class="hljs-number">42</span>);            <span class="hljs-comment">// 输出: 单个值: 42</span>
HandleValues();              <span class="hljs-comment">// 输出: 空集合</span>
</code></pre>
<h4 data-id="heading-16">与接口结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用接口作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessEnumerables</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> IEnumerable[] collections</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> collection <span class="hljs-keyword">in</span> collections)
    {
        <span class="hljs-built_in">int</span> sum = collection.Sum();
        Console.WriteLine($&amp;<span class="hljs-meta">#34;集合总和: {sum}&amp;#34;);</span>
    }
}

<span class="hljs-comment">// 调用</span>
ProcessEnumerables(
    <span class="hljs-keyword">new</span> List { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> },
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> },
    <span class="hljs-keyword">new</span> HashSet { <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span> }
);
</code></pre>
<h4 data-id="heading-17">高性能求和（使用 <code>Span</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span> <span class="hljs-title">Average</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span numbers</span>)</span>
{
    <span class="hljs-keyword">if</span> (numbers.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-built_in">decimal</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> num <span class="hljs-keyword">in</span> numbers)
    {
        sum += num;
    }
    <span class="hljs-keyword">return</span> sum / numbers.Length;
}

Console.WriteLine(Average(<span class="hljs-number">1.5</span>m, <span class="hljs-number">2.5</span>m, <span class="hljs-number">3.5</span>m)); <span class="hljs-comment">// 输出: 2.5</span>
</code></pre>
<ul>
<li>
<p>使用 <code>Span</code> 避免数组分配，提高性能。</p>
</li>
<li>
<p>适合处理大量数值计算。</p>
</li>
</ul>
<h3 data-id="heading-18">适用场景</h3>
<ul>
<li>
<p>简化方法调用：允许调用者传递任意数量的参数，减少重载需求。</p>
</li>
<li>
<p>处理集合数据：适合处理列表、数组或序列，例如日志记录、字符串连接、数学计算。</p>
</li>
<li>
<p>高性能场景（<code>C# 12+</code>）：使用 <code>Span</code> 或 <code>ReadOnlySpan</code> 减少堆分配，优化性能。</p>
</li>
<li>
<p>与本机代码交互：<code>Span</code> 类型的 <code>params</code> 参数适合传递连续内存块。</p>
</li>
<li>
<p>灵活接口设计：为方法提供通用接口，支持不同数量的输入。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose 高级状态和附带效应]]></title>    <link>https://juejin.cn/post/7582231988146782259</link>    <guid>https://juejin.cn/post/7582231988146782259</guid>    <pubDate>2025-12-11T09:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582231988146782259" data-draft-id="7581648776302690313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose 高级状态和附带效应"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-11T09:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose 高级状态和附带效应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T09:00:47.000Z" title="Thu Dec 11 2025 09:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects%3Fhl%3Dzh-cn%26continue%3Dhttps%253A%252F%252Fdeveloper.android.com%252Fcourses%252Fpathways%252Fjetpack-compose-for-android-developers-3%253Fhl%253Dzh-cn%2523codelab-https%253A%252F%252Fdeveloper.android.com%252Fcodelabs%252Fjetpack-compose-advanced-state-side-effects%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-advanced-state-side-effects?hl=zh-cn&amp;continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fjetpack-compose-for-android-developers-3%3Fhl%3Dzh-cn%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects#0" ref="nofollow noopener noreferrer">Jetpack Compose 中的高级状态和附带效应</a></p>
<p>了解与 Jetpack Compose 中的状态和附带效应 API 相关的高级概念。了解如何为复杂的有状态可组合项创建状态容器、通过 Compose 代码创建协程和调用挂起函数，以及针对不同的用例触发附带效应。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p>在此 Codelab 中，您将学习与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Compose</a> 中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fside-effects%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/side-effects?hl=zh-cn" ref="nofollow noopener noreferrer">附带效应</a> API 相关的高级概念。您将了解如何为逻辑并不简单的有状态可组合项创建状态容器，如何从 Compose 代码创建协程并调用挂起函数，以及如何触发附带效应以完成不同的用例。</p>
<h3 data-id="heading-1">学习内容</h3>
<ul>
<li>如何从 Compose 代码观察数据流以更新界面。</li>
<li>如何为有状态可组合项创建状态容器。</li>
<li>附带效应 API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>。</li>
<li>如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API 在可组合项中创建协程并调用挂起函数。</li>
</ul>
<h3 data-id="heading-2">构建内容</h3>
<p>在此 Codelab 中，您将从一个未完成的应用（即 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaterial.io%2Fdesign%2Fmaterial-studies%2Fcrane.html" target="_blank" title="https://material.io/design/material-studies/crane.html" ref="nofollow noopener noreferrer">Crane 材料研究</a>应用）着手，并且将添加一些功能来改进该应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/218536e9496a435fb0681a2146737071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=kqIGHfyp0F6%2F%2F%2FJJ5fFJJuqCOMM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">2. 准备工作</h2>
<h3 data-id="heading-4">获取代码</h3>
<p>此 Codelab 的代码可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgooglecodelabs%2Fandroid-compose-codelabs" target="_blank" title="https://github.com/googlecodelabs/android-compose-codelabs" ref="nofollow noopener noreferrer">android-compose-codelabs GitHub 代码库</a>中找到。如需克隆该代码库，请运行以下命令：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">git <span class="hljs-built_in">clone</span> https://github.com/android/codelab-android-compose</span>
</code></pre>
<p>或者，您也能以 Zip 文件的形式下载该代码库：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fmain.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/main.zip" ref="nofollow noopener noreferrer">file_download下载 ZIP 文件</a></p>
<h3 data-id="heading-5">查看示例应用</h3>
<p>您刚刚下载的代码包含提供的所有 Compose Codelab 的代码。为了完成此 Codelab，请在 Android Studio 中打开 <strong><code>AdvancedStateAndSideEffectsCodelab</code></strong> 项目。</p>
<blockquote>
<p>compose-codelabs 库包含开发者在线课程中所有 Codelab 的起始代码。</p>
<p>对于此 Codelab，请使用 <strong>AdvancedStateAndSideEffectsCodelab</strong> 项目。</p>
<ul>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6403907abaa41fab678e0688b3684a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=hEMriE4dN0WgBVdsYRGV959b%2FMs%3D" alt="android_studio_folder.png" loading="lazy"/> <strong>AdvancedStateAndSideEffectsCodelab</strong> - 该项目包含此 Codelab 的起始代码和完成后的代码。</li>
</ul>
<p>该项目在多个 git 分支中构建而成：</p>
<ul>
<li><strong>main</strong> - 该项目的起始代码；您将更改这些代码来完成此 Codelab。</li>
<li><strong>end</strong> - 包含此 Codelab 的解决方案。</li>
</ul>
</blockquote>
<p>我们建议您从 main 分支中的代码着手，按照自己的节奏逐步完成此 Codelab。</p>
<p>在本 Codelab 中，系统会为您显示需要添加到项目的代码段。在某些地方，您还需要移除在代码段的注释中明确提及的代码。</p>
<h3 data-id="heading-6">熟悉代码并运行示例应用</h3>
<p>先花点时间浏览一下项目结构，然后再运行应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0938746571fd46028bd2fbae0acdd71d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=wajQEIjQPPLXYQhdH224t6h55Ks%3D" alt="162c42b19dafa701.png" loading="lazy"/></p>
<p>从 main 分支运行应用时，您会看到某些功能（如抽屉式导航栏或加载航班目的地的功能）不起作用！这就是您在此 Codelab 的后续步骤中要改进的地方。</p>
<h3 data-id="heading-7">界面测试</h3>
<p>系统会对应用执行 <code>androidTest</code> 文件夹中提供的非常基本的界面测试。对于 <code>main</code> 和 <code>end</code> 分支，始终都应通过这些测试。</p>
<h3 data-id="heading-8">[可选] 在详情屏幕上显示地图</h3>
<p>完全没有必要按照相关说明在详情屏幕上显示城市地图。不过，如果您想要看到地图，那么需要获取个人 API 密钥，如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fget-api-key%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/get-api-key?hl=zh-cn" ref="nofollow noopener noreferrer">“地图”文档</a>中所述。按如下方式在 <code>local.properties</code> 文件中添加该密钥：</p>
<pre><code class="hljs language-ini" lang="ini">// local.properties file
<span class="hljs-attr">google.maps.key</span>={insert_your_api_key_here}
</code></pre>
<blockquote>
<p>在 Google 信息中心内设置凭据时，务必将 <code>androidx.compose.samples.crane</code> 用作软件包名称，并将 <code>A0:BD:B3:B6:F0:C4:BE:90:C6:9D:5F:4C:1D:F0:90:80:7F:D7:FE:1F</code> 用作 SHA-1 证书指纹。</p>
</blockquote>
<h3 data-id="heading-9">此 Codelab 的解决方案</h3>
<p>如需使用 git 获取 <code>end</code> 分支，请使用以下命令：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>git clone -b <span class="hljs-keyword">end</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/android</span><span class="hljs-regexp">/codelab-android-compose
</span></code></pre>
<p>或者，您也可以在此处下载解决方案代码：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fend.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/end.zip" ref="nofollow noopener noreferrer">file_download下载最终代码</a></p>
<h2 data-id="heading-10">3. 界面状态生成流水线</h2>
<p>您可能已经注意到，从 <code>main</code> 分支运行应用时，航班目的地列表为空！</p>
<p>如要解决此问题，您必须完成以下两个步骤：</p>
<ul>
<li>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Flibraries%2Farchitecture%2Fviewmodel%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=zh-cn" ref="nofollow noopener noreferrer"><code>ViewModel</code></a> 中添加逻辑以生成<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstateholders%3Fhl%3Dzh-cn%23elements-ui" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/stateholders?hl=zh-cn#elements-ui" ref="nofollow noopener noreferrer">界面状态</a>。在本示例中，即推荐目的地列表。</li>
<li>从界面取用该界面状态，这样就会在画面上显示界面。</li>
</ul>
<p>良好的应用架构会分层级，遵循基本的良好系统设计实践，例如关注点分离和可测试性。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn" ref="nofollow noopener noreferrer">界面状态生成</a>是指以下过程：应用访问数据层、应用业务规则（如果需要），以及公开要从界面取用的界面状态。</p>
<p>此应用中的数据层已实现。现在，您将生成状态（推荐目的地列表），以便界面可以取用该状态。</p>
<p>有几个 API 可用于生成界面状态。如要了解替代方案，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn%23output-types" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn#output-types" ref="nofollow noopener noreferrer">状态生成流水线中的输出类型</a>文档。一般而言，最好使用 Kotlin 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/" ref="nofollow noopener noreferrer"><code>StateFlow</code></a> 生成界面状态。</p>
<p>如要生成界面状态，请按以下步骤操作：</p>
<ol>
<li>打开 <code>home/MainViewModel.kt</code>。</li>
<li>定义一个类型为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-mutable-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-mutable-state-flow/" ref="nofollow noopener noreferrer"><code>MutableStateFlow</code></a> 的私有 <code>_suggestedDestinations</code> 变量，用于表示推荐目的地列表，并将空列表设置为起始值。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())
</code></pre>
<ol start="3">
<li>定义第二个不可变变量 <code>suggestedDestinations</code>，类型为 <code>StateFlow</code>。这是可从界面取用的公开只读变量。建议您公开只读变量，并在内部使用可变变量。这样做可确保界面状态无法修改，除非通过 <code>ViewModel</code> 使其成为单一可信来源。扩展函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2Fas-state-flow.html" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/as-state-flow.html" ref="nofollow noopener noreferrer"><code>asStateFlow</code></a> 会将可变流转换为不可变流。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()
</code></pre>
<ol start="4">
<li>在 <code>ViewModel</code> 的 init 块中，添加来自 <code>destinationsRepository</code> 的调用，以便从数据层获取目的地。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()

<span class="hljs-keyword">init</span> {
    _suggestedDestinations.value = destinationsRepository.destinations
}
</code></pre>
<ol start="5">
<li>最后，取消注释在此类中找到的内部变量 <code>_suggestedDestinations</code> 使用情况，以便可通过来自界面的事件正确更新该变量。</li>
</ol>
<p>现在，<code>ViewModel</code> 能够生成界面状态。在下一步中，您将从界面取用此状态。</p>
<h2 data-id="heading-11">4. 从 ViewModel 安全地使用流</h2>
<p>航班目的地列表仍然为空。在上一步中，您在 <code>MainViewModel</code> 中生成了界面状态。现在，您将使用要在界面中显示并由 <code>MainViewModel</code> 公开的界面状态。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件并查看 <code>CraneHomeContent</code> 可组合项。</p>
<p>被分配给一个记住的空列表的 <code>suggestedDestinations</code> 的定义上面有一条 TODO 注释。这就是屏幕上显示的内容：一个空列表！在此步骤中，您将解决该问题，并显示 <code>MainViewModel</code> 公开的推荐目的地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fa34cb764894f04ba0583dc19732ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=C9umu%2BSd9r5UJA%2FzEi%2FkfXYu8z8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>home/MainViewModel.kt</code> 并查看 <code>suggestedDestinations</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%2Fstateflow-and-sharedflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow/stateflow-and-sharedflow?hl=zh-cn" ref="nofollow noopener noreferrer">StateFlow</a>，该 StateFlow 初始化为 <code>destinationsRepository.destinations</code>，并且会在调用 <code>updatePeople</code> 或 <code>toDestinationChanged</code> 函数时得到更新。</p>
<p>您希望每当有新项被发送到 <code>suggestedDestinations</code> 数据流时 <code>CraneHomeContent</code> 可组合项中的界面都会更新。您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Flifecycle%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any%2Candroidx.lifecycle.Lifecycle%2Candroidx.lifecycle.Lifecycle.State%2Ckotlin.coroutines.CoroutineContext)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/lifecycle/compose/package-summary?hl=zh-cn#(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any,androidx.lifecycle.Lifecycle,androidx.lifecycle.Lifecycle.State,kotlin.coroutines.CoroutineContext)" ref="nofollow noopener noreferrer"><code>collectAsStateWithLifecycle()</code></a> 函数。<code>collectAsStateWithLifecycle()</code> 会以生命周期感知型方式从 <code>StateFlow</code> 收集值并通过 Compose 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">State</a> API 表示最新值。这样会使读取该状态值的 Compose 代码在发出新项时重组。</p>
<p>如需开始使用 <code>collectAsStateWithLifecycle</code> API，请先在 <code>app/build.gradle</code> 中添加以下<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">依赖项</a>。变量 <code>lifecycle_version</code> 已在项目中使用适当版本进行定义。</p>
<pre><code class="hljs language-bash" lang="bash">dependencies {
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-runtime-compose:<span class="hljs-variable">$lifecycle_version</span>"</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>collectAsStateWithLifecycle()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fconsuming-flows-safely-in-jetpack-compose-cde014d0d5a3" target="_blank" title="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3" ref="nofollow noopener noreferrer">在 Jetpack Compose 中安全地使用流</a>这篇博文。</p>
</blockquote>
<p>返回 <code>CraneHomeContent</code> 可组合项，并将分配 <code>suggestedDestinations</code> 的代码行替换为 <code>ViewModel</code> 的 <code>suggestedDestinations</code> 属性上的 <code>collectAsStateWithLifecycle</code> 调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.lifecycle.compose.collectAsStateWithLifecycle

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHomeContent</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    openDrawer: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">MainViewModel</span> = viewModel()</span></span>,
) {
    <span class="hljs-keyword">val</span> suggestedDestinations <span class="hljs-keyword">by</span> viewModel.suggestedDestinations.collectAsStateWithLifecycle()
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果您运行应用，您会看到目的地列表已填充，并且每当您点按旅行人数时，目的地都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215aaf4ff0dd4b2192a1bfd293b9768c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=7hq7zWN3WNYFxtSo0dQktRTKMfs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Compose 还为最热门的基于数据流的 Android 解决方案提供了 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Flivedata%2Fpackage-summary%3Fhl%3Dzh-cn%23observeAsState(androidx.lifecycle.LiveData)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/livedata/package-summary?hl=zh-cn#observeAsState(androidx.lifecycle.LiveData)" ref="nofollow noopener noreferrer"><code>LiveData.observeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-livedata:$composeVersion</code> 工件中。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Frxjava2%2Fpackage-summary%3Fhl%3Dzh-cn%23subscribeAsState(io.reactivex.Observable%2Ckotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/rxjava2/package-summary?hl=zh-cn#subscribeAsState(io.reactivex.Observable,kotlin.Any)" ref="nofollow noopener noreferrer"><code>Observable.subscribeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-rxjava2:$composeVersion</code> 或 <code>androidx.compose.runtime:runtime-rxjava3:$composeVersion</code> 工件中。</li>
</ul>
<p>如需了解详情，请参阅“状态”文档中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23use-other-types-of-state-in-jetpack-compose" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#use-other-types-of-state-in-jetpack-compose" ref="nofollow noopener noreferrer">其他受支持的状态类型</a>页面。</p>
</blockquote>
<h2 data-id="heading-12">5. LaunchedEffect 和 rememberUpdatedState</h2>
<p>在该项目中，有一个目前未使用的 <code>home/LandingScreen.kt</code> 文件。您想要向应用添加一个着陆屏幕，它有可能会用于在后台加载需要的所有数据。</p>
<p>着陆屏幕将占据整个屏幕，并在屏幕中间显示应用的徽标。理想情况下，您会显示该屏幕，在所有数据加载完毕之后，您会通知调用方可以使用 <code>onTimeout</code> 回调关闭着陆屏幕。</p>
<p>建议使用 Kotlin 协程在 Android 中执行异步操作。应用在启动时通常会使用协程在后台加载内容。Jetpack Compose 提供了可让您在界面层中安全使用协程的 API。由于此应用不与后端进行通信，因此您将使用协程的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlin.github.io%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines%2Fdelay.html" target="_blank" title="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/delay.html" ref="nofollow noopener noreferrer"><code>delay</code></a> 函数来模拟在后台加载内容。</p>
<blockquote>
<p><strong>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。</strong> 例如，当用户点按一个按钮时打开一个新屏幕，或者在应用未连接到互联网时显示一条消息。</p>
</blockquote>
<p>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。将状态更改为显示/隐藏着陆屏幕的操作将发生在 <code>onTimeout</code> 回调中，由于在调用 <code>onTimeout</code> 之前您需要先使用协程加载内容，因此状态变化必须发生在协程的上下文中！</p>
<p>如需从可组合项内安全地调用挂起函数，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a> API，该 API 会在 Compose 中触发协程作用域限定的附带效应。</p>
<p>当 <code>LaunchedEffect</code> 进入组合时，它会启动一个协程，并将代码块作为参数传递。如果 <code>LaunchedEffect</code> 退出组合，协程将取消。</p>
<p>虽然接下来的代码不正确，但让我们看看如何使用此 API，并探讨为什么下面的代码是错误的。您将在此步骤的后面调用 <code>LandingScreen</code> 可组合项。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// Start a side effect to load things in the background</span>
        <span class="hljs-comment">// and call onTimeout() when finished.</span>
        <span class="hljs-comment">// Passing onTimeout as a parameter to LaunchedEffect</span>
        <span class="hljs-comment">// is wrong! Don't do this. We'll improve this code in a sec.</span>
        LaunchedEffect(onTimeout) {
            delay(SplashWaitTime) <span class="hljs-comment">// Simulates loading things</span>
            onTimeout()
        }
        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>某些附带效应 API（如 <code>LaunchedEffect</code>）将可变数量的键作为形参，用于在其中一个键发生更改时<strong>重新开始</strong>执行效应。您发现错误了吗？我们不希望在此可组合函数的调用方传递不同的 <code>onTimeout</code> lambda 值时重启 <code>LaunchedEffect</code>。这会让 <code>delay</code> 再次启动，使得您无法满足相关要求。</p>
<p>接下来，让我们解决这个问题。如需在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">此可组合项的生命周期</a>内仅触发一次附带效应，请将常量用作键，例如 <code>LaunchedEffect(Unit) { ... }</code>。不过，现在又有一个问题。</p>
<p>如果 <code>onTimeout</code> 在附带效应正在进行时发生变化，效应结束时不一定会调用最后一个 <code>onTimeout</code>。如需保证调用最后一个 <code>onTimeout</code>，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a> API 记住 <code>onTimeout</code>。此 API 会捕获并更新最新值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// This will always refer to the latest onTimeout function that</span>
        <span class="hljs-comment">// LandingScreen was recomposed with</span>
        <span class="hljs-keyword">val</span> currentOnTimeout <span class="hljs-keyword">by</span> rememberUpdatedState(onTimeout)

        <span class="hljs-comment">// Create an effect that matches the lifecycle of LandingScreen.</span>
        <span class="hljs-comment">// If LandingScreen recomposes or onTimeout changes, </span>
        <span class="hljs-comment">// the delay shouldn't start again.</span>
        LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
            delay(SplashWaitTime)
            currentOnTimeout()
        }

        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>当长期存在的 lambda 或对象表达式引用在组合期间计算的参数或值时，您应使用 <code>rememberUpdatedState</code>，这在使用 <code>LaunchedEffect</code> 时可能很常见。</p>
<h3 data-id="heading-13">显示着陆屏幕</h3>
<p>现在，您需要在应用打开后显示着陆屏幕。打开 <code>home/MainActivity.kt</code> 文件，并查看首次调用的 <code>MainScreen</code> 可组合项。</p>
<p>在 <code>MainScreen</code> 可组合项中，您只需添加一种内部状态，用来跟踪是否应显示着陆屏幕：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/MainActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainScreen</span><span class="hljs-params">(onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>)</span></span> {
    Surface(color = MaterialTheme.colors.primary) {
        <span class="hljs-keyword">var</span> showLandingScreen <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
        <span class="hljs-keyword">if</span> (showLandingScreen) {
            LandingScreen(onTimeout = { showLandingScreen = <span class="hljs-literal">false</span> })
        } <span class="hljs-keyword">else</span> {
            CraneHome(onExploreItemClicked = onExploreItemClicked)
        }
    }
}
</code></pre>
<p>如果您现在运行应用，您应该会看到 <code>LandingScreen</code> 出现并在 2 秒后消失。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9911e5fd229b4bcb8e972604a49eb90f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=DI%2Fgq2wjmkvxjnyBEqzMVFTaKKI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">6. rememberCoroutineScope</h2>
<p>在此步骤中，您将使抽屉式导航栏正常工作。目前，如果您尝试点按汉堡式菜单，什么都不会发生。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件，并查看 <code>CraneHome</code> 可组合项，看看您需要在何处打开抽屉式导航栏：在 <code>openDrawer</code> 回调中！</p>
<p>在 <code>CraneHome</code> 中，有一个包含 <code>DrawerState</code> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FScaffoldState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/ScaffoldState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>scaffoldState</code></a>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FDrawerState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/DrawerState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>DrawerState</code></a> 具有以程序化方式打开和关闭抽屉式导航栏的方法。不过，如果您尝试在 <code>openDrawer</code> 回调中编写 <code>scaffoldState.drawerState.open()</code>，您会收到一条错误消息！这是因为，<code>open</code> 函数是一个<strong>挂起</strong>函数。我们再次进入协程的领域。</p>
<p>除了可让您从界面层安全调用协程的 API 之外，某些 Compose API 是挂起函数。用于打开抽屉式导航栏的 API 就是一个这样的例子。挂起函数除了能够运行异步代码之外，还可以帮助表示随着时间的推移出现的概念。打开抽屉式导航栏需要花些时间、进行移动，而且还有可能需要显示动画，这可以通过挂起函数完美地反映出来，挂起函数将在被调用的地方暂停协程的执行，直到它完成，然后再继续执行。</p>
<p>必须在协程中调用 <code>scaffoldState.drawerState.open()</code>。您可采取的行动 <code>openDrawer</code> 是一个简单的回调函数，因此：</p>
<ul>
<li>您不能简单地在其中调用挂起函数，因为 <code>openDrawer</code> 不在协程的上下文中执行。</li>
<li>您不能像之前一样使用 <code>LaunchedEffect</code>，因为不能在 <code>openDrawer</code> 中调用可组合项。我们不在组合中。</li>
</ul>
<p>您希望启动一个协程；应使用哪个作用域呢？理想情况下，您希望 <code>CoroutineScope</code> 能够遵循其调用点的生命周期。如果使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API，则会返回一个 <code>CoroutineScope</code>，该 CoroutineScope 会绑定到它在组合中的调用点。一旦退出组合，作用域将自动取消。有了这个作用域，即使您不在组合中（例如，在 <code>openDrawer</code> 回调中），也可以启动协程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/CraneHome.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHome</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
)</span></span> {
    <span class="hljs-keyword">val</span> scaffoldState = rememberScaffoldState()
    Scaffold(
        scaffoldState = scaffoldState,
        modifier = Modifier.statusBarsPadding(),
        drawerContent = {
            CraneDrawer()
        }
    ) {
        <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
        CraneHomeContent(
            modifier = modifier,
            onExploreItemClicked = onExploreItemClicked,
            openDrawer = {
                scope.launch {
                    scaffoldState.drawerState.<span class="hljs-keyword">open</span>()
                }
            }
        )
    }
}
</code></pre>
<p>如果您运行应用，您会看到当您点按汉堡式菜单图标时，系统会打开抽屉式导航栏。</p>
<h3 data-id="heading-15">LaunchedEffect 与 rememberCoroutineScope</h3>
<p>在这种情况下无法使用 <code>LaunchedEffect</code>，因为您需要触发调用以在组合之外的常规回调中创建协程。</p>
<p>回顾一下使用 <code>LaunchedEffect</code> 的着陆屏幕步骤，您可以使用 <code>rememberCoroutineScope</code> 并调用 <code>scope.launch { delay(); onTimeout(); }</code> 而不使用 <code>LaunchedEffect</code> 吗？</p>
<p>您本来可以这样做，而且似乎可行，但这样并不正确。如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23any-order" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#any-order" ref="nofollow noopener noreferrer">“Compose 编程思想”文档</a>中所述，Compose 可以随时调用可组合项。<code>LaunchedEffect</code> 可以保证当对该可组合项的调用使其进入组合时将会执行附带效应。如果您在 <code>LandingScreen</code> 的主体中使用 <code>rememberCoroutineScope</code> 和 <code>scope.launch</code>，则每次 Compose 调用 <code>LandingScreen</code> 时都会执行协程，而不管该调用是否使其进入组合。因此，您会浪费资源，而且不会在受控环境中执行此附带效应。</p>
<h2 data-id="heading-16">7. 创建状态容器</h2>
<p>您注意到了吗？如果您点按“Choose Destination”，您可以修改该字段，并根据搜索输入过滤城市。此外，您或许还注意到了，每当您修改“Choose Destination”时，文本样式都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d3b1750f3f840619a77730c387d81be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=HrS64TARh%2Fnkj691iSbShoTt6v8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>base/EditableUserInput.kt</code> 文件。<code>CraneEditableUserInput</code> 有状态可组合项接受一些参数，如 <code>hint</code> 和 <code>caption</code>，后者对应于图标旁边的可选文本。例如，当您搜索目的地时，会出现 <code>caption</code>“To”。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    hint: <span class="hljs-type">String</span>,
    caption: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-type">Int</span>? = <span class="hljs-literal">null</span>,
    onInputChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-comment">// TODO Codelab: Encapsulate this state in a state holder</span>
    <span class="hljs-keyword">var</span> textState <span class="hljs-keyword">by</span> remember { mutableStateOf(hint) }
    <span class="hljs-keyword">val</span> isHint = { textState == hint }

    ...
}
</code></pre>
<h3 data-id="heading-17">原因</h3>
<p>用于更新 <code>textState</code> 以及确定显示的内容是否对应于提示的逻辑全部都在 <code>CraneEditableUserInput</code> 可组合项的主体中。这就带来了一些缺点：</p>
<ul>
<li><code>TextField</code> 的值未提升，因而无法从外部进行控制，这使得测试更加困难。</li>
<li>此可组合项的逻辑可能会变得更加复杂，并且内部状态可能会更容易不同步。</li>
</ul>
<p>通过创建负责此可组合项的内部状态的状态容器，您可以将所有状态变化集中在一个位置。这样，状态不同步就更难了，并且相关的逻辑全部归在一个类中。此外，此状态很容易向上提升，并且可以从此可组合项的调用方使用。</p>
<p>在这种情况下，提升状态是一种不错的做法，因为这是一个低级界面组件，可能会在应用的其他部分中重复使用。因此，它越灵活越可控，就越好。</p>
<h3 data-id="heading-18">创建状态容器</h3>
<p>由于 <code>CraneEditableUserInput</code> 是一个可重复使用的组件，您可以在同一文件中创建一个名为 <code>EditableUserInputState</code> 的常规类作为状态容器，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {

    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)
       <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateText</span><span class="hljs-params">(newText: <span class="hljs-type">String</span>)</span></span> {
       text = newText
    }

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint
}
</code></pre>
<p>该类应具有以下特征：</p>
<ul>
<li><code>text</code> 是 <code>String</code> 类型的可变状态，就像在 <code>CraneEditableUserInput</code> 中一样。请务必使用 <code>mutableStateOf</code>，以便 Compose 跟踪值的更改，并在发生更改时重组。</li>
<li><code>text</code> 是具有私有 <code>set</code> 的 <code>var</code>，因此无法直接从类外部改变它。您可以公开 <code>updateText</code> 事件来对此变量进行修改，从而将该类设为单一可信来源，而不是公开此变量。</li>
<li>该类将 <code>initialText</code> 作为用于初始化 <code>text</code> 的依赖项。</li>
<li>用于判断 <code>text</code> 是否为提示的逻辑在按需执行检查的 <code>isHint</code> 属性中。</li>
</ul>
<p>如果将来逻辑变得更加复杂，您只需要对一个类进行更改：<code>EditableUserInputState</code>。</p>
<h3 data-id="heading-19">记住状态容器</h3>
<p>始终需要记住状态容器，以使其留在组合中，而不是每次都创建一个新的。最好在同一文件中创建一个执行此操作的方法，以移除样板并避免可能发生的任何错误。在 <code>base/EditableUserInput.kt</code> 文件中，添加以下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    remember(hint) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>如果您只是使用 <code>remember</code> 记住此状态，它在 activity 重新创建后不会继续留存。**为了解决此问题，您可以改用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberSaveable(kotlin.Array%2Candroidx.compose.runtime.saveable.Saver%2Ckotlin.String%2Ckotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>rememberSaveable</code></strong></a> API，它的行为方式与 <code>remember</code> 类似，但存储的值在 activity 和进程重新创建后会继续留存。在内部，它使用保存的实例状态机制。</p>
<p>对于可以存储在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fos%2FBundle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/android/os/Bundle?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Bundle</code></a> 内的对象，<code>rememberSaveable</code> 可以做所有这些工作，而无需任何额外的操作。对于您在项目中创建的 <code>EditableUserInputState</code> 类，却并非如此。因此，您需要告知 <code>rememberSaveable</code> 如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 保存和恢复此类的实例。</p>
<h3 data-id="heading-20">创建自定义保存器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 描述了如何将对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2FSaver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/Saver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Saveable</code></a>（可保存）的内容。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的实现需要替换两个函数：</p>
<ul>
<li><code>save</code> - 将原始值转换为可保存的值。</li>
<li><code>restore</code> - 将恢复的值转换为原始类的实例。</li>
</ul>
<p>在本例中，您可以使用一些现有的 Compose API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23listSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#listSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>listSaver</code></a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23mapSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#mapSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>mapSaver</code></a>（用于存储要保存在 <code>List</code> 或 <code>Map</code> 中的值），以减少您需要编写的代码量，而不是为 <code>EditableUserInputState</code> 类创建 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的自定义实现。</p>
<p>最好将 <code>Saver</code> 定义放置在与其一起使用的类附近。由于需要被静态访问，因此请在 <code>companion object</code> 中为 <code>EditableUserInputState</code> 添加 <code>Saver</code>。在 <code>base/EditableUserInput.kt</code> 文件中，添加 <code>Saver</code> 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.Saver
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.listSaver

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> Saver: Saver&lt;EditableUserInputState, *&gt; = listSaver(
            save = { listOf(it.hint, it.text) },
            restore = {
                EditableUserInputState(
                    hint = it[<span class="hljs-number">0</span>],
                    initialText = it[<span class="hljs-number">1</span>],
                )
            }
        )
    }
}
</code></pre>
<p>在本例中，您将 <code>listSaver</code> 用作实现细节，在保存器中存储和恢复 <code>EditableUserInputState</code> 的实例。</p>
<p>现在，您可以在之前创建的 <code>rememberEditableUserInputState</code> 方法的 <code>rememberSaveable</code>（而不是 <code>remember</code>）中使用此保存器：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.rememberSaveable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    rememberSaveable(hint, saver = EditableUserInputState.Saver) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>这样，<code>EditableUserInput</code> 记住的状态就会在进程和 activity 重新创建后继续留存。</p>
<h3 data-id="heading-21">使用状态容器</h3>
<p>您将要使用 <code>EditableUserInputState</code> 而不是 <code>text</code> 和 <code>isHint</code>，但您不希望只将其用作 <code>CraneEditableUserInput</code> 中的内部状态，因为调用方可组合项无法控制状态。相反，您希望提升 <code>EditableUserInputState</code>，以便调用方可以控制 <code>CraneEditableUserInput</code> 的状态。**如果您提升状态，那么可组合项就可以在预览中使用，并且更容易进行测试，因为您能够从调用方修改其状态。</p>
<p>为此，您需要更改可组合函数的形参，并在需要时为其提供默认值。由于您可能希望允许 <code>CraneEditableUserInput</code> 带有空提示，因此添加一个默认实参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>您或许已经注意到，<code>onInputChanged</code> 形参不存在了！由于状态可以提升，因此如果调用方想要知道输入是否发生了更改，它们可以控制状态并将该状态传入此函数。</p>
<p>接下来，您需要调整函数主体，以使用提升的状态，而不是之前使用的内部状态。重构后，函数应如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) {
    CraneBaseUserInput(
        caption = caption,
        tintIcon = { !state.isHint },
        showCaption = { !state.isHint },
        vectorImageId = vectorImageId
    ) {
        BasicTextField(
            value = state.text,
            onValueChange = { state.updateText(it) },
            textStyle = <span class="hljs-keyword">if</span> (state.isHint) {
                captionTextStyle.copy(color = LocalContentColor.current)
            } <span class="hljs-keyword">else</span> {
                MaterialTheme.typography.body1.copy(color = LocalContentColor.current)
            },
            cursorBrush = SolidColor(LocalContentColor.current)
        )
    }
}
</code></pre>
<h3 data-id="heading-22">状态容器调用方</h3>
<p>由于您更改了 <code>CraneEditableUserInput</code> 的 API，因此需要在调用它的所有位置进行检查，以确保传入适当的形参。</p>
<p>在项目中，您只在一个位置调用此 API，那就是在 <code>home/SearchUserInput.kt</code> 文件中。打开该文件并转到 <code>ToDestinationUserInput</code> 可组合函数；您应该会在该位置看到一个构建错误。由于提示现在是状态容器的一部分，并且您希望在组合中设置此 <code>CraneEditableUserInput</code> 实例的自定义提示，因此您需要记住 <code>ToDestinationUserInput</code> 级别的状态，并将其传入 <code>CraneEditableUserInput</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.samples.crane.base.rememberEditableUserInputState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )
}
</code></pre>
<h3 data-id="heading-23">snapshotFlow</h3>
<p>上面的代码缺少在输入更改时通知 <code>ToDestinationUserInput</code> 的调用方的功能。由于应用的结构，您不希望在层次结构中将 <code>EditableUserInputState</code> 提升到任何更高的级别。而且，您也不希望将其他可组合项（如 <code>FlySearchContent</code>）与此状态相结合。您如何从 <code>ToDestinationUserInput</code> 调用 <code>onToDestinationChanged</code> lambda 并且仍使此可组合项可重复使用呢？</p>
<p>您可以在每次输入更改时使用 <code>LaunchedEffect</code> 触发附带效应，并调用 <code>onToDestinationChanged</code> lambda：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> androidx.compose.runtime.snapshotFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.collect
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.filter

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )

    <span class="hljs-keyword">val</span> currentOnDestinationChanged <span class="hljs-keyword">by</span> rememberUpdatedState(onToDestinationChanged)
    LaunchedEffect(editableUserInputState) {
        snapshotFlow { editableUserInputState.text }
            .filter { !editableUserInputState.isHint }
            .collect {
                currentOnDestinationChanged(editableUserInputState.text)
            }
    }
}
</code></pre>
<p>您之前已经使用了 <code>LaunchedEffect</code> 和 <code>rememberUpdatedState</code>，但上面的代码还使用了一个新的 API！<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23snapshotFlow(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#snapshotFlow(kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>snapshotFlow</code></strong></a> <strong>API</strong> 将 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer"><code>State&lt;T&gt;</code></a> 对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow?hl=zh-cn" ref="nofollow noopener noreferrer">Flow</a>。当在 <code>snapshotFlow</code> 内读取的状态发生变化时，Flow 会向收集器发出新值。在本例中，您将状态转换为 Flow，以使用 Flow 运算符的强大功能。这样，您就可以在 <code>text</code> 不是 <code>hint</code> 时使用 <code>filter</code> 进行过滤，并使用 <code>collect</code> 收集发出的项，以通知父项当前的目的地发生了变化。</p>
<h2 data-id="heading-24">8. DisposableEffect</h2>
<p>当您点按某个目的地时，系统会打开详情屏幕，您可以看到相应的城市在地图上的位置。该代码位于 <code>details/DetailsActivity.kt</code> 文件中。在 <code>CityMapView</code> 可组合项中，您调用了 <code>rememberMapViewWithLifecycle</code> 函数。如果您打开此函数（它位于 <code>details/MapViewUtils.kt</code> 文件中），您会看到它未关联到任何生命周期！它只是记住 <code>MapView</code> 并对其调用 <code>onCreate</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-comment">// TODO Codelab: DisposableEffect step. Make MapView follow the lifecycle</span>
    <span class="hljs-keyword">return</span> remember {
        MapView(context).apply {
            id = R.id.map
            onCreate(Bundle())
        }
    }
}
</code></pre>
<p>虽然应用运行良好，但这也是一个问题，因为 <code>MapView</code> 未遵循正确的生命周期。因此，它不知道应用何时转至后台、View 何时应暂停，等等。让我们来解决这一问题！</p>
<blockquote>
<p><strong>注意</strong>：如果您未看到地图，请查看“准备设置”步骤中的“[可选] 在详情屏幕上显示地图”部分。** **不过，对于本部分，没有必要在屏幕上看到地图。</p>
</blockquote>
<p>由于 <code>MapView</code> 是 View 而不是可组合项，因此您希望它遵循使用它的 Activity 的生命周期，以及组合的生命周期。这意味着，您需要创建一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleEventObserver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleEventObserver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleEventObserver</code></a> 来监听生命周期事件并在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fandroid%2Freference%2Fcom%2Fgoogle%2Fandroid%2Fgms%2Fmaps%2FMapView%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/android/reference/com/google/android/gms/maps/MapView?hl=zh-cn" ref="nofollow noopener noreferrer"><code>MapView</code></a> 上调用正确的方法。然后，您需要将此观察器添加到当前 activity 的生命周期。</p>
<p>首先创建一个函数，该函数返回 <code>LifecycleEventObserver</code>，在给定某个事件的情况下，它会在 <code>MapView</code> 中调用相应的方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.lifecycle.Lifecycle
<span class="hljs-keyword">import</span> androidx.lifecycle.LifecycleEventObserver

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMapLifecycleObserver</span><span class="hljs-params">(mapView: <span class="hljs-type">MapView</span>)</span></span>: LifecycleEventObserver =
    LifecycleEventObserver { _, event -&gt;
        <span class="hljs-keyword">when</span> (event) {
            Lifecycle.Event.ON_CREATE -&gt; mapView.onCreate(Bundle())
            Lifecycle.Event.ON_START -&gt; mapView.onStart()
            Lifecycle.Event.ON_RESUME -&gt; mapView.onResume()
            Lifecycle.Event.ON_PAUSE -&gt; mapView.onPause()
            Lifecycle.Event.ON_STOP -&gt; mapView.onStop()
            Lifecycle.Event.ON_DESTROY -&gt; mapView.onDestroy()
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalStateException()
        }
    }
</code></pre>
<p>现在，您需要将此观察器添加到当前的生命周期，您可以使用当前的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleOwner%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleOwner</code></a> 与 <code>LocalLifecycleOwner</code> 组合局部函数来获取该生命周期。不过，仅仅添加观察器是不够的；您还需要能够将其移除！您需要一种附带效应，可以在效应退出组合时告知您，以便您可以执行一些清理代码。您寻找的附带效应 API 是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>。</p>
<p><code>DisposableEffect</code> 适用于在键发生变化或可组合项退出组合后需要清理的附带效应。最终的 <code>rememberMapViewWithLifecycle</code> 代码正好起到这种作用。在项目中实现以下代码行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.DisposableEffect
<span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalLifecycleOwner

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> mapView = remember {
        MapView(context).apply {
            id = R.id.map
        }
    }

    <span class="hljs-keyword">val</span> lifecycle = LocalLifecycleOwner.current.lifecycle
    DisposableEffect(key1 = lifecycle, key2 = mapView) {
        <span class="hljs-comment">// Make MapView follow the current lifecycle</span>
        <span class="hljs-keyword">val</span> lifecycleObserver = getMapLifecycleObserver(mapView)
        lifecycle.addObserver(lifecycleObserver)
        onDispose {
            lifecycle.removeObserver(lifecycleObserver)
        }
    }

    <span class="hljs-keyword">return</span> mapView
}
</code></pre>
<p>将观察器添加到了当前的 <code>lifecycle</code>，只要当前的生命周期发生变化或者此可组合项退出组合，就会将其移除。对于 <code>DisposableEffect</code> 中的 <code>key</code>，如果 <code>lifecycle</code> 或 <code>mapView</code> 发生变化，系统会移除观察器并再次将其添加到正确的 <code>lifecycle</code>。</p>
<p>通过您刚刚所做的更改，<code>MapView</code> 将始终遵循当前 <code>LifecycleOwner</code> 的 <code>lifecycle</code>，并且其行为就像在 View 环境中使用它时一样。</p>
<blockquote>
<p><strong>注意</strong>：此部分介绍了如何定义 <code>LifecycleEventObserver</code> 来响应 Compose 中的 <code>LifecycleOwner</code> 事件。您还学习了如何使用 <code>DisposableEffect</code> API 安全处置资源，以避免内存泄漏。相关示例使用了基于 View 的组件 <code>MapView</code>。在真实的 Compose 应用中，您可以使用新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fmaps-compose%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/maps-compose?hl=zh-cn" ref="nofollow noopener noreferrer">Maps for Compose 库</a>，该库会为您处理生命周期事件。</p>
</blockquote>
<h2 data-id="heading-25">9. produceState</h2>
<p>在本部分中，您将改进详情屏幕的启动方式。<code>details/DetailsActivity.kt</code> 文件中的 <code>DetailsScreen</code> 可组合项会从 ViewModel 同步获取 <code>cityDetails</code>，并在结果成功时调用 <code>DetailsContent</code>。</p>
<p>不过，<code>cityDetails</code> 在界面线程上的加载成本可能会变得越来越高，它可以使用协程将数据的加载工作移至其他线程。您将改进此代码，以添加一个加载屏幕，并在数据准备就绪时显示 <code>DetailsContent</code>。</p>
<p>为屏幕状态建模的一种方法是使用以下类，它涵盖了所有的可能性：要在屏幕上显示的数据，以及加载和错误信号。将 <code>DetailsUiState</code> 类添加到 <code>DetailsActivity.kt</code> 文件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailsUiState</span>(
    <span class="hljs-keyword">val</span> cityDetails: ExploreModel? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> throwError: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
)
</code></pre>
<p>您可以使用一个数据流（即 <code>DetailsUiState</code> 类型的 <code>StateFlow</code>）映射屏幕需要显示的内容和 ViewModel 层中的 <code>UiState</code>，ViewModel 会在信息准备就绪时更新该数据流，而 Compose 会使用您已了解的 <code>collectAsStateWithLifecycle()</code> API 收集该数据流。</p>
<p>不过，为了本练习，您将实现一种替代方案。如果您希望将 <code>uiState</code> 映射逻辑移至 Compose 环境，您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> API。</p>
<p><code>produceState</code> 可让您将非 Compose 状态转换为 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>。它会启动一个作用域限定为组合的协程，该协程可使用 <code>value</code> 属性将值推送到返回的 <code>State</code>。与 <code>LaunchedEffect</code> 一样，<code>produceState</code> 也采用键来取消和重新开始计算。</p>
<p>对于您的用例，您可以使用 <code>produceState</code> 发出初始值为 <code>DetailsUiState(isLoading = true)</code> 的 <code>uiState</code> 更新，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.produceState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {

    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-comment">// In a coroutine, this can call suspend functions or move</span>
        <span class="hljs-comment">// the computation to different Dispatchers</span>
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> ... </span>
}
</code></pre>
<p>接下来，根据 <code>uiState</code>，您会显示数据、显示加载屏幕或报告错误。下面是 <code>DetailsScreen</code> 可组合项的完整代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.Box
<span class="hljs-keyword">import</span> androidx.compose.material.CircularProgressIndicator

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-keyword">when</span> {
        uiState.cityDetails != <span class="hljs-literal">null</span> -&gt; {
            DetailsContent(uiState.cityDetails!!, modifier.fillMaxSize())
        }
        uiState.isLoading -&gt; {
            Box(modifier.fillMaxSize()) {
                CircularProgressIndicator(
                    color = MaterialTheme.colors.onSurface,
                    modifier = Modifier.align(Alignment.Center)
                )
            }
        }
        <span class="hljs-keyword">else</span> -&gt; { onErrorLoading() }
    }
}
</code></pre>
<p>如果您运行应用，您会看到在显示城市详情之前如何出现了指示“正在加载”的旋转图标。</p>
<blockquote>
<p><strong>注意</strong>：<code>collectAsStateWithLifecycle()</code> API 会在后台使用 <code>produceState()</code> API。</p>
</blockquote>
<h2 data-id="heading-26">10. derivedStateOf</h2>
<p>您要对 Crane 做的最后一项改进是，每当您在航班目的地列表中滚动时，经过屏幕的第一个元素之后，都会显示一个用于“滚动至顶部”的按钮。点按该按钮会使您前往列表中的第一个元素。</p>
<p>打开包含此代码的 <code>base/ExploreSection.kt</code> 文件。<code>ExploreSection</code> 可组合项对应于您在 Scaffold 的背景幕中看到的内容。</p>
<p>如需计算用户是否已经过第一项，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lists?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyColumn</code></a> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Ffoundation%2Flazy%2FLazyListState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/foundation/lazy/LazyListState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyListState</code></a> 并检查 <code>listState.firstVisibleItemIndex &gt; 0</code>。</p>
<p>简单实现如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// DO NOT DO THIS - It's executed on every recomposition</span>
<span class="hljs-keyword">val</span> showButton = listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
</code></pre>
<p>该解决方案的效率并不高，因为每当 <code>firstVisibleItemIndex</code> 发生变化时，读取 <code>showButton</code> 的可组合函数都会重组，这种情况经常会在滚动时发生。不过，您希望该函数仅在条件在 <code>true</code> 和 <code>false</code> 之间变化时重组。</p>
<p>有一个 API 可让您做到这一点，那就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a> API。</p>
<p><code>listState</code> 是一个可观察的 Compose <code>State</code>。您的计算 <code>showButton</code> 也需要是一个 Compose <code>State</code>，因为您希望界面在其值发生变化时重组，并显示或隐藏按钮。</p>
<p>当您想要的某个 Compose <code>State</code> 衍生自另一个 <code>State</code> 时，请使用 <code>derivedStateOf</code>。每当内部状态发生变化时，系统都会执行 <code>derivedStateOf</code> 计算块，但只有当计算结果与上一项不同时，可组合函数才会重组。这样可以最大限度地减少读取 <code>showButton</code> 的函数的重组次数。</p>
<p>在这种情况下，使用 <code>derivedStateOf</code> API 是一种更好且更高效的替代方案。您还会使用 <code>remember</code> API 来封装调用，因此计算得出的值在重组后继续有效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Show the button if the first visible item is past</span>
<span class="hljs-comment">// the first item. We use a remembered derived state to</span>
<span class="hljs-comment">// minimize unnecessary recompositions</span>
<span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
    derivedStateOf {
        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
    }
}
</code></pre>
<p>您应该已经熟悉 <code>ExploreSection</code> 可组合项的新代码。您使用 <code>Box</code> 将有条件地显示的 <code>Button</code> 放置在 <code>ExploreList</code> 的顶部。您会使用 <code>rememberCoroutineScope</code> 在 <code>Button</code> 的 <code>onClick</code> 回调内调用 <code>listState.scrollToItem</code> 挂起函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/ExploreSection.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.material.FloatingActionButton
<span class="hljs-keyword">import</span> androidx.compose.runtime.derivedStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.navigationBarsPadding
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExploreSection</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    title: <span class="hljs-type">String</span>,
    exploreList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ExploreModel</span>&gt;,
    onItemClicked: <span class="hljs-type">OnExploreItemClicked</span>
)</span></span> {
    Surface(modifier = modifier.fillMaxSize(), color = Color.White, shape = BottomSheetShape) {
        Column(modifier = Modifier.padding(start = <span class="hljs-number">24.</span>dp, top = <span class="hljs-number">20.</span>dp, end = <span class="hljs-number">24.</span>dp)) {
            Text(
                text = title,
                style = MaterialTheme.typography.caption.copy(color = crane_caption)
            )
            Spacer(Modifier.height(<span class="hljs-number">8.</span>dp))
            Box(Modifier.weight(<span class="hljs-number">1f</span>)) {
                <span class="hljs-keyword">val</span> listState = rememberLazyListState()
                ExploreList(exploreList, onItemClicked, listState = listState)

                <span class="hljs-comment">// Show the button if the first visible item is past</span>
                <span class="hljs-comment">// the first item. We use a remembered derived state to</span>
                <span class="hljs-comment">// minimize unnecessary compositions</span>
                <span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
                    derivedStateOf {
                        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
                    }
                }
                <span class="hljs-keyword">if</span> (showButton) {
                    <span class="hljs-keyword">val</span> coroutineScope = rememberCoroutineScope()
                    FloatingActionButton(
                        backgroundColor = MaterialTheme.colors.primary,
                        modifier = Modifier
                            .align(Alignment.BottomEnd)
                            .navigationBarsPadding()
                            .padding(bottom = <span class="hljs-number">8.</span>dp),
                        onClick = {
                            coroutineScope.launch {
                                listState.scrollToItem(<span class="hljs-number">0</span>)
                            }
                        }
                    ) {
                        Text(<span class="hljs-string">"Up!"</span>)
                    }
                }
            }
        }
    }
}
</code></pre>
<p>如果您运行应用，您会看到一旦您滚动并经过屏幕的第一个元素，该按钮就会出现在底部。</p>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>derivedStateOf()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fjetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" target="_blank" title="https://medium.com/androiddevelopers/jetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" ref="nofollow noopener noreferrer">何时应使用 derivedStateOf？</a>这篇博文。</p>
</blockquote>
<h2 data-id="heading-27">11. 总结</h2>
<p>您学习了如何创建状态容器、附带效应 API（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>），以及如何在 Jetpack Compose 中使用协程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务]]></title>    <link>https://juejin.cn/post/7582808491583619108</link>    <guid>https://juejin.cn/post/7582808491583619108</guid>    <pubDate>2025-12-12T08:09:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491583619108" data-draft-id="7582808491583258660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-12T08:09:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:09:43.000Z" title="Fri Dec 12 2025 08:09:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>后端 API 开发是很多前端开发者的"心理阴影"——数据库设计、ORM 操作、JWT 认证、错误处理……每一步都是坑。但有了 AI，这一切都变得简单起来。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第三篇文章，带你用 AI 快速搭建 Next.js 15 后端 API。</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：前端开发者的后端焦虑</h2>
<h3 data-id="heading-1">1.1 后端开发的"噩梦"</h3>
<p>还记得小何吗？完成前端架构搭建后，他面临一个更大的挑战：<strong>后端 API 开发</strong>。</p>
<p>作为一个前端开发者，小何对后端并不陌生，但每次写后端代码时，总有一种"如履薄冰"的感觉：</p>
<pre><code class="hljs language-txt" lang="txt">数据库表怎么设计？字段类型怎么选？
ORM 怎么用？Prisma 和 TypeORM 有什么区别？
JWT 怎么生成？Token 过期怎么处理？
接口怎么设计才符合 RESTful 规范？
错误处理怎么统一？日志怎么记录？
</code></pre>
<p>传统方式下，小何需要：</p>









































<table><thead><tr><th>任务</th><th>预计时间</th></tr></thead><tbody><tr><td>学习 Next.js API</td><td>2 小时</td></tr><tr><td>数据库表设计</td><td>3 小时</td></tr><tr><td>Prisma 配置和学习</td><td>4 小时</td></tr><tr><td>JWT 认证实现</td><td>3 小时</td></tr><tr><td>登录注册 API</td><td>4 小时</td></tr><tr><td>响应格式统一</td><td>2 小时</td></tr><tr><td>错误处理和日志</td><td>2 小时</td></tr><tr><td><strong>总计</strong></td><td><strong>20 小时</strong></td></tr></tbody></table>
<p>实际上，因为各种问题，可能需要 <strong>3-4 天</strong>。</p>
<h3 data-id="heading-2">1.2 AI 辅助的后端开发</h3>
<p>有了 TRAE SOLO，小何的体验完全不同：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我搭建 Next.js 15 后端 API，需要：
      1. MySQL 数据库，使用 Prisma ORM
      2. JWT 认证
      3. 微信小程序登录
      4. 统一的响应格式
      5. 日志记录

AI：好的，我来帮你搭建完整的后端架构：

    ✓ 分析项目结构，确定 Pages Router 模式
    ✓ 设计数据库表结构（用户、会员、账单等）
    ✓ 配置 Prisma ORM 连接 MySQL
    ✓ 实现 JWT 生成和验证
    ✓ 封装微信登录流程
    ✓ 统一响应格式（responseHelper）
    ✓ 配置 Winston 日志系统

    后端架构已生成，请查看...
</code></pre>
<p><strong>时间对比</strong>：</p>















































<table><thead><tr><th>任务</th><th>传统方式</th><th>AI 辅助</th><th>提升倍数</th></tr></thead><tbody><tr><td>数据库设计</td><td>3 小时</td><td>15 分钟</td><td><strong>12x</strong></td></tr><tr><td>Prisma 配置</td><td>4 小时</td><td>10 分钟</td><td><strong>24x</strong></td></tr><tr><td>JWT 认证</td><td>3 小时</td><td>10 分钟</td><td><strong>18x</strong></td></tr><tr><td>登录 API</td><td>4 小时</td><td>20 分钟</td><td><strong>12x</strong></td></tr><tr><td>响应格式统一</td><td>2 小时</td><td>5 分钟</td><td><strong>24x</strong></td></tr><tr><td><strong>总计</strong></td><td><strong>~20 小时</strong></td><td><strong>~1 小时</strong></td><td><strong>~20x</strong></td></tr></tbody></table>
<h2 data-id="heading-3">二、技术选型：为什么选择 Next.js 15 + Prisma</h2>
<h3 data-id="heading-4">2.1 Next.js 作为后端的优势</h3>
<pre><code class="hljs language-txt" lang="txt">小何：为什么后端要用 Next.js？不是应该用 Express 或 Koa 吗？

AI：Next.js 作为后端有独特优势：

    1. 全栈一体化
       - 前后端可以共享代码和类型
       - 部署更简单，一个服务搞定

    2. API Routes 开箱即用
       - 文件即路由，无需额外配置
       - 支持中间件、动态路由

    3. TypeScript 原生支持
       - 类型安全，减少运行时错误
       - 与 Prisma 完美配合

    4. 生态完善
       - 丰富的中间件和插件
       - 社区活跃，问题容易解决
</code></pre>
<h3 data-id="heading-5">2.2 Prisma vs TypeORM</h3>
<pre><code class="hljs language-txt" lang="txt">小何：Prisma 和 TypeORM 怎么选？

AI：（通过 MCP 查阅最新文档）

    ┌────────────────┬────────────────┬────────────────┐
    │     维度       │     Prisma     │    TypeORM     │
    ├────────────────┼────────────────┼────────────────┤
    │ 类型安全       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 学习曲线       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 迁移管理       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 查询直观性     │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 性能           │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐       │
    │ 生态系统       │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐⭐     │
    └────────────────┴────────────────┴────────────────┘

    推荐：Prisma

    理由：
    1. Schema 定义直观，一目了然
    2. 自动生成类型，类型安全
    3. 迁移管理简单，prisma migrate 一键搞定
    4. 查询 API 简洁，链式调用友好
</code></pre>
<h3 data-id="heading-6">2.3 最终技术栈</h3>
<pre><code class="hljs language-txt" lang="txt">后端技术栈：
├── 框架：Next.js 15 (Pages Router)
├── 数据库：MySQL
├── ORM：Prisma 4.11
├── 认证：JWT (jsonwebtoken)
├── 加密：bcryptjs
├── 日志：Winston + daily-rotate-file
├── AI 集成：OpenAI SDK
├── 支付：微信支付 + 支付宝
├── 存储：腾讯云 COS
└── 类型共享：shared-types (workspace)
</code></pre>
<h2 data-id="heading-7">三、数据库设计：Prisma Schema</h2>
<h3 data-id="heading-8">3.1 用户表设计</h3>
<p>数据库设计是后端开发的第一步，也是最重要的一步。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计用户表，需要支持：
1. 微信小程序登录（openid）
2. 手机号登录
3. 性别、年龄段等用户属性
4. 免费使用次数限制
5. 注册来源和渠道追踪
</code></pre>
<p><strong>AI 生成的 Prisma Schema</strong>：</p>
<pre><code class="hljs language-prisma" lang="prisma">// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  user_id               String    @id @default(uuid())
  username              String
  email                 String?   @unique
  phone_number          String?
  openid                String?   // 微信 openid
  hashed_password       String
  email_verified        Boolean   @default(false)
  phone_verified        Boolean   @default(false)

  // 地理信息
  country               String?
  province              String?
  city                  String?
  isp                   String?

  // 用户属性
  verification_code     String?
  avatar                String?
  gender                Int?      // 1: 男, 2: 女
  age_group             Int?      // 1: 00后, 2: 05后, 3: 90后, 4: 80后, 5: 70后

  // 状态管理
  disabled_status       Int?      @default(0)
  disabled_time         DateTime?

  // 免费额度
  free_reply_total      Int       @default(3)
  free_reply_used       Int       @default(0)
  free_reply_reset_time DateTime?

  // 来源追踪
  register_source       Int       @default(1)  // 注册来源
  register_channel      Int       @default(1)  // 注册渠道
  latest_source         Int       @default(1)  // 最近来源
  latest_channel        Int       @default(1)  // 最近渠道

  // 时间戳
  code_send_time        DateTime?
  create_time           DateTime? @default(now())
  update_time           DateTime  @default(now()) @updatedAt
  operate_time          DateTime?

  // 索引
  @@unique([phone_number, deleted_status])
  @@index([register_source], name: "idx_users_register_source")
  @@index([latest_source], name: "idx_users_latest_source")
  @@map("users")
}
</code></pre>
<p><strong>设计要点解析</strong>：</p>
<ol>
<li><strong>UUID 主键</strong>：使用 <code>@default(uuid())</code> 而非自增 ID，分布式友好，自己玩的小项目推荐自增 ID</li>
<li><strong>软删除</strong>：<code>deleted_status</code> + <code>deleted_time</code>，数据可恢复</li>
<li><strong>来源追踪</strong>：<code>register_source/channel</code> 和 <code>latest_source/channel</code>，用于数据分析</li>
<li><strong>免费额度</strong>：<code>free_reply_total/used/reset_time</code>，实现每日免费次数限制</li>
</ol>
<h3 data-id="heading-9">3.2 会员表设计</h3>
<pre><code class="hljs language-prisma" lang="prisma">// 会员类型模型
model MembershipType {
  id              Int       @id @default(autoincrement())
  name            String    // 会员名称：月度会员、季度会员、年度会员
  price           Decimal   @db.Decimal(10, 2)
  duration_days   Int       // 会员时长（天）
  description     String?
  is_active       Boolean   @default(true)
  sort_order      Int       @default(0)
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@map("membership_types")
}

// 用户会员记录
model UserMembership {
  id              Int       @id @default(autoincrement())
  user_id         String
  membership_type Int       // 关联会员类型
  start_time      DateTime
  end_time        DateTime
  is_active       Boolean   @default(true)
  source          String    @default("purchase") // purchase/gift/invite
  order_id        String?   // 关联订单
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@index([user_id], name: "idx_user_membership_user_id")
  @@index([end_time], name: "idx_user_membership_end_time")
  @@map("user_memberships")
}
</code></pre>
<h3 data-id="heading-10">3.3 Prisma 初始化和迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Prisma</span>
pnpm --filter xingdong-server add prisma @prisma/client

<span class="hljs-comment"># 初始化 Prisma</span>
pnpm --filter xingdong-server prisma init

<span class="hljs-comment"># 生成 Prisma Client</span>
pnpm --filter xingdong-server prisma generate

<span class="hljs-comment"># 创建迁移</span>
pnpm --filter xingdong-server prisma migrate dev --name init

<span class="hljs-comment"># 查看数据库</span>
pnpm --filter xingdong-server prisma studio
</code></pre>
<h2 data-id="heading-11">四、项目结构：分层架构设计</h2>
<h3 data-id="heading-12">4.1 目录结构</h3>
<p>AI 帮小何设计了清晰的分层架构：</p>
<pre><code class="hljs language-txt" lang="txt">apps/xindong-server/
├── prisma/
│   └── schema.prisma           # 数据库模型定义
├── src/
│   ├── constants/              # 常量定义
│   │   └── index.ts
│   ├── db/                     # 数据访问层 (DAL)
│   │   ├── user.ts             # 用户数据操作
│   │   ├── chat.ts             # 聊天数据操作
│   │   ├── membership.ts       # 会员数据操作
│   │   └── ...
│   ├── helper/                 # 辅助工具
│   │   ├── logger.ts           # 日志工具
│   │   └── responseHelper.ts   # 响应格式化
│   ├── pages/
│   │   └── api/                # API 路由
│   │       ├── auth/           # 认证相关
│   │       │   ├── login.ts
│   │       │   ├── wx-login.ts
│   │       │   └── register.ts
│   │       ├── chat/           # 聊天相关
│   │       ├── membership/     # 会员相关
│   │       └── upload/         # 文件上传
│   ├── service/                # 业务逻辑层
│   │   ├── auth.ts             # 认证服务
│   │   ├── chatService.ts      # 聊天服务
│   │   ├── membershipService.ts
│   │   └── ...
│   ├── type/                   # 类型定义
│   └── utils/                  # 工具函数
│       ├── auth/
│       │   └── auth.ts         # JWT 工具
│       ├── prismaProxy.ts      # Prisma 代理
│       └── logRequest.ts       # 请求日志
├── .env                        # 环境变量
└── package.json
</code></pre>
<p><strong>分层职责</strong>：</p>
<ol>
<li><strong>pages/api</strong>：接收请求、参数验证、调用 Service</li>
<li><strong>service</strong>：业务逻辑处理、调用多个 DB 方法</li>
<li><strong>db</strong>：纯数据操作、Prisma 查询封装</li>
<li><strong>helper</strong>：通用辅助功能（日志、响应格式化）</li>
<li><strong>utils</strong>：工具函数（加密、JWT、请求处理）</li>
</ol>
<h3 data-id="heading-13">4.2 Prisma 代理封装</h3>
<p>AI 生成了一个 Prisma 代理，自动记录所有数据库操作日志：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/prismaProxy.ts</span>
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;

<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePrismaError</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Prisma error: <span class="hljs-subst">${error.message}</span>`</span>, { error });
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">handler</span>: <span class="hljs-title class_">ProxyHandler</span>&lt;<span class="hljs-title class_">PrismaClient</span>&gt; = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, propKey</span>) {
    <span class="hljs-keyword">const</span> origMethod = target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> origMethod === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: PrismaClient, ...args: <span class="hljs-built_in">unknown</span>[]</span>) {
        <span class="hljs-keyword">const</span> boundMethod = (origMethod <span class="hljs-keyword">as</span> <span class="hljs-title class_">Function</span>).<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 记录请求日志</span>
          logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma request: <span class="hljs-subst">${propKey.toString()}</span> with args: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);

          <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">boundMethod</span>(...args);
          <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            <span class="hljs-keyword">return</span> result
              .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                <span class="hljs-comment">// 如果响应包含 count 属性，则记录所影响的行数</span>
                <span class="hljs-keyword">if</span> (res &amp;&amp; <span class="hljs-keyword">typeof</span> res.<span class="hljs-property">count</span> === <span class="hljs-string">'number'</span>) {
                  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma response: <span class="hljs-subst">${propKey.toString()}</span> affected rows: <span class="hljs-subst">${res.count}</span>`</span>);
                }
                <span class="hljs-keyword">return</span> res;
              })
              .<span class="hljs-title function_">catch</span>(handlePrismaError);
          }
          <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">handlePrismaError</span>(error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
        }
      };
    }

    <span class="hljs-keyword">return</span> target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];
  },
};

<span class="hljs-keyword">const</span> prismaProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(prisma, handler);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prismaProxy;
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 db 层使用代理后的 prisma</span>
<span class="hljs-keyword">import</span> prisma <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/prismaProxy'</span>;

<span class="hljs-comment">// 所有操作自动记录日志</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">user_id</span>: userId },
});
</code></pre>
<h2 data-id="heading-14">五、JWT 认证：从生成到验证</h2>
<h3 data-id="heading-15">5.1 JWT 工具封装</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 JWT 工具，需要：
1. 生成 Token（带过期时间）
2. 验证 Token
3. 密码哈希和验证
4. 使用 bcryptjs 加密
</code></pre>
<p><strong>AI 生成的代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/auth.ts</span>
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">'bcryptjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-comment">// 密码哈希</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hashPassword = <span class="hljs-keyword">async</span> (<span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">genSalt</span>(<span class="hljs-number">10</span>);
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">hash</span>(password, salt);
};

<span class="hljs-comment">// 密码验证</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyPassword = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">hashedPassword</span>: <span class="hljs-built_in">string</span>,
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">compare</span>(password, hashedPassword);
};

<span class="hljs-comment">// 生成 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateJWT = (<span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>({ userId }, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, {
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span>, <span class="hljs-comment">// 例如 '7d'</span>
  });
};

<span class="hljs-comment">// 验证 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyJWT = (<span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    jwt.<span class="hljs-title function_">verify</span>(token, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, <span class="hljs-function">(<span class="hljs-params">err, decoded</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-title function_">reject</span>(err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(decoded);
      }
    });
  });
};
</code></pre>
<h3 data-id="heading-16">5.2 认证中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/authMiddleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> { verifyJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth'</span>;
<span class="hljs-keyword">import</span> { sendUnauthorizedResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { getUserById } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticatedRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NextApiRequest</span> {
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">user</span>: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">withAuth</span> = (<span class="hljs-params">
  handler: (req: AuthenticatedRequest, res: NextApiResponse) =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;,
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">NextApiResponse</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 从 Header 获取 Token</span>
      <span class="hljs-keyword">const</span> authHeader = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>;
      <span class="hljs-keyword">if</span> (!authHeader || !authHeader.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'Bearer '</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'请先登录'</span>);
      }

      <span class="hljs-keyword">const</span> token = authHeader.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>);

      <span class="hljs-comment">// 验证 Token</span>
      <span class="hljs-keyword">const</span> decoded = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyJWT</span>(token);
      <span class="hljs-keyword">if</span> (!decoded || !decoded.<span class="hljs-property">userId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'Token 无效'</span>);
      }

      <span class="hljs-comment">// 获取用户信息</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserById</span>(decoded.<span class="hljs-property">userId</span>);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'用户不存在'</span>);
      }

      <span class="hljs-comment">// 注入用户信息</span>
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">userId</span> = decoded.<span class="hljs-property">userId</span>;
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">user</span> = user;

      <span class="hljs-comment">// 调用原始处理函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>, res);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'认证失败，请重新登录'</span>);
    }
  };
};
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// pages/api/user/profile.ts</span>
<span class="hljs-keyword">import</span> { withAuth, <span class="hljs-title class_">AuthenticatedRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/authMiddleware'</span>;
<span class="hljs-keyword">import</span> { sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: AuthenticatedRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-comment">// req.userId 和 req.user 已经可用</span>
  <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'获取成功'</span>, {
    <span class="hljs-attr">user_id</span>: req.<span class="hljs-property">userId</span>,
    <span class="hljs-attr">username</span>: req.<span class="hljs-property">user</span>.<span class="hljs-property">username</span>,
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withAuth</span>(handler);
</code></pre>
<h2 data-id="heading-17">六、统一响应格式</h2>
<h3 data-id="heading-18">6.1 响应格式设计</h3>
<p>统一的响应格式是 API 开发的基本要求。AI 帮小何设计了清晰的响应结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/responseHelper.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'./logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">UNAUTHORIZED_TIPS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">JsonResponse</span> {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  data?: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 通用响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendResponse</span>(<span class="hljs-params">res: NextApiResponse, code: <span class="hljs-built_in">number</span>, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">jsonResponse</span>: <span class="hljs-title class_">JsonResponse</span> = {
    code,
    message,
    data,
  };
  res.<span class="hljs-title function_">status</span>(code).<span class="hljs-title function_">json</span>(jsonResponse);
}

<span class="hljs-comment">// 成功响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendSuccessResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'数据获取成功'</span>,
  data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">200</span>, message, data);
}

<span class="hljs-comment">// 错误响应（服务器错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendErrorResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">500</span>, message, data);
  logger.<span class="hljs-title function_">error</span>(message);
  logger.<span class="hljs-title function_">error</span>(data);
}

<span class="hljs-comment">// 警告响应（业务错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendWarnningResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">503</span>, message, data);
}

<span class="hljs-comment">// 未授权响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = UNAUTHORIZED_TIPS,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">401</span>, message);
}

<span class="hljs-comment">// 方法不允许</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMethodNotAllowedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Method Not Allowed'</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">405</span>, message);
}
</code></pre>
<h3 data-id="heading-19">6.2 响应码设计</h3>



































<table><thead><tr><th>状态码</th><th>含义</th><th>使用场景</th></tr></thead><tbody><tr><td>200</td><td>成功</td><td>请求成功处理</td></tr><tr><td>401</td><td>未授权</td><td>Token 无效或过期</td></tr><tr><td>405</td><td>方法不允许</td><td>GET 接口收到 POST 请求</td></tr><tr><td>500</td><td>服务器错误</td><td>代码异常、数据库错误</td></tr><tr><td>503</td><td>业务警告</td><td>参数错误、业务规则不满足</td></tr></tbody></table>
<p><strong>前端统一处理</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 前端 HTTP 拦截器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResponse</span> = (<span class="hljs-params">response: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { code, message, data } = response;

  <span class="hljs-keyword">switch</span> (code) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">200</span>:
      <span class="hljs-keyword">return</span> data;
    <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
      <span class="hljs-comment">// 跳转登录</span>
      uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">503</span>:
      <span class="hljs-comment">// 业务警告，显示 Toast</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: message, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
      <span class="hljs-comment">// 服务器错误</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'服务器开小差了'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message || <span class="hljs-string">'未知错误'</span>);
  }
};
</code></pre>
<h2 data-id="heading-20">七、微信小程序登录实现</h2>
<h3 data-id="heading-21">7.1 登录流程设计</h3>
<p>微信小程序登录是"心动恋聊"的核心功能。AI 帮小何设计了完整的登录流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 小程序端
    participant Server as 后端服务
    participant WX as 微信服务器

    Client-&gt;&gt;Client: 1. wx.login()
    Client-&gt;&gt;Client: 2. 返回 code

    Client-&gt;&gt;Server: 3. POST /api/auth/wx-login
    Note right of Client: { code, gender, age_group }

    Server-&gt;&gt;WX: 4. jscode2session
    WX--&gt;&gt;Server: 5. 返回 openid

    Server-&gt;&gt;Server: 6. 查找/创建用户
    Server-&gt;&gt;Server: 7. 生成 JWT

    Server--&gt;&gt;Client: 8. 返回 token + userInfo
</code></pre>
<h3 data-id="heading-22">7.2 登录 API 实现</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现微信小程序登录 API，需要：
1. 接收 wx.login 的 code
2. 调用微信服务器获取 openid
3. 新用户需要收集性别和年龄段
4. 老用户直接返回 token
5. 支持多来源（小程序、App）
6. 记录用户来源和渠道
</code></pre>
<p><strong>AI 生成的代码</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/api/auth/wx-login.ts</span>
<span class="hljs-keyword">import</span> { sendErrorResponse, sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { generateJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { getUserByOpenid, createUserByOpenid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">'POST'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'Method Not Allowed'</span>);
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { code, gender, age_group } = req.<span class="hljs-property">body</span>;

    <span class="hljs-comment">// 1. 调用微信服务器获取 openid</span>
    <span class="hljs-keyword">const</span> wxLoginUrl = <span class="hljs-string">`https://api.weixin.qq.com/sns/jscode2session?appid=<span class="hljs-subst">${process.env.WX_APPID}</span>&amp;secret=<span class="hljs-subst">${process.env.WX_SECRET}</span>&amp;js_code=<span class="hljs-subst">${code}</span>&amp;grant_type=authorization_code`</span>;
    <span class="hljs-keyword">const</span> wxRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(wxLoginUrl);
    <span class="hljs-keyword">const</span> { openid } = <span class="hljs-keyword">await</span> wxRes.<span class="hljs-title function_">json</span>();

    <span class="hljs-comment">// 2. 查找或创建用户</span>
    <span class="hljs-keyword">let</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByOpenid</span>(openid);
    <span class="hljs-keyword">let</span> isNewUser = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-comment">// 新用户需要提供性别和年龄</span>
      <span class="hljs-keyword">if</span> (!gender || !age_group) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'需要完善信息'</span>, { <span class="hljs-attr">needsRegistration</span>: <span class="hljs-literal">true</span>, openid });
      }
      user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createUserByOpenid</span>(openid, gender, age_group);
      isNewUser = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 3. 生成 JWT Token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

    <span class="hljs-comment">// 4. 返回登录结果</span>
    <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'登录成功'</span>, { token, ...user, isNewUser });
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'登录失败'</span>, error.<span class="hljs-property">message</span>);
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> handler;
</code></pre>
<h3 data-id="heading-23">7.3 登录服务层</h3>
<p>手机号登录的服务层封装，支持密码和验证码两种方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { getUserByPhoneNumber } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { checkCodeValid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/service/checkCodeValid'</span>;
<span class="hljs-keyword">import</span> { generateJWT, verifyPassword } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthServiceError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    message: <span class="hljs-built_in">string</span>,
    <span class="hljs-keyword">public</span> code: <span class="hljs-built_in">string</span>,
  </span>) {
    <span class="hljs-variable language_">super</span>(message);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'AuthServiceError'</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-keyword">const</span> { phone_number, password, verification_code } = credentials;

  <span class="hljs-comment">// 从数据库获取用户</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByPhoneNumber</span>(phone_number!);
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'该用户不存在，请先注册'</span>, <span class="hljs-string">'USER_NOT_FOUND'</span>);
  }

  <span class="hljs-keyword">if</span> (password) {
    <span class="hljs-comment">// 密码登录</span>
    <span class="hljs-keyword">const</span> decodedPassword = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(password, <span class="hljs-string">'base64'</span>).<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> isPasswordValid = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyPassword</span>(decodedPassword, user.<span class="hljs-property">hashed_password</span>);
    <span class="hljs-keyword">if</span> (!isPasswordValid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'手机号或密码输入有误'</span>, <span class="hljs-string">'INVALID_CREDENTIALS'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(
        <span class="hljs-string">'手机号未验证通过，请先使用手机号+验证码的方式登录'</span>,
        <span class="hljs-string">'PHONE_UNVERIFIED'</span>,
      );
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 验证码登录</span>
    <span class="hljs-keyword">if</span> (!verification_code) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请输入验证码'</span>, <span class="hljs-string">'MISSING_VERIFICATION_CODE'</span>);
    }
    <span class="hljs-keyword">const</span> { valid, msg } = <span class="hljs-title function_">checkCodeValid</span>({ user, <span class="hljs-attr">code</span>: verification_code });
    <span class="hljs-keyword">if</span> (!valid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(msg, <span class="hljs-string">'INVALID_VERIFICATION_CODE'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请先注册完成后再登录'</span>, <span class="hljs-string">'USER_NOT_REGISTERED'</span>);
    }
  }

  <span class="hljs-comment">// 生成 JWT</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

  <span class="hljs-keyword">return</span> {
    user,
    token,
  };
}
</code></pre>
<h2 data-id="heading-24">八、前后端类型共享：shared-types</h2>
<h3 data-id="heading-25">8.1 为什么需要类型共享</h3>
<p>前后端分离开发时，最常见的问题是<strong>接口对不上</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">后端：{ user_id: "xxx" }
前端：{ userId: "xxx" }  // 拿不到数据

后端：{ gender: 1 }
前端：{ gender: "男" }  // 类型不匹配
</code></pre>
<p>解决方案：<strong>shared-types 包</strong>。</p>
<h3 data-id="heading-26">8.2 类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/shared-types/enums.ts</span>

<span class="hljs-comment">/**
 * 性别枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">GenderEnum</span> {
  <span class="hljs-variable constant_">MALE</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">FEMALE</span> = <span class="hljs-number">2</span>,
}

<span class="hljs-comment">/**
 * 年龄段枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AgeGroupEnum</span> {
  <span class="hljs-variable constant_">POST_00</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 00后</span>
  <span class="hljs-variable constant_">POST_05</span> = <span class="hljs-number">2</span>,  <span class="hljs-comment">// 05后</span>
  <span class="hljs-variable constant_">POST_90</span> = <span class="hljs-number">3</span>,  <span class="hljs-comment">// 90后</span>
  <span class="hljs-variable constant_">POST_80</span> = <span class="hljs-number">4</span>,  <span class="hljs-comment">// 80后</span>
  <span class="hljs-variable constant_">POST_70</span> = <span class="hljs-number">5</span>,  <span class="hljs-comment">// 70后</span>
}

<span class="hljs-comment">/**
 * 年龄段枚举映射（用于显示）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgeGroupMap</span> = {
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_00</span>]: <span class="hljs-string">'00后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_05</span>]: <span class="hljs-string">'05后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_90</span>]: <span class="hljs-string">'90后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_80</span>]: <span class="hljs-string">'80后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_70</span>]: <span class="hljs-string">'70后'</span>,
};

<span class="hljs-comment">/**
 * 客户端来源枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ClientSourceEnum</span> {
  <span class="hljs-variable constant_">MP_WEIXIN</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 微信小程序</span>
  <span class="hljs-variable constant_">ANDROID</span> = <span class="hljs-number">2</span>,    <span class="hljs-comment">// 安卓 App</span>
  <span class="hljs-variable constant_">HARMONY</span> = <span class="hljs-number">3</span>,    <span class="hljs-comment">// 鸿蒙</span>
}
</code></pre>
<h3 data-id="heading-27">8.3 在项目中使用</h3>
<p><strong>后端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/xingdong-server/src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-comment">// 类型自动推导，IDE 智能提示</span>
}
</code></pre>
<p><strong>前端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/unibest-mp/src/api/auth.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">WxLoginParams</span>, <span class="hljs-title class_">WxLoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> apiWxLogin = (<span class="hljs-attr">params</span>: <span class="hljs-title class_">WxLoginParams</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">WxLoginResult</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/auth/wx-login'</span>, params);
};
</code></pre>
<p><strong>package.json 配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"shared-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Next.js 配置</strong>（重要！）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// next.config.js</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">reactStrictMode</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">transpilePackages</span>: [<span class="hljs-string">'shared-types'</span>], <span class="hljs-comment">// 编译本地 TypeScript 包</span>
};
</code></pre>
<h2 data-id="heading-28">九、日志系统：Winston 配置</h2>
<h3 data-id="heading-29">9.1 日志配置</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/logger.ts</span>
<span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">DailyRotateFile</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-comment">// 日志目录</span>
<span class="hljs-keyword">const</span> logDir = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'logs'</span>);

<span class="hljs-comment">// 日志格式</span>
<span class="hljs-keyword">const</span> logFormat = winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, ...meta }</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> [<span class="hljs-subst">${level.toUpperCase()}</span>]: <span class="hljs-subst">${message}</span>`</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(meta).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      msg += <span class="hljs-string">` <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(meta)}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> msg;
  }),
);

<span class="hljs-comment">// 创建 logger</span>
<span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">level</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">LOG_LEVEL</span> || <span class="hljs-string">'info'</span>,
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>: [
    <span class="hljs-comment">// 控制台输出</span>
    <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
      <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(), logFormat),
    }),
    <span class="hljs-comment">// 按日期滚动的文件日志</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'app-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
    }),
    <span class="hljs-comment">// 错误日志单独存放</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'30d'</span>,
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logger;
</code></pre>
<h3 data-id="heading-30">9.2 请求日志中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/logRequest.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">logRequest</span> = (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">const</span> { method, url, body, query } = req;

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Request: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span>`</span>, {
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body),
    <span class="hljs-attr">query</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(query),
    <span class="hljs-attr">ip</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-for'</span>] || req.<span class="hljs-property">socket</span>.<span class="hljs-property">remoteAddress</span>,
    <span class="hljs-attr">userAgent</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'user-agent'</span>],
  });

  <span class="hljs-comment">// 记录响应时间</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'finish'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Response: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> - <span class="hljs-subst">${res.statusCode}</span> (<span class="hljs-subst">${duration}</span>ms)`</span>);
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logRequest;
</code></pre>
<h2 data-id="heading-31">十、总结与下一步</h2>
<h3 data-id="heading-32">10.1 本篇完成的工作</h3>
<p>通过 AI 辅助，我们在 <strong>约 1 小时</strong> 内完成了：</p>





































<table><thead><tr><th>任务</th><th>完成情况</th></tr></thead><tbody><tr><td>✅ Prisma 数据库设计</td><td>用户、会员、账单等核心表</td></tr><tr><td>✅ 分层架构</td><td>API → Service → DB 清晰分离</td></tr><tr><td>✅ JWT 认证</td><td>生成、验证、中间件完整实现</td></tr><tr><td>✅ 微信登录</td><td>支持小程序、App 多端登录</td></tr><tr><td>✅ 统一响应格式</td><td>responseHelper 标准化</td></tr><tr><td>✅ 类型共享</td><td>shared-types 前后端类型一致</td></tr><tr><td>✅ 日志系统</td><td>Winston 按日期滚动、分级存储</td></tr></tbody></table>
<h3 data-id="heading-33">10.2 核心提示词模板</h3>
<p><strong>数据库设计</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计 [表名] 表，需要支持：
1. [功能点 1]
2. [功能点 2]
3. [功能点 3]
使用 Prisma Schema 语法
</code></pre>
<p><strong>API 开发</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现 [功能名称] API，需要：
1. [接口功能]
2. [参数要求]
3. [返回格式]
4. [错误处理]
</code></pre>
<p><strong>工具封装</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 [工具名称]，需要：
1. [功能点 1]
2. [功能点 2]
示例用法：[使用场景]
</code></pre>
<h3 data-id="heading-34">10.3 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 4 篇：用 AI 打造原子化 CSS 开发体系 - UnoCSS 实战》</strong></p>
<p>我们将学习：</p>
<ul>
<li>UnoCSS 高级配置</li>
<li>设计稿转代码技巧</li>
<li>主题定制和换肤</li>
<li>小程序端样式优化</li>
<li>响应式布局实践</li>
</ul>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践]]></title>    <link>https://juejin.cn/post/7582156219059535935</link>    <guid>https://juejin.cn/post/7582156219059535935</guid>    <pubDate>2025-12-11T03:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156219059535935" data-draft-id="7581995152190586922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-11T03:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:43:49.000Z" title="Thu Dec 11 2025 03:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：张鑫（千乘）</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p>
<p><strong>前文回顾：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580386%26idx%3D1%26sn%3D60829abde772d4544cf2d66c1a7b81a7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580386&amp;idx=1&amp;sn=60829abde772d4544cf2d66c1a7b81a7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 UModel 高效构建可观测场景统一实体搜索引擎</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580174%26idx%3D1%26sn%3Ddf8ad313c69dd0157057a46b81c7ab40%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580174&amp;idx=1&amp;sn=df8ad313c69dd0157057a46b81c7ab40&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">构建数据资产“导航地图”：详解 UModel 数据发现与全链路分析能力</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a>》</p>
<h2 data-id="heading-0">背景</h2>
<p>基于 UModel 构建的可观测系统，访问可观测数据需要上层应用感知 EntitySet、DataSet、Storage、Filter 等多个概念，给 UI、算法、客户等使用方带来了较高的开发和维护成本。</p>
<h3 data-id="heading-1">典型场景：查询 APM 服务的请求量指标</h3>
<p>假设上层应用需要实现查询某个 APM 服务的请求量指标，开发者需要经历以下步骤：</p>
<h4 data-id="heading-2">开发者需要了解的知识</h4>
<ol>
<li><strong>实体关联：</strong> 服务实体关联哪个 MetricSet？</li>
<li><strong>存储路由：</strong> MetricSet 使用哪个 MetricStore？Region/Project/存储名称是什么？</li>
<li><strong>字段映射：</strong> Entity 的 <code>service_id</code> 对应存储的哪个字段（如 <code>acs_arms_service_id</code>）？</li>
<li><strong>查询语法：</strong> 如何编写 PromQL 表达式 <code>rate(arms_app_requests_count_raw{...}[1m])</code>？</li>
<li><strong>SPL 拼接：</strong> 如何组装成完整的查询语句？</li>
</ol>
<h4 data-id="heading-3">完整的开发步骤</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: 查询 UModel 元数据
        ↓ 找到 service EntitySet 关联的 MetricSet
        ↓ 如果 DataLink 中包含 FilterByEntity，还需根据实体数据过滤
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: 解析 MetricSet 配置
        ↓ 根据 StorageLink 获取底层 MetricStore 连接信息
        ↓ 获取 Region/Project/MetricStore 名称
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: 查看字段映射
        ↓ 从 DataLink 中获取字段映射表
        ↓ 确认 service_id → acs_arms_service_id
<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: 构造 PromQL 表达式
        ↓ 根据指标定义拼接查询表达式
        ↓ 处理聚合规则、时间窗口
<span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>: 拼接并执行查询
        ↓ 使用正确的 label 和 MetricStore
        ↓ 拼接完整的 SPL 语句并执行
</code></pre>
<p><strong>最终查询语句示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">.metricstore with(<span class="hljs-attr">region</span>=<span class="hljs-string">'cn-hangzhou'</span>, project=<span class="hljs-string">'cms-xxx'</span>, metricstore=<span class="hljs-string">'metricstore-apm'</span>)
|prom-call promql_query_range('sum by (acs_arms_service_id) (rate(arms_app_requests_count_raw{<span class="hljs-attr">acs_arms_service_id</span>=&amp;<span class="hljs-comment">#34;xxx&amp;#34;}[1m]))','1m')</span>
</code></pre>
<h3 data-id="heading-4">痛点</h3>
<h4 data-id="heading-5">痛点 1：概念复杂，学习门槛高</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>开发者必须深入理解 UModel 架构：EntitySet、DataSet、DataLink、StorageLink、Filter 等多个概念</li>
<li>需要了解 DataSet 与 Storage 的关联关系、Filter 路由逻辑、字段映射规则</li>
<li>新人上手困难，老手也容易遗漏细节</li>
</ul>
<p><strong>影响：</strong> 开发效率低，维护成本高</p>
<h4 data-id="heading-6">痛点 2：复杂场景实现困难</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>存储路由查找：需要理解多个 MetricSet 之间的选择逻辑</li>
<li>字段映射处理：Entity 字段 → 存储字段的映射规则复杂</li>
<li>过滤条件筛选：FilterByEntity 规则匹配逻辑难以掌握</li>
<li>多次查询拼接：需要多次查询元数据，再构建数据查询</li>
</ul>
<p><strong>影响：</strong> 增加代码复杂度，出错概率高</p>
<h4 data-id="heading-7">痛点 3：底层存储语法逃不掉</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>MetricSet 可能由 MetricStore 或 LogStore 实现，查询方式完全不同（PromQL vs SPL）</li>
<li>不同存储提供商（ARMS MetricStore、Aliyun Prometheus）语法有差异</li>
<li>开发者仍需精通底层查询语言</li>
</ul>
<p><strong>影响：</strong> 同样的需求需要编写不同的代码，无法统一</p>
<h4 data-id="heading-8">痛点 4：多次查询交互，效率低</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>先查询 UModel Meta 获取配置 → 再根据 Meta 查询数据</li>
<li>需要自己处理数据拼接和关联</li>
<li>每个使用方都要实现类似逻辑，代码重复度高</li>
</ul>
<p><strong>影响：</strong> 集成成本高，查询延迟大，出错概率增加</p>
<h2 data-id="heading-9">目标与架构</h2>
<h3 data-id="heading-10">设计目标</h3>
<p>针对上述四大痛点，UModel PaaS API 的设计目标是屏蔽底层复杂性，统一访问接口，使上层应用更加专注业务逻辑实现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9984af49c44c48b0afcc31e96cfd5319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=XbhGfO0hwA05cH8CwyCpYyGGoCk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-11">核心设计原则</h4>
<ul>
<li><strong>自动化处理：</strong> 自动路由、字段映射、查询转换</li>
<li><strong>统一 SPL 语法：</strong> 所有数据类型使用一致接口</li>
<li><strong>面向对象编程：</strong> 实体方法调用、关系导航</li>
<li><strong>AI 友好：</strong> 反射能力，支持 AI Agent 自主探索</li>
</ul>
<h3 data-id="heading-12">设计理念：两层抽象</h3>
<p>访问 UModel 数据时，需要单独通过 SPL 去访问指标、日志、链路等各种数据，<strong>每种数据都有不同的访问方式，没有统一的抽象。</strong></p>
<p>UModel PaaS API 采用<strong>两层抽象</strong>的设计思路：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8522b6f41d74dcbb3ed0282b539cb6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=uGJOUpgd856GZZJcjGWoRfC6myk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">第一层抽象：Table 模式（表格化抽象）</h4>
<p>将所有数据——指标、日志、链路、性能剖析——统一抽象成<strong>表格结构</strong>，所有查询都是针对表格数据进行操作。</p>
<p><strong>价值：</strong> 统一了查询语言，开发者不需要关心底层是 PromQL 还是 SLS SPL，都用同一套 SPL 语法。</p>
<h4 data-id="heading-14">第二层抽象：Object 模式（对象级抽象）</h4>
<p>表格模式解决了数据访问的统一性，但还不够。我们还需要<strong>以实体为中心</strong>的抽象。</p>
<p>传统方式：查询一个服务的指标，需要知道这个服务关联哪个 MetricSet、字段如何映射、过滤条件怎么写…</p>
<p>Object 模式：只需要说“这个服务，给我它的指标”，系统自动处理字段映射、过滤条件、存储路由。</p>
<p><strong>价值：</strong> 面向对象的思想，把实体当成对象，把查询当成方法调用：<code>service.get_metric()</code>。</p>
<h4 data-id="heading-15">第三层能力：元数据查询（反射能力）</h4>
<p>提供动态能力发现、配置验证等高级功能，让 AI Agent 可以自主探索、自主决策。</p>
<p><strong>价值：</strong> AI Agent 能够通过反射能力动态发现实体的能力边界，实现真正的智能运维。</p>
<h3 data-id="heading-16">架构分层</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ea6c34f60146fc9b4f7abe3d714181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=TAw%2BSRBwdG9e%2F7h0v48s9gQB7tk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">1. 存储层统一：EntityStore/LogStore/MetricStore → SPL</h4>
<p>自动完成存储路由、字段映射（<code>service_id → acs_arms_service_id</code>）、过滤、查询语法的转换。上层应用对存储切换无感知。</p>
<h4 data-id="heading-18">2. 数据层统一：Table 模式</h4>
<p>直接访问 DataSet，声明式查询，支持完整 SPL Pipeline。</p>
<pre><code class="hljs language-ini" lang="ini">.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.request'</span>, query=`service_id=<span class="hljs-string">'xxxx'</span>`) | stats avg(latency)
.log_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.error_log'</span> query=`service_id=<span class="hljs-string">'xxx'</span>`) | where level=&amp;<span class="hljs-comment">#34;ERROR&amp;#34;</span>
</code></pre>
<h4 data-id="heading-19">3. 对象层统一：Object 模式</h4>
<p>以实体为中心，自动处理底层细节，支持动态能力发现和配置检查。</p>
<pre><code class="hljs language-java" lang="java"># 数据访问
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'404e5d6be468f6dfaeef37a014322423'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>)</span> 
# 能力发现（Agent 自主决策的关键）
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__list_method__</span><span class="hljs-params">()</span>
# 配置检查
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__inspect__</span><span class="hljs-params">()</span>
</code></pre>
<h2 data-id="heading-20">API 说明</h2>
<p>UModel PaaS API 提供三大核心能力，满足不同场景的查询需求：</p>
<ol>
<li><strong>Table 模式</strong> - 直接访问数据集，适合批量数据分析</li>
<li><strong>Object 模式</strong> - 以实体为中心，适合实体详情查询和关系分析</li>
<li><strong>元数据查询</strong> - 反射能力和配置验证，支持 AI Agent 和开发调试</li>
</ol>
<h3 data-id="heading-21">Table 模式</h3>
<p>Table 模式（Phase 1）提供直接访问 DataSet（MetricSet、LogSet、TraceSet 等）的能力，返回表格化的可观测数据，适用于不依赖实体关系的数据查询场景。</p>
<p>如：直接查询某个 MetricSet 中的指标数据，或查询某个 LogSet 中的日志，无需关联实体信息。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 读取 apm.metric.apm.service MetricSet对应的avg_request_latency_seconds的指标，</span>
<span class="hljs-comment"># 并对该指标进行异常检测</span>
.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.metric.apm.service'</span>, metric=<span class="hljs-string">'avg_request_latency_seconds'</span>, source=<span class="hljs-string">'metrics'</span>)
| extend <span class="hljs-attr">r</span> = series_decompose_anomalies(__value__) 
| extend <span class="hljs-attr">anomaly_b</span> =r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| extend <span class="hljs-attr">x</span> = zip(anomaly_b, __ts__, anomaly_type, __value__) 
| extend <span class="hljs-attr">__anomaly_rst__</span> = filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>核心特点：</strong></p>
<ul>
<li>直接访问：直达 DataSet，无需查询实体元数据</li>
<li>语法简洁：类似 SQL 的 SPL 语法，易于理解</li>
<li>全量数据：返回 DataSet 中符合条件的所有数据</li>
</ul>
<p><strong>语法：</strong> <code>. with(domain, name, ...) | </code>，更多参数说明请参考文档：Phase 1 Table 模式 <strong>[</strong> <strong>1]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb93a3641544b08be21948d29c9578c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=gZd8RqKCeDb%2FNt%2FGSoQCXR4TpdE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">Object 模式</h3>
<p>Object 模式（Phase 2）提供<strong>以实体为中心的面向对象查询能力</strong>，自动处理实体与数据的关联关系、字段映射、关系查询等复杂逻辑，适用于需要实体上下文的业务场景。</p>
<p>如：查询某个具体服务的指标、日志、链路数据，或查询与该服务有调用关系的其他服务，系统自动完成字段映射和数据过滤。</p>
<pre><code class="hljs language-java" lang="java"># 查询特定服务的请求延迟指标，自动处理字段映射和 FilterByEntity
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span>
| project __entity_id__, __ts__, __value__, __labels__
</code></pre>
<p><strong>核心优势：</strong></p>
<ul>
<li>零配置过滤：自动处理 FilterByEntity，无需手动拼接过滤条件</li>
<li>字段映射透明：自动转换 <code>service_id → acs_arms_service_id</code> 等映射</li>
<li>面向对象语义：<code>entity.get_metric()</code>，符合开发者思维习惯</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;) | </code>，更多参数说明请参考文档：Phase 2 Object 模式 <strong>[</strong> <strong>2]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83198ad240004e66bbe5dddcf6e03773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=ArBD9CBq0HgBRZgKIUtM9dmwx%2Fw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-23">元数据查询方法</h3>
<p>元数据查询方法提供动态发现和反射能力，用于查询实体的关联关系、数据集配置、支持的方法等元数据信息，既可以帮助开发者理解实体能力，也是实现 AI Agent 自主决策和配置验证的关键基础。</p>
<p>如：查询某个服务实体支持哪些方法（<code>__list_method__()</code>）、关联了哪些数据集（<code>list_data_set()</code>）、与哪些其他服务有调用关系（<code>list_related_entity_set()</code>）、配置是否正确（<code>__inspect__()</code>）。</p>
<pre><code class="hljs language-xml" lang="xml"># 动态发现实体支持的所有方法（反射能力）
.entity_set with(domain='apm', name='apm.service') 
| entity-call __list_method__()
# 返回：方法列表及参数定义
# [
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>get_metric<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>获取指标数据<span class="hljs-symbol">&amp;#34;</span>},
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>list_related_entity_set<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>查询关联实体<span class="hljs-symbol">&amp;#34;</span>},
#   ...
# ]
</code></pre>
<p><strong>核心价值：</strong></p>
<ul>
<li>反射能力：<code>__list_method__()</code> 让 AI Agent 能自主探索实体的能力边界</li>
<li>配置验证：<code>__inspect__()</code> 一键检查 DataSet、Link、字段映射等配置完整性</li>
<li>关系查询：<code>list_related_entity_set()</code> 快速获取拓扑关系，无需查询图数据库</li>
<li>能力发现：<code>list_data_set()</code> 了解实体关联的所有观测数据类型</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;)</code>，更多参数说明请参考文档：Phase 2 Object 模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e000ccd7c30345298f37a3475cf305a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=WY4FkW9Q00FxIFvlgF0ighH8Wqo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-24">查询方式</h2>
<h3 data-id="heading-25">UI 方式</h3>
<p>登录云监控 2.0 控制台，点击实体探索 -&gt; SPL，输入 SPL，如下图所示：</p>
<p><code>.entity\_set with(domain='apm', name='apm.service', ids=['21d5ed421ae93973d67a04af551b48b8']) | entity-call get_metric('apm', 'apm.metric.apm.service', 'avg_request_latency_seconds', 'range', '', false)</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1db886c117b54ac090901b7124d42dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=2R8tjeHaOoyHZ6OwIY1UZ9sGH1k%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-26">DryRun 模式</h4>
<p>DryRun 模式返回对应的 Query，不执行当前 Query，也支持手动设置运行模式。</p>
<pre><code class="hljs language-sql" lang="sql"># 开启dry_run模式
.<span class="hljs-keyword">set</span> umodel_paas_mode<span class="hljs-operator">=</span><span class="hljs-string">'dry_run'</span>;
.entity_set <span class="hljs-keyword">with</span>(domain<span class="hljs-operator">=</span><span class="hljs-string">'apm'</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'apm.service'</span>) 
<span class="hljs-operator">|</span> entity<span class="hljs-operator">-</span><span class="hljs-keyword">call</span> get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>) 
</code></pre>
<p>UI 开启 DryRun 模式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e1724052c64023baefe3b68d746726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=7ALJIVlQpqUnJfgVAISCSI6bN2A%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">SDK 方式</h3>
<p>通过阿里云 OpenAPI <strong>[</strong> <strong>3]</strong> 下载 SDK，代码如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
&amp;#<span class="hljs-number">34</span>;fmt&amp;#<span class="hljs-number">34</span>;
	cms20240330 &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/cms<span class="hljs-number">-20240330</span>/v3/client&amp;#<span class="hljs-number">34</span>;
	openapi &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/darabonba-openapi/v2/client&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/tea/tea&amp;#<span class="hljs-number">34</span>;
	credential &amp;#<span class="hljs-number">34</span>;github.com/aliyun/credentials-<span class="hljs-keyword">go</span>/credentials&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;os&amp;#<span class="hljs-number">34</span>;
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateClient</span><span class="hljs-params">()</span></span> (_result *cms20240330.Client, _err <span class="hljs-type">error</span>) {
	credential, _err := credential.NewCredential(<span class="hljs-literal">nil</span>)
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _result, _err
	}
	config := &amp;openapi.Config{
		Credential: credential,
	}
	config.Endpoint = tea.String(&amp;#<span class="hljs-number">34</span>;cms.cn-hangzhou.aliyuncs.com&amp;#<span class="hljs-number">34</span>;)
	_result = &amp;cms20240330.Client{}
	_result, _err = cms20240330.NewClient(config)
<span class="hljs-keyword">return</span> _result, _err
}
<span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">main</span><span class="hljs-params">(args [ ]*<span class="hljs-type">string</span>)</span></span> (_err <span class="hljs-type">error</span>) {
	client, _err := CreateClient()
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _err
	}
	getEntityStoreDataRequest := &amp;cms20240330.GetEntityStoreDataRequest{
		Query: tea.String(&amp;#<span class="hljs-number">34</span>;.entity_set with(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>]) | entity-call get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>) &amp;#<span class="hljs-number">34</span>;),
		From:  tea.Int32(<span class="hljs-number">1762244123</span>),
		To:    tea.Int32(<span class="hljs-number">1762244724</span>),
	}
<span class="hljs-keyword">if</span> result, err := client.GetEntityStoreData(tea.String(&amp;#<span class="hljs-number">34</span>;o11y-demo-cn-hangzhou&amp;#<span class="hljs-number">34</span>;), getEntityStoreDataRequest); err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> err
	} <span class="hljs-keyword">else</span> {
		fmt.Printf(&amp;#<span class="hljs-number">34</span>;length: %d&amp;#<span class="hljs-number">34</span>;, <span class="hljs-built_in">len</span>(result.Body.Data))
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	err := _main(tea.StringSlice(os.Args[<span class="hljs-number">1</span>:]))
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
<span class="hljs-built_in">panic</span>(err)
	}
}
</code></pre>
<p>参数说明：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d51de5612664ed49b17fff454ce33d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=%2FqQie1WvvWGaJ9O91K%2BqXGA46VU%3D" alt="图片" loading="lazy"/></p>
<p><strong>程序运行</strong></p>
<pre><code class="hljs language-ini" lang="ini">go build -o demo .
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=
./demo
</code></pre>
<h2 data-id="heading-28">示例</h2>
<h3 data-id="heading-29">集成算子实现高阶能力：UModel 高阶查询  + 时序异常检测算子</h3>
<p>通过 UModel 高阶 API 集成 SLS 时序异常检测算子 <code>series_decompose_anomalies</code>，一行查询实现智能异常检测。</p>
<p>如：监控某个 APM 服务的请求延迟，当出现异常（突刺、趋势变化、平台变化）时触发告警。</p>
<pre><code class="hljs language-java" lang="java">.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span> 
| <span class="hljs-type">extend</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> series_decompose_anomalies(__value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">anomaly_b</span> <span class="hljs-operator">=</span>r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| <span class="hljs-type">extend</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> zip(anomaly_b, __ts__, anomaly_type, __value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">__anomaly_rst__</span> <span class="hljs-operator">=</span> filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>返回结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2de178290ed4df987dfe6746a9d4f04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=D3i7AxES%2FMbVo8kVoKF%2FbaNWDWI%3D" alt="图片" loading="lazy"/></p>
<p><strong>支持的异常类型：</strong></p>
<ul>
<li><code>SPIKE_UP / SPIKE_DOWN</code> - 向上/向下突刺</li>
<li><code>TREND_SHIFT_UP</code> / <code>TREND_SHIFT_DOWN</code> - 趋势上升/下降</li>
<li><code>LEVEL_SHIFT_UP</code> / <code>LEVEL_SHIFT_DOWN</code> - 平台上升/下降</li>
</ul>
<p>如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f1c630c37914bcd9eb048e611252e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=kpBUiMYsKPfl9O%2FH%2B1HS9SHlL3I%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-30">数据互联互通：关联自定义 LogStore</h3>
<p>在实际生产环境中，业务数据往往分散在多个存储中。例如：</p>
<ul>
<li>UModel 中存储了 APM 服务的拓扑关系、指标、链路、日志</li>
<li>业务系统的自定义日志存储在独立的 LogStore 中（如订单日志、支付日志、用户行为日志）</li>
</ul>
<p>通过 UModel 高阶 API + SPL join 能力，可以<strong>打通 UModel 实体数据与自定义业务数据</strong>，实现：</p>
<ol>
<li><strong>统一视角分析：</strong> 将应用性能问题与业务日志关联分析</li>
<li><strong>快速定位问题：</strong> 从服务异常快速定位到具体业务操作</li>
<li><strong>端到端追踪：</strong> 从业务请求到技术指标的全链路分析</li>
</ol>
<p><strong>典型场景：</strong></p>
<ul>
<li>某个 APM 服务出现延迟异常 → 关联业务订单日志 → 定位到具体慢查询的订单 ID</li>
<li>某个服务的错误日志激增 → 关联用户行为日志 → 分析是哪些用户操作触发了异常</li>
<li>分析服务调用链路 → 关联业务流程日志 → 追踪完整的业务流转路径</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 场景：关联自定义的logstore日志信息
# SPL: 
# <span class="hljs-number">1</span>. 从业务LogStore中找到失败的traceId以及msg
.<span class="hljs-keyword">let</span> failed_log = .logstore <span class="hljs-keyword">with</span>(project=‘xxx’, logstore=‘xxxx’, query=‘*<span class="hljs-comment">') </span>
                     | project trace_id, msg;
# <span class="hljs-number">2</span>. 查询服务的Trace数据
.<span class="hljs-keyword">let</span> service_traces = .entity_set <span class="hljs-keyword">with</span>(domain=<span class="hljs-comment">'apm', name='apm.service', ids=['xxxx']) </span>
                       | entity-<span class="hljs-keyword">call</span> get_trace(‘apm‘, ’apm.trace.common’);
$failed_log | <span class="hljs-keyword">join</span> $service_traces <span class="hljs-keyword">on</span> trace_id = $service_traces.traceId |  project msg
</code></pre>
<h3 data-id="heading-31">集成 AI Agent：通过反射能力实现自主决策</h3>
<p>将 UModel PaaS API 封装为 MCP Tools <strong>[</strong> <strong>4]</strong> ，通过反射能力（<code>__list_method__()</code>）让 AI Agent 具备自主探索和决策能力，实现智能运维分析。</p>
<p>如：用户问“为什么服务响应慢？”，Agent 通过动态发现可用方法，自主完成根因分析。</p>
<pre><code class="hljs language-less" lang="less"># <span class="hljs-selector-tag">Agent</span> 首先调用 <span class="hljs-selector-tag">__list_method__</span>() 动态发现实体支持的方法
<span class="hljs-selector-class">.entity_set</span> <span class="hljs-selector-tag">with</span>(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>) 
| <span class="hljs-selector-tag">entity-call</span> <span class="hljs-selector-tag">__list_method__</span>()
# 返回示例（<span class="hljs-selector-tag">Agent</span> 根据返回的方法列表自主决策下一步操作）:
# {
#   <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">methods</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[#     {&amp;#34;name&amp;#34;: &amp;#34;get_metric&amp;#34;, &amp;#34;params&amp;#34;: [...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取指标数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_log</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取日志数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_trace</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取链路数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">list_related_entity_set</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;查询关联实体<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;}
#   ]
# }
</code></pre>
<p>演示 Demo：</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fggm8MhyGXlRjpXNwxBUmJg" target="_blank" title="https://mp.weixin.qq.com/s/ggm8MhyGXlRjpXNwxBUmJg" ref="nofollow noopener noreferrer">此处</a>，查看Demo演示！</p>
<p><strong>相关链接：</strong></p>
<p>[1] Phase 1 Table 模式</p>
<p>[2] Phase 2 Object 模式</p>
<p>[3] 阿里云 OpenAPI</p>
<p>[4] MCP Tools</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode CMake Tools 功能解析、流程与最佳实践介绍]]></title>    <link>https://juejin.cn/post/7582438809377472554</link>    <guid>https://juejin.cn/post/7582438809377472554</guid>    <pubDate>2025-12-11T11:17:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582438809377472554" data-draft-id="7582397035942690822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode CMake Tools 功能解析、流程与最佳实践介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-11T11:17:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode CMake Tools 功能解析、流程与最佳实践介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T11:17:39.000Z" title="Thu Dec 11 2025 11:17:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CMake Tools 是由 Microsoft 开发的 VS Code 扩展，其核心定位是作为 CMake 与 IDE 界面之间的桥梁，通过自动化传统命令行开发中的多步骤操作（如配置、生成、构建流程）来提升开发效率。该工具不仅提供基础的项目管理功能，还包含详细的文档支持（如 FAQ 指南）以帮助用户解决使用过程中的疑问。</p>
<p>从用户需求适配角度，CMake Tools 实现了对不同技术水平开发者的覆盖：对于新手，其提供快速入门引导简化上手流程；对于专业开发者，则支持高级配置以满足复杂项目需求。这种双重支持体系使其成为跨场景 CMake 项目开发的高效工具。</p>
<p>获取该工具的标准流程需通过 VS Code 扩展面板完成。在扩展市场搜索 "cmake" 时，需注意选择 Microsoft 官方发布的 "CMake Tools"（描述为 "Extended CMake support..."），点击界面中的 "Install" 按钮即可完成安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456ffdb5fe4e4d38aab82f00ebd21360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=JZPy9i2ChGZ3MpfhzP9UUaW8RTk%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>核心价值总结：通过 IDE 集成实现 CMake 工作流自动化，消除命令行操作复杂性；兼顾新手友好性与专业扩展性；与 VS Code 生态深度融合，提供一致的开发体验。</p>
</blockquote>
<h2 data-id="heading-0">核心功能模块解析</h2>
<h3 data-id="heading-1">配置模块：智能缓存生成与命令行简化</h3>
<p>配置模块是 VS Code CMake Tools 的核心组件，其核心功能在于自动化 CMake 缓存生成逻辑。传统命令行模式下，开发者需手动执行 <code>cmake -S . -B build</code> 指定源代码目录（<code>-S</code>）和构建目录（<code>-B</code>），而工具通过图形化界面将这一过程简化为三个步骤：选择工具链（如 GCC、Clang 或 MSVC）、配置构建类型（<code>CMAKE_BUILD_TYPE</code>）、设置自定义参数。缓存生成过程中，工具会自动检测项目根目录下的 <code>CMakeLists.txt</code>，并根据用户配置生成 <code>CMakeCache.txt</code>，避免了命令行输入错误导致的配置失效问题。</p>
<p>关键配置参数对项目构建结果具有直接影响，例如：</p>
<ul>
<li><code>CMAKE_BUILD_TYPE</code>：控制编译优化级别与调试信息生成，取值范围包括 Debug（无优化，含调试符号）、Release（最高优化，无调试信息）、RelWithDebInfo（优化+调试符号）和 MinSizeRel（最小体积优化）。在开发阶段选择 Debug 可显著提升调试效率，而发布版本需切换至 Release 以获得最佳性能。</li>
<li><code>CMAKE_CXX_STANDARD</code>：指定 C++ 标准版本（如 11、14、17 或 20），工具会自动校验编译器兼容性并生成相应编译参数。</li>
</ul>
<h3 data-id="heading-2">构建模块：灵活目标管理与性能优化</h3>
<p>构建模块通过「多生成器支持」和「目标选择机制」提升开发效率。工具默认集成 Ninja、Makefiles、Visual Studio 等多种生成器，其中 Ninja 生成器凭借并行编译能力成为性能优化的关键——其基于依赖关系图的任务调度可充分利用多核 CPU，较传统 Make 构建速度提升 30%~50%。开发者可通过命令面板（<code>Ctrl+Shift+P</code>）执行 <code>CMake: Build</code> 并选择特定目标（如可执行文件、静态库或自定义目标），避免全项目重新编译。</p>
<p>性能优化实践：在大型项目中，建议：</p>
<ul>
<li>启用增量构建（默认开启），仅重新编译修改过的源文件；</li>
<li>配置 <code>CMAKE_CXX_FLAGS</code> 添加编译器特定优化（如 GCC 的 <code>-O3</code> 或 Clang 的 <code>-march=native</code>）；</li>
<li>使用 <code>ctest</code> 集成测试目标，通过 <code>CMake: Run Tests</code> 一键执行单元测试。</li>
</ul>
<h3 data-id="heading-3">调试模块：双模式适配与精准参数配置</h3>
<p>调试模块支持「启动调试（Launch）」和「附加调试（Attach）」两种模式，覆盖不同开发场景：</p>
<ul>
<li><strong>Launch 模式</strong>：适用于从零启动程序，需在 <code>launch.json</code> 中配置 <code>program</code>（可执行文件路径）和 <code>args</code>（命令行参数）。例如，调试路径为 <code>${workspaceFolder}/build/app</code> 的程序并传入 <code>--config debug</code> 参数，配置示例如下：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch App"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}/build/app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--config"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"debug"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>Attach 模式</strong>：用于调试已运行进程，需指定进程 ID（PID）或进程名称，适用于服务端程序或后台进程调试。</li>
</ul>
<p>工具通过「变量替换机制」（如 <code>${workspaceFolder}</code>、<code>${buildType}</code>）动态适配不同构建配置，确保调试器始终关联最新编译产物。同时，集成 GDB、LLDB 等调试器提供断点管理、变量监视和调用栈分析功能，实现代码编辑与调试的无缝衔接。</p>
<hr/>
<h2 data-id="heading-4">项目开发全流程实践</h2>
<p>VSCode CMake Tools 提供了从项目创建到路径配置的完整开发闭环，以下按「创建-配置-构建-调试-路径设置」流程详解实操步骤。</p>
<h3 data-id="heading-5">创建环节：项目初始化与模板选择</h3>
<p>通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Quick Start</code> 命令启动项目向导，根据开发需求选择模板类型：</p>
<ul>
<li><strong>Executable</strong>：适用于构建可执行程序，自动生成包含 <code>main.cpp</code> 的基础工程结构</li>
<li><strong>Library</strong>：用于创建静态/动态库，生成包含头文件和实现文件的库项目框架</li>
</ul>
<p>向导完成后将自动生成初始 <code>CMakeLists.txt</code>，包含项目名称、版本号及语言标准等基础配置。</p>
<h3 data-id="heading-6">配置环节：缓存生成与问题排查</h3>
<p>配置过程是将 <code>CMakeLists.txt</code> 转换为构建系统文件的核心步骤，操作流程如下：</p>
<ol>
<li>打开命令面板（<code>Ctrl+Shift+P</code>）输入并执行 <code>CMake: Configure</code> 命令</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5633515f8d144d279ed5ddd390988b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=lXINON7vngQAYjR8Iny4cCOS89w%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>首次配置需选择编译器（如 GCC、Clang 或 MSVC），后续配置将自动沿用</li>
<li>配置结果可通过 Output 面板（<code>Ctrl+Shift+U</code> 切换）的 CMake/Build 通道查看详细日志</li>
</ol>
<p>配置失败排查指南：</p>
<ul>
<li><strong>依赖缺失</strong>：日志中出现 "Could NOT find XXX" 提示时，需通过包管理器安装对应依赖</li>
<li><strong>语法错误</strong>：<code>CMakeLists.txt</code> 存在语法问题会导致 "Parse error"，可通过 VS Code 内置 CMake 语法高亮定位错误行</li>
<li><strong>路径问题</strong>：包含非 ASCII 字符或空格的项目路径可能引发配置异常，建议使用纯英文路径</li>
</ul>
<p>配置成功后将在 <code>build</code> 目录生成缓存文件（如 <code>CMakeCache.txt</code>），修改 <code>CMakeLists.txt</code> 后需重新执行配置命令更新缓存。</p>
<h3 data-id="heading-7">构建环节：编译优化与多配置管理</h3>
<p>构建操作通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Build</code> 命令触发，关键配置包括：</p>
<ul>
<li><strong>并行任务数设置</strong>：建议配置为 CPU 核心数的 1.5 倍（通过 <code>CMake: Set Build Parallel Level</code> 命令调整），平衡编译速度与系统负载</li>
<li><strong>多配置生成器使用</strong>：对支持多配置的生成器（如 Visual Studio、Xcode），可通过状态栏的构建类型下拉菜单（默认为 Debug）快速切换 Debug/Release/RelWithDebInfo 模式，无需重复配置</li>
</ul>
<h3 data-id="heading-8">调试环节：两种调试模式对比</h3>























<table><thead><tr><th>调试方式</th><th>适用场景</th><th>配置复杂度</th><th>参数传递方式</th></tr></thead><tbody><tr><td>快速调试</td><td>临时调试验证</td><td>低</td><td>不支持自定义参数</td></tr><tr><td>launch.json 配置</td><td>复杂调试场景</td><td>高</td><td>通过 args 字段定义</td></tr></tbody></table>
<p>args 参数传递示例（<code>launch.json</code>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--input"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"data.txt"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--verbose"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">Include 路径设置：自动同步与手动补充</h3>
<p>头文件路径管理采用双重机制确保 IntelliSense 正常工作：</p>
<ul>
<li><strong>自动同步</strong>：CMake 配置过程中会生成 <code>compile_commands.json</code>（需在 <code>CMakeLists.txt</code> 中设置 <code>set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</code>），VS Code 会自动解析该文件同步 include 路径</li>
<li><strong>手动补充</strong>：当自动同步不完整时，可通过 <code>.vscode/c_cpp_properties.json</code> 手动添加路径：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Linux"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"includePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"${workspaceFolder}/**"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/usr/local/include"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"${workspaceFolder}/third_party/include"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"compilerPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/usr/bin/gcc"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c17"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cppStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c++20"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>路径优先级规则：手动配置的 <code>includePath</code> 优先级高于 <code>compile_commands.json</code> 中的路径，存在冲突时以手动配置为准</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">高级特性与定制化方案</h2>
<p>VSCode CMake Tools 的高级特性体系围绕「标准化-精准控制-场景切换」构建，通过三大核心组件解决传统配置模式下的环境一致性、工具链适配与多场景切换难题。</p>
<h3 data-id="heading-11">CMake Presets：层级化配置实现团队协作标准化</h3>
<p>其核心包含：</p>
<ul>
<li><code>configurePresets</code>：定义基础构建环境（如 CMake 版本、生成器类型）</li>
<li><code>buildPresets</code>：继承配置并添加编译参数（如并行任务数）</li>
<li><code>testPresets</code>：专注测试执行策略（如测试超时设置）</li>
</ul>
<p>这种结构化配置可通过版本控制系统共享，确保团队成员使用统一的构建环境，有效消除「在我机器上能运行」的协作障碍。</p>
<h3 data-id="heading-12">工具链管理（Kits）：双轨制适配方案</h3>
<ul>
<li><strong>自动发现模式</strong>：适用于标准开发环境（如桌面端 GCC/Clang），VSCode 会扫描系统路径并识别已安装编译器</li>
<li><strong>手动定义模式</strong>：针对嵌入式开发等特殊场景，支持通过 JSON 配置文件指定交叉编译工具链。例如为 ARM 嵌入式项目配置工具链时，可在 <code>kits.json</code> 中明确定义编译器路径与目标架构：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ARM GCC Embedded"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"C"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-gcc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CXX"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-g++"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cmakeSettings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_NAME"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Generic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_PROCESSOR"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">Variants：YAML 配置实现构建场景动态切换</h3>
<p>核心依赖「filters」和「settings」字段的协同工作。以 Debug/Release 变体为例：</p>
<ul>
<li><code>filters</code> 字段通过正则表达式匹配特定构建类型</li>
<li><code>settings</code> 字段则动态调整对应参数：Debug 变体启用 <code>-O0</code> 优化和 <code>-g</code> 调试符号，Release 变体则采用 <code>-O3</code> 优化并禁用调试信息</li>
</ul>
<p>这种机制支持跨平台开发场景，如 Windows 环境自动关联 MSVC 工具链并启用 <code>/MD</code> 运行时库，Linux 环境则切换至 GCC 并配置 <code>-fPIC</code> 位置无关代码选项，实现同一套代码库在不同操作系统间的无缝构建过渡。</p>
<blockquote>
<p>关键价值：三大特性形成互补闭环——CMake Presets 解决配置标准化问题，Kits 实现工具链精准控制，Variants 则提供场景动态适配能力。在跨平台开发中，可通过组合使用实现「一次配置，多环境构建」，显著提升多平台项目的开发效率。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">最佳实践与效率优化</h2>
<h3 data-id="heading-15">配置管理：精准控制项目构建环境</h3>
<p>CMake 配置过程中，普通 Configure 操作会基于缓存文件 incremental 更新构建系统，而 Clean Configure 则会完全清除缓存并重新生成所有配置数据。当项目中发生 <code>CMakeLists.txt</code> 结构变更（如新增子目录、修改依赖关系、变更编译器设置）时，必须执行 Clean Configure 以避免缓存污染导致的构建异常。在 VS Code 中，可通过命令面板（<code>Ctrl+Shift+P</code>）运行 <code>CMake: Delete Cache and Reconfigure</code> 实现这一操作，确保配置变更被正确应用。</p>
<h3 data-id="heading-16">构建加速：从编译到链接的全流程优化</h3>
<p>构建效率优化需从工具链选择和并行策略两方面着手。Ninja 生成器相比传统 Make 工具具有更高效的依赖解析能力和任务调度机制，在多文件项目中可减少 30%-50% 的构建时间。配置方法是在 CMake 配置时指定生成器类型，通过 <code>settings.json</code> 设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.generator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ninja"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对于 C/C++ 项目，集成 <code>ccache</code> 编译器缓存工具可大幅减少重复编译时间。在 <code>CMakeLists.txt</code> 中添加以下配置启用 ccache：</p>
<pre><code class="hljs language-cmake" lang="cmake">find_program(CCACHE_FOUND ccache)
if(CCACHE_FOUND)
  set(CMAKE_C_COMPILER_LAUNCHER ${CCACHE_FOUND})
  set(CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_FOUND})
endif(CCACHE_FOUND)
</code></pre>
<p>并行构建配置需同时优化 CMake 和生成器层面的任务数。在 <code>settings.json</code> 中设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.parallelJobs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// CMake 配置阶段并行任务数</span>
  <span class="hljs-attr">"cmake.buildArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-j8"</span><span class="hljs-punctuation">]</span>  <span class="hljs-comment">// 传递给 Ninja/Make 的并行构建参数</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>建议根据 CPU 核心数设置并行任务数（通常为核心数的 1-1.5 倍），避免过度并行导致的资源竞争。</p>
<h3 data-id="heading-17">调试验证：确保调试环境与构建目标一致性</h3>
<p>调试配置失败的常见原因为调试程序路径与 CMake 目标输出路径不匹配。验证方法：首先通过 <code>CMake: Build Target</code> 确认目标已成功构建，然后在 <code>launch.json</code> 中检查 <code>"program"</code> 字段是否指向正确的可执行文件路径。对于多配置项目（如 Windows 下的 Debug/Release），需使用变量引用确保路径动态适配：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"setupCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Enable pretty-printing for gdb"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-enable-pretty-printing"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"ignoreFailures"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>其中 <code>${command:cmake.launchTargetPath}</code> 变量会自动解析当前激活目标的输出路径，避免手动维护路径的繁琐和错误。</p>
<h3 data-id="heading-18">IntelliSense 同步：保持代码分析与项目配置一致</h3>
<p>当 CMake 配置变更后（如新增头文件路径、修改宏定义），IntelliSense 可能因缓存未更新导致代码分析异常。手动同步方法：打开命令面板（<code>Ctrl+Shift+P</code>），运行 <code>CMake: Refresh IntelliSense</code> 命令，VS Code 会重新生成 <code>compile_commands.json</code> 并更新 C/C++ 扩展的配置。对于大型项目，可在 <code>settings.json</code> 中启用自动同步：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.autoRefreshIntelliSense"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">跨平台开发：实现多环境一致构建体验</h3>
<p>跨平台项目需通过「工具链文件」统一管理编译器特性、系统库路径等平台相关配置。在项目根目录创建 <code>toolchains</code> 文件夹，为不同平台编写专用工具链文件（如 <code>toolchains/linux-gcc.cmake</code>、<code>toolchains/windows-msvc.cmake</code>），然后在配置时通过命令指定：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.configureArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"-DCMAKE_TOOLCHAIN_FILE=toolchains/linux-gcc.cmake"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>同时，利用 VS Code 的「工作区信任机制」保护项目安全。首次打开项目时，在弹出的「工作区信任」对话框中选择「信任文件夹并启用所有功能」，确保 CMake Tools 能正常访问项目文件和执行构建命令。对于多人协作项目，可通过 <code>settings.json</code> 共享信任配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"security.workspace.trust.untrustedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"open"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>关键提示：跨平台开发中，避免在 <code>CMakeLists.txt</code> 中硬编码平台相关路径（如 <code>/usr/local/lib</code>），应使用 CMake 内置变量（如 <code>${CMAKE_INSTALL_LIBDIR}</code>）和工具链文件抽象平台差异，确保构建脚本的可移植性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">常见问题与解决方案</h2>
<h3 data-id="heading-21">IntelliSense 异常</h3>
<ul>
<li><strong>问题现象</strong>：代码补全失效、语法高亮异常或头文件引用报错。</li>
<li><strong>根本原因</strong>：CMake 配置解析错误或构建缓存过时，导致 IntelliSense 无法正确识别项目结构。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>查看 Output 日志：打开 VS Code 底部状态栏的 Output 面板，切换至 CMake/Build 频道，检查是否存在 <code>CMakeLists.txt</code> 语法错误或依赖缺失提示。</li>
<li>验证项目配置：在 CMAKE: PROJECT OUTLINE 树状视图中，确认源文件与 <code>CMakeLists.txt</code> 的关联是否正确，确保 <code>add_executable</code> 或 <code>target_link_libraries</code> 等指令配置无误。</li>
<li>重建缓存：按下 <code>Ctrl+Shift+P</code> 调出命令面板，执行 <code>CMake: Rebuild CMake Cache</code> 命令刷新配置。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-22">调试配置无效</h3>
<ul>
<li><strong>问题现象</strong>：启动调试后无反应或提示「程序路径不存在」。</li>
<li><strong>根本原因</strong>：<code>launch.json</code> 中 <code>program</code> 路径未正确关联构建产物，或缺少前置构建任务。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>配置 <code>program</code> 路径：在 <code>launch.json</code> 中使用变量 <code>${command:cmake.launchTargetPath}</code> 自动定位当前激活目标的可执行文件路径，避免硬编码绝对路径。</li>
<li>设置 <code>preLaunchTask</code>：添加 <code>"preLaunchTask": "CMake: build"</code> 确保调试前自动构建项目，防止因产物缺失导致启动失败。</li>
<li>验证断点位置：确保断点位于可执行代码行（如 main 函数内），而非注释或空行。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-23">Include 路径错误</h3>
<ul>
<li><strong>问题现象</strong>：编译器提示 <code>fatal error: 'xxx.h' file not found</code>。</li>
<li><strong>根本原因</strong>：头文件搜索路径未被正确添加至 IntelliSense 配置。</li>
<li><strong>解决步骤</strong>：
<ul>
<li><strong>UI 配置法</strong>：打开命令面板，执行 <code>C/C++: Edit Configurations (UI)</code>，在 Include path 中添加头文件所在目录（如 <code>${workspaceFolder}/include</code>）。</li>
<li><strong>手动编辑法</strong>：直接修改 <code>.vscode/c_cpp_properties.json</code>，在 <code>configurations[0].includePath</code> 数组中添加路径，并设置 <code>"compilerPath"</code> 为实际使用的编译器路径（如 <code>C:/MinGW/bin/gcc.exe</code>）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">工具状态异常</h3>
<ul>
<li><strong>问题现象</strong>：CMake 扩展无响应或命令面板中 CMake 相关命令缺失。</li>
<li><strong>根本原因</strong>：扩展缓存损坏或安装文件完整性问题。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>清理缓存：执行命令 <code>CMake: Clear CMake Cache</code> 清除构建缓存，路径通常为 <code>${workspaceFolder}/build/CMakeCache.txt</code>。</li>
<li>重装扩展：在 VS Code 扩展面板中卸载 CMake Tools，重启软件后重新安装最新版本，并确保依赖的 C/C++ Extension Pack 已同步更新。</li>
</ol>
</li>
</ul>
<blockquote>
<p>排查原则：所有问题均需优先检查 Output 日志与项目配置文件，避免盲目操作。对于路径相关错误，建议使用 <code>${workspaceFolder}</code> 等变量确保跨环境兼容性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-25">总结与未来展望</h2>
<p>VSCode CMake Tools 作为连接 CMake 与 VS Code 生态的关键桥梁，通过配置管理、构建执行、调试集成等核心功能模块，有效简化了 C++ 项目的开发流程。其高级特性如 CMake Presets、Kits 和 Variants 支持高度定制化的开发需求，配合最佳实践与问题解决方案，进一步提升了开发效率与项目稳定性。</p>
<h3 data-id="heading-26">未来发展方向</h3>
<ul>
<li>跨平台扩展：增强 WebAssembly 等新兴平台支持</li>
<li>团队协作优化：开发配置共享与同步机制</li>
<li>智能辅助：引入 AI 驱动的 CMake 预设生成功能</li>
</ul>
<p>随着 CMake 标准的持续迭代和社区贡献的深入，VSCode CMake Tools 将继续深化其作为 C++ 开发基础设施的价值，为开发者提供更智能、更高效的集成开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>