<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？]]></title>    <link>https://juejin.cn/post/7571372478803820559</link>    <guid>https://juejin.cn/post/7571372478803820559</guid>    <pubDate>2025-11-12T02:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803820559" data-draft-id="7571280402964922403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-12T02:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:06:17.000Z" title="Wed Nov 12 2025 02:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：代丽 货拉拉/技术中心/质量保障部/履约组</p>
</blockquote>
<p>当一个数据平台的工具量突破3000+、日均调用超50万次，是该庆祝规模化的胜利，还是警惕效率的陷阱？</p>
<p>货拉拉数据工厂就曾站在这样的十字路口——依托高效的"协议编程"架构，我们实现了工具的爆发式增长，却也迎来了用户最真实的抱怨："工具太多选不出""串流程要记半天""新手上手太费劲"。</p>
<p>于是，一场从"平台化"到"AI智能化"的跃迁就此启动。今天，我们就聊聊这场转型背后的痛点、方案与收获。</p>
<h2 data-id="heading-0">一、3k+工具的甜蜜烦恼：高效架构下的使用困局</h2>
<p>在聊转型前，必须先说说支撑我们走到今天的核心底气——"协议编程"架构，简单来说就是：</p>
<blockquote>
<p>工具开发者只需写Java工具类（遵循统一规范），平台通过自研解析引擎自动提取功能描述、输入输出参数等元信息，前端再自动生成可视化界面。</p>
</blockquote>
<p>这个模式的威力有多强？开发者不用管前端交互、权限控制这些"杂事"，专注业务逻辑就行，<strong>工具开发成本直接降低60%以上</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4dbf418904fce8705fb9f3cca9d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=CwN1EYRKuEZUhzLPIf5V%2FU6YhOw%3D" alt="" loading="lazy"/></p>
<p>靠着这套打法，数据工厂迅速成为内部造数的核心基础设施：工具总量突破3k+，日均调用超50万次。但规模上去了，新问题也找上门了，集中在两个核心痛点：</p>
<h3 data-id="heading-1">1. 工具太多，选得发愁</h3>
<p>为了鼓励提效，我们采用"全局核心工具+业务线自定义工具"的运营策略，这就导致很多功能相似的工具并存。比如"账号信息查询"这个简单场景，平台上就有3个主流版本：</p>
<ul>
<li>账号中台：通用版（支持全账户类型）</li>
<li>司机业务线：专属版（仅支持司机账户）</li>
<li>用户业务线：专属版（仅支持用户账户）</li>
</ul>
<p>实际使用中，70%的用户会优先选本业务线工具，导致通用工具复用率不足30%；更糟的是，新用户得花<strong>3分钟对比测试</strong>才能找到合适的工具，提升了使用门槛。</p>
<h3 data-id="heading-2">2. 步骤太繁，操作耗时</h3>
<p>我们的工具大多是"原子化"的，一个工具只干一件事。但真实业务场景往往需要多工具串联，比如"下单并给指定司机流转至完单"这个高频操作，用户得手动走三步：</p>
<ol>
<li>用"获取司机信息"工具查车型</li>
<li>用"下单"工具完成创建</li>
<li>用"订单流转"工具更新状态</li>
</ol>
<p>整个流程平均要5分钟，中间还要手动记结果、切工具，不仅麻烦，还容易出错。</p>
<h2 data-id="heading-3">二、升级目标：让造数像"说话"一样简单</h2>
<p>针对这些痛点，我们明确了AI升级的核心方向：<strong>打造一个能理解自然语言、自主调度工具的智能体（Agent）</strong> ，彻底改变用户与数据工厂的交互方式。</p>
<p>具体来说，就是要实现三个核心能力，让用户从"工具操作者"变成"需求提出者"：</p>
<ul>
<li><strong>精准懂需求</strong>：不用记工具名，用日常话描述需求就行（比如"查一下司机张三的账号信息并履约完单"）</li>
<li><strong>智能配工具</strong>：系统自动选最优工具，多步骤场景自动串联，不用手动组合</li>
<li><strong>自动跑流程</strong>：参数传递、工具调用、结果整合全自动化，直接给最终结果</li>
</ul>
<p>我们的愿景很直接： <strong>"所想即所得，所造皆能成"</strong> 。初期目标更是明确：造数效率提升50%以上，新用户上手时间缩短到1分钟内。</p>
<h2 data-id="heading-4">三、技术方案：AI+数据工厂的三重协同落地</h2>
<h3 data-id="heading-5">3.1 技术决策：从理论最优到落地可行</h3>
<p>智能体的核心技术选型，我们围绕业务特性做了多轮评估。常见的与LLM结合方案有三种：RAG（检索增强生成）、MCP（执行引擎）和Fine-tuning（模型微调）。</p>
<p>从理论上看，Fine-tuning似乎是最优解——数据工厂覆盖货运、小拉出行、国际化等全业务线，沉淀了大量特有领域知识，微调能让模型深度融合这些知识，减少上下文输入量，提升稳定性。</p>
<p>但早期简易尝试后，我们发现了实际障碍：微调需要大量标注数据，且对算法团队的技术能力要求极高，同时持续迭代的成本也难以承受。综合落地难度与效果反馈，我们最终确定了 <strong>“LLM+RAG+MCP”的协同路径</strong>，兼顾效果、成本与落地效率。</p>
<h3 data-id="heading-6">3.2 技术方案：三大模块构筑智能体能力</h3>
<p>我们将智能体拆解为“大脑（LLM）-知识库（RAG）-手脚（MCP）”三个核心模块，分别负责“理解决策”“知识储备”“执行落地”，形成完整工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f66e63fa8b4a7daaa8ba3779f0d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=zN%2BsUd4%2BP4VMhzj13z0lz3lz0os%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2.1 LLM：智能体的“决策大脑”</h4>
<p>LLM是智能体的核心决策层，使用到LLM的共有6处，出于成本与调优效果做了如下组合与配置（精选3个展示）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d498042d0c40f291357121e167093d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=FrB3C63EgMES2AmvEf6YYtYT4MU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2 RAG：智能体的“知识储备库”</h4>
<p>LLM 具备强大的通用能力，但对我们内部 3000 + 工具的具体信息 “一无所知”。若直接输入全量工具信息，会导致上下文过载。因此，我们通过 RAG 技术构建 “精准检索 - 高效赋能” 的知识库体系，助力智能体精准 “认知” 所需工具。</p>
<p>实践中，我们选用 bge_base_zh_1.5 作为 Embedding 模型，以适配中文语义理解场景；同时，为提升检索的精度与全面性，搭建了双层知识库筛选策略，并将其与固定原子工具列表组合，最终形成 toolList给到LLM使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f53877a952443b8546e0d3c8ae4a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=iqw4Ihwf3tHrg38zrItumGLOBvw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>全量工具详情知识库</strong>：数据直接同步平台工具数据库，细分为“线上”“线下”两个子库——线上库对应生产环境工具，线下库对应测试环境工具，避免智能体误调用测试工具影响线上业务，保障执行安全性。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97aa3aebd49240b4ad3ff99c42da5aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=6e%2BriJkIPo57AXC09Ie8kq%2BZi2M%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>自然语言与工具映射知识库</strong>：人工维护多语义映射关系，解决“用户表述≠工具描述”的匹配难题。比如“下单”“开单”“创建订单”等不同说法，均映射到同一工具，大幅提升模糊需求的匹配准确率。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10109254d5fb4aa3ba78f23fe5e012c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=jZll3THBqBe2PxPi4hfBGz7%2FMPA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3 MCP：智能体的“执行手脚”</h4>
<p>工具组合方案确定后，就需要MCP（执行引擎）负责“落地执行”，核心解决“按序执行、参数传递、失败处理、结果解析”四大问题，让智能体“会用”工具。</p>
<p>此处tool仅有一个，功能是单个工具运行，其执行逻辑依赖于prompt，prompt大纲设计：</p>
<ul>
<li><strong>核心任务定位</strong>：按工具序列依次执行，保障前序结果向后续传递，失败自动重试；提取执行结果并匹配用户诉求，用自然语言呈现。</li>
<li><strong>核心执行规则</strong>： - 顺序执行：严格遵循工具列表顺序，前序工具执行成功是后序执行的前提； - 参数关联：动态参数从历史执行结果中自动提取，固定参数保持预设值不变； - 失败处理：执行失败触发重试机制（默认3次），重试失败则终止流程并记录失败状态与原因。</li>
<li><strong>结果解析规范</strong>：根据执行状态码（如ret值）判断成败；成功则筛选核心信息分点呈现，失败则明确标注状态码、失败环节及可能原因，便于用户排查。</li>
</ul>
<h2 data-id="heading-10">四、阶段性成果：上线三月，效率与口碑双丰收</h2>
<p>今年8月AI智能体正式上线，作为内部工具的智能化升级尝试，经过一段时间的推广与迭代，在核心效率指标与用户口碑方面已取得显著成效，验证了升级方向的可行性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be704eafbb134285b0a6eb90522d2dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=W1ynp356ITusJ312zFBXhobXtWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 核心数据：用户渗透良好，效率提升显著</h3>
<p>上线至今，智能体的用户接纳度逐步提升，核心效率指标达到预期目标：</p>
<ul>
<li><strong>用户渗透</strong>：累计吸引500+内部用户使用，涵盖测试、产品、开发等关键技术岗位；</li>
<li><strong>调用表现</strong>：当前支持工具100+，累计调用次数3k+，受限于部分用户使用习惯尚未完全转变和支持工具数量有限，但高频用户的周均调用频次达10次，使用粘性较高；</li>
<li><strong>效率提升</strong>：核心业务场景的造数效率提升效果明显，以“下单并流转至完单”为例，操作时间从原有的5分钟缩短至1.5分钟左右，效率提升70%；</li>
<li><strong>使用门槛</strong>：新用户上手适应时间从原有的3分钟压缩至1分钟内，自然语言交互方式有效降低了工具使用的学习成本；</li>
</ul>
<h3 data-id="heading-12">4.2 用户反馈：跨岗位认可，痛点解决明确</h3>
<p>尽管当前使用规模仍在拓展，但智能体精准解决了用户的核心痛点，获得了实际使用者的广泛认可，积累了不少正面反馈：</p>
<ul>
<li><strong>研发岗位</strong>：“这个太牛了，不用去数据工厂找工具了，研发联调的时候很受用”——某开发反馈；</li>
<li><strong>产岗位</strong>：“说实话，有AI*数据工厂，产品验收轻松多了”——某产品反馈；</li>
<li><strong>测试岗位</strong>：“太好用了，测试经常要批量造数，和它说，它可以一次完成，原来我还得在页面点多次”——某测试反馈。</li>
</ul>
<h3 data-id="heading-13">4.3 成果价值：验证方向，沉淀经验</h3>
<p>此次阶段性成果的核心价值，不仅在于效率数据的提升，更在于验证了“AI+数据工厂”模式的可行性：一方面，通过智能化手段解决了平台规模化后的核心痛点，为后续推广积累了真实使用案例；另一方面，基于用户反馈沉淀了模型调优、交互设计的经验，为进一步提升调用频次、扩大使用范围奠定了基础。</p>
<h2 data-id="heading-14">五、未来规划：在迭代中持续精进</h2>
<p>AI智能体的初步落地验证了方向的可行性，但在实际应用中，我们也发现了需要持续优化的核心痛点。基于当前反馈，后续将聚焦问题解决与能力升级，稳步推进智能化深化。</p>
<h3 data-id="heading-15">5.1 现存核心痛点</h3>
<p>结合用户使用数据与反馈收集，目前主要存在两类待解决的问题，也是后续优化的方向：</p>
<ul>
<li><strong>表述习惯差异导致的适配问题</strong>：不同岗位、不同使用经验的用户，对同一业务场景的表述存在差异。以“小b下单”场景为例，用户可能表述为“小b下单”“货运下单”“APP创建小b订单”等多种形式。尽管当前通过持续丰富RAG知识库已实现问题可控，但知识库更新存在一定后置性，未能从源头减少歧义。</li>
<li><strong>LLM</strong> <strong>上下文过载与幻觉问题</strong>：数据工厂工具覆盖货拉拉货运、小拉出行、国际化等全业务线，为保障LLM对业务场景的理解精度，需在上下文中外挂大量业务知识与工具信息，导致上下文内容过载。这一问题直接引发LLM幻觉现象频发（如工具选错、生成逻辑有误的执行序列等），单纯通过精简上下文内容已难以有效缓解。</li>
</ul>
<h3 data-id="heading-16">5.2 后续优化路径</h3>
<p>针对上述痛点，我们制定了明确的分阶段优化计划，兼顾短期问题解决与长期能力提升：</p>
<h4 data-id="heading-17">1. 前置化引导，降低表述歧义</h4>
<p>为解决表述差异问题，后续将从“后置知识库补充”转向“前置输入引导”。计划在交互界面增加场景化引导模块：基于历史调用数据梳理高频业务场景（如订单创建、账号查询、状态流转等），为每个场景配置标准化话术模板与关键词提示。用户输入时，系统可根据初步语义识别推荐对应场景模板，用户仅需补充关键参数即可完成需求提交，从源头降低歧义表述概率。</p>
<h4 data-id="heading-18"><strong>2. 职责拆分 + 场景固化，从架构层面降低幻觉概率</strong></h4>
<p>针对上下文过载引发的幻觉问题，采用 “现有平台交互改造 + 智能体职责拆分” 双轮驱动策略，具体如下：</p>
<ul>
<li><strong>现有平台交互改造</strong>：将现有平台执行底层升级为智能体执行模式，前端除了结果展示采用智能体输出效果，其他不变。该方式既能适配用户现有使用习惯，又能规避 LLM 动态组装工具带来的幻觉风险。</li>
<li><strong>智能体职责拆分</strong>：当前智能体核心决策依赖 “工具组装” 单一 LLM，导致其同时承载业务知识存储、工具匹配判断、执行序列生成等多重职责。后续将核心职责拆分为 “业务知识解析”“工具匹配筛选”“执行序列生成” 三个独立模块，通过 “轻量化 LLM + 专用 RAG 知识库” 协同实现（如专用 RAG 承载业务知识、独立 LLM 负责工具匹配）。此举可显著降低单个模型的上下文负载，从架构层面减少幻觉发生概率。</li>
</ul>
<h4 data-id="heading-19">3. 长期技术探索：微调路径持续验证</h4>
<p>尽管初期因数据、成本等因素放弃了Fine-tuning方案，但随着业务数据的积累与技术成本的优化，我们将持续小范围验证微调可行性。计划选取高频业务场景（如订单全链路相关工具），构建专属微调数据集，探索“基础模型+场景微调”的混合模式，进一步提升模型对特定场景的理解精度与决策稳定性。</p>
<h3 data-id="heading-20">5.3 转型感悟：AI落地是场长期修行</h3>
<p>在智能体落地过程中，我们深刻体会到：LLM的强大之处在于其泛化能力，但相较于传统工程代码的强可控性，它更像一个“需要持续调教的伙伴”。AI赋能并非一蹴而就，而是循序渐进的迭代过程——既要接受初期的不完美，通过实际场景反馈持续调优；也要保持对新技术的敏感度，及时将成熟的技术方案融入现有体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！]]></title>    <link>https://juejin.cn/post/7571402480967368740</link>    <guid>https://juejin.cn/post/7571402480967368740</guid>    <pubDate>2025-11-12T06:49:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571402480967368740" data-draft-id="7564718467829465088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！"/> <meta itemprop="keywords" content="后端,Java,MyBatis"/> <meta itemprop="datePublished" content="2025-11-12T06:49:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T06:49:38.000Z" title="Wed Nov 12 2025 06:49:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华。这篇文章介绍<code>MyBatis-Plus</code>！</p>
<p><strong>什么是 MyBatis-Plus？</strong></p>
<p>简单来说，<code>MyBatis-Plus</code>是<code>MyBatis</code>的增强工具，在MyBatis的基础上只做增强不做改变，<strong>既能够简化开发，又能够提高效率</strong>！</p>
<p>我们就从最简单的开始吧！只需要几行代码就能搞定常见的 CRUD 操作。</p>
<p>如果你是新手，可以能快速的学习<code>MyBatis-Plus</code>，如果你是有经验的开发，也可以巩固一下相关的内容。</p>
<h3 data-id="heading-0">1. 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在 pom.xml 中添加以下依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 数据库驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok 简化实体类开发 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 替换成你的数据库信息</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/mybatis_plus_demo?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-comment"># 打印 SQL 日志，方便调试</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名自动转换</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-comment"># 逻辑删除配置</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>  <span class="hljs-comment"># 全局逻辑删除的实体字段名</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 逻辑已删除值(默认为 1)</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>    <span class="hljs-comment"># 逻辑未删除值(默认为 0)</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>               <span class="hljs-comment"># 主键ID自增</span>
</code></pre>
<h3 data-id="heading-2">3. 实体类设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("user")</span>  <span class="hljs-comment">// 指定对应的数据库表名</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID - 主键
     * <span class="hljs-doctag">@TableId</span> 注解表示这是主键
     * value = "id" 表示对应数据库字段名
     * type = IdType.AUTO 表示主键自增
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-comment">/**
     * 用户名
     * 如果字段名与数据库列名一致（驼峰转下划线），可以省略 <span class="hljs-doctag">@TableField</span>
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 创建时间
     * <span class="hljs-doctag">@TableField</span> 配置填充策略
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     * 插入和更新时都自动填充
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-comment">/**
     * 逻辑删除字段
     * 0-未删除 1-已删除
     */</span>
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}
</code></pre>
<h3 data-id="heading-3">4. Mapper 接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;

<span class="hljs-comment">/**
 * UserMapper 接口
 * 继承 BaseMapper 就自动拥有了 CRUD 方法
 * 
 * 注意：BaseMapper&lt;User&gt; 中的 User 是实体类类型
 */</span>
<span class="hljs-meta">@Mapper</span>  <span class="hljs-comment">// 一定要加上 @Mapper 注解，Spring 才能扫描到</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; {
    <span class="hljs-comment">// 不需要写任何方法，基本的 CRUD 都已经有了！</span>
    
    <span class="hljs-comment">/**
     * 如果需要自定义SQL，可以这样写
     */</span>
    <span class="hljs-comment">// @Select("SELECT * FROM user WHERE age &gt; #{minAge}")</span>
    <span class="hljs-comment">// List&lt;User&gt; selectUsersByMinAge(@Param("minAge") Integer minAge);</span>
}
</code></pre>
<h3 data-id="heading-4">5. 服务层实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-comment">/**
 * UserService 实现类
 * 
 * 继承 ServiceImpl 就自动拥有了更多的 CRUD 方法
 * 参数说明：
 * - UserMapper：你的 Mapper 接口
 * - User：你的实体类
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    <span class="hljs-comment">// 可以在这里添加自定义的业务方法</span>
    
    <span class="hljs-comment">/**
     * 自定义方法：根据用户名查询用户
     */</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 使用 MP 的查询构造器</span>
        <span class="hljs-keyword">return</span> lambdaQuery()
                .eq(User::getUsername, username)  <span class="hljs-comment">// username = ?</span>
                .one();  <span class="hljs-comment">// 查询一条记录</span>
    }
    
    <span class="hljs-comment">/**
     * 自定义方法：根据邮箱后缀查询用户
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsersByEmailSuffix</span><span class="hljs-params">(String emailSuffix)</span> {
        <span class="hljs-keyword">return</span> lambdaQuery()
                .likeRight(User::getEmail, emailSuffix)  <span class="hljs-comment">// email like 'emailSuffix%'</span>
                .list();
    }
}
</code></pre>
<h3 data-id="heading-5">6. 新增操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 新增用户
     */</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-comment">// 方法1：使用 save 方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.save(user);
        
        <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户成功，用户ID："</span> + user.getId();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户失败"</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量新增用户
     */</span>
    <span class="hljs-meta">@PostMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;User&gt; users)</span> {
        <span class="hljs-comment">// 批量插入，每次插入100条</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveBatch(users, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量新增成功"</span> : <span class="hljs-string">"批量新增失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 新增或更新用户（存在则更新，不存在则新增）
     */</span>
    <span class="hljs-meta">@PostMapping("/save-or-update")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">saveOrUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveOrUpdate(user);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"操作成功"</span> : <span class="hljs-string">"操作失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">7. 查询操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 查询相关操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> userService.getById(id);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户
     */</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.list();
    }
    
    <span class="hljs-comment">/**
     * 条件查询：查询年龄大于18的用户
     */</span>
    <span class="hljs-meta">@GetMapping("/adults")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAdultUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .gt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &gt; 18</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 复杂条件查询：年龄在18-60之间，并且用户名包含"张"
     */</span>
    <span class="hljs-meta">@GetMapping("/complex")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getComplexUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .between(User::getAge, <span class="hljs-number">18</span>, <span class="hljs-number">60</span>)           <span class="hljs-comment">// age between 18 and 60</span>
                .like(User::getUsername, <span class="hljs-string">"张"</span>)           <span class="hljs-comment">// username like '%张%'</span>
                .orderByDesc(User::getAge)               <span class="hljs-comment">// 按年龄降序</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPage</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size)</span> {
        
        <span class="hljs-comment">// 创建分页对象</span>
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-comment">// 执行分页查询</span>
        <span class="hljs-keyword">return</span> userService.page(page);
    }
    
    <span class="hljs-comment">/**
     * 带条件的分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page-with-condition")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPageWithCondition</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size,
            <span class="hljs-meta">@RequestParam(required = false)</span> String keyword)</span> {
        
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .like(StringUtils.isNotBlank(keyword), User::getUsername, keyword)
                .page(page);
    }
}
</code></pre>
<h3 data-id="heading-7">8. 更新操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 更新操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-keyword">if</span> (user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"用户ID不能为空"</span>;
        }
        
        <span class="hljs-comment">// 方法1：根据ID更新所有字段</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(user);
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"更新成功"</span> : <span class="hljs-string">"更新失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件更新：将所有年龄小于18的用户年龄设置为18
     */</span>
    <span class="hljs-meta">@PutMapping("/fix-age")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fixAge</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .lt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &lt; 18</span>
                .set(User::getAge, <span class="hljs-number">18</span>)       <span class="hljs-comment">// 设置 age = 18</span>
                .update();
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"年龄修复成功"</span> : <span class="hljs-string">"年龄修复失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 部分字段更新
     */</span>
    <span class="hljs-meta">@PatchMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">partialUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, 
                                   <span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; updates)</span> {
        <span class="hljs-comment">// 移除不能更新的字段</span>
        updates.remove(<span class="hljs-string">"id"</span>);
        updates.remove(<span class="hljs-string">"createTime"</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(id, updates);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"部分更新成功"</span> : <span class="hljs-string">"部分更新失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">9. 删除操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 删除操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户（逻辑删除）
     */</span>
    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 逻辑删除，实际上执行的是 update 操作，将 deleted 字段设置为 1</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeById(id);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 批量删除
     */</span>
    <span class="hljs-meta">@DeleteMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">batchDeleteUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;Long&gt; ids)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeByIds(ids);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量删除成功"</span> : <span class="hljs-string">"批量删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件删除：删除所有年龄大于100的用户
     */</span>
    <span class="hljs-meta">@DeleteMapping("/old")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteOldUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .gt(User::getAge, <span class="hljs-number">100</span>)       <span class="hljs-comment">// age &gt; 100</span>
                .remove();
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除老年用户成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">高级特性</h2>
<h3 data-id="heading-10">10. 自动填充功能</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自动填充处理器
 * 用于自动填充 createTime 和 updateTime
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    
    <span class="hljs-comment">/**
     * 插入时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 填充创建时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-comment">// 填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
    
    <span class="hljs-comment">/**
     * 更新时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 更新时只填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
}
</code></pre>
<h3 data-id="heading-11">11. 分页插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * MyBatis-Plus 配置类
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.yourpackage.mapper")</span>  <span class="hljs-comment">// 指定Mapper接口的扫描路径</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-comment">/**
     * 分页插件配置
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 分页插件</span>
        <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">paginationInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);
        paginationInterceptor.setMaxLimit(<span class="hljs-number">1000L</span>);  <span class="hljs-comment">// 设置最大单页限制数量</span>
        paginationInterceptor.setOverflow(<span class="hljs-literal">true</span>);   <span class="hljs-comment">// 超出最大页数后回到第一页</span>
        
        interceptor.addInnerInterceptor(paginationInterceptor);
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<h3 data-id="heading-12">12. 乐观锁插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 MybatisPlusConfig 中添加乐观锁插件</span>
<span class="hljs-comment">/**
 * 乐观锁插件配置
 */</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OptimisticLockerInnerInterceptor <span class="hljs-title function_">optimisticLockerInnerInterceptor</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>();
}

<span class="hljs-comment">// 实体类中配置乐观锁字段</span>
<span class="hljs-meta">@Version</span>
<span class="hljs-keyword">private</span> Integer version;
</code></pre>
<h3 data-id="heading-13">13. 谨慎使用场景</h3>
<p><strong>1. 超复杂 SQL 场景</strong></p>
<ul>
<li>涉及大量复杂联表查询</li>
<li>需要高度优化的自定义 SQL</li>
<li>复杂的存储过程调用</li>
</ul>
<p><strong>2. 性能要求极高的场景</strong></p>
<ul>
<li>高并发写入场景</li>
<li>需要精细控制 SQL 执行的场景</li>
</ul>
<p><strong>3. 遗留系统改造</strong></p>
<ul>
<li>已有复杂 MyBatis 配置的项目</li>
<li>数据库设计不符合 MP 规范</li>
</ul>
<h3 data-id="heading-14">14. 不推荐使用场景</h3>
<p><strong>1. JPA 生态重度依赖项目</strong></p>
<ul>
<li>已经深度使用 Spring Data JPA</li>
<li>需要 JPA 的级联操作等特性</li>
</ul>
<p><strong>2. 非关系型数据库</strong></p>
<ul>
<li>MongoDB、Redis 等 NoSQL 数据库</li>
<li>图数据库等特殊存储</li>
</ul>
<h2 data-id="heading-15">最佳实践建议</h2>
<h3 data-id="heading-16">15. 实体类设计规范</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}

<span class="hljs-comment">// 业务实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@TableName("sys_user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">// 数据库字段名与实体类字段名不一致时使用</span>
    <span class="hljs-meta">@TableField("phone_number")</span>
    <span class="hljs-keyword">private</span> String phoneNumber;
    
    <span class="hljs-comment">// 不映射到数据库的字段</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-keyword">private</span> String temporaryCode;
}
</code></pre>
<h3 data-id="heading-17">16. 服务层封装建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 好的服务层封装</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    
    <span class="hljs-comment">/**
     * 业务方法：用户注册
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserRegisterDTO registerDTO)</span> {
        <span class="hljs-comment">// 1. 校验用户名是否已存在</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> lambdaQuery()
                .eq(User::getUsername, registerDTO.getUsername())
                .exists();
        <span class="hljs-keyword">if</span> (exists) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户名已存在"</span>);
        }
        
        <span class="hljs-comment">// 2. DTO 转 Entity</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        BeanUtils.copyProperties(registerDTO, user);
        
        <span class="hljs-comment">// 3. 保存用户</span>
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-comment">/**
     * 安全的更新方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">safeUpdate</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不能为空"</span>);
        }
        
        <span class="hljs-comment">// 只更新非空字段</span>
        <span class="hljs-keyword">return</span> lambdaUpdate()
                .eq(User::getId, user.getId())
                .set(user.getUsername() != <span class="hljs-literal">null</span>, User::getUsername, user.getUsername())
                .set(user.getAge() != <span class="hljs-literal">null</span>, User::getAge, user.getAge())
                .set(user.getEmail() != <span class="hljs-literal">null</span>, User::getEmail, user.getEmail())
                .update();
    }
}
</code></pre>
<h3 data-id="heading-18">17. 异常处理建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 全局异常处理
 */</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleBusinessException(BusinessException e) {
        log.error(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(Result.error(e.getMessage()));
    }
    
    <span class="hljs-comment">/**
     * 处理数据异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(DataAccessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleDataAccessException(DataAccessException e) {
        log.error(<span class="hljs-string">"数据访问异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(Result.error(<span class="hljs-string">"数据操作失败"</span>));
    }
}

<span class="hljs-comment">/**
 * 统一返回结果
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> T data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">200</span>);
        result.setMessage(<span class="hljs-string">"成功"</span>);
        result.setData(data);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">500</span>);
        result.setMessage(message);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p><strong>工具是为人服务的</strong>，选择适合自己项目的技术栈才是最重要的。MyBatis-Plus 在大多数业务场景下都能显著提升开发效率，值得大家深入学习和使用。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-20">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy-GJ26kl0-yT6hE3fy2KjQ" target="_blank" title="https://mp.weixin.qq.com/s/y-GJ26kl0-yT6hE3fy2KjQ" ref="nofollow noopener noreferrer">《MySQL 为什么不推荐用雪花ID 和 UUID 做主键？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1Th3DuMqYpt4Xg5hEywIww" target="_blank" title="https://mp.weixin.qq.com/s/1Th3DuMqYpt4Xg5hEywIww" ref="nofollow noopener noreferrer">《用html写了个超好用的网页主题切换插件》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FaGLep07rnMQdQLyDHBer8Q" target="_blank" title="https://mp.weixin.qq.com/s/aGLep07rnMQdQLyDHBer8Q" ref="nofollow noopener noreferrer">《还在用 WebSocket 做实时通信？SSE 可能更简单》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角]]></title>    <link>https://juejin.cn/post/7571338749198303282</link>    <guid>https://juejin.cn/post/7571338749198303282</guid>    <pubDate>2025-11-12T00:54:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198303282" data-draft-id="7571295102851317786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-12T00:54:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:54:04.000Z" title="Wed Nov 12 2025 00:54:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>现在的世界是越来越魔幻，早就超出了常人的理解范畴。</p>
<p>我最近老刷淘宝，昨天不知哪来的兴致，没什么特定缘由，纯粹好奇当下的相关生态，便鬼使神差在搜索栏敲了 “DeepSeek”。翻了没两下，一家店的标题瞬间抓住了他的眼球 ——“无需部署、打开即用，全程不卡顿”，售价才 10 块钱，付款人数却已经破了 1000。</p>
<p>盯着页面琢磨了半天，越想越纳闷：不用买家本地部署，还能保证立刻响应，这到底是什么神仙操作？</p>
<p>要知道，DeepSeek 的热度虽已过去半年，但直到现在，偶尔还是能见到这玩意儿的身影，甚至可能让人猛地想起当初被它支配的日子。</p>
<p>于是点进去了，这数据还确实挺好的，DeepSeek的需求还是旺。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a209f806f0154bbfb32cc2d7dd9ba25d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=NDkVqg8rQo16YNI0ERxxdKa7dxk%3D" alt="图片" loading="lazy"/></p>
<p>按捺不住满心的好奇，我干脆直接下了单、付了款。</p>
<h2 data-id="heading-1">收到货后</h2>
<p>可等卖家发来所谓的 “产品”，当场就懵了 —— 那瞬间的冲击感，让差点以为自己不小心闯进了平行宇宙，满脑子都是 “这到底是啥？！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f2ae0dc9264087a0122291675f78e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=%2F8SGW97Z2fXHFZZDTt6Goa5g9jk%3D" alt="图片" loading="lazy"/></p>
<p>我第一反应直接懵了：这难道是遇到活菩萨了？居然自己部署了 DeepSeek，还开了公网供大家免费似的用？这算力得有多足啊？</p>
<p>有这资源，哥们儿直接去卖算力不比这 10 块钱一单赚得多？</p>
<p>可等定睛一看，瞬间愣住了 —— 这网址怎么这么眼熟？再仔细瞅了瞅，好家伙，居然是<a href="https://link.juejin.cn?target=https%3A%2F%2Fn.cn%2F" target="_blank" title="https://n.cn/" ref="nofollow noopener noreferrer">n.cn</a>？！</p>
<p>**这不是...360的纳米搜索？？？<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a77e83579646e5ba19dc849c5b140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=HfC4lQjs6JD4y7vk1f7AIloJDp4%3D" alt="图片" loading="lazy"/></p>
<p>我点开另一个网址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88340c9955a44ceca2e324c3e127abdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=r5wsvrq1SIP9YD7QqPsvQwC3Hxo%3D" alt="图片" loading="lazy"/></p>
<p>我一时间无语凝噎，我的大脑宕机了整整10秒钟。我想到了这个事情比较抽象，但是，我没想到能抽象到这种地步。因为，反差感极强，我本来会以为，哥们就卖链接，肯定不少差评，但，事情不太一样了起来。这个评论区，几乎全是好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ec1059d5084f5b85b83a2b5a766179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=j4nNOmXv0cCHDdZ1720j%2BbM%2Femo%3D" alt="图片" loading="lazy"/></p>
<p>甚至有300个88VIP的好评。我一条一条的看了下去，我感觉，这个世界在我的脑中，好像更魔幻，更立体了。有用户留言说，确实不卡，输出的代码很规范。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133b1ffd54194746ba0cd58f44f05fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=MmMvPL9DXnEpNCY3MM1ARye3wIY%3D" alt="图片" loading="lazy"/></p>
<p>“可以啊，是免费的r1，跟描述一致，性价比很高，不用买会员了也。”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c99efd8b8b49968351e3a7fa2096e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=TqbzdKi0xiRUWGwq%2FJt7oOqx2NU%3D" alt="图片" loading="lazy"/></p>
<p>**不用买会员了。我不知道你们是什么感受，我突然鼻子一酸。我看到的，忽然是一个个非常活生生、立体形象的人。</p>
<p>或许对于这些Ta们来说：白天在公司，他得忍着老板的 PUA 强撑着干活，连反驳的底气都没有 —— 这份薪资微薄的工作，是他在四五线小城唯一的糊口依靠。</p>
<p>晚上回到十几平米的出租屋，狭小的空间里塞满了不甘。他太想改变命运了，太怕一辈子困在原地，所以总琢磨着学门新本事，抓住点什么。</p>
<p>AI、大模型、席卷时代的技术革命，这些词像针一样扎着他的心。他知道这是翻身的机会，可每一次听说，都伴随着深深的恐慌 —— 怕自己追不上这股浪潮，怕被时代彻底抛弃。</p>
<p>可真要迈出脚步，才发现前路全是望不到头的坎：官网得靠 “魔法上网” 才能访问，他摸不着门道；会员订阅几十上百块一个月，抵得上他好几天的饭钱，根本舍不得花；那些部署教程里的术语，像天书一样晦涩，硬生生把他挡在门外，连入门的缝隙都不给留。</p>
<p>好不容易扒到 DeepSeek 和 ChatGPT 的官网，他咬碎了牙才掏出不便宜的会员费，以为终于摸到了门槛。可实际用起来，却满是失望 —— 不仅卡顿得让人抓狂，历史记录里还莫名冒出不属于自己的内容，钱花得冤枉又憋屈。</p>
<p>一次次尝试，一次次被现实打回原形。他就像个被遗弃在站台外的人，眼睁睁看着时代的列车呼啸而过，自己却连上车的资格都没有。那种求而不得的无力感，沉甸甸压在胸口，让他喘不过气。</p>
<p>直到那天在淘宝刷到那个 9.9 元的商品，<code>“无需部署”“打开即用”“立刻响应” </code>这几个字，像黑夜里的一束光，瞬间照亮了他的渴望。</p>
<p>他反复看了好几遍商品页面，纠结了很久 —— 兜里的钱每一分都要算计，他怕这又是一场骗局，怕最后连这两顿拼好饭的钱都打了水漂。可对改变的渴望，终究压过了所有顾虑。</p>
<p>下单后，他攥着手机等回复，收到可直接点开的链接时，手指都带着点颤抖。怀着忐忑点进去，居然真的能用，还异常流畅。</p>
<p>那一刻，他紧绷的肩膀突然垮了下来，长长舒了一口气，眼眶甚至有点发热。他觉得自己终于花最少的钱，攥住了那张三寸见方的、通往新世界的船票。</p>
<p><strong>满心欢喜地跑到评论区，他认认真真打下 “性价比很高，不用买会员了”，字里行间全是满足。他甚至偷偷窃喜，觉得自己占了天大的便宜，用 9.9 元就撬动了原本遥不可及的生产力工具。</strong></p>
<p>他把这个链接小心翼翼收进浏览器书签，像珍藏一件稀世珍宝。这是他在残酷生活里，拼尽全力才抓住的小小捷径，是支撑他继续往前走的一点希望。</p>
<p>可他不知道，这份被他视若珍宝的 “机会”，本就明晃晃摊在阳光下，对所有人免费开放。他只是恰好站在了信息的阴影里，没见过那片触手可及的光明，只能靠着这点 “微光”，笨拙又执着地追赶着时代的脚步。</p>
<p><strong>AI的发展，永不止步。</strong> <code>愿所有人都能跟上时代的洪流</code>，用自己信息差打出一片新的天地！</p>
<h3 data-id="heading-2">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 版本发布了，看看有哪些新特性]]></title>    <link>https://juejin.cn/post/7572010680896274472</link>    <guid>https://juejin.cn/post/7572010680896274472</guid>    <pubDate>2025-11-13T10:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896274472" data-draft-id="7571815997068001320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38 版本发布了，看看有哪些新特性"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-13T10:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个写不完程序的猿"/> <meta itemprop="url" content="https://juejin.cn/user/4055446188735672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38 版本发布了，看看有哪些新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4055446188735672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个写不完程序的猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:06:17.000Z" title="Thu Nov 13 2025 10:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<p>欢迎回到我们定期发布的季度版本 Flutter 3.38。本次更新旨在通过点简写和 Widget 预览的更新来提升您的开发效率并优化开发者体验。感谢社区的贡献，本次版本共包含来自 145 位贡献者的 825 次提交，其中 37 位是首次贡献者。让我们深入了解一下本次版本更新的内容。</p>
<h2 data-id="heading-1">Dot shorthands</h2>
<p>编写更简洁的 Dart 代码！我们很高兴地宣布 Dart 的一项新特性——<strong>点简写</strong>！简写允许您省略 Dart 可以推断的类型，从而减少样板代码。</p>
<p>例如，你可以使用简写<code>.start</code>来代替<code>MainAxisAlignment.start</code>。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: .start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: .center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* ... */</span> ], 
), 

<span class="hljs-comment">// 不使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: MainAxisAlignment.start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: CrossAxisAlignment.center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* … */</span> ], 
),
</code></pre>
<p>这同样适用于命名构造函数！你可以<code>.all</code>这样写<code>EdgeInsets.all</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">填充（
  填充：.全部（<span class="hljs-number">8.0</span>），
  子元素：文本（<span class="hljs-string">'Hello world'</span>），
），
</code></pre>
<p>Dart 3.10 和 Flutter 3.38 默认启用此功能。更多信息，请查看dart.dev 上的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.dev%2Flanguage%2Fdot-shorthands" target="_blank" title="https://dart.dev/language/dot-shorthands" ref="nofollow noopener noreferrer">dot 简写页面。您还可以在</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dart.dev%2Fea8b952b6088" target="_blank" title="https://blog.dart.dev/ea8b952b6088" ref="nofollow noopener noreferrer">Dart 3.10 发布博</a>文中了解更多相关内容（例如 Dart hooks！）。</p>
<h2 data-id="heading-2">web</h2>
<h3 data-id="heading-3">Web 开发配置文件</h3>
<p>该<code>flutter run</code>命令现在支持 Web 设置配置文件。您可以在<code>web_dev_config.yaml</code>项目根目录的文件中指定主机、端口、证书和标头信息。将该文件检入，以便团队中的每个人都能使用相同的设置进行调试。有关更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">“设置 Web 开发配置文件”</a>。</p>
<h3 data-id="heading-4">Web 开发代理设置</h3>
<p>除了现有的命令行参数外，Web 开发配置文件还支持新的代理设置。代理设置允许将对已配置路径的请求转发到另一台服务器。这使得开发能够连接到同一主机上动态端点的 Web 客户端变得更加容易。</p>
<p>有关代理设置的详细信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">设置 Web 开发配置文件</a>。</p>
<h3 data-id="heading-5">扩展了对网页热重载的支持</h3>
<p>现在，当您在浏览器中打开 Flutter 应用的链接并运行该应用时，状态热重载功能默认启用<code>-d web-server</code>。即使同时连接多个浏览器，此功能也能正常工作。</p>
<p>与之前一样<code>-d chrome</code>，此功能可以使用标志暂时禁用<code>--no-web-experimental-hot-reload</code>。禁用此功能的功能将在未来的版本中移除，因此，如果您在开发流程中遇到问题，请使用 Dart 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdart-lang%2Fsdk%2Fissues%2Fnew%3Ftemplate%3D5_web_hot_reload.yml" target="_blank" title="https://github.com/dart-lang/sdk/issues/new?template=5_web_hot_reload.yml" ref="nofollow noopener noreferrer">Web 热重载问题模板</a>提交错误报告。更多信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fbuilding%23hot-reload-web" target="_blank" title="https://docs.flutter.dev/platform-integration/web/building#hot-reload-web" ref="nofollow noopener noreferrer">Web 热重载文档</a>。</p>
<h2 data-id="heading-6">框架</h2>
<p>此版本包含框架中的许多强大的新功能和改进，使开发人员能够对高级 UI、导航和平台交互进行更精细的控制。</p>
<p>现在，开发者在使用 <code>Overlay.of</code> 创建弹出窗口、对话框和其他浮动 UI 元素时拥有了更大的控制权<code>OverlayPortal</code>。现在可以<code>Overlay</code>使用 <code>Overlay.of</code> 在组件树的任何上级组件中渲染子组件<code>OverlayPortal.overlayChildLayoutBuilder</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174239" target="_blank" title="https://github.com/flutter/flutter/pull/174239" ref="nofollow noopener noreferrer">#174239</a>），从而更轻松地显示应用范围的通知或其他需要突破父组件布局限制的 UI。底层 <code>Overlay.of</code> 方法也得到了增强，变得更加健壮高效（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174315" target="_blank" title="https://github.com/flutter/flutter/pull/174315" ref="nofollow noopener noreferrer">#174315</a>）。</p>
<p>为了提供更现代化的 Android 导航体验，预测性返回路径过渡效果现已默认启用<code>MaterialApp</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173860" target="_blank" title="https://github.com/flutter/flutter/pull/173860" ref="nofollow noopener noreferrer">#173860</a>）。当用户执行返回手势时，当前路径会以动画形式消失，同时用户会看到主屏幕的预览。此外，默认页面过渡效果也已更新，以<code>FadeForwardsPageTransitionsBuilder</code>反映<code>ZoomPageTransitionsBuilder</code>原生应用的行为。</p>
<p>此次版本更新还深化了桌面集成。在 Windows 系统上，开发者现在可以访问已连接显示器的列表，并查询每个显示器的详细属性，例如分辨率、刷新率和物理尺寸（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164460" target="_blank" title="https://github.com/flutter/flutter/pull/164460" ref="nofollow noopener noreferrer">#164460</a>）。这使得创建具有复杂窗口管理功能的应用程序成为可能。</p>
<p>最后，框架本身的容错性也得到了提升。组件生命周期回调中发生的错误（例如 <code>get_errors( </code>didUpdateWidget<code>)</code>）现在能够得到更优雅的处理，从而避免在元素树中引发级联故障（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173148" target="_blank" title="https://github.com/flutter/flutter/pull/173148" ref="nofollow noopener noreferrer">#173148</a>）。此外，<code>get_errors()</code> 也正确实现了相等性判断，确保相同的提供程序得到相同的处理，<code>ResizeImage</code>从而使图像缓存和比较更加可预测（ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer">#172643</a>）。<code>ResizeImage</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer"/></p>
<p>在网页上，UI 的优化仍在继续，修复了<code>RSuperellipse</code>当圆角半径大于小部件本身时出现的渲染错误（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172254" target="_blank" title="https://github.com/flutter/flutter/pull/172254" ref="nofollow noopener noreferrer">#172254</a>），现在，这种情况将被处理，以按预期生成药丸形状。</p>
<p>对于国际用户而言，检测浏览器首选语言环境的功能现在更加强大。引擎现在使用标准<code>Intl.Locale</code>Web API 来解析浏览器语言，取代了之前手动且较为脆弱的实现方式（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172964" target="_blank" title="https://github.com/flutter/flutter/pull/172964" ref="nofollow noopener noreferrer">#172964</a>）。这一改进带来了更可靠的语言环境检测，并为全球用户提供了更佳的体验。</p>
<p>一个特定于 Android 系统的漏洞（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171973" target="_blank" title="https://github.com/flutter/flutter/pull/171973" ref="nofollow noopener noreferrer">#171973</a>）已修复，该漏洞主要影响配备硬件键盘的三星设备。此前，用户与文本框交互后<code>TextField</code>，Android 输入法编辑器 (IME) 可能会卡在“过期”状态。这会导致 IME 错误地拦截“回车”或“空格”键的按下，从而阻止非文本控件（例如文本框<code>Checkbox</code>或<code>Radio</code>按钮）接收到事件。此修​​复程序确保<code>InputMethodManager</code>在文本连接关闭时正确重置 IME，清除其“过期”状态，并恢复用户可预期的硬件键盘交互。</p>
<h3 data-id="heading-7">材料和库比蒂诺更新</h3>
<p>Material 和 Cupertino 库持续发展，专注于 API 的一致性和优化的用户体验。此次版本更新带来了重要的 API 迁移、全新的组件功能以及诸多改进，让构建美观实用的用户界面变得更加轻松。</p>
<p>基于已弃用的旧版本<code>MaterialState</code>，本次版本继续推进内部向更统一的版本的迁移。这提供了一种一致且富有表现力的方式来定义控件在不同交互状态（例如按下、悬停或禁用）下<code>WidgetState</code>的外观，并且无需对现有应用进行任何更改。此次迁移已应用于多种控件及其主题，包括<code>IconButton</code>、、和（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer">#173893</a>）。新的 API 还增强了功能和灵活性；例如，现在包含一个属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer">#169821</a>），允许以编程方式控制其视觉状态，从而为更自定义和交互式的设计打开了大门。<code>ElevatedButton``Checkbox``Switch</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer"/><code>IconButton``statesController</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer"/></p>
<p>此次版本更新还引入了几个新特性和便捷的 API。<code>Badge.count</code>构造函数现在包含一个<code>maxCount</code>参数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171054" target="_blank" title="https://github.com/flutter/flutter/pull/171054" ref="nofollow noopener noreferrer">#171054</a>），可以轻松限制显示的数量（例如，显示“99+”而不是“100”）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36e56f6e7e457eb1916f4886662e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=AIY9Kg%2BHsadiaQhvm3JyzoOwcyg%3D" alt="" loading="lazy"/></p>
<p>为了实现更精细的手势控制，该<code>InkWell</code>小部件现在具有<code>onLongPressUp</code>回调功能（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173221" target="_blank" title="https://github.com/flutter/flutter/pull/173221" ref="nofollow noopener noreferrer">#173221</a>），可用于触发仅在用户抬起手指时才应完成的操作。</p>
<p>Cupertino 库也在不断努力提升其 iOS 兼容性。<code>CupertinoSlidingSegmentedControl</code>新增了一个<code>isMomentary</code>属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164262" target="_blank" title="https://github.com/flutter/flutter/pull/164262" ref="nofollow noopener noreferrer">#164262</a>），允许控件在不保持选中状态的情况下触发操作。为了更好地匹配原生 iOS 的行为，该控件<code>CupertinoSheet</code>在完全展开状态下向上拖动时，现在会呈现微妙的“拉伸”效果（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F168547" target="_blank" title="https://github.com/flutter/flutter/pull/168547" ref="nofollow noopener noreferrer">#168547</a>）。</p>
<p>最后，本次版本更新包含多项改进，优化了核心组件的行为。亮点包括修复了<code>DropdownMenuFormField</code>表单重置时正确清除文本字段的问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174937" target="_blank" title="https://github.com/flutter/flutter/pull/174937" ref="nofollow noopener noreferrer">#174937</a>），以及更新了组件以<code>SegmentedButton</code>改进焦点处理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173953" target="_blank" title="https://github.com/flutter/flutter/pull/173953" ref="nofollow noopener noreferrer">#173953</a>）并确保其边框能够正确反映组件的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172754" target="_blank" title="https://github.com/flutter/flutter/pull/172754" ref="nofollow noopener noreferrer">#172754</a>）。</p>
<h3 data-id="heading-8">解耦 Material and Cupertino</h3>
<p>我们一直在进行大量的规划工作，旨在将 Material 和 Cupertino 库与框架解耦。以下列表包含了围绕近期发布的一些设计文档展开的讨论。</p>
<p><strong>改进 flutter/packages 的发布流程，解耦后将包含 Material 和 Cupertino。</strong></p>
<ul>
<li>状态：已决定</li>
<li>思路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fu%2F1%2Fd%2F18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY%2Fedit" target="_blank" title="https://docs.google.com/document/u/1/d/18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY/edit" ref="nofollow noopener noreferrer">第一方软件包发布策略</a></li>
<li>决定：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s/edit?tab=t.0" ref="nofollow noopener noreferrer">批量发布单页说明（公开共享）</a></li>
</ul>
<p><strong>颜色和点阵速记</strong></p>
<ul>
<li>状态：已决定</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ%2Fedit%3Ftab%3Dt.0%23heading%3Dh.pub7jnop54q0" target="_blank" title="https://docs.google.com/document/d/1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ/edit?tab=t.0#heading=h.pub7jnop54q0" ref="nofollow noopener noreferrer">Flutter 基础配色方案（公开分享）</a></li>
</ul>
<p><strong>解耦测试</strong></p>
<ul>
<li>状态：进行中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs/edit?tab=t.0" ref="nofollow noopener noreferrer">解耦框架测试（公开共享）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F177028" target="_blank" title="https://github.com/flutter/flutter/issues/177028" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
</ul>
<p><strong>文本</strong></p>
<ul>
<li>状态：讨论中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY/edit?tab=t.0" ref="nofollow noopener noreferrer">Flutter 将设计与文本解耦（公开分享）</a></li>
</ul>
<h3 data-id="heading-9">滚动：更稳健、更可预测的条形滚动</h3>
<p>此版本带来了一系列修复，使得构建复杂的滚动布局（尤其是使用<code>SliverMainAxisGroup</code>和的布局<code>SliverCrossAxisGroup</code>）更加稳健和可预测。</p>
<p>使用这些组件将多个 Sliver 分组的开发者会发现，手势处理现在更加可靠。现在可以正确计算这些组内 Sliver 的点击和其他指针事件的命中测试，确保用户交互按预期运行（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174265" target="_blank" title="https://github.com/flutter/flutter/pull/174265" ref="nofollow noopener noreferrer">#174265</a>）。</p>
<p>其他几项修复也使得滚动行为更加准确<code>SliverMainAxisGroup</code>。使用固定标题时过度滚动的问题已得到解决（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173349" target="_blank" title="https://github.com/flutter/flutter/pull/173349" ref="nofollow noopener noreferrer">#173349</a>），调用<code>showOnScreen</code>显示小片段现在可以正常工作（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171339" target="_blank" title="https://github.com/flutter/flutter/pull/171339" ref="nofollow noopener noreferrer">#171339</a>），并且内部滚动偏移计算更加精确（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174369" target="_blank" title="https://github.com/flutter/flutter/pull/174369" ref="nofollow noopener noreferrer">#174369</a>）。</p>
<p>对于构建自定义滚动视图的开发者来说，新的<code>SliverGrid.list</code>构造函数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173925" target="_blank" title="https://github.com/flutter/flutter/pull/173925" ref="nofollow noopener noreferrer">#173925</a>）提供了一种更简洁的方式，可以从简单的子列表创建网格。</p>
<p>此次更新还改进了复杂布局中键盘和方向键用户的焦点导航体验。在具有不同滚动轴的嵌套滚动视图（例如水平轮播图的垂直列表）中，方向性焦点导航现在更加可预测，防止焦点在不同部分之间意外跳转（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172875" target="_blank" title="https://github.com/flutter/flutter/pull/172875" ref="nofollow noopener noreferrer">#172875</a>）。</p>
<h3 data-id="heading-10">无障碍设计：为所有用户提供更具包容性的体验</h3>
<p>确保所有用户都能访问应用程序是 Flutter 框架的基石。此次版本更新延续了这一承诺，赋予开发者更多程序控制权，改善了国际用户的体验，并优化了核心组件的可访问性。</p>
<p>对于构建复杂应用程序的开发者而言，此版本引入了在 iOS 上默认启用辅助功能的功能<code>WidgetsFlutterBinding.instance.ensureSemantics</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174163" target="_blank" title="https://github.com/flutter/flutter/pull/174163" ref="nofollow noopener noreferrer">#174163</a><code>debugDumpSemanticsTree</code> ）。此外，由于新增了文本输入验证结果信息，有助于更快地诊断问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174677" target="_blank" title="https://github.com/flutter/flutter/pull/174677" ref="nofollow noopener noreferrer">#174677</a> ），因此调试辅助功能问题也变得更加容易。</p>
<p>为了增强基于 Sliver 的滚动视图的辅助功能，我们新增了一个<code>SliverSemantics</code>组件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F167300" target="_blank" title="https://github.com/flutter/flutter/pull/167300" ref="nofollow noopener noreferrer">#167300</a>）。与现有组件类似，开发者可以在滚动视图中<code>Semantics</code>使用该组件，为 Sliver 树的各个部分添加特定的语义信息。这对于标注标题、分配语义角色以及为屏幕阅读器添加描述性标签尤为有用，从而为用户提供更易于理解和访问的体验。<code>SliverSemantics``CustomScrollView</code></p>
<p>最后，核心组件的辅助功能持续改进。<code>CupertinoExpansionTile</code>现在默认情况下可访问（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174480" target="_blank" title="https://github.com/flutter/flutter/pull/174480" ref="nofollow noopener noreferrer">#174480</a>），并且该<code>AutoComplete</code>组件现在会向用户播报搜索结果的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173480" target="_blank" title="https://github.com/flutter/flutter/pull/173480" ref="nofollow noopener noreferrer">#173480</a>）。其他改进，例如增大触摸目标<code>TimePicker</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F170060" target="_blank" title="https://github.com/flutter/flutter/pull/170060" ref="nofollow noopener noreferrer">#170060</a>），也有助于提供更便捷的开箱即用体验。</p>
<h2 data-id="heading-11">iOS</h2>
<p>我们很高兴地确认，Flutter 完全支持最新的平台版本：iOS 26、Xcode 26 和 macOS 26，这些版本均于 9 月发布。这确保您可以立即在 Apple 最新的操作系统和工具上开始开发和测试您的应用。</p>
<p>您可能已经注意到，Flutter 最新版本为 iOS 开发者带来了显著的体验提升，解决了用户长期以来的一个痛点：在物理设备上运行 Flutter 应用时，Xcode 应用必须自动启动<code>flutter run</code>。我们引入了一种新的部署方式，使用 Xcode 26 命令行工具 <code>npm run </code>devicectl<code>dev</code> 来进行应用的安装、启动和调试。这种方式无需在部署过程中调用 Xcode 应用，大多数情况下完全依赖于命令行 Xcode 构建工具。如果您遇到任何问题，可以使用 <code>npm run dev</code> 禁用此部署方式<code>flutter config --no-enable-lldb-debugging</code>，并请<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">提交 issue</a>告知我们！</p>
<p>此前，此功能依赖于 Xcode 自动化，但在 Xcode 26 中变得不稳定且容易出错，尤其是在连续运行命令时。如果您现在正在为最新的 Apple 版本进行开发，我们强烈建议您将 Flutter 版本更新到 3.38 或更高版本。</p>
<h3 data-id="heading-12">UIScene 生命周期迁移</h3>
<p>Flutter 3.38 包含了对苹果强制要求的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ftechnotes%2Ftn3187-migrating-to-the-uikit-scene-based-life-cycle" target="_blank" title="https://developer.apple.com/documentation/technotes/tn3187-migrating-to-the-uikit-scene-based-life-cycle" ref="nofollow noopener noreferrer">UIScene 生命周期</a>的重要支持。这是继苹果在 WWDC25 上宣布“在 iOS 26 之后的版本中，任何使用最新 SDK 构建的 UIKit 应用都必须使用 UIScene 生命周期，否则将无法启动”之后的一项关键且积极的更新。</p>
<p>为确保您的 iOS Flutter 应用程序在未来的 iOS 版本上保持兼容性并成功启动，需要进行迁移。</p>
<p><strong>迁移 Flutter 应用程序</strong></p>
<p>所有现有的 iOS Flutter 应用都必须迁移到新的生命周期。您可以通过两种方式完成此迁移：</p>
<ol>
<li>手动迁移：请按照 Flutter<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-apps" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-apps" ref="nofollow noopener noreferrer">网站</a>上提供的手动迁移说明进行操作。</li>
<li>自动迁移（实验性功能）：启用此实验性功能可自动处理迁移。此功能将在未来的版本中默认启用。运行以下命令：</li>
</ol>
<p><code>flutter config --enable-uiscene-migration</code></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fplans%3Fsource%3Dupgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" target="_blank" title="https://medium.com/plans?source=upgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d130648ca14f57b12f161cbe22a35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=hLwCNkBRffP8UU%2BRs0bp8Vt4SWs%3D" alt="成为会员" loading="lazy"/></a></p>
<p><strong>迁移 Flutter 插件</strong></p>
<p>依赖应用程序生命周期事件的 Flutter 插件必须更新为使用 UIScene 生命周期事件。插件开发者应参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-plugins" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-plugins" ref="nofollow noopener noreferrer">迁移指南</a>。未迁移的插件将在未来的版本中显示警告。</p>
<p><strong>迁移嵌入式 Flutter（可选）</strong></p>
<p>对于将 Flutter 嵌入原生宿主应用程序的项目，迁移是可选的，但强烈建议进行。使用“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-adding-flutter-to-existing-app-add-to-app" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-adding-flutter-to-existing-app-add-to-app" ref="nofollow noopener noreferrer">添加到应用程序迁移指南”</a>采用 Flutter 新的 UIScene API ，可以为您的插件启用场景生命周期事件，从而确保与 Flutter 生态系统的兼容性。</p>
<h2 data-id="heading-13">安卓</h2>
<h3 data-id="heading-14">16KB页面大小兼容性</h3>
<p>升级到 Flutter 3.38 是满足<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fpractices%2Fpage-sizes" target="_blank" title="https://developer.android.com/guide/practices/page-sizes" ref="nofollow noopener noreferrer">Google Play 16 KB 页面大小兼容性要求</a>的必要准备。从<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid-developers.googleblog.com%2F2025%2F05%2Fprepare-play-apps-for-devices-with-16kb-page-size.html" target="_blank" title="https://android-developers.googleblog.com/2025/05/prepare-play-apps-for-devices-with-16kb-page-size.html" ref="nofollow noopener noreferrer">2025 年 11 月 1 日</a>起，面向 Android 15 及更高版本的应用必须支持 16 KB 页面。此项变更可确保您的应用在高内存设备上正常运行，并带来性能提升，例如启动速度提升高达 30%。Flutter 3.38 将默认的 Android ndkVersion 更新为 NDK r28，这是原生代码实现 16 KB 页面大小支持的最低要求。</p>
<h3 data-id="heading-15">内存修复</h3>
<p>Flutter 3.38<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173770" target="_blank" title="https://github.com/flutter/flutter/issues/173770" ref="nofollow noopener noreferrer">修复了</a>一个影响所有 Android 平台 Flutter 应用的严重内存泄漏问题。该问题（在 3.29.0 版本中引入）发生在 Activity 在退出时被销毁的情况下，无论是开发者设置中配置的销毁方式，还是由于内存不足而被系统强制终止的 Activity。</p>
<h3 data-id="heading-16">Android 依赖项更新</h3>
<p>为您的应用找到合适的 Android 依赖项版本组合通常是一项挑战，这些依赖项包括 Gradle、Android Gradle 插件 (AGP)、Kotlin Gradle 插件 (KGP)、Java 等。对于 Flutter 3.38 版本，我们在持续集成 (CI) 环境中测试并确认了以下 Android 依赖项版本组合的兼容性：</p>
<ul>
<li><strong>Java 17</strong>：Flutter 3.38 中 Android 开发的最低版本要求。</li>
<li><strong>KGP 2.2.20</strong>：该工具<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">支持的最高Kotlin Gradle 插件版本。</a></li>
<li><strong>AGP 8.11.1</strong>：最新的 Android Gradle 插件版本，与 KGP 2.2.20<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">兼容。</a></li>
<li><strong>Gradle 8.14</strong>：此版本与所选的 Java、KGP 和 AGP 版本兼容。请注意，AGP 8.11.1 的最低版本要求为 Gradle 8.13。</li>
</ul>
<p>为了确保您的应用能够在不同的 Flutter 版本之间无缝运行，我们强烈建议您在构建文件中使用 Flutter SDK 提供的 API 级别变量。此版本配置的值如下：</p>
<ul>
<li><code>flutter.compileSdkVersion</code>（API 36）</li>
<li><code>flutter.targetSdkVersion</code>（API 36）</li>
<li><code>flutter.minSdkVersion</code>（API 24）或更高</li>
</ul>
<h2 data-id="heading-17">引擎</h2>
<h3 data-id="heading-18">性能叠加层</h3>
<p>性能叠加层已重构，效率更高，在 Skia 和 Impeller 后端上的渲​​染时间均有所缩短。这意味着您可以以更少的开销获得更准确的性能数据。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176364" target="_blank" title="https://github.com/flutter/flutter/pull/176364" ref="nofollow noopener noreferrer">#176364</a>）</p>
<h3 data-id="heading-19"><strong>Vulkan 和 OpenGL ES</strong></h3>
<p>对 Vulkan 和 OpenGL ES 后端的诸多修复和改进提高了在更广泛设备上的稳定性和性能。这包括更好地处理管线缓存（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176322" target="_blank" title="https://github.com/flutter/flutter/pull/176322" ref="nofollow noopener noreferrer">#176322</a>）、栅栏等待器（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173085" target="_blank" title="https://github.com/flutter/flutter/pull/173085" ref="nofollow noopener noreferrer">#173085</a>）和图像布局过渡（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173884" target="_blank" title="https://github.com/flutter/flutter/pull/173884" ref="nofollow noopener noreferrer">#173884</a>）。</p>
<h3 data-id="heading-20"><strong>渲染器统一</strong></h3>
<p>CanvasKit 和 Skwasm 渲染器的统一工作仍在继续。本次版本更新包含大量重构，以在两者之间共享更多代码，这将带来更一致的用户体验，并加快未来的开发速度（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174588" target="_blank" title="https://github.com/flutter/flutter/pull/174588" ref="nofollow noopener noreferrer">#174588</a>）。</p>
<h3 data-id="heading-21">线程合并</h3>
<p>iOS 和 Android 系统中已移除选择退出线程合并的功能。欲了解更多信息，请观看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DmiW7vCmQwnw" target="_blank" title="https://www.youtube.com/watch?v=miW7vCmQwnw" ref="nofollow noopener noreferrer">精彩的线程合并</a>视频。</p>
<h2 data-id="heading-22">开发者工具和集成开发环境</h2>
<h3 data-id="heading-23">实验性小部件预览 — 更新</h3>
<p>Flutter 3.35 引入了 Widget Previews（组件预览），这是一项实验性功能，旨在收集社区的早期反馈。Flutter 3.38 版本对 Widget Previews 进行了重大改进，包括：</p>
<ul>
<li><strong>IDE 集成</strong>：我们的 VSCode 和 IntelliJ/Android Studio 插件均已更新，初步支持 Widget 预览。现在，您可以直接在 IDE 中查看预览，从而获得更流畅的开发体验。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eddd9325a394e5abc299424e8482928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xfueeJ5rK3Rqbb3w5tpXhWW6rbg%3D" alt="" loading="lazy"/></p>
<p><em>VSCode 中嵌入了小部件预览。</em></p>
<p>在集成开发环境 (IDE) 中使用时，控件预览环境默认配置为根据当前选定的源文件筛选显示的预览：</p>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5523ec1be60e4007882e555de4dfec75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=1Tkpqux%2BBqbL1BzaaGM0GWdk1KA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>小部件预览环境主题和控件改进</strong>：小部件预览环境现在支持浅色和深色模式，以及自定义 IDE 配色方案，以匹配您的开发环境。小部件预览环境中的控件也进行了调整，以减少占用空间，从而为渲染预览腾出更多空间。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81af1c5cbc2144c9b758ba4d9111c12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=7VtppMMTLvx0%2FW8GyEq23oz9qLQ%3D" alt="" loading="lazy"/></p>
<p><em>为小部件预览环境提供自定义主题支持。</em></p>
<ul>
<li><strong>预览可扩展性</strong>：预览注解类不再标记为 final，现在可以扩展以创建自定义预览注解，从而减少常见预览类型的样板代码。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a887ce18185646bda685fc093e14c702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=c3rdsqe%2Fe33VUb5Ef%2F8SekvnXNA%3D" alt="" loading="lazy"/></p>
<p><em>自定义注解示例</em><code>BrightnessPreview</code> <em>。</em></p>
<ul>
<li><strong>多预览支持</strong>：新增的<code>MultiPreview</code>基类允许从单个自定义注释创建多个预览变体。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71472db634af4b63af1710fe1ab1d720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=4hpx%2BTpAupZ7lNoEpgI7XLPOehA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>预览组</strong>：类中的新分组参数<code>Preview</code>允许对相关的预览进行分组。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db78dfe644d94c439cf4b617d44b6df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xHQKUC6laoqz16%2FDUA7xgfy%2FVrM%3D" alt="" loading="lazy"/></p>
<p><em>预览组中多个“亮度”预览的示例。</em></p>
<ul>
<li><strong>放宽了对 @Preview 注解参数的限制</strong>：现在支持将私有常量作为<code>Preview</code>注解的参数。函数参数（例如 wrapper 和 theme）仍然需要具有公开的、静态可访问的名称。</li>
</ul>
<p>小部件预览功能目前仍处于实验阶段，您的反馈对塑造其未来至关重要。API 和用户体验尚不稳定，我们会根据您的反馈不断改进。</p>
<p>根据早期反馈，我们计划进行更多改进以提升组件预览体验，包括：</p>
<ol>
<li><strong>Flutter DevTools Widget Inspector 支持</strong>：Widget Inspector 正在更新，以支持在 widget 预览环境中检查预览效果。我们计划将检查器直接嵌入到 widget 预览器中，使其无论您处于何种开发环境都能轻松访问。</li>
<li><strong>IDE中的多项目支持</strong>：目前，组件预览器仅支持显示单个项目或Pub工作区内的预览。我们正在积极研究如何支持在IDE会话中包含多个Flutter项目的方案（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173550" target="_blank" title="https://github.com/flutter/flutter/issues/173550" ref="nofollow noopener noreferrer">问题#173550</a>）。</li>
<li><strong>提升启动性能</strong>：我们正在研究提升启动性能的机会，以缩短初始启动时间，包括：</li>
</ol>
<ul>
<li>首次运行后启动预编译的组件预览环境</li>
<li>并行化预览检测逻辑以更好地处理大型项目</li>
</ul>
<p>首先，请查看文档，然后告诉我们您的想法！</p>
<ul>
<li><strong>阅读文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Ftools%2Fwidget-previewer" target="_blank" title="https://docs.flutter.dev/tools/widget-previewer" ref="nofollow noopener noreferrer">Flutter Widget 预览（实验性功能）入门指南</a></li>
<li><strong>提供反馈：在</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">Flutter GitHub 存储库</a>中提交问题和功能请求。</li>
<li><strong>了解更多</strong>：如需深入了解技术细节，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2Fgo%2Fwidget-previews-architecture" target="_blank" title="https://flutter.dev/go/widget-previews-architecture" ref="nofollow noopener noreferrer">Flutter Widget Previews 架构文档</a>。</li>
</ul>
<p><em><strong>重要提示</strong></em> <em>：已知 Widget Previewer 在执行某些操作后可能会崩溃或停止更新</em><code>flutter pub get</code> <em>。如果遇到此问题，请</em><code>flutter pub get</code><em>在项目中运行相关命令并重启 IDE。</em> <em>详情请参阅</em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F178317" target="_blank" title="https://github.com/flutter/flutter/issues/178317" ref="nofollow noopener noreferrer"> <em>#178317 。</em></a>**</p>
<h3 data-id="heading-24">开发者工具更新</h3>
<p>Flutter 3.38 修复了 2025 年 DevTools 用户调查中用户指出的一些主要痛点，包括：</p>
<p><strong>网络面板改进</strong></p>
<ul>
<li>使用户更容易了解面板何时正在记录网络流量。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9495" target="_blank" title="https://github.com/flutter/devtools/pull/9495" ref="nofollow noopener noreferrer">#9495</a>）</li>
<li>修复了复制粘贴网络请求相关的问题。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9472" target="_blank" title="https://github.com/flutter/devtools/pull/9472" ref="nofollow noopener noreferrer">#9472</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9482" target="_blank" title="https://github.com/flutter/devtools/pull/9482" ref="nofollow noopener noreferrer">#9482</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9485" target="_blank" title="https://github.com/flutter/devtools/pull/9485" ref="nofollow noopener noreferrer">#9485</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter-intellij%2Fpull%2F8588" target="_blank" title="https://github.com/flutter/flutter-intellij/pull/8588" ref="nofollow noopener noreferrer">#8588</a>）</li>
</ul>
<p><strong>Flutter Inspector 修复</strong></p>
<ul>
<li>修复了选择控件时有时会打开底层框架源代码而不是用户源代码的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176530" target="_blank" title="https://github.com/flutter/flutter/pull/176530" ref="nofollow noopener noreferrer">#176530</a>）</li>
<li>修复了偶尔会导致无法与检查器面板顶部按钮进行交互的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9327" target="_blank" title="https://github.com/flutter/devtools/pull/9327" ref="nofollow noopener noreferrer">#9327</a>）</li>
</ul>
<h2 data-id="heading-25">弃用和重大变更</h2>
<p>作为 Flutter 框架现代化和改进工作的一部分，本次版本更新包含了几个重要的弃用项和重大变更。</p>
<p>关键的构建和工具变更可能会影响自定义构建脚本。Flutter <code>version</code>SDK 根目录下的文件已被移除，取而代之的是位于 [<code>flutter.version.json</code>此处应填写路径] 的新文件<code>bin/cache</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172793" target="_blank" title="https://github.com/flutter/flutter/pull/172793" ref="nofollow noopener noreferrer">#172793</a>）。此外，该<code>AssetManifest.json</code>文件不再默认生成（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172594" target="_blank" title="https://github.com/flutter/flutter/pull/172594" ref="nofollow noopener noreferrer">#172594</a>）。</p>
<p>其他显著变化包括：</p>
<ul>
<li>为了使行为更可预测，包含操作的 SnackBar 将不再自动关闭（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173084" target="_blank" title="https://github.com/flutter/flutter/pull/173084" ref="nofollow noopener noreferrer">#173084</a>）。</li>
<li>构造函数<code>OverlayPortal.targetsRootOverlay</code>已被弃用，取而代之的是更灵活的<code>OverlayPortal</code>（<code>overlayLocation: OverlayChildLocation.rootOverlay</code>）。</li>
<li>的几个属性<code>CupertinoDynamicColor</code>，例如<code>withAlpha</code>和<code>withOpacity</code>，现在已被弃用，取而代之的是标准<code>Color</code>方法（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171160" target="_blank" title="https://github.com/flutter/flutter/pull/171160" ref="nofollow noopener noreferrer">#171160</a>）。</li>
<li>Flutter 3.38 要求 Android 的最低 Java 版本为 17，与<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fcompatibility.html" target="_blank" title="https://docs.gradle.org/current/userguide/compatibility.html" ref="nofollow noopener noreferrer">Gradle 8.14</a>（2025 年 7 月发布）的最低要求一致。</li>
</ul>
<p>有关这些变更和其他变更的更多详细信息和迁移指南，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes" target="_blank" title="https://docs.flutter.dev/release/breaking-changes" ref="nofollow noopener noreferrer">重大变更页面</a>。</p>
<h2 data-id="heading-26">结尾</h2>
<p>Flutter 3.38 改动还是挺多的， 要升级的还得等等看看，避免在生产环境使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求详解与实战]]></title>    <link>https://juejin.cn/post/7572021695293980722</link>    <guid>https://juejin.cn/post/7572021695293980722</guid>    <pubDate>2025-11-13T10:10:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293980722" data-draft-id="7572016447804555290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求详解与实战"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-13T10:10:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:10:29.000Z" title="Thu Nov 13 2025 10:10:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，<strong>网页与服务器的数据交互</strong>已经成为核心功能之一。<br/>
而支撑这一功能的技术之一，正是 <strong>Ajax（Asynchronous JavaScript and XML）</strong> 。<br/>
今天我们就来系统了解一下 Ajax 的工作原理、请求流程以及一个完整的示例。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p><strong>Ajax</strong> 全称是 <strong>异步 JavaScript 和 XML</strong>，<br/>
中文意思是“异步的 JavaScript 与 XML”。</p>
<p>虽然名字里有 XML，但如今开发中我们更多使用 <strong>JSON</strong> 格式来传输数据。<br/>
它最大的特点是：<strong>在不刷新页面的情况下与服务器通信，动态更新网页内容。</strong></p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>Ajax 的实现依赖浏览器内置的一个对象：<code>XMLHttpRequest</code>（简称 XHR）。<br/>
通过这个对象，我们可以主动发起 HTTP 请求并接收响应。</p>
<p>流程如下：</p>
<ol>
<li>
<p><strong>创建请求对象</strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>配置请求信息</strong></p>
<pre><code class="hljs language-python" lang="python">xhr.<span class="hljs-built_in">open</span>(method, url, <span class="hljs-keyword">async</span>);
</code></pre>
<ul>
<li><code>method</code>：请求方式（如 <code>GET</code>、<code>POST</code>）</li>
<li><code>url</code>：目标接口地址</li>
<li><code>async</code>：是否异步（<code>true</code> 为异步，<code>false</code> 为同步）</li>
</ul>
</li>
<li>
<p><strong>发送请求</strong></p>
<pre><code class="hljs language-ini" lang="ini">xhr.send()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>监听请求状态变化</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xhr.onreadystatechange</span> = function() {
    if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
        const <span class="hljs-attr">data</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
        console.log(data)<span class="hljs-comment">;</span>
    }
}<span class="hljs-comment">;</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、readyState 状态说明</h2>
<p>在 Ajax 请求过程中，<code>readyState</code> 表示请求的不同阶段：</p>



































<table><thead><tr><th>状态码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>初始化</td><td>请求未初始化</td></tr><tr><td>1</td><td>打开</td><td>已调用 <code>open()</code>，还未发送</td></tr><tr><td>2</td><td>发送</td><td>已发送请求，接收到响应头</td></tr><tr><td>3</td><td>接收</td><td>正在接收服务器数据</td></tr><tr><td>4</td><td>完成</td><td>请求完成，已接收到全部响应数据</td></tr></tbody></table>
<p>同时要注意：</p>
<ul>
<li><code>xhr.status</code> 表示 HTTP 响应状态（例如 <code>200</code> 表示成功）。</li>
<li><code>xhr.responseText</code> 是服务器返回的字符串数据。</li>
</ul>
<hr/>
<h2 data-id="heading-3">四、实战示例：请求 GitHub 数据</h2>
<p>下面是一个完整的 Ajax 请求示例，用来获取 GitHub 上某组织的成员数据：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Ajax 数据请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 1. 创建 XMLHttpRequest 对象</span>
        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

        <span class="hljs-comment">// 2. 打开请求 (异步)</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 3. 监听状态变化</span>
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-comment">// 4. 解析 JSON 数据</span>
                <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

                <span class="hljs-comment">// 5. 渲染到页面</span>
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members'</span>).<span class="hljs-property">innerHTML</span> =
                    data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
            }
        };

        <span class="hljs-comment">// 6. 发送请求</span>
        xhr.<span class="hljs-title function_">send</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>执行后，浏览器会在控制台打印出返回的数据，同时在网页中显示成员列表。</p>
<hr/>
<h2 data-id="heading-4">五、同步与异步的区别</h2>
<ul>
<li><strong>同步请求（async = false）</strong> ：<br/>
浏览器会等待服务器响应后再执行后续代码，页面会“卡住”。</li>
<li><strong>异步请求（async = true）</strong> ：<br/>
浏览器不会等待，能继续执行后续代码，响应回来后再触发回调函数。<br/>
—— 这正是 Ajax 的核心优势所在。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、现代替代方案：Fetch 与 Axios</h2>
<p>如今，在实际开发中，我们更常用以下方式：</p>
<ul>
<li><strong>Fetch API</strong>：更简洁现代的异步请求方式。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; console.log(data))
  .catch(<span class="hljs-attr">err</span> =&gt; console.error(err))<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">🧩 七、小结</h2>





























<table><thead><tr><th>要点</th><th>内容</th></tr></thead><tbody><tr><td>Ajax 全称</td><td>异步 JavaScript 和 XML</td></tr><tr><td>核心对象</td><td>XMLHttpRequest</td></tr><tr><td>关键方法</td><td><code>open()</code>、<code>send()</code>、<code>onreadystatechange</code></td></tr><tr><td>常用属性</td><td><code>readyState</code>、<code>status</code>、<code>responseText</code></td></tr><tr><td>主要用途</td><td>实现网页的动态数据加载，不刷新页面即可更新内容</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">✅ 结语</h3>
<p>Ajax 是前端与服务器通信的基础技术之一。<br/>
理解其底层原理不仅能帮助你更好地使用 <code>fetch</code>，<br/>
更能让你彻底理解<strong>浏览器异步通信机制</strong>的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新MCP规范解读，看这篇就够了！]]></title>    <link>https://juejin.cn/post/7571456639477006346</link>    <guid>https://juejin.cn/post/7571456639477006346</guid>    <pubDate>2025-11-12T07:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571456639477006346" data-draft-id="7571416207972499506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新MCP规范解读，看这篇就够了！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新MCP规范解读，看这篇就够了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:59:53.000Z" title="Wed Nov 12 2025 07:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP是什么? 为什么需要它?</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67c9ad979a2434989229286027f7185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539193&amp;x-signature=AvWJDuUolC0sslAql0%2FE8bjN4jg%3D" alt="" loading="lazy"/><br/>
想象一下，你正在开发一个 AI 编程助手，它需要:</p>
<ul>
<li>读取和修改项目文件</li>
<li>查询数据库Schema</li>
<li>搜索代码仓库</li>
<li>执行Git操作</li>
</ul>
<p>传统做法是为每个数据源写一套专用代码，不同团队重复造轮子。<strong>Model Context Protocol(MCP)</strong> 就是为了解决这个问题而生的开放标准协议。</p>
<p><strong>通俗理解</strong>: MCP就像是「AI应用的USB接口标准」。就像USB让不同设备都能接入电脑一样，MCP让不同的数据源和工具都能以统一方式接入AI应用。</p>
<p><strong>实际案例</strong>: 在Claude Desktop中，你可以配置多个官方MCP服务器:</p>
<ul>
<li><strong>Filesystem服务器</strong>: 安全地读写本地文件，有权限控制</li>
<li><strong>SQLite服务器</strong>: 查询和分析SQLite数据库，自动生成SQL</li>
<li><strong>GitHub服务器</strong>: 搜索仓库、创建Issue、管理PR</li>
</ul>
<p>你的AI应用只需实现一个MCP客户端，就能连接所有服务器，无需为每个服务器写专用代码。</p>
<h2 data-id="heading-1">二、架构设计： 三个角色的分工</h2>
<p>MCP采用<strong>宿主-客户端-服务器</strong>三层架构，就像一家公司的组织结构:</p>
<p><strong>宿主(Host)</strong> = 总经理</p>
<ul>
<li>管理所有客户端</li>
<li>控制安全策略和权限</li>
<li>负责AI模型的调用</li>
</ul>
<p><strong>客户端(Client)</strong> = 部门经理</p>
<ul>
<li>客户端负责连接服务器</li>
<li>负责双方的沟通协调</li>
<li>转发消息和通知</li>
</ul>
<p><strong>服务器(Server)</strong> = 业务专员</p>
<ul>
<li>提供具体功能(资源、工具、提示模板)</li>
<li>可以是本地程序或远程服务</li>
<li>不知道其他服务器的存在</li>
</ul>
<h2 data-id="heading-2">三、协议约定：统一规范与个性化扩展</h2>
<p><strong>每个MCP服务器提供的工具、资源都不一样，但它们都遵循相同的MCP协议规范。</strong></p>
<h3 data-id="heading-3">3.1 协议的分层设计</h3>
<p>MCP采用 <strong>基础协议 + 功能扩展</strong> 的设计，就像HTTP协议一样:</p>
<p><strong>核心层(所有实现必须支持)</strong> :</p>
<ul>
<li>JSON-RPC 2.0消息格式</li>
<li>初始化握手流程(initialize/initialized)</li>
<li>基本错误处理</li>
</ul>
<p><strong>功能层(按需选择)</strong> :</p>
<ul>
<li>Resources、Prompts、Tools(服务器端)</li>
<li>Roots、Sampling、Elicitation(客户端)</li>
</ul>
<p><strong>这样设计的好处</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">统一的基础协议 → 保证互操作性
<span class="hljs-bullet">     +</span>
灵活的功能选择 → 满足不同场景需求
<span class="hljs-code">     ↓
既标准化又可扩展
</span></code></pre>
<h3 data-id="heading-4">3.2 协议约定的过程</h3>
<p><strong>步骤1: 基础协议是固定的</strong><br/>
所有MCP服务器和客户端都遵循相同的JSON-RPC 2.0格式:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 请求格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 必须是2.0</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"方法名"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 要调用的方法</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 参数对象</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 响应格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 对应请求的ID</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 成功结果</span>
  <span class="hljs-comment">// 或 "error": {...}    // 错误信息</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 能力在初始化时协商</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端发起初始化</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 我支持LLM采样</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>           <span class="hljs-comment">// 我支持根目录</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyClient"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 我提供工具</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>       <span class="hljs-comment">// 我提供资源</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLiteServer"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>协商完成后，双方都知道对方支持什么功能，<strong>只使用交集部分</strong>。</p>
<p><strong>步骤3: 方法名称是标准化的</strong><br/>
MCP规范定义了标准方法名:</p>








































<table><thead><tr><th>功能</th><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>列出资源</td><td><code>resources/list</code></td><td>固定方法名</td></tr><tr><td>读取资源</td><td><code>resources/read</code></td><td>固定方法名</td></tr><tr><td>列出工具</td><td><code>tools/list</code></td><td>固定方法名</td></tr><tr><td>调用工具</td><td><code>tools/call</code></td><td>固定方法名</td></tr><tr><td>列出提示</td><td><code>prompts/list</code></td><td>固定方法名</td></tr><tr><td>获取提示</td><td><code>prompts/get</code></td><td>固定方法名</td></tr></tbody></table>
<p><strong>步骤4: 具体内容是个性化的</strong><br/>
虽然方法名固定，但每个服务器返回的<strong>具体数据</strong>不同:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// SQLite服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行SQL查询"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_tables"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"列出所有表"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// Filesystem服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"write_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_files"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索文件"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.3 协议发现机制</h3>
<p>客户端如何知道服务器有哪些工具?</p>
<p><strong>第一步：列举</strong></p>
<pre><code class="hljs language-css" lang="css">客户端 → 服务器: {"method": <span class="hljs-string">"tools/list"</span>}
服务器 → 客户端: {
  "tools": [
    {
      "name": <span class="hljs-string">"query"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
      <span class="hljs-string">"inputSchema"</span>: {           // JSON Schema定义输入格式
        "type": <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          "sql": {"type": <span class="hljs-string">"string"</span>}
        }
      }
    }
  ]
}
</code></pre>
<p><strong>第二步：调用</strong></p>
<pre><code class="hljs language-json" lang="json">客户端 → 服务器<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 使用第一步获得的工具名</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SELECT * FROM users"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点</strong>:通过JSON Schema，客户端知道如何正确调用工具，无需硬编码。</p>
<h2 data-id="heading-6">四、协议基础：如何通信?</h2>
<p>MCP基于JSON-RPC 2.0构建，这是一个成熟的远程过程调用协议。理解这一层对掌握MCP至关重要。</p>
<h3 data-id="heading-7">4.1 JSON-RPC 2.0基础</h3>
<p><strong>消息类型</strong></p>
<p>MCP中有三种基本消息类型。<br/>
<strong>1. 请求(Request)</strong> - 期待响应</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,           <span class="hljs-regexp">//</span> 协议版本,必须是<span class="hljs-string">"2.0"</span>
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,                     <span class="hljs-regexp">//</span> 请求唯一标识(字符串或数字)
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>,     <span class="hljs-regexp">//</span> 要调用的方法名
  <span class="hljs-string">"params"</span>: {                  <span class="hljs-regexp">//</span> 可选的参数对象
    <span class="hljs-string">"cursor"</span>: <span class="hljs-string">"page2"</span>
  }
}
</code></pre>
<p><strong>2. 响应(Response)</strong> - 对请求的回复</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 成功响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 必须与请求的id相同</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行查询"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 错误响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 错误对象</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32602</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 错误码(整数)</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数无效"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 错误描述</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 可选的额外信息</span>
      <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cursor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式错误"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 通知(Notification)</strong> - 单向消息,无需响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/resources/updated"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 通知方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                                   <span class="hljs-comment">// 通知参数</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/data.json"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// 注意:没有id字段</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>标准错误码</strong></p>
<p>MCP使用JSON-RPC 2.0的标准错误码:</p>








































<table><thead><tr><th>错误码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>-32700</td><td>Parse error</td><td>JSON解析错误</td></tr><tr><td>-32600</td><td>Invalid Request</td><td>无效的请求格式</td></tr><tr><td>-32601</td><td>Method not found</td><td>方法不存在</td></tr><tr><td>-32602</td><td>Invalid params</td><td>参数无效</td></tr><tr><td>-32603</td><td>Internal error</td><td>服务器内部错误</td></tr><tr><td>-32002</td><td>Resource not found</td><td>资源未找到(MCP扩展)</td></tr></tbody></table>
<h3 data-id="heading-8">4.2 能力协商详解</h3>
<p>能力协商是MCP连接建立的第一步，决定了整个会话中可用的功能。</p>
<p><strong>初始化流程详解</strong></p>
<p><strong>阶段1: 客户端发起初始化</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 客户端支持的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 客户端能力声明</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持根目录</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持根目录变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 支持LLM采样</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 支持用户询问</span>
      <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 实验性功能</span>
        <span class="hljs-attr">"customFeature"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>            <span class="hljs-comment">// 自定义功能</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 客户端信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAIApp"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 程序名(必填)</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 版本号(必填)</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的AI应用"</span>             <span class="hljs-comment">// 显示名称(可选)</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段2: 服务器响应能力</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 服务器选择的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 服务器能力声明</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 支持资源</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 支持资源订阅</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持资源列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持工具</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                     <span class="hljs-comment">// 支持提示模板</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>           <span class="hljs-comment">// 不支持列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>                    <span class="hljs-comment">// 支持日志输出</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.1.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLite MCP服务器"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"instructions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此服务器提供SQLite数据库访问能力"</span>  <span class="hljs-comment">// 可选的使用说明</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段3: 客户端确认就绪</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/initialized"</span>  <span class="hljs-comment">// 无id,这是通知</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>协议版本协商规则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">客户端请求版本: <span class="hljs-string">"2024-11-05"</span>
         ↓
    服务器支持?
    ↙        ↘
  支持        不支持
   ↓            ↓
返回相同版本  返回服务器支持的最新版本
   ↓            ↓
协商成功    客户端检查是否支持
              ↙        ↘
           支持        不支持
            ↓            ↓
         协商成功     断开连接
</code></pre>
<p><strong>实际示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 场景1: 版本匹配</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  ✅ 成功

<span class="hljs-comment">// 场景2: 服务器版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-06-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果不支持则断开

<span class="hljs-comment">// 场景3: 客户端版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果支持则降级使用
</code></pre>
<p><strong>能力交集计算</strong></p>
<p>初始化后,双方只能使用<strong>共同支持的能力</strong>:</p>
<pre><code class="hljs language-css" lang="css">客户端能力: {roots, sampling, elicitation}
服务器能力: {resources, tools, prompts}
         ↓
   可用功能集合
   ├─ 客户端 → 服务器: resources, tools, prompts
   └─ 服务器 → 客户端: roots, sampling, elicitation
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 客户端代码示例</span>
<span class="hljs-keyword">if</span> server_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"tools"</span>):
    <span class="hljs-meta"># 服务器支持工具,可以调用</span>
    tools = <span class="hljs-keyword">await</span> session.list_tools()
<span class="hljs-keyword">else</span>:
    <span class="hljs-meta"># 服务器不支持工具,跳过</span>
    print(<span class="hljs-string">"服务器不提供工具功能"</span>)

<span class="hljs-keyword">if</span> client_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sampling"</span>):
    <span class="hljs-meta"># 客户端支持采样,服务器可以请求</span>
    <span class="hljs-meta"># (服务器端会检查这个能力)</span>
    pass
</code></pre>
<h3 data-id="heading-9">4.3 连接生命周期深入</h3>
<p><strong>完整的消息时序图</strong></p>
<pre><code class="hljs language-scss" lang="scss">客户端                                            服务器
  │                                              │
  │  <span class="hljs-number">1</span>. initialize (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">2</span>. initialize (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">3</span>. initialized (通知)                        │ 
  ├──────────────────────────────────────&gt;│
  │                                              │
  │═══════════ 正常操作阶段 ════════════        │
  │                                              │
  │  <span class="hljs-number">4</span>. tools/list (请求)                         │
  ├──────────────────────────────────────&gt;│
  │                                              │
  │  <span class="hljs-number">5</span>. tools/list (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {tools: [...]}                           │
  │                                              │
  │  <span class="hljs-number">6</span>. tools/call (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {name: <span class="hljs-string">"query"</span>, arguments: {...}}        │
  │                                              │
  │  <span class="hljs-number">7</span>. notifications/progress (通知)             │
  │&lt;──────────────────────────────────────┤
  │     {progress: <span class="hljs-number">50</span>, total: <span class="hljs-number">100</span>}               │
  │                                              │
  │  <span class="hljs-number">8</span>. tools/call (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {<span class="hljs-attribute">content</span>: [...]}                         │
  │                                              │
  │  <span class="hljs-number">9</span>. notifications/resources/updated          │
  │&lt;──────────────────────────────────────┤
  │     {uri: <span class="hljs-string">"file://..."</span>}                      │
  │                                              │
  │═══════════ 关闭阶段 ═══════════           │
  │                                              │
  │  <span class="hljs-number">10</span>. 关闭stdin                               │
  ├─────────────X                             │
  │                                             │
  │                                          服务器退出
</code></pre>
<p><strong>初始化前的限制</strong></p>
<p>在<code>initialized</code>通知发送前:</p>
<p><strong>客户端只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>请求</li>
<li>✅ <code>ping</code>请求(用于保活)</li>
<li>❌ 其他任何请求</li>
</ul>
<p><strong>服务器只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>响应</li>
<li>✅ <code>ping</code>请求</li>
<li>✅ <code>logging</code>通知(日志)</li>
<li>❌ 其他任何消息</li>
</ul>
<p><strong>违反限制的后果</strong>:</p>
<pre><code class="hljs language-css" lang="css">// 客户端在初始化前调用tools/list
请求: {"method": <span class="hljs-string">"tools/list"</span>}
响应: {
  "error": {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32600</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"会话未初始化"</span>
  }
}
</code></pre>
<p><strong>超时和重试机制</strong></p>
<p><strong>请求超时</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 设置30秒超时</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-keyword">await</span> asyncio.wait_for(
        session.call_tool(<span class="hljs-string">"slow_operation"</span>, {}),
        timeout=<span class="hljs-number">30.0</span>
    )
<span class="hljs-keyword">except</span> asyncio.TimeoutError:
    <span class="hljs-comment"># 发送取消通知</span>
    <span class="hljs-keyword">await</span> session.send_notification(
        <span class="hljs-string">"notifications/cancelled"</span>,
        {<span class="hljs-string">"requestId"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"reason"</span>: <span class="hljs-string">"超时"</span>}
    )
</code></pre>
<p><strong>进度通知重置超时</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 当收到进度通知时,可以重置超时计时器</span>
<span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># 基础超时</span>
<span class="hljs-attr">max_timeout</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># 最大超时(5分钟)</span>

while True:
    try:
        <span class="hljs-attr">msg</span> = await wait_for_message(timeout)
        if <span class="hljs-attr">msg.method</span> == <span class="hljs-string">"notifications/progress"</span>:
            <span class="hljs-comment"># 收到进度,重置超时</span>
            <span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>
    except TimeoutError:
        <span class="hljs-comment"># 超时处理</span>
        break
</code></pre>
<h3 data-id="heading-10">4.4 传输方式对比</h3>
<p><strong>stdio传输详解</strong></p>
<p><strong>优点</strong>:</p>
<ul>
<li>✅ 简单直接,适合本地开发</li>
<li>✅ 进程隔离,安全性好</li>
<li>✅ 自动管理生命周期</li>
<li>✅ 无需网络配置</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>❌ 只能本地使用</li>
<li>❌ 不支持多客户端</li>
<li>❌ 调试相对困难</li>
</ul>
<p><strong>消息格式</strong>:</p>
<pre><code class="hljs">消息1\n
消息2\n
消息3\n
</code></pre>
<p>每个JSON对象占一行,以<code>\n</code>分隔。</p>
<p><strong>HTTP传输详解</strong></p>
<p><strong>架构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────┐         HTTP POST         ┌─────────┐
│         ├──────────────────────────&gt;│         │
│ 客户端  │  请求/通知/响应(JSON-RPC) │ 服务器  │
│         │&lt;──────────────────────────┤         │
└─────────┘     HTTP 响应/SSE流       └─────────┘
             (application/json 或
              text/event-stream)
</code></pre>
<p><strong>发送消息(POST)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash">POST /mcp HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Accept: application/json, text/event-stream
Mcp-Session-Id: abc123

{<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:1,<span class="hljs-string">"method"</span>:<span class="hljs-string">"tools/list"</span>}
</code></pre>
<p><strong>立即响应(JSON)</strong> :</p>
<pre><code class="hljs language-css" lang="css">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content</span>-Type: application/json

{"jsonrpc":<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{"tools":[...]}}
</code></pre>
<p><strong>流式响应(SSE)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
Content-Type: <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123

<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">25</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">2</span>  
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">50</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">3</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{<span class="hljs-string">"content"</span>:[...]}}
</code></pre>
<p><strong>接收服务器消息(GET)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> localhost:<span class="hljs-number">8080</span>
<span class="hljs-symbol">Accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123
Last-<span class="hljs-keyword">Event</span>-ID: <span class="hljs-number">42</span>
</code></pre>
<p><strong>会话管理</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端设置会话ID</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/mcp"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_mcp</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"initialize"</span>:
        session_id = generate_session_id()
        <span class="hljs-keyword">return</span> Response(
            content=json.dumps(result),
            headers={<span class="hljs-string">"Mcp-Session-Id"</span>: session_id}
        )

<span class="hljs-comment"># 客户端后续请求携带会话ID</span>
<span class="hljs-meta">@client.request</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">method, params</span>):
    headers = {}
    <span class="hljs-keyword">if</span> self.session_id:
        headers[<span class="hljs-string">"Mcp-Session-Id"</span>] = self.session_id
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> http.post(
        <span class="hljs-string">"/mcp"</span>,
        json={<span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-string">"method"</span>: method, <span class="hljs-string">"params"</span>: params},
        headers=headers
    )
</code></pre>
<p><strong>断线重连</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_sse</span>(<span class="hljs-params">last_event_id=<span class="hljs-literal">None</span></span>):
    headers = {<span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>}
    <span class="hljs-keyword">if</span> last_event_id:
        headers[<span class="hljs-string">"Last-Event-ID"</span>] = last_event_id
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.stream(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/mcp"</span>, headers=headers) <span class="hljs-keyword">as</span> stream:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stream.aiter_lines():
            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">"id:"</span>):
                last_event_id = line[<span class="hljs-number">3</span>:].strip()
            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">"data:"</span>):
                data = json.loads(line[<span class="hljs-number">5</span>:])
                <span class="hljs-keyword">yield</span> data, last_event_id
</code></pre>
<h3 data-id="heading-11">4.5 实际通信示例</h3>
<p>让我们看一个完整的SQLite查询场景:</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">1</span>. 列出工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>
}

服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    "tools": [
      {
        "name": <span class="hljs-string">"query"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
        <span class="hljs-string">"inputSchema"</span>: {
          "type": <span class="hljs-string">"object"</span>,
          <span class="hljs-string">"properties"</span>: {
            "sql": {"type": <span class="hljs-string">"string"</span>}
          },
          "required": [<span class="hljs-string">"sql"</span>]
        }
      }
    ]
  }
}

// <span class="hljs-number">2</span>. 调用查询工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/call"</span>,
  <span class="hljs-string">"params"</span>: {
    "name": <span class="hljs-string">"query"</span>,
    <span class="hljs-string">"arguments"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>
    },
    "_meta": {
      "progressToken": <span class="hljs-string">"query-123"</span>  // 请求进度通知
    }
  }
}

// <span class="hljs-number">3</span>. 服务器发送进度(异步通知)
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"notifications/progress"</span>,
  <span class="hljs-string">"params"</span>: {
    "progressToken": <span class="hljs-string">"query-123"</span>,
    <span class="hljs-string">"progress"</span>: <span class="hljs-number">50</span>,
    <span class="hljs-string">"total"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在扫描users表..."</span>
  }
}

// <span class="hljs-number">4</span>. 返回查询结果
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    "<span class="hljs-attribute">content</span>": [
      {
        "type": <span class="hljs-string">"text"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"查询结果: 1,234个活跃用户"</span>
      }
    ],
    "isError": false
  }
}

// <span class="hljs-number">5</span>. 如果查询出错
服务器 → 客户端(错误情况):
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"error"</span>: {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32603</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"SQL语法错误"</span>,
    <span class="hljs-string">"data"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>,
      <span class="hljs-string">"error"</span>: <span class="hljs-string">"near "</span>WHERE<span class="hljs-string">": syntax error"</span>,
      <span class="hljs-string">"position"</span>: <span class="hljs-number">35</span>
    }
  }
}
</code></pre>
<p>这就是MCP通信的完整过程!通过JSON-RPC 2.0，客户端和服务器可以进行结构化、类型安全的通信。</p>
<h2 data-id="heading-12">五、服务器能力：三种核心功能</h2>
<p>MCP服务器可以提供三种功能。</p>
<h3 data-id="heading-13">5.1 Resources(资源)：应用决定用什么</h3>
<p><strong>资源就是数据</strong>，比如文件内容、数据库记录、API响应。</p>
<p><strong>谁控制</strong>: 应用程序决定把哪些资源提供给AI</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出所有可用资源</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 读取某个资源</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/read"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/main.py"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>资源URI示例</strong>:</p>
<ul>
<li><code>file:///project/src/main.py</code> - 文件</li>
<li><code>db://schema/users</code> - 数据库表结构</li>
<li><code>git://commits/main</code> - Git提交历史</li>
<li><code>https://api.example.com/data</code> - Web API</li>
</ul>
<p><strong>订阅变更</strong>: 可以订阅资源,当它变化时自动收到通知。</p>
<p><strong>实际案例</strong>: Filesystem服务器暴露资源</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/alice/project/src/main.py"</span>,  <span class="hljs-comment">// Python源文件</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"main.py"</span>,                                  <span class="hljs-comment">// 文件名</span>
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,                        <span class="hljs-comment">// 文件类型</span>
  <span class="hljs-string">"text"</span>: <span class="hljs-string">"import os<span class="hljs-subst">\n</span>def main()..."</span>                  <span class="hljs-comment">// 文件内容</span>
}
</code></pre>
<p>客户端AI可以读取这个资源，理解代码结构后提供重构建议或生成测试。</p>
<h3 data-id="heading-14">5.2 Prompts(提示模板)：用户选择用什么</h3>
<p><strong>什么是Prompt?</strong></p>
<p>Prompt就像是「对话模板」或「快捷指令」，把常用的复杂指令预设好，用户一键调用。用生活中的例子类比，就像微信的「快捷回复」或IDE中的「代码片段(Snippet)」。</p>
<p><strong>为什么需要Prompt?</strong><br/>
场景1:没有Prompt时</p>
<pre><code class="hljs language-markdown" lang="markdown">用户每次都要输入:
"请分析这个Git仓库最近一周的提交,统计:
<span class="hljs-bullet">1.</span> 总提交次数
<span class="hljs-bullet">2.</span> 每个作者的贡献
<span class="hljs-bullet">3.</span> 修改的主要文件
<span class="hljs-bullet">4.</span> 是否有破坏性变更
请用表格格式输出"
</code></pre>
<p>场景2:有Prompt后</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户只需:</span>
1. 点击 <span class="hljs-string">"/analyze-commits"</span> 命令
2. 选择分支 <span class="hljs-string">"main"</span>
3. AI自动执行完整分析
</code></pre>
<p><strong>Prompt的数据结构</strong></p>
<p><strong>定义一个Prompt</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// Prompt的唯一标识</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提交历史分析"</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 用户界面显示的名称</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析Git提交并生成报告"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 功能说明</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                          <span class="hljs-comment">// 需要的参数列表</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 参数名</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"要分析的分支名"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 参数说明</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                    <span class="hljs-comment">// 是否必填</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 时间范围</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"起始日期(如:7 days ago)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>                   <span class="hljs-comment">// 可选参数</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"author"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 作者过滤</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"只看某个作者的提交"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p><strong>步骤1: 列出所有可用的Prompt</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prompts/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📊 提交历史分析"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析指定分支的提交历史,生成统计报告"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"review_code"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 代码审查"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对代码进行质量审查和改进建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file_path"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"focus"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explain_error"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🐛 错误诊断"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"解释错误信息并提供修复建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_message"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 用户在界面上看到这些选项</strong></p>
<pre><code class="hljs language-bash" lang="bash">━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  可用命令:
  
  📊 /analyze-commits
     分析指定分支的提交历史
     
  🔍 /review-code  
     对代码进行质量审查
     
  🐛 /explain-error
     解释错误信息并修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>步骤3: 用户选择并填写参数</strong></p>
<pre><code class="hljs language-ini" lang="ini">用户输入: /analyze-commits

系统弹窗:
┌─────────────────────────┐
│ 提交历史分析            │
├─────────────────────────┤
│ 分支名 *: <span class="hljs-section">[main      ]</span> │
│ 时间范围: <span class="hljs-section">[7 days ago]</span> │
│ 作者:     <span class="hljs-section">[          ]</span> │
│                         │
│      <span class="hljs-section">[取消]</span>  <span class="hljs-section">[确定]</span>     │
└─────────────────────────┘
</code></pre>
<p><strong>步骤4: 获取完整的Prompt内容</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 客户端请求</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"prompts/get"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"analyze_commits"</span>,       <span class="hljs-comment">// 使用哪个模板</span>
    <span class="hljs-string">"arguments"</span>: {                    <span class="hljs-comment">// 用户填写的参数</span>
      <span class="hljs-string">"branch"</span>: <span class="hljs-string">"main"</span>,
      <span class="hljs-string">"since"</span>: <span class="hljs-string">"7 days ago"</span>
    }
  }
}

<span class="hljs-comment">// 服务器响应 - 返回完整的对话消息</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"分析main分支最近7天的提交"</span>,
    <span class="hljs-string">"messages"</span>: [                     <span class="hljs-comment">// 发送给AI的完整对话</span>
      {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,               <span class="hljs-comment">// 用户角色</span>
        <span class="hljs-string">"content"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"请分析main分支在过去7天的Git提交历史。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>需要统计:<span class="hljs-subst">\n</span>1. 总提交次数<span class="hljs-subst">\n</span>2. 每个作者的贡献次数和代码行数<span class="hljs-subst">\n</span>3. 主要修改的文件列表<span class="hljs-subst">\n</span>4. 是否包含breaking changes<span class="hljs-subst">\n</span>5. 提交消息的规范性<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>请用表格格式输出结果,并在最后给出改进建议。"</span>
        }
      }
    ]
  }
}
</code></pre>
<p><strong>步骤5: 客户端将消息发送给AI</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户看到AI正在分析...

AI返回:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 main分支提交分析报告(最近7天)

总提交次数: 23

作者贡献统计:
┌────────────┬────────┬──────────┐
│ 作者       │ 提交数 │ 代码行数  │
├────────────┼────────┼──────────┤
│ Alice      │   12   │  +543/-89│
│ Bob        │    8   │  +234/-45│
│ Charlie    │    3   │  +123/-12│
└────────────┴────────┴──────────┘

主要修改文件:
- src/api/users.py (8次修改)
- src/models/user.py (5次修改)
- tests/test_user.py (4次修改)

Breaking Changes: 无

提交规范性: 良好 (91%符合Conventional Commits)

改进建议:
1. 建议增加单元测试覆盖率
2. 部分提交消息过于简短
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>Prompt的内容类型</strong></p>
<p>Prompt消息中可以包含多种内容:<br/>
<strong>1. 纯文本</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请审查这段代码..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2. 嵌入图片</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base64-encoded-image-data"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 图片数据</span>
    <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>                  <span class="hljs-comment">// 图片类型</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 嵌入资源</strong>(引用MCP资源)</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"resource"</span>,
    <span class="hljs-string">"resource"</span>: {
      <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///project/src/user.py"</span>,  <span class="hljs-comment">// 资源URI</span>
      <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"class User:<span class="hljs-subst">\n</span>    def __init__..."</span>  <span class="hljs-comment">// 资源内容</span>
    }
  }
}
</code></pre>
<p><strong>4. 多轮对话</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我想优化这段代码"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// AI的回复</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供代码内容"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 用户提供代码</span>
        <span class="hljs-attr">"resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Prompt vs Tool vs Resource 对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">特性          Prompt              Tool                Resource
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
控制者        用户主动选择         AI自动决定           应用程序控制

触发方式      用户点击命令         AI判断需要调用       应用自动附加
              /analyze                              或用户选择
              
返回内容      对话消息            执行结果             数据内容
              (给AI的指令)        (函数返回值)         (上下文信息)
              
典型用途      工作流模板          执行操作             提供背景信息
              快捷指令            查询数据             文件内容
              
示例          代码审查模板        执行SQL查询          项目README
              错误诊断向导        发送邮件             数据库Schema
              
用户感知      ✅ 明显             ❓ 可能不知道         ❓ 透明的
              (用户点击)          (AI决定)            (自动加载)
</code></pre>
<p>Prompt是预设的对话模板，通过参数化实现灵活应用，提升用户体验，并能与MCP其他能力组合形成完整工作流。</p>
<p><strong>代码实现示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端:注册Prompt</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_commits"</span>,
            title=<span class="hljs-string">"📊 提交历史分析"</span>,
            description=<span class="hljs-string">"分析Git提交历史并生成统计报告"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"branch"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"分支名"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"since"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"时间范围"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">False</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_commits"</span>:
        branch = arguments[<span class="hljs-string">"branch"</span>]
        since = arguments.get(<span class="hljs-string">"since"</span>, <span class="hljs-string">"7 days ago"</span>)
        
        <span class="hljs-comment"># 构建完整的提示消息</span>
        prompt_text = <span class="hljs-string">f"""
请分析<span class="hljs-subst">{branch}</span>分支在<span class="hljs-subst">{since}</span>的Git提交历史。

需要统计:
1. 总提交次数
2. 每个作者的贡献
3. 主要修改的文件
4. 是否有breaking changes

请用表格格式输出。
        """</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: prompt_text}
                }
            ]
        }

<span class="hljs-comment"># 客户端:使用Prompt</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">use_prompt</span>(<span class="hljs-params">session, prompt_name, arguments</span>):
    <span class="hljs-comment"># 获取Prompt内容</span>
    prompt = <span class="hljs-keyword">await</span> session.get_prompt(
        name=prompt_name,
        arguments=arguments
    )
    
    <span class="hljs-comment"># 将消息发送给AI</span>
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> prompt.messages:
        ai_response = <span class="hljs-keyword">await</span> send_to_ai(message)
        <span class="hljs-built_in">print</span>(ai_response)
</code></pre>
<h3 data-id="heading-15">5.3 Tools(工具)：AI 自己决定用什么</h3>
<p><strong>Tool就是可执行的函数</strong>，比如查询数据库、调用API、写文件。</p>
<p><strong>谁控制</strong>：AI模型根据对话内容自己决定调用哪个工具</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出可用工具</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// AI调用工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京天气:晴,温度22°C"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">5.4 其他功能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fcompletion" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/completion" ref="nofollow noopener noreferrer"><strong>补全</strong></a></p>
<p>MCP提供标准化的参数自动补全功能，支持为提示和资源URI提供上下文相关的建议，实现类似IDE的交互体验。服务器通过声明<code>completions</code>能力，支持对<code>ref/prompt</code>和<code>ref/resource</code>两种引用类型的补全，每次最多返回100个按相关性排序的建议值，并可通过<code>completion/complete</code>请求获取补全结果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Flogging" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/logging" ref="nofollow noopener noreferrer"><strong>日志</strong></a></p>
<p>MCP提供结构化日志消息传递机制，允许服务器向客户端发送包含严重性级别、可选记录器名称和任意JSON可序列化数据的日志通知。服务器需声明<code>logging</code>能力，支持遵循RFC 5424标准的日志级别（从debug到emergency），客户端可通过<code>logging/setLevel</code>请求配置最低日志级别，服务器通过<code>notifications/message</code>通知发送日志消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fpagination" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/pagination" ref="nofollow noopener noreferrer"><strong>分页</strong></a></p>
<p>MCP支持对可能返回大量结果集的列表操作进行分页处理，使用基于不透明游标的分页模型而非数字页码。服务器在响应中包含当前页结果和可选的<code>nextCursor</code>字段（表示更多结果存在），客户端可通过在请求中包含游标继续分页。支持分页的操作包括<code>resources/list</code>、<code>resources/templates/list</code>、<code>prompts/list</code>和<code>tools/list</code>，客户端必须将游标视为不透明令牌。</p>
<h2 data-id="heading-17">六、客户端能力：反向请求</h2>
<p>客户端不仅接收服务器的数据，也可以提供能力给服务器使用:</p>
<h3 data-id="heading-18">6.1 Sampling(采样)：服务器请求客户端调用AI</h3>
<p><strong>场景</strong>: 服务器在处理任务时，需要AI帮忙分析中间结果。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampling/createMessage"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这个数据正常吗?"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"modelPreferences"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-sonnet"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 建议用的模型</span>
      <span class="hljs-attr">"intelligencePriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 要求智能程度</span>
      <span class="hljs-attr">"speedPriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>                     <span class="hljs-comment">// 速度要求</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际案例</strong>:Filesystem服务器在搜索大量文件时,请求AI判断哪些文件最相关。</p>
<h3 data-id="heading-19">6.2 Roots(目录)：告诉服务器工作范围</h3>
<p><strong>场景</strong>: 让服务器知道可以访问哪些目录。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"roots/list"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///home/user/project"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的项目"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>服务器知道只能在这个目录里操作，保护其他文件安全。</p>
<h3 data-id="heading-20">6.3 Elicitation(引导)：服务器向用户询问信息</h3>
<p><strong>场景</strong>: 服务器需要用户提供额外信息才能继续。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/create"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供您的GitHub用户名"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestedSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用户响应</strong>:</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"accept"</span>,  <span class="hljs-regexp">//</span> 或<span class="hljs-string">"decline"</span>拒绝, <span class="hljs-string">"cancel"</span>取消
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"octocat"</span>
  }
}
</code></pre>
<p><strong>实际案例</strong>: Git服务器需要知道提交信息格式，弹窗问用户:"请选择提交规范:Conventional Commits/Angular/Custom?"</p>
<h2 data-id="heading-21">七、完整实战：从零构建天气查询MCP</h2>
<p>下面让我们从头到尾构建一个完整的MCP系统，包含服务器和客户端。</p>
<h3 data-id="heading-22">7.1 需求分析</h3>
<p><strong>目标</strong>: 构建一个天气查询MCP服务器,提供:</p>
<ul>
<li><strong>资源</strong>: 城市列表</li>
<li><strong>工具</strong>: 查询天气、获取预报</li>
<li><strong>提示</strong>: 天气分析模板</li>
</ul>
<h3 data-id="heading-23">7.2 服务器实现(Python)</h3>
<p><strong>第一步: 安装MCP SDK</strong></p>
<pre><code class="hljs">pip install mcp
</code></pre>
<p><strong>第二步: 创建服务器 (weather_server.py)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> Server
<span class="hljs-keyword">from</span> mcp.types <span class="hljs-keyword">import</span> Resource, Tool, Prompt, TextContent
<span class="hljs-keyword">import</span> mcp.server.stdio
<span class="hljs-keyword">import</span> httpx

<span class="hljs-comment"># 创建MCP服务器实例</span>
server = Server(<span class="hljs-string">"weather-server"</span>)

<span class="hljs-comment"># 1. 定义资源:支持的城市列表</span>
<span class="hljs-meta">@server.list_resources()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_resources</span>():
    <span class="hljs-string">"""返回可用的资源列表"""</span>
    <span class="hljs-keyword">return</span> [
        Resource(
            uri=<span class="hljs-string">"weather://cities"</span>,
            name=<span class="hljs-string">"支持的城市列表"</span>,
            mimeType=<span class="hljs-string">"application/json"</span>,
            description=<span class="hljs-string">"查询天气支持的所有城市"</span>
        )
    ]

<span class="hljs-meta">@server.read_resource()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">uri: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""读取具体资源内容"""</span>
    <span class="hljs-keyword">if</span> uri == <span class="hljs-string">"weather://cities"</span>:
        cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"杭州"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"contents"</span>: [{
                <span class="hljs-string">"uri"</span>: uri,
                <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"application/json"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-built_in">str</span>(cities)
            }]
        }

<span class="hljs-comment"># 2. 定义工具:天气查询</span>
<span class="hljs-meta">@server.list_tools()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>():
    <span class="hljs-string">"""返回可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        Tool(
            name=<span class="hljs-string">"get_current_weather"</span>,
            description=<span class="hljs-string">"获取指定城市的当前天气"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称,如'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        ),
        Tool(
            name=<span class="hljs-string">"get_forecast"</span>,
            description=<span class="hljs-string">"获取未来3天天气预报"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>},
                    <span class="hljs-string">"days"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"预报天数(1-3)"</span>, <span class="hljs-string">"default"</span>: <span class="hljs-number">3</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        )
    ]

<span class="hljs-meta">@server.call_tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具调用"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"get_current_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-comment"># 实际项目中这里调用真实的天气API</span>
        <span class="hljs-comment"># 示例:使用模拟数据</span>
        weather_data = {
            <span class="hljs-string">"city"</span>: city,
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴"</span>,
            <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>
        }
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气:\n温度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'temperature'</span>]}</span>°C\n天气: <span class="hljs-subst">{weather_data[<span class="hljs-string">'condition'</span>]}</span>\n湿度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'humidity'</span>]}</span>%"</span>
            }]
        }
    
    <span class="hljs-keyword">elif</span> name == <span class="hljs-string">"get_forecast"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        days = arguments.get(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>)
        <span class="hljs-comment"># 模拟预报数据</span>
        forecast = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>未来<span class="hljs-subst">{days}</span>天预报:\n第1天: 晴,20-25°C\n第2天: 多云,18-23°C\n第3天: 小雨,16-20°C"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: forecast}]
        }

<span class="hljs-comment"># 3. 定义提示模板:天气分析</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-string">"""返回可用的提示模板"""</span>
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_weather"</span>,
            description=<span class="hljs-string">"分析天气趋势并给出建议"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""获取提示模板内容"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请分析<span class="hljs-subst">{city}</span>的天气情况,并给出出行建议。包括:\n1. 温度是否适宜\n2. 是否需要带伞\n3. 穿衣建议"</span>
                    }
                }
            ]
        }

<span class="hljs-comment"># 启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 使用stdio传输(本地)</span>
    mcp.server.stdio.run_stdio_server(server)
</code></pre>
<h3 data-id="heading-24">7.3 配置服务器(Claude Desktop)</h3>
<p>创建配置文件 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"weather"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/weather_server.py"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">7.4 客户端实现(Python)</h3>
<p>如果要自己实现客户端:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 连接到服务器</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(
        command=<span class="hljs-string">"python"</span>,
        args=[<span class="hljs-string">"/path/to/weather_server.py"</span>]
    ) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            
            <span class="hljs-comment"># 1. 初始化连接</span>
            <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 连接成功!"</span>)
            
            <span class="hljs-comment"># 2. 列出可用资源</span>
            resources = <span class="hljs-keyword">await</span> session.list_resources()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📁 可用资源: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources.resources)}</span>"</span>)
            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources.resources:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{r.name}</span>: <span class="hljs-subst">{r.uri}</span>"</span>)
            
            <span class="hljs-comment"># 3. 读取城市列表资源</span>
            cities_resource = <span class="hljs-keyword">await</span> session.read_resource(
                uri=<span class="hljs-string">"weather://cities"</span>
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌍 城市列表: <span class="hljs-subst">{cities_resource.contents[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 4. 列出可用工具</span>
            tools = <span class="hljs-keyword">await</span> session.list_tools()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 可用工具: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools.tools)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools.tools:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{t.name}</span>: <span class="hljs-subst">{t.description}</span>"</span>)
            
            <span class="hljs-comment"># 5. 调用工具查询天气</span>
            result = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_current_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌤️  查询结果:\n<span class="hljs-subst">{result.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 6. 获取预报</span>
            forecast = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_forecast"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"days"</span>: <span class="hljs-number">3</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 天气预报:\n<span class="hljs-subst">{forecast.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 7. 列出提示模板</span>
            prompts = <span class="hljs-keyword">await</span> session.list_prompts()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💡 提示模板: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts.prompts)}</span>"</span>)
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> prompts.prompts:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{p.name}</span>: <span class="hljs-subst">{p.description}</span>"</span>)
            
            <span class="hljs-comment"># 8. 获取提示内容</span>
            prompt = <span class="hljs-keyword">await</span> session.get_prompt(
                name=<span class="hljs-string">"analyze_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📝 生成的提示:\n<span class="hljs-subst">{prompt.messages[<span class="hljs-number">0</span>][<span class="hljs-string">'content'</span>][<span class="hljs-string">'text'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-26">7.5 运行效果</h3>
<pre><code class="hljs language-makefile" lang="makefile">$ python weather_client.py

✅ 连接成功!

📁 可用资源: 1
  - 支持的城市列表: weather://cities

🌍 城市列表: ['北京', '上海', '广州', '深圳', '杭州']

🔧 可用工具: 2
  - get_current_weather: 获取指定城市的当前天气
  - get_forecast: 获取未来3天天气预报

🌤️  查询结果:
<span class="hljs-section">北京当前天气:</span>
<span class="hljs-section">温度: 22°C</span>
<span class="hljs-section">天气: 晴</span>
<span class="hljs-section">湿度: 45%</span>

📅 天气预报:
<span class="hljs-section">上海未来3天预报:</span>
<span class="hljs-section">第1天: 晴,20-25°C</span>
<span class="hljs-section">第2天: 多云,18-23°C</span>
<span class="hljs-section">第3天: 小雨,16-20°C</span>

💡 提示模板: 1
  - analyze_weather: 分析天气趋势并给出建议

📝 生成的提示:
<span class="hljs-section">请分析广州的天气情况,并给出出行建议。包括:</span>
1. 温度是否适宜
2. 是否需要带伞
3. 穿衣建议
</code></pre>
<h2 data-id="heading-27">八、其他部分：MCP基础协议的另一半</h2>
<h3 data-id="heading-28">8.1 授权（Authorization）</h3>
<p>MCP授权规范定义了基于HTTP传输的安全授权机制，使MCP客户端能够代表资源所有者向受限制的MCP服务器发出请求。该规范基于OAuth 2.1及相关标准，实现了授权服务器发现、动态客户端注册和访问令牌管理。例如，客户端通过<code>resource</code>参数明确指定目标MCP服务器（如<code>https://mcp.example.com</code>），服务器则验证令牌是否专门为其颁发，确保令牌不会被误用于其他服务，从而防止"令牌传递"安全漏洞。</p>
<h3 data-id="heading-29">8.2 取消（Cancellation）</h3>
<p>MCP取消机制允许通过通知消息中止正在进行的请求，任何一方都可以发送<code>notifications/cancelled</code>通知来终止先前发出的请求。例如，当用户取消长时间运行的操作时，客户端可以发送包含请求ID和可选原因的取消通知，接收方应停止处理、释放资源且不发送响应。该机制考虑了网络延迟导致的竞态条件，允许接收方在请求已完成或无法取消时忽略通知，同时建议双方记录取消原因以便调试。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/cancelled"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户取消"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-30">8.3 Ping机制</h3>
<p>MCP提供了可选的ping机制，允许任何一方验证对方是否仍然响应且连接存活。该机制通过简单的请求/响应模式实现，例如客户端发送<code>{"jsonrpc":"2.0","id":"123","method":"ping"}</code>，服务器必须立即响应<code>{"jsonrpc":"2.0","id":"123","result":{}}</code>。如果在合理超时时间内未收到响应，发送方可以将连接视为陈旧并终止连接或尝试重新连接。实现应定期发送ping以检测连接健康状况，但应避免过度ping以减少网络开销。</p>
<h3 data-id="heading-31">8.4 进度跟踪（Progress）</h3>
<p>MCP支持通过通知消息对长时间运行的操作进行可选的进度跟踪。请求方可以在请求元数据中包含唯一的<code>progressToken</code>（如字符串"task123"）来接收进度更新，接收方则可以发送包含进度值、可选总值和消息的<code>notifications/progress</code>通知。例如，文件上传操作可以发送<code>{"progress":50,"total":100,"message":"正在上传文件..."}</code>来指示完成百分比。进度值必须随每个通知递增，双方应实现速率限制以防止消息泛滥，并在操作完成后停止发送进度通知。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/progress"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"task123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 当前进度</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 总量</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在上传文件..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-32">九、安全实践：必须重视</h2>
<h3 data-id="heading-33">9.1 核心原则</h3>
<p><strong>1. 用户同意优先</strong></p>
<ul>
<li>所有数据访问必须经用户明确同意</li>
<li>所有工具调用前必须让用户确认</li>
</ul>
<p><strong>2. 数据隐私保护</strong></p>
<ul>
<li>服务器只能看到必要的信息</li>
<li>完整对话历史保留在宿主,不发给服务器</li>
</ul>
<p><strong>3. 工具安全</strong></p>
<ul>
<li>工具代表代码执行,必须谨慎</li>
<li>显示工具要做什么,让用户批准</li>
</ul>
<p><strong>4. 输入验证</strong></p>
<ul>
<li>服务器必须验证所有输入</li>
<li>客户端必须验证工具返回的结果</li>
</ul>
<h3 data-id="heading-34">9.2 实际建议</h3>
<p><strong>服务器开发者</strong>:</p>
<ul>
<li>验证所有输入参数</li>
<li>实现访问控制和速率限制</li>
<li>记录操作日志供审计</li>
</ul>
<p><strong>客户端开发者</strong>:</p>
<ul>
<li>显示清晰的权限请求界面</li>
<li>在调用工具前展示参数</li>
<li>实现工具调用超时机制</li>
</ul>
<h2 data-id="heading-35">十、MCP生态：谁开发客户端?</h2>
<p><strong>关键认知</strong>: 在MCP生态中，<strong>客户端通常不是由下游开发者开发的</strong>，而是<strong>内置在AI应用平台中</strong>。</p>
<pre><code class="hljs language-css" lang="css">  开发者开发MCP服务器
       ↓
  配置到AI平台(Claude/<span class="hljs-attribute">Cursor</span>等)
       ↓
  AI平台内置的MCP客户端自动连接
</code></pre>
<p>对于软件开发者来说，在MCP生态中的位置如下。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">角色定位:</span>
┌─────────────────────────────────────────┐
│ AI平台开发者(Anthropic, Cursor等)       │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP客户端SDK                    │
│  ✅ 集成到自己的AI应用中                │
│  ✅ 提供配置界面                        │
│  ✅ 管理MCP服务器生命周期               │
│  ✅ 处理AI与MCP的交互逻辑               │
└─────────────────────────────────────────┘
                 ↓ 提供平台
┌─────────────────────────────────────────┐
│ MCP服务器开发者(你、我、社区)           │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP服务器                       │
│  ✅ 实现Resources/Tools/Prompts        │
│  ✅ 编写使用文档                        │
│  ✅ 发布到npm/PyPI                      │
│  ❌ 不需要开发客户端                    │
│  ❌ 不需要关心AI如何调用                │
└─────────────────────────────────────────┘
                 ↓ 使用服务
┌─────────────────────────────────────────┐
│ 最终用户(开发者、分析师等)               │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 安装需要的MCP服务器                 │
│  ✅ 配置到AI平台                        │
│  ✅ 使用AI完成任务                      │
│  ❌ 不需要写代码                        │
└─────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-36">后记</h2>
<p>MCP 让 AI 应用开发变得更简单、更安全、更强大。它不是银弹，但为构建可靠的AI系统提供了坚实基础。<strong>本文全部内容基于提示编写，欢迎交流讨论！</strong></p>
<h2 data-id="heading-37">参考文献</h2>
<ol>
<li>MCP官方规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></li>
<li>JSON-RPC 2.0: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2F" target="_blank" title="https://www.jsonrpc.org/" ref="nofollow noopener noreferrer">www.jsonrpc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析]]></title>    <link>https://juejin.cn/post/7571829879827628051</link>    <guid>https://juejin.cn/post/7571829879827628051</guid>    <pubDate>2025-11-13T10:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571829879827628051" data-draft-id="7572004684178669622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析"/> <meta itemprop="keywords" content="人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-13T10:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:20:37.000Z" title="Thu Nov 13 2025 10:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>通过 OpenAI 兼容的 API 接口使用该工具的【本地部署教程】请点击以下链接：</strong></p>
<p><a href="https://juejin.cn/post/7569789282429255722" target="_blank" title="https://juejin.cn/post/7569789282429255722">告别繁琐文档处理！PaddleOCR-VL-vLLM-OpenAI-API本地部署教程：精准解析文本/表格/公式 - 掘金</a></p>
<p><strong>模型一键部署及使用方法请进入“算家云”官网</strong></p>
<h2 data-id="heading-0">概述</h2>
<p>PaddleOCR-VL 是一个基于视觉语言模型的多功能图像识别工具，支持 OCR 文字识别、表格识别、公式识别和图表识别等功能。本文档介绍如何通过 OpenAI 兼容的 API 接口使用该模型。</p>
<p><strong>功能验证状态</strong>: 所有四种任务类型已通过完整测试，功能稳定可用（测试时间：2025-11-07）</p>
<h2 data-id="heading-1">API 配置信息</h2>
<ul>
<li><strong>API 端点</strong>: <code>http://xn-b.suanjiayun.com:51849/v1/</code>  <strong>(实例对外开放端口)</strong></li>
<li><strong>模型名称</strong>: <code>PaddleOCR-VL</code></li>
<li><strong>API Key</strong>: <code>EMPTY</code>（无需真实密钥）</li>
<li><strong>最大上下文长度</strong>: 4096 tokens</li>
<li><strong>超时设置</strong>: 建议 3600 秒</li>
<li><strong>平均响应时间</strong>: 3-5 秒</li>
</ul>
<h2 data-id="heading-2">环境准备</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<pre><code class="hljs">pip install openai
</code></pre>
<h3 data-id="heading-4">2. 基础配置</h3>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
)
</code></pre>
<h2 data-id="heading-5">支持的任务类型</h2>
<h3 data-id="heading-6">1. OCR 文字识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"OCR:"</code></li>
<li><strong>功能</strong>: 识别图像中的文字内容</li>
<li><strong>输出格式</strong>: 纯文本，保持原有布局结构</li>
<li><strong>适用场景</strong>: 文档扫描、票据识别、标牌识别等</li>
<li><strong>测试结果</strong>: 准确识别文字和数字，布局保持良好</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">CINNAMON</span> SUGAR
<span class="hljs-number">1</span> x <span class="hljs-number">17</span>,<span class="hljs-number">000</span>
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
SUB TOTAL
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
</code></pre>
<h3 data-id="heading-7">2. 表格识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Table Recognition:"</code></li>
<li><strong>功能</strong>: 识别和解析表格结构及内容</li>
<li><strong>输出格式</strong>: 结构化标记语言（<code>&lt;fcel&gt;</code>, <code>&lt;lcel&gt;</code>, <code>&lt;ecel&gt;</code>, <code>&lt;nl&gt;</code>）</li>
<li><strong>适用场景</strong>: 财务报表、数据表格、统计表等</li>
<li><strong>测试结果</strong>: 能够准确识别表格行列结构</li>
</ul>
<p><strong>标记说明</strong>:</p>
<ul>
<li><code>&lt;fcel&gt;</code>: 第一列单元格</li>
<li><code>&lt;lcel&gt;</code>: 最后一列单元格</li>
<li><code>&lt;ecel&gt;</code>: 空单元格</li>
<li><code>&lt;nl&gt;</code>: 新行</li>
</ul>
<h3 data-id="heading-8">3. 公式识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Formula Recognition:"</code></li>
<li><strong>功能</strong>: 识别数学公式和科学公式</li>
<li><strong>输出格式</strong>: 格式化对齐的文本，保持数字对齐</li>
<li><strong>适用场景</strong>: 学术论文、教材、科研文档等</li>
<li><strong>测试结果</strong>: 能识别运算符，保持格式对齐</li>
</ul>
<h3 data-id="heading-9">4. 图表识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Chart Recognition:"</code></li>
<li><strong>功能</strong>: 识别图表类型和数据内容</li>
<li><strong>输出格式</strong>: 表格化数据（Category | Value 格式）</li>
<li><strong>适用场景</strong>: 数据可视化图表、统计图形等</li>
<li><strong>测试结果</strong>: 自动结构化数据，便于后续处理</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec">Category | Value
<span class="hljs-built_in">CINNAMON</span> SUGAR | <span class="hljs-number">17000</span>
SUB TOTAL | <span class="hljs-number">17000</span>
GRAND TOTAL | <span class="hljs-number">17000</span>
</code></pre>
<h2 data-id="heading-10">使用示例</h2>
<h3 data-id="heading-11">快速开始 - 基础 OCR 识别</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 初始化客户端</span>
client = OpenAI(
    api_key=<span class="hljs-string">"EMPTY"</span>,
    base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    timeout=<span class="hljs-number">3600</span>
)

<span class="hljs-comment"># 定义任务类型</span>
TASKS = {
    <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
    <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
    <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
    <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
}

<span class="hljs-comment"># 构建请求消息</span>
messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"你的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"ocr"</span>]  <span class="hljs-comment"># 选择任务类型</span>
            }
        ]
    }
]

<span class="hljs-comment"># 发送请求</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在处理图像..."</span>)
    response = client.chat.completions.create(
        model=<span class="hljs-string">"PaddleOCR-VL"</span>,
        messages=messages,
        temperature=<span class="hljs-number">0.0</span>,
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 识别结果:\n<span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-12">不同任务类型示例</h3>
<h4 data-id="heading-13">表格识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 表格识别 - 返回结构化标记</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"包含表格的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"table"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: &lt;fcel&gt;内容&lt;fcel&gt;内容&lt;nl&gt;...</span>
</code></pre>
<h4 data-id="heading-14">图表识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 图表识别 - 返回表格化数据</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"图表图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"chart"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: Category | Value\n项目名 | 数值</span>
</code></pre>
<h2 data-id="heading-15">图片输入方式</h2>
<h3 data-id="heading-16">1. 网络图片 URL</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"image_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/image.jpg"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">2. Base64 编码图片</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_image</span>(<span class="hljs-params">image_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
        <span class="hljs-keyword">return</span> base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)

base64_image = encode_image(<span class="hljs-string">"path/to/your/image.jpg"</span>)

<span class="hljs-string">"image_url"</span>: {
    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
}
</code></pre>
<h2 data-id="heading-18">完整功能类 - 生产就绪版本</h2>
<p>基于实际测试结果，以下是经过验证的完整功能类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddleOCRVL</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.client = OpenAI(
            api_key=<span class="hljs-string">"EMPTY"</span>,
            base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
            timeout=<span class="hljs-number">3600</span>
        )
        self.tasks = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
        }
        self.output_formats = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"纯文本格式"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"结构化标记语言"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"格式化对齐文本"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"表格化数据"</span>
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, image_url, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""
        图像识别主函数 - 已通过完整测试验证

        Args:
            image_url (str): 图片URL或本地路径
            task_type (str): 任务类型 ('ocr', 'table', 'formula', 'chart')
            verbose (bool): 是否显示详细处理信息

        Returns:
            dict: 包含识别结果和元信息的字典
        """</span>
        <span class="hljs-keyword">if</span> task_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.tasks:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的任务类型: <span class="hljs-subst">{task_type}</span>. 支持的类型: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(self.tasks.keys())}</span>"</span>)

        <span class="hljs-keyword">if</span> verbose:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 开始 <span class="hljs-subst">{task_type.upper()}</span> 识别..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 预期输出格式: <span class="hljs-subst">{self.output_formats[task_type]}</span>"</span>)

        <span class="hljs-comment"># 处理本地图片</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_url.startswith((<span class="hljs-string">'http://'</span>, <span class="hljs-string">'https://'</span>)):
            image_url = self._encode_local_image(image_url)

        messages = [
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                        <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: image_url}
                    },
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: self.tasks[task_type]
                    }
                ]
            }
        ]

        <span class="hljs-keyword">try</span>:
            start_time = time.time()
            response = self.client.chat.completions.create(
                model=<span class="hljs-string">"PaddleOCR-VL"</span>,
                messages=messages,
                temperature=<span class="hljs-number">0.0</span>,
            )
            end_time = time.time()
            processing_time = end_time - start_time

            result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"content"</span>: response.choices[<span class="hljs-number">0</span>].message.content,
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-built_in">round</span>(processing_time, <span class="hljs-number">2</span>),
                <span class="hljs-string">"output_format"</span>: self.output_formats[task_type]
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功! 耗时: <span class="hljs-subst">{processing_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

            <span class="hljs-keyword">return</span> result

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            error_result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"output_format"</span>: <span class="hljs-literal">None</span>
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)

            <span class="hljs-keyword">return</span> error_result

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_recognize</span>(<span class="hljs-params">self, image_urls, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""批量识别功能"""</span>
        results = []
        <span class="hljs-keyword">for</span> i, url <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(image_urls):
            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n处理第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(image_urls)}</span> 张图片..."</span>)
            result = self.recognize(url, task_type, verbose)
            results.append(result)
            time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 避免请求过于频繁</span>
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_encode_local_image</span>(<span class="hljs-params">self, image_path</span>):
        <span class="hljs-string">"""编码本地图片为 base64"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
                base64_image = base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)
                <span class="hljs-comment"># 根据文件扩展名确定MIME类型</span>
                <span class="hljs-keyword">if</span> image_path.lower().endswith(<span class="hljs-string">'.png'</span>):
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/png;base64,<span class="hljs-subst">{base64_image}</span>"</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"无法读取图片文件: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 使用示例 - 基于实际测试验证</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    ocr = PaddleOCRVL()

    <span class="hljs-comment"># 测试用的收据图片URL</span>
    test_image = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>

    <span class="hljs-comment"># OCR 识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"OCR 结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 表格识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"table"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"表格识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 图表识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"chart"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"图表识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-19">性能特点（基于实际测试）</h2>
<h3 data-id="heading-20">✅ 已验证的性能指标</h3>
<ul>
<li><strong>响应时间</strong>: 3-5 秒（所有任务类型）</li>
<li><strong>成功率</strong>: 100%（基于测试样本）</li>
<li><strong>API 稳定性</strong>: 连续测试无异常</li>
<li><strong>识别准确率</strong>: 文字和数字识别准确</li>
</ul>
<h3 data-id="heading-21">📊 输出格式对比</h3>




































<table><thead><tr><th>任务类型</th><th>输出格式</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>OCR</td><td>纯文本</td><td>保持原布局</td><td>文档扫描、文字提取</td></tr><tr><td>Table</td><td>标记语言</td><td>结构化标记</td><td>表格数据解析</td></tr><tr><td>Formula</td><td>对齐文本</td><td>格式化显示</td><td>公式文档处理</td></tr><tr><td>Chart</td><td>表格数据</td><td>Category</td><td>Value</td><td>数据分析处理</td></tr></tbody></table>
<h2 data-id="heading-22">注意事项</h2>
<h3 data-id="heading-23">🔧 技术要求</h3>
<ol>
<li><strong>网络连接</strong>: 确保能够访问 API 端点 <code>http://xn-b.suanjiayun.com:51849/v1/</code></li>
<li><strong>图片格式</strong>: 支持常见图片格式（JPG、PNG、GIF 等）</li>
<li><strong>图片大小</strong>: 建议图片不超过 10MB</li>
<li><strong>超时设置</strong>: 建议设置 3600 秒超时（实际处理时间 3-5 秒）</li>
<li><strong>错误处理</strong>: 始终使用 try-except 处理可能的网络或 API 错误</li>
</ol>
<h3 data-id="heading-24">💡 最佳实践</h3>
<ol>
<li><strong>图片质量</strong>: 使用高清晰度图片获得最佳识别效果</li>
<li><strong>任务选择</strong>: 根据实际需求选择合适的任务类型</li>
<li><strong>结果处理</strong>: 不同任务类型返回不同格式，需要相应的后处理逻辑</li>
<li><strong>批量处理</strong>: 在请求间添加适当延迟（建议 1-2 秒）</li>
</ol>
<h2 data-id="heading-25">常见问题</h2>
<h3 data-id="heading-26">Q: 如何提高识别准确率？</h3>
<p>A:</p>
<ul>
<li>确保图片清晰度足够</li>
<li>避免图片过度压缩</li>
<li>选择合适的任务类型</li>
<li>根据测试结果，当前识别准确率已经很高</li>
</ul>
<h3 data-id="heading-27">Q: 支持批量处理吗？</h3>
<p>A: 支持，可以使用提供的 <code>batch_recognize</code> 方法，或循环调用单张处理</p>
<h3 data-id="heading-28">Q: 如何处理不同的输出格式？</h3>
<p>A:</p>
<ul>
<li><strong>OCR</strong>: 直接使用文本内容</li>
<li><strong>Table</strong>: 需要解析 <code>&lt;fcel&gt;</code>, <code>&lt;nl&gt;</code> 等标记</li>
<li><strong>Chart</strong>: 可以直接按 <code>|</code> 分割处理表格数据</li>
</ul>
<h3 data-id="heading-29">Q: API 响应时间如何？</h3>
<p>A: 根据测试结果，所有任务类型的响应时间都在 3-5 秒内</p>
<h3 data-id="heading-30">Q: 如何处理识别错误？</h3>
<p>A: 检查网络连接、图片格式和 API 端点配置。使用提供的错误处理机制</p>
<h2 data-id="heading-31">功能验证测试</h2>
<h3 data-id="heading-32">🧪 测试用例</h3>
<p>为了验证文档中的所有功能，可以运行以下测试代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 快速功能验证测试</span>
from openai import OpenAI

def quick_test():
    <span class="hljs-attr">client</span> = OpenAI(
        <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
        <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
        <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
    )

    <span class="hljs-attr">test_image</span> = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>
    <span class="hljs-attr">tasks</span> = [<span class="hljs-string">"OCR:"</span>, <span class="hljs-string">"Table Recognition:"</span>, <span class="hljs-string">"Formula Recognition:"</span>, <span class="hljs-string">"Chart Recognition:"</span>]

    print("🚀 开始功能验证测试...")

    for i, task in enumerate(tasks):
        print(f"\n测试 {i+1}/4: {task}")
        try:
            <span class="hljs-attr">messages</span> = [{
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>, <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: test_image}},
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: task}
                ]
            }]

            <span class="hljs-attr">response</span> = client.chat.completions.create(
                <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
                <span class="hljs-attr">messages</span>=messages,
                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
            )
            print(f"✅ {task} 测试通过")
        except Exception as e:
            print(f"❌ {task} 测试失败: {e}")

    print("\n🎉 测试完成!")

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    quick_test()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器之内置四大多线程API]]></title>    <link>https://juejin.cn/post/7571477608393572352</link>    <guid>https://juejin.cn/post/7571477608393572352</guid>    <pubDate>2025-11-12T09:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571477608393572352" data-draft-id="7571641339687895040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器之内置四大多线程API"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-11-12T09:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器之内置四大多线程API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:01:00.000Z" title="Wed Nov 12 2025 09:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">一、为什么 Web Worker 能实现 “多线程”？</h3>
<p>浏览器的 JS 引擎（如 V8）本身是单线程的，但浏览器是多进程 / 多线程架构。Web Worker 的本质是 <strong>浏览器为 JS 提供的 “额外线程池”</strong> ，核心原理：</p>
<ol>
<li><strong>线程隔离</strong>：Worker 线程与主线程是完全隔离的内存空间（不共享堆内存），通过 “消息队列” 通信（数据传输基于结构化克隆算法，深拷贝）。</li>
<li><strong>阻塞无关性</strong>：Worker 线程的阻塞（如死循环）不会影响主线程，但会导致自身无法响应消息。</li>
<li><strong>资源限制</strong>：浏览器对 Worker 数量有上限（通常同源下不超过 20 个），且单个 Worker 占用的内存有限制（避免滥用系统资源）。</li>
</ol>
<p><strong>关键区别</strong>：与 Node.js 的 <code>child_process</code> 不同，Web Worker 无法共享内存（需通过 <code>SharedArrayBuffer</code> 实现有限共享，见下文），且受浏览器安全策略（如跨域限制）约束。</p>
<p><strong>总结：</strong>
webwork是通过js的方式唤起浏览器的内置api使用，辅助前端计算的一种方式，就像fetch、ajaix那样唤起浏览器的接口查询一样。</p>
<h3 data-id="heading-1">多线程四大API</h3>
<p>Web Worker 是前端 “多线程” 的基础规范，但浏览器针对不同场景设计了 <strong>4 种独立的 Worker 类型</strong>—— 它们共享 “线程隔离” 的核心思想（避免阻塞主线程），但定位、能力、使用场景完全不同，均为 W3C 标准定义的原生 API（无需第三方库），底层由浏览器独立实现（无依赖关系）。</p>
<h4 data-id="heading-2">浏览器 4 种核心 Worker 类型对比表</h4>



































<table><thead><tr><th>Worker 类型</th><th>核心定位</th><th>底层依赖</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>主线程的 “计算助手”，处理耗时计算</td><td>浏览器线程池</td><td>大数据排序、加密解密、复杂算法计算</td></tr><tr><td><strong>Shared Worker</strong></td><td>多页面共享的 “后台协调者”，跨页面通信</td><td>浏览器共享线程</td><td>多标签页登录状态同步、跨页数据协同</td></tr><tr><td><strong>Service Worker</strong></td><td>页面离线的 “代理服务器”，拦截请求 + 缓存</td><td>浏览器后台线程</td><td>离线应用、请求拦截优化、浏览器推送通知</td></tr><tr><td><strong>Worklet</strong></td><td>渲染管线的 “实时处理器”，介入渲染流程</td><td>浏览器渲染线程</td><td>CSS 物理动画、音频降噪、Canvas 渲染优化</td></tr></tbody></table>
<h3 data-id="heading-3">二、分类</h3>
<h4 data-id="heading-4">1. Web Worker（计算型：解决主线程阻塞）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>独立于主线程的 “计算线程”，仅与创建它的主线程通信（一对一）；</li>
</ul>

<ul>
<li>生命周期与页面绑定（页面关闭则 Worker 销毁）；</li>
</ul>

<ul>
<li>不阻塞 UI，专门处理耗时计算（避免页面卡顿）。</li>
</ul>
<p><strong>示例：10 万条数据排序</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：发起计算请求，接收结果</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">Worker</span>) {
  <span class="hljs-comment">// 1. 创建 Worker 实例</span>
  <span class="hljs-keyword">const</span> sortWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'sort-worker.js'</span>);
  
  <span class="hljs-comment">// 2. 生成 10 万条随机大数据（模拟复杂计算场景）</span>
  <span class="hljs-keyword">const</span> bigData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100000</span>);
  
  <span class="hljs-comment">// 3. 发送数据给 Worker，触发计算</span>
  sortWorker.<span class="hljs-title function_">postMessage</span>(bigData);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：已发送数据，等待排序结果...'</span>);
  
  <span class="hljs-comment">// 4. 接收 Worker 返回的计算结果</span>
  sortWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：排序完成，前 10 条数据：'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>));
    sortWorker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 计算完成，销毁 Worker（避免内存泄漏）</span>
  };
  
  <span class="hljs-comment">// 5. 监听 Worker 错误（如代码报错）</span>
  sortWorker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker 错误：<span class="hljs-subst">${err.message}</span>（行号：<span class="hljs-subst">${err.lineno}</span>）`</span>);
    sortWorker.<span class="hljs-title function_">terminate</span>();
  };
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'当前浏览器不支持 Web Worker'</span>);
}
<span class="hljs-comment">// Worker 线程（sort-worker.js）：执行耗时计算</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = e.<span class="hljs-property">data</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker 线程：开始排序 10 万条数据...'</span>);
  
  <span class="hljs-comment">// 耗时计算（示例用内置排序，实际可替换为快排、归并等复杂算法）</span>
  <span class="hljs-keyword">const</span> sortedData = data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
  
  <span class="hljs-comment">// 向主线程返回结果</span>
  self.<span class="hljs-title function_">postMessage</span>(sortedData);
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// Worker 主动关闭，释放资源</span>
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>主线程可正常处理用户交互（点击、滚动），排序在后台线程执行，页面无卡顿；计算完成后自动销毁 Worker，无内存泄漏。</p>
<h4 data-id="heading-5">2. Shared Worker（协同型：多页面数据同步）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>同源多页面可共享同一个 Worker 实例（突破 “单页面私有” 限制）；</li>
</ul>

<ul>
<li>通过 port（通信端口）实现多页面与 Worker 的双向通信；</li>
</ul>

<ul>
<li>适合跨页面状态同步（无需重复请求接口）。</li>
</ul>
<p><strong>示例：多标签页登录状态同步</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程 - 页面 A（login.html）：登录后同步状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-comment">// 1. 创建 Shared Worker 实例</span>
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  <span class="hljs-comment">// 2. 激活通信端口（必须调用 start()）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 3. 模拟登录按钮点击，发送登录状态给 Worker</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'login-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> userInfo = { <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>, <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span> };
    sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN'</span>, <span class="hljs-attr">data</span>: userInfo });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A：已发送登录状态'</span>);
  });
  
  <span class="hljs-comment">// 4. 接收 Worker 广播的消息（如其他页面同步的状态）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A 收到消息：'</span>, e.<span class="hljs-property">data</span>);
  };
}
<span class="hljs-comment">// 主线程 - 页面 B（index.html）：实时获取登录状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 1. 向 Worker 请求当前登录状态</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'QUERY_STATUS'</span> });
  
  <span class="hljs-comment">// 2. 接收状态（页面 A 登录后，页面 B 实时更新）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'LOGIN_STATUS'</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">textContent</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">isLogin</span> 
        ? <span class="hljs-string">`已登录：<span class="hljs-subst">${e.data.username}</span>`</span> 
        : <span class="hljs-string">'未登录'</span>;
    }
  };
}
<span class="hljs-comment">// Shared Worker 线程（sync-worker.js）：维护全局状态，广播消息</span>
<span class="hljs-keyword">const</span> connections = []; <span class="hljs-comment">// 存储所有连接的页面端口</span>
<span class="hljs-keyword">let</span> globalState = { <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">''</span> }; <span class="hljs-comment">// 全局共享状态</span>
<span class="hljs-comment">// 监听页面连接（新页面打开时触发）</span>
self.<span class="hljs-property">onconnect</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
  connections.<span class="hljs-title function_">push</span>(port); <span class="hljs-comment">// 记录新连接的页面</span>
  port.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 处理页面发送的消息</span>
  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span> (msg.<span class="hljs-property">data</span>.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'LOGIN'</span>:
        <span class="hljs-comment">// 更新全局状态</span>
        globalState = msg.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 广播给所有连接的页面（同步状态到页面 A、B...）</span>
        connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">postMessage</span>({ 
          <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, 
          ...globalState 
        }));
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'QUERY_STATUS'</span>:
        <span class="hljs-comment">// 单独响应某个页面的状态查询</span>
        port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, ...globalState });
        <span class="hljs-keyword">break</span>;
    }
  };
  
  <span class="hljs-comment">// 页面关闭时，移除端口（避免内存泄漏）</span>
  port.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> index = connections.<span class="hljs-title function_">indexOf</span>(port);
    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) connections.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  };
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>页面 A 点击 “登录” 后，页面 B 无需刷新，实时显示 “已登录：admin”；多标签页共享同一登录状态，无需重复调用登录接口。</p>
<h4 data-id="heading-6">3. Service Worker（网络型：离线缓存 + 请求拦截）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>完全独立于页面，运行在浏览器后台（页面关闭后仍可活动）；</li>
</ul>

<ul>
<li>拦截所有网络请求，可自定义缓存策略（实现离线访问）；</li>
</ul>

<ul>
<li>生命周期包含 “安装→激活→运行”，需手动管理缓存版本。</li>
</ul>
<p><strong>示例：离线缓存静态资源 + API 请求</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：注册 Service Worker，触发离线逻辑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 注册 Service Worker（脚本需在根目录，确保作用域覆盖所有页面）</span>
      <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功，作用域：'</span>, registration.<span class="hljs-property">scope</span>);
      
      <span class="hljs-comment">// 2. 测试离线请求（首次联网缓存，后续断网可访问）</span>
      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API 请求结果：'</span>, data);
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Service Worker 注册失败：'</span>, err);
    }
  });
}
<span class="hljs-comment">// Service Worker 线程（sw.js）：缓存+请求拦截逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'offline-cache-v1'</span>; <span class="hljs-comment">// 缓存版本（更新时修改版本号）</span>
<span class="hljs-comment">// 需要缓存的资源列表（静态资源+API接口）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_ASSETS</span> = [
  <span class="hljs-string">'/'</span>, 
  <span class="hljs-string">'/index.html'</span>,
  <span class="hljs-string">'/styles.css'</span>,
  <span class="hljs-string">'/api/data'</span> <span class="hljs-comment">// 需缓存的 API 接口</span>
];
<span class="hljs-comment">// 1. 安装阶段：缓存静态资源（仅首次注册/版本更新时触发）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 等待缓存完成后，再进入激活阶段</span>
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">CACHE_ASSETS</span>)) <span class="hljs-comment">// 批量缓存资源</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>()) <span class="hljs-comment">// 跳过等待，立即激活新 Worker（替换旧版本）</span>
  );
});
<span class="hljs-comment">// 2. 激活阶段：清理旧缓存（避免缓存膨胀）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-comment">// 删除非当前版本的缓存</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(name))
      );
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>()) <span class="hljs-comment">// 强制所有打开的页面使用新 Worker</span>
  );
});
<span class="hljs-comment">// 3. 拦截请求：优先从缓存返回，无缓存则请求网络</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 仅拦截同源的 GET 请求（避免跨域资源和非幂等请求）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; event.<span class="hljs-property">request</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'same-origin'</span>) {
    event.<span class="hljs-title function_">respondWith</span>(
      caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
          <span class="hljs-comment">// 缓存命中：直接返回缓存资源</span>
          <span class="hljs-keyword">if</span> (cachedResponse) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从缓存返回：'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
            <span class="hljs-keyword">return</span> cachedResponse;
          }
          <span class="hljs-comment">// 缓存未命中：发起网络请求，并缓存新结果</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
              cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, networkResponse.<span class="hljs-title function_">clone</span>()); <span class="hljs-comment">// 缓存新请求</span>
            });
            <span class="hljs-keyword">return</span> networkResponse;
          });
        })
    );
  }
});
</code></pre>
<p><strong>运行效果</strong>：</p>
<ul>
<li>首次联网时，自动缓存 index.html、styles.css 和 /api/data；</li>
</ul>

<ul>
<li>断网后刷新页面，仍能正常加载页面和 API 数据（从缓存读取）；</li>
</ul>

<ul>
<li>缓存版本更新时，自动清理旧缓存，避免资源冗余。</li>
</ul>
<h4 data-id="heading-7">4. Worklet（实时型：介入渲染流程）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>嵌入浏览器渲染管线（如 CSS 引擎线程、音频线程），低延迟（&lt;1ms）；</li>
</ul>

<ul>
<li>直接干预渲染过程（动画、绘制、音频处理），弥补 Web Worker 通信延迟的缺陷；</li>
</ul>

<ul>
<li>细分类型：CSSWorklet（动画）、AudioWorklet（音频）、PaintWorklet（绘制）。</li>
</ul>
<p><strong>示例：CSSWorklet 实现物理弹性动画</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主线程（main.js）：注册 Worklet，关联动画</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 注册自定义 Worklet（加载动画逻辑脚本）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'bounce-worklet.js'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'CSSWorklet 注册失败：'</span>, err);
  }
}
<span class="hljs-comment">// HTML 结构：动画元素</span>
<span class="hljs-comment">/*
&lt;div class="box"&gt;弹性动画方块&lt;/div&gt;
*/</span>
<span class="hljs-comment">// CSS 样式：绑定 Worklet 动画</span>
<span class="hljs-comment">/*
.box {
  width: 100px;
  height: 100px;
  background: red;
  /* 使用 Worklet 定义的动画（名称与 Worklet 中注册一致） */</span>
  <span class="hljs-attr">animation</span>: bounce 2s infinite;
}
<span class="hljs-comment">/* 定义动画进度（from→to 对应 Worklet 中的 0→1） */</span>
<span class="hljs-meta">@keyframes</span> bounce {
  <span class="hljs-keyword">from</span> { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(<span class="hljs-number">0</span>); }
  to { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(300px); }
}
*/
<span class="hljs-comment">// CSSWorklet 线程（bounce-worklet.js）：自定义动画逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BounceWorklet</span> {
  <span class="hljs-comment">// 每一帧的计算（嵌入渲染管线，实时执行）</span>
  <span class="hljs-title function_">process</span>(<span class="hljs-params">inputs, outputs, parameters</span>) {
    <span class="hljs-keyword">const</span> [t] = inputs; <span class="hljs-comment">// 动画进度（0~1，from→to）</span>
    <span class="hljs-keyword">const</span> [output] = outputs; <span class="hljs-comment">// 输出结果（最终的 CSS 样式值）</span>
    
    <span class="hljs-comment">// 物理弹性公式（模拟重力+反弹效果，非匀速动画）</span>
    <span class="hljs-keyword">const</span> bounce = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-t * <span class="hljs-number">0.5</span>);
    <span class="hljs-comment">// 输出 transform 样式（控制方块位置）</span>
    output.<span class="hljs-property">value</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${<span class="hljs-number">300</span> * (<span class="hljs-number">1</span> - bounce)}</span>px)`</span>;
  }
}
<span class="hljs-comment">// 注册 Worklet 动画（名称需与 CSS 中的 @keyframes 名称一致）</span>
<span class="hljs-title function_">registerAnimator</span>(<span class="hljs-string">'bounce'</span>, <span class="hljs-title class_">BounceWorklet</span>);
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>红色方块以 “物理弹性轨迹” 上下运动（类似小球落地反弹），动画流畅无卡顿；Worklet 运行在渲染线程，延迟极低，避免 Web Worker 通信导致的动画掉帧。</p>
<h3 data-id="heading-8">三、混合使用：多 Worker 协同解决复杂场景</h3>
<h4 data-id="heading-9">场景需求：离线数据分析 Dashboard</h4>
<p>需要同时满足 4 个核心需求：</p>
<ol>
<li>离线访问（断网后仍可查看历史数据）；</li>
</ol>

<ol start="2">
<li>多标签页同步分析结果（无需重复解析）；</li>
</ol>

<ol start="3">
<li>后台解析 10 万条 CSV 数据（不阻塞页面）；</li>
</ol>

<ol start="4">
<li>实时渲染流畅图表（动画无掉帧）。</li>
</ol>
<h4 data-id="heading-10">完整实现代码（整合 4 种 Worker）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（dashboard.js）：整合所有 Worker，协调流程</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 第一步：注册 Service Worker（离线缓存）</span>
      <span class="hljs-keyword">const</span> swRegistration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功'</span>);
      <span class="hljs-comment">// 2. 第二步：创建 Shared Worker（多页面同步）</span>
      <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
      sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
      <span class="hljs-comment">// 3. 第三步：创建 Web Worker（CSV 数据解析）</span>
      <span class="hljs-keyword">const</span> csvWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'csv-worker.js'</span>);
      <span class="hljs-comment">// 4. 第四步：注册 CSSWorklet（图表动画优化）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'chart-worklet.js'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
      }
      <span class="hljs-comment">// 5. 页面元素：文件上传、图表容器、状态文本</span>
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'file-upload'</span>);
      <span class="hljs-keyword">const</span> chartContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chart-container'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
      <span class="hljs-comment">// 6. 监听文件上传：触发 CSV 解析</span>
      fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (file &amp;&amp; file.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.csv'</span>)) {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'正在解析 CSV 文件...'</span>;
          csvWorker.<span class="hljs-title function_">postMessage</span>(file); <span class="hljs-comment">// 发送文件给 Web Worker</span>
        } <span class="hljs-keyword">else</span> {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'请上传 CSV 格式文件！'</span>;
        }
      });
      <span class="hljs-comment">// 7. 接收 Web Worker 解析结果：渲染+同步+缓存</span>
      csvWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> analysisResult = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// 解析结果（数据数组+统计信息）</span>
        
        <span class="hljs-comment">// 7.1 渲染图表（用 CSSWorklet 优化动画）</span>
        <span class="hljs-title function_">renderChart</span>(analysisResult, chartContainer);
        
        <span class="hljs-comment">// 7.2 同步结果到其他标签页（通过 Shared Worker）</span>
        sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'ANALYSIS_RESULT'</span>,
          <span class="hljs-attr">data</span>: analysisResult
        });
        
        <span class="hljs-comment">// 7.3 缓存结果到 Service Worker（支持离线访问）</span>
        <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>) {
          navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'CACHE_RESULT'</span>,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'last-csv-analysis'</span>,
            <span class="hljs-attr">data</span>: analysisResult
          });
        }
        
        <span class="hljs-comment">// 7.4 更新状态文本</span>
        statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">`解析完成：共 <span class="hljs-subst">${analysisResult.totalCount}</span> 条&lt;/doubaocanvas&gt;
</span></code></pre>
<h3 data-id="heading-11">四、关于self</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 来源：Worker 线程的内置全局对象，浏览器自动注入，无需定义</span>
<span class="hljs-comment">// 2. 作用：等同于主线程的 window，是 Worker 线程访问自身能力的入口</span>
<span class="hljs-comment">// 3. 隔离性：不同 Worker 的 self 是独立实例，互不干扰（如 Web Worker 的 self ≠ Service Worker 的 self）</span>
<span class="hljs-comment">// 4. 核心能力：接收/发送消息（onmessage/postMessage）、管理生命周期（close）、调用 Worker 专属 API</span>
</code></pre>
<h5 data-id="heading-12">Worker 中 self 的简单代码示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker 线程（calc-worker.js）</span>
<span class="hljs-comment">// self 指向当前 Web Worker 实例，仅用于计算相关逻辑</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { num1, num2 } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> sum = num1 + num2; <span class="hljs-comment">// 简单计算：两数相加</span>
  self.<span class="hljs-title function_">postMessage</span>(sum); <span class="hljs-comment">// 用 self 向主线程返回结果</span>
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 用 self 主动关闭 Worker，释放资源</span>
};
<span class="hljs-comment">// 主线程（main.js）- 配合使用</span>
<span class="hljs-keyword">const</span> calcWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'calc-worker.js'</span>);
calcWorker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">num1</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">num2</span>: <span class="hljs-number">20</span> }); <span class="hljs-comment">// 发数据给 Worker</span>
calcWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// 输出 30</span>
};
</code></pre>
<h5 data-id="heading-13">注意：</h5>
<pre><code class="hljs language-lua" lang="lua">// 注意 <span class="hljs-number">1</span>：Worker 中不能用 window，必须用 <span class="hljs-built_in">self</span>（因 Worker 无窗口概念）
// 注意 <span class="hljs-number">2</span>：<span class="hljs-built_in">self</span> 无法访问 DOM（如 document、body），仅能处理非 UI 逻辑
// 注意 <span class="hljs-number">3</span>：简单场景可省略 <span class="hljs-built_in">self</span>（如 onmessage = () =&gt; {} 等同于 <span class="hljs-built_in">self</span>.onmessage = () =&gt; {}），但复杂场景建议保留，增强可读性
</code></pre>
<h3 data-id="heading-14">五、生产环境使用的平衡点</h3>
<h4 data-id="heading-15">1. 错误处理与健壮性</h4>
<ul>
<li>
<p>Worker 内部错误不会冒泡到主线程，需单独监听：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程</span>
worker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker错误：<span class="hljs-subst">${err.message}</span>`</span>);
  worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 出错后销毁Worker，避免内存泄漏</span>
};

<span class="hljs-comment">// Worker线程</span>
self.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ERROR'</span>, <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> });
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 主动关闭</span>
};
</code></pre>
</li>
<li>
<p>网络错误：Worker 脚本加载失败（404）时，主线程会触发 <code>error</code> 事件，需捕获并降级处理。</p>
</li>
</ul>
<h4 data-id="heading-16">2. 内存管理与资源回收</h4>
<ul>
<li>避免创建过多 Worker：每个 Worker 都是独立线程，占用内存和 CPU，建议通过 “Worker 池” 复用（如用 <code>p-queue</code> 管理 Worker 实例）。</li>
<li>及时销毁无用 Worker：<code>worker.terminate()</code>（主线程主动销毁，立即终止）或 <code>self.close()</code>（Worker 主动关闭，清理后终止）。</li>
<li>警惕内存泄漏：Worker 中若持有 <code>setInterval</code>、未关闭的 <code>fetch</code> 请求等，即使调用 <code>terminate</code> 也可能导致内存泄漏，需先清理资源。</li>
</ul>
<h4 data-id="heading-17">3. 跨域与安全策略</h4>
<ul>
<li>Worker 脚本必须与主线程同源（协议、域名、端口一致），若需加载跨域脚本，需通过 <code>importScripts</code> 加载且服务器允许跨域（<code>Access-Control-Allow-Origin</code>）。</li>
<li>禁止访问 <code>file://</code> 协议下的脚本（浏览器安全限制），本地开发需用 <code>http-server</code> 启动服务。</li>
<li>敏感操作限制：Worker 中无法使用 <code>localStorage</code>（部分浏览器支持，但规范不推荐），建议用 <code>IndexedDB</code> 存储大量数据（异步 API，不阻塞）。</li>
</ul>
<h4 data-id="heading-18">4. 兼容性处理与降级方案</h4>
<ul>
<li>
<p>浏览器支持：IE 完全不支持，Edge 12+、Chrome 4+、Firefox 3.5+ 支持基本特性，<code>SharedArrayBuffer</code> 和 <code>SharedWorker</code> 兼容性较差。</p>
</li>
<li>
<p>降级逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">if (window.Worker) {
  <span class="hljs-comment">// 使用Worker</span>
} else {
  <span class="hljs-comment">// 降级到主线程执行（给用户提示“当前浏览器可能卡顿”）</span>
  <span class="hljs-built_in">heavyTask</span>();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">六、性能陷阱</h3>
<ol>
<li>
<p><strong>过度使用 Worker 导致性能反降</strong>小数据计算（如几毫秒可完成的操作）用 Worker 反而会增加通信开销（序列化 + 消息传递），建议仅对 <strong>执行时间 &gt; 50ms</strong> 的任务使用 Worker。</p>
</li>
<li>
<p><strong>频繁通信导致主线程阻塞</strong>若 Worker 与主线程高频次 <code>postMessage</code>（如每秒 hundreds 次），序列化数据会占用主线程资源，导致卡顿。解决方案：</p>
<ul>
<li>批量发送数据（累计一定量后再通信）；</li>
<li>用 <code>SharedArrayBuffer</code> 减少序列化开销。</li>
</ul>
</li>
<li>
<p><strong>Worker 中滥用同步 API</strong>Worker 虽然不阻塞 UI，但内部的同步操作（如 <code>XMLHttpRequest</code> 的同步请求、大量同步循环）会阻塞自身线程，导致无法响应消息。建议优先使用异步 API（<code>fetch</code>、<code>setImmediate</code>）。</p>
</li>
<li>
<p><strong>忽略线程优先级</strong>浏览器会给 Worker 分配较低的线程优先级，若需 “近实时” 处理（如游戏帧计算），可能出现延迟。此时可考虑 <code>requestIdleCallback</code> 结合 Worker，利用主线程空闲时间处理。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！]]></title>    <link>https://juejin.cn/post/7571355146770481194</link>    <guid>https://juejin.cn/post/7571355146770481194</guid>    <pubDate>2025-11-12T01:04:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770481194" data-draft-id="7559205383505526823" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！"/> <meta itemprop="keywords" content="Bun,Node.js,测试"/> <meta itemprop="datePublished" content="2025-11-12T01:04:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Legend80s"/> <meta itemprop="url" content="https://juejin.cn/user/2568105753839790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568105753839790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Legend80s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:04:05.000Z" title="Wed Nov 12 2025 01:04:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>假设我们的组件或函数内使用了 <code>setInterval</code> (<code>setTimeout</code> 同理)，如果不对其进行任何操作，“傻傻等待”的话，一个单元测试可能就要耗费几秒钟才能完成，甚至还可能超时。</p>
<p>老牌的 jest 或新的 vitest 以及 node:test 原生都支持“时间快进”。但是 bun:test（v1.2.23 2025-10-10）尚未支持 <code>jest/vi.advanceTimersByTime</code>，将报错：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 快进1秒，触发1次 setInterval 回调</span>
<span class="hljs-number">37</span> |   vi.<span class="hljs-title function_">advanceTimersByTime</span>(<span class="hljs-number">1000</span>)
          ^
<span class="hljs-title class_">TypeError</span>: vi.<span class="hljs-property">advanceTimersByTime</span> is not a <span class="hljs-keyword">function</span>. (<span class="hljs-title class_">In</span> <span class="hljs-string">'vi.advanceTimersByTime(1000)'</span>, <span class="hljs-string">'vi.advanceTimersByTime'</span> is <span class="hljs-literal">undefined</span>)
</code></pre>
<p>难道只能“坐以待毙”？不，我们还有一种workaround。就是通过重写或者说 mock 全局 <code>setInterval / setTimeout</code>。</p>
<p>效果一睹为快：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8a359406d474f0095f2cf286b556703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514245&amp;x-signature=BZpvpHv%2BJ5VZzyimXgBh%2FDk9A0M%3D" alt="成功将耗时从 2s+ 优化到 300ms+，是其 1/8" loading="lazy"/></p>
<h2 data-id="heading-0">解决办法：重写 <code>setInterval</code></h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-comment">// 1. 保存原始的 setInterval</span>
<span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
  <span class="hljs-comment">// @ts-expect-error</span>
  globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
    <span class="hljs-comment">// console.log('callback, delay:', { callback, delay })</span>

    <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === <span class="hljs-string">'deepThinkButtonInterval'</span>) {
      <span class="hljs-comment">// 返回一个原始 ID，并且内部调用原始函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">callback</span>()
      }, <span class="hljs-number">0</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
    }
  }
})

<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
  globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
})
</code></pre>
<h3 data-id="heading-1">使用</h3>
<p>假设我们有如下待测试代码，测试深度思考功能：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 逐个字符显示，当完整内容显示后停止</span>
timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepThinkButtonInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setThinkContent</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (text.<span class="hljs-property">length</span> &lt; <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 每次输出 N 个字符</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, text.<span class="hljs-property">length</span> + <span class="hljs-number">2</span>)
    }

    <span class="hljs-built_in">clearInterval</span>(timer)
    <span class="hljs-title function_">setThinkingStatus</span>(<span class="hljs-string">'Completed'</span>)
    <span class="hljs-title function_">setThinkingStopTime</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
    <span class="hljs-keyword">return</span> text
  })
}, <span class="hljs-number">20</span>)
</code></pre>
<p>执行</p>
<pre><code class="hljs language-ts" lang="ts">❯ bun test src/<span class="hljs-title class_">DeepThinkButton</span>/
</code></pre>
<p>正常情况耗时 2s+：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">2563.</span>00ms]
</code></pre>
<p>第一步修改待测试代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- timer = setInterval(() =&gt; {</span>
<span class="hljs-addition">+ timer = setInterval(function deepThinkButtonInterval() {</span>
</code></pre>
<p>也就是匿名函数改成具名函数，方便我们针对性 mock。</p>
<p>当我们给单测添加上述 mock 后，<strong>耗时减少到 1s+</strong>：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">1344.</span>00ms]
</code></pre>
<p>但其实我们还可以加速，即在一个 interval 回调中多次运行函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 运行 6 次</span>
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
  }, <span class="hljs-number">0</span>)
</code></pre>
<p>可以看到又从 <strong>1s+ 优化到了 300ms+ ⚡️ ！</strong></p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">328.</span>00ms]
</code></pre>
<p>成功将耗时从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">2s+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span> 优化到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn><mi>m</mi><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">300ms+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">300</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span>，是其 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>8</mn></mrow><annotation encoding="application/x-tex">1/8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1/8</span></span></span></span></span>！</p>
<h2 data-id="heading-2">重构</h2>
<p>目前只有一个 test case 还好，如果多个 case 需要则要避免违背 DRY 原则，所以接下来我们封装成函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// tests/utils.ts</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">advanceInterval</span>(<span class="hljs-params">
  callbackName: <span class="hljs-built_in">string</span>,
  { ms = <span class="hljs-number">0</span>, batchCalledCount = <span class="hljs-number">1</span> }: { ms?: <span class="hljs-built_in">number</span>; batchCalledCount?: <span class="hljs-built_in">number</span> } = {},
</span>) {
  <span class="hljs-comment">// 1. 保存原始的 setInterval</span>
  <span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
    <span class="hljs-comment">// @ts-expect-error</span>
    globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
      <span class="hljs-comment">// 返回一个模拟的ID，或者调用原始函数</span>
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === callbackName) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; batchCalledCount; i++) {
            <span class="hljs-title function_">callback</span>()
          }
        }, ms)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
      }
    }
  })

  <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
    globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
  })
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-diff" lang="diff">// src/DeepThinkButton/demo/advanced.test.tsx
import React from 'react'
import { test, expect } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'

import Demo from './advanced'
import { advanceInterval } from '@/tests/rtl'

<span class="hljs-addition">+ advanceInterval('deepThinkButtonInterval', { batchCalledCount: 6 })</span>

test('自定义 icon、按钮尺寸，以及思考内容折叠后效果', async () =&gt; {
  ...
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践]]></title>    <link>https://juejin.cn/post/7571379089991483446</link>    <guid>https://juejin.cn/post/7571379089991483446</guid>    <pubDate>2025-11-12T02:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991483446" data-draft-id="7571334572769771563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践"/> <meta itemprop="keywords" content="前端,HTML,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T02:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:49:48.000Z" title="Wed Nov 12 2025 02:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握HTML常用属性与全局属性的语义与行为，理解布尔/枚举属性的差异、跨源与安全相关属性的正确配置，并形成可落地的兼容性与可访问性最佳实践</p>
<p>📊 <strong>难度等级</strong>：初级-中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#属性</code> <code>#全局属性</code> <code>#布尔属性</code> <code>#data-*</code> <code>#ARIA</code> <code>#兼容性</code><br/>
⏱️ <strong>阅读时间</strong>：约9分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🌟 引言</h2>
<p>HTML 的属性（attribute）决定了元素的语义、行为和表现。看似简单的 <code>disabled</code>、<code>contenteditable</code>、<code>hidden</code> 或 <code>data-*</code>，在不同的上下文与浏览器实现中却有不少差异：布尔属性是否需要写值？枚举属性有哪些合法取值？<code>crossorigin</code> 与 <code>integrity</code> 如何协同保障资源安全？这些问题若处理不当，会带来可访问性、性能甚至安全风险。</p>
<p>在日常的前端开发中，你是否遇到过这样的困扰：</p>
<ul>
<li>布尔属性写成 <code>disabled="false"</code> 仍然生效，导致交互异常；</li>
<li>滥用 <code>contenteditable</code> 造成键盘可访问性退化；</li>
<li>外链脚本未配置 SRI 与 CORS，被安全策略拦截或错误不透明；</li>
<li>图片懒加载与解码策略混用，出现首屏闪烁与布局抖动；</li>
</ul>
<p>今天分享 7 个「属性行为与最佳实践」核心技巧，帮你在开发中少踩坑、写出更稳妥的页面。</p>
<hr/>
<h2 data-id="heading-1">💡 核心技巧详解</h2>
<blockquote>
<p>📝 使用说明：本文选择 7 个最常用、最易混淆的属性主题进行讲解，每节均含场景、常见误区、推荐方案与要点。</p>
</blockquote>
<h3 data-id="heading-2">1. 全局属性速查：语义清晰、行为可控</h3>
<h4 data-id="heading-3">🔍 应用场景</h4>
<p>需要为元素添加标识与语义、调整方向与可编辑性、控制显示与拖拽能力等通用行为。</p>
<p>常见的全局属性包括：<code>id</code>、<code>class</code>、<code>title</code>、<code>lang</code>、<code>dir</code>、<code>hidden</code>、<code>draggable</code>、<code>contenteditable</code>。</p>
<h4 data-id="heading-4">❌ 常见问题</h4>
<ul>
<li>滥用 <code>id</code> 导致页面内唯一性被破坏；</li>
<li><code>dir</code>/<code>lang</code> 未设置，RTL/LTR 文本方向或语言识别错误；</li>
<li>非必要场景启用 <code>contenteditable</code>，可访问性与输入法体验变差；</li>
<li>用 <code>hidden</code> 替代逻辑卸载，产生无意义的可聚焦元素。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：任意启用 contenteditable 与隐身元素可聚焦问题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑卡片"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：仅在明确编辑场景启用 contenteditable；按需设置语言与方向 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"profile"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"ltr"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"用户资料"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__title"</span>&gt;</span>资料<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__desc"</span>&gt;</span>可编辑区域仅限下面的备注。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑备注"</span>&gt;</span>在此添加备注...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 安全启用/关闭可编辑区域
 * <span class="hljs-doctag">@description</span> 根据布尔开关控制元素的 contenteditable 与可聚焦性
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">enable</span> - 是否启用可编辑
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleEditable</span> = (<span class="hljs-params">el, enable</span>) =&gt; {
  <span class="hljs-comment">// 仅在需要时才启用，避免全局滥用</span>
  el.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'contenteditable'</span>, enable ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>);
  el.<span class="hljs-property">tabIndex</span> = enable ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; <span class="hljs-comment">// 控制键盘可访问性</span>
};
</code></pre>
<h4 data-id="heading-6">💡 核心要点</h4>
<ul>
<li><code>id</code> 必须全页面唯一；</li>
<li>为文档或区域设置正确的 <code>lang</code> 与 <code>dir</code>；</li>
<li><code>hidden</code> 会将元素从可访问性树中移除（但仍在 DOM），用于暂时隐藏而非卸载；</li>
<li><code>contenteditable</code> 仅用于编辑场景，注意键盘与焦点管理。</li>
</ul>
<h4 data-id="heading-7">🎯 实际应用</h4>
<p>在富文本组件中，仅对编辑容器启用 <code>contenteditable</code>，同时结合 <code>aria-label</code> 与键盘导航提示改善可访问性。</p>
<hr/>
<h3 data-id="heading-8">2. 布尔属性行为：存在即为真，值会被忽略</h3>
<h4 data-id="heading-9">🔍 应用场景</h4>
<p>控制交互状态，如禁用、自动聚焦、必填、隐藏等：<code>disabled</code>、<code>autofocus</code>、<code>required</code>、<code>hidden</code>、<code>checked</code>。</p>
<h4 data-id="heading-10">❌ 常见问题</h4>
<ul>
<li>写成 <code>disabled="false"</code> 仍然是禁用；</li>
<li>将布尔属性赋为字符串，误以为可关闭行为；</li>
<li>误用 <code>autofocus</code> 影响无障碍体验（页面初始焦点跳跃）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：disabled="false" 仍然禁用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">"false"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：通过属性存在性表达布尔含义；JS 控制用 property 更直观 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitBtn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 切换布尔属性：存在即为真
 * <span class="hljs-doctag">@description</span> 使用 property 控制更直观，避免字符串赋值歧义
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLButtonElement</span>} <span class="hljs-variable">btn</span> - 目标按钮
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">disabled</span> - 是否禁用
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setDisabled</span> = (<span class="hljs-params">btn, disabled</span>) =&gt; {
  btn.<span class="hljs-property">disabled</span> = disabled; <span class="hljs-comment">// 使用 property 代替 setAttribute('disabled', 'false')</span>
};

<span class="hljs-comment">/**
 * 初始化页面焦点
 * <span class="hljs-doctag">@description</span> 谨慎使用 autofocus，优先在脚本中设定初始焦点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">target</span> - 需要获得焦点的元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initFocus</span> = (<span class="hljs-params">target</span>) =&gt; {
  target.<span class="hljs-title function_">focus</span>(); <span class="hljs-comment">// 统一在脚本中管理初始焦点</span>
};
</code></pre>
<h4 data-id="heading-12">💡 核心要点</h4>
<ul>
<li>布尔属性仅凭「存在」即可生效，属性值通常被忽略；</li>
<li>在 JS 中优先使用 property（如 <code>el.disabled = true</code>），更直观也更兼容；</li>
<li>避免在初始加载阶段使用 <code>autofocus</code> 影响读屏与键盘用户。</li>
</ul>
<h4 data-id="heading-13">🎯 实际应用</h4>
<p>表单组件库中统一封装 <code>disabled</code> 控制逻辑，所有按钮与输入框采用 property 控制，避免属性字符串误用。</p>
<hr/>
<h3 data-id="heading-14">3. 枚举属性：合法取值与默认行为</h3>
<h4 data-id="heading-15">🔍 应用场景</h4>
<p>控制策略选择或行为方式：<code>loading</code>（img：<code>auto</code>/<code>lazy</code>/<code>eager</code>）、<code>decoding</code>（img：<code>sync</code>/<code>async</code>/<code>auto</code>）、<code>crossorigin</code>（<code>anonymous</code>/<code>use-credentials</code>）、<code>autocomplete</code>（多枚举值）。</p>
<h4 data-id="heading-16">❌ 常见问题</h4>
<ul>
<li>写入不合法取值被忽略，导致行为回退到默认；</li>
<li>不了解默认值，造成性能或兼容性问题（如图片解码抖动）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：不合法取值将被忽略，退回默认行为 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"fast"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"quick"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-17">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 合法取值：lazy 与 async 可配合减少首屏抖动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"async"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 规范化枚举属性取值
 * <span class="hljs-doctag">@description</span> 保证属性在合法集合内，否则回退到安全默认
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">name</span> - 枚举属性名
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">allowed</span> - 合法取值集合
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">value</span> - 待设置的值
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setEnumAttr</span> = (<span class="hljs-params">el, name, allowed, value</span>) =&gt; {
  <span class="hljs-keyword">const</span> v = allowed.<span class="hljs-title function_">includes</span>(value) ? value : allowed[<span class="hljs-number">0</span>];
  el.<span class="hljs-title function_">setAttribute</span>(name, v);
};
</code></pre>
<h4 data-id="heading-18">💡 核心要点</h4>
<ul>
<li>明确每个枚举属性的合法取值集合与默认值；</li>
<li>图片建议 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少阻塞与抖动；</li>
<li>跨源枚举值仅限 <code>anonymous</code> 与 <code>use-credentials</code>，影响资源请求与错误可见性。</li>
</ul>
<h4 data-id="heading-19">🎯 实际应用</h4>
<p>资源管理组件统一通过枚举校验函数设置 <code>loading</code>/<code>decoding</code>，确保配置合法与表现稳定。</p>
<hr/>
<h3 data-id="heading-20">4. 数据属性 data-* 与 dataset：结构化携带业务数据</h3>
<h4 data-id="heading-21">🔍 应用场景</h4>
<p>在不污染语义的前提下，为元素附加结构化元数据，配合脚本读取与更新。</p>
<h4 data-id="heading-22">❌ 常见问题</h4>
<ul>
<li>将业务状态塞进 <code>class</code>/<code>id</code>，难以维护；</li>
<li>用 <code>innerHTML</code> 拼字符串读取数据，易遭XSS风险。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：用 class/id 存业务状态，耦合样式与脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"order_1234"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-23">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：使用 data-* 描述元数据，脚本通过 dataset 读取/更新 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderBtn"</span> <span class="hljs-attr">data-order-id</span>=<span class="hljs-string">"1234"</span> <span class="hljs-attr">data-state</span>=<span class="hljs-string">"processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 读取并更新 dataset
 * <span class="hljs-doctag">@description</span> 通过 dataset 读取/写入 data-*，保持结构化与安全
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">{orderId:string,state:string</span>}}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useDataset</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> { orderId, state } = el.<span class="hljs-property">dataset</span>;
  <span class="hljs-comment">// 更新状态为已完成</span>
  el.<span class="hljs-property">dataset</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'done'</span>;
  <span class="hljs-keyword">return</span> { orderId, state };
};
</code></pre>
<h4 data-id="heading-24">💡 核心要点</h4>
<ul>
<li><code>data-*</code> 值始终是字符串；复杂数据请用 JSON 并在脚本中解析；</li>
<li>读取使用 <code>el.dataset.xxx</code>（自动将 <code>data-xxx</code> 转驼峰）；</li>
<li>避免将视觉样式与业务状态耦合在 <code>class</code>/<code>id</code>。</li>
</ul>
<h4 data-id="heading-25">🎯 实际应用</h4>
<p>在列表项中用 <code>data-id</code>/<code>data-type</code> 附加元数据，事件委托时通过 <code>dataset</code> 精确识别目标项。</p>
<hr/>
<h3 data-id="heading-26">5. 表单属性最佳实践：可用性与安全</h3>
<h4 data-id="heading-27">🔍 应用场景</h4>
<p>文件选择与拍照、自动完成功能、输入合法性：<code>accept</code>、<code>capture</code>、<code>autocomplete</code>、<code>required</code> 等。</p>
<h4 data-id="heading-28">❌ 常见问题</h4>
<ul>
<li><code>accept</code> 写错 MIME/扩展名，导致系统选择器无法过滤；</li>
<li><code>capture</code> 盲目开启，移动端直接拉起摄像头影响体验；</li>
<li><code>autocomplete</code> 未按枚举值配置，自动填充失败或扰民。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：accept 写错扩展名或缺少 MIME --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpg"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-29">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：精确的 MIME 或扩展名；按需配置 capture 与 autocomplete --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpeg,image/png"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cameraInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span> <span class="hljs-attr">capture</span>=<span class="hljs-string">"environment"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验文件选择类型
 * <span class="hljs-doctag">@description</span> 检查文件扩展名是否符合 accept 策略
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 用户选择的文件
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否通过校验
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateFileType</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">const</span> ok = <span class="hljs-regexp">/(jpe?g|png)$/i</span>.<span class="hljs-title function_">test</span>(file.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-30">💡 核心要点</h4>
<ul>
<li><code>accept</code> 建议使用 MIME 类型（更通用）+ 扩展名兜底；</li>
<li>移动端谨慎使用 <code>capture</code>，为用户保留从相册选择的路径；</li>
<li><code>autocomplete</code> 使用标准枚举取值提升可用性与安全（如 <code>email</code>、<code>username</code>、<code>current-password</code>）。</li>
</ul>
<h4 data-id="heading-31">🎯 实际应用</h4>
<p>上传组件在客户端先做轻量类型校验，失败时不触发网络请求，减少后端压力与无效流量。</p>
<hr/>
<h3 data-id="heading-32">6. 跨源与安全属性：<code>crossorigin</code>、<code>integrity</code>、<code>referrerpolicy</code></h3>
<h4 data-id="heading-33">🔍 应用场景</h4>
<p>外链脚本/样式/图片资源的安全与错误透明化，CDN 资源加载。</p>
<h4 data-id="heading-34">❌ 常见问题</h4>
<ul>
<li>使用 SRI（<code>integrity</code>）却未设置匹配的 CORS（<code>crossorigin</code>），导致校验失败或错误不可见；</li>
<li>未配置 <code>referrerpolicy</code>，敏感页面泄露来源信息。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：SRI 未配合 CORS，可能导致资源校验失败或错误信息被隐藏 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span> <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-35">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ SRI + CORS 协同；可按需设置 referrerpolicy --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
  <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">"no-referrer"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验跨源配置是否完整
 * <span class="hljs-doctag">@description</span> 简单检查元素是否同时具备 integrity 与合适的 crossorigin
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLScriptElement</span>} <span class="hljs-variable">el</span> - 外链脚本元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否满足基本安全配置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkCrossOriginSafety</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> hasSRI = !!el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'integrity'</span>);
  <span class="hljs-keyword">const</span> co = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'crossorigin'</span>);
  <span class="hljs-keyword">const</span> ok = hasSRI &amp;&amp; (co === <span class="hljs-string">'anonymous'</span> || co === <span class="hljs-string">'use-credentials'</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-36">💡 核心要点</h4>
<ul>
<li>SRI 要与 <code>crossorigin</code> 协同；</li>
<li><code>referrerpolicy</code> 根据场景合理配置（如下载页可用 <code>no-referrer</code>）；</li>
<li>了解错误可见性：跨源脚本在无 CORS 时错误堆栈受限。</li>
</ul>
<h4 data-id="heading-37">🎯 实际应用</h4>
<p>CDN 资源统一模板化：所有外链脚本/样式自动附加 <code>integrity</code> 与 <code>crossorigin</code>，并提供策略位可配置 <code>referrerpolicy</code>。</p>
<hr/>
<h3 data-id="heading-38">7. 可访问性与 ARIA：属性与角色的协同</h3>
<h4 data-id="heading-39">🔍 应用场景</h4>
<p>自定义组件（如伪按钮、可折叠区域）需要通过 <code>role</code> 与 <code>aria-*</code> 提升语义与可操作性。</p>
<h4 data-id="heading-40">❌ 常见问题</h4>
<ul>
<li>仅靠 <code>div</code> + 点击事件充当按钮，键盘用户无法操作；</li>
<li>误用 <code>aria-*</code> 与原生属性冲突（如对 <code>&lt;button&gt;</code> 重复声明 <code>role="button"</code>）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：无键盘可访问性与语义缺失 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doLike()"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-41">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 使用 role 与 aria-* 改善语义与交互；同时处理键盘事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"点赞"</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 为伪按钮添加键盘可访问性
 * <span class="hljs-doctag">@description</span> 处理 Enter/Space 键以触发点击行为
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 伪按钮元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">onActive</span> - 激活时的回调
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">enhancePseudoButton</span> = (<span class="hljs-params">el, onActive</span>) =&gt; {
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> k = e.<span class="hljs-property">key</span>;
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'Enter'</span> || k === <span class="hljs-string">' '</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-title function_">onActive</span>();
    }
  });
};
</code></pre>
<h4 data-id="heading-42">💡 核心要点</h4>
<ul>
<li>原生控件优先（<code>&lt;button&gt;</code>、<code>&lt;a&gt;</code> 等）；若必须自定义，再使用 <code>role</code> 与 <code>aria-*</code>；</li>
<li>始终为可交互元素提供键盘等效操作；</li>
<li>避免与原生属性冲突的冗余 <code>role</code> 声明。</li>
</ul>
<h4 data-id="heading-43">🎯 实际应用</h4>
<p>在卡片组件的可折叠区域使用 <code>aria-expanded</code> 与键盘事件，保证读屏与键盘用户体验一致。</p>
<hr/>
<h2 data-id="heading-44">📊 技巧对比总结</h2>





















































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>全局属性速查</td><td>元素语义与行为</td><td>统一管理 <code>lang/dir</code> 与编辑性</td><td>慎用 <code>contenteditable</code> 与 <code>hidden</code></td></tr><tr><td>布尔属性行为</td><td>交互禁用/焦点</td><td>property 控制直观兼容</td><td>避免 <code>autofocus</code> 影响可访问性</td></tr><tr><td>枚举属性</td><td>资源加载与策略</td><td>明确合法取值与默认值</td><td><code>crossorigin</code> 仅两种取值</td></tr><tr><td>data-* 与 dataset</td><td>携带元数据</td><td>结构化与安全</td><td>值为字符串，复杂用 JSON</td></tr><tr><td>表单属性</td><td>文件与自动填充</td><td>可用性与安全</td><td>谨慎 <code>capture</code>，精确 <code>accept</code></td></tr><tr><td>跨源与安全</td><td>外链资源</td><td>SRI + CORS 协同</td><td>错误可见性受跨源影响</td></tr><tr><td>ARIA 可访问性</td><td>自定义组件</td><td>语义与键盘可用性</td><td>避免与原生属性冲突</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-45">🎯 实战应用建议</h2>
<h3 data-id="heading-46">最佳实践</h3>
<ol>
<li>全局启用文档 <code>lang</code> 与合理的 <code>dir</code> 配置，国际化场景更稳。</li>
<li>统一封装布尔属性控制，全部走 property（<code>el.disabled = true</code>）。</li>
<li>图片使用 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少首屏阻塞与抖动。</li>
<li>业务元数据统一使用 <code>data-*</code>，避免与样式耦合。</li>
<li>表单的 <code>accept/capture/autocomplete</code> 按枚举规范配置，兼顾体验与安全。</li>
<li>外链资源模板化 SRI + CORS，必要时加 <code>referrerpolicy</code>，保障安全与隐私。</li>
</ol>
<h3 data-id="heading-47">性能考虑</h3>
<ul>
<li>图片与媒体优先使用懒加载与异步解码；</li>
<li>减少不必要的可编辑区域与聚焦跳转；</li>
<li>外链资源开启校验与跨源配置，降低失败成本并提升错误可见性。</li>
</ul>
<hr/>
<h2 data-id="heading-48">💡 总结</h2>
<p>这 7 个属性主题覆盖了日常开发中最常见且最易混淆的行为。掌握它们能让你的页面：</p>
<ol>
<li>更语义化、可访问；</li>
<li>更可控、少踩坑；</li>
<li>更安全、可观测；</li>
<li>更稳定、高性能。</li>
</ol>
<hr/>
<h2 data-id="heading-49">🔗 相关资源</h2>
<ul>
<li>MDN: HTML attribute reference — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FAttributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Global attributes — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FGlobal_attributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: ARIA roles, states and properties — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAccessibility%2FARIA" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Subresource Integrity (SRI) — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：理解了布尔与枚举属性的差异、data-* 的安全用法与跨源安全配置的关键点，能够在项目中落地更稳妥的属性策略。</p>
</blockquote>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏和分享！有任何问题也欢迎在评论区讨论。</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制]]></title>    <link>https://juejin.cn/post/7571351275976605747</link>    <guid>https://juejin.cn/post/7571351275976605747</guid>    <pubDate>2025-11-12T00:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571351275976605747" data-draft-id="7571352754896437274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-12T00:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:21:57.000Z" title="Wed Nov 12 2025 00:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在进行网页爬取时，如果频繁访问同一网站，极有可能被网站识别为爬虫，从而封禁 IP 或要求验证码验证。
为了保证爬虫稳定、高效运行，我们需要了解并掌握 <strong>防封机制与代理使用方法</strong>。</p>
</blockquote>
<p>本章将介绍 Python 爬虫中常用的防封策略、代理原理及实战应用技巧。</p>
<hr/>
<h2 data-id="heading-0">一、为什么会被封</h2>
<p>网站封禁爬虫主要是为了防止资源滥用与服务器过载。常见的封禁手段包括：</p>
<ol>
<li><strong>IP 封禁</strong>：短时间内请求频繁，直接拉黑访问 IP。</li>
<li><strong>User-Agent 检测</strong>：识别请求头中是否包含浏览器标识。</li>
<li><strong>Referer 检查</strong>：判断请求是否来自正常页面跳转。</li>
<li><strong>Cookie 校验</strong>：验证登录状态或访问来源。</li>
<li><strong>请求频率限制</strong>：同一用户短时间内过多请求触发反爬。</li>
</ol>
<p>要应对这些情况，我们可以从 <strong>“伪装自己”</strong> 和 <strong>“多IP访问”</strong> 两个方向入手。</p>
<hr/>
<h2 data-id="heading-1">二、请求伪装：模拟真实用户访问</h2>
<h3 data-id="heading-2">1. 设置请求头</h3>
<p><code>requests</code> 支持通过 <code>headers</code> 参数自定义请求头。
常见做法是添加浏览器信息，让服务器认为请求来自正常用户。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://example.com"</span>
headers = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span>
                  <span class="hljs-string">"AppleWebKit/537.36 (KHTML, like Gecko) "</span>
                  <span class="hljs-string">"Chrome/122.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Referer"</span>: <span class="hljs-string">"https://www.google.com"</span>,
}
response = requests.get(url, headers=headers)
<span class="hljs-built_in">print</span>(response.status_code)
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 随机切换 User-Agent</h3>
<p>为了避免单一 User-Agent 被识别为爬虫，可以在请求中随机切换浏览器标识。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random

user_agents = [
    <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Firefox/124.0"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Linux; Android 10) Mobile Safari/537.36"</span>,
]

headers = {<span class="hljs-string">"User-Agent"</span>: random.choice(user_agents)}
</code></pre>
<p>每次访问时随机选择一个头部，能有效减少被识别风险。</p>
<hr/>
<h3 data-id="heading-4">3. 添加延时与随机等待</h3>
<p>频繁访问网站最容易触发风控。
合理的做法是添加访问间隔，并随机化等待时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random

time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 等待1~3秒</span>
</code></pre>
<p>这样能让访问节奏更像人类操作。</p>
<hr/>
<h2 data-id="heading-5">三、使用代理服务器（Proxy）</h2>
<p>当 IP 被封时，使用代理服务器可以切换出口 IP，从而继续访问。</p>
<p>代理服务器会代替你访问目标网站，然后将结果返回。
Python 中可以通过 <code>requests</code> 轻松使用代理。</p>
<hr/>
<h3 data-id="heading-6">1. 设置代理参数</h3>
<pre><code class="hljs language-python" lang="python">proxies = {
    <span class="hljs-string">"http"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"https"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
}

response = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxies, timeout=<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>如果代理有效，返回的 IP 将与本机不同。</p>
<hr/>
<h3 data-id="heading-7">2. 使用代理池（Proxy Pool）</h3>
<p>手动设置代理不方便，可以使用 <strong>代理池</strong> 自动随机选取可用代理。</p>
<p>简单示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time

proxies_list = [
    <span class="hljs-string">"http://111.22.33.44:8080"</span>,
    <span class="hljs-string">"http://222.11.55.66:8888"</span>,
    <span class="hljs-string">"http://77.88.99.100:3128"</span>,
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_proxy</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    proxy = get_random_proxy()
    <span class="hljs-keyword">try</span>:
        res = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxy, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用代理 <span class="hljs-subst">{proxy[<span class="hljs-string">'http'</span>]}</span> -&gt; <span class="hljs-subst">{res.json()}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"代理失效："</span>, e)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 购买或搭建代理池</h3>
<p>免费代理常常不稳定，建议：</p>
<ul>
<li>使用付费代理服务（如芝麻代理、快代理等）。</li>
<li>自行搭建代理池服务，结合 Redis 存储和自动检测可用 IP。</li>
</ul>
<p>一个简单的代理池架构：</p>
<pre><code class="hljs">爬虫程序 → 请求代理池接口 → 返回可用代理 → 访问目标网站
代理池后台 → 定期检测代理可用性 → 清理无效IP
</code></pre>
<hr/>
<h2 data-id="heading-9">四、Cookie 与会话保持</h2>
<p>某些网站需要登录才能访问数据，这时需要处理 <strong>Cookie</strong>。
可以使用 <code>requests.Session()</code> 自动保持会话状态。</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
login_url = <span class="hljs-string">"https://example.com/login"</span>
payload = {<span class="hljs-string">"username"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"pass"</span>}
session.post(login_url, data=payload)

<span class="hljs-comment"># 登录成功后继续访问页面</span>
resp = session.get(<span class="hljs-string">"https://example.com/user/profile"</span>)
<span class="hljs-built_in">print</span>(resp.text)
</code></pre>
<p><code>Session</code> 会自动保存登录后的 Cookie 信息，避免每次请求重新认证。</p>
<hr/>
<h2 data-id="heading-10">五、验证码与高级防爬</h2>
<p>有的网站会要求输入验证码或 JavaScript 加密验证请求。
常见应对思路包括：</p>
<ol>
<li><strong>人工辅助识别</strong>：遇到验证码暂停爬取，手动输入。</li>
<li><strong>OCR 识别验证码</strong>：通过 <code>pytesseract</code> 识别简单图片验证码。</li>
<li><strong>模拟浏览器行为</strong>：使用 <code>selenium</code> 或 <code>playwright</code> 执行网页中的 JS 逻辑。</li>
</ol>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver

driver = webdriver.Chrome()
driver.get(<span class="hljs-string">"https://example.com"</span>)
<span class="hljs-built_in">print</span>(driver.title)
driver.quit()
</code></pre>
<p>这种方式能绕过大部分基于 JS 渲染或验证的防爬机制。</p>
<hr/>
<h2 data-id="heading-11">六、异常与重试机制</h2>
<p>网络请求容易超时或失败，建议添加异常重试机制。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_request</span>(<span class="hljs-params">url, retries=<span class="hljs-number">3</span></span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):
        <span class="hljs-keyword">try</span>:
            res = requests.get(url, timeout=<span class="hljs-number">10</span>)
            <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:
                <span class="hljs-keyword">return</span> res.text
        <span class="hljs-keyword">except</span> requests.RequestException:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 次请求失败，重试中..."</span>)
            time.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">七、综合实战示例</h2>
<p>综合以上技巧，我们可以实现一个稳定、抗封的爬虫：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests, random, time

headers_list = [
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Chrome/122.0.0.0"</span>},
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Firefox/124.0"</span>},
]
proxies_list = [
    <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"http://222.111.55.66:8888"</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>):
    headers = random.choice(headers_list)
    proxy = {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, headers=headers, proxies=proxy, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问成功："</span>, response.status_code, <span class="hljs-string">"IP："</span>, proxy)
        <span class="hljs-keyword">return</span> response.text
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问失败："</span>, e)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    html = fetch(<span class="hljs-string">"https://httpbin.org/ip"</span>)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
</code></pre>
<hr/>
<h2 data-id="heading-13">八、总结</h2>

































<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td><strong>请求伪装</strong></td><td>设置随机 User-Agent、Referer 等头信息</td></tr><tr><td><strong>请求间隔控制</strong></td><td>使用随机延时，模拟真实用户行为</td></tr><tr><td><strong>代理机制</strong></td><td>通过代理IP切换访问来源</td></tr><tr><td><strong>会话保持</strong></td><td>使用 Session 管理登录状态</td></tr><tr><td><strong>异常重试</strong></td><td>防止临时网络错误导致程序中断</td></tr><tr><td><strong>浏览器模拟</strong></td><td>处理验证码或动态渲染内容</td></tr></tbody></table>
<hr/>
<p>通过合理运用这些防封策略与代理机制，你的 Python 爬虫将更稳定、更高效、更接近真实用户访问行为，为后续数据采集与分析奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 useState 到 URLState：前端状态管理的另一种思路]]></title>    <link>https://juejin.cn/post/7571306072423628842</link>    <guid>https://juejin.cn/post/7571306072423628842</guid>    <pubDate>2025-11-12T01:09:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072423628842" data-draft-id="7571306072423612458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 useState 到 URLState：前端状态管理的另一种思路"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2025-11-12T01:09:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 useState 到 URLState：前端状态管理的另一种思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:09:56.000Z" title="Wed Nov 12 2025 01:09:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，<code>useState</code> 是我们最常用的状态管理工具之一。它轻量、直观，能满足大多数组件级状态管理需求。但在某些场景下，比如列表筛选、分页、多页面共享状态时，单纯使用 <code>useState</code> 会遇到状态丢失、刷新页面重置等问题。这时候，<strong>URLState</strong> 或许是一个更优雅的解决方案。</p>
<h2 data-id="heading-0">一、useState 的「痛点」场景</h2>
<p>先来看一个常见的业务场景：实现一个带筛选功能的商品列表页，包含「价格区间」「分类」「排序方式」三个筛选条件。用 <code>useState</code> 实现的代码可能是这样的：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 筛选状态</span>
  <span class="hljs-keyword">const</span> [priceRange, setPriceRange] = <span class="hljs-title function_">useState</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>]);
  <span class="hljs-keyword">const</span> [category, setCategory] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'all'</span>);
  <span class="hljs-keyword">const</span> [sortBy, setSortBy] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'price-asc'</span>);

  <span class="hljs-comment">// 筛选逻辑...</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{setPriceRange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{setCategory}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{setSortBy}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这段代码看似没问题，但存在三个明显痛点：</p>
<ul>
<li>
<p><strong>页面刷新状态丢失</strong>：用户筛选后刷新页面，所有筛选条件会重置为初始值，体验极差。</p>
</li>
<li>
<p><strong>状态无法共享</strong>：如果需要在其他页面（比如商品详情页）回退到筛选后的列表，无法携带筛选状态。</p>
</li>
<li>
<p><strong>无法书签/分享</strong>：用户想把筛选后的结果分享给同事，复制链接过去是未筛选的初始状态。</p>
</li>
</ul>
<h2 data-id="heading-1">二、什么是 URLState？为什么要用它？</h2>
<p><strong>URLState</strong> 是将应用状态存储在 URL 查询参数（Query String）中的状态管理方式。比如上面的筛选场景，使用 URLState 后，URL 可能变成这样：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?price=0-1000&amp;category=electronics&amp;sort=price-asc
</code></pre>
<p>这种方式的核心优势在于：</p>
<ul>
<li>
<p>「刷新不丢状态」：URL 是浏览器的持久化载体，刷新页面参数不会消失。</p>
</li>
<li>
<p>「天然可共享」：复制 URL 即可分享当前状态，支持书签保存。</p>
</li>
<li>
<p>「跨页传参简单」：不同页面间通过 URL 即可传递状态，无需依赖全局状态库。</p>
</li>
<li>
<p>「可回溯」：浏览器的前进/后退按钮能直接回溯状态变更历史。</p>
</li>
</ul>
<h2 data-id="heading-2">三、实现 URLState：自定义 useURLState Hook</h2>
<p>其实 URLState 的实现并不复杂，核心是通过 <code>URLSearchParams</code> 操作查询参数，并结合 React 的状态更新机制。下面我们封装一个通用的 <code>useURLState</code> Hook。</p>
<h3 data-id="heading-3">3.1 核心逻辑拆解</h3>
<ol>
<li>
<p>从 URL 中解析初始状态：通过 <code>new URLSearchParams(window.location.search)</code> 获取查询参数。</p>
</li>
<li>
<p>定义状态更新函数：修改状态时，同步更新 URL（使用 <code>history.pushState</code> 避免页面刷新）。</p>
</li>
<li>
<p>监听 URL 变化：当用户通过前进/后退按钮切换历史记录时，同步更新组件状态。</p>
</li>
</ol>
<h3 data-id="heading-4">3.2 完整实现代码</h3>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState, useEffect, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useURLState</span>(<span class="hljs-params">initialState = {}</span>) {
  <span class="hljs-comment">// 从 URL 解析状态</span>
  <span class="hljs-keyword">const</span> parseURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> state = {};
    
    <span class="hljs-comment">// 遍历初始状态，从 URL 中提取对应参数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(initialState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, defaultValue]</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = searchParams.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
        state[key] = defaultValue;
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 处理不同类型的默认值（数字、布尔、数组等）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'number'</span>) {
        state[key] = <span class="hljs-title class_">Number</span>(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'boolean'</span>) {
        state[key] = value === <span class="hljs-string">'true'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(defaultValue)) {
        state[key] = value.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);
      } <span class="hljs-keyword">else</span> {
        state[key] = value;
      }
    });
    
    <span class="hljs-keyword">return</span> state;
  }, [initialState]);

  <span class="hljs-comment">// 初始化状态：从 URL 解析或使用初始值</span>
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-title function_">parseURLState</span>());

  <span class="hljs-comment">// 当 URL 变化时（前进/后退），同步更新状态</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePopState</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setState</span>(<span class="hljs-title function_">parseURLState</span>());
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
  }, [parseURLState]);

  <span class="hljs-comment">// 更新状态并同步到 URL</span>
  <span class="hljs-keyword">const</span> setURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">newState</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> nextState = { ...state, ...newState };
    
    <span class="hljs-comment">// 遍历新状态，更新到 searchParams</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(nextState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (value === initialState[key]) {
        <span class="hljs-comment">// 如果值等于初始值，移除该参数（保持 URL 简洁）</span>
        searchParams.<span class="hljs-title function_">delete</span>(key);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 数组类型用 "-" 拼接</span>
        <span class="hljs-keyword">const</span> paramValue = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value) ? value.<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>) : <span class="hljs-title class_">String</span>(value);
        searchParams.<span class="hljs-title function_">set</span>(key, paramValue);
      }
    });
    
    <span class="hljs-comment">// 更新 URL（pushState 不会刷新页面）</span>
    <span class="hljs-keyword">const</span> searchString = searchParams.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> newUrl = searchString ? <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.pathname}</span>?<span class="hljs-subst">${searchString}</span>`</span> : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newUrl);
    
    <span class="hljs-comment">// 更新组件状态</span>
    <span class="hljs-title function_">setState</span>(nextState);
  }, [state, initialState]);

  <span class="hljs-keyword">return</span> [state, setURLState];
}
</code></pre>
<h2 data-id="heading-5">四、实战：用 URLState 重构商品列表页</h2>
<p>有了 <code>useURLState</code>，我们可以轻松重构之前的商品列表页，解决 <code>useState</code> 带来的痛点：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useURLState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useURLState'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 useURLState 替代 useState，初始状态和之前一致</span>
  <span class="hljs-keyword">const</span> [state, setURLState] = <span class="hljs-title function_">useURLState</span>({
    <span class="hljs-attr">priceRange</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>], <span class="hljs-comment">// 数组类型</span>
    <span class="hljs-attr">category</span>: <span class="hljs-string">'all'</span>,       <span class="hljs-comment">// 字符串类型</span>
    <span class="hljs-attr">sortBy</span>: <span class="hljs-string">'price-asc'</span>    <span class="hljs-comment">// 字符串类型</span>
  });

  <span class="hljs-keyword">const</span> { priceRange, category, sortBy } = state;

  <span class="hljs-comment">// 筛选条件变更时，调用 setURLState 更新</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePriceChange</span> = (<span class="hljs-params">newRange</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">priceRange</span>: newRange });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCategoryChange</span> = (<span class="hljs-params">newCategory</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">category</span>: newCategory });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">newSort</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">sortBy</span>: newSort });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{handlePriceChange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{handleCategoryChange}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{handleSortChange}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>此时，用户筛选商品后，URL 会自动更新为：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?priceRange=0-2000&amp;category=electronics&amp;sortBy=price-desc
</code></pre>
<p>刷新页面、复制链接分享、后退到上一个筛选状态，都能完美生效！</p>
<h2 data-id="heading-6">五、URLState 的适用场景与注意事项</h2>
<h3 data-id="heading-7">5.1 适用场景</h3>
<ul>
<li>
<p>列表筛选、分页、排序等「可分享」的状态。</p>
</li>
<li>
<p>多步骤表单（如注册流程）的进度状态。</p>
</li>
<li>
<p>单页应用中的「页面级」状态（如标签页切换）。</p>
</li>
</ul>
<h3 data-id="heading-8">5.2 注意事项</h3>
<ul>
<li>
<p><strong>不要存储敏感信息</strong>：URL 参数会暴露在地址栏、浏览器历史、服务器日志中，密码、token 等敏感信息绝对不能用 URLState。</p>
</li>
<li>
<p><strong>参数不宜过多/过长</strong>：浏览器对 URL 长度有上限（通常 2KB-8KB），复杂状态建议用全局状态库（如 Redux）。</p>
</li>
<li>
<p><strong>处理特殊类型数据</strong>：对于对象等复杂类型，需要先序列化（如 JSON.stringify），但会增加 URL 长度，需谨慎使用。</p>
</li>
</ul>
<h2 data-id="heading-9">六、总结</h2>
<p><code>useState</code> 是 React 状态管理的基石，但在「状态持久化」「可分享」场景下存在局限。URLState 作为一种轻量级的补充方案，通过 URL 查询参数实现状态的持久化和共享，无需引入复杂的状态管理库，就能解决很多实际业务问题。</p>
<p>当然，URLState 不是银弹，它和 <code>useState</code>、全局状态库是互补关系。在合适的场景选择合适的工具，才是高效开发的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题]]></title>    <link>https://juejin.cn/post/7571285984089686068</link>    <guid>https://juejin.cn/post/7571285984089686068</guid>    <pubDate>2025-11-11T17:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984089686068" data-draft-id="7571344319701942312" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-11T17:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T17:17:20.000Z" title="Tue Nov 11 2025 17:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，布局是核心技能之一，而<code>position</code>属性更是布局的 “灵魂”—— 它决定了元素在页面中的位置关系，是实现复杂布局、悬浮组件、固定导航等效果的关键。很多开发者入门时会混淆<code>absolute</code>和<code>fixed</code>，踩坑<code>sticky</code>不生效的问题，本质上是没吃透其底层原理。本文结合 5 个实战案例，从文档流本质出发，全面解析<code>position</code>的 5 种属性用法，帮你彻底掌握这个 CSS 基础核心知识点。</p>
<h2 data-id="heading-0">一、先搞懂：文档流是什么？</h2>
<p>要理解<code>position</code>，必须先明确 “文档流” 的概念 —— 这是 HTML 元素默认的布局规则，就像现实中排队一样，元素按照代码顺序依次排列。</p>
<p>块级元素（如<code>div</code>、<code>p</code>）默认垂直排列，每个元素独占一行，自上而下依次分布；行内元素（如<code>span</code>、<code>a</code>）则水平排列，从左到右紧密排布，直到一行放不下才换行。这种 “自上而下、从左到右” 的自然布局方式，就是文档流。</p>
<p>而<code>position</code>属性的核心作用，就是打破或遵循这个默认规则，改变元素的定位方式。其中，<strong>是否脱离文档流</strong>是区分不同定位属性的关键：脱离文档流的元素会 “跳出” 排队队伍，不再占用原来的位置，其他元素会忽略它重新排列；不脱离的元素则仍在队伍中，只是在原位置上进行微调。</p>
<h2 data-id="heading-1">二、逐个击破：5 种 position 属性的底层逻辑</h2>
<h3 data-id="heading-2">1. static：默认定位（无定位）</h3>
<p><code>static</code>是<code>position</code>的默认值，所有元素在未设置定位时，都遵循<code>static</code>规则 —— 按照文档流正常排列，不受<code>top</code>、<code>left</code>、<code>right</code>、<code>bottom</code>属性影响。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全遵循文档流，不脱离</li>
<li>无法通过<code>top</code>/<code>left</code>等属性调整位置</li>
<li>可用于取消已设置的定位（如示例 5 中，5 秒后将<code>absolute</code>改为<code>static</code>）</li>
</ul>
<p><strong>实战示例</strong>（示例 5 初始状态）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 初始定位 */</span>
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
<span class="hljs-comment">/* 5秒后取消定位，恢复static默认状态 */</span>
setTimeout(() =&gt; {
  oParent<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.position</span> = 'static';
}, <span class="hljs-number">5000</span>);
</code></pre>
<p>当<code>position</code>改为<code>static</code>后，<code>left</code>和<code>top</code>失效，元素回到文档流的原始位置。</p>
<hr/>
<h3 data-id="heading-3">2. relative：相对定位（不脱离文档流）</h3>
<p><code>relative</code>是 “相对” 于自身在文档流中的原始位置进行定位，这是它最核心的特征。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>不脱离文档流，原始位置仍被占用（后面元素不会补位）</li>
<li>通过<code>top</code>/<code>left</code>/<code>right</code>/<code>bottom</code>调整位置，参考点是自身默认位置</li>
<li>常作为<code>absolute</code>的 “定位容器”（子绝父相）</li>
</ul>
<p><strong>实战示例</strong>（示例 1）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">background</span>: pink;
  <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 相对定位 */</span>
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: skyblue;
}
</code></pre>
<p>这里<code>.parent</code>会相对于自己的默认位置（左上角）向右移动 100px、向下移动 100px，而它原来的位置仍被占用，<code>.box</code>元素会按照文档流在它后面正常排列，不会向前补位。</p>
<hr/>
<h3 data-id="heading-4">3. absolute：绝对定位（完全脱离文档流）</h3>
<p><code>absolute</code>是最常用的定位属性之一，元素会完全脱离文档流，相当于 “跳出” 排队队伍，不再占用任何空间。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全脱离文档流，原始位置被释放（后面元素会补位）</li>
<li>定位参考点是 “最近的已定位祖先元素”（<code>position</code>不为<code>static</code>）</li>
<li>若没有已定位祖先，则参考<code>body</code>（浏览器视口）</li>
<li>必须配合<code>top</code>/<code>left</code>等属性使用，否则定位无效</li>
</ul>
<p><strong>实战示例</strong>（示例 2）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">550px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">background</span>: pink;
  <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 定位容器 */</span>
}
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: skyblue;
  <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 绝对定位 */</span>
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于.parent右侧偏移100px */</span>
}
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: green;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); <span class="hljs-comment">/* 水平垂直居中 */</span>
}
</code></pre>
<p>示例中<code>.parent</code>设置<code>relative</code>作为定位容器，<code>.child</code>和<code>.box</code>的<code>absolute</code>定位都以<code>.parent</code>为参考。其中<code>.box</code>通过<code>left:50%</code>+<code>top:50%</code>+<code>transform:translate(-50%,-50%)</code>实现了相对于父容器的完美居中，这是<code>absolute</code>的经典用法。</p>
<hr/>
<h3 data-id="heading-5">4. fixed：固定定位（完全脱离文档流）</h3>
<p><code>fixed</code>的核心是 “固定于浏览器视口”，无论页面如何滚动，元素位置始终不变。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全脱离文档流，不占用原始位置</li>
<li>定位参考点是浏览器视口（可视区域）</li>
<li>不受祖先元素定位影响（即使父元素有<code>relative</code>，仍参考视口）</li>
<li>常用来实现固定导航、悬浮按钮、弹窗等</li>
</ul>
<p><strong>实战示例</strong>（示例 3）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">position</span>: fixed; <span class="hljs-comment">/* 固定定位 */</span>
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于视口右下角偏移100px */</span>
}
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; <span class="hljs-comment">/* 让页面可滚动 */</span>
}
</code></pre>
<p>即使页面滚动，<code>.child</code>始终固定在视口右下角 100px 的位置。需要注意的是，<code>fixed</code>元素会跟随浏览器窗口移动，不会被父容器的<code>overflow</code>属性影响（除非父容器有<code>transform</code>属性，这是常见坑点）。</p>
<hr/>
<h3 data-id="heading-6">5. sticky：粘性定位（动态切换定位方式）</h3>
<p><code>sticky</code>是 “相对定位” 和 “固定定位” 的结合体，堪称布局神器，常用于导航栏滚动吸顶效果。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>未达到滚动阈值时，表现为<code>relative</code>（遵循文档流）</li>
<li>达到滚动阈值时，自动切换为<code>fixed</code>（固定于视口）</li>
<li>不脱离文档流，原始位置仍被占用（切换为<code>fixed</code>后也不会让后面元素补位）</li>
<li>必须配合<code>top</code>/<code>left</code>等属性设置阈值，否则无效</li>
</ul>
<p><strong>实战示例</strong>（示例 4）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: green;
  <span class="hljs-attribute">position</span>: sticky; <span class="hljs-comment">/* 粘性定位 */</span>
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 滚动阈值：距离视口顶部100px时固定 */</span>
}
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; <span class="hljs-comment">/* 可滚动页面 */</span>
}
</code></pre>
<p>当页面滚动时，<code>.box</code>在未到达视口顶部 100px 前，会跟随文档流正常滚动；一旦距离顶部小于 100px，就会固定在顶部 100px 的位置，直到滚动到父元素底部，又会恢复<code>relative</code>状态。</p>
<h2 data-id="heading-7">三、关键区别：5 种定位属性核心对比</h2>









































<table><thead><tr><th>定位属性</th><th>是否脱离文档流</th><th>定位参考点</th><th>核心用途</th></tr></thead><tbody><tr><td>static</td><td>否（默认）</td><td>无</td><td>取消定位、默认布局</td></tr><tr><td>relative</td><td>否</td><td>自身默认位置</td><td>微调位置、作为 absolute 容器</td></tr><tr><td>absolute</td><td>是</td><td>最近已定位祖先 /body</td><td>精准定位、弹窗、居中</td></tr><tr><td>fixed</td><td>是</td><td>浏览器视口</td><td>固定导航、悬浮组件</td></tr><tr><td>sticky</td><td>否（动态切换）</td><td>文档流 / 视口</td><td>滚动吸顶、粘性导航</td></tr></tbody></table>
<h2 data-id="heading-8">四、实战避坑：这些问题一定要注意</h2>
<ol>
<li><strong><code>absolute</code>无法定位？</strong> 检查父元素是否有<code>position: relative/absolute/fixed/sticky</code>，若没有则参考<code>body</code>，可能因父元素未设置高度导致定位异常。</li>
<li><strong><code>sticky</code>不生效？</strong> 确保满足三个条件：设置了<code>top</code>/<code>left</code>等阈值、父元素没有<code>overflow: hidden</code>、元素在文档流中（没有脱离文档流的祖先）。</li>
<li><strong><code>fixed</code>被父元素 “困住”？</strong> 若父元素有<code>transform</code>属性（如<code>transform: translate(0)</code>），<code>fixed</code>会以该父元素为参考，而非视口，需避免这种嵌套。</li>
<li><strong>脱离文档流的影响？</strong> <code>absolute</code>和<code>fixed</code>会脱离文档流，可能导致页面布局塌陷，需提前预留空间或用其他元素补位。</li>
</ol>
<h2 data-id="heading-9">五、总结：定位属性的选择逻辑</h2>
<ol>
<li>只需微调元素位置，不影响其他布局 → <code>relative</code></li>
<li>需精准定位，且不占原始空间 → <code>absolute</code>（配合<code>relative</code>容器）</li>
<li>需固定在视口，不受滚动影响 → <code>fixed</code></li>
<li>需滚动吸顶 / 吸底效果 → <code>sticky</code></li>
<li>恢复默认布局或取消定位 → <code>static</code></li>
</ol>
<p><code>position</code>属性看似简单，实则是 CSS 布局的底层逻辑体现。掌握它们的核心区别和使用场景，能让你在实现复杂布局时游刃有余。建议结合本文的示例代码，亲自在浏览器中调试，观察元素位置变化，加深对文档流和定位规则的理解。</p>
<h2 data-id="heading-10">最后</h2>
<p>如果你在使用<code>position</code>时遇到过特殊坑点，或者有更巧妙的用法，欢迎在评论区分享～ 也可以点赞收藏，下次遇到定位问题直接翻这篇指南！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程]]></title>    <link>https://juejin.cn/post/7572002432450920457</link>    <guid>https://juejin.cn/post/7572002432450920457</guid>    <pubDate>2025-11-13T10:29:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450920457" data-draft-id="7572016447804719130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程"/> <meta itemprop="keywords" content="WebAssembly,Web Components,编程语言"/> <meta itemprop="datePublished" content="2025-11-13T10:29:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:29:03.000Z" title="Thu Nov 13 2025 10:29:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">三次登上美国知名技术媒体！MoonBit 又因 WebAssembly 组件模型引发关注！</h2>
<blockquote>
<p>在海外技术社区的持续关注下，MoonBit 又一次登上了美国知名开发者媒体 The New Stack。这是 TNS 第三次报道 MoonBit。本篇文章以 “如何用 MoonBit 构建 WebAssembly Components” 为主题，从工具链、接口定义到 Wasm 文件生成，对 MoonBit 的技术能力做了详细的解读:<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fhow-to-build-webassembly-components-with-the-moonbit-language%2F" target="_blank" title="https://thenewstack.io/how-to-build-webassembly-components-with-the-moonbit-language/" ref="nofollow noopener noreferrer">thenewstack.io/how-to-buil…</a>
）</p>
</blockquote>
<p>以下为原文翻译</p>
<p>MoonBit 是一门现代化语言，也是一套工作流，旨在构建高效的 WebAssembly 项目；它同样可以编译到 JavaScript。我上一次关注 MoonBit 是在 2024 年 6 月，因此这次我想看看它在 Wasm 使用方面是否有所进展。（顺带一提：如果您仍然对WebAssembly的意义感到陌生，你不是一个人。）</p>
<p>现在，MoonBit 也可以在 WebAssembly 的组件模型运行（Web Component Model），我们稍后将对此进行探讨。我们将实现这一点，然后检查它是否有效。本文中只打算实现一个简单的加法方法。</p>
<h3 data-id="heading-1">MoonBit 语言快速回顾</h3>
<p>在开始之前，先快速回顾一下 MoonBit 语言。</p>
<p>当然，从 Hello World 开始：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_hello</span>() <span class="hljs-punctuation">-&gt;</span> Unit { 
 <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Hello, world!"</span>) 
}
</code></pre>
<p>唯一稍微让人意外的是 <code>Unit</code> ，但它其实只是 MoonBit 中等价于 <code>void</code> 的一类对象。</p>
<p>这是另一个例子：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add3</span>(x : Int, y : Int, z : Int) <span class="hljs-punctuation">-&gt;</span> Int { 
 x + y + z 
}
</code></pre>
<p>这是一个“top level”；需要注意的是，MoonBit 必须显式声明类型。如果你想更深入了解这门语言，可以查看官方教程。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fen%2Flatest%2Flanguage%2Findex.html" target="_blank" title="https://docs.moonbitlang.com/en/latest/language/index.html" ref="nofollow noopener noreferrer">官方教程</a></p>
<hr/>
<h3 data-id="heading-2">WebAssembly 组件模型集成</h3>
<p>我们关注的是 WebAssembly 的集成。MoonBit 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcomponent-model.bytecodealliance.org%2F" target="_blank" title="https://component-model.bytecodealliance.org/" ref="nofollow noopener noreferrer">WebAssembly 组件模型</a> 协同工作，这减轻了实现基本功能时的痛苦。组件模型通常是语言项目的下一阶段，因为它们固定了接口、契约以及数据类型。</p>
<p>逻辑上，一个组件是可以包含核心模块和/或其他子组件的结构。组件使用 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">WebAssembly Interface Types（WIT）</a>来描述其中模块和子组件的接口。如果这听起来过于学术化，不用担心，它在实际生产工具链中完全能正常工作。本文的内容主要基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fzh-cn%2Flatest%2Ftoolchain%2Fwasm%2Fcomponent-model-tutorial.html" target="_blank" title="https://docs.moonbitlang.com/zh-cn/latest/toolchain/wasm/component-model-tutorial.html" ref="nofollow noopener noreferrer">MoonBit 的 WebAssembly 组件文档</a>。</p>
<h3 data-id="heading-3">安装构建组件需要的工具链</h3>
<p>在继续之前，我们需要 <code>wit-bindgen</code> CLI 工具，它用于生成兼容 WIT 的绑定文件；这个工具是基于 Rust 的，所以你需要安装 Cargo。只要安装 Rust 就能获得 Cargo：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwit-bindgen" target="_blank" title="https://github.com/bytecodealliance/wit-bindgen" ref="nofollow noopener noreferrer">Wit-bindgen</a></p>
<pre><code class="hljs language-Bash" lang="Bash">curl https://sh.rustup.rs -sSf | sh
</code></pre>
<p>（如果你使用 Homebrew 安装过 Rust，你可能需要确认是否让 rustup 来管理对 Rust 的更新。我之前没更新好导致了更多的问题，所以我建议卸载 brew 安装的版本。）</p>
<p>在此之前，你可以先输入 <code>cargo</code> 以确认你是否已经正确安装：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16906bdec1594c74aa1cbd7c56a49e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=fygtnRa2De5uOjAKvKcEQAypE%2B8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>虽然版本有点旧，但还能用。现在安装绑定工具：</p>
<pre><code class="hljs language-Bash" lang="Bash">cargo install wit-bindgen-cli
</code></pre>
<p>你可能会收到提示，要求你把 cargo 的 bin 目录加入 PATH。我是在 MacBook 上安装，因此直接把它加入了 PATH。</p>
<p>然后安装用于组件的 Wasm 工具：</p>
<pre><code class="hljs language-Bash" lang="Bash">cargo install wasm-tools
</code></pre>
<p>接着安装 MoonBit 本体：</p>
<pre><code class="hljs language-Bash" lang="Bash">curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
</code></pre>
<p>安装完成后，你需要运行一个新的 shell 或执行：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<p>现在你就可以运行 Rust 开发的项目组织工具 <code>moon</code> 了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80aa69d68b8941afa6ad10791e10291d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=CWennkspv8%2FvlPUUog1Le%2Beia5U%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这下我们就把 Moon 的整套工具都准备齐了。</p>
<h3 data-id="heading-4">使用 WIT 文件定义程序</h3>
<p>在编写 MoonBit 代码之前，我们需要先创建一个 WIT 文件，用来声明我们将在 WebAssembly 组件世界中使用的接口。</p>
<p>创建 <code>wit/world.wit</code> 文件：</p>
<pre><code class="hljs language-rust" lang="rust">package docs:adder@<span class="hljs-number">0.1</span>.<span class="hljs-number">0</span>; 

interface add { 
  add: <span class="hljs-title function_ invoke__">func</span>(x: <span class="hljs-type">u32</span>, y: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span>; 
} 
world adder { 
  export add; 
}
</code></pre>
<p>这段 WIT 声明了一个版本为 <code>0.1.0</code> 的 <code>docs:adder</code> 包，并定义了名为 <code>add</code> 的接口，其中包含一个接收和返回 <code>u32</code> 的函数（在 MoonBit 中对应 UInt）。WIT 中的 <code>world</code> 是一个容器，用来放置所有组件需要的部分，这里只有一个 add 接口。</p>
<p>UInt :<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fen%2Flatest%2Flanguage%2Ffundamentals.html%23number" target="_blank" title="https://docs.moonbitlang.com/en/latest/language/fundamentals.html#number" ref="nofollow noopener noreferrer">docs.moonbitlang.com/en/latest/l…</a></p>
<p>现在我们为 WIT 生成 MoonBit 结构：</p>
<pre><code class="hljs language-rust" lang="rust">wit-bindgen moonbit wit/world.wit --out-dir . \
    --derive-eq \
    --derive-show \
    --derive-error
</code></pre>
<p>生成后你应该会看到生成的 <code>.mbt</code> 文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d535d3166aaa4e6cb44627dfb54d21ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=3jVjbK2273B5yqqpFVBW4x7cH0c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>您可能已经猜到 <code>.mbt</code> 后缀是 MoonBit 文件。但当然我们还没有真正写 MoonBit 代码。如果现在尝试构建 Wasm 目标，会收到大量警告。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802dfdd571674cc3a3bda3adcc2df7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=lIWJ8NDGLqVCfXYDEi5r%2FuLBb64%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>查看生成的 stub，你会发现其中没有实际实现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d8d553307049ef9fa217e8a0cdf89a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=Amp4j%2BSZ7VCIECeBZu8O1MEmr14%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>简单来说，stub 里并没有真正的实现，只是接口定义。即使使用我们上面最小的 MoonBit 教程，我们仍然可以轻松完成它：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b26a340ab8f48ab963551c4eb148c88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=1ZWSVW6rc7slXK%2B7CxQCM8%2FGNPI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>主配置文件 <code>gen/moon.pkg.json</code> 会包含相关路径信息。</p>
<h3 data-id="heading-5">构建 WebAssembly 模块与组件</h3>
<p>现在我们来构建主 WebAssembly 模块：</p>
<pre><code class="hljs language-rust" lang="rust">moon build --target wasm
</code></pre>
<p>构建后会生成新的 <code>target</code> 目录，其中包含 Wasm 文件。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e31007b9db949b29b43061bf301abb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=01JYpFbHLi%2FpBUtWsHi09xypNNU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>检查一下 <code>gen.wasm</code> 是否有效：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cdccb01f3b44fbb92cb3965d6b574bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=1uqnusZTTekEiLfh%2FQw2UWkuCD4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>很好，它是合法的 WebAssembly。现在我们需要在组件模型中正确地封装它：</p>
<pre><code class="hljs language-rust" lang="rust">wasm-tools component embed wit target/wasm/release/build/gen/gen.wasm \
  --encoding utf16 \
  --output adder.wasm
</code></pre>
<p>然后执行：</p>
<pre><code class="hljs language-bash" lang="bash">wasm-tools component new adder.wasm --output adder.component.wasm
</code></pre>
<p>此时生成的文件已不同于普通的 Wasm 模块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9cb02f54544fb295ad899ee4e5b6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=CX9Tb6pb5xIWJhBKcpOBAidYWVM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以使用 Wasmtime 来验证是否成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa083bc02ebe4eb3b9bc6c745bd959fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=0hyLJI8ONFwa2qsOVOncHgNRccw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果 Wasmtime 报错，可以从这里安装最新版本：</p>
<pre><code class="hljs language-Bash" lang="Bash">curl https://wasmtime.dev/install.sh -sSf | bash
</code></pre>
<p>你也可以使用更复杂的宿主程序来进一步验证 <code>.wasm</code> 是否正常运行。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fzh-cn%2Flatest%2Ftoolchain%2Fwasm%2Fcomponent-model-tutorial.html%23using-the-example-host" target="_blank" title="https://docs.moonbitlang.com/zh-cn/latest/toolchain/wasm/component-model-tutorial.html#using-the-example-host" ref="nofollow noopener noreferrer">docs.moonbitlang.com/zh-cn/lates…</a></p>
<h3 data-id="heading-6">总结</h3>
<p>我本来是想看看 MoonBit 的进展，结果却发现了 WebAssembly 组件模型。这就是开发者的旅程——总有一座更高的山。</p>
<p>在未来的某个阶段，MoonBit 需要在对组件模型的直接支持方面投入更多工作；否则，这种偏学术化的复杂度将使 Wasm 始终难以获得更广泛的采用（或使其更趋近于 Rust 的生态）。然而，这种模式与其他基于 stub 的模型颇为相似——尽管以 WSDL 作为类比并非最恰当——但在成熟的工具链中，它们依然能够良好运作，即便是由LLM驱动的工具链亦是如此。</p>
<h2 data-id="heading-7">MoonBit 被收录入《Top Programming Languages of Late 2025》！</h2>
<p>在 MysticMatrix 发布的
《Top Programming Languages of Late 2025》
一文中，MoonBit 与 Mojo、Rust 一同被列为 2025 年度值得关注的新兴语言之一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d580fb24b6441cb9683da3a366edf7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=aRqW4UeIwB59TCw2lbCtVj%2F45Ac%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>非常感谢社区的支持，我们会继续提升编译器与工具链，为大家带来更好的开发体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作]]></title>    <link>https://juejin.cn/post/7571815997068083240</link>    <guid>https://juejin.cn/post/7571815997068083240</guid>    <pubDate>2025-11-13T10:31:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068083240" data-draft-id="7572020278386688034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T10:31:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “多余的”回车：从IDE的自动换行窥见软件工程的规范与协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:31:24.000Z" title="Thu Nov 13 2025 10:31:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>个人名片
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38e29b9b3168402984eb27e55d2e954b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=57YenSbKlw8jgRJQSV55uKR7JoI%3D" alt="在这里插入图片描述" loading="lazy"/>
🎓作者简介：java领域优质创作者
🌐个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/weixin_44976692?type=blog" ref="nofollow noopener noreferrer">码农阿豪</a>
📞工作室：新空间代码工作室（提供各种软件服务)
💌个人邮箱：[<a href="https://link.juejin.cn?target=mailto%3A2435024119%40qq.com" target="_blank" title="mailto:2435024119@qq.com" ref="nofollow noopener noreferrer">2435024119@qq.com</a>]
📱个人微信：15279484656
🌐个人导航网站：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.forff.top" target="_blank" title="http://www.forff.top" ref="nofollow noopener noreferrer">www.forff.top</a>
💡座右铭：总有人要赢。为什么不能是我呢？</p>
</blockquote>
<ul>
<li>专栏导航：</li>
</ul>
<blockquote>
<p>码农阿豪系列专栏导航
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12053689.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12053689.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">面试专栏</a>：收集了java相关高频面试题，面试实战总结🍻🎉🖥️
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12561762.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12561762.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">Spring5系列专栏</a>：整理了Spring5重要知识点与实战演练，有案例可直接使用🚀🔧💻
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12580216.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12580216.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">Redis专栏</a>：Redis从零到一学习分享，经验总结，案例实战💐📝💡
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12533392.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12533392.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">全栈系列专栏</a>：海纳百川有容乃大，可能你想要的东西里面都有🤸🌱🚀</p>
</blockquote>
<p>@<a href="https://link.juejin.cn?target=%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作</h2>
<h3 data-id="heading-1">引言：一个令人困惑的“Bug”</h3>
<p>作为一名开发者，你一定对集成开发环境无比熟悉。然而，某些时候，它们的一些“自作主张”的行为会让我们感到困惑。比如，下面这个场景你是否觉得眼熟：</p>
<ol>
<li>你在IntelliJ IDEA中编写代码，文件最后一行是<code>}</code>，光标紧跟在它后面。</li>
<li>你专注地写完了所有逻辑，没有在最后按回车键。</li>
<li>当你切换到浏览器查看文档，或是点开另一个聊天窗口之后...</li>
<li>...再切回IDEA，奇怪的事情发生了：光标竟然跑到了下一行！文件末尾莫名其妙地多了一个空行？</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6fbc62e951845be88756900f238ccb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=keWuzO9MxQxDD43ZYJUFpSLRc7Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>初遇此景，你可能会嘀咕：“我没按回车啊？难道是IDE出Bug了？” 或者怀疑自己不小心碰到了什么键。</p>
<p>请放心，这不是Bug。这背后，隐藏着一个贯穿了计算机发展史、涉及操作系统差异、版本控制哲学以及软件工程最佳实践的“古老”故事。本文将深入剖析这一现象，揭示其原理，并论证为何这个看似微不足道的细节，在现代软件开发中至关重要。</p>
<h3 data-id="heading-2">第一章：追根溯源——文本文件的“行”与“尾”</h3>
<p>要理解这个现象，我们首先需要回到计算机的早期时代，理解一个最基本的概念：文本文件中的“一行”是如何定义的？</p>
<h4 data-id="heading-3">1.1 换行符的“南北战争”</h4>
<p>在计算机世界里，纯文本文件由字符序列组成。但有一个问题：如何表示一行的结束？不幸的是，历史上出现了两大阵营，给出了不同的答案：</p>
<ul>
<li>CR+LF (Carriage Return + Line Feed, <code>\r\n</code>): 源于早期的电传打字机。<code>CR</code> 将打印头移回行首，<code>LF</code> 将纸张向上移动一行。微软的DOS和后来的Windows系统继承了这一传统，将其作为行结束标志。</li>
<li>LF (Line Feed, <code>\n</code>): Unix和类Unix系统（包括Linux, macOS）则采用了更简洁的<code>LF</code>作为行结束符。</li>
</ul>
<p>这就导致了在Windows上创建的文本文件，在Unix系统下打开时，可能会看到每行结尾多了个<code>^M</code>字符（即CR），反之亦然。</p>
<h4 data-id="heading-4">1.2 POSIX标准与“最后一行”的哲学</h4>
<p>POSIX标准为Unix-like系统定义了一系列规范，其中明确要求：</p>
<blockquote>
<p>[3.206 Line] A sequence of zero or more non-  characters plus a terminating  character.</p>
</blockquote>
<p>翻译过来就是：一行是由零个或多个非换行字符，加上一个终止的换行字符所构成的序列。</p>
<p>这意味着什么？它意味着在一个符合标准的文本文件中，每一行都必须以换行符结束，包括最后一行。</p>
<p>这听起来可能有点反直觉。一个文件末尾的换行符，并不代表一个“空行”。一个“空行”实际上是一个仅包含换行符的行。而文件末尾的换行符，其真正含义是：“这是本文件的最后一个行结束标志”。它标志着一个完整、终结的文件结构。</p>
<p>举例说明：</p>
<p>假设文件内容为 <code>Hello</code>，没有尾随换行符。
在遵循标准的工具看来，这个文件是“不完整”的——它的一行没有结束。</p>
<p>而内容为 <code>Hello\n</code> 的文件，才是格式正确的。</p>
<h3 data-id="heading-5">第二章：现代IDE的“贴心”守护者</h3>
<p>理解了历史背景和标准，我们再回到现代的IntelliJ IDEA（以及其他主流IDE/编辑器，如VS Code, Sublime Text等）。</p>
<h4 data-id="heading-6">2.1 那个关键的配置项</h4>
<p>IDEA中有一个默认开启的设置，它就是造成文章开头那个“奇怪现象”的“元凶”。</p>
<ul>
<li>路径： <code>File -&gt; Settings -&gt; Editor -&gt; General</code> (Windows/Linux) 或 <code>IntelliJ IDEA -&gt; Preferences -&gt; Editor -&gt; General</code> (macOS)</li>
<li>选项： <code>Ensure every saved file ends with a line feed</code> (或类似表述，如 <code>On Save: Ensure line feed at file end</code>)
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb60c07aa59490c885ada97c20d7574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=dLpO9jqkGAHU1JZoHNtdXWaxmv0%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<p>当这个选项被勾选时，IDEA会在你保存文件或触发自动保存（例如失去焦点、切换标签页）时，自动检查文件末尾是否有一个换行符。如果没有，它会静默地为你添加一个。</p>
<p>所以，整个流程是这样的：</p>
<ol>
<li>你编码时：内存中的文件内容没有尾随换行符。</li>
<li>你切换窗口：IDEA触发自动保存机制。</li>
<li>保存前检查：IDEA发现文件末尾缺少换行符。</li>
<li>自动修正：IDEA追加一个<code>LF</code>（<code>\n</code>）字符到文件末尾。</li>
<li>你切回IDEA：因为文件末尾现在有了一个换行符，光标自然就位于了这个“新的一行”的开头。你看到的，就是光标“自动”换行了。</li>
</ol>
<h4 data-id="heading-7">2.2 代码示例：眼见为实</h4>
<p>我们可以通过命令行工具来直观地验证这一行为。</p>
<p>首先，创建一个没有尾随换行符的文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 echo -n 来抑制默认添加的换行符</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"public class Test {}"</span> &gt; no_newline.java
</code></pre>
<p>使用 <code>hexdump</code> 或 <code>od</code> 查看其二进制内容：</p>
<pre><code class="hljs language-bash" lang="bash">hexdump -C no_newline.java
</code></pre>
<p>输出会类似于：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">00000000</span>  <span class="hljs-number">70</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">20</span> <span class="hljs-number">63</span>  6c <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">54</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  |<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tes</span>|
<span class="hljs-number">00000010</span>  <span class="hljs-number">74</span> <span class="hljs-number">20</span> 7b <span class="hljs-number">7d</span>                                       |t {}.|
<span class="hljs-number">00000014</span>
</code></pre>
<p>注意，最后一位是 <code>7d</code> (<code>}</code>)，后面没有 <code>0a</code> （<code>\n</code>）。</p>
<p>现在，用IDEA打开这个文件，什么都不做，直接切换窗口再切回来，然后保存。或者，在命令行下，我们用 <code>echo</code> 正常地创建一个文件来模拟：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"public class Test {}"</span> &gt; with_newline.java
hexdump -C with_newline.java
</code></pre>
<p>输出会类似于：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">00000000</span>  <span class="hljs-number">70</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">20</span> <span class="hljs-number">63</span>  6c <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">54</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  |<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tes</span>|
<span class="hljs-number">00000010</span>  <span class="hljs-number">74</span> <span class="hljs-number">20</span> 7b <span class="hljs-number">7d</span> 0a                                    |t {}.|
<span class="hljs-number">00000015</span>
</code></pre>
<p>看，最后一位是 <code>0a</code> (<code>\n</code>)！这就是IDEA自动为我们添加的。</p>
<h3 data-id="heading-8">第三章：为何要“多此一举”？——尾随换行符的现代意义</h3>
<p>如果仅仅是遵循一个几十年前的标准，理由或许还不够充分。这个规范在今天强大的生命力，主要源于它对现代开发流程，特别是协作和工具链的深远影响。</p>
<h4 data-id="heading-9">3.1 版本控制的“宁静”</h4>
<p>这是最重要、最实际的原因。以Git为例。</p>
<p>假设开发者A在开启尾随换行符规范的IDE上工作，他创建了一个文件。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 文件: Foo.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"Hello"</span>); <span class="hljs-comment">// 末尾有不可见的 \n</span>
    }
} <span class="hljs-comment">// 末尾也有不可见的 \n</span>
</code></pre>
<p>而开发者B使用一个不添加尾随换行符的编辑器，他修改了最后一行，并提交。</p>
<pre><code class="hljs language-java" lang="java">} <span class="hljs-comment">// 末尾没有不可见的 \n</span>
</code></pre>
<p>当B尝试推送他的代码时，Git会怎么做？Git会认为文件最后一行被修改了！<code>diff</code> 输出会是这样：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-}</span>
\ No newline at end of file
<span class="hljs-addition">+}</span>
</code></pre>
<p>看到了吗？Git 专门有一行提示 <code>\ No newline at end of file</code>。这对于文件的实际内容来说，是一个无关紧要的更改，但它却污染了提交历史。在代码审查时，你需要去判断这个改动究竟是真的逻辑修改，还是仅仅是格式变动。</p>
<p>如果整个团队都统一在文件末尾添加换行符，这种“噪音”提交就可以完全避免。</p>
<h4 data-id="heading-10">3.2 命令行工具的“预期”</h4>
<p>Unix世界的大量命令行工具都是基于“行”来处理文本的，它们默认每一行都以换行符结束。</p>
<ul>
<li>
<p><code>cat</code> 命令： 将两个文件连接时，如果第一个文件没有尾随换行符，第二个文件的第一行会紧挨着它。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># file1.txt 内容为 "Hello" (无\n)， file2.txt 内容为 "World\n"</span>
<span class="hljs-built_in">cat</span> file1.txt file2.txt
<span class="hljs-comment"># 输出： HelloWorld</span>
<span class="hljs-comment"># 而非预期的：</span>
<span class="hljs-comment"># Hello</span>
<span class="hljs-comment"># World</span>
</code></pre>
</li>
<li>
<p><code>wc -l</code> 命令： 用于统计行数。对于没有尾随换行符的文件，它统计的结果可能会少一行，因为最后一行不被认为是一行“完整的行”。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Hello"</span> &gt; file.txt
<span class="hljs-built_in">wc</span> -l file.txt
<span class="hljs-comment"># 输出 0</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Hello"</span> &gt; file.txt
<span class="hljs-built_in">wc</span> -l file.txt
<span class="hljs-comment"># 输出 1</span>
</code></pre>
</li>
<li>
<p>脚本和解析器： 某些Shell脚本或数据解析器在读取流时，如果最后一行没有换行符，可能会报错或无法正确处理最后一条数据。</p>
</li>
</ul>
<p>统一尾随换行符，确保了你的代码和文本文件能够在整个Unix工具链中流畅运行。</p>
<h4 data-id="heading-11">3.3 代码规范与可读性</h4>
<p>从视觉上看，让光标停留在文件内容的最后，而不是一个新行，对于某些开发者来说可能显得“未完成”。尾随换行符使得在终端下用 <code>cat</code> 或 <code>tail</code> 查看文件时，提示符 <code>$</code> 能出现在一个新行上，而不是紧跟在文件内容后面，这提升了可读性。</p>
<p>更重要的是，它强制了一种一致性。软件工程的一大挑战就是管理复杂性，而统一的代码风格（包括这种看不见的格式）是降低复杂性的有效手段。</p>
<h3 data-id="heading-12">第四章：跨越编辑器的共识</h3>
<p>IDEA并非个例。事实上，这已经成为现代编辑器的共识：</p>
<ul>
<li>Visual Studio Code: 状态栏右下角会显示 <code>LF</code> 或 <code>CRLF</code>，点击它可以更改。同时，它也有 <code>files.insertFinalNewline</code> 设置项，效果相同。</li>
<li>Sublime Text: 可通过 <code>"ensure_newline_at_eof_on_save": true</code> 配置。</li>
<li>Vim: 可以通过 <code>:set eol</code> 和 <code>:set fixeol</code> 配置。</li>
<li>Git: 甚至本身也参与了管理，通过 <code>core.autocrlf</code> 配置项，可以在提交和检出时自动转换换行符，其中也包括了对尾随换行符的处理。</li>
</ul>
<p>这些工具的共同努力，正在逐步消除因平台和编辑器差异带来的格式问题。</p>
<h3 data-id="heading-13">结论：拥抱规范，专注创新</h3>
<p>文章开头那个看似奇怪的“光标跳动”，不再是IDE的一个无厘头行为，而是其作为一款专业工具，在背后默默践行软件工程最佳实践的体现。它是一位严格的代码规范守护者，通过自动化的方式，帮助我们：</p>
<ol>
<li>遵循历史标准，保证文件的正确性。</li>
<li>消除版本控制噪音，让提交历史更清晰，聚焦于真正的代码逻辑变更。</li>
<li>确保与强大命令行工具链的兼容性，避免脚本和工具运行时出现意外错误。</li>
<li>促进团队协作的统一性，减少因环境差异导致的无效沟通和调试。</li>
</ol>
<p>所以，下次当你看到光标自动跳到新的一行时，你可以会心一笑。这不是一个需要被修复的Bug，而是一个值得赞赏的Feature。我们的建议是：保持你的IDE默认设置，接受并理解这份“贴心”。</p>
<p>在软件开发中，正是这些对细节的严谨对待，才构建起了庞大而稳定的数字世界的基础。让我们将精力从纠结这些格式问题上解放出来，去专注于创造更有价值的创新和逻辑吧。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元]]></title>    <link>https://juejin.cn/post/7572012699627880475</link>    <guid>https://juejin.cn/post/7572012699627880475</guid>    <pubDate>2025-11-13T10:28:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699627880475" data-draft-id="7572130072262901806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-13T10:28:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:28:50.000Z" title="Thu Nov 13 2025 10:28:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19cd4beb6f464b9289a130cbf1b926d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=k2N7Y92R%2FVjMvrDvqAcE642Gzxk%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】只用一张图，一句话，就能创造出随便乱逛的 3D 世界——李飞飞这次不是在讲故事，而是真的给你「造梦神器」。今天起，全球上线，人人可用。」</strong></h5>
<p>李飞飞的「创世神器」今天终于正式上线了！人人可用。</p>
<p>这个由 WorldLabs 推出，名为 Marble 的网站，用世界模型可以生成瑰丽梦幻的「想象世界」～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2755b929348c4d0cb1287f7fb3d27d5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=X1NXnPN9d5Z13%2BhDjYNKmMGuDV4%3D" alt="" loading="lazy"/></p>
<p>体验网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarble.worldlabs.ai%2F" target="_blank" title="https://marble.worldlabs.ai/" ref="nofollow noopener noreferrer">marble.worldlabs.ai/</a></p>
<p>这波属实是李飞飞自己联动自己了，前两天她的一篇万字长文火爆硅谷，定义 AI 的下一个十年是「空间智能」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06f36afe44324cd69d0e8b0143097077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=q27zQ0UAVUpK8ST419UCrJY4WFs%3D" alt="" loading="lazy"/></p>
<p>文章中，她为真正具备空间智能的「世界模型」所需达成的目标勾勒了一个框架。</p>
<p>而今天这个「世界」正式面向全世界发布。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a44650cdd9042b1bb8358e77e977354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=Rlo9tRn1VY2qNJ3jOh0h%2BKJIUkk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c5fab7286b54d2ebfd64aaa134c9f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=2nkeviuepdmnDdZllYjVxrccnkQ%3D" alt="" loading="lazy"/></p>
<p>看一下官方视频的效果。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>World Labs 最新官方宣传视频</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e625a9794c2464887304c97ca8cfda3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=DxIIDryHwqNmXLgFzu6qLNUmPRU%3D" alt="" loading="lazy"/></p>
<p><strong>「Marble：世界模型」</strong></p>
<p>人类对世界的感知本质上是多模态的：我们调动所有感官来理解周遭环境。</p>
<p>通过整合视觉、听觉、触觉与语言，我们构建起对外部世界的心理模型；这些不同表征方式相互协作、彼此增强，使我们能够理解世界并在其中采取行动。</p>
<p>世界模型应当以类似方式运作。它们需要具备大规模多模态能力，能够将各种可用输入信号提升为完整的三维世界，并随着新信息的出现持续迭代更新对世界的认知。</p>
<p>Marble 是开创先河的新一代世界模型，正朝着这一愿景大步迈进。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3408fd1d58a947e0b36ebb0ed4b4dcca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=B0%2Blq7hcZGwe87mDuvI7VN%2FNliY%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94b1002e07246ac855ffd3c0383fe2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=M%2FMPKks0bfUdNGDYCgo9XQAlGsU%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「文本与图像世界」</strong></p>
<p>首先，Marble 能够仅凭一张图片或简短文字提示创建完整的 3D 世界。这是最简单便捷的造物方式。</p>
<p>Marble 可生成涵盖多种场景类型与艺术风格的世界。</p>
<p>图像提示使得将 Marble 与其他 AI 工具结合变得轻而易举。可以使用喜爱的图像生成模型创建图像，随后将其导入 Marble，即可将其提升为完整的 3D 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3467d62d0c14e68b403699131af23ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=ZSLG9%2BeoSEhKs7a9INgdDnjrSIY%3D" alt="" loading="lazy"/></p>
<p>文本和图像提示直观且强大，但在创意控制方面存在局限：Marble 必须自行构建输入文本或图像提示中未包含的世界细节。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1bd9353cef949e49741c2136acdf17c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=SUcM2ISBiXpHZJxJA8XskPpgRco%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「多图像和视频到世界模型」</strong></p>
<p>实现更具创意控制的世界构建，一种简便方法是采用多图像提示技术。</p>
<p>Marble 能够接收针对世界不同部分的多样化提示图像，并将它们无缝融合成统一的 3D 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27286b252de44fd89bd6507ed1d731af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=ET7Hi6bsXQFmjiAFzYuo1UDUbQ4%3D" alt="" loading="lazy"/></p>
<p>多图像提示能以更高精度创造世界。</p>
<p>这带来了一种全新的世界生成工作流程。可以使用喜爱的图像生成工具分别迭代输入视角，而 Marble 会将其提升为完整的三维世界，同时为输入视角之间添加无缝过渡效果。</p>
<p>Marble 可以输入几张照片或一段从不同角度描绘现实世界位置的短视频，它会将这些素材组合起来，生成包含现实空间元素的 3D 世界。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3d0df0d7234f8d92b844b295dc25f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=BGJnSQKXZLJo7oJvrjX1ALNPs%2FU%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「世界编辑」</strong></p>
<p>对许多用户而言，创作过程具有高度迭代性。生成世界往往只是创意旅程的起点。当看到生成的 3D 世界时，通常会激发更多修改或完善它的灵感。</p>
<p>Marble 内置了 AI 原生世界编辑工具。编辑可以细微而局部：移除物体、修饰区域；也可以更加彻底：替换</p>
<p>物体、改变视觉风格，或重构世界的大部分结构。这为世界创建过程带来了全新层次的精细控制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3cf3999961c4045bfc82bca3af936f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=JlYD3FyVXWEI6LjEaAVW%2FFkjJCM%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55b08542376b4f4cafb8dbc33303483d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=7LKCSk4G1%2FH8AEfZ6iSOt7dDXHo%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「Chisel：在三维世界中雕琢天地」</strong></p>
<p>Chisel 和世界编辑还不太一样，有点像一根魔法棒。</p>
<p>Marble 的多模态输入与编辑功能赋予对生成世界的强大掌控力。</p>
<p>但有时，要将脑海中的构想精确呈现，仍需对场景布局或物体的精确尺寸位置进行更精细的调控。</p>
<p>针对这些场景，推出 Chisel——一款原生 AI 工具，可直接在三维空间中雕琢 Marble 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10680ecd20fc4a40a4483777a7666d6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=v5QYNfkR0kQcI1uqIvS1dwwerj4%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c300ba2c87754232b40f9cc696703656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=lpc0k0PtdC0%2FQjPocC3fmSaeKO4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「将世界导出为 3D 或者视频格式」</strong></p>
<p>使用 Marble 创建世界后，有多种导出选项以便将其整合到下游项目中。</p>
<p>高斯溅射点是 Marble 世界最高保真度的呈现方式。它将 3D 场景表示为大量半透明粒子集合。</p>
<p>可以通过与 THREE.js 集成的开源跨平台渲染器 Spark，在浏览器中实时渲染高斯溅射点。</p>
<p>Marble 世界亦可导出为三角网格模型。</p>
<p>系统能够同时生成用于粗略物理模拟的低精度碰撞体网格，以及尽可能匹配高斯溅射点视觉精度的高质量网格。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee94e6cad3541dba11c8dff5a02a37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=FUg3e9HJ%2BK9XSd3Aoz6LbT%2B%2BHIc%3D" alt="" loading="lazy"/></p>
<p>通过网格格式导出世界，可使其与众多行业标准工具实现无缝协作。</p>
<p>Marble 世界以完整 3D 形式存在，但有时视频才是分享世界的最佳方式。</p>
<p>可以使用 Marble 将生成的世界渲染成视频，通过像素级精准的相机控制，让每个镜头都如您想象般完美构图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f0366c039b4c19a71929e26c686e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=oKsZowoBaBhAc7QCtKyHxLpDd5o%3D" alt="" loading="lazy"/></p>
<p>Marble 是一款先进的生成式世界模型。</p>
<p>但只是我们迈向空间智能征途中的一步。</p>
<p>未来，交互性将成为一个关键机遇。</p>
<p>未来的世界模型将让人类与智能体都能以全新方式与生成世界互动，从而在仿真、机器人技术及其他领域解锁更多应用场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d1dbbd333294512bbdeb93b92107597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=9LdBOBtMTBcsVo9a7WUsSOO%2Fsas%3D" alt="" loading="lazy"/></p>
<p><strong>「空间智能是 AI 的下一个前沿」</strong></p>
<p>李飞飞在她的万字长文中结尾写下的感慨是对这波 AI 浪潮、智能、人类和机器命运最好的总结：</p>
<p>过去十年见证了 AI 成为一种全球现象，以及技术、经济乃至地缘政治的转折点。</p>
<p>但作为一名研究者、教育者，如今又是一名创业者，最能激励我的，仍然是图灵 75 年前提出的那个问题背后的精神。</p>
<p>我依然怀有他那份好奇与惊叹。</p>
<p>正是这种感觉，每天都激励着我迎接空间智能的挑战。</p>
<p>历史上第一次，我们有望构建出与物理世界如此协调的机器，以至于在我们面临的最严峻挑战中，可以将它们视为真正的伙伴。</p>
<p>无论是加速我们对实验室中疾病的理解，彻底改变我们讲述故事的方式，还是在我们因疾病、受伤或年老而最脆弱的时刻给予支持，我们都正处在一项新技术的风口浪尖，这项技术将提升我们最珍视的生活的方方面面。</p>
<p>这是一个更深刻、更丰富、更强大的生活愿景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c93abff73d2241aebea754f0c5138ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=qwQo1zhUCs02xphe4%2BpZIoj2sDo%3D" alt="" loading="lazy"/></p>
<p>在大自然与远古动物身上释放出第一缕空间智能的近五亿年后，我们有幸成为可能很快就能赋予机器同样能力的这一代技术专家中的一员——并有幸利用这些能力为世界各地的人们谋福祉。</p>
<p>我们关于真正智能机器的梦想，没有空间智能是不完整的。</p>
<p>这项探索，就是指引我的北极星。</p>
<p>我邀请你与我同行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/531a911ce7284fc4a4bd4587440dd6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=gdOmSAlhWgL4PR%2FlWaKSL02wK4c%3D" alt="" loading="lazy"/></p>
<p><strong>「One More Thing」</strong></p>
<p>Marble 定价方面，目前共有 3 个档位，最高一个月 95 美元，可以最多生成 75 个世界。</p>
<p>免费版本只能上传图片，可以生成 4 个世界。</p>
<p>现在 Pro 版本，首月只需 1 美元！标准版本依然还是业界最普遍的一个月 20 美元。</p>
<p>你认为这个价格合理吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9cfbe255e541a3aaf159c000b509e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=eTrRvOXCHQf8stF%2BABiSI83YZ%2F0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e77ec5fa5dc40f98d167fec9ff725e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=0%2FYXAJPreqznE1ic5HFHTYNbubQ%3D" alt="" loading="lazy"/></p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.worldlabs.ai%2Fblog%2Fmarble-world-model" target="_blank" title="https://www.worldlabs.ai/blog/marble-world-model" ref="nofollow noopener noreferrer">www.worldlabs.ai/blog/marble…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了]]></title>    <link>https://juejin.cn/post/7572002432450936841</link>    <guid>https://juejin.cn/post/7572002432450936841</guid>    <pubDate>2025-11-13T10:30:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450936841" data-draft-id="7572016447804735514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T10:30:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:30:46.000Z" title="Thu Nov 13 2025 10:30:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d66f6be0b7440799afa97c8ba012f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=DFSUUi7yT%2FEI89ngWS1D2chHFGM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】今天，OpenAI GPT-5.1「全家桶」突然登场，Instant 和 Thinking 王炸组合同步上线。这一次，模型情商智商双核升级，不仅更聪明，而且聊天更有人味了。」</strong></h5>
<p>没有直播，OpenAI 一早放大招，让所有人猝不及防。</p>
<p>就在刚刚，GPT-5.1 正式发布，GPT-5 系列重大升级版登场！</p>
<p>一共有三个版本，目前已经上线了前两个：</p>
<p>· GPT-5.1 Instant ：最常用的模型，语气更亲切、更智能，更善于遵循指令。</p>
<p>· GPT-5.1 Thinking ：先进的推理模型，更易于理解，处理简单任务速度更快，处理复杂任务更具持久力。</p>
<p>· GPT-5.1 Pro：即将上线</p>
<p>奥特曼激动表示，GPT-5.1 升级给力，尤其是指令遵循和自适应思考的改进。</p>
<p>当然，整体的智力和沟通风格，提升也很显著。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c82b2307b434181a457945e5a3a3f72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=XfBj4T8fJdnInfUjWeLTy7VU5V8%3D" alt="" loading="lazy"/></p>
<p>还记得 8 月初，GPT‑5 正式诞生，虽在全方位性能提升，但变得没有人味，更加冷淡。</p>
<p>一时间，全网喊话集体讨回 GPT-4o、o3 等模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f9fade43daa45f385d32a8e9726d064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=7EPazkdWnDCqzC%2B2DPSUeoyUrHA%3D" alt="" loading="lazy"/></p>
<p>许多人的真实反馈 OpenAI 听进去了——「一个优秀的 AI 不仅要聪明，还得会唠嗑才行」。</p>
<p>如今，两个月的迭代，OpenAI 把让所有人最想要的 GPT-5.1 带来了。</p>
<p>正如科学副总裁 Kevin Weil 所言，GPT-5.1 是 OpenAI 迄今为止推出的最完美的组合，<strong>「智商与情商双双在线」</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a9a578b0af14dc1a0c30b8596645445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=SMG0nf%2FOelUnO6BqNd4BwC35%2BeQ%3D" alt="" loading="lazy"/></p>
<p>值得一提的是，GPT-5.1 Instant 还要比 4o 的情商智商更强。</p>
<p>OpenAI 研究科学家 Aidan McLaughlin 称——</p>
<p>它是首个使用思维链（CoT），引入了「自适应推理」的模型，速度和 GPT-5 Instant 一样快。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c74136c8364e8bb996ae37199b46bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=c4vTkhKPxBrEzudt9JynOittYZ4%3D" alt="" loading="lazy"/></p>
<p>不仅如此，每个人还可以轻松地塑造 ChatGPT 的语气。</p>
<p>毕竟，每个人对聊天风格偏好不尽相同，甚至在不同对话中也会变化——因此通过「控制选项」，就可以轻松拿捏 ChatGPT 说话的调调，让其更对胃口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3806b18b51641d09a9564983a558418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=iMjGhRCg087Cp4xzj71IE9gX4dc%3D" alt="" loading="lazy"/></p>
<p>从专业可靠（Professional）、亲和友善（Friendly），到直言不讳（Candid）、天马行空（Quirky），再到吐槽达人（Cynical）、高效务实（Efficient）、技术宅（Nerdy），都能任意挑选**。**</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77776e7dc0af4b12b79f74a367946f38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=rml3hOW4J8QRmvDe%2B0lfphZd%2FUg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4085557412ad455fba0c51ad025f290a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=B2lkWBUWM1bxothoJVipBvBtoow%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3570d4258274041bf589c5438bc270b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=azzIMdwXaztyiHBdK9wZtIUsruk%3D" alt="" loading="lazy"/></p>
<p><strong>「GPT-5.1：更智能、更健谈」</strong></p>
<p>这次升级后的 GPT-5.1，在智力和沟通上，得到了大幅升级。</p>
<p>你会注意到的是，GPT-5.1 的所有回答在感觉上都更智能，语气也更自然。</p>
<p>其中，GPT-5.1 Auto 将继续为每个查询自动选择最适合的模型，因此在大多数情况下，你完全无需手动选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db20d4a970ae487ea8b454fbad732c10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=G%2BxPOyvX84nvKA%2Fp%2FsuNY9yAYFg%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838a303318ea4fec863fb2743da6e700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2aE1CGp7yf5namNhnqC5GNH4cUE%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「GPT-5.1 Instant」</strong></p>
<p>GPT-5.1 Instant 是 ChatGPT 使用最广的模型，现在它的默认语气将会更显亲切和健谈。</p>
<p>根据早期测试，它常常会出其不意地展现出俏皮的一面，同时回答依然清晰实用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c15cf3403f49465e8d157dc5db4dfb87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=qCSnEN4ojvFFkA3hGay6SKGhgkI%3D" alt="" loading="lazy"/></p>
<p>I'm feeling stressed and could use some relaxation tips</p>
<p>我感到有压力，需要一些放松的建议</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123babdb719c4e21b1c96de56a6d3d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=%2FFkk5qwq%2F%2BrH%2Fn7PV3nKRtnhMvc%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51adf017cb9d43a685d56520d60f4007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=JqRYXyKkOmW2%2BIN14yPuC29zU0Y%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Instant（上下滑动查看）</p>
<p>除此之外，OpenAI 还改进了指令遵循能力，使模型能更可靠地回答你实际提出的问题。</p>
<p>Always respond with six words</p>
<p>始终用六个词回答</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/098c0e5d430642039ab0861d0e9250d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=UzPRhvKBZICaBYCa6IUgbcBdFR4%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df27f362cd504e448c67bee83b0ce354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2ky%2Bvq5lqCO2Tn8cxQdVqNpjnKU%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Instant（上下滑动查看）</p>
<p>值得一提的是，GPT-5.1 Instant 首次引入了「自适应推理」能力，能够自主决定在回应更具挑战性的问题前是否需要深入思考，从而在保持快速响应的同时，产出更周全、更准确的答案。</p>
<p>这一点在 AIME 2025 和 Codeforces 等数学与编程评测中的显著进步得到了体现。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf446265f87a4730be17ca14506fa155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=pWGYjIyAUh2498FyUuMUO%2BOOK7E%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「GPT-5.1 Thinking」</strong></p>
<p>与此同时，升级后的 GPT-5.1 Thinking 也会在日常使用中更高效、更易于理解。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc2075486daa4a29b50c8635fa635dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=qjumqRKg35mvw7EV5AuaN275m3g%3D" alt="" loading="lazy"/></p>
<p>现在，它能更精确地根据问题调整思考时间——在复杂问题上投入更多时间，而在简单问题上则响应更快。</p>
<p>在实际使用中，这意味着对于困难的请求，你将获得更详尽的答案；对于简单的请求，等待时间则会更短。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eeb4cd56a76409288ad382370a5a5b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=O161aWnkzQXjjZALjadzRPgCoPM%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking 的回复也更加清晰，减少了专业术语和晦涩词汇的使用。</p>
<p>这使 OpenAI 最强大的模型变得更平易近人、更易于理解，尤其是在处理复杂工作任务和解释技术概念时。</p>
<p>explain BABIP and wRC+</p>
<p>解释 BABIP 和 wRC+</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cface1605a944c3be318f39f9e6e416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=UejcuVMIuwpRggU3cD%2BimOb26zw%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0db9864b2b748b0bd527a153ab4dfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=bBS0BhSXORXC1Ry6SQSLFCb4OcM%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking（上下滑动查看）</p>
<p>GPT-5.1 Thinking 的默认语气也更加亲切，更富同理心。</p>
<p>Ugh I spilled coffee all over myself before my meeting do you think everyone thought I was an idiot :(</p>
<p>呃，我在会议前把咖啡洒满了自己，你觉得大家会不会都认为我是个白痴 :(</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/699cde126f8149378ac36687f3da011c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=e3QC36Qn0r8tPdev4fPL3bIEKeU%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1780691f573b466eb0abb6784fbf4c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=kUz%2FNfbeuhC6nIuvf1UyBtzEgAU%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking（上下滑动查看）</p>
<p>关于命名的一点说明：</p>
<p>本次更新名为 GPT-5.1，旨在反映其重大改进，同时表明它仍属于 GPT-5 这一代。未来对 GPT-5 的迭代升级将遵循相同的模式。</p>
<p>同在今天，OpenAI 还发布了 GPT-5.1 系统卡，更多内容可参阅 PDF。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2f8bc3cd3b4f019710e4b08c0834cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=6FfMR1CvhkmjYcF2gJysfjVuY98%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.openai.com%2Fpdf%2F4173ec8d-1229-47db-96de-06d87147e07e%2F5_1_system_card.pdf" target="_blank" title="https://cdn.openai.com/pdf/4173ec8d-1229-47db-96de-06d87147e07e/5_1_system_card.pdf" ref="nofollow noopener noreferrer">cdn.openai.com/pdf/4173ec8…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bf613e42bfc4e32a2499b7de67e6adf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=BuWt5gW8C3x9gdy6wPKXEq3s%2BNc%3D" alt="" loading="lazy"/></p>
<p><strong>「让 ChatGPT 成为独一无二的你」</strong></p>
<p>除了 GPT-5.1 重大升级，想要自定义 ChatGPT 的语气和风格，如今变得更加简单。</p>
<p>毕竟，众人胃口难调，每个人都有自己偏好的聊天方式和风格。</p>
<p>OpenAI 的目标就是，所有人可以轻松搞定设置，让 ChatGPT 用自己最舒服的语气交流。</p>
<p>今年早些时候，OpenAI 添加了预设选项来调整 ChatGPT 的回复语气。</p>
<p>今天，这些选项正在优化，可以更好地反映人们使用 ChatGPT 的最常见方式。</p>
<ul>
<li><strong>「默认」****（</strong>「<strong>「Default」</strong>」<strong>）</strong>「、<strong>「亲和友善」****（****Friendly）」</strong>（原「倾听者」）和**高效务实（Efficient）（**原「机械」）风格将获得更新</li>
<li>同时新增了**「专业可靠（Professional）」**、<strong>直言不讳（Candid）</strong>「和」**天马行空（Quirky）**风格。</li>
<li><strong>吐槽达人（Cynical）</strong>「和」**技术宅（Nerdy）**风格则保持不变。</li>
</ul>
<p>这些选项旨在匹配 OpenAI 观察到的用户自然引导模型的方式，让人们能快速直观地选择一个感觉最对味的「个性」。</p>
<p>这些个性化设置适用于所有模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/337dfaf4a19049eba839f8afbbc186d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=TpUcsnQlgioS2uyZpomChIxLWV0%3D" alt="" loading="lazy"/></p>
<p>左：GPT-5.1；右：GPT-5</p>
<p>除了这些预设，对于希望更精细地控制 ChatGPT 回应方式的用户，OpenAI 还在试验一项新功能：</p>
<p>直接从个性化设置中调整 ChatGPT 的具体特征——包括其回复的简洁度、亲切度或易读性（是否便于快速浏览），以及使用表情符号的频率 。</p>
<p>当 ChatGPT 在对话中，注意到你偏爱某种特定语气或风格时，它还会主动提议更新这些偏好，而无需手动进入设置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb70261048f4dc0ba37e8900c5cbdb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2L5%2BPanAte6Ipxu%2BZI%2FMjIZP4uo%3D" alt="" loading="lazy"/></p>
<p>与此同时，可以随时调整或移除这些偏好。</p>
<p>更新后的风格和语气选项，将于今日起陆续推出。微调特定特征的功能将作为一项实验，从本周晚些时候开始向部分用户逐步开放。</p>
<p>这两项功能，都将在后续不断得到完善。</p>
<p>此外，更新后的 GPT-5.1 也更善于遵循「自定义指令」，让你对语气和行为有更精确的控制。</p>
<p>目前，在个性化设置中更新后，会立即在所有聊天中生效，包括正在进行的对话，从而确保体验的一致性。</p>
<p>还需要注意一点是，对基础风格、语气或自定义指令的更改仅适用于新开启的对话。</p>
<p>总而言之，GPT-5.1 重大更新和新的自定义选项，是 OpenAI 迈向一个更懂你、更智能、更健谈、更能适应个人偏好的 ChatGPT 的重要一步。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/205ea063d0dd472f89c18d7fb547a59c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=9RVkSAAci8GFp88Hn88PUZTpuJc%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「即日可用」</strong></p>
<p>今日起，GPT-5.1 Instant 和 Thinking 将率先向付费用户（Pro、Plus、Go、Business）陆续推出，随后向免费及未登录用户开放。</p>
<p>本周晚些时候，这两款模型也会登陆 API。其中，GPT-5.1 Thinking 将会以「GPT-5.1」的名称发布，而 GPT-5.1 Instant 则是「gpt-5.1-chat-latest」，两者均具备自适应推理能力。</p>
<p>未来三个月里，GPT-5（Instant 和 Thinking）将继续在 ChatGPT 的「旧模型」下拉菜单中为付费用户提供，以便用户按照自己的节奏进行比较和适应。</p>
<p>值得一提的是，OpenAI 确实从上一次全系下架所有旧模型惹怒网友，吸取了惨痛的教训。</p>
<p>它们表示，未来当 OpenAI 推出新的 ChatGPT 模型时，策略是给予用户充足的空间来评估变化并分享反馈，从在平稳过渡的同时，持续创新前沿模型。模型的淘汰周期将会提前明确地通知。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgpt-5-1%2F" target="_blank" title="https://openai.com/index/gpt-5-1/" ref="nofollow noopener noreferrer">openai.com/index/gpt-5…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FOpenAI%2Fstatus%2F1988714373058351213%3Fs%3D20" target="_blank" title="https://x.com/OpenAI/status/1988714373058351213?s=20" ref="nofollow noopener noreferrer">x.com/OpenAI/stat…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程]]></title>    <link>https://juejin.cn/post/7571815997068165160</link>    <guid>https://juejin.cn/post/7571815997068165160</guid>    <pubDate>2025-11-13T10:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068165160" data-draft-id="7572010680896421928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程"/> <meta itemprop="keywords" content="JavaScript,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T10:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="依米_"/> <meta itemprop="url" content="https://juejin.cn/user/1354189312111303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1354189312111303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    依米_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:44:35.000Z" title="Thu Nov 13 2025 10:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文带你剖析 Promise 实现原理，状态机、发布订阅模式完美实现异步编程</h2>
<blockquote>
<p>注：本文代码为仿promise原理简写的代码，非源码。</p>
</blockquote>
<h3 data-id="heading-1">1. 概述</h3>
<p>本文档详细解析了基于 ES6 Class 实现的 Promise，包括其核心原理、状态管理机制、异步处理流程以及各种方法的实现细节。通过深入理解 Promise 的内部实现，帮助你更好地掌握异步编程范式。</p>
<h3 data-id="heading-2">2. Promise 核心原理</h3>
<h4 data-id="heading-3">2.1 状态机设计</h4>
<p>Promise 采用状态机模式，具有三种互斥状态：</p>
<ul>
<li><strong>pending</strong>: 初始状态，既未完成也未拒绝</li>
<li><strong>fulfilled/resolved</strong>: 操作成功完成</li>
<li><strong>rejected</strong>: 操作失败</li>
</ul>
<p>核心特性：<strong>状态一旦改变，就不会再变</strong>，这是 Promise 可靠性的基础。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态定义与初始化</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>      <span class="hljs-comment">// 初始状态为 pending</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>       <span class="hljs-comment">// 存储成功结果</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>      <span class="hljs-comment">// 存储失败原因</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [] <span class="hljs-comment">// 成功回调队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [] <span class="hljs-comment">// 失败回调队列</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-4">2.2 发布-订阅模式</h4>
<p>Promise 内部采用发布-订阅模式处理异步回调：</p>
<ul>
<li>在 pending 状态时，通过 then/catch 方法注册的回调会被存储在回调队列中</li>
<li>当 Promise 状态改变时，会遍历执行对应队列中的所有回调(constructor中通过resolve或reject函数触发回调)</li>
</ul>
<p>这解决了异步操作和回调注册的时序问题，确保即使回调在状态变更前注册，也能在状态变更后得到执行。</p>
<h3 data-id="heading-5">3. 核心实现详解</h3>
<h4 data-id="heading-6">3.1 构造函数实现 💖</h4>
<p>构造函数接收一个 executeFn 函数，立即执行该函数并传入 resolve 和 reject 两个函数作为参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-comment">// 初始化状态和数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []
  
  <span class="hljs-comment">// 使用箭头函数定义 resolve/reject，确保 this 指向 Promise 实例</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
      <span class="hljs-comment">// 发布成功事件，执行所有成功回调</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
    }
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
      <span class="hljs-comment">// 发布失败事件，执行所有失败回调</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
    }
  }
  
  <span class="hljs-comment">// 捕获 executeFn 执行过程中的异常</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">executeFn</span>(resolve, reject)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">reject</span>(error)
  }
}
</code></pre>
<h4 data-id="heading-7">3.2 then 方法实现💖</h4>
<p><code>then</code> 方法是 Promise 规范（Promise/A+）的核心，它是 Promise 能够实现异步操作链式调用的关键机制，被誉为 JavaScript 异步编程的革命性突破。其重要性体现在：</p>
<ul>
<li><strong>彻底解决回调地狱问题</strong>：通过链式调用替代嵌套回调，使异步代码可读性大幅提升</li>
<li><strong>统一异步操作接口</strong>：为所有异步操作提供了标准化的处理方式</li>
<li><strong>错误传播机制</strong>：实现了错误在链式调用中的自动传递，无需每层都添加错误处理</li>
<li><strong>状态隔离与数据传递</strong>：保证了异步操作结果的正确传递和状态的严格隔离</li>
<li><strong>异步操作编排</strong>：支持复杂异步操作流程的构建和组合</li>
</ul>
<p><strong>核心要点：</strong></p>
<ol>
<li>
<p><strong>值穿透机制（参数校验与默认处理）</strong></p>
<ul>
<li>当 <code>onFulfilled</code> 或 <code>onRejected</code> 不是函数时（初始化为函数），Promise 规范要求实现「值穿透」</li>
<li>成功状态的值穿透：<code>value =&gt; value</code> - 确保成功的值能够继续在链中传递</li>
<li>失败状态的值穿透：<code>reason =&gt; { throw reason }</code> - 确保错误能够继续在链中传播</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>这一机制使得可以在链式调用中间跳过某些处理步骤而不中断链式调用</p>
<blockquote>
<p>当 then 方法不传递回调函数时，会使用默认函数将值传递给下一个 then 方法，实现值的穿透。</p>
</blockquote>
</li>
</ul>
<ol start="2">
<li>
<p><strong>链式调用实现（Promise 链）</strong></p>
<ul>
<li>每次调用 <code>then</code> 方法都返回一个全新的 Promise 实例（<code>promise2</code>）</li>
<li>这是链式调用的基础，保证了每个 <code>then</code> 操作都在独立的 Promise 上下文中执行</li>
</ul>
</li>
</ol>
<ul>
<li>新 Promise 的状态由回调函数的执行结果决定，实现了状态的隔离和转换</li>
</ul>
<ol start="3">
<li>
<p><strong>状态驱动的行为模式---状态机</strong></p>
<ul>
<li><strong>根据当前 Promise 的状态</strong>（pending/fulfilled/rejected）<strong>采取不同的处理策略</strong></li>
<li>已完成状态（fulfilled/rejected）：立即异步执行对应回调</li>
<li>进行中状态（pending）：将回调函数存储到对应队列中等待执行</li>
<li>这体现了状态模式的设计思想，行为随状态而变化</li>
</ul>
</li>
<li>
<p><strong>异步执行保证</strong></p>
<ul>
<li>使用 <code>setTimeout(fn, 0)</code> 模拟微任务，确保回调函数异步执行</li>
<li>这符合 Promise/A+ 规范要求，保证了回调执行的时序一致性</li>
<li>避免了同步执行可能导致的状态不一致和执行顺序问题</li>
</ul>
</li>
<li>
<p><strong>结果处理与值传递</strong></p>
<ul>
<li>通过 <code>resolvePromise</code> 辅助函数处理回调返回值，支持：
<ul>
<li>返回 Promise 对象：等待该 Promise 解决并采用其结果</li>
<li>返回普通值：直接将该值作为下一个 Promise 的成功值</li>
<li>抛出异常：将异常作为下一个 Promise 的失败原因</li>
</ul>
</li>
<li>这一设计实现了值在异步链中的自然传递和转换</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
  <span class="hljs-comment">// 参数校验，支持值穿透.当 `onFulfilled` 或 `onRejected` 不是函数时,使用箭头函数将其转为函数。实现值穿透</span>
  onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">'function'</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value
  onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-keyword">throw</span> reason }

  <span class="hljs-comment">// 返回新的 Promise 以支持链式调用</span>
  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 成功状态处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
      <span class="hljs-comment">// 异步执行回调</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 使用了值穿透，这里才能直接使用onFulfilled(this.value)，否则就异常了</span>
          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>) 
          <span class="hljs-comment">// 处理回调返回值</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">reject</span>(error)
        }
      }, <span class="hljs-number">0</span>)
    }

    <span class="hljs-comment">// 失败状态处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'rejected'</span>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">reject</span>(error)
        }
      }, <span class="hljs-number">0</span>)
    }

    <span class="hljs-comment">// pending 状态处理 - 存储回调</span>
    <span class="hljs-comment">// 订阅过程（注册回调）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        }, <span class="hljs-number">0</span>)
      })

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        }, <span class="hljs-number">0</span>)
      })
    }
  })

  <span class="hljs-keyword">return</span> promise2
}
</code></pre>
<h4 data-id="heading-8">3.3 resolvePromise 辅助函数--处理 <code>then</code> 方法回调函数的返回值💖</h4>
<p><strong>核心作用与重要性</strong></p>
<p><code>resolvePromise</code> 是 Promise 实现中最为复杂和核心的辅助函数，它是 Promise/A+ 规范中实现 "Promise Resolution Procedure"（Promise 解决过程）的关键。这个函数负责<strong>处理 <code>then</code> 方法回调函数的返回值</strong>，并<strong>根据返回值类型决定如何处理下一个 Promise 的状态转换，是实现链式调用和值传递的核心机制</strong>。</p>
<p><strong>参数说明</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
</code></pre>
<ul>
<li><code>promise2</code>: <code>then</code> 方法返回的新 Promise 实例</li>
<li><code>x</code>: <code>then</code> 方法回调函数的返回值（onFulfilled 或 onRejected 的返回值）</li>
<li><code>resolve</code>: promise2 的 resolve 函数，用于将 promise2 状态改为 fulfilled</li>
<li><code>reject</code>: promise2 的 reject 函数，用于将 promise2 状态改为 rejected</li>
</ul>
<p><strong>详细要点：</strong></p>
<ol>
<li>
<p><strong>循环引用检测</strong></p>
<ul>
<li>当 <code>x</code> 与 <code>promise2</code> 是同一个对象时，会导致无限循环</li>
<li>通过 <code>if (promise2 === x)</code> 判断避免这种情况，并抛出类型错误</li>
<li>这是 Promise/A+ 规范强制要求的安全机制</li>
</ul>
</li>
<li>
<p><strong>状态凝固保障</strong></p>
<ul>
<li>使用 <code>called</code> 标志变量确保 <code>resolve</code> 或 <code>reject</code> 只能被调用一次</li>
<li>这符合 Promise 的核心特性：状态一旦改变就不能再变</li>
<li>在所有可能调用 <code>resolve</code>/<code>reject</code> 的地方都检查 <code>called</code> 标志</li>
</ul>
</li>
<li>
<p><strong>Promise 类型处理</strong></p>
<ul>
<li>当 <code>x</code> 是 Promise 实例时，需要等待其状态变化</li>
<li>递归调用 <code>x.then()</code>，将结果继续通过 <code>resolvePromise</code> 处理</li>
<li>确保 Promise 链能够正确等待异步操作完成</li>
</ul>
</li>
<li>
<p><strong>thenable 对象兼容</strong></p>
<ul>
<li>"thenable" 对象是指具有 <code>then</code> 方法的对象或函数</li>
<li>通过动态获取 <code>x.then</code> 属性并检查其是否为函数来识别 thenable 对象</li>
<li>使用 <code>then.call(x, ...)</code> 调用 then 方法，确保上下文正确绑定</li>
<li>这是 Promise 能够兼容其他 Promise 实现的关键</li>
</ul>
</li>
<li>
<p><strong>异常处理机制</strong></p>
<ul>
<li>使用 try-catch 捕获访问 <code>x.then</code> 属性或调用 then 方法时可能发生的异常</li>
<li>任何异常都将导致 promise2 被拒绝，错误作为拒绝原因</li>
<li>异常处理也受到 <code>called</code> 标志的保护，确保只被处理一次</li>
</ul>
</li>
<li>
<p><strong>原始值直接传递</strong></p>
<ul>
<li>当 <code>x</code> 不是对象或函数时（原始值），直接调用 <code>resolve(x)</code></li>
<li>这确保了普通值能够正确地传递到下一个 Promise</li>
</ul>
</li>
</ol>
<p><strong>代码执行流程</strong></p>
<p>resolvePromise 的执行流程体现了 Promise/A+ 规范的严格要求：</p>
<ol>
<li>首先检查循环引用 → 2. 初始化 called 标志 → 3. 根据 x 的类型分三种情况处理：
<ul>
<li>Promise 实例 → 等待其状态变化并递归处理</li>
<li>对象/函数 → 检查是否为 thenable 并相应处理</li>
<li>原始值 → 直接 resolve</li>
</ul>
</li>
</ol>
<p><strong>为什么需要这个复杂的函数？</strong></p>
<p>resolvePromise 函数解决了 JavaScript 异步编程中的几个关键问题：</p>
<ul>
<li><strong>统一的异步接口</strong>：无论返回什么类型的值，都能按照统一规则处理</li>
<li><strong>跨 Promise 实现兼容</strong>：通过 thenable 机制支持不同的 Promise 实现</li>
<li><strong>防止状态不一致</strong>：通过 called 标志确保状态只变更一次</li>
<li><strong>避免死循环</strong>：通过循环引用检测确保程序安全</li>
<li><strong>正确的值传递</strong>：在异步链中确保值能够正确地从一个 Promise 传递到下一个</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {
  <span class="hljs-comment">// 处理循环引用 1.循环引用检测：当 `x` 与 `promise2` 是同一个对象时，会导致无限循环</span>
  <span class="hljs-keyword">if</span> (promise2 === x) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Chaining cycle detected for promise'</span>))
  }

  <span class="hljs-comment">// 防止多次调用 2.状态凝固保障：状态一旦改变就不能再变；确保 `resolve` 或 `reject` 只能被调用一次</span>
  <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// 处理 x 是 Promise 的情况 3.Promise 类型处理：当 `x` 是 Promise 实例时，需要等待其状态变化。</span>
  <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-comment">//递归调用 `x.then()`，将结果继续通过 `resolvePromise` 处理</span>
    x.<span class="hljs-title function_">then</span>(
      <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, value, resolve, reject),
      <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
    )
  }
    
  <span class="hljs-comment">// 4.thenable 对象兼容："thenable" 对象是指具有 `then` 方法的对象或函数</span>
  <span class="hljs-comment">// 处理 x 是对象或函数的情况（可能是 thenable）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'function'</span>)) {
    <span class="hljs-comment">// 5.异常处理机制：使用 try-catch 捕获访问 `x.then` 属性或调用 then 方法时可能发生的异常</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 动态获取 `x.then` 属性并检查其是否为函数来识别 thenable 对象</span>
      <span class="hljs-keyword">const</span> then = x.<span class="hljs-property">then</span>
      <span class="hljs-comment">// 判断是否为 thenable 对象</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// 使用 `then.call(x, ...)` 调用 then 方法，确保上下文正确绑定</span>
        <span class="hljs-comment">// 这是处理 thenable 对象的核心逻辑</span>
        then.<span class="hljs-title function_">call</span>(
          x,  <span class="hljs-comment">// 确保 then 方法内部的 this 指向 x 对象</span>
          
          <span class="hljs-comment">// 成功回调函数 - 当 thenable 对象被成功解析时执行</span>
          <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
            <span class="hljs-comment">// 状态凝固检查：如果已经调用过 resolve/reject，则直接返回</span>
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
            <span class="hljs-comment">// 标记为已调用，防止重复调用</span>
            called = <span class="hljs-literal">true</span>
            <span class="hljs-comment">// 递归调用 resolvePromise 处理 thenable 对象返回的 value</span>
            <span class="hljs-comment">// 这是实现链式调用和值传递的关键步骤</span>
            <span class="hljs-comment">// 例如：当 value 本身也是 Promise 或 thenable 时，会继续递归处理</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, value, resolve, reject)
          },
          
          <span class="hljs-comment">// 失败回调函数 - 当 thenable 对象被拒绝时执行</span>
          <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
            <span class="hljs-comment">// 状态凝固检查</span>
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
            <span class="hljs-comment">// 标记为已调用</span>
            called = <span class="hljs-literal">true</span>
            <span class="hljs-comment">// 直接拒绝 promise2，并将错误原因传递下去</span>
            <span class="hljs-title function_">reject</span>(reason)
          }
        )
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 普通对象，直接 resolve</span>
        <span class="hljs-title function_">resolve</span>(x)
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
      called = <span class="hljs-literal">true</span>
      <span class="hljs-title function_">reject</span>(error) <span class="hljs-comment">// 错误作为拒绝原因</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 原始值，直接 resolve 6.原始值直接传递</span>
    <span class="hljs-title function_">resolve</span>(x)
  }
}
</code></pre>
<blockquote>
<h3 data-id="heading-9">JavaScript中的 call 方法详解</h3>
<p><code>call</code>方法是JavaScript中函数对象的一个内置方法，它允许你调用一个函数并明确指定函数内部的<code>this</code>值。这在Promise实现中非常重要，特别是处理thenable对象时。</p>
<h4 data-id="heading-10">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>.<span class="hljs-title function_">call</span>(thisArg, arg1, arg2, ...)
</code></pre>
<h4 data-id="heading-11">主要作用</h4>
<ol>
<li><strong>改变函数内部的<code>this</code>指向</strong>
<ul>
<li>第一个参数<code>thisArg</code>就是函数执行时<code>this</code>的指向</li>
<li>后续参数作为函数的参数传入</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">为什么需要 call 方法？</h4>
<p>在JavaScript中，<strong>函数内部的<code>this</code>指向通常由调用方式决定，而不是定义方式</strong>。<code>call</code>方法提供了一种显式控制<code>this</code>指向的机制，这在很多场景下非常有用，尤其是在处理对象方法借用、回调函数、类继承等情况时。</p>
<h4 data-id="heading-13">Promise实现中的应用</h4>
<p>在Promise实现中，<code>call</code>方法主要用于处理thenable对象：</p>
<pre><code class="hljs language-javascript" lang="javascript">then.<span class="hljs-title function_">call</span>(
  x,  <span class="hljs-comment">// 确保 then 方法内部的 this 指向 x 对象</span>
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> { <span class="hljs-comment">/* 成功回调 */</span> },
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-comment">/* 失败回调 */</span> }
)
</code></pre>
<p><strong>这里为什么要用call？</strong></p>
<ul>
<li>thenable对象是指具有<code>then</code>方法的对象</li>
<li>我们<strong>需要调用这个对象的<code>then</code>方法，但同时要确保这个方法内部的<code>this</code>正确指向该对象本身</strong></li>
<li>如果直接写<code>x.then(...)</code>，在正常情况下<code>this</code>也会指向x，但使用<code>call</code>方法是更明确、更安全的做法，特别是在某些特殊情况下（如函数被赋值给变量后调用）</li>
</ul>
<h4 data-id="heading-14">简单例子说明</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个对象</span>
<span class="hljs-keyword">const</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">greeting</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>!`</span>);
  }
};

<span class="hljs-comment">// 正常调用 - this指向person</span>
person.<span class="hljs-title function_">greet</span>(<span class="hljs-string">'Hello'</span>);  <span class="hljs-comment">// 输出: "Hello, John!"</span>

<span class="hljs-comment">// 使用call改变this指向</span>
<span class="hljs-keyword">const</span> anotherPerson = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jane'</span> };
person.<span class="hljs-property">greet</span>.<span class="hljs-title function_">call</span>(anotherPerson, <span class="hljs-string">'Hi'</span>);  <span class="hljs-comment">// 输出: "Hi, Jane!"</span>
</code></pre>
<h4 data-id="heading-15">与Promise thenable处理的关系</h4>
<p>在Promise的<code>resolvePromise</code>函数中：</p>
<ol>
<li>我们检测到一个对象有<code>then</code>方法</li>
<li>我们需要调用这个<code>then</code>方法，但必须确保它在正确的<code>this</code>上下文中执行</li>
<li>使用<code>then.call(x, onFulfilled, onRejected)</code>确保了：
<ul>
<li><code>then</code>方法被调用</li>
<li><code>then</code>方法内部的<code>this</code>指向x对象</li>
<li>我们传入了成功和失败的回调函数</li>
</ul>
</li>
</ol>
<p>这种方式是Promise/A+规范要求的标准做法，确保了不同Promise实现之间的兼容性和正确的上下文绑定。</p>
</blockquote>
<h3 data-id="heading-16">4. Promise 扩展方法实现</h3>
<h4 data-id="heading-17">4.1 错误处理方法</h4>
<h5 data-id="heading-18">catch 方法</h5>
<p>专门用于捕获 Promise 链中的错误，<strong>本质是 then 方法的语法糖</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">catch</span>(onRejected) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)
}
</code></pre>
<h5 data-id="heading-19">finally 方法</h5>
<p><strong>无论 Promise 成功或失败都会执行的回调，不接收参数也不影响原 Promise 的结果</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">finally</span>(<span class="hljs-params">callback</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> value),
    <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> reason })
  )
}
</code></pre>
<h4 data-id="heading-20">4.2 静态方法</h4>
<h5 data-id="heading-21">resolve 方法</h5>
<p>返回一个已成功的 Promise，如果参数本身是 Promise 则直接返回：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-keyword">return</span> value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
}
</code></pre>
<h5 data-id="heading-22">reject 方法</h5>
<p>返回一个已失败的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">reason</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(reason))
}
</code></pre>
<h5 data-id="heading-23">all 方法💖</h5>
<p>等待所有 Promise 都成功，返回包含所有结果的数组；<strong>任一 Promise 失败则整体失败</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> result = []
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>))
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([])
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
        <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
          result[index] = value
          count++
          <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
            <span class="hljs-title function_">resolve</span>(result)
          }
        },
        <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
      )
    })
  })
}
</code></pre>
<h5 data-id="heading-24">race 方法</h5>
<p><strong>返回第一个完成的 Promise 的结果（无论成功或失败）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>))
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">promise</span> =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
        <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value),
        <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
      )
    })
  })
}
</code></pre>
<h3 data-id="heading-25">5.constructor中的resolve函数和外部的static resolve方法有何区别？</h3>
<p>在Promise实现中，constructor中的resolve函数和外部的static resolve方法有以下几个关键区别：</p>
<h4 data-id="heading-26">5.1. 定义位置与类型</h4>
<ul>
<li><strong>constructor中的resolve</strong>：是在Promise构造函数内部定义的局部函数，作为参数传递给executor函数，使用箭头函数定义以确保this指向Promise实例。</li>
<li><strong>static resolve方法</strong>：是Promise类的静态方法，通过<code>MyPromise.resolve()</code>直接调用，不属于任何实例。</li>
</ul>
<h4 data-id="heading-27">5.2. 主要作用</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>负责将Promise实例的状态从pending转变为fulfilled</li>
<li>设置成功值(value)并触发所有注册的成功回调函数</li>
<li>是Promise内部状态转换的核心机制</li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>作为Promise的工具方法，用于快速创建一个已成功状态的Promise实例</li>
<li>提供Promise包装功能，将任意值转换为Promise</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">5.3. 调用方式</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>由executor函数内部调用，通常是异步操作完成后</li>
<li>例如：<code>new MyPromise((resolve, reject) =&gt; { setTimeout(() =&gt; resolve(1), 1000); })</code></li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>直接通过类名调用，作为工厂方法使用</li>
<li>例如：<code>MyPromise.resolve(1)</code> 或 <code>MyPromise.resolve(promiseInstance)</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-29">5.4. 处理逻辑</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>检查当前状态是否为pending，确保状态只能变更一次</li>
<li>更新状态为fulfilled并存储成功值</li>
<li>异步执行所有已注册的成功回调</li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>检查传入值是否已经是Promise实例，如果是则直接返回</li>
<li>否则创建并返回一个新的已成功状态的Promise实例</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">5.5. 代码实现对比</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// constructor中的resolve（局部函数）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-comment">// static resolve方法（类静态方法）</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-keyword">return</span> value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
}
</code></pre>
<p>总结来说，constructor中的resolve是Promise内部状态管理的核心机制，负责状态转换和回调触发；而static resolve则是一个便捷的工具方法，用于创建已解决状态的Promise实例，实现值的Promise化包装。</p>
<h3 data-id="heading-31">6. 上述代码优化建议</h3>
<h4 data-id="heading-32">6.1 微任务模拟改进then 方法中 setTimeout</h4>
<p>当前实现使用 <code>setTimeout</code> 模拟异步执行，但实际的 Promise 使用微任务队列。在浏览器环境中，可以使用 <code>MutationObserver</code> 或 <code>MessageChannel</code> 更好地模拟微任务：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 微任务队列实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">microTask</span> = (<span class="hljs-params">fn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> queueMicrotask === <span class="hljs-string">'function'</span>) {
    <span class="hljs-title function_">queueMicrotask</span>(fn);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MutationObserver</span> === <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(fn);
    <span class="hljs-keyword">const</span> textNode = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>);
    observer.<span class="hljs-title function_">observe</span>(textNode, { <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span> });
    textNode.<span class="hljs-property">data</span> = <span class="hljs-string">'1'</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">setTimeout</span>(fn, <span class="hljs-number">0</span>);
  }
};

<span class="hljs-comment">// 然后在 then 方法中使用 microTask 替代 setTimeout</span>
</code></pre>
<h4 data-id="heading-33">6.2 增强静态方法</h4>
<p>可以扩展更多实用的静态方法，如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// allSettled 方法 - 等待所有 Promise 完成，不关心成功或失败</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">allSettled</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> results = [];
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([]);
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([]);
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise)
        .<span class="hljs-title function_">then</span>(
          <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
            results[index] = { <span class="hljs-attr">status</span>: <span class="hljs-string">'fulfilled'</span>, value };
            count++;
            <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
              <span class="hljs-title function_">resolve</span>(results);
            }
          },
          <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
            results[index] = { <span class="hljs-attr">status</span>: <span class="hljs-string">'rejected'</span>, reason };
            count++;
            <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
              <span class="hljs-title function_">resolve</span>(results);
            }
          }
        );
    });
  });
}

<span class="hljs-comment">// any 方法 - 返回第一个成功的 Promise</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">any</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> errors = [];
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>));
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>([], <span class="hljs-string">'All promises were rejected'</span>));
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise)
        .<span class="hljs-title function_">then</span>(resolve)
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
          errors[index] = error;
          count++;
          <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>(errors, <span class="hljs-string">'All promises were rejected'</span>));
          }
        });
    });
  });
}
</code></pre>
<h3 data-id="heading-34">7. 输入输出示例</h3>
<h4 data-id="heading-35">基本用法示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建并使用 Promise</span>
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'成功了！'</span>);
    <span class="hljs-comment">// reject('失败了！');</span>
  }, <span class="hljs-number">1000</span>);
});

promise.<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功:'</span>, value); <span class="hljs-comment">// 输出: 成功: 成功了！</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'链式调用'</span>;
  }
).<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'链式调用结果:'</span>, value); <span class="hljs-comment">// 输出: 链式调用结果: 链式调用</span>
  }
).<span class="hljs-keyword">catch</span>(
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'失败:'</span>, reason);
  }
);
</code></pre>
<h4 data-id="heading-36">静态方法使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise.all 示例</span>
<span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">100</span>)),
  <span class="hljs-number">3</span>
]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'all结果:'</span>, values); <span class="hljs-comment">// 输出: all结果: [1, 2, 3]</span>
});

<span class="hljs-comment">// Promise.race 示例</span>
<span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">race</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>), <span class="hljs-number">100</span>)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>), <span class="hljs-number">50</span>))
]).<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'race成功:'</span>, value),
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'race失败:'</span>, reason) <span class="hljs-comment">// 输出: race失败: 2</span>
);
</code></pre>
<h3 data-id="heading-37">8. 总结</h3>
<p>本文详细解析了 Promise 的实现原理，包括状态机设计、发布-订阅模式、异步执行机制以及各种方法的实现细节。通过深入理解这些核心概念，开发者可以更好地掌握异步编程范式，编写更加健壮和高效的异步代码。</p>
<p>Promise 的实现体现了优秀的设计模式应用，特别是状态机和发布-订阅模式的结合，解决了传统回调地狱问题，提供了更加优雅和可维护的异步编程解决方案。</p>
<h3 data-id="heading-38">思考1：状态机模式是什么？怎么在Promise中实现</h3>
<h4 data-id="heading-39">状态机模式的定义</h4>
<p>状态机模式是一种<strong>行为设计模式</strong>，它<strong>允许对象在内部状态改变时改变其行为</strong>。对象看起来好像修改了它的类，因为<strong>它的行为随着状态的变化而变化</strong>。在软件设计中，状态机模式特别适用于<strong>描述对象在其生命周期内可能经历的状态转换</strong>，以及这些状态转换所触发的行为。</p>
<p>在<strong>经典的设计模式分类</strong>中，我们通常不会直接使用"状态机模式"这个术语，而是使用 <strong>状态模式</strong>（State Pattern） 。状态机是一个更广泛的概念，而状态模式是实现状态机的一种面向对象设计模式。</p>
<p>总结</p>
<ul>
<li>状态模式（State Pattern） ：GoF正式定义的设计模式，属于23种经典设计模式之一。</li>
<li>状态机模式 ：更<strong>侧重于实现有限状态机概念的模式</strong>，在<strong>工程实践</strong>中的常用称呼。</li>
<li>Promise的实现同时符合状态模式的设计原则和状态机的核心概念，所以可以说它使用了状态模式（在设计模式术语中）或状态机模式（在工程实践术语中）。</li>
</ul>
<p>这就是为什么你可能在不同的资料中看到不同的称呼，但它们描述的是同一个核心设计思想。</p>
<h4 data-id="heading-40">Promise中的状态机实现</h4>
<p>在<code>promise-implementation-docs.md</code>文档中，Promise通过以下方式实现了状态机模式：</p>
<h5 data-id="heading-41">1. 状态定义</h5>
<p>Promise具有三种互斥的状态：</p>
<ul>
<li><strong>pending</strong>: 初始状态，既未完成也未拒绝</li>
<li><strong>fulfilled/resolved</strong>: 操作成功完成</li>
<li><strong>rejected</strong>: 操作失败</li>
</ul>
<h5 data-id="heading-42">2. 状态的不可变性</h5>
<p>核心特性是：<strong>状态一旦改变，就不会再变</strong>。这是Promise可靠性的基础，确保了异步操作的结果一旦确定就不会被覆盖。</p>
<h5 data-id="heading-43">3. 状态实现代码</h5>
<p>在构造函数中初始化状态和相关数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-comment">// 初始化状态和数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>      <span class="hljs-comment">// 初始状态为 pending</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>       <span class="hljs-comment">// 存储成功结果</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>      <span class="hljs-comment">// 存储失败原因</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [] <span class="hljs-comment">// 成功回调队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [] <span class="hljs-comment">// 失败回调队列</span>
  
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h5 data-id="heading-44">4. 状态转换机制</h5>
<p>通过<code>resolve</code>和<code>reject</code>函数实现状态转换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-comment">// 发布成功事件，执行所有成功回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
    <span class="hljs-comment">// 发布失败事件，执行所有失败回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
  }
}
</code></pre>
<h4 data-id="heading-45">状态机模式在Promise中的核心机制</h4>
<ol>
<li>
<p><strong>状态检查</strong>: 在转换状态前，会检查当前状态是否为<code>pending</code>，只有处于<code>pending</code>状态的Promise才能转换为<code>fulfilled</code>或<code>rejected</code>状态。</p>
</li>
<li>
<p><strong>状态与数据关联</strong>: 状态转换时，会同时存储相关的数据（成功值<code>value</code>或失败原因<code>reason</code>）。</p>
</li>
<li>
<p><strong>状态驱动行为</strong>: 状态的变化会触发相应的行为，例如执行存储在回调队列中的函数。</p>
</li>
<li>
<p><strong>互斥性</strong>: 三种状态是互斥的，任何时刻Promise只能处于其中一种状态。</p>
</li>
<li>
<p><strong>单向转换</strong>: 状态转换是单向的，只能从<code>pending</code>转换到<code>fulfilled</code>或<code>rejected</code>，一旦完成转换就不能再改变。</p>
</li>
</ol>
<p>这种状态机设计使Promise能够可靠地表示异步操作的最终结果，无论是成功还是失败，并确保异步操作的结果一旦确定就不会被覆盖，为JavaScript异步编程提供了可靠的基础。</p>
<h3 data-id="heading-46">思考2：promise中如何实现发布-订阅模式的</h3>
<p>在<code>MyPromise</code>实现中，发布-订阅模式主要体现在以下几个关键部分：</p>
<h4 data-id="heading-47">1. 事件中心（constructor中定义订阅列表）</h4>
<p>在Promise构造函数中定义了两个数组作为<strong>订阅者列表</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储Promise成功状态下需要执行的回调函数数组</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
<span class="hljs-comment">// 存储Promise失败状态下需要执行的回调函数数组</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []
</code></pre>
<p>这两个数组就是发布-订阅模式中的<strong>事件中心</strong>，用于存储所有注册的回调函数。</p>
<h4 data-id="heading-48">2. 订阅过程（<code>then</code>方法中注册回调）</h4>
<p>当Promise处于pending状态时，通过<code>then</code>方法注册的回调会被添加到对应的数组中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pending状态处理 - 存储回调</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error)
      }
    }, <span class="hljs-number">0</span>)
  })

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error)
      }
    }, <span class="hljs-number">0</span>)
  })
}
</code></pre>
<p>这部分代码实现了<strong>订阅</strong>功能，将回调函数添加到相应的事件队列中。</p>
<h4 data-id="heading-49">3. 发布过程（constructor中通过resolve或reject函数触发回调）</h4>
<p>当Promise状态发生变更时（通过resolve或reject函数），会遍历对应的回调数组并执行所有订阅的回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-comment">// 发布成功事件，执行所有注册的成功回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
    <span class="hljs-comment">// 发布失败事件，执行所有注册的失败回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
  }
}
</code></pre>
<h4 data-id="heading-50">发布-订阅模式的核心体现</h4>
<ol>
<li><strong>解耦性</strong>：Promise的状态变更（发布者）和回调执行（订阅者）完全解耦</li>
<li><strong>时序无关性</strong>：无论回调是在Promise状态变更前还是变更后注册，都能正确执行</li>
<li><strong>多订阅支持</strong>：允许多个回调订阅同一个Promise的状态变更</li>
<li><strong>异步协调</strong>：有效解决了异步操作和回调执行的时序问题</li>
</ol>
<p>通过这种发布-订阅模式，Promise巧妙地解决了JavaScript异步编程中的回调地狱问题，使代码更加清晰和可维护。</p>
<h5 data-id="heading-51">小朋友，你是否有很多❓</h5>
<p>解耦性是什么意思❓怎么做到的时序无关性❓怎么支持的多订阅❓异步协调是then方法中的setTimeout，怎么解决的时序问题❓</p>
<p>发布-订阅模式四个核心特性的具体体现：</p>
<h5 data-id="heading-52">1. 解耦性</h5>
<p>解耦性指的是Promise的<strong>状态status</strong>变更机制（发布者）和<strong>回调函数(onResolvedCallbacks、onRejectedCallbacks)<strong>执行（订阅者）<strong>完全分离</strong>，彼此之间</strong>不直接依赖</strong>。</p>
<p><strong>具体体现：</strong></p>
<ul>
<li>在<code>constructor</code>中定义了状态管理和回调数组，这是发布者的核心部分</li>
<li><code>resolve</code>和<code>reject</code>函数负责状态变更和发布事件（执行回调）</li>
<li><code>then</code>方法负责<strong>注册回调函数</strong>（pendding）到订阅列表中</li>
<li>发布者（状态变更逻辑）不需要知道具体有哪些订阅者（回调函数）</li>
<li>订阅者（回调函数）也不需要知道状态何时会变更</li>
</ul>
<h5 data-id="heading-53">2. 时序无关性</h5>
<p>时序无关性确保无论回调是在<strong>Promise状态变更前还是变更后注册，都能正确执行</strong>。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在then方法中</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
  <span class="hljs-comment">// 状态未变更时：存储回调到队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 回调逻辑 */</span> })
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
  <span class="hljs-comment">// 状态已变更时：直接执行回调</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 回调逻辑 */</span> }, <span class="hljs-number">0</span>)
}
</code></pre>
<ul>
<li>当Promise已经是fulfilled或rejected状态时，调用then方法会立即异步执行对应回调</li>
<li>当Promise还是pending状态时，<strong>回调会被存储在数组中，等待状态变更后执行</strong></li>
<li>这样<strong>无论回调注册和状态变更的顺序如何，都能保证回调正确执行</strong></li>
</ul>
<h5 data-id="heading-54">3. 多订阅支持</h5>
<p><strong>多订阅</strong>支持允许<strong>多个回调函数</strong>订阅同<strong>一个Promise的状态</strong>变更。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在constructor中使用数组存储回调</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []

<span class="hljs-comment">// resolve函数中执行所有注册的回调</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
</code></pre>
<ul>
<li>使用数组存储回调函数，而不是单一函数</li>
<li>每个Promise实例可以<strong>多次调用then方法</strong>，<strong>每次调用都会将回调添加到数组中</strong></li>
<li>状态变更时，<strong>所有注册的回调会按添加顺序依次执行</strong></li>
<li>这使得多个独立的操作可以基于同一个Promise的结果进行联动</li>
</ul>
<h5 data-id="heading-55">4. 异步协调</h5>
<p>异步协调<strong>通过setTimeout确保回调异步执行，解决了异步操作和回调执行的时序问题</strong>。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在then方法的三种状态处理中都使用了setTimeout</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">reject</span>(error)
  }
}, <span class="hljs-number">0</span>)
</code></pre>
<ul>
<li>使用setTimeout模拟微任务，确保回调在当前执行栈清空后执行</li>
<li>无论Promise状态是同步还是异步变更，回调总是异步执行</li>
<li>解决了回调地狱问题，提供了清晰的异步操作流程控制</li>
<li>确保即使在同步操作完成后，回调也会按预期顺序异步执行</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# vue2 使用 cesium 展示 TLE 星历数据]]></title>    <link>https://juejin.cn/post/7571815997068197928</link>    <guid>https://juejin.cn/post/7571815997068197928</guid>    <pubDate>2025-11-13T10:47:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068197928" data-draft-id="7572020278386769954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# vue2 使用 cesium 展示 TLE 星历数据"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T10:47:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叫我AddV"/> <meta itemprop="url" content="https://juejin.cn/user/4860749051150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # vue2 使用 cesium 展示 TLE 星历数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4860749051150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叫我AddV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:47:54.000Z" title="Thu Nov 13 2025 10:47:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue2 使用 cesium 展示 TLE 星历数据</h2>
<blockquote>
<p>为啥突然写这么一篇文章呢，是因为我现在对 cesium 也是了解一些，在做一个项目的时候用到了，发现里面的东西还很多，稍微说一下。</p>
</blockquote>
<h3 data-id="heading-1">环境准备</h3>
<h4 data-id="heading-2">1. cesium包</h4>
<p>项目中需要引入 <code>cesium</code> 包，我不是使用 <code>npm</code> 安装的，我是直接在官网下载的 <code>cesium 包</code>。下载完成后把包放进项目中使用的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80457a1e887047058f8acc3b053d070a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=ZJmy8ET3vsRp3xRrAeauNPzsenU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后引入的话，只需要在 index.html 中引入一下就可以了。</p>
<p>在 <code>&lt;head&gt;</code> 标签里面放：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"./Cesium/Widgets/widgets.css"</span>&gt;</span>
</code></pre>
<p>在 <code>&lt;body&gt;</code> 标签最后面放：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./Cesium/Cesium.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>然后就完事了。cesium 也算引入成功了。</p>
<p>如果不放心的话，可以运行起 <code>vue</code> 项目，在控制台输入命令查看一下引入的 <code>Cesium</code> 版本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VERSION</span>);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e9c07e3235a4de99465ade78bfc32b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=EBSPGsdCJBPzUL5WXCi8VT34mDE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-3">2. satellite.js</h4>
<p>这个的话我就是使用 <code>npm</code> 安装的了，我安装的 <code>5.0</code> 版本以上的，最好是<code>5</code>这个版本往上，不要装<code>4</code>，API可能会有差异。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab54b02e801f48ffaa574fa7523e01c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=rWoh4OrThM3C3w7toDIq3gSDGVg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4">3. 其他</h4>
<p>其他的话就是 <code>moment</code>，用来转换时间啥的，这个直接安装就行，想用就用，不想用就用 <code>Date()</code> 转，都可以。</p>
<h3 data-id="heading-5">Cesium 开发</h3>
<p>首先我们创建一个 <code>TCesium.js</code> 文件，用来编写 Cesium 相关的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aee20f57802649dba543a0edaadd3947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=rzwPUYTHrHb7FL4WAiK4wnqYfsc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当然，案例嘛，我文件随便创建了，但是正经开发的话需要做好目录规划。</p>
<h4 data-id="heading-6">初始化蓝星（地球）</h4>
<p>首先我也不知道为啥把地球叫蓝星，很多人把地球称作蓝星，我也就这样叫吧。</p>
<h5 data-id="heading-7">1. 创建 TCesium 类</h5>
<p>首先创建一个TCesium 类，在构造函数里面初始化蓝星。我尽可能把注释写的详细一些</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TCesium</span> {

  dom = <span class="hljs-literal">null</span>,  <span class="hljs-comment">// dom节点对象</span>
  scene = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 当前场景</span>
  viewer = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 当前地图对象</span>
  trackEntities = {} <span class="hljs-comment">// 卫星对象</span>
  totalTime = <span class="hljs-number">24</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>   <span class="hljs-comment">// 仿真总时长，默认一天， 单位秒</span>
  timeInterval = <span class="hljs-number">60</span>  <span class="hljs-comment">// 采样间隔，单位秒</span>
  satelliteDataSource = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 卫星数据源</span>

	<span class="hljs-comment">// 接收一个dom，就是用来渲染蓝星的Dom</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">dom</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dom</span> = dom;  <span class="hljs-comment">// 把穿进的dom节点赋值给全局</span>
    <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'这个地方需要填写自己在官网申请的Token值'</span>;   <span class="hljs-comment">// 设置 Token，需要从官网自己申请</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(dom, {
      <span class="hljs-attr">homeButton</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 显示主页按钮</span>
      <span class="hljs-attr">sceneModePicker</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 是否显示切换2D/3D按钮</span>
      <span class="hljs-attr">baseLayerPicker</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 图层切换按钮</span>
      <span class="hljs-attr">animation</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 动画，需要开启</span>
      <span class="hljs-attr">infoBox</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 信息框显示</span>
      <span class="hljs-attr">selectionIndicator</span>: <span class="hljs-literal">false</span>, 
      <span class="hljs-attr">geocoder</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">timeline</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 时间轴，要开启的啊</span>
      <span class="hljs-attr">fullscreenButton</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">shouldAnimate</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">navigationHelpButton</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">terrainProvider</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CesiumTerrainProvider</span>({   <span class="hljs-comment">// 基础地形数据</span>
        <span class="hljs-attr">url</span>: <span class="hljs-string">'https://www.supermapol.com/realspace/services/3D-stk_terrain/rest/realspace/datas/info/data/path'</span>,
        <span class="hljs-attr">requestVertexNormals</span>: <span class="hljs-literal">true</span>
      }),
    })
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">postProcessStages</span>.<span class="hljs-property">fxaa</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>   <span class="hljs-comment">// 开启抗锯齿优化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">sun</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// 不显示太阳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">moon</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// 不显示月亮</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">skyBox</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 不显示星空</span>
  }
}
</code></pre>
<p>然后蓝星初始化完成了就，我们需要在使用蓝星的组件编写一下基础结构引入一下就可以了。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ed-earth-model"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"earthModel"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"earthModel"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TCesium</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./TCesium"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Home"</span>,

  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">cesium</span>: <span class="hljs-literal">null</span>
    }
  },

  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initMap</span>();  <span class="hljs-comment">// 初始化地图</span>
    })
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">initMap</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cesium</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cesium</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCesium</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">earthModel</span>);
      }
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.app</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-class">.ed-earth-model</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>编写完上面的代码就可以看到蓝星初始化完成了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/313b16840b9442a9ae215bd83f7bbd39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=bmmWu21e9McdpNLxAVtkZeF1CA4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>非常好！完美~</p>
<h5 data-id="heading-8">2. 初始化数据</h5>
<p>我们写一个方法用来初始化数据，加载TLE星历数据的话，我们可以从网上找一些星历数据，或者客户提供星历数据，他们提供的星历数据一般是这个格式的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d6724c90844d298f0ef41453f19578~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=st8l5Ew772SY65C2NSIDHv%2BtXQE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>每个卫星的星历包含<code>三行</code>，然后如果有多个的话就往下排，这个星历文件就是简单的 <code>txt</code> 文件。</p>
<p>然后我们需要把这个星历文件转换成JSON对象的形式，就像下面：</p>
<pre><code class="hljs language-josn" lang="josn">{
  "name": "STARLINK-2589",
  "tle1": "1 48371U 21038U   25270.54822457  .00018630  00000+0  12665-2 0  9999",
  "tle2": "2 48371  53.0562   3.9906 0001373 107.0633 253.0506 15.06394038242577"
},
</code></pre>
<p>这个可以写个<code>JS函数</code>进行转换，我写了，但是我不想浪费时间贴了，这个不是重点，到时候你们需要的话直接自己写一个就行了。</p>
<p>星历数据自己去找就行，我上面的都不一定准确了，可以去网站上去复制，很多网站可以查看全球登记在册的卫星，都可以复制星历数据，要保证星历数据的准确性哈，出一点问题都不行，星历数据有了的话，然后我们就可以在地球展示轨道了。</p>
<p>但是有一点需要说一下，就是这个星历啊，他是有<code>时效性</code>的，一般时效性就是7天到14天左右，太久了的话不是不能用，而是不准确了，卫星的位置可能天差地别了。</p>
<h5 data-id="heading-9">3. 卫星仿真</h5>
<p>首先仿真这个就是看卫星在某一时间的运行轨迹嘛，我们写一个方法，然后来处理这个逻辑。</p>
<p>首先仿真时间可以是<code>自定义仿真时间</code>，也可以是<code>使用当前时间</code>开始仿真。</p>
<p>比如根据提供的星历数据，看一下 <code>2025-10-10 12:00:00</code>  到 <code>2025-10-10 15:00:00</code> 这三个小时的卫星轨迹。或者是看一下现在时间到未来两个小时内的卫星运行轨迹。</p>
<p><strong>准备数据</strong></p>
<p>我先贴代码，然后一点一点解释哈：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-title function_">addTle</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> tleData = [   <span class="hljs-comment">// 星历数据</span>
      {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"STARLINK-2589"</span>,
        <span class="hljs-string">"tle1"</span>: <span class="hljs-string">"1 48371U 21038U   25270.54822457  .00018630  00000+0  12665-2 0  9999"</span>,
        <span class="hljs-string">"tle2"</span>: <span class="hljs-string">"2 48371  53.0562   3.9906 0001373 107.0633 253.0506 15.06394038242577"</span>
      }
    ]
    <span class="hljs-keyword">let</span> startTime = <span class="hljs-string">"2025-11-11 08:00:00"</span>;  <span class="hljs-comment">// 东八区时间，也就是北京时间</span>
    <span class="hljs-keyword">let</span> endTime = <span class="hljs-string">"2025-11-11 12:00:00"</span>;  <span class="hljs-comment">// 东八区时间，也就是北京时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTleFile</span>(tleData, <span class="hljs-literal">true</span>, startTime, endTime);  <span class="hljs-comment">// 调用加载TLE数据的函数</span>
  }
</code></pre>
<p>这个函数就是准备了一下星历数据，当然我这里写死了，到时候项目肯定后端返回了。</p>
<p>然后创建了<code>startTime</code>  和 <code>endTime</code> ，表示仿真这个时间段的卫星轨迹。</p>
<p>然后就是去走<code>loadTleFile()</code>函数。</p>
<p><strong>加载TLE数据函数</strong></p>
<p>我先写代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 加载星历文件，实现卫星轨迹显示</span>
  <span class="hljs-title function_">loadTleFile</span>(<span class="hljs-params">tleData, showPath = <span class="hljs-literal">false</span>, startTime = <span class="hljs-literal">null</span>, endTime = <span class="hljs-literal">null</span></span>) {
    <span class="hljs-keyword">let</span> start = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">let</span> stop = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">if</span> (startTime &amp;&amp; endTime) { <span class="hljs-comment">// 假设提供了开始时间和结束时间</span>
      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(startTime));
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(endTime));
    } <span class="hljs-keyword">else</span> {  <span class="hljs-comment">// 如果没有传时间默认从系统当前时间往后一天的仿真时间</span>
      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromIso8601</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>());
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">secondsDifference</span>(stop, start);  <span class="hljs-comment">// 计算开始时间和结束时间的时间差 单位秒</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">startTime</span> = start.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 给cesium时间轴设置开始的时间，也就是上边的东八区时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">stopTime</span> = stop.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 设置cesium时间轴设置结束的时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">currentTime</span> = start.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 设置cesium时间轴设置当前的时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">clockRange</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ClockRange</span>.<span class="hljs-property">LOOP_STOP</span> <span class="hljs-comment">// 时间结束了，再继续重复来一遍</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">multiplier</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 时间轴倍速，1是正常速度，2是两倍速，0.5是半速</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">clockStep</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ClockStep</span>.<span class="hljs-property">SYSTEM_CLOCK_MULTIPLIER</span> <span class="hljs-comment">// 时间轴步长，SYSTEM_CLOCK_MULTIPLIER是根据系统时间步长来更新时间轴，其他选项还有TICK_DEPENDENT和SYSTEM_CLOCK</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">timeline</span>.<span class="hljs-title function_">updateFromClock</span>();  <span class="hljs-comment">// 强制更新时间轴</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">timeline</span>.<span class="hljs-title function_">zoomTo</span>(start.<span class="hljs-title function_">clone</span>(), stop.<span class="hljs-title function_">clone</span>());  <span class="hljs-comment">// 设置时间轴显示区间</span>

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>) {  <span class="hljs-comment">// 判断卫星数据源是不是空（可以不用，视情况而定，写一下是知道可以这样用）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CustomDataSource</span>(<span class="hljs-string">'satellite'</span>)  <span class="hljs-comment">// 是空则创建一个数据源</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">dataSources</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>)  <span class="hljs-comment">// 把数据源添加到viewer，后期卫星全部添加到卫星数据源</span>
    }
    <span class="hljs-comment">// 分批处理卫星数据，避免一次性处理所有卫星导致页面卡住</span>
    <span class="hljs-keyword">let</span> sss = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(tleData))
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_loadSatellitesInBatches</span>(sss, start, stop, <span class="hljs-number">10</span>, showPath) <span class="hljs-comment">// 每批加载10个卫星</span>
  }
</code></pre>
<p>首先<code>loadTleFile()</code>函数接收四个参数，分别是<code>星历数据列表</code>、<code>是否显示卫星轨迹线</code>、<code>仿真开始北京时间</code>、<code>仿真结束北京时间</code>。</p>
<p>里面主要做了啥呢？主要就是<code>设置时间轴</code>，让<code>Cesium</code>界面上的时间轴显示成我们设置的<code>仿真时间段</code>。</p>
<p>这里有一问题需要特别注意一下哈，那就是时间问题。我们传入的<code>开始时间和结束时间是北京时间</code>，也就是<code>东八区</code>的时间。但是！Cesium时间轴设置的时间需要是<code>UTC时间</code>。</p>
<p><code>UTC 时间</code>（Coordinated Universal Time，<code>协调世界时</code>）是全球通用的标准时间，被世界各地用作时间基准，其核心特点是统一、无时区偏移、基于原子时和地球自转校准。</p>
<p>所以说我们设置时间轴的时候需要<code>把北京时间转换成UTC时间</code>。</p>
<p>我们使用了<code>beijingTimeToDate()</code>函数：</p>
<pre><code class="hljs language-js" lang="js">      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(startTime));
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(endTime));
</code></pre>
<p><code>beijingTimeToDate()</code>函数可以把北京时间字符串转成Date类型的对象，然后通过<code>Cesium.JulianDate.fromDate()</code>函数可以转成UTC时间。</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 北京时间字符串转换为Date对象</span>
  <span class="hljs-title function_">beijingTimeToDate</span>(<span class="hljs-params">beijingTimeString</span>) {
    <span class="hljs-keyword">const</span> isoString = beijingTimeString.<span class="hljs-title function_">replace</span>(<span class="hljs-string">' '</span>, <span class="hljs-string">'T'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(isoString);
  }
</code></pre>
<p>解释一下，其实<code>北京时间和UTC时间</code>就<code>差了八小时</code>，也就是说<code>北京时间比UTC时间多八小时</code>。比如<code>北京时间2025-11-11 08:00:00</code> 对应的<code>UTC时间就是 2025-11-11 00:00:00</code>。</p>
<p>在后面就是设置时间轴了，更新时间轴，这样的话，我们时间轴就设置成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d90c92999b441aba7f4deb7f1d7f1bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=d3niq0IzQfPEcVdpNcBbYX42Cy0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>设置成功就调用了 <code>_loadSatellitesInBatches()</code> 函数分批处理星历数据了。</p>
<h5 data-id="heading-10">_loadSatellitesInBatches()函数 分批处理星历数据</h5>
<p>贴这个函数完整代码，后面解释：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 分批加载卫星数据 </span>
  <span class="hljs-title function_">_loadSatellitesInBatches</span>(<span class="hljs-params">satellites, start, stop, batchSize, showPath</span>) {
    <span class="hljs-keyword">const</span> batches = [];
    <span class="hljs-comment">// 将卫星数据分成多个批次</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; satellites.<span class="hljs-property">length</span>; i += batchSize) {
      batches.<span class="hljs-title function_">push</span>(satellites.<span class="hljs-title function_">slice</span>(i, i + batchSize));
    }
    <span class="hljs-comment">// 递归处理每个批次</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">processBatch</span> = (<span class="hljs-params">batchIndex</span>) =&gt; {
      <span class="hljs-keyword">if</span> (batchIndex &gt;= batches.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 所有批次处理完毕</span>
      }
      <span class="hljs-comment">// 处理当前批次</span>
      <span class="hljs-keyword">const</span> currentBatch = batches[batchIndex];
      currentBatch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">satellite</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_addSatelliteEntity</span>(satellite, start, stop, showPath);
      });
      <span class="hljs-comment">// 在下一帧处理下一批次，避免阻塞主线程</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">processBatch</span>(batchIndex + <span class="hljs-number">1</span>);
      });
    };
    <span class="hljs-comment">// 开始处理第一批</span>
    <span class="hljs-title function_">processBatch</span>(<span class="hljs-number">0</span>);
  }
</code></pre>
<p>为啥要分批处理哈，其实单纯案例的话不需要，分批是怕卫星星历很多，比如上百颗卫星，或者是上千颗卫星，最好分批。</p>
<p>因为后面需要对每颗卫星的星历进行处理，获取每颗卫星不同时间段的位置，比如1000颗卫星，每颗卫星取1000个位置，这个遍历时间是有点儿久的，如果不分批的话，Cesium展示的进程会被卡死，页面整个操作不了了，但是案例就一颗卫星，不需要分批，但是做分批处理是没坏处的，有备无患。</p>
<p><code>_loadSatellitesInBatches()</code>函数接收五个参数，分别是<code>星历列表</code>、<code>开始UTC时间</code>、<code>结束UTC时间</code>、<code>每批个数</code>、<code>是否显示轨迹线</code>。</p>
<p>这个函数没啥好说的，看看就懂，跟Cesium没啥关系，就是分批加载，一帧加载十颗卫星。</p>
<p>每一帧遍历这一批次的卫星星历，执行一个<code>this._addsatelliteEntity(satellite, start, stop, showPath);</code> 函数，这个函数才是真正的处理星历的函数。</p>
<h5 data-id="heading-11">_addSatelliteEntity 处理星历函数</h5>
<p>首先还是贴代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 添加单个卫星实体</span>
  <span class="hljs-title function_">_addSatelliteEntity</span>(<span class="hljs-params">satellite, start, stop, showPath</span>) {
    <span class="hljs-comment">// 创建临时对象存储当前卫星信息，避免修改this对象</span>
    <span class="hljs-keyword">const</span> satelliteInfo = {
      <span class="hljs-attr">name</span>: satellite.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">tleLine1</span>: satellite.<span class="hljs-property">tle1</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">tleLine2</span>: satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">satrec</span>: <span class="hljs-title function_">twoline2satrec</span>(satellite.<span class="hljs-property">tle1</span>.<span class="hljs-title function_">trim</span>(), satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">trim</span>()),
      <span class="hljs-attr">leadTime</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">24</span> * <span class="hljs-number">3600</span> / satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">52</span>, <span class="hljs-number">64</span>))
    };

    <span class="hljs-comment">// 创建卫星实体</span>
    <span class="hljs-keyword">let</span> cesiumSateEntity = {
      <span class="hljs-attr">id</span>: satellite.<span class="hljs-property">noradId</span> || satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 设置卫星对象的ID</span>
      <span class="hljs-attr">name</span>: satellite.<span class="hljs-property">name</span>, <span class="hljs-comment">// 设置卫星的名称</span>
      <span class="hljs-attr">description</span>: satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 设置描述</span>
      <span class="hljs-comment">// 使用专用函数计算位置，传入卫星信息</span>
      <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getSatellitePositionProperty</span>(start, satelliteInfo),
      <span class="hljs-attr">point</span>: {  <span class="hljs-comment">// 卫星用点表示</span>
        <span class="hljs-attr">pixelSize</span>: <span class="hljs-number">10</span>,  <span class="hljs-comment">// 卫星点十个像素</span>
        <span class="hljs-attr">color</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">WHITE</span>,  <span class="hljs-comment">// 卫星点是白色的</span>
      },
      <span class="hljs-attr">path</span>: {  <span class="hljs-comment">// 卫星轨迹线设置</span>
        <span class="hljs-attr">width</span>: <span class="hljs-number">0.5</span>,   <span class="hljs-comment">// 轨迹线的宽度，单位是像素</span>
        <span class="hljs-attr">leadTime</span>: satelliteInfo.<span class="hljs-property">leadTime</span>,  <span class="hljs-comment">//  轨迹线 “前瞻时间”，即显示卫星从当前时间开始，未来一段时间内的预测轨迹长度，这里设置的就是卫星运行一圈的时间，也就是显示未来一圈的轨迹</span>
        <span class="hljs-attr">trailTime</span>: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 轨迹线 “回溯时间”，即显示卫星从过去一段时间到当前时间的轨迹长度，设置为 0 表示不显示卫星过去的轨迹，只展示未来的预测轨迹</span>
        <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">YELLOW</span>,  <span class="hljs-comment">// 线是黄色的</span>
        <span class="hljs-attr">show</span>: showPath === <span class="hljs-literal">true</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认隐藏轨迹</span>
        <span class="hljs-attr">clampToGround</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 轨迹线是否 “贴地”，卫星在天上飞，轨迹就不要贴地了哈</span>
      },
      <span class="hljs-attr">label</span>: {  <span class="hljs-comment">// 卫星的label展示配置</span>
        <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 是否显示</span>
        <span class="hljs-attr">text</span>: satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 显示的内容</span>
        <span class="hljs-attr">font</span>: <span class="hljs-string">'12px sans-serif'</span>,   <span class="hljs-comment">// 字体设置</span>
        <span class="hljs-attr">fillColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">WHITE</span>,   <span class="hljs-comment">// 填充颜色白色</span>
        <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLACK</span>,  <span class="hljs-comment">// 边框颜色黑色</span>
        <span class="hljs-attr">outlineWidth</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment">// 边框宽度2像素</span>
        <span class="hljs-attr">pixelOffset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian2</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>),  <span class="hljs-comment">// 偏移量</span>
      }
    };
    <span class="hljs-comment">// 添加卫星实体</span>
    <span class="hljs-keyword">let</span> satelliteEntity = <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Entity</span>(cesiumSateEntity));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackEntities</span>[satelliteEntity.<span class="hljs-property">id</span>] = satelliteEntity;
  }
</code></pre>
<p>首先这个函数接收四个参数：<code>单颗卫星星历数据</code>、<code>仿真开始UTC时间</code>、<code>仿真结束UTC时间</code>、<code>是否显示卫星轨迹线</code>。</p>
<p>函数第一步是对卫星 TLE 数据的结构化封装：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a378b82107f04b76b57ac0ece70c6f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=OZLgkD8OeNzPcTutwxp5J6QjmjI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>因为传进来的<code>satellite</code>其实就是单个卫星数据，就是这个：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92ddf144feef4d61bfc3f8fae35f7d75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=i3u28ggCluKI4RvgtFPGnw%2BqOuE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>所以<code>satelliteInfo</code> 前三个值不解释了。</p>
<p>然后第三个字段，<code>satrec: twoline2satrec(satellite.tle1.trim(), satellite.tle2.trim())</code> 是通过 <code>twoline2satrec</code> 方法（通常来自 satellite.js 库）解析 TLE 数据后得到的 <code>卫星轨道模型对象（satrec）</code>。<code>satrec</code> 包含了 <code>SGP4 轨道</code>计算所需的所有参数（如半长轴、倾角、历元时间等），是后续调用 <code>propagate</code> 方法计算卫星实时位置（<code>ECI 坐标</code>）的核心输入。</p>
<p><code>twoline2satrec</code>  方法是<code>satellite.js</code> 库里面的，需要在顶部引入一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { twoline2satrec, propagate, gstime, eciToGeodetic, degreesLong } <span class="hljs-keyword">from</span> <span class="hljs-string">'satellite.js'</span>
</code></pre>
<p>这几个都是后面用到的，全写上吧。</p>
<p>第四个字段，<code>leadTime: parseInt(24 * 3600 / satellite.tle2.slice(52, 64))</code>  用来计算卫星的轨道周期，单位是秒，表示卫星绕地球一周所需的时间。</p>
<p>这个<code>satelliteInfo</code> 对象解释完了，后面可能用到里面的字段，注意知道每个字段的含义就行。</p>
<p>在后面就是创建一个卫星实体<code>cesiumSateEntity</code>，代码注释的很清楚了，再就是把卫星实体对象添加到卫星数据源里面，其中添加到卫星数据源之后会返回这个卫星实体对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 将卫星添加到卫星数据源</span>
<span class="hljs-keyword">let</span> satelliteEntity = <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Entity</span>(cesiumSateEntity));
</code></pre>
<p>他会返回一个<code>satelliteEntity </code>，你可以通过修改satelliteEntity 的内容，页面上的卫星状态也会跟着改变，比如颜色、是否显示轨迹、是否可见啥的，也可以获取他的信息，比如经度、纬度啥的。所以后边在对象里面存储了一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">trackEntities</span>[satelliteEntity.<span class="hljs-property">id</span>] = satelliteEntity; <span class="hljs-comment">// 存储卫星实体</span>
</code></pre>
<p>主要说的是啥呢！是创建卫星实体对象的时候设置位置调用了一个专用的计算函数：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 使用专用函数计算位置，传入卫星信息</span>
  <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getSatellitePositionProperty</span>(start, satelliteInfo),
</code></pre>
<p>调用的<code>_getSatellitePositionProperty</code>函数才是关键，他用来计算这个卫星在这个仿真时间段的位置信息！</p>
<h5 data-id="heading-12">卫星位置计算</h5>
<p>还是哈，先贴代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 为单个卫星计算位置属性</span>
  <span class="hljs-title function_">_getSatellitePositionProperty</span>(<span class="hljs-params">start, satelliteInfo</span>) {
    <span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
    <span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
    <span class="hljs-comment">// 这样可以在保持轨迹连续性的同时大幅提高性能</span>
    <span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>; <span class="hljs-comment">// timeInterval 秒钟一个采样点（秒）</span>
    <span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) {  <span class="hljs-comment">// 遍历每个采样点</span>
      <span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
      <span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
      <span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
        <span class="hljs-keyword">continue</span>
      }
      <span class="hljs-keyword">let</span> gsmt = <span class="hljs-title function_">gstime</span>(currentTime)  <span class="hljs-comment">// 计算当前时间的 GST 时间</span>
      <span class="hljs-keyword">let</span> efgd = <span class="hljs-title function_">eciToGeodetic</span>(sateCoord, gsmt)  <span class="hljs-comment">//  将 ECI 坐标转换为大地坐标</span>
      <span class="hljs-keyword">let</span> lon = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">longitude</span>)  <span class="hljs-comment">// 将大地坐标转换为度</span>
      <span class="hljs-keyword">let</span> lat = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">latitude</span>)  <span class="hljs-comment">//  将大地坐标转换为度</span>
      <span class="hljs-keyword">let</span> height = efgd.<span class="hljs-property">height</span>  <span class="hljs-comment">//  高度</span>
      <span class="hljs-keyword">let</span> stkWorldPoint = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lon, lat, height * <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 将大地坐标转换为 STK 世界坐标</span>
      <span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
      positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, stkWorldPoint);
    }
    <span class="hljs-keyword">return</span> positionProperty;
  }
</code></pre>
<p>这个函数 <code>_getSatellitePositionProperty</code> 是用于在 <code>Cesium</code> 中生成<code>单个卫星的时间序列位置属性</code>（SampledPositionProperty），核心功能是通过轨道计算获取卫星在一段时间内的连续位置，并将其转换为 Cesium 可识别的坐标格式，最终用于绘制卫星轨迹或动态展示卫星运动。</p>
<p>整体逻辑是：函数从指定的起始时间 <code>start</code> 开始，按固定时间间隔采样，计算卫星在每个采样时刻的空间位置，将这些 <code>“时间 - 位置” 对</code>整合为 SampledPositionProperty 对象（Cesium 中用于描述随时间变化的位置的专用属性），供<code>卫星实体绑定轨迹或动态更新位置</code>使用。</p>
<p>对这个函数重点解释一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
</code></pre>
<p>这行代码是用来<code>初始化位置属性</code>，创建 <code>SampledPositionProperty</code> 实例，用于存储 <code>“时间点 - 位置”</code> 的映射关系，是 Cesium 中描述动态位置的核心对象（支持插值计算，使轨迹平滑）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
</code></pre>
<p>baseTime 是用来做基准时间的。就是仿真开始时间，这里转换成了时间戳。将 Cesium 的 JulianDate 格式起始时间（start）转换为 JavaScript 时间戳（毫秒级），方便后续计算采样时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>; <span class="hljs-comment">// timeInterval 秒钟一个采样点（秒）</span>
<span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
</code></pre>
<p>上面这两行主要用来<code>设置采样参数</code>。 <code>sampleInterval</code>是每次采样的时间间隔（单位：秒），控制轨迹的精度（间隔越小，轨迹越精细，但性能消耗越高）；<code>totalSamples</code>是根据总时长（this.totalTime）和间隔计算需要的采样点数量，确保覆盖整个时间段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) { ... }
</code></pre>
<p><code>for循环</code>的话，就是为了遍历每个采样点，计算对应时间的卫星位置。</p>
<p>然后是<code>for循环</code>里面的逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
<span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
</code></pre>
<p>currentTime  这个是啥呢，就是获取<code>第 i 个采样点的时间</code>，即：<code>基准时间 + 第 i 个取样点 * 取样间隔时间(s) * 1000</code>，也就是基于起始时间戳，累加 <code>i * 采样间隔</code>（毫秒），得到当前采样点的 <code>UTC 时间</code>（Date 对象）。</p>
<p><code>sateCoord</code> 是调用 <code>propagate</code> 方法，根据卫星的 <code>satrec</code> 轨道模型和当前时间，计算卫星在<code>惯性坐标系（ECI） 中的位置</code>（x, y, z，单位通常为千米）。</p>
<p>可以理解通过这两行代码，最后获得了这个<code>在某个时间点</code>下，该卫星在<code>惯性坐标</code>系下的位置信息。</p>
<p>继续：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
  <span class="hljs-keyword">continue</span>
}
</code></pre>
<p>上面这个判断是为了过滤无效位置，若轨道计算失败（返回 NaN 或 undefined），跳过当前采样点，避免错误数据影响轨迹。</p>
<p>再往下就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> gsmt = <span class="hljs-title function_">gstime</span>(currentTime); <span class="hljs-comment">// 计算当前时间的格林尼治恒星时（GST）</span>
<span class="hljs-keyword">let</span> efgd = <span class="hljs-title function_">eciToGeodetic</span>(sateCoord, gsmt); <span class="hljs-comment">// ECI 转大地坐标</span>
</code></pre>
<p><code>gstime(currentTime)</code>是用来计算当前时间的格林尼治恒星时（用于 ECI 到地固坐标的转换，消除地球自转影响）。
<code>eciToGeodetic</code>是将惯性系（ECI）坐标转换为大地坐标（经度、纬度、高度，基于 WGS84 椭球），即<code>卫星在地面观测者眼中的位置</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> lon = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">longitude</span>); <span class="hljs-comment">// 经度（弧度→度）</span>
<span class="hljs-keyword">let</span> lat = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">latitude</span>);  <span class="hljs-comment">// 纬度（弧度→度）</span>
<span class="hljs-keyword">let</span> height = efgd.<span class="hljs-property">height</span>;              <span class="hljs-comment">// 高度（千米）</span>
</code></pre>
<p>上面是将<code>大地坐标单位转换</code>，将<code>经纬度从弧度转换为度</code>（Cesium 常用单位），保留高度值（后续需转换为米）。</p>
<p>再往下是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> stkWorldPoint = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lon, lat, height * <span class="hljs-number">1000</span>);
</code></pre>
<p>讲位置信息转换为 Cesium 世界坐标。<code>Cesium.Cartesian3.fromDegrees</code>作用是将经纬度（度）和高度（米，因此 ×1000 转换千米→米）转换为 Cesium 的<code>地固坐标系</code>（ECEF） 坐标（Cartesian3 对象），即三维世界中的位置。</p>
<p>最后了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, stkWorldPoint);
</code></pre>
<p>绑定时间与位置，计算当前<code>采样点对应的 Cesium 时间</code>（JulianDate 格式），将 <code>“时间 - 位置” 对</code>添加到 <code>positionProperty</code> 中，完成一个采样点的记录。</p>
<p>最终返回包含所有采样点的 <code>SampledPositionProperty</code> 对象，<code>可直接绑定到 Cesium 的卫星实体（Entity）上，用于动态展示卫星轨迹和位置</code>。</p>
<p>所以这个函数是卫星轨迹可视化的核心逻辑，通过 <code>“时间采样→轨道计算→坐标转换→绑定属性”</code> 的流程，将卫星的轨道参数（TLE）转换为 Cesium 可渲染的动态位置数据。</p>
<p>然后就可以看一下页面效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6a801aa43ee44ffbbfa69a8280861c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=ZARLXaZRG%2Bgjg014nwjAvzI0IgE%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d8676ea90f4496a4fede4a90a6e147~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=Cjgi1JyXoX%2BVSqu5WqJOI5aTDkc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以看到卫星轨迹线已经加载出来了。</p>
<p>然后我们用第三方软件加载一下这个星历，看一下效果是不是一样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a63d17469e14dc181a969f2ad2b0a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=TGfb%2FkJO3yR%2BQTjS27UexbHyAlw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以看到我们绘制的轨迹线和第三方软件绘制的是一样的。这就完成了！</p>
<h5 data-id="heading-13">注意</h5>
<p>有一点需要注意。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f084c50505c4fc0bc8a1a931a042e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=C%2FjHodv3nRTXIaXradIt%2BA8F2q4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>就是我们看<code>3D</code>的效果，卫星轨迹线为什么转完一圈之后首尾<code>没有闭合</code>啊？感觉像是轨迹线跑偏了一样，他理论上围着地球绕圈，不应该是个正圆吗？为什么还是“丝带”状缠起来了？我看别人做的是正圆。</p>
<p>这是一个很好的问题！</p>
<p>因为我们在<code>_getSatellitePositionProperty</code>函数中，计算卫星采样位置的时候，最后转换成了<code>地固坐标系（ECEF）</code>。而之前那些正圆，可以实现首尾相连的使用的是<code>惯性坐标系（ECI）</code></p>
<p>看之前我们写的代码可以看出来，我们拿到<code>惯性坐标</code>后转成了<code>地固坐标</code>。</p>
<h5 data-id="heading-14">那么 惯性坐标 和 地固坐标 的区别是什么？</h5>
<p><code>惯性坐标（ECI）</code>和<code>地固坐标</code>都是用来描述卫星、航天器等空间物体位置的两种核心坐标系，核心<code>区别在于是否随地球自转</code>，适用场景也因此不同。</p>
<p><strong>惯性坐标</strong>：地面上的固定点（如北京）的坐标会随地球自转而持续变化（每天绕 Z 轴旋转一圈）；卫星的坐标变化仅由其自身轨道运动导致（如近地卫星沿椭圆轨道运动）。</p>
<p><strong>地固坐标</strong>：地面上的固定点（如北京）的坐标始终不变；卫星的坐标变化是其轨道运动与地球自转的 “<code>叠加效果</code>”（如卫星从西向东运动，同时地球也在自转）。</p>
<p><strong>ECI 是 “宇宙视角”：不随地球转，适合分析卫星的绝对轨道运动；
ECEF 是 “地球视角”：随地球转，适合描述物体相对于地面的位置。</strong></p>
<p>那这样的话什么时候使用<code>惯性坐标</code>，什么时候使用<code>地固坐标</code>呢？</p>
<p><code>惯性坐标适用于</code>：卫星<code>轨道力学分析</code>、<code>轨道设计</code>、<code>航天器导航</code>（需计算<code>绝对运动</code>）。卫星轨道预测（如用 TLE 计算 ECI 坐标）、星际航行轨道规划、天体力学仿真。</p>
<p><code>固地坐标适用于</code>：<code>地面观测</code>、<code>通信链路分析</code>、地图匹配（需描述<code>相对地球表面的位置</code>）。卫星地面覆盖范围计算、地面站与卫星的方位角 / 仰角计算、GPS 等导航系统定位。</p>
<h5 data-id="heading-15">获取惯性坐标位置展示</h5>
<p>那上面写了<code>固地坐标</code>展示的方式，下面写一下<code>惯性坐标</code>展示的方法，其实很简单，只需要修改<code>_getSatellitePositionProperty</code>函数：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 为单个卫星计算位置属性</span>
  <span class="hljs-title function_">_getSatellitePositionProperty</span>(<span class="hljs-params">start, satelliteInfo</span>) {
    <span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
    <span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
    <span class="hljs-comment">// 这样可以在保持轨迹连续性的同时大幅提高性能</span>
    <span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>;  <span class="hljs-comment">// 采样时间间隔（秒）</span>
    <span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) {  <span class="hljs-comment">// 遍历每个采样点</span>
      <span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
      <span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
      <span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
        <span class="hljs-keyword">continue</span>
      }
      <span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
      <span class="hljs-keyword">const</span> cesiumPosition = {
        <span class="hljs-attr">x</span>: sateCoord.<span class="hljs-property">x</span> * <span class="hljs-number">1000</span>,
        <span class="hljs-attr">y</span>: sateCoord.<span class="hljs-property">y</span> * <span class="hljs-number">1000</span>,
        <span class="hljs-attr">z</span>: sateCoord.<span class="hljs-property">z</span> * <span class="hljs-number">1000</span>
      }
      positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, cesiumPosition);
    }
    <span class="hljs-keyword">return</span> positionProperty;
  }
</code></pre>
<p>这就可以了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/610f5ce6290d4992a15e2841517d461f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=Kl0vye78GKPTB7qIY6w56kOgR14%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63343ab9d7346ed8acfa49226b8f06a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=sTKVWh7QU8ztqSYt8CzgMSGA4p8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这就是首尾相连的正圆了。</p>
<h3 data-id="heading-16">再说一点哈</h3>
<p>很多人可能觉得这个方式绘制星历太麻烦了，性能还不好，然后使用czml不是更好吗？我想说的是，在实际开发中会遇到各种离谱的事情，让人不得不放弃一些东西，毕竟选择的实现方式还是以实际开发后出结果为准，加油吧各位！希望对大家有用！</p>
<p>好了今天就先到这儿！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[边际成本趋近于零：如何让AI智能体"说得清、讲得明"]]></title>    <link>https://juejin.cn/post/7571815573933572159</link>    <guid>https://juejin.cn/post/7571815573933572159</guid>    <pubDate>2025-11-13T11:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815573933572159" data-draft-id="7571972751528640548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="边际成本趋近于零：如何让AI智能体&quot;说得清、讲得明&quot;"/> <meta itemprop="keywords" content="架构,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T11:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            边际成本趋近于零：如何让AI智能体"说得清、讲得明"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:01:52.000Z" title="Thu Nov 13 2025 11:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>人工智能的世界正以前所未有的速度向前疾驰。其中最令人瞩目的进展之一，是「生成式 AI 智能体」（Generative AI agents）的出现。</p>
<p>这些新一代的智能体，不再仅仅是生成文本、图像或代码的工具，而是能自主决策、独立行动的系统。它们正在扩展 AI 的边界，重新定义机器能做的事情。</p>
<p>本文将带你走进生成式智能体的世界，讨论它们的核心理念、实际应用，以及它们所带来的独特价值。当然，我们也无法忽视它们面临的种种挑战。</p>
<p>不过，在深入细节之前，我们先要打好基础。只有理解这些先进系统背后的基本原理，才能真正看懂它们如何改变产业格局，并开辟出新的可能性。</p>
<h2 data-id="heading-0"><strong>生成式人工智能的基本原理</strong></h2>
<h3 data-id="heading-1"><strong>生成模型</strong></h3>
<p>生成模型是人工智能“创造”能力的核心。常见的生成模型包括对抗生成网络（GAN）、变分自编码器（VAE），以及自回归模型（如 PixelRNN）。</p>
<p>要想真正理解生成式人工智能，就必须先理解这些模型。它们决定了一台机器能否像人一样去“想象”事物、生成内容。只有掌握了这套机制，我们才能构建出真正有用的生成式智能体（Generative AI Agent），让它们在不同任务中表现出创造性。</p>
<h3 data-id="heading-2"><strong>GPT 的出现</strong></h3>
<p>在理解了生成模型的基本概念之后，我们可以进一步看看最具影响力的一类模型——<strong>预训练生成式变换模型</strong>（Generative Pre-trained Transformer），简称<strong>GPT</strong>。</p>
<p>GPT 由 OpenAI 提出，它是一种能够根据提示自动生成自然语言文本的模型。简单说，你给它一句话，它就能续写一段像人写的内容。</p>
<p>这种模型如今被广泛应用在内容创作、客户服务等场景中。更有趣的是，GPT 还能“定制”——你可以为它设定具体行动、连接 API，让它去处理电子邮件、管理电商事务等。</p>
<p>从更高的层面看，GPT 不仅是一个语言模型，更是通往下一代智能系统的地基。基于它，我们可以构建出更复杂的“生成式智能体”：它们不仅能写字，还能做事——自主地完成任务、执行逻辑，成为广义上的“助手型智能”。</p>
<h2 data-id="heading-3">生成式人工智能的演进</h2>
<p>生成式人工智能这几年的变化，可以说是一部技术快速迭代的缩影。它从最初的文本生成，发展到如今能够自主执行任务的智能体，背后是持续的研究推动和技术创新。</p>
<p>早期的模型，比如 GPT-2，只是让我们第一次看到机器可以“写”出自然语言的可能性。</p>
<p>到了 GPT-3，这种能力被大幅提升。模型规模更大，理解语境的能力更强，生成的语言也更连贯，几乎可以在多数场景中模拟人的表达。</p>
<p>今天，生成式 AI 的最新阶段，是**自主智能体（Autonomous Agents）**的出现。它们不再只输出内容，而是能在一定范围内自主行动——规划、决策、执行，甚至与其他系统协作。</p>
<p>这意味着，AI 不仅能“说”，还开始“做”。它正在渗透到各个行业，帮助企业自动化复杂流程，提高效率，重塑生产方式。</p>
<p>如果说早期的生成模型只是“语言工具”，那么现在的智能体，更像是有一定目标意识的“数字劳动力”。未来，它们可能会成为数字世界的基础设施。</p>
<h2 data-id="heading-4"><strong>什么是生成式 AI 智能体？</strong></h2>
<p>我们先来理解一下「生成式 AI 智能体」这个概念。</p>
<p>它是一类比传统 AI 模型更高级的系统，把像 GPT 这样的生成式模型能力，与自主决策和执行功能结合在一起。简单来说，它不仅能“生成内容”，还可以“自主行动”。</p>
<p>生成式 AI 智能体能做的事情相当广泛，比如分析数据、制定决策、执行特定任务等。与以往只能输出文本或图像的生成模型不同，它具备完整的任务规划与执行能力：能自己设定目标、监控输出结果，并根据新的信息调整行动。这种独立运行的能力，让它在很多领域都非常有价值。</p>
<p>更具体一点，生成式 AI 智能体的特点在于：</p>
<p>它不只是生成输出，而是能基于输出进一步行动。它可以自动分析数据，做出判断，并根据分析结果采取下一步操作。</p>
<p>这种从「生成」到「执行」的一体化设计，使它能够完成复杂的工作流程——从最初的数据处理，到最后的任务落地，都能独立完成。</p>
<p>当生成能力与自主行动结合，生成式 AI 智能体就不仅仅是一种技术工具，而是一类具有潜在“智能协作者”特征的系统。它有望改变多个行业的工作方式——无论是医疗、金融，还是客户服务，都能因此变得更高效、更精准，也更具创造力。</p>
<p>理解这样的智能体，意味着理解下一代人工智能的方向——如何让机器不仅能“思考”，还能“行动”；不仅能“输出”，还能“完成”。这正是未来 AI 应用的关键所在。</p>
<h3 data-id="heading-5">提示生成与执行框架</h3>
<p>在打造高效 AI Agent 的过程中，能否妥善生成并执行 Prompt 至关重要。所谓提示生成与执行框架（Prompt Generation and Execution Framework），就是为此提供一条完整的工作流程：如何构建 Prompt、如何处理异常、以及如何通过反馈回路实现持续改进。它确保了 AI Agent 能够精准理解用户输入，并给出可靠回应。</p>
<p><strong>这个框架的主要步骤包括：</strong></p>
<ol>
<li>分析之前阶段的输出，明确当前所需信息。</li>
<li>按照既定格式构建 Prompt，确保逻辑清晰。</li>
<li>最终确定可执行的 Prompt，并投入执行。</li>
</ol>
<p>通过这套流程，AI Agent 能够在用户指定的指令下自主完成各类任务。从需求分析到最终执行，每一步都紧密衔接，让 AI 能不断学习、优化与成长。</p>
<h2 data-id="heading-6">生成式 AI 智能体是如何运作的？</h2>
<p>生成式 AI 智能体，是一种能够<strong>自主完成复杂任务</strong>的智能系统。它将「生成模型」（Generative Models）与「多智能体框架」（Multi-Agent Framework）结合在一起，从接收任务到产出结果，全过程几乎无需人工干预。</p>
<p>在执行过程中，它不仅能适应新的信息，还能根据用户的反馈不断修正输出。</p>
<p>可以把它想象成一个小型团队：有人负责计划、有人分析数据、有人检验结果，而背后都有一个“经理”在统筹全局。整个系统协同运行，形成自洽的智能工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b9c39974d9145ab8b14a9cc68a1f3e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763636511&amp;x-signature=pzNL5Y3zknyFkhquhoyW52nfd3Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">1、用户输入（User Prompt）</h3>
<p>一切从用户的一句话开始。</p>
<p>用户以自然语言提出需求，比如生成一份报告、分析某组数据，或者执行某个动作。</p>
<h3 data-id="heading-8">2、任务理解与执行（Interpretation &amp; Execution）</h3>
<p>AI 系统首先“理解”这条指令，然后制定一份完整的工作方案。</p>
<p>在这个过程中，有一个「经理智能体」（Manager Agent）负责协调全局，它会把任务拆解成多个子任务，分派给不同的「专家智能体」。</p>
<p>这些专家智能体通常包括：</p>
<ul>
<li><strong>分析智能体（Analyst Agent）</strong> ：从多种数据源收集、整理并分析信息；</li>
<li><strong>检验智能体（Checker Agent）</strong> ：负责核实数据的准确性，校对中间结果；</li>
<li><strong>规划智能体（Planner Agent）</strong> ：协调各个部分的流程，确保工作方向一致。</li>
</ul>
<p>这些 Agent 可以访问内部数据库或外部系统，取数、分析、整合，一步步构建完整的结果。</p>
<p>不同的智能体之间会交互信息，互相补充，确保整体协作顺畅无误。</p>
<h3 data-id="heading-9">3、初稿生成与共享（Draft Output Sharing）</h3>
<p>当所有子任务完成后，经理智能体会整合成果，生成初稿。</p>
<p>这个初稿是依据现有信息完成的“第一次尝试”，随后会提交给用户审阅。</p>
<h3 data-id="heading-10">4、反馈与迭代（Feedback &amp; Iteration）</h3>
<p>用户查看初稿，提出修改意见或新的需求。</p>
<p>系统再据此迭代更新，优化输出内容。</p>
<p>如此循环往复，直到结果满足用户预期。</p>
<p>这套循环机制，使得生成式 AI 智能体能在反馈中不断自我改进，越做越准、越做越好。</p>
<h2 data-id="heading-11"><strong>生成式 AI 智能体的应用</strong></h2>
<p>生成式 AI 的出现，使得“智能体”（Agent）这一概念正在迅速落地。不同于传统的自动化工具，AI 智能体更像是一个能够理解目标、主动行动、持续改进的“数字同事”。以下是它们在各个领域的典型应用场景。</p>
<h3 data-id="heading-12"><strong>1、客户服务</strong></h3>
<p>AI 智能体可以独立处理客户咨询，实现即时响应与自动化问题解决。</p>
<p>它的好处显而易见：既能减轻人工负担，又能提升客户体验。对企业而言，这意味着服务效率的提升；对用户而言，这意味着更迅速的帮助和更稳定的体验。</p>
<h3 data-id="heading-13"><strong>2、制造业</strong></h3>
<p>在数字化工厂中，AI 调度智能体可以模拟不同的生产场景，评估各种排产方案的成本、速度与交付稳定性。</p>
<p>通过这种方式，系统能自动找到兼顾效率与成本的最佳路径，实现生产线的动态优化：既能按时交付，又能减少切换损耗。</p>
<p>它不只是“反应式”的调度助理，更是一个能主动优化的运营伙伴。</p>
<h3 data-id="heading-14"><strong>3、内容生产与管理</strong></h3>
<p>在内容行业，AI 智能体已经成为新的创作伙伴。</p>
<p>它们可以生成文字、图片、视频内容，也能管理社交媒体账号，观察趋势数据，撰写吸引人的帖子，并自动安排发布时间。</p>
<p>过去需要整支团队完成的任务，如今一个智能体就能胜任。这让内容创作真正具备了“规模化”的可能。</p>
<h3 data-id="heading-15"><strong>4、医疗健康</strong></h3>
<p>在医疗领域，AI 智能体正从辅助医生的工具，逐渐演变为“数字医疗助手”。</p>
<p>它可以分析患者数据，辅助诊断病情，甚至根据个体差异制定个性化治疗方案。</p>
<p>更重要的是，它能提前识别潜在风险，给出预防性建议，从“治病”走向“防病”。</p>
<h3 data-id="heading-16"><strong>5、金融服务</strong></h3>
<p>在金融行业，AI 智能体被用于风险控制、欺诈检测与自动化交易。</p>
<p>它们能在实时数据流中识别异常模式，评估潜在风险，并执行决策。</p>
<p>相较传统模型，智能体的优势不仅在于速度，更在于“洞察”——通过持续学习，它们能不断优化投资策略，提升资产回报。</p>
<h2 data-id="heading-17"><strong>生成式 AI 智能体的优势</strong></h2>
<h3 data-id="heading-18"><strong>1、效率与生产力</strong></h3>
<p>生成式 AI 的最大价值在于“解放人力”。</p>
<p>那些重复、琐碎又耗时的流程，AI 可以自动完成，让人类有更多精力专注于策略、创造与决策。</p>
<p>结果是：组织的效率提升了，生产力也显著提高。无论是制造、金融还是服务业，几乎都能从中受益。</p>
<h3 data-id="heading-19"><strong>2、可扩展性</strong></h3>
<p>AI 智能体可以同时处理多项任务，并在工作量增加时保持运转，而无需相应增加人力和成本。</p>
<p>这种“边际成本趋近于零”的特性，使大型企业在扩张时具备了前所未有的灵活性。</p>
<p>过去扩张靠人，现在扩张靠算力。</p>
<h3 data-id="heading-20"><strong>3、准确与一致</strong></h3>
<p>人与人工作状态不同，而 AI 的表现却稳定且可重复。</p>
<p>在金融、医疗等高风险领域，AI 的高准确性与一致性尤为重要。</p>
<p>一个不会疲劳、不会分心、不会出错的“助手”，能极大提高决策的可靠性。</p>
<h3 data-id="heading-21"><strong>4、实时决策</strong></h3>
<p>AI 的强项在于“快速洞察”。</p>
<p>它能在海量数据流中实时分析并作出判断，从而支持即时决策。</p>
<p>在环境多变、竞争激烈的场景下——比如股市交易、供应链管理——这种即时响应能力往往就是成败关键。</p>
<h2 data-id="heading-22"><strong>生成式 AI 面临的挑战与风险</strong></h2>
<p>生成式 AI 的前景令人兴奋，但越是强大的技术，越需要谨慎使用。</p>
<p>它带来的问题，也必须正面面对。</p>
<h3 data-id="heading-23"><strong>1、数据隐私与安全</strong></h3>
<p>AI 智能体往往需要处理敏感数据。如何保护隐私、防止泄露，是第一要务。</p>
<p>企业必须建立完善的安全体系，确保数据不被滥用或非法访问。</p>
<p>一旦出现漏洞，后果不仅是技术问题，更是信任危机。</p>
<h3 data-id="heading-24"><strong>2、偏见与公平</strong></h3>
<p>AI 学习的是人类数据，而人类的数据本身就包含偏见。</p>
<p>如果不加纠正，AI 可能会“忠实”地放大这些偏差。</p>
<p>要让 AI 公平，就意味着在算法层面不断地校正与监督，确保不同群体都能被平等对待。</p>
<h3 data-id="heading-25"><strong>3、可解释性与透明度</strong></h3>
<p>很多 AI 系统像一个黑箱，连开发者有时也难以解释为什么它会做出某个决定。</p>
<p>要让社会信任 AI，我们需要更高的透明度。</p>
<p>简单来说，AI 必须“说得清、讲得明”，否则就难以承担关键领域的责任。</p>
<h2 data-id="heading-26"><strong>未来展望</strong></h2>
<p>生成式 AI 智能体的未来值得期待。</p>
<p>研究仍在快速推进，企业也不断加大投入，希望在新一轮智能化浪潮中占据优势。</p>
<p>正如**BCG（波士顿咨询集团）**在《GPT 只是开始，自治智能体正在到来》一文中指出的：</p>
<p>在未来几年，能够独立执行复杂任务的自治智能体将走向主流。</p>
<p>对企业来说，接下来的关键是<strong>提前布局</strong>：</p>
<ul>
<li>制定清晰的转型路线图，</li>
<li>投资基础设施与数字人才，</li>
<li>为自动化与智能化的融合做好准备。</li>
</ul>
<p>这场变革不会一夜之间发生，但正在悄然加速。</p>
<p>谁能理解趋势、拥抱技术，谁就能在下一轮竞争中占得先机。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果]]></title>    <link>https://juejin.cn/post/7571768210715820047</link>    <guid>https://juejin.cn/post/7571768210715820047</guid>    <pubDate>2025-11-13T09:15:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715820047" data-draft-id="7571815997067640872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果"/> <meta itemprop="keywords" content="前端,Webpack,rollup.js"/> <meta itemprop="datePublished" content="2025-11-13T09:15:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:15:22.000Z" title="Thu Nov 13 2025 09:15:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Tree-shaking 是现代前端构建工具中用于消除死代码（未被使用的代码）的重要优化手段，核心原理是利用 ES6 模块的静态特性（<code>import</code>/<code>export</code>）分析代码依赖，剔除未被引用的导出内容。</p>
<h3 data-id="heading-0">一、Tree-shaking 核心前提</h3>
<p>Tree-shaking 仅对 <strong>ES6 模块（ESM）</strong>  有效，因为 ESM 具有以下静态特性：</p>
<ul>
<li>模块依赖关系在编译时确定（而非运行时）。</li>
<li><code>import</code>/<code>export</code> 语句只能出现在模块顶层，无法动态修改。</li>
</ul>
<p>CommonJS 模块（<code>require</code>/<code>module.exports</code>）因依赖关系动态化，无法被 Tree-shaking 优化。</p>
<h3 data-id="heading-1">二、Rollup 中的 Tree-shaking</h3>
<p>Rollup 是专注于 ES 模块打包的工具，Tree-shaking 是其原生核心功能，实现简洁且高效。</p>
<h4 data-id="heading-2">1. 实现原理</h4>
<p>Rollup 通过以下步骤实现 Tree-shaking：</p>
<ol>
<li><strong>依赖解析</strong>：遍历模块的 <code>import</code>/<code>export</code> 语句，构建模块依赖图。</li>
<li><strong>标记未使用代码</strong>：从入口模块出发，追踪所有被引用的导出（<code>export</code>），未被引用的导出被标记为 “死代码”。</li>
<li><strong>删除死代码</strong>：在打包阶段直接剔除标记的死代码，不生成冗余内容。</li>
</ol>
<p>Rollup 对代码的静态分析更彻底，且默认输出未被混淆的代码，因此 Tree-shaking 效果直观可见。</p>
<h4 data-id="heading-3">2. 代码示例与效果</h4>
<h5 data-id="heading-4">源文件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js（ES 模块）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用的函数</span>

<span class="hljs-comment">// index.js（入口文件）</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 仅使用 add</span>
</code></pre>
<h5 data-id="heading-5">Rollup 配置（<code>rollup.config.js</code>）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  input: <span class="hljs-string">'src/index.js'</span>,
  output: {
    file: <span class="hljs-string">'dist/bundle.js'</span>,
    format: <span class="hljs-string">'es'</span> <span class="hljs-comment">// 输出 ES 模块（保留 import/export，便于观察）</span>
  }
};
</code></pre>
<h5 data-id="heading-6">打包结果（<code>dist/bundle.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">const add = (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) =&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>;
console<span class="hljs-selector-class">.log</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 函数被完全剔除，输出代码简洁。</li>
</ul>
<h3 data-id="heading-7">三、Webpack 中的 Tree-shaking</h3>
<p>Webpack 从 v2 开始支持 Tree-shaking，但实现逻辑更复杂，受多种因素影响（如模式、压缩工具等）。</p>
<h4 data-id="heading-8">1. 实现原理</h4>
<p>Webpack 的 Tree-shaking 分为三个阶段：</p>
<ol>
<li>
<p><strong>标记阶段</strong>：</p>
<ul>
<li>解析 ES 模块的 <code>import</code>/<code>export</code>，通过 <code>ModuleConcatenationPlugin</code> 分析模块依赖。</li>
<li>对未被引用的导出标记为 <code>/* unused harmony export xxx */</code>（仅标记，不删除）。</li>
</ul>
</li>
<li>
<p><strong>删除阶段</strong>：</p>
<ul>
<li>依赖 <strong>压缩工具（如 Terser）</strong>  剔除标记的死代码。</li>
<li>仅在 <code>production</code> 模式下默认启用（开发模式为保留代码不删除）。</li>
</ul>
</li>
<li>
<p><strong>副作用处理</strong>：</p>
<ul>
<li>通过 <code>package.json</code> 的 <code>sideEffects</code> 字段标记模块是否有副作用（如全局变量修改、DOM 操作），避免误删有副作用的代码。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">2. 代码示例与效果</h4>
<h5 data-id="heading-10">源文件（同 Rollup 示例）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用</span>

<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<h5 data-id="heading-11">Webpack 配置（<code>webpack.config.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">module<span class="hljs-selector-class">.exports</span> = {
  entry: <span class="hljs-string">'./src/index.js'</span>,
  output: {
    filename: <span class="hljs-string">'bundle.js'</span>,
    path: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>)
  },
  mode: <span class="hljs-string">'production'</span> // 必须为 production 模式才会删除死代码
};
</code></pre>
<h5 data-id="heading-12">打包结果（<code>dist/bundle.js</code>，简化后）</h5>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// add(1,2) 被直接计算，minus 完全删除</span>
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 被剔除，且 <code>add</code> 函数因逻辑简单被进一步优化（直接计算结果）。</li>
</ul>
<h4 data-id="heading-13">3. 关键配置：<code>sideEffects</code></h4>
<p>如果模块存在副作用（如修改全局变量），需在 <code>package.json</code> 中声明，避免被误删：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"./src/polyfill.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 有副作用的模块</span>
    <span class="hljs-string">"*.css"</span> <span class="hljs-comment">// CSS 文件通常有副作用（插入样式）</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>sideEffects: false</code>：表示所有模块均无副作用，可安全删除未引用代码。</li>
</ul>
<h3 data-id="heading-14">四、核心差异对比</h3>



































<table><thead><tr><th>特性</th><th>Rollup</th><th>Webpack</th></tr></thead><tbody><tr><td><strong>分析能力</strong></td><td>原生支持 ESM 静态分析，更彻底</td><td>需依赖插件（<code>ModuleConcatenationPlugin</code>），分析逻辑较复杂</td></tr><tr><td><strong>删除死代码时机</strong></td><td>打包阶段直接删除</td><td>依赖压缩工具（Terser）在优化阶段删除</td></tr><tr><td><strong>开发模式效果</strong></td><td>即使开发模式也会删除死代码</td><td>仅 <code>production</code> 模式删除（开发模式保留用于调试）</td></tr><tr><td><strong>输出可读性</strong></td><td>输出代码接近源码，Tree-shaking 效果直观</td><td>输出代码经压缩混淆，效果需反推</td></tr><tr><td><strong>适用场景</strong></td><td>库文件打包（如工具库、组件库）</td><td>应用程序打包（依赖复杂、需处理多种模块类型）</td></tr></tbody></table>
<h3 data-id="heading-15">五、总结</h3>
<ul>
<li><strong>Rollup</strong>：Tree-shaking 实现简洁高效，输出代码干净，适合库文件打包（如 React、Vue 等）。</li>
<li><strong>Webpack</strong>：Tree-shaking 需配合压缩工具和模式配置，功能更全面（支持多种模块类型、复杂依赖），适合应用程序打包。</li>
</ul>
<h3 data-id="heading-16">六、直观点</h3>
<ul>
<li>整个过程就像 “清理房间”：先摸清房间里的物品（依赖解析）→ 标记没用的垃圾（标记死代码）→ 直接扔掉垃圾（删除死代码）；</li>
<li>对比 Webpack ：Rollup 是 “边打包边扔垃圾”，Webpack 是 “先标记垃圾，最后找清洁工（Terser）扔”，所以 Rollup 的产物更直观看到剔除效果。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-4]]></title>    <link>https://juejin.cn/post/7571678674144854026</link>    <guid>https://juejin.cn/post/7571678674144854026</guid>    <pubDate>2025-11-12T12:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144854026" data-draft-id="7571088527678275610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-4"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:47:15.000Z" title="Wed Nov 12 2025 12:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最激动人心的部分——<strong>协程</strong>和<strong>现代异步编程</strong>。这将彻底改变你处理并发和异步任务的方式。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 协程：重新定义异步编程</strong></h3>
<h4 data-id="heading-1"><strong>二十二、协程基础：轻量级线程</strong></h4>
<p>协程是 Kotlin 用于异步编程的解决方案，比线程更轻量、更高效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"主线程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    
    <span class="hljs-comment">// 启动一个协程</span>
    GlobalScope.launch {
        println(<span class="hljs-string">"协程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 非阻塞延迟</span>
        println(<span class="hljs-string">"协程结束: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    
    println(<span class="hljs-string">"主线程继续执行: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    Thread.sleep(<span class="hljs-number">2000L</span>) <span class="hljs-comment">// 阻塞主线程，等待协程完成</span>
    println(<span class="hljs-string">"主线程结束"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 主线程开始: main</span>
<span class="hljs-comment">// 主线程继续执行: main</span>
<span class="hljs-comment">// 协程开始: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 协程结束: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 主线程结束</span>
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><code>launch</code>: 启动一个不返回结果的协程</li>
<li><code>delay()</code>: 非阻塞的挂起函数</li>
<li>协程运行在后台线程池，不会阻塞主线程</li>
</ul>
<h4 data-id="heading-2"><strong>二十三、挂起函数：异步操作的基石</strong></h4>
<p>挂起函数是协程的核心，用 <code>suspend</code>关键字标记。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserData</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的数据"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1500L</span>) <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的帖子"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> userData = fetchUserData(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> userPosts = fetchUserPosts(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"顺序执行耗时: <span class="hljs-subst">${time}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>二十四、异步并发：同时执行多个任务</strong></h4>
<p>使用 <code>async</code>和 <code>await</code>实现并发操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-comment">// 同时启动两个异步任务</span>
        <span class="hljs-keyword">val</span> userDataDeferred = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPostsDeferred = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-comment">// 等待两个任务都完成</span>
        <span class="hljs-keyword">val</span> userData = userDataDeferred.await()
        <span class="hljs-keyword">val</span> userPosts = userPostsDeferred.await()
        
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"并发执行耗时: <span class="hljs-subst">${time}</span>ms"</span>) <span class="hljs-comment">// 时间接近最长任务的时间</span>
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 用户 1 的数据, 用户 1 的帖子</span>
<span class="hljs-comment">// 并发执行耗时: 1506ms (而不是 1000 + 1500 = 2500ms)</span>
</code></pre>
<h4 data-id="heading-4"><strong>二十五、协程上下文与调度器</strong></h4>
<p>控制协程在哪个线程上运行。</p>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 在不同调度器上启动协程</span>
    launch { <span class="hljs-comment">// 继承父协程的上下文</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Unconfined) { <span class="hljs-comment">// 不受限制，在第一个挂起点之前运行在调用者线程</span>
        <span class="hljs-built_in">println</span>("不受限制: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Default) { <span class="hljs-comment">// CPU 密集型任务</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.IO) { <span class="hljs-comment">// I/O 密集型任务</span>
        <span class="hljs-built_in">println</span>("IO 调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(newSingleThreadContext("MyThread")) { <span class="hljs-comment">// 专用线程</span>
        <span class="hljs-built_in">println</span>("专用线程: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>二十六、结构化并发：避免资源泄漏</strong></h4>
<p>使用 <code>coroutineScope</code>实现结构化并发。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 结构化并发：所有子协程完成后，父协程才完成</span>
    <span class="hljs-keyword">val</span> result = coroutineScope {
        <span class="hljs-keyword">val</span> userData = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPosts = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-string">"结果: <span class="hljs-subst">${userData.await()}</span> + <span class="hljs-subst">${userPosts.await()}</span>"</span>
    }
    println(result)
}

<span class="hljs-comment">// 处理异常的结构化并发</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataSafely</span><span class="hljs-params">()</span></span>: Result&lt;String&gt; = coroutineScope {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = async { 
            delay(<span class="hljs-number">500L</span>)
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"模拟错误"</span>)
            }
            <span class="hljs-string">"获取的数据"</span>
        }.await()
        Result.success(<span class="hljs-keyword">data</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Result.failure(e)
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>二十七、流（Flow）：异步数据流</strong></h4>
<p>Flow 是 Kotlin 的响应式流处理，类似 RxJava。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 创建流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"流开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟异步工作</span>
        emit(i) <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 流的中间操作</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        emit(i)
    }
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// 过滤偶数</span>
 .map { <span class="hljs-string">"数字: <span class="hljs-variable">$it</span>"</span> }    <span class="hljs-comment">// 转换</span>
 .onEach { println(<span class="hljs-string">"处理: <span class="hljs-variable">$it</span>"</span>) } <span class="hljs-comment">// 副作用</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 收集流</span>
    simpleFlow().collect { value -&gt; 
        println(<span class="hljs-string">"收集到: <span class="hljs-variable">$value</span>"</span>) 
    }
    
    println(<span class="hljs-string">"--- 带中间操作的流 ---"</span>)
    processNumbers().collect { println(<span class="hljs-string">"最终结果: <span class="hljs-variable">$it</span>"</span>) }
}
</code></pre>
<h4 data-id="heading-7"><strong>二十八、通道（Channel）：协程间通信</strong></h4>
<p>Channel 用于协程之间的通信。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> channel = Channel&lt;String&gt;()
    
    <span class="hljs-comment">// 生产者协程</span>
    launch {
        <span class="hljs-keyword">val</span> users = listOf(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>)
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> users) {
            channel.send(user) <span class="hljs-comment">// 发送数据</span>
            delay(<span class="hljs-number">100L</span>)
        }
        channel.close() <span class="hljs-comment">// 关闭通道</span>
    }
    
    <span class="hljs-comment">// 消费者协程</span>
    launch {
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> channel) { <span class="hljs-comment">// 接收数据</span>
            println(<span class="hljs-string">"收到用户: <span class="hljs-variable">$user</span>"</span>)
        }
        println(<span class="hljs-string">"通道已关闭"</span>)
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>二十九、实战：构建完整的异步应用</strong></h4>
<p>让我们构建一个完整的用户信息获取系统。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> content: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> user: User, <span class="hljs-keyword">val</span> posts: List&lt;Post&gt;, <span class="hljs-keyword">val</span> friends: List&lt;User&gt;)

<span class="hljs-comment">// 模拟远程数据源</span>
<span class="hljs-keyword">object</span> UserRepository {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">500L</span>) <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">return</span> User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>)
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;Post&gt; {
        delay(<span class="hljs-number">300L</span>)
        <span class="hljs-keyword">return</span> listOf(
            Post(<span class="hljs-number">1</span>, userId, <span class="hljs-string">"标题1"</span>, <span class="hljs-string">"内容1"</span>),
            Post(<span class="hljs-number">2</span>, userId, <span class="hljs-string">"标题2"</span>, <span class="hljs-string">"内容2"</span>)
        )
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserFriends</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;User&gt; {
        delay(<span class="hljs-number">400L</span>)
        <span class="hljs-keyword">return</span> listOf(
            User(userId + <span class="hljs-number">1</span>, <span class="hljs-string">"朋友1"</span>, <span class="hljs-string">"friend1@example.com"</span>),
            User(userId + <span class="hljs-number">2</span>, <span class="hljs-string">"朋友2"</span>, <span class="hljs-string">"friend2@example.com"</span>)
        )
    }
}

<span class="hljs-comment">// 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: UserProfile = coroutineScope {
        <span class="hljs-keyword">val</span> userDeferred = async { UserRepository.getUser(userId) }
        <span class="hljs-keyword">val</span> postsDeferred = async { UserRepository.getUserPosts(userId) }
        <span class="hljs-keyword">val</span> friendsDeferred = async { UserRepository.getUserFriends(userId) }
        
        UserProfile(
            user = userDeferred.await(),
            posts = postsDeferred.await(),
            friends = friendsDeferred.await()
        )
    }
    
    <span class="hljs-comment">// 使用 Flow 实现实时更新</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfileStream</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;UserProfile&gt; = flow {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> profile = getUserProfile(userId)
            emit(profile)
            delay(<span class="hljs-number">5000L</span>) <span class="hljs-comment">// 每5秒更新一次</span>
        }
    }
}

<span class="hljs-comment">// UI 层（模拟）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userService = UserService()
    
    println(<span class="hljs-string">"=== 获取用户资料 ==="</span>)
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> profile = userService.getUserProfile(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"用户: <span class="hljs-subst">${profile.user.name}</span>"</span>)
        println(<span class="hljs-string">"帖子数量: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        println(<span class="hljs-string">"好友数量: <span class="hljs-subst">${profile.friends.size}</span>"</span>)
    }
    println(<span class="hljs-string">"耗时: <span class="hljs-subst">${time}</span>ms"</span>)
    
    println(<span class="hljs-string">"\n=== 实时数据流 ==="</span>)
    <span class="hljs-comment">// 模拟实时数据流（只收集3次）</span>
    userService.getUserProfileStream(<span class="hljs-number">1</span>)
        .take(<span class="hljs-number">3</span>) <span class="hljs-comment">// 只取3个值</span>
        .collect { profile -&gt;
            println(<span class="hljs-string">"实时更新: <span class="hljs-subst">${profile.user.name}</span> - 帖子: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>三十、异常处理与超时控制</strong></h4>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 1. 基本的异常处理</span>
    val job = launch {
        try {
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
            throw <span class="hljs-built_in">RuntimeException</span>("测试异常")
        } catch (e: Exception) {
            <span class="hljs-built_in">println</span>("捕获异常: ${e.message}")
        }
    }
    job<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 2. 协程异常处理器</span>
    val handler = CoroutineExceptionHandler { _, exception -&gt;
        <span class="hljs-built_in">println</span>("协程异常处理器捕获: ${exception.message}")
    }
    
    val job2 = <span class="hljs-built_in">launch</span>(handler) {
        throw <span class="hljs-built_in">RuntimeException</span>("被处理器捕获的异常")
    }
    job2<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 3. 超时控制</span>
    try {
        <span class="hljs-built_in">withTimeout</span>(<span class="hljs-number">1300</span>L) {
            repeat(<span class="hljs-number">1000</span>) { <span class="hljs-selector-tag">i</span> -&gt;
                <span class="hljs-built_in">println</span>("任务 $i")
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>L)
            }
        }
    } catch (e: TimeoutCancellationException) {
        <span class="hljs-built_in">println</span>("任务超时")
    }
    
    <span class="hljs-comment">// 4. 超时返回默认值</span>
    val result = <span class="hljs-built_in">withTimeoutOrNull</span>(<span class="hljs-number">1300</span>L) {
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
        "成功结果"
    } ?: <span class="hljs-string">"超时默认值"</span>
    
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"结果: $result"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十一、高级模式：生产者-消费者模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">produceUsers</span><span class="hljs-params">()</span></span> = produce {
    <span class="hljs-keyword">var</span> id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>))
        delay(<span class="hljs-number">200L</span>)
        id++
        <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span> <span class="hljs-comment">// 只生产5个用户</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">processUser</span><span class="hljs-params">(userChannel: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> = produce {
    <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> userChannel) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟处理时间</span>
        send(<span class="hljs-string">"已处理: <span class="hljs-subst">${user.name}</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userProducer = produceUsers()
    <span class="hljs-keyword">val</span> processor = processUser(userProducer)
    
    <span class="hljs-comment">// 消费处理结果</span>
    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processor) {
        println(result)
    }
    
    println(<span class="hljs-string">"处理完成"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 协程的核心概念！接下来可以探索：</p>
<ol>
<li><strong>Flow 高级操作</strong>：<code>combine</code>、<code>zip</code>、<code>flatMapLatest</code>等操作符</li>
<li><strong>状态管理</strong>：使用 <code>StateFlow</code>和 <code>SharedFlow</code></li>
<li><strong>测试协程</strong>：使用 <code>TestCoroutineDispatcher</code>和 <code>runTest</code></li>
<li><strong>Android 上的协程</strong>：与 ViewModel、Lifecycle 集成</li>
<li><strong>服务端协程</strong>：Ktor 框架的使用</li>
</ol>
<p>协程是 Kotlin 生态中最强大的特性之一，它将彻底改变你处理异步编程的方式。尝试在实际项目中使用这些模式，你会发现代码变得更加简洁和易于维护！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 10：08. 基于Nuxt开发博客项目-关于我页面开发]]></title>    <link>https://juejin.cn/post/7572004684178358326</link>    <guid>https://juejin.cn/post/7572004684178358326</guid>    <pubDate>2025-11-13T09:17:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178358326" data-draft-id="7571808096936919081" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 10：08. 基于Nuxt开发博客项目-关于我页面开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-13T09:17:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 10：08. 基于Nuxt开发博客项目-关于我页面开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:17:38.000Z" title="Thu Nov 13 2025 09:17:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5056bca77be34136a2fa1fc117528418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=3Rcu7m98lM6FTqD0mK3menEz0oA%3D" alt="PixPin_2025-11-13_17-12-30.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在个人博客项目中，"关于我"页面是访客了解博主的重要窗口。一个设计合理、内容丰富的关于我页面不仅能展示个人专业能力，还能增加博客的亲和力和可信度。当然你可以完全 <code>DIY</code> 这个模块，或者也可以参考我的设计，这个页面主要包含信息卡片、个人简介、技术栈、工作经历和教育经历等模块。</p>
<p>这个是我的示例站点，在这里可以看到我目前的进度，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csyblog.cn%2F" target="_blank" title="https://www.csyblog.cn/" ref="nofollow noopener noreferrer">www.csyblog.cn/</a></p>
<h2 data-id="heading-1">二、信息卡片</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d36b17996cce434fa3af663b698900fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=FENXJuLz3jt3xYRRfX1CSyDFcEs%3D" alt="image.png" loading="lazy"/></p>
<p>实现思路很简单，就是一些基础的布局和细节样式调整，如果实现比较手生，通过咨询<code>AI</code>也很容易完成。</p>
<p>这个模块主要是展示博主头像、基本信息和社交链接。</p>
<blockquote>
<p>如果需要源码可以通过这里的联系方式联系我，我会给你当前最新的代码。因为还不够完善，所以暂时不开源。</p>
</blockquote>
<h2 data-id="heading-2">三、个人简介</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177893abcc8549cf8c00da86f20c07df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=TnlHkfb4UpHnOtoeRUm3t8vI2I8%3D" alt="image.png" loading="lazy"/></p>
<p>这里其实就是个简短的自我介绍。</p>
<h2 data-id="heading-3">四、技术栈</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65a44d240c944739749a71d20a2f85a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=enG9KRkB2gS4UA%2FSzzmDlH%2F4Lmw%3D" alt="image.png" loading="lazy"/></p>
<p>这个模块主要作用就是，展示一下自己的技术栈，知道的，了解的一股脑往上堆就好了。</p>
<h2 data-id="heading-4">五、工作经历&amp;教育经历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f871f56eaad54111b2150b359a1d9081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=dH5LBIZ9RPWUs2%2BFn8wPRQp59Es%3D" alt="image.png" loading="lazy"/></p>
<p>这里我建议要么就别写，要写就写真实的，这是人与人最基本的信任，没必要打肿脸充胖子，杜撰一些华丽的履历出来，到时候经不起考验，也是搬石头砸自己的脚。</p>
<h2 data-id="heading-5">六、首页修改</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440ef09935ca4f03b523022b808bd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=s7Nwv4rg3GjjrDRQKz6kR2Dvte4%3D" alt="PixPin_2025-11-13_17-06-07.gif" loading="lazy"/></p>
<p>因为关于我页面我写了工作经验与教育背景，这和我之前首页展示的有重复，所以我找了个炫酷的标签云组件放这里。</p>
<h2 data-id="heading-6">七、总结</h2>
<p>这个页面比较简单，但是要从0到1做出来，还是花了我不少时间的。找图标，调样式，痛并快乐着。</p>
<p>下面我们就要进入真正的重头戏了，博客模块的开发。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang 构建网络漏洞扫描器]]></title>    <link>https://juejin.cn/post/7571753301899182120</link>    <guid>https://juejin.cn/post/7571753301899182120</guid>    <pubDate>2025-11-13T08:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571753301899182120" data-draft-id="7571815997067558952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang 构建网络漏洞扫描器"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-13T08:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang 构建网络漏洞扫描器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:47:46.000Z" title="Thu Nov 13 2025 08:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本文完整介绍了如何基于 Golang 从零开始开发一个完善的网络漏洞扫描器。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Fbuilding-a-network-vulnerability-scanner-with-go" title="https://www.sitepoint.com/building-a-network-vulnerability-scanner-with-go" target="_blank" ref="nofollow noopener noreferrer">Building a Network Vulnerability Scanner with Go</a></em></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf49b7179b94dbeb43509caad6fd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763628466&amp;x-signature=EzA9Y%2FliENriQ%2FqWo58Exa%2FmHtc%3D" alt="" loading="lazy"/></p>
<p>本文将用 Go 语言创建一个简单且相当可靠的网络漏洞扫描器。Go 语言非常适合网络编程，它在设计时就考虑到了并发性，并且拥有出色的标准库。</p>
<h2 data-id="heading-0">1. 项目设置</h2>
<h5 data-id="heading-1">创建漏洞扫描器</h5>
<p>我们想要开发一个简单的命令行工具，该工具能够扫描主机网络、查找开放端口、识别运行的服务并发现潜在漏洞。这个扫描器一开始会非常简单，但随着逐步添加功能，其能力会不断增强。</p>
<p>首先，我们将创建一个新的 Go 项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> goscan
<span class="hljs-built_in">cd</span> goscan
go mod init github.com/yourusername/goscan
</code></pre>
<p>这将为项目初始化新的Go模块，帮助我们管理依赖项。</p>
<h5 data-id="heading-2">配置包和环境</h5>
<p>扫描器将利用若干 Go 包：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strconv"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"GoScan - Network Vulnerability Scanner"</span>)
}
</code></pre>
<p>这只是初始设置，但对于初始功能来说，已经足够了，我们会根据需要添加更多导入内容。像 <code>net</code> 这样的标准库包将负责处理大部分网络相关操作，而 <code>sync</code> 则会负责并发处理等。</p>
<h5 data-id="heading-3">网络扫描的伦理考量与风险</h5>
<p>在开始实现之前，首先需要探讨一下与网络扫描相关的伦理问题。在许多地区，未经授权的网络扫描是违法的，会被视为发动网络攻击的一种手段。因此，必须始终遵守以下规则：</p>
<ul>
<li><strong>许可</strong>：仅对拥有所有权或已获得明确许可进行扫描的临时网络和系统进行扫描。</li>
<li><strong>范围</strong>：为扫描设定明确的范围，并不要超出该范围。</li>
<li><strong>时间</strong>：不要进行可能导致服务中断或引发安全警报的过度扫描。</li>
<li><strong>披露</strong>：如果发现漏洞，请负责任的将其报告给相应的系统所有者。</li>
<li><strong>法律合规</strong>：了解并遵守有关网络扫描的当地法律。</li>
</ul>
<p>扫描工具的不当使用可能会导致法律诉讼、系统损坏或意外服务中断。我们的扫描器将包含诸如速率限制等防护措施，但最终责任在于用户以合乎道德的方式使用。</p>
<h2 data-id="heading-4">2. 简单端口扫描器</h2>
<p>漏洞评估基于端口扫描。每个开放端口所提供的潜在易受攻击的服务信息正是我们所要查找的内容。现在，让我们用 Go 语言编写一个简单的端口扫描器。</p>
<h5 data-id="heading-5">低级端口扫描实现</h5>
<p>端口扫描：尝试与目标主机上的每一个可能的端口建立连接。如果连接成功，则该端口是开放的；如果连接失败，则该端口是关闭的或被过滤的。对于此功能，Go 的 <code>net</code> 包已经为我们提供了支持。</p>
<p>那么，这就是我们所设计的一种简单的端口扫描器的示例：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> <span class="hljs-type">bool</span> {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    timeout := time.Second * <span class="hljs-number">2</span>
    
    fmt.Printf(<span class="hljs-string">"Scanning host: %s\n"</span>, host)
    
    <span class="hljs-comment">// Scan ports 1-1024 (well-known ports)</span>
    <span class="hljs-keyword">for</span> port := <span class="hljs-number">1</span>; port &lt;= <span class="hljs-number">1024</span>; port++ {
        <span class="hljs-keyword">if</span> scanPort(host, port, timeout) {
            fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, port)
        }
    }
    
    fmt.Println(<span class="hljs-string">"Scan complete"</span>)
}
</code></pre>
<h5 data-id="heading-6">使用 <code>net</code> 包</h5>
<p>上述代码使用了 Go 语言的 <code>net</code> 包，该包提供了网络输入/输出接口及相关函数。那么，主要的组成部分都有哪些呢？</p>
<ul>
<li><strong>net.DialTimeout</strong>：此功能会尝试在设定的超时时间内连接到 TCP 网络地址。如果连接成功，会返回连接信息以及任何可能出现的错误。</li>
<li><strong>连接处理</strong>：如果连接过程顺利，我们便知道该连接已打开，并会立即关闭该连接以释放资源。</li>
<li><strong>超时参数</strong>：设定超时时间，以避免在任何被过滤的开放端口上陷入僵局。两秒是一个不错的初始值，但可根据网络状况进行调整。</li>
</ul>
<h5 data-id="heading-7">对首次扫描进行测试</h5>
<p>现在，我们在本地主机上运行简单扫描器，那里可能有一些服务正在运行。</p>
<ul>
<li>将代码保存到名为 <code>main.go</code> 的文件中</li>
<li>用 <code>go run main.go</code> 命令运行</li>
</ul>
<p>这将显示哪些本地端口是开放的。在普通开发机器上，可能会有 80（HTTP）端口、443（HTTPS）端口，或者根据运行的服务不同，还有其他任意数量的数据库端口正在使用。</p>
<p>以下是一些可能得到的示例输出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Scanning host: localhost
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Scan complete
</code></pre>
<p>使用这种基本的扫描器是可以的，但也有不少明显的缺点：</p>
<ul>
<li><strong>速度</strong>：由于是按顺序扫描端口，所以速度极其缓慢。</li>
<li><strong>信息</strong>：只是告诉我们某个端口是否开放，没有服务信息。</li>
<li><strong>覆盖范围有限</strong>：只扫描前 1024 个端口。</li>
</ul>
<p>这些限制使得难以在实际应用中使用扫描器。</p>
<h2 data-id="heading-8">3. 从这里开始改进：多线程扫描</h2>
<h5 data-id="heading-9">为何最初的版本运行缓慢</h5>
<p>第一个端口扫描器能够正常工作，但其运行速度极其缓慢，几乎无法实际使用。问题在于其采用顺序扫描方法 —— 一次扫描一个端口。当一台主机有很多关闭/过滤的端口时，会在每个端口上等待连接超时，然后再转移到下一个端口，这造成了极大的时间浪费。</p>
<p>为了展示这个问题，我们来看看基本扫描器的运行时间：</p>
<ul>
<li>对于扫描前 1024 个端口的情况，如果设置 2 秒的超时时间，最长时间将达 2048 秒（超过 34 分钟）。</li>
<li>但即便对那些已关闭的端口的连接也会立即失败，这种方法由于网络延迟的原因也是效率低下。</li>
</ul>
<p>这种逐个端口进行的扫描方式是任何真正的漏洞扫描工具的瓶颈。</p>
<h5 data-id="heading-10">添加线程支持</h5>
<p>Go 语言在利用协程和通道实现并发方面表现尤为出色。因此，我们利用这些特性尝试同时扫描多个端口，从而显著提高性能。</p>
<p>现在让我们来创建多线程端口扫描器：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> {
    Port  <span class="hljs-type">int</span>
    State <span class="hljs-type">bool</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> Result {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">true</span>}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []Result {
    <span class="hljs-keyword">var</span> results []Result
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    <span class="hljs-comment">// Create a buffered channel to collect results</span>
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, end-start+<span class="hljs-number">1</span>)
    
    <span class="hljs-comment">// Create a semaphore to limit concurrent goroutines</span>
    <span class="hljs-comment">// This prevents us from opening too many connections at once</span>
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>) <span class="hljs-comment">// Limit to 100 concurrent scans</span>
    
    <span class="hljs-comment">// Launch goroutines for each port</span>
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            <span class="hljs-comment">// Acquire semaphore</span>
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }() <span class="hljs-comment">// Release semaphore</span>
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-comment">// Close channel when all goroutines complete</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-comment">// Collect results from channel</span>
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">500</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, result.Port)
    }
}
</code></pre>
<h5 data-id="heading-11">多线程结果</h5>
<p>现在，我们来看看改进后扫描器的性能提升以及并发机制：</p>
<ul>
<li><strong>协程</strong>：为了使扫描过程高效，我们会为需要扫描的每个端口启动一个协程，这样当我们检查一个端口时，就可以同时检查其他端口。</li>
<li><strong>等待组</strong>：同步的等待组  当我们启动协程时，希望等待它们完成。等待组有助于跟踪所有正在运行的协程，并等待它们完成。</li>
<li><strong>结果通道</strong>：我们为所有协程的结果创建了一个缓冲通道。</li>
<li><strong>信号量模式</strong>：使用信号量来限制并行进行的扫描数量,通过通道来实现,防止我们因打开过多连接而使目标系统甚至自身机器不堪重负。</li>
<li><strong>缩短超时时间</strong>：由于以并行方式运行许多此类扫描，所以使用较短的超时时间。</li>
</ul>
<p>性能差距很大。因此，当我们实现这个功能时，可以在几分钟内扫描 1024 个端口，而且肯定不会超过半小时。</p>
<p>示例输出：</p>
<pre><code class="hljs language-python" lang="python">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">3.2</span>s
Found <span class="hljs-number">3</span> <span class="hljs-built_in">open</span> ports:
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
</code></pre>
<p>这种多线程方法对于较大的端口范围和多个主机来说具有极好的扩展性。信号量模式确保即便要扫描上千个端口，也不会耗尽系统资源。</p>
<h2 data-id="heading-12">4. 添加服务检测</h2>
<p>既然已经有了一个快速、高效的端口扫描器，接下来的步骤就是了解那些开放端口上运行的是哪些服务。这通常被称为“服务指纹识别”或“标志抓取”，是一个连接到开放端口并检查返回数据的过程。</p>
<h5 data-id="heading-13">服务旗标抓取（Banner Grabbing）实现</h5>
<p>服务旗标抓取指的是当我们打开服务并读取发送给我们的响应（即旗标信息）时的操作。因此，这是一种很好的确认服务是否运行的方法，许多服务都会在旗标中标识自身信息。</p>
<p>我们在扫描器中加入抓取旗标的功能：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port     <span class="hljs-type">int</span>
    State    <span class="hljs-type">bool</span>
    Service  <span class="hljs-type">string</span>
    Banner   <span class="hljs-type">string</span>
    Version  <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    
    <span class="hljs-comment">// Some services need a trigger to send data</span>
    <span class="hljs-comment">// Send a simple HTTP request for web services</span>
    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\n\r\n"</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// For other services, just wait for the banner</span>
        <span class="hljs-comment">// Some services may require specific triggers</span>
    }
    
    <span class="hljs-comment">// Read the response</span>
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    <span class="hljs-comment">// Try to identify service from common ports</span>
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-comment">// SSH version detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-comment">// HTTP server detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-comment">// Try to find server info in format "Server: Apache/2.4.29"</span>
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:    port,
        State:   <span class="hljs-literal">true</span>,
        Service: service,
        Banner:  banner,
        Version: version,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">800</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION\tBANNER"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------\t------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        bannerPreview := <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Banner) &gt; <span class="hljs-number">30</span> {
            bannerPreview = result.Banner[:<span class="hljs-number">30</span>] + <span class="hljs-string">"..."</span>
        } <span class="hljs-keyword">else</span> {
            bannerPreview = result.Banner
        }
        
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version, 
            bannerPreview)
    }
}
</code></pre>
<h5 data-id="heading-14">识别正在运行的服务</h5>
<p>两种主要的服务检测策略：</p>
<ul>
<li><strong>基于端口识别</strong>：通过映射到公共端口号（例如，端口 80 是 HTTP），对服务有一个可能的猜测。</li>
<li><strong>旗标分析</strong>：获取旗标文本并查找服务标识符和版本信息。</li>
</ul>
<p>第一个函数 <code>grabBanner</code> 旨在从服务中获取第一个响应。有些服务（如 HTTP）要求发送请求并接收回复，为此我们会添加特定案例来处理这种情况。</p>
<h5 data-id="heading-15">基本版本检测</h5>
<p>版本检测对于漏洞的识别至关重要。在可能的情况下，扫描器会解析服务旗标以获取版本信息：</p>
<ul>
<li><strong>SSH</strong>：通常会以 <code>SSH-2.0-OpenSSH_7.4</code> 这样的形式提供版本信息。</li>
<li><strong>HTTP 服务器</strong>：通常会在响应头中（如 <code>Server: Apache/2.4.29</code>）返回其版本信息。</li>
<li><strong>数据库服务器</strong>：可能会在其欢迎消息中披露版本信息。</li>
</ul>
<p>现在，对于每个开放端口，输出都会返回更多信息：</p>
<pre><code class="hljs language-sql" lang="sql">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">5.4</span>s
Found <span class="hljs-number">3</span> <span class="hljs-keyword">open</span> ports:

PORT    SERVICE VERSION BANNER
<span class="hljs-comment">----    ------- ------- ------</span>
<span class="hljs-number">22</span>      SSH     <span class="hljs-number">2.0</span>     SSH<span class="hljs-number">-2.0</span><span class="hljs-operator">-</span>OpenSSH_8<span class="hljs-number">.4</span>p1 Ubuntu<span class="hljs-number">-6</span>
<span class="hljs-number">80</span>      HTTP    Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> Server: Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> (Ubuntu)
<span class="hljs-number">443</span>     HTTPS   <span class="hljs-literal">Unknown</span> Connection closed <span class="hljs-keyword">by</span> foreign...
</code></pre>
<p>这种增强后的信息对于漏洞评估而言要具有更高的价值。</p>
<h2 data-id="heading-16">5. 漏洞检测实现</h2>
<p>既然能列出正在运行的服务及其版本，接下来我们将实现针对漏洞的检测。我们对服务信息进行分析，并与已知漏洞进行对比。</p>
<h5 data-id="heading-17">编写简单的漏洞测试</h5>
<p>我们将根据常见服务和版本，基于已知漏洞构建数据库。为了简便起见，我们将创建一个嵌入代码的漏洞数据库，但在实际场景中，扫描器很可能会查询外部漏洞数据库（如 CVE 或 NVD）。</p>
<p>现在进一步完善代码，使其能够检测出漏洞：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-18">基于版本的漏洞匹配</h5>
<p>针对漏洞检测我们用简单版本匹配方法：</p>
<ul>
<li><strong>直接匹配</strong>：将服务类型和版本与漏洞数据库进行匹配。</li>
<li><strong>部分匹配</strong>：对于漏洞版本的匹配，我们会对版本字符串进行限制性检查，这样即使版本字符串包含额外信息，也能识别出存在漏洞的系统。</li>
</ul>
<p>在实际的扫描器中，匹配会更为复杂，会考虑到以下因素：</p>
<ul>
<li>版本范围（即版本 2.4.0 至 2.4.38 受影响）</li>
<li>特定配置的漏洞</li>
<li>操作系统特定的问题</li>
<li>更细致的版本比较</li>
</ul>
<h5 data-id="heading-19">报告发现的情况</h5>
<p>报告结果是漏洞检测流程中的最后一步，需要以简洁且具有可操作性的格式进行。扫描器现在：</p>
<ul>
<li>列出所有开放端口及其服务及版本信息</li>
<li>对于每个存在漏洞的服务，会显示：
<ul>
<li>漏洞标识（例如，CVE 编号）</li>
<li>漏洞描述</li>
<li>严重程度评级</li>
<li>更多信息的参考链接</li>
</ul>
</li>
</ul>
<p>示例输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning localhost from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">6.2</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   Unknown
</code></pre>
<p>这份详尽的漏洞数据能够帮助网络安全专家迅速找出并排序出需要解决的安全问题。</p>
<h2 data-id="heading-20">最后完善与使用方法</h2>
<p>现在已经有了一个具备服务检测和漏洞匹配功能的基本漏洞扫描器；我们对其进行完善，以便在实际应用中更具实用性。</p>
<h6 data-id="heading-21">命令行参数</h6>
<p>扫描器可以通过命令行标志进行配置，这些标志能够设定目标、端口范围以及扫描选项。使用 Go 的 <code>flag</code> 包进行配置非常简单。</p>
<p>添加命令行参数：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"encoding/json"</span>
    <span class="hljs-string">"flag"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port            <span class="hljs-type">int</span>
    State           <span class="hljs-type">bool</span>
    Service         <span class="hljs-type">string</span>
    Banner          <span class="hljs-type">string</span>
    Version         <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service       <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    <span class="hljs-comment">// ... (same as before)</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    hostPtr := flag.String(<span class="hljs-string">"host"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Target host to scan (required)"</span>)
    startPortPtr := flag.Int(<span class="hljs-string">"start"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Starting port number"</span>)
    endPortPtr := flag.Int(<span class="hljs-string">"end"</span>, <span class="hljs-number">1024</span>, <span class="hljs-string">"Ending port number"</span>)
    timeoutPtr := flag.Int(<span class="hljs-string">"timeout"</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">"Timeout in milliseconds"</span>)
    concurrencyPtr := flag.Int(<span class="hljs-string">"concurrency"</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"Number of concurrent scans"</span>)
    formatPtr := flag.String(<span class="hljs-string">"format"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"Output format: text, json, or csv"</span>)
    verbosePtr := flag.Bool(<span class="hljs-string">"verbose"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"Show verbose output including banners"</span>)
    outputFilePtr := flag.String(<span class="hljs-string">"output"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Output file (default is stdout)"</span>)
    
    flag.Parse()
    
    <span class="hljs-keyword">if</span> *hostPtr == <span class="hljs-string">""</span> {
        fmt.Println(<span class="hljs-string">"Error: host is required"</span>)
        flag.Usage()
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    <span class="hljs-keyword">if</span> *startPortPtr &lt; <span class="hljs-number">1</span> || *startPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: starting port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *endPortPtr &lt; <span class="hljs-number">1</span> || *endPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: ending port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *startPortPtr &gt; *endPortPtr {
        fmt.Println(<span class="hljs-string">"Error: starting port must be less than or equal to ending port"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    timeout := time.Duration(*timeoutPtr) * time.Millisecond
    
    <span class="hljs-keyword">var</span> outputFile *os.File
    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
    
    <span class="hljs-keyword">if</span> *outputFilePtr != <span class="hljs-string">""</span> {
        outputFile, err = os.Create(*outputFilePtr)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"Error creating output file: %v\n"</span>, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        <span class="hljs-keyword">defer</span> outputFile.Close()
    } <span class="hljs-keyword">else</span> {
        outputFile = os.Stdout
    }
    
    fmt.Fprintf(outputFile, <span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, *hostPtr, *startPortPtr, *endPortPtr)
    startTime := time.Now()
    
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, *endPortPtr-*startPortPtr+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, *concurrencyPtr)
    
    <span class="hljs-keyword">for</span> port := *startPortPtr; port &lt;= *endPortPtr; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(*hostPtr, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    elapsed := time.Since(startTime)
    
    <span class="hljs-keyword">switch</span> *formatPtr {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
        outputJSON(outputFile, results, elapsed)
    <span class="hljs-keyword">case</span> <span class="hljs-string">"csv"</span>:
        outputCSV(outputFile, results, elapsed, *verbosePtr)
    <span class="hljs-keyword">default</span>:
        outputText(outputFile, results, elapsed, *verbosePtr)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputText</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Fprintf(w, <span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(results) == <span class="hljs-number">0</span> {
        fmt.Fprintf(w, <span class="hljs-string">"No open ports found.\n"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"PORT\tSERVICE\tVERSION\n"</span>)
    fmt.Fprintf(w, <span class="hljs-string">"----\t-------\t-------\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Fprintf(w, <span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> verbose {
            fmt.Fprintf(w, <span class="hljs-string">"  Banner: %s\n"</span>, result.Banner)
        }
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"  Vulnerabilities:\n"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Fprintf(w, <span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputJSON</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration)</span></span> {
    output := <span class="hljs-keyword">struct</span> {
        ScanTime   <span class="hljs-type">string</span>       <span class="hljs-string">`json:"scan_time"`</span>
        ElapsedTime <span class="hljs-type">string</span>       <span class="hljs-string">`json:"elapsed_time"`</span>
        TotalPorts <span class="hljs-type">int</span>          <span class="hljs-string">`json:"total_ports"`</span>
        OpenPorts  <span class="hljs-type">int</span>          <span class="hljs-string">`json:"open_ports"`</span>
        Results    []ScanResult <span class="hljs-string">`json:"results"`</span>
    }{
        ScanTime:    time.Now().Format(time.RFC3339),
        ElapsedTime: elapsed.String(),
        TotalPorts:  <span class="hljs-number">0</span>, 
        OpenPorts:   <span class="hljs-built_in">len</span>(results),
        Results:     results,
    }
    
    encoder := json.NewEncoder(w)
    encoder.SetIndent(<span class="hljs-string">""</span>, <span class="hljs-string">"  "</span>)
    encoder.Encode(output)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputCSV</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"Port,Service,Version,Vulnerability ID,Severity,Description\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) == <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,,,\n"</span>, 
                result.Port, 
                escapeCSV(result.Service), 
                escapeCSV(result.Version))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,%s,%s,%s\n"</span>, 
                    result.Port, 
                    escapeCSV(result.Service), 
                    escapeCSV(result.Version),
                    escapeCSV(vuln.ID),
                    escapeCSV(vuln.Severity),
                    escapeCSV(vuln.Description))
            }
        }
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"\n# Scan completed in %s, found %d open ports\n"</span>, 
        elapsed, <span class="hljs-built_in">len</span>(results))
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">escapeCSV</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">if</span> strings.Contains(s, <span class="hljs-string">","</span>) || strings.Contains(s, <span class="hljs-string">"\""</span>) || strings.Contains(s, <span class="hljs-string">"\n"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\""</span> + strings.ReplaceAll(s, <span class="hljs-string">"\""</span>, <span class="hljs-string">"\"\""</span>) + <span class="hljs-string">"\""</span>
    }
    <span class="hljs-keyword">return</span> s
}
</code></pre>
<h6 data-id="heading-22">输出格式</h6>
<p>扫描器现在可以输出三种格式：</p>
<ul>
<li><strong>文本</strong>：易于阅读，易于编写，非常适合交互使用。</li>
<li><strong>JSON</strong>：结构化输出，适用于机器处理以及与其他工具的集成。</li>
<li><strong>CSV</strong>：电子表格兼容的格式，用于分析和报告。</li>
</ul>
<p>输出文本还会提供更多信息，例如如果设置了详细模式，则会提供原始旗标信息，对于调试或深入分析也非常方便。</p>
<h6 data-id="heading-23">示例用法及结果</h6>
<p>如果打算将扫描器用于不同场合，以下是一些可能的选择：</p>
<p><strong>单个主机的基本扫描：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com
</code></pre>
<p><strong>扫描指定端口范围：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">$ go run main.go -host example.com -start <span class="hljs-number">80</span> -end <span class="hljs-number">443</span>
</code></pre>
<p><strong>增加超时和详细信息：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -verbose -timeout <span class="hljs-number">2000</span>
</code></pre>
<p><strong>以更高的并发性扫描以获得更快的结果：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -concurrency <span class="hljs-number">200</span>
</code></pre>
<p>示例文本输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning example.com from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">12.6</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   nginx/<span class="hljs-number">1.18</span><span class="hljs-number">.0</span>：
</code></pre>
<p>JSON 输出示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scan_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-03-18T14:30:00Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"elapsed_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12.6s"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"open_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"results"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH-2.0-OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2017-15906"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Medium"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2020-9490"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"High"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTPS"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>我们用 Go 语言构建了一个强大的网络漏洞扫描器，这表明该语言非常适合用于安全工具。扫描器能迅速打开端口，识别端口上运行的服务，并判断是否存在已知漏洞。</p>
<p>扫描器提供了有关网络上运行的服务的有用信息，包括多线程、服务指纹识别以及多种输出格式。</p>
<p>请记住，像扫描器这样的工具只能在符合道德和法律规范的条件下使用，并且需要获得对目标系统的扫描授权。如果操作得当，定期进行漏洞扫描是良好安全态势的重要组成部分，能够帮助保护系统免受威胁。</p>
<p>可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frezmoss%2Fnetwork-vulnerability-scanner" title="https://github.com/rezmoss/network-vulnerability-scanner" target="_blank" ref="nofollow noopener noreferrer">GitHub</a> 上找到该项目的完整源代码。</p>
<hr/>
<blockquote>
<p>你好，我是俞凡，在Motorola做过研发，现在在Mavenir做技术工作，对通信、网络、后端架构、云原生、DevOps、CICD、区块链、AI等技术始终保持着浓厚的兴趣，平时喜欢阅读、思考，相信持续学习、终身成长，欢迎一起交流学习。为了方便大家以后能第一时间看到文章，请朋友们关注公众号"DeepNoMind"，并设个星标吧，如果能一键三连(转发、点赞、在看)，则能给我带来更多的支持和动力，激励我持续写下去，和大家共同成长进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React DevTools 组件名乱码？揭秘从开发到生产的代码变形记]]></title>    <link>https://juejin.cn/post/7571678763781652514</link>    <guid>https://juejin.cn/post/7571678763781652514</guid>    <pubDate>2025-11-12T14:34:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763781652514" data-draft-id="7571672422689488948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React DevTools 组件名乱码？揭秘从开发到生产的代码变形记"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T14:34:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React DevTools 组件名乱码？揭秘从开发到生产的代码变形记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:34:55.000Z" title="Wed Nov 12 2025 14:34:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React DevTools 组件名乱码？聊聊代码压缩这件事</h2>
<p>线上打开 React DevTools，打开一看，组件树全是 <code>C0</code>、<code>$r</code>、<code>pv</code> 这种不可读的字符。</p>
<p>开发环境明明好好的，叫 <code>NavigationProvider</code>、<code>DialogPortal</code>，怎么到线上就全变了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23fcd0708f5641e494aca20e819a15d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562895&amp;x-signature=9AyhGROp8t67XkehvUG1el%2BeKjw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">问题出在哪</h3>
<p>简单说：<strong>生产构建时，代码被压缩了，函数名被改成了短字符。</strong></p>
<p>React DevTools 依赖函数名来显示组件名。函数名变了，显示的自然也就变了。</p>
<h4 data-id="heading-2">开发环境 vs 生产环境</h4>
<p><strong>开发环境</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>React DevTools 显示：<code>NavigationProvider</code> ✅</p>
<p><strong>生产环境</strong>（压缩后）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>React DevTools 显示：<code>pv</code> ❌</p>
<h3 data-id="heading-3">从开发到生产：代码都经历了什么</h3>
<p>要理解为什么会被压缩，先要知道我们写的代码是怎么变成用户访问的线上代码的。</p>
<h4 data-id="heading-4">开发模式：原汁原味</h4>
<p>用脚手架（Create React App、Vite）开发时，启动的是<strong>开发服务器</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
<span class="hljs-comment"># 或</span>
npm start
</code></pre>
<p>这时候：</p>
<ul>
<li>代码实时编译，但<strong>不压缩</strong></li>
<li>保留完整的变量名、函数名</li>
<li>包含 Source Maps（方便调试）</li>
<li>有热更新（Hot Module Replacement）</li>
</ul>
<p>浏览器加载的代码长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http://localhost:3000/src/App.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>清清楚楚，React DevTools 自然能读到 <code>NavigationProvider</code>。</p>
<h4 data-id="heading-5">生产构建：全面优化</h4>
<p>准备部署上线时，要执行构建命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p>这一步会调用打包工具（Webpack、Vite、Rollup），做一系列优化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[源代码&lt;br/&gt;多个 .jsx 文件] --&gt; B[编译&lt;br/&gt;JSX → JS]
    B --&gt; C[打包&lt;br/&gt;合并成少数文件]
    C --&gt; D[Tree Shaking&lt;br/&gt;删除未使用代码]
    D --&gt; E[压缩&lt;br/&gt;Minification]
    E --&gt; F[生产代码&lt;br/&gt;dist/main.abc123.js]
</code></pre>
<h5 data-id="heading-6">1. 编译（Transpilation）</h5>
<p>Babel 把 JSX 和现代 JS 语法转成浏览器能理解的代码。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
&lt;<span class="hljs-title class_">Provider</span>&gt;{children}&lt;/<span class="hljs-title class_">Provider</span>&gt;

<span class="hljs-comment">// 编译后</span>
<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Provider</span>, <span class="hljs-literal">null</span>, children)
</code></pre>
<h5 data-id="heading-7">2. 打包（Bundling）</h5>
<p>把几十上百个文件合并成几个文件。</p>
<pre><code class="hljs language-css" lang="css">开发环境：
├── App<span class="hljs-selector-class">.jsx</span>
├── components/
│   ├── Navigation<span class="hljs-selector-class">.jsx</span>
│   ├── <span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.jsx</span>
│   └── <span class="hljs-selector-tag">Footer</span><span class="hljs-selector-class">.jsx</span>
└── utils/
    └── helpers<span class="hljs-selector-class">.js</span>

生产环境：
└── dist/
    └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.abc123</span><span class="hljs-selector-class">.js</span>  ← 全部合并
</code></pre>
<h5 data-id="heading-8">3. Tree Shaking</h5>
<p>删除没用到的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unusedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }  <span class="hljs-comment">// 这个没被 import</span>

<span class="hljs-comment">// 打包后：unusedFunction 被删除</span>
</code></pre>
<h5 data-id="heading-9">4. 压缩（Minification）</h5>
<p><strong>这就是导致组件名乱码的关键步骤。</strong></p>
<p>压缩器（Terser、esbuild）把代码体积压到最小：</p>
<ul>
<li>删除空格、换行、注释</li>
<li>缩短变量名和函数名</li>
<li>简化代码逻辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,<span class="hljs-literal">null</span>,e)}
</code></pre>
<h4 data-id="heading-10">为什么生产环境要这么做</h4>
<p><strong>一个字：快。</strong></p>
<p>用户访问网站时：</p>
<ol>
<li>浏览器从服务器下载 JS 文件</li>
<li>解析代码</li>
<li>执行代码</li>
</ol>
<p><strong>如果不压缩</strong>：</p>
<ul>
<li>一个中型 React 应用，原始代码可能 2-3 MB</li>
<li>在 3G 网络下，下载要 20-30 秒</li>
<li>用户看到白屏，早跑了</li>
</ul>
<p><strong>压缩后</strong>：</p>
<ul>
<li>代码体积降到 500-800 KB</li>
<li>Gzip 压缩后可能只有 200 KB</li>
<li>下载时间缩短到 3-5 秒</li>
</ul>
<p>体积差异这么大，主要因为：</p>
<ul>
<li><strong>空格和换行</strong>：原始代码为了可读性，大量使用缩进和换行（占 20-30%）</li>
<li><strong>变量名和函数名</strong>：<code>NavigationProvider</code> → <code>pv</code> 这种压缩（占 30-40%）</li>
<li><strong>注释</strong>：开发时的注释在生产环境完全删除（占 5-10%）</li>
<li><strong>未使用的代码</strong>：Tree Shaking 删除（占 10-20%）</li>
</ul>
<p>所以，<strong>压缩是生产环境的必备步骤</strong>，不是可选项。</p>
<h4 data-id="heading-11">压缩在哪个阶段</h4>
<p>在 Webpack 或 Vite 的配置中，压缩是最后一步：</p>
<p><strong>Webpack 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,  <span class="hljs-comment">// 自动启用压缩</span>

    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启压缩</span>
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(),  <span class="hljs-comment">// 使用 Terser 压缩</span>
        ],
    },
};
</code></pre>
<p><strong>Vite 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">build</span>: {
        <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,  <span class="hljs-comment">// 使用 Terser 压缩（默认是 esbuild）</span>
    },
};
</code></pre>
<p>当你执行 <code>npm run build</code>，打包工具会：</p>
<ol>
<li>编译所有源文件</li>
<li>合并成几个大文件</li>
<li><strong>最后调用压缩器处理</strong></li>
<li>输出到 <code>dist/</code> 目录</li>
</ol>
<p>压缩是<strong>构建流程的最后一步</strong>，产出的就是上线的代码。</p>
<h4 data-id="heading-12">开发和生产的环境区别</h4>













































<table><thead><tr><th>特性</th><th>开发环境</th><th>生产环境</th></tr></thead><tbody><tr><td>命令</td><td><code>npm run dev</code></td><td><code>npm run build</code></td></tr><tr><td>代码压缩</td><td>❌</td><td>✅</td></tr><tr><td>变量名</td><td><code>NavigationProvider</code></td><td><code>pv</code></td></tr><tr><td>文件体积</td><td>2-3 MB</td><td>500-800 KB</td></tr><tr><td>Source Maps</td><td>✅ 完整</td><td>❌ 或隐藏</td></tr><tr><td>调试体验</td><td>轻松</td><td>困难</td></tr><tr><td>加载速度</td><td>慢（本地不care）</td><td>快（关键指标）</td></tr></tbody></table>
<p>现在明白了：<strong>开发时你写的清晰代码，到用户那里已经面目全非</strong>。</p>
<p>而组件名乱码，就是这个"面目全非"的副作用。</p>
<h3 data-id="heading-13">为什么要压缩函数名</h3>
<p>理解了背景，再看具体的压缩逻辑就清楚了。</p>
<p><strong>减小文件体积，加快加载速度。</strong></p>
<p>压缩器做的事：</p>
<ol>
<li><strong>删除空格和换行</strong></li>
<li><strong>缩短变量名</strong>：<code>userName</code> → <code>u</code></li>
<li><strong>缩短函数名</strong>：<code>NavigationProvider</code> → <code>pv</code></li>
<li><strong>简化代码结构</strong></li>
</ol>
<p>看个真实例子：</p>
<p><strong>压缩前</strong>（15 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; {
        <span class="hljs-title function_">setLocation</span>(path);
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>压缩后</strong>（4 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Context</span>.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>体积直接砍掉 70%。</p>
<p>其中 <code>NavigationProvider</code> → <code>pv</code> 就省了 17 个字符。整个项目几百个函数，加起来就是几十 KB 的差异。</p>
<h3 data-id="heading-14">压缩过程详解</h3>
<p>压缩不是简单的文本替换，而是经过多个阶段的代码转换。</p>
<h4 data-id="heading-15">完整的构建流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[源代码 JSX] --&gt; B[Babel 转译]
    B --&gt; C[打包合并]
    C --&gt; D[Terser 压缩]
    D --&gt; E[生产代码]
</code></pre>
<ol>
<li><strong>Babel 转译</strong>：把 JSX 转成标准 JavaScript</li>
<li><strong>打包合并</strong>：多个文件合成一个文件</li>
<li><strong>Terser 压缩</strong>：真正的压缩发生在这一步</li>
<li><strong>输出</strong>：最终的生产代码</li>
</ol>
<p>重点看第三步，压缩器内部其实也分好几个阶段。</p>
<h4 data-id="heading-16">Terser 的压缩阶段</h4>
<h5 data-id="heading-17">阶段 1：解析（Parse）</h5>
<p>把代码转成抽象语法树（AST）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 转成 AST（简化版）</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"Identifier"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"NavigationProvider"</span> },
    <span class="hljs-attr">params</span>: [
        {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ObjectPattern"</span>,
            <span class="hljs-attr">properties</span>: [{ <span class="hljs-attr">key</span>: <span class="hljs-string">"children"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"children"</span> }]
        }
    ],
    <span class="hljs-attr">body</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"ReturnStatement"</span>,
        <span class="hljs-attr">argument</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"JSXElement"</span>, ... }
    }
}
</code></pre>
<p>AST 就是代码的树状结构表示，方便后续分析和修改。</p>
<h5 data-id="heading-18">阶段 2：分析（Analyze）</h5>
<p><strong>2.1 作用域分析</strong></p>
<p>找出哪些变量名可以改，哪些不能改。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// 局部变量，可以改</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-variable language_">window</span>.<span class="hljs-property">NavigationProvider</span> = <span class="hljs-title class_">NavigationProvider</span>;  <span class="hljs-comment">// 全局引用，不能改</span>
</code></pre>
<p>规则：</p>
<ul>
<li><strong>可以改</strong>：函数内部的局部变量、函数名（如果没被外部引用）</li>
<li><strong>不能改</strong>：全局变量、对象属性名、被 <code>eval()</code> 使用的变量</li>
</ul>
<p><strong>2.2 引用计数</strong></p>
<p>统计每个标识符出现了多少次，决定是否值得压缩。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider 出现 1 次</span>
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);          <span class="hljs-comment">// location 出现 1 次</span>
    <span class="hljs-keyword">const</span> currentLocation = location;        <span class="hljs-comment">// location 出现 2 次</span>
    <span class="hljs-keyword">return</span> currentLocation;                  <span class="hljs-comment">// currentLocation 出现 1 次</span>
}
</code></pre>
<p>如果一个变量只用了 1 次，改成短名称可能不划算（比如 <code>location</code> → <code>a</code> 只省 7 个字符）。</p>
<p><strong>2.3 依赖分析</strong></p>
<p>找出变量之间的依赖关系，避免命名冲突。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span>;  <span class="hljs-comment">// b 可以重命名为 a，因为不在同一作用域</span>
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">return</span> a;
}
</code></pre>
<h5 data-id="heading-19">阶段 3：转换（Transform）</h5>
<p>这是真正做压缩的阶段，分多个步骤。</p>
<p><strong>3.1 删除死代码（Dead Code Elimination）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEBUG</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">DEBUG</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug'</span>);  <span class="hljs-comment">// 这段永远不会执行</span>
    }
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p><strong>3.2 常量折叠（Constant Folding）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_COUNT</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOUBLED</span> = <span class="hljs-variable constant_">MAX_COUNT</span> * <span class="hljs-number">2</span>;
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-variable constant_">DOUBLED</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">20</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>直接算出结果，减少运行时计算。</p>
<p><strong>3.3 表达式简化</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">if</span> (isActive === <span class="hljs-literal">true</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (isActive) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p><strong>3.4 变量名压缩（Mangle）</strong></p>
<p>这是我们关心的重点。</p>
<p>压缩器遍历 AST，按照一定规则替换标识符：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第一轮：函数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider → pv</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第二轮：参数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {  <span class="hljs-comment">// children → e</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第三轮：局部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {
    <span class="hljs-keyword">const</span> [t, n] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// location → t, setLocation → n</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">r</span> = (<span class="hljs-params">o</span>) =&gt; <span class="hljs-title function_">n</span>(o);         <span class="hljs-comment">// navigate → r, path → o</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location:</span> <span class="hljs-attr">t</span>, <span class="hljs-attr">navigate:</span> <span class="hljs-attr">r</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>注意：<strong>对象属性名不会改</strong>（<code>location:</code>、<code>navigate:</code> 保持原样），因为这些是对外的接口。</p>
<p><strong>3.5 作用域提升（Scope Hoisting）</strong></p>
<p>把多个模块合并到一个作用域，减少闭包和函数调用。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前（两个文件）</span>
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date</span>) { <span class="hljs-keyword">return</span> date.<span class="hljs-title function_">toString</span>(); }

<span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));

<span class="hljs-comment">// 压缩后（合并）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">b</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-title function_">toString</span>(); }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">a</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
</code></pre>
<h5 data-id="heading-20">阶段 4：生成（Generate）</h5>
<p>把修改后的 AST 转回代码字符串。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// AST 转回代码</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"pv"</span> },  <span class="hljs-comment">// 已被修改</span>
    <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"e"</span> }],
    <span class="hljs-attr">body</span>: { ... }
}

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">e</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>同时删除所有空格、换行、注释。</p>
<h4 data-id="heading-21">命名规则详解</h4>
<p>压缩器分配短名称时的优先级：</p>
<h5 data-id="heading-22">1. 单字母（52 个）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c, ..., z
<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>, C, ..., Z
</code></pre>
<p>最常用的标识符会优先分配这些。</p>
<h5 data-id="heading-23">2. 美元符号和下划线（104 个）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, ..., <span class="hljs-variable">$Z</span>
_a, _b, ..., _Z
</code></pre>
<p>单字母用完就加前缀。</p>
<h5 data-id="heading-24">3. 两个字母（2704 个）</h5>
<pre><code class="hljs">aa, ab, ac, ..., ZZ
</code></pre>
<p>再不够就用两个字母组合。</p>
<h5 data-id="heading-25">4. 特殊组合</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$,</span> _, <span class="hljs-variable">$$</span>, <span class="hljs-variable">$_</span>, ...
</code></pre>
<p>然后是各种特殊字符组合。</p>
<p>所以你看到的 <code>pv</code>、<code>$r</code>、<code>Jt</code> 都是按照这个顺序分配的。</p>
<h4 data-id="heading-26">真实例子对比</h4>
<p>拿一段完整的代码看看每个阶段的变化：</p>
<p><strong>原始代码</strong>（150 行，5 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavigationContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">NavigationContext.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>经过 Babel</strong>（转 JSX）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-title class_">NavigationContext</span>.<span class="hljs-property">Provider</span>,
        { <span class="hljs-attr">value</span>: value },
        children
    );
}
</code></pre>
<p><strong>经过 Terser 分析</strong>（内部记录）：</p>
<pre><code class="hljs language-diff" lang="diff">作用域分析：
<span class="hljs-deletion">- NavigationContext: 全局导出，不能改</span>
<span class="hljs-deletion">- NavigationProvider: 全局导出，不能改</span>
<span class="hljs-deletion">- children: 函数参数，可以改 → e</span>
<span class="hljs-deletion">- currentLocation: 局部变量，可以改 → t</span>
<span class="hljs-deletion">- setCurrentLocation: 局部变量，可以改 → n</span>
<span class="hljs-deletion">- navigate: 局部变量，可以改 → r</span>
<span class="hljs-deletion">- newPath: 函数参数，可以改 → o</span>
<span class="hljs-deletion">- value: 局部变量，可以改 → a（但会被内联优化掉）</span>
</code></pre>
<p><strong>经过 Terser 压缩</strong>（最终产物，1.5 KB）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>{useState <span class="hljs-keyword">as</span> t}<span class="hljs-keyword">from</span><span class="hljs-string">"react"</span>;<span class="hljs-keyword">const</span> n=<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[r,o]=<span class="hljs-title function_">t</span>(<span class="hljs-string">"/"</span>),c=<span class="hljs-function"><span class="hljs-params">i</span>=&gt;</span>{i!==r&amp;&amp;(<span class="hljs-title function_">o</span>(i),<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({},<span class="hljs-string">""</span>,i))};<span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(n.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:r,<span class="hljs-attr">navigate</span>:c}},e)}
</code></pre>
<p><strong>体积对比</strong>：</p>
<ul>
<li>原始代码：5 KB</li>
<li>Babel 转译后：5.2 KB（JSX 转换略有增加）</li>
<li>Terser 压缩后：1.5 KB（减少 70%）</li>
</ul>
<p>关键变化：</p>
<ol>
<li>删除所有空格和换行：<code>5KB → 4KB</code></li>
<li>变量名压缩：<code>4KB → 2KB</code></li>
<li>表达式简化和内联：<code>2KB → 1.5KB</code></li>
</ol>
<h4 data-id="heading-27">为什么这么激进</h4>
<p>现代 Web 应用动辄几百个组件，上千个函数。</p>
<p>如果不压缩函数名和变量名：</p>
<ul>
<li>平均每个函数名 15 字符</li>
<li>1000 个函数 = 15KB 仅用于命名</li>
<li>加上变量名，总共可能 50KB+</li>
</ul>
<p>50KB 在 3G 网络下，多加载 3-5 秒。</p>
<p>所以压缩器默认非常激进，能压缩的全压缩。</p>
<h3 data-id="heading-28">背后的原理</h3>
<h4 data-id="heading-29">函数名是怎么被替换的</h4>
<p>压缩器内部维护一个映射表：</p>
<pre><code class="hljs language-bash" lang="bash">原始名称 → 压缩后名称
NavigationProvider → pv
LocationProvider → <span class="hljs-variable">$r</span>
DialogPortal → Jt
Link → vv
</code></pre>
<p>规则很简单：</p>
<ol>
<li>按出现顺序分配短名称</li>
<li>优先用单字母（a-z, A-Z）</li>
<li>单字母用完就用两个字母（aa, ab, ...）</li>
<li>加上特殊字符（$, _）增加组合数</li>
</ol>
<p>所以你会看到 <code>a</code>、<code>$r</code>、<code>pv</code>、<code>Jt</code> 这种看起来毫无规律的名称。</p>
<h4 data-id="heading-30">React DevTools 怎么知道组件名</h4>
<p>React DevTools 获取组件名的逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[读取组件] --&gt; B{有 displayName?}
    B --&gt;|有| C[显示 displayName]
    B --&gt;|没有| D{有函数名?}
    D --&gt;|有| E[显示函数名]
    D --&gt;|没有| F[显示 Anonymous]
</code></pre>
<p>优先级：<code>displayName</code> &gt; <code>函数名</code> &gt; <code>"Anonymous"</code></p>
<p>开发环境：</p>
<ul>
<li>函数名完整保留 → DevTools 读到 <code>NavigationProvider</code></li>
</ul>
<p>生产环境：</p>
<ul>
<li>函数名被压缩成 <code>pv</code> → DevTools 只能读到 <code>pv</code></li>
<li>没设置 <code>displayName</code> → 没有备用方案</li>
</ul>
<p>所以就出现了开头那张图的情况。</p>
<h3 data-id="heading-31">为什么不是所有组件都乱码</h3>
<p>你可能注意到，有些组件名还是正常的，比如 <code>Link</code>、<code>Menu</code>、<code>Dialog</code>。</p>
<p>原因有三种：</p>
<h4 data-id="heading-32">1. 组件设置了 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-title class_">MyComponent</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'MyComponent'</span>;
</code></pre>
<p>压缩器不会改 <code>displayName</code>（它是字符串，不是标识符）。</p>
<h4 data-id="heading-33">2. 组件来自第三方库</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material'</span>;
</code></pre>
<p>第三方库通常会设置 <code>displayName</code>，或者配置了保留函数名的构建选项。</p>
<h4 data-id="heading-34">3. 名称太短，碰巧没变</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Link</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>如果原本就叫 <code>Link</code>，压缩后可能还是 <code>Link</code>（4 个字符，不一定值得压缩）。</p>
<p>但这纯靠运气，不能依赖。</p>
<h3 data-id="heading-35">怎么解决</h3>
<p>核心思路就两个方向：</p>
<h4 data-id="heading-36">1. 告诉压缩器：别改函数名</h4>
<p>Webpack/Vite 配置中，设置 Terser 选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">terserOptions</span>: {
    <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 保留函数名</span>
}
</code></pre>
<p>代价：包体积增加 5-10%。</p>
<h4 data-id="heading-37">2. 手动给组件加 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">NavigationProvider</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
};

<span class="hljs-title class_">NavigationProvider</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'Navigation.Provider'</span>;
</code></pre>
<p>好处：精确控制，体积影响小。
代价：要手动维护。</p>
<h3 data-id="heading-38">该不该解决</h3>
<p><strong>内部系统/管理后台</strong>：</p>
<ul>
<li>调试需求高，体积不敏感</li>
<li>建议保留函数名，调试体验直接拉满</li>
</ul>
<p><strong>面向用户的产品</strong>：</p>
<ul>
<li>体积影响加载速度，调试主要在开发环境</li>
<li>不用管，或者只给核心组件加 displayName</li>
</ul>
<p><strong>开源组件库</strong>：</p>
<ul>
<li>用户调试需要清晰的组件名</li>
<li>建议加 displayName，或构建时保留函数名</li>
</ul>
<p>大多数情况，这不是个必须解决的问题。线上调试本来就该在 staging 环境（保留函数名），生产环境靠日志和监控。</p>
<h3 data-id="heading-39">相关资料</h3>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fterser.org%2Fdocs%2Foptions%2F" target="_blank" title="https://terser.org/docs/options/" ref="nofollow noopener noreferrer">Terser 文档</a></strong> - 了解 <code>keep_fnames</code> 等配置</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Freact-developer-tools%23why-is-my-component-called-_c" target="_blank" title="https://react.dev/learn/react-developer-tools#why-is-my-component-called-_c" ref="nofollow noopener noreferrer">React 官方：为什么我的组件叫 <code>_c</code>？</a></strong> - React 文档的解释</li>
</ol>
<hr/>
<p>搞清楚原理就好办了。遇到这种情况，知道是代码压缩导致的，而不是 React 或 DevTools 的 bug。</p>
<p>要不要解决，看具体需求。大部分时候，不用管。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java内存泄漏问题排查和JVM调优]]></title>    <link>https://juejin.cn/post/7572016447804309530</link>    <guid>https://juejin.cn/post/7572016447804309530</guid>    <pubDate>2025-11-13T09:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804309530" data-draft-id="7571840220703932462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java内存泄漏问题排查和JVM调优"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-13T09:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海边捡石子"/> <meta itemprop="url" content="https://juejin.cn/user/2335828265144488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java内存泄漏问题排查和JVM调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335828265144488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    海边捡石子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:07:34.000Z" title="Thu Nov 13 2025 09:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java语言本身支持垃圾自动回收，在日常编程中我们几乎没有关注过对象回收的问题。解决内存泄漏可能停留在八股文上。今天分享一次项目中内存泄漏的排查流程到最终解决。</p>
<h2 data-id="heading-0">java自带了强大的命令行工具</h2>





























<table><thead><tr><th>工具</th><th>核心功能</th><th>主要应用场景</th><th>关键命令/示例</th></tr></thead><tbody><tr><td>**<code>jcmd</code>**​</td><td><strong>多功能诊断</strong>：一个强大的“瑞士军刀”，可执行丰富的诊断命令，涵盖JVM状态查询、内存、线程、GC控制等。</td><td><strong>综合诊断与运维</strong>：获取完整JVM信息（参数、属性）、动态控制（触发GC、开启JFR）、生成线程/堆转储。</td><td><code>jcmd &lt;pid&gt; VM.flags</code>（查看JVM参数） <code>jcmd &lt;pid&gt; Thread.print</code>（生成线程转储） <code>jcmd &lt;pid&gt; GC.heap_dump</code>（生成堆转储）</td></tr><tr><td>**<code>jmap</code>**​</td><td><strong>堆内存分析</strong>：专用于Java堆内存（Heap Memory）的直方图统计和堆转储（Heap Dump）文件生成。</td><td><strong>深度内存分析</strong>：排查内存泄漏、分析堆内对象分布、生成堆转储文件供MAT等工具深度分析。</td><td><code>jmap -histo:live &lt;pid&gt;</code>（存活对象直方图） <code>jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;</code>（生成堆转储）</td></tr><tr><td>**<code>jstat</code>**​</td><td><strong>JVM统计监控</strong>：持续监控JVM各种运行时指标，特别是垃圾回收（GC）相关数据和类加载信息。</td><td><strong>实时性能监控</strong>：监控GC行为（频率、耗时）、各内存区使用率、类加载/卸载情况，用于性能调优。</td><td><code>jstat -gcutil &lt;pid&gt; &lt;interval&gt; &lt;count&gt;</code>（GC情况摘要） <code>jstat -gc &lt;pid&gt; 1000 5</code>（GC详情，每秒1次共5次）</td></tr></tbody></table>
<h2 data-id="heading-1">Java垃圾回收算法</h2>
<p>Java垃圾回收算法，分代垃圾回收算法</p>
<ul>
<li>新生代：复制算法</li>
<li>老年代：标记-清除算法和标记-整理算法</li>
</ul>
<h2 data-id="heading-2">排查思路</h2>
<p>在解决问题的时候，先了解下我们项目JVM参数信息.</p>
<pre><code class="hljs language-js" lang="js">jcmd &lt;pid&gt; <span class="hljs-variable constant_">VM</span>.<span class="hljs-property">flags</span>
-<span class="hljs-attr">XX</span>:<span class="hljs-title class_">CICompilerCount</span>=<span class="hljs-number">15</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">InitialHeapSize</span>=<span class="hljs-number">1031798784</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxHeapSize</span>=<span class="hljs-number">16489906176</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxNewSize</span>=<span class="hljs-number">5496635392</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MinHeapDeltaBytes</span>=<span class="hljs-number">524288</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">NewSize</span>=<span class="hljs-number">343932928</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">OldSize</span>=<span class="hljs-number">687865856</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedClassPointers</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedOops</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseFastUnorderedTimeStamps</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseParallelGC</span>
</code></pre>
<h3 data-id="heading-3">第一种情况：</h3>
<p>项目运行在linux服务器上，进行压测，内存以肉眼可见的速度上升。
使用top命令查看进程占用内存情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e250f8b1505a49a49810f612f3d92c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=%2FJ4wiiHRmvzt6DxAYpOWoPWq4Zc%3D" alt="image.png" loading="lazy"/>
这里主要关注下<strong>RES</strong>
进程当前实际使用的、未被换出到交换空间（swap out）的<strong>物理内存</strong>。包含堆内存、非堆内存、堆外内存等。如果RES值持续上升，堆内存保持稳定，说明堆外内存在上升。</p>
<p>这个时候开始考虑使用jmap获取堆转存储。分析那些对象产生的泄漏。</p>
<h3 data-id="heading-4">常见的内存泄漏，</h3>
<p>HashMap 、队列、线程池、websocket等资源没有正确的释放，另外一种是我们的程序调用了native方法，但没有释放资源。</p>
<p>发现泄漏后，最直接的办法生成jvm对象快照。生成<strong>堆转储</strong>文件，</p>
<h3 data-id="heading-5">内存分析工具</h3>
<p><strong>MAT（Memory Analyzer Tool）</strong> ：最常用的堆分析工具，支持自动检测泄漏嫌疑人（Leak Suspects）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1572a88c2cef490da539753a84cf3faa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=1OtTQoTTSvKkemUrH5oeiqaNbWc%3D" alt="image.png" loading="lazy"/>
泄漏嫌疑直接能看到使用websocket相关操作导致的</p>
<h5 data-id="heading-6">关键分析步骤：</h5>
<ol>
<li>
<p><strong>识别 “可疑大对象”</strong> ：</p>
<ul>
<li>在 MAT 中查看 “Histogram”（直方图），按 “Retained Heap”（对象被回收后可释放的内存）排序，找出占用内存前几名的类（如某业务 POJO、集合类）。</li>
<li>关注 “Shallow Heap”（对象本身大小）小但 “Retained Heap” 大的对象（通常是集合，持有大量子对象引用）。</li>
</ul>
</li>
<li>
<p><strong>追溯引用链（支配树 / 引用树）</strong> ：</p>
<ul>
<li>对可疑对象右键选择 “Merge Shortest Paths to GC Roots”（排除弱引用 / 软引用等可被 GC 自动回收的引用类型），查看谁在 “强引用” 该对象。</li>
<li>核心是找到 “根对象”（如静态变量、线程对象、类加载器），这些对象不会被 GC 回收，若其引用链中包含本应释放的对象，则导致泄漏。</li>
</ul>
<p>例：若发现大量<code>User</code>对象被<code>HashMap</code>持有，且<code>HashMap</code>是<code>UserCache</code>类的静态变量，而<code>UserCache</code>未设置过期清理逻辑，则可定位为 “静态缓存未释放” 导致的泄漏。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结]]></title>    <link>https://juejin.cn/post/7572021695293571122</link>    <guid>https://juejin.cn/post/7572021695293571122</guid>    <pubDate>2025-11-13T08:53:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293571122" data-draft-id="7571726099689062419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结"/> <meta itemprop="keywords" content="MongoDB"/> <meta itemprop="datePublished" content="2025-11-13T08:53:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:53:47.000Z" title="Thu Nov 13 2025 08:53:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<p>在前端转型全栈的过程中，我们多数情况下使用 node.js 来开发服务端，而 node.js 里操作MongoDB数据库最常用的库是 mongoose，所以 mongosh 在实际开发中的使用频率并不是很高，多用于测试或查看数据库状态等场景。</p>
<p>本章只讲述 Mongosh 一些常用命令，例如：数据库基本的增、删、改、查（CRUD）和状态信息获取等操作，能够满足我们日常开发使用即可。</p>
<h3 data-id="heading-1">1.连接数据库</h3>
<p><strong>1.1 本地连接数据库</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">mongosh --dbpath <span class="hljs-string">"path/data"</span>
</code></pre>
<p><strong>1.2 远程连接数据库</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://192.168.0.0:27017"</code></p>
<p><strong>1.3 远程连接数据库并使用用户名密码验证</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>@<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://admin:admin123@192.168.0.0:27017"</code></p>
<h3 data-id="heading-2">2.查看数据库状态</h3>
<p><strong>2.1 查看当前使用的数据库</strong></p>
<pre><code class="hljs">db
</code></pre>
<ul>
<li><strong>切换数据库</strong></li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">use</span> &lt;database_name&gt;
</code></pre>
<p>举例：<code>use admin</code></p>
<p>如果切换的数据库名称当前不存在，则会在 <code>insert</code> 插入数据时自动创建</p>
<blockquote>
<p>注意：是插入数据时创建，而不是使用 <code>use</code> 切换时创建。</p>
</blockquote>
<p><strong>2.2 列出MongoDB实例下所有的数据库</strong></p>
<p><code>show databases</code> 可以查看目前所有的数据库，也可以使用简写 <code>show dbs</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> databases
</code></pre>
<p><strong>2.3 列出当前数据库下所有集合</strong></p>
<p>理论上每个数据库下都可以包含一个或多个集合，它有点类似于我们传统关系型数据库中的 <code>表</code> 的概念。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> collections
</code></pre>
<p><strong>2.4 退出 mongosh</strong></p>
<p>使用 <code>exit</code> 可以直接退出mongosh数据库连接，也可以使用 <code>ctrl + c</code> 快捷键来退出</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exit</span>
</code></pre>
<h3 data-id="heading-3">3.数据库的增删改查</h3>
<p><strong>3.1 插入数据</strong></p>
<p>使用 <code>insertOne</code> 插入一条数据，使用 <code>insertMany</code> 插入多条数据，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 插入一条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Mike"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> })

<span class="hljs-comment">// 插入多条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertMany</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">"Marry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Kerry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> }])
</code></pre>
<p><strong>3.2 删除数据</strong></p>
<p>使用 <code>deleteOne</code> 删除单个文档，使用 <code>deleteMany</code> 删除多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 删除单个文档</span>
db.user.<span class="hljs-title function_ invoke__">deleteOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> })

<span class="hljs-comment">// 删除年龄30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">deleteMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.3 更新数据</strong></p>
<p>使用 <code>updateOne</code> 更新单个文档，使用 <code>updateMany</code> 更新多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 更新单个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> } })

<span class="hljs-comment">// 更新多个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"young"</span> } })
</code></pre>
<p><strong>3.4 查询数据</strong></p>
<p>使用 <code>find</code> 查询集合中所有数据</p>
<pre><code class="hljs language-lua" lang="lua">db.user.<span class="hljs-built_in">find</span>()
</code></pre>
<p>查询某个条件的文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 查询30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">find</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$gte</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.5 创建索引</strong></p>
<p>为某个字段创建索引</p>
<pre><code class="hljs language-css" lang="css">db<span class="hljs-selector-class">.user</span><span class="hljs-selector-class">.createIndex</span>({ name: <span class="hljs-number">1</span> })
</code></pre>
<p><strong>3.6 查看当前集合下的所有索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">db<span class="hljs-selector-class">.users</span><span class="hljs-selector-class">.getIndexes</span>()
</code></pre>
<p>执行上述代码通常会返回两个索引，<code>_id</code> 和 <code>name</code></p>
<p><code>_id</code> 索引：是自动创建，用于确保每条数据的唯一性。</p>
<p><code>name</code> 索引：自定义索引，方便对指定字段的查询操作，例如 <code>name: 1</code> 表示按升序排列，如果改为 <code>name: -1</code> 表示降序。</p>
<h3 data-id="heading-4">4.其它命令</h3>

















<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>version()</td><td>查看当前使用 <code>mongosh</code> 的版本</td></tr><tr><td>help</td><td>查看 <code>mongosh</code> 的帮助信息, 查看某个命令的帮助信息，<code>&lt;name&gt;.help()</code>, 例如：db.help()</td></tr></tbody></table>
<h3 data-id="heading-5">写在最后</h3>
<hr/>
<p>本章整理了 <code>mongosh</code> 中一些常用命令，方便大家在日常使用中参考。虽然 <code>mongosh</code> 功能强大，但像 <strong>聚合查询</strong>等更贴近业务场景的功能，我通常会通过 <code>mongoose</code> 来实现。接下来，我将继续编写关于 <code>node.js + mongoose</code> 的使用教程，并与大家分享更多实践经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android http网络请求的那些事儿]]></title>    <link>https://juejin.cn/post/7572132100326441010</link>    <guid>https://juejin.cn/post/7572132100326441010</guid>    <pubDate>2025-11-13T08:59:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326441010" data-draft-id="7572016447804080154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android http网络请求的那些事儿"/> <meta itemprop="keywords" content="OKHttp,HTTP"/> <meta itemprop="datePublished" content="2025-11-13T08:59:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天花板之恋"/> <meta itemprop="url" content="https://juejin.cn/user/2027980375463565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android http网络请求的那些事儿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2027980375463565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天花板之恋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:59:51.000Z" title="Thu Nov 13 2025 08:59:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.http协议</h3>
<p>http协议通常是基于<code>TCP/IT</code>协议之上的应用层协议，http默认端口是<code>80</code>，https默认端口是<code>443</code>。</p>
<p>http协议是无状态的协议，基于请求/响应的模型，先有请求，再有响应。</p>
<p>http请求报文包括：请求行、请求头、请求体</p>
<p>http响应报文包括：响应行、响应头、响应体</p>
<h3 data-id="heading-1">2.http请求报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1061d774eb6442d860799c0d7ffd8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=0vzUkq1wpQuA8XbiHtxi4XcDFXc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>请求行</strong>：
主要包括请求方式以及请求目标的<code>URL</code>
例如：<em>POST /chapter17/user.html HTTP/1.1</em></p>
<p><code>POST</code>代表请求方式， <code>/chapter17/user.html</code>表示请求的URL</p>
</li>
<li>
<p><strong>请求头</strong>：
包含一些key-value值，主要包括Cookie值、请求体的数据类型、请求体的数据长度等例如：</p>
<p>Content-Type: application/x-www-form-urlencoded</p>
<p>Content-Length: 37</p>
<p>Cookie: token_pass=92595c118b66417c395eb125e12c3438</p>
</li>
<li>
<p><strong>请求体</strong>：
具体的数据，比如登陆时候的用户名和密码：
username=gandalf&amp;password=19920930yus</p>
</li>
</ul>
<h3 data-id="heading-2">3.http不同请求方式</h3>
<p>请求方式有多种，常见的有<code>GET</code>、<code>POST</code>和<code>HEAD</code></p>
<ul>
<li>
<p><strong>GET请求</strong>：
GET请求没有请求体，会把参数直接加在URL后面，不安全，并且有长度限制。
但请求简单，是HTTP请求中使用最多的方式。</p>
</li>
<li>
<p><strong>POST请求</strong>：
请求的参数在请求头内，较安全，且数据大小没有限制，适合提交较大的表单数据。</p>
</li>
<li>
<p><strong>HEAD请求</strong>：
跟GET相似，只是服务器只会返回响应头，通常只为了查询某个页面的状态。</p>
</li>
</ul>
<h3 data-id="heading-3">4.http响应报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71acc7d6843640139ef47c383ba9ac62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=pkD6QZdS8M1WokSvDtdmnevwSYA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>响应行</strong>：
主要包含状态码</p>
<p>1xx:指示信息，表示请求已接收，继续处理</p>
<p>2xx:成功，表示请求已被成功接受</p>
<p>3xx:重定向</p>
<p>4xx:客户端错误</p>
<p>5xx:服务器端错误</p>
</li>
<li>
<p><strong>响应头</strong>：
包含多个<code>key-value</code>对，主要包括：<code>Content-Type</code>响应正文的类型（MIME类型）、Set-Cookie 于会话状态相关的<code>Cookie</code>技术</p>
</li>
<li>
<p><strong>响应体</strong>：
数据内容，常用的如<code>json</code>纯文本内容、图片数据等</p>
</li>
</ul>
<h3 data-id="heading-4">5.https协议</h3>
<p>由于<code>http</code>是明文传输，信息容易被篡改和窃取，所以增加了<code>https</code>协议。</p>
<p>https协议是在http协议的基础上，对报文做了对称加密的处理，并且加密密钥只会在客户端和服务端保存，保证了信息的安全。</p>
<p>https协议的前提，是需要有一个公正权威的机构，叫<code>CA</code>机构，它内部维护了一套非对称加密的<code>公钥P</code>和<code>私钥P'</code>，公钥P会发布出来，浏览器会内置这个公钥。</p>
<p>一个网站如果要使用https协议，需要先在CA申请数字证书。</p>
<h3 data-id="heading-5">6.https协议加密过程</h3>
<p>前置条件完毕，接下来看具体的步骤：</p>
<ol>
<li>首先网站有一对<code>公钥P1</code>和<code>私钥P1’</code>，然后把包含网站公钥P1、域名等信息的数据Data提供给CA机构。</li>
<li>CA对Data做<code>Hash</code>算法得到一段<code>散列码H</code>；用P'对H做加密得到数字<code>签名S</code>；把S和Data数据打包一起就是数字证书，给到网站。</li>
<li>客户端和服务端建立http连接之后，服务端会把数字证书发给客户端。客户端会得到数字签名S和原始数据Data，然后使用CA的公钥P对S解密得到<code>散列码H</code>。</li>
<li>客户端会对Data做同样的hash算法得到<code>散列码H'</code>，判断H'和H是否相等，如果相等，则表示<code>公钥P1</code>是可信的。</li>
<li>客户端会针对此次对话随机生成一个对称加密密钥<code>SK</code>，并使用P1对SK信息做加密，传递给服务器。</li>
<li>服务器在收到客户端数据后，使用自己的私钥P1'做解码，获取到了本次的SK，并开始做加密通信。</li>
</ol>
<p>流程图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d62b7b541547e49296152044c889be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=ho94erorHsoj7cYkbMIwBz5M7Fc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>关键点补充</strong>：
CA的存在是为了保证客户端判断来自服务器公钥的可靠性。
前期非对称加密的一系列动作，是为了保证最后对称加密的密钥不能被第三方获取。
最后通信数据使用对称加密（<code>AES）</code>，是因为非对称加密很耗性能，而对称加密效率更高。</li>
</ul>
<h3 data-id="heading-6">7.Cookie</h3>
<p>由于<code>http/https</code>是没有状态的协议，整个过程是请求/应答模式，而有些数据的请求是需要有状态的，比如：
请求收藏列表数据，那么肯定是需要先登陆才行，否则就会提示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{<span class="hljs-string">"errorCode"</span>:-<span class="hljs-number">1001</span>,<span class="hljs-string">"errorMsg"</span>:<span class="hljs-string">"请先登录！"</span>}
</code></pre>
<p>因此引入了<code>Cookie</code>技术。</p>
<p>首先服务端会在响应头中带有<code>Set-Cookie </code>字段的数据，当客户端解析到这样的响应头数据时，就可以把这些数据保存在本地。</p>
<p>当客户端下次要发起请求的时候，就可以把这些Cookie写入到请求头中，这样服务端就可以清楚状态并返回正确的数据了。</p>
<p>比如我们登陆了WanAndroid账号之后，服务端返回的响应报文头包含：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Set-Cookie: JSESSIONID=354B46332F155D0823934D17025C01CB; Path=/; Secure; HttpOnly
Set-Cookie: loginUserName=gandalf; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass=92595c118b66417c395eb125e12c3438; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: loginUserName_wanandroid_com=gandalf; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass_wanandroid_com=92595c118b66417c395eb125e12c3438; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
</code></pre>
<p>当我们请求收藏数据的时候，就需要把以上的Cookie信息带上，这样就会获取到收藏列表数据了，否则就会提示“请先登录！”。</p>
<h3 data-id="heading-7">8.OkHttp</h3>
<p>Android使用http网络协议的利器，它负责处理<code>HTTP/1.1</code>、<code>HTTP/2</code>、<code>SPDY</code>的请求和响应，可以理解为一个装备精良的“快递员”。</p>
<p>OkHttp 负责处理所有网络通信的底层脏活累活：</p>
<ul>
<li>通过连接池 <code>ConnectionPool</code>，高效地复用 <code>TCP </code>连接；</li>
<li><code>socket</code>自动选择最好路线，并支持自动重连；</li>
<li>拥有队列线程池，轻松写并发，支持同步和异步两种请求方式；</li>
<li>拥有强大的拦截器机制（<code>interceptors</code>），可以轻松修改请求报文和响应报文，比如统一修改请求头、日志记录、加解密、Cookie缓存等。</li>
</ul>
<h3 data-id="heading-8">9.OkHttp的执行流程</h3>
<ol>
<li>首先需要构造一个<code>OkHttpClient</code>客户端，并且在客户端配置相关的拦截器和监听器，以便扩展自定义的操作。</li>
<li>构建<code>Request</code>请求类，包含<code>URL</code>、<code>Post</code>参数等信息。</li>
<li>然后通过OkHttpClient客户端去构建一个<code>Call</code>类型的对象，代表一次请求。Call有两个方法，一个方法是<code>execute（）</code>，表示同步执行请求；
另一个方法是<code>enqueue（）</code>，表示把请求加入队列，实际会进入到Dispatcher的<code>runningAsyncCalls</code>这样的一个队列，并等待异步执行。</li>
<li>不管是同步执行还是异步执行，在执行的时候，都会先构建一个拦截器链（<code>RealInterceptorChain</code>），它会add很多默认的或者我们自定义的拦截器。</li>
<li>一个拦截器执行完之后，会调用下一个拦截器，直到调用到最后一个<code>CallServiceInterceptor</code>并返回一个<code>Response</code>。</li>
</ol>
<h3 data-id="heading-9">10.OkHttp使用示例</h3>
<p>只使用OkHttp的情况下，如果我们要发起一次登陆请求，则代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建客户端</span>
<span class="hljs-keyword">val</span> client = OkHttpClient()

<span class="hljs-comment">// 2. 手动构建请求 (URL, 请求头, 请求体)</span>
<span class="hljs-keyword">val</span> requestBody = FormBody.Builder()
    .add(<span class="hljs-string">"username"</span>, <span class="hljs-string">"gandalf"</span>)
    .add(<span class="hljs-string">"password"</span>, <span class="hljs-string">"1234567"</span>)
    .build()

<span class="hljs-keyword">val</span> request = Request.Builder()
    .url(<span class="hljs-string">"https://api.example.com/login"</span>)
    .post(requestBody)
    .build()


<span class="hljs-comment">// 3. 发起异步请求，并手动处理回调</span>
client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
        <span class="hljs-comment">// 处理网络失败</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
        <span class="hljs-comment">// 在子线程中</span>
        <span class="hljs-keyword">val</span> responseBodyString = response.body?.string()
        <span class="hljs-comment">// 4. 手动解析 JSON 字符串</span>
        <span class="hljs-keyword">val</span> user = Gson().fromJson(responseBodyString, User::<span class="hljs-keyword">class</span>.java)
        <span class="hljs-comment">// 5. 手动切换回主线程更新 UI</span>
    }
})
</code></pre>
<p>这里创建的OkHttpClient客户端是最简单的方式，如果想要添加其他配置项，比如<code>Cookie</code>的操作、<code>http日志</code>打印操作等，就需要在这里做配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> intercepter = HttpLoggingInterceptor().apply {
        level = HttpLoggingInterceptor.Level.BODY
    }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> okhttpClient = OkHttpClient.Builder()
        .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)   <span class="hljs-comment">// 读超时时间</span>
        .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)  <span class="hljs-comment">// 写超时时间</span>
        .connectTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS) <span class="hljs-comment">//连接超时时间</span>
        .addInterceptor(intercepter)  <span class="hljs-comment">// 添加日志打印的拦截器</span>
	.cookieJar(MyCookieJar()) <span class="hljs-comment">//添加Cookie操作</span>
        .build()
</code></pre>
<p>这里实现了CookieJar接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCookieJar</span> : <span class="hljs-type">CookieJar</span> {
    <span class="hljs-comment">//Http发送请求前回调，Request中设置Cookie</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadForRequest</span><span class="hljs-params">(url: <span class="hljs-type">HttpUrl</span>)</span></span>: List&lt;Cookie&gt; {
        <span class="hljs-keyword">val</span> cookieList = mutableListOf&lt;Cookie&gt;()
        CookieManager.getInstance().getCookie(url.host)?.let {
            <span class="hljs-keyword">if</span> (it.isNotEmpty()) {
                <span class="hljs-keyword">val</span> cookies = it.split(<span class="hljs-string">";"</span>.toRegex())
                <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
                    Cookie.parse(url, cookie)?.apply {
                        cookieList.add(<span class="hljs-keyword">this</span>)
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> cookieList
    }


    <span class="hljs-comment">//Http请求结束，Response中有Cookie时候回调，并在回调中实现Cookie的保存</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveFromResponse</span><span class="hljs-params">(
        url: <span class="hljs-type">HttpUrl</span>,
        cookies: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Cookie</span>&gt;
    )</span></span> {
        <span class="hljs-keyword">val</span> cookieManager = CookieManager.getInstance()
        cookieManager.setAcceptCookie(<span class="hljs-literal">true</span>)
        <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
            cookieManager.setCookie(url.toString(), cookie.toString())
        }
        cookieManager.flush()
    }
}
</code></pre>
<h3 data-id="heading-10">11. Retrofit</h3>
<p><code>Retrofit</code>是一种更高层级的封装，它让开发者更容易去描述“做什么”。而它自己会把这些业务层的逻辑转换成OkHttp能够识别的指令，具体“怎么做”的事情，就交给OkHttp去完成。</p>
<p>Retrofit的优势有如下几点：</p>
<ol>
<li><strong>API接口化</strong>：使用简单的Interface接口来定义一组业务关系API。</li>
<li><strong>注解驱动</strong>：通过 <code>@GET``````@POST</code>, <code>@Path</code>, <code>@Query</code>, <code>@Body </code>等注解，你可以清晰地描述每个请求的 URL、HTTP 方法、参数和请求体</li>
<li><strong>序列化/反序列化</strong>：通过可自由配置的转换器（<code>Converter</code>），如<code>retrofit2:converter-gson</code>，自动将 对象转换成请求体JSON，以及将响应体JSON自动转换成定义好的数据模型对象（Data Class）。</li>
<li><strong>适配协程</strong>：能将标准的网络调用无缝集成到协程框架中</li>
</ol>
<p>基本使用方式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 在接口中声明 API</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@POST(<span class="hljs-string">"login"</span>)</span>
    <span class="hljs-meta">@FormUrlEncoded</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@Field(<span class="hljs-string">"username"</span>)</span> username: <span class="hljs-type">String</span>)</span></span>: User
}

<span class="hljs-comment">// 2. 创建 Retrofit 实例 (它内部会持有并使用一个 OkHttpClient)</span>
<span class="hljs-keyword">val</span> retrofit = Retrofit.Builder()
    .baseUrl(<span class="hljs-string">"https://api.example.com/"</span>)
    .client(myOkHttpClient) <span class="hljs-comment">// 把 OkHttp 引擎装进去</span>
    .addConverterFactory(GsonConverterFactory.create())
    .build()

<span class="hljs-keyword">val</span> apiService = retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)

<span class="hljs-comment">// 3. 在协程中像调用本地方法一样调用 API</span>
viewModelScope.launch {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> user = apiService.login(<span class="hljs-string">"test"</span>)  <span class="hljs-comment">// 直接得到 User 对象，不用关心 JSON 解析和线程切换</span>
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 统一处理所有错误</span>
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么要使用 .asStateFlow() 而不是直接赋值？]]></title>    <link>https://juejin.cn/post/7572132100326539314</link>    <guid>https://juejin.cn/post/7572132100326539314</guid>    <pubDate>2025-11-13T09:18:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326539314" data-draft-id="7572130072262524974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么要使用 .asStateFlow() 而不是直接赋值？"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2025-11-13T09:18:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="默契之行"/> <meta itemprop="url" content="https://juejin.cn/user/3825956197501854"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么要使用 .asStateFlow() 而不是直接赋值？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956197501854/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    默契之行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:18:34.000Z" title="Thu Nov 13 2025 09:18:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>记录开发过程中疑问，如果说的不对，欢迎提出修改</p>
<p>这里我使用了两个<code>MutableStateFlow</code>和两个<code>StateFlow</code>做说明，其中strList是由<code>_strList.asStateFlow()</code>赋值，而<code>str2List</code>由<code>_strList</code>直接赋值。这两种在代码运行都能正常运行，这也是为什么我对此有疑问，从而做下笔记梳理</p>
</blockquote>
<h3 data-id="heading-0">示例代码及运行结果</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _strList = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>))
<span class="hljs-keyword">val</span> strList: StateFlow&lt;List&lt;String&gt;&gt; = _strList.asStateFlow()

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _str2List = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>))
<span class="hljs-keyword">val</span> str2List: StateFlow&lt;List&lt;String&gt;&gt; = _str2List

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testAsStateFlow</span><span class="hljs-params">()</span></span> = runTest {
    launch {
        strList.collect { println(<span class="hljs-string">"strList 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>) 
        (strList <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
    }
    launch {
        str2List.collect { println(<span class="hljs-string">"str2List 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>)
        (str2List <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>)
    }
}
</code></pre>
<p>下面是运行结果，可以看出通过.<code>asStateFlow</code>() 赋值的<code>strList</code> 无法直接通过<code>asStateFlow</code>转换从而修改参数,而<code>str2List</code>却可以</p>
<p><strong>strList 收到新值: [A, B, C]</strong></p>
<p><strong>str2List 收到新值: [X, Y, Z]</strong></p>
<p><strong>str2List 收到新值: [A, X, Y, Z]</strong></p>
<h3 data-id="heading-1">1. 什么是 <code>MutableStateFlow</code> 和 <code>StateFlow</code>？</h3>
<ul>
<li><code>MutableStateFlow</code> 是一种可变的状态流，它允许我们通过 <code>value</code> 属性修改流中的状态。</li>
<li><code>StateFlow</code> 是一种不可变的状态流，它只暴露给外部读取状态的能力，而不能修改状态。</li>
</ul>
<p>通常，在封装状态时，我们将 <code>MutableStateFlow</code> 定义为私有属性（例如 <code>_strList</code>），而将其暴露为不可变的 <code>StateFlow</code>（例如 <code>strList</code>），这样外部代码只能读取状态，而无法修改它。</p>
<h3 data-id="heading-2">2. 为什么不建议直接赋值？</h3>
<p>在上述代码中，如果直接将 <code>_strList</code> 或 <code>_str2List</code> 作为 <code>StateFlow</code> 来暴露，会导致外部代码可以通过强制转换或直接访问 <code>_strList</code> 或 <code>_str2List</code> 来修改其值。这样可能会破坏状态的不可变性，导致不可预测的副作用或状态变更。</p>
<p>例如，在以下代码中，尝试直接修改 <code>strList</code> 的值：</p>
<pre><code class="hljs language-ini" lang="ini">(strList as? MutableStateFlow)?.<span class="hljs-attr">value</span> = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
</code></pre>
<p>虽然 <code>strList</code> 是 <code>StateFlow</code> 类型，它不能直接修改，但通过强制转换为 <code>MutableStateFlow</code> 类型，代码可以绕过不可变性并直接修改 <code>value</code> 属性。这违背了状态不可变性的设计原则，容易导致不可控的状态更改。</p>
<h3 data-id="heading-3">3. <code>asStateFlow</code> 的作用</h3>
<p>使用 <code>asStateFlow()</code> 方法可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>。这样，外部代码只能读取状态，而无法修改它。通过这种方式，我们可以确保状态的不可变性并防止外部代码直接更改状态。</p>
<pre><code class="hljs language-swift" lang="swift">val strList: <span class="hljs-type">StateFlow</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;&gt; <span class="hljs-operator">=</span> _strList.asStateFlow()
</code></pre>
<p>这样，外部代码只能使用 <code>strList.collect { ... }</code> 来收集状态的变化，而不能修改 <code>strList</code> 的值。这使得状态管理更加安全和可控。</p>
<h3 data-id="heading-4">4. 总结</h3>
<ul>
<li><code>MutableStateFlow</code> 提供了修改状态的能力，而 <code>StateFlow</code> 只允许读取状态。</li>
<li>使用 <code>asStateFlow()</code> 可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>，从而保护状态不被外部代码直接修改。</li>
<li>通过这种方式，我们可以确保状态的不可变性，减少副作用，使代码更加健壮和可维护。</li>
</ul>
<h3 data-id="heading-5">5.延伸问题：为什么要使用 <code>asSharedFlow</code>？</h3>
<p>类似于 <code>StateFlow</code>，<code>SharedFlow</code> 也有可变和不可变的版本。<code>MutableSharedFlow</code> 允许外部代码通过 <code>emit()</code> 向流中发送事件，而 <code>SharedFlow</code> 则是一个只读流，只能被外部代码订阅和收集，不能直接修改流中的内容。</p>
<p>为了确保流的不可变性，应该使用 <code>asSharedFlow()</code> 方法将 <code>MutableSharedFlow</code> 转换为不可变的 <code>SharedFlow</code>。这样，外部代码只能订阅事件流，而不能通过 <code>emit()</code> 向流中发送事件，避免了意外修改流内容的副作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用awesome-digital-human-live2d创建属于自己的数字人]]></title>    <link>https://juejin.cn/post/7572016447804325914</link>    <guid>https://juejin.cn/post/7572016447804325914</guid>    <pubDate>2025-11-13T09:16:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804325914" data-draft-id="7571892340878458918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用awesome-digital-human-live2d创建属于自己的数字人"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T09:16:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suzumiyahr"/> <meta itemprop="url" content="https://juejin.cn/user/248966809390851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用awesome-digital-human-live2d创建属于自己的数字人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/248966809390851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suzumiyahr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:16:11.000Z" title="Thu Nov 13 2025 09:16:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.AWESOME-DIGITAL-HUMAN是什么</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FGitHub_Trending%2Faw%2Fawesome-digital-human-live2d%2Fblob%2Fmain%2FREADME.md" target="_blank" title="https://gitcode.com/GitHub_Trending/aw/awesome-digital-human-live2d/blob/main/README.md" ref="nofollow noopener noreferrer">AWESOME-DIGITAL-HUMAN</a>是一款国产开源的数字人框架</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e332a04e0bbf4bdc95ab3334522e1ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=UkUYHJnR%2BGxUm%2FeAlDgMVtcftgE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.准备工作</h2>
<p>下载源码 git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwan-h%2Fawesome-digital-human-live2d.git" target="_blank" title="https://github.com/wan-h/awesome-digital-human-live2d.git" ref="nofollow noopener noreferrer">github.com/wan-h/aweso…</a>
项目目录如下：</p>
<pre><code class="hljs language-." lang=".">├── config.yaml                  # 全局配置文件
├── agents                       # agent 配置文件目录
└── engines                      # 引擎配置文件目录
    ├── asr                      # 语音识别引擎配置文件目录
    ├── llm                      # 大模型引擎配置文件目录
    └── tts                      # 文字转语音引擎配置目录
</code></pre>
<p>容器部署：docker-compose up --build -d
创建一个千问智能体，以备后用
开通腾讯tts服务，以备后用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88dd46cfdf5468298433442db1d779a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=sXrmdQcHIu2THVOE%2BJKZ%2FVgIr1I%3D" alt="image.png" loading="lazy"/></p>
<p>打开8880端口，发现项目已经成功启动了，可以修改很多配置，比如人物的模型，背景，声音，可以使用的agent等等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2375991d638c4ec093a2d36b87aa6af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=mmJHGwRIn1pKth4sDWaSl5MyZT0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">2.项目修改</h2>
<p>修改configs\engines\tts\tencentAPI.yaml文件的相关配置，选择我们喜欢的语音</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入腾讯服务"
META: {
  official: "",
  configuration: "https://console.cloud.tencent.com/tts",
  tips: "",
  fee: ""
}
PARAMETERS: [
  {
    name: "secret_id",
    description: "tencent secret_id.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的  secret_id"
  },
  {
    name: "secret_key",
    description: "tencent secret_key.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的 secret_key"
  },
  {
    name: "voice",
    description: "Voice for TTS.",
    type: "string",
    required: false,
    choices: [],
    default: "爱小璟"
  },
  {
    name: "volume",
    description: "Set volume, default +0%.",
    type: "float",
    required: false,
    range: [-10, 10],
    default: 0.0
  },
  {
    name: "speed",
    description: "Set speed, default +0%.",
    type: "float",
    required: false,
    range: [-2, 6],
    default: 0.0
  }
]
</code></pre>
<p>打开config_template.yaml文件，可以发现目前是不支持通义千问的，首先增加对千问的支持</p>
<pre><code class="hljs language-COMMON:" lang="COMMON:">  NAME: "Awesome-Digital-Human"
  VERSION: "v3.0.0"
  LOG_LEVEL: "DEBUG"
SERVER:
  IP: "0.0.0.0"
  PORT: 8880
  WORKSPACE_PATH: "./outputs"
  ENGINES:
    ASR: 
      SUPPORT_LIST: [ "difyAPI.yaml", "cozeAPI.yaml", "tencentAPI.yaml", "funasrStreamingAPI.yaml"]
      DEFAULT: "difyAPI.yaml"
    TTS: 
      SUPPORT_LIST: [ "edgeAPI.yaml", "tencentAPI.yaml", "difyAPI.yaml", "cozeAPI.yaml" ]
      DEFAULT: "tencentAPI.yaml"
    LLM:
      SUPPORT_LIST: []
      DEFAULT: ""
  AGENTS:
    SUPPORT_LIST: [ "repeaterAgent.yaml", "openaiAPI.yaml", "difyAgent.yaml", "fastgptAgent.yaml", "cozeAgent.yaml"]
    DEFAULT: "repeaterAgent.yaml"
</code></pre>
<p>在SUPPORT_LIST里增加qwenAgent.yaml 并设置为默认。
在configs agent目录里增加一个qwenAgent.yaml文件</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入通义千问智能体（DashScope Application）"
META: {
  official: "https://bailian.console.aliyun.com/",
  configuration: "需在百炼平台创建应用并获取 App ID",
  tips: "支持多轮对话、流式输出、自动会话管理。提示词和知识库已在智能体后台配置。",
  fee: "按 DashScope 定价计费"
}
# 暴露给前端的参数选项以及默认值
PARAMETERS: [
  {
    name: "api_key",
    description: "DashScope API Key（通义千问密钥）",
    type: "string",
    required: true,
    choices: [],
    default: "你的sk"
  },
  {
    name: "app_id",
    description: "通义千问智能体 App ID（在百炼平台创建）",
    type: "string",
    required: true,
    choices: [],
    default: "你的appId"
  }
]
</code></pre>
<p>在digitalHuman\agent\core下创建qwenAgent.py文件，千问支持保存短期对话和长期对话，短期对话使用session_id或者拼接message列表均可，根据文档，在这两个字段同时存在里阿里会采用message列表的模式，此时session_id字段会失效 我们使用session_id的形式，在用户首次对话时创建session_id并传递给前端，当进行后续对话时再由前端返回，长期记忆根据用户创建memory_id存表，然后在对话中携带参数即可</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id  = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id :
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                #自定义上下文模式
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                #标准多轮对话模式
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            # 发起请求
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        # 提取 conversation_id（仅在标准模式下）
                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        # 提取文本
                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))
</code></pre>
<p>阿里创建长期记忆体sdk:</p>
<pre><code class="hljs language-@staticmethod" lang="@staticmethod">    def create_client() -&gt; bailian20231229Client:
        """
        使用凭据初始化账号Client
        @return: Client
        @throws Exception
        """
        # 工程代码建议使用更安全的无AK方式，凭据配置方式请参见：https://help.aliyun.com/document_detail/378659.html。
        credential = CredentialClient()
        config = open_api_models.Config(
            credential=credential
        )
        # Endpoint 请参考 https://api.aliyun.com/product/bailian
        config.endpoint = f'bailian.cn-beijing.aliyuncs.com'
        return bailian20231229Client(config)

    @staticmethod
    async def main_async(
        args: List[str],
    ) -&gt; None:
        client = Sample.create_client()
        create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest()
        runtime = util_models.RuntimeOptions()
        headers = {}
        try:
            # 复制代码运行请自行打印 API 的返回值
            await client.create_memory_node_with_options_async('', '', create_memory_node_request, headers, runtime)
        except Exception as error:
            # 此处仅做打印展示，请谨慎对待异常处理，在工程项目中切勿直接忽略异常。
</code></pre>
<p>需要注意incremental_output需要修改为True,否则流式输出的情况下数据会有重复。
在流式输出的情况下，如果每次返回都请求tts，会导致断句不自然甚至一字一顿的情况，比如 我 喜欢 吃这样，调整前端相关的逻辑代码，着重修改web\app(products)\sentio\hooks\chat.ts文件，主要修改逻辑就是把每次流式输出推送tts改为拼接完成后，根据标点断句分批推送tts，同时控制文字和语音的分段同时显示，使嘴型，声音和文字更加自然同步。</p>
<pre><code class="hljs language-import" lang="import">import { 
    useChatRecordStore, 
    useSentioAgentStore, 
    useSentioTtsStore,
    useSentioBasicStore,
} from "@/lib/store/sentio";
import { useTranslations } from 'next-intl';
import { CHAT_ROLE, EventResponse, STREAMING_EVENT_TYPE } from "@/lib/protocol";
import { Live2dManager } from '@/lib/live2d/live2dManager';
import { base64ToArrayBuffer, ttsTextPreprocess } from '@/lib/func';
import { convertMp3ArrayBufferToWavArrayBuffer } from "@/lib/utils/audio";
import {
    api_tts_infer,
    api_agent_stream,
} from '@/lib/api/server';
import { addToast } from "@heroui/react";
import { SENTIO_RECODER_MIN_TIME, SENTIO_RECODER_MAX_TIME } from "@/lib/constants";

export function useAudioTimer() {
    const t = useTranslations('Products.sentio');
    const startTime = useRef(new Date());
    const toast = (message: string) =&gt; {
        addToast({
            title: message,
            color: "warning",
        });
    };
    const startAudioTimer = () =&gt; {
        startTime.current = new Date();
    };
    const stopAudioTimer = (): boolean =&gt; {
        const duration = new Date().getTime() - startTime.current.getTime();
        if (duration &lt; SENTIO_RECODER_MIN_TIME) {
            toast(`${t('recordingTime')} &lt; ${SENTIO_RECODER_MIN_TIME}`);
        } else if (duration &gt; SENTIO_RECODER_MAX_TIME) {
            toast(`${t('recordingTime')} &gt; ${SENTIO_RECODER_MAX_TIME}`);
        } else {
            return true;
        }
        return false;
    };
    return { startAudioTimer, stopAudioTimer };
}

//获取 mid
function getMidFromUrl(): string | null {
    if (typeof window === 'undefined') return null;
    const params = new URLSearchParams(window.location.search);
    return params.get('mid');
}

export function useChatWithAgent() {
    const [chatting, setChatting] = useState(false);
    const { engine: agentEngine, settings: agentSettings } = useSentioAgentStore();
    const { engine: ttsEngine, settings: ttsSettings } = useSentioTtsStore();
    const { sound } = useSentioBasicStore();

    const { addChatRecord, updateLastRecord } = useChatRecordStore();
    const controller = useRef&lt;AbortController | null&gt;(null);
    const conversationId = useRef&lt;string&gt;("");
    const messageId = useRef&lt;string&gt;("");

    // 原始流式文本缓存（用于断句）
    const fullRawText = useRef&lt;string&gt;("");
    const pendingText = useRef&lt;string&gt;("");
    const lastTextUpdateTime = useRef&lt;number&gt;(0);

    // 已显示的文本（仅包含已 TTS 的内容）
    const displayedContent = useRef&lt;string&gt;("");
    const agentThinkRef = useRef&lt;string&gt;("");

    //TTS 串行队列，保证顺序
    const ttsQueue = useRef&lt;Array&lt;{ text: string }&gt;&gt;([]);
    const isProcessingTts = useRef&lt;boolean&gt;(false);

    //从 URL 获取 mid（只在初始化时读一次）
    const mid = useRef&lt;string | null&gt;(getMidFromUrl());

    const abort = () =&gt; {
        setChatting(false);
        Live2dManager.getInstance().stopAudio();
        if (controller.current) {
            controller.current.abort("abort");
            controller.current = null;
        }
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = []; // 清空队列
        isProcessingTts.current = false;
    };

    const updateDisplayedContent = (newSentence: string) =&gt; {
        displayedContent.current += newSentence;
        updateLastRecord({
            role: CHAT_ROLE.AI,
            think: agentThinkRef.current,
            content: displayedContent.current
        });
    };

    //串行处理 TTS 队列
    const processNextTtsInQueue = () =&gt; {
        if (isProcessingTts.current || ttsQueue.current.length === 0 || !controller.current) {
            return;
        }

        isProcessingTts.current = true;
        const { text } = ttsQueue.current.shift()!;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
            return;
        }

        api_tts_infer(
            ttsEngine,
            ttsSettings,
            processedText,
            controller.current.signal
        ).then((ttsResult) =&gt; {
            if (ttsResult &amp;&amp; controller.current) {
                const audioData = base64ToArrayBuffer(ttsResult);
                convertMp3ArrayBufferToWavArrayBuffer(audioData)
                    .then((buffer) =&gt; {
                        if (controller.current) {
                            updateDisplayedContent(text);
                            Live2dManager.getInstance().pushAudioQueue(buffer);
                        }
                    })
                    .catch((err) =&gt; {
                        console.warn("Audio conversion failed:", err);
                        updateDisplayedContent(text);
                    })
                    .finally(() =&gt; {
                        isProcessingTts.current = false;
                        processNextTtsInQueue();
                    });
            } else {
                updateDisplayedContent(text);
                isProcessingTts.current = false;
                processNextTtsInQueue();
            }
        }).catch((err) =&gt; {
            console.warn("TTS failed for text:", text, err);
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
        });
    };

    //入队函数（替代原来的 processTextForTTS）
    const enqueueTts = (text: string) =&gt; {
        if (!controller.current) return;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            // 无效文本立即显示
            updateDisplayedContent(text);
            return;
        }

        if (!sound) {
            // 无声模式直接显示
            updateDisplayedContent(text);
            return;
        }

        // 有声模式：入队等待串行处理
        ttsQueue.current.push({ text });
        processNextTtsInQueue();
    };

    //按标点断句并及时入队
    const tryProcessPendingText = () =&gt; {
        if (!pendingText.current.trim()) return;

        const now = Date.now();
        const timeSinceLastUpdate = now - lastTextUpdateTime.current;
        const charCount = pendingText.current.length;

        // 定义句子结束符（注意：必须包含中文和英文标点）
        const sentenceEndingsRegex = /[。！？!?.;；\n,，、…～]/g;
        const endings = pendingText.current.match(sentenceEndingsRegex) || [];
        const parts = pendingText.current.split(sentenceEndingsRegex);

        const completeSentences: string[] = [];
        let remaining = "";

        // 重组：除最后一个 part 外，其余都可组成完整句子
        for (let i = 0; i &lt; parts.length - 1; i++) {
            let sentence = parts[i];
            if (i &lt; endings.length) {
                sentence += endings[i]; // 把标点加回去
            }
            if (sentence.trim()) {
                completeSentences.push(sentence);
            }
        }

        // 最后一个 part 是未完成的片段（除非原文本以标点结尾）
        const lastPart = parts[parts.length - 1] || "";
        const endsWithPunctuation = sentenceEndingsRegex.test(pendingText.current.slice(-1));
        
        if (endsWithPunctuation) {
            // 如果原文本以标点结尾，则最后一部分也完整
            if (lastPart.trim()) {
                completeSentences.push(lastPart + (endings[endings.length - 1] || ''));
            }
            remaining = "";
        } else {
            // 否则保留为 pending
            remaining = lastPart;
        }

        // 是否强制 flush 剩余内容？
        const shouldFlushRemaining =
            charCount &gt;= 60 ||
            timeSinceLastUpdate &gt; 1500;

        if (shouldFlushRemaining &amp;&amp; remaining.trim()) {
            completeSentences.push(remaining);
            remaining = "";
        }

        // 处理所有完整句子
        completeSentences.forEach(sentence =&gt; {
            if (sentence.trim()) {
                enqueueTts(sentence);
            }
        });

        // 更新 pendingText
        pendingText.current = remaining;
    };

    const chatWithAgent = (
        message: string, 
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        addChatRecord({ role: CHAT_ROLE.HUMAN, think: "", content: message });
        addChatRecord({ role: CHAT_ROLE.AI, think: "", content: "" });

        controller.current = new AbortController();
        setChatting(true);
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = [];
        isProcessingTts.current = false;

        const agentCallback = (response: EventResponse) =&gt; {
            const { event, data } = response;
            switch (event) {
                case STREAMING_EVENT_TYPE.CONVERSATION_ID:
                    conversationId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.MESSAGE_ID:
                    messageId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.THINK:
                    agentThinkRef.current += data;
                    updateLastRecord({
                        role: CHAT_ROLE.AI,
                        think: agentThinkRef.current,
                        content: displayedContent.current
                    });
                    break;
                case STREAMING_EVENT_TYPE.TEXT:
                    fullRawText.current += data;
                    pendingText.current += data;
                    lastTextUpdateTime.current = Date.now();

                    if (sound) {
                        tryProcessPendingText();
                    } else {
                        displayedContent.current += data;
                        updateLastRecord({
                            role: CHAT_ROLE.AI,
                            think: agentThinkRef.current,
                            content: displayedContent.current
                        });
                    }
                    break;
                case STREAMING_EVENT_TYPE.ERROR:
                    addToast({ title: data, color: "danger" });
                    break;
                case STREAMING_EVENT_TYPE.TASK:
                case STREAMING_EVENT_TYPE.DONE:
                    if (postProcess) {
                        postProcess(conversationId.current, messageId.current, agentThinkRef.current, fullRawText.current);
                    }

                    // 流结束，处理剩余文本
                    if (sound &amp;&amp; pendingText.current.trim()) {
                        enqueueTts(pendingText.current);
                        pendingText.current = "";
                    }

                    setChatting(false);
                    break;
                default:
                    break;
            }
        };

        const agentErrorCallback = (error: Error) =&gt; {
            setChatting(false);
        };

        //调用 api_agent_stream 时传入 mid
        api_agent_stream(
            agentEngine,
            agentSettings,
            message,
            conversationId.current,
            controller.current.signal,
            agentCallback,
            agentErrorCallback,
            mid.current
        );
    };

    const chat = (
        message: string,
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        abort();
        chatWithAgent(message, postProcess);
    };

    useEffect(() =&gt; {
        conversationId.current = "";
        return () =&gt; {
            abort();
        };
    }, [agentEngine, agentSettings]);

    return { chat, abort, chatting, conversationId, mid: mid.current };
}
</code></pre>
<p>到这里感觉完事大吉了，但是查看长期记忆列表居然没有数据，这是什么情况？经过多次实现发现自动写入记忆片段只有推理模式才能成功，但是开启推理模式等待时间过长，不适合数字人这种需要及时交互的场景，那么有没有解决的方法呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ae70ec85eb4569af5dc3f43bf9b5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=u1Ggiind3VEByUVaIFUw6TlTiMs%3D" alt="image.png" loading="lazy"/>
我们可以使用阿里提供的另一个接口，主动创建记忆片段。
修改qwenAgent.py文件，具体逻辑就是在千问返回信息后，异步通过接口判断当前返回的内容是否需要抽取保存到记忆中，如果需要的话通过相关sdk进行保存</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
import asyncio
import re
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

# DashScope SDK 导入
try:
    from alibabacloud_bailian20231229.client import Client as bailian20231229Client
    from alibabacloud_credentials.client import Client as CredentialClient
    from alibabacloud_tea_openapi import models as open_api_models
    from alibabacloud_bailian20231229 import models as bailian_20231229_models
    from alibabacloud_tea_util import models as util_models
    from alibabacloud_credentials.models import Config as CredentialConfig
    SDK_AVAILABLE = True
except ImportError:
    logger.warning("DashScope SDK not available, memory writing disabled")
    SDK_AVAILABLE = False

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    
    def __init__(self, config=None, engine_type=None):
        """初始化 QwenAgent，兼容父类构造函数"""
        super().__init__(config, engine_type)
        self._sdk_client = None
        if SDK_AVAILABLE:
            self._init_sdk_client()
    
    def _init_sdk_client(self):
        """初始化 DashScope SDK 客户端 - 从环境变量读取 AK/SK"""
        try:
            access_key_id = os.getenv("DASHSCOPE_ACCESS_KEY_ID")
            access_key_secret = os.getenv("DASHSCOPE_ACCESS_KEY_SECRET")
            
            if not access_key_id or not access_key_secret:
                logger.error("DASHSCOPE_ACCESS_KEY_ID or DASHSCOPE_ACCESS_KEY_SECRET not set in environment variables")
                return
            
            credential_config = CredentialConfig(
                type='access_key',
                access_key_id=access_key_id,
                access_key_secret=access_key_secret
            )
            credential = CredentialClient(credential_config)
            
            config = open_api_models.Config(credential=credential)
            config.endpoint = 'bailian.cn-beijing.aliyuncs.com'
            self._sdk_client = bailian20231229Client(config)
            logger.info("DashScope SDK client initialized successfully")
        except Exception as e:
            logger.error(f"Failed to initialize SDK client: {e}")
            self._sdk_client = None
    
    #判断是否需要抽取记忆
    def _should_extract_memory(self, text: str) -&gt; bool:
        """轻量判断：是否可能包含可记忆信息"""
        if not text.strip():
            return False
        triggers = [
            "叫", "名字", "姓名",  # 基本信息
            "喜欢", "爱吃", "爱喝", "讨厌", "不吃", "过敏",  # 饮食
            "兴趣", "爱好", "擅长", "迷上", "喜欢玩",  # 兴趣
            "性格", "活泼", "内向", "安静", "调皮",  # 性格
            "年级", "学校", "班级",  # 基本信息
            "进步", "退步", "成绩", "考得", "学习", "作业"  # 学习（趋势）
        ]
        return any(trigger in text for trigger in triggers)
    
    # qwen-max 抽取结构化记忆
    async def _extract_memory_with_qwen_max(self, text: str, api_key: str, child_name: str = "") -&gt; dict:
        prompt = f"""
# 角色
你是一个严格的信息抽取系统，不是对话助手。你的唯一任务是从家长原话中提取结构化信息。

# 规则
1. 禁止任何解释、问候、反问、建议
2. 禁止输出 JSON 以外的任何字符（包括换行、空格、Markdown）
3. 如果没有可提取信息，必须输出：{{}}
4. 字段值必须是简洁的中文短语，不要完整句子

# 字段定义
- basic_info: "姓名，性别，年级"（如"李明，男，三年级"）
- diet_preference: "饮食偏好"（如"喜欢吃西瓜"）
- interests: "兴趣爱好"（如"喜欢画画"）
- personality: "性格特点"（如"性格活泼"）
- academic_trend: "学习趋势"（如"数学有进步"）

# 家长原话
{text}

# 你的输出（纯 JSON，无任何其他内容）：
"""
        
        try:
            resp = await httpxAsyncClient.post(
                "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
                headers={"Authorization": f"Bearer {api_key}"},
                json={
                    "model": "qwen-max",
                    "input": {"prompt": prompt.strip()},
                    "parameters": {
                        "max_tokens": 200,
                        "temperature": 0.01,
                        "stop": ["\n", "。", "！", "？", "："]
                    }
                },
                timeout=10.0
            )
            if resp.status_code == 200:
                data = resp.json()
                raw_text = data.get("output", {}).get("text", "").strip()
                logger.debug(f"[MemoryExtract] Raw output: '{raw_text}'")
                
                # 尝试解析 JSON
                try:
                    return json.loads(raw_text)
                except:
                    # 尝试提取 {...}
                    match = re.search(r'\{[^{}]*\}', raw_text)
                    if match:
                        try:
                            return json.loads(match.group())
                        except:
                            pass
                if raw_text == "{}":
                    return {}
                    
                logger.warning(f"[MemoryExtract] Failed to parse: {raw_text[:100]}")
                
        except Exception as e:
            logger.error(f"[MemoryExtract] Error: {e}", exc_info=True)
        
        return {}

    #使用 SDK 写入 DashScope Memory
    async def _write_memory_node_with_sdk(self, app_id: str, memory_id: str, content: str):
        if not SDK_AVAILABLE or self._sdk_client is None:
            logger.warning("[MemoryWrite] SDK not available, skipping write")
            return
            
        if not app_id or not memory_id or not content.strip():
            logger.warning("[MemoryWrite] Skip empty app_id, memory_id or content")
            return
        
        try:
            logger.info(f"[MemoryWrite] Attempting to write via SDK - app_id: '{app_id}', memory_id: '{memory_id}', content: '{content}'")
            
            create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest(
                content=content
            )
            runtime = util_models.RuntimeOptions()
            headers = {}
            space_id = os.getenv("DASHSCOPE_SPACE_ID")
            response = await self._sdk_client.create_memory_node_with_options_async(
                space_id, 
                memory_id, 
                create_memory_node_request, 
                headers, 
                runtime
            )
            
            logger.info(f"[MemoryWrite] SDK SUCCESS - MemoryNode ID: {response.body.memory_node_id}")
            
        except Exception as e:
            logger.error(f"[MemoryWrite] SDK EXCEPTION: {e}")

    #后台记忆更新任务
    async def _background_memory_update(self, user_input: str, app_id: str, memory_id: str, api_key: str):
        await asyncio.sleep(0.5)
        
        child_name = ""
        extracted = await self._extract_memory_with_qwen_max(user_input, api_key, child_name)
        logger.info(f"[Memory] Extracted result: {extracted}")
        
        for key, value in extracted.items():
            if value:
                pure_content = value
                logger.info(f"[Memory] Writing pure content: {pure_content}")
                await self._write_memory_node_with_sdk(app_id, memory_id, pure_content)

    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数（从环境变量或参数）
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id:
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            #异步触发记忆抽取
            if memory_id and self._should_extract_memory(prompt):
                logger.info("[Memory] Triggering async memory extraction...")
                asyncio.create_task(
                    self._background_memory_update(prompt, app_id, memory_id, api_key)
                )

            #发起主请求（保持原有逻辑不变）
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))

</code></pre>
<p>这样一个支持语音输出输入，长短期记忆的live2d数字人就完成了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74fdfc11e4524aeabe726993464f097c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=BPnLaTMbC0lnWRT8XyUICLzL3hg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a8a2948e24dad8528704014278769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=Ct9gxAtDQ91hP2Vvs2G3VbBE2rk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows安装Claude Code全流程]]></title>    <link>https://juejin.cn/post/7571808096936722473</link>    <guid>https://juejin.cn/post/7571808096936722473</guid>    <pubDate>2025-11-13T08:54:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096936722473" data-draft-id="7571972751528099876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows安装Claude Code全流程"/> <meta itemprop="keywords" content="Windows,Linux,Claude"/> <meta itemprop="datePublished" content="2025-11-13T08:54:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="撒币使我快乐"/> <meta itemprop="url" content="https://juejin.cn/user/1556564197509527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows安装Claude Code全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564197509527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    撒币使我快乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:54:57.000Z" title="Thu Nov 13 2025 08:54:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这里不赘述账号申请，很多网上很多资料了。在 Windows 系统上使用 Claude Code，主要有两种官方推荐的路径：一种是利用 Windows 自带的 Linux 子系统（WSL），另一种是尝试通过 PowerShell 直接安装。此外，你也可以选择将其功能集成到 VS Code 编辑器中使用。这里我们使用第一种，因为这是目前最稳定、被广泛验证的方式。</p>
<ol>
<li><strong>启用并安装 WSL</strong>：
<ul>
<li>以<strong>管理员身份</strong>打开 PowerShell。</li>
<li>依次执行以下命令：
<pre><code class="hljs language-powershell" lang="powershell">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre>
</li>
<li><strong>重启电脑</strong>使更改生效。</li>
<li>重启后，再次以管理员身份打开 PowerShell，执行 <code>wsl --install</code> 来安装默认的 Linux 发行版（通常是 Ubuntu）。过程中你需要设置一个 Linux 系统的用户名和密码。<br/>
如果这一步提示了如下报错，即使这个链接能通过浏览器打开，也需要处理网络问题<br/>
<em>无法从“<a href="https://link.juejin.cn?target=https%3A%2F%2Fraw.githubusercontent.com%2Fmicrosoft%2FWSL%2Fmaster%2Fdistributions%2FDistributionInfo.json%25E2%2580%259D" target="_blank" title="https://raw.githubusercontent.com/microsoft/WSL/master/distributions/DistributionInfo.json%E2%80%9D" ref="nofollow noopener noreferrer">raw.githubusercontent.com/microsoft/W…</a> 提取列表分发。无法解析服务器的名称或地址<br/>
错误代码: Wsl/InstallDistro/WININET_E_NAME_NOT_RESOLVED</em></li>
</ul>
</li>
<li><strong>处理网络问题方法</strong>
<ol>
<li><strong>诊断DNS解析问题</strong></li>
</ol>
<ul>
<li>
<p>按Win + R输入cmd回车打开命令行工具，执行 <code>ping raw.githubusercontent.com</code> 获取IP地址（如 <code>185.199.110.133</code>）</p>
</li>
</ul>
<ol start="2">
<li><strong>修改Hosts文件</strong></li>
</ol>
<ul>
<li>
<p>使用IDE（需管理员权限）编辑 <code>C:\Windows\System32\drivers\etc\hosts</code></p>
</li>
<li>
<p>添加行：<code>185.199.110.133 raw.githubusercontent.com</code></p>
</li>
</ul>
<ol start="3">
<li><strong>刷新DNS缓存</strong></li>
</ol>
<ul>
<li>
<p>在PowerShell中执行：<code>ipconfig /flushdns</code></p>
</li>
</ul>
<ol start="4">
<li><strong>重新执行<code>wsl --install</code></strong></li>
</ol>
<ul>
<li>执行命令并设置WSL用户名和密码</li>
</ul>
</li>
<li><strong>在 WSL 中安装 Node.js</strong>：
<ul>
<li>从开始菜单打开你安装的 Linux 发行版（如 Ubuntu）。</li>
<li>首先更新系统包并安装 Node.js（如果未安装）：
<pre><code class="hljs language-bash" lang="bash">sudo apt update &amp;&amp; sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
</code></pre>
</li>
<li>验证Node.js安装，执行：<code>node --version</code> （成功输出：<code>20.19.5</code>）</li>
</ul>
</li>
<li><strong>安装Claude Code</strong>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
</li>
<li>将ANTHROPIC_AUTH_TOKEN和ANTHROPIC_BASE_URL写入~/.zshrc<br/>
在Ubuntu中，使用vim命令修改~/.zshrc
<pre><code class="hljs language-bash" lang="bash">vim ~/.zshrc
</code></pre>
将如下内容写入~/.zshrc，注意将xxxx替换为自己的ANTHROPIC_AUTH_TOKEN，将ANTHROPIC_BASE_URL替换为自己的ANTHROPIC_BASE_URL
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Claude Code 环境变量</span>
<span class="hljs-built_in">export</span> ANTHROPIC_AUTH_TOKEN=xxxx
<span class="hljs-built_in">export</span> ANTHROPIC_BASE_URL=xxx
</code></pre>
立即重新加载并执行当前用户的 .zshrc 配置文件，后续如果遇到需要输入<code>/login</code>登录的场景可以执行一下完成登录
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
<li>使用Claude Code<br/>
在Ubuntu中，输入<code>claude code</code>即可启动</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零代码+三维仿真！实现自然灾害的可视化模拟与精准预警]]></title>    <link>https://juejin.cn/post/7571768210715869199</link>    <guid>https://juejin.cn/post/7571768210715869199</guid>    <pubDate>2025-11-13T09:27:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715869199" data-draft-id="7572010680896094248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零代码+三维仿真！实现自然灾害的可视化模拟与精准预警"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T09:27:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零代码+三维仿真！实现自然灾害的可视化模拟与精准预警
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:27:17.000Z" title="Thu Nov 13 2025 09:27:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从“被动应对”到“主动预警”的蜕变</h2>
<p>传统防灾预警高度<strong>依赖专业人员经验与繁琐的数据分析</strong>，既耗时耗力，又因灾害状态瞬息万变易错过最佳预警窗口。</p>
<p>园测信科自研的**【RiskInsight平台】<strong>构建</strong>【综合风险预警模型】<strong>和</strong>【灾害链动力学模型】<strong>两大模块，围绕滑坡泥石流、洪水、森林火灾、边坡崩塌等多个灾种，提供基于真实地理环境的灾害分析，将冰冷的监测数字转换成直观生动的</strong>三维仿真场景**，并且可以按照现实情况实时推演，推动防灾减灾工作的<strong>普及化和高效化</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06339f1be579409883ca37b66e43e818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=308%2FbePYPBjVK2JiSnOCA2SehJg%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-1">01 支持多灾种可视化的综合评价模型</h3>
<p>内置**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害综合评价模型，**利用GIS空间分析能力，实现实时数据驱动下的模型运行，以及在地图上的可视化模拟，从而降低决策理解门槛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec90003a8704e81bc7d13ebbda6d746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=zAkCqc8cbMmMfLwUjMilTsIJnmM%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>集成**多个综合评价模型，**提供多灾种科学分析支撑。</p>
</li>
<li>
<p><strong>实时数据驱动</strong>专业模型，灾害评估结果更贴近实际。</p>
</li>
<li>
<p>基于<strong>真实三维地理环境</strong>，<strong>直观展示模型分析结果</strong>，反映灾害发生概率，<strong>降低决策理解门槛</strong>。</p>
</li>
</ul>
<h3 data-id="heading-2">02 基于真实地理环境的动力学模型仿真模拟</h3>
<p>内置通用的**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害链动力学仿真分析模型**，接入真实的地理数据，可实现在三维场景中模拟灾害的演进过程（如溃决洪水的扩散过程）；</p>
<p>同时<strong>支持调整参数来对比</strong>：不同气象条件下房屋、道路、人员等承载体的受灾情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67295dcb1b534ebb821f911a00954e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=3XT6qs84%2BbuLjY9hMEhMU4rPJT4%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>内置多种灾害的动力学模型,支持<strong>实时修改模型参数</strong>，快速生成模拟场景。</p>
</li>
<li>
<p>基于真实DEM数据，<strong>可视化模拟</strong>灾害演进过程。</p>
</li>
<li>
<p>可叠加建筑物、道路、人口分布数据，<strong>动态统计</strong>灾害对关键设施的影响范围。</p>
</li>
</ul>
<h2 data-id="heading-3">零代码让精准预警触手可及</h2>
<p>灾害风险预警模型是平台的核心，面对不同的地理环境，需要业务专家据实际情况，对<strong>模型中的大量参数进行调试以获得最优的监控方案</strong>，在以往的调试过程中，需要由防灾专家与开发者多次沟通才能完成，一旦地理环境发生变化，又需要重复上述的调试过程，这样的模式不仅效率低下，更让真正懂防灾业务的人员被隔绝在技术门槛之外！</p>
<p>作为<strong>业内首个自然灾害监测预警零代码开发平台</strong>，RiskInsight通过直观的图形界面和简单的交互操作，<strong>无需编写复杂的代码就可以完成预警模型的参数调整</strong>，对开发的依赖大大降低！并且，在地理环境不断演变的情况下，<strong>可以及时地调整与验证，生成最优的监控方案。</strong></p>
<h3 data-id="heading-4">01 方式一：框选范围分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9176c3d1366b47059faa93687b7587ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=00tGBLqRtdAkDXd1erogE6QTybs%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式支持用户直接在地图上划定分析范围，操作更简便。</em></p>
<h3 data-id="heading-5">02 方式二：上传数据分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9b09b5cef4470984d0fe056a1ed4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=ai3jhm9CGQQDZTT9pIzTSidozlw%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式需用户自行制作数据上传，分析结果更精确。</em></p>
<h3 data-id="heading-6">03 运行模型</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45dcffa96a694a5bb1b40afcfdab0956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=frPmnr0hm6Q28eSVhl9Dj%2BjeMOA%3D" alt="动图封面" loading="lazy"/></p>
<h2 data-id="heading-7">仿真分析案例</h2>
<h3 data-id="heading-8">● 流域洪水</h3>
<p>本模型主要用于模拟流域或区域尺度的<strong>地表水与地下水动态过程</strong>，尤其在水文循环模拟、洪水预报、干旱评估及气候变化对水资源的影响研究中应用广泛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/076374998bb14bd39732a8ee32f9b7ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=rEp84O%2FFoEq6Q8NOHgv%2FNbKI0hc%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35bf1f4f08dc42c4adf3dde8123cb8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=xuva08%2F49LnnIdeKCtMYH6YMjt4%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-9">● 滑坡泥石流</h3>
<p>本模型是一款专注于泥石流（岩屑流、山洪泥石流）动力学模拟的专业软件工具，主要用于分析<strong>泥石流的启动、运动过程、堆积范围及对周边设施的影响</strong>，广泛应用于山地灾害风险评估、防灾减灾规划及工程防护设计领域。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d4c142155246d8ac8c8a33e6fe470e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=MmWd7EMhN8D7p5Bp%2BTTfpudT91w%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c6ac206815a4ae395ffdb960f58203f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=WhyzR7dugTxFeHp4oVc53WGcBdI%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-10">● 森林火灾</h3>
<p>本模型是野火行为研究的经典工具之一。其核心目标是通过量化火源热释放、燃料特性、气象条件及地形对火蔓延的影响，<strong>预测火线（Firefront）的推进速度与方向</strong>，为火灾防控、风险评估及应急决策提供科学依据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc11419693d84deda32e756a35992b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=vGnlZzDZOWV9GfwsZ8C%2FqjC98UQ%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e94ccca40442dbbf10bb32cdcaa4f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=tPrFfWe1pXyKbYseYMcXHfu1n6k%3D" alt="动图封面" loading="lazy"/></p>
<p>在后续的文章中，将为大家分享上述模型功能的开发思路，以及在开发过程中所遇到的问题和解决方案，敬请期待~</p>
<p>了解更多，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 原生应用开发实战营·京沪双城回顾 & PPT 下载]]></title>    <link>https://juejin.cn/post/7571768210715934735</link>    <guid>https://juejin.cn/post/7571768210715934735</guid>    <pubDate>2025-11-13T09:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715934735" data-draft-id="7571751593206415412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-13T09:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:33:53.000Z" title="Thu Nov 13 2025 09:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：盈楹&amp;望宸</p>
<p>近日，阿里云 AI 原生应用开发实战营 · 北京站&amp;上海站圆满落幕。继深圳、杭州、成都等城市之后，这两场活动吸引了 250+ 名技术从业者深度参与。</p>
<p>活动聚焦 AI Agent 领域的前沿技术与落地实践，深度分享 AI Agent 架构趋势和演进、AI 开放平台、AI 应用运行时、AI 应用托管、大模型可观测 &amp; AIOps、异步化的 Agent 事件驱动等热门技术议题，并设置了动手实操环节。</p>
<p>关注「阿里云云原生」公众号，后台回复：1111</p>
<p>免费获得北京站&amp;上海站讲师 PPT 合辑</p>
<h2 data-id="heading-0">精彩回顾丨北京站</h2>
<h3 data-id="heading-1">议题一：构建 AI 原生应用的 11 个关键要素丨王晨(望宸)阿里云智能云原生高级技术运营专家</h3>
<p>深度分享了 AI 云原生应用架构新范式，已从数字化范式演进为智能化范式，基于模型、Agent 驱动，以数据为中心，整合工具链，形成 AI 原生应用架构。AI 原生应用将具备意识、自主性、确定性、一致性。企业可以找到核心提效场景，通过 AI 原生应用架构，构建高质量数据壁垒，借助大模型大势快速迭代，同时，让数据可沉淀，行业数据可演进，评估数据可量化，反馈数据可持续。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee88b0b0a6074071869b18bf455768f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=S1QT9rzfyHKem9zlhlFm9bkPgzA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">议题二：从传统应用到 AI 应用的一站式托管丨赵庆杰(卢令)阿里云智能云原生高级技术专家</h3>
<p>首先分享了传统应用运维的‘简、稳、省’优化之道，迈向智能运维时代，SAE 智能助手的核心引擎从基础问答到故障诊断，AI 能力重构云原生运维流程。企业可借助函数计算 AgentRun、AgentRun 网关、AgentRun 可观测的产品能力，跨越 Agent 生产力鸿沟，构建智能体核心基础设施，全面打通 AI 应用落地最后一公里，加速 AI 创新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d73ad708643e4a44ab24eba6be630f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=U0Hzzf6fHgORfWjlrrLulMMZrkU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">议题三：Higress AI 开放平台：构建企业私有化 MCP/Agent 市场的实践丨刘帅(友瑾) Higress Maintainer</h3>
<p>从传统网关迈向 AI 网关，Higress 流量网关、API 网关、大模型代理、MCP 代理能力打造了 AI 网关新范式。深入分享了 Higress x HiMarket 核心原理，企业可以通过 Higress x HiMarket，实现 MCP Server 集中化治理，API 货币化等，快速构建企业级 AI 市场，同时也分享了 Higress x HiMarket 未来规划，欢迎更多用户了解 Higress x HiMarket 项目 roadmap，参与开源贡献。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be556e1797b47a5863d8ae718d67663~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=WGa0HG2O%2FUe25hS%2B80lTTLZdgCk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">议题四：大模型驱动的可观测与 AIOps 新范式丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>大模型时代带来全新的应用形态和运维模式，面临数据和认知两大难题，可观测数据平台借助统一接入、加工、存储能力，以及通用算子×可观测数据算子，来降低海量数据的分析难度，轻松驾驭驾驭海量、异构、实时的可观测数据。此外，通过引入统一模型（UModel），基于统一模型（UModel）重构可观测数据，打破通用大模型与运维领域知识的鸿沟，打造大模型驱动的可观测与 AIOps 新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ba97d150474df59c64aee5bfb0d772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=THbTNJunT%2F%2BouUBNpwRLfcQUPCQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">议题五：Apache RocketMQ x AI：面向异步化 Agent 的事件驱动架构丨周礼(不铭)阿里云智能云原生高级技术专家</h3>
<p>AI 进入 Agentic AI 阶段，AgenticAI 应用将成为主流方向，讲师分享了实现异步化 Multi-Agent 的关键点，以及基于 Apache RocketMQ 的 Multi-Agent 架构。通过语义化的 Topic 以及 LiteTopic 两个方案，可以解决通信意图不透明、调度逻辑静态固化、响应路径缺失等问题。现场详细介绍了带语义的 Topic 路由、LiteTopic 在 AI 场景中的应用及实现方案、分级消费策略等产品核心竞争力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de32351ebfa142b394f1dbc8d8d216e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ndESvBKj6yI1ivi2273aPQeJDpg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">议题六：动手实操环节：AIOps 故障定位挑战赛丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>云计算、AIGC 与数字经济的共同推动，带来软件系统数量与复杂度的持续攀升，AIOps 已成为应对这一趋势、保障智能化与可持续发展的关键方向。2025 AI 原生编程挑战赛聚焦 AIOps 故障定位领域，欢迎选手打造智能运维 Agent，让天下没有难查的故障。现场讲师详细介绍了赛题、解题思路，并带领用户现场动手实操，互动交流热烈。欢迎大家报名参赛！<a href="https://link.juejin.cn?target=https%3A%2F%2Ftianchi.aliyun.com%2Fcompetition%2Fentrance%2F532387%3Faccounttraceid%3De0ba51491d54404cae1237b6ae6c3be6hqky" target="_blank" title="https://tianchi.aliyun.com/competition/entrance/532387?accounttraceid=e0ba51491d54404cae1237b6ae6c3be6hqky" ref="nofollow noopener noreferrer">tianchi.aliyun.com/competition…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/badbf4acfcf7435990d5d3344d1e952c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=b2oNLamIW56TTHJSL6wGcuJ7zKQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f763f7cc1384aedb4b3d95656c54f48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=RUcqCKSrQVx8hwwCdsVt%2BfjATZo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb1606b88aa4acbba0fbf8f83deb27e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=MwOp8fMSXJil5PkZhrqWT9jyCe8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e3b600c4085426193ec2e261f9b693e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=SCbDU5ECVLuRfvj%2BqI83EnNoJ%2Bk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e761368c5b4ae49819ab3233c84777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=jjU9ag%2FykUT6%2FZdx962JJi0jWK4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0204555ecdd43b8b8c54f4104db6dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=HpUvkINEH8yB4LMWgb76iXsiA5c%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">精彩回顾丨上海站</h2>
<h3 data-id="heading-9">议题一：AI 原生应用架构趋势与实践丨肖京(亦盏) 阿里云智能云原生高级技术专家</h3>
<p>当前大模型已迈过技术拐点，Agentic AI 进入规模化落地阶段。AI 原生应用以模型为基础、Agent 为驱动、数据为中心，推动系统从“机器执行”向“机器思考+执行”演进。框架选型需平衡 Agentic 自主性与业务确定性，Agent 面临开发效率、业务效果，以及稳定、性能、成本、安全的挑战。实践上建议构建以数据为核心的 Agent 平台，结合 MCP/A2A 标准与 Serverless 架构，通过 AI 网关、消息队列、可观测等提升安全性、稳定性与可维护性，实现智能化人机协作新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8319c97c1d8f48268c58ddd89db27ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0vR93%2BUMmjo%2BC6WYj%2F3wJ8ek2Aw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">议题二：Serverless AI 应用运行时：从函数计算到函数智能丨史明伟(世如)阿里云智能云原生高级技术专家</h3>
<p>随着大语言模型与 AI Agent 快速发展，阿里云函数计算（FC）通过持续架构演进，从“无状态、极致弹性、按需付费” 到 “会话管理、安全隔离、忙闲计费”，成为构建 AI 应用原生架构核心载体。依托于函数计算 FC 毫秒级弹性，原生架构 3AZ 容灾高可用，会话隔离，多语言运行时，CPU/GPU 异构算力等 Serverless Infra 核心优势，够建 FunctionAI 开发平台，提供模型托管（FunModel）、AIGC 生图（FunArt）、智能体开发（AgentRun）和工具/MCP 开发能力，结合魔搭、百炼生态、电商和教育等场景落地经验，助力企业高效构建可扩展的 AI 应用体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd702ced41d43fda9b2426d6cbbb43c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ohWoDoCOT%2BNfuDEyNu7vkEIiGjE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11">议题三：MCP 网关的企业级最佳实践丨张添翼(澄潭)阿里云智能云原生技术专家</h3>
<p>随着大模型与 AI Agent 广泛应用，模型上下文协议（MCP）成为连接 AI 与外部服务的关键。阿里云 AI 网关（Higress 企业版）通过“基础连接—进阶优化—大规模治理”三阶段演进，支持 REST-to-MCP 转换、统一代理与协议卸载，实现异构服务无缝接入；并通过认证控制、最小权限管理保障安全；在大规模场景下，提供虚拟服务组装、语义化检索与智能工具精选，缓解 LLM 上下文压力，提升调用准确率与系统性能，助力企业构建高效、安全、可扩展的 AI 集成体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679de0298d864312af0cd4712c6b11bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=BqaBOFHZ%2Bq%2F%2F6YNj7F7uXJTSJ84%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">议题四：可见、可管、可控：阿里云 AI 应用可观测能力建设丨曹炜怿(顾思)阿里云智能云原生解决方案架构师</h3>
<p>阿里云大模型可观测方案通过“全栈监控-链路诊断-结果评估”三阶段演进，构建 AI 应用全生命周期观测体系。基于 Prometheus+ARMS+SLS 技术栈，实现模型性能分析、GPU 资源监控、Token 成本追踪等全栈指标采集；通过 OpenTelemetry 协议支持 LLM 调用链路追踪（TTFT/TPOT 分析）及 RAG 混合检索优化；创新 LLM-as-Judge 评估框架，内置 10+ 语义检测模板（合规/幻觉/相关性），结合向量索引与自定义评估，降低 AI 应用调试成本 50%。方案已在 vLLM 引擎优化、Token 黑洞定位等场景验证，助力企业实现推理效率和资源利用率的大幅提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a7d56337bbb4f3799d4aec94a03cb48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=JA0ZSCKpdKj%2FLGtjdFsbC9Dd1co%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">议题五：Apache RocketMQ for AI：全面拥抱企业级 AI 应用，引领 AI MQ 新时代丨杨文婷(文婷)阿里云智能云原生产品专家</h3>
<p>阿里云 Apache RocketMQ 推出面向 AI 应用的全新 LiteTopic 模型，支持百万级轻量主题，具备自动生命周期管理、排他消费与顺序消息能力，有效解决 AI 场景中的异步通信、流量治理与定速消费难题。该模型在 Multi-Agent 通信、分布式会话管理与算力调度中发挥关键作用，保障高并发、低延迟与系统可扩展性。RocketMQ 正战略升级为专为 AI 时代打造的 AIMQ，集成主流AI框架，并计划将 LiteTopic 开源，致力于构建企业级 AI 异步通信基础设施。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9badf6e36f514412b1c7c7124551f1ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9Hzckh0nvq9euuIl1F1dUV8OWPo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">议题六：动手实操环节：AIOps 故障定位挑战赛丨刘进步(石季) 阿里云智能云原生算法专家</h3>
<p>2025 年云原生编程挑战赛聚焦智能运维（AIOps）发展，应对云计算与 AIGC 浪潮下系统复杂度提升带来的故障定位难、运维成本高等挑战。大赛倡导融合可观测数据、开源标准与大模型技术，推动运维智能化。参赛者可通过云监控 2.0“看”根因、SPL 脚本“算”根因，或构建大模型 Agent 实现智能诊断，比赛提供完整脚手架与教程，覆盖从入门到高阶的智能运维演进路径，助力打造高效运维解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28333d2d8fea4041b3573b9317e5c182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=Uy1kZ9vfJyqX%2FTTliSCUF2ZOTkc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-15">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f905fdcdb645d9b180379ef0797723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9QkJjH1dmtkvkvdLZUQzi%2BHKGZA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8acb674ddf134b6d95ae65ac7b194534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=s%2FHgoeOyMBardRwO8YrA5220p98%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/525fbe56fd824d1fbfa4be714fdd98f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0GqS5uauJhC%2Bc7t5%2Frjs5MwYb0I%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bad049b076a4df2a51313673a56a09a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=aWPe8oP0wPx2JTnpj9G4W5FOar4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11227628027d4275929d32e8fc98cfc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=oojIlgdjNmcXG9QCRKiEe%2BgivyU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1266e3a18ae454aaac07be8dad1b020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=X9mJbqqCT15UCMsrdf2Gqj4%2B21A%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c63261aadc4f4eaeafbe8010f72ba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=teiP2HCpq4cDsy7A1zg83lbRa40%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从基本链表到侵入式链表，体会内核设计思路]]></title>    <link>https://juejin.cn/post/7571808096937066537</link>    <guid>https://juejin.cn/post/7571808096937066537</guid>    <pubDate>2025-11-13T09:27:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937066537" data-draft-id="7571972751528280100" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从基本链表到侵入式链表，体会内核设计思路"/> <meta itemprop="keywords" content="C语言,后端,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T09:27:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jzhwolp"/> <meta itemprop="url" content="https://juejin.cn/user/3444121799235879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从基本链表到侵入式链表，体会内核设计思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3444121799235879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jzhwolp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:27:14.000Z" title="Thu Nov 13 2025 09:27:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从链表到侵入式结构</h2>
<ul>
<li>以“学生信息链表”为应用场景。</li>
<li>通过对比两种链表实现，说明<strong>侵入式结构（intrusive data structure）与非侵入式结构（non-intrusive data structure）</strong> 的差异。</li>
<li>结合实际开发（内核 vs 用户态、性能 vs 可维护性）讨论各自优劣。</li>
</ul>
<p>在C语言中，链表是最常见的动态数据结构之一。通常我们会为每个节点定义一个包含数据和指针的结构体，用于存储和连接元素。然而，在系统级编程（如Linux内核）中，我们常看到另一种实现方式——“侵入式链表”。</p>
<p>二者虽然都能实现链表功能，但在设计哲学、灵活性与性能上存在显著差异。本文以“学生信息管理系统”为例，展示两种链表设计方式的不同实现与适用场景。</p>
<h3 data-id="heading-1">非侵入式链表（Non-Intrusive Linked List）</h3>
<h4 data-id="heading-2">介绍</h4>
<p>非侵入式链表将“数据”和“链表节点”分离。 链表节点结构独立于业务数据，节点仅负责维护指针关系。</p>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>
​
typedef struct Student {
    int id<span class="hljs-comment">;</span>
    char name<span class="hljs-section">[32]</span><span class="hljs-comment">;</span>
    int age<span class="hljs-comment">;</span>
} Student<span class="hljs-comment">;</span>
​
typedef struct Node {
    Student *data<span class="hljs-comment">;</span>
    struct Node *next<span class="hljs-comment">;</span>
} Node<span class="hljs-comment">;</span>
​
Node *create_node(Student *stu) {
    Node *<span class="hljs-attr">node</span> = malloc(sizeof(Node))<span class="hljs-comment">;</span>
    node-&gt;<span class="hljs-attr">data</span> = stu<span class="hljs-comment">;</span>
    node-&gt;<span class="hljs-attr">next</span> = NULL<span class="hljs-comment">;</span>
    return node<span class="hljs-comment">;</span>
}
​
void append(Node **head, Student *stu) {
    Node *<span class="hljs-attr">new_node</span> = create_node(stu)<span class="hljs-comment">;</span>
    if (*<span class="hljs-attr">head</span> == NULL) {
        *<span class="hljs-attr">head</span> = new_node<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    Node *<span class="hljs-attr">cur</span> = *head<span class="hljs-comment">;</span>
    while (cur-&gt;next) <span class="hljs-attr">cur</span> = cur-&gt;next<span class="hljs-comment">;</span>
    cur-&gt;<span class="hljs-attr">next</span> = new_node<span class="hljs-comment">;</span>
}
​
void print_list(Node *head) {
    while (head) {
        printf("ID: %d, Name: %s, Age: %d\n",
               head-&gt;data-&gt;id, head-&gt;data-&gt;name, head-&gt;data-&gt;age)<span class="hljs-comment">;</span>
        <span class="hljs-attr">head</span> = head-&gt;next<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-4">特点与优劣</h4>
<ul>
<li>✅ 数据结构独立，可被多个链表、哈希表、树结构同时使用。</li>
<li>✅ 修改链表逻辑不会影响业务结构。</li>
<li>❌ 每个节点要单独分配内存（malloc两次），增加内存碎片与访问开销。</li>
<li>❌ 数据和节点分离，局部性（cache locality）较差</li>
</ul>
<h3 data-id="heading-5">侵入式链表（Intrusive Linked List）</h3>
<h4 data-id="heading-6">介绍</h4>
<p>侵入式结构直接将链表指针嵌入业务结构体内部。 数据本身“知道”它属于哪个链表，这种方式常用于<strong>操作系统内核（如Linux list_head）</strong> 和高性能网络框架中。</p>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>
​
typedef struct Student {
    int id<span class="hljs-comment">;</span>
    char name<span class="hljs-section">[32]</span><span class="hljs-comment">;</span>
    int age<span class="hljs-comment">;</span>
    struct Student *next<span class="hljs-comment">; // 侵入式指针</span>
} Student<span class="hljs-comment">;</span>
​
void append(Student **head, Student *stu) {
    stu-&gt;<span class="hljs-attr">next</span> = NULL<span class="hljs-comment">;</span>
    if (*<span class="hljs-attr">head</span> == NULL) {
        *<span class="hljs-attr">head</span> = stu<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    Student *<span class="hljs-attr">cur</span> = *head<span class="hljs-comment">;</span>
    while (cur-&gt;next) <span class="hljs-attr">cur</span> = cur-&gt;next<span class="hljs-comment">;</span>
    cur-&gt;<span class="hljs-attr">next</span> = stu<span class="hljs-comment">;</span>
}
​
void print_list(Student *head) {
    while (head) {
        printf("ID: %d, Name: %s, Age: %d\n",
               head-&gt;id, head-&gt;name, head-&gt;age)<span class="hljs-comment">;</span>
        <span class="hljs-attr">head</span> = head-&gt;next<span class="hljs-comment">;</span>
    }
}
​
</code></pre>
<h4 data-id="heading-8">特点和劣势</h4>
<ul>
<li>✅ 数据与节点合一，内存连续、cache 友好。</li>
<li>✅ 无需额外分配内存，减少开销。</li>
<li>✅ 更适合系统编程、内核模块、高性能场景。</li>
<li>❌ 数据结构耦合性强，不能轻易复用（一个结构体难以同时挂在多个链表上）。</li>
<li>❌ 抽象层次低，可维护性较差。</li>
</ul>
<h3 data-id="heading-9">对比与设计思考</h3>



































<table><thead><tr><th>维度</th><th>非侵入式结构</th><th>侵入式结构</th></tr></thead><tbody><tr><td><strong>内存布局</strong></td><td>数据与节点分离</td><td>数据与节点合一</td></tr><tr><td><strong>封装性</strong></td><td>强，模块独立</td><td>弱，耦合紧密</td></tr><tr><td><strong>性能</strong></td><td>较低（多次 malloc，cache miss）</td><td>高（连续访问）</td></tr><tr><td><strong>通用性</strong></td><td>可适配不同链表/容器</td><td>只能服务于特定链表</td></tr><tr><td><strong>典型场景</strong></td><td>应用层数据结构库</td><td>内核、驱动、高性能系统</td></tr></tbody></table>
<h3 data-id="heading-10">延伸：Linux 内核链表的侵入式设计</h3>
<h4 data-id="heading-11">基本数据结构与初始化</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> *next, *prev;
};
</code></pre>
<p>这就是内核侵入式链表的核心：双向循环链表的节点。任意包含 struct list_head 成员的结构就可以“挂链” —— 这是侵入式设计的本质（链表指针嵌入业务结构）。</p>
<p>常用初始化宏 / 函数：</p>
<ul>
<li>LIST_HEAD_INIT(name)：静态初始化（把 next/prev 都指回自己）。</li>
<li>LIST_HEAD(name)：在定义时同时静态初始化一个 list head。</li>
<li>INIT_LIST_HEAD(struct list_head *list)：运行时将 list-&gt;next = list-&gt;prev = list，把它变成空链表头。实现中会使用 WRITE_ONCE 保证写操作的可见性/内存序。</li>
</ul>
<h4 data-id="heading-12">插入与删除的低级实现</h4>
<p>内核在 list.h 中把对指针的实际修改抽成了 <strong>list_add()、</strong> list_del() 等内部函数，然后在上面封装 list_add() / list_add_tail() / list_del() 等接口。这种分层便于对“批量操作”或“已知邻节点”的优化。基本思想和步骤都是直接操作 next/prev 四个指针。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_add(<span class="hljs-keyword">struct</span> list_head *<span class="hljs-keyword">new</span>,
                  <span class="hljs-keyword">struct</span> list_head *prev,
                  <span class="hljs-keyword">struct</span> list_head *next)
{
    <span class="hljs-keyword">if</span> (!__list_add_valid(<span class="hljs-keyword">new</span>, prev, next))
        <span class="hljs-keyword">return</span>;
    next-&gt;prev = <span class="hljs-keyword">new</span>;
    <span class="hljs-keyword">new</span>-&gt;next = next;
    <span class="hljs-keyword">new</span>-&gt;prev = prev;
    <span class="hljs-built_in">WRITE_ONCE</span>(prev-&gt;next, <span class="hljs-keyword">new</span>);
}
<span class="hljs-comment">/**
 * list_add - add a new entry
 * @new: new entry to be added
 * @head: list head to add it after
 *
 * Insert a new entry after the specified head.
 * This is good for implementing stacks.
 */</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">list_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *<span class="hljs-keyword">new</span>, <span class="hljs-keyword">struct</span> list_head *head)</span>
</span>{
    __list_add(<span class="hljs-keyword">new</span>, head, head-&gt;next);
}
​
<span class="hljs-comment">/**
 * list_del - deletes entry from list.
 * @entry: the element to delete from the list.
 * Note: list_empty() on entry does not return true after this, the entry is
 * in an undefined state.
 */</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_del_entry(<span class="hljs-keyword">struct</span> list_head *entry)
{
    <span class="hljs-keyword">if</span> (!__list_del_entry_valid(entry))
        <span class="hljs-keyword">return</span>;
    __list_del(entry-&gt;prev, entry-&gt;next);
}
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">list_del</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *entry)</span>
</span>{
    __list_del_entry(entry);
    entry-&gt;next = LIST_POISON1;
    entry-&gt;prev = LIST_POISON2;
}
</code></pre>
<h4 data-id="heading-13">访问/类型转换</h4>
<p>侵入式链表的关键是如何从链表节点结构（struct list_head *）回到包含它的业务结构体。内核用两个组成：offsetof（标准宏）+ container_of, container_of 宏的作用是：已知某个结构体成员的指针，通过成员在结构体中的偏移量，计算出包含该成员的结构体的起始地址。简单来说，它可以让你从成员指针“反推出”结构体指针，这是 Linux 内核侵入式数据结构设计中非常常用的技巧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a51fe14d2724607a6d4275bbccbfc07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganpod29scA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630981&amp;x-signature=%2BYYSsWtS8oxbkfbCyZHPEFXKMH8%3D" alt="container_of.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">container_of</span>(ptr, type, member) ({                      \
        const typeof( ((type *)<span class="hljs-number">0</span>)-&gt;member ) *__mptr = (ptr);    \
        (type *)( (char *)__mptr - <span class="hljs-built_in">offsetof</span>(type,member) );})
​
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">offsetof</span>(TYPE, MEMBER) ((size_t) &amp;((TYPE *)<span class="hljs-number">0</span>)-&gt;MEMBER)
​
</code></pre>
<h5 data-id="heading-14">代码示例</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* student_list.c
 *
 * 单文件示例：侵入式链表 + container_of / list_entry
 * 演示：插入、遍历、在遍历中安全删除
 */</span>
​
<span class="hljs-selector-id">#include</span> &lt;stdio<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;stdlib<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;string<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;stddef<span class="hljs-selector-class">.h</span>&gt; <span class="hljs-comment">/* offsetof */</span>
​
<span class="hljs-comment">/* -------------------- 基本类型与宏 -------------------- */</span>
​
<span class="hljs-comment">/* 内核风格的双向循环链表节点 */</span>
struct list_head {
    struct list_head *next, *prev;
};
​
<span class="hljs-comment">/* offsetof 用标准头文件提供 */</span>
​
<span class="hljs-comment">/* 简化版 container_of（可移植）：
 * ptr: 指向 member 的指针
 * type: 包含 member 的结构体类型
 * member: 成员名
 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">container_of</span>(ptr, type, member) \
    ((type *)((char *)(ptr) - <span class="hljs-built_in">offsetof</span>(type, member)))
​
<span class="hljs-comment">/* list_entry: 从 list_head 指针得到包含它的结构体指针 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_entry</span>(ptr, type, member) \
    <span class="hljs-built_in">container_of</span>(ptr, type, member)
​
<span class="hljs-comment">/* 遍历宏：迭代 list_head 指针 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each</span>(pos, head) \
    for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)
​
<span class="hljs-comment">/* 按 entry（宿主结构体）遍历 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each_entry</span>(entry, head, member)                           \
    for (entry = list_entry((head)-&gt;next, <span class="hljs-built_in">typeof</span>(*entry), member);         \
         &amp;entry-&gt;member != (head);                                         \
         entry = <span class="hljs-built_in">list_entry</span>(entry-&gt;member.next, typeof(*entry), member))
​
<span class="hljs-comment">/* 安全遍历：在循环体可能删除当前元素时使用 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each_entry_safe</span>(entry, tmp, head, member)                 \
    for (entry = list_entry((head)-&gt;next, <span class="hljs-built_in">typeof</span>(*entry), member),         \
        tmp = <span class="hljs-built_in">list_entry</span>(entry-&gt;member.next, typeof(*entry), member);      \
         &amp;entry-&gt;member != (head);                                         \
         entry = tmp, tmp = <span class="hljs-built_in">list_entry</span>(tmp-&gt;member.next, typeof(*tmp), member))
​
<span class="hljs-comment">/* LIST 初始化（运行时） */</span>
static inline void <span class="hljs-built_in">INIT_LIST_HEAD</span>(struct list_head *list)
{
    list-&gt;next = list-&gt;prev = list;
}
​
<span class="hljs-comment">/* -------------------- 链表基本操作 -------------------- */</span>
​
<span class="hljs-comment">/* 在 head 后插入 new（头插） */</span>
static inline void <span class="hljs-built_in">__list_add</span>(struct list_head *new,
                              struct list_head *prev,
                              struct list_head *next)
{
    next-&gt;prev = new;
    new-&gt;next = next;
    new-&gt;prev = prev;
    prev-&gt;next = new;
}
​
static inline void <span class="hljs-built_in">list_add</span>(struct list_head *new, struct list_head *head)
{
    <span class="hljs-built_in">__list_add</span>(new, head, head-&gt;next);
}
​
<span class="hljs-comment">/* 在 tail 前插入 new（尾插） */</span>
static inline void <span class="hljs-built_in">list_add_tail</span>(struct list_head *new, struct list_head *head)
{
    <span class="hljs-built_in">__list_add</span>(new, head-&gt;prev, head);
}
​
<span class="hljs-comment">/* 从链表删除 entry（不重置 entry 指针） */</span>
static inline void <span class="hljs-built_in">__list_del</span>(struct list_head * prev, struct list_head * next)
{
    next-&gt;prev = prev;
    prev-&gt;next = next;
}
​
static inline void <span class="hljs-built_in">list_del</span>(struct list_head *entry)
{
    <span class="hljs-built_in">__list_del</span>(entry-&gt;prev, entry-&gt;next);
    <span class="hljs-comment">/* 注意：为了简单，这里不把 entry-&gt;next/prev 置为 POISON 值或 self */</span>
}
​
<span class="hljs-comment">/* -------------------- 学生结构 + 操作 -------------------- */</span>
​
struct student {
    int id;
    char name<span class="hljs-selector-attr">[32]</span>;
    struct list_head list; <span class="hljs-comment">/* 侵入式成员 */</span>
};
​
void <span class="hljs-built_in">add_student_tail</span>(struct list_head *head, int id, const char *name)
{
    struct student *s = <span class="hljs-built_in">malloc</span>(sizeof(*s));
    if (!s) {
        <span class="hljs-built_in">perror</span>("malloc");
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
    s-&gt;id = id;
    <span class="hljs-built_in">strncpy</span>(s-&gt;name, name, sizeof(s-&gt;name) - <span class="hljs-number">1</span>);
    s-&gt;name<span class="hljs-selector-attr">[sizeof(s-&gt;name) - 1]</span> = '\<span class="hljs-number">0</span>';
    <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;s-&gt;list);
    <span class="hljs-built_in">list_add_tail</span>(&amp;s-&gt;list, head);
}
​
void <span class="hljs-built_in">print_students</span>(struct list_head *head)
{
    struct list_head *pos;
    <span class="hljs-built_in">printf</span>("当前学生列表:\n");
    <span class="hljs-built_in">list_for_each</span>(pos, head) {
        struct student *s = <span class="hljs-built_in">list_entry</span>(pos, struct student, list);
        <span class="hljs-built_in">printf</span>("  id=%d, name=%s\n", s-&gt;id, s-&gt;name);
    }
}
​
<span class="hljs-comment">/* 释放链表（安全删除并 free） */</span>
void <span class="hljs-built_in">free_all_students</span>(struct list_head *head)
{
    struct student *s, *tmp;
    <span class="hljs-built_in">list_for_each_entry_safe</span>(s, tmp, head, list) {
        <span class="hljs-built_in">list_del</span>(&amp;s-&gt;list);
        <span class="hljs-built_in">free</span>(s);
    }
}
​
<span class="hljs-comment">/* -------------------- 主程序（演示） -------------------- */</span>
​
int <span class="hljs-selector-tag">main</span>(void)
{
    struct list_head student_list;
    <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;student_list);
​
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1001</span>, "Alice");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1002</span>, "Bob");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1003</span>, "Charlie");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1004</span>, "Diana");
​
    <span class="hljs-built_in">print_students</span>(&amp;student_list);
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-comment">/* 示范：仅有 list_head 指针时，如何用 container_of / list_entry 恢复 student 指针 */</span>
    struct list_head *node = student_list<span class="hljs-selector-class">.next-</span>&gt;next; <span class="hljs-comment">/* 指向 Bob 的节点（第二个） */</span>
    struct student *stu = <span class="hljs-built_in">container_of</span>(node, struct student, list);
    <span class="hljs-built_in">printf</span>("从节点反推到结构体：id=%d, name=%s\n\n", stu-&gt;id, stu-&gt;name);
​
    <span class="hljs-comment">/* 在遍历中安全删除：删除名字以 'C' 开头的学生 */</span>
    <span class="hljs-built_in">printf</span>("在遍历中删除 name 以 'C' 开头的学生...\n");
    struct student *<span class="hljs-selector-tag">p</span>, *<span class="hljs-selector-tag">q</span>;
    <span class="hljs-built_in">list_for_each_entry_safe</span>(p, q, &amp;student_list, list) {
        if (p-&gt;name[<span class="hljs-number">0</span>] == 'C') {
            <span class="hljs-built_in">printf</span>("  删除 %s (id=%d)\n", <span class="hljs-selector-tag">p</span>-&gt;name, <span class="hljs-selector-tag">p</span>-&gt;id);
            <span class="hljs-built_in">list_del</span>(&amp;p-&gt;list);
            <span class="hljs-built_in">free</span>(p);
        }
    }
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-built_in">print_students</span>(&amp;student_list);
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-comment">/* 清理剩余节点 */</span>
    <span class="hljs-built_in">free_all_students</span>(&amp;student_list);
    return <span class="hljs-number">0</span>;
}
​
</code></pre>
<p>编译＆＆运行</p>
<pre><code class="hljs language-ini" lang="ini">gcc -Wall -Wextra -o student_list student_list 
​
./student_list
​
当前学生列表:
  <span class="hljs-attr">id</span>=<span class="hljs-number">1001</span>, name=Alice
  <span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
  <span class="hljs-attr">id</span>=<span class="hljs-number">1003</span>, name=Charlie
  <span class="hljs-attr">id</span>=<span class="hljs-number">1004</span>, name=Diana
​
从节点反推到结构体：<span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
​
在遍历中删除 name 以 'C' 开头的学生...
  删除 Charlie (<span class="hljs-attr">id</span>=<span class="hljs-number">1003</span>)
​
当前学生列表:
  <span class="hljs-attr">id</span>=<span class="hljs-number">1001</span>, name=Alice
  <span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
  <span class="hljs-attr">id</span>=<span class="hljs-number">1004</span>, name=Diana
</code></pre>
<h3 data-id="heading-15">总结</h3>
<ul>
<li>想象一个书架上摆着很多书，每本书都是一个完整的“结构体”。</li>
<li>每本书里都有一个书签（成员），标记你正在看的页。</li>
<li>现在，你手里只有一张书签（就像拿到成员指针），你想知道它属于哪本书（即找到包含它的结构体）。</li>
</ul>
<p>这时：</p>
<ol start="0">
<li>offsetof 就像你知道书签在书里的位置（比如它夹在第 50 页），也就是成员在结构体中的偏移量。</li>
<li>container_of 就像你用书签的位置和它在书里的偏移量，推算出整本书的起始位置，从而拿到整本书的信息。</li>
</ol>
<p>总结形象说法</p>
<ul>
<li>offsetof = 书签在书里的位置</li>
<li>container_of = 通过书签找到整本书</li>
</ul>
<p>也就是说，从局部线索回到整体对象。</p>























































<table><thead><tr><th>特性</th><th>侵入式（Intrusive）</th><th>非侵入式（Non-Intrusive）</th></tr></thead><tbody><tr><td><strong>定义</strong></td><td>链表节点指针嵌入到业务结构体内部</td><td>链表节点独立于业务结构体，通过指针引用业务数据</td></tr><tr><td><strong>内存布局</strong></td><td>成员指针与业务数据在同一内存块内</td><td>节点结构与业务数据分开，通常节点里只保存指针</td></tr><tr><td><strong>示例</strong></td><td>Linux 内核 <code>list_head</code> + <code>task_struct</code> / <code>sk_buff</code></td><td>标准 C++ STL <code>list</code>、Java <code>LinkedList</code>、C 语言中 <code>struct node { void *data; struct node *next; }</code></td></tr><tr><td><strong>性能</strong></td><td>高：少一次内存分配，缓存友好，遍历效率高</td><td>较低：每个节点单独分配，可能导致更多内存分配和访问</td></tr><tr><td><strong>灵活性</strong></td><td>低：业务结构体必须知道链表存在，修改结构体比较困难</td><td>高：业务结构体无需关心链表，可以被多个容器复用</td></tr><tr><td><strong>可复用性</strong></td><td>低：同一对象同时挂多个链表需要多个成员指针</td><td>高：同一对象可被多个链表引用，只需多一个节点或指针</td></tr><tr><td><strong>删除/插入</strong></td><td>直接操作节点指针即可，高效</td><td>需要通过节点找到业务数据，再操作，效率略低</td></tr><tr><td><strong>安全性</strong></td><td>稍低：不小心修改指针容易破坏链表</td><td>较高：节点与数据分离，修改节点不会破坏数据结构本身</td></tr><tr><td><strong>使用场景</strong></td><td>内核、驱动、高性能系统、游戏引擎等</td><td>应用层通用数据结构、业务逻辑、标准库容器</td></tr></tbody></table>
<p>总结一句话</p>
<ul>
<li>
<p>侵入式 = “业务结构体自带链表节点，性能高但耦合紧密”。</p>
</li>
<li>
<p>非侵入式 = “链表节点独立于业务数据，灵活可复用但性能稍低”。</p>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fkernel%2Fcommon%2F%252B%2F3f20ba7d5d1dbcd63d31e1e539a83bd3baace048%2Finclude%2Flinux%2Flist.h" target="_blank" title="https://android.googlesource.com/kernel/common/%2B/3f20ba7d5d1dbcd63d31e1e539a83bd3baace048/include/linux/list.h" ref="nofollow noopener noreferrer">linux内核链表源码链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！]]></title>    <link>https://juejin.cn/post/7572010680896110632</link>    <guid>https://juejin.cn/post/7572010680896110632</guid>    <pubDate>2025-11-13T09:36:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896110632" data-draft-id="7571751593207119924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-13T09:36:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:36:07.000Z" title="Thu Nov 13 2025 09:36:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在做自己的大屏项目，毕竟很多公司还是要求提交自己的作品的。</p>
<p>虽然做的效果一般，但是UI和UE上的体验一定要拉满，给面试官以视觉上的冲击力才是大屏的关键。</p>
<p>在掘金上看到这篇<a href="https://juejin.cn/post/7503716790615228452" target="_blank" title="https://juejin.cn/post/7503716790615228452">文章</a>写的仿百度数字滚动效果，打算比着葫芦画瓢，复刻一个Vue3版本的数字滚动组件。</p>
<p>正好现在一直在用 TRAE，复刻代码也比较简单。</p>
<h2 data-id="heading-0">效果</h2>
<p>数字滚动组件的核心部分就是延迟滚动效果，各个数字从前到后延迟滚动会造成一种非常好的视觉效果。</p>
<p>我一开始以为直接用CSS实现就齐活了，后来发现事情不是这么简单的。</p>
<ul>
<li>每位数字的滚动时间不同，做出前后延迟效果。</li>
<li>数字需要精准的滚动到所需的内容，并且滚动过程需要连贯。</li>
<li>滚动效果上带有一种惯性的感觉。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f9e3f5b48c04cbbb6ffaae6d4e74219~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631367&amp;x-signature=pvLK8AvU67wuHuRqMB2LGsHP920%3D" alt="屏幕录制-2025-11-13-172657.gif" loading="lazy"/></p>
<p>本来想着自己比着来一遍速度也很快，但是低估了内容的难度。</p>
<p>于是乎我打开 TRAE ，将J友的代码拷进去，输入指令：</p>
<p><strong>请帮我将上述代码转换为Vue3的组件代码，我要实现的是一个数字滚动的组件，将每个数字进行分割，最大8位数，不足8位使用0补齐8位。同时每3位增加一个逗号分隔符，每位数字都拥有自己的背景，类似于记分牌的效果。</strong></p>
<p>1，2，3.....</p>
<p>于是乎以下的代码就输出了出来！</p>
<h2 data-id="heading-1">实现代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_digit, index) in numList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`digit-container${index+1}`"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"digitListRefs"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-list"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup2-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"index === 1 || index === 4"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-split"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`split-${index}`"</span>&gt;</span>,<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>Ps: TRAE提醒我，每个需要滚动的数字组件一定要通过 <code>v-for</code> 循环创建，即便你的数字位数是固定的。</p>
<p>因为Vue3中只有通过<code>v-for</code>定义相同的<code>ref</code>才会被归纳到一个数组中。</p>
<p>单纯的写多个<code>div</code>其<code>ref</code>相同的话，并不是数组，而是一个对象，指向最后一个<code>DOM</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> props = defineProps&lt;{
    <span class="hljs-attr">num</span>: number
}&gt;()
<span class="hljs-keyword">const</span> digitListRefs = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>[]&gt;([])

<span class="hljs-keyword">const</span> numList = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> numStr = <span class="hljs-title class_">String</span>(props.<span class="hljs-property">num</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'0'</span>);
    <span class="hljs-keyword">return</span> numStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
});

<span class="hljs-title function_">watch</span>(numList, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">startAnimate</span>();
    })
}, {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">startAnimate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> digits = numList.<span class="hljs-property">value</span>;
    digitListRefs.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>)) {
            <span class="hljs-keyword">const</span> list = element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
            <span class="hljs-keyword">const</span> targetDigit = <span class="hljs-built_in">parseInt</span>(digits[i], <span class="hljs-number">10</span>);
            <span class="hljs-keyword">const</span> targetY = -(<span class="hljs-number">20</span> + targetDigit) * <span class="hljs-number">50</span>;

            list.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${targetY}</span>px)`</span>;
        }
    });
}
</code></pre>
<p>Ps: 这里注意，我设置的数字最大8位数，逻辑上是不足8位以0补全。</p>
<h2 data-id="heading-2">完整组件代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {ref, defineProps, computed, watch, nextTick} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
    <span class="hljs-attr">num</span>: number
}&gt;()

<span class="hljs-keyword">const</span> digitListRefs = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>[]&gt;([])

<span class="hljs-keyword">const</span> numList = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> numStr = <span class="hljs-title class_">String</span>(props.<span class="hljs-property">num</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'0'</span>);
    <span class="hljs-keyword">return</span> numStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
});

<span class="hljs-title function_">watch</span>(numList, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">startAnimate</span>();
    })
}, {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">startAnimate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> digits = numList.<span class="hljs-property">value</span>;
    digitListRefs.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>)) {
            <span class="hljs-keyword">const</span> list = element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
            <span class="hljs-keyword">const</span> targetDigit = <span class="hljs-built_in">parseInt</span>(digits[i], <span class="hljs-number">10</span>);
            <span class="hljs-keyword">const</span> targetY = -(<span class="hljs-number">20</span> + targetDigit) * <span class="hljs-number">50</span>;

            list.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${targetY}</span>px)`</span>;
        }
    });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic-content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_digit, index) in numList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`digit-container${index+1}`"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"digitListRefs"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-list"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup2-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"index === 1 || index === 4"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-split"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`split-${index}`"</span>&gt;</span>,<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"less"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.num-statistic-content</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">12px</span>;
}

<span class="hljs-selector-class">.digit-container1</span>,
<span class="hljs-selector-class">.digit-container2</span>,
<span class="hljs-selector-class">.digit-container3</span>,
<span class="hljs-selector-class">.digit-container4</span>,
<span class="hljs-selector-class">.digit-container5</span>,
<span class="hljs-selector-class">.digit-container6</span>,
<span class="hljs-selector-class">.digit-container7</span>,
<span class="hljs-selector-class">.digit-container8</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">36px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#244193</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;

    <span class="hljs-selector-class">.digit</span> {
        <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">justify-content</span>: center;
    }
}

<span class="hljs-selector-class">.digit-container1</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1720ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container2</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1760ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container3</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1800ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container4</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1840ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container5</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1880ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container6</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1920ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container7</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1960ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container8</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">2000ms</span> ease-in-out;
}

<span class="hljs-selector-class">.num-split</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>最后非常感谢这位兄弟<code>@三个木base</code>的思路及源码，再次感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 5.0+ 重要新特性全面解析]]></title>    <link>https://juejin.cn/post/7572004684178473014</link>    <guid>https://juejin.cn/post/7572004684178473014</guid>    <pubDate>2025-11-13T09:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178473014" data-draft-id="7571829879827349523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 5.0+ 重要新特性全面解析"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-13T09:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西芹术士"/> <meta itemprop="url" content="https://juejin.cn/user/2700860856743672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 5.0+ 重要新特性全面解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700860856743672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西芹术士
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:39:54.000Z" title="Thu Nov 13 2025 09:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将详细介绍 TypeScript 自 5.0 版本以来的重要更新，帮助开发者了解并应用这些新特性来提升开发效率和代码质量。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📅 TypeScript 5.0 (2023年3月)</h2>
<h3 data-id="heading-1">1. 装饰器（Decorators）正式支持</h3>
<p>TypeScript 5.0 正式支持了 ECMAScript Stage 3 的装饰器提案，这是一个里程碑式的更新。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 类装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">logged</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span>, context: ClassDecoratorContext</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> value {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
      <span class="hljs-variable language_">super</span>(...args);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`创建了 <span class="hljs-subst">${context.name}</span> 的实例`</span>);
    }
  };
}

<span class="hljs-meta">@logged</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-comment">// 方法装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, context: ClassMethodDecoratorContext</span>) {
  <span class="hljs-keyword">const</span> methodName = <span class="hljs-title class_">String</span>(context.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: <span class="hljs-built_in">any</span>, ...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`调用方法: <span class="hljs-subst">${methodName}</span>`</span>);
    <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-meta">@log</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> a + b;
  }
}
</code></pre>
<h3 data-id="heading-2">2. const 类型参数</h3>
<p>允许在泛型中使用 <code>const</code> 修饰符，锁定类型为字面量类型。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 不使用 const</span>
<span class="hljs-function">function <span class="hljs-title">makeArray</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">arr: T[]</span>)</span> {
  <span class="hljs-keyword">return</span> arr;
}
<span class="hljs-keyword">const</span> arr1 = makeArray([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// number[]</span>

<span class="hljs-comment">// 使用 const</span>
<span class="hljs-function">function <span class="hljs-title">makeConstArray</span>&lt;<span class="hljs-title">const</span> <span class="hljs-title">T</span>&gt;(<span class="hljs-params">arr: T[]</span>)</span> {
  <span class="hljs-keyword">return</span> arr;
}
<span class="hljs-keyword">const</span> arr2 = makeConstArray([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// readonly [1, 2, 3]</span>
</code></pre>
<h3 data-id="heading-3">3. 枚举改进</h3>
<p>所有枚举成员现在都可以作为联合枚举使用。</p>
<pre><code class="hljs language-javascript" lang="javascript">enum <span class="hljs-title class_">Status</span> {
  <span class="hljs-title class_">Loading</span> = <span class="hljs-string">"loading"</span>,
  <span class="hljs-title class_">Success</span> = <span class="hljs-string">"success"</span>,
  <span class="hljs-title class_">Error</span> = <span class="hljs-string">"error"</span>
}

<span class="hljs-comment">// 可以直接用作类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStatus</span>(<span class="hljs-params">status: Status</span>) {
  <span class="hljs-keyword">switch</span> (status) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Loading</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"加载中..."</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Success</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"成功！"</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Error</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"错误！"</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">📅 TypeScript 5.1 (2023年6月)</h2>
<h3 data-id="heading-5">1. get/set 访问器类型解耦</h3>
<p>允许 getter 和 setter 使用不同的类型，提供更灵活的 API 设计。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Thing</span> {
  <span class="hljs-meta">#size = 0;</span>

  <span class="hljs-comment">// getter 返回 number</span>
  <span class="hljs-function">get <span class="hljs-title">size</span><span class="hljs-params">()</span>: number {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-meta">#size;</span>
  }

  <span class="hljs-comment">// setter 可以接受 number | string</span>
  set <span class="hljs-built_in">size</span>(value: number | string) {
    <span class="hljs-keyword">this</span>.<span class="hljs-meta">#size = typeof value === <span class="hljs-string">'string'</span> ? parseInt(value) : value;</span>
  }
}

<span class="hljs-type">const</span> thing = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thing</span>();
thing.size = <span class="hljs-string">"42"</span>; <span class="hljs-comment">// ✅ 可以传字符串</span>
console.<span class="hljs-built_in">log</span>(thing.size); <span class="hljs-comment">// 42 (number)</span>
</code></pre>
<h3 data-id="heading-6">2. 未定义返回函数的改进</h3>
<p>更好地处理返回 <code>undefined</code> 的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 之前可能需要显式返回 undefined</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>): <span class="hljs-literal">undefined</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"做点什么"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
}

<span class="hljs-comment">// 现在可以省略 return</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomethingElse</span>(<span class="hljs-params"/>): <span class="hljs-literal">undefined</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"做点别的"</span>);
  <span class="hljs-comment">// 不需要显式 return</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">📅 TypeScript 5.2 (2023年8月)</h2>
<h3 data-id="heading-8">1. using 声明和显式资源管理</h3>
<p>支持 ECMAScript 的显式资源管理提案，自动清理资源。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 实现 Disposable 接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileHandle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Disposable</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">file</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">filename: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span> = filename;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`打开文件: <span class="hljs-subst">${filename}</span>`</span>);
  }

  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">dispose</span>]() {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`关闭文件: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.file}</span>`</span>);
    <span class="hljs-comment">// 清理资源</span>
  }

  <span class="hljs-title function_">read</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`读取 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.file}</span> 的内容`</span>;
  }
}

<span class="hljs-comment">// 使用 using 声明</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processFile</span>(<span class="hljs-params"/>) {
  using file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandle</span>(<span class="hljs-string">"data.txt"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-title function_">read</span>());
  <span class="hljs-comment">// 函数结束时自动调用 [Symbol.dispose]</span>
}
</code></pre>
<h3 data-id="heading-9">2. 装饰器元数据</h3>
<p>增强装饰器功能，支持元数据反射。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setMetadata</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, context: DecoratorContext</span>) =&gt;</span> {
    context.<span class="hljs-property">metadata</span>[key] = value;
  };
}

<span class="hljs-meta">@setMetadata</span>(<span class="hljs-string">"version"</span>, <span class="hljs-string">"1.0"</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {}
</code></pre>
<hr/>
<h2 data-id="heading-10">📅 TypeScript 5.3 (2023年11月)</h2>
<h3 data-id="heading-11">1. Import Attributes 支持</h3>
<p>支持导入断言的标准化语法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入 JSON 文件</span>
<span class="hljs-keyword">import</span> data <span class="hljs-keyword">from</span> <span class="hljs-string">"./data.json"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"json"</span> };

<span class="hljs-comment">// 导入 CSS 模块</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./styles.css"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"css"</span> };
</code></pre>
<h3 data-id="heading-12">2. switch(true) 收窄</h3>
<p>改进 <code>switch(true)</code> 语句中的类型收窄。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processValue</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">switch</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>:
      <span class="hljs-comment">// value 被收窄为 string</span>
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toUpperCase</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"number"</span>:
      <span class="hljs-comment">// value 被收窄为 number</span>
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">📅 TypeScript 5.4 (2024年3月)</h2>
<h3 data-id="heading-14">1. NoInfer 工具类型</h3>
<p>防止类型推断在特定位置发生，提供更精确的类型控制。</p>
<pre><code class="hljs language-ini" lang="ini">function createMap&lt;T&gt;(
  keys: T<span class="hljs-section">[]</span>,
  defaultValue: NoInfer&lt;T&gt;
): Map&lt;T, T&gt; {
  const <span class="hljs-attr">map</span> = new Map&lt;T, T&gt;()<span class="hljs-comment">;</span>
  keys.forEach(<span class="hljs-attr">key</span> =&gt; map.set(key, defaultValue))<span class="hljs-comment">;</span>
  return map<span class="hljs-comment">;</span>
}

// T 只从 keys 推断，不从 defaultValue 推断
const <span class="hljs-attr">map1</span> = createMap([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>], <span class="hljs-string">"default"</span>)<span class="hljs-comment">; // Map&lt;string, string&gt;</span>
const <span class="hljs-attr">map2</span> = createMap([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; // Map&lt;number, number&gt;</span>
</code></pre>
<h3 data-id="heading-15">2. Object.groupBy 和 Map.groupBy 支持</h3>
<p>支持新的 JavaScript 分组方法。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">const</span> <span class="hljs-string">people</span> <span class="hljs-string">=</span> [
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span> },
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span> },
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span> }
]<span class="hljs-string">;</span>

<span class="hljs-string">const</span> <span class="hljs-string">grouped</span> <span class="hljs-string">=</span> <span class="hljs-string">Object.groupBy(people,</span> <span class="hljs-string">person</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">person.age);</span>
<span class="hljs-string">//</span> { <span class="hljs-attr">25:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>}, {<span class="hljs-attr">name:</span> <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>}], 
<span class="hljs-string">//</span>   <span class="hljs-attr">30:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span>}] }
</code></pre>
<hr/>
<h2 data-id="heading-16">📅 TypeScript 5.5 (2024年6月)</h2>
<h3 data-id="heading-17">1. 推断类型谓词（Inferred Type Predicates）</h3>
<p>自动推断函数是否为类型守卫，无需手动编写类型谓词。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 之前需要显式声明类型谓词</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-comment">// 现在 TypeScript 可以自动推断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isStringAuto</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">values</span>: <span class="hljs-built_in">unknown</span>[] = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"world"</span>];
<span class="hljs-comment">// TypeScript 能识别 filter 后的类型</span>
<span class="hljs-keyword">const</span> strings = values.<span class="hljs-title function_">filter</span>(isStringAuto); <span class="hljs-comment">// string[]</span>
</code></pre>
<h3 data-id="heading-18">2. 常量索引访问的控制流收窄</h3>
<p>改进对常量索引访问的类型分析。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">function</span> processData(data: { status: <span class="hljs-string">"success"</span>; value: number } | { status: <span class="hljs-string">"error"</span>; <span class="hljs-keyword">error</span>: <span class="hljs-type">string</span> }) {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">key</span> = <span class="hljs-string">"status"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
  
  <span class="hljs-keyword">if</span> (data[<span class="hljs-keyword">key</span>] === <span class="hljs-string">"success"</span>) {
    // data 被正确收窄为 { status: <span class="hljs-string">"success"</span>; value: number }
    console.log(data.value);
  } <span class="hljs-keyword">else</span> {
    // data 被正确收窄为 { status: <span class="hljs-string">"error"</span>; <span class="hljs-keyword">error</span>: <span class="hljs-type">string</span> }
    console.log(data.<span class="hljs-keyword">error</span>);
  }
}
</code></pre>
<h3 data-id="heading-19">3. 正则表达式语法检查</h3>
<p>在字符串字面量中检查正则表达式语法错误。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ❌ 编译时报错：无效的正则表达式</span>
<span class="hljs-type">const</span> invalidRegex = /[/;

<span class="hljs-comment">// ✅ 正确的正则表达式</span>
<span class="hljs-type">const</span> validRegex = /[/;
</code></pre>
<h3 data-id="heading-20">4. 数组过滤增强</h3>
<p>更智能的数组 <code>filter</code> 方法类型推断。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">mixed</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>)[] = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"world"</span>, <span class="hljs-literal">null</span>];

<span class="hljs-comment">// 自动推断过滤后的类型</span>
<span class="hljs-keyword">const</span> nonNull = mixed.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x !== <span class="hljs-literal">null</span>); <span class="hljs-comment">// (string | number)[]</span>
<span class="hljs-keyword">const</span> strings = mixed.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">"string"</span>); <span class="hljs-comment">// string[]</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">📅 TypeScript 5.6 (2024年9月)</h2>
<h3 data-id="heading-22">1. 可变元组支持</h3>
<p>增强的元组类型功能，支持更灵活的元组操作。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 可变元组类型</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Prefixed&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">unknown</span>[]<span class="hljs-title">&gt;</span> </span>= [string, ...<span class="hljs-type">T</span>];

<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Example1</span> </span>= <span class="hljs-type">Prefixed</span>&lt;[number, boolean]&gt;; <span class="hljs-comment">// [string, number, boolean]</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Example2</span> </span>= <span class="hljs-type">Prefixed</span>&lt;[]&gt;; <span class="hljs-comment">// [string]</span>
</code></pre>
<hr/>
<h2 data-id="heading-23">📅 TypeScript 5.7 (2024年11月)</h2>
<h3 data-id="heading-24">1. ES2024 特性集成</h3>
<p>完整支持最新的 ECMAScript 2024 特性。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持 Promise.withResolvers</span>
<span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span>&lt;<span class="hljs-built_in">number</span>&gt;();

<span class="hljs-comment">// 支持 Array.fromAsync</span>
<span class="hljs-keyword">const</span> asyncIterable = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
};
<span class="hljs-keyword">const</span> array = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">fromAsync</span>(<span class="hljs-title function_">asyncIterable</span>());
</code></pre>
<h3 data-id="heading-25">2. 模块解析改进</h3>
<p>更好的路径重写和模块解析能力。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@components/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/components/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-26">📅 TypeScript 5.8 (2025年3月)</h2>
<h3 data-id="heading-27">1. 返回表达式中的分支类型检查增强</h3>
<p>改进对返回语句中条件表达式的类型检查。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params">condition: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> {
  <span class="hljs-comment">// TypeScript 5.8 更精确地推断返回类型</span>
  <span class="hljs-keyword">return</span> condition 
    ? <span class="hljs-string">"string value"</span>  <span class="hljs-comment">// string</span>
    : <span class="hljs-number">42</span>;             <span class="hljs-comment">// number</span>
}
</code></pre>
<h3 data-id="heading-28">2. 稳定的 <code>--module node18</code> 标志</h3>
<p>为 Node.js 18+ 用户提供稳定的模块系统支持。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node18"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node18"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-29">3. 直接执行支持</h3>
<p>简化 TypeScript 代码的直接执行流程，提升开发体验。</p>
<hr/>
<h2 data-id="heading-30">🎯 总结</h2>
<p>TypeScript 5.x 系列版本带来了众多重要特性：</p>
<h3 data-id="heading-31">🔑 核心亮点</h3>
<ol>
<li><strong>装饰器标准化</strong> - 正式支持 ECMAScript 装饰器</li>
<li><strong>资源管理</strong> - <code>using</code> 声明自动清理资源</li>
<li><strong>类型推断增强</strong> - 自动推断类型守卫、更好的控制流分析</li>
<li><strong>开发体验</strong> - 正则语法检查、更好的错误提示</li>
<li><strong>ECMAScript 对齐</strong> - 紧跟最新 JavaScript 标准</li>
</ol>
<h3 data-id="heading-32">📊 升级建议</h3>
<ul>
<li><strong>从 4.x 升级到 5.x</strong>: 强烈推荐，性能和类型安全性大幅提升</li>
<li><strong>渐进式采用</strong>: 新特性可以逐步引入，不会破坏现有代码</li>
<li><strong>关注装饰器</strong>: 如果使用旧版装饰器，需要迁移到新语法</li>
</ul>
<h3 data-id="heading-33">🔗 参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Frelease-notes%2Foverview.html" target="_blank" title="https://www.typescriptlang.org/docs/handbook/release-notes/overview.html" ref="nofollow noopener noreferrer">TypeScript 官方发布日志</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FTypeScript" target="_blank" title="https://github.com/microsoft/TypeScript" ref="nofollow noopener noreferrer">TypeScript GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fplay" target="_blank" title="https://www.typescriptlang.org/play" ref="nofollow noopener noreferrer">TypeScript 演练场</a></li>
</ul>
<hr/>
<p><strong>你最喜欢哪个新特性？欢迎在评论区讨论！</strong> 💬</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？]]></title>    <link>https://juejin.cn/post/7572002432450756617</link>    <guid>https://juejin.cn/post/7572002432450756617</guid>    <pubDate>2025-11-13T09:51:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450756617" data-draft-id="7572016447804588058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-13T09:51:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:35.000Z" title="Thu Nov 13 2025 09:51:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 源码泄露</h2>
<p>上周苹果 App Store 前端源码泄露，因其生产环境忘记关闭 Sourcemap，被用户下载了源码，上传到 Github。短短几天就已经 Fork 和 Star 超 5k。</p>
<p>当然现在仓库已经被 ban 了，当你打开仓库的时候，GitHub 会提示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bec1ea4ab594ecaa1dd2d35a8e140b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=Pxg4NjG37hRvG4z1T3sbXiU6Qg8%3D" alt="" loading="lazy"/></p>
<p>千万不要以为自己有 fork 就安全了，fork 的仓库也一同被删除了，据说删了 8000 多个相关仓库，足以看到当时大家凑热闹的热情 😂</p>
<h2 data-id="heading-1">2. 还想找源码？</h2>
<p>如果你还想看看泄露的代码，GitHub 可能已经不好找了，但国内的 Gitee 上依然可以找到。</p>
<p>在 Gitee 搜索 <code>apps.apple.com</code> 可以看到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c44dbffdc9994eb4b1d67ad624f8f599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=64KttuLffBcEytf8HbqIhUj3Zzg%3D" alt="" loading="lazy"/></p>
<p>如果你想找可运行的版本，可以搜索 <code>test-apps.apple.com-main</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd633b2cd4cd44ba9b3985e12dd4c5bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=SfoMOf2RKmzdSMDay6E1I2xO14k%3D" alt="" loading="lazy"/></p>
<p>不过说是可运行，其实只是本地起个服务静态预览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244729dcf28740e68611784db38cae44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=nzyXhkxI7G3uIMcbuJntbpHEwyg%3D" alt="" loading="lazy"/></p>
<p>如果要从源码运行，因为仓库引用了私有包，相对来说还是难处理的。</p>
<p>关于源码，还可以阅读我的这篇《看了下昨日泄露的苹果 App Store 源码……》</p>
<h2 data-id="heading-2">3. 类似事件</h2>
<p>不过这次泄露的只是苹果 App Store 的前端源码，对业务并没有什么影响，仓库在几天后才删除。如果泄露的后端代码，那可能就要紧张很多了。</p>
<p>其实这事之前也发生过，2019 年的时候，B 站的后端源码就被泄露了，10 点上传的源码，16 点大量吃瓜群众涌入，17 点就因 DMCA 被 ban 了。这事之后，很多仿 B 站架构的项目如雨后春笋，甚至还掀起了一股学习 Go 语言的热潮 😂</p>
<p>大家在源码中更是挖了不少内容，比如用户名密码被硬编码在代码中，暗箱操作抽奖成功率，代码不规范，发现在代码里画画、写诗、画颜文字、吐槽甚至贴广告，一度导致 B 站股价下跌。</p>
<p>相比之下，苹果这次的后果很轻了，而且源码里也没什么画画、写诗，整体是比较规范有序的。</p>
<h2 data-id="heading-3">4. DMCA</h2>
<p>说回 DMCA，全称 Digital Millennium Copyright Act，中文翻译为“数字千年版权法”，又称“千禧年数字版权法”，是美国 1998 年颁布的联邦法律，旨在应对数字时代的著作权保护问题。</p>
<p>其主要目的是保护数字内容（如音乐、电影、文字、图像等）的著作权，并为在线服务提供商（如 Google 等）提供了免除因用户上传侵权内容而产生的金钱赔偿责任的安全港规则。<strong>这意味着在线服务提供商在收到版权所有者的侵权通知后，若能及时移除侵权内容，则可免受法律追责。</strong></p>
<p><strong>GitHub 有专门的仓库记录 DMCA 的公开通知：</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fdmca" target="_blank" title="https://github.com/github/dmca" ref="nofollow noopener noreferrer"><strong>https://github.com/github/dmca</strong></a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d7515169ed4fe9a92ff9a980d1155a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=JTeq14xDeYUQ041FCM5PdSjmL8U%3D" alt="" loading="lazy"/></p>
<p>从中可以翻到 11 月 7 日的 apple 仓库相关的通知：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bd1d2974c1470b8ef1009ff4612d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=y8zV3JrOfBNzdgvd%2Bt2jSJp71FQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[下一代桌面应用框架 - Tauri 尝鲜]]></title>    <link>https://juejin.cn/post/7571815997067935784</link>    <guid>https://juejin.cn/post/7571815997067935784</guid>    <pubDate>2025-11-13T09:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997067935784" data-draft-id="7571768210716082191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="下一代桌面应用框架 - Tauri 尝鲜"/> <meta itemprop="keywords" content="前端框架,Electron"/> <meta itemprop="datePublished" content="2025-11-13T09:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节逆旅"/> <meta itemprop="url" content="https://juejin.cn/user/2471357871561214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            下一代桌面应用框架 - Tauri 尝鲜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2471357871561214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节逆旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:51.000Z" title="Thu Nov 13 2025 09:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前我写过一篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSKmJoeDJHymMLUj1QR4V7A" target="_blank" title="https://mp.weixin.qq.com/s/SKmJoeDJHymMLUj1QR4V7A" ref="nofollow noopener noreferrer">文章</a>，介绍了<code>pake</code>这个小玩具，今天我来说一说它的亲爹<code>Tauri</code>。</p>
<hr/>
<p>做过桌面应用打包的前端同学，对 <code>Electron</code> 的名声肯定是如雷贯耳。它可以用我们熟悉的 Web 技术构建跨平台的桌面应用，VS Code、Slack、Discord 等众多知名应用都是基于它构建的。然而，<code>Electron</code> 的“缺点”也很明显：打包体积大、内存占用高，特别是在弱网传输的时候，这个毛病影响很大。。</p>
<p>接下来，我来介绍一个正在悄摸摸崛起的挑战者——<code>Tauri</code>。我掐指算过了，它会是下一代桌面应用框架！</p>
<h3 data-id="heading-0">Tauri 是什么？</h3>
<p>我先简单介绍一下 <code>tauri</code> 框架。
<code>Tauri</code> 是一个为构建更小、更快、更安全的桌面应用程序而设计的框架。它和 <code>Electron</code> 一样，允许你使用任何前端框架（如 React、Vue、Svelte 或原生 HTML/CSS/JS）来构建用户界面。
但它的核心思想与 <code>Electron</code> 有本质区别：</p>
<ol>
<li><strong>更小的体积</strong>：<code>Electron</code> 内置了一个完整的 Chromium 浏览器，所以每个应用都至少要带上 100MB+ 的基础文件。而 <code>Tauri</code> 则使用操作系统自带的 WebView（Windows 上的 Webview2，macOS 上的 WebKit，Linux 上的 WebKitGTK）。这意味着你的应用本身不包含浏览器，体积可以轻松做到 10MB 以下，甚至更小。</li>
<li><strong>更低的资源占用</strong>：由于不自带浏览器，<code>Tauri</code> 应用的内存占用和 CPU 消耗远低于 <code>Electron</code> 应用，运行起来更加轻快。</li>
<li><strong>后端使用 Rust</strong>：<code>Tauri</code> 的后端核心是用 Rust 编写的。Rust 以其高性能、内存安全和并发性著称，这为桌面应用提供了坚实、安全的后端基础。你可以通过简单的 JS API 调用 Rust 代码，处理文件系统、执行 Shell 命令等操作，既安全又高效。</li>
<li><strong>安全优先</strong>：<code>Tauri</code> 默认采用“权限最小化”原则。你需要在一个叫 <code>allowlist</code>（允许列表）的配置文件中，明确开启你的应用需要使用的 API（如文件读写、网络请求等），这大大降低了应用的安全风险。
总而言之，<code>Tauri</code> 用“借力”的方式，解决了 <code>Electron</code> 最大的体积和性能问题，同时用 Rust 提供了一个强大而安全的后端，这正是它被称为“下一代”框架的原因。目前<code>Tauri</code>版本已经到了2.0，本文后面用的也是这个版本。</li>
</ol>
<hr/>
<h3 data-id="heading-1">Windows 系统安装 Tauri</h3>
<p>接下来我带你在 <code>windows</code> 系统安装一下 <code>tauri</code> 框架，后面有空我再介绍一下在 <code>ubuntu</code> 系统中的安装方法。
在开始之前，<code>Tauri</code> 需要两个核心依赖：Rust 语言环境和 C++ 编译工具链。</p>
<h4 data-id="heading-2">1. 安装 Rust</h4>
<p><code>Tauri</code> 的后端是 Rust，所以首先需要安装 Rust。
访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frust-lang.org%2Ftools%2Finstall%2F" target="_blank" title="https://rust-lang.org/tools/install/" ref="nofollow noopener noreferrer">rust-lang.org/tools/insta…</a>
下载并运行 <code>rustup-init.exe</code>，按照提示安装即可。安装完成后，它会提示你重启终端或重新加载环境变量。</p>
<h4 data-id="heading-3">2. 安装 Microsoft C++ 生成工具</h4>
<p>在 Windows 上编译 Rust 和一些原生 Node.js 模块需要 C++ 构建工具。
访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualstudio.microsoft.com%2Fzh-hans%2Fvisual-cpp-build-tools%2F" target="_blank" title="https://visualstudio.microsoft.com/zh-hans/visual-cpp-build-tools/" ref="nofollow noopener noreferrer">visualstudio.microsoft.com/zh-hans/vis…</a>
下载“Microsoft C++ 生成工具”。在安装程序中，只用勾选“使用 C++ 的桌面开发”，然后安装即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8f0ef17883b48b6aef4975df231852c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6YCG5peF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632882&amp;x-signature=HCc25Mxi1xkq2mEF%2F5DFzN7juN0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">3. 确认环境</h4>
<p>打开一个新的终端（CMD 或 PowerShell），输入以下命令，如果都能正常显示版本号，说明环境就绪了。</p>
<pre><code class="hljs language-bash" lang="bash">rustc --version
npm --version
</code></pre>
<hr/>
<h3 data-id="heading-5">Tauri 初体验：打包一个远程 URL</h3>
<h4 data-id="heading-6">1. 准备一个前端项目</h4>
<p>我直接把一个项目复制过来，把代码管理相关文件夹删除，依赖也可以删除，然后存在一个文件夹里，就用这个项目来试下效果。</p>
<ol start="3">
<li>在项目根目录初始化 <code>npm</code> 项目：
<pre><code class="hljs language-bash" lang="bash">npm init -y
</code></pre>
这会生成一个 <code>package.json</code> 文件。</li>
</ol>
<h4 data-id="heading-7">2. 初始化 Tauri</h4>
<p>把这个实验项目用vscode打开，然后执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Tauri CLI 作为开发依赖</span>
npm install -D @tauri-apps/cli@latest 
<span class="hljs-comment"># 初始化 Tauri 项目</span>
npm run tauri init
</code></pre>
<p>执行 <code>init</code> 命令时，它会问你几个问题，比如应用名称、窗口标题等，一路回车使用默认值即可。</p>
<p>这会创建一个 <code>src-tauri</code> 目录，这就是 <code>Tauri</code> 框架的后端部分。里面包含了 Rust 代码和关键的配置文件 <code>tauri.conf.json</code>。</p>
<h4 data-id="heading-8">3. 尝鲜 Tauri</h4>
<p>安装好了之后，咱先尝个鲜，把本地跑起来的应用打包进去呢？
看起来，如果只是打包一个url，这个包会相当的小。如果我把这个前端应用在服务器上用nginx部署，然后再用<code>tauri</code>打包，会不会比较有意思？
是的，这是一个非常有趣的应用场景！你可以创建一个“壳应用”，它本身不包含任何业务逻辑，只是加载一个远程的 Web 地址。这样做的好处是：</p>
<ul>
<li><strong>体积极小</strong>：应用本身只有几 MB，用户下载飞快。</li>
<li><strong>热更新</strong>：你只需要更新服务器上的网页，所有用户的桌面应用内容就自动更新了，无需重新分发安装包。
要实现这个，只需在 <code>tauri.conf.json</code> 配置文件中修改 <code>window.url</code> 字段：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// src-tauri/tauri.conf.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"devUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://your-nginx-deployed-app.com"</span> <span class="hljs-comment">// 改成你的网址</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>不过，这种方式的缺点是应用部署必须得配一个nginx，安装过程不够简单，有点拖泥带水。</p>
<hr/>
<h3 data-id="heading-9">Tauri 实战：打包本地前端应用</h3>
<p>所以，我依然想用tauri打包一个包含所有前端应用内容的本地包，不依赖于url。来吧！
我带你创建一个完整的前端项目并将其打包成一个独立的桌面应用。</p>
<h4 data-id="heading-10">1. 修改配置</h4>
<p>前面只是尝鲜，只用到<code>devUrl</code>这个配置。接下来将是最关键的一步！你需要根据你的项目结构，修改 <code>src-tauri/tauri.conf.json</code> 文件。我这里给出一个配置文件的模板，里面有详细说明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../node_modules/@tauri-apps/cli/config.schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tauri Demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 这里要注意，会有一些格式要求，按提示改就行</span>
  <span class="hljs-attr">"identifier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.tauri.demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"beforeDevCommand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"beforeBuildCommand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pm run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 告诉 Tauri 你的前端静态文件（HTML, JS, CSS）在哪个目录</span>
    <span class="hljs-attr">"frontendDist"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../dist"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"app"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"windows"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 给窗口一个唯一的 label</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tauri Demo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"width"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">800</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"height"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">600</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"resizable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"fullscreen"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"security"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"csp"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span> <span class="hljs-comment">// 内容安全策略，开发阶段可以设为 null</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bundle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"icons/32x32.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/128x128.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/128x128@2x.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/icon.icns"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/icon.ico"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span> <span class="hljs-comment">// 插件配置，后面会用到</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点解释</strong>：</p>
<ul>
<li><code>frontendDist</code>: 这是 Tauri 2.0 的新字段，替代了旧版的 <code>distDir</code>。它指向你构建完成后的前端资源目录。对于vue项目，直接指向根目录 <code>"../dist"</code> 即可。</li>
<li><code>beforeDevCommand</code> / <code>beforeBuildCommand</code>: 意思是在执行  <code>Tauri</code>的构建之前，会执行这些项目本身的 <code>npm run dev</code> 或 <code>npm run build</code> 脚本。</li>
<li><code>app.windows</code>: 窗口配置现在被放在 <code>app</code> 对象下。给窗口加了一个 <code>label: "main"</code>，这在权限配置时会用到。</li>
<li><code>plugins</code>: Tauri 2.0 的核心功能（如文件系统、Shell）都通过插件提供。需要在这里声明使用的插件。</li>
</ul>
<h4 data-id="heading-11">2. 开发与运行</h4>
<p>配置完成后，就可以启动开发模式了。直接运行即可：</p>
<pre><code class="hljs language-bash" lang="bash">npm run tauri dev
</code></pre>
<p>这会先执行<code>npm run dev</code>，然后编译 Rust 后端，然后直接弹出一个桌面窗口，里面加载的就是你的 <code>index.html</code> 页面。当你修改项目文件并保存时，窗口会自动刷新，这就是热重载。</p>
<h4 data-id="heading-12">3. 构建最终安装包</h4>
<p>当你对应用满意后，就可以执行构建命令了：</p>
<pre><code class="hljs language-bash" lang="bash">npm run tauri build
</code></pre>
<p>下面这张图是执行<code>npm run tauri:build</code>后的效果，它会先执行<code>npm run build</code>，构建本地的打包文件，然后再从dist文件夹下面获取静态文件并打包为最终包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4430943ef5d040acafb88e8f7d94c346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6YCG5peF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632882&amp;x-signature=z3d1yFl74flVUbs4aVcBDLb8qAk%3D" alt="" loading="lazy"/></p>
<p>构建完成后，你可以在 <code>src-tauri/target/release/bundle/</code> 目录下找到生成的安装包。在 Windows 上，你会看到一个 <code>.msi</code> 安装文件和一个免安装的 <code>.exe</code> 文件。这个 <code>.exe</code> 文件就是我们的最终成果，体积非常小，可以分发给用户直接运行！</p>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p><code>Tauri</code> 以其轻量、高性能和高安全性的特性，为前端开发者打开了一扇通往现代桌面应用开发的新大门。虽然生态和社区相比 <code>Electron</code> 还在成长中，但其技术理念的先进性已经吸引了大量关注。如果你正准备开发一款桌面应用，或者对 <code>Electron</code> 的性能和体积感到困扰，不妨来尝一尝 <code>Tauri</code> 这道“新菜”，相信它会给你带来惊喜！</p>
<hr/>
<p>后续，我将探索<code>Tauri</code>框架的<code>IPC</code>通信，给应用增加与后端通信的能力，敬请期待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Android平台上使用Three.js优雅的加载3D模型]]></title>    <link>https://juejin.cn/post/7571808096937295913</link>    <guid>https://juejin.cn/post/7571808096937295913</guid>    <pubDate>2025-11-13T09:54:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937295913" data-draft-id="7571829879826989075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Android平台上使用Three.js优雅的加载3D模型"/> <meta itemprop="keywords" content="Android,前端,three.js"/> <meta itemprop="datePublished" content="2025-11-13T09:54:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="onthewaying"/> <meta itemprop="url" content="https://juejin.cn/user/360295542299479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Android平台上使用Three.js优雅的加载3D模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295542299479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    onthewaying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:54:09.000Z" title="Thu Nov 13 2025 09:54:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Three.js是什么？</h2>
<p>Three.js是一个基于WebGL（Web Graphics Library）的3D图形渲染库，因为浏览器里最底层的3D API是WebGL。直接写会像写 OpenGL一样复杂，繁琐。<strong>Three.js 就是 WebGL 的封装层</strong>，提供了更高层次的接口，让你用几行代码就能创建出复杂的 3D 场景。</p>
<h2 data-id="heading-1">二、Three.js的核心概念</h2>
<h3 data-id="heading-2">1.Scene（场景）</h3>
<p>这是一个容器，一个无限大的虚拟空间。你之后创建的所有物体、光源、相机都必须被添加到这个场景中。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
</code></pre>
<h3 data-id="heading-3">2.Camera（相机）</h3>
<p>它决定了我们从哪个角度、以何种视野去观察这个场景。最常用的是<strong>透视相机 PerspectiveCamera</strong>，它模拟了人眼的视觉效果（近大远小）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
</code></pre>
<h3 data-id="heading-4">3.WebGLRenderer（渲染器）</h3>
<p>渲染器会根据相机的位置和视野，将场景中的内容计算并绘制到一个HTML的元素上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// antialias开启抗锯齿</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>); <span class="hljs-comment">// 将canvas添加到页面</span>
</code></pre>
<h3 data-id="heading-5">4.OrbitControls（控制器）</h3>
<p>控制器可以让用户用鼠标或触摸来旋转、缩放、平移相机。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 启用阻尼效果，使旋转更平滑</span>
controls.<span class="hljs-title function_">update</span>();
</code></pre>
<h3 data-id="heading-6">5.Light光源</h3>
<p>模拟自然光照、阴影、反光等效果</p>
<ul>
<li><strong>环境光 AmbientLight：</strong>  提供一种无方向的、均匀的基础光照，确保场景中最暗的地方也不是纯黑。</li>
<li><strong>平行光 DirectionalLight：</strong>  模拟像太阳光一样的效果，从一个方向平行照射过来，可以产生阴影。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">// 颜色, 强度</span>
scene.<span class="hljs-title function_">add</span>(ambientLight);

<span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>);
directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7</span>); <span class="hljs-comment">// 设置光源位置</span>
scene.<span class="hljs-title function_">add</span>(directionalLight);
</code></pre>
<h2 data-id="heading-7">三、实战案例</h2>
<p>核心分4大块：</p>
<p>1.Android原生：作为宿主，负责创建和管理WebView，处理原生UI交互，并准备3D模型文件（可以是本地，也可以是网络上获取的）。</p>
<p>2.WebView:负责加载本地的HTML和JavaScript文件。</p>
<p>3.JavaScript Bridge (@JavascriptInterface):这是原生代码与WebView中JavaScript代码双向通信的通道。</p>
<p>4.Assets:存放我们的index.html、Three.js库文件、模型文件以及核心的渲染逻辑main.js。</p>
<p>完整代码如下：</p>
<p>index.html主要是搭建一个网页环境，用于加载和执行main.js。</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"&gt;
    &lt;title&gt;Three.js on Android&lt;/title&gt;
    &lt;style&gt;
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script type="importmap"&gt;
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
&lt;/script&gt;

&lt;script type="module" src="./main.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>main.js主要处理3D场景的创建、物体添加、动画循环等核心逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/loaders/GLTFLoader.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/controls/OrbitControls.js'</span>;

<span class="hljs-comment">//创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0xeeeeee</span>); <span class="hljs-comment">// 设置背景色</span>

<span class="hljs-comment">//创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 75:场景范围</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">//创建渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>); <span class="hljs-comment">// renderer.domElement 本质是canvas</span>

<span class="hljs-comment">//添加光源</span>
<span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">// 环境光</span>
scene.<span class="hljs-title function_">add</span>(ambientLight);

<span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// 平行光</span>
directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7.5</span>);
scene.<span class="hljs-title function_">add</span>(directionalLight);

<span class="hljs-comment">//添加控制器，允许用户用手势旋转、缩放模型</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 启用阻尼效果，使旋转更平滑</span>
controls.<span class="hljs-title function_">update</span>();


<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUrl</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">const</span> urlString = androidBridge.<span class="hljs-title function_">getUrl</span>()
   <span class="hljs-keyword">const</span> info = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(androidBridge.<span class="hljs-title function_">getUrl</span>())
   <span class="hljs-keyword">return</span> info.<span class="hljs-property">url</span>
}

<span class="hljs-comment">//加载 3D 模型 (GLTF/GLB)</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">load</span>(<span class="hljs-title function_">getUrl</span>(),
    <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf</span>) {
        <span class="hljs-keyword">const</span> model = gltf.<span class="hljs-property">scene</span>;
        <span class="hljs-comment">// 调整模型大小和位置</span>
        model.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 调整模型初始的大小</span>
        model.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        model.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>; <span class="hljs-comment">// 修改模型的 rotation属性 ,GLB 模型 180 度旋转</span>
        scene.<span class="hljs-title function_">add</span>(model);
    },

    <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>) + <span class="hljs-string">'% loaded'</span>);
        androidBridge.<span class="hljs-title function_">sendDataToAndroid</span>(xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>);
    },
    
    <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'An error happened'</span>, error);
    }
);

<span class="hljs-comment">// 动画循环 </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);

    controls.<span class="hljs-title function_">update</span>(); <span class="hljs-comment">// 更新控制器</span>

    renderer.<span class="hljs-title function_">render</span>(scene, camera);
}

<span class="hljs-title function_">animate</span>();

<span class="hljs-comment">//处理窗口大小变化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
    camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
});
</code></pre>
<p>AndroidBridge.kt主要是把从服务器获取的3d模型url传递到main.js中，然后再从main.js中获取加载进度回调到Android原生代码中。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AndroidBridge</span> {
    private <span class="hljs-keyword">var</span> <span class="hljs-attr">info</span>: <span class="hljs-title class_">String</span>? = <span class="hljs-literal">null</span>


    private <span class="hljs-keyword">var</span> <span class="hljs-attr">progressCallback</span>: <span class="hljs-title class_">ProgressCallback</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 定义回调接口</span>
    interface <span class="hljs-title class_">ProgressCallback</span> {
        fun <span class="hljs-title function_">onProgressUpdate</span>(<span class="hljs-attr">progress</span>: <span class="hljs-title class_">Int</span>)
    }

    <span class="hljs-comment">// 设置回调</span>
    fun <span class="hljs-title function_">setProgressCallback</span>(<span class="hljs-params">callback: ProgressCallback</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">progressCallback</span> = callback
    }

    @<span class="hljs-title class_">JavascriptInterface</span>
    fun <span class="hljs-title function_">getUrl</span>(): <span class="hljs-title class_">String</span> {
        <span class="hljs-keyword">return</span> info.<span class="hljs-title function_">orEmpty</span>()
    }

    fun <span class="hljs-title function_">setUrl</span>(<span class="hljs-params">info: <span class="hljs-built_in">String</span>?</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = info
    }

    @<span class="hljs-title class_">JavascriptInterface</span>
    fun <span class="hljs-title function_">sendDataToAndroid</span>(<span class="hljs-params">progress: Int</span>) {
        progressCallback?.<span class="hljs-title function_">onProgressUpdate</span>(progress)
    }
}
</code></pre>
<p>MainActivity.kt主要是提供webview，以及从服务器获取3D模型url，完成和js的交互。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>初始化<span class="hljs-title class_">WebView</span>
val webSettings = settings
webSettings.<span class="hljs-property">javaScriptEnabled</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowFileAccess</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowFileAccessFromFileURLs</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowContentAccess</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">domStorageEnabled</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">builtInZoomControls</span> = <span class="hljs-literal">false</span>
webSettings.<span class="hljs-property">displayZoomControls</span> = <span class="hljs-literal">false</span>
webSettings.<span class="hljs-property">allowUniversalAccessFromFileURLs</span> = <span class="hljs-literal">true</span>
<span class="hljs-title function_">setWebChromeClient</span>(object : <span class="hljs-title class_">WebChromeClient</span>() {
    override fun <span class="hljs-title function_">onConsoleMessage</span>(<span class="hljs-attr">cm</span>: <span class="hljs-title class_">ConsoleMessage</span>): <span class="hljs-title class_">Boolean</span> {
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">"three"</span>, cm.<span class="hljs-title function_">message</span>() + <span class="hljs-string">" at "</span> + cm.<span class="hljs-title function_">sourceId</span>() + <span class="hljs-string">":"</span> + cm.<span class="hljs-title function_">lineNumber</span>())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
})
    
<span class="hljs-number">2.</span>获取3D模型url
bindViewModel {
    ai3Data.<span class="hljs-title function_">observe</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>@WebViewActivity</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.<span class="hljs-title function_">isEmpty</span>(it.<span class="hljs-property">data</span>?.<span class="hljs-property">glb_url</span>)) {
            bindView {
                val glbUrl = it.<span class="hljs-property">data</span>?.<span class="hljs-property">glb_url</span>
                val bridge = <span class="hljs-title class_">AndroidBridge</span>()
                webView.<span class="hljs-title function_">addJavascriptInterface</span>(bridge,<span class="hljs-string">"androidBridge"</span>)
                bridge.<span class="hljs-title function_">setUrl</span>(<span class="hljs-string">"{"</span>url<span class="hljs-string">":"</span>$glbUrl<span class="hljs-string">"}"</span>)
                webView.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">"file:///android_asset/threejs/index.html"</span>)
                bridge.<span class="hljs-title function_">setProgressCallback</span>(object :<span class="hljs-title class_">AndroidBridge</span>.<span class="hljs-property">ProgressCallback</span> {
                    override fun <span class="hljs-title function_">onProgressUpdate</span>(<span class="hljs-params">progress: Int</span>) {
                        runOnUiThread {
                            <span class="hljs-keyword">if</span> (progress &lt; <span class="hljs-number">100</span>) {
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载进度$progress%"</span>
                            } <span class="hljs-keyword">else</span> {
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载进度$progress%"</span>
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载结束"</span>
                            }
                        }
                    }
                })
            }
        }
    }
}
</code></pre>
<p>以上代码就是利用WebView作为桥梁，驱动Three.js，在Android原生应用中渲染3D模型的例子。</p>
<h2 data-id="heading-8">四、Three.js还能做什么？</h2>
<p>1.网页3D游戏<br/>
2.炫酷的动画特效<br/>
3.3D图表的数据可视化<br/>
4.电商网站的3D产品展示<br/>
5.房产APP中房屋的3D展示</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：长期记忆]]></title>    <link>https://juejin.cn/post/7572130072262688814</link>    <guid>https://juejin.cn/post/7572130072262688814</guid>    <pubDate>2025-11-13T09:51:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572130072262688814" data-draft-id="7571751593207201844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：长期记忆"/> <meta itemprop="keywords" content="Agent,LangChain,Python"/> <meta itemprop="datePublished" content="2025-11-13T09:51:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：长期记忆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:55.000Z" title="Thu Nov 13 2025 09:51:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><blockquote>
<p>阅读本文您将获得：</p>
<ul>
<li>LangChain长期记忆store的实现</li>
<li>LangGraph持久化功能的存储结构</li>
<li>智能体使用工具读取长期记忆</li>
<li>智能体使用工具写入长期记忆</li>
</ul>
</blockquote>
<h2 data-id="heading-0">1、概述</h2>
<p>LangChain智能体借助LangGraph的持久化功能实现长期记忆。LangChain长期记忆属于高阶的主题，使用时需具备LangGraph相关知识。</p>
<h2 data-id="heading-1">2、记忆存储</h2>
<p>LangGraph将长期记忆以JSON文档的形式存储在存储系统中。
每个记忆都归属于一个自定义命名空间（类似文件夹），并对应一个唯一键（类似文件名）。命名空间中通常包含用户ID、组织ID或其他标识，这些信息能让记忆的整理更便捷。
这种结构支持对记忆进行层级化组织，同时可通过内容筛选器实现跨命名空间检索。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-keyword">def</span> <span class="hljs-title function_">embed</span>(<span class="hljs-params">texts: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">float</span>]]:
    <span class="hljs-comment"># Replace with an actual embedding function or LangChain embeddings object</span>
    <span class="hljs-keyword">return</span> [[<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>] * <span class="hljs-built_in">len</span>(texts)]

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production use.</span>
store = InMemoryStore(index={<span class="hljs-string">"embed"</span>: embed, <span class="hljs-string">"dims"</span>: <span class="hljs-number">2</span>}) 
user_id = <span class="hljs-string">"my-user"</span>
application_context = <span class="hljs-string">"chitchat"</span>
namespace = (user_id, application_context) 
store.put( 
    namespace,
    <span class="hljs-string">"a-memory"</span>,
    {
        <span class="hljs-string">"rules"</span>: [
            <span class="hljs-string">"User likes short, direct language"</span>,
            <span class="hljs-string">"User only speaks English &amp; python"</span>,
        ],
        <span class="hljs-string">"my-key"</span>: <span class="hljs-string">"my-value"</span>,
    },
)
<span class="hljs-comment"># get the "memory" by ID</span>
item = store.get(namespace, <span class="hljs-string">"a-memory"</span>) 
<span class="hljs-comment"># search for "memories" within this namespace, filtering on content equivalence, sorted by vector similarity</span>
items = store.search( 
    namespace, <span class="hljs-built_in">filter</span>={<span class="hljs-string">"my-key"</span>: <span class="hljs-string">"my-value"</span>}, query=<span class="hljs-string">"language preferences"</span>
)
</code></pre>
<h2 data-id="heading-2">3、在工具中读取长期记忆</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.</span>
store = InMemoryStore() 

<span class="hljs-comment"># Write sample data to the store using the put method</span>
store.put( 
    (<span class="hljs-string">"users"</span>,),  <span class="hljs-comment"># Namespace to group related data together (users namespace for user data)</span>
    <span class="hljs-string">"user_123"</span>,  <span class="hljs-comment"># Key within the namespace (user ID as key)</span>
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"John Smith"</span>,
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"English"</span>,
    }  <span class="hljs-comment"># Data to store for the given user</span>
)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_info</span>(<span class="hljs-params">runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Look up user info."""</span>
    <span class="hljs-comment"># Access the store - same as that provided to `create_agent`</span>
    store = runtime.store 
    user_id = runtime.context.user_id
    <span class="hljs-comment"># Retrieve data from store - returns StoreValue object with value and metadata</span>
    user_info = store.get((<span class="hljs-string">"users"</span>,), user_id) 
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(user_info.value) <span class="hljs-keyword">if</span> user_info <span class="hljs-keyword">else</span> <span class="hljs-string">"Unknown user"</span>

agent = create_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[get_user_info],
    <span class="hljs-comment"># Pass store to agent - enables agent to access store when running tools</span>
    store=store, 
    context_schema=Context
)

<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"look up user information"</span>}]},
    context=Context(user_id=<span class="hljs-string">"user_123"</span>) 
)
</code></pre>
<h2 data-id="heading-3">4、在工具中写入长期记忆</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.</span>
store = InMemoryStore() 

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># TypedDict defines the structure of user information for the LLM</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Tool that allows agent to update user information (useful for chat applications)</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_user_info</span>(<span class="hljs-params">user_info: UserInfo, runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Save user info."""</span>
    <span class="hljs-comment"># Access the store - same as that provided to `create_agent`</span>
    store = runtime.store 
    user_id = runtime.context.user_id 
    <span class="hljs-comment"># Store data in the store (namespace, key, data)</span>
    store.put((<span class="hljs-string">"users"</span>,), user_id, user_info) 
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Successfully saved user info."</span>

agent = create_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[save_user_info],
    store=store, 
    context_schema=Context
)

<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"My name is John Smith"</span>}]},
    <span class="hljs-comment"># user_id passed in context to identify whose information is being updated</span>
    context=Context(user_id=<span class="hljs-string">"user_123"</span>) 
)

<span class="hljs-comment"># You can access the store directly to get the value</span>
store.get((<span class="hljs-string">"users"</span>,), <span class="hljs-string">"user_123"</span>).value
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？]]></title>    <link>https://juejin.cn/post/7572004684177768502</link>    <guid>https://juejin.cn/post/7572004684177768502</guid>    <pubDate>2025-11-13T08:23:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684177768502" data-draft-id="7571621555512950838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？"/> <meta itemprop="keywords" content="JavaScript,Vue.js,Webpack"/> <meta itemprop="datePublished" content="2025-11-13T08:23:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小蹦跶儿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414058300238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414058300238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小蹦跶儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:23:22.000Z" title="Thu Nov 13 2025 08:23:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前言：</p>
<p>做前端项目打包时，你是否遇到过这样的窘境：本地 <code>npm run dev</code> 运行一切正常，可执行 <code>npm run build</code> 打包后，生产环境控制台直接抛出 <code>TypeError: Cannot assign to read only property 'exports' of object '#&lt;Object&gt;'</code> 错误？</p>
</blockquote>
<h2 data-id="heading-0">一、背景介绍</h2>
<p>最近有个以前的老项目（<code>Vue2+webpack</code>）在正式环境出现了问题，这个项目中途一直没改动，突然有个页面打不开了。在控制台的报错信息如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6b2b50d0954401c8fd00114313ebabf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=tzs4YKEagByBPR5jPhKM%2BnT2m3c%3D" alt="image.png" loading="lazy"/></p>
<p>需要说明的一点，这是打包后的报错，在本地运行的时候，是没有问题的。
我把这段报错信息复制下来，如果有需要的话可以复制去研究一下。</p>
<pre><code class="hljs language-js" lang="js">vendor.0d88a535e3e863312d89.<span class="hljs-property">js</span>:<span class="hljs-number">44</span> <span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Cannot</span> assign to read only property <span class="hljs-string">'exports'</span> <span class="hljs-keyword">of</span> object <span class="hljs-string">'#&lt;Object&gt;
    at Object.&lt;anonymous&gt; (0.d97ee341e9f7c8f3e805.js:1:14033)
    at 16Wf (0.d97ee341e9f7c8f3e805.js:1:16662)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.exjW (0.d97ee341e9f7c8f3e805.js:10:119646)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.OpaP (0.d97ee341e9f7c8f3e805.js:10:22333)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at 7AuU (0.d97ee341e9f7c8f3e805.js:1:52095)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.sGS9 (0.d97ee341e9f7c8f3e805.js:10:181323)
</span></code></pre>
<h2 data-id="heading-1">二、解决方法</h2>
<blockquote>
<h3 data-id="heading-2">快速修复建议</h3>
<ol>
<li>首先尝试 <strong>方案一</strong> 和 <strong>方案二</strong>，检查并修正 <code>babel</code> 和 <code>webpack</code> 配置。（推荐）</li>
<li>如果你知道具体哪个文件导致问题，直接修改该文件的模块语法。</li>
</ol>
</blockquote>
<h3 data-id="heading-3">下面将具体展开描述解决步骤：</h3>
<ol>
<li>我将这个问题的报错信息直接抛给了<code>通义千问</code>，让它帮我分析问题原因，并给出解决方案。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4496d7c5a994618a8a5832617ebb6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=2cdQnYBw%2BQgyxBFExctJtMlJVI4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee165c0db354b78a1db3739a73877b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=KFeEAM9OMKij0Kf0QTPy%2BlZymbg%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"presets"</span>: [
    [<span class="hljs-string">"env"</span>, {
      <span class="hljs-string">"modules"</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-string">"targets"</span>: {
        <span class="hljs-string">"browsers"</span>: [<span class="hljs-string">"&gt; 1%"</span>, <span class="hljs-string">"last 2 versions"</span>, <span class="hljs-string">"not ie &lt;= 8"</span>]
      }
    }],
    <span class="hljs-string">"stage-2"</span>
  ],
  <span class="hljs-string">"plugins"</span>: [<span class="hljs-string">"transform-runtime"</span>]
}

</code></pre>
<ol start="2">
<li>
<p>对照着我自己的代码检查之后，确保项目根目录下的<code>.babelrc</code> 或 <code>babel.config.js</code>文件包含正确的配置，没有问题，（我项目中是<code>.babelrc文件</code>）。</p>
<p>如果没有 <code>.babelrc</code> 文件，创建一个并添加上述内容。</p>
</li>
<li>
<p>然后继续看下一个方案：</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29209c1200af4132a8075624458fa0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=9oGg9qKGzFqR116%2FpLCYbRY%2FAkU%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 添加 JavaScript 文件处理规则来解决模块系统冲突问题</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/(node_modules|bower_components)/</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>: [
            [<span class="hljs-string">'env'</span>, {
              <span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 确保设置为 false</span>
            }]
          ]
        }
      }
    ]
  },
</code></pre>
<p>根据 <strong>方案二</strong> ，找到项目中对应的 <code>build/webpack.prod.conf.js</code>文件，看是否有上面的这段代码。</p>
<p>下图是我的项目中的代码，很尴尬，没有这部分代码……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497e9431d3a2457795f015eda24e6d49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=Zm2ADLUzpBSSd2BiqNflhgqZFcQ%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>接着就可以将这部分代码加进去：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc5afd22e9d34f36a3986803d8a3286b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=oc%2FNPqZ8GGHf7Z%2FzGibD07YSg8c%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下，可直接复制：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 添加 JavaScript 文件处理规则来解决模块系统冲突问题</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/(node_modules|bower_components)/</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>: [
            [<span class="hljs-string">'env'</span>, {
              <span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span>
            }]
          ]
        }
      },
      <span class="hljs-comment">// 保留原有的样式处理规则</span>
      ...utils.<span class="hljs-title function_">styleLoaders</span>({
        <span class="hljs-attr">sourceMap</span>: config.<span class="hljs-property">build</span>.<span class="hljs-property">productionSourceMap</span>,
        <span class="hljs-attr">extract</span>: <span class="hljs-literal">true</span>
      })
    ]
  },
</code></pre>
<p>关键点是设置 <code>"modules": false</code>，这告诉 Babel 不要转换 ES6 的 import/export 语法，让 webpack 来处理模块系统，避免 ES6 模块语法和 CommonJS 语法冲突的问题。</p>
<p>完成这些修改后，重新运行 <code>npm run build</code> 应该就能解决你遇到的错误了。</p>
<p>推荐这个方案的原因是，这样可以确保开发环境和生产环境使用相同的 <code>babel</code> 配置。这个修改就是我成功解决问题的方法。</p>
<ol start="5">
<li>AI 还给我建议说，“检查具体出错的文件“，可是根据错误堆栈，问题出现的文件名称是被编译过的，找的话就需要查找源代码中混用了 <code>import</code> 和 <code>module.exports</code> 的地方，找到之后统一使用一种模块语法即可。
由于我的出错文件是在第三方库中，所以这个方案有点麻烦，我果断放弃。</li>
</ol>
<h2 data-id="heading-4">三、问题原因</h2>
<p>核心原因正如分析所示：在同一模块中同时混用了 ES6 的 <code>import/export</code> 语法与 CommonJS 的 <code>module.exports</code> 语法，导致 webpack 处理模块时出现冲突。这是 webpack 打包后，生产环境中较为常见的问题。</p>
<p>如果是自己写的代码，可以在代码中查找并修改，统一项目中的模块语法规范即可。如果是第三方库出现的问题，就可以用本文中的方法解决，先尝试检查 <code>babel</code> 配置并确保 <code>modules: false</code> 设置正确，这通常能解决大部分此类问题。</p>
<h2 data-id="heading-5">四、总结</h2>
<p>前端打包报错往往 “现象复杂，根源简单”，遇到类似问题时，优先排查模块语法、依赖兼容性、Webpack 配置这三大方向，通常能快速找到突破口。</p>
<p>以上，希望对大家有帮助！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++智能指针介绍]]></title>    <link>https://juejin.cn/post/7571815573932916799</link>    <guid>https://juejin.cn/post/7571815573932916799</guid>    <pubDate>2025-11-13T08:22:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815573932916799" data-draft-id="7571678388954300435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++智能指针介绍"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-13T08:22:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qwepoilkjasd"/> <meta itemprop="url" content="https://juejin.cn/user/318221180214507"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++智能指针介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/318221180214507/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qwepoilkjasd
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:22:23.000Z" title="Thu Nov 13 2025 08:22:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，非常乐意为你详细讲解 C++ 智能指针。这是现代 C++（C++11 及之后）中<strong>最重要</strong>的特性之一，它彻底改变了 C++ 的内存管理方式。</p>
<p>我们将从<strong>为什么</strong>需要它开始，然后逐一介绍三种核心的智能指针：<code>std::unique_ptr</code>、<code>std::shared_ptr</code> 和 <code>std::weak_ptr</code>。</p>
<hr/>
<h2 data-id="heading-0">🎯 1. 为什么需要智能指针？（传统指针的问题）</h2>
<p>在 C++ 中，我们经常使用 <code>new</code> 在**堆 (Heap)**上动态分配内存。</p>
<p>C++</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">old_way</span>() {
    MyClass* raw_ptr = new <span class="hljs-built_in">MyClass</span>(); <span class="hljs-comment">// 1. 分配内存</span>
    raw_ptr-&gt;<span class="hljs-built_in">do_something</span>();
    <span class="hljs-comment">// ...</span>
    delete raw_ptr; <span class="hljs-comment">// 2. 必须手动释放</span>
}
</code></pre>
<p>这种“裸指针” (Raw Pointer) 的管理方式非常危险，极易出错：</p>
<ol>
<li>
<p><strong>内存泄漏 (Memory Leaks)</strong> ：</p>
<ul>
<li><strong>忘记 <code>delete</code></strong>：最常见的问题。<code>raw_ptr</code> 是一个局部变量，当 <code>old_way()</code> 函数结束时，<code>raw_ptr</code> 变量本身被销毁了，但它所<strong>指向</strong>的在“堆”上的 <code>MyClass</code> 对象<strong>依然存在</strong>，这块内存永远无法被回收。</li>
<li><strong>提前返回</strong>：如果在 <code>new</code> 和 <code>delete</code> 之间有 <code>return</code>、<code>break</code> 或 <code>continue</code>，<code>delete</code> 语句可能被跳过。</li>
<li><strong>发生异常</strong>：如果在 <code>do_something()</code> 中抛出了异常，<code>delete raw_ptr;</code> 这一行永远不会被执行，内存泄漏。</li>
</ul>
</li>
<li>
<p><strong>悬挂指针 (Dangling Pointers)</strong> ：<br/>
<strong>悬空指针</strong> ：</p>
<ul>
<li>当一个指针被 <code>delete</code> 后，它并没有自动变为 <code>nullptr</code>，它依然指向那块“已释放”的内存。如果后续代码不慎再次使用了这个指针（“Use-After-Free”），会导致未定义行为（通常是程序崩溃）。</li>
</ul>
</li>
<li>
<p><strong>所有权 (Ownership) 不明</strong>：</p>
<ul>
<li>当一个裸指针在多个函数或对象之间传递时，到底<strong>谁</strong>负责 <code>delete</code> 它？</li>
<li>如果两个模块都尝试 <code>delete</code> 同一个指针，会引发<strong>二次释放 (Double Free)</strong> ，导致程序崩溃。</li>
<li>如果谁都不 <code>delete</code>，就是内存泄漏。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">💡 2. 核心思想：RAII 与智能指针</h2>
<p>为了解决这些问题，C++ 引入了<strong>智能指针 (Smart Pointers)</strong> 。</p>
<p>智能指针<strong>不是</strong>指针，它是一个<strong>对象</strong>（一个类模板）。它封装（wrap）了一个裸指针，并利用了 C++ 的一个核心特性：<strong>RAII (Resource Acquisition Is Initialization)</strong> ，即“资源获取即初始化”。</p>
<p>RAII 的核心思想：</p>
<ol>
<li>一个对象在它的<strong>构造函数</strong>中获取资源（这里是 <code>new</code> 出来的内存）。</li>
<li>这个对象在它的<strong>析构函数</strong>中释放资源（这里是 <code>delete</code> 封装的裸指针）。</li>
<li>C++ 保证，一个在<strong>栈 (Stack)上创建的对象，当它离开作用域时（例如函数返回），它的析构函数必定</strong>会被自动调用（即使发生异常，也会“栈展开”）。</li>
</ol>
<p><strong>智能指针就是这样一个 RAII 对象</strong>。你把 <code>new</code> 得到的指针交给它，你就可以“忘记”<code>delete</code> 了。当智能指针对象生命周期结束时，它会在析构函数中自动帮你 <code>delete</code> 掉它所管理的指针。</p>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span> <span class="hljs-comment">// 智能指针的头文件</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">smart_way</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// std::make_unique 是创建 unique_ptr 的推荐方式 (C++14)</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; smart_ptr = <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();
    
    smart_ptr-&gt;do_something();

    <span class="hljs-comment">// 当 smart_way() 函数返回时，smart_ptr 离开作用域</span>
    <span class="hljs-comment">// 它的析构函数被自动调用</span>
    <span class="hljs-comment">// 析构函数会自动执行 delete smart_ptr.get()</span>
} <span class="hljs-comment">// &lt;-- 内存在这里被自动释放，即使发生异常也一样！</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">🔧 3. <code>std::unique_ptr</code> (独占指针)</h2>
<p><code>std::unique_ptr</code> 是最常用、最高效、最“轻量级”的智能指针。</p>
<ul>
<li>
<p><strong>核心概念：</strong> <strong>独占所有权 (Exclusive Ownership)</strong> 。</p>
</li>
<li>
<p><strong>含义：</strong> 在任何时刻，<strong>只有一个</strong> <code>unique_ptr</code> 可以指向某个特定的对象。它“拥有”这个对象。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li><strong>轻量</strong>：它的大小和裸指针一样（没有额外开销），因为它不需要存储“引用计数”之类的东西。</li>
<li><strong>不可复制 (Non-Copyable)</strong> ：你不能“拷贝”一个 <code>unique_ptr</code>，因为这会违反“独占”所有权。</li>
<li><strong>可以移动 (Movable)</strong> ：你可以将所有权从一个 <code>unique_ptr</code> <strong>转移 (move)</strong> 给另一个。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-3">示例：创建、使用和转移</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span> <span class="hljs-comment">// for std::move</span></span>

<span class="hljs-comment">// 推荐的创建方式 (C++14)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p1 = <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();

<span class="hljs-comment">// 像裸指针一样使用</span>
p1-&gt;do_something();
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; (*p1).value;

<span class="hljs-comment">// 1. 编译错误：不允许复制！</span>
<span class="hljs-comment">// std::unique_ptr&lt;MyClass&gt; p2 = p1; // ERROR: copy constructor is deleted</span>

<span class="hljs-comment">// 2. 正确：转移所有权 (Move)</span>
<span class="hljs-comment">// p1 将放弃所有权，并变为空 (nullptr)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p2 = <span class="hljs-built_in">std</span>::move(p1);

<span class="hljs-keyword">if</span> (p1 == nullptr) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"p1 现在是空的"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
}
<span class="hljs-keyword">if</span> (p2 != nullptr) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"p2 拥有了该对象"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    p2-&gt;do_something();
} <span class="hljs-comment">// &lt;-- p2 在这里离开作用域，释放 MyClass 对象</span>

<span class="hljs-comment">// 3. 从函数返回 (所有权转移)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; <span class="hljs-title function_">create_object</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 工厂函数返回一个对象的所有权</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();
}
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p3 = create_object();

<span class="hljs-comment">// 4. 作为参数传递 (转移所有权)</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">take_ownership</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p)</span> {
    p-&gt;do_something();
} <span class="hljs-comment">// &lt;-- p 在这里析构，释放对象</span>
take_ownership(<span class="hljs-built_in">std</span>::move(p3));
<span class="hljs-comment">// p3 在此之后也变为空</span>
</code></pre>
<h3 data-id="heading-4">什么时候用 <code>unique_ptr</code>？</h3>
<p><strong>答案：默认首选！</strong> 只要你不需要多个指针“共享”一个对象，就应该用 <code>unique_ptr</code>。</p>
<ul>
<li>作为类的成员变量（Pimpl 惯用法）。</li>
<li>在函数中创建并返回一个堆上对象（工厂模式）。</li>
<li>存储在 STL 容器中（例如 <code>std::vector&lt;std::unique_ptr&lt;MyClass&gt;&gt;</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">🤝 4. <code>std::shared_ptr</code> (共享指针)</h2>
<p><code>std::shared_ptr</code> 解决了“多个指针需要指向同一对象”的场景。</p>
<ul>
<li>
<p><strong>核心概念：</strong> <strong>共享所有权 (Shared Ownership)</strong> 。</p>
</li>
<li>
<p><strong>含义：</strong> 多个 <code>shared_ptr</code> 可以指向同一个对象。它们通过<strong>引用计数 (Reference Counting)</strong> 来管理这个对象的生命周期。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li><strong>引用计数</strong>：内部有一个“控制块”，其中包含一个计数器。</li>
<li>每当一个 <code>shared_ptr</code> <strong>被复制</strong>（或赋值给另一个 <code>shared_ptr</code>）时，<strong>计数器 +1</strong>。</li>
<li>每当一个 <code>shared_ptr</code> <strong>被析构</strong>（或被赋新值）时，<strong>计数器 -1</strong>。</li>
<li>当<strong>计数器减到 0</strong> 时，意味着最后一个拥有该对象的 <code>shared_ptr</code> 消失了，它会在析构时 <code>delete</code> 掉被管理的对象。</li>
<li><strong>开销</strong>：比 <code>unique_ptr</code> 重。它需要额外分配“控制块”的内存，并且增减计数器必须是<strong>原子操作</strong>（线程安全），这有性能开销。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-6">示例：创建和共享</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-comment">// 推荐的创建方式 (C++11)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp1 = <span class="hljs-built_in">std</span>::make_shared&lt;MyClass&gt;();
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 1</span>

{
    <span class="hljs-comment">// 复制构造函数，sp2 也指向 sp1 的对象</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp2 = sp1;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 2</span>
    
    <span class="hljs-comment">// sp2 和 sp1 都可以使用</span>
    sp2-&gt;do_something();

} <span class="hljs-comment">// &lt;-- sp2 在这里离开作用域，析构</span>
  <span class="hljs-comment">// 引用计数 -1，变为 1</span>

<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 1</span>

<span class="hljs-comment">// 为什么用 make_shared？</span>
<span class="hljs-comment">// 1. 性能：MyClass 对象和“控制块”的内存可以一次性分配，减少内存分配次数。</span>
<span class="hljs-comment">// 2. 异常安全：避免了在 `new MyClass()` 成功但 `shared_ptr` 构造失败时导致的内存泄漏。</span>
</code></pre>
<h3 data-id="heading-7">什么时候用 <code>shared_ptr</code>？</h3>
<p>当你<strong>无法</strong>明确界定“谁是唯一的所有者”时。</p>
<ul>
<li>你希望将一个对象存储在多个数据结构中，并且希望它在“所有引用它的地方都失效”后才被销毁。</li>
<li>异步回调（例如，<code>this</code> 指针可能在回调被调用前失效，使用 <code>shared_from_this</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">🚫 5. <code>std::weak_ptr</code> (弱指针)</h2>
<p><code>shared_ptr</code> 有一个致命问题：<strong>循环引用 (Circular Reference)</strong> 。</p>
<h3 data-id="heading-9">问题：循环引用</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeA</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeB&gt; b_ptr;
    ~NodeA() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeA 析构\n"</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeA&gt; a_ptr;
    ~NodeB() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeB 析构\n"</span>; }
};

<span class="hljs-type">void</span> <span class="hljs-title function_">circular_reference_problem</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">auto</span> a = <span class="hljs-built_in">std</span>::make_shared&lt;NodeA&gt;(); <span class="hljs-comment">// a 的计数 = 1</span>
    <span class="hljs-keyword">auto</span> b = <span class="hljs-built_in">std</span>::make_shared&lt;NodeB&gt;(); <span class="hljs-comment">// b 的计数 = 1</span>

    a-&gt;b_ptr = b; <span class="hljs-comment">// b 的计数 = 2 (a 持有 b)</span>
    b-&gt;a_ptr = a; <span class="hljs-comment">// a 的计数 = 2 (b 持有 a)</span>

} <span class="hljs-comment">// &lt;-- 函数结束，a 和 b 两个 shared_ptr 离开作用域</span>
<span class="hljs-comment">// a 的计数从 2 -&gt; 1</span>
<span class="hljs-comment">// b 的计数从 2 -&gt; 1</span>

<span class="hljs-comment">// **内存泄漏！**</span>
<span class="hljs-comment">// a 的计数是 1 (因为 b 还指着它)，所以 NodeA 不会被析构。</span>
<span class="hljs-comment">// b 的计数是 1 (因为 a 还指着它)，所以 NodeB 也不会被析构。</span>
<span class="hljs-comment">// 它们互相“续命”，导致谁也无法释放。</span>
</code></pre>
<h3 data-id="heading-10">解决方案：<code>std::weak_ptr</code></h3>
<p><code>weak_ptr</code> 是一种<strong>非拥有 (Non-owning)</strong> 的智能指针。</p>
<ul>
<li>
<p><strong>核心概念：</strong> 它只是一个“观察者”。</p>
</li>
<li>
<p><strong>含义：</strong> 它可以指向 <code>shared_ptr</code> 管理的对象，但它<strong>不会</strong>增加引用计数。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li>它不能阻止所指向的对象被销毁。</li>
<li>你<strong>不能</strong>直接通过 <code>weak_ptr</code> 使用对象（没有 <code>-&gt;</code> 或 <code>*</code> 操作符）。</li>
<li>你需要<strong>检查</strong>它指向的对象是否还“存活”。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-11">示例：打破循环</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB_Fixed</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeA_Fixed</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeB_Fixed&gt; b_ptr; <span class="hljs-comment">// A 强引用 B</span>
    ~NodeA_Fixed() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeA 析构\n"</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB_Fixed</span> {</span>
    <span class="hljs-comment">// B 弱引用 A</span>
    <span class="hljs-built_in">std</span>::weak_ptr&lt;NodeA_Fixed&gt; a_ptr; <span class="hljs-comment">// &lt;-- 关键！</span>
    ~NodeB_Fixed() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeB 析构\n"</span>; }
};

<span class="hljs-type">void</span> <span class="hljs-title function_">circular_reference_solution</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">auto</span> a = <span class="hljs-built_in">std</span>::make_shared&lt;NodeA_Fixed&gt;(); <span class="hljs-comment">// a 计数 = 1</span>
    <span class="hljs-keyword">auto</span> b = <span class="hljs-built_in">std</span>::make_shared&lt;NodeB_Fixed&gt;(); <span class="hljs-comment">// b 计数 = 1</span>

    a-&gt;b_ptr = b; <span class="hljs-comment">// b 计数 = 2</span>
    b-&gt;a_ptr = a; <span class="hljs-comment">// a 计数 = 1 (weak_ptr 不增加计数)</span>
}
<span class="hljs-comment">// 函数结束:</span>
<span class="hljs-comment">// 1. a (shared_ptr) 离开作用域，a 计数从 1 -&gt; 0。</span>
<span class="hljs-comment">// 2. NodeA 被析构！</span>
<span class="hljs-comment">// 3. 在 NodeA 的析构函数中，a-&gt;b_ptr (shared_ptr) 被销毁。</span>
<span class="hljs-comment">// 4. b 计数从 2 -&gt; 1。</span>
<span class="hljs-comment">// 5. b (shared_ptr) 离开作用域，b 计数从 1 -&gt; 0。</span>
<span class="hljs-comment">// 6. NodeB 被析构！</span>
<span class="hljs-comment">// (顺序可能是 5-&gt;6-&gt;3-&gt;4-&gt;1-&gt;2，但结果一样)</span>
<span class="hljs-comment">// **内存被正确释放！**</span>
</code></pre>
<h3 data-id="heading-12">如何使用 <code>weak_ptr</code>？</h3>
<p>你需要先把它“锁住” (<code>.lock()</code>)，尝试获取一个临时的 <code>shared_ptr</code>：</p>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 假设你有一个 weak_ptr</span>
<span class="hljs-built_in">std</span>::weak_ptr&lt;MyClass&gt; wp = ...;

<span class="hljs-comment">// 尝试提升 (lock) 为 shared_ptr</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp = wp.lock()) {
    <span class="hljs-comment">// 提升成功！</span>
    <span class="hljs-comment">// 这意味着在 if 语句块内，对象是存活的</span>
    <span class="hljs-comment">// sp 保证了对象在此期间不会被释放</span>
    sp-&gt;do_something();
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 提升失败，对象已经被销毁了</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"对象已不存在"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
}
</code></pre>
<h3 data-id="heading-13">什么时候用 <code>weak_ptr</code>？</h3>
<ol>
<li><strong>打破 <code>shared_ptr</code> 的循环引用</strong>（如上例中的父子/A-B 关系）。</li>
<li><strong>缓存 (Caching)</strong> ：你有一个缓存系统，希望缓存的对象在“别处都不用”时自动销毁，但你又想能随时访问它。<code>std::map&lt;Key, std::weak_ptr&lt;Value&gt;&gt;</code> 就很合适。</li>
<li><strong>观察者模式</strong>：<code>Subject</code> 可以持有 <code>std::vector&lt;std::weak_ptr&lt;Observer&gt;&gt;</code>，当 <code>Observer</code> 自行销毁时，<code>Subject</code> 不需要知道，它在通知时只需检查 <code>lock()</code> 是否成功。</li>
</ol>
<hr/>
<h2 data-id="heading-14">💡 6. 智能指针最佳实践（总结）</h2>
<ol>
<li>
<p><strong>首选 <code>std::make_unique</code> (C++14)</strong> ：当你创建对象时，优先使用 <code>unique_ptr</code>。</p>
</li>
<li>
<p><strong>需要共享时才用 <code>std::make_shared</code></strong>：当你明确知道所有权需要被共享时，才使用 <code>shared_ptr</code>。</p>
</li>
<li>
<p><strong>使用 <code>weak_ptr</code> 打破 <code>shared_ptr</code> 循环</strong>：当你发现 <code>shared_ptr</code> 构成了循环（例如树结构中的“子节点指向父节点”），使用 <code>weak_ptr</code> 作为“非拥有”的一方。</p>
</li>
<li>
<p><strong>不要混用裸指针和智能指针</strong>：</p>
<ul>
<li><strong>绝对禁止</strong>：<code>MyClass* raw = new MyClass();</code></li>
<li><code>std::shared_ptr&lt;MyClass&gt; p1(raw);</code></li>
<li><code>std::shared_ptr&lt;MyClass&gt; p2(raw);</code></li>
<li>这会导致 <code>p1</code> 和 <code>p2</code> 都有各自的引用计数（都为1），它们都会在析构时尝试 <code>delete raw</code>，导致<strong>二次释放</strong>。</li>
</ul>
</li>
<li>
<p><strong>如何向函数传递智能指针？（非常重要）</strong></p>
<ul>
<li>
<p><strong>情况1：函数只是“使用”对象，不关心所有权。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 传递<strong>裸指针</strong> (<code>MyClass*</code>) 或<strong>引用</strong> (<code>MyClass&amp;</code>)。</li>
<li><strong>原因：</strong> 这最快，并且解耦。调用者可以用 <code>unique_ptr</code>、<code>shared_ptr</code> 或普通栈对象。</li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use_object</span><span class="hljs-params">(MyClass* obj)</span> </span>{ obj-&gt;<span class="hljs-built_in">do_something</span>(); }
<span class="hljs-comment">// 调用:</span>
<span class="hljs-built_in">use_object</span>(my_unique_ptr.<span class="hljs-built_in">get</span>());
<span class="hljs-built_in">use_object</span>(my_shared_ptr.<span class="hljs-built_in">get</span>());
</code></pre>
</li>
<li>
<p><strong>情况2：函数需要“共享”所有权（例如，把它存为成员）。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 按<strong>常量引用</strong>传递 <code>shared_ptr</code>。</li>
</ul>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">store_object</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;&amp; ptr)</span> {
    m_member_ptr = ptr; <span class="hljs-comment">// 复制，引用计数+1</span>
}
</code></pre>
</li>
<li>
<p><strong>情况3：函数需要“夺取”或“转移”所有权。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 按<strong>值</strong>传递 <code>unique_ptr</code>（需要 <code>std::move</code>）。</li>
</ul>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">take_ownership</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; ptr)</span> {
    m_member_ptr = <span class="hljs-built_in">std</span>::move(ptr); <span class="hljs-comment">// 接收所有权</span>
}
<span class="hljs-comment">// 调用:</span>
take_ownership(<span class="hljs-built_in">std</span>::move(my_unique_ptr));
</code></pre>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用LangGraph构建一个智能体]]></title>    <link>https://juejin.cn/post/7572022112102531098</link>    <guid>https://juejin.cn/post/7572022112102531098</guid>    <pubDate>2025-11-13T08:24:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572022112102531098" data-draft-id="7571731181198622756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用LangGraph构建一个智能体"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-13T08:24:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用LangGraph构建一个智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:24:45.000Z" title="Thu Nov 13 2025 08:24:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>使用 LangGraph 构建智能体时，首先要将任务分解为称为 <strong>节点</strong> 的离散步骤。然后，需要描述每个节点不同的决策逻辑和状态转换方式。最后，通过一个 <strong>共享状态</strong> 将各个节点连接起来，每个节点都可以读写该状态。</p>
<hr/>
<p>要在 LangGraph 中实现智能体，通常需要遵循五个步骤。</p>
<h2 data-id="heading-0">第一步：将你的工作流程分解成一个个独立的步骤。</h2>
<p>首先，确定流程中的各个步骤。每个步骤都将成为一个节点（一个执行特定操作的函数）。然后，绘制这些步骤之间的连接图。</p>
<h2 data-id="heading-1">第二步：明确每个步骤需要做什么</h2>
<p>对于图中的每个节点，确定它代表什么类型的操作以及它需要什么上下文才能正常工作。</p>
<p>一般有以下4种类型的操作步骤：</p>
<ul>
<li><strong>LLM 步骤</strong>：用于某个步骤需要理解、分析、生成文本或做出推理决策时。</li>
<li><strong>数据步骤</strong>：用于某个步骤需要从外部来源检索信息时。</li>
<li><strong>动作步骤</strong>：用于某个步骤需要执行外部操作时。</li>
<li><strong>用户输入步骤</strong>：用于某个步骤需要人工干预时。</li>
</ul>
<h3 data-id="heading-2">分类详解与实例</h3>



































<table><thead><tr><th align="left">步骤类型</th><th align="left">核心职能</th><th align="left">典型节点示例</th><th align="left">所需上下文（举例）</th></tr></thead><tbody><tr><td align="left"><strong>LLM 步骤</strong><br/>（大脑）</td><td align="left"><strong>理解、推理、决策、生成</strong></td><td align="left">• <strong>分类节点</strong>：分析用户意图。<br/>• <strong>起草回复节点</strong>：生成回复内容。</td><td align="left">• 原始用户输入<br/>• 分类结果<br/>• 公司回复风格指南</td></tr><tr><td align="left"><strong>数据步骤</strong><br/>（记忆）</td><td align="left"><strong>信息检索、数据查询</strong></td><td align="left">• <strong>文档搜索节点</strong>：从知识库查找答案。<br/>• <strong>客户历史查询</strong>：从数据库获取过往记录。</td><td align="left">• 查询关键词（如订单号）<br/>• 搜索范围/权限</td></tr><tr><td align="left"><strong>动作步骤</strong><br/>（手脚）</td><td align="left"><strong>执行实际操作、改变外部状态</strong></td><td align="left">• <strong>发送回复节点</strong>：将最终回复邮件发出。<br/>• <strong>创建工单节点</strong>：在追踪系统中创建Bug工单。</td><td align="left">• 最终审定的回复内容<br/>• 目标邮箱地址<br/>• 工单详细信息</td></tr><tr><td align="left"><strong>用户输入步骤</strong><br/>（监督）</td><td align="left"><strong>引入人类判断、处理异常</strong></td><td align="left">• <strong>人工审核节点</strong>：将敏感或复杂回复交由人工审批。</td><td align="left">• 需要审核的回复草稿<br/>• 触发送审的原因（如高金额退款）</td></tr></tbody></table>
<h2 data-id="heading-3">第三步：设计你的共享状态</h2>
<p>状态是你的智能体中所有节点都可以访问的共享记忆。你可以将其想象成你的智能体在处理流程中所使用的笔记本，用来记录它在此过程中了解到的一切信息和做出的所有决定。</p>
<p>设计状态就是为你的智能体 <strong>设计数据结构</strong>。一个精心设计的“共享笔记本”（状态）是构建一个高效、可靠且易于理解的智能体工作流的基石。它决定了节点之间如何通信，以及工作流的上下文如何得以保持。</p>
<h3 data-id="heading-4">哪些数据要保存在状态中？</h3>
<p>这个数据是否需要跨步骤保持？如果需要，则将其置于状态中。如果能从其他数据中推导出，则在需要时计算，而不是将其存储在状态中。</p>
<p>💡 <strong>一个关键原则</strong>：你的状态应该存储原始数据，而不是格式化的文本。需要时，在节点内部进行格式化。</p>
<h2 data-id="heading-5">第四步：构建节点</h2>
<p>构建节点就是我们将每个步骤实现为一个函数。LangGraph 中的一个节点就是一个 Python 函数，它接收当前状态并返回更新后的状态。</p>
<h3 data-id="heading-6">如何妥善处理节点中可能发生的错误？</h3>



































<table><thead><tr><th align="left">错误类型</th><th align="left">谁来修复它</th><th align="left">修复策略</th><th align="left">何时使用</th></tr></thead><tbody><tr><td align="left">瞬态错误（网络问题、速率限制）</td><td align="left">系统（自动）</td><td align="left">重试策略</td><td align="left">临时故障，通常在重试后解决。</td></tr><tr><td align="left">LLM 可恢复错误（工具故障、解析问题）</td><td align="left">LLM</td><td align="left">将错误存储在状态中并循环返回</td><td align="left">LLM能够发现错误并调整其方法</td></tr><tr><td align="left">用户可修正的错误（信息缺失、说明不清晰）</td><td align="left">人类</td><td align="left">暂停</td><td align="left">需要用户输入才能继续</td></tr><tr><td align="left">意外错误</td><td align="left">开发者</td><td align="left">让错误冒泡吧</td><td align="left">未知问题需要Debug</td></tr></tbody></table>
<h2 data-id="heading-7">第五步：将节点连接起来</h2>
<p>现在，我们将节点连接成一个可运行的工作流图。由于我们的节点能够处理自身的路由决策，我们只需要定义几条必要的边即可。</p>
<h2 data-id="heading-8">总结一下</h2>
<p>通过以上步骤我们总结一下 LangGraph 的思维方式：</p>
<ul>
<li>将任务分解成若干个独立的步骤，每个节点专注于做好一件事。</li>
<li>状态是共享的记忆，保存了原始数据。</li>
<li>每个节点都是一个函数，输入状态，输出更新后的状态。</li>
<li>错误是流程预设的一部分，通过多种策略修复它。</li>
<li>人工干预具有最高权限，等待人工干预时暂停执行，保存所有状态。</li>
<li>只需少量的必要连接，图结构由节点自行构建出来。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析]]></title>    <link>https://juejin.cn/post/7571892340878606374</link>    <guid>https://juejin.cn/post/7571892340878606374</guid>    <pubDate>2025-11-13T08:11:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571892340878606374" data-draft-id="7571830282849681459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析"/> <meta itemprop="keywords" content="Flutter,Dart,iOS"/> <meta itemprop="datePublished" content="2025-11-13T08:11:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:11:34.000Z" title="Thu Nov 13 2025 08:11:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">网络请求与数据解析</h2>
<blockquote>
<p>在移动开发中需要与云端服务器进行频繁的数据交互，本节内容讲带你详细了解网络请求与数据解析，让你的应用真正地“活”起来。</p>
</blockquote>
<h3 data-id="heading-1">一、 为什么网络层如此重要？</h3>
<p>举个例子：你正在开发一个新闻App，那些滚动的时事新闻、视频等内容，不可能全部打包在App安装包里，它们需要从服务器实时获取。这个“获取”的过程，就是通过网络请求完成的。</p>
<p>简单来说，流程就是：<strong>App 问服务器要数据 -&gt; 服务器返回数据 -&gt; App 把数据展示出来</strong>。</p>
<p>在Flutter中，常用的两个网络请求库：<strong>官方推荐的 <code>http</code> 库</strong> 和 <strong>社区维护得 <code>dio</code> 库</strong>。我们将从两者入手，带你彻底玩转网络请求。</p>
<h3 data-id="heading-2">二、 <code>http库</code> 与 <code>dio库</code> 如何选择？</h3>
<p>选择哪个库，就像选择工具，没有绝对的好坏，只有合不合适。</p>
<h4 data-id="heading-3">1. <code>http</code> 库</h4>
<p><code>http</code> 库是Flutter团队维护的底层库，它：</p>
<ul>
<li><strong>优点</strong>：官方维护，稳定可靠；API简单直接，学习成本低。</li>
<li><strong>缺点</strong>：功能相对基础，许多高级功能（如拦截器、文件上传/下载进度等）需要自己手动实现。</li>
</ul>
<p><strong>核心方法：</strong></p>
<ul>
<li><code>get()</code>: 向指定URL发起GET请求，用于获取数据。</li>
<li><code>post()</code>: 发起POST请求，用于提交数据。</li>
<li><code>put()</code>, <code>delete()</code>, <code>head()</code> 等：对应其他HTTP方法。</li>
</ul>
<h4 data-id="heading-4">2. <code>dio</code> 库</h4>
<p><code>dio</code> 是一个强大的第三方HTTP客户端，它：</p>
<ul>
<li><strong>优点</strong>：支持<strong>拦截器</strong>、<strong>全局配置</strong>、<strong>请求取消</strong>、<strong>FormData</strong>、<strong>文件上传/下载</strong>、<strong>超时设置</strong>等。</li>
<li><strong>缺点</strong>：相对于<code>http</code>库更重一些。</li>
</ul>
<p><strong>如何选择？</strong></p>
<ul>
<li><strong>新手入门</strong>：可以从 <code>http</code> 开始，上手快。</li>
<li><strong>中大型项目</strong>：强烈推荐 <code>dio</code>，它能帮你节省大量造轮子的时间。</li>
</ul>
<p><strong>本节内容主要以 <code>dio</code> 为例进行讲解</strong>，它更符合项目开发的实际情况。</p>
<h3 data-id="heading-5">三、 引入依赖</h3>
<p>首先，在你的 <code>pubspec.yaml</code> 文件中声明依赖。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.0.0</span> 
  <span class="hljs-comment"># 用于JSON序列化</span>
  <span class="hljs-attr">json_annotation:</span> <span class="hljs-string">^4.8.0</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">flutter_test:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">build_runner:</span> <span class="hljs-string">^2.3.0</span>
  <span class="hljs-attr">json_serializable:</span> <span class="hljs-string">^6.5.0</span>
</code></pre>
<p>执行 <code>flutter pub get</code> 安装依赖。</p>
<h3 data-id="heading-6">四、 <code>http</code> 库</h3>
<p>虽然我们推荐使用<code>dio</code>库，但了解<code>http</code>库的基本用法仍是必要的。</p>
<p><strong>以获取一篇博客文章信息为例</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:http/http.dart'</span> <span class="hljs-keyword">as</span> http; 
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:convert'</span>; 

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpExample</span> </span>{
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; fetchPost() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 发起GET请求</span>
      <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> http.<span class="hljs-keyword">get</span>(
        <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://jsonplaceholder.typicode.com/posts/1'</span>),
      );

      <span class="hljs-comment">// 2. 状态码200表示成功</span>
      <span class="hljs-keyword">if</span> (response.statusCode == <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 3. 使用 dart:convert 解析返回的JSON字符串</span>
        <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; jsonData = json.decode(response.body);
        
        <span class="hljs-comment">// 4. 从解析后的Map中取出数据</span>
        <span class="hljs-built_in">String</span> title = jsonData[<span class="hljs-string">'title'</span>];
        <span class="hljs-built_in">String</span> body = jsonData[<span class="hljs-string">'body'</span>];
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'标题: <span class="hljs-subst">$title</span>'</span>);
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'内容: <span class="hljs-subst">$body</span>'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 请求失败</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求失败，状态码: <span class="hljs-subst">${response.statusCode}</span>'</span>);
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'响应体: <span class="hljs-subst">${response.body}</span>'</span>);
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 捕获异常</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求发生异常: <span class="hljs-subst">$e</span>'</span>);
    }
  }
}
</code></pre>
<p><strong>代码解读：</strong></p>
<ol>
<li><code>async</code>/<code>await</code>：网络请求是耗时操作，必须使用异步。<code>await</code> 会等待请求完成，而不会阻塞UI线程。</li>
<li><code>Uri.parse</code>：将字符串URL转换为Uri对象。</li>
<li><code>response.statusCode</code>：响应状态码，<strong>200系列表示成功</strong>。</li>
<li><code>json.decode()</code>：反序列化将JSON串转换为Dart中的 <code>Map&lt;String, dynamic&gt;</code> 或 <code>List</code>；</li>
</ol>
<h3 data-id="heading-7">五、 <code>dio</code> 库</h3>
<p>下面我们重点讲解下<code>dio</code>库：</p>
<h4 data-id="heading-8">1. Dio-发起请求</h4>
<p>我们先创建一个Dio实例并进行全局配置。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DioManager</span> </span>{
  <span class="hljs-comment">// 单例</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DioManager _instance = DioManager._internal();
  <span class="hljs-keyword">factory</span> DioManager() =&gt; _instance;
  DioManager._internal() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://jsonplaceholder.typicode.com'</span>, 
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">5</span>), <span class="hljs-comment">// 连接超时时间</span>
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>), <span class="hljs-comment">// 接收数据超时时间</span>
      headers: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>, 
      },
    ));
  }

  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Dio _dio;
  Dio <span class="hljs-keyword">get</span> dio =&gt; _dio;
}

<span class="hljs-comment">// GET请求</span>
<span class="hljs-keyword">void</span> fetchPostWithDio() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// baseUrl后面拼接路径</span>
    Response response = <span class="hljs-keyword">await</span> DioManager().dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/posts/1'</span>);
    <span class="hljs-comment">// dio会自动检查状态码，非200系列会抛异常，所以这里直接处理数据</span>
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; data = response.data; <span class="hljs-comment">// 这里dio帮我们自动解析了JSON</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取数据: <span class="hljs-subst">${data[<span class="hljs-string">'title'</span>]}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求异常: <span class="hljs-subst">$e</span>'</span>);
    <span class="hljs-keyword">if</span> (e.response != <span class="hljs-keyword">null</span>) {
      <span class="hljs-comment">// 错误状态码</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'错误状态码: <span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'错误信息: <span class="hljs-subst">${e.response?.data}</span>'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 抛异常</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'异常: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 未知异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'未知异常: <span class="hljs-subst">$e</span>'</span>);
  }
}
</code></pre>
<p><strong>Dio相比Http的优点：</strong></p>
<ul>
<li><strong>自动JSON解析</strong>：<code>response.data</code> 直接就是Map或List，无需手动 <code>json.decode</code>，太方便了！</li>
<li><strong>配置清晰</strong>：<code>BaseOptions</code> 全局配置一目了然。</li>
<li><strong>结构化异常</strong>：<code>DioException</code> 包含了丰富的错误信息。</li>
</ul>
<h4 data-id="heading-9">2. Dio-网络请求流程</h4>
<p>为了让大家更直观地理解，我们用一个流程图来展示Dio处理请求的完整过程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as 客户端
    participant I as 拦截器
    participant D as Dio
    participant S as 服务端

    A-&gt;&gt;D: 发起请求
    Note right of A: await dio.get('/users')
    
    D-&gt;&gt;I: 请求拦截器
    Note right of I: 添加Token、日志等
    
    I-&gt;&gt;D: 处理后的请求
    D-&gt;&gt;S: 发送网络请求
    
    S--&gt;&gt;D: 返回响应
    D-&gt;&gt;I: 响应拦截器
    Note right of I: 解析JSON、错误处理
    
    I-&gt;&gt;D: 处理后的响应
    D--&gt;&gt;A: 返回最终结果
</code></pre>
<h4 data-id="heading-10">3. Dio-拦截器</h4>
<p>拦截器允许我们在请求发送前和响应返回后，插入自定义逻辑，对所有经过的请求和响应进行检查和加工。</p>
<p><strong>案例：自动添加认证Token</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    <span class="hljs-comment">// 请求发送前，为每个请求的Header加上Token</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> token = <span class="hljs-string">'your_auth_token_here'</span>;
    <span class="hljs-keyword">if</span> (token.isNotEmpty) {
      options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$token</span>'</span>;
    }
    
    handler.next(options);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onResponse(Response response, ResponseInterceptorHandler handler) {
    <span class="hljs-comment">// 响应成功处理</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求成功: <span class="hljs-subst">${response.requestOptions.path}</span>'</span>);
    handler.next(response);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onError(DioException err, ErrorInterceptorHandler handler) {
    <span class="hljs-comment">// 失败处理</span>
    <span class="hljs-comment">// 当Token过期时，自动跳转到登录页</span>
    <span class="hljs-keyword">if</span> (err.response?.statusCode == <span class="hljs-number">401</span>) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'Token已过期，请重新登录!'</span>);
      <span class="hljs-comment">// 这里可以跳转到登录页面</span>
      <span class="hljs-comment">// NavigationService.instance.navigateTo('/login');</span>
    }
 
    handler.next(err);
  }
}

<span class="hljs-comment">// 将拦截器添加到Dio实例中</span>
<span class="hljs-keyword">void</span> main() {
  <span class="hljs-keyword">final</span> dio = DioManager().dio;
  dio.interceptors.add(AuthInterceptor());
  <span class="hljs-comment">// 这里可以添加其他拦截器</span>
  dio.interceptors.add(LogInterceptor(responseBody: <span class="hljs-keyword">true</span>)); 
}
</code></pre>
<blockquote>
<p>拦截器的添加顺序就是它们的执行顺序。<code>onRequest</code> 正序执行，<code>onResponse</code> 和 <code>onError</code> 倒序执行。</p>
</blockquote>
<h3 data-id="heading-11">六、 JSON序列化与反序列化</h3>
<blockquote>
<p>这是新手最容易踩坑的地方。直接从JSON转换成Dart对象（Model），能让我们的代码更安全、更易维护。</p>
</blockquote>
<h4 data-id="heading-12">1. 为什么要序列化？</h4>
<ul>
<li><strong>类型安全</strong>：直接操作Map，编译器不知道<code>data[‘title‘]</code>是String还是int，容易写错;</li>
<li><strong>代码效率</strong>：使用点语法<code>post.title</code>访问属性，比<code>post[‘title‘]</code>更高效且有代码提示;</li>
<li><strong>可维护性</strong>：当接口字段变更时，你只需要修改一个Model类，而不是分散在各处的字符串key;;</li>
</ul>
<h4 data-id="heading-13">2. 使用 <code>json_serializable</code>自动序列化</h4>
<p>通过代码生成的方式，自动创建 <code>fromJson</code> 和 <code>toJson</code> 方法，一劳永逸。</p>
<p><strong>步骤1：创建Model类并使用注解</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// post.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;

<span class="hljs-comment">// 运行 `flutter pub run build_runner build` 后，会生成 post.g.dart 文件</span>
<span class="hljs-keyword">part</span> <span class="hljs-string">'post.g.dart'</span>;

<span class="hljs-comment">// 这个注解告诉生成器这个类需要生成序列化代码</span>
<span class="hljs-meta">@JsonSerializable</span>()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> </span>{
  <span class="hljs-comment">// 使用@JsonKey可以自定义序列化行为</span>
  <span class="hljs-comment">// 例如，如果JSON字段名是`user_id`，而Dart字段是`userId`，可以这样映射：</span>
  <span class="hljs-comment">// @JsonKey(name: 'user_id')</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> body;

  Post({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.title,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.body,
  });

  <span class="hljs-comment">// 生成的代码会提供这两个方法</span>
  <span class="hljs-keyword">factory</span> Post.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$PostFromJson(json);
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() =&gt; _$PostToJson(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p><strong>步骤2：运行代码生成命令</strong></p>
<p>在项目根目录下执行：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build
</code></pre>
<p>这个命令会扫描所有带有 <code>@JsonSerializable()</code> 注解的类，并生成对应的 <code>.g.dart</code> 文件（如 <code>post.g.dart</code>）。这个文件里包含了 <code>_$PostFromJson</code> 和 <code>_$PostToJson</code> 的具体实现。</p>
<p><strong>步骤3：自动生成</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 具体的请求方法中使用</span>
<span class="hljs-keyword">void</span> fetchPostModel() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    Response response = <span class="hljs-keyword">await</span> DioManager().dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/posts/1'</span>);
    <span class="hljs-comment">// 将响应数据转换为Post对象</span>
    Post post = Post.fromJson(response.data);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'文章标题: <span class="hljs-subst">${post.title}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// ... 错误处理</span>
  }
}
</code></pre>
<p><strong><code>json_serializable</code> 的优势：</strong></p>
<ul>
<li>自动处理类型转换，避免手误；</li>
<li>通过 <code>@JsonKey</code> 注解可以处理各种复杂场景；</li>
</ul>
<h3 data-id="heading-14">七、 网络层在MVVM模式中的定位</h3>
<p>实际项目中，我们不会直接在UI页面里写网络请求代码。让我们看看网络层在MVVM架构中是如何工作的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[View&lt;br&gt;视图层] --&gt;|调用| B[ViewModel&lt;br&gt;视图模型]
    B --&gt;|调用| C[Model&lt;br&gt;模型层]
    C --&gt;|使用| D[Dio&lt;br&gt;网络层]
    D --&gt;|返回JSON| C
    C --&gt;|转换为Model| B
    B --&gt;|更新状态| A
</code></pre>
<p><strong>各个分层职责：</strong></p>
<ul>
<li><strong>View</strong>：只关心数据的展示和用户交互；</li>
<li><strong>ViewModel</strong>：持有业务状态，处理UI逻辑，不关心数据从哪里来；</li>
<li><strong>Model</strong>：决定数据是从网络获取还是本地数据库读取，它调用网络层；</li>
<li><strong>Dio</strong>：纯粹的网络请求执行者，负责API调用、错误初步处理等；</li>
</ul>
<p><strong>这样分层的好处是：最终目的是解耦</strong>，各司其职，修改网络层不会影响业务逻辑，代码结构清晰，同事方便单元测试。</p>
<h3 data-id="heading-15">八、 错误处理</h3>
<p>一个好的应用，必须支持处理各种异常情况。</p>
<h4 data-id="heading-16">1.  <code>DioException</code></h4>
<p><code>DioException</code> 的类型 (<code>type</code>) 帮助我们准确判断错误根源。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> handleDioError(DioException e) {
  <span class="hljs-keyword">switch</span> (e.type) {
    <span class="hljs-keyword">case</span> DioExceptionType.connectionTimeout:
    <span class="hljs-keyword">case</span> DioExceptionType.sendTimeout:
    <span class="hljs-keyword">case</span> DioExceptionType.receiveTimeout:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'超时错误，请检查网络连接是否稳定。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badCertificate:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'证书错误。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badResponse:
      <span class="hljs-comment">// 服务器返回了错误状态码</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'服务器错误: <span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
      <span class="hljs-comment">// 可以根据不同状态码做不同处理</span>
      <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">404</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求的资源不存在(404)'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">500</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'服务器内部错误(500)'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">401</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'未授权，请重新登录(401)'</span>);
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.cancel:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求被取消。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.connectionError:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络连接错误，请检查网络是否开启。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.unknown:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'未知错误: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<h4 data-id="heading-17">2. 重试机制</h4>
<p>对于因网络波动导致的失败，自动重试能大幅提升用户体验。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RetryInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-keyword">final</span> Dio _dio;

  RetryInterceptor(<span class="hljs-keyword">this</span>._dio);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onError(DioException err, ErrorInterceptorHandler handler) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 只对超时和网络连接错误进行重试</span>
    <span class="hljs-keyword">if</span> (err.type == DioExceptionType.connectionTimeout ||
        err.type == DioExceptionType.receiveTimeout ||
        err.type == DioExceptionType.connectionError) {
      
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> retryCount = err.requestOptions.extra[<span class="hljs-string">'retry_count'</span>] ?? <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> maxRetryCount = <span class="hljs-number">3</span>;

      <span class="hljs-keyword">if</span> (retryCount &lt; maxRetryCount) {
        <span class="hljs-comment">// 增加重试计数</span>
        err.requestOptions.extra[<span class="hljs-string">'retry_count'</span>] = retryCount + <span class="hljs-number">1</span>;
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络不稳定，正在尝试第<span class="hljs-subst">${retryCount + <span class="hljs-number">1</span>}</span>次重试...'</span>);

        <span class="hljs-comment">// 等待一段时间后重试</span>
        <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span> * (retryCount + <span class="hljs-number">1</span>)));

        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 重新发送请求</span>
          <span class="hljs-keyword">final</span> Response response = <span class="hljs-keyword">await</span> _dio.fetch(err.requestOptions);
          <span class="hljs-comment">// 返回成功response</span>
          handler.resolve(response);
          <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">catch</span> (retryError) {
          <span class="hljs-comment">// 如果失败继续传递错误</span>
          handler.next(err);
          <span class="hljs-keyword">return</span>;
        }
      }
    }
    <span class="hljs-comment">// 如果不是指定错误或已达最大重试次数，则继续传递错误</span>
    handler.next(err);
  }
}
</code></pre>
<h3 data-id="heading-18">九、 封装一个完整的网络请求库</h3>
<p>到这已经把所有的网络请求知识学完了，下面我们用学到的知识封装一个通用的网络请求工具类。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// http_client.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpClient</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpClient _instance = HttpClient._internal();
  <span class="hljs-keyword">factory</span> HttpClient() =&gt; _instance;

  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Dio _dio;

  HttpClient._internal() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://api.yourserver.com/v1'</span>,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      headers: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
    ));

    <span class="hljs-comment">// 添加拦截器</span>
    _dio.interceptors.add(LogInterceptor(
      requestBody: kDebugMode, 
      responseBody: kDebugMode,
    ));
    _dio.interceptors.add(AuthInterceptor());
    _dio.interceptors.add(RetryInterceptor(_dio));
  }

  <span class="hljs-comment">// 封装GET请求</span>
  Future&lt;Response&lt;T&gt;&gt; <span class="hljs-keyword">get</span>&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? headers,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> options = Options(headers: headers);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.<span class="hljs-keyword">get</span>&lt;T&gt;(
        path,
        queryParameters: queryParameters,
        options: options,
      );
    } <span class="hljs-keyword">on</span> DioException {
      <span class="hljs-keyword">rethrow</span>; 
    }
  }

  <span class="hljs-comment">// 封装POST请求</span>
  Future&lt;Response&lt;T&gt;&gt; post&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">dynamic</span> data,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? headers,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> options = Options(headers: headers);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.post&lt;T&gt;(
        path,
        data: data,
        queryParameters: queryParameters,
        options: options,
      );
    } <span class="hljs-keyword">on</span> DioException {
      <span class="hljs-keyword">rethrow</span>;
    }
  }

  <span class="hljs-comment">// 获取列表数据</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;T&gt;&gt; getList&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;)? fromJson,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">get</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt;&gt;(path, queryParameters: queryParameters);
    <span class="hljs-comment">// 将List&lt;dynamic&gt;转换为List&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (fromJson != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> response.data!.map&lt;T&gt;((item) =&gt; fromJson(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;)).toList();
    }
    
    <span class="hljs-keyword">return</span> response.data <span class="hljs-keyword">as</span> <span class="hljs-built_in">List</span>&lt;T&gt;;
  }

  <span class="hljs-comment">// 获取单个对象</span>
  Future&lt;T&gt; getItem&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-keyword">required</span> T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;) fromJson,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">get</span>&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;(path, queryParameters: queryParameters);
    <span class="hljs-keyword">return</span> fromJson(response.data!);
  }
}

<span class="hljs-comment">// </span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostRepository</span> </span>{
  <span class="hljs-keyword">final</span> HttpClient _client = HttpClient();

  Future&lt;Post&gt; getPost(<span class="hljs-built_in">int</span> id) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.getItem(
      <span class="hljs-string">'/posts/<span class="hljs-subst">$id</span>'</span>,
      fromJson: Post.fromJson, 
    );
    <span class="hljs-keyword">return</span> response;
  }

  Future&lt;<span class="hljs-built_in">List</span>&lt;Post&gt;&gt; getPosts() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.getList(
      <span class="hljs-string">'/posts'</span>,
      fromJson: Post.fromJson,
    );
    <span class="hljs-keyword">return</span> response;
  }

  Future&lt;Post&gt; createPost(Post post) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Model转JSON</span>
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.post(
      <span class="hljs-string">'/posts'</span>,
      data: post.toJson(),
    );
    <span class="hljs-keyword">return</span> Post.fromJson(response.data);
  }
}
</code></pre>
<h3 data-id="heading-19">总结</h3>
<p>又到了写总结诶的时候了，让我们用一张表格来回顾所有知识点：</p>













































<table><thead><tr><th align="left">知识点</th><th align="left">核心</th><th align="left">用途</th></tr></thead><tbody><tr><td align="left"><strong>库选择</strong></td><td align="left"><code>http</code> 轻量，<code>dio</code> 强大</td><td align="left">中大型项目首选 <code>dio</code></td></tr><tr><td align="left"><strong>异步编程</strong></td><td align="left">使用 <code>async</code>/<code>await</code> 处理耗时操作</td><td align="left">不能阻塞UI线程</td></tr><tr><td align="left"><strong>JSON序列化</strong></td><td align="left">自动生成</td><td align="left"><strong>推荐</strong> <code>json_serializable</code></td></tr><tr><td align="left"><strong>错误处理</strong></td><td align="left">区分网络异常和服务器错误</td><td align="left">精确捕获 <code>DioException</code> 并分类处理</td></tr><tr><td align="left"><strong>拦截器</strong></td><td align="left">统一处理请求/响应</td><td align="left">用于添加Token、日志、重试逻辑</td></tr><tr><td align="left"><strong>架构分层</strong></td><td align="left">MVVM</td><td align="left">分离解耦</td></tr><tr><td align="left"><strong>请求封装</strong></td><td align="left">统一封装GET/POST等基础方法</td><td align="left">提供 <code>getItem</code>, <code>getList</code> 等语义化方法</td></tr></tbody></table>
<p>网络请求在实际项目中直观重要，没有网络就没有数据，掌握好本章内容，你就能为你Flutter应用注入源源不断的活力。让我们下期见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“误操作导致 feat 功能未生效，尽管 merge 已完成”]]></title>    <link>https://juejin.cn/post/7571734313928015906</link>    <guid>https://juejin.cn/post/7571734313928015906</guid>    <pubDate>2025-11-13T08:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571734313928015906" data-draft-id="7571559178742874147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“误操作导致 feat 功能未生效，尽管 merge 已完成”"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-11-13T08:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="山有木兮木有枝_"/> <meta itemprop="url" content="https://juejin.cn/user/3393532732927097"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “误操作导致 feat 功能未生效，尽管 merge 已完成”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3393532732927097/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    山有木兮木有枝_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:29:27.000Z" title="Thu Nov 13 2025 08:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>场景：</p>
<blockquote>
<p><strong>假如在本地 <code>test</code> 分支合并了远程分支（比如 <code>feat</code>），但在合并过程中“放弃了某些文件的修改”（比如手动 checkout 或 restore 覆盖了冲突文件，但没正确提交或处理），导致本地 <code>test</code> 的内容和远程 <code>test</code> 不一致。现在你想再次合并，Git 却提示“Already up to date”（已经是最新），但实际上代码并不一致。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🔍 问题本质</h2>
<p>Git 判断是否“需要合并”的依据是 <strong>提交历史（commit history）</strong> ，而不是文件内容。</p>
<ul>
<li>如果你本地 <code>test</code> 分支的 <strong>最新提交</strong> 已经包含了远程 <code>feat</code> 分支的所有提交（通过之前的合并），那么 Git 就认为“无需再合并”，即使你<strong>手动改过文件内容</strong>。</li>
<li>换句话说：<strong>你本地丢弃了某些变更，但 Git 的历史记录仍然认为“这些变更已经被合并过了”</strong> 。</li>
</ul>
<p>所以，<code>git merge origin/feat</code> → 提示 “Already up to date”，但文件内容却不是 <code>feat</code> 分支的样子。</p>
<hr/>
<h2 data-id="heading-1">✅ 解决方案</h2>
<h3 data-id="heading-2">✅ 方法一：<strong>重新应用 feat 分支的变更（推荐）</strong></h3>
<p>目标：让 <code>test</code> 分支真正拥有 <code>feat</code> 分支中那些被你丢弃的文件内容。</p>
<h4 data-id="heading-3">步骤：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保在 test 分支</span>
git checkout <span class="hljs-built_in">test</span>

<span class="hljs-comment"># 2. 获取最新远程信息</span>
git fetch origin

<span class="hljs-comment"># 3. 直接从远程 feat 分支检出你需要的文件（覆盖当前）</span>
git checkout origin/feat -- path/to/file1 path/to/file2

<span class="hljs-comment"># 或者如果你要整个 feat 分支的全部文件（谨慎！）</span>
<span class="hljs-comment"># git checkout origin/feat -- .</span>

<span class="hljs-comment"># 4. 提交这个“修正”</span>
git add .
git commit -m <span class="hljs-string">"fix: restore files from feat branch that were dropped during merge"</span>

<span class="hljs-comment"># 5. 推送到远程 test（如果需要）</span>
git push origin <span class="hljs-built_in">test</span>
</code></pre>
<blockquote>
<p>这样做不会改变历史，只是新增一个提交来“补回”之前丢失的内容。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">✅ 方法二：<strong>撤销之前的错误合并，重新合并</strong></h3>
<p>如果之前的合并是“错误的”（因为丢弃了重要内容），可以<strong>回退那次合并提交</strong>，然后重新干净地合并。</p>
<h4 data-id="heading-5">步骤：</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 查看提交历史，找到错误合并的提交 ID（假设是 abc1234）</span>
git <span class="hljs-keyword">log</span> --oneline -<span class="hljs-number">10</span>

<span class="hljs-comment"># 2. 回退到合并前的状态（保留更改在工作区，方便检查）</span>
git <span class="hljs-keyword">reset</span> --hard HEAD~<span class="hljs-number">1</span>   <span class="hljs-comment"># 如果合并是上一个提交</span>

<span class="hljs-comment"># 或者更安全的方式：创建一个新分支备份当前状态</span>
git branch backup-test

<span class="hljs-comment"># 然后硬重置</span>
git <span class="hljs-keyword">reset</span> --hard &lt;合并前的提交ID&gt;

<span class="hljs-comment"># 3. 重新合并 feat</span>
git merge origin/feat

<span class="hljs-comment"># 这次认真处理冲突，不要随意丢弃修改！</span>

<span class="hljs-comment"># 4. 推送（可能需要 force，如果是共享分支请谨慎！）</span>
git <span class="hljs-keyword">push</span> --force-with-lease origin test
</code></pre>
<blockquote>
<p>⚠️ 注意：如果 <code>test</code> 是多人协作的公共分支，<strong>强制推送会重写历史</strong>，务必先沟通！</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">✅ 方法三：用 <code>cherry-pick</code> 补关键提交（适用于只丢了几份文件）</h3>
<p>如果 <code>feat</code> 分支只有少数几个提交修改了关键文件，你可以单独 pick 这些提交：</p>
<pre><code class="hljs language-python" lang="python">git cherry-pick &lt;commit-<span class="hljs-built_in">id</span>-that-modified-the-file&gt;
</code></pre>
<hr/>
<h2 data-id="heading-7">🛡️ 如何避免下次再发生？</h2>
<ol>
<li><strong>不要在合并冲突时随意 <code>git checkout --theirs</code> 或手动覆盖而不提交</strong><br/>
→ 应该解决冲突后 <code>git add</code> + <code>git commit</code>。</li>
<li><strong>合并前先 <code>git status</code> 和 <code>git diff</code> 确认内容</strong></li>
<li><strong>使用 PR/MR（Pull Request / Merge Request）机制</strong><br/>
→ 在 Web 界面审查变更，避免本地误操作。</li>
<li><strong>合并后运行测试，确认功能正常</strong></li>
</ol>
<hr/>
<h2 data-id="heading-8">🔚 总结</h2>















<table><thead><tr><th>问题</th><th>原因</th><th>解法</th></tr></thead><tbody><tr><td>Git 说“Already up to date”但文件不对</td><td>合并历史存在，但文件内容被手动丢弃</td><td>① 手动检出文件并提交；② 回退合并重做</td></tr></tbody></table>
<p>最安全、最简单的做法是：<br/>
👉 <strong>用 <code>git checkout origin/feat -- 文件路径</code> 把缺失的文件补回来，然后提交推送。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【跨国数仓迁移最佳实践11】基于 MaxCompute Resource & Quota策略优化实现资源管理性能与成本最优平衡]]></title>    <link>https://juejin.cn/post/7571815997067411496</link>    <guid>https://juejin.cn/post/7571815997067411496</guid>    <pubDate>2025-11-13T08:30:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997067411496" data-draft-id="7571722835659014178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【跨国数仓迁移最佳实践11】基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-11-13T08:30:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【跨国数仓迁移最佳实践11】基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:30:10.000Z" title="Thu Nov 13 2025 08:30:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本系列文章将围绕东南亚头部科技集团的真实迁移历程展开，逐步拆解 BigQuery 迁移至 MaxCompute 过程中的关键挑战与技术创新。本篇为第十一篇，基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡。</p>
<p>注：客户背景为东南亚头部科技集团，文中用 GoTerra 表示。</p>
<h2 data-id="heading-0">1. 背景</h2>
<p>GoTerra作为东南亚互联网头部企业，其业务生态覆盖网约车、电商、外卖、物流及金融支付等多个垂直领域，内部采用多账户架构（10+ Accounts，70+ Projects）及上百个资源额度组（Quota Group）进行精细化管理。在从BigQuery迁移至阿里云MaxCompute的过程中，对资源管理的核心诉求在于通过智能弹性资源分配策略，动态适配业务负载波动，在控制成本的同时避免资源瓶颈，实现性能与成本的最优平衡。面临以下核心挑战：</p>
<p><strong>多业务线资源协调复杂</strong></p>
<ul>
<li><strong>规模庞大</strong>：跨10+独立业务单元（Account），涉及70+项目（Project），需创建100+资源额度组（Quota Group），资源管理颗粒度极细。</li>
<li><strong>资源预留成本压力</strong>：每个Quota Group需按配置预留资源（CU），预付费模式下资源闲置与成本控制难以平衡。</li>
</ul>
<p><strong>计费模式差异带来的不确定性</strong></p>
<ul>
<li><strong>MaxCompute</strong>：预付费CU + 定时弹性资源模式，迁移前缺乏历史数据支撑，无法精准预估所需CU量，存在资源预留不足（性能瓶颈）或过度配置（成本浪费）的双重风险</li>
</ul>
<p><strong>多类型作业资源需求冲突</strong></p>
<ul>
<li><strong>ETL作业</strong>：需保障1小时内完成海量数据处理，依赖高吞吐计算资源。</li>
<li><strong>BI作业</strong>：要求10-15分钟低延迟响应，需快速分配临时资源。</li>
<li><strong>并存挑战</strong>：长周期ETL与短周期BI作业共享资源池，如何动态调度以避免资源争抢、同时满足不同SLA（服务等级协议），成为性能与成本平衡的关键难题。</li>
</ul>
<h2 data-id="heading-1">2. Resource Advisor和TopN Fair</h2>
<h3 data-id="heading-2">2.1. Resource Advisor</h3>
<h4 data-id="heading-3">2.1.1. 核心挑战</h4>
<p><strong>资源预估难题:</strong></p>
<ul>
<li>计费模式差异</li>
<li>作业类型复杂</li>
</ul>
<p><strong>多业务实体管理，每个业务实体需独立阿里云账号，SLA要求不同，导致资源购买量预期不一致：</strong></p>
<ul>
<li>超买：资源闲置浪费，挤占集群容量</li>
<li>少买：作业堆积，等资源时间长，影响业务数据产出</li>
</ul>
<p>如何在控制成本的前提下，动态适配业务负载波动，避免资源瓶颈</p>
<h4 data-id="heading-4">2.1.2. 分层资源配置策略</h4>





























<table><thead><tr><th>资源配置</th><th>用途</th><th>配置原则</th><th>计费</th></tr></thead><tbody><tr><td>预付费CU</td><td>保障全天候基线资源需求，覆盖日常稳定负载</td><td>基于历史日均负载的80%-90%预购CU适用于ETL类周期性作业（如每日定时批处理）。</td><td>按购买量计费，24h预留，计费时间24h</td></tr><tr><td>定时弹性CU(Adhoc)</td><td>适用于可预测的负载波动（如BI报表每日上午集中执行）</td><td>在业务高峰期（如早晚高峰）自动扩容资源，峰值后释放</td><td>指定时间计费按购买量计费，指定时间预留</td></tr><tr><td>AutoScaleQuota</td><td>应对突发BI作业流量</td><td>预估突发流量峰值，配置弹性上限</td><td>动态监控实时资源利用率，触发自动扩缩容。超出预付费CU+Adhoc CU部分按分钟级计费，避免突发流量导致的资源不足</td></tr></tbody></table>
<p>其中AutoScaleQuota是应对GoTerra迁移场景新增的产品类型，解决迁移过程中，业务资源需求变化快，作业性能要求高的需求：</p>
<p>分层配置策略特点：</p>
<ul>
<li>
<p><strong>灵活组合</strong>：支持预付费、分时弹性与自动弹性任意搭配，满足不同业务场景的降本增效需求</p>
</li>
<li>
<p><strong>极致成本</strong>：自动弹性部分，按实际使用量计费；相比扩缩槽等预留付费模式更加经济实惠</p>
</li>
<li>
<p><strong>开箱即用</strong>：基于负载感知的自动弹性扩缩容，配置简单</p>
</li>
<li>
<p><strong>秒级弹性</strong>：对比BigQuery限制扩缩容步长和窗口期，MaxCompute更加灵活及时</p>
</li>
<li>
<p><strong>资源稳定</strong>：基于历史数据和预测模型进行资源调度优化，保障弹性库存供给</p>
</li>
</ul>
<h4 data-id="heading-5">2.1.3. 智能资源推荐与弹性配置</h4>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/27030/1755447893739-4d81b9fc-e3c2-443f-88ec-b41693951a22.jpeg" alt="img" loading="lazy"/></p>
<p>资源推荐工具（T+1动态调优）</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>基于历史数据的作业运行日志与资源消耗，结合作业类型（ETL/BI）的SLA要求，预测次日CU需求。</li>
</ul>
<p><strong>技术实现：</strong></p>
<ul>
<li>数据采集：抓取作业运行时长、CPU/内存消耗、并发度等指标。</li>
<li>作业分类模型：自动识别ETL/BI作业。</li>
</ul>
<p><strong>资源预测算法：</strong></p>
<ul>
<li>线性回归：基于历史资源消耗趋势预测基线需求。</li>
<li>弹性缓冲：根据业务波动率增加10%-20%冗余量。</li>
<li>反馈优化：每日对比实际资源消耗与预测值，动态调整模型参数。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/27030/1755447804209-897f84f9-8a75-4172-a4d7-dbadc8e06fcd.png" alt="img" loading="lazy"/></p>
<h4 data-id="heading-6">2.1.4. 推荐效果</h4>
<p>GoTerra迁入MaxCompute过程中，MaxCompute进行了深度架构升级和性能优化，同时在合理的资源配置规划下，根据用户历史作业数据定期推荐用户Quota组配置和策略，每月实际产生费用约降低到BigQuery的42%。</p>
<h3 data-id="heading-7">2.2. TopN Fair</h3>
<h4 data-id="heading-8">2.2.1. 现有调度策略局限性</h4>

























<table><thead><tr><th/><th>FIFO</th><th>FAIR</th></tr></thead><tbody><tr><td>调度策略说明</td><td>对于作业优先级相同的场景，资源将优先分配至先提交的作业。对于作业优先级不同的场景，即使优先级高的作业提交时间晚于优先级低的作业，资源也将优先分配至高优先级作业。</td><td>对于作业优先级相同的场景，资源将平均分配至同一时间提交的所有作业。对于作业优先级不同的场景，资源优先平均分配给优先级较高的作业，若有剩余，再平均分配给优先级较低的作业</td></tr><tr><td>优点&amp;适用场景</td><td>保障先提交的作业优先执行，适合ETL类长时间任务</td><td>资源均分给最高优先级的所有作业，适合短时BI任务</td></tr><tr><td>缺点</td><td>小作业需等待长作业完成，导致延迟（“头阻塞”)</td><td>先提交的作业可能因资源被平分走而延长执行时间</td></tr></tbody></table>
<p>GOTO业务需求</p>
<p><strong>混合负载场景：ETL（长作业）与BI（短作业）并存</strong></p>
<p><strong>核心诉求：</strong></p>
<ul>
<li>长作业优先：先提交的ETL作业需保障足够并发资源</li>
<li>短作业友好：后提交的BI作业可短时借用资源，但不显著影响长作业进度</li>
</ul>
<h4 data-id="heading-9">2.2.2. 新策略：TopN Fair + 动态并发保障</h4>
<h6 data-id="heading-10">2.2.2.1. 核心设计目标</h6>
<ul>
<li>资源隔离：确保长作业的最低并发度（JobMinimumConcurrency）。</li>
<li>弹性资源复用：在满足长作业的前提下，允许Quota组保留部分资源给短作业动态借用。</li>
<li>优先级分层：结合作业类型（ETL/BI）和提交时间，实现混合调度。</li>
</ul>
<h6 data-id="heading-11">2.2.2.2. 关键参数定义</h6>
<ul>
<li>JobMinimumConcurrency（最低并发度）：</li>
<li>每个作业运行所需的最小并发度。</li>
<li>全局配置项，例如：JobMinimumConcurrency=10 表示每个作业至少分配10个并发单元。</li>
<li>TopN Fair策略：</li>
<li>TopN作业：按提交时间排序，在至少保障每个作业JobMinimumConcurrency并发度的情况下，挑选前N个作业分配Quota组资源</li>
</ul>
<h6 data-id="heading-12">2.2.2.3. <strong>动态N值计算公式</strong></h6>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/0a5ab9849511b050a1193e319fef1a95.svg" alt="img" loading="lazy"/></p>
<p>计算出N，如果<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/1b75d0123aca04d79d5f853ed77b7409.svg" alt="img" loading="lazy"/>，则<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/2e5e940745bf407dc626f3a83aaf3e1d.svg" alt="img" loading="lazy"/></p>
<p>符号解释：</p>
<ul>
<li><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/246dc4d855e50ae1dc924cc0a7d9c7d8.svg" alt="img" loading="lazy"/>：第i个作业的资源需求（如CPU核数、内存）。</li>
<li>Runtime：Quota组当前可用的资源量</li>
<li><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/32ffe6a546bdc55dc0a2d71bb0929934.svg" alt="img" loading="lazy"/>：当前最少可参与资源分配的作业数</li>
</ul>
<p>公式含义：
动态计算N值，确保前N个作业的累计资源需求不超过Quota组总容量的JobMinimumConcurrency倍，且至少保障<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/32ffe6a546bdc55dc0a2d71bb0929934.svg" alt="img" loading="lazy"/>个作业参与资源分配，避免少量作业占满整个组；</p>
<h4 data-id="heading-13">2.2.3. 策略优势</h4>





























<table><thead><tr><th>维度</th><th>FIFO</th><th>FAIR</th><th>TopN Fair + 短作业插队</th></tr></thead><tbody><tr><td>长作业保障</td><td>强</td><td>弱</td><td>强</td></tr><tr><td>短作业支持</td><td>差</td><td>强</td><td>强</td></tr><tr><td>使用场景</td><td>ETL</td><td>BI</td><td>ETL+BI混合场景</td></tr></tbody></table>
<h4 data-id="heading-14">2.2.4. 实际效果</h4>
<p>整集群作业平均运行数下降15.7%，作业运行时Latency 95分位值下降45.7%，GoTerra用户的效果较好的Quota组，作业平均运行数下降31.3%, 作业运行时Latency 95分位值下降75.4%。</p>
<h2 data-id="heading-15">3. 结语与展望</h2>
<p>GoTerra迁移到MaxCompute后，Resource Advisor持续通过智能资源推荐优化成本，目标将总体费用控制在BigQuery的40%以内。随着新产品AutoScaleQuota上线，资源管理实现全自动化：基于业务负载动态调整配额，无需人工干预，彻底解决突发流量导致的资源不足与作业等待问题。同时，TopN Fair已在印尼集群全面上线，后续的发展方向：分析各Quota组作业执行模式，自动配置JobMinimumConcurrency并动态切换调度策略，进一步提升资源利用率。</p>
<p>在性能与成本优化的基础上，稳定性也是一个非常重要的目标，系统稳定性目标达99.99%可用性，保障GoTerra在MaxCompute上实现“低成本、高效率、强稳定”的运行体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待]]></title>    <link>https://juejin.cn/post/7572022112102580250</link>    <guid>https://juejin.cn/post/7572022112102580250</guid>    <pubDate>2025-11-13T08:32:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572022112102580250" data-draft-id="7572002432450166793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T08:32:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快递鸟"/> <meta itemprop="url" content="https://juejin.cn/user/4279725171674573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4279725171674573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快递鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:32:48.000Z" title="Thu Nov 13 2025 08:32:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>物流信息滞后，早已是困扰商家与用户的核心痛点 —— 用户下单后反复刷新查不到轨迹，商家客服被 “包裹到哪了” 的咨询淹没，异常包裹错过最佳处理时机，这些场景在日常物流中屡见不鲜。对商家而言，物流信息滞后不仅增加客服压力，还会导致用户信任流失、复购率下降；对用户来说，模糊的物流状态意味着焦虑与不确定性，甚至可能引发订单取消。快递鸟针对性推出在途监控 API，以 “毫秒级响应、全链路覆盖、智能预警” 为核心，彻底破解物流信息滞后难题，让物流状态实时可见、异常及时可控，重塑物流信息透明化体验。</p>
<p><strong>一、物流信息滞后的核心痛点：商家与用户的双重困扰</strong></p>
<p>物流信息滞后并非简单的 “更新慢”，而是贯穿运输全流程的连锁问题，对商家和用户造成多维度影响：</p>
<p><strong>1. 用户体验滑坡，信任持续流失</strong></p>
<p>用户下单后最关心 “包裹是否发出、何时能到”，但传统物流信息常出现 “揽收后半天无更新”“中转节点断层”“派件前突然失联” 等情况。这种不确定性让用户频繁咨询客服，甚至因焦虑取消订单；部分用户因物流信息模糊，怀疑包裹丢失或错发，直接给出差评，损害商家口碑。数据显示，超 60% 的物流相关投诉，根源都在于信息更新不及时。</p>
<p><strong>2. 商家客服承压，运营效率低下</strong></p>
<p>物流信息滞后直接导致商家客服咨询量激增，“查件” 成为客服日常工作的核心内容。客服需切换多个物流商系统逐一查询，再手动反馈给用户，不仅占用大量人力，还易出现回复不及时、信息不准确的问题；大促期间，滞后的物流信息让客服团队不堪重负，甚至影响其他售后问题的处理效率。</p>
<p><strong>3. 异常处理被动，损失不断扩大</strong></p>
<p>包裹出现中转滞留、破损、地址错误等异常时，传统模式下需等用户反馈或物流商通知，商家才能知晓。此时往往已错过最佳处理时机 —— 滞留包裹可能继续延误，破损包裹难以界定责任，最终导致用户投诉升级、理赔成本增加，甚至引发品牌信任危机。</p>
<p><strong>4. 运营决策盲目，优化无从下手</strong></p>
<p>缺乏实时、精准的物流数据支撑，商家无法准确判断物流商的实际时效、异常率等核心指标。选择物流合作方、优化发货流程、制定促销履约预案时，只能依赖经验而非数据，导致物流成本居高不下，履约体验难以提升。</p>
<p><strong>二、快递鸟在途监控 API：毫秒级响应破解滞后难题</strong></p>
<p>快递鸟在途监控 API 以技术突破为核心，通过 “实时数据同步、全链路覆盖、智能预警、数据协同” 四大优势，从根源上解决物流信息滞后问题，让物流状态 “秒级更新、全程可视”。</p>
<p><strong>1. 毫秒级数据同步，信息更新无延迟</strong></p>
<p>快递鸟在途监控 API 的核心竞争力，在于其极致的响应速度 —— 依托分布式架构与智能数据抓取技术，实现物流数据 “毫秒级同步、秒级更新”：</p>
<ul>
<li>对接 2700 + 国内外物流商的实时数据接口，包裹的揽收、中转、派送、签收等每一个节点变动，都会在毫秒内被抓取并同步至 API；</li>
<li>数据传输采用 HTTPS 加密与高速通道，确保信息从物流商系统到商家 / 用户终端的传输延迟控制在 100-300 毫秒内，远超传统物流查询工具的分钟级甚至小时级更新速度；</li>
<li>支持高并发查询，即便大促期间单日百万级订单查询，仍能保持毫秒级响应，避免查询拥堵导致的信息延迟。</li>
</ul>
<p>对用户而言，下单后可实时查看包裹动态，每一次节点变动都能即时知晓；对商家来说，客服查询物流信息时 “即查即得”，无需等待加载，响应效率提升 80%。</p>
<p><strong>2. 全链路轨迹覆盖，无信息盲区</strong></p>
<p>快递鸟在途监控 API 打破传统物流信息 “断档” 问题，实现从 “下单 - 揽收 - 中转 - 末端派送 - 签收” 的全链路轨迹覆盖，尤其适配复杂物流场景：</p>
<ul>
<li>国内物流：覆盖快递、快运、同城即时配送等场景，详细展示每个中转中心、网点的处理时间，甚至标注 “快递员正在派送”“即将送达” 等精细化状态；</li>
<li>跨境物流：同步国际运输节点与清关进度，清晰展示 “国内揽收 - 国际航班起飞 - 目的国清关 - 末端派送” 全流程，让跨境物流不再 “黑箱操作”；</li>
<li>特殊场景：生鲜冷链订单同步温湿度数据，大件物流标注 “上门搬运”“安装预约” 状态，异常订单实时标记 “滞留”“破损” 等提示，确保信息无死角。</li>
</ul>
<p><strong>3. 智能异常预警，变被动为主动</strong></p>
<p>快递鸟在途监控 API 不止于 “实时展示”，更能主动识别异常、提前预警，帮助商家抢占处理先机：</p>
<ul>
<li>预设 40 + 异常场景规则，包括揽收超时、中转滞留超 4 小时、派件失败、地址错误、温湿度异常等，系统自动监控包裹状态，一旦触发异常规则，立即通过 API 推送预警信息；</li>
<li>预警方式灵活多样，支持短信、站内信、Webhook 等多种渠道，商家可实时接收异常通知，第一时间协调物流商处理，避免问题扩大；</li>
<li>异常原因智能分析，API 会结合历史数据与物流商规则，初步判断异常原因（如 “中转中心爆仓”“地址不完整”），为商家提供处理方向参考。</li>
</ul>
<p>例如，某电商商家通过 API 发现包裹 “中转滞留超 4 小时”，立即联系物流商加急处理，最终避免了包裹延误，用户满意度未受影响 —— 这种主动干预，远比用户投诉后再处理更高效。</p>
<p><strong>4. 数据深度协同，打通全业务闭环</strong></p>
<p>快递鸟在途监控 API 并非孤立的查询工具，而是能与商家业务系统深度协同，让物流数据成为运营决策的支撑：</p>
<ul>
<li>
<p>与订单系统联动：物流状态自动同步至商家订单系统，触发对应订单状态变更（如 “已揽收”“已签收”），无需人工手动更新；</p>
</li>
<li>
<p>与客服系统集成：客服接待用户时，系统自动显示对应订单的物流轨迹，无需手动查询，响应速度提升 50%；</p>
</li>
<li>
<p>与数据分析系统对接：自动汇总物流时效、异常率、各物流商表现等多维度数据，生成可视化报表，帮助商家优化物流合作方案、调整发货策略。</p>
</li>
</ul>
<p><strong>三、典型应用场景：快递鸟 API 适配多元物流需求</strong></p>
<p>快递鸟在途监控 API 的灵活性，使其能精准适配不同行业、不同规模的物流场景，落地效果显著：</p>
<p><strong>1. 电商日常发货场景</strong></p>
<p>某服饰电商日均发货 2000 单，接入 API 后，用户在订单页即可查看实时物流轨迹，查件咨询量下降 60%；客服无需切换多个物流系统，直接在后台获取轨迹信息，工作效率提升 40%；异常包裹提前预警，售后纠纷率下降 70%，店铺 DSR 评分提升 0.4 分。</p>
<p><strong>2. 跨境电商物流场景</strong></p>
<p>某跨境美妆商家通过 API 对接国际物流商，用户可实时查看清关进度与国际运输轨迹，“清关多久”“包裹到哪国了” 的咨询量减少 55%；商家通过 API 监控清关异常，提前补充申报资料，清关延误率从 25% 降至 5%，用户复购率增长 20%。</p>
<p><strong>3. 大促峰值履约场景</strong></p>
<p>双 11 期间，某家居商家订单量激增至 10000 单 / 日，依托 API 的高并发处理能力，物流信息更新无延迟；商家通过 API 批量监控包裹状态，快速筛选异常订单并处理，大促期间物流投诉率从 30% 降至 8%，履约效率大幅提升。</p>
<p><strong>4. 生鲜冷链场景</strong></p>
<p>某生鲜平台接入 API 后，实时同步冷链包裹的温湿度数据，一旦超出预设范围立即预警，商家及时协调物流商调整温控，生鲜破损率从 12% 降至 3%；用户在订单页查看温湿度记录，对产品新鲜度更放心，复购率提升 25%。</p>
<p><strong>四、落地核心价值：商家与用户的双向共赢</strong></p>
<p><strong>1. 商家端：降本提效，构建核心竞争力</strong></p>
<ul>
<li>客服成本降低：查件咨询量下降 60%，客服团队规模可缩减 30%-50%，人力成本显著降低；</li>
<li>售后纠纷减少：异常提前预警与快速处理，物流相关投诉率下降 70%，品牌口碑持续优化；</li>
<li>运营决策科学：物流数据实时汇总分析，为物流商选择、发货优化提供依据，物流成本平均降低 10%-15%；</li>
<li>履约效率提升：全流程数据协同，订单处理效率提升 50%，大促峰值无需额外加班即可应对。</li>
</ul>
<p><strong>2. 用户端：体验升级，物流透明更安心</strong></p>
<ul>
<li>查件更便捷：在下单平台即可实时查看全链路轨迹，无需跳转第三方工具，操作简化 80%；</li>
<li>等待不焦虑：毫秒级更新 + 关键节点推送，清晰知晓包裹动态与预计送达时间，消除不确定性；</li>
<li>权益有保障：异常情况提前告知，问题及时处理，无需反复咨询客服，消费体验更顺畅；</li>
<li>信任度提升：透明、高效的物流信息展示，增强对商家的信任，复购意愿显著提升。</li>
</ul>
<p><strong>​</strong></p>
<p><strong>结语</strong></p>
<p>物流信息的透明化与实时性，早已成为衡量物流服务品质的核心标准。快递鸟在途监控 API 以 “毫秒级响应” 打破物流信息滞后的行业痛点，通过全链路覆盖、智能预警、数据协同，让物流状态从 “模糊未知” 变为 “清晰可控”，既为商家降低运营成本、提升效率，也为用户带来更安心、更便捷的物流体验。</p>
<p>在物流数字化深入发展的今天，物流信息的实时性已成为商家的核心竞争力之一。快递鸟在途监控 API 不仅是一款工具，更是商家优化物流体验、构建品牌信任的重要支撑。未来，随着 AI、物联网技术的深度融合，快递鸟还将实现更精准的时效预测、更智能的异常干预，让物流信息服务更具价值，推动行业向更高效、更透明的方向发展。物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2618. 检查是否是类的对象实例（JavaScript）]]></title>    <link>https://juejin.cn/post/7572004684178145334</link>    <guid>https://juejin.cn/post/7572004684178145334</guid>    <pubDate>2025-11-13T09:00:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178145334" data-draft-id="7571815573932998719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2618. 检查是否是类的对象实例（JavaScript）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-13T09:00:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2618. 检查是否是类的对象实例（JavaScript）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:00:04.000Z" title="Thu Nov 13 2025 09:00:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>题目链接：<code>https://leetcode.cn/problems/check-if-object-instance-of-class/description/</code></li>
<li>难度：简单</li>
<li>类型：JavaScript/原型链/类型判断</li>
</ul>
<h2 data-id="heading-0">题目要点</h2>
<ul>
<li>给定 <code>value</code> 与 <code>classFn</code>，判断 <code>value</code> 是否是 <code>classFn</code> 或其超类的实例。</li>
<li>需要考虑 <code>undefined</code>、<code>null</code>、非函数的 <code>classFn</code>。</li>
<li>对原始类型与其包装类（如 <code>5</code> 与 <code>Number</code>）要正确处理。</li>
</ul>
<h2 data-id="heading-1">解法一：<code>instanceof</code> + 原始类型映射（推荐）</h2>
<ul>
<li>思路：
<ul>
<li>优先用 <code>instanceof</code> 判断对象与原型链关系（内部会调用 <code>Symbol.hasInstance</code>）。</li>
<li>对原始类型做特判，使 <code>number → Number</code>、<code>string → String</code>、<code>boolean → Boolean</code>、<code>bigint → BigInt</code>、<code>symbol → Symbol</code> 返回 <code>true</code>。</li>
<li>非法输入（<code>classFn</code> 非函数或任一为 <code>null/undefined</code>）返回 <code>false</code>。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 检查值是否为给定类或其超类的实例
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstance</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> classFn) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<ul>
<li>
<p>复杂度：</p>
<ul>
<li><code>instanceof</code> 的原型链检查为 <code>O(h)</code>（<code>h</code> 为原型链高度）。</li>
<li>原始类型映射为 <code>O(1)</code>。</li>
</ul>
</li>
<li>
<p>边界说明：</p>
<ul>
<li><code>checkIfInstance(Date, Date) → false</code>（<code>Date</code> 是 <code>Function</code> 的实例）。</li>
<li><code>checkIfInstance(5, Number) → true</code>（与题目示例一致）。</li>
<li><code>checkIfInstance(5, Object) → false</code>（不把原始值视作 <code>Object</code> 的实例）。</li>
<li><code>checkIfInstance(null, Object) → false</code>。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">解法二：手写原型链遍历 + 原始类型特判</h2>
<ul>
<li>思路：
<ul>
<li>对对象与函数：沿 <code>Object.getPrototypeOf</code> 逐层向上，判断是否等于 <code>classFn.prototype</code>。</li>
<li>对原始类型：做与解法一相同的映射特判。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 通过手写原型链判断实例关系
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstanceByProto</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(value)
  <span class="hljs-keyword">const</span> target = classFn.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
  <span class="hljs-keyword">while</span> (proto) {
    <span class="hljs-keyword">if</span> (proto === target) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<ul>
<li>说明：与 <code>instanceof</code> 等价于遍历原型链的判断，但仍需对原始类型做特判。</li>
</ul>
<h2 data-id="heading-3">解法三：利用 <code>Symbol.hasInstance</code>（了解）</h2>
<ul>
<li>思路：
<ul>
<li><code>instanceof</code> 内部会调用 <code>classFn[Symbol.hasInstance](value)</code>，可显式使用以获得可定制的实例判断行为。</li>
<li>对多数内置类型，直接用 <code>instanceof</code> 即可；手动调用一般用于定制类。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 基于 Symbol.hasInstance 的实例判断
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstanceByHasInstance</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> hasInst = classFn[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>]
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> hasInst === <span class="hljs-string">'function'</span> &amp;&amp; hasInst.<span class="hljs-title function_">call</span>(classFn, value)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<h2 data-id="heading-4">示例与验证</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-title class_">Date</span>))            <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(), <span class="hljs-title class_">Animal</span>))           <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-title class_">Date</span>, <span class="hljs-title class_">Date</span>))                  <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">Number</span>))                   <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-function">() =&gt;</span> {}, <span class="hljs-title class_">Function</span>))          <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">Object</span>))                   <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'7:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-literal">null</span>, <span class="hljs-title class_">Object</span>))                <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'8:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-title class_">Number</span>))           <span class="hljs-comment">// false</span>
</code></pre>
<h2 data-id="heading-5">总结</h2>
<ul>
<li>推荐以 <code>instanceof</code> 为主，原始类型补充为辅，满足题目示例与语义直觉。</li>
<li>若需要可定制的行为，可考虑 <code>Symbol.hasInstance</code>，但一般场景不必复杂化。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跟着TRAE SOLO学习两大搜索]]></title>    <link>https://juejin.cn/post/7571829879827234835</link>    <guid>https://juejin.cn/post/7571829879827234835</guid>    <pubDate>2025-11-13T09:02:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571829879827234835" data-draft-id="7571808096936771625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跟着TRAE SOLO学习两大搜索"/> <meta itemprop="keywords" content="前端,算法"/> <meta itemprop="datePublished" content="2025-11-13T09:02:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跟着TRAE SOLO学习两大搜索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:02:00.000Z" title="Thu Nov 13 2025 09:02:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跟着TRAE SOLO学习两大搜索</h2>
<h3 data-id="heading-1">1.顺序搜索（Sequential Search）</h3>
<h4 data-id="heading-2">认识</h4>
<p>顺序搜索也称为线性搜索（Linear Search）。它的基本思想是从数据结构的一端开始，逐个检查每个元素，直到找到目标元素或检查完所有元素。</p>
<pre><code class="hljs language-plain" lang="plain">function sequentialSearch(arr, target) {
    for (let i = 0; i &lt; arr.length; i++) {
        if (arr[i] === target) {
            return i;
        }
    }
    return -1;
};
const arr = [4, 3, 6, 2, 5, 7, 9, 8, 1]
console.log(sequentialSearch(arr, 8)) // 7
</code></pre>
<h4 data-id="heading-3">Javascript顺序搜索实现</h4>
<h5 data-id="heading-4">基础实现</h5>
<p>基础实现比较好写，就是一个小标</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;顺序搜索 Sequential Search&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;script&gt;
    // 1 顺序搜索 
    function SequentialSearch(arr, target) {
        for (let i = 0; i &lt; arr.length; i++) {
            if (arr[i] == target) {
                return i;
            }
        }
        return -1;
    }
    // 功能测试
    const arr = [1, 4, 3, 6, 2, 5, 7, 9, 8];
    let target = 2;
    let result = SequentialSearch(arr, target);
    console.log(`元素 ${target} 在数组中的索引是 ${result}`);
    
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h5 data-id="heading-5">哨兵模式（Sentinel Pattern）优化</h5>
<p>针对哨兵模式进行优化</p>
<p>也就是将上面循环中的判断条件进行减少为一个</p>
<p>【哨兵模式】将目标值作为哨兵放在了数组的末尾，确保循环一定会终止</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 需要同时检查两个条件:</span>
<span class="hljs-comment">// 1. arr[i] === target - 找到目标元素</span>
<span class="hljs-comment">// 2. i &lt; arr.length - 确保没有超出数组范围</span>
</code></pre>
<p>实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2-优化-哨兵模式</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">SequentialSearch</span>(<span class="hljs-params">arr, target</span>) {
      <span class="hljs-comment">// 如果数组为空，直接返回-1</span>
      <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
      }
      <span class="hljs-comment">// 保存最后一个元素</span>
      <span class="hljs-keyword">const</span> last = arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
      arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] = target; <span class="hljs-comment">// 将最后一个元素设为哨兵</span>

      <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (arr[i] !== target) {
          i++
      }
      <span class="hljs-comment">// 恢复最后一个元素</span>
      arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] = last;
      <span class="hljs-comment">// 如果找到的位置不是最后一个元素，或者是最后一个元素且值匹配</span>
      <span class="hljs-keyword">if</span> (i &lt; arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> || arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target){
          <span class="hljs-keyword">return</span> i
      }
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
 }
</code></pre>
<h5 data-id="heading-6">双向迭代优化</h5>
<p>双向迭代顺序搜索，同时从左和右开始进行搜索</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 3-双向迭代顺序搜索（从前和从后同时搜索）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 待搜索的数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeBidirectionalSearch</span>(<span class="hljs-params">arr, target</span>) {
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> right = arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (left &lt;= right) {
        <span class="hljs-comment">// 从前向后检查</span>
        <span class="hljs-keyword">if</span> (arr[left] === target) {
            <span class="hljs-keyword">return</span> left;
        }
        <span class="hljs-comment">// 从后向前检查</span>
        <span class="hljs-keyword">if</span> (arr[right] === target) {
            <span class="hljs-keyword">return</span> right;
        }
        left++;
        right--;
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<h5 data-id="heading-7">概率优化--暂时没理解</h5>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">/**
     * 4-基于概率的迭代顺序搜索（高频元素优先）
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 待搜索的数组
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">frequencyMap</span> - 可选的频率映射表
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeProbabilisticSearch</span>(<span class="hljs-params">arr, target, frequencyMap = <span class="hljs-literal">null</span></span>) {
        <span class="hljs-comment">// 如果没有提供频率映射表，则创建一个</span>
        <span class="hljs-keyword">if</span> (!frequencyMap) {
            frequencyMap = {};
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
                frequencyMap[item] = (frequencyMap[item] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-comment">// 创建一个按频率排序的索引数组</span>
        <span class="hljs-keyword">const</span> indices = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: arr.<span class="hljs-property">length</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);
        indices.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span>
            (frequencyMap[arr[b]] || <span class="hljs-number">0</span>) - (frequencyMap[arr[a]] || <span class="hljs-number">0</span>)
        );

        <span class="hljs-comment">// 按照排序后的索引顺序搜索</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">of</span> indices) {
            <span class="hljs-keyword">if</span> (arr[i] === target) {
                <span class="hljs-keyword">return</span> i;
            }
        }

        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">const</span> myList = [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">iterativeProbabilisticSearch</span>(myList, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 2</span>
</code></pre>
<h5 data-id="heading-8">缓存优化</h5>
<p>下面的优化非常的简单，但是符合V8引擎的设计</p>
<p>每次循环迭代都需要访问arr.length属性调整为  只在循环开始前访问一次arr.length并将其存储在局部变量length中</p>
<p>JavaScript引擎（如V8）对局部变量的访问速度远快于对象属性访问。这是因为：</p>
<ol>
<li>局部变量存储在寄存器或栈上，访问速度快</li>
<li>对象属性存储在堆上，需要通过属性查找机制访问，速度较慢</li>
</ol>
<p><code>这种局部变量的访问由于存储在在寄存器或栈上 访问速度明显大于存储在堆上的对象属性，以前我还一直坚持不增加多余局部变量呢</code></p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeCachedSearch</span>(<span class="hljs-params">arr, target</span>) {
      <span class="hljs-keyword">const</span> length = arr.<span class="hljs-property">length</span>; <span class="hljs-comment">// 缓存数组长度</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
          <span class="hljs-keyword">if</span> (arr[i] === target) {
              <span class="hljs-keyword">return</span> i;
          }
      }
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 使用示例</span>
  <span class="hljs-keyword">const</span> myList = [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">iterativeCachedSearch</span>(myList, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 2</span>
</code></pre>
<h3 data-id="heading-9">2.二分搜索（Binary Search）</h3>
<h4 data-id="heading-10">认识</h4>
<p><code>二分搜索</code>，也叫<code>折半搜索</code>，是一种在<code>有序数组</code>中查找特定元素的搜索算法。所以是用二分查找的前提是数组必须是<code>有序</code>的.</p>
<p>二分搜索通过不断将搜索范围减半的方式，快速定位目标元素。</p>
<h4 data-id="heading-11">工作原理</h4>
<ol>
<li>从数组的中间元素开始，如果中间元素正好是要查找的元素，则搜索过程结束</li>
<li>如果目标元素大于或小于中间元素，则在数组大于或小于中间元素的那一半中查找</li>
<li>重复上述过程，直到找到目标元素或搜索范围为空</li>
</ol>
<h4 data-id="heading-12">时间复杂度</h4>
<ul>
<li>最坏情况：O(log n)</li>
<li>平均情况：O(log n)</li>
<li>最好情况：O(1)（目标元素正好在中间）</li>
</ul>
<h4 data-id="heading-13">空间复杂度</h4>
<ul>
<li>迭代实现：O(1)</li>
<li>递归实现：O(log n)（由于递归调用栈）</li>
</ul>
<h4 data-id="heading-14">实现</h4>
<h5 data-id="heading-15">基础版本</h5>
<p>基础版本实现，这里我们先来自己手写一个简单的二分搜索模块</p>
<pre><code class="hljs language-javascript" lang="javascript">     <span class="hljs-comment">/**
     * 1-基础迭代二分搜索
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 已排序的数组
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">arr,target</span>){
        <span class="hljs-keyword">let</span> left=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> right=arr.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span>(left &lt;= right){
            <span class="hljs-keyword">const</span> mid=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left+ right)/<span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span>(arr[mid]===target){
                <span class="hljs-keyword">return</span> mid;<span class="hljs-comment">// 找到目标，返回索引</span>
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arr[mid]&lt; target){
                left = mid +<span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
            }<span class="hljs-keyword">else</span>{
                right =mid -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 目标在左半部分</span>
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">const</span> sortedArray = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">binarySearch</span>(sortedArray, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 3</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">binarySearch</span>(sortedArray, <span class="hljs-number">8</span>)); <span class="hljs-comment">// 输出: -1</span>
</code></pre>
<h5 data-id="heading-16">防止整数溢出</h5>
<p>接下来我们就跟着trae优化迭代上面版本的二分搜索，有时候我们会出现一种情况</p>
<p>这里我们主要讲的就是<code>left + (right - left) / 2</code> 比 <code>(left + right) / 2</code> 更安全</p>
<pre><code class="hljs language-javascript" lang="javascript">当 left 和 right 都很大时
和可能会超过 <span class="hljs-title class_">JavaScript</span> 中 <span class="hljs-title class_">Number</span> 类型的最大安全整数（<span class="hljs-number">2</span>^<span class="hljs-number">53</span> - <span class="hljs-number">1</span>）
这会导致整数溢出，得到错误的结果
</code></pre>
<p>利用下面的写法就可以有效避免我们结果超过<code>Number.MAX_SAFE_INTEGER</code>，也就是通过先计算的方式直接避免最后结果超过最大值</p>
<pre><code class="hljs language-javascript" lang="javascript">使用 left + (right - left) / <span class="hljs-number">2</span>

<span class="hljs-comment">// 先计算 (right - left)，这个差值很小</span>
<span class="hljs-comment">// 然后加到 left 上，不会溢出</span>

<span class="hljs-comment">// left + right 会先计算，结果可能超过 Number.MAX_SAFE_INTEGER</span>
<span class="hljs-comment">// 导致溢出，得到错误的结果</span>
</code></pre>
<p>所以防止整数溢出我们更改为</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">const</span> mid = left + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((right - left) / <span class="hljs-number">2</span>);
</code></pre>
<h5 data-id="heading-17">添加输入验证</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加在函数开始处</span>
<span class="hljs-comment">// 输入验证</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) || arr.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'输入必须是非空数组'</span>);
}
</code></pre>
<h5 data-id="heading-18">提前处理边界情况</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加在输入验证之后，循环之前</span>
<span class="hljs-comment">// 提前处理边界情况</span>
<span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] === target) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target) <span class="hljs-keyword">return</span> arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

</code></pre>
<h5 data-id="heading-19">优化循环条件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">while</span> (left &lt;= right) {

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">while</span> (left &lt; right) {

<span class="hljs-comment">// 调整循环体内的逻辑</span>
</code></pre>
<h5 data-id="heading-20">调整循环体内的逻辑</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">if</span> (arr[mid] === target) {
    <span class="hljs-keyword">return</span> mid; <span class="hljs-comment">// 找到目标，返回索引</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
} <span class="hljs-keyword">else</span> {
    right = mid - <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在左半部分</span>
}

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
} <span class="hljs-keyword">else</span> {
    right = mid; <span class="hljs-comment">// 目标在左半部分或mid就是目标</span>
}
</code></pre>
<p>最后我们优化完成以后</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">arr, target</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) || arr.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'输入必须是非空数组'</span>);
  }
  <span class="hljs-comment">// 提前处理边界情况</span>
  <span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] === target) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target) <span class="hljs-keyword">return</span> arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> right = arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 循环条件优化为 left &lt; right</span>
  <span class="hljs-keyword">while</span> (left &lt; right) {
      <span class="hljs-comment">// 防止整数溢出的中间值计算</span>
      <span class="hljs-keyword">const</span> mid = left + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((right - left) / <span class="hljs-number">2</span>);

      <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
          left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分，排除mid</span>
      } <span class="hljs-keyword">else</span> {
          right = mid; <span class="hljs-comment">// 目标在左半部分或mid就是目标</span>
      }
  }
  <span class="hljs-comment">// 循环结束后检查left位置是否为目标</span>
  <span class="hljs-keyword">return</span> arr[left] === target ? left : -<span class="hljs-number">1</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>